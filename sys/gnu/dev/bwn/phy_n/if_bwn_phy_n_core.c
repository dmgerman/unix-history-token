begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*    Broadcom B43 wireless driver   IEEE 802.11n PHY data tables    Copyright (c) 2008 Michael Buesch<m@bues.ch>   Copyright (c) 2010 RafaÅ MiÅecki<zajec5@gmail.com>    This program is free software; you can redistribute it and/or modify   it under the terms of the GNU General Public License as published by   the Free Software Foundation; either version 2 of the License, or   (at your option) any later version.    This program is distributed in the hope that it will be useful,   but WITHOUT ANY WARRANTY; without even the implied warranty of   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the   GNU General Public License for more details.    You should have received a copy of the GNU General Public License   along with this program; see the file COPYING.  If not, write to   the Free Software Foundation, Inc., 51 Franklin Steet, Fifth Floor,   Boston, MA 02110-1301, USA.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*  * The Broadcom Wireless LAN controller driver.  */
end_comment

begin_include
include|#
directive|include
file|"opt_wlan.h"
end_include

begin_include
include|#
directive|include
file|"opt_bwn.h"
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|<sys/errno.h>
end_include

begin_include
include|#
directive|include
file|<sys/firmware.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_include
include|#
directive|include
file|<net/ethernet.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_var.h>
end_include

begin_include
include|#
directive|include
file|<net/if_arp.h>
end_include

begin_include
include|#
directive|include
file|<net/if_dl.h>
end_include

begin_include
include|#
directive|include
file|<net/if_llc.h>
end_include

begin_include
include|#
directive|include
file|<net/if_media.h>
end_include

begin_include
include|#
directive|include
file|<net/if_types.h>
end_include

begin_include
include|#
directive|include
file|<dev/pci/pcivar.h>
end_include

begin_include
include|#
directive|include
file|<dev/pci/pcireg.h>
end_include

begin_include
include|#
directive|include
file|<dev/siba/siba_ids.h>
end_include

begin_include
include|#
directive|include
file|<dev/siba/sibareg.h>
end_include

begin_include
include|#
directive|include
file|<dev/siba/sibavar.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_var.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_radiotap.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_regdomain.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_phy.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_ratectl.h>
end_include

begin_include
include|#
directive|include
file|<dev/bwn/if_bwnreg.h>
end_include

begin_include
include|#
directive|include
file|<dev/bwn/if_bwnvar.h>
end_include

begin_include
include|#
directive|include
file|<dev/bwn/if_bwn_misc.h>
end_include

begin_include
include|#
directive|include
file|<dev/bwn/if_bwn_util.h>
end_include

begin_include
include|#
directive|include
file|<dev/bwn/if_bwn_debug.h>
end_include

begin_include
include|#
directive|include
file|<dev/bwn/if_bwn_phy_common.h>
end_include

begin_include
include|#
directive|include
file|<dev/bwn/if_bwn_chipid.h>
end_include

begin_include
include|#
directive|include
file|<dev/bwn/if_bwn_cordic.h>
end_include

begin_include
include|#
directive|include
file|<gnu/dev/bwn/phy_n/if_bwn_phy_n_regs.h>
end_include

begin_include
include|#
directive|include
file|<gnu/dev/bwn/phy_n/if_bwn_phy_n_ppr.h>
end_include

begin_include
include|#
directive|include
file|<gnu/dev/bwn/phy_n/if_bwn_phy_n_tables.h>
end_include

begin_include
include|#
directive|include
file|<gnu/dev/bwn/phy_n/if_bwn_radio_2055.h>
end_include

begin_include
include|#
directive|include
file|<gnu/dev/bwn/phy_n/if_bwn_radio_2056.h>
end_include

begin_include
include|#
directive|include
file|<gnu/dev/bwn/phy_n/if_bwn_radio_2057.h>
end_include

begin_include
include|#
directive|include
file|<gnu/dev/bwn/phy_n/if_bwn_phy_n_core.h>
end_include

begin_struct
struct|struct
name|bwn_nphy_txgains
block|{
name|uint16_t
name|tx_lpf
index|[
literal|2
index|]
decl_stmt|;
name|uint16_t
name|txgm
index|[
literal|2
index|]
decl_stmt|;
name|uint16_t
name|pga
index|[
literal|2
index|]
decl_stmt|;
name|uint16_t
name|pad
index|[
literal|2
index|]
decl_stmt|;
name|uint16_t
name|ipa
index|[
literal|2
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|bwn_nphy_iqcal_params
block|{
name|uint16_t
name|tx_lpf
decl_stmt|;
name|uint16_t
name|txgm
decl_stmt|;
name|uint16_t
name|pga
decl_stmt|;
name|uint16_t
name|pad
decl_stmt|;
name|uint16_t
name|ipa
decl_stmt|;
name|uint16_t
name|cal_gain
decl_stmt|;
name|uint16_t
name|ncorr
index|[
literal|5
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|bwn_nphy_iq_est
block|{
name|int32_t
name|iq0_prod
decl_stmt|;
name|uint32_t
name|i0_pwr
decl_stmt|;
name|uint32_t
name|q0_pwr
decl_stmt|;
name|int32_t
name|iq1_prod
decl_stmt|;
name|uint32_t
name|i1_pwr
decl_stmt|;
name|uint32_t
name|q1_pwr
decl_stmt|;
block|}
struct|;
end_struct

begin_enum
enum|enum
name|bwn_nphy_rf_sequence
block|{
name|BWN_RFSEQ_RX2TX
block|,
name|BWN_RFSEQ_TX2RX
block|,
name|BWN_RFSEQ_RESET2RX
block|,
name|BWN_RFSEQ_UPDATE_GAINH
block|,
name|BWN_RFSEQ_UPDATE_GAINL
block|,
name|BWN_RFSEQ_UPDATE_GAINU
block|, }
enum|;
end_enum

begin_enum
enum|enum
name|n_rf_ctl_over_cmd
block|{
name|N_RF_CTL_OVER_CMD_RXRF_PU
init|=
literal|0
block|,
name|N_RF_CTL_OVER_CMD_RX_PU
init|=
literal|1
block|,
name|N_RF_CTL_OVER_CMD_TX_PU
init|=
literal|2
block|,
name|N_RF_CTL_OVER_CMD_RX_GAIN
init|=
literal|3
block|,
name|N_RF_CTL_OVER_CMD_TX_GAIN
init|=
literal|4
block|, }
enum|;
end_enum

begin_enum
enum|enum
name|n_intc_override
block|{
name|N_INTC_OVERRIDE_OFF
init|=
literal|0
block|,
name|N_INTC_OVERRIDE_TRSW
init|=
literal|1
block|,
name|N_INTC_OVERRIDE_PA
init|=
literal|2
block|,
name|N_INTC_OVERRIDE_EXT_LNA_PU
init|=
literal|3
block|,
name|N_INTC_OVERRIDE_EXT_LNA_GAIN
init|=
literal|4
block|, }
enum|;
end_enum

begin_enum
enum|enum
name|n_rssi_type
block|{
name|N_RSSI_W1
init|=
literal|0
block|,
name|N_RSSI_W2
block|,
name|N_RSSI_NB
block|,
name|N_RSSI_IQ
block|,
name|N_RSSI_TSSI_2G
block|,
name|N_RSSI_TSSI_5G
block|,
name|N_RSSI_TBD
block|, }
enum|;
end_enum

begin_enum
enum|enum
name|n_rail_type
block|{
name|N_RAIL_I
init|=
literal|0
block|,
name|N_RAIL_Q
init|=
literal|1
block|, }
enum|;
end_enum

begin_function
specifier|static
specifier|inline
name|bool
name|bwn_nphy_ipa
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|bwn_band_t
name|band
init|=
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
decl_stmt|;
return|return
operator|(
operator|(
name|mac
operator|->
name|mac_phy
operator|.
name|phy_n
operator|->
name|ipa2g_on
operator|&&
name|band
operator|==
name|BWN_BAND_2G
operator|)
operator|||
operator|(
name|mac
operator|->
name|mac_phy
operator|.
name|phy_n
operator|->
name|ipa5g_on
operator|&&
name|band
operator|==
name|BWN_BAND_5G
operator|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RxCoreGetState */
end_comment

begin_function
specifier|static
name|uint8_t
name|bwn_nphy_get_rx_core_state
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
return|return
operator|(
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFSEQCA
argument_list|)
operator|&
name|BWN_NPHY_RFSEQCA_RXEN
operator|)
operator|>>
name|BWN_NPHY_RFSEQCA_RXEN_SHIFT
return|;
block|}
end_function

begin_comment
comment|/**************************************************  * RF (just without bwn_nphy_rf_ctl_intc_override)  **************************************************/
end_comment

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/ForceRFSeq */
end_comment

begin_function
specifier|static
name|void
name|bwn_nphy_force_rf_sequence
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|enum
name|bwn_nphy_rf_sequence
name|seq
parameter_list|)
block|{
specifier|static
specifier|const
name|uint16_t
name|trigger
index|[]
init|=
block|{
index|[
name|BWN_RFSEQ_RX2TX
index|]
operator|=
name|BWN_NPHY_RFSEQTR_RX2TX
block|,
index|[
name|BWN_RFSEQ_TX2RX
index|]
operator|=
name|BWN_NPHY_RFSEQTR_TX2RX
block|,
index|[
name|BWN_RFSEQ_RESET2RX
index|]
operator|=
name|BWN_NPHY_RFSEQTR_RST2RX
block|,
index|[
name|BWN_RFSEQ_UPDATE_GAINH
index|]
operator|=
name|BWN_NPHY_RFSEQTR_UPGH
block|,
index|[
name|BWN_RFSEQ_UPDATE_GAINL
index|]
operator|=
name|BWN_NPHY_RFSEQTR_UPGL
block|,
index|[
name|BWN_RFSEQ_UPDATE_GAINU
index|]
operator|=
name|BWN_NPHY_RFSEQTR_UPGU
block|, 	}
decl_stmt|;
name|int
name|i
decl_stmt|;
name|uint16_t
name|seq_mode
init|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFSEQMODE
argument_list|)
decl_stmt|;
if|if
condition|(
name|seq
operator|>=
name|nitems
argument_list|(
name|trigger
argument_list|)
condition|)
block|{
name|BWN_WARNPRINTF
argument_list|(
name|mac
operator|->
name|mac_sc
argument_list|,
literal|"%s: seq %d> max"
argument_list|,
name|__func__
argument_list|,
name|seq
argument_list|)
expr_stmt|;
block|}
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFSEQMODE
argument_list|,
name|BWN_NPHY_RFSEQMODE_CAOVER
operator||
name|BWN_NPHY_RFSEQMODE_TROVER
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFSEQTR
argument_list|,
name|trigger
index|[
name|seq
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|200
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFSEQST
argument_list|)
operator|&
name|trigger
index|[
name|seq
index|]
operator|)
condition|)
goto|goto
name|ok
goto|;
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
block|}
name|BWN_ERRPRINTF
argument_list|(
name|mac
operator|->
name|mac_sc
argument_list|,
literal|"RF sequence status timeout\n"
argument_list|)
expr_stmt|;
name|ok
label|:
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFSEQMODE
argument_list|,
name|seq_mode
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_nphy_rf_ctl_override_rev19
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint16_t
name|field
parameter_list|,
name|uint16_t
name|value
parameter_list|,
name|uint8_t
name|core
parameter_list|,
name|bool
name|off
parameter_list|,
name|uint8_t
name|override_id
parameter_list|)
block|{
comment|/* TODO */
block|}
end_function

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RFCtrlOverrideRev7 */
end_comment

begin_function
specifier|static
name|void
name|bwn_nphy_rf_ctl_override_rev7
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint16_t
name|field
parameter_list|,
name|uint16_t
name|value
parameter_list|,
name|uint8_t
name|core
parameter_list|,
name|bool
name|off
parameter_list|,
name|uint8_t
name|override
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
specifier|const
name|struct
name|bwn_nphy_rf_control_override_rev7
modifier|*
name|e
decl_stmt|;
name|uint16_t
name|en_addrs
index|[
literal|3
index|]
index|[
literal|2
index|]
init|=
block|{
block|{
literal|0x0E7
block|,
literal|0x0EC
block|}
block|,
block|{
literal|0x342
block|,
literal|0x343
block|}
block|,
block|{
literal|0x346
block|,
literal|0x347
block|}
block|}
decl_stmt|;
name|uint16_t
name|en_addr
decl_stmt|;
name|uint16_t
name|en_mask
init|=
name|field
decl_stmt|;
name|uint16_t
name|val_addr
decl_stmt|;
name|uint8_t
name|i
decl_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|19
operator|||
name|phy
operator|->
name|rev
operator|<
literal|3
condition|)
block|{
name|BWN_WARNPRINTF
argument_list|(
name|mac
operator|->
name|mac_sc
argument_list|,
literal|"%s: phy rev %d out of range\n"
argument_list|,
name|__func__
argument_list|,
name|phy
operator|->
name|rev
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Remember: we can get NULL! */
name|e
operator|=
name|bwn_nphy_get_rf_ctl_over_rev7
argument_list|(
name|mac
argument_list|,
name|field
argument_list|,
name|override
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|override
operator|>=
name|nitems
argument_list|(
name|en_addrs
argument_list|)
condition|)
block|{
name|BWN_ERRPRINTF
argument_list|(
name|mac
operator|->
name|mac_sc
argument_list|,
literal|"Invalid override value %d\n"
argument_list|,
name|override
argument_list|)
expr_stmt|;
return|return;
block|}
name|en_addr
operator|=
name|en_addrs
index|[
name|override
index|]
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|e
condition|)
name|val_addr
operator|=
operator|(
name|i
operator|==
literal|0
operator|)
condition|?
name|e
operator|->
name|val_addr_core0
else|:
name|e
operator|->
name|val_addr_core1
expr_stmt|;
if|if
condition|(
name|off
condition|)
block|{
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|en_addr
argument_list|,
operator|~
name|en_mask
argument_list|)
expr_stmt|;
if|if
condition|(
name|e
condition|)
comment|/* Do it safer, better than wl */
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|val_addr
argument_list|,
operator|~
name|e
operator|->
name|val_mask
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|core
operator|||
operator|(
name|core
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
operator|)
condition|)
block|{
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|en_addr
argument_list|,
name|en_mask
argument_list|)
expr_stmt|;
if|if
condition|(
name|e
condition|)
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|val_addr
argument_list|,
operator|~
name|e
operator|->
name|val_mask
argument_list|,
operator|(
name|value
operator|<<
name|e
operator|->
name|val_shift
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RFCtrlOverideOneToMany */
end_comment

begin_function
specifier|static
name|void
name|bwn_nphy_rf_ctl_override_one_to_many
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|enum
name|n_rf_ctl_over_cmd
name|cmd
parameter_list|,
name|uint16_t
name|value
parameter_list|,
name|uint8_t
name|core
parameter_list|,
name|bool
name|off
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|uint16_t
name|tmp
decl_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|<
literal|7
condition|)
block|{
name|BWN_ERRPRINTF
argument_list|(
name|mac
operator|->
name|mac_sc
argument_list|,
literal|"%s: phy rev %d out of range\n"
argument_list|,
name|__func__
argument_list|,
name|phy
operator|->
name|rev
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|N_RF_CTL_OVER_CMD_RXRF_PU
case|:
name|bwn_nphy_rf_ctl_override_rev7
argument_list|(
name|mac
argument_list|,
literal|0x20
argument_list|,
name|value
argument_list|,
name|core
argument_list|,
name|off
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|bwn_nphy_rf_ctl_override_rev7
argument_list|(
name|mac
argument_list|,
literal|0x10
argument_list|,
name|value
argument_list|,
name|core
argument_list|,
name|off
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|bwn_nphy_rf_ctl_override_rev7
argument_list|(
name|mac
argument_list|,
literal|0x08
argument_list|,
name|value
argument_list|,
name|core
argument_list|,
name|off
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|N_RF_CTL_OVER_CMD_RX_PU
case|:
name|bwn_nphy_rf_ctl_override_rev7
argument_list|(
name|mac
argument_list|,
literal|0x4
argument_list|,
name|value
argument_list|,
name|core
argument_list|,
name|off
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|bwn_nphy_rf_ctl_override_rev7
argument_list|(
name|mac
argument_list|,
literal|0x2
argument_list|,
name|value
argument_list|,
name|core
argument_list|,
name|off
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|bwn_nphy_rf_ctl_override_rev7
argument_list|(
name|mac
argument_list|,
literal|0x1
argument_list|,
name|value
argument_list|,
name|core
argument_list|,
name|off
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|bwn_nphy_rf_ctl_override_rev7
argument_list|(
name|mac
argument_list|,
literal|0x2
argument_list|,
name|value
argument_list|,
name|core
argument_list|,
name|off
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|bwn_nphy_rf_ctl_override_rev7
argument_list|(
name|mac
argument_list|,
literal|0x0800
argument_list|,
literal|0
argument_list|,
name|core
argument_list|,
name|off
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|N_RF_CTL_OVER_CMD_TX_PU
case|:
name|bwn_nphy_rf_ctl_override_rev7
argument_list|(
name|mac
argument_list|,
literal|0x4
argument_list|,
name|value
argument_list|,
name|core
argument_list|,
name|off
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bwn_nphy_rf_ctl_override_rev7
argument_list|(
name|mac
argument_list|,
literal|0x2
argument_list|,
name|value
argument_list|,
name|core
argument_list|,
name|off
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|bwn_nphy_rf_ctl_override_rev7
argument_list|(
name|mac
argument_list|,
literal|0x1
argument_list|,
name|value
argument_list|,
name|core
argument_list|,
name|off
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|bwn_nphy_rf_ctl_override_rev7
argument_list|(
name|mac
argument_list|,
literal|0x0800
argument_list|,
literal|1
argument_list|,
name|core
argument_list|,
name|off
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|N_RF_CTL_OVER_CMD_RX_GAIN
case|:
name|tmp
operator|=
name|value
operator|&
literal|0xFF
expr_stmt|;
name|bwn_nphy_rf_ctl_override_rev7
argument_list|(
name|mac
argument_list|,
literal|0x0800
argument_list|,
name|tmp
argument_list|,
name|core
argument_list|,
name|off
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|value
operator|>>
literal|8
expr_stmt|;
name|bwn_nphy_rf_ctl_override_rev7
argument_list|(
name|mac
argument_list|,
literal|0x6000
argument_list|,
name|tmp
argument_list|,
name|core
argument_list|,
name|off
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|N_RF_CTL_OVER_CMD_TX_GAIN
case|:
name|tmp
operator|=
name|value
operator|&
literal|0x7FFF
expr_stmt|;
name|bwn_nphy_rf_ctl_override_rev7
argument_list|(
name|mac
argument_list|,
literal|0x1000
argument_list|,
name|tmp
argument_list|,
name|core
argument_list|,
name|off
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|value
operator|>>
literal|14
expr_stmt|;
name|bwn_nphy_rf_ctl_override_rev7
argument_list|(
name|mac
argument_list|,
literal|0x4000
argument_list|,
name|tmp
argument_list|,
name|core
argument_list|,
name|off
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RFCtrlOverride */
end_comment

begin_function
specifier|static
name|void
name|bwn_nphy_rf_ctl_override
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint16_t
name|field
parameter_list|,
name|uint16_t
name|value
parameter_list|,
name|uint8_t
name|core
parameter_list|,
name|bool
name|off
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|uint8_t
name|index
init|=
name|fls
argument_list|(
name|field
argument_list|)
decl_stmt|;
name|uint8_t
name|addr
decl_stmt|,
name|en_addr
decl_stmt|,
name|val_addr
decl_stmt|;
comment|/* we expect only one bit set */
if|if
condition|(
name|field
operator|&
operator|(
operator|~
operator|(
literal|1
operator|<<
operator|(
name|index
operator|-
literal|1
operator|)
operator|)
operator|)
condition|)
block|{
name|BWN_ERRPRINTF
argument_list|(
name|mac
operator|->
name|mac_sc
argument_list|,
literal|"%s: field 0x%04x has>1 bit set\n"
argument_list|,
name|__func__
argument_list|,
name|field
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|3
condition|)
block|{
specifier|const
name|struct
name|bwn_nphy_rf_control_override_rev3
modifier|*
name|rf_ctrl
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|index
operator|==
literal|0
operator|||
name|index
operator|==
literal|16
condition|)
block|{
name|BWN_ERRPRINTF
argument_list|(
name|mac
operator|->
name|mac_sc
argument_list|,
literal|"Unsupported RF Ctrl Override call\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|rf_ctrl
operator|=
operator|&
name|tbl_rf_control_override_rev3
index|[
name|index
operator|-
literal|1
index|]
expr_stmt|;
name|en_addr
operator|=
name|BWN_PHY_N
argument_list|(
operator|(
name|i
operator|==
literal|0
operator|)
condition|?
name|rf_ctrl
operator|->
name|en_addr0
else|:
name|rf_ctrl
operator|->
name|en_addr1
argument_list|)
expr_stmt|;
name|val_addr
operator|=
name|BWN_PHY_N
argument_list|(
operator|(
name|i
operator|==
literal|0
operator|)
condition|?
name|rf_ctrl
operator|->
name|val_addr0
else|:
name|rf_ctrl
operator|->
name|val_addr1
argument_list|)
expr_stmt|;
if|if
condition|(
name|off
condition|)
block|{
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|en_addr
argument_list|,
operator|~
operator|(
name|field
operator|)
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|val_addr
argument_list|,
operator|~
operator|(
name|rf_ctrl
operator|->
name|val_mask
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|core
operator|==
literal|0
operator|||
operator|(
operator|(
literal|1
operator|<<
name|i
operator|)
operator|&
name|core
operator|)
condition|)
block|{
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|en_addr
argument_list|,
name|field
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|val_addr
argument_list|,
operator|~
operator|(
name|rf_ctrl
operator|->
name|val_mask
operator|)
argument_list|,
operator|(
name|value
operator|<<
name|rf_ctrl
operator|->
name|val_shift
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
else|else
block|{
specifier|const
name|struct
name|bwn_nphy_rf_control_override_rev2
modifier|*
name|rf_ctrl
decl_stmt|;
if|if
condition|(
name|off
condition|)
block|{
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_OVER
argument_list|,
operator|~
operator|(
name|field
operator|)
argument_list|)
expr_stmt|;
name|value
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_OVER
argument_list|,
name|field
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|index
operator|<=
literal|1
operator|||
name|index
operator|==
literal|16
condition|)
block|{
name|BWN_ERRPRINTF
argument_list|(
name|mac
operator|->
name|mac_sc
argument_list|,
literal|"Unsupported RF Ctrl Override call\n"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|index
operator|==
literal|2
operator|||
name|index
operator|==
literal|10
operator|||
operator|(
name|index
operator|>=
literal|13
operator|&&
name|index
operator|<=
literal|15
operator|)
condition|)
block|{
name|core
operator|=
literal|1
expr_stmt|;
block|}
name|rf_ctrl
operator|=
operator|&
name|tbl_rf_control_override_rev2
index|[
name|index
operator|-
literal|2
index|]
expr_stmt|;
name|addr
operator|=
name|BWN_PHY_N
argument_list|(
operator|(
name|i
operator|==
literal|0
operator|)
condition|?
name|rf_ctrl
operator|->
name|addr0
else|:
name|rf_ctrl
operator|->
name|addr1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
literal|1
operator|<<
name|i
operator|)
operator|&
name|core
condition|)
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|addr
argument_list|,
operator|~
operator|(
name|rf_ctrl
operator|->
name|bmask
operator|)
argument_list|,
operator|(
name|value
operator|<<
name|rf_ctrl
operator|->
name|shift
operator|)
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_OVER
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_CMD
argument_list|,
name|BWN_NPHY_RFCTL_CMD_START
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_OVER
argument_list|,
literal|0xFFFE
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_nphy_rf_ctl_intc_override_rev7
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|enum
name|n_intc_override
name|intc_override
parameter_list|,
name|uint16_t
name|value
parameter_list|,
name|uint8_t
name|core_sel
parameter_list|)
block|{
name|uint16_t
name|reg
decl_stmt|,
name|tmp
decl_stmt|,
name|tmp2
decl_stmt|,
name|val
decl_stmt|;
name|int
name|core
decl_stmt|;
comment|/* TODO: What about rev19+? Revs 3+ and 7+ are a bit similar */
for|for
control|(
name|core
operator|=
literal|0
init|;
name|core
operator|<
literal|2
condition|;
name|core
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|core_sel
operator|==
literal|1
operator|&&
name|core
operator|!=
literal|0
operator|)
operator|||
operator|(
name|core_sel
operator|==
literal|2
operator|&&
name|core
operator|!=
literal|1
operator|)
condition|)
continue|continue;
name|reg
operator|=
operator|(
name|core
operator|==
literal|0
operator|)
condition|?
name|BWN_NPHY_RFCTL_INTC1
else|:
name|BWN_NPHY_RFCTL_INTC2
expr_stmt|;
switch|switch
condition|(
name|intc_override
condition|)
block|{
case|case
name|N_INTC_OVERRIDE_OFF
case|:
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|reg
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
literal|0x2ff
argument_list|,
operator|~
literal|0x2000
argument_list|)
expr_stmt|;
name|bwn_nphy_force_rf_sequence
argument_list|(
name|mac
argument_list|,
name|BWN_RFSEQ_RESET2RX
argument_list|)
expr_stmt|;
break|break;
case|case
name|N_INTC_OVERRIDE_TRSW
case|:
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|reg
argument_list|,
operator|~
literal|0xC0
argument_list|,
name|value
operator|<<
literal|6
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|reg
argument_list|,
literal|0x400
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
literal|0x2ff
argument_list|,
operator|~
literal|0xC000
operator|&
literal|0xFFFF
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
literal|0x2ff
argument_list|,
literal|0x2000
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
literal|0x2ff
argument_list|,
literal|0x0001
argument_list|)
expr_stmt|;
break|break;
case|case
name|N_INTC_OVERRIDE_PA
case|:
name|tmp
operator|=
literal|0x0030
expr_stmt|;
if|if
condition|(
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_5G
condition|)
name|val
operator|=
name|value
operator|<<
literal|5
expr_stmt|;
else|else
name|val
operator|=
name|value
operator|<<
literal|4
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|reg
argument_list|,
operator|~
name|tmp
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|reg
argument_list|,
literal|0x1000
argument_list|)
expr_stmt|;
break|break;
case|case
name|N_INTC_OVERRIDE_EXT_LNA_PU
case|:
if|if
condition|(
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_5G
condition|)
block|{
name|tmp
operator|=
literal|0x0001
expr_stmt|;
name|tmp2
operator|=
literal|0x0004
expr_stmt|;
name|val
operator|=
name|value
expr_stmt|;
block|}
else|else
block|{
name|tmp
operator|=
literal|0x0004
expr_stmt|;
name|tmp2
operator|=
literal|0x0001
expr_stmt|;
name|val
operator|=
name|value
operator|<<
literal|2
expr_stmt|;
block|}
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|reg
argument_list|,
operator|~
name|tmp
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|reg
argument_list|,
operator|~
name|tmp2
argument_list|)
expr_stmt|;
break|break;
case|case
name|N_INTC_OVERRIDE_EXT_LNA_GAIN
case|:
if|if
condition|(
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_5G
condition|)
block|{
name|tmp
operator|=
literal|0x0002
expr_stmt|;
name|tmp2
operator|=
literal|0x0008
expr_stmt|;
name|val
operator|=
name|value
operator|<<
literal|1
expr_stmt|;
block|}
else|else
block|{
name|tmp
operator|=
literal|0x0008
expr_stmt|;
name|tmp2
operator|=
literal|0x0002
expr_stmt|;
name|val
operator|=
name|value
operator|<<
literal|3
expr_stmt|;
block|}
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|reg
argument_list|,
operator|~
name|tmp
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|reg
argument_list|,
operator|~
name|tmp2
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
end_function

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RFCtrlIntcOverride */
end_comment

begin_function
specifier|static
name|void
name|bwn_nphy_rf_ctl_intc_override
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|enum
name|n_intc_override
name|intc_override
parameter_list|,
name|uint16_t
name|value
parameter_list|,
name|uint8_t
name|core
parameter_list|)
block|{
name|uint8_t
name|i
decl_stmt|,
name|j
decl_stmt|;
name|uint16_t
name|reg
decl_stmt|,
name|tmp
decl_stmt|,
name|val
decl_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|7
condition|)
block|{
name|bwn_nphy_rf_ctl_intc_override_rev7
argument_list|(
name|mac
argument_list|,
name|intc_override
argument_list|,
name|value
argument_list|,
name|core
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|<
literal|3
condition|)
block|{
name|BWN_ERRPRINTF
argument_list|(
name|mac
operator|->
name|mac_sc
argument_list|,
literal|"%s: phy rev %d out of range\n"
argument_list|,
name|__func__
argument_list|,
name|mac
operator|->
name|mac_phy
operator|.
name|rev
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|core
operator|==
literal|1
operator|&&
name|i
operator|==
literal|1
operator|)
operator|||
operator|(
name|core
operator|==
literal|2
operator|&&
operator|!
name|i
operator|)
condition|)
continue|continue;
name|reg
operator|=
operator|(
name|i
operator|==
literal|0
operator|)
condition|?
name|BWN_NPHY_RFCTL_INTC1
else|:
name|BWN_NPHY_RFCTL_INTC2
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|reg
argument_list|,
literal|0x400
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|intc_override
condition|)
block|{
case|case
name|N_INTC_OVERRIDE_OFF
case|:
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|reg
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bwn_nphy_force_rf_sequence
argument_list|(
name|mac
argument_list|,
name|BWN_RFSEQ_RESET2RX
argument_list|)
expr_stmt|;
break|break;
case|case
name|N_INTC_OVERRIDE_TRSW
case|:
if|if
condition|(
operator|!
name|i
condition|)
block|{
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_INTC1
argument_list|,
literal|0xFC3F
argument_list|,
operator|(
name|value
operator|<<
literal|6
operator|)
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TXF_40CO_B1S1
argument_list|,
literal|0xFFFE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_CMD
argument_list|,
name|BWN_NPHY_RFCTL_CMD_START
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|100
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_CMD
argument_list|)
operator|&
name|BWN_NPHY_RFCTL_CMD_START
operator|)
condition|)
block|{
name|j
operator|=
literal|0
expr_stmt|;
break|break;
block|}
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|j
condition|)
name|BWN_ERRPRINTF
argument_list|(
name|mac
operator|->
name|mac_sc
argument_list|,
literal|"intc override timeout\n"
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TXF_40CO_B1S1
argument_list|,
literal|0xFFFE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_INTC2
argument_list|,
literal|0xFC3F
argument_list|,
operator|(
name|value
operator|<<
literal|6
operator|)
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_OVER
argument_list|,
literal|0xFFFE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_CMD
argument_list|,
name|BWN_NPHY_RFCTL_CMD_RXTX
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|100
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_CMD
argument_list|)
operator|&
name|BWN_NPHY_RFCTL_CMD_RXTX
operator|)
condition|)
block|{
name|j
operator|=
literal|0
expr_stmt|;
break|break;
block|}
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|j
condition|)
name|BWN_ERRPRINTF
argument_list|(
name|mac
operator|->
name|mac_sc
argument_list|,
literal|"intc override timeout\n"
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_OVER
argument_list|,
literal|0xFFFE
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|N_INTC_OVERRIDE_PA
case|:
if|if
condition|(
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_5G
condition|)
block|{
name|tmp
operator|=
literal|0x0020
expr_stmt|;
name|val
operator|=
name|value
operator|<<
literal|5
expr_stmt|;
block|}
else|else
block|{
name|tmp
operator|=
literal|0x0010
expr_stmt|;
name|val
operator|=
name|value
operator|<<
literal|4
expr_stmt|;
block|}
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|reg
argument_list|,
operator|~
name|tmp
argument_list|,
name|val
argument_list|)
expr_stmt|;
break|break;
case|case
name|N_INTC_OVERRIDE_EXT_LNA_PU
case|:
if|if
condition|(
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_5G
condition|)
block|{
name|tmp
operator|=
literal|0x0001
expr_stmt|;
name|val
operator|=
name|value
expr_stmt|;
block|}
else|else
block|{
name|tmp
operator|=
literal|0x0004
expr_stmt|;
name|val
operator|=
name|value
operator|<<
literal|2
expr_stmt|;
block|}
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|reg
argument_list|,
operator|~
name|tmp
argument_list|,
name|val
argument_list|)
expr_stmt|;
break|break;
case|case
name|N_INTC_OVERRIDE_EXT_LNA_GAIN
case|:
if|if
condition|(
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_5G
condition|)
block|{
name|tmp
operator|=
literal|0x0002
expr_stmt|;
name|val
operator|=
name|value
operator|<<
literal|1
expr_stmt|;
block|}
else|else
block|{
name|tmp
operator|=
literal|0x0008
expr_stmt|;
name|val
operator|=
name|value
operator|<<
literal|3
expr_stmt|;
block|}
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|reg
argument_list|,
operator|~
name|tmp
argument_list|,
name|val
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
end_function

begin_comment
comment|/**************************************************  * Various PHY ops  **************************************************/
end_comment

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/clip-detection */
end_comment

begin_function
specifier|static
name|void
name|bwn_nphy_write_clip_detection
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
specifier|const
name|uint16_t
modifier|*
name|clip_st
parameter_list|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_C1_CLIP1THRES
argument_list|,
name|clip_st
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_C2_CLIP1THRES
argument_list|,
name|clip_st
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/clip-detection */
end_comment

begin_function
specifier|static
name|void
name|bwn_nphy_read_clip_detection
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint16_t
modifier|*
name|clip_st
parameter_list|)
block|{
name|clip_st
index|[
literal|0
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_C1_CLIP1THRES
argument_list|)
expr_stmt|;
name|clip_st
index|[
literal|1
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_C2_CLIP1THRES
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/classifier */
end_comment

begin_function
specifier|static
name|uint16_t
name|bwn_nphy_classifier
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint16_t
name|mask
parameter_list|,
name|uint16_t
name|val
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|uint16_t
name|tmp
decl_stmt|;
if|if
condition|(
name|siba_get_revid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
literal|16
condition|)
name|bwn_mac_suspend
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_CLASSCTL
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|(
name|BWN_NPHY_CLASSCTL_CCKEN
operator||
name|BWN_NPHY_CLASSCTL_OFDMEN
operator||
name|BWN_NPHY_CLASSCTL_WAITEDEN
operator|)
expr_stmt|;
name|tmp
operator|&=
operator|~
name|mask
expr_stmt|;
name|tmp
operator||=
operator|(
name|val
operator|&
name|mask
operator|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_CLASSCTL
argument_list|,
literal|0xFFF8
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|siba_get_revid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
literal|16
condition|)
name|bwn_mac_enable
argument_list|(
name|mac
argument_list|)
expr_stmt|;
return|return
name|tmp
return|;
block|}
end_function

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/CCA */
end_comment

begin_function
specifier|static
name|void
name|bwn_nphy_reset_cca
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|uint16_t
name|bbcfg
decl_stmt|;
name|bwn_phy_force_clock
argument_list|(
name|mac
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|bbcfg
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_BBCFG
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_BBCFG
argument_list|,
name|bbcfg
operator||
name|BWN_NPHY_BBCFG_RSTCCA
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_BBCFG
argument_list|,
name|bbcfg
operator|&
operator|~
name|BWN_NPHY_BBCFG_RSTCCA
argument_list|)
expr_stmt|;
name|bwn_phy_force_clock
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bwn_nphy_force_rf_sequence
argument_list|(
name|mac
argument_list|,
name|BWN_RFSEQ_RESET2RX
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/carriersearch */
end_comment

begin_function
specifier|static
name|void
name|bwn_nphy_stay_in_carrier_search
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|bool
name|enable
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwn_phy_n
modifier|*
name|nphy
init|=
name|phy
operator|->
name|phy_n
decl_stmt|;
if|if
condition|(
name|enable
condition|)
block|{
specifier|static
specifier|const
name|uint16_t
name|clip
index|[]
init|=
block|{
literal|0xFFFF
block|,
literal|0xFFFF
block|}
decl_stmt|;
if|if
condition|(
name|nphy
operator|->
name|deaf_count
operator|++
operator|==
literal|0
condition|)
block|{
name|nphy
operator|->
name|classifier_state
operator|=
name|bwn_nphy_classifier
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bwn_nphy_classifier
argument_list|(
name|mac
argument_list|,
literal|0x7
argument_list|,
name|BWN_NPHY_CLASSCTL_WAITEDEN
argument_list|)
expr_stmt|;
name|bwn_nphy_read_clip_detection
argument_list|(
name|mac
argument_list|,
name|nphy
operator|->
name|clip_state
argument_list|)
expr_stmt|;
name|bwn_nphy_write_clip_detection
argument_list|(
name|mac
argument_list|,
name|clip
argument_list|)
expr_stmt|;
block|}
name|bwn_nphy_reset_cca
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|--
name|nphy
operator|->
name|deaf_count
operator|==
literal|0
condition|)
block|{
name|bwn_nphy_classifier
argument_list|(
name|mac
argument_list|,
literal|0x7
argument_list|,
name|nphy
operator|->
name|classifier_state
argument_list|)
expr_stmt|;
name|bwn_nphy_write_clip_detection
argument_list|(
name|mac
argument_list|,
name|nphy
operator|->
name|clip_state
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/PHY/N/Read_Lpf_Bw_Ctl */
end_comment

begin_function
specifier|static
name|uint16_t
name|bwn_nphy_read_lpf_ctl
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint16_t
name|offset
parameter_list|)
block|{
if|if
condition|(
operator|!
name|offset
condition|)
name|offset
operator|=
name|bwn_is_40mhz
argument_list|(
name|mac
argument_list|)
condition|?
literal|0x159
else|:
literal|0x154
expr_stmt|;
return|return
name|bwn_ntab_read
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|7
argument_list|,
name|offset
argument_list|)
argument_list|)
operator|&
literal|0x7
return|;
block|}
end_function

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/AdjustLnaGainTbl */
end_comment

begin_function
specifier|static
name|void
name|bwn_nphy_adjust_lna_gain_table
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_phy_n
modifier|*
name|nphy
init|=
name|mac
operator|->
name|mac_phy
operator|.
name|phy_n
decl_stmt|;
name|uint8_t
name|i
decl_stmt|;
name|int16_t
name|tmp
decl_stmt|;
name|uint16_t
name|data
index|[
literal|4
index|]
decl_stmt|;
name|int16_t
name|gain
index|[
literal|2
index|]
decl_stmt|;
name|uint16_t
name|minmax
index|[
literal|2
index|]
decl_stmt|;
specifier|static
specifier|const
name|uint16_t
name|lna_gain
index|[
literal|4
index|]
init|=
block|{
operator|-
literal|2
block|,
literal|10
block|,
literal|19
block|,
literal|25
block|}
decl_stmt|;
if|if
condition|(
name|nphy
operator|->
name|hang_avoid
condition|)
name|bwn_nphy_stay_in_carrier_search
argument_list|(
name|mac
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|nphy
operator|->
name|gain_boost
condition|)
block|{
if|if
condition|(
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_2G
condition|)
block|{
name|gain
index|[
literal|0
index|]
operator|=
literal|6
expr_stmt|;
name|gain
index|[
literal|1
index|]
operator|=
literal|6
expr_stmt|;
block|}
else|else
block|{
name|tmp
operator|=
literal|40370
operator|-
literal|315
operator|*
name|bwn_get_chan
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|gain
index|[
literal|0
index|]
operator|=
operator|(
operator|(
name|tmp
operator|>>
literal|13
operator|)
operator|+
operator|(
operator|(
name|tmp
operator|>>
literal|12
operator|)
operator|&
literal|1
operator|)
operator|)
expr_stmt|;
name|tmp
operator|=
literal|23242
operator|-
literal|224
operator|*
name|bwn_get_chan
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|gain
index|[
literal|1
index|]
operator|=
operator|(
operator|(
name|tmp
operator|>>
literal|13
operator|)
operator|+
operator|(
operator|(
name|tmp
operator|>>
literal|12
operator|)
operator|&
literal|1
operator|)
operator|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|gain
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|gain
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|nphy
operator|->
name|elna_gain_config
condition|)
block|{
name|data
index|[
literal|0
index|]
operator|=
literal|19
operator|+
name|gain
index|[
name|i
index|]
expr_stmt|;
name|data
index|[
literal|1
index|]
operator|=
literal|25
operator|+
name|gain
index|[
name|i
index|]
expr_stmt|;
name|data
index|[
literal|2
index|]
operator|=
literal|25
operator|+
name|gain
index|[
name|i
index|]
expr_stmt|;
name|data
index|[
literal|3
index|]
operator|=
literal|25
operator|+
name|gain
index|[
name|i
index|]
expr_stmt|;
block|}
else|else
block|{
name|data
index|[
literal|0
index|]
operator|=
name|lna_gain
index|[
literal|0
index|]
operator|+
name|gain
index|[
name|i
index|]
expr_stmt|;
name|data
index|[
literal|1
index|]
operator|=
name|lna_gain
index|[
literal|1
index|]
operator|+
name|gain
index|[
name|i
index|]
expr_stmt|;
name|data
index|[
literal|2
index|]
operator|=
name|lna_gain
index|[
literal|2
index|]
operator|+
name|gain
index|[
name|i
index|]
expr_stmt|;
name|data
index|[
literal|3
index|]
operator|=
name|lna_gain
index|[
literal|3
index|]
operator|+
name|gain
index|[
name|i
index|]
expr_stmt|;
block|}
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
name|i
argument_list|,
literal|8
argument_list|)
argument_list|,
literal|4
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|minmax
index|[
name|i
index|]
operator|=
literal|23
operator|+
name|gain
index|[
name|i
index|]
expr_stmt|;
block|}
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_C1_MINMAX_GAIN
argument_list|,
operator|~
name|BWN_NPHY_C1_MINGAIN
argument_list|,
name|minmax
index|[
literal|0
index|]
operator|<<
name|BWN_NPHY_C1_MINGAIN_SHIFT
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_C2_MINMAX_GAIN
argument_list|,
operator|~
name|BWN_NPHY_C2_MINGAIN
argument_list|,
name|minmax
index|[
literal|1
index|]
operator|<<
name|BWN_NPHY_C2_MINGAIN_SHIFT
argument_list|)
expr_stmt|;
if|if
condition|(
name|nphy
operator|->
name|hang_avoid
condition|)
name|bwn_nphy_stay_in_carrier_search
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/SetRfSeq */
end_comment

begin_function
specifier|static
name|void
name|bwn_nphy_set_rf_sequence
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint8_t
name|cmd
parameter_list|,
name|uint8_t
modifier|*
name|events
parameter_list|,
name|uint8_t
modifier|*
name|delays
parameter_list|,
name|uint8_t
name|length
parameter_list|)
block|{
name|struct
name|bwn_phy_n
modifier|*
name|nphy
init|=
name|mac
operator|->
name|mac_phy
operator|.
name|phy_n
decl_stmt|;
name|uint8_t
name|i
decl_stmt|;
name|uint8_t
name|end
init|=
operator|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|3
operator|)
condition|?
literal|0x1F
else|:
literal|0x0F
decl_stmt|;
name|uint16_t
name|offset1
init|=
name|cmd
operator|<<
literal|4
decl_stmt|;
name|uint16_t
name|offset2
init|=
name|offset1
operator|+
literal|0x80
decl_stmt|;
if|if
condition|(
name|nphy
operator|->
name|hang_avoid
condition|)
name|bwn_nphy_stay_in_carrier_search
argument_list|(
name|mac
argument_list|,
name|true
argument_list|)
expr_stmt|;
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB8
argument_list|(
literal|7
argument_list|,
name|offset1
argument_list|)
argument_list|,
name|length
argument_list|,
name|events
argument_list|)
expr_stmt|;
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB8
argument_list|(
literal|7
argument_list|,
name|offset2
argument_list|)
argument_list|,
name|length
argument_list|,
name|delays
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|length
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
block|{
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB8
argument_list|(
literal|7
argument_list|,
name|offset1
operator|+
name|i
argument_list|)
argument_list|,
name|end
argument_list|)
expr_stmt|;
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB8
argument_list|(
literal|7
argument_list|,
name|offset2
operator|+
name|i
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|nphy
operator|->
name|hang_avoid
condition|)
name|bwn_nphy_stay_in_carrier_search
argument_list|(
name|mac
argument_list|,
name|false
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**************************************************  * Radio 0x2057  **************************************************/
end_comment

begin_function
specifier|static
name|void
name|bwn_radio_2057_chantab_upload
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
specifier|const
name|struct
name|bwn_nphy_chantabent_rev7
modifier|*
name|e_r7
parameter_list|,
specifier|const
name|struct
name|bwn_nphy_chantabent_rev7_2g
modifier|*
name|e_r7_2g
parameter_list|)
block|{
if|if
condition|(
name|e_r7_2g
condition|)
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_VCOCAL_COUNTVAL0
argument_list|,
name|e_r7_2g
operator|->
name|radio_vcocal_countval0
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_VCOCAL_COUNTVAL1
argument_list|,
name|e_r7_2g
operator|->
name|radio_vcocal_countval1
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_RFPLL_REFMASTER_SPAREXTALSIZE
argument_list|,
name|e_r7_2g
operator|->
name|radio_rfpll_refmaster_sparextalsize
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_RFPLL_LOOPFILTER_R1
argument_list|,
name|e_r7_2g
operator|->
name|radio_rfpll_loopfilter_r1
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_RFPLL_LOOPFILTER_C2
argument_list|,
name|e_r7_2g
operator|->
name|radio_rfpll_loopfilter_c2
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_RFPLL_LOOPFILTER_C1
argument_list|,
name|e_r7_2g
operator|->
name|radio_rfpll_loopfilter_c1
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_CP_KPD_IDAC
argument_list|,
name|e_r7_2g
operator|->
name|radio_cp_kpd_idac
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_RFPLL_MMD0
argument_list|,
name|e_r7_2g
operator|->
name|radio_rfpll_mmd0
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_RFPLL_MMD1
argument_list|,
name|e_r7_2g
operator|->
name|radio_rfpll_mmd1
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_VCOBUF_TUNE
argument_list|,
name|e_r7_2g
operator|->
name|radio_vcobuf_tune
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_LOGEN_MX2G_TUNE
argument_list|,
name|e_r7_2g
operator|->
name|radio_logen_mx2g_tune
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_LOGEN_INDBUF2G_TUNE
argument_list|,
name|e_r7_2g
operator|->
name|radio_logen_indbuf2g_tune
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_TXMIX2G_TUNE_BOOST_PU_CORE0
argument_list|,
name|e_r7_2g
operator|->
name|radio_txmix2g_tune_boost_pu_core0
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_PAD2G_TUNE_PUS_CORE0
argument_list|,
name|e_r7_2g
operator|->
name|radio_pad2g_tune_pus_core0
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_LNA2G_TUNE_CORE0
argument_list|,
name|e_r7_2g
operator|->
name|radio_lna2g_tune_core0
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_TXMIX2G_TUNE_BOOST_PU_CORE1
argument_list|,
name|e_r7_2g
operator|->
name|radio_txmix2g_tune_boost_pu_core1
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_PAD2G_TUNE_PUS_CORE1
argument_list|,
name|e_r7_2g
operator|->
name|radio_pad2g_tune_pus_core1
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_LNA2G_TUNE_CORE1
argument_list|,
name|e_r7_2g
operator|->
name|radio_lna2g_tune_core1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_VCOCAL_COUNTVAL0
argument_list|,
name|e_r7
operator|->
name|radio_vcocal_countval0
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_VCOCAL_COUNTVAL1
argument_list|,
name|e_r7
operator|->
name|radio_vcocal_countval1
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_RFPLL_REFMASTER_SPAREXTALSIZE
argument_list|,
name|e_r7
operator|->
name|radio_rfpll_refmaster_sparextalsize
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_RFPLL_LOOPFILTER_R1
argument_list|,
name|e_r7
operator|->
name|radio_rfpll_loopfilter_r1
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_RFPLL_LOOPFILTER_C2
argument_list|,
name|e_r7
operator|->
name|radio_rfpll_loopfilter_c2
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_RFPLL_LOOPFILTER_C1
argument_list|,
name|e_r7
operator|->
name|radio_rfpll_loopfilter_c1
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_CP_KPD_IDAC
argument_list|,
name|e_r7
operator|->
name|radio_cp_kpd_idac
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_RFPLL_MMD0
argument_list|,
name|e_r7
operator|->
name|radio_rfpll_mmd0
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_RFPLL_MMD1
argument_list|,
name|e_r7
operator|->
name|radio_rfpll_mmd1
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_VCOBUF_TUNE
argument_list|,
name|e_r7
operator|->
name|radio_vcobuf_tune
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_LOGEN_MX2G_TUNE
argument_list|,
name|e_r7
operator|->
name|radio_logen_mx2g_tune
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_LOGEN_MX5G_TUNE
argument_list|,
name|e_r7
operator|->
name|radio_logen_mx5g_tune
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_LOGEN_INDBUF2G_TUNE
argument_list|,
name|e_r7
operator|->
name|radio_logen_indbuf2g_tune
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_LOGEN_INDBUF5G_TUNE
argument_list|,
name|e_r7
operator|->
name|radio_logen_indbuf5g_tune
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_TXMIX2G_TUNE_BOOST_PU_CORE0
argument_list|,
name|e_r7
operator|->
name|radio_txmix2g_tune_boost_pu_core0
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_PAD2G_TUNE_PUS_CORE0
argument_list|,
name|e_r7
operator|->
name|radio_pad2g_tune_pus_core0
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_PGA_BOOST_TUNE_CORE0
argument_list|,
name|e_r7
operator|->
name|radio_pga_boost_tune_core0
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_TXMIX5G_BOOST_TUNE_CORE0
argument_list|,
name|e_r7
operator|->
name|radio_txmix5g_boost_tune_core0
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_PAD5G_TUNE_MISC_PUS_CORE0
argument_list|,
name|e_r7
operator|->
name|radio_pad5g_tune_misc_pus_core0
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_LNA2G_TUNE_CORE0
argument_list|,
name|e_r7
operator|->
name|radio_lna2g_tune_core0
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_LNA5G_TUNE_CORE0
argument_list|,
name|e_r7
operator|->
name|radio_lna5g_tune_core0
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_TXMIX2G_TUNE_BOOST_PU_CORE1
argument_list|,
name|e_r7
operator|->
name|radio_txmix2g_tune_boost_pu_core1
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_PAD2G_TUNE_PUS_CORE1
argument_list|,
name|e_r7
operator|->
name|radio_pad2g_tune_pus_core1
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_PGA_BOOST_TUNE_CORE1
argument_list|,
name|e_r7
operator|->
name|radio_pga_boost_tune_core1
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_TXMIX5G_BOOST_TUNE_CORE1
argument_list|,
name|e_r7
operator|->
name|radio_txmix5g_boost_tune_core1
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_PAD5G_TUNE_MISC_PUS_CORE1
argument_list|,
name|e_r7
operator|->
name|radio_pad5g_tune_misc_pus_core1
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_LNA2G_TUNE_CORE1
argument_list|,
name|e_r7
operator|->
name|radio_lna2g_tune_core1
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_LNA5G_TUNE_CORE1
argument_list|,
name|e_r7
operator|->
name|radio_lna5g_tune_core1
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_radio_2057_setup
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
specifier|const
name|struct
name|bwn_nphy_chantabent_rev7
modifier|*
name|tabent_r7
parameter_list|,
specifier|const
name|struct
name|bwn_nphy_chantabent_rev7_2g
modifier|*
name|tabent_r7_2g
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|bwn_radio_2057_chantab_upload
argument_list|(
name|mac
argument_list|,
name|tabent_r7
argument_list|,
name|tabent_r7_2g
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|phy
operator|->
name|rf_rev
condition|)
block|{
case|case
literal|0
operator|...
literal|4
case|:
case|case
literal|6
case|:
if|if
condition|(
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_2G
condition|)
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_RFPLL_LOOPFILTER_R1
argument_list|,
literal|0x3f
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_CP_KPD_IDAC
argument_list|,
literal|0x3f
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_RFPLL_LOOPFILTER_C1
argument_list|,
literal|0x8
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_RFPLL_LOOPFILTER_C2
argument_list|,
literal|0x8
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_RFPLL_LOOPFILTER_R1
argument_list|,
literal|0x1f
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_CP_KPD_IDAC
argument_list|,
literal|0x3f
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_RFPLL_LOOPFILTER_C1
argument_list|,
literal|0x8
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_RFPLL_LOOPFILTER_C2
argument_list|,
literal|0x8
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|9
case|:
comment|/* e.g. PHY rev 16 */
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_LOGEN_PTAT_RESETS
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_VCOBUF_IDACS
argument_list|,
literal|0x18
argument_list|)
expr_stmt|;
if|if
condition|(
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_5G
condition|)
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_LOGEN_PTAT_RESETS
argument_list|,
literal|0x38
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_VCOBUF_IDACS
argument_list|,
literal|0x0f
argument_list|)
expr_stmt|;
if|if
condition|(
name|bwn_is_40mhz
argument_list|(
name|mac
argument_list|)
condition|)
block|{
comment|/* TODO */
block|}
else|else
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_PAD_BIAS_FILTER_BWS_CORE0
argument_list|,
literal|0x3c
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_PAD_BIAS_FILTER_BWS_CORE1
argument_list|,
literal|0x3c
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
case|case
literal|14
case|:
comment|/* 2 GHz only */
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_RFPLL_LOOPFILTER_R1
argument_list|,
literal|0x1b
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_CP_KPD_IDAC
argument_list|,
literal|0x3f
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_RFPLL_LOOPFILTER_C1
argument_list|,
literal|0x1f
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_RFPLL_LOOPFILTER_C2
argument_list|,
literal|0x1f
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_2G
condition|)
block|{
name|uint16_t
name|txmix2g_tune_boost_pu
init|=
literal|0
decl_stmt|;
name|uint16_t
name|pad2g_tune_pus
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|bwn_nphy_ipa
argument_list|(
name|mac
argument_list|)
condition|)
block|{
switch|switch
condition|(
name|phy
operator|->
name|rf_rev
condition|)
block|{
case|case
literal|9
case|:
name|txmix2g_tune_boost_pu
operator|=
literal|0x0041
expr_stmt|;
comment|/* TODO */
break|break;
case|case
literal|14
case|:
name|txmix2g_tune_boost_pu
operator|=
literal|0x21
expr_stmt|;
name|pad2g_tune_pus
operator|=
literal|0x23
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|txmix2g_tune_boost_pu
condition|)
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_TXMIX2G_TUNE_BOOST_PU_CORE0
argument_list|,
name|txmix2g_tune_boost_pu
argument_list|)
expr_stmt|;
if|if
condition|(
name|pad2g_tune_pus
condition|)
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_PAD2G_TUNE_PUS_CORE0
argument_list|,
name|pad2g_tune_pus
argument_list|)
expr_stmt|;
if|if
condition|(
name|txmix2g_tune_boost_pu
condition|)
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_TXMIX2G_TUNE_BOOST_PU_CORE1
argument_list|,
name|txmix2g_tune_boost_pu
argument_list|)
expr_stmt|;
if|if
condition|(
name|pad2g_tune_pus
condition|)
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_PAD2G_TUNE_PUS_CORE1
argument_list|,
name|pad2g_tune_pus
argument_list|)
expr_stmt|;
block|}
comment|/* 50..100 */
name|DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
comment|/* VCO calibration */
name|BWN_RF_MASK
argument_list|(
name|mac
argument_list|,
name|R2057_RFPLL_MISC_EN
argument_list|,
operator|~
literal|0x01
argument_list|)
expr_stmt|;
name|BWN_RF_MASK
argument_list|(
name|mac
argument_list|,
name|R2057_RFPLL_MISC_CAL_RESETN
argument_list|,
operator|~
literal|0x04
argument_list|)
expr_stmt|;
name|BWN_RF_SET
argument_list|(
name|mac
argument_list|,
name|R2057_RFPLL_MISC_CAL_RESETN
argument_list|,
literal|0x4
argument_list|)
expr_stmt|;
name|BWN_RF_SET
argument_list|(
name|mac
argument_list|,
name|R2057_RFPLL_MISC_EN
argument_list|,
literal|0x01
argument_list|)
expr_stmt|;
comment|/* 300..600 */
name|DELAY
argument_list|(
literal|600
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Calibrate resistors in LPF of PLL?  * http://bcm-v4.sipsolutions.net/PHY/radio205x_rcal  */
end_comment

begin_function
specifier|static
name|uint8_t
name|bwn_radio_2057_rcal
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|uint16_t
name|saved_regs_phy
index|[
literal|12
index|]
decl_stmt|;
name|uint16_t
name|saved_regs_phy_rf
index|[
literal|6
index|]
decl_stmt|;
name|uint16_t
name|saved_regs_radio
index|[
literal|2
index|]
init|=
block|{ }
decl_stmt|;
specifier|static
specifier|const
name|uint16_t
name|phy_to_store
index|[]
init|=
block|{
name|BWN_NPHY_RFCTL_RSSIO1
block|,
name|BWN_NPHY_RFCTL_RSSIO2
block|,
name|BWN_NPHY_RFCTL_LUT_TRSW_LO1
block|,
name|BWN_NPHY_RFCTL_LUT_TRSW_LO2
block|,
name|BWN_NPHY_RFCTL_RXG1
block|,
name|BWN_NPHY_RFCTL_RXG2
block|,
name|BWN_NPHY_RFCTL_TXG1
block|,
name|BWN_NPHY_RFCTL_TXG2
block|,
name|BWN_NPHY_REV7_RF_CTL_MISC_REG3
block|,
name|BWN_NPHY_REV7_RF_CTL_MISC_REG4
block|,
name|BWN_NPHY_REV7_RF_CTL_MISC_REG5
block|,
name|BWN_NPHY_REV7_RF_CTL_MISC_REG6
block|, 	}
decl_stmt|;
specifier|static
specifier|const
name|uint16_t
name|phy_to_store_rf
index|[]
init|=
block|{
name|BWN_NPHY_REV3_RFCTL_OVER0
block|,
name|BWN_NPHY_REV3_RFCTL_OVER1
block|,
name|BWN_NPHY_REV7_RF_CTL_OVER3
block|,
name|BWN_NPHY_REV7_RF_CTL_OVER4
block|,
name|BWN_NPHY_REV7_RF_CTL_OVER5
block|,
name|BWN_NPHY_REV7_RF_CTL_OVER6
block|, 	}
decl_stmt|;
name|uint16_t
name|tmp
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* Save */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nitems
argument_list|(
name|phy_to_store
argument_list|)
condition|;
name|i
operator|++
control|)
name|saved_regs_phy
index|[
name|i
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|phy_to_store
index|[
name|i
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nitems
argument_list|(
name|phy_to_store_rf
argument_list|)
condition|;
name|i
operator|++
control|)
name|saved_regs_phy_rf
index|[
name|i
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|phy_to_store_rf
index|[
name|i
index|]
argument_list|)
expr_stmt|;
comment|/* Set */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nitems
argument_list|(
name|phy_to_store
argument_list|)
condition|;
name|i
operator|++
control|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|phy_to_store
index|[
name|i
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_REV3_RFCTL_OVER0
argument_list|,
literal|0x07ff
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_REV3_RFCTL_OVER1
argument_list|,
literal|0x07ff
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_REV7_RF_CTL_OVER3
argument_list|,
literal|0x07ff
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_REV7_RF_CTL_OVER4
argument_list|,
literal|0x07ff
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_REV7_RF_CTL_OVER5
argument_list|,
literal|0x007f
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_REV7_RF_CTL_OVER6
argument_list|,
literal|0x007f
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|phy
operator|->
name|rf_rev
condition|)
block|{
case|case
literal|5
case|:
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_REV7_RF_CTL_OVER3
argument_list|,
operator|~
literal|0x2
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|BWN_RF_SET
argument_list|(
name|mac
argument_list|,
name|R2057_IQTEST_SEL_PU
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
name|BWN_RF_SETMASK
argument_list|(
name|mac
argument_list|,
name|R2057v7_IQTEST_SEL_PU2
argument_list|,
operator|~
literal|0x2
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|9
case|:
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_REV7_RF_CTL_OVER3
argument_list|,
literal|0x2
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_REV7_RF_CTL_MISC_REG3
argument_list|,
literal|0x2
argument_list|)
expr_stmt|;
name|saved_regs_radio
index|[
literal|0
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
name|R2057_IQTEST_SEL_PU
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_IQTEST_SEL_PU
argument_list|,
literal|0x11
argument_list|)
expr_stmt|;
break|break;
case|case
literal|14
case|:
name|saved_regs_radio
index|[
literal|0
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
name|R2057_IQTEST_SEL_PU
argument_list|)
expr_stmt|;
name|saved_regs_radio
index|[
literal|1
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
name|R2057v7_IQTEST_SEL_PU2
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_REV7_RF_CTL_MISC_REG3
argument_list|,
literal|0x2
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_REV7_RF_CTL_OVER3
argument_list|,
literal|0x2
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057v7_IQTEST_SEL_PU2
argument_list|,
literal|0x2
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_IQTEST_SEL_PU
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* Enable */
name|BWN_RF_SET
argument_list|(
name|mac
argument_list|,
name|R2057_RCAL_CONFIG
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
comment|/* Start */
name|BWN_RF_SET
argument_list|(
name|mac
argument_list|,
name|R2057_RCAL_CONFIG
argument_list|,
literal|0x2
argument_list|)
expr_stmt|;
comment|/* 100..200 */
name|DELAY
argument_list|(
literal|200
argument_list|)
expr_stmt|;
comment|/* Stop */
name|BWN_RF_MASK
argument_list|(
name|mac
argument_list|,
name|R2057_RCAL_CONFIG
argument_list|,
operator|~
literal|0x2
argument_list|)
expr_stmt|;
comment|/* Wait and check for result */
if|if
condition|(
operator|!
name|bwn_radio_wait_value
argument_list|(
name|mac
argument_list|,
name|R2057_RCAL_STATUS
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|100
argument_list|,
literal|1000000
argument_list|)
condition|)
block|{
name|BWN_ERRPRINTF
argument_list|(
name|mac
operator|->
name|mac_sc
argument_list|,
literal|"Radio 0x2057 rcal timeout\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|tmp
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
name|R2057_RCAL_STATUS
argument_list|)
operator|&
literal|0x3E
expr_stmt|;
comment|/* Disable */
name|BWN_RF_MASK
argument_list|(
name|mac
argument_list|,
name|R2057_RCAL_CONFIG
argument_list|,
operator|~
literal|0x1
argument_list|)
expr_stmt|;
comment|/* Restore */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nitems
argument_list|(
name|phy_to_store_rf
argument_list|)
condition|;
name|i
operator|++
control|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|phy_to_store_rf
index|[
name|i
index|]
argument_list|,
name|saved_regs_phy_rf
index|[
name|i
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nitems
argument_list|(
name|phy_to_store
argument_list|)
condition|;
name|i
operator|++
control|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|phy_to_store
index|[
name|i
index|]
argument_list|,
name|saved_regs_phy
index|[
name|i
index|]
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|phy
operator|->
name|rf_rev
condition|)
block|{
case|case
literal|0
operator|...
literal|4
case|:
case|case
literal|6
case|:
name|BWN_RF_SETMASK
argument_list|(
name|mac
argument_list|,
name|R2057_TEMPSENSE_CONFIG
argument_list|,
operator|~
literal|0x3C
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|BWN_RF_SETMASK
argument_list|(
name|mac
argument_list|,
name|R2057_BANDGAP_RCAL_TRIM
argument_list|,
operator|~
literal|0xF0
argument_list|,
name|tmp
operator|<<
literal|2
argument_list|)
expr_stmt|;
break|break;
case|case
literal|5
case|:
name|BWN_RF_MASK
argument_list|(
name|mac
argument_list|,
name|R2057_IPA2G_CASCONV_CORE0
argument_list|,
operator|~
literal|0x1
argument_list|)
expr_stmt|;
name|BWN_RF_MASK
argument_list|(
name|mac
argument_list|,
name|R2057v7_IQTEST_SEL_PU2
argument_list|,
operator|~
literal|0x2
argument_list|)
expr_stmt|;
break|break;
case|case
literal|9
case|:
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_IQTEST_SEL_PU
argument_list|,
name|saved_regs_radio
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|14
case|:
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_IQTEST_SEL_PU
argument_list|,
name|saved_regs_radio
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057v7_IQTEST_SEL_PU2
argument_list|,
name|saved_regs_radio
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
name|tmp
operator|&
literal|0x3e
return|;
block|}
end_function

begin_comment
comment|/* Calibrate the internal RC oscillator?  * http://bcm-v4.sipsolutions.net/PHY/radio2057_rccal  */
end_comment

begin_function
specifier|static
name|uint16_t
name|bwn_radio_2057_rccal
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|bool
name|special
init|=
operator|(
name|phy
operator|->
name|rf_rev
operator|==
literal|3
operator|||
name|phy
operator|->
name|rf_rev
operator|==
literal|4
operator|||
name|phy
operator|->
name|rf_rev
operator|==
literal|6
operator|)
decl_stmt|;
name|uint16_t
name|tmp
decl_stmt|;
comment|/* Setup cal */
if|if
condition|(
name|special
condition|)
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_RCCAL_MASTER
argument_list|,
literal|0x61
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_RCCAL_TRC0
argument_list|,
literal|0xC0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057v7_RCCAL_MASTER
argument_list|,
literal|0x61
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_RCCAL_TRC0
argument_list|,
literal|0xE9
argument_list|)
expr_stmt|;
block|}
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_RCCAL_X1
argument_list|,
literal|0x6E
argument_list|)
expr_stmt|;
comment|/* Start, wait, stop */
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_RCCAL_START_R1_Q1_P1
argument_list|,
literal|0x55
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bwn_radio_wait_value
argument_list|(
name|mac
argument_list|,
name|R2057_RCCAL_DONE_OSCCAP
argument_list|,
literal|2
argument_list|,
literal|2
argument_list|,
literal|500
argument_list|,
literal|5000000
argument_list|)
condition|)
name|BWN_DBGPRINTF
argument_list|(
name|mac
argument_list|,
literal|"Radio 0x2057 rccal timeout\n"
argument_list|)
expr_stmt|;
comment|/* 35..70 */
name|DELAY
argument_list|(
literal|70
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_RCCAL_START_R1_Q1_P1
argument_list|,
literal|0x15
argument_list|)
expr_stmt|;
comment|/* 70..140 */
name|DELAY
argument_list|(
literal|140
argument_list|)
expr_stmt|;
comment|/* Setup cal */
if|if
condition|(
name|special
condition|)
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_RCCAL_MASTER
argument_list|,
literal|0x69
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_RCCAL_TRC0
argument_list|,
literal|0xB0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057v7_RCCAL_MASTER
argument_list|,
literal|0x69
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_RCCAL_TRC0
argument_list|,
literal|0xD5
argument_list|)
expr_stmt|;
block|}
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_RCCAL_X1
argument_list|,
literal|0x6E
argument_list|)
expr_stmt|;
comment|/* Start, wait, stop */
comment|/* 35..70 */
name|DELAY
argument_list|(
literal|70
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_RCCAL_START_R1_Q1_P1
argument_list|,
literal|0x55
argument_list|)
expr_stmt|;
comment|/* 70..140 */
name|DELAY
argument_list|(
literal|140
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bwn_radio_wait_value
argument_list|(
name|mac
argument_list|,
name|R2057_RCCAL_DONE_OSCCAP
argument_list|,
literal|2
argument_list|,
literal|2
argument_list|,
literal|500
argument_list|,
literal|5000000
argument_list|)
condition|)
name|BWN_DBGPRINTF
argument_list|(
name|mac
argument_list|,
literal|"Radio 0x2057 rccal timeout\n"
argument_list|)
expr_stmt|;
comment|/* 35..70 */
name|DELAY
argument_list|(
literal|70
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_RCCAL_START_R1_Q1_P1
argument_list|,
literal|0x15
argument_list|)
expr_stmt|;
comment|/* 70..140 */
name|DELAY
argument_list|(
literal|140
argument_list|)
expr_stmt|;
comment|/* Setup cal */
if|if
condition|(
name|special
condition|)
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_RCCAL_MASTER
argument_list|,
literal|0x73
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_RCCAL_X1
argument_list|,
literal|0x28
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_RCCAL_TRC0
argument_list|,
literal|0xB0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057v7_RCCAL_MASTER
argument_list|,
literal|0x73
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_RCCAL_X1
argument_list|,
literal|0x6E
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_RCCAL_TRC0
argument_list|,
literal|0x99
argument_list|)
expr_stmt|;
block|}
comment|/* Start, wait, stop */
comment|/* 35..70 */
name|DELAY
argument_list|(
literal|70
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_RCCAL_START_R1_Q1_P1
argument_list|,
literal|0x55
argument_list|)
expr_stmt|;
comment|/* 70..140 */
name|DELAY
argument_list|(
literal|140
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bwn_radio_wait_value
argument_list|(
name|mac
argument_list|,
name|R2057_RCCAL_DONE_OSCCAP
argument_list|,
literal|2
argument_list|,
literal|2
argument_list|,
literal|500
argument_list|,
literal|5000000
argument_list|)
condition|)
block|{
name|BWN_ERRPRINTF
argument_list|(
name|mac
operator|->
name|mac_sc
argument_list|,
literal|"Radio 0x2057 rcal timeout\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|tmp
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
name|R2057_RCCAL_DONE_OSCCAP
argument_list|)
expr_stmt|;
comment|/* 35..70 */
name|DELAY
argument_list|(
literal|70
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_RCCAL_START_R1_Q1_P1
argument_list|,
literal|0x15
argument_list|)
expr_stmt|;
comment|/* 70..140 */
name|DELAY
argument_list|(
literal|140
argument_list|)
expr_stmt|;
if|if
condition|(
name|special
condition|)
name|BWN_RF_MASK
argument_list|(
name|mac
argument_list|,
name|R2057_RCCAL_MASTER
argument_list|,
operator|~
literal|0x1
argument_list|)
expr_stmt|;
else|else
name|BWN_RF_MASK
argument_list|(
name|mac
argument_list|,
name|R2057v7_RCCAL_MASTER
argument_list|,
operator|~
literal|0x1
argument_list|)
expr_stmt|;
return|return
name|tmp
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_radio_2057_init_pre
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_CMD
argument_list|,
operator|~
name|BWN_NPHY_RFCTL_CMD_CHIP0PU
argument_list|)
expr_stmt|;
comment|/* Maybe wl meant to reset and set (order?) RFCTL_CMD_OEPORFORCE? */
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_CMD
argument_list|,
name|BWN_NPHY_RFCTL_CMD_OEPORFORCE
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_CMD
argument_list|,
operator|~
name|BWN_NPHY_RFCTL_CMD_OEPORFORCE
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_CMD
argument_list|,
name|BWN_NPHY_RFCTL_CMD_CHIP0PU
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_radio_2057_init_post
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|BWN_RF_SET
argument_list|(
name|mac
argument_list|,
name|R2057_XTALPUOVR_PINCTRL
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
if|if
condition|(
literal|0
condition|)
comment|/* FIXME: Is this BCM43217 specific? */
name|BWN_RF_SET
argument_list|(
name|mac
argument_list|,
name|R2057_XTALPUOVR_PINCTRL
argument_list|,
literal|0x2
argument_list|)
expr_stmt|;
name|BWN_RF_SET
argument_list|(
name|mac
argument_list|,
name|R2057_RFPLL_MISC_CAL_RESETN
argument_list|,
literal|0x78
argument_list|)
expr_stmt|;
name|BWN_RF_SET
argument_list|(
name|mac
argument_list|,
name|R2057_XTAL_CONFIG2
argument_list|,
literal|0x80
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|2000
argument_list|)
expr_stmt|;
name|BWN_RF_MASK
argument_list|(
name|mac
argument_list|,
name|R2057_RFPLL_MISC_CAL_RESETN
argument_list|,
operator|~
literal|0x78
argument_list|)
expr_stmt|;
name|BWN_RF_MASK
argument_list|(
name|mac
argument_list|,
name|R2057_XTAL_CONFIG2
argument_list|,
operator|~
literal|0x80
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|phy_do_full_init
condition|)
block|{
name|bwn_radio_2057_rcal
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|bwn_radio_2057_rccal
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
name|BWN_RF_MASK
argument_list|(
name|mac
argument_list|,
name|R2057_RFPLL_MASTER
argument_list|,
operator|~
literal|0x8
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/Radio/2057/Init */
end_comment

begin_function
specifier|static
name|void
name|bwn_radio_2057_init
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|bwn_radio_2057_init_pre
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|r2057_upload_inittabs
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|bwn_radio_2057_init_post
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**************************************************  * Radio 0x2056  **************************************************/
end_comment

begin_function
specifier|static
name|void
name|bwn_chantab_radio_2056_upload
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
specifier|const
name|struct
name|bwn_nphy_channeltab_entry_rev3
modifier|*
name|e
parameter_list|)
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_SYN_PLL_VCOCAL1
argument_list|,
name|e
operator|->
name|radio_syn_pll_vcocal1
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_SYN_PLL_VCOCAL2
argument_list|,
name|e
operator|->
name|radio_syn_pll_vcocal2
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_SYN_PLL_REFDIV
argument_list|,
name|e
operator|->
name|radio_syn_pll_refdiv
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_SYN_PLL_MMD2
argument_list|,
name|e
operator|->
name|radio_syn_pll_mmd2
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_SYN_PLL_MMD1
argument_list|,
name|e
operator|->
name|radio_syn_pll_mmd1
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_SYN_PLL_LOOPFILTER1
argument_list|,
name|e
operator|->
name|radio_syn_pll_loopfilter1
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_SYN_PLL_LOOPFILTER2
argument_list|,
name|e
operator|->
name|radio_syn_pll_loopfilter2
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_SYN_PLL_LOOPFILTER3
argument_list|,
name|e
operator|->
name|radio_syn_pll_loopfilter3
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_SYN_PLL_LOOPFILTER4
argument_list|,
name|e
operator|->
name|radio_syn_pll_loopfilter4
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_SYN_PLL_LOOPFILTER5
argument_list|,
name|e
operator|->
name|radio_syn_pll_loopfilter5
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_SYN_RESERVED_ADDR27
argument_list|,
name|e
operator|->
name|radio_syn_reserved_addr27
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_SYN_RESERVED_ADDR28
argument_list|,
name|e
operator|->
name|radio_syn_reserved_addr28
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_SYN_RESERVED_ADDR29
argument_list|,
name|e
operator|->
name|radio_syn_reserved_addr29
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_SYN_LOGEN_VCOBUF1
argument_list|,
name|e
operator|->
name|radio_syn_logen_vcobuf1
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_SYN_LOGEN_MIXER2
argument_list|,
name|e
operator|->
name|radio_syn_logen_mixer2
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_SYN_LOGEN_BUF3
argument_list|,
name|e
operator|->
name|radio_syn_logen_buf3
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_SYN_LOGEN_BUF4
argument_list|,
name|e
operator|->
name|radio_syn_logen_buf4
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_RX0
operator||
name|B2056_RX_LNAA_TUNE
argument_list|,
name|e
operator|->
name|radio_rx0_lnaa_tune
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_RX0
operator||
name|B2056_RX_LNAG_TUNE
argument_list|,
name|e
operator|->
name|radio_rx0_lnag_tune
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_TX0
operator||
name|B2056_TX_INTPAA_BOOST_TUNE
argument_list|,
name|e
operator|->
name|radio_tx0_intpaa_boost_tune
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_TX0
operator||
name|B2056_TX_INTPAG_BOOST_TUNE
argument_list|,
name|e
operator|->
name|radio_tx0_intpag_boost_tune
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_TX0
operator||
name|B2056_TX_PADA_BOOST_TUNE
argument_list|,
name|e
operator|->
name|radio_tx0_pada_boost_tune
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_TX0
operator||
name|B2056_TX_PADG_BOOST_TUNE
argument_list|,
name|e
operator|->
name|radio_tx0_padg_boost_tune
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_TX0
operator||
name|B2056_TX_PGAA_BOOST_TUNE
argument_list|,
name|e
operator|->
name|radio_tx0_pgaa_boost_tune
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_TX0
operator||
name|B2056_TX_PGAG_BOOST_TUNE
argument_list|,
name|e
operator|->
name|radio_tx0_pgag_boost_tune
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_TX0
operator||
name|B2056_TX_MIXA_BOOST_TUNE
argument_list|,
name|e
operator|->
name|radio_tx0_mixa_boost_tune
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_TX0
operator||
name|B2056_TX_MIXG_BOOST_TUNE
argument_list|,
name|e
operator|->
name|radio_tx0_mixg_boost_tune
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_RX1
operator||
name|B2056_RX_LNAA_TUNE
argument_list|,
name|e
operator|->
name|radio_rx1_lnaa_tune
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_RX1
operator||
name|B2056_RX_LNAG_TUNE
argument_list|,
name|e
operator|->
name|radio_rx1_lnag_tune
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_TX1
operator||
name|B2056_TX_INTPAA_BOOST_TUNE
argument_list|,
name|e
operator|->
name|radio_tx1_intpaa_boost_tune
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_TX1
operator||
name|B2056_TX_INTPAG_BOOST_TUNE
argument_list|,
name|e
operator|->
name|radio_tx1_intpag_boost_tune
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_TX1
operator||
name|B2056_TX_PADA_BOOST_TUNE
argument_list|,
name|e
operator|->
name|radio_tx1_pada_boost_tune
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_TX1
operator||
name|B2056_TX_PADG_BOOST_TUNE
argument_list|,
name|e
operator|->
name|radio_tx1_padg_boost_tune
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_TX1
operator||
name|B2056_TX_PGAA_BOOST_TUNE
argument_list|,
name|e
operator|->
name|radio_tx1_pgaa_boost_tune
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_TX1
operator||
name|B2056_TX_PGAG_BOOST_TUNE
argument_list|,
name|e
operator|->
name|radio_tx1_pgag_boost_tune
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_TX1
operator||
name|B2056_TX_MIXA_BOOST_TUNE
argument_list|,
name|e
operator|->
name|radio_tx1_mixa_boost_tune
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_TX1
operator||
name|B2056_TX_MIXG_BOOST_TUNE
argument_list|,
name|e
operator|->
name|radio_tx1_mixg_boost_tune
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/Radio/2056Setup */
end_comment

begin_function
specifier|static
name|void
name|bwn_radio_2056_setup
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
specifier|const
name|struct
name|bwn_nphy_channeltab_entry_rev3
modifier|*
name|e
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|bwn_band_t
name|band
init|=
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
decl_stmt|;
name|uint16_t
name|offset
decl_stmt|;
name|uint8_t
name|i
decl_stmt|;
name|uint16_t
name|bias
decl_stmt|,
name|cbias
decl_stmt|;
name|uint16_t
name|pag_boost
decl_stmt|,
name|padg_boost
decl_stmt|,
name|pgag_boost
decl_stmt|,
name|mixg_boost
decl_stmt|;
name|uint16_t
name|paa_boost
decl_stmt|,
name|pada_boost
decl_stmt|,
name|pgaa_boost
decl_stmt|,
name|mixa_boost
decl_stmt|;
name|bool
name|is_pkg_fab_smic
decl_stmt|;
name|DPRINTF
argument_list|(
name|mac
operator|->
name|mac_sc
argument_list|,
name|BWN_DEBUG_RF
argument_list|,
literal|"%s: called\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|<
literal|3
condition|)
block|{
name|BWN_ERRPRINTF
argument_list|(
name|mac
operator|->
name|mac_sc
argument_list|,
literal|"%s: phy rev %d out of range\n"
argument_list|,
name|__func__
argument_list|,
name|mac
operator|->
name|mac_phy
operator|.
name|rev
argument_list|)
expr_stmt|;
block|}
name|is_pkg_fab_smic
operator|=
operator|(
operator|(
name|siba_get_chipid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
name|BCMA_CHIP_ID_BCM43224
operator|||
name|siba_get_chipid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
name|BCMA_CHIP_ID_BCM43225
operator|||
name|siba_get_chipid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
name|BCMA_CHIP_ID_BCM43421
operator|)
operator|&&
name|siba_get_chippkg
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
name|BCMA_PKG_ID_BCM43224_FAB_SMIC
operator|)
expr_stmt|;
name|bwn_chantab_radio_2056_upload
argument_list|(
name|mac
argument_list|,
name|e
argument_list|)
expr_stmt|;
name|b2056_upload_syn_pll_cp2
argument_list|(
name|mac
argument_list|,
name|band
operator|==
name|BWN_BAND_5G
argument_list|)
expr_stmt|;
if|if
condition|(
name|siba_sprom_get_bf2_lo
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|&
name|BWN_BFL2_GPLL_WAR
operator|&&
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_2G
condition|)
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_SYN_PLL_LOOPFILTER1
argument_list|,
literal|0x1F
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_SYN_PLL_LOOPFILTER2
argument_list|,
literal|0x1F
argument_list|)
expr_stmt|;
if|if
condition|(
name|siba_get_chipid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
name|BCMA_CHIP_ID_BCM4716
operator|||
name|siba_get_chipid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
name|BCMA_CHIP_ID_BCM47162
condition|)
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_SYN_PLL_LOOPFILTER4
argument_list|,
literal|0x14
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_SYN_PLL_CP2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_SYN_PLL_LOOPFILTER4
argument_list|,
literal|0x0B
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_SYN_PLL_CP2
argument_list|,
literal|0x14
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|siba_sprom_get_bf2_hi
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|&
name|BWN_BFH2_GPLL_WAR2
operator|&&
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_2G
condition|)
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_SYN_PLL_LOOPFILTER1
argument_list|,
literal|0x1f
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_SYN_PLL_LOOPFILTER2
argument_list|,
literal|0x1f
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_SYN_PLL_LOOPFILTER4
argument_list|,
literal|0x0b
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_SYN_PLL_CP2
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|siba_sprom_get_bf2_lo
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|&
name|BWN_BFL2_APLL_WAR
operator|&&
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_5G
condition|)
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_SYN_PLL_LOOPFILTER1
argument_list|,
literal|0x1F
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_SYN_PLL_LOOPFILTER2
argument_list|,
literal|0x1F
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_SYN_PLL_LOOPFILTER4
argument_list|,
literal|0x05
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_SYN_PLL_CP2
argument_list|,
literal|0x0C
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|phy_n
operator|->
name|ipa2g_on
operator|&&
name|band
operator|==
name|BWN_BAND_2G
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
block|{
name|offset
operator|=
name|i
condition|?
name|B2056_TX1
else|:
name|B2056_TX0
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|5
condition|)
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|offset
operator||
name|B2056_TX_PADG_IDAC
argument_list|,
literal|0xcc
argument_list|)
expr_stmt|;
if|if
condition|(
name|siba_get_chipid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
name|BCMA_CHIP_ID_BCM4716
operator|||
name|siba_get_chipid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
name|BCMA_CHIP_ID_BCM47162
condition|)
block|{
name|bias
operator|=
literal|0x40
expr_stmt|;
name|cbias
operator|=
literal|0x45
expr_stmt|;
name|pag_boost
operator|=
literal|0x5
expr_stmt|;
name|pgag_boost
operator|=
literal|0x33
expr_stmt|;
name|mixg_boost
operator|=
literal|0x55
expr_stmt|;
block|}
else|else
block|{
name|bias
operator|=
literal|0x25
expr_stmt|;
name|cbias
operator|=
literal|0x20
expr_stmt|;
if|if
condition|(
name|is_pkg_fab_smic
condition|)
block|{
name|bias
operator|=
literal|0x2a
expr_stmt|;
name|cbias
operator|=
literal|0x38
expr_stmt|;
block|}
name|pag_boost
operator|=
literal|0x4
expr_stmt|;
name|pgag_boost
operator|=
literal|0x03
expr_stmt|;
name|mixg_boost
operator|=
literal|0x65
expr_stmt|;
block|}
name|padg_boost
operator|=
literal|0x77
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|offset
operator||
name|B2056_TX_INTPAG_IMAIN_STAT
argument_list|,
name|bias
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|offset
operator||
name|B2056_TX_INTPAG_IAUX_STAT
argument_list|,
name|bias
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|offset
operator||
name|B2056_TX_INTPAG_CASCBIAS
argument_list|,
name|cbias
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|offset
operator||
name|B2056_TX_INTPAG_BOOST_TUNE
argument_list|,
name|pag_boost
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|offset
operator||
name|B2056_TX_PGAG_BOOST_TUNE
argument_list|,
name|pgag_boost
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|offset
operator||
name|B2056_TX_PADG_BOOST_TUNE
argument_list|,
name|padg_boost
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|offset
operator||
name|B2056_TX_MIXG_BOOST_TUNE
argument_list|,
name|mixg_boost
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|bias
operator|=
name|bwn_is_40mhz
argument_list|(
name|mac
argument_list|)
condition|?
literal|0x40
else|:
literal|0x20
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|offset
operator||
name|B2056_TX_INTPAG_IMAIN_STAT
argument_list|,
name|bias
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|offset
operator||
name|B2056_TX_INTPAG_IAUX_STAT
argument_list|,
name|bias
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|offset
operator||
name|B2056_TX_INTPAG_CASCBIAS
argument_list|,
literal|0x30
argument_list|)
expr_stmt|;
block|}
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|offset
operator||
name|B2056_TX_PA_SPARE1
argument_list|,
literal|0xee
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|phy_n
operator|->
name|ipa5g_on
operator|&&
name|band
operator|==
name|BWN_BAND_5G
condition|)
block|{
name|uint16_t
name|freq
init|=
name|bwn_get_centre_freq
argument_list|(
name|mac
argument_list|)
decl_stmt|;
comment|/* XXX 5g low/med/high? */
if|if
condition|(
name|freq
operator|<
literal|5100
condition|)
block|{
name|paa_boost
operator|=
literal|0xA
expr_stmt|;
name|pada_boost
operator|=
literal|0x77
expr_stmt|;
name|pgaa_boost
operator|=
literal|0xF
expr_stmt|;
name|mixa_boost
operator|=
literal|0xF
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|freq
operator|<
literal|5340
condition|)
block|{
name|paa_boost
operator|=
literal|0x8
expr_stmt|;
name|pada_boost
operator|=
literal|0x77
expr_stmt|;
name|pgaa_boost
operator|=
literal|0xFB
expr_stmt|;
name|mixa_boost
operator|=
literal|0xF
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|freq
operator|<
literal|5650
condition|)
block|{
name|paa_boost
operator|=
literal|0x0
expr_stmt|;
name|pada_boost
operator|=
literal|0x77
expr_stmt|;
name|pgaa_boost
operator|=
literal|0xB
expr_stmt|;
name|mixa_boost
operator|=
literal|0xF
expr_stmt|;
block|}
else|else
block|{
name|paa_boost
operator|=
literal|0x0
expr_stmt|;
name|pada_boost
operator|=
literal|0x77
expr_stmt|;
if|if
condition|(
name|freq
operator|!=
literal|5825
condition|)
name|pgaa_boost
operator|=
operator|-
operator|(
name|freq
operator|-
literal|18
operator|)
operator|/
literal|36
operator|+
literal|168
expr_stmt|;
else|else
name|pgaa_boost
operator|=
literal|6
expr_stmt|;
name|mixa_boost
operator|=
literal|0xF
expr_stmt|;
block|}
name|cbias
operator|=
name|is_pkg_fab_smic
condition|?
literal|0x35
else|:
literal|0x30
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
block|{
name|offset
operator|=
name|i
condition|?
name|B2056_TX1
else|:
name|B2056_TX0
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|offset
operator||
name|B2056_TX_INTPAA_BOOST_TUNE
argument_list|,
name|paa_boost
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|offset
operator||
name|B2056_TX_PADA_BOOST_TUNE
argument_list|,
name|pada_boost
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|offset
operator||
name|B2056_TX_PGAA_BOOST_TUNE
argument_list|,
name|pgaa_boost
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|offset
operator||
name|B2056_TX_MIXA_BOOST_TUNE
argument_list|,
name|mixa_boost
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|offset
operator||
name|B2056_TX_TXSPARE1
argument_list|,
literal|0x30
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|offset
operator||
name|B2056_TX_PA_SPARE2
argument_list|,
literal|0xee
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|offset
operator||
name|B2056_TX_PADA_CASCBIAS
argument_list|,
literal|0x03
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|offset
operator||
name|B2056_TX_INTPAA_IAUX_STAT
argument_list|,
literal|0x30
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|offset
operator||
name|B2056_TX_INTPAA_IMAIN_STAT
argument_list|,
literal|0x30
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|offset
operator||
name|B2056_TX_INTPAA_CASCBIAS
argument_list|,
name|cbias
argument_list|)
expr_stmt|;
block|}
block|}
name|DELAY
argument_list|(
literal|50
argument_list|)
expr_stmt|;
comment|/* VCO calibration */
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_SYN_PLL_VCOCAL12
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_TX_INTPAA_PA_MISC
argument_list|,
literal|0x38
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_TX_INTPAA_PA_MISC
argument_list|,
literal|0x18
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_TX_INTPAA_PA_MISC
argument_list|,
literal|0x38
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_TX_INTPAA_PA_MISC
argument_list|,
literal|0x39
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|300
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|bwn_radio_2056_rcal
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|uint16_t
name|mast2
decl_stmt|,
name|tmp
decl_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|!=
literal|3
condition|)
return|return
literal|0
return|;
name|DPRINTF
argument_list|(
name|mac
operator|->
name|mac_sc
argument_list|,
name|BWN_DEBUG_RF
argument_list|,
literal|"%s: called\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|mast2
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
name|B2056_SYN_PLL_MAST2
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_SYN_PLL_MAST2
argument_list|,
name|mast2
operator||
literal|0x7
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_SYN_RCAL_MASTER
argument_list|,
literal|0x01
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_SYN_RCAL_MASTER
argument_list|,
literal|0x09
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bwn_radio_wait_value
argument_list|(
name|mac
argument_list|,
name|B2056_SYN_RCAL_CODE_OUT
argument_list|,
literal|0x80
argument_list|,
literal|0x80
argument_list|,
literal|100
argument_list|,
literal|1000000
argument_list|)
condition|)
block|{
name|BWN_ERRPRINTF
argument_list|(
name|mac
operator|->
name|mac_sc
argument_list|,
literal|"Radio recalibration timeout\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_SYN_RCAL_MASTER
argument_list|,
literal|0x01
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
name|B2056_SYN_RCAL_CODE_OUT
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_SYN_RCAL_MASTER
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_SYN_PLL_MAST2
argument_list|,
name|mast2
argument_list|)
expr_stmt|;
return|return
name|tmp
operator|&
literal|0x1f
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_radio_init2056_pre
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|DPRINTF
argument_list|(
name|mac
operator|->
name|mac_sc
argument_list|,
name|BWN_DEBUG_RF
argument_list|,
literal|"%s: called\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_CMD
argument_list|,
operator|~
name|BWN_NPHY_RFCTL_CMD_CHIP0PU
argument_list|)
expr_stmt|;
comment|/* Maybe wl meant to reset and set (order?) RFCTL_CMD_OEPORFORCE? */
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_CMD
argument_list|,
name|BWN_NPHY_RFCTL_CMD_OEPORFORCE
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_CMD
argument_list|,
operator|~
name|BWN_NPHY_RFCTL_CMD_OEPORFORCE
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_CMD
argument_list|,
name|BWN_NPHY_RFCTL_CMD_CHIP0PU
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_radio_init2056_post
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|DPRINTF
argument_list|(
name|mac
operator|->
name|mac_sc
argument_list|,
name|BWN_DEBUG_RF
argument_list|,
literal|"%s: called\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|BWN_RF_SET
argument_list|(
name|mac
argument_list|,
name|B2056_SYN_COM_CTRL
argument_list|,
literal|0xB
argument_list|)
expr_stmt|;
name|BWN_RF_SET
argument_list|(
name|mac
argument_list|,
name|B2056_SYN_COM_PU
argument_list|,
literal|0x2
argument_list|)
expr_stmt|;
name|BWN_RF_SET
argument_list|(
name|mac
argument_list|,
name|B2056_SYN_COM_RESET
argument_list|,
literal|0x2
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
name|BWN_RF_MASK
argument_list|(
name|mac
argument_list|,
name|B2056_SYN_COM_RESET
argument_list|,
operator|~
literal|0x2
argument_list|)
expr_stmt|;
name|BWN_RF_MASK
argument_list|(
name|mac
argument_list|,
name|B2056_SYN_PLL_MAST2
argument_list|,
operator|~
literal|0xFC
argument_list|)
expr_stmt|;
name|BWN_RF_MASK
argument_list|(
name|mac
argument_list|,
name|B2056_SYN_RCCAL_CTRL0
argument_list|,
operator|~
literal|0x1
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|phy_do_full_init
condition|)
name|bwn_radio_2056_rcal
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Initialize a Broadcom 2056 N-radio  * http://bcm-v4.sipsolutions.net/802.11/Radio/2056/Init  */
end_comment

begin_function
specifier|static
name|void
name|bwn_radio_init2056
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|DPRINTF
argument_list|(
name|mac
operator|->
name|mac_sc
argument_list|,
name|BWN_DEBUG_RF
argument_list|,
literal|"%s: called\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|bwn_radio_init2056_pre
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|b2056_upload_inittabs
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bwn_radio_init2056_post
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**************************************************  * Radio 0x2055  **************************************************/
end_comment

begin_function
specifier|static
name|void
name|bwn_chantab_radio_upload
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
specifier|const
name|struct
name|bwn_nphy_channeltab_entry_rev2
modifier|*
name|e
parameter_list|)
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2055_PLL_REF
argument_list|,
name|e
operator|->
name|radio_pll_ref
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2055_RF_PLLMOD0
argument_list|,
name|e
operator|->
name|radio_rf_pllmod0
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2055_RF_PLLMOD1
argument_list|,
name|e
operator|->
name|radio_rf_pllmod1
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2055_VCO_CAPTAIL
argument_list|,
name|e
operator|->
name|radio_vco_captail
argument_list|)
expr_stmt|;
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCTL
argument_list|)
expr_stmt|;
comment|/* flush writes */
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2055_VCO_CAL1
argument_list|,
name|e
operator|->
name|radio_vco_cal1
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2055_VCO_CAL2
argument_list|,
name|e
operator|->
name|radio_vco_cal2
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2055_PLL_LFC1
argument_list|,
name|e
operator|->
name|radio_pll_lfc1
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2055_PLL_LFR1
argument_list|,
name|e
operator|->
name|radio_pll_lfr1
argument_list|)
expr_stmt|;
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCTL
argument_list|)
expr_stmt|;
comment|/* flush writes */
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2055_PLL_LFC2
argument_list|,
name|e
operator|->
name|radio_pll_lfc2
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2055_LGBUF_CENBUF
argument_list|,
name|e
operator|->
name|radio_lgbuf_cenbuf
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2055_LGEN_TUNE1
argument_list|,
name|e
operator|->
name|radio_lgen_tune1
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2055_LGEN_TUNE2
argument_list|,
name|e
operator|->
name|radio_lgen_tune2
argument_list|)
expr_stmt|;
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCTL
argument_list|)
expr_stmt|;
comment|/* flush writes */
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2055_C1_LGBUF_ATUNE
argument_list|,
name|e
operator|->
name|radio_c1_lgbuf_atune
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2055_C1_LGBUF_GTUNE
argument_list|,
name|e
operator|->
name|radio_c1_lgbuf_gtune
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2055_C1_RX_RFR1
argument_list|,
name|e
operator|->
name|radio_c1_rx_rfr1
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2055_C1_TX_PGAPADTN
argument_list|,
name|e
operator|->
name|radio_c1_tx_pgapadtn
argument_list|)
expr_stmt|;
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCTL
argument_list|)
expr_stmt|;
comment|/* flush writes */
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2055_C1_TX_MXBGTRIM
argument_list|,
name|e
operator|->
name|radio_c1_tx_mxbgtrim
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2055_C2_LGBUF_ATUNE
argument_list|,
name|e
operator|->
name|radio_c2_lgbuf_atune
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2055_C2_LGBUF_GTUNE
argument_list|,
name|e
operator|->
name|radio_c2_lgbuf_gtune
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2055_C2_RX_RFR1
argument_list|,
name|e
operator|->
name|radio_c2_rx_rfr1
argument_list|)
expr_stmt|;
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCTL
argument_list|)
expr_stmt|;
comment|/* flush writes */
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2055_C2_TX_PGAPADTN
argument_list|,
name|e
operator|->
name|radio_c2_tx_pgapadtn
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2055_C2_TX_MXBGTRIM
argument_list|,
name|e
operator|->
name|radio_c2_tx_mxbgtrim
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/Radio/2055Setup */
end_comment

begin_function
specifier|static
name|void
name|bwn_radio_2055_setup
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
specifier|const
name|struct
name|bwn_nphy_channeltab_entry_rev2
modifier|*
name|e
parameter_list|)
block|{
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|3
condition|)
block|{
name|BWN_ERRPRINTF
argument_list|(
name|mac
operator|->
name|mac_sc
argument_list|,
literal|"%s: phy rev %d out of range\n"
argument_list|,
name|__func__
argument_list|,
name|mac
operator|->
name|mac_phy
operator|.
name|rev
argument_list|)
expr_stmt|;
block|}
name|DPRINTF
argument_list|(
name|mac
operator|->
name|mac_sc
argument_list|,
name|BWN_DEBUG_RF
argument_list|,
literal|"%s: called\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|bwn_chantab_radio_upload
argument_list|(
name|mac
argument_list|,
name|e
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|50
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2055_VCO_CAL10
argument_list|,
literal|0x05
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2055_VCO_CAL10
argument_list|,
literal|0x45
argument_list|)
expr_stmt|;
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCTL
argument_list|)
expr_stmt|;
comment|/* flush writes */
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2055_VCO_CAL10
argument_list|,
literal|0x65
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|300
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_radio_init2055_pre
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_CMD
argument_list|,
operator|~
name|BWN_NPHY_RFCTL_CMD_PORFORCE
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_CMD
argument_list|,
name|BWN_NPHY_RFCTL_CMD_CHIP0PU
operator||
name|BWN_NPHY_RFCTL_CMD_OEPORFORCE
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_CMD
argument_list|,
name|BWN_NPHY_RFCTL_CMD_PORFORCE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_radio_init2055_post
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|struct
name|bwn_phy_n
modifier|*
name|nphy
init|=
name|mac
operator|->
name|mac_phy
operator|.
name|phy_n
decl_stmt|;
name|bool
name|workaround
init|=
name|false
decl_stmt|;
if|if
condition|(
name|siba_get_revid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|<
literal|4
condition|)
name|workaround
operator|=
operator|(
name|siba_get_pci_subvendor
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|!=
name|SIBA_BOARDVENDOR_BCM
operator|)
operator|&&
operator|(
name|siba_get_pci_subdevice
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
name|SIBA_BOARD_BCM4321
operator|)
operator|&&
operator|(
name|siba_sprom_get_brev
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|>=
literal|0x41
operator|)
expr_stmt|;
else|else
name|workaround
operator|=
operator|!
operator|(
name|siba_sprom_get_bf2_lo
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|&
name|BWN_BFL2_RXBB_INT_REG_DIS
operator|)
expr_stmt|;
name|BWN_RF_MASK
argument_list|(
name|mac
argument_list|,
name|B2055_MASTER1
argument_list|,
literal|0xFFF3
argument_list|)
expr_stmt|;
if|if
condition|(
name|workaround
condition|)
block|{
name|BWN_RF_MASK
argument_list|(
name|mac
argument_list|,
name|B2055_C1_RX_BB_REG
argument_list|,
literal|0x7F
argument_list|)
expr_stmt|;
name|BWN_RF_MASK
argument_list|(
name|mac
argument_list|,
name|B2055_C2_RX_BB_REG
argument_list|,
literal|0x7F
argument_list|)
expr_stmt|;
block|}
name|BWN_RF_SETMASK
argument_list|(
name|mac
argument_list|,
name|B2055_RRCCAL_NOPTSEL
argument_list|,
literal|0xFFC0
argument_list|,
literal|0x2C
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2055_CAL_MISC
argument_list|,
literal|0x3C
argument_list|)
expr_stmt|;
name|BWN_RF_MASK
argument_list|(
name|mac
argument_list|,
name|B2055_CAL_MISC
argument_list|,
literal|0xFFBE
argument_list|)
expr_stmt|;
name|BWN_RF_SET
argument_list|(
name|mac
argument_list|,
name|B2055_CAL_LPOCTL
argument_list|,
literal|0x80
argument_list|)
expr_stmt|;
name|BWN_RF_SET
argument_list|(
name|mac
argument_list|,
name|B2055_CAL_MISC
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
name|BWN_RF_SET
argument_list|(
name|mac
argument_list|,
name|B2055_CAL_MISC
argument_list|,
literal|0x40
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bwn_radio_wait_value
argument_list|(
name|mac
argument_list|,
name|B2055_CAL_COUT2
argument_list|,
literal|0x80
argument_list|,
literal|0x80
argument_list|,
literal|10
argument_list|,
literal|2000
argument_list|)
condition|)
name|BWN_ERRPRINTF
argument_list|(
name|mac
operator|->
name|mac_sc
argument_list|,
literal|"radio post init timeout\n"
argument_list|)
expr_stmt|;
name|BWN_RF_MASK
argument_list|(
name|mac
argument_list|,
name|B2055_CAL_LPOCTL
argument_list|,
literal|0xFF7F
argument_list|)
expr_stmt|;
name|bwn_switch_channel
argument_list|(
name|mac
argument_list|,
name|bwn_get_chan
argument_list|(
name|mac
argument_list|)
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2055_C1_RX_BB_LPF
argument_list|,
literal|0x9
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2055_C2_RX_BB_LPF
argument_list|,
literal|0x9
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2055_C1_RX_BB_MIDACHP
argument_list|,
literal|0x83
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2055_C2_RX_BB_MIDACHP
argument_list|,
literal|0x83
argument_list|)
expr_stmt|;
name|BWN_RF_SETMASK
argument_list|(
name|mac
argument_list|,
name|B2055_C1_LNA_GAINBST
argument_list|,
literal|0xFFF8
argument_list|,
literal|0x6
argument_list|)
expr_stmt|;
name|BWN_RF_SETMASK
argument_list|(
name|mac
argument_list|,
name|B2055_C2_LNA_GAINBST
argument_list|,
literal|0xFFF8
argument_list|,
literal|0x6
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|nphy
operator|->
name|gain_boost
condition|)
block|{
name|BWN_RF_SET
argument_list|(
name|mac
argument_list|,
name|B2055_C1_RX_RFSPC1
argument_list|,
literal|0x2
argument_list|)
expr_stmt|;
name|BWN_RF_SET
argument_list|(
name|mac
argument_list|,
name|B2055_C2_RX_RFSPC1
argument_list|,
literal|0x2
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BWN_RF_MASK
argument_list|(
name|mac
argument_list|,
name|B2055_C1_RX_RFSPC1
argument_list|,
literal|0xFFFD
argument_list|)
expr_stmt|;
name|BWN_RF_MASK
argument_list|(
name|mac
argument_list|,
name|B2055_C2_RX_RFSPC1
argument_list|,
literal|0xFFFD
argument_list|)
expr_stmt|;
block|}
name|DELAY
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Initialize a Broadcom 2055 N-radio  * http://bcm-v4.sipsolutions.net/802.11/Radio/2055/Init  */
end_comment

begin_function
specifier|static
name|void
name|bwn_radio_init2055
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|bwn_radio_init2055_pre
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_status
operator|<
name|BWN_MAC_STATUS_INITED
condition|)
block|{
comment|/* Follow wl, not specs. Do not force uploading all regs */
name|b2055_upload_inittab
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|bool
name|ghz5
init|=
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_5G
decl_stmt|;
name|b2055_upload_inittab
argument_list|(
name|mac
argument_list|,
name|ghz5
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|bwn_radio_init2055_post
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**************************************************  * Samples  **************************************************/
end_comment

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/LoadSampleTable */
end_comment

begin_function
specifier|static
name|int
name|bwn_nphy_load_samples
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|struct
name|bwn_c32
modifier|*
name|samples
parameter_list|,
name|uint16_t
name|len
parameter_list|)
block|{
name|struct
name|bwn_phy_n
modifier|*
name|nphy
init|=
name|mac
operator|->
name|mac_phy
operator|.
name|phy_n
decl_stmt|;
name|uint16_t
name|i
decl_stmt|;
name|uint32_t
modifier|*
name|data
decl_stmt|;
name|data
operator|=
name|malloc
argument_list|(
name|len
operator|*
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|data
condition|)
block|{
name|BWN_ERRPRINTF
argument_list|(
name|mac
operator|->
name|mac_sc
argument_list|,
literal|"allocation for samples loading failed\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOMEM
return|;
block|}
if|if
condition|(
name|nphy
operator|->
name|hang_avoid
condition|)
name|bwn_nphy_stay_in_carrier_search
argument_list|(
name|mac
argument_list|,
literal|1
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
block|{
name|data
index|[
name|i
index|]
operator|=
operator|(
name|samples
index|[
name|i
index|]
operator|.
name|i
operator|&
literal|0x3FF
operator|<<
literal|10
operator|)
expr_stmt|;
name|data
index|[
name|i
index|]
operator||=
name|samples
index|[
name|i
index|]
operator|.
name|q
operator|&
literal|0x3FF
expr_stmt|;
block|}
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB32
argument_list|(
literal|17
argument_list|,
literal|0
argument_list|)
argument_list|,
name|len
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|data
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
if|if
condition|(
name|nphy
operator|->
name|hang_avoid
condition|)
name|bwn_nphy_stay_in_carrier_search
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/GenLoadSamples */
end_comment

begin_function
specifier|static
name|uint16_t
name|bwn_nphy_gen_load_samples
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint32_t
name|freq
parameter_list|,
name|uint16_t
name|max
parameter_list|,
name|bool
name|test
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|uint16_t
name|bw
decl_stmt|,
name|len
decl_stmt|,
name|rot
decl_stmt|,
name|angle
decl_stmt|;
name|struct
name|bwn_c32
modifier|*
name|samples
decl_stmt|;
name|bw
operator|=
name|bwn_is_40mhz
argument_list|(
name|mac
argument_list|)
condition|?
literal|40
else|:
literal|20
expr_stmt|;
name|len
operator|=
name|bw
operator|<<
literal|3
expr_stmt|;
if|if
condition|(
name|test
condition|)
block|{
if|if
condition|(
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_BBCFG
argument_list|)
operator|&
name|BWN_NPHY_BBCFG_RSTRX
condition|)
name|bw
operator|=
literal|82
expr_stmt|;
else|else
name|bw
operator|=
literal|80
expr_stmt|;
if|if
condition|(
name|bwn_is_40mhz
argument_list|(
name|mac
argument_list|)
condition|)
name|bw
operator|<<=
literal|1
expr_stmt|;
name|len
operator|=
name|bw
operator|<<
literal|1
expr_stmt|;
block|}
name|samples
operator|=
name|malloc
argument_list|(
name|len
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|bwn_c32
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|samples
condition|)
block|{
name|BWN_ERRPRINTF
argument_list|(
name|mac
operator|->
name|mac_sc
argument_list|,
literal|"allocation for samples generation failed\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|rot
operator|=
operator|(
operator|(
operator|(
name|freq
operator|*
literal|36
operator|)
operator|/
name|bw
operator|)
operator|<<
literal|16
operator|)
operator|/
literal|100
expr_stmt|;
name|angle
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
block|{
name|samples
index|[
name|i
index|]
operator|=
name|bwn_cordic
argument_list|(
name|angle
argument_list|)
expr_stmt|;
name|angle
operator|+=
name|rot
expr_stmt|;
name|samples
index|[
name|i
index|]
operator|.
name|q
operator|=
name|CORDIC_CONVERT
argument_list|(
name|samples
index|[
name|i
index|]
operator|.
name|q
operator|*
name|max
argument_list|)
expr_stmt|;
name|samples
index|[
name|i
index|]
operator|.
name|i
operator|=
name|CORDIC_CONVERT
argument_list|(
name|samples
index|[
name|i
index|]
operator|.
name|i
operator|*
name|max
argument_list|)
expr_stmt|;
block|}
name|i
operator|=
name|bwn_nphy_load_samples
argument_list|(
name|mac
argument_list|,
name|samples
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|samples
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
return|return
operator|(
name|i
operator|<
literal|0
operator|)
condition|?
literal|0
else|:
name|len
return|;
block|}
end_function

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RunSamples */
end_comment

begin_function
specifier|static
name|void
name|bwn_nphy_run_samples
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint16_t
name|samps
parameter_list|,
name|uint16_t
name|loops
parameter_list|,
name|uint16_t
name|wait
parameter_list|,
name|bool
name|iqmode
parameter_list|,
name|bool
name|dac_test
parameter_list|,
name|bool
name|modify_bbmult
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwn_phy_n
modifier|*
name|nphy
init|=
name|mac
operator|->
name|mac_phy
operator|.
name|phy_n
decl_stmt|;
name|int
name|i
decl_stmt|;
name|uint16_t
name|seq_mode
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
name|bwn_nphy_stay_in_carrier_search
argument_list|(
name|mac
argument_list|,
name|true
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|7
condition|)
block|{
name|bool
name|lpf_bw3
decl_stmt|,
name|lpf_bw4
decl_stmt|;
name|lpf_bw3
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_REV7_RF_CTL_OVER3
argument_list|)
operator|&
literal|0x80
expr_stmt|;
name|lpf_bw4
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_REV7_RF_CTL_OVER4
argument_list|)
operator|&
literal|0x80
expr_stmt|;
if|if
condition|(
name|lpf_bw3
operator|||
name|lpf_bw4
condition|)
block|{
comment|/* TODO */
block|}
else|else
block|{
name|uint16_t
name|value
init|=
name|bwn_nphy_read_lpf_ctl
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|)
decl_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|19
condition|)
name|bwn_nphy_rf_ctl_override_rev19
argument_list|(
name|mac
argument_list|,
literal|0x80
argument_list|,
name|value
argument_list|,
literal|0
argument_list|,
name|false
argument_list|,
literal|1
argument_list|)
expr_stmt|;
else|else
name|bwn_nphy_rf_ctl_override_rev7
argument_list|(
name|mac
argument_list|,
literal|0x80
argument_list|,
name|value
argument_list|,
literal|0
argument_list|,
name|false
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|nphy
operator|->
name|lpf_bw_overrode_for_sample_play
operator|=
name|true
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|nphy
operator|->
name|bb_mult_save
operator|&
literal|0x80000000
operator|)
operator|==
literal|0
condition|)
block|{
name|tmp
operator|=
name|bwn_ntab_read
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|15
argument_list|,
literal|87
argument_list|)
argument_list|)
expr_stmt|;
name|nphy
operator|->
name|bb_mult_save
operator|=
operator|(
name|tmp
operator|&
literal|0xFFFF
operator|)
operator||
literal|0x80000000
expr_stmt|;
block|}
if|if
condition|(
name|modify_bbmult
condition|)
block|{
name|tmp
operator|=
operator|!
name|bwn_is_40mhz
argument_list|(
name|mac
argument_list|)
condition|?
literal|0x6464
else|:
literal|0x4747
expr_stmt|;
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|15
argument_list|,
literal|87
argument_list|)
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_SAMP_DEPCNT
argument_list|,
operator|(
name|samps
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|loops
operator|!=
literal|0xFFFF
condition|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_SAMP_LOOPCNT
argument_list|,
operator|(
name|loops
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
else|else
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_SAMP_LOOPCNT
argument_list|,
name|loops
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_SAMP_WAITCNT
argument_list|,
name|wait
argument_list|)
expr_stmt|;
name|seq_mode
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFSEQMODE
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFSEQMODE
argument_list|,
name|BWN_NPHY_RFSEQMODE_CAOVER
argument_list|)
expr_stmt|;
if|if
condition|(
name|iqmode
condition|)
block|{
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_IQLOCAL_CMDGCTL
argument_list|,
literal|0x7FFF
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_IQLOCAL_CMDGCTL
argument_list|,
literal|0x8000
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tmp
operator|=
name|dac_test
condition|?
literal|5
else|:
literal|1
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_SAMP_CMD
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|100
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFSEQST
argument_list|)
operator|&
literal|1
operator|)
condition|)
block|{
name|i
operator|=
literal|0
expr_stmt|;
break|break;
block|}
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|i
condition|)
name|BWN_ERRPRINTF
argument_list|(
name|mac
operator|->
name|mac_sc
argument_list|,
literal|"run samples timeout\n"
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFSEQMODE
argument_list|,
name|seq_mode
argument_list|)
expr_stmt|;
name|bwn_nphy_stay_in_carrier_search
argument_list|(
name|mac
argument_list|,
name|false
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**************************************************  * RSSI  **************************************************/
end_comment

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/ScaleOffsetRssi */
end_comment

begin_function
specifier|static
name|void
name|bwn_nphy_scale_offset_rssi
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint16_t
name|scale
parameter_list|,
name|int8_t
name|offset
parameter_list|,
name|uint8_t
name|core
parameter_list|,
name|enum
name|n_rail_type
name|rail
parameter_list|,
name|enum
name|n_rssi_type
name|rssi_type
parameter_list|)
block|{
name|uint16_t
name|tmp
decl_stmt|;
name|bool
name|core1or5
init|=
operator|(
name|core
operator|==
literal|1
operator|)
operator|||
operator|(
name|core
operator|==
literal|5
operator|)
decl_stmt|;
name|bool
name|core2or5
init|=
operator|(
name|core
operator|==
literal|2
operator|)
operator|||
operator|(
name|core
operator|==
literal|5
operator|)
decl_stmt|;
name|offset
operator|=
name|bwn_clamp_val
argument_list|(
name|offset
argument_list|,
operator|-
literal|32
argument_list|,
literal|31
argument_list|)
expr_stmt|;
name|tmp
operator|=
operator|(
operator|(
name|scale
operator|&
literal|0x3F
operator|)
operator|<<
literal|8
operator|)
operator||
operator|(
name|offset
operator|&
literal|0x3F
operator|)
expr_stmt|;
switch|switch
condition|(
name|rssi_type
condition|)
block|{
case|case
name|N_RSSI_NB
case|:
if|if
condition|(
name|core1or5
operator|&&
name|rail
operator|==
name|N_RAIL_I
condition|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RSSIMC_0I_RSSI_Z
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|core1or5
operator|&&
name|rail
operator|==
name|N_RAIL_Q
condition|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RSSIMC_0Q_RSSI_Z
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|core2or5
operator|&&
name|rail
operator|==
name|N_RAIL_I
condition|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RSSIMC_1I_RSSI_Z
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|core2or5
operator|&&
name|rail
operator|==
name|N_RAIL_Q
condition|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RSSIMC_1Q_RSSI_Z
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
break|break;
case|case
name|N_RSSI_W1
case|:
if|if
condition|(
name|core1or5
operator|&&
name|rail
operator|==
name|N_RAIL_I
condition|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RSSIMC_0I_RSSI_X
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|core1or5
operator|&&
name|rail
operator|==
name|N_RAIL_Q
condition|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RSSIMC_0Q_RSSI_X
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|core2or5
operator|&&
name|rail
operator|==
name|N_RAIL_I
condition|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RSSIMC_1I_RSSI_X
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|core2or5
operator|&&
name|rail
operator|==
name|N_RAIL_Q
condition|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RSSIMC_1Q_RSSI_X
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
break|break;
case|case
name|N_RSSI_W2
case|:
if|if
condition|(
name|core1or5
operator|&&
name|rail
operator|==
name|N_RAIL_I
condition|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RSSIMC_0I_RSSI_Y
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|core1or5
operator|&&
name|rail
operator|==
name|N_RAIL_Q
condition|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RSSIMC_0Q_RSSI_Y
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|core2or5
operator|&&
name|rail
operator|==
name|N_RAIL_I
condition|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RSSIMC_1I_RSSI_Y
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|core2or5
operator|&&
name|rail
operator|==
name|N_RAIL_Q
condition|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RSSIMC_1Q_RSSI_Y
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
break|break;
case|case
name|N_RSSI_TBD
case|:
if|if
condition|(
name|core1or5
operator|&&
name|rail
operator|==
name|N_RAIL_I
condition|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RSSIMC_0I_TBD
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|core1or5
operator|&&
name|rail
operator|==
name|N_RAIL_Q
condition|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RSSIMC_0Q_TBD
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|core2or5
operator|&&
name|rail
operator|==
name|N_RAIL_I
condition|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RSSIMC_1I_TBD
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|core2or5
operator|&&
name|rail
operator|==
name|N_RAIL_Q
condition|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RSSIMC_1Q_TBD
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
break|break;
case|case
name|N_RSSI_IQ
case|:
if|if
condition|(
name|core1or5
operator|&&
name|rail
operator|==
name|N_RAIL_I
condition|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RSSIMC_0I_PWRDET
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|core1or5
operator|&&
name|rail
operator|==
name|N_RAIL_Q
condition|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RSSIMC_0Q_PWRDET
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|core2or5
operator|&&
name|rail
operator|==
name|N_RAIL_I
condition|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RSSIMC_1I_PWRDET
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|core2or5
operator|&&
name|rail
operator|==
name|N_RAIL_Q
condition|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RSSIMC_1Q_PWRDET
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
break|break;
case|case
name|N_RSSI_TSSI_2G
case|:
if|if
condition|(
name|core1or5
condition|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RSSIMC_0I_TSSI
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|core2or5
condition|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RSSIMC_1I_TSSI
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
break|break;
case|case
name|N_RSSI_TSSI_5G
case|:
if|if
condition|(
name|core1or5
condition|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RSSIMC_0Q_TSSI
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|core2or5
condition|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RSSIMC_1Q_TSSI
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_nphy_rssi_select_rev19
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint8_t
name|code
parameter_list|,
name|enum
name|n_rssi_type
name|rssi_type
parameter_list|)
block|{
comment|/* TODO */
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_nphy_rev3_rssi_select
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint8_t
name|code
parameter_list|,
name|enum
name|n_rssi_type
name|rssi_type
parameter_list|)
block|{
name|uint8_t
name|i
decl_stmt|;
name|uint16_t
name|reg
decl_stmt|,
name|val
decl_stmt|;
if|if
condition|(
name|code
operator|==
literal|0
condition|)
block|{
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_OVER1
argument_list|,
literal|0xFDFF
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_OVER
argument_list|,
literal|0xFDFF
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_C1
argument_list|,
literal|0xFCFF
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_C2
argument_list|,
literal|0xFCFF
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TXF_40CO_B1S0
argument_list|,
literal|0xFFDF
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TXF_40CO_B32S1
argument_list|,
literal|0xFFDF
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_LUT_TRSW_UP1
argument_list|,
literal|0xFFC3
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_LUT_TRSW_UP2
argument_list|,
literal|0xFFC3
argument_list|)
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|code
operator|==
literal|1
operator|&&
name|i
operator|==
literal|1
operator|)
operator|||
operator|(
name|code
operator|==
literal|2
operator|&&
operator|!
name|i
operator|)
condition|)
continue|continue;
name|reg
operator|=
operator|(
name|i
operator|==
literal|0
operator|)
condition|?
name|BWN_NPHY_AFECTL_OVER1
else|:
name|BWN_NPHY_AFECTL_OVER
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|reg
argument_list|,
literal|0xFDFF
argument_list|,
literal|0x0200
argument_list|)
expr_stmt|;
if|if
condition|(
name|rssi_type
operator|==
name|N_RSSI_W1
operator|||
name|rssi_type
operator|==
name|N_RSSI_W2
operator|||
name|rssi_type
operator|==
name|N_RSSI_NB
condition|)
block|{
name|reg
operator|=
operator|(
name|i
operator|==
literal|0
operator|)
condition|?
name|BWN_NPHY_AFECTL_C1
else|:
name|BWN_NPHY_AFECTL_C2
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|reg
argument_list|,
literal|0xFCFF
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|reg
operator|=
operator|(
name|i
operator|==
literal|0
operator|)
condition|?
name|BWN_NPHY_RFCTL_LUT_TRSW_UP1
else|:
name|BWN_NPHY_RFCTL_LUT_TRSW_UP2
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|reg
argument_list|,
literal|0xFFC3
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|rssi_type
operator|==
name|N_RSSI_W1
condition|)
name|val
operator|=
operator|(
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_5G
operator|)
condition|?
literal|4
else|:
literal|8
expr_stmt|;
elseif|else
if|if
condition|(
name|rssi_type
operator|==
name|N_RSSI_W2
condition|)
name|val
operator|=
literal|16
expr_stmt|;
else|else
name|val
operator|=
literal|32
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|reg
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|reg
operator|=
operator|(
name|i
operator|==
literal|0
operator|)
condition|?
name|BWN_NPHY_TXF_40CO_B1S0
else|:
name|BWN_NPHY_TXF_40CO_B32S1
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|reg
argument_list|,
literal|0x0020
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|rssi_type
operator|==
name|N_RSSI_TBD
condition|)
name|val
operator|=
literal|0x0100
expr_stmt|;
elseif|else
if|if
condition|(
name|rssi_type
operator|==
name|N_RSSI_IQ
condition|)
name|val
operator|=
literal|0x0200
expr_stmt|;
else|else
name|val
operator|=
literal|0x0300
expr_stmt|;
name|reg
operator|=
operator|(
name|i
operator|==
literal|0
operator|)
condition|?
name|BWN_NPHY_AFECTL_C1
else|:
name|BWN_NPHY_AFECTL_C2
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|reg
argument_list|,
literal|0xFCFF
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|reg
argument_list|,
literal|0xF3FF
argument_list|,
name|val
operator|<<
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|rssi_type
operator|!=
name|N_RSSI_IQ
operator|&&
name|rssi_type
operator|!=
name|N_RSSI_TBD
condition|)
block|{
name|bwn_band_t
name|band
init|=
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
decl_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|<
literal|7
condition|)
block|{
if|if
condition|(
name|bwn_nphy_ipa
argument_list|(
name|mac
argument_list|)
condition|)
name|val
operator|=
operator|(
name|band
operator|==
name|BWN_BAND_5G
operator|)
condition|?
literal|0xC
else|:
literal|0xE
expr_stmt|;
else|else
name|val
operator|=
literal|0x11
expr_stmt|;
name|reg
operator|=
operator|(
name|i
operator|==
literal|0
operator|)
condition|?
name|B2056_TX0
else|:
name|B2056_TX1
expr_stmt|;
name|reg
operator||=
name|B2056_TX_TX_SSI_MUX
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|reg
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
name|reg
operator|=
operator|(
name|i
operator|==
literal|0
operator|)
condition|?
name|BWN_NPHY_AFECTL_OVER1
else|:
name|BWN_NPHY_AFECTL_OVER
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|reg
argument_list|,
literal|0x0200
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_nphy_rev2_rssi_select
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint8_t
name|code
parameter_list|,
name|enum
name|n_rssi_type
name|rssi_type
parameter_list|)
block|{
name|uint16_t
name|val
decl_stmt|;
name|bool
name|rssi_w1_w2_nb
init|=
name|false
decl_stmt|;
switch|switch
condition|(
name|rssi_type
condition|)
block|{
case|case
name|N_RSSI_W1
case|:
case|case
name|N_RSSI_W2
case|:
case|case
name|N_RSSI_NB
case|:
name|val
operator|=
literal|0
expr_stmt|;
name|rssi_w1_w2_nb
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|N_RSSI_TBD
case|:
name|val
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|N_RSSI_IQ
case|:
name|val
operator|=
literal|2
expr_stmt|;
break|break;
default|default:
name|val
operator|=
literal|3
expr_stmt|;
block|}
name|val
operator|=
operator|(
name|val
operator|<<
literal|12
operator|)
operator||
operator|(
name|val
operator|<<
literal|14
operator|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_C1
argument_list|,
literal|0x0FFF
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_C2
argument_list|,
literal|0x0FFF
argument_list|,
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|rssi_w1_w2_nb
condition|)
block|{
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_RSSIO1
argument_list|,
literal|0xFFCF
argument_list|,
operator|(
name|rssi_type
operator|+
literal|1
operator|)
operator|<<
literal|4
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_RSSIO2
argument_list|,
literal|0xFFCF
argument_list|,
operator|(
name|rssi_type
operator|+
literal|1
operator|)
operator|<<
literal|4
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|code
operator|==
literal|0
condition|)
block|{
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_OVER
argument_list|,
operator|~
literal|0x3000
argument_list|)
expr_stmt|;
if|if
condition|(
name|rssi_w1_w2_nb
condition|)
block|{
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_CMD
argument_list|,
operator|~
operator|(
name|BWN_NPHY_RFCTL_CMD_RXEN
operator||
name|BWN_NPHY_RFCTL_CMD_CORESEL
operator|)
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_OVER
argument_list|,
operator|~
operator|(
literal|0x1
operator|<<
literal|12
operator||
literal|0x1
operator|<<
literal|5
operator||
literal|0x1
operator|<<
literal|1
operator||
literal|0x1
operator|)
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_CMD
argument_list|,
operator|~
name|BWN_NPHY_RFCTL_CMD_START
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|20
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_OVER
argument_list|,
operator|~
literal|0x1
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_OVER
argument_list|,
literal|0x3000
argument_list|)
expr_stmt|;
if|if
condition|(
name|rssi_w1_w2_nb
condition|)
block|{
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_CMD
argument_list|,
operator|~
operator|(
name|BWN_NPHY_RFCTL_CMD_RXEN
operator||
name|BWN_NPHY_RFCTL_CMD_CORESEL
operator|)
argument_list|,
operator|(
name|BWN_NPHY_RFCTL_CMD_RXEN
operator||
name|code
operator|<<
name|BWN_NPHY_RFCTL_CMD_CORESEL_SHIFT
operator|)
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_OVER
argument_list|,
operator|(
literal|0x1
operator|<<
literal|12
operator||
literal|0x1
operator|<<
literal|5
operator||
literal|0x1
operator|<<
literal|1
operator||
literal|0x1
operator|)
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_CMD
argument_list|,
name|BWN_NPHY_RFCTL_CMD_START
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|20
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_OVER
argument_list|,
operator|~
literal|0x1
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RSSISel */
end_comment

begin_function
specifier|static
name|void
name|bwn_nphy_rssi_select
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint8_t
name|code
parameter_list|,
name|enum
name|n_rssi_type
name|type
parameter_list|)
block|{
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|19
condition|)
name|bwn_nphy_rssi_select_rev19
argument_list|(
name|mac
argument_list|,
name|code
argument_list|,
name|type
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|3
condition|)
name|bwn_nphy_rev3_rssi_select
argument_list|(
name|mac
argument_list|,
name|code
argument_list|,
name|type
argument_list|)
expr_stmt|;
else|else
name|bwn_nphy_rev2_rssi_select
argument_list|(
name|mac
argument_list|,
name|code
argument_list|,
name|type
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/SetRssi2055Vcm */
end_comment

begin_function
specifier|static
name|void
name|bwn_nphy_set_rssi_2055_vcm
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|enum
name|n_rssi_type
name|rssi_type
parameter_list|,
name|uint8_t
modifier|*
name|buf
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|rssi_type
operator|==
name|N_RSSI_NB
condition|)
block|{
if|if
condition|(
name|i
operator|==
literal|0
condition|)
block|{
name|BWN_RF_SETMASK
argument_list|(
name|mac
argument_list|,
name|B2055_C1_B0NB_RSSIVCM
argument_list|,
literal|0xFC
argument_list|,
name|buf
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|BWN_RF_SETMASK
argument_list|(
name|mac
argument_list|,
name|B2055_C1_RX_BB_RSSICTL5
argument_list|,
literal|0xFC
argument_list|,
name|buf
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BWN_RF_SETMASK
argument_list|(
name|mac
argument_list|,
name|B2055_C2_B0NB_RSSIVCM
argument_list|,
literal|0xFC
argument_list|,
name|buf
index|[
literal|2
operator|*
name|i
index|]
argument_list|)
expr_stmt|;
name|BWN_RF_SETMASK
argument_list|(
name|mac
argument_list|,
name|B2055_C2_RX_BB_RSSICTL5
argument_list|,
literal|0xFC
argument_list|,
name|buf
index|[
literal|2
operator|*
name|i
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|i
operator|==
literal|0
condition|)
name|BWN_RF_SETMASK
argument_list|(
name|mac
argument_list|,
name|B2055_C1_RX_BB_RSSICTL5
argument_list|,
literal|0xF3
argument_list|,
name|buf
index|[
literal|0
index|]
operator|<<
literal|2
argument_list|)
expr_stmt|;
else|else
name|BWN_RF_SETMASK
argument_list|(
name|mac
argument_list|,
name|B2055_C2_RX_BB_RSSICTL5
argument_list|,
literal|0xF3
argument_list|,
name|buf
index|[
literal|2
operator|*
name|i
operator|+
literal|1
index|]
operator|<<
literal|2
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/PollRssi */
end_comment

begin_function
specifier|static
name|int
name|bwn_nphy_poll_rssi
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|enum
name|n_rssi_type
name|rssi_type
parameter_list|,
name|int32_t
modifier|*
name|buf
parameter_list|,
name|uint8_t
name|nsamp
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|out
decl_stmt|;
name|uint16_t
name|save_regs_phy
index|[
literal|9
index|]
decl_stmt|;
name|uint16_t
name|s
index|[
literal|2
index|]
decl_stmt|;
comment|/* TODO: rev7+ is treated like rev3+, what about rev19+? */
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|3
condition|)
block|{
name|save_regs_phy
index|[
literal|0
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_C1
argument_list|)
expr_stmt|;
name|save_regs_phy
index|[
literal|1
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_C2
argument_list|)
expr_stmt|;
name|save_regs_phy
index|[
literal|2
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_LUT_TRSW_UP1
argument_list|)
expr_stmt|;
name|save_regs_phy
index|[
literal|3
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_LUT_TRSW_UP2
argument_list|)
expr_stmt|;
name|save_regs_phy
index|[
literal|4
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_OVER1
argument_list|)
expr_stmt|;
name|save_regs_phy
index|[
literal|5
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_OVER
argument_list|)
expr_stmt|;
name|save_regs_phy
index|[
literal|6
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TXF_40CO_B1S0
argument_list|)
expr_stmt|;
name|save_regs_phy
index|[
literal|7
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TXF_40CO_B32S1
argument_list|)
expr_stmt|;
name|save_regs_phy
index|[
literal|8
index|]
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|save_regs_phy
index|[
literal|0
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_C1
argument_list|)
expr_stmt|;
name|save_regs_phy
index|[
literal|1
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_C2
argument_list|)
expr_stmt|;
name|save_regs_phy
index|[
literal|2
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_OVER
argument_list|)
expr_stmt|;
name|save_regs_phy
index|[
literal|3
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_CMD
argument_list|)
expr_stmt|;
name|save_regs_phy
index|[
literal|4
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_OVER
argument_list|)
expr_stmt|;
name|save_regs_phy
index|[
literal|5
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_RSSIO1
argument_list|)
expr_stmt|;
name|save_regs_phy
index|[
literal|6
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_RSSIO2
argument_list|)
expr_stmt|;
name|save_regs_phy
index|[
literal|7
index|]
operator|=
literal|0
expr_stmt|;
name|save_regs_phy
index|[
literal|8
index|]
operator|=
literal|0
expr_stmt|;
block|}
name|bwn_nphy_rssi_select
argument_list|(
name|mac
argument_list|,
literal|5
argument_list|,
name|rssi_type
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|<
literal|2
condition|)
block|{
name|save_regs_phy
index|[
literal|8
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_GPIO_SEL
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_GPIO_SEL
argument_list|,
literal|5
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
name|buf
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nsamp
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|<
literal|2
condition|)
block|{
name|s
index|[
literal|0
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_GPIO_LOOUT
argument_list|)
expr_stmt|;
name|s
index|[
literal|1
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_GPIO_HIOUT
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|s
index|[
literal|0
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RSSI1
argument_list|)
expr_stmt|;
name|s
index|[
literal|1
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RSSI2
argument_list|)
expr_stmt|;
block|}
name|buf
index|[
literal|0
index|]
operator|+=
operator|(
call|(
name|int8_t
call|)
argument_list|(
operator|(
name|s
index|[
literal|0
index|]
operator|&
literal|0x3F
operator|)
operator|<<
literal|2
argument_list|)
operator|)
operator|>>
literal|2
expr_stmt|;
name|buf
index|[
literal|1
index|]
operator|+=
operator|(
call|(
name|int8_t
call|)
argument_list|(
operator|(
operator|(
name|s
index|[
literal|0
index|]
operator|>>
literal|8
operator|)
operator|&
literal|0x3F
operator|)
operator|<<
literal|2
argument_list|)
operator|)
operator|>>
literal|2
expr_stmt|;
name|buf
index|[
literal|2
index|]
operator|+=
operator|(
call|(
name|int8_t
call|)
argument_list|(
operator|(
name|s
index|[
literal|1
index|]
operator|&
literal|0x3F
operator|)
operator|<<
literal|2
argument_list|)
operator|)
operator|>>
literal|2
expr_stmt|;
name|buf
index|[
literal|3
index|]
operator|+=
operator|(
call|(
name|int8_t
call|)
argument_list|(
operator|(
operator|(
name|s
index|[
literal|1
index|]
operator|>>
literal|8
operator|)
operator|&
literal|0x3F
operator|)
operator|<<
literal|2
argument_list|)
operator|)
operator|>>
literal|2
expr_stmt|;
block|}
name|out
operator|=
operator|(
name|buf
index|[
literal|0
index|]
operator|&
literal|0xFF
operator|)
operator|<<
literal|24
operator||
operator|(
name|buf
index|[
literal|1
index|]
operator|&
literal|0xFF
operator|)
operator|<<
literal|16
operator||
operator|(
name|buf
index|[
literal|2
index|]
operator|&
literal|0xFF
operator|)
operator|<<
literal|8
operator||
operator|(
name|buf
index|[
literal|3
index|]
operator|&
literal|0xFF
operator|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|<
literal|2
condition|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_GPIO_SEL
argument_list|,
name|save_regs_phy
index|[
literal|8
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|3
condition|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_C1
argument_list|,
name|save_regs_phy
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_C2
argument_list|,
name|save_regs_phy
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_LUT_TRSW_UP1
argument_list|,
name|save_regs_phy
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_LUT_TRSW_UP2
argument_list|,
name|save_regs_phy
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_OVER1
argument_list|,
name|save_regs_phy
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_OVER
argument_list|,
name|save_regs_phy
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TXF_40CO_B1S0
argument_list|,
name|save_regs_phy
index|[
literal|6
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TXF_40CO_B32S1
argument_list|,
name|save_regs_phy
index|[
literal|7
index|]
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_C1
argument_list|,
name|save_regs_phy
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_C2
argument_list|,
name|save_regs_phy
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_OVER
argument_list|,
name|save_regs_phy
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_CMD
argument_list|,
name|save_regs_phy
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_OVER
argument_list|,
name|save_regs_phy
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_RSSIO1
argument_list|,
name|save_regs_phy
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_RSSIO2
argument_list|,
name|save_regs_phy
index|[
literal|6
index|]
argument_list|)
expr_stmt|;
block|}
return|return
name|out
return|;
block|}
end_function

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RSSICalRev3 */
end_comment

begin_function
specifier|static
name|void
name|bwn_nphy_rev3_rssi_cal
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
comment|//struct bwn_phy *phy =&mac->mac_phy;
name|struct
name|bwn_phy_n
modifier|*
name|nphy
init|=
name|mac
operator|->
name|mac_phy
operator|.
name|phy_n
decl_stmt|;
name|uint16_t
name|saved_regs_phy_rfctl
index|[
literal|2
index|]
decl_stmt|;
name|uint16_t
name|saved_regs_phy
index|[
literal|22
index|]
decl_stmt|;
name|uint16_t
name|regs_to_store_rev3
index|[]
init|=
block|{
name|BWN_NPHY_AFECTL_OVER1
block|,
name|BWN_NPHY_AFECTL_OVER
block|,
name|BWN_NPHY_AFECTL_C1
block|,
name|BWN_NPHY_AFECTL_C2
block|,
name|BWN_NPHY_TXF_40CO_B1S1
block|,
name|BWN_NPHY_RFCTL_OVER
block|,
name|BWN_NPHY_TXF_40CO_B1S0
block|,
name|BWN_NPHY_TXF_40CO_B32S1
block|,
name|BWN_NPHY_RFCTL_CMD
block|,
name|BWN_NPHY_RFCTL_LUT_TRSW_UP1
block|,
name|BWN_NPHY_RFCTL_LUT_TRSW_UP2
block|,
name|BWN_NPHY_RFCTL_RSSIO1
block|,
name|BWN_NPHY_RFCTL_RSSIO2
block|}
decl_stmt|;
name|uint16_t
name|regs_to_store_rev7
index|[]
init|=
block|{
name|BWN_NPHY_AFECTL_OVER1
block|,
name|BWN_NPHY_AFECTL_OVER
block|,
name|BWN_NPHY_AFECTL_C1
block|,
name|BWN_NPHY_AFECTL_C2
block|,
name|BWN_NPHY_TXF_40CO_B1S1
block|,
name|BWN_NPHY_RFCTL_OVER
block|,
name|BWN_NPHY_REV7_RF_CTL_OVER3
block|,
name|BWN_NPHY_REV7_RF_CTL_OVER4
block|,
name|BWN_NPHY_REV7_RF_CTL_OVER5
block|,
name|BWN_NPHY_REV7_RF_CTL_OVER6
block|,
literal|0x2ff
block|,
name|BWN_NPHY_TXF_40CO_B1S0
block|,
name|BWN_NPHY_TXF_40CO_B32S1
block|,
name|BWN_NPHY_RFCTL_CMD
block|,
name|BWN_NPHY_RFCTL_LUT_TRSW_UP1
block|,
name|BWN_NPHY_RFCTL_LUT_TRSW_UP2
block|,
name|BWN_NPHY_REV7_RF_CTL_MISC_REG3
block|,
name|BWN_NPHY_REV7_RF_CTL_MISC_REG4
block|,
name|BWN_NPHY_REV7_RF_CTL_MISC_REG5
block|,
name|BWN_NPHY_REV7_RF_CTL_MISC_REG6
block|,
name|BWN_NPHY_RFCTL_RSSIO1
block|,
name|BWN_NPHY_RFCTL_RSSIO2
block|}
decl_stmt|;
name|uint16_t
modifier|*
name|regs_to_store
decl_stmt|;
name|int
name|regs_amount
decl_stmt|;
name|uint16_t
name|class
decl_stmt|;
name|uint16_t
name|clip_state
index|[
literal|2
index|]
decl_stmt|;
name|uint16_t
name|clip_off
index|[
literal|2
index|]
init|=
block|{
literal|0xFFFF
block|,
literal|0xFFFF
block|}
decl_stmt|;
name|uint8_t
name|vcm_final
init|=
literal|0
decl_stmt|;
name|int32_t
name|offset
index|[
literal|4
index|]
decl_stmt|;
name|int32_t
name|results
index|[
literal|8
index|]
index|[
literal|4
index|]
init|=
block|{ }
decl_stmt|;
name|int32_t
name|results_min
index|[
literal|4
index|]
init|=
block|{ }
decl_stmt|;
name|int32_t
name|poll_results
index|[
literal|4
index|]
init|=
block|{ }
decl_stmt|;
name|uint16_t
modifier|*
name|rssical_radio_regs
init|=
name|NULL
decl_stmt|;
name|uint16_t
modifier|*
name|rssical_phy_regs
init|=
name|NULL
decl_stmt|;
name|uint16_t
name|r
decl_stmt|;
comment|/* routing */
name|uint8_t
name|rx_core_state
decl_stmt|;
name|int
name|core
decl_stmt|,
name|i
decl_stmt|,
name|j
decl_stmt|,
name|vcm
decl_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|7
condition|)
block|{
name|regs_to_store
operator|=
name|regs_to_store_rev7
expr_stmt|;
name|regs_amount
operator|=
name|nitems
argument_list|(
name|regs_to_store_rev7
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|regs_to_store
operator|=
name|regs_to_store_rev3
expr_stmt|;
name|regs_amount
operator|=
name|nitems
argument_list|(
name|regs_to_store_rev3
argument_list|)
expr_stmt|;
block|}
name|KASSERT
argument_list|(
operator|(
name|regs_amount
operator|<=
name|nitems
argument_list|(
name|saved_regs_phy
argument_list|)
operator|)
argument_list|,
operator|(
literal|"%s: reg_amount (%d) too large\n"
operator|,
name|__func__
operator|,
name|regs_amount
operator|)
argument_list|)
expr_stmt|;
name|class
operator|=
name|bwn_nphy_classifier
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bwn_nphy_classifier
argument_list|(
name|mac
argument_list|,
literal|7
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|bwn_nphy_read_clip_detection
argument_list|(
name|mac
argument_list|,
name|clip_state
argument_list|)
expr_stmt|;
name|bwn_nphy_write_clip_detection
argument_list|(
name|mac
argument_list|,
name|clip_off
argument_list|)
expr_stmt|;
name|saved_regs_phy_rfctl
index|[
literal|0
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_INTC1
argument_list|)
expr_stmt|;
name|saved_regs_phy_rfctl
index|[
literal|1
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_INTC2
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|regs_amount
condition|;
name|i
operator|++
control|)
name|saved_regs_phy
index|[
name|i
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|regs_to_store
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|bwn_nphy_rf_ctl_intc_override
argument_list|(
name|mac
argument_list|,
name|N_INTC_OVERRIDE_OFF
argument_list|,
literal|0
argument_list|,
literal|7
argument_list|)
expr_stmt|;
name|bwn_nphy_rf_ctl_intc_override
argument_list|(
name|mac
argument_list|,
name|N_INTC_OVERRIDE_TRSW
argument_list|,
literal|1
argument_list|,
literal|7
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|7
condition|)
block|{
name|bwn_nphy_rf_ctl_override_one_to_many
argument_list|(
name|mac
argument_list|,
name|N_RF_CTL_OVER_CMD_RXRF_PU
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|false
argument_list|)
expr_stmt|;
name|bwn_nphy_rf_ctl_override_one_to_many
argument_list|(
name|mac
argument_list|,
name|N_RF_CTL_OVER_CMD_RX_PU
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
name|false
argument_list|)
expr_stmt|;
name|bwn_nphy_rf_ctl_override_rev7
argument_list|(
name|mac
argument_list|,
literal|0x80
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
name|false
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bwn_nphy_rf_ctl_override_rev7
argument_list|(
name|mac
argument_list|,
literal|0x40
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
name|false
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_5G
condition|)
block|{
name|bwn_nphy_rf_ctl_override_rev7
argument_list|(
name|mac
argument_list|,
literal|0x20
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|false
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bwn_nphy_rf_ctl_override_rev7
argument_list|(
name|mac
argument_list|,
literal|0x10
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
name|false
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|bwn_nphy_rf_ctl_override_rev7
argument_list|(
name|mac
argument_list|,
literal|0x10
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|false
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bwn_nphy_rf_ctl_override_rev7
argument_list|(
name|mac
argument_list|,
literal|0x20
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
name|false
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|bwn_nphy_rf_ctl_override
argument_list|(
name|mac
argument_list|,
literal|0x1
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|false
argument_list|)
expr_stmt|;
name|bwn_nphy_rf_ctl_override
argument_list|(
name|mac
argument_list|,
literal|0x2
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
name|false
argument_list|)
expr_stmt|;
name|bwn_nphy_rf_ctl_override
argument_list|(
name|mac
argument_list|,
literal|0x80
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
name|false
argument_list|)
expr_stmt|;
name|bwn_nphy_rf_ctl_override
argument_list|(
name|mac
argument_list|,
literal|0x40
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
name|false
argument_list|)
expr_stmt|;
if|if
condition|(
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_5G
condition|)
block|{
name|bwn_nphy_rf_ctl_override
argument_list|(
name|mac
argument_list|,
literal|0x20
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|false
argument_list|)
expr_stmt|;
name|bwn_nphy_rf_ctl_override
argument_list|(
name|mac
argument_list|,
literal|0x10
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
name|false
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|bwn_nphy_rf_ctl_override
argument_list|(
name|mac
argument_list|,
literal|0x10
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|false
argument_list|)
expr_stmt|;
name|bwn_nphy_rf_ctl_override
argument_list|(
name|mac
argument_list|,
literal|0x20
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
name|false
argument_list|)
expr_stmt|;
block|}
block|}
name|rx_core_state
operator|=
name|bwn_nphy_get_rx_core_state
argument_list|(
name|mac
argument_list|)
expr_stmt|;
for|for
control|(
name|core
operator|=
literal|0
init|;
name|core
operator|<
literal|2
condition|;
name|core
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|rx_core_state
operator|&
operator|(
literal|1
operator|<<
name|core
operator|)
operator|)
condition|)
continue|continue;
name|r
operator|=
name|core
condition|?
name|B2056_RX1
else|:
name|B2056_RX0
expr_stmt|;
name|bwn_nphy_scale_offset_rssi
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|core
operator|+
literal|1
argument_list|,
name|N_RAIL_I
argument_list|,
name|N_RSSI_NB
argument_list|)
expr_stmt|;
name|bwn_nphy_scale_offset_rssi
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|core
operator|+
literal|1
argument_list|,
name|N_RAIL_Q
argument_list|,
name|N_RSSI_NB
argument_list|)
expr_stmt|;
comment|/* Grab RSSI results for every possible VCM */
for|for
control|(
name|vcm
operator|=
literal|0
init|;
name|vcm
operator|<
literal|8
condition|;
name|vcm
operator|++
control|)
block|{
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|7
condition|)
name|BWN_RF_SETMASK
argument_list|(
name|mac
argument_list|,
name|core
condition|?
name|R2057_NB_MASTER_CORE1
else|:
name|R2057_NB_MASTER_CORE0
argument_list|,
operator|~
name|R2057_VCM_MASK
argument_list|,
name|vcm
argument_list|)
expr_stmt|;
else|else
name|BWN_RF_SETMASK
argument_list|(
name|mac
argument_list|,
name|r
operator||
name|B2056_RX_RSSI_MISC
argument_list|,
literal|0xE3
argument_list|,
name|vcm
operator|<<
literal|2
argument_list|)
expr_stmt|;
name|bwn_nphy_poll_rssi
argument_list|(
name|mac
argument_list|,
name|N_RSSI_NB
argument_list|,
name|results
index|[
name|vcm
index|]
argument_list|,
literal|8
argument_list|)
expr_stmt|;
block|}
comment|/* Find out which VCM got the best results */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|+=
literal|2
control|)
block|{
name|int32_t
name|currd
decl_stmt|;
name|int32_t
name|mind
init|=
literal|0x100000
decl_stmt|;
name|int32_t
name|minpoll
init|=
literal|249
decl_stmt|;
name|uint8_t
name|minvcm
init|=
literal|0
decl_stmt|;
if|if
condition|(
literal|2
operator|*
name|core
operator|!=
name|i
condition|)
continue|continue;
for|for
control|(
name|vcm
operator|=
literal|0
init|;
name|vcm
operator|<
literal|8
condition|;
name|vcm
operator|++
control|)
block|{
name|currd
operator|=
name|results
index|[
name|vcm
index|]
index|[
name|i
index|]
operator|*
name|results
index|[
name|vcm
index|]
index|[
name|i
index|]
operator|+
name|results
index|[
name|vcm
index|]
index|[
name|i
operator|+
literal|1
index|]
operator|*
name|results
index|[
name|vcm
index|]
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|currd
operator|<
name|mind
condition|)
block|{
name|mind
operator|=
name|currd
expr_stmt|;
name|minvcm
operator|=
name|vcm
expr_stmt|;
block|}
if|if
condition|(
name|results
index|[
name|vcm
index|]
index|[
name|i
index|]
operator|<
name|minpoll
condition|)
name|minpoll
operator|=
name|results
index|[
name|vcm
index|]
index|[
name|i
index|]
expr_stmt|;
block|}
name|vcm_final
operator|=
name|minvcm
expr_stmt|;
name|results_min
index|[
name|i
index|]
operator|=
name|minpoll
expr_stmt|;
block|}
comment|/* Select the best VCM */
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|7
condition|)
name|BWN_RF_SETMASK
argument_list|(
name|mac
argument_list|,
name|core
condition|?
name|R2057_NB_MASTER_CORE1
else|:
name|R2057_NB_MASTER_CORE0
argument_list|,
operator|~
name|R2057_VCM_MASK
argument_list|,
name|vcm
argument_list|)
expr_stmt|;
else|else
name|BWN_RF_SETMASK
argument_list|(
name|mac
argument_list|,
name|r
operator||
name|B2056_RX_RSSI_MISC
argument_list|,
literal|0xE3
argument_list|,
name|vcm_final
operator|<<
literal|2
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|core
operator|!=
name|i
operator|/
literal|2
condition|)
continue|continue;
name|offset
index|[
name|i
index|]
operator|=
operator|-
name|results
index|[
name|vcm_final
index|]
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|offset
index|[
name|i
index|]
operator|<
literal|0
condition|)
name|offset
index|[
name|i
index|]
operator|=
operator|-
operator|(
operator|(
name|abs
argument_list|(
name|offset
index|[
name|i
index|]
argument_list|)
operator|+
literal|4
operator|)
operator|/
literal|8
operator|)
expr_stmt|;
else|else
name|offset
index|[
name|i
index|]
operator|=
operator|(
name|offset
index|[
name|i
index|]
operator|+
literal|4
operator|)
operator|/
literal|8
expr_stmt|;
if|if
condition|(
name|results_min
index|[
name|i
index|]
operator|==
literal|248
condition|)
name|offset
index|[
name|i
index|]
operator|=
operator|-
literal|32
expr_stmt|;
name|bwn_nphy_scale_offset_rssi
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|,
name|offset
index|[
name|i
index|]
argument_list|,
operator|(
name|i
operator|/
literal|2
operator|==
literal|0
operator|)
condition|?
literal|1
else|:
literal|2
argument_list|,
operator|(
name|i
operator|%
literal|2
operator|==
literal|0
operator|)
condition|?
name|N_RAIL_I
else|:
name|N_RAIL_Q
argument_list|,
name|N_RSSI_NB
argument_list|)
expr_stmt|;
block|}
block|}
for|for
control|(
name|core
operator|=
literal|0
init|;
name|core
operator|<
literal|2
condition|;
name|core
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|rx_core_state
operator|&
operator|(
literal|1
operator|<<
name|core
operator|)
operator|)
condition|)
continue|continue;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
block|{
name|bwn_nphy_scale_offset_rssi
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|core
operator|+
literal|1
argument_list|,
name|N_RAIL_I
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|bwn_nphy_scale_offset_rssi
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|core
operator|+
literal|1
argument_list|,
name|N_RAIL_Q
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|bwn_nphy_poll_rssi
argument_list|(
name|mac
argument_list|,
name|i
argument_list|,
name|poll_results
argument_list|,
literal|8
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|4
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|j
operator|/
literal|2
operator|==
name|core
condition|)
block|{
name|offset
index|[
name|j
index|]
operator|=
literal|232
operator|-
name|poll_results
index|[
name|j
index|]
expr_stmt|;
if|if
condition|(
name|offset
index|[
name|j
index|]
operator|<
literal|0
condition|)
name|offset
index|[
name|j
index|]
operator|=
operator|-
operator|(
name|abs
argument_list|(
name|offset
index|[
name|j
index|]
operator|+
literal|4
argument_list|)
operator|/
literal|8
operator|)
expr_stmt|;
else|else
name|offset
index|[
name|j
index|]
operator|=
operator|(
name|offset
index|[
name|j
index|]
operator|+
literal|4
operator|)
operator|/
literal|8
expr_stmt|;
name|bwn_nphy_scale_offset_rssi
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|,
name|offset
index|[
literal|2
operator|*
name|core
index|]
argument_list|,
name|core
operator|+
literal|1
argument_list|,
name|j
operator|%
literal|2
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_INTC1
argument_list|,
name|saved_regs_phy_rfctl
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_INTC2
argument_list|,
name|saved_regs_phy_rfctl
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|bwn_nphy_force_rf_sequence
argument_list|(
name|mac
argument_list|,
name|BWN_RFSEQ_RESET2RX
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TXF_40CO_B1S1
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_CMD
argument_list|,
name|BWN_NPHY_RFCTL_CMD_START
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TXF_40CO_B1S1
argument_list|,
operator|~
literal|0x1
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_OVER
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_CMD
argument_list|,
name|BWN_NPHY_RFCTL_CMD_RXTX
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_OVER
argument_list|,
operator|~
literal|0x1
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|regs_amount
condition|;
name|i
operator|++
control|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|regs_to_store
index|[
name|i
index|]
argument_list|,
name|saved_regs_phy
index|[
name|i
index|]
argument_list|)
expr_stmt|;
comment|/* Store for future configuration */
if|if
condition|(
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_2G
condition|)
block|{
name|rssical_radio_regs
operator|=
name|nphy
operator|->
name|rssical_cache
operator|.
name|rssical_radio_regs_2G
expr_stmt|;
name|rssical_phy_regs
operator|=
name|nphy
operator|->
name|rssical_cache
operator|.
name|rssical_phy_regs_2G
expr_stmt|;
block|}
else|else
block|{
name|rssical_radio_regs
operator|=
name|nphy
operator|->
name|rssical_cache
operator|.
name|rssical_radio_regs_5G
expr_stmt|;
name|rssical_phy_regs
operator|=
name|nphy
operator|->
name|rssical_cache
operator|.
name|rssical_phy_regs_5G
expr_stmt|;
block|}
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|7
condition|)
block|{
name|rssical_radio_regs
index|[
literal|0
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
name|R2057_NB_MASTER_CORE0
argument_list|)
expr_stmt|;
name|rssical_radio_regs
index|[
literal|1
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
name|R2057_NB_MASTER_CORE1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|rssical_radio_regs
index|[
literal|0
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
name|B2056_RX0
operator||
name|B2056_RX_RSSI_MISC
argument_list|)
expr_stmt|;
name|rssical_radio_regs
index|[
literal|1
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
name|B2056_RX1
operator||
name|B2056_RX_RSSI_MISC
argument_list|)
expr_stmt|;
block|}
name|rssical_phy_regs
index|[
literal|0
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RSSIMC_0I_RSSI_Z
argument_list|)
expr_stmt|;
name|rssical_phy_regs
index|[
literal|1
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RSSIMC_0Q_RSSI_Z
argument_list|)
expr_stmt|;
name|rssical_phy_regs
index|[
literal|2
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RSSIMC_1I_RSSI_Z
argument_list|)
expr_stmt|;
name|rssical_phy_regs
index|[
literal|3
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RSSIMC_1Q_RSSI_Z
argument_list|)
expr_stmt|;
name|rssical_phy_regs
index|[
literal|4
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RSSIMC_0I_RSSI_X
argument_list|)
expr_stmt|;
name|rssical_phy_regs
index|[
literal|5
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RSSIMC_0Q_RSSI_X
argument_list|)
expr_stmt|;
name|rssical_phy_regs
index|[
literal|6
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RSSIMC_1I_RSSI_X
argument_list|)
expr_stmt|;
name|rssical_phy_regs
index|[
literal|7
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RSSIMC_1Q_RSSI_X
argument_list|)
expr_stmt|;
name|rssical_phy_regs
index|[
literal|8
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RSSIMC_0I_RSSI_Y
argument_list|)
expr_stmt|;
name|rssical_phy_regs
index|[
literal|9
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RSSIMC_0Q_RSSI_Y
argument_list|)
expr_stmt|;
name|rssical_phy_regs
index|[
literal|10
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RSSIMC_1I_RSSI_Y
argument_list|)
expr_stmt|;
name|rssical_phy_regs
index|[
literal|11
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RSSIMC_1Q_RSSI_Y
argument_list|)
expr_stmt|;
comment|/* Remember for which channel we store configuration */
if|if
condition|(
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_2G
condition|)
name|nphy
operator|->
name|rssical_chanspec_2G
operator|.
name|center_freq
operator|=
name|bwn_get_centre_freq
argument_list|(
name|mac
argument_list|)
expr_stmt|;
else|else
name|nphy
operator|->
name|rssical_chanspec_5G
operator|.
name|center_freq
operator|=
name|bwn_get_centre_freq
argument_list|(
name|mac
argument_list|)
expr_stmt|;
comment|/* End of calibration, restore configuration */
name|bwn_nphy_classifier
argument_list|(
name|mac
argument_list|,
literal|7
argument_list|,
name|class
argument_list|)
expr_stmt|;
name|bwn_nphy_write_clip_detection
argument_list|(
name|mac
argument_list|,
name|clip_state
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RSSICal */
end_comment

begin_function
specifier|static
name|void
name|bwn_nphy_rev2_rssi_cal
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|enum
name|n_rssi_type
name|type
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|vcm
decl_stmt|;
name|uint8_t
name|state
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|code
decl_stmt|,
name|val
decl_stmt|;
name|uint16_t
name|class
decl_stmt|,
name|override
decl_stmt|;
name|uint8_t
name|regs_save_radio
index|[
literal|2
index|]
decl_stmt|;
name|uint16_t
name|regs_save_phy
index|[
literal|2
index|]
decl_stmt|;
name|int32_t
name|offset
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|core
decl_stmt|;
name|uint8_t
name|rail
decl_stmt|;
name|uint16_t
name|clip_state
index|[
literal|2
index|]
decl_stmt|;
name|uint16_t
name|clip_off
index|[
literal|2
index|]
init|=
block|{
literal|0xFFFF
block|,
literal|0xFFFF
block|}
decl_stmt|;
name|int32_t
name|results_min
index|[
literal|4
index|]
init|=
block|{ }
decl_stmt|;
name|uint8_t
name|vcm_final
index|[
literal|4
index|]
init|=
block|{ }
decl_stmt|;
name|int32_t
name|results
index|[
literal|4
index|]
index|[
literal|4
index|]
init|=
block|{ }
decl_stmt|;
name|int32_t
name|miniq
index|[
literal|4
index|]
index|[
literal|2
index|]
init|=
block|{ }
decl_stmt|;
if|if
condition|(
name|type
operator|==
name|N_RSSI_NB
condition|)
block|{
name|code
operator|=
literal|0
expr_stmt|;
name|val
operator|=
literal|6
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|type
operator|==
name|N_RSSI_W1
operator|||
name|type
operator|==
name|N_RSSI_W2
condition|)
block|{
name|code
operator|=
literal|25
expr_stmt|;
name|val
operator|=
literal|4
expr_stmt|;
block|}
else|else
block|{
name|BWN_ERRPRINTF
argument_list|(
name|mac
operator|->
name|mac_sc
argument_list|,
literal|"%s: RSSI type %d invalid\n"
argument_list|,
name|__func__
argument_list|,
name|type
argument_list|)
expr_stmt|;
return|return;
block|}
name|class
operator|=
name|bwn_nphy_classifier
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bwn_nphy_classifier
argument_list|(
name|mac
argument_list|,
literal|7
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|bwn_nphy_read_clip_detection
argument_list|(
name|mac
argument_list|,
name|clip_state
argument_list|)
expr_stmt|;
name|bwn_nphy_write_clip_detection
argument_list|(
name|mac
argument_list|,
name|clip_off
argument_list|)
expr_stmt|;
if|if
condition|(
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_5G
condition|)
name|override
operator|=
literal|0x140
expr_stmt|;
else|else
name|override
operator|=
literal|0x110
expr_stmt|;
name|regs_save_phy
index|[
literal|0
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_INTC1
argument_list|)
expr_stmt|;
name|regs_save_radio
index|[
literal|0
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
name|B2055_C1_PD_RXTX
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_INTC1
argument_list|,
name|override
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2055_C1_PD_RXTX
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|regs_save_phy
index|[
literal|1
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_INTC2
argument_list|)
expr_stmt|;
name|regs_save_radio
index|[
literal|1
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
name|B2055_C2_PD_RXTX
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_INTC2
argument_list|,
name|override
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2055_C2_PD_RXTX
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|state
index|[
literal|0
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
name|B2055_C1_PD_RSSIMISC
argument_list|)
operator|&
literal|0x07
expr_stmt|;
name|state
index|[
literal|1
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
name|B2055_C2_PD_RSSIMISC
argument_list|)
operator|&
literal|0x07
expr_stmt|;
name|BWN_RF_MASK
argument_list|(
name|mac
argument_list|,
name|B2055_C1_PD_RSSIMISC
argument_list|,
literal|0xF8
argument_list|)
expr_stmt|;
name|BWN_RF_MASK
argument_list|(
name|mac
argument_list|,
name|B2055_C2_PD_RSSIMISC
argument_list|,
literal|0xF8
argument_list|)
expr_stmt|;
name|state
index|[
literal|2
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
name|B2055_C1_SP_RSSI
argument_list|)
operator|&
literal|0x07
expr_stmt|;
name|state
index|[
literal|3
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
name|B2055_C2_SP_RSSI
argument_list|)
operator|&
literal|0x07
expr_stmt|;
name|bwn_nphy_rssi_select
argument_list|(
name|mac
argument_list|,
literal|5
argument_list|,
name|type
argument_list|)
expr_stmt|;
name|bwn_nphy_scale_offset_rssi
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|5
argument_list|,
name|N_RAIL_I
argument_list|,
name|type
argument_list|)
expr_stmt|;
name|bwn_nphy_scale_offset_rssi
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|5
argument_list|,
name|N_RAIL_Q
argument_list|,
name|type
argument_list|)
expr_stmt|;
for|for
control|(
name|vcm
operator|=
literal|0
init|;
name|vcm
operator|<
literal|4
condition|;
name|vcm
operator|++
control|)
block|{
name|uint8_t
name|tmp
index|[
literal|4
index|]
decl_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|4
condition|;
name|j
operator|++
control|)
name|tmp
index|[
name|j
index|]
operator|=
name|vcm
expr_stmt|;
if|if
condition|(
name|type
operator|!=
name|N_RSSI_W2
condition|)
name|bwn_nphy_set_rssi_2055_vcm
argument_list|(
name|mac
argument_list|,
name|type
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|bwn_nphy_poll_rssi
argument_list|(
name|mac
argument_list|,
name|type
argument_list|,
name|results
index|[
name|vcm
index|]
argument_list|,
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|N_RSSI_W1
operator|||
name|type
operator|==
name|N_RSSI_W2
condition|)
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|2
condition|;
name|j
operator|++
control|)
name|miniq
index|[
name|vcm
index|]
index|[
name|j
index|]
operator|=
name|min
argument_list|(
name|results
index|[
name|vcm
index|]
index|[
literal|2
operator|*
name|j
index|]
argument_list|,
name|results
index|[
name|vcm
index|]
index|[
literal|2
operator|*
name|j
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
name|int32_t
name|mind
init|=
literal|0x100000
decl_stmt|;
name|uint8_t
name|minvcm
init|=
literal|0
decl_stmt|;
name|int32_t
name|minpoll
init|=
literal|249
decl_stmt|;
name|int32_t
name|currd
decl_stmt|;
for|for
control|(
name|vcm
operator|=
literal|0
init|;
name|vcm
operator|<
literal|4
condition|;
name|vcm
operator|++
control|)
block|{
if|if
condition|(
name|type
operator|==
name|N_RSSI_NB
condition|)
name|currd
operator|=
name|abs
argument_list|(
name|results
index|[
name|vcm
index|]
index|[
name|i
index|]
operator|-
name|code
operator|*
literal|8
argument_list|)
expr_stmt|;
else|else
name|currd
operator|=
name|abs
argument_list|(
name|miniq
index|[
name|vcm
index|]
index|[
name|i
operator|/
literal|2
index|]
operator|-
name|code
operator|*
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|currd
operator|<
name|mind
condition|)
block|{
name|mind
operator|=
name|currd
expr_stmt|;
name|minvcm
operator|=
name|vcm
expr_stmt|;
block|}
if|if
condition|(
name|results
index|[
name|vcm
index|]
index|[
name|i
index|]
operator|<
name|minpoll
condition|)
name|minpoll
operator|=
name|results
index|[
name|vcm
index|]
index|[
name|i
index|]
expr_stmt|;
block|}
name|results_min
index|[
name|i
index|]
operator|=
name|minpoll
expr_stmt|;
name|vcm_final
index|[
name|i
index|]
operator|=
name|minvcm
expr_stmt|;
block|}
if|if
condition|(
name|type
operator|!=
name|N_RSSI_W2
condition|)
name|bwn_nphy_set_rssi_2055_vcm
argument_list|(
name|mac
argument_list|,
name|type
argument_list|,
name|vcm_final
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
name|offset
index|[
name|i
index|]
operator|=
operator|(
name|code
operator|*
literal|8
operator|)
operator|-
name|results
index|[
name|vcm_final
index|[
name|i
index|]
index|]
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|offset
index|[
name|i
index|]
operator|<
literal|0
condition|)
name|offset
index|[
name|i
index|]
operator|=
operator|-
operator|(
operator|(
name|abs
argument_list|(
name|offset
index|[
name|i
index|]
argument_list|)
operator|+
literal|4
operator|)
operator|/
literal|8
operator|)
expr_stmt|;
else|else
name|offset
index|[
name|i
index|]
operator|=
operator|(
name|offset
index|[
name|i
index|]
operator|+
literal|4
operator|)
operator|/
literal|8
expr_stmt|;
if|if
condition|(
name|results_min
index|[
name|i
index|]
operator|==
literal|248
condition|)
name|offset
index|[
name|i
index|]
operator|=
name|code
operator|-
literal|32
expr_stmt|;
name|core
operator|=
operator|(
name|i
operator|/
literal|2
operator|)
condition|?
literal|2
else|:
literal|1
expr_stmt|;
name|rail
operator|=
operator|(
name|i
operator|%
literal|2
operator|)
condition|?
name|N_RAIL_Q
else|:
name|N_RAIL_I
expr_stmt|;
name|bwn_nphy_scale_offset_rssi
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|,
name|offset
index|[
name|i
index|]
argument_list|,
name|core
argument_list|,
name|rail
argument_list|,
name|type
argument_list|)
expr_stmt|;
block|}
name|BWN_RF_SETMASK
argument_list|(
name|mac
argument_list|,
name|B2055_C1_PD_RSSIMISC
argument_list|,
literal|0xF8
argument_list|,
name|state
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|BWN_RF_SETMASK
argument_list|(
name|mac
argument_list|,
name|B2055_C2_PD_RSSIMISC
argument_list|,
literal|0xF8
argument_list|,
name|state
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|state
index|[
literal|2
index|]
condition|)
block|{
case|case
literal|1
case|:
name|bwn_nphy_rssi_select
argument_list|(
name|mac
argument_list|,
literal|1
argument_list|,
name|N_RSSI_NB
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|bwn_nphy_rssi_select
argument_list|(
name|mac
argument_list|,
literal|1
argument_list|,
name|N_RSSI_W1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|bwn_nphy_rssi_select
argument_list|(
name|mac
argument_list|,
literal|1
argument_list|,
name|N_RSSI_W2
argument_list|)
expr_stmt|;
break|break;
default|default:
name|bwn_nphy_rssi_select
argument_list|(
name|mac
argument_list|,
literal|1
argument_list|,
name|N_RSSI_W2
argument_list|)
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
name|state
index|[
literal|3
index|]
condition|)
block|{
case|case
literal|1
case|:
name|bwn_nphy_rssi_select
argument_list|(
name|mac
argument_list|,
literal|2
argument_list|,
name|N_RSSI_NB
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|bwn_nphy_rssi_select
argument_list|(
name|mac
argument_list|,
literal|2
argument_list|,
name|N_RSSI_W1
argument_list|)
expr_stmt|;
break|break;
default|default:
name|bwn_nphy_rssi_select
argument_list|(
name|mac
argument_list|,
literal|2
argument_list|,
name|N_RSSI_W2
argument_list|)
expr_stmt|;
break|break;
block|}
name|bwn_nphy_rssi_select
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|,
name|type
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_INTC1
argument_list|,
name|regs_save_phy
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2055_C1_PD_RXTX
argument_list|,
name|regs_save_radio
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_INTC2
argument_list|,
name|regs_save_phy
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2055_C2_PD_RXTX
argument_list|,
name|regs_save_radio
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|bwn_nphy_classifier
argument_list|(
name|mac
argument_list|,
literal|7
argument_list|,
name|class
argument_list|)
expr_stmt|;
name|bwn_nphy_write_clip_detection
argument_list|(
name|mac
argument_list|,
name|clip_state
argument_list|)
expr_stmt|;
comment|/* Specs don't say about reset here, but it makes wl and b43 dumps 	   identical, it really seems wl performs this */
name|bwn_nphy_reset_cca
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * RSSI Calibration  * http://bcm-v4.sipsolutions.net/802.11/PHY/N/RSSICal  */
end_comment

begin_function
specifier|static
name|void
name|bwn_nphy_rssi_cal
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|19
condition|)
block|{
comment|/* TODO */
block|}
elseif|else
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|3
condition|)
block|{
name|bwn_nphy_rev3_rssi_cal
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|bwn_nphy_rev2_rssi_cal
argument_list|(
name|mac
argument_list|,
name|N_RSSI_NB
argument_list|)
expr_stmt|;
name|bwn_nphy_rev2_rssi_cal
argument_list|(
name|mac
argument_list|,
name|N_RSSI_W1
argument_list|)
expr_stmt|;
name|bwn_nphy_rev2_rssi_cal
argument_list|(
name|mac
argument_list|,
name|N_RSSI_W2
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**************************************************  * Workarounds  **************************************************/
end_comment

begin_function
specifier|static
name|void
name|bwn_nphy_gain_ctl_workarounds_rev19
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
comment|/* TODO */
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_nphy_gain_ctl_workarounds_rev7
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
switch|switch
condition|(
name|phy
operator|->
name|rev
condition|)
block|{
comment|/* TODO */
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_nphy_gain_ctl_workarounds_rev3
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|bool
name|ghz5
decl_stmt|;
name|bool
name|ext_lna
decl_stmt|;
name|uint16_t
name|rssi_gain
decl_stmt|;
name|struct
name|bwn_nphy_gain_ctl_workaround_entry
modifier|*
name|e
decl_stmt|;
name|uint8_t
name|lpf_gain
index|[
literal|6
index|]
init|=
block|{
literal|0x00
block|,
literal|0x06
block|,
literal|0x0C
block|,
literal|0x12
block|,
literal|0x12
block|,
literal|0x12
block|}
decl_stmt|;
name|uint8_t
name|lpf_bits
index|[
literal|6
index|]
init|=
block|{
literal|0
block|,
literal|1
block|,
literal|2
block|,
literal|3
block|,
literal|3
block|,
literal|3
block|}
decl_stmt|;
comment|/* Prepare values */
name|ghz5
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_BANDCTL
argument_list|)
operator|&
name|BWN_NPHY_BANDCTL_5GHZ
expr_stmt|;
name|ext_lna
operator|=
name|ghz5
condition|?
name|siba_sprom_get_bf_hi
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|&
name|BWN_BFH_EXTLNA_5GHZ
else|:
name|siba_sprom_get_bf_lo
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|&
name|BWN_BFL_EXTLNA
expr_stmt|;
name|e
operator|=
name|bwn_nphy_get_gain_ctl_workaround_ent
argument_list|(
name|mac
argument_list|,
name|ghz5
argument_list|,
name|ext_lna
argument_list|)
expr_stmt|;
if|if
condition|(
name|ghz5
operator|&&
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|5
condition|)
name|rssi_gain
operator|=
literal|0x90
expr_stmt|;
else|else
name|rssi_gain
operator|=
literal|0x50
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RXCTL
argument_list|,
literal|0x0040
argument_list|)
expr_stmt|;
comment|/* Set Clip 2 detect */
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_C1_CGAINI
argument_list|,
name|BWN_NPHY_C1_CGAINI_CL2DETECT
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_C2_CGAINI
argument_list|,
name|BWN_NPHY_C2_CGAINI_CL2DETECT
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_RX0
operator||
name|B2056_RX_BIASPOLE_LNAG1_IDAC
argument_list|,
literal|0x17
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_RX1
operator||
name|B2056_RX_BIASPOLE_LNAG1_IDAC
argument_list|,
literal|0x17
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_RX0
operator||
name|B2056_RX_LNAG2_IDAC
argument_list|,
literal|0xF0
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_RX1
operator||
name|B2056_RX_LNAG2_IDAC
argument_list|,
literal|0xF0
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_RX0
operator||
name|B2056_RX_RSSI_POLE
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_RX1
operator||
name|B2056_RX_RSSI_POLE
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_RX0
operator||
name|B2056_RX_RSSI_GAIN
argument_list|,
name|rssi_gain
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_RX1
operator||
name|B2056_RX_RSSI_GAIN
argument_list|,
name|rssi_gain
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_RX0
operator||
name|B2056_RX_BIASPOLE_LNAA1_IDAC
argument_list|,
literal|0x17
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_RX1
operator||
name|B2056_RX_BIASPOLE_LNAA1_IDAC
argument_list|,
literal|0x17
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_RX0
operator||
name|B2056_RX_LNAA2_IDAC
argument_list|,
literal|0xFF
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_RX1
operator||
name|B2056_RX_LNAA2_IDAC
argument_list|,
literal|0xFF
argument_list|)
expr_stmt|;
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB8
argument_list|(
literal|0
argument_list|,
literal|8
argument_list|)
argument_list|,
literal|4
argument_list|,
name|e
operator|->
name|lna1_gain
argument_list|)
expr_stmt|;
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB8
argument_list|(
literal|1
argument_list|,
literal|8
argument_list|)
argument_list|,
literal|4
argument_list|,
name|e
operator|->
name|lna1_gain
argument_list|)
expr_stmt|;
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB8
argument_list|(
literal|0
argument_list|,
literal|16
argument_list|)
argument_list|,
literal|4
argument_list|,
name|e
operator|->
name|lna2_gain
argument_list|)
expr_stmt|;
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB8
argument_list|(
literal|1
argument_list|,
literal|16
argument_list|)
argument_list|,
literal|4
argument_list|,
name|e
operator|->
name|lna2_gain
argument_list|)
expr_stmt|;
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB8
argument_list|(
literal|0
argument_list|,
literal|32
argument_list|)
argument_list|,
literal|10
argument_list|,
name|e
operator|->
name|gain_db
argument_list|)
expr_stmt|;
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB8
argument_list|(
literal|1
argument_list|,
literal|32
argument_list|)
argument_list|,
literal|10
argument_list|,
name|e
operator|->
name|gain_db
argument_list|)
expr_stmt|;
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB8
argument_list|(
literal|2
argument_list|,
literal|32
argument_list|)
argument_list|,
literal|10
argument_list|,
name|e
operator|->
name|gain_bits
argument_list|)
expr_stmt|;
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB8
argument_list|(
literal|3
argument_list|,
literal|32
argument_list|)
argument_list|,
literal|10
argument_list|,
name|e
operator|->
name|gain_bits
argument_list|)
expr_stmt|;
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB8
argument_list|(
literal|0
argument_list|,
literal|0x40
argument_list|)
argument_list|,
literal|6
argument_list|,
name|lpf_gain
argument_list|)
expr_stmt|;
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB8
argument_list|(
literal|1
argument_list|,
literal|0x40
argument_list|)
argument_list|,
literal|6
argument_list|,
name|lpf_gain
argument_list|)
expr_stmt|;
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB8
argument_list|(
literal|2
argument_list|,
literal|0x40
argument_list|)
argument_list|,
literal|6
argument_list|,
name|lpf_bits
argument_list|)
expr_stmt|;
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB8
argument_list|(
literal|3
argument_list|,
literal|0x40
argument_list|)
argument_list|,
literal|6
argument_list|,
name|lpf_bits
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_REV3_C1_INITGAIN_A
argument_list|,
name|e
operator|->
name|init_gain
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_REV3_C2_INITGAIN_A
argument_list|,
name|e
operator|->
name|init_gain
argument_list|)
expr_stmt|;
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|7
argument_list|,
literal|0x106
argument_list|)
argument_list|,
literal|2
argument_list|,
name|e
operator|->
name|rfseq_init
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_REV3_C1_CLIP_HIGAIN_A
argument_list|,
name|e
operator|->
name|cliphi_gain
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_REV3_C2_CLIP_HIGAIN_A
argument_list|,
name|e
operator|->
name|cliphi_gain
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_REV3_C1_CLIP_MEDGAIN_A
argument_list|,
name|e
operator|->
name|clipmd_gain
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_REV3_C2_CLIP_MEDGAIN_A
argument_list|,
name|e
operator|->
name|clipmd_gain
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_REV3_C1_CLIP_LOGAIN_A
argument_list|,
name|e
operator|->
name|cliplo_gain
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_REV3_C2_CLIP_LOGAIN_A
argument_list|,
name|e
operator|->
name|cliplo_gain
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_CRSMINPOWER0
argument_list|,
literal|0xFF00
argument_list|,
name|e
operator|->
name|crsmin
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_CRSMINPOWERL0
argument_list|,
literal|0xFF00
argument_list|,
name|e
operator|->
name|crsminl
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_CRSMINPOWERU0
argument_list|,
literal|0xFF00
argument_list|,
name|e
operator|->
name|crsminu
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_C1_NBCLIPTHRES
argument_list|,
name|e
operator|->
name|nbclip
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_C2_NBCLIPTHRES
argument_list|,
name|e
operator|->
name|nbclip
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_C1_CLIPWBTHRES
argument_list|,
operator|~
name|BWN_NPHY_C1_CLIPWBTHRES_CLIP2
argument_list|,
name|e
operator|->
name|wlclip
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_C2_CLIPWBTHRES
argument_list|,
operator|~
name|BWN_NPHY_C2_CLIPWBTHRES_CLIP2
argument_list|,
name|e
operator|->
name|wlclip
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_CCK_SHIFTB_REF
argument_list|,
literal|0x809C
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_nphy_gain_ctl_workarounds_rev1_2
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_phy_n
modifier|*
name|nphy
init|=
name|mac
operator|->
name|mac_phy
operator|.
name|phy_n
decl_stmt|;
name|uint8_t
name|i
decl_stmt|,
name|j
decl_stmt|;
name|uint8_t
name|code
decl_stmt|;
name|uint16_t
name|tmp
decl_stmt|;
name|uint8_t
name|rfseq_events
index|[
literal|3
index|]
init|=
block|{
literal|6
block|,
literal|8
block|,
literal|7
block|}
decl_stmt|;
name|uint8_t
name|rfseq_delays
index|[
literal|3
index|]
init|=
block|{
literal|10
block|,
literal|30
block|,
literal|1
block|}
decl_stmt|;
comment|/* Set Clip 2 detect */
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_C1_CGAINI
argument_list|,
name|BWN_NPHY_C1_CGAINI_CL2DETECT
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_C2_CGAINI
argument_list|,
name|BWN_NPHY_C2_CGAINI_CL2DETECT
argument_list|)
expr_stmt|;
comment|/* Set narrowband clip threshold */
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_C1_NBCLIPTHRES
argument_list|,
literal|0x84
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_C2_NBCLIPTHRES
argument_list|,
literal|0x84
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bwn_is_40mhz
argument_list|(
name|mac
argument_list|)
condition|)
block|{
comment|/* Set dwell lengths */
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_CLIP1_NBDWELL_LEN
argument_list|,
literal|0x002B
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_CLIP2_NBDWELL_LEN
argument_list|,
literal|0x002B
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_W1CLIP1_DWELL_LEN
argument_list|,
literal|0x0009
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_W1CLIP2_DWELL_LEN
argument_list|,
literal|0x0009
argument_list|)
expr_stmt|;
block|}
comment|/* Set wideband clip 2 threshold */
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_C1_CLIPWBTHRES
argument_list|,
operator|~
name|BWN_NPHY_C1_CLIPWBTHRES_CLIP2
argument_list|,
literal|21
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_C2_CLIPWBTHRES
argument_list|,
operator|~
name|BWN_NPHY_C2_CLIPWBTHRES_CLIP2
argument_list|,
literal|21
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bwn_is_40mhz
argument_list|(
name|mac
argument_list|)
condition|)
block|{
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_C1_CGAINI
argument_list|,
operator|~
name|BWN_NPHY_C1_CGAINI_GAINBKOFF
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_C2_CGAINI
argument_list|,
operator|~
name|BWN_NPHY_C2_CGAINI_GAINBKOFF
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_C1_CCK_CGAINI
argument_list|,
operator|~
name|BWN_NPHY_C1_CCK_CGAINI_GAINBKOFF
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_C2_CCK_CGAINI
argument_list|,
operator|~
name|BWN_NPHY_C2_CCK_CGAINI_GAINBKOFF
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
block|}
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_CCK_SHIFTB_REF
argument_list|,
literal|0x809C
argument_list|)
expr_stmt|;
if|if
condition|(
name|nphy
operator|->
name|gain_boost
condition|)
block|{
if|if
condition|(
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_2G
operator|&&
name|bwn_is_40mhz
argument_list|(
name|mac
argument_list|)
condition|)
name|code
operator|=
literal|4
expr_stmt|;
else|else
name|code
operator|=
literal|5
expr_stmt|;
block|}
else|else
block|{
name|code
operator|=
name|bwn_is_40mhz
argument_list|(
name|mac
argument_list|)
condition|?
literal|6
else|:
literal|7
expr_stmt|;
block|}
comment|/* Set HPVGA2 index */
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_C1_INITGAIN
argument_list|,
operator|~
name|BWN_NPHY_C1_INITGAIN_HPVGA2
argument_list|,
name|code
operator|<<
name|BWN_NPHY_C1_INITGAIN_HPVGA2_SHIFT
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_C2_INITGAIN
argument_list|,
operator|~
name|BWN_NPHY_C2_INITGAIN_HPVGA2
argument_list|,
name|code
operator|<<
name|BWN_NPHY_C2_INITGAIN_HPVGA2_SHIFT
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TABLE_ADDR
argument_list|,
literal|0x1D06
argument_list|)
expr_stmt|;
comment|/* specs say about 2 loops, but wl does 4 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TABLE_DATALO
argument_list|,
operator|(
name|code
operator|<<
literal|8
operator||
literal|0x7C
operator|)
argument_list|)
expr_stmt|;
name|bwn_nphy_adjust_lna_gain_table
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|nphy
operator|->
name|elna_gain_config
condition|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TABLE_ADDR
argument_list|,
literal|0x0808
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TABLE_DATALO
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TABLE_DATALO
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TABLE_DATALO
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TABLE_DATALO
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TABLE_ADDR
argument_list|,
literal|0x0C08
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TABLE_DATALO
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TABLE_DATALO
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TABLE_DATALO
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TABLE_DATALO
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TABLE_ADDR
argument_list|,
literal|0x1D06
argument_list|)
expr_stmt|;
comment|/* specs say about 2 loops, but wl does 4 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TABLE_DATALO
argument_list|,
operator|(
name|code
operator|<<
literal|8
operator||
literal|0x74
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|==
literal|2
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TABLE_ADDR
argument_list|,
operator|(
literal|0x0400
operator|*
name|i
operator|)
operator|+
literal|0x0020
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|21
condition|;
name|j
operator|++
control|)
block|{
name|tmp
operator|=
name|j
operator|*
operator|(
name|i
operator|<
literal|2
condition|?
literal|3
else|:
literal|1
operator|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TABLE_DATALO
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|bwn_nphy_set_rf_sequence
argument_list|(
name|mac
argument_list|,
literal|5
argument_list|,
name|rfseq_events
argument_list|,
name|rfseq_delays
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_OVER_DGAIN1
argument_list|,
operator|~
name|BWN_NPHY_OVER_DGAIN_CCKDGECV
operator|&
literal|0xFFFF
argument_list|,
literal|0x5A
operator|<<
name|BWN_NPHY_OVER_DGAIN_CCKDGECV_SHIFT
argument_list|)
expr_stmt|;
if|if
condition|(
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_2G
condition|)
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_N
argument_list|(
literal|0xC5D
argument_list|)
argument_list|,
literal|0xFF80
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/WorkaroundsGainCtrl */
end_comment

begin_function
specifier|static
name|void
name|bwn_nphy_gain_ctl_workarounds
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|19
condition|)
name|bwn_nphy_gain_ctl_workarounds_rev19
argument_list|(
name|mac
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|7
condition|)
name|bwn_nphy_gain_ctl_workarounds_rev7
argument_list|(
name|mac
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|3
condition|)
name|bwn_nphy_gain_ctl_workarounds_rev3
argument_list|(
name|mac
argument_list|)
expr_stmt|;
else|else
name|bwn_nphy_gain_ctl_workarounds_rev1_2
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_nphy_workarounds_rev7plus
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
comment|/* TX to RX */
name|uint8_t
name|tx2rx_events
index|[
literal|7
index|]
init|=
block|{
literal|4
block|,
literal|3
block|,
literal|5
block|,
literal|2
block|,
literal|1
block|,
literal|8
block|,
literal|31
block|, }
decl_stmt|;
name|uint8_t
name|tx2rx_delays
index|[
literal|7
index|]
init|=
block|{
literal|8
block|,
literal|4
block|,
literal|4
block|,
literal|4
block|,
literal|4
block|,
literal|6
block|,
literal|1
block|, }
decl_stmt|;
comment|/* RX to TX */
name|uint8_t
name|rx2tx_events_ipa
index|[
literal|9
index|]
init|=
block|{
literal|0x0
block|,
literal|0x1
block|,
literal|0x2
block|,
literal|0x8
block|,
literal|0x5
block|,
literal|0x6
block|,
literal|0xF
block|,
literal|0x3
block|,
literal|0x1F
block|}
decl_stmt|;
name|uint8_t
name|rx2tx_delays_ipa
index|[
literal|9
index|]
init|=
block|{
literal|8
block|,
literal|6
block|,
literal|6
block|,
literal|4
block|,
literal|4
block|,
literal|16
block|,
literal|43
block|,
literal|1
block|,
literal|1
block|}
decl_stmt|;
specifier|static
specifier|const
name|uint16_t
name|ntab7_15e_16e
index|[]
init|=
block|{
literal|0
block|,
literal|0x10f
block|,
literal|0x10f
block|}
decl_stmt|;
name|uint8_t
name|ntab7_138_146
index|[]
init|=
block|{
literal|0x11
block|,
literal|0x11
block|}
decl_stmt|;
name|uint8_t
name|ntab7_133
index|[]
init|=
block|{
literal|0x77
block|,
literal|0x11
block|,
literal|0x11
block|}
decl_stmt|;
name|uint16_t
name|lpf_ofdm_20mhz
index|[
literal|2
index|]
decl_stmt|,
name|lpf_ofdm_40mhz
index|[
literal|2
index|]
decl_stmt|,
name|lpf_11b
index|[
literal|2
index|]
decl_stmt|;
name|uint16_t
name|bcap_val
decl_stmt|;
name|int16_t
name|bcap_val_11b
index|[
literal|2
index|]
decl_stmt|,
name|bcap_val_11n_20
index|[
literal|2
index|]
decl_stmt|,
name|bcap_val_11n_40
index|[
literal|2
index|]
decl_stmt|;
name|uint16_t
name|scap_val
decl_stmt|;
name|int16_t
name|scap_val_11b
index|[
literal|2
index|]
decl_stmt|,
name|scap_val_11n_20
index|[
literal|2
index|]
decl_stmt|,
name|scap_val_11n_40
index|[
literal|2
index|]
decl_stmt|;
name|bool
name|rccal_ovrd
init|=
name|false
decl_stmt|;
name|uint16_t
name|bias
decl_stmt|,
name|conv
decl_stmt|,
name|filt
decl_stmt|;
name|uint32_t
name|noise_tbl
index|[
literal|2
index|]
decl_stmt|;
name|uint32_t
name|tmp32
decl_stmt|;
name|uint8_t
name|core
decl_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_PHASETR_A0
argument_list|,
literal|0x0125
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_PHASETR_A1
argument_list|,
literal|0x01b3
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_PHASETR_A2
argument_list|,
literal|0x0105
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_PHASETR_B0
argument_list|,
literal|0x016e
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_PHASETR_B1
argument_list|,
literal|0x00cd
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_PHASETR_B2
argument_list|,
literal|0x0020
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|==
literal|7
condition|)
block|{
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_FINERX2_CGC
argument_list|,
literal|0x10
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_FREQGAIN0
argument_list|,
literal|0xFF80
argument_list|,
literal|0x0020
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_FREQGAIN0
argument_list|,
literal|0x80FF
argument_list|,
literal|0x2700
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_FREQGAIN1
argument_list|,
literal|0xFF80
argument_list|,
literal|0x002E
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_FREQGAIN1
argument_list|,
literal|0x80FF
argument_list|,
literal|0x3300
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_FREQGAIN2
argument_list|,
literal|0xFF80
argument_list|,
literal|0x0037
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_FREQGAIN2
argument_list|,
literal|0x80FF
argument_list|,
literal|0x3A00
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_FREQGAIN3
argument_list|,
literal|0xFF80
argument_list|,
literal|0x003C
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_FREQGAIN3
argument_list|,
literal|0x80FF
argument_list|,
literal|0x3E00
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_FREQGAIN4
argument_list|,
literal|0xFF80
argument_list|,
literal|0x003E
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_FREQGAIN4
argument_list|,
literal|0x80FF
argument_list|,
literal|0x3F00
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_FREQGAIN5
argument_list|,
literal|0xFF80
argument_list|,
literal|0x0040
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_FREQGAIN5
argument_list|,
literal|0x80FF
argument_list|,
literal|0x4000
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_FREQGAIN6
argument_list|,
literal|0xFF80
argument_list|,
literal|0x0040
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_FREQGAIN6
argument_list|,
literal|0x80FF
argument_list|,
literal|0x4000
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_FREQGAIN7
argument_list|,
literal|0xFF80
argument_list|,
literal|0x0040
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_FREQGAIN7
argument_list|,
literal|0x80FF
argument_list|,
literal|0x4000
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|16
condition|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_FORCEFRONT0
argument_list|,
literal|0x7ff
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_FORCEFRONT1
argument_list|,
literal|0x7ff
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|phy
operator|->
name|rev
operator|<=
literal|8
condition|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_FORCEFRONT0
argument_list|,
literal|0x1B0
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_FORCEFRONT1
argument_list|,
literal|0x1B0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|16
condition|)
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TXTAILCNT
argument_list|,
operator|~
literal|0xFF
argument_list|,
literal|0xa0
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|8
condition|)
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TXTAILCNT
argument_list|,
operator|~
literal|0xFF
argument_list|,
literal|0x72
argument_list|)
expr_stmt|;
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|8
argument_list|,
literal|0x00
argument_list|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|8
argument_list|,
literal|0x10
argument_list|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|tmp32
operator|=
name|bwn_ntab_read
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB32
argument_list|(
literal|30
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|tmp32
operator|&=
literal|0xffffff
expr_stmt|;
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB32
argument_list|(
literal|30
argument_list|,
literal|0
argument_list|)
argument_list|,
name|tmp32
argument_list|)
expr_stmt|;
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|7
argument_list|,
literal|0x15d
argument_list|)
argument_list|,
literal|3
argument_list|,
name|ntab7_15e_16e
argument_list|)
expr_stmt|;
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|7
argument_list|,
literal|0x16d
argument_list|)
argument_list|,
literal|3
argument_list|,
name|ntab7_15e_16e
argument_list|)
expr_stmt|;
name|bwn_nphy_set_rf_sequence
argument_list|(
name|mac
argument_list|,
literal|1
argument_list|,
name|tx2rx_events
argument_list|,
name|tx2rx_delays
argument_list|,
name|nitems
argument_list|(
name|tx2rx_events
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bwn_nphy_ipa
argument_list|(
name|mac
argument_list|)
condition|)
name|bwn_nphy_set_rf_sequence
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|,
name|rx2tx_events_ipa
argument_list|,
name|rx2tx_delays_ipa
argument_list|,
name|nitems
argument_list|(
name|rx2tx_events_ipa
argument_list|)
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_EPS_OVERRIDEI_0
argument_list|,
literal|0x3FFF
argument_list|,
literal|0x4000
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_EPS_OVERRIDEI_1
argument_list|,
literal|0x3FFF
argument_list|,
literal|0x4000
argument_list|)
expr_stmt|;
for|for
control|(
name|core
operator|=
literal|0
init|;
name|core
operator|<
literal|2
condition|;
name|core
operator|++
control|)
block|{
name|lpf_ofdm_20mhz
index|[
name|core
index|]
operator|=
name|bwn_nphy_read_lpf_ctl
argument_list|(
name|mac
argument_list|,
literal|0x154
operator|+
name|core
operator|*
literal|0x10
argument_list|)
expr_stmt|;
name|lpf_ofdm_40mhz
index|[
name|core
index|]
operator|=
name|bwn_nphy_read_lpf_ctl
argument_list|(
name|mac
argument_list|,
literal|0x159
operator|+
name|core
operator|*
literal|0x10
argument_list|)
expr_stmt|;
name|lpf_11b
index|[
name|core
index|]
operator|=
name|bwn_nphy_read_lpf_ctl
argument_list|(
name|mac
argument_list|,
literal|0x152
operator|+
name|core
operator|*
literal|0x10
argument_list|)
expr_stmt|;
block|}
name|bcap_val
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
name|R2057_RCCAL_BCAP_VAL
argument_list|)
expr_stmt|;
name|scap_val
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
name|R2057_RCCAL_SCAP_VAL
argument_list|)
expr_stmt|;
if|if
condition|(
name|bwn_nphy_ipa
argument_list|(
name|mac
argument_list|)
condition|)
block|{
name|bool
name|ghz2
init|=
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_2G
decl_stmt|;
switch|switch
condition|(
name|phy
operator|->
name|rf_rev
condition|)
block|{
case|case
literal|5
case|:
comment|/* Check radio version (to be 0) by PHY rev for now */
if|if
condition|(
name|phy
operator|->
name|rev
operator|==
literal|8
operator|&&
name|bwn_is_40mhz
argument_list|(
name|mac
argument_list|)
condition|)
block|{
for|for
control|(
name|core
operator|=
literal|0
init|;
name|core
operator|<
literal|2
condition|;
name|core
operator|++
control|)
block|{
name|scap_val_11b
index|[
name|core
index|]
operator|=
name|scap_val
expr_stmt|;
name|bcap_val_11b
index|[
name|core
index|]
operator|=
name|bcap_val
expr_stmt|;
name|scap_val_11n_20
index|[
name|core
index|]
operator|=
name|scap_val
expr_stmt|;
name|bcap_val_11n_20
index|[
name|core
index|]
operator|=
name|bcap_val
expr_stmt|;
name|scap_val_11n_40
index|[
name|core
index|]
operator|=
literal|0xc
expr_stmt|;
name|bcap_val_11n_40
index|[
name|core
index|]
operator|=
literal|0xc
expr_stmt|;
block|}
name|rccal_ovrd
operator|=
name|true
expr_stmt|;
block|}
if|if
condition|(
name|phy
operator|->
name|rev
operator|==
literal|9
condition|)
block|{
comment|/* TODO: Radio version 1 (e.g. BCM5357B0) */
block|}
break|break;
case|case
literal|7
case|:
case|case
literal|8
case|:
for|for
control|(
name|core
operator|=
literal|0
init|;
name|core
operator|<
literal|2
condition|;
name|core
operator|++
control|)
block|{
name|scap_val_11b
index|[
name|core
index|]
operator|=
name|scap_val
expr_stmt|;
name|bcap_val_11b
index|[
name|core
index|]
operator|=
name|bcap_val
expr_stmt|;
name|lpf_ofdm_20mhz
index|[
name|core
index|]
operator|=
literal|4
expr_stmt|;
name|lpf_11b
index|[
name|core
index|]
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_2G
condition|)
block|{
name|scap_val_11n_20
index|[
name|core
index|]
operator|=
literal|0xc
expr_stmt|;
name|bcap_val_11n_20
index|[
name|core
index|]
operator|=
literal|0xc
expr_stmt|;
name|scap_val_11n_40
index|[
name|core
index|]
operator|=
literal|0xa
expr_stmt|;
name|bcap_val_11n_40
index|[
name|core
index|]
operator|=
literal|0xa
expr_stmt|;
block|}
else|else
block|{
name|scap_val_11n_20
index|[
name|core
index|]
operator|=
literal|0x14
expr_stmt|;
name|bcap_val_11n_20
index|[
name|core
index|]
operator|=
literal|0x14
expr_stmt|;
name|scap_val_11n_40
index|[
name|core
index|]
operator|=
literal|0xf
expr_stmt|;
name|bcap_val_11n_40
index|[
name|core
index|]
operator|=
literal|0xf
expr_stmt|;
block|}
block|}
name|rccal_ovrd
operator|=
name|true
expr_stmt|;
break|break;
case|case
literal|9
case|:
for|for
control|(
name|core
operator|=
literal|0
init|;
name|core
operator|<
literal|2
condition|;
name|core
operator|++
control|)
block|{
name|bcap_val_11b
index|[
name|core
index|]
operator|=
name|bcap_val
expr_stmt|;
name|scap_val_11b
index|[
name|core
index|]
operator|=
name|scap_val
expr_stmt|;
name|lpf_11b
index|[
name|core
index|]
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|ghz2
condition|)
block|{
name|bcap_val_11n_20
index|[
name|core
index|]
operator|=
name|bcap_val
operator|+
literal|13
expr_stmt|;
name|scap_val_11n_20
index|[
name|core
index|]
operator|=
name|scap_val
operator|+
literal|15
expr_stmt|;
block|}
else|else
block|{
name|bcap_val_11n_20
index|[
name|core
index|]
operator|=
name|bcap_val
operator|+
literal|14
expr_stmt|;
name|scap_val_11n_20
index|[
name|core
index|]
operator|=
name|scap_val
operator|+
literal|15
expr_stmt|;
block|}
name|lpf_ofdm_20mhz
index|[
name|core
index|]
operator|=
literal|4
expr_stmt|;
if|if
condition|(
name|ghz2
condition|)
block|{
name|bcap_val_11n_40
index|[
name|core
index|]
operator|=
name|bcap_val
operator|-
literal|7
expr_stmt|;
name|scap_val_11n_40
index|[
name|core
index|]
operator|=
name|scap_val
operator|-
literal|5
expr_stmt|;
block|}
else|else
block|{
name|bcap_val_11n_40
index|[
name|core
index|]
operator|=
name|bcap_val
operator|+
literal|2
expr_stmt|;
name|scap_val_11n_40
index|[
name|core
index|]
operator|=
name|scap_val
operator|+
literal|4
expr_stmt|;
block|}
name|lpf_ofdm_40mhz
index|[
name|core
index|]
operator|=
literal|4
expr_stmt|;
block|}
name|rccal_ovrd
operator|=
name|true
expr_stmt|;
break|break;
case|case
literal|14
case|:
for|for
control|(
name|core
operator|=
literal|0
init|;
name|core
operator|<
literal|2
condition|;
name|core
operator|++
control|)
block|{
name|bcap_val_11b
index|[
name|core
index|]
operator|=
name|bcap_val
expr_stmt|;
name|scap_val_11b
index|[
name|core
index|]
operator|=
name|scap_val
expr_stmt|;
name|lpf_11b
index|[
name|core
index|]
operator|=
literal|1
expr_stmt|;
block|}
name|bcap_val_11n_20
index|[
literal|0
index|]
operator|=
name|bcap_val
operator|+
literal|20
expr_stmt|;
name|scap_val_11n_20
index|[
literal|0
index|]
operator|=
name|scap_val
operator|+
literal|20
expr_stmt|;
name|lpf_ofdm_20mhz
index|[
literal|0
index|]
operator|=
literal|3
expr_stmt|;
name|bcap_val_11n_20
index|[
literal|1
index|]
operator|=
name|bcap_val
operator|+
literal|16
expr_stmt|;
name|scap_val_11n_20
index|[
literal|1
index|]
operator|=
name|scap_val
operator|+
literal|16
expr_stmt|;
name|lpf_ofdm_20mhz
index|[
literal|1
index|]
operator|=
literal|3
expr_stmt|;
name|bcap_val_11n_40
index|[
literal|0
index|]
operator|=
name|bcap_val
operator|+
literal|20
expr_stmt|;
name|scap_val_11n_40
index|[
literal|0
index|]
operator|=
name|scap_val
operator|+
literal|20
expr_stmt|;
name|lpf_ofdm_40mhz
index|[
literal|0
index|]
operator|=
literal|4
expr_stmt|;
name|bcap_val_11n_40
index|[
literal|1
index|]
operator|=
name|bcap_val
operator|+
literal|10
expr_stmt|;
name|scap_val_11n_40
index|[
literal|1
index|]
operator|=
name|scap_val
operator|+
literal|10
expr_stmt|;
name|lpf_ofdm_40mhz
index|[
literal|1
index|]
operator|=
literal|4
expr_stmt|;
name|rccal_ovrd
operator|=
name|true
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
if|if
condition|(
name|phy
operator|->
name|rf_rev
operator|==
literal|5
condition|)
block|{
for|for
control|(
name|core
operator|=
literal|0
init|;
name|core
operator|<
literal|2
condition|;
name|core
operator|++
control|)
block|{
name|lpf_ofdm_20mhz
index|[
name|core
index|]
operator|=
literal|1
expr_stmt|;
name|lpf_ofdm_40mhz
index|[
name|core
index|]
operator|=
literal|3
expr_stmt|;
name|scap_val_11b
index|[
name|core
index|]
operator|=
name|scap_val
expr_stmt|;
name|bcap_val_11b
index|[
name|core
index|]
operator|=
name|bcap_val
expr_stmt|;
name|scap_val_11n_20
index|[
name|core
index|]
operator|=
literal|0x11
expr_stmt|;
name|scap_val_11n_40
index|[
name|core
index|]
operator|=
literal|0x11
expr_stmt|;
name|bcap_val_11n_20
index|[
name|core
index|]
operator|=
literal|0x13
expr_stmt|;
name|bcap_val_11n_40
index|[
name|core
index|]
operator|=
literal|0x13
expr_stmt|;
block|}
name|rccal_ovrd
operator|=
name|true
expr_stmt|;
block|}
block|}
if|if
condition|(
name|rccal_ovrd
condition|)
block|{
name|uint16_t
name|rx2tx_lut_20_11b
index|[
literal|2
index|]
decl_stmt|,
name|rx2tx_lut_20_11n
index|[
literal|2
index|]
decl_stmt|,
name|rx2tx_lut_40_11n
index|[
literal|2
index|]
decl_stmt|;
name|uint8_t
name|rx2tx_lut_extra
init|=
literal|1
decl_stmt|;
for|for
control|(
name|core
operator|=
literal|0
init|;
name|core
operator|<
literal|2
condition|;
name|core
operator|++
control|)
block|{
name|bcap_val_11b
index|[
name|core
index|]
operator|=
name|bwn_clamp_val
argument_list|(
name|bcap_val_11b
index|[
name|core
index|]
argument_list|,
literal|0
argument_list|,
literal|0x1f
argument_list|)
expr_stmt|;
name|scap_val_11b
index|[
name|core
index|]
operator|=
name|bwn_clamp_val
argument_list|(
name|scap_val_11b
index|[
name|core
index|]
argument_list|,
literal|0
argument_list|,
literal|0x1f
argument_list|)
expr_stmt|;
name|bcap_val_11n_20
index|[
name|core
index|]
operator|=
name|bwn_clamp_val
argument_list|(
name|bcap_val_11n_20
index|[
name|core
index|]
argument_list|,
literal|0
argument_list|,
literal|0x1f
argument_list|)
expr_stmt|;
name|scap_val_11n_20
index|[
name|core
index|]
operator|=
name|bwn_clamp_val
argument_list|(
name|scap_val_11n_20
index|[
name|core
index|]
argument_list|,
literal|0
argument_list|,
literal|0x1f
argument_list|)
expr_stmt|;
name|bcap_val_11n_40
index|[
name|core
index|]
operator|=
name|bwn_clamp_val
argument_list|(
name|bcap_val_11n_40
index|[
name|core
index|]
argument_list|,
literal|0
argument_list|,
literal|0x1f
argument_list|)
expr_stmt|;
name|scap_val_11n_40
index|[
name|core
index|]
operator|=
name|bwn_clamp_val
argument_list|(
name|scap_val_11n_40
index|[
name|core
index|]
argument_list|,
literal|0
argument_list|,
literal|0x1f
argument_list|)
expr_stmt|;
name|rx2tx_lut_20_11b
index|[
name|core
index|]
operator|=
operator|(
name|rx2tx_lut_extra
operator|<<
literal|13
operator|)
operator||
operator|(
name|bcap_val_11b
index|[
name|core
index|]
operator|<<
literal|8
operator|)
operator||
operator|(
name|scap_val_11b
index|[
name|core
index|]
operator|<<
literal|3
operator|)
operator||
name|lpf_11b
index|[
name|core
index|]
expr_stmt|;
name|rx2tx_lut_20_11n
index|[
name|core
index|]
operator|=
operator|(
name|rx2tx_lut_extra
operator|<<
literal|13
operator|)
operator||
operator|(
name|bcap_val_11n_20
index|[
name|core
index|]
operator|<<
literal|8
operator|)
operator||
operator|(
name|scap_val_11n_20
index|[
name|core
index|]
operator|<<
literal|3
operator|)
operator||
name|lpf_ofdm_20mhz
index|[
name|core
index|]
expr_stmt|;
name|rx2tx_lut_40_11n
index|[
name|core
index|]
operator|=
operator|(
name|rx2tx_lut_extra
operator|<<
literal|13
operator|)
operator||
operator|(
name|bcap_val_11n_40
index|[
name|core
index|]
operator|<<
literal|8
operator|)
operator||
operator|(
name|scap_val_11n_40
index|[
name|core
index|]
operator|<<
literal|3
operator|)
operator||
name|lpf_ofdm_40mhz
index|[
name|core
index|]
expr_stmt|;
block|}
for|for
control|(
name|core
operator|=
literal|0
init|;
name|core
operator|<
literal|2
condition|;
name|core
operator|++
control|)
block|{
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|7
argument_list|,
literal|0x152
operator|+
name|core
operator|*
literal|16
argument_list|)
argument_list|,
name|rx2tx_lut_20_11b
index|[
name|core
index|]
argument_list|)
expr_stmt|;
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|7
argument_list|,
literal|0x153
operator|+
name|core
operator|*
literal|16
argument_list|)
argument_list|,
name|rx2tx_lut_20_11n
index|[
name|core
index|]
argument_list|)
expr_stmt|;
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|7
argument_list|,
literal|0x154
operator|+
name|core
operator|*
literal|16
argument_list|)
argument_list|,
name|rx2tx_lut_20_11n
index|[
name|core
index|]
argument_list|)
expr_stmt|;
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|7
argument_list|,
literal|0x155
operator|+
name|core
operator|*
literal|16
argument_list|)
argument_list|,
name|rx2tx_lut_40_11n
index|[
name|core
index|]
argument_list|)
expr_stmt|;
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|7
argument_list|,
literal|0x156
operator|+
name|core
operator|*
literal|16
argument_list|)
argument_list|,
name|rx2tx_lut_40_11n
index|[
name|core
index|]
argument_list|)
expr_stmt|;
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|7
argument_list|,
literal|0x157
operator|+
name|core
operator|*
literal|16
argument_list|)
argument_list|,
name|rx2tx_lut_40_11n
index|[
name|core
index|]
argument_list|)
expr_stmt|;
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|7
argument_list|,
literal|0x158
operator|+
name|core
operator|*
literal|16
argument_list|)
argument_list|,
name|rx2tx_lut_40_11n
index|[
name|core
index|]
argument_list|)
expr_stmt|;
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|7
argument_list|,
literal|0x159
operator|+
name|core
operator|*
literal|16
argument_list|)
argument_list|,
name|rx2tx_lut_40_11n
index|[
name|core
index|]
argument_list|)
expr_stmt|;
block|}
block|}
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x32F
argument_list|,
literal|0x3
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rf_rev
operator|==
literal|4
operator|||
name|phy
operator|->
name|rf_rev
operator|==
literal|6
condition|)
name|bwn_nphy_rf_ctl_override_rev7
argument_list|(
name|mac
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
literal|3
argument_list|,
name|false
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rf_rev
operator|==
literal|3
operator|||
name|phy
operator|->
name|rf_rev
operator|==
literal|4
operator|||
name|phy
operator|->
name|rf_rev
operator|==
literal|6
condition|)
block|{
if|if
condition|(
name|siba_sprom_get_rev
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|&&
name|siba_sprom_get_bf2_hi
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|&
name|BWN_BFH2_IPALVLSHIFT_3P3
condition|)
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x5
argument_list|,
literal|0x05
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x6
argument_list|,
literal|0x30
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x7
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|BWN_RF_SET
argument_list|(
name|mac
argument_list|,
literal|0x4f
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
name|BWN_RF_SET
argument_list|(
name|mac
argument_list|,
literal|0xd4
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
name|bias
operator|=
literal|0x1f
expr_stmt|;
name|conv
operator|=
literal|0x6f
expr_stmt|;
name|filt
operator|=
literal|0xaa
expr_stmt|;
block|}
else|else
block|{
name|bias
operator|=
literal|0x2b
expr_stmt|;
name|conv
operator|=
literal|0x7f
expr_stmt|;
name|filt
operator|=
literal|0xee
expr_stmt|;
block|}
if|if
condition|(
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_2G
condition|)
block|{
for|for
control|(
name|core
operator|=
literal|0
init|;
name|core
operator|<
literal|2
condition|;
name|core
operator|++
control|)
block|{
if|if
condition|(
name|core
operator|==
literal|0
condition|)
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x5F
argument_list|,
name|bias
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x64
argument_list|,
name|conv
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x66
argument_list|,
name|filt
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0xE8
argument_list|,
name|bias
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0xE9
argument_list|,
name|conv
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0xEB
argument_list|,
name|filt
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
if|if
condition|(
name|bwn_nphy_ipa
argument_list|(
name|mac
argument_list|)
condition|)
block|{
if|if
condition|(
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_2G
condition|)
block|{
if|if
condition|(
name|phy
operator|->
name|rf_rev
operator|==
literal|3
operator|||
name|phy
operator|->
name|rf_rev
operator|==
literal|4
operator|||
name|phy
operator|->
name|rf_rev
operator|==
literal|6
condition|)
block|{
for|for
control|(
name|core
operator|=
literal|0
init|;
name|core
operator|<
literal|2
condition|;
name|core
operator|++
control|)
block|{
if|if
condition|(
name|core
operator|==
literal|0
condition|)
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x51
argument_list|,
literal|0x7f
argument_list|)
expr_stmt|;
else|else
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0xd6
argument_list|,
literal|0x7f
argument_list|)
expr_stmt|;
block|}
block|}
switch|switch
condition|(
name|phy
operator|->
name|rf_rev
condition|)
block|{
case|case
literal|3
case|:
for|for
control|(
name|core
operator|=
literal|0
init|;
name|core
operator|<
literal|2
condition|;
name|core
operator|++
control|)
block|{
if|if
condition|(
name|core
operator|==
literal|0
condition|)
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x64
argument_list|,
literal|0x13
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x5F
argument_list|,
literal|0x1F
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x66
argument_list|,
literal|0xEE
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x59
argument_list|,
literal|0x8A
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x80
argument_list|,
literal|0x3E
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x69
argument_list|,
literal|0x13
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0xE8
argument_list|,
literal|0x1F
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0xEB
argument_list|,
literal|0xEE
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0xDE
argument_list|,
literal|0x8A
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x105
argument_list|,
literal|0x3E
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
case|case
literal|7
case|:
case|case
literal|8
case|:
if|if
condition|(
operator|!
name|bwn_is_40mhz
argument_list|(
name|mac
argument_list|)
condition|)
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x5F
argument_list|,
literal|0x14
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0xE8
argument_list|,
literal|0x12
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x5F
argument_list|,
literal|0x16
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0xE8
argument_list|,
literal|0x16
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|14
case|:
for|for
control|(
name|core
operator|=
literal|0
init|;
name|core
operator|<
literal|2
condition|;
name|core
operator|++
control|)
block|{
name|int
name|o
init|=
name|core
condition|?
literal|0x85
else|:
literal|0
decl_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|o
operator|+
name|R2057_IPA2G_CASCONV_CORE0
argument_list|,
literal|0x13
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|o
operator|+
name|R2057_TXMIX2G_TUNE_BOOST_PU_CORE0
argument_list|,
literal|0x21
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|o
operator|+
name|R2057_IPA2G_BIAS_FILTER_CORE0
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|o
operator|+
name|R2057_PAD2G_IDACS_CORE0
argument_list|,
literal|0x88
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|o
operator|+
name|R2057_PAD2G_TUNE_PUS_CORE0
argument_list|,
literal|0x23
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|o
operator|+
name|R2057_IPA2G_IMAIN_CORE0
argument_list|,
literal|0x16
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|o
operator|+
name|R2057_PAD_BIAS_FILTER_BWS_CORE0
argument_list|,
literal|0x3e
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|o
operator|+
name|R2057_BACKUP1_CORE0
argument_list|,
literal|0x10
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
block|}
else|else
block|{
name|uint16_t
name|freq
init|=
name|bwn_get_centre_freq
argument_list|(
name|mac
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|freq
operator|>=
literal|5180
operator|&&
name|freq
operator|<=
literal|5230
operator|)
operator|||
operator|(
name|freq
operator|>=
literal|5745
operator|&&
name|freq
operator|<=
literal|5805
operator|)
condition|)
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x7D
argument_list|,
literal|0xFF
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0xFE
argument_list|,
literal|0xFF
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
if|if
condition|(
name|phy
operator|->
name|rf_rev
operator|!=
literal|5
condition|)
block|{
for|for
control|(
name|core
operator|=
literal|0
init|;
name|core
operator|<
literal|2
condition|;
name|core
operator|++
control|)
block|{
if|if
condition|(
name|core
operator|==
literal|0
condition|)
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x5c
argument_list|,
literal|0x61
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x51
argument_list|,
literal|0x70
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0xe1
argument_list|,
literal|0x61
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0xd6
argument_list|,
literal|0x70
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
if|if
condition|(
name|phy
operator|->
name|rf_rev
operator|==
literal|4
condition|)
block|{
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|8
argument_list|,
literal|0x05
argument_list|)
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|8
argument_list|,
literal|0x15
argument_list|)
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
for|for
control|(
name|core
operator|=
literal|0
init|;
name|core
operator|<
literal|2
condition|;
name|core
operator|++
control|)
block|{
if|if
condition|(
name|core
operator|==
literal|0
condition|)
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x1a1
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x1a2
argument_list|,
literal|0x3f
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x1a6
argument_list|,
literal|0x3f
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x1a7
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x1ab
argument_list|,
literal|0x3f
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x1ac
argument_list|,
literal|0x3f
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_C1
argument_list|,
literal|0x4
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_OVER1
argument_list|,
literal|0x4
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_C2
argument_list|,
literal|0x4
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_OVER
argument_list|,
literal|0x4
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_C1
argument_list|,
operator|~
literal|0x1
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_OVER1
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_C2
argument_list|,
operator|~
literal|0x1
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_OVER
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|8
argument_list|,
literal|0x05
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|8
argument_list|,
literal|0x15
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_C1
argument_list|,
operator|~
literal|0x4
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_OVER1
argument_list|,
operator|~
literal|0x4
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_C2
argument_list|,
operator|~
literal|0x4
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_OVER
argument_list|,
operator|~
literal|0x4
argument_list|)
expr_stmt|;
block|}
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_ENDROP_TLEN
argument_list|,
literal|0x2
argument_list|)
expr_stmt|;
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB32
argument_list|(
literal|16
argument_list|,
literal|0x100
argument_list|)
argument_list|,
literal|20
argument_list|)
expr_stmt|;
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB8
argument_list|(
literal|7
argument_list|,
literal|0x138
argument_list|)
argument_list|,
literal|2
argument_list|,
name|ntab7_138_146
argument_list|)
expr_stmt|;
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|7
argument_list|,
literal|0x141
argument_list|)
argument_list|,
literal|0x77
argument_list|)
expr_stmt|;
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB8
argument_list|(
literal|7
argument_list|,
literal|0x133
argument_list|)
argument_list|,
literal|3
argument_list|,
name|ntab7_133
argument_list|)
expr_stmt|;
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB8
argument_list|(
literal|7
argument_list|,
literal|0x146
argument_list|)
argument_list|,
literal|2
argument_list|,
name|ntab7_138_146
argument_list|)
expr_stmt|;
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|7
argument_list|,
literal|0x123
argument_list|)
argument_list|,
literal|0x77
argument_list|)
expr_stmt|;
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|7
argument_list|,
literal|0x12A
argument_list|)
argument_list|,
literal|0x77
argument_list|)
expr_stmt|;
name|bwn_ntab_read_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB32
argument_list|(
literal|16
argument_list|,
literal|0x02
argument_list|)
argument_list|,
literal|1
argument_list|,
name|noise_tbl
argument_list|)
expr_stmt|;
name|noise_tbl
index|[
literal|1
index|]
operator|=
name|bwn_is_40mhz
argument_list|(
name|mac
argument_list|)
condition|?
literal|0x14D
else|:
literal|0x18D
expr_stmt|;
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB32
argument_list|(
literal|16
argument_list|,
literal|0x02
argument_list|)
argument_list|,
literal|2
argument_list|,
name|noise_tbl
argument_list|)
expr_stmt|;
name|bwn_ntab_read_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB32
argument_list|(
literal|16
argument_list|,
literal|0x7E
argument_list|)
argument_list|,
literal|1
argument_list|,
name|noise_tbl
argument_list|)
expr_stmt|;
name|noise_tbl
index|[
literal|1
index|]
operator|=
name|bwn_is_40mhz
argument_list|(
name|mac
argument_list|)
condition|?
literal|0x14D
else|:
literal|0x18D
expr_stmt|;
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB32
argument_list|(
literal|16
argument_list|,
literal|0x7E
argument_list|)
argument_list|,
literal|2
argument_list|,
name|noise_tbl
argument_list|)
expr_stmt|;
name|bwn_nphy_gain_ctl_workarounds
argument_list|(
name|mac
argument_list|)
expr_stmt|;
comment|/* TODO 	bwn_ntab_write_bulk(mac, BWN_NTAB16(8, 0x08), 4, 			    aux_adc_vmid_rev7_core0); 	bwn_ntab_write_bulk(mac, BWN_NTAB16(8, 0x18), 4, 			    aux_adc_vmid_rev7_core1); 	bwn_ntab_write_bulk(mac, BWN_NTAB16(8, 0x0C), 4, 			    aux_adc_gain_rev7); 	bwn_ntab_write_bulk(mac, BWN_NTAB16(8, 0x1C), 4, 			    aux_adc_gain_rev7); 	*/
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_nphy_workarounds_rev3plus
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|struct
name|bwn_phy_n
modifier|*
name|nphy
init|=
name|mac
operator|->
name|mac_phy
operator|.
name|phy_n
decl_stmt|;
comment|/* TX to RX */
name|uint8_t
name|tx2rx_events
index|[
literal|7
index|]
init|=
block|{
literal|0x4
block|,
literal|0x3
block|,
literal|0x5
block|,
literal|0x2
block|,
literal|0x1
block|,
literal|0x8
block|,
literal|0x1F
block|}
decl_stmt|;
name|uint8_t
name|tx2rx_delays
index|[
literal|7
index|]
init|=
block|{
literal|8
block|,
literal|4
block|,
literal|4
block|,
literal|4
block|,
literal|4
block|,
literal|6
block|,
literal|1
block|}
decl_stmt|;
comment|/* RX to TX */
name|uint8_t
name|rx2tx_events_ipa
index|[
literal|9
index|]
init|=
block|{
literal|0x0
block|,
literal|0x1
block|,
literal|0x2
block|,
literal|0x8
block|,
literal|0x5
block|,
literal|0x6
block|,
literal|0xF
block|,
literal|0x3
block|,
literal|0x1F
block|}
decl_stmt|;
name|uint8_t
name|rx2tx_delays_ipa
index|[
literal|9
index|]
init|=
block|{
literal|8
block|,
literal|6
block|,
literal|6
block|,
literal|4
block|,
literal|4
block|,
literal|16
block|,
literal|43
block|,
literal|1
block|,
literal|1
block|}
decl_stmt|;
name|uint8_t
name|rx2tx_events
index|[
literal|9
index|]
init|=
block|{
literal|0x0
block|,
literal|0x1
block|,
literal|0x2
block|,
literal|0x8
block|,
literal|0x5
block|,
literal|0x6
block|,
literal|0x3
block|,
literal|0x4
block|,
literal|0x1F
block|}
decl_stmt|;
name|uint8_t
name|rx2tx_delays
index|[
literal|9
index|]
init|=
block|{
literal|8
block|,
literal|6
block|,
literal|6
block|,
literal|4
block|,
literal|4
block|,
literal|18
block|,
literal|42
block|,
literal|1
block|,
literal|1
block|}
decl_stmt|;
name|uint16_t
name|vmids
index|[
literal|5
index|]
index|[
literal|4
index|]
init|=
block|{
block|{
literal|0xa2
block|,
literal|0xb4
block|,
literal|0xb4
block|,
literal|0x89
block|, }
block|,
comment|/* 0 */
block|{
literal|0xb4
block|,
literal|0xb4
block|,
literal|0xb4
block|,
literal|0x24
block|, }
block|,
comment|/* 1 */
block|{
literal|0xa2
block|,
literal|0xb4
block|,
literal|0xb4
block|,
literal|0x74
block|, }
block|,
comment|/* 2 */
block|{
literal|0xa2
block|,
literal|0xb4
block|,
literal|0xb4
block|,
literal|0x270
block|, }
block|,
comment|/* 3 */
block|{
literal|0xa2
block|,
literal|0xb4
block|,
literal|0xb4
block|,
literal|0x00
block|, }
block|,
comment|/* 4 and 5 */
block|}
decl_stmt|;
name|uint16_t
name|gains
index|[
literal|5
index|]
index|[
literal|4
index|]
init|=
block|{
block|{
literal|0x02
block|,
literal|0x02
block|,
literal|0x02
block|,
literal|0x00
block|, }
block|,
comment|/* 0 */
block|{
literal|0x02
block|,
literal|0x02
block|,
literal|0x02
block|,
literal|0x02
block|, }
block|,
comment|/* 1 */
block|{
literal|0x02
block|,
literal|0x02
block|,
literal|0x02
block|,
literal|0x04
block|, }
block|,
comment|/* 2 */
block|{
literal|0x02
block|,
literal|0x02
block|,
literal|0x02
block|,
literal|0x00
block|, }
block|,
comment|/* 3 */
block|{
literal|0x02
block|,
literal|0x02
block|,
literal|0x02
block|,
literal|0x00
block|, }
block|,
comment|/* 4 and 5 */
block|}
decl_stmt|;
name|uint16_t
modifier|*
name|vmid
decl_stmt|,
modifier|*
name|gain
decl_stmt|;
name|uint8_t
name|pdet_range
decl_stmt|;
name|uint16_t
name|tmp16
decl_stmt|;
name|uint32_t
name|tmp32
decl_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_FORCEFRONT0
argument_list|,
literal|0x1f8
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_FORCEFRONT1
argument_list|,
literal|0x1f8
argument_list|)
expr_stmt|;
name|tmp32
operator|=
name|bwn_ntab_read
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB32
argument_list|(
literal|30
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|tmp32
operator|&=
literal|0xffffff
expr_stmt|;
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB32
argument_list|(
literal|30
argument_list|,
literal|0
argument_list|)
argument_list|,
name|tmp32
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_PHASETR_A0
argument_list|,
literal|0x0125
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_PHASETR_A1
argument_list|,
literal|0x01B3
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_PHASETR_A2
argument_list|,
literal|0x0105
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_PHASETR_B0
argument_list|,
literal|0x016E
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_PHASETR_B1
argument_list|,
literal|0x00CD
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_PHASETR_B2
argument_list|,
literal|0x0020
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_REV3_C1_CLIP_LOGAIN_B
argument_list|,
literal|0x000C
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_REV3_C2_CLIP_LOGAIN_B
argument_list|,
literal|0x000C
argument_list|)
expr_stmt|;
comment|/* TX to RX */
name|bwn_nphy_set_rf_sequence
argument_list|(
name|mac
argument_list|,
literal|1
argument_list|,
name|tx2rx_events
argument_list|,
name|tx2rx_delays
argument_list|,
name|nitems
argument_list|(
name|tx2rx_events
argument_list|)
argument_list|)
expr_stmt|;
comment|/* RX to TX */
if|if
condition|(
name|bwn_nphy_ipa
argument_list|(
name|mac
argument_list|)
condition|)
name|bwn_nphy_set_rf_sequence
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|,
name|rx2tx_events_ipa
argument_list|,
name|rx2tx_delays_ipa
argument_list|,
name|nitems
argument_list|(
name|rx2tx_events_ipa
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|nphy
operator|->
name|hw_phyrxchain
operator|!=
literal|3
operator|&&
name|nphy
operator|->
name|hw_phyrxchain
operator|!=
name|nphy
operator|->
name|hw_phytxchain
condition|)
block|{
if|if
condition|(
name|bwn_nphy_ipa
argument_list|(
name|mac
argument_list|)
condition|)
block|{
name|rx2tx_delays
index|[
literal|5
index|]
operator|=
literal|59
expr_stmt|;
name|rx2tx_delays
index|[
literal|6
index|]
operator|=
literal|1
expr_stmt|;
name|rx2tx_events
index|[
literal|7
index|]
operator|=
literal|0x1F
expr_stmt|;
block|}
name|bwn_nphy_set_rf_sequence
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|,
name|rx2tx_events
argument_list|,
name|rx2tx_delays
argument_list|,
name|nitems
argument_list|(
name|rx2tx_events
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|tmp16
operator|=
operator|(
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_2G
operator|)
condition|?
literal|0x2
else|:
literal|0x9C40
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_ENDROP_TLEN
argument_list|,
name|tmp16
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_SGILTRNOFFSET
argument_list|,
literal|0xF0FF
argument_list|,
literal|0x0700
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bwn_is_40mhz
argument_list|(
name|mac
argument_list|)
condition|)
block|{
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB32
argument_list|(
literal|16
argument_list|,
literal|3
argument_list|)
argument_list|,
literal|0x18D
argument_list|)
expr_stmt|;
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB32
argument_list|(
literal|16
argument_list|,
literal|127
argument_list|)
argument_list|,
literal|0x18D
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB32
argument_list|(
literal|16
argument_list|,
literal|3
argument_list|)
argument_list|,
literal|0x14D
argument_list|)
expr_stmt|;
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB32
argument_list|(
literal|16
argument_list|,
literal|127
argument_list|)
argument_list|,
literal|0x14D
argument_list|)
expr_stmt|;
block|}
name|bwn_nphy_gain_ctl_workarounds
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|8
argument_list|,
literal|0
argument_list|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|8
argument_list|,
literal|16
argument_list|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_2G
condition|)
name|pdet_range
operator|=
name|siba_sprom_get_fem_2ghz_pdet_range
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
expr_stmt|;
else|else
name|pdet_range
operator|=
name|siba_sprom_get_fem_5ghz_pdet_range
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
expr_stmt|;
comment|/* uint16_t min() */
name|vmid
operator|=
name|vmids
index|[
name|min
argument_list|(
name|pdet_range
argument_list|,
literal|4
argument_list|)
index|]
expr_stmt|;
name|gain
operator|=
name|gains
index|[
name|min
argument_list|(
name|pdet_range
argument_list|,
literal|4
argument_list|)
index|]
expr_stmt|;
switch|switch
condition|(
name|pdet_range
condition|)
block|{
case|case
literal|3
case|:
if|if
condition|(
operator|!
operator|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|4
operator|&&
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_2G
operator|)
condition|)
break|break;
comment|/* FALL THROUGH */
case|case
literal|0
case|:
case|case
literal|1
case|:
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|8
argument_list|,
literal|0x08
argument_list|)
argument_list|,
literal|4
argument_list|,
name|vmid
argument_list|)
expr_stmt|;
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|8
argument_list|,
literal|0x18
argument_list|)
argument_list|,
literal|4
argument_list|,
name|vmid
argument_list|)
expr_stmt|;
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|8
argument_list|,
literal|0x0c
argument_list|)
argument_list|,
literal|4
argument_list|,
name|gain
argument_list|)
expr_stmt|;
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|8
argument_list|,
literal|0x1c
argument_list|)
argument_list|,
literal|4
argument_list|,
name|gain
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|6
condition|)
block|{
if|if
condition|(
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_2G
condition|)
name|vmid
index|[
literal|3
index|]
operator|=
literal|0x94
expr_stmt|;
else|else
name|vmid
index|[
literal|3
index|]
operator|=
literal|0x8e
expr_stmt|;
name|gain
index|[
literal|3
index|]
operator|=
literal|3
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|==
literal|5
condition|)
block|{
name|vmid
index|[
literal|3
index|]
operator|=
literal|0x84
expr_stmt|;
name|gain
index|[
literal|3
index|]
operator|=
literal|2
expr_stmt|;
block|}
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|8
argument_list|,
literal|0x08
argument_list|)
argument_list|,
literal|4
argument_list|,
name|vmid
argument_list|)
expr_stmt|;
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|8
argument_list|,
literal|0x18
argument_list|)
argument_list|,
literal|4
argument_list|,
name|vmid
argument_list|)
expr_stmt|;
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|8
argument_list|,
literal|0x0c
argument_list|)
argument_list|,
literal|4
argument_list|,
name|gain
argument_list|)
expr_stmt|;
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|8
argument_list|,
literal|0x1c
argument_list|)
argument_list|,
literal|4
argument_list|,
name|gain
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
case|case
literal|5
case|:
if|if
condition|(
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|!=
name|BWN_BAND_2G
condition|)
block|{
if|if
condition|(
name|pdet_range
operator|==
literal|4
condition|)
block|{
name|vmid
index|[
literal|3
index|]
operator|=
literal|0x8e
expr_stmt|;
name|tmp16
operator|=
literal|0x96
expr_stmt|;
name|gain
index|[
literal|3
index|]
operator|=
literal|0x2
expr_stmt|;
block|}
else|else
block|{
name|vmid
index|[
literal|3
index|]
operator|=
literal|0x89
expr_stmt|;
name|tmp16
operator|=
literal|0x89
expr_stmt|;
name|gain
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|pdet_range
operator|==
literal|4
condition|)
block|{
name|vmid
index|[
literal|3
index|]
operator|=
literal|0x89
expr_stmt|;
name|tmp16
operator|=
literal|0x8b
expr_stmt|;
name|gain
index|[
literal|3
index|]
operator|=
literal|0x2
expr_stmt|;
block|}
else|else
block|{
name|vmid
index|[
literal|3
index|]
operator|=
literal|0x74
expr_stmt|;
name|tmp16
operator|=
literal|0x70
expr_stmt|;
name|gain
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
block|}
block|}
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|8
argument_list|,
literal|0x08
argument_list|)
argument_list|,
literal|4
argument_list|,
name|vmid
argument_list|)
expr_stmt|;
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|8
argument_list|,
literal|0x0c
argument_list|)
argument_list|,
literal|4
argument_list|,
name|gain
argument_list|)
expr_stmt|;
name|vmid
index|[
literal|3
index|]
operator|=
name|tmp16
expr_stmt|;
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|8
argument_list|,
literal|0x18
argument_list|)
argument_list|,
literal|4
argument_list|,
name|vmid
argument_list|)
expr_stmt|;
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|8
argument_list|,
literal|0x1c
argument_list|)
argument_list|,
literal|4
argument_list|,
name|gain
argument_list|)
expr_stmt|;
break|break;
block|}
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_RX0
operator||
name|B2056_RX_MIXA_MAST_BIAS
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_RX1
operator||
name|B2056_RX_MIXA_MAST_BIAS
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_RX0
operator||
name|B2056_RX_MIXA_BIAS_MAIN
argument_list|,
literal|0x06
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_RX1
operator||
name|B2056_RX_MIXA_BIAS_MAIN
argument_list|,
literal|0x06
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_RX0
operator||
name|B2056_RX_MIXA_BIAS_AUX
argument_list|,
literal|0x07
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_RX1
operator||
name|B2056_RX_MIXA_BIAS_AUX
argument_list|,
literal|0x07
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_RX0
operator||
name|B2056_RX_MIXA_LOB_BIAS
argument_list|,
literal|0x88
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_RX1
operator||
name|B2056_RX_MIXA_LOB_BIAS
argument_list|,
literal|0x88
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_RX0
operator||
name|B2056_RX_MIXA_CMFB_IDAC
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_RX1
operator||
name|B2056_RX_MIXA_CMFB_IDAC
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_RX0
operator||
name|B2056_RX_MIXG_CMFB_IDAC
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_RX1
operator||
name|B2056_RX_MIXG_CMFB_IDAC
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
comment|/* N PHY WAR TX Chain Update with hw_phytxchain as argument */
if|if
condition|(
operator|(
name|siba_sprom_get_bf2_lo
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|&
name|BWN_BFL2_APLL_WAR
operator|&&
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_5G
operator|)
operator|||
operator|(
name|siba_sprom_get_bf2_lo
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|&
name|BWN_BFL2_GPLL_WAR
operator|&&
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_2G
operator|)
condition|)
name|tmp32
operator|=
literal|0x00088888
expr_stmt|;
else|else
name|tmp32
operator|=
literal|0x88888888
expr_stmt|;
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB32
argument_list|(
literal|30
argument_list|,
literal|1
argument_list|)
argument_list|,
name|tmp32
argument_list|)
expr_stmt|;
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB32
argument_list|(
literal|30
argument_list|,
literal|2
argument_list|)
argument_list|,
name|tmp32
argument_list|)
expr_stmt|;
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB32
argument_list|(
literal|30
argument_list|,
literal|3
argument_list|)
argument_list|,
name|tmp32
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|==
literal|4
operator|&&
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_5G
condition|)
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_TX0
operator||
name|B2056_TX_GMBB_IDAC
argument_list|,
literal|0x70
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_TX1
operator||
name|B2056_TX_GMBB_IDAC
argument_list|,
literal|0x70
argument_list|)
expr_stmt|;
block|}
comment|/* Dropped probably-always-true condition */
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_ED_CRS40ASSERTTHRESH0
argument_list|,
literal|0x03eb
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_ED_CRS40ASSERTTHRESH1
argument_list|,
literal|0x03eb
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_ED_CRS40DEASSERTTHRESH0
argument_list|,
literal|0x0341
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_ED_CRS40DEASSERTTHRESH1
argument_list|,
literal|0x0341
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_ED_CRS20LASSERTTHRESH0
argument_list|,
literal|0x042b
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_ED_CRS20LASSERTTHRESH1
argument_list|,
literal|0x042b
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_ED_CRS20LDEASSERTTHRESH0
argument_list|,
literal|0x0381
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_ED_CRS20LDEASSERTTHRESH1
argument_list|,
literal|0x0381
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_ED_CRS20UASSERTTHRESH0
argument_list|,
literal|0x042b
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_ED_CRS20UASSERTTHRESH1
argument_list|,
literal|0x042b
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_ED_CRS20UDEASSERTTHRESH0
argument_list|,
literal|0x0381
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_ED_CRS20UDEASSERTTHRESH1
argument_list|,
literal|0x0381
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|6
operator|&&
name|siba_sprom_get_bf2_lo
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|&
name|BWN_BFL2_SINGLEANT_CCK
condition|)
empty_stmt|;
comment|/* TODO: 0x0080000000000000 HF */
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_nphy_workarounds_rev1_2
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwn_phy_n
modifier|*
name|nphy
init|=
name|phy
operator|->
name|phy_n
decl_stmt|;
name|uint8_t
name|events1
index|[
literal|7
index|]
init|=
block|{
literal|0x0
block|,
literal|0x1
block|,
literal|0x2
block|,
literal|0x8
block|,
literal|0x4
block|,
literal|0x5
block|,
literal|0x3
block|}
decl_stmt|;
name|uint8_t
name|delays1
index|[
literal|7
index|]
init|=
block|{
literal|0x8
block|,
literal|0x6
block|,
literal|0x6
block|,
literal|0x2
block|,
literal|0x4
block|,
literal|0x3C
block|,
literal|0x1
block|}
decl_stmt|;
name|uint8_t
name|events2
index|[
literal|7
index|]
init|=
block|{
literal|0x0
block|,
literal|0x3
block|,
literal|0x5
block|,
literal|0x4
block|,
literal|0x2
block|,
literal|0x1
block|,
literal|0x8
block|}
decl_stmt|;
name|uint8_t
name|delays2
index|[
literal|7
index|]
init|=
block|{
literal|0x8
block|,
literal|0x6
block|,
literal|0x2
block|,
literal|0x4
block|,
literal|0x4
block|,
literal|0x6
block|,
literal|0x1
block|}
decl_stmt|;
if|if
condition|(
name|siba_sprom_get_bf2_lo
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|&
name|BWN_BFL2_SKWRKFEM_BRD
operator|||
name|siba_get_pci_subdevice
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
name|BCMA_BOARD_TYPE_BCM943224M93
condition|)
block|{
name|delays1
index|[
literal|0
index|]
operator|=
literal|0x1
expr_stmt|;
name|delays1
index|[
literal|5
index|]
operator|=
literal|0x14
expr_stmt|;
block|}
if|if
condition|(
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_5G
operator|&&
name|nphy
operator|->
name|band5g_pwrgain
condition|)
block|{
name|BWN_RF_MASK
argument_list|(
name|mac
argument_list|,
name|B2055_C1_TX_RF_SPARE
argument_list|,
operator|~
literal|0x8
argument_list|)
expr_stmt|;
name|BWN_RF_MASK
argument_list|(
name|mac
argument_list|,
name|B2055_C2_TX_RF_SPARE
argument_list|,
operator|~
literal|0x8
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BWN_RF_SET
argument_list|(
name|mac
argument_list|,
name|B2055_C1_TX_RF_SPARE
argument_list|,
literal|0x8
argument_list|)
expr_stmt|;
name|BWN_RF_SET
argument_list|(
name|mac
argument_list|,
name|B2055_C2_TX_RF_SPARE
argument_list|,
literal|0x8
argument_list|)
expr_stmt|;
block|}
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|8
argument_list|,
literal|0x00
argument_list|)
argument_list|,
literal|0x000A
argument_list|)
expr_stmt|;
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|8
argument_list|,
literal|0x10
argument_list|)
argument_list|,
literal|0x000A
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|<
literal|3
condition|)
block|{
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|8
argument_list|,
literal|0x02
argument_list|)
argument_list|,
literal|0xCDAA
argument_list|)
expr_stmt|;
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|8
argument_list|,
literal|0x12
argument_list|)
argument_list|,
literal|0xCDAA
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|<
literal|2
condition|)
block|{
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|8
argument_list|,
literal|0x08
argument_list|)
argument_list|,
literal|0x0000
argument_list|)
expr_stmt|;
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|8
argument_list|,
literal|0x18
argument_list|)
argument_list|,
literal|0x0000
argument_list|)
expr_stmt|;
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|8
argument_list|,
literal|0x07
argument_list|)
argument_list|,
literal|0x7AAB
argument_list|)
expr_stmt|;
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|8
argument_list|,
literal|0x17
argument_list|)
argument_list|,
literal|0x7AAB
argument_list|)
expr_stmt|;
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|8
argument_list|,
literal|0x06
argument_list|)
argument_list|,
literal|0x0800
argument_list|)
expr_stmt|;
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|8
argument_list|,
literal|0x16
argument_list|)
argument_list|,
literal|0x0800
argument_list|)
expr_stmt|;
block|}
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_LUT_TRSW_LO1
argument_list|,
literal|0x2D8
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_LUT_TRSW_UP1
argument_list|,
literal|0x301
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_LUT_TRSW_LO2
argument_list|,
literal|0x2D8
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_LUT_TRSW_UP2
argument_list|,
literal|0x301
argument_list|)
expr_stmt|;
name|bwn_nphy_set_rf_sequence
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|,
name|events1
argument_list|,
name|delays1
argument_list|,
literal|7
argument_list|)
expr_stmt|;
name|bwn_nphy_set_rf_sequence
argument_list|(
name|mac
argument_list|,
literal|1
argument_list|,
name|events2
argument_list|,
name|delays2
argument_list|,
literal|7
argument_list|)
expr_stmt|;
name|bwn_nphy_gain_ctl_workarounds
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|<
literal|2
condition|)
block|{
if|if
condition|(
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RXCTL
argument_list|)
operator|&
literal|0x2
condition|)
name|bwn_hf_write
argument_list|(
name|mac
argument_list|,
name|bwn_hf_read
argument_list|(
name|mac
argument_list|)
operator||
name|BWN_HF_MLADVW
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|==
literal|2
condition|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_CRSCHECK2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_CRSCHECK3
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|<
literal|2
condition|)
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_SCRAM_SIGCTL
argument_list|,
operator|~
name|BWN_NPHY_SCRAM_SIGCTL_SCM
argument_list|)
expr_stmt|;
comment|/* Set phase track alpha and beta */
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_PHASETR_A0
argument_list|,
literal|0x125
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_PHASETR_A1
argument_list|,
literal|0x1B3
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_PHASETR_A2
argument_list|,
literal|0x105
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_PHASETR_B0
argument_list|,
literal|0x16E
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_PHASETR_B1
argument_list|,
literal|0xCD
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_PHASETR_B2
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|<
literal|3
condition|)
block|{
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_PIL_DW1
argument_list|,
operator|~
name|BWN_NPHY_PIL_DW_64QAM
operator|&
literal|0xFFFF
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TXF_20CO_S2B1
argument_list|,
literal|0xB5
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TXF_20CO_S2B2
argument_list|,
literal|0xA4
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TXF_20CO_S2B3
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|==
literal|2
condition|)
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_FINERX2_CGC
argument_list|,
name|BWN_NPHY_FINERX2_CGC_DECGC
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/Workarounds */
end_comment

begin_function
specifier|static
name|void
name|bwn_nphy_workarounds
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwn_phy_n
modifier|*
name|nphy
init|=
name|phy
operator|->
name|phy_n
decl_stmt|;
if|if
condition|(
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_5G
condition|)
name|bwn_nphy_classifier
argument_list|(
name|mac
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
name|bwn_nphy_classifier
argument_list|(
name|mac
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|nphy
operator|->
name|hang_avoid
condition|)
name|bwn_nphy_stay_in_carrier_search
argument_list|(
name|mac
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_IQFLIP
argument_list|,
name|BWN_NPHY_IQFLIP_ADC1
operator||
name|BWN_NPHY_IQFLIP_ADC2
argument_list|)
expr_stmt|;
comment|/* TODO: rev19+ */
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|7
condition|)
name|bwn_nphy_workarounds_rev7plus
argument_list|(
name|mac
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|3
condition|)
name|bwn_nphy_workarounds_rev3plus
argument_list|(
name|mac
argument_list|)
expr_stmt|;
else|else
name|bwn_nphy_workarounds_rev1_2
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|nphy
operator|->
name|hang_avoid
condition|)
name|bwn_nphy_stay_in_carrier_search
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**************************************************  * Tx/Rx common  **************************************************/
end_comment

begin_comment
comment|/*  * Transmits a known value for LO calibration  * http://bcm-v4.sipsolutions.net/802.11/PHY/N/TXTone  */
end_comment

begin_function
specifier|static
name|int
name|bwn_nphy_tx_tone
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint32_t
name|freq
parameter_list|,
name|uint16_t
name|max_val
parameter_list|,
name|bool
name|iqmode
parameter_list|,
name|bool
name|dac_test
parameter_list|,
name|bool
name|modify_bbmult
parameter_list|)
block|{
name|uint16_t
name|samp
init|=
name|bwn_nphy_gen_load_samples
argument_list|(
name|mac
argument_list|,
name|freq
argument_list|,
name|max_val
argument_list|,
name|dac_test
argument_list|)
decl_stmt|;
if|if
condition|(
name|samp
operator|==
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|bwn_nphy_run_samples
argument_list|(
name|mac
argument_list|,
name|samp
argument_list|,
literal|0xFFFF
argument_list|,
literal|0
argument_list|,
name|iqmode
argument_list|,
name|dac_test
argument_list|,
name|modify_bbmult
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/Chains */
end_comment

begin_function
specifier|static
name|void
name|bwn_nphy_update_txrx_chain
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_phy_n
modifier|*
name|nphy
init|=
name|mac
operator|->
name|mac_phy
operator|.
name|phy_n
decl_stmt|;
name|bool
name|override
init|=
name|false
decl_stmt|;
name|uint16_t
name|chain
init|=
literal|0x33
decl_stmt|;
if|if
condition|(
name|nphy
operator|->
name|txrx_chain
operator|==
literal|0
condition|)
block|{
name|chain
operator|=
literal|0x11
expr_stmt|;
name|override
operator|=
name|true
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|nphy
operator|->
name|txrx_chain
operator|==
literal|1
condition|)
block|{
name|chain
operator|=
literal|0x22
expr_stmt|;
name|override
operator|=
name|true
expr_stmt|;
block|}
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFSEQCA
argument_list|,
operator|~
operator|(
name|BWN_NPHY_RFSEQCA_TXEN
operator||
name|BWN_NPHY_RFSEQCA_RXEN
operator|)
argument_list|,
name|chain
argument_list|)
expr_stmt|;
if|if
condition|(
name|override
condition|)
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFSEQMODE
argument_list|,
name|BWN_NPHY_RFSEQMODE_CAOVER
argument_list|)
expr_stmt|;
else|else
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFSEQMODE
argument_list|,
operator|~
name|BWN_NPHY_RFSEQMODE_CAOVER
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/stop-playback */
end_comment

begin_function
specifier|static
name|void
name|bwn_nphy_stop_playback
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwn_phy_n
modifier|*
name|nphy
init|=
name|mac
operator|->
name|mac_phy
operator|.
name|phy_n
decl_stmt|;
name|uint16_t
name|tmp
decl_stmt|;
if|if
condition|(
name|nphy
operator|->
name|hang_avoid
condition|)
name|bwn_nphy_stay_in_carrier_search
argument_list|(
name|mac
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_SAMP_STAT
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|&
literal|0x1
condition|)
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_SAMP_CMD
argument_list|,
name|BWN_NPHY_SAMP_CMD_STOP
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|tmp
operator|&
literal|0x2
condition|)
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_IQLOCAL_CMDGCTL
argument_list|,
literal|0x7FFF
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_SAMP_CMD
argument_list|,
operator|~
literal|0x0004
argument_list|)
expr_stmt|;
if|if
condition|(
name|nphy
operator|->
name|bb_mult_save
operator|&
literal|0x80000000
condition|)
block|{
name|tmp
operator|=
name|nphy
operator|->
name|bb_mult_save
operator|&
literal|0xFFFF
expr_stmt|;
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|15
argument_list|,
literal|87
argument_list|)
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|nphy
operator|->
name|bb_mult_save
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|7
operator|&&
name|nphy
operator|->
name|lpf_bw_overrode_for_sample_play
condition|)
block|{
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|19
condition|)
name|bwn_nphy_rf_ctl_override_rev19
argument_list|(
name|mac
argument_list|,
literal|0x80
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|true
argument_list|,
literal|1
argument_list|)
expr_stmt|;
else|else
name|bwn_nphy_rf_ctl_override_rev7
argument_list|(
name|mac
argument_list|,
literal|0x80
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|true
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|nphy
operator|->
name|lpf_bw_overrode_for_sample_play
operator|=
name|false
expr_stmt|;
block|}
if|if
condition|(
name|nphy
operator|->
name|hang_avoid
condition|)
name|bwn_nphy_stay_in_carrier_search
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/IqCalGainParams */
end_comment

begin_function
specifier|static
name|void
name|bwn_nphy_iq_cal_gain_params
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint16_t
name|core
parameter_list|,
name|struct
name|bwn_nphy_txgains
name|target
parameter_list|,
name|struct
name|bwn_nphy_iqcal_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|indx
decl_stmt|;
name|uint16_t
name|gain
decl_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|3
condition|)
block|{
name|params
operator|->
name|tx_lpf
operator|=
name|target
operator|.
name|tx_lpf
index|[
name|core
index|]
expr_stmt|;
comment|/* Rev 7+ */
name|params
operator|->
name|txgm
operator|=
name|target
operator|.
name|txgm
index|[
name|core
index|]
expr_stmt|;
name|params
operator|->
name|pga
operator|=
name|target
operator|.
name|pga
index|[
name|core
index|]
expr_stmt|;
name|params
operator|->
name|pad
operator|=
name|target
operator|.
name|pad
index|[
name|core
index|]
expr_stmt|;
name|params
operator|->
name|ipa
operator|=
name|target
operator|.
name|ipa
index|[
name|core
index|]
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|19
condition|)
block|{
comment|/* TODO */
block|}
elseif|else
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|7
condition|)
block|{
name|params
operator|->
name|cal_gain
operator|=
operator|(
name|params
operator|->
name|txgm
operator|<<
literal|12
operator|)
operator||
operator|(
name|params
operator|->
name|pga
operator|<<
literal|8
operator|)
operator||
operator|(
name|params
operator|->
name|pad
operator|<<
literal|3
operator|)
operator||
operator|(
name|params
operator|->
name|ipa
operator|)
operator||
operator|(
name|params
operator|->
name|tx_lpf
operator|<<
literal|15
operator|)
expr_stmt|;
block|}
else|else
block|{
name|params
operator|->
name|cal_gain
operator|=
operator|(
name|params
operator|->
name|txgm
operator|<<
literal|12
operator|)
operator||
operator|(
name|params
operator|->
name|pga
operator|<<
literal|8
operator|)
operator||
operator|(
name|params
operator|->
name|pad
operator|<<
literal|4
operator|)
operator||
operator|(
name|params
operator|->
name|ipa
operator|)
expr_stmt|;
block|}
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|5
condition|;
name|j
operator|++
control|)
name|params
operator|->
name|ncorr
index|[
name|j
index|]
operator|=
literal|0x79
expr_stmt|;
block|}
else|else
block|{
name|gain
operator|=
operator|(
name|target
operator|.
name|pad
index|[
name|core
index|]
operator|)
operator||
operator|(
name|target
operator|.
name|pga
index|[
name|core
index|]
operator|<<
literal|4
operator|)
operator||
operator|(
name|target
operator|.
name|txgm
index|[
name|core
index|]
operator|<<
literal|8
operator|)
expr_stmt|;
name|indx
operator|=
operator|(
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_5G
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|9
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|tbl_iqcal_gainparams
index|[
name|indx
index|]
index|[
name|i
index|]
index|[
literal|0
index|]
operator|==
name|gain
condition|)
break|break;
name|i
operator|=
name|min
argument_list|(
name|i
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|params
operator|->
name|txgm
operator|=
name|tbl_iqcal_gainparams
index|[
name|indx
index|]
index|[
name|i
index|]
index|[
literal|1
index|]
expr_stmt|;
name|params
operator|->
name|pga
operator|=
name|tbl_iqcal_gainparams
index|[
name|indx
index|]
index|[
name|i
index|]
index|[
literal|2
index|]
expr_stmt|;
name|params
operator|->
name|pad
operator|=
name|tbl_iqcal_gainparams
index|[
name|indx
index|]
index|[
name|i
index|]
index|[
literal|3
index|]
expr_stmt|;
name|params
operator|->
name|cal_gain
operator|=
operator|(
name|params
operator|->
name|txgm
operator|<<
literal|7
operator|)
operator||
operator|(
name|params
operator|->
name|pga
operator|<<
literal|4
operator|)
operator||
operator|(
name|params
operator|->
name|pad
operator|<<
literal|2
operator|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|4
condition|;
name|j
operator|++
control|)
name|params
operator|->
name|ncorr
index|[
name|j
index|]
operator|=
name|tbl_iqcal_gainparams
index|[
name|indx
index|]
index|[
name|i
index|]
index|[
literal|4
operator|+
name|j
index|]
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**************************************************  * Tx and Rx  **************************************************/
end_comment

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/TxPwrCtrlEnable */
end_comment

begin_function
specifier|static
name|void
name|bwn_nphy_tx_power_ctrl
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|bool
name|enable
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwn_phy_n
modifier|*
name|nphy
init|=
name|mac
operator|->
name|mac_phy
operator|.
name|phy_n
decl_stmt|;
name|uint8_t
name|i
decl_stmt|;
name|uint16_t
name|bmask
decl_stmt|,
name|val
decl_stmt|,
name|tmp
decl_stmt|;
name|bwn_band_t
name|band
init|=
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
decl_stmt|;
if|if
condition|(
name|nphy
operator|->
name|hang_avoid
condition|)
name|bwn_nphy_stay_in_carrier_search
argument_list|(
name|mac
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|nphy
operator|->
name|txpwrctrl
operator|=
name|enable
expr_stmt|;
if|if
condition|(
operator|!
name|enable
condition|)
block|{
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|3
operator|&&
operator|(
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TXPCTL_CMD
argument_list|)
operator|&
operator|(
name|BWN_NPHY_TXPCTL_CMD_COEFF
operator||
name|BWN_NPHY_TXPCTL_CMD_HWPCTLEN
operator||
name|BWN_NPHY_TXPCTL_CMD_PCTLEN
operator|)
operator|)
condition|)
block|{
comment|/* We disable enabled TX pwr ctl, save it's state */
name|nphy
operator|->
name|tx_pwr_idx
index|[
literal|0
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_C1_TXPCTL_STAT
argument_list|)
operator|&
literal|0x7f
expr_stmt|;
name|nphy
operator|->
name|tx_pwr_idx
index|[
literal|1
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_C2_TXPCTL_STAT
argument_list|)
operator|&
literal|0x7f
expr_stmt|;
block|}
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TABLE_ADDR
argument_list|,
literal|0x6840
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|84
condition|;
name|i
operator|++
control|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TABLE_DATALO
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TABLE_ADDR
argument_list|,
literal|0x6C40
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|84
condition|;
name|i
operator|++
control|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TABLE_DATALO
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|BWN_NPHY_TXPCTL_CMD_COEFF
operator||
name|BWN_NPHY_TXPCTL_CMD_HWPCTLEN
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|3
condition|)
name|tmp
operator||=
name|BWN_NPHY_TXPCTL_CMD_PCTLEN
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TXPCTL_CMD
argument_list|,
operator|~
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|3
condition|)
block|{
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_OVER1
argument_list|,
literal|0x0100
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_OVER
argument_list|,
literal|0x0100
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_OVER
argument_list|,
literal|0x4000
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|==
literal|2
condition|)
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_BPHY_CTL3
argument_list|,
operator|~
name|BWN_NPHY_BPHY_CTL3_SCALE
argument_list|,
literal|0x53
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|<
literal|2
condition|)
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_BPHY_CTL3
argument_list|,
operator|~
name|BWN_NPHY_BPHY_CTL3_SCALE
argument_list|,
literal|0x5A
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|<
literal|2
operator|&&
name|bwn_is_40mhz
argument_list|(
name|mac
argument_list|)
condition|)
name|bwn_hf_write
argument_list|(
name|mac
argument_list|,
name|bwn_hf_read
argument_list|(
name|mac
argument_list|)
operator||
name|BWN_HF_TSSI_RESET_PSM_WORKAROUN
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|26
argument_list|,
literal|64
argument_list|)
argument_list|,
literal|84
argument_list|,
name|nphy
operator|->
name|adj_pwr_tbl
argument_list|)
expr_stmt|;
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|27
argument_list|,
literal|64
argument_list|)
argument_list|,
literal|84
argument_list|,
name|nphy
operator|->
name|adj_pwr_tbl
argument_list|)
expr_stmt|;
name|bmask
operator|=
name|BWN_NPHY_TXPCTL_CMD_COEFF
operator||
name|BWN_NPHY_TXPCTL_CMD_HWPCTLEN
expr_stmt|;
comment|/* wl does useless check for "enable" param here */
name|val
operator|=
name|BWN_NPHY_TXPCTL_CMD_COEFF
operator||
name|BWN_NPHY_TXPCTL_CMD_HWPCTLEN
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|3
condition|)
block|{
name|bmask
operator||=
name|BWN_NPHY_TXPCTL_CMD_PCTLEN
expr_stmt|;
if|if
condition|(
name|val
condition|)
name|val
operator||=
name|BWN_NPHY_TXPCTL_CMD_PCTLEN
expr_stmt|;
block|}
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TXPCTL_CMD
argument_list|,
operator|~
operator|(
name|bmask
operator|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|band
operator|==
name|BWN_BAND_5G
condition|)
block|{
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|19
condition|)
block|{
comment|/* TODO */
block|}
elseif|else
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|7
condition|)
block|{
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TXPCTL_CMD
argument_list|,
operator|~
name|BWN_NPHY_TXPCTL_CMD_INIT
argument_list|,
literal|0x32
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TXPCTL_INIT
argument_list|,
operator|~
name|BWN_NPHY_TXPCTL_INIT_PIDXI1
argument_list|,
literal|0x32
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TXPCTL_CMD
argument_list|,
operator|~
name|BWN_NPHY_TXPCTL_CMD_INIT
argument_list|,
literal|0x64
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|>
literal|1
condition|)
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TXPCTL_INIT
argument_list|,
operator|~
name|BWN_NPHY_TXPCTL_INIT_PIDXI1
argument_list|,
literal|0x64
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|3
condition|)
block|{
if|if
condition|(
name|nphy
operator|->
name|tx_pwr_idx
index|[
literal|0
index|]
operator|!=
literal|128
operator|&&
name|nphy
operator|->
name|tx_pwr_idx
index|[
literal|1
index|]
operator|!=
literal|128
condition|)
block|{
comment|/* Recover TX pwr ctl state */
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TXPCTL_CMD
argument_list|,
operator|~
name|BWN_NPHY_TXPCTL_CMD_INIT
argument_list|,
name|nphy
operator|->
name|tx_pwr_idx
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>
literal|1
condition|)
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TXPCTL_INIT
argument_list|,
operator|~
literal|0xff
argument_list|,
name|nphy
operator|->
name|tx_pwr_idx
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|7
condition|)
block|{
comment|/* TODO */
block|}
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|3
condition|)
block|{
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_OVER1
argument_list|,
operator|~
literal|0x100
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_OVER
argument_list|,
operator|~
literal|0x100
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_OVER
argument_list|,
operator|~
literal|0x4000
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|==
literal|2
condition|)
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_BPHY_CTL3
argument_list|,
operator|~
literal|0xFF
argument_list|,
literal|0x3b
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|<
literal|2
condition|)
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_BPHY_CTL3
argument_list|,
operator|~
literal|0xFF
argument_list|,
literal|0x40
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|<
literal|2
operator|&&
name|bwn_is_40mhz
argument_list|(
name|mac
argument_list|)
condition|)
name|bwn_hf_write
argument_list|(
name|mac
argument_list|,
name|bwn_hf_read
argument_list|(
name|mac
argument_list|)
operator|&
operator|~
name|BWN_HF_TSSI_RESET_PSM_WORKAROUN
argument_list|)
expr_stmt|;
if|if
condition|(
name|bwn_nphy_ipa
argument_list|(
name|mac
argument_list|)
condition|)
block|{
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_PAPD_EN0
argument_list|,
operator|~
literal|0x4
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_PAPD_EN1
argument_list|,
operator|~
literal|0x4
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|nphy
operator|->
name|hang_avoid
condition|)
name|bwn_nphy_stay_in_carrier_search
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/TxPwrFix */
end_comment

begin_function
specifier|static
name|void
name|bwn_nphy_tx_power_fix
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|struct
name|bwn_phy_n
modifier|*
name|nphy
init|=
name|mac
operator|->
name|mac_phy
operator|.
name|phy_n
decl_stmt|;
name|uint8_t
name|txpi
index|[
literal|2
index|]
decl_stmt|,
name|bbmult
decl_stmt|,
name|i
decl_stmt|;
name|uint16_t
name|tmp
decl_stmt|,
name|radio_gain
decl_stmt|,
name|dac_gain
decl_stmt|;
name|uint16_t
name|freq
init|=
name|bwn_get_centre_freq
argument_list|(
name|mac
argument_list|)
decl_stmt|;
name|uint32_t
name|txgain
decl_stmt|;
comment|/* uint32_t gaintbl; rev3+ */
if|if
condition|(
name|nphy
operator|->
name|hang_avoid
condition|)
name|bwn_nphy_stay_in_carrier_search
argument_list|(
name|mac
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* TODO: rev19+ */
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|7
condition|)
block|{
name|txpi
index|[
literal|0
index|]
operator|=
name|txpi
index|[
literal|1
index|]
operator|=
literal|30
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|3
condition|)
block|{
name|txpi
index|[
literal|0
index|]
operator|=
literal|40
expr_stmt|;
name|txpi
index|[
literal|1
index|]
operator|=
literal|40
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|siba_sprom_get_rev
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|<
literal|4
condition|)
block|{
name|txpi
index|[
literal|0
index|]
operator|=
literal|72
expr_stmt|;
name|txpi
index|[
literal|1
index|]
operator|=
literal|72
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_2G
condition|)
block|{
name|txpi
index|[
literal|0
index|]
operator|=
name|siba_sprom_get_txpid_2g_0
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
expr_stmt|;
name|txpi
index|[
literal|1
index|]
operator|=
name|siba_sprom_get_txpid_2g_1
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|freq
operator|>=
literal|4900
operator|&&
name|freq
operator|<
literal|5100
condition|)
block|{
name|txpi
index|[
literal|0
index|]
operator|=
name|siba_sprom_get_txpid_5gl_0
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
expr_stmt|;
name|txpi
index|[
literal|1
index|]
operator|=
name|siba_sprom_get_txpid_5gl_1
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|freq
operator|>=
literal|5100
operator|&&
name|freq
operator|<
literal|5500
condition|)
block|{
name|txpi
index|[
literal|0
index|]
operator|=
name|siba_sprom_get_txpid_5g_0
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
expr_stmt|;
name|txpi
index|[
literal|1
index|]
operator|=
name|siba_sprom_get_txpid_5g_1
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|freq
operator|>=
literal|5500
condition|)
block|{
name|txpi
index|[
literal|0
index|]
operator|=
name|siba_sprom_get_txpid_5gh_0
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
expr_stmt|;
name|txpi
index|[
literal|1
index|]
operator|=
name|siba_sprom_get_txpid_5gh_1
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|txpi
index|[
literal|0
index|]
operator|=
literal|91
expr_stmt|;
name|txpi
index|[
literal|1
index|]
operator|=
literal|91
expr_stmt|;
block|}
block|}
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|<
literal|7
operator|&&
operator|(
name|txpi
index|[
literal|0
index|]
operator|<
literal|40
operator|||
name|txpi
index|[
literal|0
index|]
operator|>
literal|100
operator|||
name|txpi
index|[
literal|1
index|]
operator|<
literal|40
operator|||
name|txpi
index|[
literal|1
index|]
operator|>
literal|100
operator|)
condition|)
name|txpi
index|[
literal|0
index|]
operator|=
name|txpi
index|[
literal|1
index|]
operator|=
literal|91
expr_stmt|;
comment|/* 	for (i = 0; i< 2; i++) { 		nphy->txpwrindex[i].index_internal = txpi[i]; 		nphy->txpwrindex[i].index_internal_save = txpi[i]; 	} 	*/
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
block|{
specifier|const
name|uint32_t
modifier|*
name|table
init|=
name|bwn_nphy_get_tx_gain_table
argument_list|(
name|mac
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|table
condition|)
break|break;
name|txgain
operator|=
operator|*
operator|(
name|table
operator|+
name|txpi
index|[
name|i
index|]
operator|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|3
condition|)
name|radio_gain
operator|=
operator|(
name|txgain
operator|>>
literal|16
operator|)
operator|&
literal|0x1FFFF
expr_stmt|;
else|else
name|radio_gain
operator|=
operator|(
name|txgain
operator|>>
literal|16
operator|)
operator|&
literal|0x1FFF
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|7
condition|)
name|dac_gain
operator|=
operator|(
name|txgain
operator|>>
literal|8
operator|)
operator|&
literal|0x7
expr_stmt|;
else|else
name|dac_gain
operator|=
operator|(
name|txgain
operator|>>
literal|8
operator|)
operator|&
literal|0x3F
expr_stmt|;
name|bbmult
operator|=
name|txgain
operator|&
literal|0xFF
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|3
condition|)
block|{
if|if
condition|(
name|i
operator|==
literal|0
condition|)
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_OVER1
argument_list|,
literal|0x0100
argument_list|)
expr_stmt|;
else|else
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_OVER
argument_list|,
literal|0x0100
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_OVER
argument_list|,
literal|0x4000
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|==
literal|0
condition|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_DACGAIN1
argument_list|,
name|dac_gain
argument_list|)
expr_stmt|;
else|else
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_DACGAIN2
argument_list|,
name|dac_gain
argument_list|)
expr_stmt|;
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|0x7
argument_list|,
literal|0x110
operator|+
name|i
argument_list|)
argument_list|,
name|radio_gain
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|bwn_ntab_read
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|0xF
argument_list|,
literal|0x57
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
literal|0
condition|)
name|tmp
operator|=
operator|(
name|tmp
operator|&
literal|0x00FF
operator|)
operator||
operator|(
name|bbmult
operator|<<
literal|8
operator|)
expr_stmt|;
else|else
name|tmp
operator|=
operator|(
name|tmp
operator|&
literal|0xFF00
operator|)
operator||
name|bbmult
expr_stmt|;
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|0xF
argument_list|,
literal|0x57
argument_list|)
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|bwn_nphy_ipa
argument_list|(
name|mac
argument_list|)
condition|)
block|{
name|uint32_t
name|tmp32
decl_stmt|;
name|uint16_t
name|reg
init|=
operator|(
name|i
operator|==
literal|0
operator|)
condition|?
name|BWN_NPHY_PAPD_EN0
else|:
name|BWN_NPHY_PAPD_EN1
decl_stmt|;
name|tmp32
operator|=
name|bwn_ntab_read
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB32
argument_list|(
literal|26
operator|+
name|i
argument_list|,
literal|576
operator|+
name|txpi
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|reg
argument_list|,
literal|0xE00F
argument_list|,
operator|(
name|uint32_t
operator|)
name|tmp32
operator|<<
literal|4
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|reg
argument_list|,
literal|0x4
argument_list|)
expr_stmt|;
block|}
block|}
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_BPHY_CTL2
argument_list|,
operator|~
name|BWN_NPHY_BPHY_CTL2_LUT
argument_list|)
expr_stmt|;
if|if
condition|(
name|nphy
operator|->
name|hang_avoid
condition|)
name|bwn_nphy_stay_in_carrier_search
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_nphy_ipa_internal_tssi_setup
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|uint8_t
name|core
decl_stmt|;
name|uint16_t
name|r
decl_stmt|;
comment|/* routing */
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|19
condition|)
block|{
comment|/* TODO */
block|}
elseif|else
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|7
condition|)
block|{
for|for
control|(
name|core
operator|=
literal|0
init|;
name|core
operator|<
literal|2
condition|;
name|core
operator|++
control|)
block|{
name|r
operator|=
name|core
condition|?
literal|0x190
else|:
literal|0x170
expr_stmt|;
if|if
condition|(
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_2G
condition|)
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|r
operator|+
literal|0x5
argument_list|,
literal|0x5
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|r
operator|+
literal|0x9
argument_list|,
literal|0xE
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|!=
literal|5
condition|)
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|r
operator|+
literal|0xA
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|!=
literal|7
condition|)
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|r
operator|+
literal|0xB
argument_list|,
literal|1
argument_list|)
expr_stmt|;
else|else
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|r
operator|+
literal|0xB
argument_list|,
literal|0x31
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|r
operator|+
literal|0x5
argument_list|,
literal|0x9
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|r
operator|+
literal|0x9
argument_list|,
literal|0xC
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|r
operator|+
literal|0xB
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|!=
literal|5
condition|)
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|r
operator|+
literal|0xA
argument_list|,
literal|1
argument_list|)
expr_stmt|;
else|else
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|r
operator|+
literal|0xA
argument_list|,
literal|0x31
argument_list|)
expr_stmt|;
block|}
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|r
operator|+
literal|0x6
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|r
operator|+
literal|0x7
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|r
operator|+
literal|0x8
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|r
operator|+
literal|0xC
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_2G
condition|)
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_SYN_RESERVED_ADDR31
argument_list|,
literal|0x128
argument_list|)
expr_stmt|;
else|else
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_SYN_RESERVED_ADDR31
argument_list|,
literal|0x80
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_SYN_RESERVED_ADDR30
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_SYN_GPIO_MASTER1
argument_list|,
literal|0x29
argument_list|)
expr_stmt|;
for|for
control|(
name|core
operator|=
literal|0
init|;
name|core
operator|<
literal|2
condition|;
name|core
operator|++
control|)
block|{
name|r
operator|=
name|core
condition|?
name|B2056_TX1
else|:
name|B2056_TX0
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|r
operator||
name|B2056_TX_IQCAL_VCM_HG
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|r
operator||
name|B2056_TX_IQCAL_IDAC
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|r
operator||
name|B2056_TX_TSSI_VCM
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|r
operator||
name|B2056_TX_TX_AMP_DET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|r
operator||
name|B2056_TX_TSSI_MISC1
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|r
operator||
name|B2056_TX_TSSI_MISC2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|r
operator||
name|B2056_TX_TSSI_MISC3
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_2G
condition|)
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|r
operator||
name|B2056_TX_TX_SSI_MASTER
argument_list|,
literal|0x5
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|!=
literal|5
condition|)
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|r
operator||
name|B2056_TX_TSSIA
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|5
condition|)
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|r
operator||
name|B2056_TX_TSSIG
argument_list|,
literal|0x31
argument_list|)
expr_stmt|;
else|else
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|r
operator||
name|B2056_TX_TSSIG
argument_list|,
literal|0x11
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|r
operator||
name|B2056_TX_TX_SSI_MUX
argument_list|,
literal|0xE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|r
operator||
name|B2056_TX_TX_SSI_MASTER
argument_list|,
literal|0x9
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|r
operator||
name|B2056_TX_TSSIA
argument_list|,
literal|0x31
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|r
operator||
name|B2056_TX_TSSIG
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|r
operator||
name|B2056_TX_TX_SSI_MUX
argument_list|,
literal|0xC
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_comment
comment|/*  * Stop radio and transmit known signal. Then check received signal strength to  * get TSSI (Transmit Signal Strength Indicator).  * http://bcm-v4.sipsolutions.net/802.11/PHY/N/TxPwrCtrlIdleTssi  */
end_comment

begin_function
specifier|static
name|void
name|bwn_nphy_tx_power_ctl_idle_tssi
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwn_phy_n
modifier|*
name|nphy
init|=
name|mac
operator|->
name|mac_phy
operator|.
name|phy_n
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
name|int32_t
name|rssi
index|[
literal|4
index|]
init|=
block|{ }
decl_stmt|;
if|if
condition|(
name|bwn_is_chan_passive
argument_list|(
name|mac
argument_list|)
condition|)
return|return;
if|if
condition|(
name|bwn_nphy_ipa
argument_list|(
name|mac
argument_list|)
condition|)
name|bwn_nphy_ipa_internal_tssi_setup
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|19
condition|)
name|bwn_nphy_rf_ctl_override_rev19
argument_list|(
name|mac
argument_list|,
literal|0x1000
argument_list|,
literal|0
argument_list|,
literal|3
argument_list|,
name|false
argument_list|,
literal|0
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|7
condition|)
name|bwn_nphy_rf_ctl_override_rev7
argument_list|(
name|mac
argument_list|,
literal|0x1000
argument_list|,
literal|0
argument_list|,
literal|3
argument_list|,
name|false
argument_list|,
literal|0
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|3
condition|)
name|bwn_nphy_rf_ctl_override
argument_list|(
name|mac
argument_list|,
literal|0x2000
argument_list|,
literal|0
argument_list|,
literal|3
argument_list|,
name|false
argument_list|)
expr_stmt|;
name|bwn_nphy_stop_playback
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|bwn_nphy_tx_tone
argument_list|(
name|mac
argument_list|,
literal|4000
argument_list|,
literal|0
argument_list|,
name|false
argument_list|,
name|false
argument_list|,
name|false
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|20
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|bwn_nphy_poll_rssi
argument_list|(
name|mac
argument_list|,
name|N_RSSI_TSSI_2G
argument_list|,
name|rssi
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|bwn_nphy_stop_playback
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|bwn_nphy_rssi_select
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|,
name|N_RSSI_W1
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|19
condition|)
name|bwn_nphy_rf_ctl_override_rev19
argument_list|(
name|mac
argument_list|,
literal|0x1000
argument_list|,
literal|0
argument_list|,
literal|3
argument_list|,
name|true
argument_list|,
literal|0
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|7
condition|)
name|bwn_nphy_rf_ctl_override_rev7
argument_list|(
name|mac
argument_list|,
literal|0x1000
argument_list|,
literal|0
argument_list|,
literal|3
argument_list|,
name|true
argument_list|,
literal|0
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|3
condition|)
name|bwn_nphy_rf_ctl_override
argument_list|(
name|mac
argument_list|,
literal|0x2000
argument_list|,
literal|0
argument_list|,
literal|3
argument_list|,
name|true
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|19
condition|)
block|{
comment|/* TODO */
return|return;
block|}
elseif|else
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|3
condition|)
block|{
name|nphy
operator|->
name|pwr_ctl_info
index|[
literal|0
index|]
operator|.
name|idle_tssi_5g
operator|=
operator|(
name|tmp
operator|>>
literal|24
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|nphy
operator|->
name|pwr_ctl_info
index|[
literal|1
index|]
operator|.
name|idle_tssi_5g
operator|=
operator|(
name|tmp
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
block|}
else|else
block|{
name|nphy
operator|->
name|pwr_ctl_info
index|[
literal|0
index|]
operator|.
name|idle_tssi_5g
operator|=
operator|(
name|tmp
operator|>>
literal|16
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|nphy
operator|->
name|pwr_ctl_info
index|[
literal|1
index|]
operator|.
name|idle_tssi_5g
operator|=
name|tmp
operator|&
literal|0xFF
expr_stmt|;
block|}
name|nphy
operator|->
name|pwr_ctl_info
index|[
literal|0
index|]
operator|.
name|idle_tssi_2g
operator|=
operator|(
name|tmp
operator|>>
literal|24
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|nphy
operator|->
name|pwr_ctl_info
index|[
literal|1
index|]
operator|.
name|idle_tssi_2g
operator|=
operator|(
name|tmp
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
block|}
end_function

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/PHY/N/TxPwrLimitToTbl */
end_comment

begin_function
specifier|static
name|void
name|bwn_nphy_tx_prepare_adjusted_power_table
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_phy_n
modifier|*
name|nphy
init|=
name|mac
operator|->
name|mac_phy
operator|.
name|phy_n
decl_stmt|;
name|uint8_t
name|idx
decl_stmt|,
name|delta
decl_stmt|;
name|uint8_t
name|i
decl_stmt|,
name|stf_mode
decl_stmt|;
comment|/* Array adj_pwr_tbl corresponds to the hardware table. It consists of 	 * 21 groups, each containing 4 entries. 	 * 	 * First group has entries for CCK modulation. 	 * The rest of groups has 1 entry per modulation (SISO, CDD, STBC, SDM). 	 * 	 * Group 0 is for CCK 	 * Groups 1..4 use BPSK (group per coding rate) 	 * Groups 5..8 use QPSK (group per coding rate) 	 * Groups 9..12 use 16-QAM (group per coding rate) 	 * Groups 13..16 use 64-QAM (group per coding rate) 	 * Groups 17..20 are unknown 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
name|nphy
operator|->
name|adj_pwr_tbl
index|[
name|i
index|]
operator|=
name|nphy
operator|->
name|tx_power_offset
index|[
name|i
index|]
expr_stmt|;
for|for
control|(
name|stf_mode
operator|=
literal|0
init|;
name|stf_mode
operator|<
literal|4
condition|;
name|stf_mode
operator|++
control|)
block|{
name|delta
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|stf_mode
condition|)
block|{
case|case
literal|0
case|:
if|if
condition|(
name|bwn_is_40mhz
argument_list|(
name|mac
argument_list|)
operator|&&
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|5
condition|)
block|{
name|idx
operator|=
literal|68
expr_stmt|;
block|}
else|else
block|{
name|delta
operator|=
literal|1
expr_stmt|;
name|idx
operator|=
name|bwn_is_40mhz
argument_list|(
name|mac
argument_list|)
condition|?
literal|52
else|:
literal|4
expr_stmt|;
block|}
break|break;
case|case
literal|1
case|:
name|idx
operator|=
name|bwn_is_40mhz
argument_list|(
name|mac
argument_list|)
condition|?
literal|76
else|:
literal|28
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|idx
operator|=
name|bwn_is_40mhz
argument_list|(
name|mac
argument_list|)
condition|?
literal|84
else|:
literal|36
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|idx
operator|=
name|bwn_is_40mhz
argument_list|(
name|mac
argument_list|)
condition|?
literal|92
else|:
literal|44
expr_stmt|;
break|break;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|20
condition|;
name|i
operator|++
control|)
block|{
name|nphy
operator|->
name|adj_pwr_tbl
index|[
literal|4
operator|+
literal|4
operator|*
name|i
operator|+
name|stf_mode
index|]
operator|=
name|nphy
operator|->
name|tx_power_offset
index|[
name|idx
index|]
expr_stmt|;
if|if
condition|(
name|i
operator|==
literal|0
condition|)
name|idx
operator|+=
name|delta
expr_stmt|;
if|if
condition|(
name|i
operator|==
literal|14
condition|)
name|idx
operator|+=
literal|1
operator|-
name|delta
expr_stmt|;
if|if
condition|(
name|i
operator|==
literal|3
operator|||
name|i
operator|==
literal|4
operator|||
name|i
operator|==
literal|7
operator|||
name|i
operator|==
literal|8
operator|||
name|i
operator|==
literal|11
operator|||
name|i
operator|==
literal|13
condition|)
name|idx
operator|+=
literal|1
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/TxPwrCtrlSetup */
end_comment

begin_function
specifier|static
name|void
name|bwn_nphy_tx_power_ctl_setup
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwn_phy_n
modifier|*
name|nphy
init|=
name|mac
operator|->
name|mac_phy
operator|.
name|phy_n
decl_stmt|;
name|struct
name|siba_sprom_core_pwr_info
name|core_pwr_info
index|[
literal|4
index|]
decl_stmt|;
name|int
name|n
decl_stmt|;
name|int16_t
name|a1
index|[
literal|2
index|]
decl_stmt|,
name|b0
index|[
literal|2
index|]
decl_stmt|,
name|b1
index|[
literal|2
index|]
decl_stmt|;
name|uint8_t
name|idle
index|[
literal|2
index|]
decl_stmt|;
name|uint8_t
name|ppr_max
decl_stmt|;
name|int8_t
name|target
index|[
literal|2
index|]
decl_stmt|;
name|int32_t
name|num
decl_stmt|,
name|den
decl_stmt|,
name|pwr
decl_stmt|;
name|uint32_t
name|regval
index|[
literal|64
index|]
decl_stmt|;
name|uint16_t
name|freq
init|=
name|bwn_get_centre_freq
argument_list|(
name|mac
argument_list|)
decl_stmt|;
name|uint16_t
name|tmp
decl_stmt|;
name|uint16_t
name|r
decl_stmt|;
comment|/* routing */
name|uint8_t
name|i
decl_stmt|,
name|c
decl_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
literal|4
condition|;
name|n
operator|++
control|)
block|{
name|bzero
argument_list|(
operator|&
name|core_pwr_info
index|[
name|n
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|core_pwr_info
index|[
name|n
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|siba_sprom_get_core_power_info
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
name|n
argument_list|,
operator|&
name|core_pwr_info
index|[
name|n
index|]
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|BWN_ERRPRINTF
argument_list|(
name|mac
operator|->
name|mac_sc
argument_list|,
literal|"%s: failed to get core_pwr_info for core %d\n"
argument_list|,
name|__func__
argument_list|,
name|n
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|siba_get_revid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
literal|11
operator|||
name|siba_get_revid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
literal|12
condition|)
block|{
name|BWN_WRITE_SETMASK4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCTL
argument_list|,
operator|~
literal|0
argument_list|,
literal|0x200000
argument_list|)
expr_stmt|;
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCTL
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|nphy
operator|->
name|hang_avoid
condition|)
name|bwn_nphy_stay_in_carrier_search
argument_list|(
name|mac
argument_list|,
name|true
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TSSIMODE
argument_list|,
name|BWN_NPHY_TSSIMODE_EN
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|3
condition|)
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TXPCTL_CMD
argument_list|,
operator|~
name|BWN_NPHY_TXPCTL_CMD_PCTLEN
operator|&
literal|0xFFFF
argument_list|)
expr_stmt|;
else|else
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TXPCTL_CMD
argument_list|,
name|BWN_NPHY_TXPCTL_CMD_PCTLEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|siba_get_revid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
literal|11
operator|||
name|siba_get_revid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
literal|12
condition|)
name|BWN_WRITE_SETMASK4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCTL
argument_list|,
operator|~
literal|0x200000
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* 	 * XXX TODO: see if those bandsbelow map to 5g-lo, 5g-mid, 5g-hi in 	 * any way. 	 */
if|if
condition|(
name|siba_sprom_get_rev
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|<
literal|4
condition|)
block|{
name|idle
index|[
literal|0
index|]
operator|=
name|nphy
operator|->
name|pwr_ctl_info
index|[
literal|0
index|]
operator|.
name|idle_tssi_2g
expr_stmt|;
name|idle
index|[
literal|1
index|]
operator|=
name|nphy
operator|->
name|pwr_ctl_info
index|[
literal|1
index|]
operator|.
name|idle_tssi_2g
expr_stmt|;
name|target
index|[
literal|0
index|]
operator|=
name|target
index|[
literal|1
index|]
operator|=
literal|52
expr_stmt|;
name|a1
index|[
literal|0
index|]
operator|=
name|a1
index|[
literal|1
index|]
operator|=
operator|-
literal|424
expr_stmt|;
name|b0
index|[
literal|0
index|]
operator|=
name|b0
index|[
literal|1
index|]
operator|=
literal|5612
expr_stmt|;
name|b1
index|[
literal|0
index|]
operator|=
name|b1
index|[
literal|1
index|]
operator|=
operator|-
literal|1393
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_2G
condition|)
block|{
for|for
control|(
name|c
operator|=
literal|0
init|;
name|c
operator|<
literal|2
condition|;
name|c
operator|++
control|)
block|{
name|idle
index|[
name|c
index|]
operator|=
name|nphy
operator|->
name|pwr_ctl_info
index|[
name|c
index|]
operator|.
name|idle_tssi_2g
expr_stmt|;
name|target
index|[
name|c
index|]
operator|=
name|core_pwr_info
index|[
name|c
index|]
operator|.
name|maxpwr_2g
expr_stmt|;
name|a1
index|[
name|c
index|]
operator|=
name|core_pwr_info
index|[
name|c
index|]
operator|.
name|pa_2g
index|[
literal|0
index|]
expr_stmt|;
name|b0
index|[
name|c
index|]
operator|=
name|core_pwr_info
index|[
name|c
index|]
operator|.
name|pa_2g
index|[
literal|1
index|]
expr_stmt|;
name|b1
index|[
name|c
index|]
operator|=
name|core_pwr_info
index|[
name|c
index|]
operator|.
name|pa_2g
index|[
literal|2
index|]
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|freq
operator|>=
literal|4900
operator|&&
name|freq
operator|<
literal|5100
condition|)
block|{
for|for
control|(
name|c
operator|=
literal|0
init|;
name|c
operator|<
literal|2
condition|;
name|c
operator|++
control|)
block|{
name|idle
index|[
name|c
index|]
operator|=
name|nphy
operator|->
name|pwr_ctl_info
index|[
name|c
index|]
operator|.
name|idle_tssi_5g
expr_stmt|;
name|target
index|[
name|c
index|]
operator|=
name|core_pwr_info
index|[
name|c
index|]
operator|.
name|maxpwr_5gl
expr_stmt|;
name|a1
index|[
name|c
index|]
operator|=
name|core_pwr_info
index|[
name|c
index|]
operator|.
name|pa_5gl
index|[
literal|0
index|]
expr_stmt|;
name|b0
index|[
name|c
index|]
operator|=
name|core_pwr_info
index|[
name|c
index|]
operator|.
name|pa_5gl
index|[
literal|1
index|]
expr_stmt|;
name|b1
index|[
name|c
index|]
operator|=
name|core_pwr_info
index|[
name|c
index|]
operator|.
name|pa_5gl
index|[
literal|2
index|]
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|freq
operator|>=
literal|5100
operator|&&
name|freq
operator|<
literal|5500
condition|)
block|{
for|for
control|(
name|c
operator|=
literal|0
init|;
name|c
operator|<
literal|2
condition|;
name|c
operator|++
control|)
block|{
name|idle
index|[
name|c
index|]
operator|=
name|nphy
operator|->
name|pwr_ctl_info
index|[
name|c
index|]
operator|.
name|idle_tssi_5g
expr_stmt|;
name|target
index|[
name|c
index|]
operator|=
name|core_pwr_info
index|[
name|c
index|]
operator|.
name|maxpwr_5g
expr_stmt|;
name|a1
index|[
name|c
index|]
operator|=
name|core_pwr_info
index|[
name|c
index|]
operator|.
name|pa_5g
index|[
literal|0
index|]
expr_stmt|;
name|b0
index|[
name|c
index|]
operator|=
name|core_pwr_info
index|[
name|c
index|]
operator|.
name|pa_5g
index|[
literal|1
index|]
expr_stmt|;
name|b1
index|[
name|c
index|]
operator|=
name|core_pwr_info
index|[
name|c
index|]
operator|.
name|pa_5g
index|[
literal|2
index|]
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|freq
operator|>=
literal|5500
condition|)
block|{
for|for
control|(
name|c
operator|=
literal|0
init|;
name|c
operator|<
literal|2
condition|;
name|c
operator|++
control|)
block|{
name|idle
index|[
name|c
index|]
operator|=
name|nphy
operator|->
name|pwr_ctl_info
index|[
name|c
index|]
operator|.
name|idle_tssi_5g
expr_stmt|;
name|target
index|[
name|c
index|]
operator|=
name|core_pwr_info
index|[
name|c
index|]
operator|.
name|maxpwr_5gh
expr_stmt|;
name|a1
index|[
name|c
index|]
operator|=
name|core_pwr_info
index|[
name|c
index|]
operator|.
name|pa_5gh
index|[
literal|0
index|]
expr_stmt|;
name|b0
index|[
name|c
index|]
operator|=
name|core_pwr_info
index|[
name|c
index|]
operator|.
name|pa_5gh
index|[
literal|1
index|]
expr_stmt|;
name|b1
index|[
name|c
index|]
operator|=
name|core_pwr_info
index|[
name|c
index|]
operator|.
name|pa_5gh
index|[
literal|2
index|]
expr_stmt|;
block|}
block|}
else|else
block|{
name|idle
index|[
literal|0
index|]
operator|=
name|nphy
operator|->
name|pwr_ctl_info
index|[
literal|0
index|]
operator|.
name|idle_tssi_5g
expr_stmt|;
name|idle
index|[
literal|1
index|]
operator|=
name|nphy
operator|->
name|pwr_ctl_info
index|[
literal|1
index|]
operator|.
name|idle_tssi_5g
expr_stmt|;
name|target
index|[
literal|0
index|]
operator|=
name|target
index|[
literal|1
index|]
operator|=
literal|52
expr_stmt|;
name|a1
index|[
literal|0
index|]
operator|=
name|a1
index|[
literal|1
index|]
operator|=
operator|-
literal|424
expr_stmt|;
name|b0
index|[
literal|0
index|]
operator|=
name|b0
index|[
literal|1
index|]
operator|=
literal|5612
expr_stmt|;
name|b1
index|[
literal|0
index|]
operator|=
name|b1
index|[
literal|1
index|]
operator|=
operator|-
literal|1393
expr_stmt|;
block|}
block|}
name|ppr_max
operator|=
name|bwn_ppr_get_max
argument_list|(
name|mac
argument_list|,
operator|&
name|nphy
operator|->
name|tx_pwr_max_ppr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ppr_max
condition|)
block|{
name|target
index|[
literal|0
index|]
operator|=
name|ppr_max
expr_stmt|;
name|target
index|[
literal|1
index|]
operator|=
name|ppr_max
expr_stmt|;
block|}
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|3
condition|)
block|{
if|if
condition|(
name|siba_sprom_get_fem_2ghz_tssipos
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
condition|)
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TXPCTL_ITSSI
argument_list|,
literal|0x4000
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|7
condition|)
block|{
for|for
control|(
name|c
operator|=
literal|0
init|;
name|c
operator|<
literal|2
condition|;
name|c
operator|++
control|)
block|{
name|r
operator|=
name|c
condition|?
literal|0x190
else|:
literal|0x170
expr_stmt|;
if|if
condition|(
name|bwn_nphy_ipa
argument_list|(
name|mac
argument_list|)
condition|)
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|r
operator|+
literal|0x9
argument_list|,
operator|(
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_2G
operator|)
condition|?
literal|0xE
else|:
literal|0xC
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|bwn_nphy_ipa
argument_list|(
name|mac
argument_list|)
condition|)
block|{
name|tmp
operator|=
operator|(
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_5G
operator|)
condition|?
literal|0xC
else|:
literal|0xE
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_TX0
operator||
name|B2056_TX_TX_SSI_MUX
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_TX1
operator||
name|B2056_TX_TX_SSI_MUX
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_TX0
operator||
name|B2056_TX_TX_SSI_MUX
argument_list|,
literal|0x11
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2056_TX1
operator||
name|B2056_TX_TX_SSI_MUX
argument_list|,
literal|0x11
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|siba_get_revid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
literal|11
operator|||
name|siba_get_revid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
literal|12
condition|)
block|{
name|BWN_WRITE_SETMASK4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCTL
argument_list|,
operator|~
literal|0
argument_list|,
literal|0x200000
argument_list|)
expr_stmt|;
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCTL
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|19
condition|)
block|{
comment|/* TODO */
block|}
elseif|else
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|7
condition|)
block|{
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TXPCTL_CMD
argument_list|,
operator|~
name|BWN_NPHY_TXPCTL_CMD_INIT
argument_list|,
literal|0x19
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TXPCTL_INIT
argument_list|,
operator|~
name|BWN_NPHY_TXPCTL_INIT_PIDXI1
argument_list|,
literal|0x19
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TXPCTL_CMD
argument_list|,
operator|~
name|BWN_NPHY_TXPCTL_CMD_INIT
argument_list|,
literal|0x40
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>
literal|1
condition|)
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TXPCTL_INIT
argument_list|,
operator|~
name|BWN_NPHY_TXPCTL_INIT_PIDXI1
argument_list|,
literal|0x40
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|siba_get_revid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
literal|11
operator|||
name|siba_get_revid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
literal|12
condition|)
name|BWN_WRITE_SETMASK4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCTL
argument_list|,
operator|~
literal|0x200000
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TXPCTL_N
argument_list|,
literal|0xF0
operator|<<
name|BWN_NPHY_TXPCTL_N_TSSID_SHIFT
operator||
literal|3
operator|<<
name|BWN_NPHY_TXPCTL_N_NPTIL2_SHIFT
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TXPCTL_ITSSI
argument_list|,
name|idle
index|[
literal|0
index|]
operator|<<
name|BWN_NPHY_TXPCTL_ITSSI_0_SHIFT
operator||
name|idle
index|[
literal|1
index|]
operator|<<
name|BWN_NPHY_TXPCTL_ITSSI_1_SHIFT
operator||
name|BWN_NPHY_TXPCTL_ITSSI_BINF
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TXPCTL_TPWR
argument_list|,
name|target
index|[
literal|0
index|]
operator|<<
name|BWN_NPHY_TXPCTL_TPWR_0_SHIFT
operator||
name|target
index|[
literal|1
index|]
operator|<<
name|BWN_NPHY_TXPCTL_TPWR_1_SHIFT
argument_list|)
expr_stmt|;
for|for
control|(
name|c
operator|=
literal|0
init|;
name|c
operator|<
literal|2
condition|;
name|c
operator|++
control|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|64
condition|;
name|i
operator|++
control|)
block|{
name|num
operator|=
literal|8
operator|*
operator|(
literal|16
operator|*
name|b0
index|[
name|c
index|]
operator|+
name|b1
index|[
name|c
index|]
operator|*
name|i
operator|)
expr_stmt|;
name|den
operator|=
literal|32768
operator|+
name|a1
index|[
name|c
index|]
operator|*
name|i
expr_stmt|;
name|pwr
operator|=
name|max
argument_list|(
operator|(
literal|4
operator|*
name|num
operator|+
name|den
operator|/
literal|2
operator|)
operator|/
name|den
argument_list|,
operator|-
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|<
literal|3
operator|&&
operator|(
name|i
operator|<=
operator|(
literal|31
operator|-
name|idle
index|[
name|c
index|]
operator|+
literal|1
operator|)
operator|)
condition|)
name|pwr
operator|=
name|max
argument_list|(
name|pwr
argument_list|,
name|target
index|[
name|c
index|]
operator|+
literal|1
argument_list|)
expr_stmt|;
name|regval
index|[
name|i
index|]
operator|=
name|pwr
expr_stmt|;
block|}
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB32
argument_list|(
literal|26
operator|+
name|c
argument_list|,
literal|0
argument_list|)
argument_list|,
literal|64
argument_list|,
name|regval
argument_list|)
expr_stmt|;
block|}
name|bwn_nphy_tx_prepare_adjusted_power_table
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|26
argument_list|,
literal|64
argument_list|)
argument_list|,
literal|84
argument_list|,
name|nphy
operator|->
name|adj_pwr_tbl
argument_list|)
expr_stmt|;
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|27
argument_list|,
literal|64
argument_list|)
argument_list|,
literal|84
argument_list|,
name|nphy
operator|->
name|adj_pwr_tbl
argument_list|)
expr_stmt|;
if|if
condition|(
name|nphy
operator|->
name|hang_avoid
condition|)
name|bwn_nphy_stay_in_carrier_search
argument_list|(
name|mac
argument_list|,
name|false
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_nphy_tx_gain_table_upload
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
specifier|const
name|uint32_t
modifier|*
name|table
init|=
name|NULL
decl_stmt|;
name|uint32_t
name|rfpwr_offset
decl_stmt|;
name|uint8_t
name|pga_gain
decl_stmt|,
name|pad_gain
decl_stmt|;
name|int
name|i
decl_stmt|;
specifier|const
name|int16_t
modifier|*
name|rf_pwr_offset_table
init|=
name|NULL
decl_stmt|;
name|table
operator|=
name|bwn_nphy_get_tx_gain_table
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|table
condition|)
return|return;
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB32
argument_list|(
literal|26
argument_list|,
literal|192
argument_list|)
argument_list|,
literal|128
argument_list|,
name|table
argument_list|)
expr_stmt|;
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB32
argument_list|(
literal|27
argument_list|,
literal|192
argument_list|)
argument_list|,
literal|128
argument_list|,
name|table
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|<
literal|3
condition|)
return|return;
if|#
directive|if
literal|0
block|nphy->gmval = (table[0]>> 16)& 0x7000;
endif|#
directive|endif
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|19
condition|)
block|{
return|return;
block|}
elseif|else
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|7
condition|)
block|{
name|rf_pwr_offset_table
operator|=
name|bwn_ntab_get_rf_pwr_offset_table
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rf_pwr_offset_table
condition|)
return|return;
comment|/* TODO: Enable this once we have gains configured */
return|return;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|128
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|19
condition|)
block|{
comment|/* TODO */
return|return;
block|}
elseif|else
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|7
condition|)
block|{
name|pga_gain
operator|=
operator|(
name|table
index|[
name|i
index|]
operator|>>
literal|24
operator|)
operator|&
literal|0xf
expr_stmt|;
name|pad_gain
operator|=
operator|(
name|table
index|[
name|i
index|]
operator|>>
literal|19
operator|)
operator|&
literal|0x1f
expr_stmt|;
if|if
condition|(
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_2G
condition|)
name|rfpwr_offset
operator|=
name|rf_pwr_offset_table
index|[
name|pad_gain
index|]
expr_stmt|;
else|else
name|rfpwr_offset
operator|=
name|rf_pwr_offset_table
index|[
name|pga_gain
index|]
expr_stmt|;
block|}
else|else
block|{
name|pga_gain
operator|=
operator|(
name|table
index|[
name|i
index|]
operator|>>
literal|24
operator|)
operator|&
literal|0xF
expr_stmt|;
if|if
condition|(
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_2G
condition|)
name|rfpwr_offset
operator|=
name|bwn_ntab_papd_pga_gain_delta_ipa_2g
index|[
name|pga_gain
index|]
expr_stmt|;
else|else
name|rfpwr_offset
operator|=
literal|0
expr_stmt|;
comment|/* FIXME */
block|}
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB32
argument_list|(
literal|26
argument_list|,
literal|576
operator|+
name|i
argument_list|)
argument_list|,
name|rfpwr_offset
argument_list|)
expr_stmt|;
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB32
argument_list|(
literal|27
argument_list|,
literal|576
operator|+
name|i
argument_list|)
argument_list|,
name|rfpwr_offset
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/PA%20override */
end_comment

begin_function
specifier|static
name|void
name|bwn_nphy_pa_override
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|bool
name|enable
parameter_list|)
block|{
name|struct
name|bwn_phy_n
modifier|*
name|nphy
init|=
name|mac
operator|->
name|mac_phy
operator|.
name|phy_n
decl_stmt|;
name|bwn_band_t
name|band
decl_stmt|;
name|uint16_t
name|tmp
decl_stmt|;
if|if
condition|(
operator|!
name|enable
condition|)
block|{
name|nphy
operator|->
name|rfctrl_intc1_save
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_INTC1
argument_list|)
expr_stmt|;
name|nphy
operator|->
name|rfctrl_intc2_save
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_INTC2
argument_list|)
expr_stmt|;
name|band
operator|=
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|7
condition|)
block|{
name|tmp
operator|=
literal|0x1480
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|3
condition|)
block|{
if|if
condition|(
name|band
operator|==
name|BWN_BAND_5G
condition|)
name|tmp
operator|=
literal|0x600
expr_stmt|;
else|else
name|tmp
operator|=
literal|0x480
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|band
operator|==
name|BWN_BAND_5G
condition|)
name|tmp
operator|=
literal|0x180
expr_stmt|;
else|else
name|tmp
operator|=
literal|0x120
expr_stmt|;
block|}
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_INTC1
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_INTC2
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_INTC1
argument_list|,
name|nphy
operator|->
name|rfctrl_intc1_save
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_INTC2
argument_list|,
name|nphy
operator|->
name|rfctrl_intc2_save
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * TX low-pass filter bandwidth setup  * http://bcm-v4.sipsolutions.net/802.11/PHY/N/TxLpFbw  */
end_comment

begin_function
specifier|static
name|void
name|bwn_nphy_tx_lpf_bw
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|uint16_t
name|tmp
decl_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|<
literal|3
operator|||
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|7
condition|)
return|return;
if|if
condition|(
name|bwn_nphy_ipa
argument_list|(
name|mac
argument_list|)
condition|)
name|tmp
operator|=
name|bwn_is_40mhz
argument_list|(
name|mac
argument_list|)
condition|?
literal|5
else|:
literal|4
expr_stmt|;
else|else
name|tmp
operator|=
name|bwn_is_40mhz
argument_list|(
name|mac
argument_list|)
condition|?
literal|3
else|:
literal|1
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TXF_40CO_B32S2
argument_list|,
operator|(
name|tmp
operator|<<
literal|9
operator|)
operator||
operator|(
name|tmp
operator|<<
literal|6
operator|)
operator||
operator|(
name|tmp
operator|<<
literal|3
operator|)
operator||
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|bwn_nphy_ipa
argument_list|(
name|mac
argument_list|)
condition|)
block|{
name|tmp
operator|=
name|bwn_is_40mhz
argument_list|(
name|mac
argument_list|)
condition|?
literal|4
else|:
literal|1
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TXF_40CO_B1S2
argument_list|,
operator|(
name|tmp
operator|<<
literal|9
operator|)
operator||
operator|(
name|tmp
operator|<<
literal|6
operator|)
operator||
operator|(
name|tmp
operator|<<
literal|3
operator|)
operator||
name|tmp
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RxIqEst */
end_comment

begin_function
specifier|static
name|void
name|bwn_nphy_rx_iq_est
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|struct
name|bwn_nphy_iq_est
modifier|*
name|est
parameter_list|,
name|uint16_t
name|samps
parameter_list|,
name|uint8_t
name|time
parameter_list|,
name|bool
name|wait
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|uint16_t
name|tmp
decl_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_IQEST_SAMCNT
argument_list|,
name|samps
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_IQEST_WT
argument_list|,
operator|~
name|BWN_NPHY_IQEST_WT_VAL
argument_list|,
name|time
argument_list|)
expr_stmt|;
if|if
condition|(
name|wait
condition|)
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_IQEST_CMD
argument_list|,
name|BWN_NPHY_IQEST_CMD_MODE
argument_list|)
expr_stmt|;
else|else
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_IQEST_CMD
argument_list|,
operator|~
name|BWN_NPHY_IQEST_CMD_MODE
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_IQEST_CMD
argument_list|,
name|BWN_NPHY_IQEST_CMD_START
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1000
init|;
name|i
condition|;
name|i
operator|--
control|)
block|{
name|tmp
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_IQEST_CMD
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|tmp
operator|&
name|BWN_NPHY_IQEST_CMD_START
operator|)
condition|)
block|{
name|est
operator|->
name|i0_pwr
operator|=
operator|(
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_IQEST_IPACC_HI0
argument_list|)
operator|<<
literal|16
operator|)
operator||
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_IQEST_IPACC_LO0
argument_list|)
expr_stmt|;
name|est
operator|->
name|q0_pwr
operator|=
operator|(
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_IQEST_QPACC_HI0
argument_list|)
operator|<<
literal|16
operator|)
operator||
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_IQEST_QPACC_LO0
argument_list|)
expr_stmt|;
name|est
operator|->
name|iq0_prod
operator|=
operator|(
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_IQEST_IQACC_HI0
argument_list|)
operator|<<
literal|16
operator|)
operator||
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_IQEST_IQACC_LO0
argument_list|)
expr_stmt|;
name|est
operator|->
name|i1_pwr
operator|=
operator|(
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_IQEST_IPACC_HI1
argument_list|)
operator|<<
literal|16
operator|)
operator||
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_IQEST_IPACC_LO1
argument_list|)
expr_stmt|;
name|est
operator|->
name|q1_pwr
operator|=
operator|(
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_IQEST_QPACC_HI1
argument_list|)
operator|<<
literal|16
operator|)
operator||
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_IQEST_QPACC_LO1
argument_list|)
expr_stmt|;
name|est
operator|->
name|iq1_prod
operator|=
operator|(
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_IQEST_IQACC_HI1
argument_list|)
operator|<<
literal|16
operator|)
operator||
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_IQEST_IQACC_LO1
argument_list|)
expr_stmt|;
return|return;
block|}
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
name|memset
argument_list|(
name|est
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|est
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RxIqCoeffs */
end_comment

begin_function
specifier|static
name|void
name|bwn_nphy_rx_iq_coeffs
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|bool
name|write
parameter_list|,
name|struct
name|bwn_phy_n_iq_comp
modifier|*
name|pcomp
parameter_list|)
block|{
if|if
condition|(
name|write
condition|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_C1_RXIQ_COMPA0
argument_list|,
name|pcomp
operator|->
name|a0
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_C1_RXIQ_COMPB0
argument_list|,
name|pcomp
operator|->
name|b0
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_C2_RXIQ_COMPA1
argument_list|,
name|pcomp
operator|->
name|a1
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_C2_RXIQ_COMPB1
argument_list|,
name|pcomp
operator|->
name|b1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|pcomp
operator|->
name|a0
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_C1_RXIQ_COMPA0
argument_list|)
expr_stmt|;
name|pcomp
operator|->
name|b0
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_C1_RXIQ_COMPB0
argument_list|)
expr_stmt|;
name|pcomp
operator|->
name|a1
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_C2_RXIQ_COMPA1
argument_list|)
expr_stmt|;
name|pcomp
operator|->
name|b1
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_C2_RXIQ_COMPB1
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_if
if|#
directive|if
literal|0
end_if

begin_comment
comment|/* Ready but not used anywhere */
end_comment

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RxCalPhyCleanup */
end_comment

begin_comment
unit|static void bwn_nphy_rx_cal_phy_cleanup(struct bwn_mac *mac, uint8_t core) { 	uint16_t *regs = mac->mac_phy.phy_n->tx_rx_cal_phy_saveregs;  	BWN_PHY_WRITE(mac, BWN_NPHY_RFSEQCA, regs[0]); 	if (core == 0) { 		BWN_PHY_WRITE(mac, BWN_NPHY_AFECTL_C1, regs[1]); 		BWN_PHY_WRITE(mac, BWN_NPHY_AFECTL_OVER1, regs[2]); 	} else { 		BWN_PHY_WRITE(mac, BWN_NPHY_AFECTL_C2, regs[1]); 		BWN_PHY_WRITE(mac, BWN_NPHY_AFECTL_OVER, regs[2]); 	} 	BWN_PHY_WRITE(mac, BWN_NPHY_RFCTL_INTC1, regs[3]); 	BWN_PHY_WRITE(mac, BWN_NPHY_RFCTL_INTC2, regs[4]); 	BWN_PHY_WRITE(mac, BWN_NPHY_RFCTL_RSSIO1, regs[5]); 	BWN_PHY_WRITE(mac, BWN_NPHY_RFCTL_RSSIO2, regs[6]); 	BWN_PHY_WRITE(mac, BWN_NPHY_TXF_40CO_B1S1, regs[7]); 	BWN_PHY_WRITE(mac, BWN_NPHY_RFCTL_OVER, regs[8]); 	BWN_PHY_WRITE(mac, BWN_NPHY_PAPD_EN0, regs[9]); 	BWN_PHY_WRITE(mac, BWN_NPHY_PAPD_EN1, regs[10]); }
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RxCalPhySetup */
end_comment

begin_endif
unit|static void bwn_nphy_rx_cal_phy_setup(struct bwn_mac *mac, uint8_t core) { 	uint8_t rxval, txval; 	uint16_t *regs = mac->mac_phy.phy_n->tx_rx_cal_phy_saveregs;  	regs[0] = BWN_PHY_READ(mac, BWN_NPHY_RFSEQCA); 	if (core == 0) { 		regs[1] = BWN_PHY_READ(mac, BWN_NPHY_AFECTL_C1); 		regs[2] = BWN_PHY_READ(mac, BWN_NPHY_AFECTL_OVER1); 	} else { 		regs[1] = BWN_PHY_READ(mac, BWN_NPHY_AFECTL_C2); 		regs[2] = BWN_PHY_READ(mac, BWN_NPHY_AFECTL_OVER); 	} 	regs[3] = BWN_PHY_READ(mac, BWN_NPHY_RFCTL_INTC1); 	regs[4] = BWN_PHY_READ(mac, BWN_NPHY_RFCTL_INTC2); 	regs[5] = BWN_PHY_READ(mac, BWN_NPHY_RFCTL_RSSIO1); 	regs[6] = BWN_PHY_READ(mac, BWN_NPHY_RFCTL_RSSIO2); 	regs[7] = BWN_PHY_READ(mac, BWN_NPHY_TXF_40CO_B1S1); 	regs[8] = BWN_PHY_READ(mac, BWN_NPHY_RFCTL_OVER); 	regs[9] = BWN_PHY_READ(mac, BWN_NPHY_PAPD_EN0); 	regs[10] = BWN_PHY_READ(mac, BWN_NPHY_PAPD_EN1);  	BWN_PHY_MASK(mac, BWN_NPHY_PAPD_EN0, ~0x0001); 	BWN_PHY_MASK(mac, BWN_NPHY_PAPD_EN1, ~0x0001);  	BWN_PHY_SETMASK(mac, BWN_NPHY_RFSEQCA, 			~BWN_NPHY_RFSEQCA_RXDIS& 0xFFFF, 			((1 - core)<< BWN_NPHY_RFSEQCA_RXDIS_SHIFT)); 	BWN_PHY_SETMASK(mac, BWN_NPHY_RFSEQCA, ~BWN_NPHY_RFSEQCA_TXEN, 			((1 - core)<< BWN_NPHY_RFSEQCA_TXEN_SHIFT)); 	BWN_PHY_SETMASK(mac, BWN_NPHY_RFSEQCA, ~BWN_NPHY_RFSEQCA_RXEN, 			(core<< BWN_NPHY_RFSEQCA_RXEN_SHIFT)); 	BWN_PHY_SETMASK(mac, BWN_NPHY_RFSEQCA, ~BWN_NPHY_RFSEQCA_TXDIS, 			(core<< BWN_NPHY_RFSEQCA_TXDIS_SHIFT));  	if (core == 0) { 		BWN_PHY_MASK(mac, BWN_NPHY_AFECTL_C1, ~0x0007); 		BWN_PHY_SET(mac, BWN_NPHY_AFECTL_OVER1, 0x0007); 	} else { 		BWN_PHY_MASK(mac, BWN_NPHY_AFECTL_C2, ~0x0007); 		BWN_PHY_SET(mac, BWN_NPHY_AFECTL_OVER, 0x0007); 	}  	bwn_nphy_rf_ctl_intc_override(mac, N_INTC_OVERRIDE_PA, 0, 3); 	bwn_nphy_rf_ctl_override(mac, 8, 0, 3, false); 	bwn_nphy_force_rf_sequence(mac, BWN_RFSEQ_RX2TX);  	if (core == 0) { 		rxval = 1; 		txval = 8; 	} else { 		rxval = 4; 		txval = 2; 	} 	bwn_nphy_rf_ctl_intc_override(mac, N_INTC_OVERRIDE_TRSW, rxval, 				      core + 1); 	bwn_nphy_rf_ctl_intc_override(mac, N_INTC_OVERRIDE_TRSW, txval, 				      2 - core); }
endif|#
directive|endif
end_endif

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/CalcRxIqComp */
end_comment

begin_function
specifier|static
name|void
name|bwn_nphy_calc_rx_iq_comp
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint8_t
name|mask
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int32_t
name|iq
decl_stmt|;
name|uint32_t
name|ii
decl_stmt|;
name|uint32_t
name|qq
decl_stmt|;
name|int
name|iq_nbits
decl_stmt|,
name|qq_nbits
decl_stmt|;
name|int
name|arsh
decl_stmt|,
name|brsh
decl_stmt|;
name|uint16_t
name|tmp
decl_stmt|,
name|a
decl_stmt|,
name|b
decl_stmt|;
name|struct
name|bwn_nphy_iq_est
name|est
decl_stmt|;
name|struct
name|bwn_phy_n_iq_comp
name|old
decl_stmt|;
name|struct
name|bwn_phy_n_iq_comp
name|new
init|=
block|{ }
decl_stmt|;
name|bool
name|error
init|=
name|false
decl_stmt|;
if|if
condition|(
name|mask
operator|==
literal|0
condition|)
return|return;
name|bwn_nphy_rx_iq_coeffs
argument_list|(
name|mac
argument_list|,
name|false
argument_list|,
operator|&
name|old
argument_list|)
expr_stmt|;
name|bwn_nphy_rx_iq_coeffs
argument_list|(
name|mac
argument_list|,
name|true
argument_list|,
operator|&
name|new
argument_list|)
expr_stmt|;
name|bwn_nphy_rx_iq_est
argument_list|(
name|mac
argument_list|,
operator|&
name|est
argument_list|,
literal|0x4000
argument_list|,
literal|32
argument_list|,
name|false
argument_list|)
expr_stmt|;
name|new
operator|=
name|old
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|==
literal|0
operator|&&
operator|(
name|mask
operator|&
literal|1
operator|)
condition|)
block|{
name|iq
operator|=
name|est
operator|.
name|iq0_prod
expr_stmt|;
name|ii
operator|=
name|est
operator|.
name|i0_pwr
expr_stmt|;
name|qq
operator|=
name|est
operator|.
name|q0_pwr
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|i
operator|==
literal|1
operator|&&
operator|(
name|mask
operator|&
literal|2
operator|)
condition|)
block|{
name|iq
operator|=
name|est
operator|.
name|iq1_prod
expr_stmt|;
name|ii
operator|=
name|est
operator|.
name|i1_pwr
expr_stmt|;
name|qq
operator|=
name|est
operator|.
name|q1_pwr
expr_stmt|;
block|}
else|else
block|{
continue|continue;
block|}
if|if
condition|(
name|ii
operator|+
name|qq
operator|<
literal|2
condition|)
block|{
name|error
operator|=
name|true
expr_stmt|;
break|break;
block|}
name|iq_nbits
operator|=
name|fls
argument_list|(
name|abs
argument_list|(
name|iq
argument_list|)
argument_list|)
expr_stmt|;
name|qq_nbits
operator|=
name|fls
argument_list|(
name|qq
argument_list|)
expr_stmt|;
name|arsh
operator|=
name|iq_nbits
operator|-
literal|20
expr_stmt|;
if|if
condition|(
name|arsh
operator|>=
literal|0
condition|)
block|{
name|a
operator|=
operator|-
operator|(
operator|(
name|iq
operator|<<
operator|(
literal|30
operator|-
name|iq_nbits
operator|)
operator|)
operator|+
operator|(
name|ii
operator|>>
operator|(
literal|1
operator|+
name|arsh
operator|)
operator|)
operator|)
expr_stmt|;
name|tmp
operator|=
name|ii
operator|>>
name|arsh
expr_stmt|;
block|}
else|else
block|{
name|a
operator|=
operator|-
operator|(
operator|(
name|iq
operator|<<
operator|(
literal|30
operator|-
name|iq_nbits
operator|)
operator|)
operator|+
operator|(
name|ii
operator|<<
operator|(
operator|-
literal|1
operator|-
name|arsh
operator|)
operator|)
operator|)
expr_stmt|;
name|tmp
operator|=
name|ii
operator|<<
operator|-
name|arsh
expr_stmt|;
block|}
if|if
condition|(
name|tmp
operator|==
literal|0
condition|)
block|{
name|error
operator|=
name|true
expr_stmt|;
break|break;
block|}
name|a
operator|/=
name|tmp
expr_stmt|;
name|brsh
operator|=
name|qq_nbits
operator|-
literal|11
expr_stmt|;
if|if
condition|(
name|brsh
operator|>=
literal|0
condition|)
block|{
name|b
operator|=
operator|(
name|qq
operator|<<
operator|(
literal|31
operator|-
name|qq_nbits
operator|)
operator|)
expr_stmt|;
name|tmp
operator|=
name|ii
operator|>>
name|brsh
expr_stmt|;
block|}
else|else
block|{
name|b
operator|=
operator|(
name|qq
operator|<<
operator|(
literal|31
operator|-
name|qq_nbits
operator|)
operator|)
expr_stmt|;
name|tmp
operator|=
name|ii
operator|<<
operator|-
name|brsh
expr_stmt|;
block|}
if|if
condition|(
name|tmp
operator|==
literal|0
condition|)
block|{
name|error
operator|=
name|true
expr_stmt|;
break|break;
block|}
name|b
operator|=
name|bwn_sqrt
argument_list|(
name|mac
argument_list|,
name|b
operator|/
name|tmp
operator|-
name|a
operator|*
name|a
argument_list|)
operator|-
operator|(
literal|1
operator|<<
literal|10
operator|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
literal|0
operator|&&
operator|(
name|mask
operator|&
literal|0x1
operator|)
condition|)
block|{
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|3
condition|)
block|{
name|new
operator|.
name|a0
operator|=
name|a
operator|&
literal|0x3FF
expr_stmt|;
name|new
operator|.
name|b0
operator|=
name|b
operator|&
literal|0x3FF
expr_stmt|;
block|}
else|else
block|{
name|new
operator|.
name|a0
operator|=
name|b
operator|&
literal|0x3FF
expr_stmt|;
name|new
operator|.
name|b0
operator|=
name|a
operator|&
literal|0x3FF
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|i
operator|==
literal|1
operator|&&
operator|(
name|mask
operator|&
literal|0x2
operator|)
condition|)
block|{
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|3
condition|)
block|{
name|new
operator|.
name|a1
operator|=
name|a
operator|&
literal|0x3FF
expr_stmt|;
name|new
operator|.
name|b1
operator|=
name|b
operator|&
literal|0x3FF
expr_stmt|;
block|}
else|else
block|{
name|new
operator|.
name|a1
operator|=
name|b
operator|&
literal|0x3FF
expr_stmt|;
name|new
operator|.
name|b1
operator|=
name|a
operator|&
literal|0x3FF
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|error
condition|)
name|new
operator|=
name|old
expr_stmt|;
name|bwn_nphy_rx_iq_coeffs
argument_list|(
name|mac
argument_list|,
name|true
argument_list|,
operator|&
name|new
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/TxIqWar */
end_comment

begin_function
specifier|static
name|void
name|bwn_nphy_tx_iq_workaround
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|uint16_t
name|array
index|[
literal|4
index|]
decl_stmt|;
name|bwn_ntab_read_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|0xF
argument_list|,
literal|0x50
argument_list|)
argument_list|,
literal|4
argument_list|,
name|array
argument_list|)
expr_stmt|;
name|bwn_shm_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
name|BWN_SHM_SH_NPHY_TXIQW0
argument_list|,
name|array
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|bwn_shm_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
name|BWN_SHM_SH_NPHY_TXIQW1
argument_list|,
name|array
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|bwn_shm_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
name|BWN_SHM_SH_NPHY_TXIQW2
argument_list|,
name|array
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|bwn_shm_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
name|BWN_SHM_SH_NPHY_TXIQW3
argument_list|,
name|array
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/SpurWar */
end_comment

begin_function
specifier|static
name|void
name|bwn_nphy_spur_workaround
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_phy_n
modifier|*
name|nphy
init|=
name|mac
operator|->
name|mac_phy
operator|.
name|phy_n
decl_stmt|;
name|uint8_t
name|channel
init|=
name|bwn_get_chan
argument_list|(
name|mac
argument_list|)
decl_stmt|;
name|int
name|tone
index|[
literal|2
index|]
init|=
block|{
literal|57
block|,
literal|58
block|}
decl_stmt|;
name|uint32_t
name|noise
index|[
literal|2
index|]
init|=
block|{
literal|0x3FF
block|,
literal|0x3FF
block|}
decl_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|<
literal|3
condition|)
block|{
name|BWN_ERRPRINTF
argument_list|(
name|mac
operator|->
name|mac_sc
argument_list|,
literal|"%s: phy rev %d out of range\n"
argument_list|,
name|__func__
argument_list|,
name|mac
operator|->
name|mac_phy
operator|.
name|rev
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|nphy
operator|->
name|hang_avoid
condition|)
name|bwn_nphy_stay_in_carrier_search
argument_list|(
name|mac
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|nphy
operator|->
name|gband_spurwar_en
condition|)
block|{
comment|/* TODO: N PHY Adjust Analog Pfbw (7) */
if|if
condition|(
name|channel
operator|==
literal|11
operator|&&
name|bwn_is_40mhz
argument_list|(
name|mac
argument_list|)
condition|)
empty_stmt|;
comment|/* TODO: N PHY Adjust Min Noise Var(2, tone, noise)*/
else|else
empty_stmt|;
comment|/* TODO: N PHY Adjust Min Noise Var(0, NULL, NULL)*/
comment|/* TODO: N PHY Adjust CRS Min Power (0x1E) */
block|}
if|if
condition|(
name|nphy
operator|->
name|aband_spurwar_en
condition|)
block|{
if|if
condition|(
name|channel
operator|==
literal|54
condition|)
block|{
name|tone
index|[
literal|0
index|]
operator|=
literal|0x20
expr_stmt|;
name|noise
index|[
literal|0
index|]
operator|=
literal|0x25F
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|channel
operator|==
literal|38
operator|||
name|channel
operator|==
literal|102
operator|||
name|channel
operator|==
literal|118
condition|)
block|{
if|if
condition|(
literal|0
comment|/* FIXME */
condition|)
block|{
name|tone
index|[
literal|0
index|]
operator|=
literal|0x20
expr_stmt|;
name|noise
index|[
literal|0
index|]
operator|=
literal|0x21F
expr_stmt|;
block|}
else|else
block|{
name|tone
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|noise
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|channel
operator|==
literal|134
condition|)
block|{
name|tone
index|[
literal|0
index|]
operator|=
literal|0x20
expr_stmt|;
name|noise
index|[
literal|0
index|]
operator|=
literal|0x21F
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|channel
operator|==
literal|151
condition|)
block|{
name|tone
index|[
literal|0
index|]
operator|=
literal|0x10
expr_stmt|;
name|noise
index|[
literal|0
index|]
operator|=
literal|0x23F
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|channel
operator|==
literal|153
operator|||
name|channel
operator|==
literal|161
condition|)
block|{
name|tone
index|[
literal|0
index|]
operator|=
literal|0x30
expr_stmt|;
name|noise
index|[
literal|0
index|]
operator|=
literal|0x23F
expr_stmt|;
block|}
else|else
block|{
name|tone
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|noise
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|tone
index|[
literal|0
index|]
operator|&&
operator|!
name|noise
index|[
literal|0
index|]
condition|)
empty_stmt|;
comment|/* TODO: N PHY Adjust Min Noise Var(1, tone, noise)*/
else|else
empty_stmt|;
comment|/* TODO: N PHY Adjust Min Noise Var(0, NULL, NULL)*/
block|}
if|if
condition|(
name|nphy
operator|->
name|hang_avoid
condition|)
name|bwn_nphy_stay_in_carrier_search
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/TxPwrCtrlCoefSetup */
end_comment

begin_function
specifier|static
name|void
name|bwn_nphy_tx_pwr_ctrl_coef_setup
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_phy_n
modifier|*
name|nphy
init|=
name|mac
operator|->
name|mac_phy
operator|.
name|phy_n
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
name|uint32_t
name|cur_real
decl_stmt|,
name|cur_imag
decl_stmt|,
name|real_part
decl_stmt|,
name|imag_part
decl_stmt|;
name|uint16_t
name|buffer
index|[
literal|7
index|]
decl_stmt|;
if|if
condition|(
name|nphy
operator|->
name|hang_avoid
condition|)
name|bwn_nphy_stay_in_carrier_search
argument_list|(
name|mac
argument_list|,
name|true
argument_list|)
expr_stmt|;
name|bwn_ntab_read_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|15
argument_list|,
literal|80
argument_list|)
argument_list|,
literal|7
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
block|{
name|tmp
operator|=
operator|(
operator|(
name|buffer
index|[
name|i
operator|*
literal|2
index|]
operator|&
literal|0x3FF
operator|)
operator|<<
literal|10
operator|)
operator||
operator|(
name|buffer
index|[
name|i
operator|*
literal|2
operator|+
literal|1
index|]
operator|&
literal|0x3FF
operator|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TABLE_ADDR
argument_list|,
operator|(
operator|(
operator|(
name|i
operator|+
literal|26
operator|)
operator|<<
literal|10
operator|)
operator||
literal|320
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|128
condition|;
name|j
operator|++
control|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TABLE_DATAHI
argument_list|,
operator|(
operator|(
name|tmp
operator|>>
literal|16
operator|)
operator|&
literal|0xFFFF
operator|)
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TABLE_DATALO
argument_list|,
operator|(
name|tmp
operator|&
literal|0xFFFF
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
block|{
name|tmp
operator|=
name|buffer
index|[
literal|5
operator|+
name|i
index|]
expr_stmt|;
name|real_part
operator|=
operator|(
name|tmp
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|imag_part
operator|=
operator|(
name|tmp
operator|&
literal|0xFF
operator|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TABLE_ADDR
argument_list|,
operator|(
operator|(
operator|(
name|i
operator|+
literal|26
operator|)
operator|<<
literal|10
operator|)
operator||
literal|448
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|3
condition|)
block|{
name|cur_real
operator|=
name|real_part
expr_stmt|;
name|cur_imag
operator|=
name|imag_part
expr_stmt|;
name|tmp
operator|=
operator|(
operator|(
name|cur_real
operator|&
literal|0xFF
operator|)
operator|<<
literal|8
operator|)
operator||
operator|(
name|cur_imag
operator|&
literal|0xFF
operator|)
expr_stmt|;
block|}
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|128
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|<
literal|3
condition|)
block|{
name|cur_real
operator|=
operator|(
name|real_part
operator|*
name|loscale
index|[
name|j
index|]
operator|+
literal|128
operator|)
operator|>>
literal|8
expr_stmt|;
name|cur_imag
operator|=
operator|(
name|imag_part
operator|*
name|loscale
index|[
name|j
index|]
operator|+
literal|128
operator|)
operator|>>
literal|8
expr_stmt|;
name|tmp
operator|=
operator|(
operator|(
name|cur_real
operator|&
literal|0xFF
operator|)
operator|<<
literal|8
operator|)
operator||
operator|(
name|cur_imag
operator|&
literal|0xFF
operator|)
expr_stmt|;
block|}
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TABLE_DATAHI
argument_list|,
operator|(
operator|(
name|tmp
operator|>>
literal|16
operator|)
operator|&
literal|0xFFFF
operator|)
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TABLE_DATALO
argument_list|,
operator|(
name|tmp
operator|&
literal|0xFFFF
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|3
condition|)
block|{
name|bwn_shm_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
name|BWN_SHM_SH_NPHY_TXPWR_INDX0
argument_list|,
literal|0xFFFF
argument_list|)
expr_stmt|;
name|bwn_shm_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
name|BWN_SHM_SH_NPHY_TXPWR_INDX1
argument_list|,
literal|0xFFFF
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|nphy
operator|->
name|hang_avoid
condition|)
name|bwn_nphy_stay_in_carrier_search
argument_list|(
name|mac
argument_list|,
name|false
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Restore RSSI Calibration  * http://bcm-v4.sipsolutions.net/802.11/PHY/N/RestoreRssiCal  */
end_comment

begin_function
specifier|static
name|void
name|bwn_nphy_restore_rssi_cal
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_phy_n
modifier|*
name|nphy
init|=
name|mac
operator|->
name|mac_phy
operator|.
name|phy_n
decl_stmt|;
name|uint16_t
modifier|*
name|rssical_radio_regs
init|=
name|NULL
decl_stmt|;
name|uint16_t
modifier|*
name|rssical_phy_regs
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_2G
condition|)
block|{
if|if
condition|(
operator|!
name|nphy
operator|->
name|rssical_chanspec_2G
operator|.
name|center_freq
condition|)
return|return;
name|rssical_radio_regs
operator|=
name|nphy
operator|->
name|rssical_cache
operator|.
name|rssical_radio_regs_2G
expr_stmt|;
name|rssical_phy_regs
operator|=
name|nphy
operator|->
name|rssical_cache
operator|.
name|rssical_phy_regs_2G
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|nphy
operator|->
name|rssical_chanspec_5G
operator|.
name|center_freq
condition|)
return|return;
name|rssical_radio_regs
operator|=
name|nphy
operator|->
name|rssical_cache
operator|.
name|rssical_radio_regs_5G
expr_stmt|;
name|rssical_phy_regs
operator|=
name|nphy
operator|->
name|rssical_cache
operator|.
name|rssical_phy_regs_5G
expr_stmt|;
block|}
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|19
condition|)
block|{
comment|/* TODO */
block|}
elseif|else
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|7
condition|)
block|{
name|BWN_RF_SETMASK
argument_list|(
name|mac
argument_list|,
name|R2057_NB_MASTER_CORE0
argument_list|,
operator|~
name|R2057_VCM_MASK
argument_list|,
name|rssical_radio_regs
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|BWN_RF_SETMASK
argument_list|(
name|mac
argument_list|,
name|R2057_NB_MASTER_CORE1
argument_list|,
operator|~
name|R2057_VCM_MASK
argument_list|,
name|rssical_radio_regs
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BWN_RF_SETMASK
argument_list|(
name|mac
argument_list|,
name|B2056_RX0
operator||
name|B2056_RX_RSSI_MISC
argument_list|,
literal|0xE3
argument_list|,
name|rssical_radio_regs
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|BWN_RF_SETMASK
argument_list|(
name|mac
argument_list|,
name|B2056_RX1
operator||
name|B2056_RX_RSSI_MISC
argument_list|,
literal|0xE3
argument_list|,
name|rssical_radio_regs
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RSSIMC_0I_RSSI_Z
argument_list|,
name|rssical_phy_regs
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RSSIMC_0Q_RSSI_Z
argument_list|,
name|rssical_phy_regs
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RSSIMC_1I_RSSI_Z
argument_list|,
name|rssical_phy_regs
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RSSIMC_1Q_RSSI_Z
argument_list|,
name|rssical_phy_regs
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RSSIMC_0I_RSSI_X
argument_list|,
name|rssical_phy_regs
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RSSIMC_0Q_RSSI_X
argument_list|,
name|rssical_phy_regs
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RSSIMC_1I_RSSI_X
argument_list|,
name|rssical_phy_regs
index|[
literal|6
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RSSIMC_1Q_RSSI_X
argument_list|,
name|rssical_phy_regs
index|[
literal|7
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RSSIMC_0I_RSSI_Y
argument_list|,
name|rssical_phy_regs
index|[
literal|8
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RSSIMC_0Q_RSSI_Y
argument_list|,
name|rssical_phy_regs
index|[
literal|9
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RSSIMC_1I_RSSI_Y
argument_list|,
name|rssical_phy_regs
index|[
literal|10
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RSSIMC_1Q_RSSI_Y
argument_list|,
name|rssical_phy_regs
index|[
literal|11
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_nphy_tx_cal_radio_setup_rev19
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
comment|/* TODO */
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_nphy_tx_cal_radio_setup_rev7
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwn_phy_n
modifier|*
name|nphy
init|=
name|mac
operator|->
name|mac_phy
operator|.
name|phy_n
decl_stmt|;
name|uint16_t
modifier|*
name|save
init|=
name|nphy
operator|->
name|tx_rx_cal_radio_saveregs
decl_stmt|;
name|int
name|core
decl_stmt|,
name|off
decl_stmt|;
name|uint16_t
name|r
decl_stmt|,
name|tmp
decl_stmt|;
for|for
control|(
name|core
operator|=
literal|0
init|;
name|core
operator|<
literal|2
condition|;
name|core
operator|++
control|)
block|{
name|r
operator|=
name|core
condition|?
literal|0x20
else|:
literal|0
expr_stmt|;
name|off
operator|=
name|core
operator|*
literal|11
expr_stmt|;
name|save
index|[
name|off
operator|+
literal|0
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
name|r
operator|+
name|R2057_TX0_TX_SSI_MASTER
argument_list|)
expr_stmt|;
name|save
index|[
name|off
operator|+
literal|1
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
name|r
operator|+
name|R2057_TX0_IQCAL_VCM_HG
argument_list|)
expr_stmt|;
name|save
index|[
name|off
operator|+
literal|2
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
name|r
operator|+
name|R2057_TX0_IQCAL_IDAC
argument_list|)
expr_stmt|;
name|save
index|[
name|off
operator|+
literal|3
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
name|r
operator|+
name|R2057_TX0_TSSI_VCM
argument_list|)
expr_stmt|;
name|save
index|[
name|off
operator|+
literal|4
index|]
operator|=
literal|0
expr_stmt|;
name|save
index|[
name|off
operator|+
literal|5
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
name|r
operator|+
name|R2057_TX0_TX_SSI_MUX
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rf_rev
operator|!=
literal|5
condition|)
name|save
index|[
name|off
operator|+
literal|6
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
name|r
operator|+
name|R2057_TX0_TSSIA
argument_list|)
expr_stmt|;
name|save
index|[
name|off
operator|+
literal|7
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
name|r
operator|+
name|R2057_TX0_TSSIG
argument_list|)
expr_stmt|;
name|save
index|[
name|off
operator|+
literal|8
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
name|r
operator|+
name|R2057_TX0_TSSI_MISC1
argument_list|)
expr_stmt|;
if|if
condition|(
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_5G
condition|)
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|r
operator|+
name|R2057_TX0_TX_SSI_MASTER
argument_list|,
literal|0xA
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|r
operator|+
name|R2057_TX0_IQCAL_VCM_HG
argument_list|,
literal|0x43
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|r
operator|+
name|R2057_TX0_IQCAL_IDAC
argument_list|,
literal|0x55
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|r
operator|+
name|R2057_TX0_TSSI_VCM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|r
operator|+
name|R2057_TX0_TSSIG
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|nphy
operator|->
name|use_int_tx_iq_lo_cal
condition|)
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|r
operator|+
name|R2057_TX0_TX_SSI_MUX
argument_list|,
literal|0x4
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|true
condition|?
literal|0x31
else|:
literal|0x21
expr_stmt|;
comment|/* TODO */
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|r
operator|+
name|R2057_TX0_TSSIA
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|r
operator|+
name|R2057_TX0_TSSI_MISC1
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|r
operator|+
name|R2057_TX0_TX_SSI_MASTER
argument_list|,
literal|0x6
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|r
operator|+
name|R2057_TX0_IQCAL_VCM_HG
argument_list|,
literal|0x43
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|r
operator|+
name|R2057_TX0_IQCAL_IDAC
argument_list|,
literal|0x55
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|r
operator|+
name|R2057_TX0_TSSI_VCM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rf_rev
operator|!=
literal|5
condition|)
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|r
operator|+
name|R2057_TX0_TSSIA
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|nphy
operator|->
name|use_int_tx_iq_lo_cal
condition|)
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|r
operator|+
name|R2057_TX0_TX_SSI_MUX
argument_list|,
literal|0x6
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|true
condition|?
literal|0x31
else|:
literal|0x21
expr_stmt|;
comment|/* TODO */
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|r
operator|+
name|R2057_TX0_TSSIG
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|r
operator|+
name|R2057_TX0_TSSI_MISC1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/TxCalRadioSetup */
end_comment

begin_function
specifier|static
name|void
name|bwn_nphy_tx_cal_radio_setup
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwn_phy_n
modifier|*
name|nphy
init|=
name|mac
operator|->
name|mac_phy
operator|.
name|phy_n
decl_stmt|;
name|uint16_t
modifier|*
name|save
init|=
name|nphy
operator|->
name|tx_rx_cal_radio_saveregs
decl_stmt|;
name|uint16_t
name|tmp
decl_stmt|;
name|uint8_t
name|offset
decl_stmt|,
name|i
decl_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|19
condition|)
block|{
name|bwn_nphy_tx_cal_radio_setup_rev19
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|7
condition|)
block|{
name|bwn_nphy_tx_cal_radio_setup_rev7
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|3
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
block|{
name|tmp
operator|=
operator|(
name|i
operator|==
literal|0
operator|)
condition|?
literal|0x2000
else|:
literal|0x3000
expr_stmt|;
name|offset
operator|=
name|i
operator|*
literal|11
expr_stmt|;
name|save
index|[
name|offset
operator|+
literal|0
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
name|B2055_CAL_RVARCTL
argument_list|)
expr_stmt|;
name|save
index|[
name|offset
operator|+
literal|1
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
name|B2055_CAL_LPOCTL
argument_list|)
expr_stmt|;
name|save
index|[
name|offset
operator|+
literal|2
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
name|B2055_CAL_TS
argument_list|)
expr_stmt|;
name|save
index|[
name|offset
operator|+
literal|3
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
name|B2055_CAL_RCCALRTS
argument_list|)
expr_stmt|;
name|save
index|[
name|offset
operator|+
literal|4
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
name|B2055_CAL_RCALRTS
argument_list|)
expr_stmt|;
name|save
index|[
name|offset
operator|+
literal|5
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
name|B2055_PADDRV
argument_list|)
expr_stmt|;
name|save
index|[
name|offset
operator|+
literal|6
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
name|B2055_XOCTL1
argument_list|)
expr_stmt|;
name|save
index|[
name|offset
operator|+
literal|7
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
name|B2055_XOCTL2
argument_list|)
expr_stmt|;
name|save
index|[
name|offset
operator|+
literal|8
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
name|B2055_XOREGUL
argument_list|)
expr_stmt|;
name|save
index|[
name|offset
operator|+
literal|9
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
name|B2055_XOMISC
argument_list|)
expr_stmt|;
name|save
index|[
name|offset
operator|+
literal|10
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
name|B2055_PLL_LFC1
argument_list|)
expr_stmt|;
if|if
condition|(
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_5G
condition|)
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|tmp
operator||
name|B2055_CAL_RVARCTL
argument_list|,
literal|0x0A
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|tmp
operator||
name|B2055_CAL_LPOCTL
argument_list|,
literal|0x40
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|tmp
operator||
name|B2055_CAL_TS
argument_list|,
literal|0x55
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|tmp
operator||
name|B2055_CAL_RCCALRTS
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|tmp
operator||
name|B2055_CAL_RCALRTS
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|nphy
operator|->
name|ipa5g_on
condition|)
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|tmp
operator||
name|B2055_PADDRV
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|tmp
operator||
name|B2055_XOCTL1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|tmp
operator||
name|B2055_PADDRV
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|tmp
operator||
name|B2055_XOCTL1
argument_list|,
literal|0x2F
argument_list|)
expr_stmt|;
block|}
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|tmp
operator||
name|B2055_XOCTL2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|tmp
operator||
name|B2055_CAL_RVARCTL
argument_list|,
literal|0x06
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|tmp
operator||
name|B2055_CAL_LPOCTL
argument_list|,
literal|0x40
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|tmp
operator||
name|B2055_CAL_TS
argument_list|,
literal|0x55
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|tmp
operator||
name|B2055_CAL_RCCALRTS
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|tmp
operator||
name|B2055_CAL_RCALRTS
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|tmp
operator||
name|B2055_XOCTL1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|nphy
operator|->
name|ipa2g_on
condition|)
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|tmp
operator||
name|B2055_PADDRV
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|tmp
operator||
name|B2055_XOCTL2
argument_list|,
operator|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|<
literal|5
operator|)
condition|?
literal|0x11
else|:
literal|0x01
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|tmp
operator||
name|B2055_PADDRV
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|tmp
operator||
name|B2055_XOCTL2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|tmp
operator||
name|B2055_XOREGUL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|tmp
operator||
name|B2055_XOMISC
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|tmp
operator||
name|B2055_PLL_LFC1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|save
index|[
literal|0
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
name|B2055_C1_TX_RF_IQCAL1
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2055_C1_TX_RF_IQCAL1
argument_list|,
literal|0x29
argument_list|)
expr_stmt|;
name|save
index|[
literal|1
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
name|B2055_C1_TX_RF_IQCAL2
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2055_C1_TX_RF_IQCAL2
argument_list|,
literal|0x54
argument_list|)
expr_stmt|;
name|save
index|[
literal|2
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
name|B2055_C2_TX_RF_IQCAL1
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2055_C2_TX_RF_IQCAL1
argument_list|,
literal|0x29
argument_list|)
expr_stmt|;
name|save
index|[
literal|3
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
name|B2055_C2_TX_RF_IQCAL2
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2055_C2_TX_RF_IQCAL2
argument_list|,
literal|0x54
argument_list|)
expr_stmt|;
name|save
index|[
literal|3
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
name|B2055_C1_PWRDET_RXTX
argument_list|)
expr_stmt|;
name|save
index|[
literal|4
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
name|B2055_C2_PWRDET_RXTX
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_BANDCTL
argument_list|)
operator|&
name|BWN_NPHY_BANDCTL_5GHZ
operator|)
condition|)
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2055_C1_PWRDET_RXTX
argument_list|,
literal|0x04
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2055_C2_PWRDET_RXTX
argument_list|,
literal|0x04
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2055_C1_PWRDET_RXTX
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|B2055_C2_PWRDET_RXTX
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|<
literal|2
condition|)
block|{
name|BWN_RF_SET
argument_list|(
name|mac
argument_list|,
name|B2055_C1_TX_BB_MXGM
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
name|BWN_RF_SET
argument_list|(
name|mac
argument_list|,
name|B2055_C2_TX_BB_MXGM
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BWN_RF_MASK
argument_list|(
name|mac
argument_list|,
name|B2055_C1_TX_BB_MXGM
argument_list|,
operator|~
literal|0x20
argument_list|)
expr_stmt|;
name|BWN_RF_MASK
argument_list|(
name|mac
argument_list|,
name|B2055_C2_TX_BB_MXGM
argument_list|,
operator|~
literal|0x20
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/UpdateTxCalLadder */
end_comment

begin_function
specifier|static
name|void
name|bwn_nphy_update_tx_cal_ladder
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint16_t
name|core
parameter_list|)
block|{
name|struct
name|bwn_phy_n
modifier|*
name|nphy
init|=
name|mac
operator|->
name|mac_phy
operator|.
name|phy_n
decl_stmt|;
name|int
name|i
decl_stmt|;
name|uint16_t
name|scale
decl_stmt|,
name|entry
decl_stmt|;
name|uint16_t
name|tmp
init|=
name|nphy
operator|->
name|txcal_bbmult
decl_stmt|;
if|if
condition|(
name|core
operator|==
literal|0
condition|)
name|tmp
operator|>>=
literal|8
expr_stmt|;
name|tmp
operator|&=
literal|0xff
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|18
condition|;
name|i
operator|++
control|)
block|{
name|scale
operator|=
operator|(
name|ladder_lo
index|[
name|i
index|]
operator|.
name|percent
operator|*
name|tmp
operator|)
operator|/
literal|100
expr_stmt|;
name|entry
operator|=
operator|(
operator|(
name|scale
operator|&
literal|0xFF
operator|)
operator|<<
literal|8
operator|)
operator||
name|ladder_lo
index|[
name|i
index|]
operator|.
name|g_env
expr_stmt|;
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|15
argument_list|,
name|i
argument_list|)
argument_list|,
name|entry
argument_list|)
expr_stmt|;
name|scale
operator|=
operator|(
name|ladder_iq
index|[
name|i
index|]
operator|.
name|percent
operator|*
name|tmp
operator|)
operator|/
literal|100
expr_stmt|;
name|entry
operator|=
operator|(
operator|(
name|scale
operator|&
literal|0xFF
operator|)
operator|<<
literal|8
operator|)
operator||
name|ladder_iq
index|[
name|i
index|]
operator|.
name|g_env
expr_stmt|;
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|15
argument_list|,
name|i
operator|+
literal|32
argument_list|)
argument_list|,
name|entry
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_nphy_pa_set_tx_dig_filter
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint16_t
name|offset
parameter_list|,
specifier|const
name|int16_t
modifier|*
name|filter
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|offset
operator|=
name|BWN_PHY_N
argument_list|(
name|offset
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|15
condition|;
name|i
operator|++
operator|,
name|offset
operator|++
control|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|offset
argument_list|,
name|filter
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/ExtPaSetTxDigiFilts */
end_comment

begin_function
specifier|static
name|void
name|bwn_nphy_ext_pa_set_tx_dig_filters
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|bwn_nphy_pa_set_tx_dig_filter
argument_list|(
name|mac
argument_list|,
literal|0x2C5
argument_list|,
name|tbl_tx_filter_coef_rev4
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/IpaSetTxDigiFilts */
end_comment

begin_function
specifier|static
name|void
name|bwn_nphy_int_pa_set_tx_dig_filters
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
comment|/* BWN_NPHY_TXF_20CO_S0A1, BWN_NPHY_TXF_40CO_S0A1, unknown */
specifier|static
specifier|const
name|uint16_t
name|offset
index|[]
init|=
block|{
literal|0x186
block|,
literal|0x195
block|,
literal|0x2C5
block|}
decl_stmt|;
specifier|static
specifier|const
name|int16_t
name|dig_filter_phy_rev16
index|[]
init|=
block|{
operator|-
literal|375
block|,
literal|136
block|,
operator|-
literal|407
block|,
literal|208
block|,
operator|-
literal|1527
block|,
literal|956
block|,
literal|93
block|,
literal|186
block|,
literal|93
block|,
literal|230
block|,
operator|-
literal|44
block|,
literal|230
block|,
literal|201
block|,
operator|-
literal|191
block|,
literal|201
block|, 	}
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|3
condition|;
name|i
operator|++
control|)
name|bwn_nphy_pa_set_tx_dig_filter
argument_list|(
name|mac
argument_list|,
name|offset
index|[
name|i
index|]
argument_list|,
name|tbl_tx_filter_coef_rev4
index|[
name|i
index|]
argument_list|)
expr_stmt|;
comment|/* Verified with BCM43227 and BCM43228 */
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|==
literal|16
condition|)
name|bwn_nphy_pa_set_tx_dig_filter
argument_list|(
name|mac
argument_list|,
literal|0x186
argument_list|,
name|dig_filter_phy_rev16
argument_list|)
expr_stmt|;
comment|/* Verified with BCM43131 and BCM43217 */
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|==
literal|17
condition|)
block|{
name|bwn_nphy_pa_set_tx_dig_filter
argument_list|(
name|mac
argument_list|,
literal|0x186
argument_list|,
name|dig_filter_phy_rev16
argument_list|)
expr_stmt|;
name|bwn_nphy_pa_set_tx_dig_filter
argument_list|(
name|mac
argument_list|,
literal|0x195
argument_list|,
name|tbl_tx_filter_coef_rev4
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|bwn_is_40mhz
argument_list|(
name|mac
argument_list|)
condition|)
block|{
name|bwn_nphy_pa_set_tx_dig_filter
argument_list|(
name|mac
argument_list|,
literal|0x186
argument_list|,
name|tbl_tx_filter_coef_rev4
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_5G
condition|)
name|bwn_nphy_pa_set_tx_dig_filter
argument_list|(
name|mac
argument_list|,
literal|0x186
argument_list|,
name|tbl_tx_filter_coef_rev4
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|bwn_get_chan
argument_list|(
name|mac
argument_list|)
operator|==
literal|14
condition|)
name|bwn_nphy_pa_set_tx_dig_filter
argument_list|(
name|mac
argument_list|,
literal|0x186
argument_list|,
name|tbl_tx_filter_coef_rev4
index|[
literal|6
index|]
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/GetTxGain */
end_comment

begin_function
specifier|static
name|struct
name|bwn_nphy_txgains
name|bwn_nphy_get_tx_gains
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_phy_n
modifier|*
name|nphy
init|=
name|mac
operator|->
name|mac_phy
operator|.
name|phy_n
decl_stmt|;
name|uint16_t
name|curr_gain
index|[
literal|2
index|]
decl_stmt|;
name|struct
name|bwn_nphy_txgains
name|target
decl_stmt|;
specifier|const
name|uint32_t
modifier|*
name|table
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|!
name|nphy
operator|->
name|txpwrctrl
condition|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|nphy
operator|->
name|hang_avoid
condition|)
name|bwn_nphy_stay_in_carrier_search
argument_list|(
name|mac
argument_list|,
name|true
argument_list|)
expr_stmt|;
name|bwn_ntab_read_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|7
argument_list|,
literal|0x110
argument_list|)
argument_list|,
literal|2
argument_list|,
name|curr_gain
argument_list|)
expr_stmt|;
if|if
condition|(
name|nphy
operator|->
name|hang_avoid
condition|)
name|bwn_nphy_stay_in_carrier_search
argument_list|(
name|mac
argument_list|,
name|false
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|7
condition|)
block|{
name|target
operator|.
name|ipa
index|[
name|i
index|]
operator|=
name|curr_gain
index|[
name|i
index|]
operator|&
literal|0x0007
expr_stmt|;
name|target
operator|.
name|pad
index|[
name|i
index|]
operator|=
operator|(
name|curr_gain
index|[
name|i
index|]
operator|&
literal|0x00F8
operator|)
operator|>>
literal|3
expr_stmt|;
name|target
operator|.
name|pga
index|[
name|i
index|]
operator|=
operator|(
name|curr_gain
index|[
name|i
index|]
operator|&
literal|0x0F00
operator|)
operator|>>
literal|8
expr_stmt|;
name|target
operator|.
name|txgm
index|[
name|i
index|]
operator|=
operator|(
name|curr_gain
index|[
name|i
index|]
operator|&
literal|0x7000
operator|)
operator|>>
literal|12
expr_stmt|;
name|target
operator|.
name|tx_lpf
index|[
name|i
index|]
operator|=
operator|(
name|curr_gain
index|[
name|i
index|]
operator|&
literal|0x8000
operator|)
operator|>>
literal|15
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|3
condition|)
block|{
name|target
operator|.
name|ipa
index|[
name|i
index|]
operator|=
name|curr_gain
index|[
name|i
index|]
operator|&
literal|0x000F
expr_stmt|;
name|target
operator|.
name|pad
index|[
name|i
index|]
operator|=
operator|(
name|curr_gain
index|[
name|i
index|]
operator|&
literal|0x00F0
operator|)
operator|>>
literal|4
expr_stmt|;
name|target
operator|.
name|pga
index|[
name|i
index|]
operator|=
operator|(
name|curr_gain
index|[
name|i
index|]
operator|&
literal|0x0F00
operator|)
operator|>>
literal|8
expr_stmt|;
name|target
operator|.
name|txgm
index|[
name|i
index|]
operator|=
operator|(
name|curr_gain
index|[
name|i
index|]
operator|&
literal|0x7000
operator|)
operator|>>
literal|12
expr_stmt|;
block|}
else|else
block|{
name|target
operator|.
name|ipa
index|[
name|i
index|]
operator|=
name|curr_gain
index|[
name|i
index|]
operator|&
literal|0x0003
expr_stmt|;
name|target
operator|.
name|pad
index|[
name|i
index|]
operator|=
operator|(
name|curr_gain
index|[
name|i
index|]
operator|&
literal|0x000C
operator|)
operator|>>
literal|2
expr_stmt|;
name|target
operator|.
name|pga
index|[
name|i
index|]
operator|=
operator|(
name|curr_gain
index|[
name|i
index|]
operator|&
literal|0x0070
operator|)
operator|>>
literal|4
expr_stmt|;
name|target
operator|.
name|txgm
index|[
name|i
index|]
operator|=
operator|(
name|curr_gain
index|[
name|i
index|]
operator|&
literal|0x0380
operator|)
operator|>>
literal|7
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|int
name|i
decl_stmt|;
name|uint16_t
name|index
index|[
literal|2
index|]
decl_stmt|;
name|index
index|[
literal|0
index|]
operator|=
operator|(
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_C1_TXPCTL_STAT
argument_list|)
operator|&
name|BWN_NPHY_TXPCTL_STAT_BIDX
operator|)
operator|>>
name|BWN_NPHY_TXPCTL_STAT_BIDX_SHIFT
expr_stmt|;
name|index
index|[
literal|1
index|]
operator|=
operator|(
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_C2_TXPCTL_STAT
argument_list|)
operator|&
name|BWN_NPHY_TXPCTL_STAT_BIDX
operator|)
operator|>>
name|BWN_NPHY_TXPCTL_STAT_BIDX_SHIFT
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
operator|++
name|i
control|)
block|{
name|table
operator|=
name|bwn_nphy_get_tx_gain_table
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|table
condition|)
break|break;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|7
condition|)
block|{
name|target
operator|.
name|ipa
index|[
name|i
index|]
operator|=
operator|(
name|table
index|[
name|index
index|[
name|i
index|]
index|]
operator|>>
literal|16
operator|)
operator|&
literal|0x7
expr_stmt|;
name|target
operator|.
name|pad
index|[
name|i
index|]
operator|=
operator|(
name|table
index|[
name|index
index|[
name|i
index|]
index|]
operator|>>
literal|19
operator|)
operator|&
literal|0x1F
expr_stmt|;
name|target
operator|.
name|pga
index|[
name|i
index|]
operator|=
operator|(
name|table
index|[
name|index
index|[
name|i
index|]
index|]
operator|>>
literal|24
operator|)
operator|&
literal|0xF
expr_stmt|;
name|target
operator|.
name|txgm
index|[
name|i
index|]
operator|=
operator|(
name|table
index|[
name|index
index|[
name|i
index|]
index|]
operator|>>
literal|28
operator|)
operator|&
literal|0x7
expr_stmt|;
name|target
operator|.
name|tx_lpf
index|[
name|i
index|]
operator|=
operator|(
name|table
index|[
name|index
index|[
name|i
index|]
index|]
operator|>>
literal|31
operator|)
operator|&
literal|0x1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|3
condition|)
block|{
name|target
operator|.
name|ipa
index|[
name|i
index|]
operator|=
operator|(
name|table
index|[
name|index
index|[
name|i
index|]
index|]
operator|>>
literal|16
operator|)
operator|&
literal|0xF
expr_stmt|;
name|target
operator|.
name|pad
index|[
name|i
index|]
operator|=
operator|(
name|table
index|[
name|index
index|[
name|i
index|]
index|]
operator|>>
literal|20
operator|)
operator|&
literal|0xF
expr_stmt|;
name|target
operator|.
name|pga
index|[
name|i
index|]
operator|=
operator|(
name|table
index|[
name|index
index|[
name|i
index|]
index|]
operator|>>
literal|24
operator|)
operator|&
literal|0xF
expr_stmt|;
name|target
operator|.
name|txgm
index|[
name|i
index|]
operator|=
operator|(
name|table
index|[
name|index
index|[
name|i
index|]
index|]
operator|>>
literal|28
operator|)
operator|&
literal|0xF
expr_stmt|;
block|}
else|else
block|{
name|target
operator|.
name|ipa
index|[
name|i
index|]
operator|=
operator|(
name|table
index|[
name|index
index|[
name|i
index|]
index|]
operator|>>
literal|16
operator|)
operator|&
literal|0x3
expr_stmt|;
name|target
operator|.
name|pad
index|[
name|i
index|]
operator|=
operator|(
name|table
index|[
name|index
index|[
name|i
index|]
index|]
operator|>>
literal|18
operator|)
operator|&
literal|0x3
expr_stmt|;
name|target
operator|.
name|pga
index|[
name|i
index|]
operator|=
operator|(
name|table
index|[
name|index
index|[
name|i
index|]
index|]
operator|>>
literal|20
operator|)
operator|&
literal|0x7
expr_stmt|;
name|target
operator|.
name|txgm
index|[
name|i
index|]
operator|=
operator|(
name|table
index|[
name|index
index|[
name|i
index|]
index|]
operator|>>
literal|23
operator|)
operator|&
literal|0x7
expr_stmt|;
block|}
block|}
block|}
return|return
name|target
return|;
block|}
end_function

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/TxCalPhyCleanup */
end_comment

begin_function
specifier|static
name|void
name|bwn_nphy_tx_cal_phy_cleanup
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|uint16_t
modifier|*
name|regs
init|=
name|mac
operator|->
name|mac_phy
operator|.
name|phy_n
operator|->
name|tx_rx_cal_phy_saveregs
decl_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|3
condition|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_C1
argument_list|,
name|regs
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_C2
argument_list|,
name|regs
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_OVER1
argument_list|,
name|regs
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_OVER
argument_list|,
name|regs
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_BBCFG
argument_list|,
name|regs
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|8
argument_list|,
literal|3
argument_list|)
argument_list|,
name|regs
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|8
argument_list|,
literal|19
argument_list|)
argument_list|,
name|regs
index|[
literal|6
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_INTC1
argument_list|,
name|regs
index|[
literal|7
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_INTC2
argument_list|,
name|regs
index|[
literal|8
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_PAPD_EN0
argument_list|,
name|regs
index|[
literal|9
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_PAPD_EN1
argument_list|,
name|regs
index|[
literal|10
index|]
argument_list|)
expr_stmt|;
name|bwn_nphy_reset_cca
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_C1
argument_list|,
literal|0x0FFF
argument_list|,
name|regs
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_C2
argument_list|,
literal|0x0FFF
argument_list|,
name|regs
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_OVER
argument_list|,
name|regs
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|8
argument_list|,
literal|2
argument_list|)
argument_list|,
name|regs
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|8
argument_list|,
literal|18
argument_list|)
argument_list|,
name|regs
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_INTC1
argument_list|,
name|regs
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_INTC2
argument_list|,
name|regs
index|[
literal|6
index|]
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/TxCalPhySetup */
end_comment

begin_function
specifier|static
name|void
name|bwn_nphy_tx_cal_phy_setup
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwn_phy_n
modifier|*
name|nphy
init|=
name|mac
operator|->
name|mac_phy
operator|.
name|phy_n
decl_stmt|;
name|uint16_t
modifier|*
name|regs
init|=
name|mac
operator|->
name|mac_phy
operator|.
name|phy_n
operator|->
name|tx_rx_cal_phy_saveregs
decl_stmt|;
name|uint16_t
name|tmp
decl_stmt|;
name|regs
index|[
literal|0
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_C1
argument_list|)
expr_stmt|;
name|regs
index|[
literal|1
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_C2
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|3
condition|)
block|{
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_C1
argument_list|,
literal|0xF0FF
argument_list|,
literal|0x0A00
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_C2
argument_list|,
literal|0xF0FF
argument_list|,
literal|0x0A00
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_OVER1
argument_list|)
expr_stmt|;
name|regs
index|[
literal|2
index|]
operator|=
name|tmp
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_OVER1
argument_list|,
name|tmp
operator||
literal|0x0600
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_OVER
argument_list|)
expr_stmt|;
name|regs
index|[
literal|3
index|]
operator|=
name|tmp
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_OVER
argument_list|,
name|tmp
operator||
literal|0x0600
argument_list|)
expr_stmt|;
name|regs
index|[
literal|4
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_BBCFG
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_BBCFG
argument_list|,
operator|~
name|BWN_NPHY_BBCFG_RSTRX
operator|&
literal|0xFFFF
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|bwn_ntab_read
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|8
argument_list|,
literal|3
argument_list|)
argument_list|)
expr_stmt|;
name|regs
index|[
literal|5
index|]
operator|=
name|tmp
expr_stmt|;
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|8
argument_list|,
literal|3
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|bwn_ntab_read
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|8
argument_list|,
literal|19
argument_list|)
argument_list|)
expr_stmt|;
name|regs
index|[
literal|6
index|]
operator|=
name|tmp
expr_stmt|;
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|8
argument_list|,
literal|19
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|regs
index|[
literal|7
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_INTC1
argument_list|)
expr_stmt|;
name|regs
index|[
literal|8
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_INTC2
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|nphy
operator|->
name|use_int_tx_iq_lo_cal
condition|)
name|bwn_nphy_rf_ctl_intc_override
argument_list|(
name|mac
argument_list|,
name|N_INTC_OVERRIDE_PA
argument_list|,
literal|1
argument_list|,
literal|3
argument_list|)
expr_stmt|;
else|else
name|bwn_nphy_rf_ctl_intc_override
argument_list|(
name|mac
argument_list|,
name|N_INTC_OVERRIDE_PA
argument_list|,
literal|0
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|bwn_nphy_rf_ctl_intc_override
argument_list|(
name|mac
argument_list|,
name|N_INTC_OVERRIDE_TRSW
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|bwn_nphy_rf_ctl_intc_override
argument_list|(
name|mac
argument_list|,
name|N_INTC_OVERRIDE_TRSW
argument_list|,
literal|8
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|regs
index|[
literal|9
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_PAPD_EN0
argument_list|)
expr_stmt|;
name|regs
index|[
literal|10
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_PAPD_EN1
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_PAPD_EN0
argument_list|,
operator|~
literal|0x0001
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_PAPD_EN1
argument_list|,
operator|~
literal|0x0001
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|bwn_nphy_read_lpf_ctl
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|19
condition|)
name|bwn_nphy_rf_ctl_override_rev19
argument_list|(
name|mac
argument_list|,
literal|0x80
argument_list|,
name|tmp
argument_list|,
literal|0
argument_list|,
name|false
argument_list|,
literal|1
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|7
condition|)
name|bwn_nphy_rf_ctl_override_rev7
argument_list|(
name|mac
argument_list|,
literal|0x80
argument_list|,
name|tmp
argument_list|,
literal|0
argument_list|,
name|false
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|nphy
operator|->
name|use_int_tx_iq_lo_cal
operator|&&
name|true
comment|/* FIXME */
condition|)
block|{
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|19
condition|)
block|{
name|bwn_nphy_rf_ctl_override_rev19
argument_list|(
name|mac
argument_list|,
literal|0x8
argument_list|,
literal|0
argument_list|,
literal|0x3
argument_list|,
name|false
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|8
condition|)
block|{
name|bwn_nphy_rf_ctl_override_rev7
argument_list|(
name|mac
argument_list|,
literal|0x8
argument_list|,
literal|0
argument_list|,
literal|0x3
argument_list|,
name|false
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|phy
operator|->
name|rev
operator|==
literal|7
condition|)
block|{
name|BWN_RF_SETMASK
argument_list|(
name|mac
argument_list|,
name|R2057_OVR_REG0
argument_list|,
literal|1
operator|<<
literal|4
argument_list|,
literal|1
operator|<<
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_2G
condition|)
block|{
name|BWN_RF_SETMASK
argument_list|(
name|mac
argument_list|,
name|R2057_PAD2G_TUNE_PUS_CORE0
argument_list|,
operator|~
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_RF_SETMASK
argument_list|(
name|mac
argument_list|,
name|R2057_PAD2G_TUNE_PUS_CORE1
argument_list|,
operator|~
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BWN_RF_SETMASK
argument_list|(
name|mac
argument_list|,
name|R2057_IPA5G_CASCOFFV_PU_CORE0
argument_list|,
operator|~
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_RF_SETMASK
argument_list|(
name|mac
argument_list|,
name|R2057_IPA5G_CASCOFFV_PU_CORE1
argument_list|,
operator|~
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
else|else
block|{
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_C1
argument_list|,
literal|0x0FFF
argument_list|,
literal|0xA000
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_C2
argument_list|,
literal|0x0FFF
argument_list|,
literal|0xA000
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_OVER
argument_list|)
expr_stmt|;
name|regs
index|[
literal|2
index|]
operator|=
name|tmp
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_OVER
argument_list|,
name|tmp
operator||
literal|0x3000
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|bwn_ntab_read
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|8
argument_list|,
literal|2
argument_list|)
argument_list|)
expr_stmt|;
name|regs
index|[
literal|3
index|]
operator|=
name|tmp
expr_stmt|;
name|tmp
operator||=
literal|0x2000
expr_stmt|;
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|8
argument_list|,
literal|2
argument_list|)
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|bwn_ntab_read
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|8
argument_list|,
literal|18
argument_list|)
argument_list|)
expr_stmt|;
name|regs
index|[
literal|4
index|]
operator|=
name|tmp
expr_stmt|;
name|tmp
operator||=
literal|0x2000
expr_stmt|;
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|8
argument_list|,
literal|18
argument_list|)
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|regs
index|[
literal|5
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_INTC1
argument_list|)
expr_stmt|;
name|regs
index|[
literal|6
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_INTC2
argument_list|)
expr_stmt|;
if|if
condition|(
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_5G
condition|)
name|tmp
operator|=
literal|0x0180
expr_stmt|;
else|else
name|tmp
operator|=
literal|0x0120
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_INTC1
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_INTC2
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/SaveCal */
end_comment

begin_function
specifier|static
name|void
name|bwn_nphy_save_cal
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwn_phy_n
modifier|*
name|nphy
init|=
name|mac
operator|->
name|mac_phy
operator|.
name|phy_n
decl_stmt|;
name|struct
name|bwn_phy_n_iq_comp
modifier|*
name|rxcal_coeffs
init|=
name|NULL
decl_stmt|;
name|uint16_t
modifier|*
name|txcal_radio_regs
init|=
name|NULL
decl_stmt|;
name|struct
name|bwn_chanspec
modifier|*
name|iqcal_chanspec
decl_stmt|;
name|uint16_t
modifier|*
name|table
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|nphy
operator|->
name|hang_avoid
condition|)
name|bwn_nphy_stay_in_carrier_search
argument_list|(
name|mac
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_2G
condition|)
block|{
name|rxcal_coeffs
operator|=
operator|&
name|nphy
operator|->
name|cal_cache
operator|.
name|rxcal_coeffs_2G
expr_stmt|;
name|txcal_radio_regs
operator|=
name|nphy
operator|->
name|cal_cache
operator|.
name|txcal_radio_regs_2G
expr_stmt|;
name|iqcal_chanspec
operator|=
operator|&
name|nphy
operator|->
name|iqcal_chanspec_2G
expr_stmt|;
name|table
operator|=
name|nphy
operator|->
name|cal_cache
operator|.
name|txcal_coeffs_2G
expr_stmt|;
block|}
else|else
block|{
name|rxcal_coeffs
operator|=
operator|&
name|nphy
operator|->
name|cal_cache
operator|.
name|rxcal_coeffs_5G
expr_stmt|;
name|txcal_radio_regs
operator|=
name|nphy
operator|->
name|cal_cache
operator|.
name|txcal_radio_regs_5G
expr_stmt|;
name|iqcal_chanspec
operator|=
operator|&
name|nphy
operator|->
name|iqcal_chanspec_5G
expr_stmt|;
name|table
operator|=
name|nphy
operator|->
name|cal_cache
operator|.
name|txcal_coeffs_5G
expr_stmt|;
block|}
name|bwn_nphy_rx_iq_coeffs
argument_list|(
name|mac
argument_list|,
name|false
argument_list|,
name|rxcal_coeffs
argument_list|)
expr_stmt|;
comment|/* TODO use some definitions */
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|19
condition|)
block|{
comment|/* TODO */
block|}
elseif|else
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|7
condition|)
block|{
name|txcal_radio_regs
index|[
literal|0
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
name|R2057_TX0_LOFT_FINE_I
argument_list|)
expr_stmt|;
name|txcal_radio_regs
index|[
literal|1
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
name|R2057_TX0_LOFT_FINE_Q
argument_list|)
expr_stmt|;
name|txcal_radio_regs
index|[
literal|4
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
name|R2057_TX0_LOFT_COARSE_I
argument_list|)
expr_stmt|;
name|txcal_radio_regs
index|[
literal|5
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
name|R2057_TX0_LOFT_COARSE_Q
argument_list|)
expr_stmt|;
name|txcal_radio_regs
index|[
literal|2
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
name|R2057_TX1_LOFT_FINE_I
argument_list|)
expr_stmt|;
name|txcal_radio_regs
index|[
literal|3
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
name|R2057_TX1_LOFT_FINE_Q
argument_list|)
expr_stmt|;
name|txcal_radio_regs
index|[
literal|6
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
name|R2057_TX1_LOFT_COARSE_I
argument_list|)
expr_stmt|;
name|txcal_radio_regs
index|[
literal|7
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
name|R2057_TX1_LOFT_COARSE_Q
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|3
condition|)
block|{
name|txcal_radio_regs
index|[
literal|0
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
literal|0x2021
argument_list|)
expr_stmt|;
name|txcal_radio_regs
index|[
literal|1
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
literal|0x2022
argument_list|)
expr_stmt|;
name|txcal_radio_regs
index|[
literal|2
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
literal|0x3021
argument_list|)
expr_stmt|;
name|txcal_radio_regs
index|[
literal|3
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
literal|0x3022
argument_list|)
expr_stmt|;
name|txcal_radio_regs
index|[
literal|4
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
literal|0x2023
argument_list|)
expr_stmt|;
name|txcal_radio_regs
index|[
literal|5
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
literal|0x2024
argument_list|)
expr_stmt|;
name|txcal_radio_regs
index|[
literal|6
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
literal|0x3023
argument_list|)
expr_stmt|;
name|txcal_radio_regs
index|[
literal|7
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
literal|0x3024
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|txcal_radio_regs
index|[
literal|0
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
literal|0x8B
argument_list|)
expr_stmt|;
name|txcal_radio_regs
index|[
literal|1
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
literal|0xBA
argument_list|)
expr_stmt|;
name|txcal_radio_regs
index|[
literal|2
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
literal|0x8D
argument_list|)
expr_stmt|;
name|txcal_radio_regs
index|[
literal|3
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
literal|0xBC
argument_list|)
expr_stmt|;
block|}
name|iqcal_chanspec
operator|->
name|center_freq
operator|=
name|bwn_get_centre_freq
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|iqcal_chanspec
operator|->
name|channel_type
operator|=
name|bwn_get_chan_type
argument_list|(
name|mac
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|bwn_ntab_read_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|15
argument_list|,
literal|80
argument_list|)
argument_list|,
literal|8
argument_list|,
name|table
argument_list|)
expr_stmt|;
if|if
condition|(
name|nphy
operator|->
name|hang_avoid
condition|)
name|bwn_nphy_stay_in_carrier_search
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RestoreCal */
end_comment

begin_function
specifier|static
name|void
name|bwn_nphy_restore_cal
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwn_phy_n
modifier|*
name|nphy
init|=
name|mac
operator|->
name|mac_phy
operator|.
name|phy_n
decl_stmt|;
name|uint16_t
name|coef
index|[
literal|4
index|]
decl_stmt|;
name|uint16_t
modifier|*
name|loft
init|=
name|NULL
decl_stmt|;
name|uint16_t
modifier|*
name|table
init|=
name|NULL
decl_stmt|;
name|int
name|i
decl_stmt|;
name|uint16_t
modifier|*
name|txcal_radio_regs
init|=
name|NULL
decl_stmt|;
name|struct
name|bwn_phy_n_iq_comp
modifier|*
name|rxcal_coeffs
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_2G
condition|)
block|{
if|if
condition|(
operator|!
name|nphy
operator|->
name|iqcal_chanspec_2G
operator|.
name|center_freq
condition|)
return|return;
name|table
operator|=
name|nphy
operator|->
name|cal_cache
operator|.
name|txcal_coeffs_2G
expr_stmt|;
name|loft
operator|=
operator|&
name|nphy
operator|->
name|cal_cache
operator|.
name|txcal_coeffs_2G
index|[
literal|5
index|]
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|nphy
operator|->
name|iqcal_chanspec_5G
operator|.
name|center_freq
condition|)
return|return;
name|table
operator|=
name|nphy
operator|->
name|cal_cache
operator|.
name|txcal_coeffs_5G
expr_stmt|;
name|loft
operator|=
operator|&
name|nphy
operator|->
name|cal_cache
operator|.
name|txcal_coeffs_5G
index|[
literal|5
index|]
expr_stmt|;
block|}
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|15
argument_list|,
literal|80
argument_list|)
argument_list|,
literal|4
argument_list|,
name|table
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|3
condition|)
name|table
index|[
name|i
index|]
operator|=
name|coef
index|[
name|i
index|]
expr_stmt|;
else|else
name|coef
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
block|}
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|15
argument_list|,
literal|88
argument_list|)
argument_list|,
literal|4
argument_list|,
name|coef
argument_list|)
expr_stmt|;
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|15
argument_list|,
literal|85
argument_list|)
argument_list|,
literal|2
argument_list|,
name|loft
argument_list|)
expr_stmt|;
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|15
argument_list|,
literal|93
argument_list|)
argument_list|,
literal|2
argument_list|,
name|loft
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|<
literal|2
condition|)
name|bwn_nphy_tx_iq_workaround
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_2G
condition|)
block|{
name|txcal_radio_regs
operator|=
name|nphy
operator|->
name|cal_cache
operator|.
name|txcal_radio_regs_2G
expr_stmt|;
name|rxcal_coeffs
operator|=
operator|&
name|nphy
operator|->
name|cal_cache
operator|.
name|rxcal_coeffs_2G
expr_stmt|;
block|}
else|else
block|{
name|txcal_radio_regs
operator|=
name|nphy
operator|->
name|cal_cache
operator|.
name|txcal_radio_regs_5G
expr_stmt|;
name|rxcal_coeffs
operator|=
operator|&
name|nphy
operator|->
name|cal_cache
operator|.
name|rxcal_coeffs_5G
expr_stmt|;
block|}
comment|/* TODO use some definitions */
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|19
condition|)
block|{
comment|/* TODO */
block|}
elseif|else
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|7
condition|)
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_TX0_LOFT_FINE_I
argument_list|,
name|txcal_radio_regs
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_TX0_LOFT_FINE_Q
argument_list|,
name|txcal_radio_regs
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_TX0_LOFT_COARSE_I
argument_list|,
name|txcal_radio_regs
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_TX0_LOFT_COARSE_Q
argument_list|,
name|txcal_radio_regs
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_TX1_LOFT_FINE_I
argument_list|,
name|txcal_radio_regs
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_TX1_LOFT_FINE_Q
argument_list|,
name|txcal_radio_regs
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_TX1_LOFT_COARSE_I
argument_list|,
name|txcal_radio_regs
index|[
literal|6
index|]
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|R2057_TX1_LOFT_COARSE_Q
argument_list|,
name|txcal_radio_regs
index|[
literal|7
index|]
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|3
condition|)
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x2021
argument_list|,
name|txcal_radio_regs
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x2022
argument_list|,
name|txcal_radio_regs
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x3021
argument_list|,
name|txcal_radio_regs
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x3022
argument_list|,
name|txcal_radio_regs
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x2023
argument_list|,
name|txcal_radio_regs
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x2024
argument_list|,
name|txcal_radio_regs
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x3023
argument_list|,
name|txcal_radio_regs
index|[
literal|6
index|]
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x3024
argument_list|,
name|txcal_radio_regs
index|[
literal|7
index|]
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x8B
argument_list|,
name|txcal_radio_regs
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0xBA
argument_list|,
name|txcal_radio_regs
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x8D
argument_list|,
name|txcal_radio_regs
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0xBC
argument_list|,
name|txcal_radio_regs
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
block|}
name|bwn_nphy_rx_iq_coeffs
argument_list|(
name|mac
argument_list|,
name|true
argument_list|,
name|rxcal_coeffs
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/CalTxIqlo */
end_comment

begin_function
specifier|static
name|int
name|bwn_nphy_cal_tx_iq_lo
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|struct
name|bwn_nphy_txgains
name|target
parameter_list|,
name|bool
name|full
parameter_list|,
name|bool
name|mphase
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwn_phy_n
modifier|*
name|nphy
init|=
name|mac
operator|->
name|mac_phy
operator|.
name|phy_n
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|int
name|freq
decl_stmt|;
name|bool
name|avoid
init|=
name|false
decl_stmt|;
name|uint8_t
name|length
decl_stmt|;
name|uint16_t
name|tmp
decl_stmt|,
name|core
decl_stmt|,
name|type
decl_stmt|,
name|count
decl_stmt|,
name|max
decl_stmt|,
name|numb
decl_stmt|,
name|last
init|=
literal|0
decl_stmt|,
name|cmd
decl_stmt|;
specifier|const
name|uint16_t
modifier|*
name|table
decl_stmt|;
name|bool
name|phy6or5x
decl_stmt|;
name|uint16_t
name|buffer
index|[
literal|11
index|]
decl_stmt|;
name|uint16_t
name|diq_start
init|=
literal|0
decl_stmt|;
name|uint16_t
name|save
index|[
literal|2
index|]
decl_stmt|;
name|uint16_t
name|gain
index|[
literal|2
index|]
decl_stmt|;
name|struct
name|bwn_nphy_iqcal_params
name|params
index|[
literal|2
index|]
decl_stmt|;
name|bool
name|updated
index|[
literal|2
index|]
init|=
block|{ }
decl_stmt|;
name|bwn_nphy_stay_in_carrier_search
argument_list|(
name|mac
argument_list|,
name|true
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|4
condition|)
block|{
name|avoid
operator|=
name|nphy
operator|->
name|hang_avoid
expr_stmt|;
name|nphy
operator|->
name|hang_avoid
operator|=
name|false
expr_stmt|;
block|}
name|bwn_ntab_read_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|7
argument_list|,
literal|0x110
argument_list|)
argument_list|,
literal|2
argument_list|,
name|save
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
block|{
name|bwn_nphy_iq_cal_gain_params
argument_list|(
name|mac
argument_list|,
name|i
argument_list|,
name|target
argument_list|,
operator|&
name|params
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|gain
index|[
name|i
index|]
operator|=
name|params
index|[
name|i
index|]
operator|.
name|cal_gain
expr_stmt|;
block|}
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|7
argument_list|,
literal|0x110
argument_list|)
argument_list|,
literal|2
argument_list|,
name|gain
argument_list|)
expr_stmt|;
name|bwn_nphy_tx_cal_radio_setup
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|bwn_nphy_tx_cal_phy_setup
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|phy6or5x
operator|=
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|6
operator|||
operator|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|==
literal|5
operator|&&
name|nphy
operator|->
name|ipa2g_on
operator|&&
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_2G
operator|)
expr_stmt|;
if|if
condition|(
name|phy6or5x
condition|)
block|{
if|if
condition|(
name|bwn_is_40mhz
argument_list|(
name|mac
argument_list|)
condition|)
block|{
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|15
argument_list|,
literal|0
argument_list|)
argument_list|,
literal|18
argument_list|,
name|tbl_tx_iqlo_cal_loft_ladder_40
argument_list|)
expr_stmt|;
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|15
argument_list|,
literal|32
argument_list|)
argument_list|,
literal|18
argument_list|,
name|tbl_tx_iqlo_cal_iqimb_ladder_40
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|15
argument_list|,
literal|0
argument_list|)
argument_list|,
literal|18
argument_list|,
name|tbl_tx_iqlo_cal_loft_ladder_20
argument_list|)
expr_stmt|;
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|15
argument_list|,
literal|32
argument_list|)
argument_list|,
literal|18
argument_list|,
name|tbl_tx_iqlo_cal_iqimb_ladder_20
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|19
condition|)
block|{
comment|/* TODO */
block|}
elseif|else
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|7
condition|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_IQLOCAL_CMDGCTL
argument_list|,
literal|0x8AD9
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_IQLOCAL_CMDGCTL
argument_list|,
literal|0x8AA9
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|bwn_is_40mhz
argument_list|(
name|mac
argument_list|)
condition|)
name|freq
operator|=
literal|2500
expr_stmt|;
else|else
name|freq
operator|=
literal|5000
expr_stmt|;
if|if
condition|(
name|nphy
operator|->
name|mphase_cal_phase_id
operator|>
literal|2
condition|)
name|bwn_nphy_run_samples
argument_list|(
name|mac
argument_list|,
operator|(
name|bwn_is_40mhz
argument_list|(
name|mac
argument_list|)
condition|?
literal|40
else|:
literal|20
operator|)
operator|*
literal|8
argument_list|,
literal|0xFFFF
argument_list|,
literal|0
argument_list|,
name|true
argument_list|,
name|false
argument_list|,
name|false
argument_list|)
expr_stmt|;
else|else
name|error
operator|=
name|bwn_nphy_tx_tone
argument_list|(
name|mac
argument_list|,
name|freq
argument_list|,
literal|250
argument_list|,
name|true
argument_list|,
name|false
argument_list|,
name|false
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|nphy
operator|->
name|mphase_cal_phase_id
operator|>
literal|2
condition|)
block|{
name|table
operator|=
name|nphy
operator|->
name|mphase_txcal_bestcoeffs
expr_stmt|;
name|length
operator|=
literal|11
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|<
literal|3
condition|)
name|length
operator|-=
literal|2
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|full
operator|&&
name|nphy
operator|->
name|txiqlocal_coeffsvalid
condition|)
block|{
name|table
operator|=
name|nphy
operator|->
name|txiqlocal_bestc
expr_stmt|;
name|length
operator|=
literal|11
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|<
literal|3
condition|)
name|length
operator|-=
literal|2
expr_stmt|;
block|}
else|else
block|{
name|full
operator|=
name|true
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|3
condition|)
block|{
name|table
operator|=
name|tbl_tx_iqlo_cal_startcoefs_nphyrev3
expr_stmt|;
name|length
operator|=
name|BWN_NTAB_TX_IQLO_CAL_STARTCOEFS_REV3
expr_stmt|;
block|}
else|else
block|{
name|table
operator|=
name|tbl_tx_iqlo_cal_startcoefs
expr_stmt|;
name|length
operator|=
name|BWN_NTAB_TX_IQLO_CAL_STARTCOEFS
expr_stmt|;
block|}
block|}
block|}
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|15
argument_list|,
literal|64
argument_list|)
argument_list|,
name|length
argument_list|,
name|table
argument_list|)
expr_stmt|;
if|if
condition|(
name|full
condition|)
block|{
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|3
condition|)
name|max
operator|=
name|BWN_NTAB_TX_IQLO_CAL_CMDS_FULLCAL_REV3
expr_stmt|;
else|else
name|max
operator|=
name|BWN_NTAB_TX_IQLO_CAL_CMDS_FULLCAL
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|3
condition|)
name|max
operator|=
name|BWN_NTAB_TX_IQLO_CAL_CMDS_RECAL_REV3
expr_stmt|;
else|else
name|max
operator|=
name|BWN_NTAB_TX_IQLO_CAL_CMDS_RECAL
expr_stmt|;
block|}
if|if
condition|(
name|mphase
condition|)
block|{
name|count
operator|=
name|nphy
operator|->
name|mphase_txcal_cmdidx
expr_stmt|;
name|numb
operator|=
name|min
argument_list|(
name|max
argument_list|,
call|(
name|uint16_t
call|)
argument_list|(
name|count
operator|+
name|nphy
operator|->
name|mphase_txcal_numcmds
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|count
operator|=
literal|0
expr_stmt|;
name|numb
operator|=
name|max
expr_stmt|;
block|}
for|for
control|(
init|;
name|count
operator|<
name|numb
condition|;
name|count
operator|++
control|)
block|{
if|if
condition|(
name|full
condition|)
block|{
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|3
condition|)
name|cmd
operator|=
name|tbl_tx_iqlo_cal_cmds_fullcal_nphyrev3
index|[
name|count
index|]
expr_stmt|;
else|else
name|cmd
operator|=
name|tbl_tx_iqlo_cal_cmds_fullcal
index|[
name|count
index|]
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|3
condition|)
name|cmd
operator|=
name|tbl_tx_iqlo_cal_cmds_recal_nphyrev3
index|[
name|count
index|]
expr_stmt|;
else|else
name|cmd
operator|=
name|tbl_tx_iqlo_cal_cmds_recal
index|[
name|count
index|]
expr_stmt|;
block|}
name|core
operator|=
operator|(
name|cmd
operator|&
literal|0x3000
operator|)
operator|>>
literal|12
expr_stmt|;
name|type
operator|=
operator|(
name|cmd
operator|&
literal|0x0F00
operator|)
operator|>>
literal|8
expr_stmt|;
if|if
condition|(
name|phy6or5x
operator|&&
name|updated
index|[
name|core
index|]
operator|==
literal|0
condition|)
block|{
name|bwn_nphy_update_tx_cal_ladder
argument_list|(
name|mac
argument_list|,
name|core
argument_list|)
expr_stmt|;
name|updated
index|[
name|core
index|]
operator|=
name|true
expr_stmt|;
block|}
name|tmp
operator|=
operator|(
name|params
index|[
name|core
index|]
operator|.
name|ncorr
index|[
name|type
index|]
operator|<<
literal|8
operator|)
operator||
literal|0x66
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_IQLOCAL_CMDNNUM
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
literal|1
operator|||
name|type
operator|==
literal|3
operator|||
name|type
operator|==
literal|4
condition|)
block|{
name|buffer
index|[
literal|0
index|]
operator|=
name|bwn_ntab_read
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|15
argument_list|,
literal|69
operator|+
name|core
argument_list|)
argument_list|)
expr_stmt|;
name|diq_start
operator|=
name|buffer
index|[
literal|0
index|]
expr_stmt|;
name|buffer
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|15
argument_list|,
literal|69
operator|+
name|core
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_IQLOCAL_CMD
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2000
condition|;
name|i
operator|++
control|)
block|{
name|tmp
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_IQLOCAL_CMD
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|&
literal|0xC000
condition|)
break|break;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
name|bwn_ntab_read_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|15
argument_list|,
literal|96
argument_list|)
argument_list|,
name|length
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|15
argument_list|,
literal|64
argument_list|)
argument_list|,
name|length
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
literal|1
operator|||
name|type
operator|==
literal|3
operator|||
name|type
operator|==
literal|4
condition|)
name|buffer
index|[
literal|0
index|]
operator|=
name|diq_start
expr_stmt|;
block|}
if|if
condition|(
name|mphase
condition|)
name|nphy
operator|->
name|mphase_txcal_cmdidx
operator|=
operator|(
name|numb
operator|>=
name|max
operator|)
condition|?
literal|0
else|:
name|numb
expr_stmt|;
name|last
operator|=
operator|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|<
literal|3
operator|)
condition|?
literal|6
else|:
literal|7
expr_stmt|;
if|if
condition|(
operator|!
name|mphase
operator|||
name|nphy
operator|->
name|mphase_cal_phase_id
operator|==
name|last
condition|)
block|{
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|15
argument_list|,
literal|96
argument_list|)
argument_list|,
literal|4
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
name|bwn_ntab_read_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|15
argument_list|,
literal|80
argument_list|)
argument_list|,
literal|4
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|<
literal|3
condition|)
block|{
name|buffer
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|buffer
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|buffer
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|buffer
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
block|}
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|15
argument_list|,
literal|88
argument_list|)
argument_list|,
literal|4
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
name|bwn_ntab_read_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|15
argument_list|,
literal|101
argument_list|)
argument_list|,
literal|2
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|15
argument_list|,
literal|85
argument_list|)
argument_list|,
literal|2
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|15
argument_list|,
literal|93
argument_list|)
argument_list|,
literal|2
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
name|length
operator|=
literal|11
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|<
literal|3
condition|)
name|length
operator|-=
literal|2
expr_stmt|;
name|bwn_ntab_read_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|15
argument_list|,
literal|96
argument_list|)
argument_list|,
name|length
argument_list|,
name|nphy
operator|->
name|txiqlocal_bestc
argument_list|)
expr_stmt|;
name|nphy
operator|->
name|txiqlocal_coeffsvalid
operator|=
name|true
expr_stmt|;
name|nphy
operator|->
name|txiqlocal_chanspec
operator|.
name|center_freq
operator|=
name|bwn_get_centre_freq
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|nphy
operator|->
name|txiqlocal_chanspec
operator|.
name|channel_type
operator|=
name|bwn_get_chan_type
argument_list|(
name|mac
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|length
operator|=
literal|11
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|<
literal|3
condition|)
name|length
operator|-=
literal|2
expr_stmt|;
name|bwn_ntab_read_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|15
argument_list|,
literal|96
argument_list|)
argument_list|,
name|length
argument_list|,
name|nphy
operator|->
name|mphase_txcal_bestcoeffs
argument_list|)
expr_stmt|;
block|}
name|bwn_nphy_stop_playback
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_IQLOCAL_CMDGCTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|bwn_nphy_tx_cal_phy_cleanup
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|7
argument_list|,
literal|0x110
argument_list|)
argument_list|,
literal|2
argument_list|,
name|save
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|<
literal|2
operator|&&
operator|(
operator|!
name|mphase
operator|||
name|nphy
operator|->
name|mphase_cal_phase_id
operator|==
name|last
operator|)
condition|)
name|bwn_nphy_tx_iq_workaround
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|4
condition|)
name|nphy
operator|->
name|hang_avoid
operator|=
name|avoid
expr_stmt|;
name|bwn_nphy_stay_in_carrier_search
argument_list|(
name|mac
argument_list|,
name|false
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/ReapplyTxCalCoeffs */
end_comment

begin_function
specifier|static
name|void
name|bwn_nphy_reapply_tx_cal_coeffs
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_phy_n
modifier|*
name|nphy
init|=
name|mac
operator|->
name|mac_phy
operator|.
name|phy_n
decl_stmt|;
name|uint8_t
name|i
decl_stmt|;
name|uint16_t
name|buffer
index|[
literal|7
index|]
decl_stmt|;
name|bool
name|equal
init|=
name|true
decl_stmt|;
if|if
condition|(
operator|!
name|nphy
operator|->
name|txiqlocal_coeffsvalid
operator|||
name|nphy
operator|->
name|txiqlocal_chanspec
operator|.
name|center_freq
operator|!=
name|bwn_get_centre_freq
argument_list|(
name|mac
argument_list|)
operator|||
name|nphy
operator|->
name|txiqlocal_chanspec
operator|.
name|channel_type
operator|!=
name|bwn_get_chan_type
argument_list|(
name|mac
argument_list|,
name|NULL
argument_list|)
condition|)
return|return;
name|bwn_ntab_read_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|15
argument_list|,
literal|80
argument_list|)
argument_list|,
literal|7
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|buffer
index|[
name|i
index|]
operator|!=
name|nphy
operator|->
name|txiqlocal_bestc
index|[
name|i
index|]
condition|)
block|{
name|equal
operator|=
name|false
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
operator|!
name|equal
condition|)
block|{
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|15
argument_list|,
literal|80
argument_list|)
argument_list|,
literal|4
argument_list|,
name|nphy
operator|->
name|txiqlocal_bestc
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
name|buffer
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|15
argument_list|,
literal|88
argument_list|)
argument_list|,
literal|4
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|15
argument_list|,
literal|85
argument_list|)
argument_list|,
literal|2
argument_list|,
operator|&
name|nphy
operator|->
name|txiqlocal_bestc
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|15
argument_list|,
literal|93
argument_list|)
argument_list|,
literal|2
argument_list|,
operator|&
name|nphy
operator|->
name|txiqlocal_bestc
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/CalRxIqRev2 */
end_comment

begin_function
specifier|static
name|int
name|bwn_nphy_rev2_cal_rx_iq
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|struct
name|bwn_nphy_txgains
name|target
parameter_list|,
name|uint8_t
name|type
parameter_list|,
name|bool
name|debug
parameter_list|)
block|{
name|struct
name|bwn_phy_n
modifier|*
name|nphy
init|=
name|mac
operator|->
name|mac_phy
operator|.
name|phy_n
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|index
decl_stmt|;
name|uint8_t
name|rfctl
index|[
literal|2
index|]
decl_stmt|;
name|uint8_t
name|afectl_core
decl_stmt|;
name|uint16_t
name|tmp
index|[
literal|6
index|]
decl_stmt|;
name|uint16_t
name|cur_hpf1
decl_stmt|,
name|cur_hpf2
decl_stmt|,
name|cur_lna
decl_stmt|;
name|uint32_t
name|real
decl_stmt|,
name|imag
decl_stmt|;
name|bwn_band_t
name|band
decl_stmt|;
name|uint8_t
name|use
decl_stmt|;
name|uint16_t
name|cur_hpf
decl_stmt|;
name|uint16_t
name|lna
index|[
literal|3
index|]
init|=
block|{
literal|3
block|,
literal|3
block|,
literal|1
block|}
decl_stmt|;
name|uint16_t
name|hpf1
index|[
literal|3
index|]
init|=
block|{
literal|7
block|,
literal|2
block|,
literal|0
block|}
decl_stmt|;
name|uint16_t
name|hpf2
index|[
literal|3
index|]
init|=
block|{
literal|2
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
name|uint32_t
name|power
index|[
literal|3
index|]
init|=
block|{ }
decl_stmt|;
name|uint16_t
name|gain_save
index|[
literal|2
index|]
decl_stmt|;
name|uint16_t
name|cal_gain
index|[
literal|2
index|]
decl_stmt|;
name|struct
name|bwn_nphy_iqcal_params
name|cal_params
index|[
literal|2
index|]
decl_stmt|;
name|struct
name|bwn_nphy_iq_est
name|est
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|bool
name|playtone
init|=
name|true
decl_stmt|;
name|int
name|desired
init|=
literal|13
decl_stmt|;
name|bwn_nphy_stay_in_carrier_search
argument_list|(
name|mac
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|<
literal|2
condition|)
name|bwn_nphy_reapply_tx_cal_coeffs
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|bwn_ntab_read_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|7
argument_list|,
literal|0x110
argument_list|)
argument_list|,
literal|2
argument_list|,
name|gain_save
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
block|{
name|bwn_nphy_iq_cal_gain_params
argument_list|(
name|mac
argument_list|,
name|i
argument_list|,
name|target
argument_list|,
operator|&
name|cal_params
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|cal_gain
index|[
name|i
index|]
operator|=
name|cal_params
index|[
name|i
index|]
operator|.
name|cal_gain
expr_stmt|;
block|}
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|7
argument_list|,
literal|0x110
argument_list|)
argument_list|,
literal|2
argument_list|,
name|cal_gain
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|==
literal|0
condition|)
block|{
name|rfctl
index|[
literal|0
index|]
operator|=
name|BWN_NPHY_RFCTL_INTC1
expr_stmt|;
name|rfctl
index|[
literal|1
index|]
operator|=
name|BWN_NPHY_RFCTL_INTC2
expr_stmt|;
name|afectl_core
operator|=
name|BWN_NPHY_AFECTL_C1
expr_stmt|;
block|}
else|else
block|{
name|rfctl
index|[
literal|0
index|]
operator|=
name|BWN_NPHY_RFCTL_INTC2
expr_stmt|;
name|rfctl
index|[
literal|1
index|]
operator|=
name|BWN_NPHY_RFCTL_INTC1
expr_stmt|;
name|afectl_core
operator|=
name|BWN_NPHY_AFECTL_C2
expr_stmt|;
block|}
name|tmp
index|[
literal|1
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFSEQCA
argument_list|)
expr_stmt|;
name|tmp
index|[
literal|2
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|afectl_core
argument_list|)
expr_stmt|;
name|tmp
index|[
literal|3
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_OVER
argument_list|)
expr_stmt|;
name|tmp
index|[
literal|4
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|rfctl
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|tmp
index|[
literal|5
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|rfctl
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFSEQCA
argument_list|,
operator|~
name|BWN_NPHY_RFSEQCA_RXDIS
operator|&
literal|0xFFFF
argument_list|,
operator|(
operator|(
literal|1
operator|-
name|i
operator|)
operator|<<
name|BWN_NPHY_RFSEQCA_RXDIS_SHIFT
operator|)
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFSEQCA
argument_list|,
operator|~
name|BWN_NPHY_RFSEQCA_TXEN
argument_list|,
operator|(
literal|1
operator|-
name|i
operator|)
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|afectl_core
argument_list|,
literal|0x0006
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_OVER
argument_list|,
literal|0x0006
argument_list|)
expr_stmt|;
name|band
operator|=
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|nphy
operator|->
name|rxcalparams
operator|&
literal|0xFF000000
condition|)
block|{
if|if
condition|(
name|band
operator|==
name|BWN_BAND_5G
condition|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|rfctl
index|[
literal|0
index|]
argument_list|,
literal|0x140
argument_list|)
expr_stmt|;
else|else
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|rfctl
index|[
literal|0
index|]
argument_list|,
literal|0x110
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|band
operator|==
name|BWN_BAND_5G
condition|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|rfctl
index|[
literal|0
index|]
argument_list|,
literal|0x180
argument_list|)
expr_stmt|;
else|else
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|rfctl
index|[
literal|0
index|]
argument_list|,
literal|0x120
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|band
operator|==
name|BWN_BAND_5G
condition|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|rfctl
index|[
literal|1
index|]
argument_list|,
literal|0x148
argument_list|)
expr_stmt|;
else|else
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|rfctl
index|[
literal|1
index|]
argument_list|,
literal|0x114
argument_list|)
expr_stmt|;
if|if
condition|(
name|nphy
operator|->
name|rxcalparams
operator|&
literal|0x10000
condition|)
block|{
name|BWN_RF_SETMASK
argument_list|(
name|mac
argument_list|,
name|B2055_C1_GENSPARE2
argument_list|,
literal|0xFC
argument_list|,
operator|(
name|i
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
name|BWN_RF_SETMASK
argument_list|(
name|mac
argument_list|,
name|B2055_C2_GENSPARE2
argument_list|,
literal|0xFC
argument_list|,
operator|(
literal|2
operator|-
name|i
operator|)
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|4
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|j
operator|<
literal|3
condition|)
block|{
name|cur_lna
operator|=
name|lna
index|[
name|j
index|]
expr_stmt|;
name|cur_hpf1
operator|=
name|hpf1
index|[
name|j
index|]
expr_stmt|;
name|cur_hpf2
operator|=
name|hpf2
index|[
name|j
index|]
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|power
index|[
literal|1
index|]
operator|>
literal|10000
condition|)
block|{
name|use
operator|=
literal|1
expr_stmt|;
name|cur_hpf
operator|=
name|cur_hpf1
expr_stmt|;
name|index
operator|=
literal|2
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|power
index|[
literal|0
index|]
operator|>
literal|10000
condition|)
block|{
name|use
operator|=
literal|1
expr_stmt|;
name|cur_hpf
operator|=
name|cur_hpf1
expr_stmt|;
name|index
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|index
operator|=
literal|0
expr_stmt|;
name|use
operator|=
literal|2
expr_stmt|;
name|cur_hpf
operator|=
name|cur_hpf2
expr_stmt|;
block|}
block|}
name|cur_lna
operator|=
name|lna
index|[
name|index
index|]
expr_stmt|;
name|cur_hpf1
operator|=
name|hpf1
index|[
name|index
index|]
expr_stmt|;
name|cur_hpf2
operator|=
name|hpf2
index|[
name|index
index|]
expr_stmt|;
name|cur_hpf
operator|+=
name|desired
operator|-
name|bwn_hweight32
argument_list|(
name|power
index|[
name|index
index|]
argument_list|)
expr_stmt|;
name|cur_hpf
operator|=
name|bwn_clamp_val
argument_list|(
name|cur_hpf
argument_list|,
literal|0
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|use
operator|==
literal|1
condition|)
name|cur_hpf1
operator|=
name|cur_hpf
expr_stmt|;
else|else
name|cur_hpf2
operator|=
name|cur_hpf
expr_stmt|;
block|}
name|tmp
index|[
literal|0
index|]
operator|=
operator|(
operator|(
name|cur_hpf2
operator|<<
literal|8
operator|)
operator||
operator|(
name|cur_hpf1
operator|<<
literal|4
operator|)
operator||
operator|(
name|cur_lna
operator|<<
literal|2
operator|)
operator|)
expr_stmt|;
name|bwn_nphy_rf_ctl_override
argument_list|(
name|mac
argument_list|,
literal|0x400
argument_list|,
name|tmp
index|[
literal|0
index|]
argument_list|,
literal|3
argument_list|,
name|false
argument_list|)
expr_stmt|;
name|bwn_nphy_force_rf_sequence
argument_list|(
name|mac
argument_list|,
name|BWN_RFSEQ_RESET2RX
argument_list|)
expr_stmt|;
name|bwn_nphy_stop_playback
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|playtone
condition|)
block|{
name|ret
operator|=
name|bwn_nphy_tx_tone
argument_list|(
name|mac
argument_list|,
literal|4000
argument_list|,
operator|(
name|nphy
operator|->
name|rxcalparams
operator|&
literal|0xFFFF
operator|)
argument_list|,
name|false
argument_list|,
name|false
argument_list|,
name|true
argument_list|)
expr_stmt|;
name|playtone
operator|=
name|false
expr_stmt|;
block|}
else|else
block|{
name|bwn_nphy_run_samples
argument_list|(
name|mac
argument_list|,
literal|160
argument_list|,
literal|0xFFFF
argument_list|,
literal|0
argument_list|,
name|false
argument_list|,
name|false
argument_list|,
name|true
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|j
operator|<
literal|3
condition|)
block|{
name|bwn_nphy_rx_iq_est
argument_list|(
name|mac
argument_list|,
operator|&
name|est
argument_list|,
literal|1024
argument_list|,
literal|32
argument_list|,
name|false
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
literal|0
condition|)
block|{
name|real
operator|=
name|est
operator|.
name|i0_pwr
expr_stmt|;
name|imag
operator|=
name|est
operator|.
name|q0_pwr
expr_stmt|;
block|}
else|else
block|{
name|real
operator|=
name|est
operator|.
name|i1_pwr
expr_stmt|;
name|imag
operator|=
name|est
operator|.
name|q1_pwr
expr_stmt|;
block|}
name|power
index|[
name|i
index|]
operator|=
operator|(
operator|(
name|real
operator|+
name|imag
operator|)
operator|/
literal|1024
operator|)
operator|+
literal|1
expr_stmt|;
block|}
else|else
block|{
name|bwn_nphy_calc_rx_iq_comp
argument_list|(
name|mac
argument_list|,
literal|1
operator|<<
name|i
argument_list|)
expr_stmt|;
block|}
name|bwn_nphy_stop_playback
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
break|break;
block|}
name|BWN_RF_MASK
argument_list|(
name|mac
argument_list|,
name|B2055_C1_GENSPARE2
argument_list|,
literal|0xFC
argument_list|)
expr_stmt|;
name|BWN_RF_MASK
argument_list|(
name|mac
argument_list|,
name|B2055_C2_GENSPARE2
argument_list|,
literal|0xFC
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|rfctl
index|[
literal|1
index|]
argument_list|,
name|tmp
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|rfctl
index|[
literal|0
index|]
argument_list|,
name|tmp
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_OVER
argument_list|,
name|tmp
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|afectl_core
argument_list|,
name|tmp
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFSEQCA
argument_list|,
name|tmp
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
break|break;
block|}
name|bwn_nphy_rf_ctl_override
argument_list|(
name|mac
argument_list|,
literal|0x400
argument_list|,
literal|0
argument_list|,
literal|3
argument_list|,
name|true
argument_list|)
expr_stmt|;
name|bwn_nphy_force_rf_sequence
argument_list|(
name|mac
argument_list|,
name|BWN_RFSEQ_RESET2RX
argument_list|)
expr_stmt|;
name|bwn_ntab_write_bulk
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|7
argument_list|,
literal|0x110
argument_list|)
argument_list|,
literal|2
argument_list|,
name|gain_save
argument_list|)
expr_stmt|;
name|bwn_nphy_stay_in_carrier_search
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bwn_nphy_rev3_cal_rx_iq
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|struct
name|bwn_nphy_txgains
name|target
parameter_list|,
name|uint8_t
name|type
parameter_list|,
name|bool
name|debug
parameter_list|)
block|{
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/CalRxIq */
end_comment

begin_function
specifier|static
name|int
name|bwn_nphy_cal_rx_iq
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|struct
name|bwn_nphy_txgains
name|target
parameter_list|,
name|uint8_t
name|type
parameter_list|,
name|bool
name|debug
parameter_list|)
block|{
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|7
condition|)
name|type
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|3
condition|)
return|return
name|bwn_nphy_rev3_cal_rx_iq
argument_list|(
name|mac
argument_list|,
name|target
argument_list|,
name|type
argument_list|,
name|debug
argument_list|)
return|;
else|else
return|return
name|bwn_nphy_rev2_cal_rx_iq
argument_list|(
name|mac
argument_list|,
name|target
argument_list|,
name|type
argument_list|,
name|debug
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RxCoreSetState */
end_comment

begin_function
specifier|static
name|void
name|bwn_nphy_set_rx_core_state
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint8_t
name|mask
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwn_phy_n
modifier|*
name|nphy
init|=
name|phy
operator|->
name|phy_n
decl_stmt|;
comment|/* uint16_t buf[16]; it's rev3+ */
name|nphy
operator|->
name|phyrxchain
operator|=
name|mask
expr_stmt|;
if|if
condition|(
literal|0
comment|/* FIXME clk */
condition|)
return|return;
name|bwn_mac_suspend
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|nphy
operator|->
name|hang_avoid
condition|)
name|bwn_nphy_stay_in_carrier_search
argument_list|(
name|mac
argument_list|,
name|true
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFSEQCA
argument_list|,
operator|~
name|BWN_NPHY_RFSEQCA_RXEN
argument_list|,
operator|(
name|mask
operator|&
literal|0x3
operator|)
operator|<<
name|BWN_NPHY_RFSEQCA_RXEN_SHIFT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|mask
operator|&
literal|0x3
operator|)
operator|!=
literal|0x3
condition|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_HPANT_SWTHRES
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|3
condition|)
block|{
comment|/* TODO */
block|}
block|}
else|else
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_HPANT_SWTHRES
argument_list|,
literal|0x1E
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|3
condition|)
block|{
comment|/* TODO */
block|}
block|}
name|bwn_nphy_force_rf_sequence
argument_list|(
name|mac
argument_list|,
name|BWN_RFSEQ_RESET2RX
argument_list|)
expr_stmt|;
if|if
condition|(
name|nphy
operator|->
name|hang_avoid
condition|)
name|bwn_nphy_stay_in_carrier_search
argument_list|(
name|mac
argument_list|,
name|false
argument_list|)
expr_stmt|;
name|bwn_mac_enable
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|bwn_txpwr_result_t
name|bwn_nphy_op_recalc_txpower
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|bool
name|ignore_tssi
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwn_phy_n
modifier|*
name|nphy
init|=
name|mac
operator|->
name|mac_phy
operator|.
name|phy_n
decl_stmt|;
name|struct
name|ieee80211_channel
modifier|*
name|channel
init|=
name|bwn_get_channel
argument_list|(
name|mac
argument_list|)
decl_stmt|;
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|struct
name|bwn_ppr
modifier|*
name|ppr
init|=
operator|&
name|nphy
operator|->
name|tx_pwr_max_ppr
decl_stmt|;
name|uint8_t
name|max
decl_stmt|;
comment|/* qdBm */
name|bool
name|tx_pwr_state
decl_stmt|;
if|if
condition|(
name|nphy
operator|->
name|tx_pwr_last_recalc_freq
operator|==
name|bwn_get_centre_freq
argument_list|(
name|mac
argument_list|)
operator|&&
name|nphy
operator|->
name|tx_pwr_last_recalc_limit
operator|==
name|phy
operator|->
name|txpower
condition|)
return|return
name|BWN_TXPWR_RES_DONE
return|;
comment|/* Make sure we have a clean PPR */
name|bwn_ppr_clear
argument_list|(
name|mac
argument_list|,
name|ppr
argument_list|)
expr_stmt|;
comment|/* HW limitations */
name|bwn_ppr_load_max_from_sprom
argument_list|(
name|mac
argument_list|,
name|ppr
argument_list|,
name|BWN_PHY_BAND_2G
argument_list|)
expr_stmt|;
comment|/* XXX TODO: other bands? */
comment|/* Regulatory& user settings */
name|max
operator|=
name|INT_TO_Q52
argument_list|(
name|bwn_get_chan_power
argument_list|(
name|mac
argument_list|,
name|channel
argument_list|)
argument_list|)
expr_stmt|;
comment|/* uint8_t */
if|if
condition|(
name|phy
operator|->
name|txpower
condition|)
name|max
operator|=
name|min
argument_list|(
name|max
argument_list|,
name|INT_TO_Q52
argument_list|(
name|phy
operator|->
name|txpower
argument_list|)
argument_list|)
expr_stmt|;
name|bwn_ppr_apply_max
argument_list|(
name|mac
argument_list|,
name|ppr
argument_list|,
name|max
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
name|mac
operator|->
name|mac_sc
argument_list|,
name|BWN_DEBUG_XMIT_POWER
argument_list|,
literal|"Calculated TX power: "
name|Q52_FMT
literal|"\n"
argument_list|,
name|Q52_ARG
argument_list|(
name|bwn_ppr_get_max
argument_list|(
name|mac
argument_list|,
name|ppr
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
comment|/* TODO: Enable this once we get gains working */
if|#
directive|if
literal|0
comment|/* Some extra gains */
block|hw_gain = 6;
comment|/* N-PHY specific */
block|if (bwn_current_band(mac) == BWN_BAND_2G) 		hw_gain += sprom->antenna_gain.a0; 	else 		hw_gain += sprom->antenna_gain.a1; 	bwn_ppr_add(mac, ppr, -hw_gain);
endif|#
directive|endif
comment|/* Make sure we didn't go too low */
name|bwn_ppr_apply_min
argument_list|(
name|mac
argument_list|,
name|ppr
argument_list|,
name|INT_TO_Q52
argument_list|(
literal|8
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Apply */
name|tx_pwr_state
operator|=
name|nphy
operator|->
name|txpwrctrl
expr_stmt|;
name|bwn_mac_suspend
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|bwn_nphy_tx_power_ctl_setup
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|siba_get_revid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
literal|11
operator|||
name|siba_get_revid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
literal|12
condition|)
block|{
name|BWN_WRITE_SETMASK4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCTL
argument_list|,
operator|~
literal|0
argument_list|,
name|BWN_MACCTL_PHY_LOCK
argument_list|)
expr_stmt|;
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCTL
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|bwn_nphy_tx_power_ctrl
argument_list|(
name|mac
argument_list|,
name|nphy
operator|->
name|txpwrctrl
argument_list|)
expr_stmt|;
if|if
condition|(
name|siba_get_revid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
literal|11
operator|||
name|siba_get_revid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
literal|12
condition|)
name|BWN_WRITE_SETMASK4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCTL
argument_list|,
operator|~
name|BWN_MACCTL_PHY_LOCK
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bwn_mac_enable
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|nphy
operator|->
name|tx_pwr_last_recalc_freq
operator|=
name|bwn_get_centre_freq
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|nphy
operator|->
name|tx_pwr_last_recalc_limit
operator|=
name|phy
operator|->
name|txpower
expr_stmt|;
return|return
name|BWN_TXPWR_RES_DONE
return|;
block|}
end_function

begin_comment
comment|/**************************************************  * N-PHY init  **************************************************/
end_comment

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/MIMOConfig */
end_comment

begin_function
specifier|static
name|void
name|bwn_nphy_update_mimo_config
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|int32_t
name|preamble
parameter_list|)
block|{
name|uint16_t
name|mimocfg
init|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_MIMOCFG
argument_list|)
decl_stmt|;
name|mimocfg
operator||=
name|BWN_NPHY_MIMOCFG_AUTO
expr_stmt|;
if|if
condition|(
name|preamble
operator|==
literal|1
condition|)
name|mimocfg
operator||=
name|BWN_NPHY_MIMOCFG_GFMIX
expr_stmt|;
else|else
name|mimocfg
operator|&=
operator|~
name|BWN_NPHY_MIMOCFG_GFMIX
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_MIMOCFG
argument_list|,
name|mimocfg
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/BPHYInit */
end_comment

begin_function
specifier|static
name|void
name|bwn_nphy_bphy_init
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|unsigned
name|int
name|i
decl_stmt|;
name|uint16_t
name|val
decl_stmt|;
name|val
operator|=
literal|0x1E1F
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_N_BMODE
argument_list|(
literal|0x88
operator|+
name|i
argument_list|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|val
operator|-=
literal|0x202
expr_stmt|;
block|}
name|val
operator|=
literal|0x3E3F
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_N_BMODE
argument_list|(
literal|0x98
operator|+
name|i
argument_list|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|val
operator|-=
literal|0x202
expr_stmt|;
block|}
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_N_BMODE
argument_list|(
literal|0x38
argument_list|)
argument_list|,
literal|0x668
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/SuperSwitchInit */
end_comment

begin_function
specifier|static
name|void
name|bwn_nphy_superswitch_init
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|bool
name|init
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|7
condition|)
return|return;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|3
condition|)
block|{
if|if
condition|(
operator|!
name|init
condition|)
return|return;
if|if
condition|(
literal|0
comment|/* FIXME */
condition|)
block|{
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|9
argument_list|,
literal|2
argument_list|)
argument_list|,
literal|0x211
argument_list|)
expr_stmt|;
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|9
argument_list|,
literal|3
argument_list|)
argument_list|,
literal|0x222
argument_list|)
expr_stmt|;
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|9
argument_list|,
literal|8
argument_list|)
argument_list|,
literal|0x144
argument_list|)
expr_stmt|;
name|bwn_ntab_write
argument_list|(
name|mac
argument_list|,
name|BWN_NTAB16
argument_list|(
literal|9
argument_list|,
literal|12
argument_list|)
argument_list|,
literal|0x188
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_GPIO_LOOEN
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_GPIO_HIOEN
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* XXX handle bhnd bus */
if|if
condition|(
name|bwn_is_bus_siba
argument_list|(
name|mac
argument_list|)
condition|)
block|{
name|siba_gpio_set
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|0xfc00
argument_list|)
expr_stmt|;
block|}
name|BWN_WRITE_SETMASK4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCTL
argument_list|,
operator|~
name|BWN_MACCTL_GPOUT_MASK
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_WRITE_SETMASK2
argument_list|(
name|mac
argument_list|,
name|BWN_GPIO_MASK
argument_list|,
operator|~
literal|0
argument_list|,
literal|0xFC00
argument_list|)
expr_stmt|;
name|BWN_WRITE_SETMASK2
argument_list|(
name|mac
argument_list|,
name|BWN_GPIO_CONTROL
argument_list|,
operator|(
operator|~
literal|0xFC00
operator|&
literal|0xFFFF
operator|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|init
condition|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_LUT_TRSW_LO1
argument_list|,
literal|0x2D8
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_LUT_TRSW_UP1
argument_list|,
literal|0x301
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_LUT_TRSW_LO2
argument_list|,
literal|0x2D8
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_LUT_TRSW_UP2
argument_list|,
literal|0x301
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/Init/N */
end_comment

begin_function
specifier|static
name|int
name|bwn_phy_initn
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwn_phy_n
modifier|*
name|nphy
init|=
name|phy
operator|->
name|phy_n
decl_stmt|;
name|uint8_t
name|tx_pwr_state
decl_stmt|;
name|struct
name|bwn_nphy_txgains
name|target
decl_stmt|;
name|uint16_t
name|tmp
decl_stmt|;
name|bwn_band_t
name|tmp2
decl_stmt|;
name|bool
name|do_rssi_cal
decl_stmt|;
name|uint16_t
name|clip
index|[
literal|2
index|]
decl_stmt|;
name|bool
name|do_cal
init|=
name|false
decl_stmt|;
if|if
condition|(
operator|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|3
operator|)
operator|&&
operator|(
name|siba_sprom_get_bf_lo
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|&
name|BWN_BFL_EXTLNA
operator|)
operator|&&
operator|(
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_2G
operator|)
condition|)
block|{
comment|/* XXX bhnd bus */
if|if
condition|(
name|bwn_is_bus_siba
argument_list|(
name|mac
argument_list|)
condition|)
block|{
name|siba_cc_set32
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
name|SIBA_CC_CHIPCTL
argument_list|,
literal|0x40
argument_list|)
expr_stmt|;
block|}
block|}
name|nphy
operator|->
name|use_int_tx_iq_lo_cal
operator|=
name|bwn_nphy_ipa
argument_list|(
name|mac
argument_list|)
operator|||
name|phy
operator|->
name|rev
operator|>=
literal|7
operator|||
operator|(
name|phy
operator|->
name|rev
operator|>=
literal|5
operator|&&
name|siba_sprom_get_bf2_hi
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|&
name|BWN_BFH2_INTERNDET_TXIQCAL
operator|)
expr_stmt|;
name|nphy
operator|->
name|deaf_count
operator|=
literal|0
expr_stmt|;
name|bwn_nphy_tables_init
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|nphy
operator|->
name|crsminpwr_adjusted
operator|=
name|false
expr_stmt|;
name|nphy
operator|->
name|noisevars_adjusted
operator|=
name|false
expr_stmt|;
comment|/* Clear all overrides */
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|3
condition|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TXF_40CO_B1S1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_OVER
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|7
condition|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_REV7_RF_CTL_OVER3
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_REV7_RF_CTL_OVER4
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_REV7_RF_CTL_OVER5
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_REV7_RF_CTL_OVER6
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|19
condition|)
block|{
comment|/* TODO */
block|}
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TXF_40CO_B1S0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TXF_40CO_B32S1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_OVER
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_INTC1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_INTC2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|<
literal|6
condition|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_INTC3
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_INTC4
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFSEQMODE
argument_list|,
operator|~
operator|(
name|BWN_NPHY_RFSEQMODE_CAOVER
operator||
name|BWN_NPHY_RFSEQMODE_TROVER
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|3
condition|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_OVER1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_OVER
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|<=
literal|2
condition|)
block|{
name|tmp
operator|=
operator|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|==
literal|2
operator|)
condition|?
literal|0x3B
else|:
literal|0x40
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_BPHY_CTL3
argument_list|,
operator|~
name|BWN_NPHY_BPHY_CTL3_SCALE
argument_list|,
name|tmp
operator|<<
name|BWN_NPHY_BPHY_CTL3_SCALE_SHIFT
argument_list|)
expr_stmt|;
block|}
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFESEQ_TX2RX_PUD_20M
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFESEQ_TX2RX_PUD_40M
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
if|if
condition|(
name|siba_sprom_get_bf2_lo
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|&
name|BWN_BFL2_SKWRKFEM_BRD
operator|||
operator|(
name|siba_get_pci_subvendor
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
name|PCI_VENDOR_APPLE
operator|&&
name|siba_get_pci_subdevice
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
name|BCMA_BOARD_TYPE_BCM943224M93
operator|)
condition|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TXREALFD
argument_list|,
literal|0xA0
argument_list|)
expr_stmt|;
else|else
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TXREALFD
argument_list|,
literal|0xB8
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_MIMO_CRSTXEXT
argument_list|,
literal|0xC8
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_PLOAD_CSENSE_EXTLEN
argument_list|,
literal|0x50
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TXRIFS_FRDEL
argument_list|,
literal|0x30
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|<
literal|8
condition|)
name|bwn_nphy_update_mimo_config
argument_list|(
name|mac
argument_list|,
name|nphy
operator|->
name|preamble_override
argument_list|)
expr_stmt|;
name|bwn_nphy_update_txrx_chain
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|<
literal|2
condition|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_DUP40_GFBL
argument_list|,
literal|0xAA8
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_DUP40_BL
argument_list|,
literal|0x9A4
argument_list|)
expr_stmt|;
block|}
name|tmp2
operator|=
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|bwn_nphy_ipa
argument_list|(
name|mac
argument_list|)
condition|)
block|{
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_PAPD_EN0
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_EPS_TABLE_ADJ0
argument_list|,
literal|0x007F
argument_list|,
name|nphy
operator|->
name|papd_epsilon_offset
index|[
literal|0
index|]
operator|<<
literal|7
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_PAPD_EN1
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_EPS_TABLE_ADJ1
argument_list|,
literal|0x007F
argument_list|,
name|nphy
operator|->
name|papd_epsilon_offset
index|[
literal|1
index|]
operator|<<
literal|7
argument_list|)
expr_stmt|;
name|bwn_nphy_int_pa_set_tx_dig_filters
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|5
condition|)
block|{
name|bwn_nphy_ext_pa_set_tx_dig_filters
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
name|bwn_nphy_workarounds
argument_list|(
name|mac
argument_list|)
expr_stmt|;
comment|/* Reset CCA, in init code it differs a little from standard way */
name|bwn_phy_force_clock
argument_list|(
name|mac
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_BBCFG
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_BBCFG
argument_list|,
name|tmp
operator||
name|BWN_NPHY_BBCFG_RSTCCA
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_BBCFG
argument_list|,
name|tmp
operator|&
operator|~
name|BWN_NPHY_BBCFG_RSTCCA
argument_list|)
expr_stmt|;
name|bwn_phy_force_clock
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bwn_mac_phy_clock_set
argument_list|(
name|mac
argument_list|,
name|true
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|<
literal|7
condition|)
block|{
name|bwn_nphy_pa_override
argument_list|(
name|mac
argument_list|,
name|false
argument_list|)
expr_stmt|;
name|bwn_nphy_force_rf_sequence
argument_list|(
name|mac
argument_list|,
name|BWN_RFSEQ_RX2TX
argument_list|)
expr_stmt|;
name|bwn_nphy_force_rf_sequence
argument_list|(
name|mac
argument_list|,
name|BWN_RFSEQ_RESET2RX
argument_list|)
expr_stmt|;
name|bwn_nphy_pa_override
argument_list|(
name|mac
argument_list|,
name|true
argument_list|)
expr_stmt|;
block|}
name|bwn_nphy_classifier
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bwn_nphy_read_clip_detection
argument_list|(
name|mac
argument_list|,
name|clip
argument_list|)
expr_stmt|;
if|if
condition|(
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_2G
condition|)
name|bwn_nphy_bphy_init
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|tx_pwr_state
operator|=
name|nphy
operator|->
name|txpwrctrl
expr_stmt|;
name|bwn_nphy_tx_power_ctrl
argument_list|(
name|mac
argument_list|,
name|false
argument_list|)
expr_stmt|;
name|bwn_nphy_tx_power_fix
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|bwn_nphy_tx_power_ctl_idle_tssi
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|bwn_nphy_tx_power_ctl_setup
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|bwn_nphy_tx_gain_table_upload
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|nphy
operator|->
name|phyrxchain
operator|!=
literal|3
condition|)
name|bwn_nphy_set_rx_core_state
argument_list|(
name|mac
argument_list|,
name|nphy
operator|->
name|phyrxchain
argument_list|)
expr_stmt|;
if|if
condition|(
name|nphy
operator|->
name|mphase_cal_phase_id
operator|>
literal|0
condition|)
empty_stmt|;
comment|/* TODO PHY Periodic Calibration Multi-Phase Restart */
name|do_rssi_cal
operator|=
name|false
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|3
condition|)
block|{
if|if
condition|(
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_2G
condition|)
name|do_rssi_cal
operator|=
operator|!
name|nphy
operator|->
name|rssical_chanspec_2G
operator|.
name|center_freq
expr_stmt|;
else|else
name|do_rssi_cal
operator|=
operator|!
name|nphy
operator|->
name|rssical_chanspec_5G
operator|.
name|center_freq
expr_stmt|;
if|if
condition|(
name|do_rssi_cal
condition|)
name|bwn_nphy_rssi_cal
argument_list|(
name|mac
argument_list|)
expr_stmt|;
else|else
name|bwn_nphy_restore_rssi_cal
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|bwn_nphy_rssi_cal
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|(
operator|(
name|nphy
operator|->
name|measure_hold
operator|&
literal|0x6
operator|)
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_2G
condition|)
name|do_cal
operator|=
operator|!
name|nphy
operator|->
name|iqcal_chanspec_2G
operator|.
name|center_freq
expr_stmt|;
else|else
name|do_cal
operator|=
operator|!
name|nphy
operator|->
name|iqcal_chanspec_5G
operator|.
name|center_freq
expr_stmt|;
if|if
condition|(
name|nphy
operator|->
name|mute
condition|)
name|do_cal
operator|=
name|false
expr_stmt|;
if|if
condition|(
name|do_cal
condition|)
block|{
name|target
operator|=
name|bwn_nphy_get_tx_gains
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|nphy
operator|->
name|antsel_type
operator|==
literal|2
condition|)
name|bwn_nphy_superswitch_init
argument_list|(
name|mac
argument_list|,
name|true
argument_list|)
expr_stmt|;
if|if
condition|(
name|nphy
operator|->
name|perical
operator|!=
literal|2
condition|)
block|{
name|bwn_nphy_rssi_cal
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|3
condition|)
block|{
name|nphy
operator|->
name|cal_orig_pwr_idx
index|[
literal|0
index|]
operator|=
name|nphy
operator|->
name|txpwrindex
index|[
literal|0
index|]
operator|.
name|index_internal
expr_stmt|;
name|nphy
operator|->
name|cal_orig_pwr_idx
index|[
literal|1
index|]
operator|=
name|nphy
operator|->
name|txpwrindex
index|[
literal|1
index|]
operator|.
name|index_internal
expr_stmt|;
comment|/* TODO N PHY Pre Calibrate TX Gain */
name|target
operator|=
name|bwn_nphy_get_tx_gains
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|bwn_nphy_cal_tx_iq_lo
argument_list|(
name|mac
argument_list|,
name|target
argument_list|,
name|true
argument_list|,
name|false
argument_list|)
condition|)
if|if
condition|(
name|bwn_nphy_cal_rx_iq
argument_list|(
name|mac
argument_list|,
name|target
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|)
operator|==
literal|0
condition|)
name|bwn_nphy_save_cal
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|nphy
operator|->
name|mphase_cal_phase_id
operator|==
literal|0
condition|)
empty_stmt|;
comment|/* N PHY Periodic Calibration with arg 3 */
block|}
else|else
block|{
name|bwn_nphy_restore_cal
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
block|}
name|bwn_nphy_tx_pwr_ctrl_coef_setup
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|bwn_nphy_tx_power_ctrl
argument_list|(
name|mac
argument_list|,
name|tx_pwr_state
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TXMACIF_HOLDOFF
argument_list|,
literal|0x0015
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_TXMACDELAY
argument_list|,
literal|0x0320
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|3
operator|&&
name|phy
operator|->
name|rev
operator|<=
literal|6
condition|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_PLOAD_CSENSE_EXTLEN
argument_list|,
literal|0x0032
argument_list|)
expr_stmt|;
name|bwn_nphy_tx_lpf_bw
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|3
condition|)
name|bwn_nphy_spur_workaround
argument_list|(
name|mac
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**************************************************  * Channel switching ops.  **************************************************/
end_comment

begin_function
specifier|static
name|void
name|bwn_chantab_phy_upload
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
specifier|const
name|struct
name|bwn_phy_n_sfo_cfg
modifier|*
name|e
parameter_list|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_BW1A
argument_list|,
name|e
operator|->
name|phy_bw1a
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_BW2
argument_list|,
name|e
operator|->
name|phy_bw2
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_BW3
argument_list|,
name|e
operator|->
name|phy_bw3
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_BW4
argument_list|,
name|e
operator|->
name|phy_bw4
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_BW5
argument_list|,
name|e
operator|->
name|phy_bw5
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_BW6
argument_list|,
name|e
operator|->
name|phy_bw6
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PmuSpurAvoid */
end_comment

begin_function
specifier|static
name|void
name|bwn_nphy_pmu_spur_avoid
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|bool
name|avoid
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
comment|/* XXX bhnd */
if|if
condition|(
name|bwn_is_bus_siba
argument_list|(
name|mac
argument_list|)
condition|)
block|{
name|DPRINTF
argument_list|(
name|sc
argument_list|,
name|BWN_DEBUG_RESET
argument_list|,
literal|"%s: spuravoid %d\n"
argument_list|,
name|__func__
argument_list|,
name|avoid
argument_list|)
expr_stmt|;
name|siba_pmu_spuravoid_pllupdate
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
name|avoid
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/ChanspecSetup */
end_comment

begin_function
specifier|static
name|void
name|bwn_nphy_channel_setup
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
specifier|const
name|struct
name|bwn_phy_n_sfo_cfg
modifier|*
name|e
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
name|new_channel
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwn_phy_n
modifier|*
name|nphy
init|=
name|mac
operator|->
name|mac_phy
operator|.
name|phy_n
decl_stmt|;
name|int
name|ch
init|=
name|new_channel
operator|->
name|ic_ieee
decl_stmt|;
name|uint16_t
name|tmp16
decl_stmt|;
if|if
condition|(
name|bwn_channel_band
argument_list|(
name|mac
argument_list|,
name|new_channel
argument_list|)
operator|==
name|BWN_BAND_5G
condition|)
block|{
name|DPRINTF
argument_list|(
name|sc
argument_list|,
name|BWN_DEBUG_RESET
argument_list|,
literal|"%s: BAND_5G; chan=%d\n"
argument_list|,
name|__func__
argument_list|,
name|ch
argument_list|)
expr_stmt|;
comment|/* Switch to 2 GHz for a moment to access BWN_PHY_B_BBCFG */
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_BANDCTL
argument_list|,
operator|~
name|BWN_NPHY_BANDCTL_5GHZ
argument_list|)
expr_stmt|;
name|tmp16
operator|=
name|BWN_READ_2
argument_list|(
name|mac
argument_list|,
name|BWN_PSM_PHY_HDR
argument_list|)
expr_stmt|;
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
name|BWN_PSM_PHY_HDR
argument_list|,
name|tmp16
operator||
literal|4
argument_list|)
expr_stmt|;
comment|/* Put BPHY in the reset */
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_B_BBCFG
argument_list|,
name|BWN_PHY_B_BBCFG_RSTCCA
operator||
name|BWN_PHY_B_BBCFG_RSTRX
argument_list|)
expr_stmt|;
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
name|BWN_PSM_PHY_HDR
argument_list|,
name|tmp16
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_BANDCTL
argument_list|,
name|BWN_NPHY_BANDCTL_5GHZ
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|bwn_channel_band
argument_list|(
name|mac
argument_list|,
name|new_channel
argument_list|)
operator|==
name|BWN_BAND_2G
condition|)
block|{
name|DPRINTF
argument_list|(
name|sc
argument_list|,
name|BWN_DEBUG_RESET
argument_list|,
literal|"%s: BAND_2G; chan=%d\n"
argument_list|,
name|__func__
argument_list|,
name|ch
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_BANDCTL
argument_list|,
operator|~
name|BWN_NPHY_BANDCTL_5GHZ
argument_list|)
expr_stmt|;
name|tmp16
operator|=
name|BWN_READ_2
argument_list|(
name|mac
argument_list|,
name|BWN_PSM_PHY_HDR
argument_list|)
expr_stmt|;
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
name|BWN_PSM_PHY_HDR
argument_list|,
name|tmp16
operator||
literal|4
argument_list|)
expr_stmt|;
comment|/* Take BPHY out of the reset */
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_B_BBCFG
argument_list|,
operator|(
name|uint16_t
operator|)
operator|~
operator|(
name|BWN_PHY_B_BBCFG_RSTCCA
operator||
name|BWN_PHY_B_BBCFG_RSTRX
operator|)
argument_list|)
expr_stmt|;
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
name|BWN_PSM_PHY_HDR
argument_list|,
name|tmp16
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BWN_ERRPRINTF
argument_list|(
name|mac
operator|->
name|mac_sc
argument_list|,
literal|"%s: unknown band?\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
block|}
name|bwn_chantab_phy_upload
argument_list|(
name|mac
argument_list|,
name|e
argument_list|)
expr_stmt|;
if|if
condition|(
name|new_channel
operator|->
name|ic_ieee
operator|==
literal|14
condition|)
block|{
name|bwn_nphy_classifier
argument_list|(
name|mac
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_B_TEST
argument_list|,
literal|0x0800
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|bwn_nphy_classifier
argument_list|(
name|mac
argument_list|,
literal|2
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|bwn_channel_band
argument_list|(
name|mac
argument_list|,
name|new_channel
argument_list|)
operator|==
name|BWN_BAND_2G
condition|)
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_B_TEST
argument_list|,
operator|~
literal|0x840
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|nphy
operator|->
name|txpwrctrl
condition|)
name|bwn_nphy_tx_power_fix
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|<
literal|3
condition|)
name|bwn_nphy_adjust_lna_gain_table
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|bwn_nphy_tx_lpf_bw
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|3
operator|&&
name|mac
operator|->
name|mac_phy
operator|.
name|phy_n
operator|->
name|spur_avoid
operator|!=
name|BWN_SPUR_AVOID_DISABLE
condition|)
block|{
name|uint8_t
name|spuravoid
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|phy_n
operator|->
name|spur_avoid
operator|==
name|BWN_SPUR_AVOID_FORCE
condition|)
block|{
name|spuravoid
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|19
condition|)
block|{
comment|/* TODO */
block|}
elseif|else
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|18
condition|)
block|{
comment|/* TODO */
block|}
elseif|else
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|17
condition|)
block|{
comment|/* TODO: Off for channels 1-11, but check 12-14! */
block|}
elseif|else
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|16
condition|)
block|{
comment|/* TODO: Off for 2 GHz, but check 5 GHz! */
block|}
elseif|else
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|7
condition|)
block|{
if|if
condition|(
operator|!
name|bwn_is_40mhz
argument_list|(
name|mac
argument_list|)
condition|)
block|{
comment|/* 20MHz */
if|if
condition|(
name|ch
operator|==
literal|13
operator|||
name|ch
operator|==
literal|14
operator|||
name|ch
operator|==
literal|153
condition|)
name|spuravoid
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
comment|/* 40 MHz */
if|if
condition|(
name|ch
operator|==
literal|54
condition|)
name|spuravoid
operator|=
literal|1
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
operator|!
name|bwn_is_40mhz
argument_list|(
name|mac
argument_list|)
condition|)
block|{
comment|/* 20MHz */
if|if
condition|(
operator|(
name|ch
operator|>=
literal|5
operator|&&
name|ch
operator|<=
literal|8
operator|)
operator|||
name|ch
operator|==
literal|13
operator|||
name|ch
operator|==
literal|14
condition|)
name|spuravoid
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
comment|/* 40MHz */
if|if
condition|(
name|nphy
operator|->
name|aband_spurwar_en
operator|&&
operator|(
name|ch
operator|==
literal|38
operator|||
name|ch
operator|==
literal|102
operator|||
name|ch
operator|==
literal|118
operator|)
condition|)
name|spuravoid
operator|=
name|siba_get_chipid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
literal|0x4716
expr_stmt|;
block|}
block|}
name|bwn_nphy_pmu_spur_avoid
argument_list|(
name|mac
argument_list|,
name|spuravoid
argument_list|)
expr_stmt|;
name|bwn_mac_switch_freq
argument_list|(
name|mac
argument_list|,
name|spuravoid
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|==
literal|3
operator|||
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|==
literal|4
condition|)
name|bwn_wireless_core_phy_pll_reset
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|spuravoid
condition|)
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_BBCFG
argument_list|,
name|BWN_NPHY_BBCFG_RSTRX
argument_list|)
expr_stmt|;
else|else
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_BBCFG
argument_list|,
operator|~
name|BWN_NPHY_BBCFG_RSTRX
operator|&
literal|0xFFFF
argument_list|)
expr_stmt|;
name|bwn_nphy_reset_cca
argument_list|(
name|mac
argument_list|)
expr_stmt|;
comment|/* wl sets useless phy_isspuravoid here */
block|}
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_NDATAT_DUP40
argument_list|,
literal|0x3830
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|3
condition|)
name|bwn_nphy_spur_workaround
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/SetChanspec */
end_comment

begin_function
specifier|static
name|int
name|bwn_nphy_set_channel
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
name|channel
parameter_list|,
name|bwn_chan_type_t
name|channel_type
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
specifier|const
name|struct
name|bwn_nphy_channeltab_entry_rev2
modifier|*
name|tabent_r2
init|=
name|NULL
decl_stmt|;
specifier|const
name|struct
name|bwn_nphy_channeltab_entry_rev3
modifier|*
name|tabent_r3
init|=
name|NULL
decl_stmt|;
specifier|const
name|struct
name|bwn_nphy_chantabent_rev7
modifier|*
name|tabent_r7
init|=
name|NULL
decl_stmt|;
specifier|const
name|struct
name|bwn_nphy_chantabent_rev7_2g
modifier|*
name|tabent_r7_2g
init|=
name|NULL
decl_stmt|;
name|uint8_t
name|tmp
decl_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|19
condition|)
block|{
return|return
operator|-
name|ESRCH
return|;
comment|/* TODO */
block|}
elseif|else
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|7
condition|)
block|{
name|r2057_get_chantabent_rev7
argument_list|(
name|mac
argument_list|,
name|bwn_get_chan_centre_freq
argument_list|(
name|mac
argument_list|,
name|channel
argument_list|)
argument_list|,
operator|&
name|tabent_r7
argument_list|,
operator|&
name|tabent_r7_2g
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tabent_r7
operator|&&
operator|!
name|tabent_r7_2g
condition|)
return|return
operator|-
name|ESRCH
return|;
block|}
elseif|else
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|3
condition|)
block|{
name|tabent_r3
operator|=
name|bwn_nphy_get_chantabent_rev3
argument_list|(
name|mac
argument_list|,
name|bwn_get_chan_centre_freq
argument_list|(
name|mac
argument_list|,
name|channel
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tabent_r3
condition|)
return|return
operator|-
name|ESRCH
return|;
block|}
else|else
block|{
name|tabent_r2
operator|=
name|bwn_nphy_get_chantabent_rev2
argument_list|(
name|mac
argument_list|,
name|channel
operator|->
name|ic_ieee
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tabent_r2
condition|)
return|return
operator|-
name|ESRCH
return|;
block|}
comment|/* Channel is set later in common code, but we need to set it on our 	   own to let this function's subcalls work properly. */
if|#
directive|if
literal|0
block|phy->channel = channel->ic_ieee;
endif|#
directive|endif
if|#
directive|if
literal|0
block|if (bwn_channel_type_is_40mhz(phy->channel_type) != 		bwn_channel_type_is_40mhz(channel_type)) 		;
comment|/* TODO: BMAC BW Set (channel_type) */
endif|#
directive|endif
if|if
condition|(
name|channel_type
operator|==
name|BWN_CHAN_TYPE_40_HT_U
condition|)
block|{
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RXCTL
argument_list|,
name|BWN_NPHY_RXCTL_BSELU20
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|7
condition|)
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
literal|0x310
argument_list|,
literal|0x8000
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|channel_type
operator|==
name|BWN_CHAN_TYPE_40_HT_D
condition|)
block|{
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RXCTL
argument_list|,
operator|~
name|BWN_NPHY_RXCTL_BSELU20
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|7
condition|)
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
literal|0x310
argument_list|,
operator|(
name|uint16_t
operator|)
operator|~
literal|0x8000
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|19
condition|)
block|{
comment|/* TODO */
block|}
elseif|else
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|7
condition|)
block|{
specifier|const
name|struct
name|bwn_phy_n_sfo_cfg
modifier|*
name|phy_regs
init|=
name|tabent_r7
condition|?
operator|&
operator|(
name|tabent_r7
operator|->
name|phy_regs
operator|)
else|:
operator|&
operator|(
name|tabent_r7_2g
operator|->
name|phy_regs
operator|)
decl_stmt|;
if|if
condition|(
name|phy
operator|->
name|rf_rev
operator|<=
literal|4
operator|||
name|phy
operator|->
name|rf_rev
operator|==
literal|6
condition|)
block|{
name|tmp
operator|=
operator|(
name|bwn_channel_band
argument_list|(
name|mac
argument_list|,
name|channel
argument_list|)
operator|==
name|BWN_BAND_5G
operator|)
condition|?
literal|2
else|:
literal|0
expr_stmt|;
name|BWN_RF_SETMASK
argument_list|(
name|mac
argument_list|,
name|R2057_TIA_CONFIG_CORE0
argument_list|,
operator|~
literal|2
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|BWN_RF_SETMASK
argument_list|(
name|mac
argument_list|,
name|R2057_TIA_CONFIG_CORE1
argument_list|,
operator|~
literal|2
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
name|bwn_radio_2057_setup
argument_list|(
name|mac
argument_list|,
name|tabent_r7
argument_list|,
name|tabent_r7_2g
argument_list|)
expr_stmt|;
name|bwn_nphy_channel_setup
argument_list|(
name|mac
argument_list|,
name|phy_regs
argument_list|,
name|channel
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|3
condition|)
block|{
name|tmp
operator|=
operator|(
name|bwn_channel_band
argument_list|(
name|mac
argument_list|,
name|channel
argument_list|)
operator|==
name|BWN_BAND_5G
operator|)
condition|?
literal|4
else|:
literal|0
expr_stmt|;
name|BWN_RF_SETMASK
argument_list|(
name|mac
argument_list|,
literal|0x08
argument_list|,
literal|0xFFFB
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|bwn_radio_2056_setup
argument_list|(
name|mac
argument_list|,
name|tabent_r3
argument_list|)
expr_stmt|;
name|bwn_nphy_channel_setup
argument_list|(
name|mac
argument_list|,
operator|&
operator|(
name|tabent_r3
operator|->
name|phy_regs
operator|)
argument_list|,
name|channel
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tmp
operator|=
operator|(
name|bwn_channel_band
argument_list|(
name|mac
argument_list|,
name|channel
argument_list|)
operator|==
name|BWN_BAND_5G
operator|)
condition|?
literal|0x0020
else|:
literal|0x0050
expr_stmt|;
name|BWN_RF_SETMASK
argument_list|(
name|mac
argument_list|,
name|B2055_MASTER1
argument_list|,
literal|0xFF8F
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|bwn_radio_2055_setup
argument_list|(
name|mac
argument_list|,
name|tabent_r2
argument_list|)
expr_stmt|;
name|bwn_nphy_channel_setup
argument_list|(
name|mac
argument_list|,
operator|&
operator|(
name|tabent_r2
operator|->
name|phy_regs
operator|)
argument_list|,
name|channel
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**************************************************  * Basic PHY ops.  **************************************************/
end_comment

begin_function
name|int
name|bwn_nphy_op_allocate
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_phy_n
modifier|*
name|nphy
decl_stmt|;
name|nphy
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|nphy
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_ZERO
operator||
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|nphy
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|mac
operator|->
name|mac_phy
operator|.
name|phy_n
operator|=
name|nphy
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|bwn_nphy_op_prepare_structs
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwn_phy_n
modifier|*
name|nphy
init|=
name|phy
operator|->
name|phy_n
decl_stmt|;
name|memset
argument_list|(
name|nphy
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|nphy
argument_list|)
argument_list|)
expr_stmt|;
name|nphy
operator|->
name|hang_avoid
operator|=
operator|(
name|phy
operator|->
name|rev
operator|==
literal|3
operator|||
name|phy
operator|->
name|rev
operator|==
literal|4
operator|)
expr_stmt|;
name|nphy
operator|->
name|spur_avoid
operator|=
operator|(
name|phy
operator|->
name|rev
operator|>=
literal|3
operator|)
condition|?
name|BWN_SPUR_AVOID_AUTO
else|:
name|BWN_SPUR_AVOID_DISABLE
expr_stmt|;
name|nphy
operator|->
name|gain_boost
operator|=
name|true
expr_stmt|;
comment|/* this way we follow wl, assume it is true */
name|nphy
operator|->
name|txrx_chain
operator|=
literal|2
expr_stmt|;
comment|/* sth different than 0 and 1 for now */
name|nphy
operator|->
name|phyrxchain
operator|=
literal|3
expr_stmt|;
comment|/* to avoid bwn_nphy_set_rx_core_state like wl */
name|nphy
operator|->
name|perical
operator|=
literal|2
expr_stmt|;
comment|/* avoid additional rssi cal on init (like wl) */
comment|/* 128 can mean disabled-by-default state of TX pwr ctl. Max value is 	 * 0x7f == 127 and we check for 128 when restoring TX pwr ctl. */
name|nphy
operator|->
name|tx_pwr_idx
index|[
literal|0
index|]
operator|=
literal|128
expr_stmt|;
name|nphy
operator|->
name|tx_pwr_idx
index|[
literal|1
index|]
operator|=
literal|128
expr_stmt|;
comment|/* Hardware TX power control and 5GHz power gain */
name|nphy
operator|->
name|txpwrctrl
operator|=
name|false
expr_stmt|;
name|nphy
operator|->
name|pwg_gain_5ghz
operator|=
name|false
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|3
operator|||
operator|(
name|siba_get_pci_subvendor
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
name|PCI_VENDOR_APPLE
operator|&&
operator|(
name|siba_get_revid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
literal|11
operator|||
name|siba_get_revid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
literal|12
operator|)
operator|)
condition|)
block|{
name|nphy
operator|->
name|txpwrctrl
operator|=
name|true
expr_stmt|;
name|nphy
operator|->
name|pwg_gain_5ghz
operator|=
name|true
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|siba_sprom_get_rev
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|>=
literal|4
condition|)
block|{
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|2
operator|&&
operator|(
name|siba_sprom_get_bf2_lo
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|&
name|BWN_BFL2_TXPWRCTRL_EN
operator|)
condition|)
block|{
name|nphy
operator|->
name|txpwrctrl
operator|=
name|true
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_BWN_SSB
if|if
condition|(
name|dev
operator|->
name|dev
operator|->
name|bus_type
operator|==
name|BWN_BUS_SSB
operator|&&
name|dev
operator|->
name|dev
operator|->
name|sdev
operator|->
name|bus
operator|->
name|bustype
operator|==
name|SSB_BUSTYPE_PCI
condition|)
block|{
name|struct
name|pci_dev
modifier|*
name|pdev
init|=
name|dev
operator|->
name|dev
operator|->
name|sdev
operator|->
name|bus
operator|->
name|host_pci
decl_stmt|;
if|if
condition|(
name|pdev
operator|->
name|device
operator|==
literal|0x4328
operator|||
name|pdev
operator|->
name|device
operator|==
literal|0x432a
condition|)
name|nphy
operator|->
name|pwg_gain_5ghz
operator|=
name|true
expr_stmt|;
block|}
endif|#
directive|endif
block|}
elseif|else
if|if
condition|(
name|siba_sprom_get_bf2_lo
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|&
name|BWN_BFL2_5G_PWRGAIN
condition|)
block|{
name|nphy
operator|->
name|pwg_gain_5ghz
operator|=
name|true
expr_stmt|;
block|}
block|}
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|3
condition|)
block|{
name|nphy
operator|->
name|ipa2g_on
operator|=
name|siba_sprom_get_fem_2ghz_extpa_gain
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
literal|2
expr_stmt|;
name|nphy
operator|->
name|ipa5g_on
operator|=
name|siba_sprom_get_fem_5ghz_extpa_gain
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
literal|2
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|bwn_nphy_op_free
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwn_phy_n
modifier|*
name|nphy
init|=
name|phy
operator|->
name|phy_n
decl_stmt|;
name|free
argument_list|(
name|nphy
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|phy
operator|->
name|phy_n
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
name|int
name|bwn_nphy_op_init
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
return|return
name|bwn_phy_initn
argument_list|(
name|mac
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|check_phyreg
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint16_t
name|offset
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|BWN_DEBUG
if|if
condition|(
operator|(
name|offset
operator|&
name|BWN_PHYROUTE_MASK
operator|)
operator|==
name|BWN_PHYROUTE_OFDM_GPHY
condition|)
block|{
comment|/* OFDM registers are onnly available on A/G-PHYs */
name|BWN_ERRPRINTF
argument_list|(
name|mac
operator|->
name|mac_sc
argument_list|,
literal|"Invalid OFDM PHY access at "
literal|"0x%04X on N-PHY\n"
argument_list|,
name|offset
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|offset
operator|&
name|BWN_PHYROUTE_MASK
operator|)
operator|==
name|BWN_PHYROUTE_EXT_GPHY
condition|)
block|{
comment|/* Ext-G registers are only available on G-PHYs */
name|BWN_ERRPRINTF
argument_list|(
name|mac
operator|->
name|mac_sc
argument_list|,
literal|"Invalid EXT-G PHY access at "
literal|"0x%04X on N-PHY\n"
argument_list|,
name|offset
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* BWN_DEBUG */
block|}
end_function

begin_function
name|void
name|bwn_nphy_op_maskset
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint16_t
name|reg
parameter_list|,
name|uint16_t
name|mask
parameter_list|,
name|uint16_t
name|set
parameter_list|)
block|{
name|check_phyreg
argument_list|(
name|mac
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|BWN_WRITE_2_F
argument_list|(
name|mac
argument_list|,
name|BWN_PHYCTL
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|BWN_WRITE_SETMASK2
argument_list|(
name|mac
argument_list|,
name|BWN_PHYDATA
argument_list|,
name|mask
argument_list|,
name|set
argument_list|)
expr_stmt|;
block|}
end_function

begin_if
if|#
directive|if
literal|0
end_if

begin_comment
unit|uint16_t bwn_nphy_op_radio_read(struct bwn_mac *mac, uint16_t reg) {
comment|/* Register 1 is a 32-bit register. */
end_comment

begin_comment
unit|if (mac->mac_phy.rev< 7&& reg == 1) { 		BWN_ERRPRINTF(mac->mac_sc, "%s: bad reg access\n", __func__); 	}  	if (mac->mac_phy.rev>= 7) 		reg |= 0x200;
comment|/* Radio 0x2057 */
end_comment

begin_endif
unit|else 		reg |= 0x100;  	BWN_WRITE_2_F(mac, BWN_RFCTL, reg); 	return BWN_READ_2(mac, BWN_RFDATALO); }
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
literal|0
end_if

begin_comment
unit|void bwn_nphy_op_radio_write(struct bwn_mac *mac, uint16_t reg, uint16_t value) {
comment|/* Register 1 is a 32-bit register. */
end_comment

begin_endif
unit|if (mac->mac_phy.rev< 7&& reg == 1) { 		BWN_ERRPRINTF(mac->mac_sc, "%s: bad reg access\n", __func__); 	}  	BWN_WRITE_2_F(mac, BWN_RFCTL, reg); 	BWN_WRITE_2(mac, BWN_RFDATALO, value); }
endif|#
directive|endif
end_endif

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/Radio/Switch%20Radio */
end_comment

begin_function
name|void
name|bwn_nphy_op_software_rfkill
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|bool
name|active
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
if|if
condition|(
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCTL
argument_list|)
operator|&
name|BWN_MACCTL_ON
condition|)
name|BWN_ERRPRINTF
argument_list|(
name|mac
operator|->
name|mac_sc
argument_list|,
literal|"MAC not suspended\n"
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
name|mac
operator|->
name|mac_sc
argument_list|,
name|BWN_DEBUG_RESET
operator||
name|BWN_DEBUG_PHY
argument_list|,
literal|"%s: called; rev=%d, rf_on=%d, active=%d\n"
argument_list|,
name|__func__
argument_list|,
name|phy
operator|->
name|rev
argument_list|,
name|mac
operator|->
name|mac_phy
operator|.
name|rf_on
argument_list|,
name|active
argument_list|)
expr_stmt|;
comment|/* 	 * XXX TODO: don't bother doing RF programming if it's 	 * already done.  But, bwn(4) currently sets rf_on in the 	 * PHY setup and leaves it on after startup, which causes 	 * the below to not init the 2056/2057 radios. 	 */
if|if
condition|(
name|active
condition|)
block|{
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|19
condition|)
block|{
comment|/* TODO */
block|}
elseif|else
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|7
condition|)
block|{
comment|//			if (!mac->mac_phy.rf_on)
name|bwn_radio_2057_init
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|bwn_switch_channel
argument_list|(
name|mac
argument_list|,
name|bwn_get_chan
argument_list|(
name|mac
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|3
condition|)
block|{
comment|//			if (!mac->mac_phy.rf_on)
name|bwn_radio_init2056
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|bwn_switch_channel
argument_list|(
name|mac
argument_list|,
name|bwn_get_chan
argument_list|(
name|mac
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|bwn_radio_init2055
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|19
condition|)
block|{
comment|/* TODO */
block|}
elseif|else
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|8
condition|)
block|{
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_CMD
argument_list|,
operator|~
name|BWN_NPHY_RFCTL_CMD_CHIP0PU
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|7
condition|)
block|{
comment|/* Nothing needed */
block|}
elseif|else
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|3
condition|)
block|{
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_RFCTL_CMD
argument_list|,
operator|~
name|BWN_NPHY_RFCTL_CMD_CHIP0PU
argument_list|)
expr_stmt|;
name|BWN_RF_MASK
argument_list|(
name|mac
argument_list|,
literal|0x09
argument_list|,
operator|~
literal|0x2
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x204D
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x2053
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x2058
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x205E
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_RF_MASK
argument_list|(
name|mac
argument_list|,
literal|0x2062
argument_list|,
operator|~
literal|0xF0
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x2064
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x304D
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x3053
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x3058
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x305E
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_RF_MASK
argument_list|(
name|mac
argument_list|,
literal|0x3062
argument_list|,
operator|~
literal|0xF0
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x3064
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/* http://bcm-v4.sipsolutions.net/802.11/PHY/Anacore */
end_comment

begin_function
name|void
name|bwn_nphy_op_switch_analog
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|bool
name|on
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|uint16_t
name|override
init|=
name|on
condition|?
literal|0x0
else|:
literal|0x7FFF
decl_stmt|;
name|uint16_t
name|core
init|=
name|on
condition|?
literal|0xD
else|:
literal|0x00FD
decl_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|19
condition|)
block|{
comment|/* TODO */
name|device_printf
argument_list|(
name|mac
operator|->
name|mac_sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: TODO\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|3
condition|)
block|{
if|if
condition|(
name|on
condition|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_C1
argument_list|,
name|core
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_OVER1
argument_list|,
name|override
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_C2
argument_list|,
name|core
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_OVER
argument_list|,
name|override
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_OVER1
argument_list|,
name|override
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_C1
argument_list|,
name|core
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_OVER
argument_list|,
name|override
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_C2
argument_list|,
name|core
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_NPHY_AFECTL_OVER
argument_list|,
name|override
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|bwn_nphy_op_switch_channel
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|unsigned
name|int
name|new_channel
parameter_list|)
block|{
name|struct
name|ieee80211_channel
modifier|*
name|channel
init|=
name|bwn_get_channel
argument_list|(
name|mac
argument_list|)
decl_stmt|;
name|bwn_chan_type_t
name|channel_type
init|=
name|bwn_get_chan_type
argument_list|(
name|mac
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
if|if
condition|(
name|bwn_current_band
argument_list|(
name|mac
argument_list|)
operator|==
name|BWN_BAND_2G
condition|)
block|{
if|if
condition|(
operator|(
name|new_channel
operator|<
literal|1
operator|)
operator|||
operator|(
name|new_channel
operator|>
literal|14
operator|)
condition|)
return|return
operator|-
name|EINVAL
return|;
block|}
else|else
block|{
if|if
condition|(
name|new_channel
operator|>
literal|200
condition|)
return|return
operator|-
name|EINVAL
return|;
block|}
return|return
name|bwn_nphy_set_channel
argument_list|(
name|mac
argument_list|,
name|channel
argument_list|,
name|channel_type
argument_list|)
return|;
block|}
end_function

begin_if
if|#
directive|if
literal|0
end_if

begin_endif
unit|unsigned int bwn_nphy_op_get_default_chan(struct bwn_mac *mac) { 	if (bwn_current_band(mac) == BWN_BAND_2G) 		return 1; 	return 36; }
endif|#
directive|endif
end_endif

end_unit


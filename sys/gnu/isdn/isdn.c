begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_decl_stmt
specifier|static
name|char
name|_isdnid
index|[]
init|=
literal|"@(#)$Id: isdn.c,v 1.2 1995/02/15 06:28:29 jkh Exp $"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*******************************************************************************  *  II - Version 0.1 $Revision: 1.2 $   $State: Exp $  *  * Copyright 1994 Dietmar Friede  *******************************************************************************  * Bug reports, patches, comments, suggestions should be sent to:  *  *	jkr@saarlink.de or jkrause@guug.de  *  *******************************************************************************  * $Log: isdn.c,v $  * Revision 1.2  1995/02/15  06:28:29  jkh  * Fix up include paths, nuke some warnings.  *  * Revision 1.1  1995/02/14  15:00:33  jkh  * An ISDN driver that supports the EDSS1 and the 1TR6 ISDN interfaces.  * EDSS1 is the "Euro-ISDN", 1TR6 is the soon obsolete german ISDN Interface.  * Obtained from: Dietmar Friede<dfriede@drnhh.neuhaus.de> and  * 	Juergen Krause<jkr@saarlink.de>  *  * This is only one part - the rest to follow in a couple of hours.  * This part is a benign import, since it doesn't affect anything else.  *  *  ******************************************************************************/
end_comment

begin_comment
comment|/*  * Copyright (c) 1994 Dietmar Friede (dietmar@friede.de) All rights reserved.  * FSF/FSAG GNU Copyright applies  *   * An intermediate level for ISDN Drivers.  *   */
end_comment

begin_include
include|#
directive|include
file|"isdn.h"
end_include

begin_include
include|#
directive|include
file|"ii.h"
end_include

begin_include
include|#
directive|include
file|"ity.h"
end_include

begin_include
include|#
directive|include
file|"itel.h"
end_include

begin_include
include|#
directive|include
file|"ispy.h"
end_include

begin_if
if|#
directive|if
name|NISDN
operator|>
literal|0
end_if

begin_define
define|#
directive|define
name|TYPNR
value|4
end_define

begin_define
define|#
directive|define
name|N_ISDN_APPL
value|(NII + NITY + NITEL + NISPY)
end_define

begin_include
include|#
directive|include
file|"param.h"
end_include

begin_include
include|#
directive|include
file|"ioctl.h"
end_include

begin_include
include|#
directive|include
file|"kernel.h"
end_include

begin_include
include|#
directive|include
file|"systm.h"
end_include

begin_include
include|#
directive|include
file|"proc.h"
end_include

begin_include
include|#
directive|include
file|"gnu/isdn/isdn_ioctl.h"
end_include

begin_decl_stmt
name|isdn_appl_t
name|isdn_appl
index|[
name|N_ISDN_APPL
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|isdn_ctrl_t
name|isdn_ctrl
index|[
name|N_ISDN_CTRL
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|Isdn_Appl
decl_stmt|,
name|Isdn_Ctrl
decl_stmt|,
name|Isdn_Typ
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|ii_input
argument_list|()
decl_stmt|,
name|ii_out
argument_list|()
decl_stmt|,
name|ii_connect
argument_list|()
decl_stmt|,
name|ii_disconnect
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|ity_input
argument_list|()
decl_stmt|,
name|ity_out
argument_list|()
decl_stmt|,
name|ity_connect
argument_list|()
decl_stmt|,
name|ity_disconnect
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|itel_input
argument_list|()
decl_stmt|,
name|itel_out
argument_list|()
decl_stmt|,
name|itel_connect
argument_list|()
decl_stmt|,
name|itel_disconnect
argument_list|()
decl_stmt|;
end_decl_stmt

begin_function_decl
name|int
name|ispy_input
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|int
name|isdn_stat
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|int
name|o_flags
decl_stmt|,
name|r_flags
decl_stmt|,
name|bufind
index|[
name|TYPNR
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|buffer
index|[
name|TYPNR
index|]
index|[
literal|257
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|u_char
name|appl_list
index|[
name|TYPNR
index|]
decl_stmt|;
end_decl_stmt

begin_typedef
typedef|typedef
name|u_char
name|prot
index|[
literal|2
index|]
typedef|;
end_typedef

begin_decl_stmt
specifier|static
name|u_char
name|prot_size
index|[
literal|2
index|]
init|=
block|{
literal|0
block|,
literal|2
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|prot
name|passiv
index|[
literal|6
index|]
init|=
block|{
block|{
literal|0
block|}
block|,
block|{
literal|3
block|,
literal|3
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|prot
name|activ
index|[
literal|6
index|]
init|=
block|{
block|{
literal|0
block|}
block|,
block|{
literal|1
block|,
literal|3
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|passout
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|u_short
name|isdn_state
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_expr_stmt
specifier|static
name|isdn_timeout
operator|=
literal|0
expr_stmt|;
end_expr_stmt

begin_function
name|int
name|isdn_get_prot_size
parameter_list|(
name|int
name|ap
parameter_list|)
block|{
return|return
operator|(
name|prot_size
index|[
name|isdn_appl
index|[
name|ap
index|]
operator|.
name|prot
index|]
operator|)
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|isdn_get_prot
parameter_list|(
name|int
name|ap
parameter_list|,
name|int
name|dir
parameter_list|)
block|{
if|if
condition|(
name|dir
condition|)
return|return
operator|(
name|activ
index|[
name|isdn_appl
index|[
name|ap
index|]
operator|.
name|prot
index|]
operator|)
return|;
return|return
operator|(
name|passiv
index|[
name|isdn_appl
index|[
name|ap
index|]
operator|.
name|prot
index|]
operator|)
return|;
block|}
end_function

begin_function
name|int
name|isdn_set_prot
parameter_list|(
name|int
name|ap
parameter_list|,
name|int
name|dir
parameter_list|,
name|char
modifier|*
name|p
parameter_list|)
block|{
name|char
modifier|*
name|pr
decl_stmt|;
name|int
name|i
decl_stmt|,
name|l
decl_stmt|;
if|if
condition|(
operator|(
name|l
operator|=
name|isdn_get_prot_size
argument_list|(
name|ap
argument_list|)
operator|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|dir
condition|)
name|pr
operator|=
name|passiv
index|[
name|isdn_appl
index|[
name|ap
index|]
operator|.
name|prot
index|]
expr_stmt|;
else|else
name|pr
operator|=
name|activ
index|[
name|isdn_appl
index|[
name|ap
index|]
operator|.
name|prot
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|l
condition|;
name|i
operator|++
operator|,
name|pr
operator|++
operator|,
name|p
operator|++
control|)
operator|*
name|p
operator|=
operator|*
name|pr
expr_stmt|;
return|return
operator|(
name|l
operator|)
return|;
block|}
end_function

begin_function
name|void
name|isdn_attach
parameter_list|()
block|{
name|isdn_appl_t
modifier|*
name|appl
decl_stmt|;
name|int
name|i
decl_stmt|,
name|an
decl_stmt|;
name|appl_list
index|[
literal|0
index|]
operator|=
name|Isdn_Typ
operator|=
name|an
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NII
condition|;
name|i
operator|++
operator|,
name|an
operator|++
control|)
block|{
name|appl
operator|=
operator|&
name|isdn_appl
index|[
name|an
index|]
expr_stmt|;
name|appl
operator|->
name|ctrl
operator|=
operator|-
literal|1
expr_stmt|;
name|appl
operator|->
name|state
operator|=
literal|0
expr_stmt|;
name|appl
operator|->
name|appl
operator|=
name|an
expr_stmt|;
name|appl
operator|->
name|typ
operator|=
name|Isdn_Typ
expr_stmt|;
name|appl
operator|->
name|drivno
operator|=
name|iiattach
argument_list|(
name|an
argument_list|)
expr_stmt|;
name|appl
operator|->
name|PassUp
operator|=
name|ii_input
expr_stmt|;
name|appl
operator|->
name|PassDown
operator|=
name|ii_out
expr_stmt|;
name|appl
operator|->
name|Connect
operator|=
name|ii_connect
expr_stmt|;
name|appl
operator|->
name|DisConn
operator|=
name|ii_disconnect
expr_stmt|;
block|}
name|appl_list
index|[
literal|1
index|]
operator|=
name|an
expr_stmt|;
name|Isdn_Typ
operator|=
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NITY
condition|;
name|i
operator|++
operator|,
name|an
operator|++
control|)
block|{
name|appl
operator|=
operator|&
name|isdn_appl
index|[
name|an
index|]
expr_stmt|;
name|appl
operator|->
name|ctrl
operator|=
operator|-
literal|1
expr_stmt|;
name|appl
operator|->
name|state
operator|=
literal|0
expr_stmt|;
name|appl
operator|->
name|appl
operator|=
name|an
expr_stmt|;
name|appl
operator|->
name|typ
operator|=
name|Isdn_Typ
expr_stmt|;
name|appl
operator|->
name|drivno
operator|=
name|ityattach
argument_list|(
name|an
argument_list|)
expr_stmt|;
name|appl
operator|->
name|PassUp
operator|=
name|ity_input
expr_stmt|;
name|appl
operator|->
name|PassDown
operator|=
name|ity_out
expr_stmt|;
name|appl
operator|->
name|Connect
operator|=
name|ity_connect
expr_stmt|;
name|appl
operator|->
name|DisConn
operator|=
name|ity_disconnect
expr_stmt|;
block|}
name|appl_list
index|[
literal|2
index|]
operator|=
name|an
expr_stmt|;
name|Isdn_Typ
operator|=
literal|2
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NITEL
condition|;
name|i
operator|++
operator|,
name|an
operator|++
control|)
block|{
name|appl
operator|=
operator|&
name|isdn_appl
index|[
name|an
index|]
expr_stmt|;
name|appl
operator|->
name|ctrl
operator|=
operator|-
literal|1
expr_stmt|;
name|appl
operator|->
name|state
operator|=
literal|0
expr_stmt|;
name|appl
operator|->
name|appl
operator|=
name|an
expr_stmt|;
name|appl
operator|->
name|typ
operator|=
name|Isdn_Typ
expr_stmt|;
name|appl
operator|->
name|drivno
operator|=
name|itelattach
argument_list|(
name|an
argument_list|)
expr_stmt|;
name|appl
operator|->
name|PassUp
operator|=
name|itel_input
expr_stmt|;
name|appl
operator|->
name|PassDown
operator|=
name|itel_out
expr_stmt|;
name|appl
operator|->
name|Connect
operator|=
name|itel_connect
expr_stmt|;
name|appl
operator|->
name|DisConn
operator|=
name|itel_disconnect
expr_stmt|;
block|}
name|appl_list
index|[
literal|3
index|]
operator|=
name|an
expr_stmt|;
name|Isdn_Typ
operator|=
literal|3
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NISPY
condition|;
name|i
operator|++
operator|,
name|an
operator|++
control|)
block|{
name|appl
operator|=
operator|&
name|isdn_appl
index|[
name|an
index|]
expr_stmt|;
name|appl
operator|->
name|ctrl
operator|=
operator|-
literal|1
expr_stmt|;
name|appl
operator|->
name|state
operator|=
literal|0
expr_stmt|;
name|appl
operator|->
name|appl
operator|=
name|an
expr_stmt|;
name|appl
operator|->
name|typ
operator|=
name|Isdn_Typ
expr_stmt|;
name|appl
operator|->
name|drivno
operator|=
name|ispyattach
argument_list|(
name|an
argument_list|)
expr_stmt|;
name|appl
operator|->
name|PassUp
operator|=
name|ispy_input
expr_stmt|;
block|}
name|Isdn_Appl
operator|=
name|an
expr_stmt|;
block|}
end_function

begin_function
name|int
name|isdn_ctrl_attach
parameter_list|(
name|int
name|n
parameter_list|)
block|{
name|int
name|c
init|=
name|Isdn_Ctrl
decl_stmt|;
if|if
condition|(
name|Isdn_Ctrl
operator|==
literal|0
condition|)
name|isdn_attach
argument_list|()
expr_stmt|;
if|if
condition|(
operator|(
name|Isdn_Ctrl
operator|+=
name|n
operator|)
operator|<=
name|N_ISDN_CTRL
condition|)
return|return
operator|(
name|c
operator|)
return|;
name|Isdn_Ctrl
operator|=
name|c
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * isdnopen() New open on device.  *   * I forbid all but one open per application. The only programs opening the  *  isdn device are the ISDN-daemon  */
end_comment

begin_function
name|int
name|isdnopen
parameter_list|(
name|dev_t
name|dev
parameter_list|,
name|int
name|flag
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
if|if
condition|(
name|minor
argument_list|(
name|dev
argument_list|)
operator|>
name|Isdn_Typ
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
comment|/* Card busy ? */
if|if
condition|(
name|o_flags
operator|&
operator|(
literal|1
operator|<<
name|minor
argument_list|(
name|dev
argument_list|)
operator|)
condition|)
return|return
operator|(
name|EBUSY
operator|)
return|;
name|o_flags
operator||=
operator|(
literal|1
operator|<<
name|minor
argument_list|(
name|dev
argument_list|)
operator|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|isdnclose
parameter_list|(
name|dev_t
name|dev
parameter_list|,
name|int
name|flag
parameter_list|)
block|{
name|o_flags
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|minor
argument_list|(
name|dev
argument_list|)
operator|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|isdnread
parameter_list|(
name|dev_t
name|dev
parameter_list|,
name|struct
name|uio
modifier|*
name|uio
parameter_list|)
block|{
name|int
name|x
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|int
name|unit
init|=
name|minor
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|r_flags
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|unit
operator|)
expr_stmt|;
name|x
operator|=
name|splhigh
argument_list|()
expr_stmt|;
if|if
condition|(
name|bufind
index|[
name|unit
index|]
operator|==
literal|0
condition|)
block|{
name|r_flags
operator||=
operator|(
literal|1
operator|<<
name|unit
operator|)
expr_stmt|;
name|error
operator|=
name|tsleep
argument_list|(
operator|(
name|caddr_t
operator|)
name|buffer
index|[
name|unit
index|]
argument_list|,
name|PZERO
operator|+
literal|1
argument_list|,
literal|"isdnin"
argument_list|,
name|hz
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|bufind
index|[
name|unit
index|]
condition|)
block|{
name|buffer
index|[
name|unit
index|]
index|[
name|bufind
index|[
name|unit
index|]
operator|++
index|]
operator|=
literal|0
expr_stmt|;
name|error
operator|=
name|uiomove
argument_list|(
name|buffer
index|[
name|unit
index|]
argument_list|,
name|bufind
index|[
name|unit
index|]
argument_list|,
name|uio
argument_list|)
expr_stmt|;
name|bufind
index|[
name|unit
index|]
operator|=
literal|0
expr_stmt|;
block|}
name|splx
argument_list|(
name|x
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_function
name|int
name|isdnioctl
parameter_list|(
name|dev_t
name|dev
parameter_list|,
name|int
name|cmd
parameter_list|,
name|caddr_t
name|data
parameter_list|,
name|int
name|flag
parameter_list|)
block|{
name|int
name|err
decl_stmt|,
name|x
decl_stmt|,
name|i
decl_stmt|;
name|isdn_appl_t
modifier|*
name|appl
decl_stmt|;
name|isdn_ctrl_t
modifier|*
name|ctrl
decl_stmt|;
name|short
modifier|*
name|val
init|=
operator|(
name|short
operator|*
operator|)
name|data
decl_stmt|;
name|unsigned
name|ab
decl_stmt|,
name|an
decl_stmt|,
name|cn
decl_stmt|;
name|err
operator|=
literal|0
expr_stmt|;
name|ab
operator|=
name|appl_list
index|[
name|minor
argument_list|(
name|dev
argument_list|)
index|]
expr_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|ISDN_LISTEN
case|:
block|{
name|listen_t
modifier|*
name|s
init|=
operator|(
name|listen_t
operator|*
operator|)
name|data
decl_stmt|;
name|an
operator|=
name|ab
expr_stmt|;
if|if
condition|(
name|s
operator|->
name|ctrl
operator|>=
name|Isdn_Ctrl
condition|)
return|return
operator|(
name|ENODEV
operator|)
return|;
name|cn
operator|=
name|s
operator|->
name|ctrl
expr_stmt|;
name|ctrl
operator|=
operator|&
name|isdn_ctrl
index|[
name|cn
index|]
expr_stmt|;
name|x
operator|=
name|splhigh
argument_list|()
expr_stmt|;
while|while
condition|(
name|isdn_state
condition|)
block|{
name|err
operator|=
name|tsleep
argument_list|(
operator|(
name|caddr_t
operator|)
name|ctrl
argument_list|,
name|PZERO
operator||
name|PCATCH
argument_list|,
literal|"slisten"
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|EWOULDBLOCK
condition|)
block|{
name|splx
argument_list|(
name|x
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
block|}
name|isdn_state
operator|=
literal|0xffff
expr_stmt|;
while|while
condition|(
operator|(
name|err
operator|=
call|(
modifier|*
name|ctrl
operator|->
name|listen
call|)
argument_list|(
name|s
operator|->
name|ctrl
argument_list|,
name|minor
argument_list|(
name|dev
argument_list|)
operator||
literal|0x30
argument_list|,
name|s
operator|->
name|inf_mask
argument_list|,
name|s
operator|->
name|subadr_mask
argument_list|,
name|s
operator|->
name|si_mask
argument_list|)
operator|)
operator|==
name|EBUSY
condition|)
block|{
name|err
operator|=
name|tsleep
argument_list|(
operator|(
name|caddr_t
operator|)
name|ctrl
argument_list|,
name|PZERO
operator||
name|PCATCH
argument_list|,
literal|"blisten"
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|EWOULDBLOCK
condition|)
block|{
name|splx
argument_list|(
name|x
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
block|}
if|if
condition|(
name|err
condition|)
block|{
name|splx
argument_list|(
name|x
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
while|while
condition|(
name|isdn_state
operator|==
literal|0xffff
condition|)
block|{
name|err
operator|=
name|tsleep
argument_list|(
operator|(
name|caddr_t
operator|)
name|ctrl
argument_list|,
name|PZERO
operator||
name|PCATCH
argument_list|,
literal|"ilisten"
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|EWOULDBLOCK
condition|)
block|{
name|splx
argument_list|(
name|x
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
block|}
name|splx
argument_list|(
name|x
argument_list|)
expr_stmt|;
name|err
operator|=
name|isdn_state
expr_stmt|;
name|isdn_state
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
comment|/* tricky but it works */
block|}
break|break;
case|case
name|ISDN_DIAL
case|:
block|{
name|dial_t
modifier|*
name|d
init|=
operator|(
name|dial_t
operator|*
operator|)
name|data
decl_stmt|;
name|telno_t
modifier|*
name|t
init|=
operator|&
name|d
operator|->
name|telno
decl_stmt|;
name|an
operator|=
name|d
operator|->
name|appl
operator|+
name|ab
expr_stmt|;
name|cn
operator|=
name|d
operator|->
name|ctrl
expr_stmt|;
if|if
condition|(
name|an
operator|>=
name|Isdn_Appl
operator|||
name|cn
operator|>=
name|Isdn_Ctrl
condition|)
return|return
operator|(
name|ENODEV
operator|)
return|;
name|appl
operator|=
operator|&
name|isdn_appl
index|[
name|an
index|]
expr_stmt|;
if|if
condition|(
name|ISBUSY
argument_list|(
name|appl
operator|->
name|ctrl
argument_list|)
operator|||
name|appl
operator|->
name|state
condition|)
return|return
operator|(
name|EBUSY
operator|)
return|;
name|appl
operator|->
name|state
operator|=
literal|1
expr_stmt|;
name|x
operator|=
name|splhigh
argument_list|()
expr_stmt|;
while|while
condition|(
operator|(
name|err
operator|=
operator|(
operator|*
name|isdn_ctrl
index|[
name|cn
index|]
operator|.
name|connect
operator|)
operator|(
name|cn
operator|,
name|an
operator|,
name|d
operator|->
name|b_channel
operator|,
name|d
operator|->
name|inf_mask
operator|,
name|d
operator|->
name|out_serv
operator|,
name|d
operator|->
name|out_serv_add
operator|,
name|d
operator|->
name|src_subadr
operator|,
name|t
operator|->
name|length
operator|,
name|t
operator|->
name|no
operator|,
name|d
operator|->
name|spv
operator|)
operator|)
operator|==
name|EBUSY
condition|)
block|{
name|err
operator|=
name|tsleep
argument_list|(
operator|(
name|caddr_t
operator|)
name|appl
argument_list|,
name|PZERO
operator||
name|PCATCH
argument_list|,
literal|"idial"
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|EWOULDBLOCK
condition|)
block|{
name|splx
argument_list|(
name|x
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
block|}
if|if
condition|(
name|err
condition|)
name|appl
operator|->
name|state
operator|=
literal|0
expr_stmt|;
name|splx
argument_list|(
name|x
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
break|break;
case|case
name|ISDN_HANGUP
case|:
name|cn
operator|=
name|data
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|cn
operator|>=
name|Isdn_Ctrl
condition|)
return|return
operator|(
name|ENODEV
operator|)
return|;
name|x
operator|=
name|splhigh
argument_list|()
expr_stmt|;
while|while
condition|(
operator|(
name|err
operator|=
operator|(
operator|*
name|isdn_ctrl
index|[
name|cn
index|]
operator|.
name|disconnect
operator|)
operator|(
name|cn
operator|,
name|data
index|[
literal|1
index|]
operator|)
operator|)
operator|==
name|EBUSY
condition|)
block|{
name|err
operator|=
name|tsleep
argument_list|(
operator|(
name|caddr_t
operator|)
name|data
argument_list|,
name|PZERO
operator||
name|PCATCH
argument_list|,
literal|"ihang"
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|EWOULDBLOCK
condition|)
block|{
name|splx
argument_list|(
name|x
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
block|}
name|splx
argument_list|(
name|x
argument_list|)
expr_stmt|;
break|break;
case|case
name|ISDN_ACCEPT
case|:
name|cn
operator|=
name|data
index|[
literal|0
index|]
expr_stmt|;
name|an
operator|=
name|data
index|[
literal|1
index|]
operator|+
name|ab
expr_stmt|;
if|if
condition|(
name|cn
operator|>=
name|Isdn_Ctrl
condition|)
return|return
operator|(
name|ENODEV
operator|)
return|;
name|x
operator|=
name|splhigh
argument_list|()
expr_stmt|;
while|while
condition|(
operator|(
name|err
operator|=
operator|(
operator|*
name|isdn_ctrl
index|[
name|cn
index|]
operator|.
name|accept
operator|)
operator|(
name|cn
operator|,
name|an
operator|,
name|data
index|[
literal|2
index|]
operator|)
operator|)
operator|==
name|EBUSY
condition|)
block|{
name|err
operator|=
name|tsleep
argument_list|(
operator|(
name|caddr_t
operator|)
name|data
argument_list|,
name|PZERO
operator||
name|PCATCH
argument_list|,
literal|"iaccept"
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|EWOULDBLOCK
condition|)
block|{
name|splx
argument_list|(
name|x
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
block|}
name|splx
argument_list|(
name|x
argument_list|)
expr_stmt|;
break|break;
case|case
name|ISDN_SET_PARAM
case|:
block|{
name|isdn_param
modifier|*
name|p
init|=
operator|(
name|isdn_param
operator|*
operator|)
name|data
decl_stmt|;
name|an
operator|=
name|p
operator|->
name|appl
operator|+
name|ab
expr_stmt|;
if|if
condition|(
name|an
operator|>=
name|Isdn_Appl
condition|)
return|return
operator|(
name|ENODEV
operator|)
return|;
name|appl
operator|=
operator|&
name|isdn_appl
index|[
name|an
index|]
expr_stmt|;
name|bcopy
argument_list|(
name|p
argument_list|,
name|appl
argument_list|,
sizeof|sizeof
argument_list|(
name|isdn_param
argument_list|)
argument_list|)
expr_stmt|;
name|appl
operator|->
name|appl
operator|+=
name|ab
expr_stmt|;
block|}
break|break;
case|case
name|ISDN_GET_PARAM
case|:
block|{
name|isdn_param
modifier|*
name|p
init|=
operator|(
name|isdn_param
operator|*
operator|)
name|data
decl_stmt|;
name|an
operator|=
name|p
operator|->
name|appl
operator|+
name|ab
expr_stmt|;
if|if
condition|(
name|an
operator|>=
name|Isdn_Appl
condition|)
return|return
operator|(
name|ENODEV
operator|)
return|;
name|appl
operator|=
operator|&
name|isdn_appl
index|[
name|an
index|]
expr_stmt|;
name|bcopy
argument_list|(
name|appl
argument_list|,
name|p
argument_list|,
sizeof|sizeof
argument_list|(
name|isdn_param
argument_list|)
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|err
operator|=
name|ENODEV
expr_stmt|;
block|}
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
name|void
name|isdn_start_out
parameter_list|(
name|int
name|cn
parameter_list|)
block|{
name|isdn_ctrl_t
modifier|*
name|ctrl
init|=
operator|&
name|isdn_ctrl
index|[
name|cn
index|]
decl_stmt|;
name|isdn_appl_t
modifier|*
name|appl
init|=
operator|&
name|isdn_appl
index|[
name|ctrl
operator|->
name|appl
index|]
decl_stmt|;
name|int
name|x
decl_stmt|;
name|x
operator|=
name|splhigh
argument_list|()
expr_stmt|;
if|if
condition|(
name|ctrl
operator|->
name|o_len
operator|==
literal|0
condition|)
block|{
name|int
name|l
decl_stmt|;
name|l
operator|=
name|isdn_set_prot
argument_list|(
name|ctrl
operator|->
name|appl
argument_list|,
name|ctrl
operator|->
name|islisten
argument_list|,
name|ctrl
operator|->
name|o_buf
argument_list|)
expr_stmt|;
name|ctrl
operator|->
name|o_len
operator|=
call|(
modifier|*
name|appl
operator|->
name|PassDown
call|)
argument_list|(
name|appl
operator|->
name|drivno
argument_list|,
name|ctrl
operator|->
name|o_buf
operator|+
name|l
argument_list|,
literal|2048
operator|-
name|l
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctrl
operator|->
name|o_len
operator|==
literal|0
condition|)
block|{
name|splx
argument_list|(
name|x
argument_list|)
expr_stmt|;
return|return;
block|}
name|ctrl
operator|->
name|o_len
operator|+=
name|l
expr_stmt|;
call|(
modifier|*
name|ctrl
operator|->
name|output
call|)
argument_list|(
name|cn
argument_list|)
expr_stmt|;
block|}
name|splx
argument_list|(
name|x
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|isdn_stat
parameter_list|(
name|int
name|cn
parameter_list|)
block|{
name|isdn_ctrl_t
modifier|*
name|ctrl
init|=
operator|&
name|isdn_ctrl
index|[
name|cn
index|]
decl_stmt|;
return|return
operator|(
call|(
modifier|*
name|ctrl
operator|->
name|state
call|)
argument_list|(
name|cn
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|isdn_output
parameter_list|(
name|int
name|an
parameter_list|)
block|{
name|isdn_appl_t
modifier|*
name|appl
init|=
operator|&
name|isdn_appl
index|[
name|an
index|]
decl_stmt|;
if|if
condition|(
name|ISFREE
argument_list|(
name|appl
operator|->
name|ctrl
argument_list|)
condition|)
block|{
name|int
name|l
decl_stmt|;
name|char
name|buf
index|[
literal|10
index|]
decl_stmt|;
if|if
condition|(
name|appl
operator|->
name|state
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|l
operator|=
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"d %d"
argument_list|,
name|an
operator|-
name|appl_list
index|[
name|appl
operator|->
name|typ
index|]
argument_list|)
expr_stmt|;
name|passout
argument_list|(
name|appl
operator|->
name|typ
argument_list|,
name|l
argument_list|,
name|buf
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|isdn_start_out
argument_list|(
name|appl
operator|->
name|ctrl
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|isdn_msg
parameter_list|(
name|int
name|an
parameter_list|)
block|{
name|isdn_appl_t
modifier|*
name|appl
init|=
operator|&
name|isdn_appl
index|[
name|an
index|]
decl_stmt|;
if|if
condition|(
name|ISFREE
argument_list|(
name|appl
operator|->
name|ctrl
argument_list|)
condition|)
block|{
name|int
name|l
decl_stmt|;
name|char
name|buf
index|[
literal|256
index|]
decl_stmt|;
name|l
operator|=
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"M %d"
argument_list|,
name|an
operator|-
name|appl_list
index|[
name|appl
operator|->
name|typ
index|]
argument_list|)
expr_stmt|;
name|l
operator|+=
call|(
modifier|*
name|appl
operator|->
name|PassDown
call|)
argument_list|(
name|appl
operator|->
name|drivno
argument_list|,
name|buf
operator|+
name|l
argument_list|,
literal|256
operator|-
name|l
argument_list|)
expr_stmt|;
name|passout
argument_list|(
name|appl
operator|->
name|typ
argument_list|,
name|l
argument_list|,
name|buf
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
name|int
name|isdn_input
parameter_list|(
name|int
name|an
parameter_list|,
name|int
name|len
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|int
name|dir
parameter_list|)
block|{
name|int
name|l
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|;
name|isdn_appl_t
modifier|*
name|appl
init|=
operator|&
name|isdn_appl
index|[
name|an
index|]
decl_stmt|;
if|if
condition|(
name|l
operator|=
name|isdn_get_prot_size
argument_list|(
name|an
argument_list|)
condition|)
block|{
name|p
operator|=
name|isdn_get_prot
argument_list|(
name|an
argument_list|,
name|dir
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p
index|[
literal|0
index|]
operator|!=
name|buf
index|[
literal|0
index|]
operator|)
operator|||
operator|(
name|p
index|[
literal|1
index|]
operator|!=
name|buf
index|[
literal|1
index|]
operator|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|len
operator|-=
name|l
expr_stmt|;
name|buf
operator|+=
name|l
expr_stmt|;
block|}
return|return
operator|(
call|(
modifier|*
name|appl
operator|->
name|PassUp
call|)
argument_list|(
name|appl
operator|->
name|drivno
argument_list|,
name|len
argument_list|,
name|buf
argument_list|,
name|dir
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|void
name|isdn_accept_con_ind
parameter_list|(
name|int
name|an
parameter_list|,
name|int
name|cn
parameter_list|,
name|char
name|serv
parameter_list|,
name|char
name|serv_add
parameter_list|,
name|char
name|subadr
parameter_list|,
name|char
name|nl
parameter_list|,
name|char
modifier|*
name|num
parameter_list|)
block|{
name|int
name|l
decl_stmt|;
name|char
name|buf
index|[
literal|32
index|]
decl_stmt|;
name|an
operator|&=
literal|0xf
expr_stmt|;
name|l
operator|=
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"a %d %d %d %d %c %d %d %s"
argument_list|,
name|an
argument_list|,
name|cn
argument_list|,
name|serv
argument_list|,
name|serv_add
argument_list|,
name|subadr
argument_list|,
operator|(
name|u_char
operator|)
name|num
index|[
literal|0
index|]
argument_list|,
name|nl
argument_list|,
name|num
operator|+
literal|1
argument_list|)
expr_stmt|;
name|passout
argument_list|(
name|an
argument_list|,
name|l
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|isdn_info
parameter_list|(
name|int
name|an
parameter_list|,
name|int
name|typ
parameter_list|,
name|int
name|len
parameter_list|,
name|char
modifier|*
name|data
parameter_list|)
block|{
name|int
name|l
decl_stmt|;
name|char
name|buf
index|[
literal|64
index|]
decl_stmt|;
name|u_short
name|no
decl_stmt|;
if|if
condition|(
name|an
operator|<
name|Isdn_Appl
condition|)
name|no
operator|=
name|isdn_appl
index|[
name|an
index|]
operator|.
name|typ
expr_stmt|;
else|else
name|no
operator|=
name|an
operator|&
literal|0xf
expr_stmt|;
if|if
condition|(
name|no
operator|>
name|Isdn_Typ
condition|)
name|no
operator|=
literal|3
expr_stmt|;
if|if
condition|(
name|len
operator|>
literal|48
condition|)
name|len
operator|=
literal|48
expr_stmt|;
name|data
index|[
name|len
index|]
operator|=
literal|0
expr_stmt|;
name|l
operator|=
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"i %d %d %d %s"
argument_list|,
name|an
argument_list|,
name|typ
argument_list|,
name|len
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|passout
argument_list|(
name|no
argument_list|,
name|l
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|isdn_check
parameter_list|()
block|{
name|int
name|i
decl_stmt|;
name|isdn_timeout
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|Isdn_Ctrl
condition|;
name|i
operator|++
control|)
block|{
name|int
name|an
decl_stmt|;
name|isdn_ctrl_t
modifier|*
name|ctrl
init|=
operator|&
name|isdn_ctrl
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
operator|(
name|an
operator|=
name|ctrl
operator|->
name|appl
operator|)
operator|<
name|Isdn_Appl
condition|)
block|{
name|isdn_appl_t
modifier|*
name|appl
init|=
operator|&
name|isdn_appl
index|[
name|an
index|]
decl_stmt|;
if|if
condition|(
name|appl
operator|->
name|timeout
condition|)
block|{
name|isdn_timeout
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|time
operator|.
name|tv_sec
operator|>
operator|(
name|ctrl
operator|->
name|lastact
operator|+
operator|(
name|appl
operator|->
name|timeout
operator|)
operator|)
condition|)
block|{
name|isdn_disconnect
argument_list|(
name|an
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
block|}
if|if
condition|(
name|isdn_timeout
condition|)
block|{
name|timeout
argument_list|(
name|isdn_check
argument_list|,
literal|0
argument_list|,
name|hz
operator|/
literal|2
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|isdn_conn_ind
parameter_list|(
name|int
name|an
parameter_list|,
name|int
name|cn
parameter_list|,
name|int
name|dial
parameter_list|)
block|{
name|isdn_appl_t
modifier|*
name|appl
init|=
operator|&
name|isdn_appl
index|[
name|an
index|]
decl_stmt|;
name|int
name|l
decl_stmt|;
name|char
name|buf
index|[
literal|10
index|]
decl_stmt|;
if|if
condition|(
name|appl
operator|->
name|Connect
condition|)
call|(
modifier|*
name|appl
operator|->
name|Connect
call|)
argument_list|(
name|appl
operator|->
name|drivno
argument_list|)
expr_stmt|;
name|l
operator|=
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"C %d %d %d"
argument_list|,
name|an
operator|-
name|appl_list
index|[
name|appl
operator|->
name|typ
index|]
argument_list|,
name|cn
argument_list|,
name|dial
argument_list|)
expr_stmt|;
name|passout
argument_list|(
name|appl
operator|->
name|typ
argument_list|,
name|l
argument_list|,
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|isdn_timeout
operator|==
literal|0
operator|)
operator|&&
name|appl
operator|->
name|timeout
condition|)
block|{
name|isdn_timeout
operator|=
literal|1
expr_stmt|;
name|timeout
argument_list|(
name|isdn_check
argument_list|,
literal|0
argument_list|,
name|hz
operator|/
literal|2
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|isdn_disconn_ind
parameter_list|(
name|int
name|an
parameter_list|)
block|{
name|isdn_appl_t
modifier|*
name|appl
init|=
operator|&
name|isdn_appl
index|[
name|an
index|]
decl_stmt|;
name|int
name|l
decl_stmt|;
name|char
name|buf
index|[
literal|10
index|]
decl_stmt|;
if|if
condition|(
operator|(
name|an
operator|<
literal|0
operator|)
operator|||
operator|(
name|an
operator|>=
name|Isdn_Appl
operator|)
condition|)
return|return;
name|appl
operator|->
name|state
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|appl
operator|->
name|DisConn
condition|)
call|(
modifier|*
name|appl
operator|->
name|DisConn
call|)
argument_list|(
name|appl
operator|->
name|drivno
argument_list|)
expr_stmt|;
name|l
operator|=
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"D %d"
argument_list|,
name|an
operator|-
name|appl_list
index|[
name|appl
operator|->
name|typ
index|]
argument_list|)
expr_stmt|;
name|passout
argument_list|(
name|appl
operator|->
name|typ
argument_list|,
name|l
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|isdn_disconnect
parameter_list|(
name|int
name|an
parameter_list|,
name|int
name|rea
parameter_list|)
block|{
name|isdn_appl_t
modifier|*
name|appl
init|=
operator|&
name|isdn_appl
index|[
name|an
index|]
decl_stmt|;
if|if
condition|(
name|ISBUSY
argument_list|(
name|appl
operator|->
name|ctrl
argument_list|)
condition|)
block|{
name|int
name|x
decl_stmt|;
name|x
operator|=
name|splhigh
argument_list|()
expr_stmt|;
operator|(
operator|*
name|isdn_ctrl
index|[
name|appl
operator|->
name|ctrl
index|]
operator|.
name|disconnect
operator|)
operator|(
name|appl
operator|->
name|ctrl
operator|,
name|rea
operator|)
expr_stmt|;
name|splx
argument_list|(
name|x
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|passout
parameter_list|(
name|int
name|unit
parameter_list|,
name|int
name|l
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|int
name|x
decl_stmt|;
name|x
operator|=
name|splhigh
argument_list|()
expr_stmt|;
if|if
condition|(
operator|(
name|bufind
index|[
name|unit
index|]
operator|+
name|l
operator|)
operator|>=
literal|256
condition|)
block|{
name|splx
argument_list|(
name|x
argument_list|)
expr_stmt|;
return|return;
block|}
name|bcopy
argument_list|(
name|buf
argument_list|,
operator|&
name|buffer
index|[
name|unit
index|]
index|[
name|bufind
index|[
name|unit
index|]
index|]
argument_list|,
name|l
argument_list|)
expr_stmt|;
name|bufind
index|[
name|unit
index|]
operator|+=
name|l
expr_stmt|;
name|buffer
index|[
name|unit
index|]
index|[
name|bufind
index|[
name|unit
index|]
operator|++
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|r_flags
operator|&
operator|(
literal|1
operator|<<
name|unit
operator|)
condition|)
block|{
name|r_flags
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|unit
operator|)
expr_stmt|;
name|wakeup
argument_list|(
operator|(
name|caddr_t
operator|)
name|buffer
index|[
name|unit
index|]
argument_list|)
expr_stmt|;
block|}
name|splx
argument_list|(
name|x
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* NISDN> 0 */
end_comment

end_unit


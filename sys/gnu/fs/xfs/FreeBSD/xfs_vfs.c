begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2000-2003 Silicon Graphics, Inc.  All Rights Reserved.  *  * This program is free software; you can redistribute it and/or modify it  * under the terms of version 2 of the GNU General Public License as  * published by the Free Software Foundation.  *  * This program is distributed in the hope that it would be useful, but  * WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  *  * Further, this software is distributed without any warranty that it is  * free of the rightful claim of any third person regarding infringement  * or the like.  Any license provided herein, whether implied or  * otherwise, applies only to this software file.  Patent licenses, if  * any, provided herein do not apply to combinations of this program with  * other software, or any other product whatsoever.  *  * You should have received a copy of the GNU General Public License along  * with this program; if not, write the Free Software Foundation, Inc., 59  * Temple Place - Suite 330, Boston MA 02111-1307, USA.  *  * Contact information: Silicon Graphics, Inc., 1600 Amphitheatre Pkwy,  * Mountain View, CA  94043, or:  *  * http://www.sgi.com  *  * For further information regarding this notice, see:  *  * http://oss.sgi.com/projects/GenInfo/SGIGPLNoticeExplan/  */
end_comment

begin_include
include|#
directive|include
file|"xfs.h"
end_include

begin_include
include|#
directive|include
file|"xfs_fs.h"
end_include

begin_include
include|#
directive|include
file|"xfs_macros.h"
end_include

begin_include
include|#
directive|include
file|"xfs_inum.h"
end_include

begin_include
include|#
directive|include
file|"xfs_log.h"
end_include

begin_include
include|#
directive|include
file|"xfs_clnt.h"
end_include

begin_include
include|#
directive|include
file|"xfs_trans.h"
end_include

begin_include
include|#
directive|include
file|"xfs_sb.h"
end_include

begin_include
include|#
directive|include
file|"xfs_ag.h"
end_include

begin_include
include|#
directive|include
file|"xfs_dir.h"
end_include

begin_include
include|#
directive|include
file|"xfs_dir2.h"
end_include

begin_include
include|#
directive|include
file|"xfs_imap.h"
end_include

begin_include
include|#
directive|include
file|"xfs_alloc.h"
end_include

begin_include
include|#
directive|include
file|"xfs_dmapi.h"
end_include

begin_include
include|#
directive|include
file|"xfs_mount.h"
end_include

begin_include
include|#
directive|include
file|"xfs_quota.h"
end_include

begin_include
include|#
directive|include
file|"xfs_mountops.h"
end_include

begin_function
name|int
name|xvfs_mount
parameter_list|(
name|struct
name|bhv_desc
modifier|*
name|bdp
parameter_list|,
name|struct
name|xfs_mount_args
modifier|*
name|args
parameter_list|,
name|struct
name|cred
modifier|*
name|cr
parameter_list|)
block|{
name|struct
name|bhv_desc
modifier|*
name|next
init|=
name|bdp
decl_stmt|;
name|ASSERT
argument_list|(
name|next
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
operator|(
name|bhvtovfsops
argument_list|(
name|next
argument_list|)
operator|)
operator|->
name|xvfs_mount
condition|)
name|next
operator|=
name|BHV_NEXT
argument_list|(
name|next
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
operator|*
name|bhvtovfsops
argument_list|(
name|next
argument_list|)
operator|->
name|xvfs_mount
operator|)
operator|(
name|next
operator|,
name|args
operator|,
name|cr
operator|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|xvfs_parseargs
parameter_list|(
name|struct
name|bhv_desc
modifier|*
name|bdp
parameter_list|,
name|char
modifier|*
name|s
parameter_list|,
name|struct
name|xfs_mount_args
modifier|*
name|args
parameter_list|,
name|int
name|f
parameter_list|)
block|{
name|struct
name|bhv_desc
modifier|*
name|next
init|=
name|bdp
decl_stmt|;
name|ASSERT
argument_list|(
name|next
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
operator|(
name|bhvtovfsops
argument_list|(
name|next
argument_list|)
operator|)
operator|->
name|xvfs_parseargs
condition|)
name|next
operator|=
name|BHV_NEXT
argument_list|(
name|next
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
operator|*
name|bhvtovfsops
argument_list|(
name|next
argument_list|)
operator|->
name|xvfs_parseargs
operator|)
operator|(
name|next
operator|,
name|s
operator|,
name|args
operator|,
name|f
operator|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|xvfs_showargs
parameter_list|(
name|struct
name|bhv_desc
modifier|*
name|bdp
parameter_list|,
name|struct
name|sbuf
modifier|*
name|m
parameter_list|)
block|{
name|struct
name|bhv_desc
modifier|*
name|next
init|=
name|bdp
decl_stmt|;
name|ASSERT
argument_list|(
name|next
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
operator|(
name|bhvtovfsops
argument_list|(
name|next
argument_list|)
operator|)
operator|->
name|xvfs_showargs
condition|)
name|next
operator|=
name|BHV_NEXT
argument_list|(
name|next
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
operator|*
name|bhvtovfsops
argument_list|(
name|next
argument_list|)
operator|->
name|xvfs_showargs
operator|)
operator|(
name|next
operator|,
name|m
operator|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|xvfs_unmount
parameter_list|(
name|struct
name|bhv_desc
modifier|*
name|bdp
parameter_list|,
name|int
name|fl
parameter_list|,
name|struct
name|cred
modifier|*
name|cr
parameter_list|)
block|{
name|struct
name|bhv_desc
modifier|*
name|next
init|=
name|bdp
decl_stmt|;
name|ASSERT
argument_list|(
name|next
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
operator|(
name|bhvtovfsops
argument_list|(
name|next
argument_list|)
operator|)
operator|->
name|xvfs_unmount
condition|)
name|next
operator|=
name|BHV_NEXT
argument_list|(
name|next
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
operator|*
name|bhvtovfsops
argument_list|(
name|next
argument_list|)
operator|->
name|xvfs_unmount
operator|)
operator|(
name|next
operator|,
name|fl
operator|,
name|cr
operator|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|xvfs_mntupdate
parameter_list|(
name|struct
name|bhv_desc
modifier|*
name|bdp
parameter_list|,
name|int
modifier|*
name|fl
parameter_list|,
name|struct
name|xfs_mount_args
modifier|*
name|args
parameter_list|)
block|{
name|struct
name|bhv_desc
modifier|*
name|next
init|=
name|bdp
decl_stmt|;
name|ASSERT
argument_list|(
name|next
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
operator|(
name|bhvtovfsops
argument_list|(
name|next
argument_list|)
operator|)
operator|->
name|xvfs_mntupdate
condition|)
name|next
operator|=
name|BHV_NEXT
argument_list|(
name|next
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
operator|*
name|bhvtovfsops
argument_list|(
name|next
argument_list|)
operator|->
name|xvfs_mntupdate
operator|)
operator|(
name|next
operator|,
name|fl
operator|,
name|args
operator|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|xvfs_root
parameter_list|(
name|struct
name|bhv_desc
modifier|*
name|bdp
parameter_list|,
name|struct
name|xfs_vnode
modifier|*
modifier|*
name|vpp
parameter_list|)
block|{
name|struct
name|bhv_desc
modifier|*
name|next
init|=
name|bdp
decl_stmt|;
name|ASSERT
argument_list|(
name|next
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
operator|(
name|bhvtovfsops
argument_list|(
name|next
argument_list|)
operator|)
operator|->
name|xvfs_root
condition|)
name|next
operator|=
name|BHV_NEXT
argument_list|(
name|next
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
operator|*
name|bhvtovfsops
argument_list|(
name|next
argument_list|)
operator|->
name|xvfs_root
operator|)
operator|(
name|next
operator|,
name|vpp
operator|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|xvfs_statvfs
parameter_list|(
name|struct
name|bhv_desc
modifier|*
name|bdp
parameter_list|,
name|struct
name|statfs
modifier|*
name|sp
parameter_list|,
name|struct
name|xfs_vnode
modifier|*
name|vp
parameter_list|)
block|{
name|struct
name|bhv_desc
modifier|*
name|next
init|=
name|bdp
decl_stmt|;
name|ASSERT
argument_list|(
name|next
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
operator|(
name|bhvtovfsops
argument_list|(
name|next
argument_list|)
operator|)
operator|->
name|xvfs_statvfs
condition|)
name|next
operator|=
name|BHV_NEXT
argument_list|(
name|next
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
operator|*
name|bhvtovfsops
argument_list|(
name|next
argument_list|)
operator|->
name|xvfs_statvfs
operator|)
operator|(
name|next
operator|,
name|sp
operator|,
name|vp
operator|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|xvfs_sync
parameter_list|(
name|struct
name|bhv_desc
modifier|*
name|bdp
parameter_list|,
name|int
name|fl
parameter_list|,
name|struct
name|cred
modifier|*
name|cr
parameter_list|)
block|{
name|struct
name|bhv_desc
modifier|*
name|next
init|=
name|bdp
decl_stmt|;
name|ASSERT
argument_list|(
name|next
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
operator|(
name|bhvtovfsops
argument_list|(
name|next
argument_list|)
operator|)
operator|->
name|xvfs_sync
condition|)
name|next
operator|=
name|BHV_NEXT
argument_list|(
name|next
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
operator|*
name|bhvtovfsops
argument_list|(
name|next
argument_list|)
operator|->
name|xvfs_sync
operator|)
operator|(
name|next
operator|,
name|fl
operator|,
name|cr
operator|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|xvfs_vget
parameter_list|(
name|struct
name|bhv_desc
modifier|*
name|bdp
parameter_list|,
name|struct
name|xfs_vnode
modifier|*
modifier|*
name|vpp
parameter_list|,
name|struct
name|fid
modifier|*
name|fidp
parameter_list|)
block|{
name|struct
name|bhv_desc
modifier|*
name|next
init|=
name|bdp
decl_stmt|;
name|ASSERT
argument_list|(
name|next
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
operator|(
name|bhvtovfsops
argument_list|(
name|next
argument_list|)
operator|)
operator|->
name|xvfs_vget
condition|)
name|next
operator|=
name|BHV_NEXT
argument_list|(
name|next
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
operator|*
name|bhvtovfsops
argument_list|(
name|next
argument_list|)
operator|->
name|xvfs_vget
operator|)
operator|(
name|next
operator|,
name|vpp
operator|,
name|fidp
operator|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|xvfs_dmapiops
parameter_list|(
name|struct
name|bhv_desc
modifier|*
name|bdp
parameter_list|,
name|caddr_t
name|addr
parameter_list|)
block|{
name|struct
name|bhv_desc
modifier|*
name|next
init|=
name|bdp
decl_stmt|;
name|ASSERT
argument_list|(
name|next
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
operator|(
name|bhvtovfsops
argument_list|(
name|next
argument_list|)
operator|)
operator|->
name|xvfs_dmapiops
condition|)
name|next
operator|=
name|BHV_NEXT
argument_list|(
name|next
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
operator|*
name|bhvtovfsops
argument_list|(
name|next
argument_list|)
operator|->
name|xvfs_dmapiops
operator|)
operator|(
name|next
operator|,
name|addr
operator|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|xvfs_quotactl
parameter_list|(
name|struct
name|bhv_desc
modifier|*
name|bdp
parameter_list|,
name|int
name|cmd
parameter_list|,
name|int
name|id
parameter_list|,
name|caddr_t
name|addr
parameter_list|)
block|{
name|struct
name|bhv_desc
modifier|*
name|next
init|=
name|bdp
decl_stmt|;
name|ASSERT
argument_list|(
name|next
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
operator|(
name|bhvtovfsops
argument_list|(
name|next
argument_list|)
operator|)
operator|->
name|xvfs_quotactl
condition|)
name|next
operator|=
name|BHV_NEXT
argument_list|(
name|next
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
operator|*
name|bhvtovfsops
argument_list|(
name|next
argument_list|)
operator|->
name|xvfs_quotactl
operator|)
operator|(
name|next
operator|,
name|cmd
operator|,
name|id
operator|,
name|addr
operator|)
operator|)
return|;
block|}
end_function

begin_function
name|struct
name|inode
modifier|*
name|xvfs_get_inode
parameter_list|(
name|struct
name|bhv_desc
modifier|*
name|bdp
parameter_list|,
name|xfs_ino_t
name|ino
parameter_list|,
name|int
name|fl
parameter_list|)
block|{
name|struct
name|bhv_desc
modifier|*
name|next
init|=
name|bdp
decl_stmt|;
while|while
condition|(
operator|!
operator|(
name|bhvtovfsops
argument_list|(
name|next
argument_list|)
operator|)
operator|->
name|xvfs_get_inode
condition|)
name|next
operator|=
name|BHV_NEXTNULL
argument_list|(
name|next
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
operator|*
name|bhvtovfsops
argument_list|(
name|next
argument_list|)
operator|->
name|xvfs_get_inode
operator|)
operator|(
name|next
operator|,
name|ino
operator|,
name|fl
operator|)
operator|)
return|;
block|}
end_function

begin_function
name|void
name|xvfs_init_vnode
parameter_list|(
name|struct
name|bhv_desc
modifier|*
name|bdp
parameter_list|,
name|struct
name|xfs_vnode
modifier|*
name|vp
parameter_list|,
name|struct
name|bhv_desc
modifier|*
name|bp
parameter_list|,
name|int
name|unlock
parameter_list|)
block|{
name|struct
name|bhv_desc
modifier|*
name|next
init|=
name|bdp
decl_stmt|;
name|ASSERT
argument_list|(
name|next
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
operator|(
name|bhvtovfsops
argument_list|(
name|next
argument_list|)
operator|)
operator|->
name|xvfs_init_vnode
condition|)
name|next
operator|=
name|BHV_NEXT
argument_list|(
name|next
argument_list|)
expr_stmt|;
operator|(
operator|(
operator|*
name|bhvtovfsops
argument_list|(
name|next
argument_list|)
operator|->
name|xvfs_init_vnode
operator|)
operator|(
name|next
operator|,
name|vp
operator|,
name|bp
operator|,
name|unlock
operator|)
operator|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|xvfs_force_shutdown
parameter_list|(
name|struct
name|bhv_desc
modifier|*
name|bdp
parameter_list|,
name|int
name|fl
parameter_list|,
name|char
modifier|*
name|file
parameter_list|,
name|int
name|line
parameter_list|)
block|{
name|struct
name|bhv_desc
modifier|*
name|next
init|=
name|bdp
decl_stmt|;
name|ASSERT
argument_list|(
name|next
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
operator|(
name|bhvtovfsops
argument_list|(
name|next
argument_list|)
operator|)
operator|->
name|xvfs_force_shutdown
condition|)
name|next
operator|=
name|BHV_NEXT
argument_list|(
name|next
argument_list|)
expr_stmt|;
operator|(
operator|(
operator|*
name|bhvtovfsops
argument_list|(
name|next
argument_list|)
operator|->
name|xvfs_force_shutdown
operator|)
operator|(
name|next
operator|,
name|fl
operator|,
name|file
operator|,
name|line
operator|)
operator|)
expr_stmt|;
block|}
end_function

begin_function
name|xfs_vfs_t
modifier|*
name|vfs_allocate
parameter_list|(
name|struct
name|mount
modifier|*
name|mp
parameter_list|)
block|{
name|struct
name|xfs_vfs
modifier|*
name|vfsp
decl_stmt|;
name|struct
name|xfsmount
modifier|*
name|xmp
decl_stmt|;
name|xmp
operator|=
name|kmem_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|xmp
argument_list|)
argument_list|,
name|KM_SLEEP
argument_list|)
expr_stmt|;
name|vfsp
operator|=
name|XFSTOVFS
argument_list|(
name|xmp
argument_list|)
expr_stmt|;
name|bhv_head_init
argument_list|(
name|VFS_BHVHEAD
argument_list|(
name|vfsp
argument_list|)
argument_list|,
literal|"vfs"
argument_list|)
expr_stmt|;
name|xmp
operator|->
name|m_mp
operator|=
name|mp
expr_stmt|;
name|mp
operator|->
name|mnt_data
operator|=
operator|(
name|qaddr_t
operator|)
name|xmp
expr_stmt|;
name|vfsp
operator|->
name|vfs_mp
operator|=
name|mp
expr_stmt|;
return|return
name|vfsp
return|;
block|}
end_function

begin_function
name|void
name|vfs_deallocate
parameter_list|(
name|struct
name|xfs_vfs
modifier|*
name|vfsp
parameter_list|)
block|{
name|struct
name|xfsmount
modifier|*
name|xmp
decl_stmt|;
name|bhv_head_destroy
argument_list|(
name|VFS_BHVHEAD
argument_list|(
name|vfsp
argument_list|)
argument_list|)
expr_stmt|;
name|xmp
operator|=
name|VFSTOXFS
argument_list|(
name|vfsp
argument_list|)
expr_stmt|;
name|kmem_free
argument_list|(
name|xmp
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|xmp
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Allocate and initialize a new XFS mount structure  */
end_comment

begin_function
name|struct
name|xfsmount
modifier|*
name|xfsmount_allocate
parameter_list|(
name|struct
name|mount
modifier|*
name|mp
parameter_list|)
block|{
name|xfs_vfs_t
modifier|*
name|vfsp
decl_stmt|;
name|vfsp
operator|=
name|vfs_allocate
argument_list|(
name|mp
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|vfsp
argument_list|)
expr_stmt|;
if|if
condition|(
name|mp
operator|->
name|mnt_flag
operator|&
name|MNT_RDONLY
condition|)
name|vfsp
operator|->
name|vfs_flag
operator||=
name|VFS_RDONLY
expr_stmt|;
name|bhv_insert_all_vfsops
argument_list|(
name|vfsp
argument_list|)
expr_stmt|;
return|return
operator|(
name|VFSTOXFS
argument_list|(
name|vfsp
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|void
name|xfsmount_deallocate
parameter_list|(
name|struct
name|xfsmount
modifier|*
name|xmp
parameter_list|)
block|{
name|xfs_vfs_t
modifier|*
name|vfsp
decl_stmt|;
name|vfsp
operator|=
name|XFSTOVFS
argument_list|(
name|xmp
argument_list|)
expr_stmt|;
name|bhv_remove_all_vfsops
argument_list|(
name|vfsp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|vfs_deallocate
argument_list|(
name|vfsp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|vfs_insertops
parameter_list|(
name|struct
name|xfs_vfs
modifier|*
name|vfsp
parameter_list|,
name|struct
name|bhv_vfsops
modifier|*
name|vfsops
parameter_list|)
block|{
name|struct
name|bhv_desc
modifier|*
name|bdp
decl_stmt|;
name|bdp
operator|=
name|kmem_alloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|bhv_desc
argument_list|)
argument_list|,
name|KM_SLEEP
argument_list|)
expr_stmt|;
name|bhv_desc_init
argument_list|(
name|bdp
argument_list|,
name|NULL
argument_list|,
name|vfsp
argument_list|,
name|vfsops
argument_list|)
expr_stmt|;
name|bhv_insert
argument_list|(
operator|&
name|vfsp
operator|->
name|vfs_bh
argument_list|,
name|bdp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|vfs_insertbhv
parameter_list|(
name|struct
name|xfs_vfs
modifier|*
name|vfsp
parameter_list|,
name|struct
name|bhv_desc
modifier|*
name|bdp
parameter_list|,
name|struct
name|xvfsops
modifier|*
name|vfsops
parameter_list|,
name|void
modifier|*
name|mount
parameter_list|)
block|{
name|bhv_desc_init
argument_list|(
name|bdp
argument_list|,
name|mount
argument_list|,
name|vfsp
argument_list|,
name|vfsops
argument_list|)
expr_stmt|;
name|bhv_insert_initial
argument_list|(
operator|&
name|vfsp
operator|->
name|vfs_bh
argument_list|,
name|bdp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|bhv_remove_vfsops
parameter_list|(
name|struct
name|xfs_vfs
modifier|*
name|vfsp
parameter_list|,
name|int
name|pos
parameter_list|)
block|{
name|struct
name|bhv_desc
modifier|*
name|bhv
decl_stmt|;
name|bhv
operator|=
name|bhv_lookup_range
argument_list|(
operator|&
name|vfsp
operator|->
name|vfs_bh
argument_list|,
name|pos
argument_list|,
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|bhv
condition|)
block|{
name|bhv_remove
argument_list|(
operator|&
name|vfsp
operator|->
name|vfs_bh
argument_list|,
name|bhv
argument_list|)
expr_stmt|;
name|kmem_free
argument_list|(
name|bhv
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|bhv
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|bhv_remove_all_vfsops
parameter_list|(
name|struct
name|xfs_vfs
modifier|*
name|vfsp
parameter_list|,
name|int
name|freebase
parameter_list|)
block|{
name|struct
name|xfs_mount
modifier|*
name|mp
decl_stmt|;
name|bhv_remove_vfsops
argument_list|(
name|vfsp
argument_list|,
name|VFS_POSITION_QM
argument_list|)
expr_stmt|;
name|bhv_remove_vfsops
argument_list|(
name|vfsp
argument_list|,
name|VFS_POSITION_DM
argument_list|)
expr_stmt|;
name|bhv_remove_vfsops
argument_list|(
name|vfsp
argument_list|,
name|VFS_POSITION_IO
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|freebase
condition|)
return|return;
name|mp
operator|=
name|XFS_BHVTOM
argument_list|(
name|bhv_lookup
argument_list|(
name|VFS_BHVHEAD
argument_list|(
name|vfsp
argument_list|)
argument_list|,
operator|&
name|xfs_vfsops
argument_list|)
argument_list|)
expr_stmt|;
name|VFS_REMOVEBHV
argument_list|(
name|vfsp
argument_list|,
operator|&
name|mp
operator|->
name|m_bhv
argument_list|)
expr_stmt|;
name|xfs_mount_free
argument_list|(
name|mp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|bhv_insert_all_vfsops
parameter_list|(
name|struct
name|xfs_vfs
modifier|*
name|vfsp
parameter_list|)
block|{
name|struct
name|xfs_mount
modifier|*
name|mp
decl_stmt|;
name|mp
operator|=
name|xfs_mount_init
argument_list|()
expr_stmt|;
name|vfs_insertbhv
argument_list|(
name|vfsp
argument_list|,
operator|&
name|mp
operator|->
name|m_bhv
argument_list|,
operator|&
name|xfs_vfsops
argument_list|,
name|mp
argument_list|)
expr_stmt|;
name|vfs_insertdmapi
argument_list|(
name|vfsp
argument_list|)
expr_stmt|;
name|vfs_insertquota
argument_list|(
name|vfsp
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


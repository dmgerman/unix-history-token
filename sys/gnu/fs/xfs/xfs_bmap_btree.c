begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2000-2003,2005 Silicon Graphics, Inc.  * All Rights Reserved.  *  * This program is free software; you can redistribute it and/or  * modify it under the terms of the GNU General Public License as  * published by the Free Software Foundation.  *  * This program is distributed in the hope that it would be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  * GNU General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program; if not, write the Free Software Foundation,  * Inc.,  51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA  */
end_comment

begin_include
include|#
directive|include
file|"xfs.h"
end_include

begin_include
include|#
directive|include
file|"xfs_fs.h"
end_include

begin_include
include|#
directive|include
file|"xfs_types.h"
end_include

begin_include
include|#
directive|include
file|"xfs_bit.h"
end_include

begin_include
include|#
directive|include
file|"xfs_log.h"
end_include

begin_include
include|#
directive|include
file|"xfs_inum.h"
end_include

begin_include
include|#
directive|include
file|"xfs_trans.h"
end_include

begin_include
include|#
directive|include
file|"xfs_sb.h"
end_include

begin_include
include|#
directive|include
file|"xfs_ag.h"
end_include

begin_include
include|#
directive|include
file|"xfs_dir.h"
end_include

begin_include
include|#
directive|include
file|"xfs_dir2.h"
end_include

begin_include
include|#
directive|include
file|"xfs_dmapi.h"
end_include

begin_include
include|#
directive|include
file|"xfs_mount.h"
end_include

begin_include
include|#
directive|include
file|"xfs_bmap_btree.h"
end_include

begin_include
include|#
directive|include
file|"xfs_alloc_btree.h"
end_include

begin_include
include|#
directive|include
file|"xfs_ialloc_btree.h"
end_include

begin_include
include|#
directive|include
file|"xfs_dir_sf.h"
end_include

begin_include
include|#
directive|include
file|"xfs_dir2_sf.h"
end_include

begin_include
include|#
directive|include
file|"xfs_attr_sf.h"
end_include

begin_include
include|#
directive|include
file|"xfs_dinode.h"
end_include

begin_include
include|#
directive|include
file|"xfs_inode.h"
end_include

begin_include
include|#
directive|include
file|"xfs_inode_item.h"
end_include

begin_include
include|#
directive|include
file|"xfs_alloc.h"
end_include

begin_include
include|#
directive|include
file|"xfs_btree.h"
end_include

begin_include
include|#
directive|include
file|"xfs_ialloc.h"
end_include

begin_include
include|#
directive|include
file|"xfs_itable.h"
end_include

begin_include
include|#
directive|include
file|"xfs_bmap.h"
end_include

begin_include
include|#
directive|include
file|"xfs_error.h"
end_include

begin_include
include|#
directive|include
file|"xfs_quota.h"
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|XFS_BMBT_TRACE
argument_list|)
end_if

begin_decl_stmt
name|ktrace_t
modifier|*
name|xfs_bmbt_trace_buf
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * Prototypes for internal btree functions.  */
end_comment

begin_function_decl
name|STATIC
name|int
name|xfs_bmbt_killroot
parameter_list|(
name|xfs_btree_cur_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|STATIC
name|void
name|xfs_bmbt_log_keys
parameter_list|(
name|xfs_btree_cur_t
modifier|*
parameter_list|,
name|xfs_buf_t
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|STATIC
name|void
name|xfs_bmbt_log_ptrs
parameter_list|(
name|xfs_btree_cur_t
modifier|*
parameter_list|,
name|xfs_buf_t
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|STATIC
name|int
name|xfs_bmbt_lshift
parameter_list|(
name|xfs_btree_cur_t
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|STATIC
name|int
name|xfs_bmbt_rshift
parameter_list|(
name|xfs_btree_cur_t
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|STATIC
name|int
name|xfs_bmbt_split
parameter_list|(
name|xfs_btree_cur_t
modifier|*
parameter_list|,
name|int
parameter_list|,
name|xfs_fsblock_t
modifier|*
parameter_list|,
name|xfs_bmbt_key_t
modifier|*
parameter_list|,
name|xfs_btree_cur_t
modifier|*
modifier|*
parameter_list|,
name|int
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|STATIC
name|int
name|xfs_bmbt_updkey
parameter_list|(
name|xfs_btree_cur_t
modifier|*
parameter_list|,
name|xfs_bmbt_key_t
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_if
if|#
directive|if
name|defined
argument_list|(
name|XFS_BMBT_TRACE
argument_list|)
end_if

begin_decl_stmt
specifier|static
name|char
name|ARGS
index|[]
init|=
literal|"args"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|ENTRY
index|[]
init|=
literal|"entry"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|ERROR
index|[]
init|=
literal|"error"
decl_stmt|;
end_decl_stmt

begin_undef
undef|#
directive|undef
name|EXIT
end_undef

begin_decl_stmt
specifier|static
name|char
name|EXIT
index|[]
init|=
literal|"exit"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Add a trace buffer entry for the arguments given to the routine,  * generic form.  */
end_comment

begin_function
name|STATIC
name|void
name|xfs_bmbt_trace_enter
parameter_list|(
name|char
modifier|*
name|func
parameter_list|,
name|xfs_btree_cur_t
modifier|*
name|cur
parameter_list|,
name|char
modifier|*
name|s
parameter_list|,
name|int
name|type
parameter_list|,
name|int
name|line
parameter_list|,
name|__psunsigned_t
name|a0
parameter_list|,
name|__psunsigned_t
name|a1
parameter_list|,
name|__psunsigned_t
name|a2
parameter_list|,
name|__psunsigned_t
name|a3
parameter_list|,
name|__psunsigned_t
name|a4
parameter_list|,
name|__psunsigned_t
name|a5
parameter_list|,
name|__psunsigned_t
name|a6
parameter_list|,
name|__psunsigned_t
name|a7
parameter_list|,
name|__psunsigned_t
name|a8
parameter_list|,
name|__psunsigned_t
name|a9
parameter_list|,
name|__psunsigned_t
name|a10
parameter_list|)
block|{
name|xfs_inode_t
modifier|*
name|ip
decl_stmt|;
name|int
name|whichfork
decl_stmt|;
name|ip
operator|=
name|cur
operator|->
name|bc_private
operator|.
name|b
operator|.
name|ip
expr_stmt|;
name|whichfork
operator|=
name|cur
operator|->
name|bc_private
operator|.
name|b
operator|.
name|whichfork
expr_stmt|;
name|ktrace_enter
argument_list|(
name|xfs_bmbt_trace_buf
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|__psint_t
operator|)
name|type
operator||
operator|(
name|whichfork
operator|<<
literal|8
operator|)
operator||
operator|(
name|line
operator|<<
literal|16
operator|)
operator|)
argument_list|,
operator|(
name|void
operator|*
operator|)
name|func
argument_list|,
operator|(
name|void
operator|*
operator|)
name|s
argument_list|,
operator|(
name|void
operator|*
operator|)
name|ip
argument_list|,
operator|(
name|void
operator|*
operator|)
name|cur
argument_list|,
operator|(
name|void
operator|*
operator|)
name|a0
argument_list|,
operator|(
name|void
operator|*
operator|)
name|a1
argument_list|,
operator|(
name|void
operator|*
operator|)
name|a2
argument_list|,
operator|(
name|void
operator|*
operator|)
name|a3
argument_list|,
operator|(
name|void
operator|*
operator|)
name|a4
argument_list|,
operator|(
name|void
operator|*
operator|)
name|a5
argument_list|,
operator|(
name|void
operator|*
operator|)
name|a6
argument_list|,
operator|(
name|void
operator|*
operator|)
name|a7
argument_list|,
operator|(
name|void
operator|*
operator|)
name|a8
argument_list|,
operator|(
name|void
operator|*
operator|)
name|a9
argument_list|,
operator|(
name|void
operator|*
operator|)
name|a10
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|ip
operator|->
name|i_btrace
argument_list|)
expr_stmt|;
name|ktrace_enter
argument_list|(
name|ip
operator|->
name|i_btrace
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|__psint_t
operator|)
name|type
operator||
operator|(
name|whichfork
operator|<<
literal|8
operator|)
operator||
operator|(
name|line
operator|<<
literal|16
operator|)
operator|)
argument_list|,
operator|(
name|void
operator|*
operator|)
name|func
argument_list|,
operator|(
name|void
operator|*
operator|)
name|s
argument_list|,
operator|(
name|void
operator|*
operator|)
name|ip
argument_list|,
operator|(
name|void
operator|*
operator|)
name|cur
argument_list|,
operator|(
name|void
operator|*
operator|)
name|a0
argument_list|,
operator|(
name|void
operator|*
operator|)
name|a1
argument_list|,
operator|(
name|void
operator|*
operator|)
name|a2
argument_list|,
operator|(
name|void
operator|*
operator|)
name|a3
argument_list|,
operator|(
name|void
operator|*
operator|)
name|a4
argument_list|,
operator|(
name|void
operator|*
operator|)
name|a5
argument_list|,
operator|(
name|void
operator|*
operator|)
name|a6
argument_list|,
operator|(
name|void
operator|*
operator|)
name|a7
argument_list|,
operator|(
name|void
operator|*
operator|)
name|a8
argument_list|,
operator|(
name|void
operator|*
operator|)
name|a9
argument_list|,
operator|(
name|void
operator|*
operator|)
name|a10
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Add a trace buffer entry for arguments, for a buffer& 1 integer arg.  */
end_comment

begin_function
name|STATIC
name|void
name|xfs_bmbt_trace_argbi
parameter_list|(
name|char
modifier|*
name|func
parameter_list|,
name|xfs_btree_cur_t
modifier|*
name|cur
parameter_list|,
name|xfs_buf_t
modifier|*
name|b
parameter_list|,
name|int
name|i
parameter_list|,
name|int
name|line
parameter_list|)
block|{
name|xfs_bmbt_trace_enter
argument_list|(
name|func
argument_list|,
name|cur
argument_list|,
name|ARGS
argument_list|,
name|XFS_BMBT_KTRACE_ARGBI
argument_list|,
name|line
argument_list|,
operator|(
name|__psunsigned_t
operator|)
name|b
argument_list|,
name|i
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Add a trace buffer entry for arguments, for a buffer& 2 integer args.  */
end_comment

begin_function
name|STATIC
name|void
name|xfs_bmbt_trace_argbii
parameter_list|(
name|char
modifier|*
name|func
parameter_list|,
name|xfs_btree_cur_t
modifier|*
name|cur
parameter_list|,
name|xfs_buf_t
modifier|*
name|b
parameter_list|,
name|int
name|i0
parameter_list|,
name|int
name|i1
parameter_list|,
name|int
name|line
parameter_list|)
block|{
name|xfs_bmbt_trace_enter
argument_list|(
name|func
argument_list|,
name|cur
argument_list|,
name|ARGS
argument_list|,
name|XFS_BMBT_KTRACE_ARGBII
argument_list|,
name|line
argument_list|,
operator|(
name|__psunsigned_t
operator|)
name|b
argument_list|,
name|i0
argument_list|,
name|i1
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Add a trace buffer entry for arguments, for 3 block-length args  * and an integer arg.  */
end_comment

begin_function
name|STATIC
name|void
name|xfs_bmbt_trace_argfffi
parameter_list|(
name|char
modifier|*
name|func
parameter_list|,
name|xfs_btree_cur_t
modifier|*
name|cur
parameter_list|,
name|xfs_dfiloff_t
name|o
parameter_list|,
name|xfs_dfsbno_t
name|b
parameter_list|,
name|xfs_dfilblks_t
name|i
parameter_list|,
name|int
name|j
parameter_list|,
name|int
name|line
parameter_list|)
block|{
name|xfs_bmbt_trace_enter
argument_list|(
name|func
argument_list|,
name|cur
argument_list|,
name|ARGS
argument_list|,
name|XFS_BMBT_KTRACE_ARGFFFI
argument_list|,
name|line
argument_list|,
name|o
operator|>>
literal|32
argument_list|,
operator|(
name|int
operator|)
name|o
argument_list|,
name|b
operator|>>
literal|32
argument_list|,
operator|(
name|int
operator|)
name|b
argument_list|,
name|i
operator|>>
literal|32
argument_list|,
operator|(
name|int
operator|)
name|i
argument_list|,
operator|(
name|int
operator|)
name|j
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Add a trace buffer entry for arguments, for one integer arg.  */
end_comment

begin_function
name|STATIC
name|void
name|xfs_bmbt_trace_argi
parameter_list|(
name|char
modifier|*
name|func
parameter_list|,
name|xfs_btree_cur_t
modifier|*
name|cur
parameter_list|,
name|int
name|i
parameter_list|,
name|int
name|line
parameter_list|)
block|{
name|xfs_bmbt_trace_enter
argument_list|(
name|func
argument_list|,
name|cur
argument_list|,
name|ARGS
argument_list|,
name|XFS_BMBT_KTRACE_ARGI
argument_list|,
name|line
argument_list|,
name|i
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Add a trace buffer entry for arguments, for int, fsblock, key.  */
end_comment

begin_function
name|STATIC
name|void
name|xfs_bmbt_trace_argifk
parameter_list|(
name|char
modifier|*
name|func
parameter_list|,
name|xfs_btree_cur_t
modifier|*
name|cur
parameter_list|,
name|int
name|i
parameter_list|,
name|xfs_fsblock_t
name|f
parameter_list|,
name|xfs_bmbt_key_t
modifier|*
name|k
parameter_list|,
name|int
name|line
parameter_list|)
block|{
name|xfs_dfsbno_t
name|d
decl_stmt|;
name|xfs_dfiloff_t
name|o
decl_stmt|;
name|d
operator|=
operator|(
name|xfs_dfsbno_t
operator|)
name|f
expr_stmt|;
name|o
operator|=
name|INT_GET
argument_list|(
name|k
operator|->
name|br_startoff
argument_list|,
name|ARCH_CONVERT
argument_list|)
expr_stmt|;
name|xfs_bmbt_trace_enter
argument_list|(
name|func
argument_list|,
name|cur
argument_list|,
name|ARGS
argument_list|,
name|XFS_BMBT_KTRACE_ARGIFK
argument_list|,
name|line
argument_list|,
name|i
argument_list|,
name|d
operator|>>
literal|32
argument_list|,
operator|(
name|int
operator|)
name|d
argument_list|,
name|o
operator|>>
literal|32
argument_list|,
operator|(
name|int
operator|)
name|o
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Add a trace buffer entry for arguments, for int, fsblock, rec.  */
end_comment

begin_function
name|STATIC
name|void
name|xfs_bmbt_trace_argifr
parameter_list|(
name|char
modifier|*
name|func
parameter_list|,
name|xfs_btree_cur_t
modifier|*
name|cur
parameter_list|,
name|int
name|i
parameter_list|,
name|xfs_fsblock_t
name|f
parameter_list|,
name|xfs_bmbt_rec_t
modifier|*
name|r
parameter_list|,
name|int
name|line
parameter_list|)
block|{
name|xfs_dfsbno_t
name|b
decl_stmt|;
name|xfs_dfilblks_t
name|c
decl_stmt|;
name|xfs_dfsbno_t
name|d
decl_stmt|;
name|xfs_dfiloff_t
name|o
decl_stmt|;
name|xfs_bmbt_irec_t
name|s
decl_stmt|;
name|d
operator|=
operator|(
name|xfs_dfsbno_t
operator|)
name|f
expr_stmt|;
name|xfs_bmbt_disk_get_all
argument_list|(
name|r
argument_list|,
operator|&
name|s
argument_list|)
expr_stmt|;
name|o
operator|=
operator|(
name|xfs_dfiloff_t
operator|)
name|s
operator|.
name|br_startoff
expr_stmt|;
name|b
operator|=
operator|(
name|xfs_dfsbno_t
operator|)
name|s
operator|.
name|br_startblock
expr_stmt|;
name|c
operator|=
name|s
operator|.
name|br_blockcount
expr_stmt|;
name|xfs_bmbt_trace_enter
argument_list|(
name|func
argument_list|,
name|cur
argument_list|,
name|ARGS
argument_list|,
name|XFS_BMBT_KTRACE_ARGIFR
argument_list|,
name|line
argument_list|,
name|i
argument_list|,
name|d
operator|>>
literal|32
argument_list|,
operator|(
name|int
operator|)
name|d
argument_list|,
name|o
operator|>>
literal|32
argument_list|,
operator|(
name|int
operator|)
name|o
argument_list|,
name|b
operator|>>
literal|32
argument_list|,
operator|(
name|int
operator|)
name|b
argument_list|,
name|c
operator|>>
literal|32
argument_list|,
operator|(
name|int
operator|)
name|c
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Add a trace buffer entry for arguments, for int, key.  */
end_comment

begin_function
name|STATIC
name|void
name|xfs_bmbt_trace_argik
parameter_list|(
name|char
modifier|*
name|func
parameter_list|,
name|xfs_btree_cur_t
modifier|*
name|cur
parameter_list|,
name|int
name|i
parameter_list|,
name|xfs_bmbt_key_t
modifier|*
name|k
parameter_list|,
name|int
name|line
parameter_list|)
block|{
name|xfs_dfiloff_t
name|o
decl_stmt|;
name|o
operator|=
name|INT_GET
argument_list|(
name|k
operator|->
name|br_startoff
argument_list|,
name|ARCH_CONVERT
argument_list|)
expr_stmt|;
name|xfs_bmbt_trace_enter
argument_list|(
name|func
argument_list|,
name|cur
argument_list|,
name|ARGS
argument_list|,
name|XFS_BMBT_KTRACE_ARGIFK
argument_list|,
name|line
argument_list|,
name|i
argument_list|,
name|o
operator|>>
literal|32
argument_list|,
operator|(
name|int
operator|)
name|o
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Add a trace buffer entry for the cursor/operation.  */
end_comment

begin_function
name|STATIC
name|void
name|xfs_bmbt_trace_cursor
parameter_list|(
name|char
modifier|*
name|func
parameter_list|,
name|xfs_btree_cur_t
modifier|*
name|cur
parameter_list|,
name|char
modifier|*
name|s
parameter_list|,
name|int
name|line
parameter_list|)
block|{
name|xfs_bmbt_rec_t
name|r
decl_stmt|;
name|xfs_bmbt_set_all
argument_list|(
operator|&
name|r
argument_list|,
operator|&
name|cur
operator|->
name|bc_rec
operator|.
name|b
argument_list|)
expr_stmt|;
name|xfs_bmbt_trace_enter
argument_list|(
name|func
argument_list|,
name|cur
argument_list|,
name|s
argument_list|,
name|XFS_BMBT_KTRACE_CUR
argument_list|,
name|line
argument_list|,
operator|(
name|cur
operator|->
name|bc_nlevels
operator|<<
literal|24
operator|)
operator||
operator|(
name|cur
operator|->
name|bc_private
operator|.
name|b
operator|.
name|flags
operator|<<
literal|16
operator|)
operator||
name|cur
operator|->
name|bc_private
operator|.
name|b
operator|.
name|allocated
argument_list|,
name|INT_GET
argument_list|(
name|r
operator|.
name|l0
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|>>
literal|32
argument_list|,
operator|(
name|int
operator|)
name|INT_GET
argument_list|(
name|r
operator|.
name|l0
argument_list|,
name|ARCH_CONVERT
argument_list|)
argument_list|,
name|INT_GET
argument_list|(
name|r
operator|.
name|l1
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|>>
literal|32
argument_list|,
operator|(
name|int
operator|)
name|INT_GET
argument_list|(
name|r
operator|.
name|l1
argument_list|,
name|ARCH_CONVERT
argument_list|)
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|cur
operator|->
name|bc_bufs
index|[
literal|0
index|]
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|cur
operator|->
name|bc_bufs
index|[
literal|1
index|]
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|cur
operator|->
name|bc_bufs
index|[
literal|2
index|]
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|cur
operator|->
name|bc_bufs
index|[
literal|3
index|]
argument_list|,
operator|(
name|cur
operator|->
name|bc_ptrs
index|[
literal|0
index|]
operator|<<
literal|16
operator|)
operator||
name|cur
operator|->
name|bc_ptrs
index|[
literal|1
index|]
argument_list|,
operator|(
name|cur
operator|->
name|bc_ptrs
index|[
literal|2
index|]
operator|<<
literal|16
operator|)
operator||
name|cur
operator|->
name|bc_ptrs
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_define
define|#
directive|define
name|XFS_BMBT_TRACE_ARGBI
parameter_list|(
name|c
parameter_list|,
name|b
parameter_list|,
name|i
parameter_list|)
define|\
value|xfs_bmbt_trace_argbi(fname, c, b, i, __LINE__)
end_define

begin_define
define|#
directive|define
name|XFS_BMBT_TRACE_ARGBII
parameter_list|(
name|c
parameter_list|,
name|b
parameter_list|,
name|i
parameter_list|,
name|j
parameter_list|)
define|\
value|xfs_bmbt_trace_argbii(fname, c, b, i, j, __LINE__)
end_define

begin_define
define|#
directive|define
name|XFS_BMBT_TRACE_ARGFFFI
parameter_list|(
name|c
parameter_list|,
name|o
parameter_list|,
name|b
parameter_list|,
name|i
parameter_list|,
name|j
parameter_list|)
define|\
value|xfs_bmbt_trace_argfffi(fname, c, o, b, i, j, __LINE__)
end_define

begin_define
define|#
directive|define
name|XFS_BMBT_TRACE_ARGI
parameter_list|(
name|c
parameter_list|,
name|i
parameter_list|)
define|\
value|xfs_bmbt_trace_argi(fname, c, i, __LINE__)
end_define

begin_define
define|#
directive|define
name|XFS_BMBT_TRACE_ARGIFK
parameter_list|(
name|c
parameter_list|,
name|i
parameter_list|,
name|f
parameter_list|,
name|k
parameter_list|)
define|\
value|xfs_bmbt_trace_argifk(fname, c, i, f, k, __LINE__)
end_define

begin_define
define|#
directive|define
name|XFS_BMBT_TRACE_ARGIFR
parameter_list|(
name|c
parameter_list|,
name|i
parameter_list|,
name|f
parameter_list|,
name|r
parameter_list|)
define|\
value|xfs_bmbt_trace_argifr(fname, c, i, f, r, __LINE__)
end_define

begin_define
define|#
directive|define
name|XFS_BMBT_TRACE_ARGIK
parameter_list|(
name|c
parameter_list|,
name|i
parameter_list|,
name|k
parameter_list|)
define|\
value|xfs_bmbt_trace_argik(fname, c, i, k, __LINE__)
end_define

begin_define
define|#
directive|define
name|XFS_BMBT_TRACE_CURSOR
parameter_list|(
name|c
parameter_list|,
name|s
parameter_list|)
define|\
value|xfs_bmbt_trace_cursor(fname, c, s, __LINE__)
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|XFS_BMBT_TRACE_ARGBI
parameter_list|(
name|c
parameter_list|,
name|b
parameter_list|,
name|i
parameter_list|)
end_define

begin_define
define|#
directive|define
name|XFS_BMBT_TRACE_ARGBII
parameter_list|(
name|c
parameter_list|,
name|b
parameter_list|,
name|i
parameter_list|,
name|j
parameter_list|)
end_define

begin_define
define|#
directive|define
name|XFS_BMBT_TRACE_ARGFFFI
parameter_list|(
name|c
parameter_list|,
name|o
parameter_list|,
name|b
parameter_list|,
name|i
parameter_list|,
name|j
parameter_list|)
end_define

begin_define
define|#
directive|define
name|XFS_BMBT_TRACE_ARGI
parameter_list|(
name|c
parameter_list|,
name|i
parameter_list|)
end_define

begin_define
define|#
directive|define
name|XFS_BMBT_TRACE_ARGIFK
parameter_list|(
name|c
parameter_list|,
name|i
parameter_list|,
name|f
parameter_list|,
name|k
parameter_list|)
end_define

begin_define
define|#
directive|define
name|XFS_BMBT_TRACE_ARGIFR
parameter_list|(
name|c
parameter_list|,
name|i
parameter_list|,
name|f
parameter_list|,
name|r
parameter_list|)
end_define

begin_define
define|#
directive|define
name|XFS_BMBT_TRACE_ARGIK
parameter_list|(
name|c
parameter_list|,
name|i
parameter_list|,
name|k
parameter_list|)
end_define

begin_define
define|#
directive|define
name|XFS_BMBT_TRACE_CURSOR
parameter_list|(
name|c
parameter_list|,
name|s
parameter_list|)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* XFS_BMBT_TRACE */
end_comment

begin_comment
comment|/*  * Internal functions.  */
end_comment

begin_comment
comment|/*  * Delete record pointed to by cur/level.  */
end_comment

begin_function
name|STATIC
name|int
comment|/* error */
name|xfs_bmbt_delrec
parameter_list|(
name|xfs_btree_cur_t
modifier|*
name|cur
parameter_list|,
name|int
name|level
parameter_list|,
name|int
modifier|*
name|stat
parameter_list|)
comment|/* success/failure */
block|{
name|xfs_bmbt_block_t
modifier|*
name|block
decl_stmt|;
comment|/* bmap btree block */
name|xfs_fsblock_t
name|bno
decl_stmt|;
comment|/* fs-relative block number */
name|xfs_buf_t
modifier|*
name|bp
decl_stmt|;
comment|/* buffer for block */
name|int
name|error
decl_stmt|;
comment|/* error return value */
ifdef|#
directive|ifdef
name|XFS_BMBT_TRACE
specifier|static
name|char
name|fname
index|[]
init|=
literal|"xfs_bmbt_delrec"
decl_stmt|;
endif|#
directive|endif
name|int
name|i
decl_stmt|;
comment|/* loop counter */
name|int
name|j
decl_stmt|;
comment|/* temp state */
name|xfs_bmbt_key_t
name|key
decl_stmt|;
comment|/* bmap btree key */
name|xfs_bmbt_key_t
modifier|*
name|kp
init|=
name|NULL
decl_stmt|;
comment|/* pointer to bmap btree key */
name|xfs_fsblock_t
name|lbno
decl_stmt|;
comment|/* left sibling block number */
name|xfs_buf_t
modifier|*
name|lbp
decl_stmt|;
comment|/* left buffer pointer */
name|xfs_bmbt_block_t
modifier|*
name|left
decl_stmt|;
comment|/* left btree block */
name|xfs_bmbt_key_t
modifier|*
name|lkp
decl_stmt|;
comment|/* left btree key */
name|xfs_bmbt_ptr_t
modifier|*
name|lpp
decl_stmt|;
comment|/* left address pointer */
name|int
name|lrecs
init|=
literal|0
decl_stmt|;
comment|/* left record count */
name|xfs_bmbt_rec_t
modifier|*
name|lrp
decl_stmt|;
comment|/* left record pointer */
name|xfs_mount_t
modifier|*
name|mp
decl_stmt|;
comment|/* file system mount point */
name|xfs_bmbt_ptr_t
modifier|*
name|pp
decl_stmt|;
comment|/* pointer to bmap block addr */
name|int
name|ptr
decl_stmt|;
comment|/* key/record index */
name|xfs_fsblock_t
name|rbno
decl_stmt|;
comment|/* right sibling block number */
name|xfs_buf_t
modifier|*
name|rbp
decl_stmt|;
comment|/* right buffer pointer */
name|xfs_bmbt_block_t
modifier|*
name|right
decl_stmt|;
comment|/* right btree block */
name|xfs_bmbt_key_t
modifier|*
name|rkp
decl_stmt|;
comment|/* right btree key */
name|xfs_bmbt_rec_t
modifier|*
name|rp
decl_stmt|;
comment|/* pointer to bmap btree rec */
name|xfs_bmbt_ptr_t
modifier|*
name|rpp
decl_stmt|;
comment|/* right address pointer */
name|xfs_bmbt_block_t
modifier|*
name|rrblock
decl_stmt|;
comment|/* right-right btree block */
name|xfs_buf_t
modifier|*
name|rrbp
decl_stmt|;
comment|/* right-right buffer pointer */
name|int
name|rrecs
init|=
literal|0
decl_stmt|;
comment|/* right record count */
name|xfs_bmbt_rec_t
modifier|*
name|rrp
decl_stmt|;
comment|/* right record pointer */
name|xfs_btree_cur_t
modifier|*
name|tcur
decl_stmt|;
comment|/* temporary btree cursor */
name|int
name|numrecs
decl_stmt|;
comment|/* temporary numrec count */
name|int
name|numlrecs
decl_stmt|,
name|numrrecs
decl_stmt|;
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ENTRY
argument_list|)
expr_stmt|;
name|XFS_BMBT_TRACE_ARGI
argument_list|(
name|cur
argument_list|,
name|level
argument_list|)
expr_stmt|;
name|ptr
operator|=
name|cur
operator|->
name|bc_ptrs
index|[
name|level
index|]
expr_stmt|;
name|tcur
operator|=
operator|(
name|xfs_btree_cur_t
operator|*
operator|)
literal|0
expr_stmt|;
if|if
condition|(
name|ptr
operator|==
literal|0
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|EXIT
argument_list|)
expr_stmt|;
operator|*
name|stat
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
name|block
operator|=
name|xfs_bmbt_get_block
argument_list|(
name|cur
argument_list|,
name|level
argument_list|,
operator|&
name|bp
argument_list|)
expr_stmt|;
name|numrecs
operator|=
name|be16_to_cpu
argument_list|(
name|block
operator|->
name|bb_numrecs
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_btree_check_lblock
argument_list|(
name|cur
argument_list|,
name|block
argument_list|,
name|level
argument_list|,
name|bp
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
goto|goto
name|error0
goto|;
block|}
endif|#
directive|endif
if|if
condition|(
name|ptr
operator|>
name|numrecs
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|EXIT
argument_list|)
expr_stmt|;
operator|*
name|stat
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
name|XFS_STATS_INC
argument_list|(
name|xs_bmbt_delrec
argument_list|)
expr_stmt|;
if|if
condition|(
name|level
operator|>
literal|0
condition|)
block|{
name|kp
operator|=
name|XFS_BMAP_KEY_IADDR
argument_list|(
name|block
argument_list|,
literal|1
argument_list|,
name|cur
argument_list|)
expr_stmt|;
name|pp
operator|=
name|XFS_BMAP_PTR_IADDR
argument_list|(
name|block
argument_list|,
literal|1
argument_list|,
name|cur
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
for|for
control|(
name|i
operator|=
name|ptr
init|;
name|i
operator|<
name|numrecs
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_btree_check_lptr
argument_list|(
name|cur
argument_list|,
name|INT_GET
argument_list|(
name|pp
index|[
name|i
index|]
argument_list|,
name|ARCH_CONVERT
argument_list|)
argument_list|,
name|level
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
goto|goto
name|error0
goto|;
block|}
block|}
endif|#
directive|endif
if|if
condition|(
name|ptr
operator|<
name|numrecs
condition|)
block|{
name|memmove
argument_list|(
operator|&
name|kp
index|[
name|ptr
operator|-
literal|1
index|]
argument_list|,
operator|&
name|kp
index|[
name|ptr
index|]
argument_list|,
operator|(
name|numrecs
operator|-
name|ptr
operator|)
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|kp
argument_list|)
argument_list|)
expr_stmt|;
name|memmove
argument_list|(
operator|&
name|pp
index|[
name|ptr
operator|-
literal|1
index|]
argument_list|,
operator|&
name|pp
index|[
name|ptr
index|]
argument_list|,
comment|/* INT_: direct copy */
operator|(
name|numrecs
operator|-
name|ptr
operator|)
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|pp
argument_list|)
argument_list|)
expr_stmt|;
name|xfs_bmbt_log_ptrs
argument_list|(
name|cur
argument_list|,
name|bp
argument_list|,
name|ptr
argument_list|,
name|numrecs
operator|-
literal|1
argument_list|)
expr_stmt|;
name|xfs_bmbt_log_keys
argument_list|(
name|cur
argument_list|,
name|bp
argument_list|,
name|ptr
argument_list|,
name|numrecs
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|rp
operator|=
name|XFS_BMAP_REC_IADDR
argument_list|(
name|block
argument_list|,
literal|1
argument_list|,
name|cur
argument_list|)
expr_stmt|;
if|if
condition|(
name|ptr
operator|<
name|numrecs
condition|)
block|{
name|memmove
argument_list|(
operator|&
name|rp
index|[
name|ptr
operator|-
literal|1
index|]
argument_list|,
operator|&
name|rp
index|[
name|ptr
index|]
argument_list|,
operator|(
name|numrecs
operator|-
name|ptr
operator|)
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|rp
argument_list|)
argument_list|)
expr_stmt|;
name|xfs_bmbt_log_recs
argument_list|(
name|cur
argument_list|,
name|bp
argument_list|,
name|ptr
argument_list|,
name|numrecs
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ptr
operator|==
literal|1
condition|)
block|{
name|INT_SET
argument_list|(
name|key
operator|.
name|br_startoff
argument_list|,
name|ARCH_CONVERT
argument_list|,
name|xfs_bmbt_disk_get_startoff
argument_list|(
name|rp
argument_list|)
argument_list|)
expr_stmt|;
name|kp
operator|=
operator|&
name|key
expr_stmt|;
block|}
block|}
name|numrecs
operator|--
expr_stmt|;
name|block
operator|->
name|bb_numrecs
operator|=
name|cpu_to_be16
argument_list|(
name|numrecs
argument_list|)
expr_stmt|;
name|xfs_bmbt_log_block
argument_list|(
name|cur
argument_list|,
name|bp
argument_list|,
name|XFS_BB_NUMRECS
argument_list|)
expr_stmt|;
comment|/* 	 * We're at the root level. 	 * First, shrink the root block in-memory. 	 * Try to get rid of the next level down. 	 * If we can't then there's nothing left to do. 	 */
if|if
condition|(
name|level
operator|==
name|cur
operator|->
name|bc_nlevels
operator|-
literal|1
condition|)
block|{
name|xfs_iroot_realloc
argument_list|(
name|cur
operator|->
name|bc_private
operator|.
name|b
operator|.
name|ip
argument_list|,
operator|-
literal|1
argument_list|,
name|cur
operator|->
name|bc_private
operator|.
name|b
operator|.
name|whichfork
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_bmbt_killroot
argument_list|(
name|cur
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
goto|goto
name|error0
goto|;
block|}
if|if
condition|(
name|level
operator|>
literal|0
operator|&&
operator|(
name|error
operator|=
name|xfs_bmbt_decrement
argument_list|(
name|cur
argument_list|,
name|level
argument_list|,
operator|&
name|j
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
goto|goto
name|error0
goto|;
block|}
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|EXIT
argument_list|)
expr_stmt|;
operator|*
name|stat
operator|=
literal|1
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|ptr
operator|==
literal|1
operator|&&
operator|(
name|error
operator|=
name|xfs_bmbt_updkey
argument_list|(
name|cur
argument_list|,
name|kp
argument_list|,
name|level
operator|+
literal|1
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
goto|goto
name|error0
goto|;
block|}
if|if
condition|(
name|numrecs
operator|>=
name|XFS_BMAP_BLOCK_IMINRECS
argument_list|(
name|level
argument_list|,
name|cur
argument_list|)
condition|)
block|{
if|if
condition|(
name|level
operator|>
literal|0
operator|&&
operator|(
name|error
operator|=
name|xfs_bmbt_decrement
argument_list|(
name|cur
argument_list|,
name|level
argument_list|,
operator|&
name|j
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
goto|goto
name|error0
goto|;
block|}
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|EXIT
argument_list|)
expr_stmt|;
operator|*
name|stat
operator|=
literal|1
expr_stmt|;
return|return
literal|0
return|;
block|}
name|rbno
operator|=
name|be64_to_cpu
argument_list|(
name|block
operator|->
name|bb_rightsib
argument_list|)
expr_stmt|;
name|lbno
operator|=
name|be64_to_cpu
argument_list|(
name|block
operator|->
name|bb_leftsib
argument_list|)
expr_stmt|;
comment|/* 	 * One child of root, need to get a chance to copy its contents 	 * into the root and delete it. Can't go up to next level, 	 * there's nothing to delete there. 	 */
if|if
condition|(
name|lbno
operator|==
name|NULLFSBLOCK
operator|&&
name|rbno
operator|==
name|NULLFSBLOCK
operator|&&
name|level
operator|==
name|cur
operator|->
name|bc_nlevels
operator|-
literal|2
condition|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_bmbt_killroot
argument_list|(
name|cur
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
goto|goto
name|error0
goto|;
block|}
if|if
condition|(
name|level
operator|>
literal|0
operator|&&
operator|(
name|error
operator|=
name|xfs_bmbt_decrement
argument_list|(
name|cur
argument_list|,
name|level
argument_list|,
operator|&
name|i
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
goto|goto
name|error0
goto|;
block|}
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|EXIT
argument_list|)
expr_stmt|;
operator|*
name|stat
operator|=
literal|1
expr_stmt|;
return|return
literal|0
return|;
block|}
name|ASSERT
argument_list|(
name|rbno
operator|!=
name|NULLFSBLOCK
operator|||
name|lbno
operator|!=
name|NULLFSBLOCK
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_btree_dup_cursor
argument_list|(
name|cur
argument_list|,
operator|&
name|tcur
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
goto|goto
name|error0
goto|;
block|}
name|bno
operator|=
name|NULLFSBLOCK
expr_stmt|;
if|if
condition|(
name|rbno
operator|!=
name|NULLFSBLOCK
condition|)
block|{
name|i
operator|=
name|xfs_btree_lastrec
argument_list|(
name|tcur
argument_list|,
name|level
argument_list|)
expr_stmt|;
name|XFS_WANT_CORRUPTED_GOTO
argument_list|(
name|i
operator|==
literal|1
argument_list|,
name|error0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_bmbt_increment
argument_list|(
name|tcur
argument_list|,
name|level
argument_list|,
operator|&
name|i
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
goto|goto
name|error0
goto|;
block|}
name|XFS_WANT_CORRUPTED_GOTO
argument_list|(
name|i
operator|==
literal|1
argument_list|,
name|error0
argument_list|)
expr_stmt|;
name|i
operator|=
name|xfs_btree_lastrec
argument_list|(
name|tcur
argument_list|,
name|level
argument_list|)
expr_stmt|;
name|XFS_WANT_CORRUPTED_GOTO
argument_list|(
name|i
operator|==
literal|1
argument_list|,
name|error0
argument_list|)
expr_stmt|;
name|rbp
operator|=
name|tcur
operator|->
name|bc_bufs
index|[
name|level
index|]
expr_stmt|;
name|right
operator|=
name|XFS_BUF_TO_BMBT_BLOCK
argument_list|(
name|rbp
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_btree_check_lblock
argument_list|(
name|cur
argument_list|,
name|right
argument_list|,
name|level
argument_list|,
name|rbp
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
goto|goto
name|error0
goto|;
block|}
endif|#
directive|endif
name|bno
operator|=
name|be64_to_cpu
argument_list|(
name|right
operator|->
name|bb_leftsib
argument_list|)
expr_stmt|;
if|if
condition|(
name|be16_to_cpu
argument_list|(
name|right
operator|->
name|bb_numrecs
argument_list|)
operator|-
literal|1
operator|>=
name|XFS_BMAP_BLOCK_IMINRECS
argument_list|(
name|level
argument_list|,
name|cur
argument_list|)
condition|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_bmbt_lshift
argument_list|(
name|tcur
argument_list|,
name|level
argument_list|,
operator|&
name|i
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
goto|goto
name|error0
goto|;
block|}
if|if
condition|(
name|i
condition|)
block|{
name|ASSERT
argument_list|(
name|be16_to_cpu
argument_list|(
name|block
operator|->
name|bb_numrecs
argument_list|)
operator|>=
name|XFS_BMAP_BLOCK_IMINRECS
argument_list|(
name|level
argument_list|,
name|tcur
argument_list|)
argument_list|)
expr_stmt|;
name|xfs_btree_del_cursor
argument_list|(
name|tcur
argument_list|,
name|XFS_BTREE_NOERROR
argument_list|)
expr_stmt|;
name|tcur
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|level
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_bmbt_decrement
argument_list|(
name|cur
argument_list|,
name|level
argument_list|,
operator|&
name|i
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
goto|goto
name|error0
goto|;
block|}
block|}
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|EXIT
argument_list|)
expr_stmt|;
operator|*
name|stat
operator|=
literal|1
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
name|rrecs
operator|=
name|be16_to_cpu
argument_list|(
name|right
operator|->
name|bb_numrecs
argument_list|)
expr_stmt|;
if|if
condition|(
name|lbno
operator|!=
name|NULLFSBLOCK
condition|)
block|{
name|i
operator|=
name|xfs_btree_firstrec
argument_list|(
name|tcur
argument_list|,
name|level
argument_list|)
expr_stmt|;
name|XFS_WANT_CORRUPTED_GOTO
argument_list|(
name|i
operator|==
literal|1
argument_list|,
name|error0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_bmbt_decrement
argument_list|(
name|tcur
argument_list|,
name|level
argument_list|,
operator|&
name|i
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
goto|goto
name|error0
goto|;
block|}
name|XFS_WANT_CORRUPTED_GOTO
argument_list|(
name|i
operator|==
literal|1
argument_list|,
name|error0
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|lbno
operator|!=
name|NULLFSBLOCK
condition|)
block|{
name|i
operator|=
name|xfs_btree_firstrec
argument_list|(
name|tcur
argument_list|,
name|level
argument_list|)
expr_stmt|;
name|XFS_WANT_CORRUPTED_GOTO
argument_list|(
name|i
operator|==
literal|1
argument_list|,
name|error0
argument_list|)
expr_stmt|;
comment|/* 		 * decrement to last in block 		 */
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_bmbt_decrement
argument_list|(
name|tcur
argument_list|,
name|level
argument_list|,
operator|&
name|i
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
goto|goto
name|error0
goto|;
block|}
name|i
operator|=
name|xfs_btree_firstrec
argument_list|(
name|tcur
argument_list|,
name|level
argument_list|)
expr_stmt|;
name|XFS_WANT_CORRUPTED_GOTO
argument_list|(
name|i
operator|==
literal|1
argument_list|,
name|error0
argument_list|)
expr_stmt|;
name|lbp
operator|=
name|tcur
operator|->
name|bc_bufs
index|[
name|level
index|]
expr_stmt|;
name|left
operator|=
name|XFS_BUF_TO_BMBT_BLOCK
argument_list|(
name|lbp
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_btree_check_lblock
argument_list|(
name|cur
argument_list|,
name|left
argument_list|,
name|level
argument_list|,
name|lbp
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
goto|goto
name|error0
goto|;
block|}
endif|#
directive|endif
name|bno
operator|=
name|be64_to_cpu
argument_list|(
name|left
operator|->
name|bb_rightsib
argument_list|)
expr_stmt|;
if|if
condition|(
name|be16_to_cpu
argument_list|(
name|left
operator|->
name|bb_numrecs
argument_list|)
operator|-
literal|1
operator|>=
name|XFS_BMAP_BLOCK_IMINRECS
argument_list|(
name|level
argument_list|,
name|cur
argument_list|)
condition|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_bmbt_rshift
argument_list|(
name|tcur
argument_list|,
name|level
argument_list|,
operator|&
name|i
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
goto|goto
name|error0
goto|;
block|}
if|if
condition|(
name|i
condition|)
block|{
name|ASSERT
argument_list|(
name|be16_to_cpu
argument_list|(
name|block
operator|->
name|bb_numrecs
argument_list|)
operator|>=
name|XFS_BMAP_BLOCK_IMINRECS
argument_list|(
name|level
argument_list|,
name|tcur
argument_list|)
argument_list|)
expr_stmt|;
name|xfs_btree_del_cursor
argument_list|(
name|tcur
argument_list|,
name|XFS_BTREE_NOERROR
argument_list|)
expr_stmt|;
name|tcur
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|level
operator|==
literal|0
condition|)
name|cur
operator|->
name|bc_ptrs
index|[
literal|0
index|]
operator|++
expr_stmt|;
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|EXIT
argument_list|)
expr_stmt|;
operator|*
name|stat
operator|=
literal|1
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
name|lrecs
operator|=
name|be16_to_cpu
argument_list|(
name|left
operator|->
name|bb_numrecs
argument_list|)
expr_stmt|;
block|}
name|xfs_btree_del_cursor
argument_list|(
name|tcur
argument_list|,
name|XFS_BTREE_NOERROR
argument_list|)
expr_stmt|;
name|tcur
operator|=
name|NULL
expr_stmt|;
name|mp
operator|=
name|cur
operator|->
name|bc_mp
expr_stmt|;
name|ASSERT
argument_list|(
name|bno
operator|!=
name|NULLFSBLOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|lbno
operator|!=
name|NULLFSBLOCK
operator|&&
name|lrecs
operator|+
name|be16_to_cpu
argument_list|(
name|block
operator|->
name|bb_numrecs
argument_list|)
operator|<=
name|XFS_BMAP_BLOCK_IMAXRECS
argument_list|(
name|level
argument_list|,
name|cur
argument_list|)
condition|)
block|{
name|rbno
operator|=
name|bno
expr_stmt|;
name|right
operator|=
name|block
expr_stmt|;
name|rbp
operator|=
name|bp
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_btree_read_bufl
argument_list|(
name|mp
argument_list|,
name|cur
operator|->
name|bc_tp
argument_list|,
name|lbno
argument_list|,
literal|0
argument_list|,
operator|&
name|lbp
argument_list|,
name|XFS_BMAP_BTREE_REF
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
goto|goto
name|error0
goto|;
block|}
name|left
operator|=
name|XFS_BUF_TO_BMBT_BLOCK
argument_list|(
name|lbp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_btree_check_lblock
argument_list|(
name|cur
argument_list|,
name|left
argument_list|,
name|level
argument_list|,
name|lbp
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
goto|goto
name|error0
goto|;
block|}
block|}
elseif|else
if|if
condition|(
name|rbno
operator|!=
name|NULLFSBLOCK
operator|&&
name|rrecs
operator|+
name|be16_to_cpu
argument_list|(
name|block
operator|->
name|bb_numrecs
argument_list|)
operator|<=
name|XFS_BMAP_BLOCK_IMAXRECS
argument_list|(
name|level
argument_list|,
name|cur
argument_list|)
condition|)
block|{
name|lbno
operator|=
name|bno
expr_stmt|;
name|left
operator|=
name|block
expr_stmt|;
name|lbp
operator|=
name|bp
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_btree_read_bufl
argument_list|(
name|mp
argument_list|,
name|cur
operator|->
name|bc_tp
argument_list|,
name|rbno
argument_list|,
literal|0
argument_list|,
operator|&
name|rbp
argument_list|,
name|XFS_BMAP_BTREE_REF
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
goto|goto
name|error0
goto|;
block|}
name|right
operator|=
name|XFS_BUF_TO_BMBT_BLOCK
argument_list|(
name|rbp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_btree_check_lblock
argument_list|(
name|cur
argument_list|,
name|right
argument_list|,
name|level
argument_list|,
name|rbp
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
goto|goto
name|error0
goto|;
block|}
name|lrecs
operator|=
name|be16_to_cpu
argument_list|(
name|left
operator|->
name|bb_numrecs
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|level
operator|>
literal|0
operator|&&
operator|(
name|error
operator|=
name|xfs_bmbt_decrement
argument_list|(
name|cur
argument_list|,
name|level
argument_list|,
operator|&
name|i
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
goto|goto
name|error0
goto|;
block|}
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|EXIT
argument_list|)
expr_stmt|;
operator|*
name|stat
operator|=
literal|1
expr_stmt|;
return|return
literal|0
return|;
block|}
name|numlrecs
operator|=
name|be16_to_cpu
argument_list|(
name|left
operator|->
name|bb_numrecs
argument_list|)
expr_stmt|;
name|numrrecs
operator|=
name|be16_to_cpu
argument_list|(
name|right
operator|->
name|bb_numrecs
argument_list|)
expr_stmt|;
if|if
condition|(
name|level
operator|>
literal|0
condition|)
block|{
name|lkp
operator|=
name|XFS_BMAP_KEY_IADDR
argument_list|(
name|left
argument_list|,
name|numlrecs
operator|+
literal|1
argument_list|,
name|cur
argument_list|)
expr_stmt|;
name|lpp
operator|=
name|XFS_BMAP_PTR_IADDR
argument_list|(
name|left
argument_list|,
name|numlrecs
operator|+
literal|1
argument_list|,
name|cur
argument_list|)
expr_stmt|;
name|rkp
operator|=
name|XFS_BMAP_KEY_IADDR
argument_list|(
name|right
argument_list|,
literal|1
argument_list|,
name|cur
argument_list|)
expr_stmt|;
name|rpp
operator|=
name|XFS_BMAP_PTR_IADDR
argument_list|(
name|right
argument_list|,
literal|1
argument_list|,
name|cur
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|numrrecs
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_btree_check_lptr
argument_list|(
name|cur
argument_list|,
name|INT_GET
argument_list|(
name|rpp
index|[
name|i
index|]
argument_list|,
name|ARCH_CONVERT
argument_list|)
argument_list|,
name|level
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
goto|goto
name|error0
goto|;
block|}
block|}
endif|#
directive|endif
name|memcpy
argument_list|(
name|lkp
argument_list|,
name|rkp
argument_list|,
name|numrrecs
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|lkp
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|lpp
argument_list|,
name|rpp
argument_list|,
name|numrrecs
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|lpp
argument_list|)
argument_list|)
expr_stmt|;
name|xfs_bmbt_log_keys
argument_list|(
name|cur
argument_list|,
name|lbp
argument_list|,
name|numlrecs
operator|+
literal|1
argument_list|,
name|numlrecs
operator|+
name|numrrecs
argument_list|)
expr_stmt|;
name|xfs_bmbt_log_ptrs
argument_list|(
name|cur
argument_list|,
name|lbp
argument_list|,
name|numlrecs
operator|+
literal|1
argument_list|,
name|numlrecs
operator|+
name|numrrecs
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|lrp
operator|=
name|XFS_BMAP_REC_IADDR
argument_list|(
name|left
argument_list|,
name|numlrecs
operator|+
literal|1
argument_list|,
name|cur
argument_list|)
expr_stmt|;
name|rrp
operator|=
name|XFS_BMAP_REC_IADDR
argument_list|(
name|right
argument_list|,
literal|1
argument_list|,
name|cur
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|lrp
argument_list|,
name|rrp
argument_list|,
name|numrrecs
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|lrp
argument_list|)
argument_list|)
expr_stmt|;
name|xfs_bmbt_log_recs
argument_list|(
name|cur
argument_list|,
name|lbp
argument_list|,
name|numlrecs
operator|+
literal|1
argument_list|,
name|numlrecs
operator|+
name|numrrecs
argument_list|)
expr_stmt|;
block|}
name|be16_add
argument_list|(
operator|&
name|left
operator|->
name|bb_numrecs
argument_list|,
name|numrrecs
argument_list|)
expr_stmt|;
name|left
operator|->
name|bb_rightsib
operator|=
name|right
operator|->
name|bb_rightsib
expr_stmt|;
name|xfs_bmbt_log_block
argument_list|(
name|cur
argument_list|,
name|lbp
argument_list|,
name|XFS_BB_RIGHTSIB
operator||
name|XFS_BB_NUMRECS
argument_list|)
expr_stmt|;
if|if
condition|(
name|be64_to_cpu
argument_list|(
name|left
operator|->
name|bb_rightsib
argument_list|)
operator|!=
name|NULLDFSBNO
condition|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_btree_read_bufl
argument_list|(
name|mp
argument_list|,
name|cur
operator|->
name|bc_tp
argument_list|,
name|be64_to_cpu
argument_list|(
name|left
operator|->
name|bb_rightsib
argument_list|)
argument_list|,
literal|0
argument_list|,
operator|&
name|rrbp
argument_list|,
name|XFS_BMAP_BTREE_REF
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
goto|goto
name|error0
goto|;
block|}
name|rrblock
operator|=
name|XFS_BUF_TO_BMBT_BLOCK
argument_list|(
name|rrbp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_btree_check_lblock
argument_list|(
name|cur
argument_list|,
name|rrblock
argument_list|,
name|level
argument_list|,
name|rrbp
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
goto|goto
name|error0
goto|;
block|}
name|rrblock
operator|->
name|bb_leftsib
operator|=
name|cpu_to_be64
argument_list|(
name|lbno
argument_list|)
expr_stmt|;
name|xfs_bmbt_log_block
argument_list|(
name|cur
argument_list|,
name|rrbp
argument_list|,
name|XFS_BB_LEFTSIB
argument_list|)
expr_stmt|;
block|}
name|xfs_bmap_add_free
argument_list|(
name|XFS_DADDR_TO_FSB
argument_list|(
name|mp
argument_list|,
name|XFS_BUF_ADDR
argument_list|(
name|rbp
argument_list|)
argument_list|)
argument_list|,
literal|1
argument_list|,
name|cur
operator|->
name|bc_private
operator|.
name|b
operator|.
name|flist
argument_list|,
name|mp
argument_list|)
expr_stmt|;
name|cur
operator|->
name|bc_private
operator|.
name|b
operator|.
name|ip
operator|->
name|i_d
operator|.
name|di_nblocks
operator|--
expr_stmt|;
name|xfs_trans_log_inode
argument_list|(
name|cur
operator|->
name|bc_tp
argument_list|,
name|cur
operator|->
name|bc_private
operator|.
name|b
operator|.
name|ip
argument_list|,
name|XFS_ILOG_CORE
argument_list|)
expr_stmt|;
name|XFS_TRANS_MOD_DQUOT_BYINO
argument_list|(
name|mp
argument_list|,
name|cur
operator|->
name|bc_tp
argument_list|,
name|cur
operator|->
name|bc_private
operator|.
name|b
operator|.
name|ip
argument_list|,
name|XFS_TRANS_DQ_BCOUNT
argument_list|,
operator|-
literal|1L
argument_list|)
expr_stmt|;
name|xfs_trans_binval
argument_list|(
name|cur
operator|->
name|bc_tp
argument_list|,
name|rbp
argument_list|)
expr_stmt|;
if|if
condition|(
name|bp
operator|!=
name|lbp
condition|)
block|{
name|cur
operator|->
name|bc_bufs
index|[
name|level
index|]
operator|=
name|lbp
expr_stmt|;
name|cur
operator|->
name|bc_ptrs
index|[
name|level
index|]
operator|+=
name|lrecs
expr_stmt|;
name|cur
operator|->
name|bc_ra
index|[
name|level
index|]
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_bmbt_increment
argument_list|(
name|cur
argument_list|,
name|level
operator|+
literal|1
argument_list|,
operator|&
name|i
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
goto|goto
name|error0
goto|;
block|}
if|if
condition|(
name|level
operator|>
literal|0
condition|)
name|cur
operator|->
name|bc_ptrs
index|[
name|level
index|]
operator|--
expr_stmt|;
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|EXIT
argument_list|)
expr_stmt|;
operator|*
name|stat
operator|=
literal|2
expr_stmt|;
return|return
literal|0
return|;
name|error0
label|:
if|if
condition|(
name|tcur
condition|)
name|xfs_btree_del_cursor
argument_list|(
name|tcur
argument_list|,
name|XFS_BTREE_ERROR
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|DEBUG
end_ifdef

begin_comment
comment|/*  * Get the data from the pointed-to record.  */
end_comment

begin_function
name|int
name|xfs_bmbt_get_rec
parameter_list|(
name|xfs_btree_cur_t
modifier|*
name|cur
parameter_list|,
name|xfs_fileoff_t
modifier|*
name|off
parameter_list|,
name|xfs_fsblock_t
modifier|*
name|bno
parameter_list|,
name|xfs_filblks_t
modifier|*
name|len
parameter_list|,
name|xfs_exntst_t
modifier|*
name|state
parameter_list|,
name|int
modifier|*
name|stat
parameter_list|)
block|{
name|xfs_bmbt_block_t
modifier|*
name|block
decl_stmt|;
name|xfs_buf_t
modifier|*
name|bp
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|int
name|error
decl_stmt|;
endif|#
directive|endif
name|int
name|ptr
decl_stmt|;
name|xfs_bmbt_rec_t
modifier|*
name|rp
decl_stmt|;
name|block
operator|=
name|xfs_bmbt_get_block
argument_list|(
name|cur
argument_list|,
literal|0
argument_list|,
operator|&
name|bp
argument_list|)
expr_stmt|;
name|ptr
operator|=
name|cur
operator|->
name|bc_ptrs
index|[
literal|0
index|]
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_btree_check_lblock
argument_list|(
name|cur
argument_list|,
name|block
argument_list|,
literal|0
argument_list|,
name|bp
argument_list|)
operator|)
condition|)
return|return
name|error
return|;
endif|#
directive|endif
if|if
condition|(
name|ptr
operator|>
name|be16_to_cpu
argument_list|(
name|block
operator|->
name|bb_numrecs
argument_list|)
operator|||
name|ptr
operator|<=
literal|0
condition|)
block|{
operator|*
name|stat
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
name|rp
operator|=
name|XFS_BMAP_REC_IADDR
argument_list|(
name|block
argument_list|,
name|ptr
argument_list|,
name|cur
argument_list|)
expr_stmt|;
operator|*
name|off
operator|=
name|xfs_bmbt_disk_get_startoff
argument_list|(
name|rp
argument_list|)
expr_stmt|;
operator|*
name|bno
operator|=
name|xfs_bmbt_disk_get_startblock
argument_list|(
name|rp
argument_list|)
expr_stmt|;
operator|*
name|len
operator|=
name|xfs_bmbt_disk_get_blockcount
argument_list|(
name|rp
argument_list|)
expr_stmt|;
operator|*
name|state
operator|=
name|xfs_bmbt_disk_get_state
argument_list|(
name|rp
argument_list|)
expr_stmt|;
operator|*
name|stat
operator|=
literal|1
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * Insert one record/level.  Return information to the caller  * allowing the next level up to proceed if necessary.  */
end_comment

begin_function
name|STATIC
name|int
comment|/* error */
name|xfs_bmbt_insrec
parameter_list|(
name|xfs_btree_cur_t
modifier|*
name|cur
parameter_list|,
name|int
name|level
parameter_list|,
name|xfs_fsblock_t
modifier|*
name|bnop
parameter_list|,
name|xfs_bmbt_rec_t
modifier|*
name|recp
parameter_list|,
name|xfs_btree_cur_t
modifier|*
modifier|*
name|curp
parameter_list|,
name|int
modifier|*
name|stat
parameter_list|)
comment|/* no-go/done/continue */
block|{
name|xfs_bmbt_block_t
modifier|*
name|block
decl_stmt|;
comment|/* bmap btree block */
name|xfs_buf_t
modifier|*
name|bp
decl_stmt|;
comment|/* buffer for block */
name|int
name|error
decl_stmt|;
comment|/* error return value */
ifdef|#
directive|ifdef
name|XFS_BMBT_TRACE
specifier|static
name|char
name|fname
index|[]
init|=
literal|"xfs_bmbt_insrec"
decl_stmt|;
endif|#
directive|endif
name|int
name|i
decl_stmt|;
comment|/* loop index */
name|xfs_bmbt_key_t
name|key
decl_stmt|;
comment|/* bmap btree key */
name|xfs_bmbt_key_t
modifier|*
name|kp
init|=
name|NULL
decl_stmt|;
comment|/* pointer to bmap btree key */
name|int
name|logflags
decl_stmt|;
comment|/* inode logging flags */
name|xfs_fsblock_t
name|nbno
decl_stmt|;
comment|/* new block number */
name|struct
name|xfs_btree_cur
modifier|*
name|ncur
decl_stmt|;
comment|/* new btree cursor */
name|xfs_bmbt_key_t
name|nkey
decl_stmt|;
comment|/* new btree key value */
name|xfs_bmbt_rec_t
name|nrec
decl_stmt|;
comment|/* new record count */
name|int
name|optr
decl_stmt|;
comment|/* old key/record index */
name|xfs_bmbt_ptr_t
modifier|*
name|pp
decl_stmt|;
comment|/* pointer to bmap block addr */
name|int
name|ptr
decl_stmt|;
comment|/* key/record index */
name|xfs_bmbt_rec_t
modifier|*
name|rp
init|=
name|NULL
decl_stmt|;
comment|/* pointer to bmap btree rec */
name|int
name|numrecs
decl_stmt|;
name|ASSERT
argument_list|(
name|level
operator|<
name|cur
operator|->
name|bc_nlevels
argument_list|)
expr_stmt|;
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ENTRY
argument_list|)
expr_stmt|;
name|XFS_BMBT_TRACE_ARGIFR
argument_list|(
name|cur
argument_list|,
name|level
argument_list|,
operator|*
name|bnop
argument_list|,
name|recp
argument_list|)
expr_stmt|;
name|ncur
operator|=
operator|(
name|xfs_btree_cur_t
operator|*
operator|)
literal|0
expr_stmt|;
name|INT_SET
argument_list|(
name|key
operator|.
name|br_startoff
argument_list|,
name|ARCH_CONVERT
argument_list|,
name|xfs_bmbt_disk_get_startoff
argument_list|(
name|recp
argument_list|)
argument_list|)
expr_stmt|;
name|optr
operator|=
name|ptr
operator|=
name|cur
operator|->
name|bc_ptrs
index|[
name|level
index|]
expr_stmt|;
if|if
condition|(
name|ptr
operator|==
literal|0
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|EXIT
argument_list|)
expr_stmt|;
operator|*
name|stat
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
name|XFS_STATS_INC
argument_list|(
name|xs_bmbt_insrec
argument_list|)
expr_stmt|;
name|block
operator|=
name|xfs_bmbt_get_block
argument_list|(
name|cur
argument_list|,
name|level
argument_list|,
operator|&
name|bp
argument_list|)
expr_stmt|;
name|numrecs
operator|=
name|be16_to_cpu
argument_list|(
name|block
operator|->
name|bb_numrecs
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_btree_check_lblock
argument_list|(
name|cur
argument_list|,
name|block
argument_list|,
name|level
argument_list|,
name|bp
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
if|if
condition|(
name|ptr
operator|<=
name|numrecs
condition|)
block|{
if|if
condition|(
name|level
operator|==
literal|0
condition|)
block|{
name|rp
operator|=
name|XFS_BMAP_REC_IADDR
argument_list|(
name|block
argument_list|,
name|ptr
argument_list|,
name|cur
argument_list|)
expr_stmt|;
name|xfs_btree_check_rec
argument_list|(
name|XFS_BTNUM_BMAP
argument_list|,
name|recp
argument_list|,
name|rp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|kp
operator|=
name|XFS_BMAP_KEY_IADDR
argument_list|(
name|block
argument_list|,
name|ptr
argument_list|,
name|cur
argument_list|)
expr_stmt|;
name|xfs_btree_check_key
argument_list|(
name|XFS_BTNUM_BMAP
argument_list|,
operator|&
name|key
argument_list|,
name|kp
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
name|nbno
operator|=
name|NULLFSBLOCK
expr_stmt|;
if|if
condition|(
name|numrecs
operator|==
name|XFS_BMAP_BLOCK_IMAXRECS
argument_list|(
name|level
argument_list|,
name|cur
argument_list|)
condition|)
block|{
if|if
condition|(
name|numrecs
operator|<
name|XFS_BMAP_BLOCK_DMAXRECS
argument_list|(
name|level
argument_list|,
name|cur
argument_list|)
condition|)
block|{
comment|/* 			 * A root block, that can be made bigger. 			 */
name|xfs_iroot_realloc
argument_list|(
name|cur
operator|->
name|bc_private
operator|.
name|b
operator|.
name|ip
argument_list|,
literal|1
argument_list|,
name|cur
operator|->
name|bc_private
operator|.
name|b
operator|.
name|whichfork
argument_list|)
expr_stmt|;
name|block
operator|=
name|xfs_bmbt_get_block
argument_list|(
name|cur
argument_list|,
name|level
argument_list|,
operator|&
name|bp
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|level
operator|==
name|cur
operator|->
name|bc_nlevels
operator|-
literal|1
condition|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_bmbt_newroot
argument_list|(
name|cur
argument_list|,
operator|&
name|logflags
argument_list|,
name|stat
argument_list|)
operator|)
operator|||
operator|*
name|stat
operator|==
literal|0
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
name|xfs_trans_log_inode
argument_list|(
name|cur
operator|->
name|bc_tp
argument_list|,
name|cur
operator|->
name|bc_private
operator|.
name|b
operator|.
name|ip
argument_list|,
name|logflags
argument_list|)
expr_stmt|;
name|block
operator|=
name|xfs_bmbt_get_block
argument_list|(
name|cur
argument_list|,
name|level
argument_list|,
operator|&
name|bp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_bmbt_rshift
argument_list|(
name|cur
argument_list|,
name|level
argument_list|,
operator|&
name|i
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
if|if
condition|(
name|i
condition|)
block|{
comment|/* nothing */
block|}
else|else
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_bmbt_lshift
argument_list|(
name|cur
argument_list|,
name|level
argument_list|,
operator|&
name|i
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
if|if
condition|(
name|i
condition|)
block|{
name|optr
operator|=
name|ptr
operator|=
name|cur
operator|->
name|bc_ptrs
index|[
name|level
index|]
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_bmbt_split
argument_list|(
name|cur
argument_list|,
name|level
argument_list|,
operator|&
name|nbno
argument_list|,
operator|&
name|nkey
argument_list|,
operator|&
name|ncur
argument_list|,
operator|&
name|i
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
if|if
condition|(
name|i
condition|)
block|{
name|block
operator|=
name|xfs_bmbt_get_block
argument_list|(
name|cur
argument_list|,
name|level
argument_list|,
operator|&
name|bp
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_btree_check_lblock
argument_list|(
name|cur
argument_list|,
name|block
argument_list|,
name|level
argument_list|,
name|bp
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
endif|#
directive|endif
name|ptr
operator|=
name|cur
operator|->
name|bc_ptrs
index|[
name|level
index|]
expr_stmt|;
name|xfs_bmbt_disk_set_allf
argument_list|(
operator|&
name|nrec
argument_list|,
name|nkey
operator|.
name|br_startoff
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|XFS_EXT_NORM
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|EXIT
argument_list|)
expr_stmt|;
operator|*
name|stat
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
block|}
block|}
block|}
name|numrecs
operator|=
name|be16_to_cpu
argument_list|(
name|block
operator|->
name|bb_numrecs
argument_list|)
expr_stmt|;
if|if
condition|(
name|level
operator|>
literal|0
condition|)
block|{
name|kp
operator|=
name|XFS_BMAP_KEY_IADDR
argument_list|(
name|block
argument_list|,
literal|1
argument_list|,
name|cur
argument_list|)
expr_stmt|;
name|pp
operator|=
name|XFS_BMAP_PTR_IADDR
argument_list|(
name|block
argument_list|,
literal|1
argument_list|,
name|cur
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
for|for
control|(
name|i
operator|=
name|numrecs
init|;
name|i
operator|>=
name|ptr
condition|;
name|i
operator|--
control|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_btree_check_lptr
argument_list|(
name|cur
argument_list|,
name|INT_GET
argument_list|(
name|pp
index|[
name|i
operator|-
literal|1
index|]
argument_list|,
name|ARCH_CONVERT
argument_list|)
argument_list|,
name|level
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
block|}
endif|#
directive|endif
name|memmove
argument_list|(
operator|&
name|kp
index|[
name|ptr
index|]
argument_list|,
operator|&
name|kp
index|[
name|ptr
operator|-
literal|1
index|]
argument_list|,
operator|(
name|numrecs
operator|-
name|ptr
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|kp
argument_list|)
argument_list|)
expr_stmt|;
name|memmove
argument_list|(
operator|&
name|pp
index|[
name|ptr
index|]
argument_list|,
operator|&
name|pp
index|[
name|ptr
operator|-
literal|1
index|]
argument_list|,
comment|/* INT_: direct copy */
operator|(
name|numrecs
operator|-
name|ptr
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|pp
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_btree_check_lptr
argument_list|(
name|cur
argument_list|,
operator|(
name|xfs_bmbt_ptr_t
operator|)
operator|*
name|bnop
argument_list|,
name|level
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
endif|#
directive|endif
name|kp
index|[
name|ptr
operator|-
literal|1
index|]
operator|=
name|key
expr_stmt|;
name|INT_SET
argument_list|(
name|pp
index|[
name|ptr
operator|-
literal|1
index|]
argument_list|,
name|ARCH_CONVERT
argument_list|,
operator|*
name|bnop
argument_list|)
expr_stmt|;
name|numrecs
operator|++
expr_stmt|;
name|block
operator|->
name|bb_numrecs
operator|=
name|cpu_to_be16
argument_list|(
name|numrecs
argument_list|)
expr_stmt|;
name|xfs_bmbt_log_keys
argument_list|(
name|cur
argument_list|,
name|bp
argument_list|,
name|ptr
argument_list|,
name|numrecs
argument_list|)
expr_stmt|;
name|xfs_bmbt_log_ptrs
argument_list|(
name|cur
argument_list|,
name|bp
argument_list|,
name|ptr
argument_list|,
name|numrecs
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|rp
operator|=
name|XFS_BMAP_REC_IADDR
argument_list|(
name|block
argument_list|,
literal|1
argument_list|,
name|cur
argument_list|)
expr_stmt|;
name|memmove
argument_list|(
operator|&
name|rp
index|[
name|ptr
index|]
argument_list|,
operator|&
name|rp
index|[
name|ptr
operator|-
literal|1
index|]
argument_list|,
operator|(
name|numrecs
operator|-
name|ptr
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|rp
argument_list|)
argument_list|)
expr_stmt|;
name|rp
index|[
name|ptr
operator|-
literal|1
index|]
operator|=
operator|*
name|recp
expr_stmt|;
name|numrecs
operator|++
expr_stmt|;
name|block
operator|->
name|bb_numrecs
operator|=
name|cpu_to_be16
argument_list|(
name|numrecs
argument_list|)
expr_stmt|;
name|xfs_bmbt_log_recs
argument_list|(
name|cur
argument_list|,
name|bp
argument_list|,
name|ptr
argument_list|,
name|numrecs
argument_list|)
expr_stmt|;
block|}
name|xfs_bmbt_log_block
argument_list|(
name|cur
argument_list|,
name|bp
argument_list|,
name|XFS_BB_NUMRECS
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|ptr
operator|<
name|numrecs
condition|)
block|{
if|if
condition|(
name|level
operator|==
literal|0
condition|)
name|xfs_btree_check_rec
argument_list|(
name|XFS_BTNUM_BMAP
argument_list|,
name|rp
operator|+
name|ptr
operator|-
literal|1
argument_list|,
name|rp
operator|+
name|ptr
argument_list|)
expr_stmt|;
else|else
name|xfs_btree_check_key
argument_list|(
name|XFS_BTNUM_BMAP
argument_list|,
name|kp
operator|+
name|ptr
operator|-
literal|1
argument_list|,
name|kp
operator|+
name|ptr
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|optr
operator|==
literal|1
operator|&&
operator|(
name|error
operator|=
name|xfs_bmbt_updkey
argument_list|(
name|cur
argument_list|,
operator|&
name|key
argument_list|,
name|level
operator|+
literal|1
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
operator|*
name|bnop
operator|=
name|nbno
expr_stmt|;
if|if
condition|(
name|nbno
operator|!=
name|NULLFSBLOCK
condition|)
block|{
operator|*
name|recp
operator|=
name|nrec
expr_stmt|;
operator|*
name|curp
operator|=
name|ncur
expr_stmt|;
block|}
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|EXIT
argument_list|)
expr_stmt|;
operator|*
name|stat
operator|=
literal|1
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|STATIC
name|int
name|xfs_bmbt_killroot
parameter_list|(
name|xfs_btree_cur_t
modifier|*
name|cur
parameter_list|)
block|{
name|xfs_bmbt_block_t
modifier|*
name|block
decl_stmt|;
name|xfs_bmbt_block_t
modifier|*
name|cblock
decl_stmt|;
name|xfs_buf_t
modifier|*
name|cbp
decl_stmt|;
name|xfs_bmbt_key_t
modifier|*
name|ckp
decl_stmt|;
name|xfs_bmbt_ptr_t
modifier|*
name|cpp
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|int
name|error
decl_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|XFS_BMBT_TRACE
specifier|static
name|char
name|fname
index|[]
init|=
literal|"xfs_bmbt_killroot"
decl_stmt|;
endif|#
directive|endif
name|int
name|i
decl_stmt|;
name|xfs_bmbt_key_t
modifier|*
name|kp
decl_stmt|;
name|xfs_inode_t
modifier|*
name|ip
decl_stmt|;
name|xfs_ifork_t
modifier|*
name|ifp
decl_stmt|;
name|int
name|level
decl_stmt|;
name|xfs_bmbt_ptr_t
modifier|*
name|pp
decl_stmt|;
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ENTRY
argument_list|)
expr_stmt|;
name|level
operator|=
name|cur
operator|->
name|bc_nlevels
operator|-
literal|1
expr_stmt|;
name|ASSERT
argument_list|(
name|level
operator|>=
literal|1
argument_list|)
expr_stmt|;
comment|/* 	 * Don't deal with the root block needs to be a leaf case. 	 * We're just going to turn the thing back into extents anyway. 	 */
if|if
condition|(
name|level
operator|==
literal|1
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|EXIT
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|block
operator|=
name|xfs_bmbt_get_block
argument_list|(
name|cur
argument_list|,
name|level
argument_list|,
operator|&
name|cbp
argument_list|)
expr_stmt|;
comment|/* 	 * Give up if the root has multiple children. 	 */
if|if
condition|(
name|be16_to_cpu
argument_list|(
name|block
operator|->
name|bb_numrecs
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|EXIT
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* 	 * Only do this if the next level will fit. 	 * Then the data must be copied up to the inode, 	 * instead of freeing the root you free the next level. 	 */
name|cbp
operator|=
name|cur
operator|->
name|bc_bufs
index|[
name|level
operator|-
literal|1
index|]
expr_stmt|;
name|cblock
operator|=
name|XFS_BUF_TO_BMBT_BLOCK
argument_list|(
name|cbp
argument_list|)
expr_stmt|;
if|if
condition|(
name|be16_to_cpu
argument_list|(
name|cblock
operator|->
name|bb_numrecs
argument_list|)
operator|>
name|XFS_BMAP_BLOCK_DMAXRECS
argument_list|(
name|level
argument_list|,
name|cur
argument_list|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|EXIT
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|ASSERT
argument_list|(
name|be64_to_cpu
argument_list|(
name|cblock
operator|->
name|bb_leftsib
argument_list|)
operator|==
name|NULLDFSBNO
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|be64_to_cpu
argument_list|(
name|cblock
operator|->
name|bb_rightsib
argument_list|)
operator|==
name|NULLDFSBNO
argument_list|)
expr_stmt|;
name|ip
operator|=
name|cur
operator|->
name|bc_private
operator|.
name|b
operator|.
name|ip
expr_stmt|;
name|ifp
operator|=
name|XFS_IFORK_PTR
argument_list|(
name|ip
argument_list|,
name|cur
operator|->
name|bc_private
operator|.
name|b
operator|.
name|whichfork
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|XFS_BMAP_BLOCK_IMAXRECS
argument_list|(
name|level
argument_list|,
name|cur
argument_list|)
operator|==
name|XFS_BMAP_BROOT_MAXRECS
argument_list|(
name|ifp
operator|->
name|if_broot_bytes
argument_list|)
argument_list|)
expr_stmt|;
name|i
operator|=
call|(
name|int
call|)
argument_list|(
name|be16_to_cpu
argument_list|(
name|cblock
operator|->
name|bb_numrecs
argument_list|)
operator|-
name|XFS_BMAP_BLOCK_IMAXRECS
argument_list|(
name|level
argument_list|,
name|cur
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
condition|)
block|{
name|xfs_iroot_realloc
argument_list|(
name|ip
argument_list|,
name|i
argument_list|,
name|cur
operator|->
name|bc_private
operator|.
name|b
operator|.
name|whichfork
argument_list|)
expr_stmt|;
name|block
operator|=
name|ifp
operator|->
name|if_broot
expr_stmt|;
block|}
name|be16_add
argument_list|(
operator|&
name|block
operator|->
name|bb_numrecs
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|block
operator|->
name|bb_numrecs
operator|==
name|cblock
operator|->
name|bb_numrecs
argument_list|)
expr_stmt|;
name|kp
operator|=
name|XFS_BMAP_KEY_IADDR
argument_list|(
name|block
argument_list|,
literal|1
argument_list|,
name|cur
argument_list|)
expr_stmt|;
name|ckp
operator|=
name|XFS_BMAP_KEY_IADDR
argument_list|(
name|cblock
argument_list|,
literal|1
argument_list|,
name|cur
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|kp
argument_list|,
name|ckp
argument_list|,
name|be16_to_cpu
argument_list|(
name|block
operator|->
name|bb_numrecs
argument_list|)
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|kp
argument_list|)
argument_list|)
expr_stmt|;
name|pp
operator|=
name|XFS_BMAP_PTR_IADDR
argument_list|(
name|block
argument_list|,
literal|1
argument_list|,
name|cur
argument_list|)
expr_stmt|;
name|cpp
operator|=
name|XFS_BMAP_PTR_IADDR
argument_list|(
name|cblock
argument_list|,
literal|1
argument_list|,
name|cur
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|be16_to_cpu
argument_list|(
name|cblock
operator|->
name|bb_numrecs
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_btree_check_lptr
argument_list|(
name|cur
argument_list|,
name|INT_GET
argument_list|(
name|cpp
index|[
name|i
index|]
argument_list|,
name|ARCH_CONVERT
argument_list|)
argument_list|,
name|level
operator|-
literal|1
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
block|}
endif|#
directive|endif
name|memcpy
argument_list|(
name|pp
argument_list|,
name|cpp
argument_list|,
name|be16_to_cpu
argument_list|(
name|block
operator|->
name|bb_numrecs
argument_list|)
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|pp
argument_list|)
argument_list|)
expr_stmt|;
name|xfs_bmap_add_free
argument_list|(
name|XFS_DADDR_TO_FSB
argument_list|(
name|cur
operator|->
name|bc_mp
argument_list|,
name|XFS_BUF_ADDR
argument_list|(
name|cbp
argument_list|)
argument_list|)
argument_list|,
literal|1
argument_list|,
name|cur
operator|->
name|bc_private
operator|.
name|b
operator|.
name|flist
argument_list|,
name|cur
operator|->
name|bc_mp
argument_list|)
expr_stmt|;
name|ip
operator|->
name|i_d
operator|.
name|di_nblocks
operator|--
expr_stmt|;
name|XFS_TRANS_MOD_DQUOT_BYINO
argument_list|(
name|cur
operator|->
name|bc_mp
argument_list|,
name|cur
operator|->
name|bc_tp
argument_list|,
name|ip
argument_list|,
name|XFS_TRANS_DQ_BCOUNT
argument_list|,
operator|-
literal|1L
argument_list|)
expr_stmt|;
name|xfs_trans_binval
argument_list|(
name|cur
operator|->
name|bc_tp
argument_list|,
name|cbp
argument_list|)
expr_stmt|;
name|cur
operator|->
name|bc_bufs
index|[
name|level
operator|-
literal|1
index|]
operator|=
name|NULL
expr_stmt|;
name|be16_add
argument_list|(
operator|&
name|block
operator|->
name|bb_level
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|xfs_trans_log_inode
argument_list|(
name|cur
operator|->
name|bc_tp
argument_list|,
name|ip
argument_list|,
name|XFS_ILOG_CORE
operator||
name|XFS_ILOG_FBROOT
argument_list|(
name|cur
operator|->
name|bc_private
operator|.
name|b
operator|.
name|whichfork
argument_list|)
argument_list|)
expr_stmt|;
name|cur
operator|->
name|bc_nlevels
operator|--
expr_stmt|;
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|EXIT
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Log key values from the btree block.  */
end_comment

begin_function
name|STATIC
name|void
name|xfs_bmbt_log_keys
parameter_list|(
name|xfs_btree_cur_t
modifier|*
name|cur
parameter_list|,
name|xfs_buf_t
modifier|*
name|bp
parameter_list|,
name|int
name|kfirst
parameter_list|,
name|int
name|klast
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|XFS_BMBT_TRACE
specifier|static
name|char
name|fname
index|[]
init|=
literal|"xfs_bmbt_log_keys"
decl_stmt|;
endif|#
directive|endif
name|xfs_trans_t
modifier|*
name|tp
decl_stmt|;
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ENTRY
argument_list|)
expr_stmt|;
name|XFS_BMBT_TRACE_ARGBII
argument_list|(
name|cur
argument_list|,
name|bp
argument_list|,
name|kfirst
argument_list|,
name|klast
argument_list|)
expr_stmt|;
name|tp
operator|=
name|cur
operator|->
name|bc_tp
expr_stmt|;
if|if
condition|(
name|bp
condition|)
block|{
name|xfs_bmbt_block_t
modifier|*
name|block
decl_stmt|;
name|int
name|first
decl_stmt|;
name|xfs_bmbt_key_t
modifier|*
name|kp
decl_stmt|;
name|int
name|last
decl_stmt|;
name|block
operator|=
name|XFS_BUF_TO_BMBT_BLOCK
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|kp
operator|=
name|XFS_BMAP_KEY_DADDR
argument_list|(
name|block
argument_list|,
literal|1
argument_list|,
name|cur
argument_list|)
expr_stmt|;
name|first
operator|=
call|(
name|int
call|)
argument_list|(
operator|(
name|xfs_caddr_t
operator|)
operator|&
name|kp
index|[
name|kfirst
operator|-
literal|1
index|]
operator|-
operator|(
name|xfs_caddr_t
operator|)
name|block
argument_list|)
expr_stmt|;
name|last
operator|=
call|(
name|int
call|)
argument_list|(
operator|(
operator|(
name|xfs_caddr_t
operator|)
operator|&
name|kp
index|[
name|klast
index|]
operator|-
literal|1
operator|)
operator|-
operator|(
name|xfs_caddr_t
operator|)
name|block
argument_list|)
expr_stmt|;
name|xfs_trans_log_buf
argument_list|(
name|tp
argument_list|,
name|bp
argument_list|,
name|first
argument_list|,
name|last
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|xfs_inode_t
modifier|*
name|ip
decl_stmt|;
name|ip
operator|=
name|cur
operator|->
name|bc_private
operator|.
name|b
operator|.
name|ip
expr_stmt|;
name|xfs_trans_log_inode
argument_list|(
name|tp
argument_list|,
name|ip
argument_list|,
name|XFS_ILOG_FBROOT
argument_list|(
name|cur
operator|->
name|bc_private
operator|.
name|b
operator|.
name|whichfork
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|EXIT
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Log pointer values from the btree block.  */
end_comment

begin_function
name|STATIC
name|void
name|xfs_bmbt_log_ptrs
parameter_list|(
name|xfs_btree_cur_t
modifier|*
name|cur
parameter_list|,
name|xfs_buf_t
modifier|*
name|bp
parameter_list|,
name|int
name|pfirst
parameter_list|,
name|int
name|plast
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|XFS_BMBT_TRACE
specifier|static
name|char
name|fname
index|[]
init|=
literal|"xfs_bmbt_log_ptrs"
decl_stmt|;
endif|#
directive|endif
name|xfs_trans_t
modifier|*
name|tp
decl_stmt|;
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ENTRY
argument_list|)
expr_stmt|;
name|XFS_BMBT_TRACE_ARGBII
argument_list|(
name|cur
argument_list|,
name|bp
argument_list|,
name|pfirst
argument_list|,
name|plast
argument_list|)
expr_stmt|;
name|tp
operator|=
name|cur
operator|->
name|bc_tp
expr_stmt|;
if|if
condition|(
name|bp
condition|)
block|{
name|xfs_bmbt_block_t
modifier|*
name|block
decl_stmt|;
name|int
name|first
decl_stmt|;
name|int
name|last
decl_stmt|;
name|xfs_bmbt_ptr_t
modifier|*
name|pp
decl_stmt|;
name|block
operator|=
name|XFS_BUF_TO_BMBT_BLOCK
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|pp
operator|=
name|XFS_BMAP_PTR_DADDR
argument_list|(
name|block
argument_list|,
literal|1
argument_list|,
name|cur
argument_list|)
expr_stmt|;
name|first
operator|=
call|(
name|int
call|)
argument_list|(
operator|(
name|xfs_caddr_t
operator|)
operator|&
name|pp
index|[
name|pfirst
operator|-
literal|1
index|]
operator|-
operator|(
name|xfs_caddr_t
operator|)
name|block
argument_list|)
expr_stmt|;
name|last
operator|=
call|(
name|int
call|)
argument_list|(
operator|(
operator|(
name|xfs_caddr_t
operator|)
operator|&
name|pp
index|[
name|plast
index|]
operator|-
literal|1
operator|)
operator|-
operator|(
name|xfs_caddr_t
operator|)
name|block
argument_list|)
expr_stmt|;
name|xfs_trans_log_buf
argument_list|(
name|tp
argument_list|,
name|bp
argument_list|,
name|first
argument_list|,
name|last
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|xfs_inode_t
modifier|*
name|ip
decl_stmt|;
name|ip
operator|=
name|cur
operator|->
name|bc_private
operator|.
name|b
operator|.
name|ip
expr_stmt|;
name|xfs_trans_log_inode
argument_list|(
name|tp
argument_list|,
name|ip
argument_list|,
name|XFS_ILOG_FBROOT
argument_list|(
name|cur
operator|->
name|bc_private
operator|.
name|b
operator|.
name|whichfork
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|EXIT
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Lookup the record.  The cursor is made to point to it, based on dir.  */
end_comment

begin_function
name|STATIC
name|int
comment|/* error */
name|xfs_bmbt_lookup
parameter_list|(
name|xfs_btree_cur_t
modifier|*
name|cur
parameter_list|,
name|xfs_lookup_t
name|dir
parameter_list|,
name|int
modifier|*
name|stat
parameter_list|)
comment|/* success/failure */
block|{
name|xfs_bmbt_block_t
modifier|*
name|block
init|=
name|NULL
decl_stmt|;
name|xfs_buf_t
modifier|*
name|bp
decl_stmt|;
name|xfs_daddr_t
name|d
decl_stmt|;
name|xfs_sfiloff_t
name|diff
decl_stmt|;
name|int
name|error
decl_stmt|;
comment|/* error return value */
ifdef|#
directive|ifdef
name|XFS_BMBT_TRACE
specifier|static
name|char
name|fname
index|[]
init|=
literal|"xfs_bmbt_lookup"
decl_stmt|;
endif|#
directive|endif
name|xfs_fsblock_t
name|fsbno
init|=
literal|0
decl_stmt|;
name|int
name|high
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|keyno
init|=
literal|0
decl_stmt|;
name|xfs_bmbt_key_t
modifier|*
name|kkbase
init|=
name|NULL
decl_stmt|;
name|xfs_bmbt_key_t
modifier|*
name|kkp
decl_stmt|;
name|xfs_bmbt_rec_t
modifier|*
name|krbase
init|=
name|NULL
decl_stmt|;
name|xfs_bmbt_rec_t
modifier|*
name|krp
decl_stmt|;
name|int
name|level
decl_stmt|;
name|int
name|low
decl_stmt|;
name|xfs_mount_t
modifier|*
name|mp
decl_stmt|;
name|xfs_bmbt_ptr_t
modifier|*
name|pp
decl_stmt|;
name|xfs_bmbt_irec_t
modifier|*
name|rp
decl_stmt|;
name|xfs_fileoff_t
name|startoff
decl_stmt|;
name|xfs_trans_t
modifier|*
name|tp
decl_stmt|;
name|XFS_STATS_INC
argument_list|(
name|xs_bmbt_lookup
argument_list|)
expr_stmt|;
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ENTRY
argument_list|)
expr_stmt|;
name|XFS_BMBT_TRACE_ARGI
argument_list|(
name|cur
argument_list|,
operator|(
name|int
operator|)
name|dir
argument_list|)
expr_stmt|;
name|tp
operator|=
name|cur
operator|->
name|bc_tp
expr_stmt|;
name|mp
operator|=
name|cur
operator|->
name|bc_mp
expr_stmt|;
name|rp
operator|=
operator|&
name|cur
operator|->
name|bc_rec
operator|.
name|b
expr_stmt|;
for|for
control|(
name|level
operator|=
name|cur
operator|->
name|bc_nlevels
operator|-
literal|1
operator|,
name|diff
operator|=
literal|1
init|;
name|level
operator|>=
literal|0
condition|;
name|level
operator|--
control|)
block|{
if|if
condition|(
name|level
operator|<
name|cur
operator|->
name|bc_nlevels
operator|-
literal|1
condition|)
block|{
name|d
operator|=
name|XFS_FSB_TO_DADDR
argument_list|(
name|mp
argument_list|,
name|fsbno
argument_list|)
expr_stmt|;
name|bp
operator|=
name|cur
operator|->
name|bc_bufs
index|[
name|level
index|]
expr_stmt|;
if|if
condition|(
name|bp
operator|&&
name|XFS_BUF_ADDR
argument_list|(
name|bp
argument_list|)
operator|!=
name|d
condition|)
name|bp
operator|=
operator|(
name|xfs_buf_t
operator|*
operator|)
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|bp
condition|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_btree_read_bufl
argument_list|(
name|mp
argument_list|,
name|tp
argument_list|,
name|fsbno
argument_list|,
literal|0
argument_list|,
operator|&
name|bp
argument_list|,
name|XFS_BMAP_BTREE_REF
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
name|xfs_btree_setbuf
argument_list|(
name|cur
argument_list|,
name|level
argument_list|,
name|bp
argument_list|)
expr_stmt|;
name|block
operator|=
name|XFS_BUF_TO_BMBT_BLOCK
argument_list|(
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_btree_check_lblock
argument_list|(
name|cur
argument_list|,
name|block
argument_list|,
name|level
argument_list|,
name|bp
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
block|}
else|else
name|block
operator|=
name|XFS_BUF_TO_BMBT_BLOCK
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
else|else
name|block
operator|=
name|xfs_bmbt_get_block
argument_list|(
name|cur
argument_list|,
name|level
argument_list|,
operator|&
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
name|diff
operator|==
literal|0
condition|)
name|keyno
operator|=
literal|1
expr_stmt|;
else|else
block|{
if|if
condition|(
name|level
operator|>
literal|0
condition|)
name|kkbase
operator|=
name|XFS_BMAP_KEY_IADDR
argument_list|(
name|block
argument_list|,
literal|1
argument_list|,
name|cur
argument_list|)
expr_stmt|;
else|else
name|krbase
operator|=
name|XFS_BMAP_REC_IADDR
argument_list|(
name|block
argument_list|,
literal|1
argument_list|,
name|cur
argument_list|)
expr_stmt|;
name|low
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|high
operator|=
name|be16_to_cpu
argument_list|(
name|block
operator|->
name|bb_numrecs
argument_list|)
operator|)
condition|)
block|{
name|ASSERT
argument_list|(
name|level
operator|==
literal|0
argument_list|)
expr_stmt|;
name|cur
operator|->
name|bc_ptrs
index|[
literal|0
index|]
operator|=
name|dir
operator|!=
name|XFS_LOOKUP_LE
expr_stmt|;
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|EXIT
argument_list|)
expr_stmt|;
operator|*
name|stat
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
while|while
condition|(
name|low
operator|<=
name|high
condition|)
block|{
name|XFS_STATS_INC
argument_list|(
name|xs_bmbt_compare
argument_list|)
expr_stmt|;
name|keyno
operator|=
operator|(
name|low
operator|+
name|high
operator|)
operator|>>
literal|1
expr_stmt|;
if|if
condition|(
name|level
operator|>
literal|0
condition|)
block|{
name|kkp
operator|=
name|kkbase
operator|+
name|keyno
operator|-
literal|1
expr_stmt|;
name|startoff
operator|=
name|INT_GET
argument_list|(
name|kkp
operator|->
name|br_startoff
argument_list|,
name|ARCH_CONVERT
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|krp
operator|=
name|krbase
operator|+
name|keyno
operator|-
literal|1
expr_stmt|;
name|startoff
operator|=
name|xfs_bmbt_disk_get_startoff
argument_list|(
name|krp
argument_list|)
expr_stmt|;
block|}
name|diff
operator|=
call|(
name|xfs_sfiloff_t
call|)
argument_list|(
name|startoff
operator|-
name|rp
operator|->
name|br_startoff
argument_list|)
expr_stmt|;
if|if
condition|(
name|diff
operator|<
literal|0
condition|)
name|low
operator|=
name|keyno
operator|+
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|diff
operator|>
literal|0
condition|)
name|high
operator|=
name|keyno
operator|-
literal|1
expr_stmt|;
else|else
break|break;
block|}
block|}
if|if
condition|(
name|level
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|diff
operator|>
literal|0
operator|&&
operator|--
name|keyno
operator|<
literal|1
condition|)
name|keyno
operator|=
literal|1
expr_stmt|;
name|pp
operator|=
name|XFS_BMAP_PTR_IADDR
argument_list|(
name|block
argument_list|,
name|keyno
argument_list|,
name|cur
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_btree_check_lptr
argument_list|(
name|cur
argument_list|,
name|INT_GET
argument_list|(
operator|*
name|pp
argument_list|,
name|ARCH_CONVERT
argument_list|)
argument_list|,
name|level
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
endif|#
directive|endif
name|fsbno
operator|=
name|INT_GET
argument_list|(
operator|*
name|pp
argument_list|,
name|ARCH_CONVERT
argument_list|)
expr_stmt|;
name|cur
operator|->
name|bc_ptrs
index|[
name|level
index|]
operator|=
name|keyno
expr_stmt|;
block|}
block|}
if|if
condition|(
name|dir
operator|!=
name|XFS_LOOKUP_LE
operator|&&
name|diff
operator|<
literal|0
condition|)
block|{
name|keyno
operator|++
expr_stmt|;
comment|/* 		 * If ge search and we went off the end of the block, but it's 		 * not the last block, we're in the wrong block. 		 */
if|if
condition|(
name|dir
operator|==
name|XFS_LOOKUP_GE
operator|&&
name|keyno
operator|>
name|be16_to_cpu
argument_list|(
name|block
operator|->
name|bb_numrecs
argument_list|)
operator|&&
name|be64_to_cpu
argument_list|(
name|block
operator|->
name|bb_rightsib
argument_list|)
operator|!=
name|NULLDFSBNO
condition|)
block|{
name|cur
operator|->
name|bc_ptrs
index|[
literal|0
index|]
operator|=
name|keyno
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_bmbt_increment
argument_list|(
name|cur
argument_list|,
literal|0
argument_list|,
operator|&
name|i
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
name|XFS_WANT_CORRUPTED_RETURN
argument_list|(
name|i
operator|==
literal|1
argument_list|)
expr_stmt|;
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|EXIT
argument_list|)
expr_stmt|;
operator|*
name|stat
operator|=
literal|1
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|dir
operator|==
name|XFS_LOOKUP_LE
operator|&&
name|diff
operator|>
literal|0
condition|)
name|keyno
operator|--
expr_stmt|;
name|cur
operator|->
name|bc_ptrs
index|[
literal|0
index|]
operator|=
name|keyno
expr_stmt|;
if|if
condition|(
name|keyno
operator|==
literal|0
operator|||
name|keyno
operator|>
name|be16_to_cpu
argument_list|(
name|block
operator|->
name|bb_numrecs
argument_list|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|EXIT
argument_list|)
expr_stmt|;
operator|*
name|stat
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|EXIT
argument_list|)
expr_stmt|;
operator|*
name|stat
operator|=
operator|(
operator|(
name|dir
operator|!=
name|XFS_LOOKUP_EQ
operator|)
operator|||
operator|(
name|diff
operator|==
literal|0
operator|)
operator|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Move 1 record left from cur/level if possible.  * Update cur to reflect the new path.  */
end_comment

begin_function
name|STATIC
name|int
comment|/* error */
name|xfs_bmbt_lshift
parameter_list|(
name|xfs_btree_cur_t
modifier|*
name|cur
parameter_list|,
name|int
name|level
parameter_list|,
name|int
modifier|*
name|stat
parameter_list|)
comment|/* success/failure */
block|{
name|int
name|error
decl_stmt|;
comment|/* error return value */
ifdef|#
directive|ifdef
name|XFS_BMBT_TRACE
specifier|static
name|char
name|fname
index|[]
init|=
literal|"xfs_bmbt_lshift"
decl_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|DEBUG
name|int
name|i
decl_stmt|;
comment|/* loop counter */
endif|#
directive|endif
name|xfs_bmbt_key_t
name|key
decl_stmt|;
comment|/* bmap btree key */
name|xfs_buf_t
modifier|*
name|lbp
decl_stmt|;
comment|/* left buffer pointer */
name|xfs_bmbt_block_t
modifier|*
name|left
decl_stmt|;
comment|/* left btree block */
name|xfs_bmbt_key_t
modifier|*
name|lkp
init|=
name|NULL
decl_stmt|;
comment|/* left btree key */
name|xfs_bmbt_ptr_t
modifier|*
name|lpp
decl_stmt|;
comment|/* left address pointer */
name|int
name|lrecs
decl_stmt|;
comment|/* left record count */
name|xfs_bmbt_rec_t
modifier|*
name|lrp
init|=
name|NULL
decl_stmt|;
comment|/* left record pointer */
name|xfs_mount_t
modifier|*
name|mp
decl_stmt|;
comment|/* file system mount point */
name|xfs_buf_t
modifier|*
name|rbp
decl_stmt|;
comment|/* right buffer pointer */
name|xfs_bmbt_block_t
modifier|*
name|right
decl_stmt|;
comment|/* right btree block */
name|xfs_bmbt_key_t
modifier|*
name|rkp
init|=
name|NULL
decl_stmt|;
comment|/* right btree key */
name|xfs_bmbt_ptr_t
modifier|*
name|rpp
init|=
name|NULL
decl_stmt|;
comment|/* right address pointer */
name|xfs_bmbt_rec_t
modifier|*
name|rrp
init|=
name|NULL
decl_stmt|;
comment|/* right record pointer */
name|int
name|rrecs
decl_stmt|;
comment|/* right record count */
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ENTRY
argument_list|)
expr_stmt|;
name|XFS_BMBT_TRACE_ARGI
argument_list|(
name|cur
argument_list|,
name|level
argument_list|)
expr_stmt|;
if|if
condition|(
name|level
operator|==
name|cur
operator|->
name|bc_nlevels
operator|-
literal|1
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|EXIT
argument_list|)
expr_stmt|;
operator|*
name|stat
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
name|rbp
operator|=
name|cur
operator|->
name|bc_bufs
index|[
name|level
index|]
expr_stmt|;
name|right
operator|=
name|XFS_BUF_TO_BMBT_BLOCK
argument_list|(
name|rbp
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_btree_check_lblock
argument_list|(
name|cur
argument_list|,
name|right
argument_list|,
name|level
argument_list|,
name|rbp
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
endif|#
directive|endif
if|if
condition|(
name|be64_to_cpu
argument_list|(
name|right
operator|->
name|bb_leftsib
argument_list|)
operator|==
name|NULLDFSBNO
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|EXIT
argument_list|)
expr_stmt|;
operator|*
name|stat
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|cur
operator|->
name|bc_ptrs
index|[
name|level
index|]
operator|<=
literal|1
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|EXIT
argument_list|)
expr_stmt|;
operator|*
name|stat
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
name|mp
operator|=
name|cur
operator|->
name|bc_mp
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_btree_read_bufl
argument_list|(
name|mp
argument_list|,
name|cur
operator|->
name|bc_tp
argument_list|,
name|be64_to_cpu
argument_list|(
name|right
operator|->
name|bb_leftsib
argument_list|)
argument_list|,
literal|0
argument_list|,
operator|&
name|lbp
argument_list|,
name|XFS_BMAP_BTREE_REF
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
name|left
operator|=
name|XFS_BUF_TO_BMBT_BLOCK
argument_list|(
name|lbp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_btree_check_lblock
argument_list|(
name|cur
argument_list|,
name|left
argument_list|,
name|level
argument_list|,
name|lbp
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
if|if
condition|(
name|be16_to_cpu
argument_list|(
name|left
operator|->
name|bb_numrecs
argument_list|)
operator|==
name|XFS_BMAP_BLOCK_IMAXRECS
argument_list|(
name|level
argument_list|,
name|cur
argument_list|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|EXIT
argument_list|)
expr_stmt|;
operator|*
name|stat
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
name|lrecs
operator|=
name|be16_to_cpu
argument_list|(
name|left
operator|->
name|bb_numrecs
argument_list|)
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|level
operator|>
literal|0
condition|)
block|{
name|lkp
operator|=
name|XFS_BMAP_KEY_IADDR
argument_list|(
name|left
argument_list|,
name|lrecs
argument_list|,
name|cur
argument_list|)
expr_stmt|;
name|rkp
operator|=
name|XFS_BMAP_KEY_IADDR
argument_list|(
name|right
argument_list|,
literal|1
argument_list|,
name|cur
argument_list|)
expr_stmt|;
operator|*
name|lkp
operator|=
operator|*
name|rkp
expr_stmt|;
name|xfs_bmbt_log_keys
argument_list|(
name|cur
argument_list|,
name|lbp
argument_list|,
name|lrecs
argument_list|,
name|lrecs
argument_list|)
expr_stmt|;
name|lpp
operator|=
name|XFS_BMAP_PTR_IADDR
argument_list|(
name|left
argument_list|,
name|lrecs
argument_list|,
name|cur
argument_list|)
expr_stmt|;
name|rpp
operator|=
name|XFS_BMAP_PTR_IADDR
argument_list|(
name|right
argument_list|,
literal|1
argument_list|,
name|cur
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_btree_check_lptr
argument_list|(
name|cur
argument_list|,
name|INT_GET
argument_list|(
operator|*
name|rpp
argument_list|,
name|ARCH_CONVERT
argument_list|)
argument_list|,
name|level
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
endif|#
directive|endif
operator|*
name|lpp
operator|=
operator|*
name|rpp
expr_stmt|;
comment|/* INT_: direct copy */
name|xfs_bmbt_log_ptrs
argument_list|(
name|cur
argument_list|,
name|lbp
argument_list|,
name|lrecs
argument_list|,
name|lrecs
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|lrp
operator|=
name|XFS_BMAP_REC_IADDR
argument_list|(
name|left
argument_list|,
name|lrecs
argument_list|,
name|cur
argument_list|)
expr_stmt|;
name|rrp
operator|=
name|XFS_BMAP_REC_IADDR
argument_list|(
name|right
argument_list|,
literal|1
argument_list|,
name|cur
argument_list|)
expr_stmt|;
operator|*
name|lrp
operator|=
operator|*
name|rrp
expr_stmt|;
name|xfs_bmbt_log_recs
argument_list|(
name|cur
argument_list|,
name|lbp
argument_list|,
name|lrecs
argument_list|,
name|lrecs
argument_list|)
expr_stmt|;
block|}
name|left
operator|->
name|bb_numrecs
operator|=
name|cpu_to_be16
argument_list|(
name|lrecs
argument_list|)
expr_stmt|;
name|xfs_bmbt_log_block
argument_list|(
name|cur
argument_list|,
name|lbp
argument_list|,
name|XFS_BB_NUMRECS
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|level
operator|>
literal|0
condition|)
name|xfs_btree_check_key
argument_list|(
name|XFS_BTNUM_BMAP
argument_list|,
name|lkp
operator|-
literal|1
argument_list|,
name|lkp
argument_list|)
expr_stmt|;
else|else
name|xfs_btree_check_rec
argument_list|(
name|XFS_BTNUM_BMAP
argument_list|,
name|lrp
operator|-
literal|1
argument_list|,
name|lrp
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|rrecs
operator|=
name|be16_to_cpu
argument_list|(
name|right
operator|->
name|bb_numrecs
argument_list|)
operator|-
literal|1
expr_stmt|;
name|right
operator|->
name|bb_numrecs
operator|=
name|cpu_to_be16
argument_list|(
name|rrecs
argument_list|)
expr_stmt|;
name|xfs_bmbt_log_block
argument_list|(
name|cur
argument_list|,
name|rbp
argument_list|,
name|XFS_BB_NUMRECS
argument_list|)
expr_stmt|;
if|if
condition|(
name|level
operator|>
literal|0
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rrecs
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_btree_check_lptr
argument_list|(
name|cur
argument_list|,
name|INT_GET
argument_list|(
name|rpp
index|[
name|i
operator|+
literal|1
index|]
argument_list|,
name|ARCH_CONVERT
argument_list|)
argument_list|,
name|level
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
block|}
endif|#
directive|endif
name|memmove
argument_list|(
name|rkp
argument_list|,
name|rkp
operator|+
literal|1
argument_list|,
name|rrecs
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|rkp
argument_list|)
argument_list|)
expr_stmt|;
name|memmove
argument_list|(
name|rpp
argument_list|,
name|rpp
operator|+
literal|1
argument_list|,
name|rrecs
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|rpp
argument_list|)
argument_list|)
expr_stmt|;
name|xfs_bmbt_log_keys
argument_list|(
name|cur
argument_list|,
name|rbp
argument_list|,
literal|1
argument_list|,
name|rrecs
argument_list|)
expr_stmt|;
name|xfs_bmbt_log_ptrs
argument_list|(
name|cur
argument_list|,
name|rbp
argument_list|,
literal|1
argument_list|,
name|rrecs
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|memmove
argument_list|(
name|rrp
argument_list|,
name|rrp
operator|+
literal|1
argument_list|,
name|rrecs
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|rrp
argument_list|)
argument_list|)
expr_stmt|;
name|xfs_bmbt_log_recs
argument_list|(
name|cur
argument_list|,
name|rbp
argument_list|,
literal|1
argument_list|,
name|rrecs
argument_list|)
expr_stmt|;
name|INT_SET
argument_list|(
name|key
operator|.
name|br_startoff
argument_list|,
name|ARCH_CONVERT
argument_list|,
name|xfs_bmbt_disk_get_startoff
argument_list|(
name|rrp
argument_list|)
argument_list|)
expr_stmt|;
name|rkp
operator|=
operator|&
name|key
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_bmbt_updkey
argument_list|(
name|cur
argument_list|,
name|rkp
argument_list|,
name|level
operator|+
literal|1
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
name|cur
operator|->
name|bc_ptrs
index|[
name|level
index|]
operator|--
expr_stmt|;
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|EXIT
argument_list|)
expr_stmt|;
operator|*
name|stat
operator|=
literal|1
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Move 1 record right from cur/level if possible.  * Update cur to reflect the new path.  */
end_comment

begin_function
name|STATIC
name|int
comment|/* error */
name|xfs_bmbt_rshift
parameter_list|(
name|xfs_btree_cur_t
modifier|*
name|cur
parameter_list|,
name|int
name|level
parameter_list|,
name|int
modifier|*
name|stat
parameter_list|)
comment|/* success/failure */
block|{
name|int
name|error
decl_stmt|;
comment|/* error return value */
ifdef|#
directive|ifdef
name|XFS_BMBT_TRACE
specifier|static
name|char
name|fname
index|[]
init|=
literal|"xfs_bmbt_rshift"
decl_stmt|;
endif|#
directive|endif
name|int
name|i
decl_stmt|;
comment|/* loop counter */
name|xfs_bmbt_key_t
name|key
decl_stmt|;
comment|/* bmap btree key */
name|xfs_buf_t
modifier|*
name|lbp
decl_stmt|;
comment|/* left buffer pointer */
name|xfs_bmbt_block_t
modifier|*
name|left
decl_stmt|;
comment|/* left btree block */
name|xfs_bmbt_key_t
modifier|*
name|lkp
decl_stmt|;
comment|/* left btree key */
name|xfs_bmbt_ptr_t
modifier|*
name|lpp
decl_stmt|;
comment|/* left address pointer */
name|xfs_bmbt_rec_t
modifier|*
name|lrp
decl_stmt|;
comment|/* left record pointer */
name|xfs_mount_t
modifier|*
name|mp
decl_stmt|;
comment|/* file system mount point */
name|xfs_buf_t
modifier|*
name|rbp
decl_stmt|;
comment|/* right buffer pointer */
name|xfs_bmbt_block_t
modifier|*
name|right
decl_stmt|;
comment|/* right btree block */
name|xfs_bmbt_key_t
modifier|*
name|rkp
decl_stmt|;
comment|/* right btree key */
name|xfs_bmbt_ptr_t
modifier|*
name|rpp
decl_stmt|;
comment|/* right address pointer */
name|xfs_bmbt_rec_t
modifier|*
name|rrp
init|=
name|NULL
decl_stmt|;
comment|/* right record pointer */
name|struct
name|xfs_btree_cur
modifier|*
name|tcur
decl_stmt|;
comment|/* temporary btree cursor */
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ENTRY
argument_list|)
expr_stmt|;
name|XFS_BMBT_TRACE_ARGI
argument_list|(
name|cur
argument_list|,
name|level
argument_list|)
expr_stmt|;
if|if
condition|(
name|level
operator|==
name|cur
operator|->
name|bc_nlevels
operator|-
literal|1
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|EXIT
argument_list|)
expr_stmt|;
operator|*
name|stat
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
name|lbp
operator|=
name|cur
operator|->
name|bc_bufs
index|[
name|level
index|]
expr_stmt|;
name|left
operator|=
name|XFS_BUF_TO_BMBT_BLOCK
argument_list|(
name|lbp
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_btree_check_lblock
argument_list|(
name|cur
argument_list|,
name|left
argument_list|,
name|level
argument_list|,
name|lbp
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
endif|#
directive|endif
if|if
condition|(
name|be64_to_cpu
argument_list|(
name|left
operator|->
name|bb_rightsib
argument_list|)
operator|==
name|NULLDFSBNO
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|EXIT
argument_list|)
expr_stmt|;
operator|*
name|stat
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|cur
operator|->
name|bc_ptrs
index|[
name|level
index|]
operator|>=
name|be16_to_cpu
argument_list|(
name|left
operator|->
name|bb_numrecs
argument_list|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|EXIT
argument_list|)
expr_stmt|;
operator|*
name|stat
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
name|mp
operator|=
name|cur
operator|->
name|bc_mp
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_btree_read_bufl
argument_list|(
name|mp
argument_list|,
name|cur
operator|->
name|bc_tp
argument_list|,
name|be64_to_cpu
argument_list|(
name|left
operator|->
name|bb_rightsib
argument_list|)
argument_list|,
literal|0
argument_list|,
operator|&
name|rbp
argument_list|,
name|XFS_BMAP_BTREE_REF
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
name|right
operator|=
name|XFS_BUF_TO_BMBT_BLOCK
argument_list|(
name|rbp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_btree_check_lblock
argument_list|(
name|cur
argument_list|,
name|right
argument_list|,
name|level
argument_list|,
name|rbp
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
if|if
condition|(
name|be16_to_cpu
argument_list|(
name|right
operator|->
name|bb_numrecs
argument_list|)
operator|==
name|XFS_BMAP_BLOCK_IMAXRECS
argument_list|(
name|level
argument_list|,
name|cur
argument_list|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|EXIT
argument_list|)
expr_stmt|;
operator|*
name|stat
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|level
operator|>
literal|0
condition|)
block|{
name|lkp
operator|=
name|XFS_BMAP_KEY_IADDR
argument_list|(
name|left
argument_list|,
name|be16_to_cpu
argument_list|(
name|left
operator|->
name|bb_numrecs
argument_list|)
argument_list|,
name|cur
argument_list|)
expr_stmt|;
name|lpp
operator|=
name|XFS_BMAP_PTR_IADDR
argument_list|(
name|left
argument_list|,
name|be16_to_cpu
argument_list|(
name|left
operator|->
name|bb_numrecs
argument_list|)
argument_list|,
name|cur
argument_list|)
expr_stmt|;
name|rkp
operator|=
name|XFS_BMAP_KEY_IADDR
argument_list|(
name|right
argument_list|,
literal|1
argument_list|,
name|cur
argument_list|)
expr_stmt|;
name|rpp
operator|=
name|XFS_BMAP_PTR_IADDR
argument_list|(
name|right
argument_list|,
literal|1
argument_list|,
name|cur
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
for|for
control|(
name|i
operator|=
name|be16_to_cpu
argument_list|(
name|right
operator|->
name|bb_numrecs
argument_list|)
operator|-
literal|1
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_btree_check_lptr
argument_list|(
name|cur
argument_list|,
name|INT_GET
argument_list|(
name|rpp
index|[
name|i
index|]
argument_list|,
name|ARCH_CONVERT
argument_list|)
argument_list|,
name|level
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
block|}
endif|#
directive|endif
name|memmove
argument_list|(
name|rkp
operator|+
literal|1
argument_list|,
name|rkp
argument_list|,
name|be16_to_cpu
argument_list|(
name|right
operator|->
name|bb_numrecs
argument_list|)
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|rkp
argument_list|)
argument_list|)
expr_stmt|;
name|memmove
argument_list|(
name|rpp
operator|+
literal|1
argument_list|,
name|rpp
argument_list|,
name|be16_to_cpu
argument_list|(
name|right
operator|->
name|bb_numrecs
argument_list|)
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|rpp
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_btree_check_lptr
argument_list|(
name|cur
argument_list|,
name|INT_GET
argument_list|(
operator|*
name|lpp
argument_list|,
name|ARCH_CONVERT
argument_list|)
argument_list|,
name|level
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
endif|#
directive|endif
operator|*
name|rkp
operator|=
operator|*
name|lkp
expr_stmt|;
operator|*
name|rpp
operator|=
operator|*
name|lpp
expr_stmt|;
comment|/* INT_: direct copy */
name|xfs_bmbt_log_keys
argument_list|(
name|cur
argument_list|,
name|rbp
argument_list|,
literal|1
argument_list|,
name|be16_to_cpu
argument_list|(
name|right
operator|->
name|bb_numrecs
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|xfs_bmbt_log_ptrs
argument_list|(
name|cur
argument_list|,
name|rbp
argument_list|,
literal|1
argument_list|,
name|be16_to_cpu
argument_list|(
name|right
operator|->
name|bb_numrecs
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|lrp
operator|=
name|XFS_BMAP_REC_IADDR
argument_list|(
name|left
argument_list|,
name|be16_to_cpu
argument_list|(
name|left
operator|->
name|bb_numrecs
argument_list|)
argument_list|,
name|cur
argument_list|)
expr_stmt|;
name|rrp
operator|=
name|XFS_BMAP_REC_IADDR
argument_list|(
name|right
argument_list|,
literal|1
argument_list|,
name|cur
argument_list|)
expr_stmt|;
name|memmove
argument_list|(
name|rrp
operator|+
literal|1
argument_list|,
name|rrp
argument_list|,
name|be16_to_cpu
argument_list|(
name|right
operator|->
name|bb_numrecs
argument_list|)
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|rrp
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|rrp
operator|=
operator|*
name|lrp
expr_stmt|;
name|xfs_bmbt_log_recs
argument_list|(
name|cur
argument_list|,
name|rbp
argument_list|,
literal|1
argument_list|,
name|be16_to_cpu
argument_list|(
name|right
operator|->
name|bb_numrecs
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|INT_SET
argument_list|(
name|key
operator|.
name|br_startoff
argument_list|,
name|ARCH_CONVERT
argument_list|,
name|xfs_bmbt_disk_get_startoff
argument_list|(
name|rrp
argument_list|)
argument_list|)
expr_stmt|;
name|rkp
operator|=
operator|&
name|key
expr_stmt|;
block|}
name|be16_add
argument_list|(
operator|&
name|left
operator|->
name|bb_numrecs
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|xfs_bmbt_log_block
argument_list|(
name|cur
argument_list|,
name|lbp
argument_list|,
name|XFS_BB_NUMRECS
argument_list|)
expr_stmt|;
name|be16_add
argument_list|(
operator|&
name|right
operator|->
name|bb_numrecs
argument_list|,
literal|1
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|level
operator|>
literal|0
condition|)
name|xfs_btree_check_key
argument_list|(
name|XFS_BTNUM_BMAP
argument_list|,
name|rkp
argument_list|,
name|rkp
operator|+
literal|1
argument_list|)
expr_stmt|;
else|else
name|xfs_btree_check_rec
argument_list|(
name|XFS_BTNUM_BMAP
argument_list|,
name|rrp
argument_list|,
name|rrp
operator|+
literal|1
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|xfs_bmbt_log_block
argument_list|(
name|cur
argument_list|,
name|rbp
argument_list|,
name|XFS_BB_NUMRECS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_btree_dup_cursor
argument_list|(
name|cur
argument_list|,
operator|&
name|tcur
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
name|i
operator|=
name|xfs_btree_lastrec
argument_list|(
name|tcur
argument_list|,
name|level
argument_list|)
expr_stmt|;
name|XFS_WANT_CORRUPTED_GOTO
argument_list|(
name|i
operator|==
literal|1
argument_list|,
name|error0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_bmbt_increment
argument_list|(
name|tcur
argument_list|,
name|level
argument_list|,
operator|&
name|i
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|tcur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
goto|goto
name|error1
goto|;
block|}
name|XFS_WANT_CORRUPTED_GOTO
argument_list|(
name|i
operator|==
literal|1
argument_list|,
name|error0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_bmbt_updkey
argument_list|(
name|tcur
argument_list|,
name|rkp
argument_list|,
name|level
operator|+
literal|1
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|tcur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
goto|goto
name|error1
goto|;
block|}
name|xfs_btree_del_cursor
argument_list|(
name|tcur
argument_list|,
name|XFS_BTREE_NOERROR
argument_list|)
expr_stmt|;
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|EXIT
argument_list|)
expr_stmt|;
operator|*
name|stat
operator|=
literal|1
expr_stmt|;
return|return
literal|0
return|;
name|error0
label|:
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
name|error1
label|:
name|xfs_btree_del_cursor
argument_list|(
name|tcur
argument_list|,
name|XFS_BTREE_ERROR
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_comment
comment|/*  * Determine the extent state.  */
end_comment

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
name|STATIC
name|xfs_exntst_t
name|xfs_extent_state
parameter_list|(
name|xfs_filblks_t
name|blks
parameter_list|,
name|int
name|extent_flag
parameter_list|)
block|{
if|if
condition|(
name|extent_flag
condition|)
block|{
name|ASSERT
argument_list|(
name|blks
operator|!=
literal|0
argument_list|)
expr_stmt|;
comment|/* saved for DMIG */
return|return
name|XFS_EXT_UNWRITTEN
return|;
block|}
return|return
name|XFS_EXT_NORM
return|;
block|}
end_function

begin_comment
comment|/*  * Split cur/level block in half.  * Return new block number and its first record (to be inserted into parent).  */
end_comment

begin_function
name|STATIC
name|int
comment|/* error */
name|xfs_bmbt_split
parameter_list|(
name|xfs_btree_cur_t
modifier|*
name|cur
parameter_list|,
name|int
name|level
parameter_list|,
name|xfs_fsblock_t
modifier|*
name|bnop
parameter_list|,
name|xfs_bmbt_key_t
modifier|*
name|keyp
parameter_list|,
name|xfs_btree_cur_t
modifier|*
modifier|*
name|curp
parameter_list|,
name|int
modifier|*
name|stat
parameter_list|)
comment|/* success/failure */
block|{
name|xfs_alloc_arg_t
name|args
decl_stmt|;
comment|/* block allocation args */
name|int
name|error
decl_stmt|;
comment|/* error return value */
ifdef|#
directive|ifdef
name|XFS_BMBT_TRACE
specifier|static
name|char
name|fname
index|[]
init|=
literal|"xfs_bmbt_split"
decl_stmt|;
endif|#
directive|endif
name|int
name|i
decl_stmt|;
comment|/* loop counter */
name|xfs_fsblock_t
name|lbno
decl_stmt|;
comment|/* left sibling block number */
name|xfs_buf_t
modifier|*
name|lbp
decl_stmt|;
comment|/* left buffer pointer */
name|xfs_bmbt_block_t
modifier|*
name|left
decl_stmt|;
comment|/* left btree block */
name|xfs_bmbt_key_t
modifier|*
name|lkp
decl_stmt|;
comment|/* left btree key */
name|xfs_bmbt_ptr_t
modifier|*
name|lpp
decl_stmt|;
comment|/* left address pointer */
name|xfs_bmbt_rec_t
modifier|*
name|lrp
decl_stmt|;
comment|/* left record pointer */
name|xfs_buf_t
modifier|*
name|rbp
decl_stmt|;
comment|/* right buffer pointer */
name|xfs_bmbt_block_t
modifier|*
name|right
decl_stmt|;
comment|/* right btree block */
name|xfs_bmbt_key_t
modifier|*
name|rkp
decl_stmt|;
comment|/* right btree key */
name|xfs_bmbt_ptr_t
modifier|*
name|rpp
decl_stmt|;
comment|/* right address pointer */
name|xfs_bmbt_block_t
modifier|*
name|rrblock
decl_stmt|;
comment|/* right-right btree block */
name|xfs_buf_t
modifier|*
name|rrbp
decl_stmt|;
comment|/* right-right buffer pointer */
name|xfs_bmbt_rec_t
modifier|*
name|rrp
decl_stmt|;
comment|/* right record pointer */
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ENTRY
argument_list|)
expr_stmt|;
name|XFS_BMBT_TRACE_ARGIFK
argument_list|(
name|cur
argument_list|,
name|level
argument_list|,
operator|*
name|bnop
argument_list|,
name|keyp
argument_list|)
expr_stmt|;
name|args
operator|.
name|tp
operator|=
name|cur
operator|->
name|bc_tp
expr_stmt|;
name|args
operator|.
name|mp
operator|=
name|cur
operator|->
name|bc_mp
expr_stmt|;
name|lbp
operator|=
name|cur
operator|->
name|bc_bufs
index|[
name|level
index|]
expr_stmt|;
name|lbno
operator|=
name|XFS_DADDR_TO_FSB
argument_list|(
name|args
operator|.
name|mp
argument_list|,
name|XFS_BUF_ADDR
argument_list|(
name|lbp
argument_list|)
argument_list|)
expr_stmt|;
name|left
operator|=
name|XFS_BUF_TO_BMBT_BLOCK
argument_list|(
name|lbp
argument_list|)
expr_stmt|;
name|args
operator|.
name|fsbno
operator|=
name|cur
operator|->
name|bc_private
operator|.
name|b
operator|.
name|firstblock
expr_stmt|;
if|if
condition|(
name|args
operator|.
name|fsbno
operator|==
name|NULLFSBLOCK
condition|)
block|{
name|args
operator|.
name|fsbno
operator|=
name|lbno
expr_stmt|;
name|args
operator|.
name|type
operator|=
name|XFS_ALLOCTYPE_START_BNO
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cur
operator|->
name|bc_private
operator|.
name|b
operator|.
name|flist
operator|->
name|xbf_low
condition|)
name|args
operator|.
name|type
operator|=
name|XFS_ALLOCTYPE_FIRST_AG
expr_stmt|;
else|else
name|args
operator|.
name|type
operator|=
name|XFS_ALLOCTYPE_NEAR_BNO
expr_stmt|;
name|args
operator|.
name|mod
operator|=
name|args
operator|.
name|minleft
operator|=
name|args
operator|.
name|alignment
operator|=
name|args
operator|.
name|total
operator|=
name|args
operator|.
name|isfl
operator|=
name|args
operator|.
name|userdata
operator|=
name|args
operator|.
name|minalignslop
operator|=
literal|0
expr_stmt|;
name|args
operator|.
name|minlen
operator|=
name|args
operator|.
name|maxlen
operator|=
name|args
operator|.
name|prod
operator|=
literal|1
expr_stmt|;
name|args
operator|.
name|wasdel
operator|=
name|cur
operator|->
name|bc_private
operator|.
name|b
operator|.
name|flags
operator|&
name|XFS_BTCUR_BPRV_WASDEL
expr_stmt|;
if|if
condition|(
operator|!
name|args
operator|.
name|wasdel
operator|&&
name|xfs_trans_get_block_res
argument_list|(
name|args
operator|.
name|tp
argument_list|)
operator|==
literal|0
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
return|return
name|XFS_ERROR
argument_list|(
name|ENOSPC
argument_list|)
return|;
block|}
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_alloc_vextent
argument_list|(
operator|&
name|args
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
if|if
condition|(
name|args
operator|.
name|fsbno
operator|==
name|NULLFSBLOCK
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|EXIT
argument_list|)
expr_stmt|;
operator|*
name|stat
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
name|ASSERT
argument_list|(
name|args
operator|.
name|len
operator|==
literal|1
argument_list|)
expr_stmt|;
name|cur
operator|->
name|bc_private
operator|.
name|b
operator|.
name|firstblock
operator|=
name|args
operator|.
name|fsbno
expr_stmt|;
name|cur
operator|->
name|bc_private
operator|.
name|b
operator|.
name|allocated
operator|++
expr_stmt|;
name|cur
operator|->
name|bc_private
operator|.
name|b
operator|.
name|ip
operator|->
name|i_d
operator|.
name|di_nblocks
operator|++
expr_stmt|;
name|xfs_trans_log_inode
argument_list|(
name|args
operator|.
name|tp
argument_list|,
name|cur
operator|->
name|bc_private
operator|.
name|b
operator|.
name|ip
argument_list|,
name|XFS_ILOG_CORE
argument_list|)
expr_stmt|;
name|XFS_TRANS_MOD_DQUOT_BYINO
argument_list|(
name|args
operator|.
name|mp
argument_list|,
name|args
operator|.
name|tp
argument_list|,
name|cur
operator|->
name|bc_private
operator|.
name|b
operator|.
name|ip
argument_list|,
name|XFS_TRANS_DQ_BCOUNT
argument_list|,
literal|1L
argument_list|)
expr_stmt|;
name|rbp
operator|=
name|xfs_btree_get_bufl
argument_list|(
name|args
operator|.
name|mp
argument_list|,
name|args
operator|.
name|tp
argument_list|,
name|args
operator|.
name|fsbno
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|right
operator|=
name|XFS_BUF_TO_BMBT_BLOCK
argument_list|(
name|rbp
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_btree_check_lblock
argument_list|(
name|cur
argument_list|,
name|left
argument_list|,
name|level
argument_list|,
name|rbp
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
endif|#
directive|endif
name|right
operator|->
name|bb_magic
operator|=
name|cpu_to_be32
argument_list|(
name|XFS_BMAP_MAGIC
argument_list|)
expr_stmt|;
name|right
operator|->
name|bb_level
operator|=
name|left
operator|->
name|bb_level
expr_stmt|;
name|right
operator|->
name|bb_numrecs
operator|=
name|cpu_to_be16
argument_list|(
name|be16_to_cpu
argument_list|(
name|left
operator|->
name|bb_numrecs
argument_list|)
operator|/
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|be16_to_cpu
argument_list|(
name|left
operator|->
name|bb_numrecs
argument_list|)
operator|&
literal|1
operator|)
operator|&&
name|cur
operator|->
name|bc_ptrs
index|[
name|level
index|]
operator|<=
name|be16_to_cpu
argument_list|(
name|right
operator|->
name|bb_numrecs
argument_list|)
operator|+
literal|1
condition|)
name|be16_add
argument_list|(
operator|&
name|right
operator|->
name|bb_numrecs
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|i
operator|=
name|be16_to_cpu
argument_list|(
name|left
operator|->
name|bb_numrecs
argument_list|)
operator|-
name|be16_to_cpu
argument_list|(
name|right
operator|->
name|bb_numrecs
argument_list|)
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|level
operator|>
literal|0
condition|)
block|{
name|lkp
operator|=
name|XFS_BMAP_KEY_IADDR
argument_list|(
name|left
argument_list|,
name|i
argument_list|,
name|cur
argument_list|)
expr_stmt|;
name|lpp
operator|=
name|XFS_BMAP_PTR_IADDR
argument_list|(
name|left
argument_list|,
name|i
argument_list|,
name|cur
argument_list|)
expr_stmt|;
name|rkp
operator|=
name|XFS_BMAP_KEY_IADDR
argument_list|(
name|right
argument_list|,
literal|1
argument_list|,
name|cur
argument_list|)
expr_stmt|;
name|rpp
operator|=
name|XFS_BMAP_PTR_IADDR
argument_list|(
name|right
argument_list|,
literal|1
argument_list|,
name|cur
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|be16_to_cpu
argument_list|(
name|right
operator|->
name|bb_numrecs
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_btree_check_lptr
argument_list|(
name|cur
argument_list|,
name|INT_GET
argument_list|(
name|lpp
index|[
name|i
index|]
argument_list|,
name|ARCH_CONVERT
argument_list|)
argument_list|,
name|level
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
block|}
endif|#
directive|endif
name|memcpy
argument_list|(
name|rkp
argument_list|,
name|lkp
argument_list|,
name|be16_to_cpu
argument_list|(
name|right
operator|->
name|bb_numrecs
argument_list|)
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|rkp
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|rpp
argument_list|,
name|lpp
argument_list|,
name|be16_to_cpu
argument_list|(
name|right
operator|->
name|bb_numrecs
argument_list|)
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|rpp
argument_list|)
argument_list|)
expr_stmt|;
name|xfs_bmbt_log_keys
argument_list|(
name|cur
argument_list|,
name|rbp
argument_list|,
literal|1
argument_list|,
name|be16_to_cpu
argument_list|(
name|right
operator|->
name|bb_numrecs
argument_list|)
argument_list|)
expr_stmt|;
name|xfs_bmbt_log_ptrs
argument_list|(
name|cur
argument_list|,
name|rbp
argument_list|,
literal|1
argument_list|,
name|be16_to_cpu
argument_list|(
name|right
operator|->
name|bb_numrecs
argument_list|)
argument_list|)
expr_stmt|;
name|keyp
operator|->
name|br_startoff
operator|=
name|INT_GET
argument_list|(
name|rkp
operator|->
name|br_startoff
argument_list|,
name|ARCH_CONVERT
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|lrp
operator|=
name|XFS_BMAP_REC_IADDR
argument_list|(
name|left
argument_list|,
name|i
argument_list|,
name|cur
argument_list|)
expr_stmt|;
name|rrp
operator|=
name|XFS_BMAP_REC_IADDR
argument_list|(
name|right
argument_list|,
literal|1
argument_list|,
name|cur
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|rrp
argument_list|,
name|lrp
argument_list|,
name|be16_to_cpu
argument_list|(
name|right
operator|->
name|bb_numrecs
argument_list|)
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|rrp
argument_list|)
argument_list|)
expr_stmt|;
name|xfs_bmbt_log_recs
argument_list|(
name|cur
argument_list|,
name|rbp
argument_list|,
literal|1
argument_list|,
name|be16_to_cpu
argument_list|(
name|right
operator|->
name|bb_numrecs
argument_list|)
argument_list|)
expr_stmt|;
name|keyp
operator|->
name|br_startoff
operator|=
name|xfs_bmbt_disk_get_startoff
argument_list|(
name|rrp
argument_list|)
expr_stmt|;
block|}
name|be16_add
argument_list|(
operator|&
name|left
operator|->
name|bb_numrecs
argument_list|,
operator|-
operator|(
name|be16_to_cpu
argument_list|(
name|right
operator|->
name|bb_numrecs
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|right
operator|->
name|bb_rightsib
operator|=
name|left
operator|->
name|bb_rightsib
expr_stmt|;
name|left
operator|->
name|bb_rightsib
operator|=
name|cpu_to_be64
argument_list|(
name|args
operator|.
name|fsbno
argument_list|)
expr_stmt|;
name|right
operator|->
name|bb_leftsib
operator|=
name|cpu_to_be64
argument_list|(
name|lbno
argument_list|)
expr_stmt|;
name|xfs_bmbt_log_block
argument_list|(
name|cur
argument_list|,
name|rbp
argument_list|,
name|XFS_BB_ALL_BITS
argument_list|)
expr_stmt|;
name|xfs_bmbt_log_block
argument_list|(
name|cur
argument_list|,
name|lbp
argument_list|,
name|XFS_BB_NUMRECS
operator||
name|XFS_BB_RIGHTSIB
argument_list|)
expr_stmt|;
if|if
condition|(
name|be64_to_cpu
argument_list|(
name|right
operator|->
name|bb_rightsib
argument_list|)
operator|!=
name|NULLDFSBNO
condition|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_btree_read_bufl
argument_list|(
name|args
operator|.
name|mp
argument_list|,
name|args
operator|.
name|tp
argument_list|,
name|be64_to_cpu
argument_list|(
name|right
operator|->
name|bb_rightsib
argument_list|)
argument_list|,
literal|0
argument_list|,
operator|&
name|rrbp
argument_list|,
name|XFS_BMAP_BTREE_REF
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
name|rrblock
operator|=
name|XFS_BUF_TO_BMBT_BLOCK
argument_list|(
name|rrbp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_btree_check_lblock
argument_list|(
name|cur
argument_list|,
name|rrblock
argument_list|,
name|level
argument_list|,
name|rrbp
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
name|rrblock
operator|->
name|bb_leftsib
operator|=
name|cpu_to_be64
argument_list|(
name|args
operator|.
name|fsbno
argument_list|)
expr_stmt|;
name|xfs_bmbt_log_block
argument_list|(
name|cur
argument_list|,
name|rrbp
argument_list|,
name|XFS_BB_LEFTSIB
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|cur
operator|->
name|bc_ptrs
index|[
name|level
index|]
operator|>
name|be16_to_cpu
argument_list|(
name|left
operator|->
name|bb_numrecs
argument_list|)
operator|+
literal|1
condition|)
block|{
name|xfs_btree_setbuf
argument_list|(
name|cur
argument_list|,
name|level
argument_list|,
name|rbp
argument_list|)
expr_stmt|;
name|cur
operator|->
name|bc_ptrs
index|[
name|level
index|]
operator|-=
name|be16_to_cpu
argument_list|(
name|left
operator|->
name|bb_numrecs
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|level
operator|+
literal|1
operator|<
name|cur
operator|->
name|bc_nlevels
condition|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_btree_dup_cursor
argument_list|(
name|cur
argument_list|,
name|curp
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
operator|(
operator|*
name|curp
operator|)
operator|->
name|bc_ptrs
index|[
name|level
operator|+
literal|1
index|]
operator|++
expr_stmt|;
block|}
operator|*
name|bnop
operator|=
name|args
operator|.
name|fsbno
expr_stmt|;
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|EXIT
argument_list|)
expr_stmt|;
operator|*
name|stat
operator|=
literal|1
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Update keys for the record.  */
end_comment

begin_function
name|STATIC
name|int
name|xfs_bmbt_updkey
parameter_list|(
name|xfs_btree_cur_t
modifier|*
name|cur
parameter_list|,
name|xfs_bmbt_key_t
modifier|*
name|keyp
parameter_list|,
comment|/* on-disk format */
name|int
name|level
parameter_list|)
block|{
name|xfs_bmbt_block_t
modifier|*
name|block
decl_stmt|;
name|xfs_buf_t
modifier|*
name|bp
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|int
name|error
decl_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|XFS_BMBT_TRACE
specifier|static
name|char
name|fname
index|[]
init|=
literal|"xfs_bmbt_updkey"
decl_stmt|;
endif|#
directive|endif
name|xfs_bmbt_key_t
modifier|*
name|kp
decl_stmt|;
name|int
name|ptr
decl_stmt|;
name|ASSERT
argument_list|(
name|level
operator|>=
literal|1
argument_list|)
expr_stmt|;
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ENTRY
argument_list|)
expr_stmt|;
name|XFS_BMBT_TRACE_ARGIK
argument_list|(
name|cur
argument_list|,
name|level
argument_list|,
name|keyp
argument_list|)
expr_stmt|;
for|for
control|(
name|ptr
operator|=
literal|1
init|;
name|ptr
operator|==
literal|1
operator|&&
name|level
operator|<
name|cur
operator|->
name|bc_nlevels
condition|;
name|level
operator|++
control|)
block|{
name|block
operator|=
name|xfs_bmbt_get_block
argument_list|(
name|cur
argument_list|,
name|level
argument_list|,
operator|&
name|bp
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_btree_check_lblock
argument_list|(
name|cur
argument_list|,
name|block
argument_list|,
name|level
argument_list|,
name|bp
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
endif|#
directive|endif
name|ptr
operator|=
name|cur
operator|->
name|bc_ptrs
index|[
name|level
index|]
expr_stmt|;
name|kp
operator|=
name|XFS_BMAP_KEY_IADDR
argument_list|(
name|block
argument_list|,
name|ptr
argument_list|,
name|cur
argument_list|)
expr_stmt|;
operator|*
name|kp
operator|=
operator|*
name|keyp
expr_stmt|;
name|xfs_bmbt_log_keys
argument_list|(
name|cur
argument_list|,
name|bp
argument_list|,
name|ptr
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
block|}
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|EXIT
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Convert on-disk form of btree root to in-memory form.  */
end_comment

begin_function
name|void
name|xfs_bmdr_to_bmbt
parameter_list|(
name|xfs_bmdr_block_t
modifier|*
name|dblock
parameter_list|,
name|int
name|dblocklen
parameter_list|,
name|xfs_bmbt_block_t
modifier|*
name|rblock
parameter_list|,
name|int
name|rblocklen
parameter_list|)
block|{
name|int
name|dmxr
decl_stmt|;
name|xfs_bmbt_key_t
modifier|*
name|fkp
decl_stmt|;
name|xfs_bmbt_ptr_t
modifier|*
name|fpp
decl_stmt|;
name|xfs_bmbt_key_t
modifier|*
name|tkp
decl_stmt|;
name|xfs_bmbt_ptr_t
modifier|*
name|tpp
decl_stmt|;
name|rblock
operator|->
name|bb_magic
operator|=
name|cpu_to_be32
argument_list|(
name|XFS_BMAP_MAGIC
argument_list|)
expr_stmt|;
name|rblock
operator|->
name|bb_level
operator|=
name|dblock
operator|->
name|bb_level
expr_stmt|;
name|ASSERT
argument_list|(
name|be16_to_cpu
argument_list|(
name|rblock
operator|->
name|bb_level
argument_list|)
operator|>
literal|0
argument_list|)
expr_stmt|;
name|rblock
operator|->
name|bb_numrecs
operator|=
name|dblock
operator|->
name|bb_numrecs
expr_stmt|;
name|rblock
operator|->
name|bb_leftsib
operator|=
name|cpu_to_be64
argument_list|(
name|NULLDFSBNO
argument_list|)
expr_stmt|;
name|rblock
operator|->
name|bb_rightsib
operator|=
name|cpu_to_be64
argument_list|(
name|NULLDFSBNO
argument_list|)
expr_stmt|;
name|dmxr
operator|=
operator|(
name|int
operator|)
name|XFS_BTREE_BLOCK_MAXRECS
argument_list|(
name|dblocklen
argument_list|,
name|xfs_bmdr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fkp
operator|=
name|XFS_BTREE_KEY_ADDR
argument_list|(
name|dblocklen
argument_list|,
name|xfs_bmdr
argument_list|,
name|dblock
argument_list|,
literal|1
argument_list|,
name|dmxr
argument_list|)
expr_stmt|;
name|tkp
operator|=
name|XFS_BMAP_BROOT_KEY_ADDR
argument_list|(
name|rblock
argument_list|,
literal|1
argument_list|,
name|rblocklen
argument_list|)
expr_stmt|;
name|fpp
operator|=
name|XFS_BTREE_PTR_ADDR
argument_list|(
name|dblocklen
argument_list|,
name|xfs_bmdr
argument_list|,
name|dblock
argument_list|,
literal|1
argument_list|,
name|dmxr
argument_list|)
expr_stmt|;
name|tpp
operator|=
name|XFS_BMAP_BROOT_PTR_ADDR
argument_list|(
name|rblock
argument_list|,
literal|1
argument_list|,
name|rblocklen
argument_list|)
expr_stmt|;
name|dmxr
operator|=
name|be16_to_cpu
argument_list|(
name|dblock
operator|->
name|bb_numrecs
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|tkp
argument_list|,
name|fkp
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|fkp
argument_list|)
operator|*
name|dmxr
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|tpp
argument_list|,
name|fpp
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|fpp
argument_list|)
operator|*
name|dmxr
argument_list|)
expr_stmt|;
comment|/* INT_: direct copy */
block|}
end_function

begin_comment
comment|/*  * Decrement cursor by one record at the level.  * For nonzero levels the leaf-ward information is untouched.  */
end_comment

begin_function
name|int
comment|/* error */
name|xfs_bmbt_decrement
parameter_list|(
name|xfs_btree_cur_t
modifier|*
name|cur
parameter_list|,
name|int
name|level
parameter_list|,
name|int
modifier|*
name|stat
parameter_list|)
comment|/* success/failure */
block|{
name|xfs_bmbt_block_t
modifier|*
name|block
decl_stmt|;
name|xfs_buf_t
modifier|*
name|bp
decl_stmt|;
name|int
name|error
decl_stmt|;
comment|/* error return value */
ifdef|#
directive|ifdef
name|XFS_BMBT_TRACE
specifier|static
name|char
name|fname
index|[]
init|=
literal|"xfs_bmbt_decrement"
decl_stmt|;
endif|#
directive|endif
name|xfs_fsblock_t
name|fsbno
decl_stmt|;
name|int
name|lev
decl_stmt|;
name|xfs_mount_t
modifier|*
name|mp
decl_stmt|;
name|xfs_trans_t
modifier|*
name|tp
decl_stmt|;
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ENTRY
argument_list|)
expr_stmt|;
name|XFS_BMBT_TRACE_ARGI
argument_list|(
name|cur
argument_list|,
name|level
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|level
operator|<
name|cur
operator|->
name|bc_nlevels
argument_list|)
expr_stmt|;
if|if
condition|(
name|level
operator|<
name|cur
operator|->
name|bc_nlevels
operator|-
literal|1
condition|)
name|xfs_btree_readahead
argument_list|(
name|cur
argument_list|,
name|level
argument_list|,
name|XFS_BTCUR_LEFTRA
argument_list|)
expr_stmt|;
if|if
condition|(
operator|--
name|cur
operator|->
name|bc_ptrs
index|[
name|level
index|]
operator|>
literal|0
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|EXIT
argument_list|)
expr_stmt|;
operator|*
name|stat
operator|=
literal|1
expr_stmt|;
return|return
literal|0
return|;
block|}
name|block
operator|=
name|xfs_bmbt_get_block
argument_list|(
name|cur
argument_list|,
name|level
argument_list|,
operator|&
name|bp
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_btree_check_lblock
argument_list|(
name|cur
argument_list|,
name|block
argument_list|,
name|level
argument_list|,
name|bp
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
endif|#
directive|endif
if|if
condition|(
name|be64_to_cpu
argument_list|(
name|block
operator|->
name|bb_leftsib
argument_list|)
operator|==
name|NULLDFSBNO
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|EXIT
argument_list|)
expr_stmt|;
operator|*
name|stat
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
for|for
control|(
name|lev
operator|=
name|level
operator|+
literal|1
init|;
name|lev
operator|<
name|cur
operator|->
name|bc_nlevels
condition|;
name|lev
operator|++
control|)
block|{
if|if
condition|(
operator|--
name|cur
operator|->
name|bc_ptrs
index|[
name|lev
index|]
operator|>
literal|0
condition|)
break|break;
if|if
condition|(
name|lev
operator|<
name|cur
operator|->
name|bc_nlevels
operator|-
literal|1
condition|)
name|xfs_btree_readahead
argument_list|(
name|cur
argument_list|,
name|lev
argument_list|,
name|XFS_BTCUR_LEFTRA
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|lev
operator|==
name|cur
operator|->
name|bc_nlevels
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|EXIT
argument_list|)
expr_stmt|;
operator|*
name|stat
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
name|tp
operator|=
name|cur
operator|->
name|bc_tp
expr_stmt|;
name|mp
operator|=
name|cur
operator|->
name|bc_mp
expr_stmt|;
for|for
control|(
name|block
operator|=
name|xfs_bmbt_get_block
argument_list|(
name|cur
argument_list|,
name|lev
argument_list|,
operator|&
name|bp
argument_list|)
init|;
name|lev
operator|>
name|level
condition|;
control|)
block|{
name|fsbno
operator|=
name|INT_GET
argument_list|(
operator|*
name|XFS_BMAP_PTR_IADDR
argument_list|(
name|block
argument_list|,
name|cur
operator|->
name|bc_ptrs
index|[
name|lev
index|]
argument_list|,
name|cur
argument_list|)
argument_list|,
name|ARCH_CONVERT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_btree_read_bufl
argument_list|(
name|mp
argument_list|,
name|tp
argument_list|,
name|fsbno
argument_list|,
literal|0
argument_list|,
operator|&
name|bp
argument_list|,
name|XFS_BMAP_BTREE_REF
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
name|lev
operator|--
expr_stmt|;
name|xfs_btree_setbuf
argument_list|(
name|cur
argument_list|,
name|lev
argument_list|,
name|bp
argument_list|)
expr_stmt|;
name|block
operator|=
name|XFS_BUF_TO_BMBT_BLOCK
argument_list|(
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_btree_check_lblock
argument_list|(
name|cur
argument_list|,
name|block
argument_list|,
name|lev
argument_list|,
name|bp
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
name|cur
operator|->
name|bc_ptrs
index|[
name|lev
index|]
operator|=
name|be16_to_cpu
argument_list|(
name|block
operator|->
name|bb_numrecs
argument_list|)
expr_stmt|;
block|}
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|EXIT
argument_list|)
expr_stmt|;
operator|*
name|stat
operator|=
literal|1
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Delete the record pointed to by cur.  */
end_comment

begin_function
name|int
comment|/* error */
name|xfs_bmbt_delete
parameter_list|(
name|xfs_btree_cur_t
modifier|*
name|cur
parameter_list|,
name|int
modifier|*
name|stat
parameter_list|)
comment|/* success/failure */
block|{
name|int
name|error
decl_stmt|;
comment|/* error return value */
ifdef|#
directive|ifdef
name|XFS_BMBT_TRACE
specifier|static
name|char
name|fname
index|[]
init|=
literal|"xfs_bmbt_delete"
decl_stmt|;
endif|#
directive|endif
name|int
name|i
decl_stmt|;
name|int
name|level
decl_stmt|;
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ENTRY
argument_list|)
expr_stmt|;
for|for
control|(
name|level
operator|=
literal|0
operator|,
name|i
operator|=
literal|2
init|;
name|i
operator|==
literal|2
condition|;
name|level
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_bmbt_delrec
argument_list|(
name|cur
argument_list|,
name|level
argument_list|,
operator|&
name|i
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
block|}
if|if
condition|(
name|i
operator|==
literal|0
condition|)
block|{
for|for
control|(
name|level
operator|=
literal|1
init|;
name|level
operator|<
name|cur
operator|->
name|bc_nlevels
condition|;
name|level
operator|++
control|)
block|{
if|if
condition|(
name|cur
operator|->
name|bc_ptrs
index|[
name|level
index|]
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_bmbt_decrement
argument_list|(
name|cur
argument_list|,
name|level
argument_list|,
operator|&
name|i
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
break|break;
block|}
block|}
block|}
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|EXIT
argument_list|)
expr_stmt|;
operator|*
name|stat
operator|=
name|i
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Convert a compressed bmap extent record to an uncompressed form.  * This code must be in sync with the routines xfs_bmbt_get_startoff,  * xfs_bmbt_get_startblock, xfs_bmbt_get_blockcount and xfs_bmbt_get_state.  */
end_comment

begin_function
name|STATIC
name|__inline__
name|void
name|__xfs_bmbt_get_all
parameter_list|(
name|__uint64_t
name|l0
parameter_list|,
name|__uint64_t
name|l1
parameter_list|,
name|xfs_bmbt_irec_t
modifier|*
name|s
parameter_list|)
block|{
name|int
name|ext_flag
decl_stmt|;
name|xfs_exntst_t
name|st
decl_stmt|;
name|ext_flag
operator|=
call|(
name|int
call|)
argument_list|(
name|l0
operator|>>
operator|(
literal|64
operator|-
name|BMBT_EXNTFLAG_BITLEN
operator|)
argument_list|)
expr_stmt|;
name|s
operator|->
name|br_startoff
operator|=
operator|(
operator|(
name|xfs_fileoff_t
operator|)
name|l0
operator|&
name|XFS_MASK64LO
argument_list|(
literal|64
operator|-
name|BMBT_EXNTFLAG_BITLEN
argument_list|)
operator|)
operator|>>
literal|9
expr_stmt|;
if|#
directive|if
name|XFS_BIG_BLKNOS
name|s
operator|->
name|br_startblock
operator|=
operator|(
operator|(
operator|(
name|xfs_fsblock_t
operator|)
name|l0
operator|&
name|XFS_MASK64LO
argument_list|(
literal|9
argument_list|)
operator|)
operator|<<
literal|43
operator|)
operator||
operator|(
operator|(
operator|(
name|xfs_fsblock_t
operator|)
name|l1
operator|)
operator|>>
literal|21
operator|)
expr_stmt|;
else|#
directive|else
ifdef|#
directive|ifdef
name|DEBUG
block|{
name|xfs_dfsbno_t
name|b
decl_stmt|;
name|b
operator|=
operator|(
operator|(
operator|(
name|xfs_dfsbno_t
operator|)
name|l0
operator|&
name|XFS_MASK64LO
argument_list|(
literal|9
argument_list|)
operator|)
operator|<<
literal|43
operator|)
operator||
operator|(
operator|(
operator|(
name|xfs_dfsbno_t
operator|)
name|l1
operator|)
operator|>>
literal|21
operator|)
expr_stmt|;
name|ASSERT
argument_list|(
operator|(
name|b
operator|>>
literal|32
operator|)
operator|==
literal|0
operator|||
name|ISNULLDSTARTBLOCK
argument_list|(
name|b
argument_list|)
argument_list|)
expr_stmt|;
name|s
operator|->
name|br_startblock
operator|=
operator|(
name|xfs_fsblock_t
operator|)
name|b
expr_stmt|;
block|}
else|#
directive|else
comment|/* !DEBUG */
name|s
operator|->
name|br_startblock
operator|=
call|(
name|xfs_fsblock_t
call|)
argument_list|(
operator|(
operator|(
name|xfs_dfsbno_t
operator|)
name|l1
operator|)
operator|>>
literal|21
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* DEBUG */
endif|#
directive|endif
comment|/* XFS_BIG_BLKNOS */
name|s
operator|->
name|br_blockcount
operator|=
call|(
name|xfs_filblks_t
call|)
argument_list|(
name|l1
operator|&
name|XFS_MASK64LO
argument_list|(
literal|21
argument_list|)
argument_list|)
expr_stmt|;
comment|/* This is xfs_extent_state() in-line */
if|if
condition|(
name|ext_flag
condition|)
block|{
name|ASSERT
argument_list|(
name|s
operator|->
name|br_blockcount
operator|!=
literal|0
argument_list|)
expr_stmt|;
comment|/* saved for DMIG */
name|st
operator|=
name|XFS_EXT_UNWRITTEN
expr_stmt|;
block|}
else|else
name|st
operator|=
name|XFS_EXT_NORM
expr_stmt|;
name|s
operator|->
name|br_state
operator|=
name|st
expr_stmt|;
block|}
end_function

begin_function
name|void
name|xfs_bmbt_get_all
parameter_list|(
name|xfs_bmbt_rec_t
modifier|*
name|r
parameter_list|,
name|xfs_bmbt_irec_t
modifier|*
name|s
parameter_list|)
block|{
name|__xfs_bmbt_get_all
argument_list|(
name|r
operator|->
name|l0
argument_list|,
name|r
operator|->
name|l1
argument_list|,
name|s
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Get the block pointer for the given level of the cursor.  * Fill in the buffer pointer, if applicable.  */
end_comment

begin_function
name|xfs_bmbt_block_t
modifier|*
name|xfs_bmbt_get_block
parameter_list|(
name|xfs_btree_cur_t
modifier|*
name|cur
parameter_list|,
name|int
name|level
parameter_list|,
name|xfs_buf_t
modifier|*
modifier|*
name|bpp
parameter_list|)
block|{
name|xfs_ifork_t
modifier|*
name|ifp
decl_stmt|;
name|xfs_bmbt_block_t
modifier|*
name|rval
decl_stmt|;
if|if
condition|(
name|level
operator|<
name|cur
operator|->
name|bc_nlevels
operator|-
literal|1
condition|)
block|{
operator|*
name|bpp
operator|=
name|cur
operator|->
name|bc_bufs
index|[
name|level
index|]
expr_stmt|;
name|rval
operator|=
name|XFS_BUF_TO_BMBT_BLOCK
argument_list|(
operator|*
name|bpp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|*
name|bpp
operator|=
name|NULL
expr_stmt|;
name|ifp
operator|=
name|XFS_IFORK_PTR
argument_list|(
name|cur
operator|->
name|bc_private
operator|.
name|b
operator|.
name|ip
argument_list|,
name|cur
operator|->
name|bc_private
operator|.
name|b
operator|.
name|whichfork
argument_list|)
expr_stmt|;
name|rval
operator|=
name|ifp
operator|->
name|if_broot
expr_stmt|;
block|}
return|return
name|rval
return|;
block|}
end_function

begin_comment
comment|/*  * Extract the blockcount field from an in memory bmap extent record.  */
end_comment

begin_function
name|xfs_filblks_t
name|xfs_bmbt_get_blockcount
parameter_list|(
name|xfs_bmbt_rec_t
modifier|*
name|r
parameter_list|)
block|{
return|return
call|(
name|xfs_filblks_t
call|)
argument_list|(
name|r
operator|->
name|l1
operator|&
name|XFS_MASK64LO
argument_list|(
literal|21
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  * Extract the startblock field from an in memory bmap extent record.  */
end_comment

begin_function
name|xfs_fsblock_t
name|xfs_bmbt_get_startblock
parameter_list|(
name|xfs_bmbt_rec_t
modifier|*
name|r
parameter_list|)
block|{
if|#
directive|if
name|XFS_BIG_BLKNOS
return|return
operator|(
operator|(
operator|(
name|xfs_fsblock_t
operator|)
name|r
operator|->
name|l0
operator|&
name|XFS_MASK64LO
argument_list|(
literal|9
argument_list|)
operator|)
operator|<<
literal|43
operator|)
operator||
operator|(
operator|(
operator|(
name|xfs_fsblock_t
operator|)
name|r
operator|->
name|l1
operator|)
operator|>>
literal|21
operator|)
return|;
else|#
directive|else
ifdef|#
directive|ifdef
name|DEBUG
name|xfs_dfsbno_t
name|b
decl_stmt|;
name|b
operator|=
operator|(
operator|(
operator|(
name|xfs_dfsbno_t
operator|)
name|r
operator|->
name|l0
operator|&
name|XFS_MASK64LO
argument_list|(
literal|9
argument_list|)
operator|)
operator|<<
literal|43
operator|)
operator||
operator|(
operator|(
operator|(
name|xfs_dfsbno_t
operator|)
name|r
operator|->
name|l1
operator|)
operator|>>
literal|21
operator|)
expr_stmt|;
name|ASSERT
argument_list|(
operator|(
name|b
operator|>>
literal|32
operator|)
operator|==
literal|0
operator|||
name|ISNULLDSTARTBLOCK
argument_list|(
name|b
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|xfs_fsblock_t
operator|)
name|b
return|;
else|#
directive|else
comment|/* !DEBUG */
return|return
call|(
name|xfs_fsblock_t
call|)
argument_list|(
operator|(
operator|(
name|xfs_dfsbno_t
operator|)
name|r
operator|->
name|l1
operator|)
operator|>>
literal|21
argument_list|)
return|;
endif|#
directive|endif
comment|/* DEBUG */
endif|#
directive|endif
comment|/* XFS_BIG_BLKNOS */
block|}
end_function

begin_comment
comment|/*  * Extract the startoff field from an in memory bmap extent record.  */
end_comment

begin_function
name|xfs_fileoff_t
name|xfs_bmbt_get_startoff
parameter_list|(
name|xfs_bmbt_rec_t
modifier|*
name|r
parameter_list|)
block|{
return|return
operator|(
operator|(
name|xfs_fileoff_t
operator|)
name|r
operator|->
name|l0
operator|&
name|XFS_MASK64LO
argument_list|(
literal|64
operator|-
name|BMBT_EXNTFLAG_BITLEN
argument_list|)
operator|)
operator|>>
literal|9
return|;
block|}
end_function

begin_function
name|xfs_exntst_t
name|xfs_bmbt_get_state
parameter_list|(
name|xfs_bmbt_rec_t
modifier|*
name|r
parameter_list|)
block|{
name|int
name|ext_flag
decl_stmt|;
name|ext_flag
operator|=
call|(
name|int
call|)
argument_list|(
operator|(
name|r
operator|->
name|l0
operator|)
operator|>>
operator|(
literal|64
operator|-
name|BMBT_EXNTFLAG_BITLEN
operator|)
argument_list|)
expr_stmt|;
return|return
name|xfs_extent_state
argument_list|(
name|xfs_bmbt_get_blockcount
argument_list|(
name|r
argument_list|)
argument_list|,
name|ext_flag
argument_list|)
return|;
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|XFS_NATIVE_HOST
end_ifndef

begin_comment
comment|/* Endian flipping versions of the bmbt extraction functions */
end_comment

begin_function
name|void
name|xfs_bmbt_disk_get_all
parameter_list|(
name|xfs_bmbt_rec_t
modifier|*
name|r
parameter_list|,
name|xfs_bmbt_irec_t
modifier|*
name|s
parameter_list|)
block|{
name|__uint64_t
name|l0
decl_stmt|,
name|l1
decl_stmt|;
name|l0
operator|=
name|INT_GET
argument_list|(
name|r
operator|->
name|l0
argument_list|,
name|ARCH_CONVERT
argument_list|)
expr_stmt|;
name|l1
operator|=
name|INT_GET
argument_list|(
name|r
operator|->
name|l1
argument_list|,
name|ARCH_CONVERT
argument_list|)
expr_stmt|;
name|__xfs_bmbt_get_all
argument_list|(
name|l0
argument_list|,
name|l1
argument_list|,
name|s
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Extract the blockcount field from an on disk bmap extent record.  */
end_comment

begin_function
name|xfs_filblks_t
name|xfs_bmbt_disk_get_blockcount
parameter_list|(
name|xfs_bmbt_rec_t
modifier|*
name|r
parameter_list|)
block|{
return|return
call|(
name|xfs_filblks_t
call|)
argument_list|(
name|INT_GET
argument_list|(
name|r
operator|->
name|l1
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|&
name|XFS_MASK64LO
argument_list|(
literal|21
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  * Extract the startblock field from an on disk bmap extent record.  */
end_comment

begin_function
name|xfs_fsblock_t
name|xfs_bmbt_disk_get_startblock
parameter_list|(
name|xfs_bmbt_rec_t
modifier|*
name|r
parameter_list|)
block|{
if|#
directive|if
name|XFS_BIG_BLKNOS
return|return
operator|(
operator|(
operator|(
name|xfs_fsblock_t
operator|)
name|INT_GET
argument_list|(
name|r
operator|->
name|l0
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|&
name|XFS_MASK64LO
argument_list|(
literal|9
argument_list|)
operator|)
operator|<<
literal|43
operator|)
operator||
operator|(
operator|(
operator|(
name|xfs_fsblock_t
operator|)
name|INT_GET
argument_list|(
name|r
operator|->
name|l1
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|)
operator|>>
literal|21
operator|)
return|;
else|#
directive|else
ifdef|#
directive|ifdef
name|DEBUG
name|xfs_dfsbno_t
name|b
decl_stmt|;
name|b
operator|=
operator|(
operator|(
operator|(
name|xfs_dfsbno_t
operator|)
name|INT_GET
argument_list|(
name|r
operator|->
name|l0
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|&
name|XFS_MASK64LO
argument_list|(
literal|9
argument_list|)
operator|)
operator|<<
literal|43
operator|)
operator||
operator|(
operator|(
operator|(
name|xfs_dfsbno_t
operator|)
name|INT_GET
argument_list|(
name|r
operator|->
name|l1
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|)
operator|>>
literal|21
operator|)
expr_stmt|;
name|ASSERT
argument_list|(
operator|(
name|b
operator|>>
literal|32
operator|)
operator|==
literal|0
operator|||
name|ISNULLDSTARTBLOCK
argument_list|(
name|b
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|xfs_fsblock_t
operator|)
name|b
return|;
else|#
directive|else
comment|/* !DEBUG */
return|return
call|(
name|xfs_fsblock_t
call|)
argument_list|(
operator|(
operator|(
name|xfs_dfsbno_t
operator|)
name|INT_GET
argument_list|(
name|r
operator|->
name|l1
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|)
operator|>>
literal|21
argument_list|)
return|;
endif|#
directive|endif
comment|/* DEBUG */
endif|#
directive|endif
comment|/* XFS_BIG_BLKNOS */
block|}
end_function

begin_comment
comment|/*  * Extract the startoff field from a disk format bmap extent record.  */
end_comment

begin_function
name|xfs_fileoff_t
name|xfs_bmbt_disk_get_startoff
parameter_list|(
name|xfs_bmbt_rec_t
modifier|*
name|r
parameter_list|)
block|{
return|return
operator|(
operator|(
name|xfs_fileoff_t
operator|)
name|INT_GET
argument_list|(
name|r
operator|->
name|l0
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|&
name|XFS_MASK64LO
argument_list|(
literal|64
operator|-
name|BMBT_EXNTFLAG_BITLEN
argument_list|)
operator|)
operator|>>
literal|9
return|;
block|}
end_function

begin_function
name|xfs_exntst_t
name|xfs_bmbt_disk_get_state
parameter_list|(
name|xfs_bmbt_rec_t
modifier|*
name|r
parameter_list|)
block|{
name|int
name|ext_flag
decl_stmt|;
name|ext_flag
operator|=
call|(
name|int
call|)
argument_list|(
operator|(
name|INT_GET
argument_list|(
name|r
operator|->
name|l0
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|)
operator|>>
operator|(
literal|64
operator|-
name|BMBT_EXNTFLAG_BITLEN
operator|)
argument_list|)
expr_stmt|;
return|return
name|xfs_extent_state
argument_list|(
name|xfs_bmbt_disk_get_blockcount
argument_list|(
name|r
argument_list|)
argument_list|,
name|ext_flag
argument_list|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* XFS_NATIVE_HOST */
end_comment

begin_comment
comment|/*  * Increment cursor by one record at the level.  * For nonzero levels the leaf-ward information is untouched.  */
end_comment

begin_function
name|int
comment|/* error */
name|xfs_bmbt_increment
parameter_list|(
name|xfs_btree_cur_t
modifier|*
name|cur
parameter_list|,
name|int
name|level
parameter_list|,
name|int
modifier|*
name|stat
parameter_list|)
comment|/* success/failure */
block|{
name|xfs_bmbt_block_t
modifier|*
name|block
decl_stmt|;
name|xfs_buf_t
modifier|*
name|bp
decl_stmt|;
name|int
name|error
decl_stmt|;
comment|/* error return value */
ifdef|#
directive|ifdef
name|XFS_BMBT_TRACE
specifier|static
name|char
name|fname
index|[]
init|=
literal|"xfs_bmbt_increment"
decl_stmt|;
endif|#
directive|endif
name|xfs_fsblock_t
name|fsbno
decl_stmt|;
name|int
name|lev
decl_stmt|;
name|xfs_mount_t
modifier|*
name|mp
decl_stmt|;
name|xfs_trans_t
modifier|*
name|tp
decl_stmt|;
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ENTRY
argument_list|)
expr_stmt|;
name|XFS_BMBT_TRACE_ARGI
argument_list|(
name|cur
argument_list|,
name|level
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|level
operator|<
name|cur
operator|->
name|bc_nlevels
argument_list|)
expr_stmt|;
if|if
condition|(
name|level
operator|<
name|cur
operator|->
name|bc_nlevels
operator|-
literal|1
condition|)
name|xfs_btree_readahead
argument_list|(
name|cur
argument_list|,
name|level
argument_list|,
name|XFS_BTCUR_RIGHTRA
argument_list|)
expr_stmt|;
name|block
operator|=
name|xfs_bmbt_get_block
argument_list|(
name|cur
argument_list|,
name|level
argument_list|,
operator|&
name|bp
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_btree_check_lblock
argument_list|(
name|cur
argument_list|,
name|block
argument_list|,
name|level
argument_list|,
name|bp
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
endif|#
directive|endif
if|if
condition|(
operator|++
name|cur
operator|->
name|bc_ptrs
index|[
name|level
index|]
operator|<=
name|be16_to_cpu
argument_list|(
name|block
operator|->
name|bb_numrecs
argument_list|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|EXIT
argument_list|)
expr_stmt|;
operator|*
name|stat
operator|=
literal|1
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|be64_to_cpu
argument_list|(
name|block
operator|->
name|bb_rightsib
argument_list|)
operator|==
name|NULLDFSBNO
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|EXIT
argument_list|)
expr_stmt|;
operator|*
name|stat
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
for|for
control|(
name|lev
operator|=
name|level
operator|+
literal|1
init|;
name|lev
operator|<
name|cur
operator|->
name|bc_nlevels
condition|;
name|lev
operator|++
control|)
block|{
name|block
operator|=
name|xfs_bmbt_get_block
argument_list|(
name|cur
argument_list|,
name|lev
argument_list|,
operator|&
name|bp
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_btree_check_lblock
argument_list|(
name|cur
argument_list|,
name|block
argument_list|,
name|lev
argument_list|,
name|bp
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
endif|#
directive|endif
if|if
condition|(
operator|++
name|cur
operator|->
name|bc_ptrs
index|[
name|lev
index|]
operator|<=
name|be16_to_cpu
argument_list|(
name|block
operator|->
name|bb_numrecs
argument_list|)
condition|)
break|break;
if|if
condition|(
name|lev
operator|<
name|cur
operator|->
name|bc_nlevels
operator|-
literal|1
condition|)
name|xfs_btree_readahead
argument_list|(
name|cur
argument_list|,
name|lev
argument_list|,
name|XFS_BTCUR_RIGHTRA
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|lev
operator|==
name|cur
operator|->
name|bc_nlevels
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|EXIT
argument_list|)
expr_stmt|;
operator|*
name|stat
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
name|tp
operator|=
name|cur
operator|->
name|bc_tp
expr_stmt|;
name|mp
operator|=
name|cur
operator|->
name|bc_mp
expr_stmt|;
for|for
control|(
name|block
operator|=
name|xfs_bmbt_get_block
argument_list|(
name|cur
argument_list|,
name|lev
argument_list|,
operator|&
name|bp
argument_list|)
init|;
name|lev
operator|>
name|level
condition|;
control|)
block|{
name|fsbno
operator|=
name|INT_GET
argument_list|(
operator|*
name|XFS_BMAP_PTR_IADDR
argument_list|(
name|block
argument_list|,
name|cur
operator|->
name|bc_ptrs
index|[
name|lev
index|]
argument_list|,
name|cur
argument_list|)
argument_list|,
name|ARCH_CONVERT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_btree_read_bufl
argument_list|(
name|mp
argument_list|,
name|tp
argument_list|,
name|fsbno
argument_list|,
literal|0
argument_list|,
operator|&
name|bp
argument_list|,
name|XFS_BMAP_BTREE_REF
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
name|lev
operator|--
expr_stmt|;
name|xfs_btree_setbuf
argument_list|(
name|cur
argument_list|,
name|lev
argument_list|,
name|bp
argument_list|)
expr_stmt|;
name|block
operator|=
name|XFS_BUF_TO_BMBT_BLOCK
argument_list|(
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_btree_check_lblock
argument_list|(
name|cur
argument_list|,
name|block
argument_list|,
name|lev
argument_list|,
name|bp
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
name|cur
operator|->
name|bc_ptrs
index|[
name|lev
index|]
operator|=
literal|1
expr_stmt|;
block|}
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|EXIT
argument_list|)
expr_stmt|;
operator|*
name|stat
operator|=
literal|1
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Insert the current record at the point referenced by cur.  */
end_comment

begin_function
name|int
comment|/* error */
name|xfs_bmbt_insert
parameter_list|(
name|xfs_btree_cur_t
modifier|*
name|cur
parameter_list|,
name|int
modifier|*
name|stat
parameter_list|)
comment|/* success/failure */
block|{
name|int
name|error
decl_stmt|;
comment|/* error return value */
ifdef|#
directive|ifdef
name|XFS_BMBT_TRACE
specifier|static
name|char
name|fname
index|[]
init|=
literal|"xfs_bmbt_insert"
decl_stmt|;
endif|#
directive|endif
name|int
name|i
decl_stmt|;
name|int
name|level
decl_stmt|;
name|xfs_fsblock_t
name|nbno
decl_stmt|;
name|xfs_btree_cur_t
modifier|*
name|ncur
decl_stmt|;
name|xfs_bmbt_rec_t
name|nrec
decl_stmt|;
name|xfs_btree_cur_t
modifier|*
name|pcur
decl_stmt|;
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ENTRY
argument_list|)
expr_stmt|;
name|level
operator|=
literal|0
expr_stmt|;
name|nbno
operator|=
name|NULLFSBLOCK
expr_stmt|;
name|xfs_bmbt_disk_set_all
argument_list|(
operator|&
name|nrec
argument_list|,
operator|&
name|cur
operator|->
name|bc_rec
operator|.
name|b
argument_list|)
expr_stmt|;
name|ncur
operator|=
operator|(
name|xfs_btree_cur_t
operator|*
operator|)
literal|0
expr_stmt|;
name|pcur
operator|=
name|cur
expr_stmt|;
do|do
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_bmbt_insrec
argument_list|(
name|pcur
argument_list|,
name|level
operator|++
argument_list|,
operator|&
name|nbno
argument_list|,
operator|&
name|nrec
argument_list|,
operator|&
name|ncur
argument_list|,
operator|&
name|i
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
name|pcur
operator|!=
name|cur
condition|)
name|xfs_btree_del_cursor
argument_list|(
name|pcur
argument_list|,
name|XFS_BTREE_ERROR
argument_list|)
expr_stmt|;
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
name|XFS_WANT_CORRUPTED_GOTO
argument_list|(
name|i
operator|==
literal|1
argument_list|,
name|error0
argument_list|)
expr_stmt|;
if|if
condition|(
name|pcur
operator|!=
name|cur
operator|&&
operator|(
name|ncur
operator|||
name|nbno
operator|==
name|NULLFSBLOCK
operator|)
condition|)
block|{
name|cur
operator|->
name|bc_nlevels
operator|=
name|pcur
operator|->
name|bc_nlevels
expr_stmt|;
name|cur
operator|->
name|bc_private
operator|.
name|b
operator|.
name|allocated
operator|+=
name|pcur
operator|->
name|bc_private
operator|.
name|b
operator|.
name|allocated
expr_stmt|;
name|pcur
operator|->
name|bc_private
operator|.
name|b
operator|.
name|allocated
operator|=
literal|0
expr_stmt|;
name|ASSERT
argument_list|(
operator|(
name|cur
operator|->
name|bc_private
operator|.
name|b
operator|.
name|firstblock
operator|!=
name|NULLFSBLOCK
operator|)
operator|||
operator|(
name|cur
operator|->
name|bc_private
operator|.
name|b
operator|.
name|ip
operator|->
name|i_d
operator|.
name|di_flags
operator|&
name|XFS_DIFLAG_REALTIME
operator|)
argument_list|)
expr_stmt|;
name|cur
operator|->
name|bc_private
operator|.
name|b
operator|.
name|firstblock
operator|=
name|pcur
operator|->
name|bc_private
operator|.
name|b
operator|.
name|firstblock
expr_stmt|;
name|ASSERT
argument_list|(
name|cur
operator|->
name|bc_private
operator|.
name|b
operator|.
name|flist
operator|==
name|pcur
operator|->
name|bc_private
operator|.
name|b
operator|.
name|flist
argument_list|)
expr_stmt|;
name|xfs_btree_del_cursor
argument_list|(
name|pcur
argument_list|,
name|XFS_BTREE_NOERROR
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ncur
condition|)
block|{
name|pcur
operator|=
name|ncur
expr_stmt|;
name|ncur
operator|=
operator|(
name|xfs_btree_cur_t
operator|*
operator|)
literal|0
expr_stmt|;
block|}
block|}
do|while
condition|(
name|nbno
operator|!=
name|NULLFSBLOCK
condition|)
do|;
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|EXIT
argument_list|)
expr_stmt|;
operator|*
name|stat
operator|=
name|i
expr_stmt|;
return|return
literal|0
return|;
name|error0
label|:
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_comment
comment|/*  * Log fields from the btree block header.  */
end_comment

begin_function
name|void
name|xfs_bmbt_log_block
parameter_list|(
name|xfs_btree_cur_t
modifier|*
name|cur
parameter_list|,
name|xfs_buf_t
modifier|*
name|bp
parameter_list|,
name|int
name|fields
parameter_list|)
block|{
name|int
name|first
decl_stmt|;
ifdef|#
directive|ifdef
name|XFS_BMBT_TRACE
specifier|static
name|char
name|fname
index|[]
init|=
literal|"xfs_bmbt_log_block"
decl_stmt|;
endif|#
directive|endif
name|int
name|last
decl_stmt|;
name|xfs_trans_t
modifier|*
name|tp
decl_stmt|;
specifier|static
specifier|const
name|short
name|offsets
index|[]
init|=
block|{
name|offsetof
argument_list|(
name|xfs_bmbt_block_t
argument_list|,
name|bb_magic
argument_list|)
block|,
name|offsetof
argument_list|(
name|xfs_bmbt_block_t
argument_list|,
name|bb_level
argument_list|)
block|,
name|offsetof
argument_list|(
name|xfs_bmbt_block_t
argument_list|,
name|bb_numrecs
argument_list|)
block|,
name|offsetof
argument_list|(
name|xfs_bmbt_block_t
argument_list|,
name|bb_leftsib
argument_list|)
block|,
name|offsetof
argument_list|(
name|xfs_bmbt_block_t
argument_list|,
name|bb_rightsib
argument_list|)
block|,
expr|sizeof
operator|(
name|xfs_bmbt_block_t
operator|)
block|}
decl_stmt|;
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ENTRY
argument_list|)
expr_stmt|;
name|XFS_BMBT_TRACE_ARGBI
argument_list|(
name|cur
argument_list|,
name|bp
argument_list|,
name|fields
argument_list|)
expr_stmt|;
name|tp
operator|=
name|cur
operator|->
name|bc_tp
expr_stmt|;
if|if
condition|(
name|bp
condition|)
block|{
name|xfs_btree_offsets
argument_list|(
name|fields
argument_list|,
name|offsets
argument_list|,
name|XFS_BB_NUM_BITS
argument_list|,
operator|&
name|first
argument_list|,
operator|&
name|last
argument_list|)
expr_stmt|;
name|xfs_trans_log_buf
argument_list|(
name|tp
argument_list|,
name|bp
argument_list|,
name|first
argument_list|,
name|last
argument_list|)
expr_stmt|;
block|}
else|else
name|xfs_trans_log_inode
argument_list|(
name|tp
argument_list|,
name|cur
operator|->
name|bc_private
operator|.
name|b
operator|.
name|ip
argument_list|,
name|XFS_ILOG_FBROOT
argument_list|(
name|cur
operator|->
name|bc_private
operator|.
name|b
operator|.
name|whichfork
argument_list|)
argument_list|)
expr_stmt|;
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|EXIT
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Log record values from the btree block.  */
end_comment

begin_function
name|void
name|xfs_bmbt_log_recs
parameter_list|(
name|xfs_btree_cur_t
modifier|*
name|cur
parameter_list|,
name|xfs_buf_t
modifier|*
name|bp
parameter_list|,
name|int
name|rfirst
parameter_list|,
name|int
name|rlast
parameter_list|)
block|{
name|xfs_bmbt_block_t
modifier|*
name|block
decl_stmt|;
name|int
name|first
decl_stmt|;
ifdef|#
directive|ifdef
name|XFS_BMBT_TRACE
specifier|static
name|char
name|fname
index|[]
init|=
literal|"xfs_bmbt_log_recs"
decl_stmt|;
endif|#
directive|endif
name|int
name|last
decl_stmt|;
name|xfs_bmbt_rec_t
modifier|*
name|rp
decl_stmt|;
name|xfs_trans_t
modifier|*
name|tp
decl_stmt|;
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ENTRY
argument_list|)
expr_stmt|;
name|XFS_BMBT_TRACE_ARGBII
argument_list|(
name|cur
argument_list|,
name|bp
argument_list|,
name|rfirst
argument_list|,
name|rlast
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|tp
operator|=
name|cur
operator|->
name|bc_tp
expr_stmt|;
name|block
operator|=
name|XFS_BUF_TO_BMBT_BLOCK
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|rp
operator|=
name|XFS_BMAP_REC_DADDR
argument_list|(
name|block
argument_list|,
literal|1
argument_list|,
name|cur
argument_list|)
expr_stmt|;
name|first
operator|=
call|(
name|int
call|)
argument_list|(
operator|(
name|xfs_caddr_t
operator|)
operator|&
name|rp
index|[
name|rfirst
operator|-
literal|1
index|]
operator|-
operator|(
name|xfs_caddr_t
operator|)
name|block
argument_list|)
expr_stmt|;
name|last
operator|=
call|(
name|int
call|)
argument_list|(
operator|(
operator|(
name|xfs_caddr_t
operator|)
operator|&
name|rp
index|[
name|rlast
index|]
operator|-
literal|1
operator|)
operator|-
operator|(
name|xfs_caddr_t
operator|)
name|block
argument_list|)
expr_stmt|;
name|xfs_trans_log_buf
argument_list|(
name|tp
argument_list|,
name|bp
argument_list|,
name|first
argument_list|,
name|last
argument_list|)
expr_stmt|;
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|EXIT
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
comment|/* error */
name|xfs_bmbt_lookup_eq
parameter_list|(
name|xfs_btree_cur_t
modifier|*
name|cur
parameter_list|,
name|xfs_fileoff_t
name|off
parameter_list|,
name|xfs_fsblock_t
name|bno
parameter_list|,
name|xfs_filblks_t
name|len
parameter_list|,
name|int
modifier|*
name|stat
parameter_list|)
comment|/* success/failure */
block|{
name|cur
operator|->
name|bc_rec
operator|.
name|b
operator|.
name|br_startoff
operator|=
name|off
expr_stmt|;
name|cur
operator|->
name|bc_rec
operator|.
name|b
operator|.
name|br_startblock
operator|=
name|bno
expr_stmt|;
name|cur
operator|->
name|bc_rec
operator|.
name|b
operator|.
name|br_blockcount
operator|=
name|len
expr_stmt|;
return|return
name|xfs_bmbt_lookup
argument_list|(
name|cur
argument_list|,
name|XFS_LOOKUP_EQ
argument_list|,
name|stat
argument_list|)
return|;
block|}
end_function

begin_function
name|int
comment|/* error */
name|xfs_bmbt_lookup_ge
parameter_list|(
name|xfs_btree_cur_t
modifier|*
name|cur
parameter_list|,
name|xfs_fileoff_t
name|off
parameter_list|,
name|xfs_fsblock_t
name|bno
parameter_list|,
name|xfs_filblks_t
name|len
parameter_list|,
name|int
modifier|*
name|stat
parameter_list|)
comment|/* success/failure */
block|{
name|cur
operator|->
name|bc_rec
operator|.
name|b
operator|.
name|br_startoff
operator|=
name|off
expr_stmt|;
name|cur
operator|->
name|bc_rec
operator|.
name|b
operator|.
name|br_startblock
operator|=
name|bno
expr_stmt|;
name|cur
operator|->
name|bc_rec
operator|.
name|b
operator|.
name|br_blockcount
operator|=
name|len
expr_stmt|;
return|return
name|xfs_bmbt_lookup
argument_list|(
name|cur
argument_list|,
name|XFS_LOOKUP_GE
argument_list|,
name|stat
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  * Give the bmap btree a new root block.  Copy the old broot contents  * down into a real block and make the broot point to it.  */
end_comment

begin_function
name|int
comment|/* error */
name|xfs_bmbt_newroot
parameter_list|(
name|xfs_btree_cur_t
modifier|*
name|cur
parameter_list|,
comment|/* btree cursor */
name|int
modifier|*
name|logflags
parameter_list|,
comment|/* logging flags for inode */
name|int
modifier|*
name|stat
parameter_list|)
comment|/* return status - 0 fail */
block|{
name|xfs_alloc_arg_t
name|args
decl_stmt|;
comment|/* allocation arguments */
name|xfs_bmbt_block_t
modifier|*
name|block
decl_stmt|;
comment|/* bmap btree block */
name|xfs_buf_t
modifier|*
name|bp
decl_stmt|;
comment|/* buffer for block */
name|xfs_bmbt_block_t
modifier|*
name|cblock
decl_stmt|;
comment|/* child btree block */
name|xfs_bmbt_key_t
modifier|*
name|ckp
decl_stmt|;
comment|/* child key pointer */
name|xfs_bmbt_ptr_t
modifier|*
name|cpp
decl_stmt|;
comment|/* child ptr pointer */
name|int
name|error
decl_stmt|;
comment|/* error return code */
ifdef|#
directive|ifdef
name|XFS_BMBT_TRACE
specifier|static
name|char
name|fname
index|[]
init|=
literal|"xfs_bmbt_newroot"
decl_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|DEBUG
name|int
name|i
decl_stmt|;
comment|/* loop counter */
endif|#
directive|endif
name|xfs_bmbt_key_t
modifier|*
name|kp
decl_stmt|;
comment|/* pointer to bmap btree key */
name|int
name|level
decl_stmt|;
comment|/* btree level */
name|xfs_bmbt_ptr_t
modifier|*
name|pp
decl_stmt|;
comment|/* pointer to bmap block addr */
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ENTRY
argument_list|)
expr_stmt|;
name|level
operator|=
name|cur
operator|->
name|bc_nlevels
operator|-
literal|1
expr_stmt|;
name|block
operator|=
name|xfs_bmbt_get_block
argument_list|(
name|cur
argument_list|,
name|level
argument_list|,
operator|&
name|bp
argument_list|)
expr_stmt|;
comment|/* 	 * Copy the root into a real block. 	 */
name|args
operator|.
name|mp
operator|=
name|cur
operator|->
name|bc_mp
expr_stmt|;
name|pp
operator|=
name|XFS_BMAP_PTR_IADDR
argument_list|(
name|block
argument_list|,
literal|1
argument_list|,
name|cur
argument_list|)
expr_stmt|;
name|args
operator|.
name|tp
operator|=
name|cur
operator|->
name|bc_tp
expr_stmt|;
name|args
operator|.
name|fsbno
operator|=
name|cur
operator|->
name|bc_private
operator|.
name|b
operator|.
name|firstblock
expr_stmt|;
name|args
operator|.
name|mod
operator|=
name|args
operator|.
name|minleft
operator|=
name|args
operator|.
name|alignment
operator|=
name|args
operator|.
name|total
operator|=
name|args
operator|.
name|isfl
operator|=
name|args
operator|.
name|userdata
operator|=
name|args
operator|.
name|minalignslop
operator|=
literal|0
expr_stmt|;
name|args
operator|.
name|minlen
operator|=
name|args
operator|.
name|maxlen
operator|=
name|args
operator|.
name|prod
operator|=
literal|1
expr_stmt|;
name|args
operator|.
name|wasdel
operator|=
name|cur
operator|->
name|bc_private
operator|.
name|b
operator|.
name|flags
operator|&
name|XFS_BTCUR_BPRV_WASDEL
expr_stmt|;
if|if
condition|(
name|args
operator|.
name|fsbno
operator|==
name|NULLFSBLOCK
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_btree_check_lptr
argument_list|(
name|cur
argument_list|,
name|INT_GET
argument_list|(
operator|*
name|pp
argument_list|,
name|ARCH_CONVERT
argument_list|)
argument_list|,
name|level
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
endif|#
directive|endif
name|args
operator|.
name|fsbno
operator|=
name|INT_GET
argument_list|(
operator|*
name|pp
argument_list|,
name|ARCH_CONVERT
argument_list|)
expr_stmt|;
name|args
operator|.
name|type
operator|=
name|XFS_ALLOCTYPE_START_BNO
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|args
operator|.
name|wasdel
condition|)
name|args
operator|.
name|type
operator|=
name|XFS_ALLOCTYPE_FIRST_AG
expr_stmt|;
else|else
name|args
operator|.
name|type
operator|=
name|XFS_ALLOCTYPE_NEAR_BNO
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_alloc_vextent
argument_list|(
operator|&
name|args
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
if|if
condition|(
name|args
operator|.
name|fsbno
operator|==
name|NULLFSBLOCK
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|EXIT
argument_list|)
expr_stmt|;
operator|*
name|stat
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
name|ASSERT
argument_list|(
name|args
operator|.
name|len
operator|==
literal|1
argument_list|)
expr_stmt|;
name|cur
operator|->
name|bc_private
operator|.
name|b
operator|.
name|firstblock
operator|=
name|args
operator|.
name|fsbno
expr_stmt|;
name|cur
operator|->
name|bc_private
operator|.
name|b
operator|.
name|allocated
operator|++
expr_stmt|;
name|cur
operator|->
name|bc_private
operator|.
name|b
operator|.
name|ip
operator|->
name|i_d
operator|.
name|di_nblocks
operator|++
expr_stmt|;
name|XFS_TRANS_MOD_DQUOT_BYINO
argument_list|(
name|args
operator|.
name|mp
argument_list|,
name|args
operator|.
name|tp
argument_list|,
name|cur
operator|->
name|bc_private
operator|.
name|b
operator|.
name|ip
argument_list|,
name|XFS_TRANS_DQ_BCOUNT
argument_list|,
literal|1L
argument_list|)
expr_stmt|;
name|bp
operator|=
name|xfs_btree_get_bufl
argument_list|(
name|args
operator|.
name|mp
argument_list|,
name|cur
operator|->
name|bc_tp
argument_list|,
name|args
operator|.
name|fsbno
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|cblock
operator|=
name|XFS_BUF_TO_BMBT_BLOCK
argument_list|(
name|bp
argument_list|)
expr_stmt|;
operator|*
name|cblock
operator|=
operator|*
name|block
expr_stmt|;
name|be16_add
argument_list|(
operator|&
name|block
operator|->
name|bb_level
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|block
operator|->
name|bb_numrecs
operator|=
name|cpu_to_be16
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|cur
operator|->
name|bc_nlevels
operator|++
expr_stmt|;
name|cur
operator|->
name|bc_ptrs
index|[
name|level
operator|+
literal|1
index|]
operator|=
literal|1
expr_stmt|;
name|kp
operator|=
name|XFS_BMAP_KEY_IADDR
argument_list|(
name|block
argument_list|,
literal|1
argument_list|,
name|cur
argument_list|)
expr_stmt|;
name|ckp
operator|=
name|XFS_BMAP_KEY_IADDR
argument_list|(
name|cblock
argument_list|,
literal|1
argument_list|,
name|cur
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|ckp
argument_list|,
name|kp
argument_list|,
name|be16_to_cpu
argument_list|(
name|cblock
operator|->
name|bb_numrecs
argument_list|)
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|kp
argument_list|)
argument_list|)
expr_stmt|;
name|cpp
operator|=
name|XFS_BMAP_PTR_IADDR
argument_list|(
name|cblock
argument_list|,
literal|1
argument_list|,
name|cur
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|be16_to_cpu
argument_list|(
name|cblock
operator|->
name|bb_numrecs
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_btree_check_lptr
argument_list|(
name|cur
argument_list|,
name|INT_GET
argument_list|(
name|pp
index|[
name|i
index|]
argument_list|,
name|ARCH_CONVERT
argument_list|)
argument_list|,
name|level
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
block|}
endif|#
directive|endif
name|memcpy
argument_list|(
name|cpp
argument_list|,
name|pp
argument_list|,
name|be16_to_cpu
argument_list|(
name|cblock
operator|->
name|bb_numrecs
argument_list|)
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|pp
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_btree_check_lptr
argument_list|(
name|cur
argument_list|,
operator|(
name|xfs_bmbt_ptr_t
operator|)
name|args
operator|.
name|fsbno
argument_list|,
name|level
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
endif|#
directive|endif
name|INT_SET
argument_list|(
operator|*
name|pp
argument_list|,
name|ARCH_CONVERT
argument_list|,
name|args
operator|.
name|fsbno
argument_list|)
expr_stmt|;
name|xfs_iroot_realloc
argument_list|(
name|cur
operator|->
name|bc_private
operator|.
name|b
operator|.
name|ip
argument_list|,
literal|1
operator|-
name|be16_to_cpu
argument_list|(
name|cblock
operator|->
name|bb_numrecs
argument_list|)
argument_list|,
name|cur
operator|->
name|bc_private
operator|.
name|b
operator|.
name|whichfork
argument_list|)
expr_stmt|;
name|xfs_btree_setbuf
argument_list|(
name|cur
argument_list|,
name|level
argument_list|,
name|bp
argument_list|)
expr_stmt|;
comment|/* 	 * Do all this logging at the end so that 	 * the root is at the right level. 	 */
name|xfs_bmbt_log_block
argument_list|(
name|cur
argument_list|,
name|bp
argument_list|,
name|XFS_BB_ALL_BITS
argument_list|)
expr_stmt|;
name|xfs_bmbt_log_keys
argument_list|(
name|cur
argument_list|,
name|bp
argument_list|,
literal|1
argument_list|,
name|be16_to_cpu
argument_list|(
name|cblock
operator|->
name|bb_numrecs
argument_list|)
argument_list|)
expr_stmt|;
name|xfs_bmbt_log_ptrs
argument_list|(
name|cur
argument_list|,
name|bp
argument_list|,
literal|1
argument_list|,
name|be16_to_cpu
argument_list|(
name|cblock
operator|->
name|bb_numrecs
argument_list|)
argument_list|)
expr_stmt|;
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|EXIT
argument_list|)
expr_stmt|;
operator|*
name|logflags
operator||=
name|XFS_ILOG_CORE
operator||
name|XFS_ILOG_FBROOT
argument_list|(
name|cur
operator|->
name|bc_private
operator|.
name|b
operator|.
name|whichfork
argument_list|)
expr_stmt|;
operator|*
name|stat
operator|=
literal|1
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Set all the fields in a bmap extent record from the uncompressed form.  */
end_comment

begin_function
name|void
name|xfs_bmbt_set_all
parameter_list|(
name|xfs_bmbt_rec_t
modifier|*
name|r
parameter_list|,
name|xfs_bmbt_irec_t
modifier|*
name|s
parameter_list|)
block|{
name|int
name|extent_flag
decl_stmt|;
name|ASSERT
argument_list|(
operator|(
name|s
operator|->
name|br_state
operator|==
name|XFS_EXT_NORM
operator|)
operator|||
operator|(
name|s
operator|->
name|br_state
operator|==
name|XFS_EXT_UNWRITTEN
operator|)
argument_list|)
expr_stmt|;
name|extent_flag
operator|=
operator|(
name|s
operator|->
name|br_state
operator|==
name|XFS_EXT_NORM
operator|)
condition|?
literal|0
else|:
literal|1
expr_stmt|;
name|ASSERT
argument_list|(
operator|(
name|s
operator|->
name|br_startoff
operator|&
name|XFS_MASK64HI
argument_list|(
literal|9
argument_list|)
operator|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
operator|(
name|s
operator|->
name|br_blockcount
operator|&
name|XFS_MASK64HI
argument_list|(
literal|43
argument_list|)
operator|)
operator|==
literal|0
argument_list|)
expr_stmt|;
if|#
directive|if
name|XFS_BIG_BLKNOS
name|ASSERT
argument_list|(
operator|(
name|s
operator|->
name|br_startblock
operator|&
name|XFS_MASK64HI
argument_list|(
literal|12
argument_list|)
operator|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|r
operator|->
name|l0
operator|=
operator|(
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|extent_flag
operator|<<
literal|63
operator|)
operator||
operator|(
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|s
operator|->
name|br_startoff
operator|<<
literal|9
operator|)
operator||
operator|(
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|s
operator|->
name|br_startblock
operator|>>
literal|43
operator|)
expr_stmt|;
name|r
operator|->
name|l1
operator|=
operator|(
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|s
operator|->
name|br_startblock
operator|<<
literal|21
operator|)
operator||
operator|(
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|s
operator|->
name|br_blockcount
operator|&
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|XFS_MASK64LO
argument_list|(
literal|21
argument_list|)
operator|)
expr_stmt|;
else|#
directive|else
comment|/* !XFS_BIG_BLKNOS */
if|if
condition|(
name|ISNULLSTARTBLOCK
argument_list|(
name|s
operator|->
name|br_startblock
argument_list|)
condition|)
block|{
name|r
operator|->
name|l0
operator|=
operator|(
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|extent_flag
operator|<<
literal|63
operator|)
operator||
operator|(
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|s
operator|->
name|br_startoff
operator|<<
literal|9
operator|)
operator||
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|XFS_MASK64LO
argument_list|(
literal|9
argument_list|)
expr_stmt|;
name|r
operator|->
name|l1
operator|=
name|XFS_MASK64HI
argument_list|(
literal|11
argument_list|)
operator||
operator|(
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|s
operator|->
name|br_startblock
operator|<<
literal|21
operator|)
operator||
operator|(
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|s
operator|->
name|br_blockcount
operator|&
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|XFS_MASK64LO
argument_list|(
literal|21
argument_list|)
operator|)
expr_stmt|;
block|}
else|else
block|{
name|r
operator|->
name|l0
operator|=
operator|(
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|extent_flag
operator|<<
literal|63
operator|)
operator||
operator|(
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|s
operator|->
name|br_startoff
operator|<<
literal|9
operator|)
expr_stmt|;
name|r
operator|->
name|l1
operator|=
operator|(
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|s
operator|->
name|br_startblock
operator|<<
literal|21
operator|)
operator||
operator|(
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|s
operator|->
name|br_blockcount
operator|&
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|XFS_MASK64LO
argument_list|(
literal|21
argument_list|)
operator|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* XFS_BIG_BLKNOS */
block|}
end_function

begin_comment
comment|/*  * Set all the fields in a bmap extent record from the arguments.  */
end_comment

begin_function
name|void
name|xfs_bmbt_set_allf
parameter_list|(
name|xfs_bmbt_rec_t
modifier|*
name|r
parameter_list|,
name|xfs_fileoff_t
name|o
parameter_list|,
name|xfs_fsblock_t
name|b
parameter_list|,
name|xfs_filblks_t
name|c
parameter_list|,
name|xfs_exntst_t
name|v
parameter_list|)
block|{
name|int
name|extent_flag
decl_stmt|;
name|ASSERT
argument_list|(
operator|(
name|v
operator|==
name|XFS_EXT_NORM
operator|)
operator|||
operator|(
name|v
operator|==
name|XFS_EXT_UNWRITTEN
operator|)
argument_list|)
expr_stmt|;
name|extent_flag
operator|=
operator|(
name|v
operator|==
name|XFS_EXT_NORM
operator|)
condition|?
literal|0
else|:
literal|1
expr_stmt|;
name|ASSERT
argument_list|(
operator|(
name|o
operator|&
name|XFS_MASK64HI
argument_list|(
literal|64
operator|-
name|BMBT_STARTOFF_BITLEN
argument_list|)
operator|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
operator|(
name|c
operator|&
name|XFS_MASK64HI
argument_list|(
literal|64
operator|-
name|BMBT_BLOCKCOUNT_BITLEN
argument_list|)
operator|)
operator|==
literal|0
argument_list|)
expr_stmt|;
if|#
directive|if
name|XFS_BIG_BLKNOS
name|ASSERT
argument_list|(
operator|(
name|b
operator|&
name|XFS_MASK64HI
argument_list|(
literal|64
operator|-
name|BMBT_STARTBLOCK_BITLEN
argument_list|)
operator|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|r
operator|->
name|l0
operator|=
operator|(
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|extent_flag
operator|<<
literal|63
operator|)
operator||
operator|(
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|o
operator|<<
literal|9
operator|)
operator||
operator|(
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|b
operator|>>
literal|43
operator|)
expr_stmt|;
name|r
operator|->
name|l1
operator|=
operator|(
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|b
operator|<<
literal|21
operator|)
operator||
operator|(
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|c
operator|&
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|XFS_MASK64LO
argument_list|(
literal|21
argument_list|)
operator|)
expr_stmt|;
else|#
directive|else
comment|/* !XFS_BIG_BLKNOS */
if|if
condition|(
name|ISNULLSTARTBLOCK
argument_list|(
name|b
argument_list|)
condition|)
block|{
name|r
operator|->
name|l0
operator|=
operator|(
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|extent_flag
operator|<<
literal|63
operator|)
operator||
operator|(
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|o
operator|<<
literal|9
operator|)
operator||
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|XFS_MASK64LO
argument_list|(
literal|9
argument_list|)
expr_stmt|;
name|r
operator|->
name|l1
operator|=
name|XFS_MASK64HI
argument_list|(
literal|11
argument_list|)
operator||
operator|(
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|b
operator|<<
literal|21
operator|)
operator||
operator|(
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|c
operator|&
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|XFS_MASK64LO
argument_list|(
literal|21
argument_list|)
operator|)
expr_stmt|;
block|}
else|else
block|{
name|r
operator|->
name|l0
operator|=
operator|(
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|extent_flag
operator|<<
literal|63
operator|)
operator||
operator|(
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|o
operator|<<
literal|9
operator|)
expr_stmt|;
name|r
operator|->
name|l1
operator|=
operator|(
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|b
operator|<<
literal|21
operator|)
operator||
operator|(
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|c
operator|&
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|XFS_MASK64LO
argument_list|(
literal|21
argument_list|)
operator|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* XFS_BIG_BLKNOS */
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|XFS_NATIVE_HOST
end_ifndef

begin_comment
comment|/*  * Set all the fields in a bmap extent record from the uncompressed form.  */
end_comment

begin_function
name|void
name|xfs_bmbt_disk_set_all
parameter_list|(
name|xfs_bmbt_rec_t
modifier|*
name|r
parameter_list|,
name|xfs_bmbt_irec_t
modifier|*
name|s
parameter_list|)
block|{
name|int
name|extent_flag
decl_stmt|;
name|ASSERT
argument_list|(
operator|(
name|s
operator|->
name|br_state
operator|==
name|XFS_EXT_NORM
operator|)
operator|||
operator|(
name|s
operator|->
name|br_state
operator|==
name|XFS_EXT_UNWRITTEN
operator|)
argument_list|)
expr_stmt|;
name|extent_flag
operator|=
operator|(
name|s
operator|->
name|br_state
operator|==
name|XFS_EXT_NORM
operator|)
condition|?
literal|0
else|:
literal|1
expr_stmt|;
name|ASSERT
argument_list|(
operator|(
name|s
operator|->
name|br_startoff
operator|&
name|XFS_MASK64HI
argument_list|(
literal|9
argument_list|)
operator|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
operator|(
name|s
operator|->
name|br_blockcount
operator|&
name|XFS_MASK64HI
argument_list|(
literal|43
argument_list|)
operator|)
operator|==
literal|0
argument_list|)
expr_stmt|;
if|#
directive|if
name|XFS_BIG_BLKNOS
name|ASSERT
argument_list|(
operator|(
name|s
operator|->
name|br_startblock
operator|&
name|XFS_MASK64HI
argument_list|(
literal|12
argument_list|)
operator|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|INT_SET
argument_list|(
name|r
operator|->
name|l0
argument_list|,
name|ARCH_CONVERT
argument_list|,
operator|(
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|extent_flag
operator|<<
literal|63
operator|)
operator||
operator|(
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|s
operator|->
name|br_startoff
operator|<<
literal|9
operator|)
operator||
operator|(
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|s
operator|->
name|br_startblock
operator|>>
literal|43
operator|)
argument_list|)
expr_stmt|;
name|INT_SET
argument_list|(
name|r
operator|->
name|l1
argument_list|,
name|ARCH_CONVERT
argument_list|,
operator|(
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|s
operator|->
name|br_startblock
operator|<<
literal|21
operator|)
operator||
operator|(
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|s
operator|->
name|br_blockcount
operator|&
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|XFS_MASK64LO
argument_list|(
literal|21
argument_list|)
operator|)
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* !XFS_BIG_BLKNOS */
if|if
condition|(
name|ISNULLSTARTBLOCK
argument_list|(
name|s
operator|->
name|br_startblock
argument_list|)
condition|)
block|{
name|INT_SET
argument_list|(
name|r
operator|->
name|l0
argument_list|,
name|ARCH_CONVERT
argument_list|,
operator|(
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|extent_flag
operator|<<
literal|63
operator|)
operator||
operator|(
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|s
operator|->
name|br_startoff
operator|<<
literal|9
operator|)
operator||
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|XFS_MASK64LO
argument_list|(
literal|9
argument_list|)
argument_list|)
expr_stmt|;
name|INT_SET
argument_list|(
name|r
operator|->
name|l1
argument_list|,
name|ARCH_CONVERT
argument_list|,
name|XFS_MASK64HI
argument_list|(
literal|11
argument_list|)
operator||
operator|(
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|s
operator|->
name|br_startblock
operator|<<
literal|21
operator|)
operator||
operator|(
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|s
operator|->
name|br_blockcount
operator|&
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|XFS_MASK64LO
argument_list|(
literal|21
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|INT_SET
argument_list|(
name|r
operator|->
name|l0
argument_list|,
name|ARCH_CONVERT
argument_list|,
operator|(
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|extent_flag
operator|<<
literal|63
operator|)
operator||
operator|(
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|s
operator|->
name|br_startoff
operator|<<
literal|9
operator|)
argument_list|)
expr_stmt|;
name|INT_SET
argument_list|(
name|r
operator|->
name|l1
argument_list|,
name|ARCH_CONVERT
argument_list|,
operator|(
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|s
operator|->
name|br_startblock
operator|<<
literal|21
operator|)
operator||
operator|(
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|s
operator|->
name|br_blockcount
operator|&
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|XFS_MASK64LO
argument_list|(
literal|21
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* XFS_BIG_BLKNOS */
block|}
end_function

begin_comment
comment|/*  * Set all the fields in a disk format bmap extent record from the arguments.  */
end_comment

begin_function
name|void
name|xfs_bmbt_disk_set_allf
parameter_list|(
name|xfs_bmbt_rec_t
modifier|*
name|r
parameter_list|,
name|xfs_fileoff_t
name|o
parameter_list|,
name|xfs_fsblock_t
name|b
parameter_list|,
name|xfs_filblks_t
name|c
parameter_list|,
name|xfs_exntst_t
name|v
parameter_list|)
block|{
name|int
name|extent_flag
decl_stmt|;
name|ASSERT
argument_list|(
operator|(
name|v
operator|==
name|XFS_EXT_NORM
operator|)
operator|||
operator|(
name|v
operator|==
name|XFS_EXT_UNWRITTEN
operator|)
argument_list|)
expr_stmt|;
name|extent_flag
operator|=
operator|(
name|v
operator|==
name|XFS_EXT_NORM
operator|)
condition|?
literal|0
else|:
literal|1
expr_stmt|;
name|ASSERT
argument_list|(
operator|(
name|o
operator|&
name|XFS_MASK64HI
argument_list|(
literal|64
operator|-
name|BMBT_STARTOFF_BITLEN
argument_list|)
operator|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
operator|(
name|c
operator|&
name|XFS_MASK64HI
argument_list|(
literal|64
operator|-
name|BMBT_BLOCKCOUNT_BITLEN
argument_list|)
operator|)
operator|==
literal|0
argument_list|)
expr_stmt|;
if|#
directive|if
name|XFS_BIG_BLKNOS
name|ASSERT
argument_list|(
operator|(
name|b
operator|&
name|XFS_MASK64HI
argument_list|(
literal|64
operator|-
name|BMBT_STARTBLOCK_BITLEN
argument_list|)
operator|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|INT_SET
argument_list|(
name|r
operator|->
name|l0
argument_list|,
name|ARCH_CONVERT
argument_list|,
operator|(
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|extent_flag
operator|<<
literal|63
operator|)
operator||
operator|(
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|o
operator|<<
literal|9
operator|)
operator||
operator|(
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|b
operator|>>
literal|43
operator|)
argument_list|)
expr_stmt|;
name|INT_SET
argument_list|(
name|r
operator|->
name|l1
argument_list|,
name|ARCH_CONVERT
argument_list|,
operator|(
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|b
operator|<<
literal|21
operator|)
operator||
operator|(
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|c
operator|&
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|XFS_MASK64LO
argument_list|(
literal|21
argument_list|)
operator|)
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* !XFS_BIG_BLKNOS */
if|if
condition|(
name|ISNULLSTARTBLOCK
argument_list|(
name|b
argument_list|)
condition|)
block|{
name|INT_SET
argument_list|(
name|r
operator|->
name|l0
argument_list|,
name|ARCH_CONVERT
argument_list|,
operator|(
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|extent_flag
operator|<<
literal|63
operator|)
operator||
operator|(
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|o
operator|<<
literal|9
operator|)
operator||
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|XFS_MASK64LO
argument_list|(
literal|9
argument_list|)
argument_list|)
expr_stmt|;
name|INT_SET
argument_list|(
name|r
operator|->
name|l1
argument_list|,
name|ARCH_CONVERT
argument_list|,
name|XFS_MASK64HI
argument_list|(
literal|11
argument_list|)
operator||
operator|(
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|b
operator|<<
literal|21
operator|)
operator||
operator|(
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|c
operator|&
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|XFS_MASK64LO
argument_list|(
literal|21
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|INT_SET
argument_list|(
name|r
operator|->
name|l0
argument_list|,
name|ARCH_CONVERT
argument_list|,
operator|(
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|extent_flag
operator|<<
literal|63
operator|)
operator||
operator|(
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|o
operator|<<
literal|9
operator|)
argument_list|)
expr_stmt|;
name|INT_SET
argument_list|(
name|r
operator|->
name|l1
argument_list|,
name|ARCH_CONVERT
argument_list|,
operator|(
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|b
operator|<<
literal|21
operator|)
operator||
operator|(
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|c
operator|&
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|XFS_MASK64LO
argument_list|(
literal|21
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* XFS_BIG_BLKNOS */
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* XFS_NATIVE_HOST */
end_comment

begin_comment
comment|/*  * Set the blockcount field in a bmap extent record.  */
end_comment

begin_function
name|void
name|xfs_bmbt_set_blockcount
parameter_list|(
name|xfs_bmbt_rec_t
modifier|*
name|r
parameter_list|,
name|xfs_filblks_t
name|v
parameter_list|)
block|{
name|ASSERT
argument_list|(
operator|(
name|v
operator|&
name|XFS_MASK64HI
argument_list|(
literal|43
argument_list|)
operator|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|r
operator|->
name|l1
operator|=
operator|(
name|r
operator|->
name|l1
operator|&
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|XFS_MASK64HI
argument_list|(
literal|43
argument_list|)
operator|)
operator||
call|(
name|xfs_bmbt_rec_base_t
call|)
argument_list|(
name|v
operator|&
name|XFS_MASK64LO
argument_list|(
literal|21
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Set the startblock field in a bmap extent record.  */
end_comment

begin_function
name|void
name|xfs_bmbt_set_startblock
parameter_list|(
name|xfs_bmbt_rec_t
modifier|*
name|r
parameter_list|,
name|xfs_fsblock_t
name|v
parameter_list|)
block|{
if|#
directive|if
name|XFS_BIG_BLKNOS
name|ASSERT
argument_list|(
operator|(
name|v
operator|&
name|XFS_MASK64HI
argument_list|(
literal|12
argument_list|)
operator|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|r
operator|->
name|l0
operator|=
operator|(
name|r
operator|->
name|l0
operator|&
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|XFS_MASK64HI
argument_list|(
literal|55
argument_list|)
operator|)
operator||
call|(
name|xfs_bmbt_rec_base_t
call|)
argument_list|(
name|v
operator|>>
literal|43
argument_list|)
expr_stmt|;
name|r
operator|->
name|l1
operator|=
operator|(
name|r
operator|->
name|l1
operator|&
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|XFS_MASK64LO
argument_list|(
literal|21
argument_list|)
operator|)
operator||
call|(
name|xfs_bmbt_rec_base_t
call|)
argument_list|(
name|v
operator|<<
literal|21
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* !XFS_BIG_BLKNOS */
if|if
condition|(
name|ISNULLSTARTBLOCK
argument_list|(
name|v
argument_list|)
condition|)
block|{
name|r
operator|->
name|l0
operator||=
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|XFS_MASK64LO
argument_list|(
literal|9
argument_list|)
expr_stmt|;
name|r
operator|->
name|l1
operator|=
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|XFS_MASK64HI
argument_list|(
literal|11
argument_list|)
operator||
operator|(
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|v
operator|<<
literal|21
operator|)
operator||
operator|(
name|r
operator|->
name|l1
operator|&
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|XFS_MASK64LO
argument_list|(
literal|21
argument_list|)
operator|)
expr_stmt|;
block|}
else|else
block|{
name|r
operator|->
name|l0
operator|&=
operator|~
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|XFS_MASK64LO
argument_list|(
literal|9
argument_list|)
expr_stmt|;
name|r
operator|->
name|l1
operator|=
operator|(
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|v
operator|<<
literal|21
operator|)
operator||
operator|(
name|r
operator|->
name|l1
operator|&
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|XFS_MASK64LO
argument_list|(
literal|21
argument_list|)
operator|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* XFS_BIG_BLKNOS */
block|}
end_function

begin_comment
comment|/*  * Set the startoff field in a bmap extent record.  */
end_comment

begin_function
name|void
name|xfs_bmbt_set_startoff
parameter_list|(
name|xfs_bmbt_rec_t
modifier|*
name|r
parameter_list|,
name|xfs_fileoff_t
name|v
parameter_list|)
block|{
name|ASSERT
argument_list|(
operator|(
name|v
operator|&
name|XFS_MASK64HI
argument_list|(
literal|9
argument_list|)
operator|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|r
operator|->
name|l0
operator|=
operator|(
name|r
operator|->
name|l0
operator|&
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|XFS_MASK64HI
argument_list|(
literal|1
argument_list|)
operator|)
operator||
operator|(
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|v
operator|<<
literal|9
operator|)
operator||
operator|(
name|r
operator|->
name|l0
operator|&
operator|(
name|xfs_bmbt_rec_base_t
operator|)
name|XFS_MASK64LO
argument_list|(
literal|9
argument_list|)
operator|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Set the extent state field in a bmap extent record.  */
end_comment

begin_function
name|void
name|xfs_bmbt_set_state
parameter_list|(
name|xfs_bmbt_rec_t
modifier|*
name|r
parameter_list|,
name|xfs_exntst_t
name|v
parameter_list|)
block|{
name|ASSERT
argument_list|(
name|v
operator|==
name|XFS_EXT_NORM
operator|||
name|v
operator|==
name|XFS_EXT_UNWRITTEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|==
name|XFS_EXT_NORM
condition|)
name|r
operator|->
name|l0
operator|&=
name|XFS_MASK64LO
argument_list|(
literal|64
operator|-
name|BMBT_EXNTFLAG_BITLEN
argument_list|)
expr_stmt|;
else|else
name|r
operator|->
name|l0
operator||=
name|XFS_MASK64HI
argument_list|(
name|BMBT_EXNTFLAG_BITLEN
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Convert in-memory form of btree root to on-disk form.  */
end_comment

begin_function
name|void
name|xfs_bmbt_to_bmdr
parameter_list|(
name|xfs_bmbt_block_t
modifier|*
name|rblock
parameter_list|,
name|int
name|rblocklen
parameter_list|,
name|xfs_bmdr_block_t
modifier|*
name|dblock
parameter_list|,
name|int
name|dblocklen
parameter_list|)
block|{
name|int
name|dmxr
decl_stmt|;
name|xfs_bmbt_key_t
modifier|*
name|fkp
decl_stmt|;
name|xfs_bmbt_ptr_t
modifier|*
name|fpp
decl_stmt|;
name|xfs_bmbt_key_t
modifier|*
name|tkp
decl_stmt|;
name|xfs_bmbt_ptr_t
modifier|*
name|tpp
decl_stmt|;
name|ASSERT
argument_list|(
name|be32_to_cpu
argument_list|(
name|rblock
operator|->
name|bb_magic
argument_list|)
operator|==
name|XFS_BMAP_MAGIC
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|be64_to_cpu
argument_list|(
name|rblock
operator|->
name|bb_leftsib
argument_list|)
operator|==
name|NULLDFSBNO
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|be64_to_cpu
argument_list|(
name|rblock
operator|->
name|bb_rightsib
argument_list|)
operator|==
name|NULLDFSBNO
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|be16_to_cpu
argument_list|(
name|rblock
operator|->
name|bb_level
argument_list|)
operator|>
literal|0
argument_list|)
expr_stmt|;
name|dblock
operator|->
name|bb_level
operator|=
name|rblock
operator|->
name|bb_level
expr_stmt|;
name|dblock
operator|->
name|bb_numrecs
operator|=
name|rblock
operator|->
name|bb_numrecs
expr_stmt|;
name|dmxr
operator|=
operator|(
name|int
operator|)
name|XFS_BTREE_BLOCK_MAXRECS
argument_list|(
name|dblocklen
argument_list|,
name|xfs_bmdr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fkp
operator|=
name|XFS_BMAP_BROOT_KEY_ADDR
argument_list|(
name|rblock
argument_list|,
literal|1
argument_list|,
name|rblocklen
argument_list|)
expr_stmt|;
name|tkp
operator|=
name|XFS_BTREE_KEY_ADDR
argument_list|(
name|dblocklen
argument_list|,
name|xfs_bmdr
argument_list|,
name|dblock
argument_list|,
literal|1
argument_list|,
name|dmxr
argument_list|)
expr_stmt|;
name|fpp
operator|=
name|XFS_BMAP_BROOT_PTR_ADDR
argument_list|(
name|rblock
argument_list|,
literal|1
argument_list|,
name|rblocklen
argument_list|)
expr_stmt|;
name|tpp
operator|=
name|XFS_BTREE_PTR_ADDR
argument_list|(
name|dblocklen
argument_list|,
name|xfs_bmdr
argument_list|,
name|dblock
argument_list|,
literal|1
argument_list|,
name|dmxr
argument_list|)
expr_stmt|;
name|dmxr
operator|=
name|be16_to_cpu
argument_list|(
name|dblock
operator|->
name|bb_numrecs
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|tkp
argument_list|,
name|fkp
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|fkp
argument_list|)
operator|*
name|dmxr
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|tpp
argument_list|,
name|fpp
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|fpp
argument_list|)
operator|*
name|dmxr
argument_list|)
expr_stmt|;
comment|/* INT_: direct copy */
block|}
end_function

begin_comment
comment|/*  * Update the record to the passed values.  */
end_comment

begin_function
name|int
name|xfs_bmbt_update
parameter_list|(
name|xfs_btree_cur_t
modifier|*
name|cur
parameter_list|,
name|xfs_fileoff_t
name|off
parameter_list|,
name|xfs_fsblock_t
name|bno
parameter_list|,
name|xfs_filblks_t
name|len
parameter_list|,
name|xfs_exntst_t
name|state
parameter_list|)
block|{
name|xfs_bmbt_block_t
modifier|*
name|block
decl_stmt|;
name|xfs_buf_t
modifier|*
name|bp
decl_stmt|;
name|int
name|error
decl_stmt|;
ifdef|#
directive|ifdef
name|XFS_BMBT_TRACE
specifier|static
name|char
name|fname
index|[]
init|=
literal|"xfs_bmbt_update"
decl_stmt|;
endif|#
directive|endif
name|xfs_bmbt_key_t
name|key
decl_stmt|;
name|int
name|ptr
decl_stmt|;
name|xfs_bmbt_rec_t
modifier|*
name|rp
decl_stmt|;
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ENTRY
argument_list|)
expr_stmt|;
name|XFS_BMBT_TRACE_ARGFFFI
argument_list|(
name|cur
argument_list|,
operator|(
name|xfs_dfiloff_t
operator|)
name|off
argument_list|,
operator|(
name|xfs_dfsbno_t
operator|)
name|bno
argument_list|,
operator|(
name|xfs_dfilblks_t
operator|)
name|len
argument_list|,
operator|(
name|int
operator|)
name|state
argument_list|)
expr_stmt|;
name|block
operator|=
name|xfs_bmbt_get_block
argument_list|(
name|cur
argument_list|,
literal|0
argument_list|,
operator|&
name|bp
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_btree_check_lblock
argument_list|(
name|cur
argument_list|,
name|block
argument_list|,
literal|0
argument_list|,
name|bp
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
endif|#
directive|endif
name|ptr
operator|=
name|cur
operator|->
name|bc_ptrs
index|[
literal|0
index|]
expr_stmt|;
name|rp
operator|=
name|XFS_BMAP_REC_IADDR
argument_list|(
name|block
argument_list|,
name|ptr
argument_list|,
name|cur
argument_list|)
expr_stmt|;
name|xfs_bmbt_disk_set_allf
argument_list|(
name|rp
argument_list|,
name|off
argument_list|,
name|bno
argument_list|,
name|len
argument_list|,
name|state
argument_list|)
expr_stmt|;
name|xfs_bmbt_log_recs
argument_list|(
name|cur
argument_list|,
name|bp
argument_list|,
name|ptr
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ptr
operator|>
literal|1
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|EXIT
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|INT_SET
argument_list|(
name|key
operator|.
name|br_startoff
argument_list|,
name|ARCH_CONVERT
argument_list|,
name|off
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_bmbt_updkey
argument_list|(
name|cur
argument_list|,
operator|&
name|key
argument_list|,
literal|1
argument_list|)
operator|)
condition|)
block|{
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
name|XFS_BMBT_TRACE_CURSOR
argument_list|(
name|cur
argument_list|,
name|EXIT
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Check extent records, which have just been read, for  * any bit in the extent flag field. ASSERT on debug  * kernels, as this condition should not occur.  * Return an error condition (1) if any flags found,  * otherwise return 0.  */
end_comment

begin_function
name|int
name|xfs_check_nostate_extents
parameter_list|(
name|xfs_ifork_t
modifier|*
name|ifp
parameter_list|,
name|xfs_extnum_t
name|idx
parameter_list|,
name|xfs_extnum_t
name|num
parameter_list|)
block|{
name|xfs_bmbt_rec_t
modifier|*
name|ep
decl_stmt|;
for|for
control|(
init|;
name|num
operator|>
literal|0
condition|;
name|num
operator|--
operator|,
name|idx
operator|++
control|)
block|{
name|ep
operator|=
name|xfs_iext_get_ext
argument_list|(
name|ifp
argument_list|,
name|idx
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ep
operator|->
name|l0
operator|>>
operator|(
literal|64
operator|-
name|BMBT_EXNTFLAG_BITLEN
operator|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|ASSERT
argument_list|(
literal|0
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

end_unit


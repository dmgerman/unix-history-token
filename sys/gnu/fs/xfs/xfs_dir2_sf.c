begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2000-2003,2005 Silicon Graphics, Inc.  * All Rights Reserved.  *  * This program is free software; you can redistribute it and/or  * modify it under the terms of the GNU General Public License as  * published by the Free Software Foundation.  *  * This program is distributed in the hope that it would be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  * GNU General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program; if not, write the Free Software Foundation,  * Inc.,  51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA  */
end_comment

begin_include
include|#
directive|include
file|"xfs.h"
end_include

begin_include
include|#
directive|include
file|"xfs_fs.h"
end_include

begin_include
include|#
directive|include
file|"xfs_types.h"
end_include

begin_include
include|#
directive|include
file|"xfs_log.h"
end_include

begin_include
include|#
directive|include
file|"xfs_inum.h"
end_include

begin_include
include|#
directive|include
file|"xfs_trans.h"
end_include

begin_include
include|#
directive|include
file|"xfs_sb.h"
end_include

begin_include
include|#
directive|include
file|"xfs_dir.h"
end_include

begin_include
include|#
directive|include
file|"xfs_dir2.h"
end_include

begin_include
include|#
directive|include
file|"xfs_dmapi.h"
end_include

begin_include
include|#
directive|include
file|"xfs_mount.h"
end_include

begin_include
include|#
directive|include
file|"xfs_da_btree.h"
end_include

begin_include
include|#
directive|include
file|"xfs_bmap_btree.h"
end_include

begin_include
include|#
directive|include
file|"xfs_dir_sf.h"
end_include

begin_include
include|#
directive|include
file|"xfs_dir2_sf.h"
end_include

begin_include
include|#
directive|include
file|"xfs_attr_sf.h"
end_include

begin_include
include|#
directive|include
file|"xfs_dinode.h"
end_include

begin_include
include|#
directive|include
file|"xfs_inode.h"
end_include

begin_include
include|#
directive|include
file|"xfs_inode_item.h"
end_include

begin_include
include|#
directive|include
file|"xfs_dir_leaf.h"
end_include

begin_include
include|#
directive|include
file|"xfs_error.h"
end_include

begin_include
include|#
directive|include
file|"xfs_dir2_data.h"
end_include

begin_include
include|#
directive|include
file|"xfs_dir2_leaf.h"
end_include

begin_include
include|#
directive|include
file|"xfs_dir2_block.h"
end_include

begin_include
include|#
directive|include
file|"xfs_dir2_trace.h"
end_include

begin_comment
comment|/*  * Prototypes for internal functions.  */
end_comment

begin_function_decl
specifier|static
name|void
name|xfs_dir2_sf_addname_easy
parameter_list|(
name|xfs_da_args_t
modifier|*
name|args
parameter_list|,
name|xfs_dir2_sf_entry_t
modifier|*
name|sfep
parameter_list|,
name|xfs_dir2_data_aoff_t
name|offset
parameter_list|,
name|int
name|new_isize
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|xfs_dir2_sf_addname_hard
parameter_list|(
name|xfs_da_args_t
modifier|*
name|args
parameter_list|,
name|int
name|objchange
parameter_list|,
name|int
name|new_isize
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|xfs_dir2_sf_addname_pick
parameter_list|(
name|xfs_da_args_t
modifier|*
name|args
parameter_list|,
name|int
name|objchange
parameter_list|,
name|xfs_dir2_sf_entry_t
modifier|*
modifier|*
name|sfepp
parameter_list|,
name|xfs_dir2_data_aoff_t
modifier|*
name|offsetp
parameter_list|)
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|DEBUG
end_ifdef

begin_function_decl
specifier|static
name|void
name|xfs_dir2_sf_check
parameter_list|(
name|xfs_da_args_t
modifier|*
name|args
parameter_list|)
function_decl|;
end_function_decl

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|xfs_dir2_sf_check
parameter_list|(
name|args
parameter_list|)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* DEBUG */
end_comment

begin_if
if|#
directive|if
name|XFS_BIG_INUMS
end_if

begin_function_decl
specifier|static
name|void
name|xfs_dir2_sf_toino4
parameter_list|(
name|xfs_da_args_t
modifier|*
name|args
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|xfs_dir2_sf_toino8
parameter_list|(
name|xfs_da_args_t
modifier|*
name|args
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* XFS_BIG_INUMS */
end_comment

begin_comment
comment|/*  * Given a block directory (dp/block), calculate its size as a shortform (sf)  * directory and a header for the sf directory, if it will fit it the  * space currently present in the inode.  If it won't fit, the output  * size is too big (but not accurate).  */
end_comment

begin_function
name|int
comment|/* size for sf form */
name|xfs_dir2_block_sfsize
parameter_list|(
name|xfs_inode_t
modifier|*
name|dp
parameter_list|,
comment|/* incore inode pointer */
name|xfs_dir2_block_t
modifier|*
name|block
parameter_list|,
comment|/* block directory data */
name|xfs_dir2_sf_hdr_t
modifier|*
name|sfhp
parameter_list|)
comment|/* output: header for sf form */
block|{
name|xfs_dir2_dataptr_t
name|addr
decl_stmt|;
comment|/* data entry address */
name|xfs_dir2_leaf_entry_t
modifier|*
name|blp
decl_stmt|;
comment|/* leaf area of the block */
name|xfs_dir2_block_tail_t
modifier|*
name|btp
decl_stmt|;
comment|/* tail area of the block */
name|int
name|count
decl_stmt|;
comment|/* shortform entry count */
name|xfs_dir2_data_entry_t
modifier|*
name|dep
decl_stmt|;
comment|/* data entry in the block */
name|int
name|i
decl_stmt|;
comment|/* block entry index */
name|int
name|i8count
decl_stmt|;
comment|/* count of big-inode entries */
name|int
name|isdot
decl_stmt|;
comment|/* entry is "." */
name|int
name|isdotdot
decl_stmt|;
comment|/* entry is ".." */
name|xfs_mount_t
modifier|*
name|mp
decl_stmt|;
comment|/* mount structure pointer */
name|int
name|namelen
decl_stmt|;
comment|/* total name bytes */
name|xfs_ino_t
name|parent
init|=
literal|0
decl_stmt|;
comment|/* parent inode number */
name|int
name|size
init|=
literal|0
decl_stmt|;
comment|/* total computed size */
name|mp
operator|=
name|dp
operator|->
name|i_mount
expr_stmt|;
name|count
operator|=
name|i8count
operator|=
name|namelen
operator|=
literal|0
expr_stmt|;
name|btp
operator|=
name|XFS_DIR2_BLOCK_TAIL_P
argument_list|(
name|mp
argument_list|,
name|block
argument_list|)
expr_stmt|;
name|blp
operator|=
name|XFS_DIR2_BLOCK_LEAF_P
argument_list|(
name|btp
argument_list|)
expr_stmt|;
comment|/* 	 * Iterate over the block's data entries by using the leaf pointers. 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|be32_to_cpu
argument_list|(
name|btp
operator|->
name|count
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|addr
operator|=
name|be32_to_cpu
argument_list|(
name|blp
index|[
name|i
index|]
operator|.
name|address
argument_list|)
operator|)
operator|==
name|XFS_DIR2_NULL_DATAPTR
condition|)
continue|continue;
comment|/* 		 * Calculate the pointer to the entry at hand. 		 */
name|dep
operator|=
operator|(
name|xfs_dir2_data_entry_t
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|block
operator|+
name|XFS_DIR2_DATAPTR_TO_OFF
argument_list|(
name|mp
argument_list|,
name|addr
argument_list|)
operator|)
expr_stmt|;
comment|/* 		 * Detect . and .., so we can special-case them. 		 * . is not included in sf directories. 		 * .. is included by just the parent inode number. 		 */
name|isdot
operator|=
name|dep
operator|->
name|namelen
operator|==
literal|1
operator|&&
name|dep
operator|->
name|name
index|[
literal|0
index|]
operator|==
literal|'.'
expr_stmt|;
name|isdotdot
operator|=
name|dep
operator|->
name|namelen
operator|==
literal|2
operator|&&
name|dep
operator|->
name|name
index|[
literal|0
index|]
operator|==
literal|'.'
operator|&&
name|dep
operator|->
name|name
index|[
literal|1
index|]
operator|==
literal|'.'
expr_stmt|;
if|#
directive|if
name|XFS_BIG_INUMS
if|if
condition|(
operator|!
name|isdot
condition|)
name|i8count
operator|+=
name|INT_GET
argument_list|(
name|dep
operator|->
name|inumber
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|>
name|XFS_DIR2_MAX_SHORT_INUM
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|isdot
operator|&&
operator|!
name|isdotdot
condition|)
block|{
name|count
operator|++
expr_stmt|;
name|namelen
operator|+=
name|dep
operator|->
name|namelen
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|isdotdot
condition|)
name|parent
operator|=
name|INT_GET
argument_list|(
name|dep
operator|->
name|inumber
argument_list|,
name|ARCH_CONVERT
argument_list|)
expr_stmt|;
comment|/* 		 * Calculate the new size, see if we should give up yet. 		 */
name|size
operator|=
name|XFS_DIR2_SF_HDR_SIZE
argument_list|(
name|i8count
argument_list|)
operator|+
comment|/* header */
name|count
operator|+
comment|/* namelen */
name|count
operator|*
operator|(
name|uint
operator|)
sizeof|sizeof
argument_list|(
name|xfs_dir2_sf_off_t
argument_list|)
operator|+
comment|/* offset */
name|namelen
operator|+
comment|/* name */
operator|(
name|i8count
condition|?
comment|/* inumber */
operator|(
name|uint
operator|)
sizeof|sizeof
argument_list|(
name|xfs_dir2_ino8_t
argument_list|)
operator|*
name|count
else|:
operator|(
name|uint
operator|)
sizeof|sizeof
argument_list|(
name|xfs_dir2_ino4_t
argument_list|)
operator|*
name|count
operator|)
expr_stmt|;
if|if
condition|(
name|size
operator|>
name|XFS_IFORK_DSIZE
argument_list|(
name|dp
argument_list|)
condition|)
return|return
name|size
return|;
comment|/* size value is a failure */
block|}
comment|/* 	 * Create the output header, if it worked. 	 */
name|sfhp
operator|->
name|count
operator|=
name|count
expr_stmt|;
name|sfhp
operator|->
name|i8count
operator|=
name|i8count
expr_stmt|;
name|XFS_DIR2_SF_PUT_INUMBER
argument_list|(
operator|(
name|xfs_dir2_sf_t
operator|*
operator|)
name|sfhp
argument_list|,
operator|&
name|parent
argument_list|,
operator|&
name|sfhp
operator|->
name|parent
argument_list|)
expr_stmt|;
return|return
name|size
return|;
block|}
end_function

begin_comment
comment|/*  * Convert a block format directory to shortform.  * Caller has already checked that it will fit, and built us a header.  */
end_comment

begin_function
name|int
comment|/* error */
name|xfs_dir2_block_to_sf
parameter_list|(
name|xfs_da_args_t
modifier|*
name|args
parameter_list|,
comment|/* operation arguments */
name|xfs_dabuf_t
modifier|*
name|bp
parameter_list|,
comment|/* block buffer */
name|int
name|size
parameter_list|,
comment|/* shortform directory size */
name|xfs_dir2_sf_hdr_t
modifier|*
name|sfhp
parameter_list|)
comment|/* shortform directory hdr */
block|{
name|xfs_dir2_block_t
modifier|*
name|block
decl_stmt|;
comment|/* block structure */
name|xfs_dir2_block_tail_t
modifier|*
name|btp
decl_stmt|;
comment|/* block tail pointer */
name|xfs_dir2_data_entry_t
modifier|*
name|dep
decl_stmt|;
comment|/* data entry pointer */
name|xfs_inode_t
modifier|*
name|dp
decl_stmt|;
comment|/* incore directory inode */
name|xfs_dir2_data_unused_t
modifier|*
name|dup
decl_stmt|;
comment|/* unused data pointer */
name|char
modifier|*
name|endptr
decl_stmt|;
comment|/* end of data entries */
name|int
name|error
decl_stmt|;
comment|/* error return value */
name|int
name|logflags
decl_stmt|;
comment|/* inode logging flags */
name|xfs_mount_t
modifier|*
name|mp
decl_stmt|;
comment|/* filesystem mount point */
name|char
modifier|*
name|ptr
decl_stmt|;
comment|/* current data pointer */
name|xfs_dir2_sf_entry_t
modifier|*
name|sfep
decl_stmt|;
comment|/* shortform entry */
name|xfs_dir2_sf_t
modifier|*
name|sfp
decl_stmt|;
comment|/* shortform structure */
name|xfs_ino_t
name|temp
decl_stmt|;
name|xfs_dir2_trace_args_sb
argument_list|(
literal|"block_to_sf"
argument_list|,
name|args
argument_list|,
name|size
argument_list|,
name|bp
argument_list|)
expr_stmt|;
name|dp
operator|=
name|args
operator|->
name|dp
expr_stmt|;
name|mp
operator|=
name|dp
operator|->
name|i_mount
expr_stmt|;
comment|/* 	 * Make a copy of the block data, so we can shrink the inode 	 * and add local data. 	 */
name|block
operator|=
name|kmem_alloc
argument_list|(
name|mp
operator|->
name|m_dirblksize
argument_list|,
name|KM_SLEEP
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|block
argument_list|,
name|bp
operator|->
name|data
argument_list|,
name|mp
operator|->
name|m_dirblksize
argument_list|)
expr_stmt|;
name|logflags
operator|=
name|XFS_ILOG_CORE
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_dir2_shrink_inode
argument_list|(
name|args
argument_list|,
name|mp
operator|->
name|m_dirdatablk
argument_list|,
name|bp
argument_list|)
operator|)
condition|)
block|{
name|ASSERT
argument_list|(
name|error
operator|!=
name|ENOSPC
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* 	 * The buffer is now unconditionally gone, whether 	 * xfs_dir2_shrink_inode worked or not. 	 * 	 * Convert the inode to local format. 	 */
name|dp
operator|->
name|i_df
operator|.
name|if_flags
operator|&=
operator|~
name|XFS_IFEXTENTS
expr_stmt|;
name|dp
operator|->
name|i_df
operator|.
name|if_flags
operator||=
name|XFS_IFINLINE
expr_stmt|;
name|dp
operator|->
name|i_d
operator|.
name|di_format
operator|=
name|XFS_DINODE_FMT_LOCAL
expr_stmt|;
name|ASSERT
argument_list|(
name|dp
operator|->
name|i_df
operator|.
name|if_bytes
operator|==
literal|0
argument_list|)
expr_stmt|;
name|xfs_idata_realloc
argument_list|(
name|dp
argument_list|,
name|size
argument_list|,
name|XFS_DATA_FORK
argument_list|)
expr_stmt|;
name|logflags
operator||=
name|XFS_ILOG_DDATA
expr_stmt|;
comment|/* 	 * Copy the header into the newly allocate local space. 	 */
name|sfp
operator|=
operator|(
name|xfs_dir2_sf_t
operator|*
operator|)
name|dp
operator|->
name|i_df
operator|.
name|if_u1
operator|.
name|if_data
expr_stmt|;
name|memcpy
argument_list|(
name|sfp
argument_list|,
name|sfhp
argument_list|,
name|XFS_DIR2_SF_HDR_SIZE
argument_list|(
name|sfhp
operator|->
name|i8count
argument_list|)
argument_list|)
expr_stmt|;
name|dp
operator|->
name|i_d
operator|.
name|di_size
operator|=
name|size
expr_stmt|;
comment|/* 	 * Set up to loop over the block's entries. 	 */
name|btp
operator|=
name|XFS_DIR2_BLOCK_TAIL_P
argument_list|(
name|mp
argument_list|,
name|block
argument_list|)
expr_stmt|;
name|ptr
operator|=
operator|(
name|char
operator|*
operator|)
name|block
operator|->
name|u
expr_stmt|;
name|endptr
operator|=
operator|(
name|char
operator|*
operator|)
name|XFS_DIR2_BLOCK_LEAF_P
argument_list|(
name|btp
argument_list|)
expr_stmt|;
name|sfep
operator|=
name|XFS_DIR2_SF_FIRSTENTRY
argument_list|(
name|sfp
argument_list|)
expr_stmt|;
comment|/* 	 * Loop over the active and unused entries. 	 * Stop when we reach the leaf/tail portion of the block. 	 */
while|while
condition|(
name|ptr
operator|<
name|endptr
condition|)
block|{
comment|/* 		 * If it's unused, just skip over it. 		 */
name|dup
operator|=
operator|(
name|xfs_dir2_data_unused_t
operator|*
operator|)
name|ptr
expr_stmt|;
if|if
condition|(
name|be16_to_cpu
argument_list|(
name|dup
operator|->
name|freetag
argument_list|)
operator|==
name|XFS_DIR2_DATA_FREE_TAG
condition|)
block|{
name|ptr
operator|+=
name|be16_to_cpu
argument_list|(
name|dup
operator|->
name|length
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|dep
operator|=
operator|(
name|xfs_dir2_data_entry_t
operator|*
operator|)
name|ptr
expr_stmt|;
comment|/* 		 * Skip . 		 */
if|if
condition|(
name|dep
operator|->
name|namelen
operator|==
literal|1
operator|&&
name|dep
operator|->
name|name
index|[
literal|0
index|]
operator|==
literal|'.'
condition|)
name|ASSERT
argument_list|(
name|INT_GET
argument_list|(
name|dep
operator|->
name|inumber
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|==
name|dp
operator|->
name|i_ino
argument_list|)
expr_stmt|;
comment|/* 		 * Skip .., but make sure the inode number is right. 		 */
elseif|else
if|if
condition|(
name|dep
operator|->
name|namelen
operator|==
literal|2
operator|&&
name|dep
operator|->
name|name
index|[
literal|0
index|]
operator|==
literal|'.'
operator|&&
name|dep
operator|->
name|name
index|[
literal|1
index|]
operator|==
literal|'.'
condition|)
name|ASSERT
argument_list|(
name|INT_GET
argument_list|(
name|dep
operator|->
name|inumber
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|==
name|XFS_DIR2_SF_GET_INUMBER
argument_list|(
name|sfp
argument_list|,
operator|&
name|sfp
operator|->
name|hdr
operator|.
name|parent
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 		 * Normal entry, copy it into shortform. 		 */
else|else
block|{
name|sfep
operator|->
name|namelen
operator|=
name|dep
operator|->
name|namelen
expr_stmt|;
name|XFS_DIR2_SF_PUT_OFFSET
argument_list|(
name|sfep
argument_list|,
call|(
name|xfs_dir2_data_aoff_t
call|)
argument_list|(
operator|(
name|char
operator|*
operator|)
name|dep
operator|-
operator|(
name|char
operator|*
operator|)
name|block
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|sfep
operator|->
name|name
argument_list|,
name|dep
operator|->
name|name
argument_list|,
name|dep
operator|->
name|namelen
argument_list|)
expr_stmt|;
name|temp
operator|=
name|INT_GET
argument_list|(
name|dep
operator|->
name|inumber
argument_list|,
name|ARCH_CONVERT
argument_list|)
expr_stmt|;
name|XFS_DIR2_SF_PUT_INUMBER
argument_list|(
name|sfp
argument_list|,
operator|&
name|temp
argument_list|,
name|XFS_DIR2_SF_INUMBERP
argument_list|(
name|sfep
argument_list|)
argument_list|)
expr_stmt|;
name|sfep
operator|=
name|XFS_DIR2_SF_NEXTENTRY
argument_list|(
name|sfp
argument_list|,
name|sfep
argument_list|)
expr_stmt|;
block|}
name|ptr
operator|+=
name|XFS_DIR2_DATA_ENTSIZE
argument_list|(
name|dep
operator|->
name|namelen
argument_list|)
expr_stmt|;
block|}
name|ASSERT
argument_list|(
operator|(
name|char
operator|*
operator|)
name|sfep
operator|-
operator|(
name|char
operator|*
operator|)
name|sfp
operator|==
name|size
argument_list|)
expr_stmt|;
name|xfs_dir2_sf_check
argument_list|(
name|args
argument_list|)
expr_stmt|;
name|out
label|:
name|xfs_trans_log_inode
argument_list|(
name|args
operator|->
name|trans
argument_list|,
name|dp
argument_list|,
name|logflags
argument_list|)
expr_stmt|;
name|kmem_free
argument_list|(
name|block
argument_list|,
name|mp
operator|->
name|m_dirblksize
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_comment
comment|/*  * Add a name to a shortform directory.  * There are two algorithms, "easy" and "hard" which we decide on  * before changing anything.  * Convert to block form if necessary, if the new entry won't fit.  */
end_comment

begin_function
name|int
comment|/* error */
name|xfs_dir2_sf_addname
parameter_list|(
name|xfs_da_args_t
modifier|*
name|args
parameter_list|)
comment|/* operation arguments */
block|{
name|int
name|add_entsize
decl_stmt|;
comment|/* size of the new entry */
name|xfs_inode_t
modifier|*
name|dp
decl_stmt|;
comment|/* incore directory inode */
name|int
name|error
decl_stmt|;
comment|/* error return value */
name|int
name|incr_isize
decl_stmt|;
comment|/* total change in size */
name|int
name|new_isize
decl_stmt|;
comment|/* di_size after adding name */
name|int
name|objchange
decl_stmt|;
comment|/* changing to 8-byte inodes */
name|xfs_dir2_data_aoff_t
name|offset
init|=
literal|0
decl_stmt|;
comment|/* offset for new entry */
name|int
name|old_isize
decl_stmt|;
comment|/* di_size before adding name */
name|int
name|pick
decl_stmt|;
comment|/* which algorithm to use */
name|xfs_dir2_sf_t
modifier|*
name|sfp
decl_stmt|;
comment|/* shortform structure */
name|xfs_dir2_sf_entry_t
modifier|*
name|sfep
init|=
name|NULL
decl_stmt|;
comment|/* shortform entry */
name|xfs_dir2_trace_args
argument_list|(
literal|"sf_addname"
argument_list|,
name|args
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|xfs_dir2_sf_lookup
argument_list|(
name|args
argument_list|)
operator|==
name|ENOENT
argument_list|)
expr_stmt|;
name|dp
operator|=
name|args
operator|->
name|dp
expr_stmt|;
name|ASSERT
argument_list|(
name|dp
operator|->
name|i_df
operator|.
name|if_flags
operator|&
name|XFS_IFINLINE
argument_list|)
expr_stmt|;
comment|/* 	 * Make sure the shortform value has some of its header. 	 */
if|if
condition|(
name|dp
operator|->
name|i_d
operator|.
name|di_size
operator|<
name|offsetof
argument_list|(
name|xfs_dir2_sf_hdr_t
argument_list|,
name|parent
argument_list|)
condition|)
block|{
name|ASSERT
argument_list|(
name|XFS_FORCED_SHUTDOWN
argument_list|(
name|dp
operator|->
name|i_mount
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|XFS_ERROR
argument_list|(
name|EIO
argument_list|)
return|;
block|}
name|ASSERT
argument_list|(
name|dp
operator|->
name|i_df
operator|.
name|if_bytes
operator|==
name|dp
operator|->
name|i_d
operator|.
name|di_size
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|dp
operator|->
name|i_df
operator|.
name|if_u1
operator|.
name|if_data
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|sfp
operator|=
operator|(
name|xfs_dir2_sf_t
operator|*
operator|)
name|dp
operator|->
name|i_df
operator|.
name|if_u1
operator|.
name|if_data
expr_stmt|;
name|ASSERT
argument_list|(
name|dp
operator|->
name|i_d
operator|.
name|di_size
operator|>=
name|XFS_DIR2_SF_HDR_SIZE
argument_list|(
name|sfp
operator|->
name|hdr
operator|.
name|i8count
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Compute entry (and change in) size. 	 */
name|add_entsize
operator|=
name|XFS_DIR2_SF_ENTSIZE_BYNAME
argument_list|(
name|sfp
argument_list|,
name|args
operator|->
name|namelen
argument_list|)
expr_stmt|;
name|incr_isize
operator|=
name|add_entsize
expr_stmt|;
name|objchange
operator|=
literal|0
expr_stmt|;
if|#
directive|if
name|XFS_BIG_INUMS
comment|/* 	 * Do we have to change to 8 byte inodes? 	 */
if|if
condition|(
name|args
operator|->
name|inumber
operator|>
name|XFS_DIR2_MAX_SHORT_INUM
operator|&&
name|sfp
operator|->
name|hdr
operator|.
name|i8count
operator|==
literal|0
condition|)
block|{
comment|/* 		 * Yes, adjust the entry size and the total size. 		 */
name|add_entsize
operator|+=
operator|(
name|uint
operator|)
sizeof|sizeof
argument_list|(
name|xfs_dir2_ino8_t
argument_list|)
operator|-
operator|(
name|uint
operator|)
sizeof|sizeof
argument_list|(
name|xfs_dir2_ino4_t
argument_list|)
expr_stmt|;
name|incr_isize
operator|+=
operator|(
name|sfp
operator|->
name|hdr
operator|.
name|count
operator|+
literal|2
operator|)
operator|*
operator|(
operator|(
name|uint
operator|)
sizeof|sizeof
argument_list|(
name|xfs_dir2_ino8_t
argument_list|)
operator|-
operator|(
name|uint
operator|)
sizeof|sizeof
argument_list|(
name|xfs_dir2_ino4_t
argument_list|)
operator|)
expr_stmt|;
name|objchange
operator|=
literal|1
expr_stmt|;
block|}
endif|#
directive|endif
name|old_isize
operator|=
operator|(
name|int
operator|)
name|dp
operator|->
name|i_d
operator|.
name|di_size
expr_stmt|;
name|new_isize
operator|=
name|old_isize
operator|+
name|incr_isize
expr_stmt|;
comment|/* 	 * Won't fit as shortform any more (due to size), 	 * or the pick routine says it won't (due to offset values). 	 */
if|if
condition|(
name|new_isize
operator|>
name|XFS_IFORK_DSIZE
argument_list|(
name|dp
argument_list|)
operator|||
operator|(
name|pick
operator|=
name|xfs_dir2_sf_addname_pick
argument_list|(
name|args
argument_list|,
name|objchange
argument_list|,
operator|&
name|sfep
argument_list|,
operator|&
name|offset
argument_list|)
operator|)
operator|==
literal|0
condition|)
block|{
comment|/* 		 * Just checking or no space reservation, it doesn't fit. 		 */
if|if
condition|(
name|args
operator|->
name|justcheck
operator|||
name|args
operator|->
name|total
operator|==
literal|0
condition|)
return|return
name|XFS_ERROR
argument_list|(
name|ENOSPC
argument_list|)
return|;
comment|/* 		 * Convert to block form then add the name. 		 */
name|error
operator|=
name|xfs_dir2_sf_to_block
argument_list|(
name|args
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
return|return
name|xfs_dir2_block_addname
argument_list|(
name|args
argument_list|)
return|;
block|}
comment|/* 	 * Just checking, it fits. 	 */
if|if
condition|(
name|args
operator|->
name|justcheck
condition|)
return|return
literal|0
return|;
comment|/* 	 * Do it the easy way - just add it at the end. 	 */
if|if
condition|(
name|pick
operator|==
literal|1
condition|)
name|xfs_dir2_sf_addname_easy
argument_list|(
name|args
argument_list|,
name|sfep
argument_list|,
name|offset
argument_list|,
name|new_isize
argument_list|)
expr_stmt|;
comment|/* 	 * Do it the hard way - look for a place to insert the new entry. 	 * Convert to 8 byte inode numbers first if necessary. 	 */
else|else
block|{
name|ASSERT
argument_list|(
name|pick
operator|==
literal|2
argument_list|)
expr_stmt|;
if|#
directive|if
name|XFS_BIG_INUMS
if|if
condition|(
name|objchange
condition|)
name|xfs_dir2_sf_toino8
argument_list|(
name|args
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|xfs_dir2_sf_addname_hard
argument_list|(
name|args
argument_list|,
name|objchange
argument_list|,
name|new_isize
argument_list|)
expr_stmt|;
block|}
name|xfs_trans_log_inode
argument_list|(
name|args
operator|->
name|trans
argument_list|,
name|dp
argument_list|,
name|XFS_ILOG_CORE
operator||
name|XFS_ILOG_DDATA
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Add the new entry the "easy" way.  * This is copying the old directory and adding the new entry at the end.  * Since it's sorted by "offset" we need room after the last offset  * that's already there, and then room to convert to a block directory.  * This is already checked by the pick routine.  */
end_comment

begin_function
specifier|static
name|void
name|xfs_dir2_sf_addname_easy
parameter_list|(
name|xfs_da_args_t
modifier|*
name|args
parameter_list|,
comment|/* operation arguments */
name|xfs_dir2_sf_entry_t
modifier|*
name|sfep
parameter_list|,
comment|/* pointer to new entry */
name|xfs_dir2_data_aoff_t
name|offset
parameter_list|,
comment|/* offset to use for new ent */
name|int
name|new_isize
parameter_list|)
comment|/* new directory size */
block|{
name|int
name|byteoff
decl_stmt|;
comment|/* byte offset in sf dir */
name|xfs_inode_t
modifier|*
name|dp
decl_stmt|;
comment|/* incore directory inode */
name|xfs_dir2_sf_t
modifier|*
name|sfp
decl_stmt|;
comment|/* shortform structure */
name|dp
operator|=
name|args
operator|->
name|dp
expr_stmt|;
name|sfp
operator|=
operator|(
name|xfs_dir2_sf_t
operator|*
operator|)
name|dp
operator|->
name|i_df
operator|.
name|if_u1
operator|.
name|if_data
expr_stmt|;
name|byteoff
operator|=
call|(
name|int
call|)
argument_list|(
operator|(
name|char
operator|*
operator|)
name|sfep
operator|-
operator|(
name|char
operator|*
operator|)
name|sfp
argument_list|)
expr_stmt|;
comment|/* 	 * Grow the in-inode space. 	 */
name|xfs_idata_realloc
argument_list|(
name|dp
argument_list|,
name|XFS_DIR2_SF_ENTSIZE_BYNAME
argument_list|(
name|sfp
argument_list|,
name|args
operator|->
name|namelen
argument_list|)
argument_list|,
name|XFS_DATA_FORK
argument_list|)
expr_stmt|;
comment|/* 	 * Need to set up again due to realloc of the inode data. 	 */
name|sfp
operator|=
operator|(
name|xfs_dir2_sf_t
operator|*
operator|)
name|dp
operator|->
name|i_df
operator|.
name|if_u1
operator|.
name|if_data
expr_stmt|;
name|sfep
operator|=
operator|(
name|xfs_dir2_sf_entry_t
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|sfp
operator|+
name|byteoff
operator|)
expr_stmt|;
comment|/* 	 * Fill in the new entry. 	 */
name|sfep
operator|->
name|namelen
operator|=
name|args
operator|->
name|namelen
expr_stmt|;
name|XFS_DIR2_SF_PUT_OFFSET
argument_list|(
name|sfep
argument_list|,
name|offset
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|sfep
operator|->
name|name
argument_list|,
name|args
operator|->
name|name
argument_list|,
name|sfep
operator|->
name|namelen
argument_list|)
expr_stmt|;
name|XFS_DIR2_SF_PUT_INUMBER
argument_list|(
name|sfp
argument_list|,
operator|&
name|args
operator|->
name|inumber
argument_list|,
name|XFS_DIR2_SF_INUMBERP
argument_list|(
name|sfep
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Update the header and inode. 	 */
name|sfp
operator|->
name|hdr
operator|.
name|count
operator|++
expr_stmt|;
if|#
directive|if
name|XFS_BIG_INUMS
if|if
condition|(
name|args
operator|->
name|inumber
operator|>
name|XFS_DIR2_MAX_SHORT_INUM
condition|)
name|sfp
operator|->
name|hdr
operator|.
name|i8count
operator|++
expr_stmt|;
endif|#
directive|endif
name|dp
operator|->
name|i_d
operator|.
name|di_size
operator|=
name|new_isize
expr_stmt|;
name|xfs_dir2_sf_check
argument_list|(
name|args
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Add the new entry the "hard" way.  * The caller has already converted to 8 byte inode numbers if necessary,  * in which case we need to leave the i8count at 1.  * Find a hole that the new entry will fit into, and copy  * the first part of the entries, the new entry, and the last part of  * the entries.  */
end_comment

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|void
name|xfs_dir2_sf_addname_hard
parameter_list|(
name|xfs_da_args_t
modifier|*
name|args
parameter_list|,
comment|/* operation arguments */
name|int
name|objchange
parameter_list|,
comment|/* changing inode number size */
name|int
name|new_isize
parameter_list|)
comment|/* new directory size */
block|{
name|int
name|add_datasize
decl_stmt|;
comment|/* data size need for new ent */
name|char
modifier|*
name|buf
decl_stmt|;
comment|/* buffer for old */
name|xfs_inode_t
modifier|*
name|dp
decl_stmt|;
comment|/* incore directory inode */
name|int
name|eof
decl_stmt|;
comment|/* reached end of old dir */
name|int
name|nbytes
decl_stmt|;
comment|/* temp for byte copies */
name|xfs_dir2_data_aoff_t
name|new_offset
decl_stmt|;
comment|/* next offset value */
name|xfs_dir2_data_aoff_t
name|offset
decl_stmt|;
comment|/* current offset value */
name|int
name|old_isize
decl_stmt|;
comment|/* previous di_size */
name|xfs_dir2_sf_entry_t
modifier|*
name|oldsfep
decl_stmt|;
comment|/* entry in original dir */
name|xfs_dir2_sf_t
modifier|*
name|oldsfp
decl_stmt|;
comment|/* original shortform dir */
name|xfs_dir2_sf_entry_t
modifier|*
name|sfep
decl_stmt|;
comment|/* entry in new dir */
name|xfs_dir2_sf_t
modifier|*
name|sfp
decl_stmt|;
comment|/* new shortform dir */
comment|/* 	 * Copy the old directory to the stack buffer. 	 */
name|dp
operator|=
name|args
operator|->
name|dp
expr_stmt|;
name|sfp
operator|=
operator|(
name|xfs_dir2_sf_t
operator|*
operator|)
name|dp
operator|->
name|i_df
operator|.
name|if_u1
operator|.
name|if_data
expr_stmt|;
name|old_isize
operator|=
operator|(
name|int
operator|)
name|dp
operator|->
name|i_d
operator|.
name|di_size
expr_stmt|;
name|buf
operator|=
name|kmem_alloc
argument_list|(
name|old_isize
argument_list|,
name|KM_SLEEP
argument_list|)
expr_stmt|;
name|oldsfp
operator|=
operator|(
name|xfs_dir2_sf_t
operator|*
operator|)
name|buf
expr_stmt|;
name|memcpy
argument_list|(
name|oldsfp
argument_list|,
name|sfp
argument_list|,
name|old_isize
argument_list|)
expr_stmt|;
comment|/* 	 * Loop over the old directory finding the place we're going 	 * to insert the new entry. 	 * If it's going to end up at the end then oldsfep will point there. 	 */
for|for
control|(
name|offset
operator|=
name|XFS_DIR2_DATA_FIRST_OFFSET
operator|,
name|oldsfep
operator|=
name|XFS_DIR2_SF_FIRSTENTRY
argument_list|(
name|oldsfp
argument_list|)
operator|,
name|add_datasize
operator|=
name|XFS_DIR2_DATA_ENTSIZE
argument_list|(
name|args
operator|->
name|namelen
argument_list|)
operator|,
name|eof
operator|=
operator|(
name|char
operator|*
operator|)
name|oldsfep
operator|==
operator|&
name|buf
index|[
name|old_isize
index|]
init|;
operator|!
name|eof
condition|;
name|offset
operator|=
name|new_offset
operator|+
name|XFS_DIR2_DATA_ENTSIZE
argument_list|(
name|oldsfep
operator|->
name|namelen
argument_list|)
operator|,
name|oldsfep
operator|=
name|XFS_DIR2_SF_NEXTENTRY
argument_list|(
name|oldsfp
argument_list|,
name|oldsfep
argument_list|)
operator|,
name|eof
operator|=
operator|(
name|char
operator|*
operator|)
name|oldsfep
operator|==
operator|&
name|buf
index|[
name|old_isize
index|]
control|)
block|{
name|new_offset
operator|=
name|XFS_DIR2_SF_GET_OFFSET
argument_list|(
name|oldsfep
argument_list|)
expr_stmt|;
if|if
condition|(
name|offset
operator|+
name|add_datasize
operator|<=
name|new_offset
condition|)
break|break;
block|}
comment|/* 	 * Get rid of the old directory, then allocate space for 	 * the new one.  We do this so xfs_idata_realloc won't copy 	 * the data. 	 */
name|xfs_idata_realloc
argument_list|(
name|dp
argument_list|,
operator|-
name|old_isize
argument_list|,
name|XFS_DATA_FORK
argument_list|)
expr_stmt|;
name|xfs_idata_realloc
argument_list|(
name|dp
argument_list|,
name|new_isize
argument_list|,
name|XFS_DATA_FORK
argument_list|)
expr_stmt|;
comment|/* 	 * Reset the pointer since the buffer was reallocated. 	 */
name|sfp
operator|=
operator|(
name|xfs_dir2_sf_t
operator|*
operator|)
name|dp
operator|->
name|i_df
operator|.
name|if_u1
operator|.
name|if_data
expr_stmt|;
comment|/* 	 * Copy the first part of the directory, including the header. 	 */
name|nbytes
operator|=
call|(
name|int
call|)
argument_list|(
operator|(
name|char
operator|*
operator|)
name|oldsfep
operator|-
operator|(
name|char
operator|*
operator|)
name|oldsfp
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|sfp
argument_list|,
name|oldsfp
argument_list|,
name|nbytes
argument_list|)
expr_stmt|;
name|sfep
operator|=
operator|(
name|xfs_dir2_sf_entry_t
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|sfp
operator|+
name|nbytes
operator|)
expr_stmt|;
comment|/* 	 * Fill in the new entry, and update the header counts. 	 */
name|sfep
operator|->
name|namelen
operator|=
name|args
operator|->
name|namelen
expr_stmt|;
name|XFS_DIR2_SF_PUT_OFFSET
argument_list|(
name|sfep
argument_list|,
name|offset
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|sfep
operator|->
name|name
argument_list|,
name|args
operator|->
name|name
argument_list|,
name|sfep
operator|->
name|namelen
argument_list|)
expr_stmt|;
name|XFS_DIR2_SF_PUT_INUMBER
argument_list|(
name|sfp
argument_list|,
operator|&
name|args
operator|->
name|inumber
argument_list|,
name|XFS_DIR2_SF_INUMBERP
argument_list|(
name|sfep
argument_list|)
argument_list|)
expr_stmt|;
name|sfp
operator|->
name|hdr
operator|.
name|count
operator|++
expr_stmt|;
if|#
directive|if
name|XFS_BIG_INUMS
if|if
condition|(
name|args
operator|->
name|inumber
operator|>
name|XFS_DIR2_MAX_SHORT_INUM
operator|&&
operator|!
name|objchange
condition|)
name|sfp
operator|->
name|hdr
operator|.
name|i8count
operator|++
expr_stmt|;
endif|#
directive|endif
comment|/* 	 * If there's more left to copy, do that. 	 */
if|if
condition|(
operator|!
name|eof
condition|)
block|{
name|sfep
operator|=
name|XFS_DIR2_SF_NEXTENTRY
argument_list|(
name|sfp
argument_list|,
name|sfep
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|sfep
argument_list|,
name|oldsfep
argument_list|,
name|old_isize
operator|-
name|nbytes
argument_list|)
expr_stmt|;
block|}
name|kmem_free
argument_list|(
name|buf
argument_list|,
name|old_isize
argument_list|)
expr_stmt|;
name|dp
operator|->
name|i_d
operator|.
name|di_size
operator|=
name|new_isize
expr_stmt|;
name|xfs_dir2_sf_check
argument_list|(
name|args
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Decide if the new entry will fit at all.  * If it will fit, pick between adding the new entry to the end (easy)  * or somewhere else (hard).  * Return 0 (won't fit), 1 (easy), 2 (hard).  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|int
comment|/* pick result */
name|xfs_dir2_sf_addname_pick
parameter_list|(
name|xfs_da_args_t
modifier|*
name|args
parameter_list|,
comment|/* operation arguments */
name|int
name|objchange
parameter_list|,
comment|/* inode # size changes */
name|xfs_dir2_sf_entry_t
modifier|*
modifier|*
name|sfepp
parameter_list|,
comment|/* out(1): new entry ptr */
name|xfs_dir2_data_aoff_t
modifier|*
name|offsetp
parameter_list|)
comment|/* out(1): new offset */
block|{
name|xfs_inode_t
modifier|*
name|dp
decl_stmt|;
comment|/* incore directory inode */
name|int
name|holefit
decl_stmt|;
comment|/* found hole it will fit in */
name|int
name|i
decl_stmt|;
comment|/* entry number */
name|xfs_mount_t
modifier|*
name|mp
decl_stmt|;
comment|/* filesystem mount point */
name|xfs_dir2_data_aoff_t
name|offset
decl_stmt|;
comment|/* data block offset */
name|xfs_dir2_sf_entry_t
modifier|*
name|sfep
decl_stmt|;
comment|/* shortform entry */
name|xfs_dir2_sf_t
modifier|*
name|sfp
decl_stmt|;
comment|/* shortform structure */
name|int
name|size
decl_stmt|;
comment|/* entry's data size */
name|int
name|used
decl_stmt|;
comment|/* data bytes used */
name|dp
operator|=
name|args
operator|->
name|dp
expr_stmt|;
name|mp
operator|=
name|dp
operator|->
name|i_mount
expr_stmt|;
name|sfp
operator|=
operator|(
name|xfs_dir2_sf_t
operator|*
operator|)
name|dp
operator|->
name|i_df
operator|.
name|if_u1
operator|.
name|if_data
expr_stmt|;
name|size
operator|=
name|XFS_DIR2_DATA_ENTSIZE
argument_list|(
name|args
operator|->
name|namelen
argument_list|)
expr_stmt|;
name|offset
operator|=
name|XFS_DIR2_DATA_FIRST_OFFSET
expr_stmt|;
name|sfep
operator|=
name|XFS_DIR2_SF_FIRSTENTRY
argument_list|(
name|sfp
argument_list|)
expr_stmt|;
name|holefit
operator|=
literal|0
expr_stmt|;
comment|/* 	 * Loop over sf entries. 	 * Keep track of data offset and whether we've seen a place 	 * to insert the new entry. 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sfp
operator|->
name|hdr
operator|.
name|count
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|holefit
condition|)
name|holefit
operator|=
name|offset
operator|+
name|size
operator|<=
name|XFS_DIR2_SF_GET_OFFSET
argument_list|(
name|sfep
argument_list|)
expr_stmt|;
name|offset
operator|=
name|XFS_DIR2_SF_GET_OFFSET
argument_list|(
name|sfep
argument_list|)
operator|+
name|XFS_DIR2_DATA_ENTSIZE
argument_list|(
name|sfep
operator|->
name|namelen
argument_list|)
expr_stmt|;
name|sfep
operator|=
name|XFS_DIR2_SF_NEXTENTRY
argument_list|(
name|sfp
argument_list|,
name|sfep
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Calculate data bytes used excluding the new entry, if this 	 * was a data block (block form directory). 	 */
name|used
operator|=
name|offset
operator|+
operator|(
name|sfp
operator|->
name|hdr
operator|.
name|count
operator|+
literal|3
operator|)
operator|*
operator|(
name|uint
operator|)
sizeof|sizeof
argument_list|(
name|xfs_dir2_leaf_entry_t
argument_list|)
operator|+
operator|(
name|uint
operator|)
sizeof|sizeof
argument_list|(
name|xfs_dir2_block_tail_t
argument_list|)
expr_stmt|;
comment|/* 	 * If it won't fit in a block form then we can't insert it, 	 * we'll go back, convert to block, then try the insert and convert 	 * to leaf. 	 */
if|if
condition|(
name|used
operator|+
operator|(
name|holefit
condition|?
literal|0
else|:
name|size
operator|)
operator|>
name|mp
operator|->
name|m_dirblksize
condition|)
return|return
literal|0
return|;
comment|/* 	 * If changing the inode number size, do it the hard way. 	 */
if|#
directive|if
name|XFS_BIG_INUMS
if|if
condition|(
name|objchange
condition|)
block|{
return|return
literal|2
return|;
block|}
else|#
directive|else
name|ASSERT
argument_list|(
name|objchange
operator|==
literal|0
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* 	 * If it won't fit at the end then do it the hard way (use the hole). 	 */
if|if
condition|(
name|used
operator|+
name|size
operator|>
name|mp
operator|->
name|m_dirblksize
condition|)
return|return
literal|2
return|;
comment|/* 	 * Do it the easy way. 	 */
operator|*
name|sfepp
operator|=
name|sfep
expr_stmt|;
operator|*
name|offsetp
operator|=
name|offset
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|DEBUG
end_ifdef

begin_comment
comment|/*  * Check consistency of shortform directory, assert if bad.  */
end_comment

begin_function
specifier|static
name|void
name|xfs_dir2_sf_check
parameter_list|(
name|xfs_da_args_t
modifier|*
name|args
parameter_list|)
comment|/* operation arguments */
block|{
name|xfs_inode_t
modifier|*
name|dp
decl_stmt|;
comment|/* incore directory inode */
name|int
name|i
decl_stmt|;
comment|/* entry number */
name|int
name|i8count
decl_stmt|;
comment|/* number of big inode#s */
name|xfs_ino_t
name|ino
decl_stmt|;
comment|/* entry inode number */
name|int
name|offset
decl_stmt|;
comment|/* data offset */
name|xfs_dir2_sf_entry_t
modifier|*
name|sfep
decl_stmt|;
comment|/* shortform dir entry */
name|xfs_dir2_sf_t
modifier|*
name|sfp
decl_stmt|;
comment|/* shortform structure */
name|dp
operator|=
name|args
operator|->
name|dp
expr_stmt|;
name|sfp
operator|=
operator|(
name|xfs_dir2_sf_t
operator|*
operator|)
name|dp
operator|->
name|i_df
operator|.
name|if_u1
operator|.
name|if_data
expr_stmt|;
name|offset
operator|=
name|XFS_DIR2_DATA_FIRST_OFFSET
expr_stmt|;
name|ino
operator|=
name|XFS_DIR2_SF_GET_INUMBER
argument_list|(
name|sfp
argument_list|,
operator|&
name|sfp
operator|->
name|hdr
operator|.
name|parent
argument_list|)
expr_stmt|;
name|i8count
operator|=
name|ino
operator|>
name|XFS_DIR2_MAX_SHORT_INUM
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|sfep
operator|=
name|XFS_DIR2_SF_FIRSTENTRY
argument_list|(
name|sfp
argument_list|)
init|;
name|i
operator|<
name|sfp
operator|->
name|hdr
operator|.
name|count
condition|;
name|i
operator|++
operator|,
name|sfep
operator|=
name|XFS_DIR2_SF_NEXTENTRY
argument_list|(
name|sfp
argument_list|,
name|sfep
argument_list|)
control|)
block|{
name|ASSERT
argument_list|(
name|XFS_DIR2_SF_GET_OFFSET
argument_list|(
name|sfep
argument_list|)
operator|>=
name|offset
argument_list|)
expr_stmt|;
name|ino
operator|=
name|XFS_DIR2_SF_GET_INUMBER
argument_list|(
name|sfp
argument_list|,
name|XFS_DIR2_SF_INUMBERP
argument_list|(
name|sfep
argument_list|)
argument_list|)
expr_stmt|;
name|i8count
operator|+=
name|ino
operator|>
name|XFS_DIR2_MAX_SHORT_INUM
expr_stmt|;
name|offset
operator|=
name|XFS_DIR2_SF_GET_OFFSET
argument_list|(
name|sfep
argument_list|)
operator|+
name|XFS_DIR2_DATA_ENTSIZE
argument_list|(
name|sfep
operator|->
name|namelen
argument_list|)
expr_stmt|;
block|}
name|ASSERT
argument_list|(
name|i8count
operator|==
name|sfp
operator|->
name|hdr
operator|.
name|i8count
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|XFS_BIG_INUMS
operator|||
name|i8count
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
operator|(
name|char
operator|*
operator|)
name|sfep
operator|-
operator|(
name|char
operator|*
operator|)
name|sfp
operator|==
name|dp
operator|->
name|i_d
operator|.
name|di_size
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|offset
operator|+
operator|(
name|sfp
operator|->
name|hdr
operator|.
name|count
operator|+
literal|2
operator|)
operator|*
operator|(
name|uint
operator|)
sizeof|sizeof
argument_list|(
name|xfs_dir2_leaf_entry_t
argument_list|)
operator|+
operator|(
name|uint
operator|)
sizeof|sizeof
argument_list|(
name|xfs_dir2_block_tail_t
argument_list|)
operator|<=
name|dp
operator|->
name|i_mount
operator|->
name|m_dirblksize
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* DEBUG */
end_comment

begin_comment
comment|/*  * Create a new (shortform) directory.  */
end_comment

begin_function
name|int
comment|/* error, always 0 */
name|xfs_dir2_sf_create
parameter_list|(
name|xfs_da_args_t
modifier|*
name|args
parameter_list|,
comment|/* operation arguments */
name|xfs_ino_t
name|pino
parameter_list|)
comment|/* parent inode number */
block|{
name|xfs_inode_t
modifier|*
name|dp
decl_stmt|;
comment|/* incore directory inode */
name|int
name|i8count
decl_stmt|;
comment|/* parent inode is an 8-byte number */
name|xfs_dir2_sf_t
modifier|*
name|sfp
decl_stmt|;
comment|/* shortform structure */
name|int
name|size
decl_stmt|;
comment|/* directory size */
name|xfs_dir2_trace_args_i
argument_list|(
literal|"sf_create"
argument_list|,
name|args
argument_list|,
name|pino
argument_list|)
expr_stmt|;
name|dp
operator|=
name|args
operator|->
name|dp
expr_stmt|;
name|ASSERT
argument_list|(
name|dp
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|dp
operator|->
name|i_d
operator|.
name|di_size
operator|==
literal|0
argument_list|)
expr_stmt|;
comment|/* 	 * If it's currently a zero-length extent file, 	 * convert it to local format. 	 */
if|if
condition|(
name|dp
operator|->
name|i_d
operator|.
name|di_format
operator|==
name|XFS_DINODE_FMT_EXTENTS
condition|)
block|{
name|dp
operator|->
name|i_df
operator|.
name|if_flags
operator|&=
operator|~
name|XFS_IFEXTENTS
expr_stmt|;
comment|/* just in case */
name|dp
operator|->
name|i_d
operator|.
name|di_format
operator|=
name|XFS_DINODE_FMT_LOCAL
expr_stmt|;
name|xfs_trans_log_inode
argument_list|(
name|args
operator|->
name|trans
argument_list|,
name|dp
argument_list|,
name|XFS_ILOG_CORE
argument_list|)
expr_stmt|;
name|dp
operator|->
name|i_df
operator|.
name|if_flags
operator||=
name|XFS_IFINLINE
expr_stmt|;
block|}
name|ASSERT
argument_list|(
name|dp
operator|->
name|i_df
operator|.
name|if_flags
operator|&
name|XFS_IFINLINE
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|dp
operator|->
name|i_df
operator|.
name|if_bytes
operator|==
literal|0
argument_list|)
expr_stmt|;
name|i8count
operator|=
name|pino
operator|>
name|XFS_DIR2_MAX_SHORT_INUM
expr_stmt|;
name|size
operator|=
name|XFS_DIR2_SF_HDR_SIZE
argument_list|(
name|i8count
argument_list|)
expr_stmt|;
comment|/* 	 * Make a buffer for the data. 	 */
name|xfs_idata_realloc
argument_list|(
name|dp
argument_list|,
name|size
argument_list|,
name|XFS_DATA_FORK
argument_list|)
expr_stmt|;
comment|/* 	 * Fill in the header, 	 */
name|sfp
operator|=
operator|(
name|xfs_dir2_sf_t
operator|*
operator|)
name|dp
operator|->
name|i_df
operator|.
name|if_u1
operator|.
name|if_data
expr_stmt|;
name|sfp
operator|->
name|hdr
operator|.
name|i8count
operator|=
name|i8count
expr_stmt|;
comment|/* 	 * Now can put in the inode number, since i8count is set. 	 */
name|XFS_DIR2_SF_PUT_INUMBER
argument_list|(
name|sfp
argument_list|,
operator|&
name|pino
argument_list|,
operator|&
name|sfp
operator|->
name|hdr
operator|.
name|parent
argument_list|)
expr_stmt|;
name|sfp
operator|->
name|hdr
operator|.
name|count
operator|=
literal|0
expr_stmt|;
name|dp
operator|->
name|i_d
operator|.
name|di_size
operator|=
name|size
expr_stmt|;
name|xfs_dir2_sf_check
argument_list|(
name|args
argument_list|)
expr_stmt|;
name|xfs_trans_log_inode
argument_list|(
name|args
operator|->
name|trans
argument_list|,
name|dp
argument_list|,
name|XFS_ILOG_CORE
operator||
name|XFS_ILOG_DDATA
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
comment|/* error */
name|xfs_dir2_sf_getdents
parameter_list|(
name|xfs_inode_t
modifier|*
name|dp
parameter_list|,
comment|/* incore directory inode */
name|uio_t
modifier|*
name|uio
parameter_list|,
comment|/* caller's buffer control */
name|int
modifier|*
name|eofp
parameter_list|,
comment|/* eof reached? (out) */
name|xfs_dirent_t
modifier|*
name|dbp
parameter_list|,
comment|/* caller's buffer */
name|xfs_dir2_put_t
name|put
parameter_list|)
comment|/* abi's formatting function */
block|{
name|int
name|error
decl_stmt|;
comment|/* error return value */
name|int
name|i
decl_stmt|;
comment|/* shortform entry number */
name|xfs_mount_t
modifier|*
name|mp
decl_stmt|;
comment|/* filesystem mount point */
name|xfs_dir2_dataptr_t
name|off
decl_stmt|;
comment|/* current entry's offset */
name|xfs_dir2_put_args_t
name|p
decl_stmt|;
comment|/* arg package for put rtn */
name|xfs_dir2_sf_entry_t
modifier|*
name|sfep
decl_stmt|;
comment|/* shortform directory entry */
name|xfs_dir2_sf_t
modifier|*
name|sfp
decl_stmt|;
comment|/* shortform structure */
name|xfs_off_t
name|dir_offset
decl_stmt|;
name|mp
operator|=
name|dp
operator|->
name|i_mount
expr_stmt|;
name|ASSERT
argument_list|(
name|dp
operator|->
name|i_df
operator|.
name|if_flags
operator|&
name|XFS_IFINLINE
argument_list|)
expr_stmt|;
comment|/* 	 * Give up if the directory is way too short. 	 */
if|if
condition|(
name|dp
operator|->
name|i_d
operator|.
name|di_size
operator|<
name|offsetof
argument_list|(
name|xfs_dir2_sf_hdr_t
argument_list|,
name|parent
argument_list|)
condition|)
block|{
name|ASSERT
argument_list|(
name|XFS_FORCED_SHUTDOWN
argument_list|(
name|mp
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|XFS_ERROR
argument_list|(
name|EIO
argument_list|)
return|;
block|}
name|dir_offset
operator|=
name|uio
operator|->
name|uio_offset
expr_stmt|;
name|ASSERT
argument_list|(
name|dp
operator|->
name|i_df
operator|.
name|if_bytes
operator|==
name|dp
operator|->
name|i_d
operator|.
name|di_size
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|dp
operator|->
name|i_df
operator|.
name|if_u1
operator|.
name|if_data
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|sfp
operator|=
operator|(
name|xfs_dir2_sf_t
operator|*
operator|)
name|dp
operator|->
name|i_df
operator|.
name|if_u1
operator|.
name|if_data
expr_stmt|;
name|ASSERT
argument_list|(
name|dp
operator|->
name|i_d
operator|.
name|di_size
operator|>=
name|XFS_DIR2_SF_HDR_SIZE
argument_list|(
name|sfp
operator|->
name|hdr
operator|.
name|i8count
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * If the block number in the offset is out of range, we're done. 	 */
if|if
condition|(
name|XFS_DIR2_DATAPTR_TO_DB
argument_list|(
name|mp
argument_list|,
name|dir_offset
argument_list|)
operator|>
name|mp
operator|->
name|m_dirdatablk
condition|)
block|{
operator|*
name|eofp
operator|=
literal|1
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* 	 * Set up putargs structure. 	 */
name|p
operator|.
name|dbp
operator|=
name|dbp
expr_stmt|;
name|p
operator|.
name|put
operator|=
name|put
expr_stmt|;
name|p
operator|.
name|uio
operator|=
name|uio
expr_stmt|;
comment|/* 	 * Put . entry unless we're starting past it. 	 */
if|if
condition|(
name|dir_offset
operator|<=
name|XFS_DIR2_DB_OFF_TO_DATAPTR
argument_list|(
name|mp
argument_list|,
name|mp
operator|->
name|m_dirdatablk
argument_list|,
name|XFS_DIR2_DATA_DOT_OFFSET
argument_list|)
condition|)
block|{
name|p
operator|.
name|cook
operator|=
name|XFS_DIR2_DB_OFF_TO_DATAPTR
argument_list|(
name|mp
argument_list|,
literal|0
argument_list|,
name|XFS_DIR2_DATA_DOTDOT_OFFSET
argument_list|)
expr_stmt|;
name|p
operator|.
name|ino
operator|=
name|dp
operator|->
name|i_ino
expr_stmt|;
if|#
directive|if
name|XFS_BIG_INUMS
name|p
operator|.
name|ino
operator|+=
name|mp
operator|->
name|m_inoadd
expr_stmt|;
endif|#
directive|endif
name|p
operator|.
name|name
operator|=
literal|"."
expr_stmt|;
name|p
operator|.
name|namelen
operator|=
literal|1
expr_stmt|;
name|error
operator|=
name|p
operator|.
name|put
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p
operator|.
name|done
condition|)
block|{
name|uio
operator|->
name|uio_offset
operator|=
name|XFS_DIR2_DB_OFF_TO_DATAPTR
argument_list|(
name|mp
argument_list|,
name|mp
operator|->
name|m_dirdatablk
argument_list|,
name|XFS_DIR2_DATA_DOT_OFFSET
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
block|}
comment|/* 	 * Put .. entry unless we're starting past it. 	 */
if|if
condition|(
name|dir_offset
operator|<=
name|XFS_DIR2_DB_OFF_TO_DATAPTR
argument_list|(
name|mp
argument_list|,
name|mp
operator|->
name|m_dirdatablk
argument_list|,
name|XFS_DIR2_DATA_DOTDOT_OFFSET
argument_list|)
condition|)
block|{
name|p
operator|.
name|cook
operator|=
name|XFS_DIR2_DB_OFF_TO_DATAPTR
argument_list|(
name|mp
argument_list|,
name|mp
operator|->
name|m_dirdatablk
argument_list|,
name|XFS_DIR2_DATA_FIRST_OFFSET
argument_list|)
expr_stmt|;
name|p
operator|.
name|ino
operator|=
name|XFS_DIR2_SF_GET_INUMBER
argument_list|(
name|sfp
argument_list|,
operator|&
name|sfp
operator|->
name|hdr
operator|.
name|parent
argument_list|)
expr_stmt|;
if|#
directive|if
name|XFS_BIG_INUMS
name|p
operator|.
name|ino
operator|+=
name|mp
operator|->
name|m_inoadd
expr_stmt|;
endif|#
directive|endif
name|p
operator|.
name|name
operator|=
literal|".."
expr_stmt|;
name|p
operator|.
name|namelen
operator|=
literal|2
expr_stmt|;
name|error
operator|=
name|p
operator|.
name|put
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p
operator|.
name|done
condition|)
block|{
name|uio
operator|->
name|uio_offset
operator|=
name|XFS_DIR2_DB_OFF_TO_DATAPTR
argument_list|(
name|mp
argument_list|,
name|mp
operator|->
name|m_dirdatablk
argument_list|,
name|XFS_DIR2_DATA_DOTDOT_OFFSET
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
block|}
comment|/* 	 * Loop while there are more entries and put'ing works. 	 */
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|sfep
operator|=
name|XFS_DIR2_SF_FIRSTENTRY
argument_list|(
name|sfp
argument_list|)
init|;
name|i
operator|<
name|sfp
operator|->
name|hdr
operator|.
name|count
condition|;
name|i
operator|++
operator|,
name|sfep
operator|=
name|XFS_DIR2_SF_NEXTENTRY
argument_list|(
name|sfp
argument_list|,
name|sfep
argument_list|)
control|)
block|{
name|off
operator|=
name|XFS_DIR2_DB_OFF_TO_DATAPTR
argument_list|(
name|mp
argument_list|,
name|mp
operator|->
name|m_dirdatablk
argument_list|,
name|XFS_DIR2_SF_GET_OFFSET
argument_list|(
name|sfep
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dir_offset
operator|>
name|off
condition|)
continue|continue;
name|p
operator|.
name|namelen
operator|=
name|sfep
operator|->
name|namelen
expr_stmt|;
name|p
operator|.
name|cook
operator|=
name|XFS_DIR2_DB_OFF_TO_DATAPTR
argument_list|(
name|mp
argument_list|,
name|mp
operator|->
name|m_dirdatablk
argument_list|,
name|XFS_DIR2_SF_GET_OFFSET
argument_list|(
name|sfep
argument_list|)
operator|+
name|XFS_DIR2_DATA_ENTSIZE
argument_list|(
name|p
operator|.
name|namelen
argument_list|)
argument_list|)
expr_stmt|;
name|p
operator|.
name|ino
operator|=
name|XFS_DIR2_SF_GET_INUMBER
argument_list|(
name|sfp
argument_list|,
name|XFS_DIR2_SF_INUMBERP
argument_list|(
name|sfep
argument_list|)
argument_list|)
expr_stmt|;
if|#
directive|if
name|XFS_BIG_INUMS
name|p
operator|.
name|ino
operator|+=
name|mp
operator|->
name|m_inoadd
expr_stmt|;
endif|#
directive|endif
name|p
operator|.
name|name
operator|=
operator|(
name|char
operator|*
operator|)
name|sfep
operator|->
name|name
expr_stmt|;
name|error
operator|=
name|p
operator|.
name|put
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p
operator|.
name|done
condition|)
block|{
name|uio
operator|->
name|uio_offset
operator|=
name|off
expr_stmt|;
return|return
name|error
return|;
block|}
block|}
comment|/* 	 * They all fit. 	 */
operator|*
name|eofp
operator|=
literal|1
expr_stmt|;
name|uio
operator|->
name|uio_offset
operator|=
name|XFS_DIR2_DB_OFF_TO_DATAPTR
argument_list|(
name|mp
argument_list|,
name|mp
operator|->
name|m_dirdatablk
operator|+
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Lookup an entry in a shortform directory.  * Returns EEXIST if found, ENOENT if not found.  */
end_comment

begin_function
name|int
comment|/* error */
name|xfs_dir2_sf_lookup
parameter_list|(
name|xfs_da_args_t
modifier|*
name|args
parameter_list|)
comment|/* operation arguments */
block|{
name|xfs_inode_t
modifier|*
name|dp
decl_stmt|;
comment|/* incore directory inode */
name|int
name|i
decl_stmt|;
comment|/* entry index */
name|xfs_dir2_sf_entry_t
modifier|*
name|sfep
decl_stmt|;
comment|/* shortform directory entry */
name|xfs_dir2_sf_t
modifier|*
name|sfp
decl_stmt|;
comment|/* shortform structure */
name|xfs_dir2_trace_args
argument_list|(
literal|"sf_lookup"
argument_list|,
name|args
argument_list|)
expr_stmt|;
name|xfs_dir2_sf_check
argument_list|(
name|args
argument_list|)
expr_stmt|;
name|dp
operator|=
name|args
operator|->
name|dp
expr_stmt|;
name|ASSERT
argument_list|(
name|dp
operator|->
name|i_df
operator|.
name|if_flags
operator|&
name|XFS_IFINLINE
argument_list|)
expr_stmt|;
comment|/* 	 * Bail out if the directory is way too short. 	 */
if|if
condition|(
name|dp
operator|->
name|i_d
operator|.
name|di_size
operator|<
name|offsetof
argument_list|(
name|xfs_dir2_sf_hdr_t
argument_list|,
name|parent
argument_list|)
condition|)
block|{
name|ASSERT
argument_list|(
name|XFS_FORCED_SHUTDOWN
argument_list|(
name|dp
operator|->
name|i_mount
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|XFS_ERROR
argument_list|(
name|EIO
argument_list|)
return|;
block|}
name|ASSERT
argument_list|(
name|dp
operator|->
name|i_df
operator|.
name|if_bytes
operator|==
name|dp
operator|->
name|i_d
operator|.
name|di_size
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|dp
operator|->
name|i_df
operator|.
name|if_u1
operator|.
name|if_data
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|sfp
operator|=
operator|(
name|xfs_dir2_sf_t
operator|*
operator|)
name|dp
operator|->
name|i_df
operator|.
name|if_u1
operator|.
name|if_data
expr_stmt|;
name|ASSERT
argument_list|(
name|dp
operator|->
name|i_d
operator|.
name|di_size
operator|>=
name|XFS_DIR2_SF_HDR_SIZE
argument_list|(
name|sfp
operator|->
name|hdr
operator|.
name|i8count
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Special case for . 	 */
if|if
condition|(
name|args
operator|->
name|namelen
operator|==
literal|1
operator|&&
name|args
operator|->
name|name
index|[
literal|0
index|]
operator|==
literal|'.'
condition|)
block|{
name|args
operator|->
name|inumber
operator|=
name|dp
operator|->
name|i_ino
expr_stmt|;
return|return
name|XFS_ERROR
argument_list|(
name|EEXIST
argument_list|)
return|;
block|}
comment|/* 	 * Special case for .. 	 */
if|if
condition|(
name|args
operator|->
name|namelen
operator|==
literal|2
operator|&&
name|args
operator|->
name|name
index|[
literal|0
index|]
operator|==
literal|'.'
operator|&&
name|args
operator|->
name|name
index|[
literal|1
index|]
operator|==
literal|'.'
condition|)
block|{
name|args
operator|->
name|inumber
operator|=
name|XFS_DIR2_SF_GET_INUMBER
argument_list|(
name|sfp
argument_list|,
operator|&
name|sfp
operator|->
name|hdr
operator|.
name|parent
argument_list|)
expr_stmt|;
return|return
name|XFS_ERROR
argument_list|(
name|EEXIST
argument_list|)
return|;
block|}
comment|/* 	 * Loop over all the entries trying to match ours. 	 */
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|sfep
operator|=
name|XFS_DIR2_SF_FIRSTENTRY
argument_list|(
name|sfp
argument_list|)
init|;
name|i
operator|<
name|sfp
operator|->
name|hdr
operator|.
name|count
condition|;
name|i
operator|++
operator|,
name|sfep
operator|=
name|XFS_DIR2_SF_NEXTENTRY
argument_list|(
name|sfp
argument_list|,
name|sfep
argument_list|)
control|)
block|{
if|if
condition|(
name|sfep
operator|->
name|namelen
operator|==
name|args
operator|->
name|namelen
operator|&&
name|sfep
operator|->
name|name
index|[
literal|0
index|]
operator|==
name|args
operator|->
name|name
index|[
literal|0
index|]
operator|&&
name|memcmp
argument_list|(
name|args
operator|->
name|name
argument_list|,
name|sfep
operator|->
name|name
argument_list|,
name|args
operator|->
name|namelen
argument_list|)
operator|==
literal|0
condition|)
block|{
name|args
operator|->
name|inumber
operator|=
name|XFS_DIR2_SF_GET_INUMBER
argument_list|(
name|sfp
argument_list|,
name|XFS_DIR2_SF_INUMBERP
argument_list|(
name|sfep
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|XFS_ERROR
argument_list|(
name|EEXIST
argument_list|)
return|;
block|}
block|}
comment|/* 	 * Didn't find it. 	 */
name|ASSERT
argument_list|(
name|args
operator|->
name|oknoent
argument_list|)
expr_stmt|;
return|return
name|XFS_ERROR
argument_list|(
name|ENOENT
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  * Remove an entry from a shortform directory.  */
end_comment

begin_function
name|int
comment|/* error */
name|xfs_dir2_sf_removename
parameter_list|(
name|xfs_da_args_t
modifier|*
name|args
parameter_list|)
block|{
name|int
name|byteoff
decl_stmt|;
comment|/* offset of removed entry */
name|xfs_inode_t
modifier|*
name|dp
decl_stmt|;
comment|/* incore directory inode */
name|int
name|entsize
decl_stmt|;
comment|/* this entry's size */
name|int
name|i
decl_stmt|;
comment|/* shortform entry index */
name|int
name|newsize
decl_stmt|;
comment|/* new inode size */
name|int
name|oldsize
decl_stmt|;
comment|/* old inode size */
name|xfs_dir2_sf_entry_t
modifier|*
name|sfep
decl_stmt|;
comment|/* shortform directory entry */
name|xfs_dir2_sf_t
modifier|*
name|sfp
decl_stmt|;
comment|/* shortform structure */
name|xfs_dir2_trace_args
argument_list|(
literal|"sf_removename"
argument_list|,
name|args
argument_list|)
expr_stmt|;
name|dp
operator|=
name|args
operator|->
name|dp
expr_stmt|;
name|ASSERT
argument_list|(
name|dp
operator|->
name|i_df
operator|.
name|if_flags
operator|&
name|XFS_IFINLINE
argument_list|)
expr_stmt|;
name|oldsize
operator|=
operator|(
name|int
operator|)
name|dp
operator|->
name|i_d
operator|.
name|di_size
expr_stmt|;
comment|/* 	 * Bail out if the directory is way too short. 	 */
if|if
condition|(
name|oldsize
operator|<
name|offsetof
argument_list|(
name|xfs_dir2_sf_hdr_t
argument_list|,
name|parent
argument_list|)
condition|)
block|{
name|ASSERT
argument_list|(
name|XFS_FORCED_SHUTDOWN
argument_list|(
name|dp
operator|->
name|i_mount
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|XFS_ERROR
argument_list|(
name|EIO
argument_list|)
return|;
block|}
name|ASSERT
argument_list|(
name|dp
operator|->
name|i_df
operator|.
name|if_bytes
operator|==
name|oldsize
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|dp
operator|->
name|i_df
operator|.
name|if_u1
operator|.
name|if_data
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|sfp
operator|=
operator|(
name|xfs_dir2_sf_t
operator|*
operator|)
name|dp
operator|->
name|i_df
operator|.
name|if_u1
operator|.
name|if_data
expr_stmt|;
name|ASSERT
argument_list|(
name|oldsize
operator|>=
name|XFS_DIR2_SF_HDR_SIZE
argument_list|(
name|sfp
operator|->
name|hdr
operator|.
name|i8count
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Loop over the old directory entries. 	 * Find the one we're deleting. 	 */
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|sfep
operator|=
name|XFS_DIR2_SF_FIRSTENTRY
argument_list|(
name|sfp
argument_list|)
init|;
name|i
operator|<
name|sfp
operator|->
name|hdr
operator|.
name|count
condition|;
name|i
operator|++
operator|,
name|sfep
operator|=
name|XFS_DIR2_SF_NEXTENTRY
argument_list|(
name|sfp
argument_list|,
name|sfep
argument_list|)
control|)
block|{
if|if
condition|(
name|sfep
operator|->
name|namelen
operator|==
name|args
operator|->
name|namelen
operator|&&
name|sfep
operator|->
name|name
index|[
literal|0
index|]
operator|==
name|args
operator|->
name|name
index|[
literal|0
index|]
operator|&&
name|memcmp
argument_list|(
name|sfep
operator|->
name|name
argument_list|,
name|args
operator|->
name|name
argument_list|,
name|args
operator|->
name|namelen
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ASSERT
argument_list|(
name|XFS_DIR2_SF_GET_INUMBER
argument_list|(
name|sfp
argument_list|,
name|XFS_DIR2_SF_INUMBERP
argument_list|(
name|sfep
argument_list|)
argument_list|)
operator|==
name|args
operator|->
name|inumber
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
comment|/* 	 * Didn't find it. 	 */
if|if
condition|(
name|i
operator|==
name|sfp
operator|->
name|hdr
operator|.
name|count
condition|)
block|{
return|return
name|XFS_ERROR
argument_list|(
name|ENOENT
argument_list|)
return|;
block|}
comment|/* 	 * Calculate sizes. 	 */
name|byteoff
operator|=
call|(
name|int
call|)
argument_list|(
operator|(
name|char
operator|*
operator|)
name|sfep
operator|-
operator|(
name|char
operator|*
operator|)
name|sfp
argument_list|)
expr_stmt|;
name|entsize
operator|=
name|XFS_DIR2_SF_ENTSIZE_BYNAME
argument_list|(
name|sfp
argument_list|,
name|args
operator|->
name|namelen
argument_list|)
expr_stmt|;
name|newsize
operator|=
name|oldsize
operator|-
name|entsize
expr_stmt|;
comment|/* 	 * Copy the part if any after the removed entry, sliding it down. 	 */
if|if
condition|(
name|byteoff
operator|+
name|entsize
operator|<
name|oldsize
condition|)
name|memmove
argument_list|(
operator|(
name|char
operator|*
operator|)
name|sfp
operator|+
name|byteoff
argument_list|,
operator|(
name|char
operator|*
operator|)
name|sfp
operator|+
name|byteoff
operator|+
name|entsize
argument_list|,
name|oldsize
operator|-
operator|(
name|byteoff
operator|+
name|entsize
operator|)
argument_list|)
expr_stmt|;
comment|/* 	 * Fix up the header and file size. 	 */
name|sfp
operator|->
name|hdr
operator|.
name|count
operator|--
expr_stmt|;
name|dp
operator|->
name|i_d
operator|.
name|di_size
operator|=
name|newsize
expr_stmt|;
comment|/* 	 * Reallocate, making it smaller. 	 */
name|xfs_idata_realloc
argument_list|(
name|dp
argument_list|,
name|newsize
operator|-
name|oldsize
argument_list|,
name|XFS_DATA_FORK
argument_list|)
expr_stmt|;
name|sfp
operator|=
operator|(
name|xfs_dir2_sf_t
operator|*
operator|)
name|dp
operator|->
name|i_df
operator|.
name|if_u1
operator|.
name|if_data
expr_stmt|;
if|#
directive|if
name|XFS_BIG_INUMS
comment|/* 	 * Are we changing inode number size? 	 */
if|if
condition|(
name|args
operator|->
name|inumber
operator|>
name|XFS_DIR2_MAX_SHORT_INUM
condition|)
block|{
if|if
condition|(
name|sfp
operator|->
name|hdr
operator|.
name|i8count
operator|==
literal|1
condition|)
name|xfs_dir2_sf_toino4
argument_list|(
name|args
argument_list|)
expr_stmt|;
else|else
name|sfp
operator|->
name|hdr
operator|.
name|i8count
operator|--
expr_stmt|;
block|}
endif|#
directive|endif
name|xfs_dir2_sf_check
argument_list|(
name|args
argument_list|)
expr_stmt|;
name|xfs_trans_log_inode
argument_list|(
name|args
operator|->
name|trans
argument_list|,
name|dp
argument_list|,
name|XFS_ILOG_CORE
operator||
name|XFS_ILOG_DDATA
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Replace the inode number of an entry in a shortform directory.  */
end_comment

begin_function
name|int
comment|/* error */
name|xfs_dir2_sf_replace
parameter_list|(
name|xfs_da_args_t
modifier|*
name|args
parameter_list|)
comment|/* operation arguments */
block|{
name|xfs_inode_t
modifier|*
name|dp
decl_stmt|;
comment|/* incore directory inode */
name|int
name|i
decl_stmt|;
comment|/* entry index */
if|#
directive|if
name|XFS_BIG_INUMS
operator|||
name|defined
argument_list|(
name|DEBUG
argument_list|)
name|xfs_ino_t
name|ino
init|=
literal|0
decl_stmt|;
comment|/* entry old inode number */
endif|#
directive|endif
if|#
directive|if
name|XFS_BIG_INUMS
name|int
name|i8elevated
decl_stmt|;
comment|/* sf_toino8 set i8count=1 */
endif|#
directive|endif
name|xfs_dir2_sf_entry_t
modifier|*
name|sfep
decl_stmt|;
comment|/* shortform directory entry */
name|xfs_dir2_sf_t
modifier|*
name|sfp
decl_stmt|;
comment|/* shortform structure */
name|xfs_dir2_trace_args
argument_list|(
literal|"sf_replace"
argument_list|,
name|args
argument_list|)
expr_stmt|;
name|dp
operator|=
name|args
operator|->
name|dp
expr_stmt|;
name|ASSERT
argument_list|(
name|dp
operator|->
name|i_df
operator|.
name|if_flags
operator|&
name|XFS_IFINLINE
argument_list|)
expr_stmt|;
comment|/* 	 * Bail out if the shortform directory is way too small. 	 */
if|if
condition|(
name|dp
operator|->
name|i_d
operator|.
name|di_size
operator|<
name|offsetof
argument_list|(
name|xfs_dir2_sf_hdr_t
argument_list|,
name|parent
argument_list|)
condition|)
block|{
name|ASSERT
argument_list|(
name|XFS_FORCED_SHUTDOWN
argument_list|(
name|dp
operator|->
name|i_mount
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|XFS_ERROR
argument_list|(
name|EIO
argument_list|)
return|;
block|}
name|ASSERT
argument_list|(
name|dp
operator|->
name|i_df
operator|.
name|if_bytes
operator|==
name|dp
operator|->
name|i_d
operator|.
name|di_size
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|dp
operator|->
name|i_df
operator|.
name|if_u1
operator|.
name|if_data
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|sfp
operator|=
operator|(
name|xfs_dir2_sf_t
operator|*
operator|)
name|dp
operator|->
name|i_df
operator|.
name|if_u1
operator|.
name|if_data
expr_stmt|;
name|ASSERT
argument_list|(
name|dp
operator|->
name|i_d
operator|.
name|di_size
operator|>=
name|XFS_DIR2_SF_HDR_SIZE
argument_list|(
name|sfp
operator|->
name|hdr
operator|.
name|i8count
argument_list|)
argument_list|)
expr_stmt|;
if|#
directive|if
name|XFS_BIG_INUMS
comment|/* 	 * New inode number is large, and need to convert to 8-byte inodes. 	 */
if|if
condition|(
name|args
operator|->
name|inumber
operator|>
name|XFS_DIR2_MAX_SHORT_INUM
operator|&&
name|sfp
operator|->
name|hdr
operator|.
name|i8count
operator|==
literal|0
condition|)
block|{
name|int
name|error
decl_stmt|;
comment|/* error return value */
name|int
name|newsize
decl_stmt|;
comment|/* new inode size */
name|newsize
operator|=
name|dp
operator|->
name|i_df
operator|.
name|if_bytes
operator|+
operator|(
name|sfp
operator|->
name|hdr
operator|.
name|count
operator|+
literal|1
operator|)
operator|*
operator|(
operator|(
name|uint
operator|)
sizeof|sizeof
argument_list|(
name|xfs_dir2_ino8_t
argument_list|)
operator|-
operator|(
name|uint
operator|)
sizeof|sizeof
argument_list|(
name|xfs_dir2_ino4_t
argument_list|)
operator|)
expr_stmt|;
comment|/* 		 * Won't fit as shortform, convert to block then do replace. 		 */
if|if
condition|(
name|newsize
operator|>
name|XFS_IFORK_DSIZE
argument_list|(
name|dp
argument_list|)
condition|)
block|{
name|error
operator|=
name|xfs_dir2_sf_to_block
argument_list|(
name|args
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
return|return
name|error
return|;
block|}
return|return
name|xfs_dir2_block_replace
argument_list|(
name|args
argument_list|)
return|;
block|}
comment|/* 		 * Still fits, convert to 8-byte now. 		 */
name|xfs_dir2_sf_toino8
argument_list|(
name|args
argument_list|)
expr_stmt|;
name|i8elevated
operator|=
literal|1
expr_stmt|;
name|sfp
operator|=
operator|(
name|xfs_dir2_sf_t
operator|*
operator|)
name|dp
operator|->
name|i_df
operator|.
name|if_u1
operator|.
name|if_data
expr_stmt|;
block|}
else|else
name|i8elevated
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
name|ASSERT
argument_list|(
name|args
operator|->
name|namelen
operator|!=
literal|1
operator|||
name|args
operator|->
name|name
index|[
literal|0
index|]
operator|!=
literal|'.'
argument_list|)
expr_stmt|;
comment|/* 	 * Replace ..'s entry. 	 */
if|if
condition|(
name|args
operator|->
name|namelen
operator|==
literal|2
operator|&&
name|args
operator|->
name|name
index|[
literal|0
index|]
operator|==
literal|'.'
operator|&&
name|args
operator|->
name|name
index|[
literal|1
index|]
operator|==
literal|'.'
condition|)
block|{
if|#
directive|if
name|XFS_BIG_INUMS
operator|||
name|defined
argument_list|(
name|DEBUG
argument_list|)
name|ino
operator|=
name|XFS_DIR2_SF_GET_INUMBER
argument_list|(
name|sfp
argument_list|,
operator|&
name|sfp
operator|->
name|hdr
operator|.
name|parent
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|args
operator|->
name|inumber
operator|!=
name|ino
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|XFS_DIR2_SF_PUT_INUMBER
argument_list|(
name|sfp
argument_list|,
operator|&
name|args
operator|->
name|inumber
argument_list|,
operator|&
name|sfp
operator|->
name|hdr
operator|.
name|parent
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Normal entry, look for the name. 	 */
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|sfep
operator|=
name|XFS_DIR2_SF_FIRSTENTRY
argument_list|(
name|sfp
argument_list|)
init|;
name|i
operator|<
name|sfp
operator|->
name|hdr
operator|.
name|count
condition|;
name|i
operator|++
operator|,
name|sfep
operator|=
name|XFS_DIR2_SF_NEXTENTRY
argument_list|(
name|sfp
argument_list|,
name|sfep
argument_list|)
control|)
block|{
if|if
condition|(
name|sfep
operator|->
name|namelen
operator|==
name|args
operator|->
name|namelen
operator|&&
name|sfep
operator|->
name|name
index|[
literal|0
index|]
operator|==
name|args
operator|->
name|name
index|[
literal|0
index|]
operator|&&
name|memcmp
argument_list|(
name|args
operator|->
name|name
argument_list|,
name|sfep
operator|->
name|name
argument_list|,
name|args
operator|->
name|namelen
argument_list|)
operator|==
literal|0
condition|)
block|{
if|#
directive|if
name|XFS_BIG_INUMS
operator|||
name|defined
argument_list|(
name|DEBUG
argument_list|)
name|ino
operator|=
name|XFS_DIR2_SF_GET_INUMBER
argument_list|(
name|sfp
argument_list|,
name|XFS_DIR2_SF_INUMBERP
argument_list|(
name|sfep
argument_list|)
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|args
operator|->
name|inumber
operator|!=
name|ino
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|XFS_DIR2_SF_PUT_INUMBER
argument_list|(
name|sfp
argument_list|,
operator|&
name|args
operator|->
name|inumber
argument_list|,
name|XFS_DIR2_SF_INUMBERP
argument_list|(
name|sfep
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
comment|/* 		 * Didn't find it. 		 */
if|if
condition|(
name|i
operator|==
name|sfp
operator|->
name|hdr
operator|.
name|count
condition|)
block|{
name|ASSERT
argument_list|(
name|args
operator|->
name|oknoent
argument_list|)
expr_stmt|;
if|#
directive|if
name|XFS_BIG_INUMS
if|if
condition|(
name|i8elevated
condition|)
name|xfs_dir2_sf_toino4
argument_list|(
name|args
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|XFS_ERROR
argument_list|(
name|ENOENT
argument_list|)
return|;
block|}
block|}
if|#
directive|if
name|XFS_BIG_INUMS
comment|/* 	 * See if the old number was large, the new number is small. 	 */
if|if
condition|(
name|ino
operator|>
name|XFS_DIR2_MAX_SHORT_INUM
operator|&&
name|args
operator|->
name|inumber
operator|<=
name|XFS_DIR2_MAX_SHORT_INUM
condition|)
block|{
comment|/* 		 * And the old count was one, so need to convert to small. 		 */
if|if
condition|(
name|sfp
operator|->
name|hdr
operator|.
name|i8count
operator|==
literal|1
condition|)
name|xfs_dir2_sf_toino4
argument_list|(
name|args
argument_list|)
expr_stmt|;
else|else
name|sfp
operator|->
name|hdr
operator|.
name|i8count
operator|--
expr_stmt|;
block|}
comment|/* 	 * See if the old number was small, the new number is large. 	 */
if|if
condition|(
name|ino
operator|<=
name|XFS_DIR2_MAX_SHORT_INUM
operator|&&
name|args
operator|->
name|inumber
operator|>
name|XFS_DIR2_MAX_SHORT_INUM
condition|)
block|{
comment|/* 		 * add to the i8count unless we just converted to 8-byte 		 * inodes (which does an implied i8count = 1) 		 */
name|ASSERT
argument_list|(
name|sfp
operator|->
name|hdr
operator|.
name|i8count
operator|!=
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|i8elevated
condition|)
name|sfp
operator|->
name|hdr
operator|.
name|i8count
operator|++
expr_stmt|;
block|}
endif|#
directive|endif
name|xfs_dir2_sf_check
argument_list|(
name|args
argument_list|)
expr_stmt|;
name|xfs_trans_log_inode
argument_list|(
name|args
operator|->
name|trans
argument_list|,
name|dp
argument_list|,
name|XFS_ILOG_DDATA
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_if
if|#
directive|if
name|XFS_BIG_INUMS
end_if

begin_comment
comment|/*  * Convert from 8-byte inode numbers to 4-byte inode numbers.  * The last 8-byte inode number is gone, but the count is still 1.  */
end_comment

begin_function
specifier|static
name|void
name|xfs_dir2_sf_toino4
parameter_list|(
name|xfs_da_args_t
modifier|*
name|args
parameter_list|)
comment|/* operation arguments */
block|{
name|char
modifier|*
name|buf
decl_stmt|;
comment|/* old dir's buffer */
name|xfs_inode_t
modifier|*
name|dp
decl_stmt|;
comment|/* incore directory inode */
name|int
name|i
decl_stmt|;
comment|/* entry index */
name|xfs_ino_t
name|ino
decl_stmt|;
comment|/* entry inode number */
name|int
name|newsize
decl_stmt|;
comment|/* new inode size */
name|xfs_dir2_sf_entry_t
modifier|*
name|oldsfep
decl_stmt|;
comment|/* old sf entry */
name|xfs_dir2_sf_t
modifier|*
name|oldsfp
decl_stmt|;
comment|/* old sf directory */
name|int
name|oldsize
decl_stmt|;
comment|/* old inode size */
name|xfs_dir2_sf_entry_t
modifier|*
name|sfep
decl_stmt|;
comment|/* new sf entry */
name|xfs_dir2_sf_t
modifier|*
name|sfp
decl_stmt|;
comment|/* new sf directory */
name|xfs_dir2_trace_args
argument_list|(
literal|"sf_toino4"
argument_list|,
name|args
argument_list|)
expr_stmt|;
name|dp
operator|=
name|args
operator|->
name|dp
expr_stmt|;
comment|/* 	 * Copy the old directory to the buffer. 	 * Then nuke it from the inode, and add the new buffer to the inode. 	 * Don't want xfs_idata_realloc copying the data here. 	 */
name|oldsize
operator|=
name|dp
operator|->
name|i_df
operator|.
name|if_bytes
expr_stmt|;
name|buf
operator|=
name|kmem_alloc
argument_list|(
name|oldsize
argument_list|,
name|KM_SLEEP
argument_list|)
expr_stmt|;
name|oldsfp
operator|=
operator|(
name|xfs_dir2_sf_t
operator|*
operator|)
name|dp
operator|->
name|i_df
operator|.
name|if_u1
operator|.
name|if_data
expr_stmt|;
name|ASSERT
argument_list|(
name|oldsfp
operator|->
name|hdr
operator|.
name|i8count
operator|==
literal|1
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|buf
argument_list|,
name|oldsfp
argument_list|,
name|oldsize
argument_list|)
expr_stmt|;
comment|/* 	 * Compute the new inode size. 	 */
name|newsize
operator|=
name|oldsize
operator|-
operator|(
name|oldsfp
operator|->
name|hdr
operator|.
name|count
operator|+
literal|1
operator|)
operator|*
operator|(
operator|(
name|uint
operator|)
sizeof|sizeof
argument_list|(
name|xfs_dir2_ino8_t
argument_list|)
operator|-
operator|(
name|uint
operator|)
sizeof|sizeof
argument_list|(
name|xfs_dir2_ino4_t
argument_list|)
operator|)
expr_stmt|;
name|xfs_idata_realloc
argument_list|(
name|dp
argument_list|,
operator|-
name|oldsize
argument_list|,
name|XFS_DATA_FORK
argument_list|)
expr_stmt|;
name|xfs_idata_realloc
argument_list|(
name|dp
argument_list|,
name|newsize
argument_list|,
name|XFS_DATA_FORK
argument_list|)
expr_stmt|;
comment|/* 	 * Reset our pointers, the data has moved. 	 */
name|oldsfp
operator|=
operator|(
name|xfs_dir2_sf_t
operator|*
operator|)
name|buf
expr_stmt|;
name|sfp
operator|=
operator|(
name|xfs_dir2_sf_t
operator|*
operator|)
name|dp
operator|->
name|i_df
operator|.
name|if_u1
operator|.
name|if_data
expr_stmt|;
comment|/* 	 * Fill in the new header. 	 */
name|sfp
operator|->
name|hdr
operator|.
name|count
operator|=
name|oldsfp
operator|->
name|hdr
operator|.
name|count
expr_stmt|;
name|sfp
operator|->
name|hdr
operator|.
name|i8count
operator|=
literal|0
expr_stmt|;
name|ino
operator|=
name|XFS_DIR2_SF_GET_INUMBER
argument_list|(
name|oldsfp
argument_list|,
operator|&
name|oldsfp
operator|->
name|hdr
operator|.
name|parent
argument_list|)
expr_stmt|;
name|XFS_DIR2_SF_PUT_INUMBER
argument_list|(
name|sfp
argument_list|,
operator|&
name|ino
argument_list|,
operator|&
name|sfp
operator|->
name|hdr
operator|.
name|parent
argument_list|)
expr_stmt|;
comment|/* 	 * Copy the entries field by field. 	 */
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|sfep
operator|=
name|XFS_DIR2_SF_FIRSTENTRY
argument_list|(
name|sfp
argument_list|)
operator|,
name|oldsfep
operator|=
name|XFS_DIR2_SF_FIRSTENTRY
argument_list|(
name|oldsfp
argument_list|)
init|;
name|i
operator|<
name|sfp
operator|->
name|hdr
operator|.
name|count
condition|;
name|i
operator|++
operator|,
name|sfep
operator|=
name|XFS_DIR2_SF_NEXTENTRY
argument_list|(
name|sfp
argument_list|,
name|sfep
argument_list|)
operator|,
name|oldsfep
operator|=
name|XFS_DIR2_SF_NEXTENTRY
argument_list|(
name|oldsfp
argument_list|,
name|oldsfep
argument_list|)
control|)
block|{
name|sfep
operator|->
name|namelen
operator|=
name|oldsfep
operator|->
name|namelen
expr_stmt|;
name|sfep
operator|->
name|offset
operator|=
name|oldsfep
operator|->
name|offset
expr_stmt|;
name|memcpy
argument_list|(
name|sfep
operator|->
name|name
argument_list|,
name|oldsfep
operator|->
name|name
argument_list|,
name|sfep
operator|->
name|namelen
argument_list|)
expr_stmt|;
name|ino
operator|=
name|XFS_DIR2_SF_GET_INUMBER
argument_list|(
name|oldsfp
argument_list|,
name|XFS_DIR2_SF_INUMBERP
argument_list|(
name|oldsfep
argument_list|)
argument_list|)
expr_stmt|;
name|XFS_DIR2_SF_PUT_INUMBER
argument_list|(
name|sfp
argument_list|,
operator|&
name|ino
argument_list|,
name|XFS_DIR2_SF_INUMBERP
argument_list|(
name|sfep
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Clean up the inode. 	 */
name|kmem_free
argument_list|(
name|buf
argument_list|,
name|oldsize
argument_list|)
expr_stmt|;
name|dp
operator|->
name|i_d
operator|.
name|di_size
operator|=
name|newsize
expr_stmt|;
name|xfs_trans_log_inode
argument_list|(
name|args
operator|->
name|trans
argument_list|,
name|dp
argument_list|,
name|XFS_ILOG_CORE
operator||
name|XFS_ILOG_DDATA
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Convert from 4-byte inode numbers to 8-byte inode numbers.  * The new 8-byte inode number is not there yet, we leave with the  * count 1 but no corresponding entry.  */
end_comment

begin_function
specifier|static
name|void
name|xfs_dir2_sf_toino8
parameter_list|(
name|xfs_da_args_t
modifier|*
name|args
parameter_list|)
comment|/* operation arguments */
block|{
name|char
modifier|*
name|buf
decl_stmt|;
comment|/* old dir's buffer */
name|xfs_inode_t
modifier|*
name|dp
decl_stmt|;
comment|/* incore directory inode */
name|int
name|i
decl_stmt|;
comment|/* entry index */
name|xfs_ino_t
name|ino
decl_stmt|;
comment|/* entry inode number */
name|int
name|newsize
decl_stmt|;
comment|/* new inode size */
name|xfs_dir2_sf_entry_t
modifier|*
name|oldsfep
decl_stmt|;
comment|/* old sf entry */
name|xfs_dir2_sf_t
modifier|*
name|oldsfp
decl_stmt|;
comment|/* old sf directory */
name|int
name|oldsize
decl_stmt|;
comment|/* old inode size */
name|xfs_dir2_sf_entry_t
modifier|*
name|sfep
decl_stmt|;
comment|/* new sf entry */
name|xfs_dir2_sf_t
modifier|*
name|sfp
decl_stmt|;
comment|/* new sf directory */
name|xfs_dir2_trace_args
argument_list|(
literal|"sf_toino8"
argument_list|,
name|args
argument_list|)
expr_stmt|;
name|dp
operator|=
name|args
operator|->
name|dp
expr_stmt|;
comment|/* 	 * Copy the old directory to the buffer. 	 * Then nuke it from the inode, and add the new buffer to the inode. 	 * Don't want xfs_idata_realloc copying the data here. 	 */
name|oldsize
operator|=
name|dp
operator|->
name|i_df
operator|.
name|if_bytes
expr_stmt|;
name|buf
operator|=
name|kmem_alloc
argument_list|(
name|oldsize
argument_list|,
name|KM_SLEEP
argument_list|)
expr_stmt|;
name|oldsfp
operator|=
operator|(
name|xfs_dir2_sf_t
operator|*
operator|)
name|dp
operator|->
name|i_df
operator|.
name|if_u1
operator|.
name|if_data
expr_stmt|;
name|ASSERT
argument_list|(
name|oldsfp
operator|->
name|hdr
operator|.
name|i8count
operator|==
literal|0
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|buf
argument_list|,
name|oldsfp
argument_list|,
name|oldsize
argument_list|)
expr_stmt|;
comment|/* 	 * Compute the new inode size. 	 */
name|newsize
operator|=
name|oldsize
operator|+
operator|(
name|oldsfp
operator|->
name|hdr
operator|.
name|count
operator|+
literal|1
operator|)
operator|*
operator|(
operator|(
name|uint
operator|)
sizeof|sizeof
argument_list|(
name|xfs_dir2_ino8_t
argument_list|)
operator|-
operator|(
name|uint
operator|)
sizeof|sizeof
argument_list|(
name|xfs_dir2_ino4_t
argument_list|)
operator|)
expr_stmt|;
name|xfs_idata_realloc
argument_list|(
name|dp
argument_list|,
operator|-
name|oldsize
argument_list|,
name|XFS_DATA_FORK
argument_list|)
expr_stmt|;
name|xfs_idata_realloc
argument_list|(
name|dp
argument_list|,
name|newsize
argument_list|,
name|XFS_DATA_FORK
argument_list|)
expr_stmt|;
comment|/* 	 * Reset our pointers, the data has moved. 	 */
name|oldsfp
operator|=
operator|(
name|xfs_dir2_sf_t
operator|*
operator|)
name|buf
expr_stmt|;
name|sfp
operator|=
operator|(
name|xfs_dir2_sf_t
operator|*
operator|)
name|dp
operator|->
name|i_df
operator|.
name|if_u1
operator|.
name|if_data
expr_stmt|;
comment|/* 	 * Fill in the new header. 	 */
name|sfp
operator|->
name|hdr
operator|.
name|count
operator|=
name|oldsfp
operator|->
name|hdr
operator|.
name|count
expr_stmt|;
name|sfp
operator|->
name|hdr
operator|.
name|i8count
operator|=
literal|1
expr_stmt|;
name|ino
operator|=
name|XFS_DIR2_SF_GET_INUMBER
argument_list|(
name|oldsfp
argument_list|,
operator|&
name|oldsfp
operator|->
name|hdr
operator|.
name|parent
argument_list|)
expr_stmt|;
name|XFS_DIR2_SF_PUT_INUMBER
argument_list|(
name|sfp
argument_list|,
operator|&
name|ino
argument_list|,
operator|&
name|sfp
operator|->
name|hdr
operator|.
name|parent
argument_list|)
expr_stmt|;
comment|/* 	 * Copy the entries field by field. 	 */
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|sfep
operator|=
name|XFS_DIR2_SF_FIRSTENTRY
argument_list|(
name|sfp
argument_list|)
operator|,
name|oldsfep
operator|=
name|XFS_DIR2_SF_FIRSTENTRY
argument_list|(
name|oldsfp
argument_list|)
init|;
name|i
operator|<
name|sfp
operator|->
name|hdr
operator|.
name|count
condition|;
name|i
operator|++
operator|,
name|sfep
operator|=
name|XFS_DIR2_SF_NEXTENTRY
argument_list|(
name|sfp
argument_list|,
name|sfep
argument_list|)
operator|,
name|oldsfep
operator|=
name|XFS_DIR2_SF_NEXTENTRY
argument_list|(
name|oldsfp
argument_list|,
name|oldsfep
argument_list|)
control|)
block|{
name|sfep
operator|->
name|namelen
operator|=
name|oldsfep
operator|->
name|namelen
expr_stmt|;
name|sfep
operator|->
name|offset
operator|=
name|oldsfep
operator|->
name|offset
expr_stmt|;
name|memcpy
argument_list|(
name|sfep
operator|->
name|name
argument_list|,
name|oldsfep
operator|->
name|name
argument_list|,
name|sfep
operator|->
name|namelen
argument_list|)
expr_stmt|;
name|ino
operator|=
name|XFS_DIR2_SF_GET_INUMBER
argument_list|(
name|oldsfp
argument_list|,
name|XFS_DIR2_SF_INUMBERP
argument_list|(
name|oldsfep
argument_list|)
argument_list|)
expr_stmt|;
name|XFS_DIR2_SF_PUT_INUMBER
argument_list|(
name|sfp
argument_list|,
operator|&
name|ino
argument_list|,
name|XFS_DIR2_SF_INUMBERP
argument_list|(
name|sfep
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Clean up the inode. 	 */
name|kmem_free
argument_list|(
name|buf
argument_list|,
name|oldsize
argument_list|)
expr_stmt|;
name|dp
operator|->
name|i_d
operator|.
name|di_size
operator|=
name|newsize
expr_stmt|;
name|xfs_trans_log_inode
argument_list|(
name|args
operator|->
name|trans
argument_list|,
name|dp
argument_list|,
name|XFS_ILOG_CORE
operator||
name|XFS_ILOG_DDATA
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* XFS_BIG_INUMS */
end_comment

end_unit


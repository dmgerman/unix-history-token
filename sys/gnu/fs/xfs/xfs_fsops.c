begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2000-2005 Silicon Graphics, Inc.  * All Rights Reserved.  *  * This program is free software; you can redistribute it and/or  * modify it under the terms of the GNU General Public License as  * published by the Free Software Foundation.  *  * This program is distributed in the hope that it would be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  * GNU General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program; if not, write the Free Software Foundation,  * Inc.,  51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA  */
end_comment

begin_include
include|#
directive|include
file|"xfs.h"
end_include

begin_include
include|#
directive|include
file|"xfs_fs.h"
end_include

begin_include
include|#
directive|include
file|"xfs_types.h"
end_include

begin_include
include|#
directive|include
file|"xfs_bit.h"
end_include

begin_include
include|#
directive|include
file|"xfs_inum.h"
end_include

begin_include
include|#
directive|include
file|"xfs_log.h"
end_include

begin_include
include|#
directive|include
file|"xfs_trans.h"
end_include

begin_include
include|#
directive|include
file|"xfs_sb.h"
end_include

begin_include
include|#
directive|include
file|"xfs_ag.h"
end_include

begin_include
include|#
directive|include
file|"xfs_dir.h"
end_include

begin_include
include|#
directive|include
file|"xfs_dir2.h"
end_include

begin_include
include|#
directive|include
file|"xfs_dmapi.h"
end_include

begin_include
include|#
directive|include
file|"xfs_mount.h"
end_include

begin_include
include|#
directive|include
file|"xfs_bmap_btree.h"
end_include

begin_include
include|#
directive|include
file|"xfs_alloc_btree.h"
end_include

begin_include
include|#
directive|include
file|"xfs_ialloc_btree.h"
end_include

begin_include
include|#
directive|include
file|"xfs_dir_sf.h"
end_include

begin_include
include|#
directive|include
file|"xfs_dir2_sf.h"
end_include

begin_include
include|#
directive|include
file|"xfs_attr_sf.h"
end_include

begin_include
include|#
directive|include
file|"xfs_dinode.h"
end_include

begin_include
include|#
directive|include
file|"xfs_inode.h"
end_include

begin_include
include|#
directive|include
file|"xfs_inode_item.h"
end_include

begin_include
include|#
directive|include
file|"xfs_btree.h"
end_include

begin_include
include|#
directive|include
file|"xfs_error.h"
end_include

begin_include
include|#
directive|include
file|"xfs_alloc.h"
end_include

begin_include
include|#
directive|include
file|"xfs_ialloc.h"
end_include

begin_include
include|#
directive|include
file|"xfs_fsops.h"
end_include

begin_include
include|#
directive|include
file|"xfs_itable.h"
end_include

begin_include
include|#
directive|include
file|"xfs_trans_space.h"
end_include

begin_include
include|#
directive|include
file|"xfs_rtalloc.h"
end_include

begin_include
include|#
directive|include
file|"xfs_rw.h"
end_include

begin_comment
comment|/*  * File system operations  */
end_comment

begin_function
name|int
name|xfs_fs_geometry
parameter_list|(
name|xfs_mount_t
modifier|*
name|mp
parameter_list|,
name|xfs_fsop_geom_t
modifier|*
name|geo
parameter_list|,
name|int
name|new_version
parameter_list|)
block|{
name|geo
operator|->
name|blocksize
operator|=
name|mp
operator|->
name|m_sb
operator|.
name|sb_blocksize
expr_stmt|;
name|geo
operator|->
name|rtextsize
operator|=
name|mp
operator|->
name|m_sb
operator|.
name|sb_rextsize
expr_stmt|;
name|geo
operator|->
name|agblocks
operator|=
name|mp
operator|->
name|m_sb
operator|.
name|sb_agblocks
expr_stmt|;
name|geo
operator|->
name|agcount
operator|=
name|mp
operator|->
name|m_sb
operator|.
name|sb_agcount
expr_stmt|;
name|geo
operator|->
name|logblocks
operator|=
name|mp
operator|->
name|m_sb
operator|.
name|sb_logblocks
expr_stmt|;
name|geo
operator|->
name|sectsize
operator|=
name|mp
operator|->
name|m_sb
operator|.
name|sb_sectsize
expr_stmt|;
name|geo
operator|->
name|inodesize
operator|=
name|mp
operator|->
name|m_sb
operator|.
name|sb_inodesize
expr_stmt|;
name|geo
operator|->
name|imaxpct
operator|=
name|mp
operator|->
name|m_sb
operator|.
name|sb_imax_pct
expr_stmt|;
name|geo
operator|->
name|datablocks
operator|=
name|mp
operator|->
name|m_sb
operator|.
name|sb_dblocks
expr_stmt|;
name|geo
operator|->
name|rtblocks
operator|=
name|mp
operator|->
name|m_sb
operator|.
name|sb_rblocks
expr_stmt|;
name|geo
operator|->
name|rtextents
operator|=
name|mp
operator|->
name|m_sb
operator|.
name|sb_rextents
expr_stmt|;
name|geo
operator|->
name|logstart
operator|=
name|mp
operator|->
name|m_sb
operator|.
name|sb_logstart
expr_stmt|;
name|ASSERT
argument_list|(
sizeof|sizeof
argument_list|(
name|geo
operator|->
name|uuid
argument_list|)
operator|==
sizeof|sizeof
argument_list|(
name|mp
operator|->
name|m_sb
operator|.
name|sb_uuid
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|geo
operator|->
name|uuid
argument_list|,
operator|&
name|mp
operator|->
name|m_sb
operator|.
name|sb_uuid
argument_list|,
sizeof|sizeof
argument_list|(
name|mp
operator|->
name|m_sb
operator|.
name|sb_uuid
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|new_version
operator|>=
literal|2
condition|)
block|{
name|geo
operator|->
name|sunit
operator|=
name|mp
operator|->
name|m_sb
operator|.
name|sb_unit
expr_stmt|;
name|geo
operator|->
name|swidth
operator|=
name|mp
operator|->
name|m_sb
operator|.
name|sb_width
expr_stmt|;
block|}
if|if
condition|(
name|new_version
operator|>=
literal|3
condition|)
block|{
name|geo
operator|->
name|version
operator|=
name|XFS_FSOP_GEOM_VERSION
expr_stmt|;
name|geo
operator|->
name|flags
operator|=
operator|(
name|XFS_SB_VERSION_HASATTR
argument_list|(
operator|&
name|mp
operator|->
name|m_sb
argument_list|)
condition|?
name|XFS_FSOP_GEOM_FLAGS_ATTR
else|:
literal|0
operator|)
operator||
operator|(
name|XFS_SB_VERSION_HASNLINK
argument_list|(
operator|&
name|mp
operator|->
name|m_sb
argument_list|)
condition|?
name|XFS_FSOP_GEOM_FLAGS_NLINK
else|:
literal|0
operator|)
operator||
operator|(
name|XFS_SB_VERSION_HASQUOTA
argument_list|(
operator|&
name|mp
operator|->
name|m_sb
argument_list|)
condition|?
name|XFS_FSOP_GEOM_FLAGS_QUOTA
else|:
literal|0
operator|)
operator||
operator|(
name|XFS_SB_VERSION_HASALIGN
argument_list|(
operator|&
name|mp
operator|->
name|m_sb
argument_list|)
condition|?
name|XFS_FSOP_GEOM_FLAGS_IALIGN
else|:
literal|0
operator|)
operator||
operator|(
name|XFS_SB_VERSION_HASDALIGN
argument_list|(
operator|&
name|mp
operator|->
name|m_sb
argument_list|)
condition|?
name|XFS_FSOP_GEOM_FLAGS_DALIGN
else|:
literal|0
operator|)
operator||
operator|(
name|XFS_SB_VERSION_HASSHARED
argument_list|(
operator|&
name|mp
operator|->
name|m_sb
argument_list|)
condition|?
name|XFS_FSOP_GEOM_FLAGS_SHARED
else|:
literal|0
operator|)
operator||
operator|(
name|XFS_SB_VERSION_HASEXTFLGBIT
argument_list|(
operator|&
name|mp
operator|->
name|m_sb
argument_list|)
condition|?
name|XFS_FSOP_GEOM_FLAGS_EXTFLG
else|:
literal|0
operator|)
operator||
operator|(
name|XFS_SB_VERSION_HASDIRV2
argument_list|(
operator|&
name|mp
operator|->
name|m_sb
argument_list|)
condition|?
name|XFS_FSOP_GEOM_FLAGS_DIRV2
else|:
literal|0
operator|)
operator||
operator|(
name|XFS_SB_VERSION_HASSECTOR
argument_list|(
operator|&
name|mp
operator|->
name|m_sb
argument_list|)
condition|?
name|XFS_FSOP_GEOM_FLAGS_SECTOR
else|:
literal|0
operator|)
operator||
operator|(
name|XFS_SB_VERSION_HASATTR2
argument_list|(
operator|&
name|mp
operator|->
name|m_sb
argument_list|)
condition|?
name|XFS_FSOP_GEOM_FLAGS_ATTR2
else|:
literal|0
operator|)
expr_stmt|;
name|geo
operator|->
name|logsectsize
operator|=
name|XFS_SB_VERSION_HASSECTOR
argument_list|(
operator|&
name|mp
operator|->
name|m_sb
argument_list|)
condition|?
name|mp
operator|->
name|m_sb
operator|.
name|sb_logsectsize
else|:
name|BBSIZE
expr_stmt|;
name|geo
operator|->
name|rtsectsize
operator|=
name|mp
operator|->
name|m_sb
operator|.
name|sb_blocksize
expr_stmt|;
name|geo
operator|->
name|dirblocksize
operator|=
name|mp
operator|->
name|m_dirblksize
expr_stmt|;
block|}
if|if
condition|(
name|new_version
operator|>=
literal|4
condition|)
block|{
name|geo
operator|->
name|flags
operator||=
operator|(
name|XFS_SB_VERSION_HASLOGV2
argument_list|(
operator|&
name|mp
operator|->
name|m_sb
argument_list|)
condition|?
name|XFS_FSOP_GEOM_FLAGS_LOGV2
else|:
literal|0
operator|)
expr_stmt|;
name|geo
operator|->
name|logsunit
operator|=
name|mp
operator|->
name|m_sb
operator|.
name|sb_logsunit
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|xfs_growfs_data_private
parameter_list|(
name|xfs_mount_t
modifier|*
name|mp
parameter_list|,
comment|/* mount point for filesystem */
name|xfs_growfs_data_t
modifier|*
name|in
parameter_list|)
comment|/* growfs data input struct */
block|{
name|xfs_agf_t
modifier|*
name|agf
decl_stmt|;
name|xfs_agi_t
modifier|*
name|agi
decl_stmt|;
name|xfs_agnumber_t
name|agno
decl_stmt|;
name|xfs_extlen_t
name|agsize
decl_stmt|;
name|xfs_extlen_t
name|tmpsize
decl_stmt|;
name|xfs_alloc_rec_t
modifier|*
name|arec
decl_stmt|;
name|xfs_btree_sblock_t
modifier|*
name|block
decl_stmt|;
name|xfs_buf_t
modifier|*
name|bp
decl_stmt|;
name|int
name|bucket
decl_stmt|;
name|int
name|dpct
decl_stmt|;
name|int
name|error
decl_stmt|;
name|xfs_agnumber_t
name|nagcount
decl_stmt|;
name|xfs_agnumber_t
name|nagimax
init|=
literal|0
decl_stmt|;
name|xfs_rfsblock_t
name|nb
decl_stmt|,
name|nb_mod
decl_stmt|;
name|xfs_rfsblock_t
name|new
decl_stmt|;
name|xfs_rfsblock_t
name|nfree
decl_stmt|;
name|xfs_agnumber_t
name|oagcount
decl_stmt|;
name|int
name|pct
decl_stmt|;
name|xfs_sb_t
modifier|*
name|sbp
decl_stmt|;
name|xfs_trans_t
modifier|*
name|tp
decl_stmt|;
name|nb
operator|=
name|in
operator|->
name|newblocks
expr_stmt|;
name|pct
operator|=
name|in
operator|->
name|imaxpct
expr_stmt|;
if|if
condition|(
name|nb
operator|<
name|mp
operator|->
name|m_sb
operator|.
name|sb_dblocks
operator|||
name|pct
operator|<
literal|0
operator|||
name|pct
operator|>
literal|100
condition|)
return|return
name|XFS_ERROR
argument_list|(
name|EINVAL
argument_list|)
return|;
name|dpct
operator|=
name|pct
operator|-
name|mp
operator|->
name|m_sb
operator|.
name|sb_imax_pct
expr_stmt|;
name|error
operator|=
name|xfs_read_buf
argument_list|(
name|mp
argument_list|,
name|mp
operator|->
name|m_ddev_targp
argument_list|,
name|XFS_FSB_TO_BB
argument_list|(
name|mp
argument_list|,
name|nb
argument_list|)
operator|-
name|XFS_FSS_TO_BB
argument_list|(
name|mp
argument_list|,
literal|1
argument_list|)
argument_list|,
name|XFS_FSS_TO_BB
argument_list|(
name|mp
argument_list|,
literal|1
argument_list|)
argument_list|,
literal|0
argument_list|,
operator|&
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
name|ASSERT
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|xfs_buf_relse
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|new
operator|=
name|nb
expr_stmt|;
comment|/* use new as a temporary here */
name|nb_mod
operator|=
name|do_div
argument_list|(
name|new
argument_list|,
name|mp
operator|->
name|m_sb
operator|.
name|sb_agblocks
argument_list|)
expr_stmt|;
name|nagcount
operator|=
name|new
operator|+
operator|(
name|nb_mod
operator|!=
literal|0
operator|)
expr_stmt|;
if|if
condition|(
name|nb_mod
operator|&&
name|nb_mod
operator|<
name|XFS_MIN_AG_BLOCKS
condition|)
block|{
name|nagcount
operator|--
expr_stmt|;
name|nb
operator|=
name|nagcount
operator|*
name|mp
operator|->
name|m_sb
operator|.
name|sb_agblocks
expr_stmt|;
if|if
condition|(
name|nb
operator|<
name|mp
operator|->
name|m_sb
operator|.
name|sb_dblocks
condition|)
return|return
name|XFS_ERROR
argument_list|(
name|EINVAL
argument_list|)
return|;
block|}
name|new
operator|=
name|nb
operator|-
name|mp
operator|->
name|m_sb
operator|.
name|sb_dblocks
expr_stmt|;
name|oagcount
operator|=
name|mp
operator|->
name|m_sb
operator|.
name|sb_agcount
expr_stmt|;
if|if
condition|(
name|nagcount
operator|>
name|oagcount
condition|)
block|{
name|down_write
argument_list|(
operator|&
name|mp
operator|->
name|m_peraglock
argument_list|)
expr_stmt|;
name|mp
operator|->
name|m_perag
operator|=
name|kmem_realloc
argument_list|(
name|mp
operator|->
name|m_perag
argument_list|,
sizeof|sizeof
argument_list|(
name|xfs_perag_t
argument_list|)
operator|*
name|nagcount
argument_list|,
sizeof|sizeof
argument_list|(
name|xfs_perag_t
argument_list|)
operator|*
name|oagcount
argument_list|,
name|KM_SLEEP
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|mp
operator|->
name|m_perag
index|[
name|oagcount
index|]
argument_list|,
literal|0
argument_list|,
operator|(
name|nagcount
operator|-
name|oagcount
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|xfs_perag_t
argument_list|)
argument_list|)
expr_stmt|;
name|mp
operator|->
name|m_flags
operator||=
name|XFS_MOUNT_32BITINODES
expr_stmt|;
name|nagimax
operator|=
name|xfs_initialize_perag
argument_list|(
name|XFS_MTOVFS
argument_list|(
name|mp
argument_list|)
argument_list|,
name|mp
argument_list|,
name|nagcount
argument_list|)
expr_stmt|;
name|up_write
argument_list|(
operator|&
name|mp
operator|->
name|m_peraglock
argument_list|)
expr_stmt|;
block|}
name|tp
operator|=
name|xfs_trans_alloc
argument_list|(
name|mp
argument_list|,
name|XFS_TRANS_GROWFS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_trans_reserve
argument_list|(
name|tp
argument_list|,
name|XFS_GROWFS_SPACE_RES
argument_list|(
name|mp
argument_list|)
argument_list|,
name|XFS_GROWDATA_LOG_RES
argument_list|(
name|mp
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
operator|)
condition|)
block|{
name|xfs_trans_cancel
argument_list|(
name|tp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
name|nfree
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|agno
operator|=
name|nagcount
operator|-
literal|1
init|;
name|agno
operator|>=
name|oagcount
condition|;
name|agno
operator|--
operator|,
name|new
operator|-=
name|agsize
control|)
block|{
comment|/* 		 * AG freelist header block 		 */
name|bp
operator|=
name|xfs_buf_get
argument_list|(
name|mp
operator|->
name|m_ddev_targp
argument_list|,
name|XFS_AG_DADDR
argument_list|(
name|mp
argument_list|,
name|agno
argument_list|,
name|XFS_AGF_DADDR
argument_list|(
name|mp
argument_list|)
argument_list|)
argument_list|,
name|XFS_FSS_TO_BB
argument_list|(
name|mp
argument_list|,
literal|1
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|agf
operator|=
name|XFS_BUF_TO_AGF
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|agf
argument_list|,
literal|0
argument_list|,
name|mp
operator|->
name|m_sb
operator|.
name|sb_sectsize
argument_list|)
expr_stmt|;
name|agf
operator|->
name|agf_magicnum
operator|=
name|cpu_to_be32
argument_list|(
name|XFS_AGF_MAGIC
argument_list|)
expr_stmt|;
name|agf
operator|->
name|agf_versionnum
operator|=
name|cpu_to_be32
argument_list|(
name|XFS_AGF_VERSION
argument_list|)
expr_stmt|;
name|agf
operator|->
name|agf_seqno
operator|=
name|cpu_to_be32
argument_list|(
name|agno
argument_list|)
expr_stmt|;
if|if
condition|(
name|agno
operator|==
name|nagcount
operator|-
literal|1
condition|)
name|agsize
operator|=
name|nb
operator|-
operator|(
name|agno
operator|*
operator|(
name|xfs_rfsblock_t
operator|)
name|mp
operator|->
name|m_sb
operator|.
name|sb_agblocks
operator|)
expr_stmt|;
else|else
name|agsize
operator|=
name|mp
operator|->
name|m_sb
operator|.
name|sb_agblocks
expr_stmt|;
name|agf
operator|->
name|agf_length
operator|=
name|cpu_to_be32
argument_list|(
name|agsize
argument_list|)
expr_stmt|;
name|agf
operator|->
name|agf_roots
index|[
name|XFS_BTNUM_BNOi
index|]
operator|=
name|cpu_to_be32
argument_list|(
name|XFS_BNO_BLOCK
argument_list|(
name|mp
argument_list|)
argument_list|)
expr_stmt|;
name|agf
operator|->
name|agf_roots
index|[
name|XFS_BTNUM_CNTi
index|]
operator|=
name|cpu_to_be32
argument_list|(
name|XFS_CNT_BLOCK
argument_list|(
name|mp
argument_list|)
argument_list|)
expr_stmt|;
name|agf
operator|->
name|agf_levels
index|[
name|XFS_BTNUM_BNOi
index|]
operator|=
name|cpu_to_be32
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|agf
operator|->
name|agf_levels
index|[
name|XFS_BTNUM_CNTi
index|]
operator|=
name|cpu_to_be32
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|agf
operator|->
name|agf_flfirst
operator|=
literal|0
expr_stmt|;
name|agf
operator|->
name|agf_fllast
operator|=
name|cpu_to_be32
argument_list|(
name|XFS_AGFL_SIZE
argument_list|(
name|mp
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|agf
operator|->
name|agf_flcount
operator|=
literal|0
expr_stmt|;
name|tmpsize
operator|=
name|agsize
operator|-
name|XFS_PREALLOC_BLOCKS
argument_list|(
name|mp
argument_list|)
expr_stmt|;
name|agf
operator|->
name|agf_freeblks
operator|=
name|cpu_to_be32
argument_list|(
name|tmpsize
argument_list|)
expr_stmt|;
name|agf
operator|->
name|agf_longest
operator|=
name|cpu_to_be32
argument_list|(
name|tmpsize
argument_list|)
expr_stmt|;
name|error
operator|=
name|xfs_bwrite
argument_list|(
name|mp
argument_list|,
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
goto|goto
name|error0
goto|;
block|}
comment|/* 		 * AG inode header block 		 */
name|bp
operator|=
name|xfs_buf_get
argument_list|(
name|mp
operator|->
name|m_ddev_targp
argument_list|,
name|XFS_AG_DADDR
argument_list|(
name|mp
argument_list|,
name|agno
argument_list|,
name|XFS_AGI_DADDR
argument_list|(
name|mp
argument_list|)
argument_list|)
argument_list|,
name|XFS_FSS_TO_BB
argument_list|(
name|mp
argument_list|,
literal|1
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|agi
operator|=
name|XFS_BUF_TO_AGI
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|agi
argument_list|,
literal|0
argument_list|,
name|mp
operator|->
name|m_sb
operator|.
name|sb_sectsize
argument_list|)
expr_stmt|;
name|agi
operator|->
name|agi_magicnum
operator|=
name|cpu_to_be32
argument_list|(
name|XFS_AGI_MAGIC
argument_list|)
expr_stmt|;
name|agi
operator|->
name|agi_versionnum
operator|=
name|cpu_to_be32
argument_list|(
name|XFS_AGI_VERSION
argument_list|)
expr_stmt|;
name|agi
operator|->
name|agi_seqno
operator|=
name|cpu_to_be32
argument_list|(
name|agno
argument_list|)
expr_stmt|;
name|agi
operator|->
name|agi_length
operator|=
name|cpu_to_be32
argument_list|(
name|agsize
argument_list|)
expr_stmt|;
name|agi
operator|->
name|agi_count
operator|=
literal|0
expr_stmt|;
name|agi
operator|->
name|agi_root
operator|=
name|cpu_to_be32
argument_list|(
name|XFS_IBT_BLOCK
argument_list|(
name|mp
argument_list|)
argument_list|)
expr_stmt|;
name|agi
operator|->
name|agi_level
operator|=
name|cpu_to_be32
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|agi
operator|->
name|agi_freecount
operator|=
literal|0
expr_stmt|;
name|agi
operator|->
name|agi_newino
operator|=
name|cpu_to_be32
argument_list|(
name|NULLAGINO
argument_list|)
expr_stmt|;
name|agi
operator|->
name|agi_dirino
operator|=
name|cpu_to_be32
argument_list|(
name|NULLAGINO
argument_list|)
expr_stmt|;
for|for
control|(
name|bucket
operator|=
literal|0
init|;
name|bucket
operator|<
name|XFS_AGI_UNLINKED_BUCKETS
condition|;
name|bucket
operator|++
control|)
name|agi
operator|->
name|agi_unlinked
index|[
name|bucket
index|]
operator|=
name|cpu_to_be32
argument_list|(
name|NULLAGINO
argument_list|)
expr_stmt|;
name|error
operator|=
name|xfs_bwrite
argument_list|(
name|mp
argument_list|,
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
goto|goto
name|error0
goto|;
block|}
comment|/* 		 * BNO btree root block 		 */
name|bp
operator|=
name|xfs_buf_get
argument_list|(
name|mp
operator|->
name|m_ddev_targp
argument_list|,
name|XFS_AGB_TO_DADDR
argument_list|(
name|mp
argument_list|,
name|agno
argument_list|,
name|XFS_BNO_BLOCK
argument_list|(
name|mp
argument_list|)
argument_list|)
argument_list|,
name|BTOBB
argument_list|(
name|mp
operator|->
name|m_sb
operator|.
name|sb_blocksize
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|block
operator|=
name|XFS_BUF_TO_SBLOCK
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|block
argument_list|,
literal|0
argument_list|,
name|mp
operator|->
name|m_sb
operator|.
name|sb_blocksize
argument_list|)
expr_stmt|;
name|block
operator|->
name|bb_magic
operator|=
name|cpu_to_be32
argument_list|(
name|XFS_ABTB_MAGIC
argument_list|)
expr_stmt|;
name|block
operator|->
name|bb_level
operator|=
literal|0
expr_stmt|;
name|block
operator|->
name|bb_numrecs
operator|=
name|cpu_to_be16
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|block
operator|->
name|bb_leftsib
operator|=
name|cpu_to_be32
argument_list|(
name|NULLAGBLOCK
argument_list|)
expr_stmt|;
name|block
operator|->
name|bb_rightsib
operator|=
name|cpu_to_be32
argument_list|(
name|NULLAGBLOCK
argument_list|)
expr_stmt|;
name|arec
operator|=
name|XFS_BTREE_REC_ADDR
argument_list|(
name|mp
operator|->
name|m_sb
operator|.
name|sb_blocksize
argument_list|,
name|xfs_alloc
argument_list|,
name|block
argument_list|,
literal|1
argument_list|,
name|mp
operator|->
name|m_alloc_mxr
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|arec
operator|->
name|ar_startblock
operator|=
name|cpu_to_be32
argument_list|(
name|XFS_PREALLOC_BLOCKS
argument_list|(
name|mp
argument_list|)
argument_list|)
expr_stmt|;
name|arec
operator|->
name|ar_blockcount
operator|=
name|cpu_to_be32
argument_list|(
name|agsize
operator|-
name|be32_to_cpu
argument_list|(
name|arec
operator|->
name|ar_startblock
argument_list|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|xfs_bwrite
argument_list|(
name|mp
argument_list|,
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
goto|goto
name|error0
goto|;
block|}
comment|/* 		 * CNT btree root block 		 */
name|bp
operator|=
name|xfs_buf_get
argument_list|(
name|mp
operator|->
name|m_ddev_targp
argument_list|,
name|XFS_AGB_TO_DADDR
argument_list|(
name|mp
argument_list|,
name|agno
argument_list|,
name|XFS_CNT_BLOCK
argument_list|(
name|mp
argument_list|)
argument_list|)
argument_list|,
name|BTOBB
argument_list|(
name|mp
operator|->
name|m_sb
operator|.
name|sb_blocksize
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|block
operator|=
name|XFS_BUF_TO_SBLOCK
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|block
argument_list|,
literal|0
argument_list|,
name|mp
operator|->
name|m_sb
operator|.
name|sb_blocksize
argument_list|)
expr_stmt|;
name|block
operator|->
name|bb_magic
operator|=
name|cpu_to_be32
argument_list|(
name|XFS_ABTC_MAGIC
argument_list|)
expr_stmt|;
name|block
operator|->
name|bb_level
operator|=
literal|0
expr_stmt|;
name|block
operator|->
name|bb_numrecs
operator|=
name|cpu_to_be16
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|block
operator|->
name|bb_leftsib
operator|=
name|cpu_to_be32
argument_list|(
name|NULLAGBLOCK
argument_list|)
expr_stmt|;
name|block
operator|->
name|bb_rightsib
operator|=
name|cpu_to_be32
argument_list|(
name|NULLAGBLOCK
argument_list|)
expr_stmt|;
name|arec
operator|=
name|XFS_BTREE_REC_ADDR
argument_list|(
name|mp
operator|->
name|m_sb
operator|.
name|sb_blocksize
argument_list|,
name|xfs_alloc
argument_list|,
name|block
argument_list|,
literal|1
argument_list|,
name|mp
operator|->
name|m_alloc_mxr
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|arec
operator|->
name|ar_startblock
operator|=
name|cpu_to_be32
argument_list|(
name|XFS_PREALLOC_BLOCKS
argument_list|(
name|mp
argument_list|)
argument_list|)
expr_stmt|;
name|arec
operator|->
name|ar_blockcount
operator|=
name|cpu_to_be32
argument_list|(
name|agsize
operator|-
name|be32_to_cpu
argument_list|(
name|arec
operator|->
name|ar_startblock
argument_list|)
argument_list|)
expr_stmt|;
name|nfree
operator|+=
name|be32_to_cpu
argument_list|(
name|arec
operator|->
name|ar_blockcount
argument_list|)
expr_stmt|;
name|error
operator|=
name|xfs_bwrite
argument_list|(
name|mp
argument_list|,
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
goto|goto
name|error0
goto|;
block|}
comment|/* 		 * INO btree root block 		 */
name|bp
operator|=
name|xfs_buf_get
argument_list|(
name|mp
operator|->
name|m_ddev_targp
argument_list|,
name|XFS_AGB_TO_DADDR
argument_list|(
name|mp
argument_list|,
name|agno
argument_list|,
name|XFS_IBT_BLOCK
argument_list|(
name|mp
argument_list|)
argument_list|)
argument_list|,
name|BTOBB
argument_list|(
name|mp
operator|->
name|m_sb
operator|.
name|sb_blocksize
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|block
operator|=
name|XFS_BUF_TO_SBLOCK
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|block
argument_list|,
literal|0
argument_list|,
name|mp
operator|->
name|m_sb
operator|.
name|sb_blocksize
argument_list|)
expr_stmt|;
name|block
operator|->
name|bb_magic
operator|=
name|cpu_to_be32
argument_list|(
name|XFS_IBT_MAGIC
argument_list|)
expr_stmt|;
name|block
operator|->
name|bb_level
operator|=
literal|0
expr_stmt|;
name|block
operator|->
name|bb_numrecs
operator|=
literal|0
expr_stmt|;
name|block
operator|->
name|bb_leftsib
operator|=
name|cpu_to_be32
argument_list|(
name|NULLAGBLOCK
argument_list|)
expr_stmt|;
name|block
operator|->
name|bb_rightsib
operator|=
name|cpu_to_be32
argument_list|(
name|NULLAGBLOCK
argument_list|)
expr_stmt|;
name|error
operator|=
name|xfs_bwrite
argument_list|(
name|mp
argument_list|,
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
goto|goto
name|error0
goto|;
block|}
block|}
name|xfs_trans_agblocks_delta
argument_list|(
name|tp
argument_list|,
name|nfree
argument_list|)
expr_stmt|;
comment|/* 	 * There are new blocks in the old last a.g. 	 */
if|if
condition|(
name|new
condition|)
block|{
comment|/* 		 * Change the agi length. 		 */
name|error
operator|=
name|xfs_ialloc_read_agi
argument_list|(
name|mp
argument_list|,
name|tp
argument_list|,
name|agno
argument_list|,
operator|&
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
goto|goto
name|error0
goto|;
block|}
name|ASSERT
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|agi
operator|=
name|XFS_BUF_TO_AGI
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|be32_add
argument_list|(
operator|&
name|agi
operator|->
name|agi_length
argument_list|,
name|new
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|nagcount
operator|==
name|oagcount
operator|||
name|be32_to_cpu
argument_list|(
name|agi
operator|->
name|agi_length
argument_list|)
operator|==
name|mp
operator|->
name|m_sb
operator|.
name|sb_agblocks
argument_list|)
expr_stmt|;
name|xfs_ialloc_log_agi
argument_list|(
name|tp
argument_list|,
name|bp
argument_list|,
name|XFS_AGI_LENGTH
argument_list|)
expr_stmt|;
comment|/* 		 * Change agf length. 		 */
name|error
operator|=
name|xfs_alloc_read_agf
argument_list|(
name|mp
argument_list|,
name|tp
argument_list|,
name|agno
argument_list|,
literal|0
argument_list|,
operator|&
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
goto|goto
name|error0
goto|;
block|}
name|ASSERT
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|agf
operator|=
name|XFS_BUF_TO_AGF
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|be32_add
argument_list|(
operator|&
name|agf
operator|->
name|agf_length
argument_list|,
name|new
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|be32_to_cpu
argument_list|(
name|agf
operator|->
name|agf_length
argument_list|)
operator|==
name|be32_to_cpu
argument_list|(
name|agi
operator|->
name|agi_length
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 		 * Free the new space. 		 */
name|error
operator|=
name|xfs_free_extent
argument_list|(
name|tp
argument_list|,
name|XFS_AGB_TO_FSB
argument_list|(
name|mp
argument_list|,
name|agno
argument_list|,
name|be32_to_cpu
argument_list|(
name|agf
operator|->
name|agf_length
argument_list|)
operator|-
name|new
argument_list|)
argument_list|,
name|new
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
goto|goto
name|error0
goto|;
block|}
block|}
if|if
condition|(
name|nagcount
operator|>
name|oagcount
condition|)
name|xfs_trans_mod_sb
argument_list|(
name|tp
argument_list|,
name|XFS_TRANS_SB_AGCOUNT
argument_list|,
name|nagcount
operator|-
name|oagcount
argument_list|)
expr_stmt|;
if|if
condition|(
name|nb
operator|>
name|mp
operator|->
name|m_sb
operator|.
name|sb_dblocks
condition|)
name|xfs_trans_mod_sb
argument_list|(
name|tp
argument_list|,
name|XFS_TRANS_SB_DBLOCKS
argument_list|,
name|nb
operator|-
name|mp
operator|->
name|m_sb
operator|.
name|sb_dblocks
argument_list|)
expr_stmt|;
if|if
condition|(
name|nfree
condition|)
name|xfs_trans_mod_sb
argument_list|(
name|tp
argument_list|,
name|XFS_TRANS_SB_FDBLOCKS
argument_list|,
name|nfree
argument_list|)
expr_stmt|;
if|if
condition|(
name|dpct
condition|)
name|xfs_trans_mod_sb
argument_list|(
name|tp
argument_list|,
name|XFS_TRANS_SB_IMAXPCT
argument_list|,
name|dpct
argument_list|)
expr_stmt|;
name|error
operator|=
name|xfs_trans_commit
argument_list|(
name|tp
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
return|return
name|error
return|;
block|}
comment|/* New allocation groups fully initialized, so update mount struct */
if|if
condition|(
name|nagimax
condition|)
name|mp
operator|->
name|m_maxagi
operator|=
name|nagimax
expr_stmt|;
if|if
condition|(
name|mp
operator|->
name|m_sb
operator|.
name|sb_imax_pct
condition|)
block|{
name|__uint64_t
name|icount
init|=
name|mp
operator|->
name|m_sb
operator|.
name|sb_dblocks
operator|*
name|mp
operator|->
name|m_sb
operator|.
name|sb_imax_pct
decl_stmt|;
name|do_div
argument_list|(
name|icount
argument_list|,
literal|100
argument_list|)
expr_stmt|;
name|mp
operator|->
name|m_maxicount
operator|=
name|icount
operator|<<
name|mp
operator|->
name|m_sb
operator|.
name|sb_inopblog
expr_stmt|;
block|}
else|else
name|mp
operator|->
name|m_maxicount
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|agno
operator|=
literal|1
init|;
name|agno
operator|<
name|nagcount
condition|;
name|agno
operator|++
control|)
block|{
name|error
operator|=
name|xfs_read_buf
argument_list|(
name|mp
argument_list|,
name|mp
operator|->
name|m_ddev_targp
argument_list|,
name|XFS_AGB_TO_DADDR
argument_list|(
name|mp
argument_list|,
name|agno
argument_list|,
name|XFS_SB_BLOCK
argument_list|(
name|mp
argument_list|)
argument_list|)
argument_list|,
name|XFS_FSS_TO_BB
argument_list|(
name|mp
argument_list|,
literal|1
argument_list|)
argument_list|,
literal|0
argument_list|,
operator|&
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|xfs_fs_cmn_err
argument_list|(
name|CE_WARN
argument_list|,
name|mp
argument_list|,
literal|"error %d reading secondary superblock for ag %d"
argument_list|,
name|error
argument_list|,
name|agno
argument_list|)
expr_stmt|;
break|break;
block|}
name|sbp
operator|=
name|XFS_BUF_TO_SBP
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|xfs_xlatesb
argument_list|(
name|sbp
argument_list|,
operator|&
name|mp
operator|->
name|m_sb
argument_list|,
operator|-
literal|1
argument_list|,
name|XFS_SB_ALL_BITS
argument_list|)
expr_stmt|;
comment|/* 		 * If we get an error writing out the alternate superblocks, 		 * just issue a warning and continue.  The real work is 		 * already done and committed. 		 */
if|if
condition|(
operator|!
operator|(
name|error
operator|=
name|xfs_bwrite
argument_list|(
name|mp
argument_list|,
name|bp
argument_list|)
operator|)
condition|)
block|{
continue|continue;
block|}
else|else
block|{
name|xfs_fs_cmn_err
argument_list|(
name|CE_WARN
argument_list|,
name|mp
argument_list|,
literal|"write error %d updating secondary superblock for ag %d"
argument_list|,
name|error
argument_list|,
name|agno
argument_list|)
expr_stmt|;
break|break;
comment|/* no point in continuing */
block|}
block|}
return|return
literal|0
return|;
name|error0
label|:
name|xfs_trans_cancel
argument_list|(
name|tp
argument_list|,
name|XFS_TRANS_ABORT
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|xfs_growfs_log_private
parameter_list|(
name|xfs_mount_t
modifier|*
name|mp
parameter_list|,
comment|/* mount point for filesystem */
name|xfs_growfs_log_t
modifier|*
name|in
parameter_list|)
comment|/* growfs log input struct */
block|{
name|xfs_extlen_t
name|nb
decl_stmt|;
name|nb
operator|=
name|in
operator|->
name|newblocks
expr_stmt|;
if|if
condition|(
name|nb
operator|<
name|XFS_MIN_LOG_BLOCKS
operator|||
name|nb
operator|<
name|XFS_B_TO_FSB
argument_list|(
name|mp
argument_list|,
name|XFS_MIN_LOG_BYTES
argument_list|)
condition|)
return|return
name|XFS_ERROR
argument_list|(
name|EINVAL
argument_list|)
return|;
if|if
condition|(
name|nb
operator|==
name|mp
operator|->
name|m_sb
operator|.
name|sb_logblocks
operator|&&
name|in
operator|->
name|isint
operator|==
operator|(
name|mp
operator|->
name|m_sb
operator|.
name|sb_logstart
operator|!=
literal|0
operator|)
condition|)
return|return
name|XFS_ERROR
argument_list|(
name|EINVAL
argument_list|)
return|;
comment|/* 	 * Moving the log is hard, need new interfaces to sync 	 * the log first, hold off all activity while moving it. 	 * Can have shorter or longer log in the same space, 	 * or transform internal to external log or vice versa. 	 */
return|return
name|XFS_ERROR
argument_list|(
name|ENOSYS
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  * protected versions of growfs function acquire and release locks on the mount  * point - exported through ioctls: XFS_IOC_FSGROWFSDATA, XFS_IOC_FSGROWFSLOG,  * XFS_IOC_FSGROWFSRT  */
end_comment

begin_function
name|int
name|xfs_growfs_data
parameter_list|(
name|xfs_mount_t
modifier|*
name|mp
parameter_list|,
name|xfs_growfs_data_t
modifier|*
name|in
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
if|if
condition|(
operator|!
name|cpsema
argument_list|(
operator|&
name|mp
operator|->
name|m_growlock
argument_list|)
condition|)
return|return
name|XFS_ERROR
argument_list|(
name|EWOULDBLOCK
argument_list|)
return|;
name|error
operator|=
name|xfs_growfs_data_private
argument_list|(
name|mp
argument_list|,
name|in
argument_list|)
expr_stmt|;
name|vsema
argument_list|(
operator|&
name|mp
operator|->
name|m_growlock
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_function
name|int
name|xfs_growfs_log
parameter_list|(
name|xfs_mount_t
modifier|*
name|mp
parameter_list|,
name|xfs_growfs_log_t
modifier|*
name|in
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
if|if
condition|(
operator|!
name|cpsema
argument_list|(
operator|&
name|mp
operator|->
name|m_growlock
argument_list|)
condition|)
return|return
name|XFS_ERROR
argument_list|(
name|EWOULDBLOCK
argument_list|)
return|;
name|error
operator|=
name|xfs_growfs_log_private
argument_list|(
name|mp
argument_list|,
name|in
argument_list|)
expr_stmt|;
name|vsema
argument_list|(
operator|&
name|mp
operator|->
name|m_growlock
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_comment
comment|/*  * exported through ioctl XFS_IOC_FSCOUNTS  */
end_comment

begin_function
name|int
name|xfs_fs_counts
parameter_list|(
name|xfs_mount_t
modifier|*
name|mp
parameter_list|,
name|xfs_fsop_counts_t
modifier|*
name|cnt
parameter_list|)
block|{
name|unsigned
name|long
name|s
decl_stmt|;
name|xfs_icsb_sync_counters_lazy
argument_list|(
name|mp
argument_list|)
expr_stmt|;
name|s
operator|=
name|XFS_SB_LOCK
argument_list|(
name|mp
argument_list|)
expr_stmt|;
name|cnt
operator|->
name|freedata
operator|=
name|mp
operator|->
name|m_sb
operator|.
name|sb_fdblocks
expr_stmt|;
name|cnt
operator|->
name|freertx
operator|=
name|mp
operator|->
name|m_sb
operator|.
name|sb_frextents
expr_stmt|;
name|cnt
operator|->
name|freeino
operator|=
name|mp
operator|->
name|m_sb
operator|.
name|sb_ifree
expr_stmt|;
name|cnt
operator|->
name|allocino
operator|=
name|mp
operator|->
name|m_sb
operator|.
name|sb_icount
expr_stmt|;
name|XFS_SB_UNLOCK
argument_list|(
name|mp
argument_list|,
name|s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * exported through ioctl XFS_IOC_SET_RESBLKS& XFS_IOC_GET_RESBLKS  *  * xfs_reserve_blocks is called to set m_resblks  * in the in-core mount table. The number of unused reserved blocks  * is kept in m_resblks_avail.  *  * Reserve the requested number of blocks if available. Otherwise return  * as many as possible to satisfy the request. The actual number  * reserved are returned in outval  *  * A null inval pointer indicates that only the current reserved blocks  * available  should  be returned no settings are changed.  */
end_comment

begin_function
name|int
name|xfs_reserve_blocks
parameter_list|(
name|xfs_mount_t
modifier|*
name|mp
parameter_list|,
name|__uint64_t
modifier|*
name|inval
parameter_list|,
name|xfs_fsop_resblks_t
modifier|*
name|outval
parameter_list|)
block|{
name|__int64_t
name|lcounter
decl_stmt|,
name|delta
decl_stmt|;
name|__uint64_t
name|request
decl_stmt|;
name|unsigned
name|long
name|s
decl_stmt|;
comment|/* If inval is null, report current values and return */
if|if
condition|(
name|inval
operator|==
operator|(
name|__uint64_t
operator|*
operator|)
name|NULL
condition|)
block|{
name|outval
operator|->
name|resblks
operator|=
name|mp
operator|->
name|m_resblks
expr_stmt|;
name|outval
operator|->
name|resblks_avail
operator|=
name|mp
operator|->
name|m_resblks_avail
expr_stmt|;
return|return
literal|0
return|;
block|}
name|request
operator|=
operator|*
name|inval
expr_stmt|;
name|s
operator|=
name|XFS_SB_LOCK
argument_list|(
name|mp
argument_list|)
expr_stmt|;
comment|/* 	 * If our previous reservation was larger than the current value, 	 * then move any unused blocks back to the free pool. 	 */
if|if
condition|(
name|mp
operator|->
name|m_resblks
operator|>
name|request
condition|)
block|{
name|lcounter
operator|=
name|mp
operator|->
name|m_resblks_avail
operator|-
name|request
expr_stmt|;
if|if
condition|(
name|lcounter
operator|>
literal|0
condition|)
block|{
comment|/* release unused blocks */
name|mp
operator|->
name|m_sb
operator|.
name|sb_fdblocks
operator|+=
name|lcounter
expr_stmt|;
name|mp
operator|->
name|m_resblks_avail
operator|-=
name|lcounter
expr_stmt|;
block|}
name|mp
operator|->
name|m_resblks
operator|=
name|request
expr_stmt|;
block|}
else|else
block|{
name|delta
operator|=
name|request
operator|-
name|mp
operator|->
name|m_resblks
expr_stmt|;
name|lcounter
operator|=
name|mp
operator|->
name|m_sb
operator|.
name|sb_fdblocks
operator|-
name|delta
expr_stmt|;
if|if
condition|(
name|lcounter
operator|<
literal|0
condition|)
block|{
comment|/* We can't satisfy the request, just get what we can */
name|mp
operator|->
name|m_resblks
operator|+=
name|mp
operator|->
name|m_sb
operator|.
name|sb_fdblocks
expr_stmt|;
name|mp
operator|->
name|m_resblks_avail
operator|+=
name|mp
operator|->
name|m_sb
operator|.
name|sb_fdblocks
expr_stmt|;
name|mp
operator|->
name|m_sb
operator|.
name|sb_fdblocks
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|mp
operator|->
name|m_sb
operator|.
name|sb_fdblocks
operator|=
name|lcounter
expr_stmt|;
name|mp
operator|->
name|m_resblks
operator|=
name|request
expr_stmt|;
name|mp
operator|->
name|m_resblks_avail
operator|+=
name|delta
expr_stmt|;
block|}
block|}
name|outval
operator|->
name|resblks
operator|=
name|mp
operator|->
name|m_resblks
expr_stmt|;
name|outval
operator|->
name|resblks_avail
operator|=
name|mp
operator|->
name|m_resblks_avail
expr_stmt|;
name|XFS_SB_UNLOCK
argument_list|(
name|mp
argument_list|,
name|s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|xfs_fs_log_dummy
parameter_list|(
name|xfs_mount_t
modifier|*
name|mp
parameter_list|)
block|{
name|xfs_trans_t
modifier|*
name|tp
decl_stmt|;
name|xfs_inode_t
modifier|*
name|ip
decl_stmt|;
name|tp
operator|=
name|_xfs_trans_alloc
argument_list|(
name|mp
argument_list|,
name|XFS_TRANS_DUMMY1
argument_list|)
expr_stmt|;
name|atomic_inc
argument_list|(
operator|&
name|mp
operator|->
name|m_active_trans
argument_list|)
expr_stmt|;
if|if
condition|(
name|xfs_trans_reserve
argument_list|(
name|tp
argument_list|,
literal|0
argument_list|,
name|XFS_ICHANGE_LOG_RES
argument_list|(
name|mp
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|xfs_trans_cancel
argument_list|(
name|tp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
name|ip
operator|=
name|mp
operator|->
name|m_rootip
expr_stmt|;
name|xfs_ilock
argument_list|(
name|ip
argument_list|,
name|XFS_ILOCK_EXCL
argument_list|)
expr_stmt|;
name|xfs_trans_ijoin
argument_list|(
name|tp
argument_list|,
name|ip
argument_list|,
name|XFS_ILOCK_EXCL
argument_list|)
expr_stmt|;
name|xfs_trans_ihold
argument_list|(
name|tp
argument_list|,
name|ip
argument_list|)
expr_stmt|;
name|xfs_trans_log_inode
argument_list|(
name|tp
argument_list|,
name|ip
argument_list|,
name|XFS_ILOG_CORE
argument_list|)
expr_stmt|;
name|xfs_trans_set_sync
argument_list|(
name|tp
argument_list|)
expr_stmt|;
name|xfs_trans_commit
argument_list|(
name|tp
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|xfs_iunlock
argument_list|(
name|ip
argument_list|,
name|XFS_ILOCK_EXCL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|xfs_fs_goingdown
parameter_list|(
name|xfs_mount_t
modifier|*
name|mp
parameter_list|,
name|__uint32_t
name|inflags
parameter_list|)
block|{
switch|switch
condition|(
name|inflags
condition|)
block|{
case|case
name|XFS_FSOP_GOING_FLAGS_DEFAULT
case|:
block|{
ifdef|#
directive|ifdef
name|RMC
name|struct
name|xfs_vfs
modifier|*
name|vfsp
init|=
name|XFS_MTOVFS
argument_list|(
name|mp
argument_list|)
decl_stmt|;
name|struct
name|super_block
modifier|*
name|sb
init|=
name|freeze_bdev
argument_list|(
name|vfsp
operator|->
name|vfs_super
operator|->
name|s_bdev
argument_list|)
decl_stmt|;
if|if
condition|(
name|sb
operator|&&
operator|!
name|IS_ERR
argument_list|(
name|sb
argument_list|)
condition|)
block|{
name|xfs_force_shutdown
argument_list|(
name|mp
argument_list|,
name|XFS_FORCE_UMOUNT
argument_list|)
expr_stmt|;
name|thaw_bdev
argument_list|(
name|sb
operator|->
name|s_bdev
argument_list|,
name|sb
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
break|break;
block|}
case|case
name|XFS_FSOP_GOING_FLAGS_LOGFLUSH
case|:
name|xfs_force_shutdown
argument_list|(
name|mp
argument_list|,
name|XFS_FORCE_UMOUNT
argument_list|)
expr_stmt|;
break|break;
case|case
name|XFS_FSOP_GOING_FLAGS_NOLOGFLUSH
case|:
name|xfs_force_shutdown
argument_list|(
name|mp
argument_list|,
name|XFS_FORCE_UMOUNT
operator||
name|XFS_LOG_IO_ERROR
argument_list|)
expr_stmt|;
break|break;
default|default:
return|return
name|XFS_ERROR
argument_list|(
name|EINVAL
argument_list|)
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

end_unit


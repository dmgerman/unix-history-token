begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2000-2003 Silicon Graphics, Inc.  All Rights Reserved.  *  * This program is free software; you can redistribute it and/or modify it  * under the terms of version 2 of the GNU General Public License as  * published by the Free Software Foundation.  *  * This program is distributed in the hope that it would be useful, but  * WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  *  * Further, this software is distributed without any warranty that it is  * free of the rightful claim of any third person regarding infringement  * or the like.  Any license provided herein, whether implied or  * otherwise, applies only to this software file.  Patent licenses, if  * any, provided herein do not apply to combinations of this program with  * other software, or any other product whatsoever.  *  * You should have received a copy of the GNU General Public License along  * with this program; if not, write the Free Software Foundation, Inc., 59  * Temple Place - Suite 330, Boston MA 02111-1307, USA.  *  * Contact information: Silicon Graphics, Inc., 1600 Amphitheatre Pkwy,  * Mountain View, CA  94043, or:  *  * http://www.sgi.com  *  * For further information regarding this notice, see:  *  * http://oss.sgi.com/projects/GenInfo/SGIGPLNoticeExplan/  */
end_comment

begin_comment
comment|/*  * xfs_dir2_block.c  * XFS V2 directory implementation, single-block form.  * See xfs_dir2_block.h for the format.  */
end_comment

begin_include
include|#
directive|include
file|"xfs.h"
end_include

begin_include
include|#
directive|include
file|"xfs_macros.h"
end_include

begin_include
include|#
directive|include
file|"xfs_types.h"
end_include

begin_include
include|#
directive|include
file|"xfs_inum.h"
end_include

begin_include
include|#
directive|include
file|"xfs_log.h"
end_include

begin_include
include|#
directive|include
file|"xfs_trans.h"
end_include

begin_include
include|#
directive|include
file|"xfs_sb.h"
end_include

begin_include
include|#
directive|include
file|"xfs_dir.h"
end_include

begin_include
include|#
directive|include
file|"xfs_dir2.h"
end_include

begin_include
include|#
directive|include
file|"xfs_dmapi.h"
end_include

begin_include
include|#
directive|include
file|"xfs_mount.h"
end_include

begin_include
include|#
directive|include
file|"xfs_bmap_btree.h"
end_include

begin_include
include|#
directive|include
file|"xfs_attr_sf.h"
end_include

begin_include
include|#
directive|include
file|"xfs_dir_sf.h"
end_include

begin_include
include|#
directive|include
file|"xfs_dir2_sf.h"
end_include

begin_include
include|#
directive|include
file|"xfs_dinode.h"
end_include

begin_include
include|#
directive|include
file|"xfs_inode_item.h"
end_include

begin_include
include|#
directive|include
file|"xfs_inode.h"
end_include

begin_include
include|#
directive|include
file|"xfs_da_btree.h"
end_include

begin_include
include|#
directive|include
file|"xfs_dir_leaf.h"
end_include

begin_include
include|#
directive|include
file|"xfs_dir2_data.h"
end_include

begin_include
include|#
directive|include
file|"xfs_dir2_leaf.h"
end_include

begin_include
include|#
directive|include
file|"xfs_dir2_block.h"
end_include

begin_include
include|#
directive|include
file|"xfs_dir2_trace.h"
end_include

begin_include
include|#
directive|include
file|"xfs_error.h"
end_include

begin_comment
comment|/*  * Local function prototypes.  */
end_comment

begin_function_decl
specifier|static
name|void
name|xfs_dir2_block_log_leaf
parameter_list|(
name|xfs_trans_t
modifier|*
name|tp
parameter_list|,
name|xfs_dabuf_t
modifier|*
name|bp
parameter_list|,
name|int
name|first
parameter_list|,
name|int
name|last
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|xfs_dir2_block_log_tail
parameter_list|(
name|xfs_trans_t
modifier|*
name|tp
parameter_list|,
name|xfs_dabuf_t
modifier|*
name|bp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|xfs_dir2_block_lookup_int
parameter_list|(
name|xfs_da_args_t
modifier|*
name|args
parameter_list|,
name|xfs_dabuf_t
modifier|*
modifier|*
name|bpp
parameter_list|,
name|int
modifier|*
name|entno
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|xfs_dir2_block_sort
parameter_list|(
specifier|const
name|void
modifier|*
name|a
parameter_list|,
specifier|const
name|void
modifier|*
name|b
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * Add an entry to a block directory.  */
end_comment

begin_function
name|int
comment|/* error */
name|xfs_dir2_block_addname
parameter_list|(
name|xfs_da_args_t
modifier|*
name|args
parameter_list|)
comment|/* directory op arguments */
block|{
name|xfs_dir2_data_free_t
modifier|*
name|bf
decl_stmt|;
comment|/* bestfree table in block */
name|xfs_dir2_block_t
modifier|*
name|block
decl_stmt|;
comment|/* directory block structure */
name|xfs_dir2_leaf_entry_t
modifier|*
name|blp
decl_stmt|;
comment|/* block leaf entries */
name|xfs_dabuf_t
modifier|*
name|bp
decl_stmt|;
comment|/* buffer for block */
name|xfs_dir2_block_tail_t
modifier|*
name|btp
decl_stmt|;
comment|/* block tail */
name|int
name|compact
decl_stmt|;
comment|/* need to compact leaf ents */
name|xfs_dir2_data_entry_t
modifier|*
name|dep
decl_stmt|;
comment|/* block data entry */
name|xfs_inode_t
modifier|*
name|dp
decl_stmt|;
comment|/* directory inode */
name|xfs_dir2_data_unused_t
modifier|*
name|dup
decl_stmt|;
comment|/* block unused entry */
name|int
name|error
decl_stmt|;
comment|/* error return value */
name|xfs_dir2_data_unused_t
modifier|*
name|enddup
init|=
name|NULL
decl_stmt|;
comment|/* unused at end of data */
name|xfs_dahash_t
name|hash
decl_stmt|;
comment|/* hash value of found entry */
name|int
name|high
decl_stmt|;
comment|/* high index for binary srch */
name|int
name|highstale
decl_stmt|;
comment|/* high stale index */
name|int
name|lfloghigh
init|=
literal|0
decl_stmt|;
comment|/* last final leaf to log */
name|int
name|lfloglow
init|=
literal|0
decl_stmt|;
comment|/* first final leaf to log */
name|int
name|len
decl_stmt|;
comment|/* length of the new entry */
name|int
name|low
decl_stmt|;
comment|/* low index for binary srch */
name|int
name|lowstale
decl_stmt|;
comment|/* low stale index */
name|int
name|mid
init|=
literal|0
decl_stmt|;
comment|/* midpoint for binary srch */
name|xfs_mount_t
modifier|*
name|mp
decl_stmt|;
comment|/* filesystem mount point */
name|int
name|needlog
decl_stmt|;
comment|/* need to log header */
name|int
name|needscan
decl_stmt|;
comment|/* need to rescan freespace */
name|xfs_dir2_data_off_t
modifier|*
name|tagp
decl_stmt|;
comment|/* pointer to tag value */
name|xfs_trans_t
modifier|*
name|tp
decl_stmt|;
comment|/* transaction structure */
name|xfs_dir2_trace_args
argument_list|(
literal|"block_addname"
argument_list|,
name|args
argument_list|)
expr_stmt|;
name|dp
operator|=
name|args
operator|->
name|dp
expr_stmt|;
name|tp
operator|=
name|args
operator|->
name|trans
expr_stmt|;
name|mp
operator|=
name|dp
operator|->
name|i_mount
expr_stmt|;
comment|/* 	 * Read the (one and only) directory block into dabuf bp. 	 */
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_da_read_buf
argument_list|(
name|tp
argument_list|,
name|dp
argument_list|,
name|mp
operator|->
name|m_dirdatablk
argument_list|,
operator|-
literal|1
argument_list|,
operator|&
name|bp
argument_list|,
name|XFS_DATA_FORK
argument_list|)
operator|)
condition|)
block|{
return|return
name|error
return|;
block|}
name|ASSERT
argument_list|(
name|bp
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|block
operator|=
name|bp
operator|->
name|data
expr_stmt|;
comment|/* 	 * Check the magic number, corrupted if wrong. 	 */
if|if
condition|(
name|unlikely
argument_list|(
name|INT_GET
argument_list|(
name|block
operator|->
name|hdr
operator|.
name|magic
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|!=
name|XFS_DIR2_BLOCK_MAGIC
argument_list|)
condition|)
block|{
name|XFS_CORRUPTION_ERROR
argument_list|(
literal|"xfs_dir2_block_addname"
argument_list|,
name|XFS_ERRLEVEL_LOW
argument_list|,
name|mp
argument_list|,
name|block
argument_list|)
expr_stmt|;
name|xfs_da_brelse
argument_list|(
name|tp
argument_list|,
name|bp
argument_list|)
expr_stmt|;
return|return
name|XFS_ERROR
argument_list|(
name|EFSCORRUPTED
argument_list|)
return|;
block|}
name|len
operator|=
name|XFS_DIR2_DATA_ENTSIZE
argument_list|(
name|args
operator|->
name|namelen
argument_list|)
expr_stmt|;
comment|/* 	 * Set up pointers to parts of the block. 	 */
name|bf
operator|=
name|block
operator|->
name|hdr
operator|.
name|bestfree
expr_stmt|;
name|btp
operator|=
name|XFS_DIR2_BLOCK_TAIL_P
argument_list|(
name|mp
argument_list|,
name|block
argument_list|)
expr_stmt|;
name|blp
operator|=
name|XFS_DIR2_BLOCK_LEAF_P_ARCH
argument_list|(
name|btp
argument_list|,
name|ARCH_CONVERT
argument_list|)
expr_stmt|;
comment|/* 	 * No stale entries?  Need space for entry and new leaf. 	 */
if|if
condition|(
name|INT_ISZERO
argument_list|(
name|btp
operator|->
name|stale
argument_list|,
name|ARCH_CONVERT
argument_list|)
condition|)
block|{
comment|/* 		 * Tag just before the first leaf entry. 		 */
name|tagp
operator|=
operator|(
name|xfs_dir2_data_off_t
operator|*
operator|)
name|blp
operator|-
literal|1
expr_stmt|;
comment|/* 		 * Data object just before the first leaf entry. 		 */
name|enddup
operator|=
operator|(
name|xfs_dir2_data_unused_t
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|block
operator|+
name|INT_GET
argument_list|(
operator|*
name|tagp
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|)
expr_stmt|;
comment|/* 		 * If it's not free then can't do this add without cleaning up: 		 * the space before the first leaf entry needs to be free so it 		 * can be expanded to hold the pointer to the new entry. 		 */
if|if
condition|(
name|INT_GET
argument_list|(
name|enddup
operator|->
name|freetag
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|!=
name|XFS_DIR2_DATA_FREE_TAG
condition|)
name|dup
operator|=
name|enddup
operator|=
name|NULL
expr_stmt|;
comment|/* 		 * Check out the biggest freespace and see if it's the same one. 		 */
else|else
block|{
name|dup
operator|=
operator|(
name|xfs_dir2_data_unused_t
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|block
operator|+
name|INT_GET
argument_list|(
name|bf
index|[
literal|0
index|]
operator|.
name|offset
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
name|dup
operator|==
name|enddup
condition|)
block|{
comment|/* 				 * It is the biggest freespace, is it too small 				 * to hold the new leaf too? 				 */
if|if
condition|(
name|INT_GET
argument_list|(
name|dup
operator|->
name|length
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|<
name|len
operator|+
operator|(
name|uint
operator|)
sizeof|sizeof
argument_list|(
operator|*
name|blp
argument_list|)
condition|)
block|{
comment|/* 					 * Yes, we use the second-largest 					 * entry instead if it works. 					 */
if|if
condition|(
name|INT_GET
argument_list|(
name|bf
index|[
literal|1
index|]
operator|.
name|length
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|>=
name|len
condition|)
name|dup
operator|=
operator|(
name|xfs_dir2_data_unused_t
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|block
operator|+
name|INT_GET
argument_list|(
name|bf
index|[
literal|1
index|]
operator|.
name|offset
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|)
expr_stmt|;
else|else
name|dup
operator|=
name|NULL
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* 				 * Not the same free entry, 				 * just check its length. 				 */
if|if
condition|(
name|INT_GET
argument_list|(
name|dup
operator|->
name|length
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|<
name|len
condition|)
block|{
name|dup
operator|=
name|NULL
expr_stmt|;
block|}
block|}
block|}
name|compact
operator|=
literal|0
expr_stmt|;
block|}
comment|/* 	 * If there are stale entries we'll use one for the leaf. 	 * Is the biggest entry enough to avoid compaction? 	 */
elseif|else
if|if
condition|(
name|INT_GET
argument_list|(
name|bf
index|[
literal|0
index|]
operator|.
name|length
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|>=
name|len
condition|)
block|{
name|dup
operator|=
operator|(
name|xfs_dir2_data_unused_t
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|block
operator|+
name|INT_GET
argument_list|(
name|bf
index|[
literal|0
index|]
operator|.
name|offset
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|)
expr_stmt|;
name|compact
operator|=
literal|0
expr_stmt|;
block|}
comment|/* 	 * Will need to compact to make this work. 	 */
else|else
block|{
comment|/* 		 * Tag just before the first leaf entry. 		 */
name|tagp
operator|=
operator|(
name|xfs_dir2_data_off_t
operator|*
operator|)
name|blp
operator|-
literal|1
expr_stmt|;
comment|/* 		 * Data object just before the first leaf entry. 		 */
name|dup
operator|=
operator|(
name|xfs_dir2_data_unused_t
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|block
operator|+
name|INT_GET
argument_list|(
operator|*
name|tagp
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|)
expr_stmt|;
comment|/* 		 * If it's not free then the data will go where the 		 * leaf data starts now, if it works at all. 		 */
if|if
condition|(
name|INT_GET
argument_list|(
name|dup
operator|->
name|freetag
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|==
name|XFS_DIR2_DATA_FREE_TAG
condition|)
block|{
if|if
condition|(
name|INT_GET
argument_list|(
name|dup
operator|->
name|length
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|+
operator|(
name|INT_GET
argument_list|(
name|btp
operator|->
name|stale
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|-
literal|1
operator|)
operator|*
operator|(
name|uint
operator|)
sizeof|sizeof
argument_list|(
operator|*
name|blp
argument_list|)
operator|<
name|len
condition|)
name|dup
operator|=
name|NULL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|INT_GET
argument_list|(
name|btp
operator|->
name|stale
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|-
literal|1
operator|)
operator|*
operator|(
name|uint
operator|)
sizeof|sizeof
argument_list|(
operator|*
name|blp
argument_list|)
operator|<
name|len
condition|)
name|dup
operator|=
name|NULL
expr_stmt|;
else|else
name|dup
operator|=
operator|(
name|xfs_dir2_data_unused_t
operator|*
operator|)
name|blp
expr_stmt|;
name|compact
operator|=
literal|1
expr_stmt|;
block|}
comment|/* 	 * If this isn't a real add, we're done with the buffer. 	 */
if|if
condition|(
name|args
operator|->
name|justcheck
condition|)
name|xfs_da_brelse
argument_list|(
name|tp
argument_list|,
name|bp
argument_list|)
expr_stmt|;
comment|/* 	 * If we don't have space for the new entry& leaf ... 	 */
if|if
condition|(
operator|!
name|dup
condition|)
block|{
comment|/* 		 * Not trying to actually do anything, or don't have 		 * a space reservation: return no-space. 		 */
if|if
condition|(
name|args
operator|->
name|justcheck
operator|||
name|args
operator|->
name|total
operator|==
literal|0
condition|)
return|return
name|XFS_ERROR
argument_list|(
name|ENOSPC
argument_list|)
return|;
comment|/* 		 * Convert to the next larger format. 		 * Then add the new entry in that format. 		 */
name|error
operator|=
name|xfs_dir2_block_to_leaf
argument_list|(
name|args
argument_list|,
name|bp
argument_list|)
expr_stmt|;
name|xfs_da_buf_done
argument_list|(
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
return|return
name|xfs_dir2_leaf_addname
argument_list|(
name|args
argument_list|)
return|;
block|}
comment|/* 	 * Just checking, and it would work, so say so. 	 */
if|if
condition|(
name|args
operator|->
name|justcheck
condition|)
return|return
literal|0
return|;
name|needlog
operator|=
name|needscan
operator|=
literal|0
expr_stmt|;
comment|/* 	 * If need to compact the leaf entries, do it now. 	 * Leave the highest-numbered stale entry stale. 	 * XXX should be the one closest to mid but mid is not yet computed. 	 */
if|if
condition|(
name|compact
condition|)
block|{
name|int
name|fromidx
decl_stmt|;
comment|/* source leaf index */
name|int
name|toidx
decl_stmt|;
comment|/* target leaf index */
for|for
control|(
name|fromidx
operator|=
name|toidx
operator|=
name|INT_GET
argument_list|(
name|btp
operator|->
name|count
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|-
literal|1
operator|,
name|highstale
operator|=
name|lfloghigh
operator|=
operator|-
literal|1
init|;
name|fromidx
operator|>=
literal|0
condition|;
name|fromidx
operator|--
control|)
block|{
if|if
condition|(
name|INT_GET
argument_list|(
name|blp
index|[
name|fromidx
index|]
operator|.
name|address
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|==
name|XFS_DIR2_NULL_DATAPTR
condition|)
block|{
if|if
condition|(
name|highstale
operator|==
operator|-
literal|1
condition|)
name|highstale
operator|=
name|toidx
expr_stmt|;
else|else
block|{
if|if
condition|(
name|lfloghigh
operator|==
operator|-
literal|1
condition|)
name|lfloghigh
operator|=
name|toidx
expr_stmt|;
continue|continue;
block|}
block|}
if|if
condition|(
name|fromidx
operator|<
name|toidx
condition|)
name|blp
index|[
name|toidx
index|]
operator|=
name|blp
index|[
name|fromidx
index|]
expr_stmt|;
name|toidx
operator|--
expr_stmt|;
block|}
name|lfloglow
operator|=
name|toidx
operator|+
literal|1
operator|-
operator|(
name|INT_GET
argument_list|(
name|btp
operator|->
name|stale
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|-
literal|1
operator|)
expr_stmt|;
name|lfloghigh
operator|-=
name|INT_GET
argument_list|(
name|btp
operator|->
name|stale
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|-
literal|1
expr_stmt|;
name|INT_MOD
argument_list|(
name|btp
operator|->
name|count
argument_list|,
name|ARCH_CONVERT
argument_list|,
operator|-
operator|(
name|INT_GET
argument_list|(
name|btp
operator|->
name|stale
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
name|xfs_dir2_data_make_free
argument_list|(
name|tp
argument_list|,
name|bp
argument_list|,
call|(
name|xfs_dir2_data_aoff_t
call|)
argument_list|(
operator|(
name|char
operator|*
operator|)
name|blp
operator|-
operator|(
name|char
operator|*
operator|)
name|block
argument_list|)
argument_list|,
call|(
name|xfs_dir2_data_aoff_t
call|)
argument_list|(
operator|(
name|INT_GET
argument_list|(
name|btp
operator|->
name|stale
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|-
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|blp
argument_list|)
argument_list|)
argument_list|,
operator|&
name|needlog
argument_list|,
operator|&
name|needscan
argument_list|)
expr_stmt|;
name|blp
operator|+=
name|INT_GET
argument_list|(
name|btp
operator|->
name|stale
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|-
literal|1
expr_stmt|;
name|INT_SET
argument_list|(
name|btp
operator|->
name|stale
argument_list|,
name|ARCH_CONVERT
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* 		 * If we now need to rebuild the bestfree map, do so. 		 * This needs to happen before the next call to use_free. 		 */
if|if
condition|(
name|needscan
condition|)
block|{
name|xfs_dir2_data_freescan
argument_list|(
name|mp
argument_list|,
operator|(
name|xfs_dir2_data_t
operator|*
operator|)
name|block
argument_list|,
operator|&
name|needlog
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|needscan
operator|=
literal|0
expr_stmt|;
block|}
block|}
comment|/* 	 * Set leaf logging boundaries to impossible state. 	 * For the no-stale case they're set explicitly. 	 */
elseif|else
if|if
condition|(
name|INT_GET
argument_list|(
name|btp
operator|->
name|stale
argument_list|,
name|ARCH_CONVERT
argument_list|)
condition|)
block|{
name|lfloglow
operator|=
name|INT_GET
argument_list|(
name|btp
operator|->
name|count
argument_list|,
name|ARCH_CONVERT
argument_list|)
expr_stmt|;
name|lfloghigh
operator|=
operator|-
literal|1
expr_stmt|;
block|}
comment|/* 	 * Find the slot that's first lower than our hash value, -1 if none. 	 */
for|for
control|(
name|low
operator|=
literal|0
operator|,
name|high
operator|=
name|INT_GET
argument_list|(
name|btp
operator|->
name|count
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|-
literal|1
init|;
name|low
operator|<=
name|high
condition|;
control|)
block|{
name|mid
operator|=
operator|(
name|low
operator|+
name|high
operator|)
operator|>>
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|hash
operator|=
name|INT_GET
argument_list|(
name|blp
index|[
name|mid
index|]
operator|.
name|hashval
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|)
operator|==
name|args
operator|->
name|hashval
condition|)
break|break;
if|if
condition|(
name|hash
operator|<
name|args
operator|->
name|hashval
condition|)
name|low
operator|=
name|mid
operator|+
literal|1
expr_stmt|;
else|else
name|high
operator|=
name|mid
operator|-
literal|1
expr_stmt|;
block|}
while|while
condition|(
name|mid
operator|>=
literal|0
operator|&&
name|INT_GET
argument_list|(
name|blp
index|[
name|mid
index|]
operator|.
name|hashval
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|>=
name|args
operator|->
name|hashval
condition|)
block|{
name|mid
operator|--
expr_stmt|;
block|}
comment|/* 	 * No stale entries, will use enddup space to hold new leaf. 	 */
if|if
condition|(
name|INT_ISZERO
argument_list|(
name|btp
operator|->
name|stale
argument_list|,
name|ARCH_CONVERT
argument_list|)
condition|)
block|{
comment|/* 		 * Mark the space needed for the new leaf entry, now in use. 		 */
name|xfs_dir2_data_use_free
argument_list|(
name|tp
argument_list|,
name|bp
argument_list|,
name|enddup
argument_list|,
call|(
name|xfs_dir2_data_aoff_t
call|)
argument_list|(
operator|(
name|char
operator|*
operator|)
name|enddup
operator|-
operator|(
name|char
operator|*
operator|)
name|block
operator|+
name|INT_GET
argument_list|(
name|enddup
operator|->
name|length
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|-
sizeof|sizeof
argument_list|(
operator|*
name|blp
argument_list|)
argument_list|)
argument_list|,
operator|(
name|xfs_dir2_data_aoff_t
operator|)
sizeof|sizeof
argument_list|(
operator|*
name|blp
argument_list|)
argument_list|,
operator|&
name|needlog
argument_list|,
operator|&
name|needscan
argument_list|)
expr_stmt|;
comment|/* 		 * Update the tail (entry count). 		 */
name|INT_MOD
argument_list|(
name|btp
operator|->
name|count
argument_list|,
name|ARCH_CONVERT
argument_list|,
operator|+
literal|1
argument_list|)
expr_stmt|;
comment|/* 		 * If we now need to rebuild the bestfree map, do so. 		 * This needs to happen before the next call to use_free. 		 */
if|if
condition|(
name|needscan
condition|)
block|{
name|xfs_dir2_data_freescan
argument_list|(
name|mp
argument_list|,
operator|(
name|xfs_dir2_data_t
operator|*
operator|)
name|block
argument_list|,
operator|&
name|needlog
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|needscan
operator|=
literal|0
expr_stmt|;
block|}
comment|/* 		 * Adjust pointer to the first leaf entry, we're about to move 		 * the table up one to open up space for the new leaf entry. 		 * Then adjust our index to match. 		 */
name|blp
operator|--
expr_stmt|;
name|mid
operator|++
expr_stmt|;
if|if
condition|(
name|mid
condition|)
name|memmove
argument_list|(
name|blp
argument_list|,
operator|&
name|blp
index|[
literal|1
index|]
argument_list|,
name|mid
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|blp
argument_list|)
argument_list|)
expr_stmt|;
name|lfloglow
operator|=
literal|0
expr_stmt|;
name|lfloghigh
operator|=
name|mid
expr_stmt|;
block|}
comment|/* 	 * Use a stale leaf for our new entry. 	 */
else|else
block|{
for|for
control|(
name|lowstale
operator|=
name|mid
init|;
name|lowstale
operator|>=
literal|0
operator|&&
name|INT_GET
argument_list|(
name|blp
index|[
name|lowstale
index|]
operator|.
name|address
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|!=
name|XFS_DIR2_NULL_DATAPTR
condition|;
name|lowstale
operator|--
control|)
continue|continue;
for|for
control|(
name|highstale
operator|=
name|mid
operator|+
literal|1
init|;
name|highstale
operator|<
name|INT_GET
argument_list|(
name|btp
operator|->
name|count
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|&&
name|INT_GET
argument_list|(
name|blp
index|[
name|highstale
index|]
operator|.
name|address
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|!=
name|XFS_DIR2_NULL_DATAPTR
operator|&&
operator|(
name|lowstale
operator|<
literal|0
operator|||
name|mid
operator|-
name|lowstale
operator|>
name|highstale
operator|-
name|mid
operator|)
condition|;
name|highstale
operator|++
control|)
continue|continue;
comment|/* 		 * Move entries toward the low-numbered stale entry. 		 */
if|if
condition|(
name|lowstale
operator|>=
literal|0
operator|&&
operator|(
name|highstale
operator|==
name|INT_GET
argument_list|(
name|btp
operator|->
name|count
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|||
name|mid
operator|-
name|lowstale
operator|<=
name|highstale
operator|-
name|mid
operator|)
condition|)
block|{
if|if
condition|(
name|mid
operator|-
name|lowstale
condition|)
name|memmove
argument_list|(
operator|&
name|blp
index|[
name|lowstale
index|]
argument_list|,
operator|&
name|blp
index|[
name|lowstale
operator|+
literal|1
index|]
argument_list|,
operator|(
name|mid
operator|-
name|lowstale
operator|)
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|blp
argument_list|)
argument_list|)
expr_stmt|;
name|lfloglow
operator|=
name|MIN
argument_list|(
name|lowstale
argument_list|,
name|lfloglow
argument_list|)
expr_stmt|;
name|lfloghigh
operator|=
name|MAX
argument_list|(
name|mid
argument_list|,
name|lfloghigh
argument_list|)
expr_stmt|;
block|}
comment|/* 		 * Move entries toward the high-numbered stale entry. 		 */
else|else
block|{
name|ASSERT
argument_list|(
name|highstale
operator|<
name|INT_GET
argument_list|(
name|btp
operator|->
name|count
argument_list|,
name|ARCH_CONVERT
argument_list|)
argument_list|)
expr_stmt|;
name|mid
operator|++
expr_stmt|;
if|if
condition|(
name|highstale
operator|-
name|mid
condition|)
name|memmove
argument_list|(
operator|&
name|blp
index|[
name|mid
operator|+
literal|1
index|]
argument_list|,
operator|&
name|blp
index|[
name|mid
index|]
argument_list|,
operator|(
name|highstale
operator|-
name|mid
operator|)
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|blp
argument_list|)
argument_list|)
expr_stmt|;
name|lfloglow
operator|=
name|MIN
argument_list|(
name|mid
argument_list|,
name|lfloglow
argument_list|)
expr_stmt|;
name|lfloghigh
operator|=
name|MAX
argument_list|(
name|highstale
argument_list|,
name|lfloghigh
argument_list|)
expr_stmt|;
block|}
name|INT_MOD
argument_list|(
name|btp
operator|->
name|stale
argument_list|,
name|ARCH_CONVERT
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Point to the new data entry. 	 */
name|dep
operator|=
operator|(
name|xfs_dir2_data_entry_t
operator|*
operator|)
name|dup
expr_stmt|;
comment|/* 	 * Fill in the leaf entry. 	 */
name|INT_SET
argument_list|(
name|blp
index|[
name|mid
index|]
operator|.
name|hashval
argument_list|,
name|ARCH_CONVERT
argument_list|,
name|args
operator|->
name|hashval
argument_list|)
expr_stmt|;
name|INT_SET
argument_list|(
name|blp
index|[
name|mid
index|]
operator|.
name|address
argument_list|,
name|ARCH_CONVERT
argument_list|,
name|XFS_DIR2_BYTE_TO_DATAPTR
argument_list|(
name|mp
argument_list|,
operator|(
name|char
operator|*
operator|)
name|dep
operator|-
operator|(
name|char
operator|*
operator|)
name|block
argument_list|)
argument_list|)
expr_stmt|;
name|xfs_dir2_block_log_leaf
argument_list|(
name|tp
argument_list|,
name|bp
argument_list|,
name|lfloglow
argument_list|,
name|lfloghigh
argument_list|)
expr_stmt|;
comment|/* 	 * Mark space for the data entry used. 	 */
name|xfs_dir2_data_use_free
argument_list|(
name|tp
argument_list|,
name|bp
argument_list|,
name|dup
argument_list|,
call|(
name|xfs_dir2_data_aoff_t
call|)
argument_list|(
operator|(
name|char
operator|*
operator|)
name|dup
operator|-
operator|(
name|char
operator|*
operator|)
name|block
argument_list|)
argument_list|,
operator|(
name|xfs_dir2_data_aoff_t
operator|)
name|len
argument_list|,
operator|&
name|needlog
argument_list|,
operator|&
name|needscan
argument_list|)
expr_stmt|;
comment|/* 	 * Create the new data entry. 	 */
name|INT_SET
argument_list|(
name|dep
operator|->
name|inumber
argument_list|,
name|ARCH_CONVERT
argument_list|,
name|args
operator|->
name|inumber
argument_list|)
expr_stmt|;
name|dep
operator|->
name|namelen
operator|=
name|args
operator|->
name|namelen
expr_stmt|;
name|memcpy
argument_list|(
name|dep
operator|->
name|name
argument_list|,
name|args
operator|->
name|name
argument_list|,
name|args
operator|->
name|namelen
argument_list|)
expr_stmt|;
name|tagp
operator|=
name|XFS_DIR2_DATA_ENTRY_TAG_P
argument_list|(
name|dep
argument_list|)
expr_stmt|;
name|INT_SET
argument_list|(
operator|*
name|tagp
argument_list|,
name|ARCH_CONVERT
argument_list|,
call|(
name|xfs_dir2_data_off_t
call|)
argument_list|(
operator|(
name|char
operator|*
operator|)
name|dep
operator|-
operator|(
name|char
operator|*
operator|)
name|block
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Clean up the bestfree array and log the header, tail, and entry. 	 */
if|if
condition|(
name|needscan
condition|)
name|xfs_dir2_data_freescan
argument_list|(
name|mp
argument_list|,
operator|(
name|xfs_dir2_data_t
operator|*
operator|)
name|block
argument_list|,
operator|&
name|needlog
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|needlog
condition|)
name|xfs_dir2_data_log_header
argument_list|(
name|tp
argument_list|,
name|bp
argument_list|)
expr_stmt|;
name|xfs_dir2_block_log_tail
argument_list|(
name|tp
argument_list|,
name|bp
argument_list|)
expr_stmt|;
name|xfs_dir2_data_log_entry
argument_list|(
name|tp
argument_list|,
name|bp
argument_list|,
name|dep
argument_list|)
expr_stmt|;
name|xfs_dir2_data_check
argument_list|(
name|dp
argument_list|,
name|bp
argument_list|)
expr_stmt|;
name|xfs_da_buf_done
argument_list|(
name|bp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Readdir for block directories.  */
end_comment

begin_function
name|int
comment|/* error */
name|xfs_dir2_block_getdents
parameter_list|(
name|xfs_trans_t
modifier|*
name|tp
parameter_list|,
comment|/* transaction (NULL) */
name|xfs_inode_t
modifier|*
name|dp
parameter_list|,
comment|/* incore inode */
name|uio_t
modifier|*
name|uio
parameter_list|,
comment|/* caller's buffer control */
name|int
modifier|*
name|eofp
parameter_list|,
comment|/* eof reached? (out) */
name|xfs_dirent_t
modifier|*
name|dbp
parameter_list|,
comment|/* caller's buffer */
name|xfs_dir2_put_t
name|put
parameter_list|)
comment|/* abi's formatting function */
block|{
name|xfs_dir2_block_t
modifier|*
name|block
decl_stmt|;
comment|/* directory block structure */
name|xfs_dabuf_t
modifier|*
name|bp
decl_stmt|;
comment|/* buffer for block */
name|xfs_dir2_block_tail_t
modifier|*
name|btp
decl_stmt|;
comment|/* block tail */
name|xfs_dir2_data_entry_t
modifier|*
name|dep
decl_stmt|;
comment|/* block data entry */
name|xfs_dir2_data_unused_t
modifier|*
name|dup
decl_stmt|;
comment|/* block unused entry */
name|char
modifier|*
name|endptr
decl_stmt|;
comment|/* end of the data entries */
name|int
name|error
decl_stmt|;
comment|/* error return value */
name|xfs_mount_t
modifier|*
name|mp
decl_stmt|;
comment|/* filesystem mount point */
name|xfs_dir2_put_args_t
name|p
decl_stmt|;
comment|/* arg package for put rtn */
name|char
modifier|*
name|ptr
decl_stmt|;
comment|/* current data entry */
name|int
name|wantoff
decl_stmt|;
comment|/* starting block offset */
name|mp
operator|=
name|dp
operator|->
name|i_mount
expr_stmt|;
comment|/* 	 * If the block number in the offset is out of range, we're done. 	 */
if|if
condition|(
name|XFS_DIR2_DATAPTR_TO_DB
argument_list|(
name|mp
argument_list|,
name|uio
operator|->
name|uio_offset
argument_list|)
operator|>
name|mp
operator|->
name|m_dirdatablk
condition|)
block|{
operator|*
name|eofp
operator|=
literal|1
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* 	 * Can't read the block, give up, else get dabuf in bp. 	 */
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_da_read_buf
argument_list|(
name|tp
argument_list|,
name|dp
argument_list|,
name|mp
operator|->
name|m_dirdatablk
argument_list|,
operator|-
literal|1
argument_list|,
operator|&
name|bp
argument_list|,
name|XFS_DATA_FORK
argument_list|)
operator|)
condition|)
block|{
return|return
name|error
return|;
block|}
name|ASSERT
argument_list|(
name|bp
operator|!=
name|NULL
argument_list|)
expr_stmt|;
comment|/* 	 * Extract the byte offset we start at from the seek pointer. 	 * We'll skip entries before this. 	 */
name|wantoff
operator|=
name|XFS_DIR2_DATAPTR_TO_OFF
argument_list|(
name|mp
argument_list|,
name|uio
operator|->
name|uio_offset
argument_list|)
expr_stmt|;
name|block
operator|=
name|bp
operator|->
name|data
expr_stmt|;
name|xfs_dir2_data_check
argument_list|(
name|dp
argument_list|,
name|bp
argument_list|)
expr_stmt|;
comment|/* 	 * Set up values for the loop. 	 */
name|btp
operator|=
name|XFS_DIR2_BLOCK_TAIL_P
argument_list|(
name|mp
argument_list|,
name|block
argument_list|)
expr_stmt|;
name|ptr
operator|=
operator|(
name|char
operator|*
operator|)
name|block
operator|->
name|u
expr_stmt|;
name|endptr
operator|=
operator|(
name|char
operator|*
operator|)
name|XFS_DIR2_BLOCK_LEAF_P_ARCH
argument_list|(
name|btp
argument_list|,
name|ARCH_CONVERT
argument_list|)
expr_stmt|;
name|p
operator|.
name|dbp
operator|=
name|dbp
expr_stmt|;
name|p
operator|.
name|put
operator|=
name|put
expr_stmt|;
name|p
operator|.
name|uio
operator|=
name|uio
expr_stmt|;
comment|/* 	 * Loop over the data portion of the block. 	 * Each object is a real entry (dep) or an unused one (dup). 	 */
while|while
condition|(
name|ptr
operator|<
name|endptr
condition|)
block|{
name|dup
operator|=
operator|(
name|xfs_dir2_data_unused_t
operator|*
operator|)
name|ptr
expr_stmt|;
comment|/* 		 * Unused, skip it. 		 */
if|if
condition|(
name|INT_GET
argument_list|(
name|dup
operator|->
name|freetag
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|==
name|XFS_DIR2_DATA_FREE_TAG
condition|)
block|{
name|ptr
operator|+=
name|INT_GET
argument_list|(
name|dup
operator|->
name|length
argument_list|,
name|ARCH_CONVERT
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|dep
operator|=
operator|(
name|xfs_dir2_data_entry_t
operator|*
operator|)
name|ptr
expr_stmt|;
comment|/* 		 * Bump pointer for the next iteration. 		 */
name|ptr
operator|+=
name|XFS_DIR2_DATA_ENTSIZE
argument_list|(
name|dep
operator|->
name|namelen
argument_list|)
expr_stmt|;
comment|/* 		 * The entry is before the desired starting point, skip it. 		 */
if|if
condition|(
operator|(
name|char
operator|*
operator|)
name|dep
operator|-
operator|(
name|char
operator|*
operator|)
name|block
operator|<
name|wantoff
condition|)
continue|continue;
comment|/* 		 * Set up argument structure for put routine. 		 */
name|p
operator|.
name|namelen
operator|=
name|dep
operator|->
name|namelen
expr_stmt|;
name|p
operator|.
name|cook
operator|=
name|XFS_DIR2_DB_OFF_TO_DATAPTR
argument_list|(
name|mp
argument_list|,
name|mp
operator|->
name|m_dirdatablk
argument_list|,
name|ptr
operator|-
operator|(
name|char
operator|*
operator|)
name|block
argument_list|)
expr_stmt|;
name|p
operator|.
name|ino
operator|=
name|INT_GET
argument_list|(
name|dep
operator|->
name|inumber
argument_list|,
name|ARCH_CONVERT
argument_list|)
expr_stmt|;
if|#
directive|if
name|XFS_BIG_INUMS
name|p
operator|.
name|ino
operator|+=
name|mp
operator|->
name|m_inoadd
expr_stmt|;
endif|#
directive|endif
name|p
operator|.
name|name
operator|=
operator|(
name|char
operator|*
operator|)
name|dep
operator|->
name|name
expr_stmt|;
comment|/* 		 * Put the entry in the caller's buffer. 		 */
name|error
operator|=
name|p
operator|.
name|put
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
comment|/* 		 * If it didn't fit, set the final offset to here& return. 		 */
if|if
condition|(
operator|!
name|p
operator|.
name|done
condition|)
block|{
name|uio
operator|->
name|uio_offset
operator|=
name|XFS_DIR2_DB_OFF_TO_DATAPTR
argument_list|(
name|mp
argument_list|,
name|mp
operator|->
name|m_dirdatablk
argument_list|,
operator|(
name|char
operator|*
operator|)
name|dep
operator|-
operator|(
name|char
operator|*
operator|)
name|block
argument_list|)
expr_stmt|;
name|xfs_da_brelse
argument_list|(
name|tp
argument_list|,
name|bp
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
block|}
comment|/* 	 * Reached the end of the block. 	 * Set the offset to a nonexistent block 1 and return. 	 */
operator|*
name|eofp
operator|=
literal|1
expr_stmt|;
name|uio
operator|->
name|uio_offset
operator|=
name|XFS_DIR2_DB_OFF_TO_DATAPTR
argument_list|(
name|mp
argument_list|,
name|mp
operator|->
name|m_dirdatablk
operator|+
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|xfs_da_brelse
argument_list|(
name|tp
argument_list|,
name|bp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Log leaf entries from the block.  */
end_comment

begin_function
specifier|static
name|void
name|xfs_dir2_block_log_leaf
parameter_list|(
name|xfs_trans_t
modifier|*
name|tp
parameter_list|,
comment|/* transaction structure */
name|xfs_dabuf_t
modifier|*
name|bp
parameter_list|,
comment|/* block buffer */
name|int
name|first
parameter_list|,
comment|/* index of first logged leaf */
name|int
name|last
parameter_list|)
comment|/* index of last logged leaf */
block|{
name|xfs_dir2_block_t
modifier|*
name|block
decl_stmt|;
comment|/* directory block structure */
name|xfs_dir2_leaf_entry_t
modifier|*
name|blp
decl_stmt|;
comment|/* block leaf entries */
name|xfs_dir2_block_tail_t
modifier|*
name|btp
decl_stmt|;
comment|/* block tail */
name|xfs_mount_t
modifier|*
name|mp
decl_stmt|;
comment|/* filesystem mount point */
name|mp
operator|=
name|tp
operator|->
name|t_mountp
expr_stmt|;
name|block
operator|=
name|bp
operator|->
name|data
expr_stmt|;
name|btp
operator|=
name|XFS_DIR2_BLOCK_TAIL_P
argument_list|(
name|mp
argument_list|,
name|block
argument_list|)
expr_stmt|;
name|blp
operator|=
name|XFS_DIR2_BLOCK_LEAF_P_ARCH
argument_list|(
name|btp
argument_list|,
name|ARCH_CONVERT
argument_list|)
expr_stmt|;
name|xfs_da_log_buf
argument_list|(
name|tp
argument_list|,
name|bp
argument_list|,
call|(
name|uint
call|)
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|blp
index|[
name|first
index|]
operator|-
operator|(
name|char
operator|*
operator|)
name|block
argument_list|)
argument_list|,
call|(
name|uint
call|)
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|blp
index|[
name|last
operator|+
literal|1
index|]
operator|-
operator|(
name|char
operator|*
operator|)
name|block
operator|-
literal|1
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Log the block tail.  */
end_comment

begin_function
specifier|static
name|void
name|xfs_dir2_block_log_tail
parameter_list|(
name|xfs_trans_t
modifier|*
name|tp
parameter_list|,
comment|/* transaction structure */
name|xfs_dabuf_t
modifier|*
name|bp
parameter_list|)
comment|/* block buffer */
block|{
name|xfs_dir2_block_t
modifier|*
name|block
decl_stmt|;
comment|/* directory block structure */
name|xfs_dir2_block_tail_t
modifier|*
name|btp
decl_stmt|;
comment|/* block tail */
name|xfs_mount_t
modifier|*
name|mp
decl_stmt|;
comment|/* filesystem mount point */
name|mp
operator|=
name|tp
operator|->
name|t_mountp
expr_stmt|;
name|block
operator|=
name|bp
operator|->
name|data
expr_stmt|;
name|btp
operator|=
name|XFS_DIR2_BLOCK_TAIL_P
argument_list|(
name|mp
argument_list|,
name|block
argument_list|)
expr_stmt|;
name|xfs_da_log_buf
argument_list|(
name|tp
argument_list|,
name|bp
argument_list|,
call|(
name|uint
call|)
argument_list|(
operator|(
name|char
operator|*
operator|)
name|btp
operator|-
operator|(
name|char
operator|*
operator|)
name|block
argument_list|)
argument_list|,
call|(
name|uint
call|)
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|btp
operator|+
literal|1
operator|)
operator|-
operator|(
name|char
operator|*
operator|)
name|block
operator|-
literal|1
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Look up an entry in the block.  This is the external routine,  * xfs_dir2_block_lookup_int does the real work.  */
end_comment

begin_function
name|int
comment|/* error */
name|xfs_dir2_block_lookup
parameter_list|(
name|xfs_da_args_t
modifier|*
name|args
parameter_list|)
comment|/* dir lookup arguments */
block|{
name|xfs_dir2_block_t
modifier|*
name|block
decl_stmt|;
comment|/* block structure */
name|xfs_dir2_leaf_entry_t
modifier|*
name|blp
decl_stmt|;
comment|/* block leaf entries */
name|xfs_dabuf_t
modifier|*
name|bp
decl_stmt|;
comment|/* block buffer */
name|xfs_dir2_block_tail_t
modifier|*
name|btp
decl_stmt|;
comment|/* block tail */
name|xfs_dir2_data_entry_t
modifier|*
name|dep
decl_stmt|;
comment|/* block data entry */
name|xfs_inode_t
modifier|*
name|dp
decl_stmt|;
comment|/* incore inode */
name|int
name|ent
decl_stmt|;
comment|/* entry index */
name|int
name|error
decl_stmt|;
comment|/* error return value */
name|xfs_mount_t
modifier|*
name|mp
decl_stmt|;
comment|/* filesystem mount point */
name|xfs_dir2_trace_args
argument_list|(
literal|"block_lookup"
argument_list|,
name|args
argument_list|)
expr_stmt|;
comment|/* 	 * Get the buffer, look up the entry. 	 * If not found (ENOENT) then return, have no buffer. 	 */
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_dir2_block_lookup_int
argument_list|(
name|args
argument_list|,
operator|&
name|bp
argument_list|,
operator|&
name|ent
argument_list|)
operator|)
condition|)
return|return
name|error
return|;
name|dp
operator|=
name|args
operator|->
name|dp
expr_stmt|;
name|mp
operator|=
name|dp
operator|->
name|i_mount
expr_stmt|;
name|block
operator|=
name|bp
operator|->
name|data
expr_stmt|;
name|xfs_dir2_data_check
argument_list|(
name|dp
argument_list|,
name|bp
argument_list|)
expr_stmt|;
name|btp
operator|=
name|XFS_DIR2_BLOCK_TAIL_P
argument_list|(
name|mp
argument_list|,
name|block
argument_list|)
expr_stmt|;
name|blp
operator|=
name|XFS_DIR2_BLOCK_LEAF_P_ARCH
argument_list|(
name|btp
argument_list|,
name|ARCH_CONVERT
argument_list|)
expr_stmt|;
comment|/* 	 * Get the offset from the leaf entry, to point to the data. 	 */
name|dep
operator|=
operator|(
name|xfs_dir2_data_entry_t
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|block
operator|+
name|XFS_DIR2_DATAPTR_TO_OFF
argument_list|(
name|mp
argument_list|,
name|INT_GET
argument_list|(
name|blp
index|[
name|ent
index|]
operator|.
name|address
argument_list|,
name|ARCH_CONVERT
argument_list|)
argument_list|)
operator|)
expr_stmt|;
comment|/* 	 * Fill in inode number, release the block. 	 */
name|args
operator|->
name|inumber
operator|=
name|INT_GET
argument_list|(
name|dep
operator|->
name|inumber
argument_list|,
name|ARCH_CONVERT
argument_list|)
expr_stmt|;
name|xfs_da_brelse
argument_list|(
name|args
operator|->
name|trans
argument_list|,
name|bp
argument_list|)
expr_stmt|;
return|return
name|XFS_ERROR
argument_list|(
name|EEXIST
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  * Internal block lookup routine.  */
end_comment

begin_function
specifier|static
name|int
comment|/* error */
name|xfs_dir2_block_lookup_int
parameter_list|(
name|xfs_da_args_t
modifier|*
name|args
parameter_list|,
comment|/* dir lookup arguments */
name|xfs_dabuf_t
modifier|*
modifier|*
name|bpp
parameter_list|,
comment|/* returned block buffer */
name|int
modifier|*
name|entno
parameter_list|)
comment|/* returned entry number */
block|{
name|xfs_dir2_dataptr_t
name|addr
decl_stmt|;
comment|/* data entry address */
name|xfs_dir2_block_t
modifier|*
name|block
decl_stmt|;
comment|/* block structure */
name|xfs_dir2_leaf_entry_t
modifier|*
name|blp
decl_stmt|;
comment|/* block leaf entries */
name|xfs_dabuf_t
modifier|*
name|bp
decl_stmt|;
comment|/* block buffer */
name|xfs_dir2_block_tail_t
modifier|*
name|btp
decl_stmt|;
comment|/* block tail */
name|xfs_dir2_data_entry_t
modifier|*
name|dep
decl_stmt|;
comment|/* block data entry */
name|xfs_inode_t
modifier|*
name|dp
decl_stmt|;
comment|/* incore inode */
name|int
name|error
decl_stmt|;
comment|/* error return value */
name|xfs_dahash_t
name|hash
decl_stmt|;
comment|/* found hash value */
name|int
name|high
decl_stmt|;
comment|/* binary search high index */
name|int
name|low
decl_stmt|;
comment|/* binary search low index */
name|int
name|mid
decl_stmt|;
comment|/* binary search current idx */
name|xfs_mount_t
modifier|*
name|mp
decl_stmt|;
comment|/* filesystem mount point */
name|xfs_trans_t
modifier|*
name|tp
decl_stmt|;
comment|/* transaction pointer */
name|dp
operator|=
name|args
operator|->
name|dp
expr_stmt|;
name|tp
operator|=
name|args
operator|->
name|trans
expr_stmt|;
name|mp
operator|=
name|dp
operator|->
name|i_mount
expr_stmt|;
comment|/* 	 * Read the buffer, return error if we can't get it. 	 */
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_da_read_buf
argument_list|(
name|tp
argument_list|,
name|dp
argument_list|,
name|mp
operator|->
name|m_dirdatablk
argument_list|,
operator|-
literal|1
argument_list|,
operator|&
name|bp
argument_list|,
name|XFS_DATA_FORK
argument_list|)
operator|)
condition|)
block|{
return|return
name|error
return|;
block|}
name|ASSERT
argument_list|(
name|bp
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|block
operator|=
name|bp
operator|->
name|data
expr_stmt|;
name|xfs_dir2_data_check
argument_list|(
name|dp
argument_list|,
name|bp
argument_list|)
expr_stmt|;
name|btp
operator|=
name|XFS_DIR2_BLOCK_TAIL_P
argument_list|(
name|mp
argument_list|,
name|block
argument_list|)
expr_stmt|;
name|blp
operator|=
name|XFS_DIR2_BLOCK_LEAF_P_ARCH
argument_list|(
name|btp
argument_list|,
name|ARCH_CONVERT
argument_list|)
expr_stmt|;
comment|/* 	 * Loop doing a binary search for our hash value. 	 * Find our entry, ENOENT if it's not there. 	 */
for|for
control|(
name|low
operator|=
literal|0
operator|,
name|high
operator|=
name|INT_GET
argument_list|(
name|btp
operator|->
name|count
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|-
literal|1
init|;
condition|;
control|)
block|{
name|ASSERT
argument_list|(
name|low
operator|<=
name|high
argument_list|)
expr_stmt|;
name|mid
operator|=
operator|(
name|low
operator|+
name|high
operator|)
operator|>>
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|hash
operator|=
name|INT_GET
argument_list|(
name|blp
index|[
name|mid
index|]
operator|.
name|hashval
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|)
operator|==
name|args
operator|->
name|hashval
condition|)
break|break;
if|if
condition|(
name|hash
operator|<
name|args
operator|->
name|hashval
condition|)
name|low
operator|=
name|mid
operator|+
literal|1
expr_stmt|;
else|else
name|high
operator|=
name|mid
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|low
operator|>
name|high
condition|)
block|{
name|ASSERT
argument_list|(
name|args
operator|->
name|oknoent
argument_list|)
expr_stmt|;
name|xfs_da_brelse
argument_list|(
name|tp
argument_list|,
name|bp
argument_list|)
expr_stmt|;
return|return
name|XFS_ERROR
argument_list|(
name|ENOENT
argument_list|)
return|;
block|}
block|}
comment|/* 	 * Back up to the first one with the right hash value. 	 */
while|while
condition|(
name|mid
operator|>
literal|0
operator|&&
name|INT_GET
argument_list|(
name|blp
index|[
name|mid
operator|-
literal|1
index|]
operator|.
name|hashval
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|==
name|args
operator|->
name|hashval
condition|)
block|{
name|mid
operator|--
expr_stmt|;
block|}
comment|/* 	 * Now loop forward through all the entries with the 	 * right hash value looking for our name. 	 */
do|do
block|{
if|if
condition|(
operator|(
name|addr
operator|=
name|INT_GET
argument_list|(
name|blp
index|[
name|mid
index|]
operator|.
name|address
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|)
operator|==
name|XFS_DIR2_NULL_DATAPTR
condition|)
continue|continue;
comment|/* 		 * Get pointer to the entry from the leaf. 		 */
name|dep
operator|=
operator|(
name|xfs_dir2_data_entry_t
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|block
operator|+
name|XFS_DIR2_DATAPTR_TO_OFF
argument_list|(
name|mp
argument_list|,
name|addr
argument_list|)
operator|)
expr_stmt|;
comment|/* 		 * Compare, if it's right give back buffer& entry number. 		 */
if|if
condition|(
name|dep
operator|->
name|namelen
operator|==
name|args
operator|->
name|namelen
operator|&&
name|dep
operator|->
name|name
index|[
literal|0
index|]
operator|==
name|args
operator|->
name|name
index|[
literal|0
index|]
operator|&&
name|memcmp
argument_list|(
name|dep
operator|->
name|name
argument_list|,
name|args
operator|->
name|name
argument_list|,
name|args
operator|->
name|namelen
argument_list|)
operator|==
literal|0
condition|)
block|{
operator|*
name|bpp
operator|=
name|bp
expr_stmt|;
operator|*
name|entno
operator|=
name|mid
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
do|while
condition|(
operator|++
name|mid
operator|<
name|INT_GET
argument_list|(
name|btp
operator|->
name|count
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|&&
name|INT_GET
argument_list|(
name|blp
index|[
name|mid
index|]
operator|.
name|hashval
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|==
name|hash
condition|)
do|;
comment|/* 	 * No match, release the buffer and return ENOENT. 	 */
name|ASSERT
argument_list|(
name|args
operator|->
name|oknoent
argument_list|)
expr_stmt|;
name|xfs_da_brelse
argument_list|(
name|tp
argument_list|,
name|bp
argument_list|)
expr_stmt|;
return|return
name|XFS_ERROR
argument_list|(
name|ENOENT
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  * Remove an entry from a block format directory.  * If that makes the block small enough to fit in shortform, transform it.  */
end_comment

begin_function
name|int
comment|/* error */
name|xfs_dir2_block_removename
parameter_list|(
name|xfs_da_args_t
modifier|*
name|args
parameter_list|)
comment|/* directory operation args */
block|{
name|xfs_dir2_block_t
modifier|*
name|block
decl_stmt|;
comment|/* block structure */
name|xfs_dir2_leaf_entry_t
modifier|*
name|blp
decl_stmt|;
comment|/* block leaf pointer */
name|xfs_dabuf_t
modifier|*
name|bp
decl_stmt|;
comment|/* block buffer */
name|xfs_dir2_block_tail_t
modifier|*
name|btp
decl_stmt|;
comment|/* block tail */
name|xfs_dir2_data_entry_t
modifier|*
name|dep
decl_stmt|;
comment|/* block data entry */
name|xfs_inode_t
modifier|*
name|dp
decl_stmt|;
comment|/* incore inode */
name|int
name|ent
decl_stmt|;
comment|/* block leaf entry index */
name|int
name|error
decl_stmt|;
comment|/* error return value */
name|xfs_mount_t
modifier|*
name|mp
decl_stmt|;
comment|/* filesystem mount point */
name|int
name|needlog
decl_stmt|;
comment|/* need to log block header */
name|int
name|needscan
decl_stmt|;
comment|/* need to fixup bestfree */
name|xfs_dir2_sf_hdr_t
name|sfh
decl_stmt|;
comment|/* shortform header */
name|int
name|size
decl_stmt|;
comment|/* shortform size */
name|xfs_trans_t
modifier|*
name|tp
decl_stmt|;
comment|/* transaction pointer */
name|xfs_dir2_trace_args
argument_list|(
literal|"block_removename"
argument_list|,
name|args
argument_list|)
expr_stmt|;
comment|/* 	 * Look up the entry in the block.  Gets the buffer and entry index. 	 * It will always be there, the vnodeops level does a lookup first. 	 */
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_dir2_block_lookup_int
argument_list|(
name|args
argument_list|,
operator|&
name|bp
argument_list|,
operator|&
name|ent
argument_list|)
operator|)
condition|)
block|{
return|return
name|error
return|;
block|}
name|dp
operator|=
name|args
operator|->
name|dp
expr_stmt|;
name|tp
operator|=
name|args
operator|->
name|trans
expr_stmt|;
name|mp
operator|=
name|dp
operator|->
name|i_mount
expr_stmt|;
name|block
operator|=
name|bp
operator|->
name|data
expr_stmt|;
name|btp
operator|=
name|XFS_DIR2_BLOCK_TAIL_P
argument_list|(
name|mp
argument_list|,
name|block
argument_list|)
expr_stmt|;
name|blp
operator|=
name|XFS_DIR2_BLOCK_LEAF_P_ARCH
argument_list|(
name|btp
argument_list|,
name|ARCH_CONVERT
argument_list|)
expr_stmt|;
comment|/* 	 * Point to the data entry using the leaf entry. 	 */
name|dep
operator|=
operator|(
name|xfs_dir2_data_entry_t
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|block
operator|+
name|XFS_DIR2_DATAPTR_TO_OFF
argument_list|(
name|mp
argument_list|,
name|INT_GET
argument_list|(
name|blp
index|[
name|ent
index|]
operator|.
name|address
argument_list|,
name|ARCH_CONVERT
argument_list|)
argument_list|)
operator|)
expr_stmt|;
comment|/* 	 * Mark the data entry's space free. 	 */
name|needlog
operator|=
name|needscan
operator|=
literal|0
expr_stmt|;
name|xfs_dir2_data_make_free
argument_list|(
name|tp
argument_list|,
name|bp
argument_list|,
call|(
name|xfs_dir2_data_aoff_t
call|)
argument_list|(
operator|(
name|char
operator|*
operator|)
name|dep
operator|-
operator|(
name|char
operator|*
operator|)
name|block
argument_list|)
argument_list|,
name|XFS_DIR2_DATA_ENTSIZE
argument_list|(
name|dep
operator|->
name|namelen
argument_list|)
argument_list|,
operator|&
name|needlog
argument_list|,
operator|&
name|needscan
argument_list|)
expr_stmt|;
comment|/* 	 * Fix up the block tail. 	 */
name|INT_MOD
argument_list|(
name|btp
operator|->
name|stale
argument_list|,
name|ARCH_CONVERT
argument_list|,
operator|+
literal|1
argument_list|)
expr_stmt|;
name|xfs_dir2_block_log_tail
argument_list|(
name|tp
argument_list|,
name|bp
argument_list|)
expr_stmt|;
comment|/* 	 * Remove the leaf entry by marking it stale. 	 */
name|INT_SET
argument_list|(
name|blp
index|[
name|ent
index|]
operator|.
name|address
argument_list|,
name|ARCH_CONVERT
argument_list|,
name|XFS_DIR2_NULL_DATAPTR
argument_list|)
expr_stmt|;
name|xfs_dir2_block_log_leaf
argument_list|(
name|tp
argument_list|,
name|bp
argument_list|,
name|ent
argument_list|,
name|ent
argument_list|)
expr_stmt|;
comment|/* 	 * Fix up bestfree, log the header if necessary. 	 */
if|if
condition|(
name|needscan
condition|)
name|xfs_dir2_data_freescan
argument_list|(
name|mp
argument_list|,
operator|(
name|xfs_dir2_data_t
operator|*
operator|)
name|block
argument_list|,
operator|&
name|needlog
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|needlog
condition|)
name|xfs_dir2_data_log_header
argument_list|(
name|tp
argument_list|,
name|bp
argument_list|)
expr_stmt|;
name|xfs_dir2_data_check
argument_list|(
name|dp
argument_list|,
name|bp
argument_list|)
expr_stmt|;
comment|/* 	 * See if the size as a shortform is good enough. 	 */
if|if
condition|(
operator|(
name|size
operator|=
name|xfs_dir2_block_sfsize
argument_list|(
name|dp
argument_list|,
name|block
argument_list|,
operator|&
name|sfh
argument_list|)
operator|)
operator|>
name|XFS_IFORK_DSIZE
argument_list|(
name|dp
argument_list|)
condition|)
block|{
name|xfs_da_buf_done
argument_list|(
name|bp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* 	 * If it works, do the conversion. 	 */
return|return
name|xfs_dir2_block_to_sf
argument_list|(
name|args
argument_list|,
name|bp
argument_list|,
name|size
argument_list|,
operator|&
name|sfh
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  * Replace an entry in a V2 block directory.  * Change the inode number to the new value.  */
end_comment

begin_function
name|int
comment|/* error */
name|xfs_dir2_block_replace
parameter_list|(
name|xfs_da_args_t
modifier|*
name|args
parameter_list|)
comment|/* directory operation args */
block|{
name|xfs_dir2_block_t
modifier|*
name|block
decl_stmt|;
comment|/* block structure */
name|xfs_dir2_leaf_entry_t
modifier|*
name|blp
decl_stmt|;
comment|/* block leaf entries */
name|xfs_dabuf_t
modifier|*
name|bp
decl_stmt|;
comment|/* block buffer */
name|xfs_dir2_block_tail_t
modifier|*
name|btp
decl_stmt|;
comment|/* block tail */
name|xfs_dir2_data_entry_t
modifier|*
name|dep
decl_stmt|;
comment|/* block data entry */
name|xfs_inode_t
modifier|*
name|dp
decl_stmt|;
comment|/* incore inode */
name|int
name|ent
decl_stmt|;
comment|/* leaf entry index */
name|int
name|error
decl_stmt|;
comment|/* error return value */
name|xfs_mount_t
modifier|*
name|mp
decl_stmt|;
comment|/* filesystem mount point */
name|xfs_dir2_trace_args
argument_list|(
literal|"block_replace"
argument_list|,
name|args
argument_list|)
expr_stmt|;
comment|/* 	 * Lookup the entry in the directory.  Get buffer and entry index. 	 * This will always succeed since the caller has already done a lookup. 	 */
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_dir2_block_lookup_int
argument_list|(
name|args
argument_list|,
operator|&
name|bp
argument_list|,
operator|&
name|ent
argument_list|)
operator|)
condition|)
block|{
return|return
name|error
return|;
block|}
name|dp
operator|=
name|args
operator|->
name|dp
expr_stmt|;
name|mp
operator|=
name|dp
operator|->
name|i_mount
expr_stmt|;
name|block
operator|=
name|bp
operator|->
name|data
expr_stmt|;
name|btp
operator|=
name|XFS_DIR2_BLOCK_TAIL_P
argument_list|(
name|mp
argument_list|,
name|block
argument_list|)
expr_stmt|;
name|blp
operator|=
name|XFS_DIR2_BLOCK_LEAF_P_ARCH
argument_list|(
name|btp
argument_list|,
name|ARCH_CONVERT
argument_list|)
expr_stmt|;
comment|/* 	 * Point to the data entry we need to change. 	 */
name|dep
operator|=
operator|(
name|xfs_dir2_data_entry_t
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|block
operator|+
name|XFS_DIR2_DATAPTR_TO_OFF
argument_list|(
name|mp
argument_list|,
name|INT_GET
argument_list|(
name|blp
index|[
name|ent
index|]
operator|.
name|address
argument_list|,
name|ARCH_CONVERT
argument_list|)
argument_list|)
operator|)
expr_stmt|;
name|ASSERT
argument_list|(
name|INT_GET
argument_list|(
name|dep
operator|->
name|inumber
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|!=
name|args
operator|->
name|inumber
argument_list|)
expr_stmt|;
comment|/* 	 * Change the inode number to the new value. 	 */
name|INT_SET
argument_list|(
name|dep
operator|->
name|inumber
argument_list|,
name|ARCH_CONVERT
argument_list|,
name|args
operator|->
name|inumber
argument_list|)
expr_stmt|;
name|xfs_dir2_data_log_entry
argument_list|(
name|args
operator|->
name|trans
argument_list|,
name|bp
argument_list|,
name|dep
argument_list|)
expr_stmt|;
name|xfs_dir2_data_check
argument_list|(
name|dp
argument_list|,
name|bp
argument_list|)
expr_stmt|;
name|xfs_da_buf_done
argument_list|(
name|bp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Qsort comparison routine for the block leaf entries.  */
end_comment

begin_function
specifier|static
name|int
comment|/* sort order */
name|xfs_dir2_block_sort
parameter_list|(
specifier|const
name|void
modifier|*
name|a
parameter_list|,
comment|/* first leaf entry */
specifier|const
name|void
modifier|*
name|b
parameter_list|)
comment|/* second leaf entry */
block|{
specifier|const
name|xfs_dir2_leaf_entry_t
modifier|*
name|la
decl_stmt|;
comment|/* first leaf entry */
specifier|const
name|xfs_dir2_leaf_entry_t
modifier|*
name|lb
decl_stmt|;
comment|/* second leaf entry */
name|la
operator|=
name|a
expr_stmt|;
name|lb
operator|=
name|b
expr_stmt|;
return|return
name|INT_GET
argument_list|(
name|la
operator|->
name|hashval
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|<
name|INT_GET
argument_list|(
name|lb
operator|->
name|hashval
argument_list|,
name|ARCH_CONVERT
argument_list|)
condition|?
operator|-
literal|1
else|:
operator|(
name|INT_GET
argument_list|(
name|la
operator|->
name|hashval
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|>
name|INT_GET
argument_list|(
name|lb
operator|->
name|hashval
argument_list|,
name|ARCH_CONVERT
argument_list|)
condition|?
literal|1
else|:
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Convert a V2 leaf directory to a V2 block directory if possible.  */
end_comment

begin_function
name|int
comment|/* error */
name|xfs_dir2_leaf_to_block
parameter_list|(
name|xfs_da_args_t
modifier|*
name|args
parameter_list|,
comment|/* operation arguments */
name|xfs_dabuf_t
modifier|*
name|lbp
parameter_list|,
comment|/* leaf buffer */
name|xfs_dabuf_t
modifier|*
name|dbp
parameter_list|)
comment|/* data buffer */
block|{
name|xfs_dir2_data_off_t
modifier|*
name|bestsp
decl_stmt|;
comment|/* leaf bests table */
name|xfs_dir2_block_t
modifier|*
name|block
decl_stmt|;
comment|/* block structure */
name|xfs_dir2_block_tail_t
modifier|*
name|btp
decl_stmt|;
comment|/* block tail */
name|xfs_inode_t
modifier|*
name|dp
decl_stmt|;
comment|/* incore directory inode */
name|xfs_dir2_data_unused_t
modifier|*
name|dup
decl_stmt|;
comment|/* unused data entry */
name|int
name|error
decl_stmt|;
comment|/* error return value */
name|int
name|from
decl_stmt|;
comment|/* leaf from index */
name|xfs_dir2_leaf_t
modifier|*
name|leaf
decl_stmt|;
comment|/* leaf structure */
name|xfs_dir2_leaf_entry_t
modifier|*
name|lep
decl_stmt|;
comment|/* leaf entry */
name|xfs_dir2_leaf_tail_t
modifier|*
name|ltp
decl_stmt|;
comment|/* leaf tail structure */
name|xfs_mount_t
modifier|*
name|mp
decl_stmt|;
comment|/* file system mount point */
name|int
name|needlog
decl_stmt|;
comment|/* need to log data header */
name|int
name|needscan
decl_stmt|;
comment|/* need to scan for bestfree */
name|xfs_dir2_sf_hdr_t
name|sfh
decl_stmt|;
comment|/* shortform header */
name|int
name|size
decl_stmt|;
comment|/* bytes used */
name|xfs_dir2_data_off_t
modifier|*
name|tagp
decl_stmt|;
comment|/* end of entry (tag) */
name|int
name|to
decl_stmt|;
comment|/* block/leaf to index */
name|xfs_trans_t
modifier|*
name|tp
decl_stmt|;
comment|/* transaction pointer */
name|xfs_dir2_trace_args_bb
argument_list|(
literal|"leaf_to_block"
argument_list|,
name|args
argument_list|,
name|lbp
argument_list|,
name|dbp
argument_list|)
expr_stmt|;
name|dp
operator|=
name|args
operator|->
name|dp
expr_stmt|;
name|tp
operator|=
name|args
operator|->
name|trans
expr_stmt|;
name|mp
operator|=
name|dp
operator|->
name|i_mount
expr_stmt|;
name|leaf
operator|=
name|lbp
operator|->
name|data
expr_stmt|;
name|ASSERT
argument_list|(
name|INT_GET
argument_list|(
name|leaf
operator|->
name|hdr
operator|.
name|info
operator|.
name|magic
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|==
name|XFS_DIR2_LEAF1_MAGIC
argument_list|)
expr_stmt|;
name|ltp
operator|=
name|XFS_DIR2_LEAF_TAIL_P
argument_list|(
name|mp
argument_list|,
name|leaf
argument_list|)
expr_stmt|;
comment|/* 	 * If there are data blocks other than the first one, take this 	 * opportunity to remove trailing empty data blocks that may have 	 * been left behind during no-space-reservation operations. 	 * These will show up in the leaf bests table. 	 */
while|while
condition|(
name|dp
operator|->
name|i_d
operator|.
name|di_size
operator|>
name|mp
operator|->
name|m_dirblksize
condition|)
block|{
name|bestsp
operator|=
name|XFS_DIR2_LEAF_BESTS_P_ARCH
argument_list|(
name|ltp
argument_list|,
name|ARCH_CONVERT
argument_list|)
expr_stmt|;
if|if
condition|(
name|INT_GET
argument_list|(
name|bestsp
index|[
name|INT_GET
argument_list|(
name|ltp
operator|->
name|bestcount
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|-
literal|1
index|]
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|==
name|mp
operator|->
name|m_dirblksize
operator|-
operator|(
name|uint
operator|)
sizeof|sizeof
argument_list|(
name|block
operator|->
name|hdr
argument_list|)
condition|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|xfs_dir2_leaf_trim_data
argument_list|(
name|args
argument_list|,
name|lbp
argument_list|,
call|(
name|xfs_dir2_db_t
call|)
argument_list|(
name|INT_GET
argument_list|(
name|ltp
operator|->
name|bestcount
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|-
literal|1
argument_list|)
argument_list|)
operator|)
condition|)
goto|goto
name|out
goto|;
block|}
else|else
block|{
name|error
operator|=
literal|0
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
comment|/* 	 * Read the data block if we don't already have it, give up if it fails. 	 */
if|if
condition|(
name|dbp
operator|==
name|NULL
operator|&&
operator|(
name|error
operator|=
name|xfs_da_read_buf
argument_list|(
name|tp
argument_list|,
name|dp
argument_list|,
name|mp
operator|->
name|m_dirdatablk
argument_list|,
operator|-
literal|1
argument_list|,
operator|&
name|dbp
argument_list|,
name|XFS_DATA_FORK
argument_list|)
operator|)
condition|)
block|{
goto|goto
name|out
goto|;
block|}
name|block
operator|=
name|dbp
operator|->
name|data
expr_stmt|;
name|ASSERT
argument_list|(
name|INT_GET
argument_list|(
name|block
operator|->
name|hdr
operator|.
name|magic
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|==
name|XFS_DIR2_DATA_MAGIC
argument_list|)
expr_stmt|;
comment|/* 	 * Size of the "leaf" area in the block. 	 */
name|size
operator|=
operator|(
name|uint
operator|)
sizeof|sizeof
argument_list|(
name|block
operator|->
name|tail
argument_list|)
operator|+
operator|(
name|uint
operator|)
sizeof|sizeof
argument_list|(
operator|*
name|lep
argument_list|)
operator|*
operator|(
name|INT_GET
argument_list|(
name|leaf
operator|->
name|hdr
operator|.
name|count
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|-
name|INT_GET
argument_list|(
name|leaf
operator|->
name|hdr
operator|.
name|stale
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|)
expr_stmt|;
comment|/* 	 * Look at the last data entry. 	 */
name|tagp
operator|=
operator|(
name|xfs_dir2_data_off_t
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|block
operator|+
name|mp
operator|->
name|m_dirblksize
operator|)
operator|-
literal|1
expr_stmt|;
name|dup
operator|=
operator|(
name|xfs_dir2_data_unused_t
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|block
operator|+
name|INT_GET
argument_list|(
operator|*
name|tagp
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|)
expr_stmt|;
comment|/* 	 * If it's not free or is too short we can't do it. 	 */
if|if
condition|(
name|INT_GET
argument_list|(
name|dup
operator|->
name|freetag
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|!=
name|XFS_DIR2_DATA_FREE_TAG
operator|||
name|INT_GET
argument_list|(
name|dup
operator|->
name|length
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|<
name|size
condition|)
block|{
name|error
operator|=
literal|0
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* 	 * Start converting it to block form. 	 */
name|INT_SET
argument_list|(
name|block
operator|->
name|hdr
operator|.
name|magic
argument_list|,
name|ARCH_CONVERT
argument_list|,
name|XFS_DIR2_BLOCK_MAGIC
argument_list|)
expr_stmt|;
name|needlog
operator|=
literal|1
expr_stmt|;
name|needscan
operator|=
literal|0
expr_stmt|;
comment|/* 	 * Use up the space at the end of the block (blp/btp). 	 */
name|xfs_dir2_data_use_free
argument_list|(
name|tp
argument_list|,
name|dbp
argument_list|,
name|dup
argument_list|,
name|mp
operator|->
name|m_dirblksize
operator|-
name|size
argument_list|,
name|size
argument_list|,
operator|&
name|needlog
argument_list|,
operator|&
name|needscan
argument_list|)
expr_stmt|;
comment|/* 	 * Initialize the block tail. 	 */
name|btp
operator|=
name|XFS_DIR2_BLOCK_TAIL_P
argument_list|(
name|mp
argument_list|,
name|block
argument_list|)
expr_stmt|;
name|INT_SET
argument_list|(
name|btp
operator|->
name|count
argument_list|,
name|ARCH_CONVERT
argument_list|,
name|INT_GET
argument_list|(
name|leaf
operator|->
name|hdr
operator|.
name|count
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|-
name|INT_GET
argument_list|(
name|leaf
operator|->
name|hdr
operator|.
name|stale
argument_list|,
name|ARCH_CONVERT
argument_list|)
argument_list|)
expr_stmt|;
name|INT_ZERO
argument_list|(
name|btp
operator|->
name|stale
argument_list|,
name|ARCH_CONVERT
argument_list|)
expr_stmt|;
name|xfs_dir2_block_log_tail
argument_list|(
name|tp
argument_list|,
name|dbp
argument_list|)
expr_stmt|;
comment|/* 	 * Initialize the block leaf area.  We compact out stale entries. 	 */
name|lep
operator|=
name|XFS_DIR2_BLOCK_LEAF_P_ARCH
argument_list|(
name|btp
argument_list|,
name|ARCH_CONVERT
argument_list|)
expr_stmt|;
for|for
control|(
name|from
operator|=
name|to
operator|=
literal|0
init|;
name|from
operator|<
name|INT_GET
argument_list|(
name|leaf
operator|->
name|hdr
operator|.
name|count
argument_list|,
name|ARCH_CONVERT
argument_list|)
condition|;
name|from
operator|++
control|)
block|{
if|if
condition|(
name|INT_GET
argument_list|(
name|leaf
operator|->
name|ents
index|[
name|from
index|]
operator|.
name|address
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|==
name|XFS_DIR2_NULL_DATAPTR
condition|)
continue|continue;
name|lep
index|[
name|to
operator|++
index|]
operator|=
name|leaf
operator|->
name|ents
index|[
name|from
index|]
expr_stmt|;
block|}
name|ASSERT
argument_list|(
name|to
operator|==
name|INT_GET
argument_list|(
name|btp
operator|->
name|count
argument_list|,
name|ARCH_CONVERT
argument_list|)
argument_list|)
expr_stmt|;
name|xfs_dir2_block_log_leaf
argument_list|(
name|tp
argument_list|,
name|dbp
argument_list|,
literal|0
argument_list|,
name|INT_GET
argument_list|(
name|btp
operator|->
name|count
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* 	 * Scan the bestfree if we need it and log the data block header. 	 */
if|if
condition|(
name|needscan
condition|)
name|xfs_dir2_data_freescan
argument_list|(
name|mp
argument_list|,
operator|(
name|xfs_dir2_data_t
operator|*
operator|)
name|block
argument_list|,
operator|&
name|needlog
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|needlog
condition|)
name|xfs_dir2_data_log_header
argument_list|(
name|tp
argument_list|,
name|dbp
argument_list|)
expr_stmt|;
comment|/* 	 * Pitch the old leaf block. 	 */
name|error
operator|=
name|xfs_da_shrink_inode
argument_list|(
name|args
argument_list|,
name|mp
operator|->
name|m_dirleafblk
argument_list|,
name|lbp
argument_list|)
expr_stmt|;
name|lbp
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
goto|goto
name|out
goto|;
block|}
comment|/* 	 * Now see if the resulting block can be shrunken to shortform. 	 */
if|if
condition|(
operator|(
name|size
operator|=
name|xfs_dir2_block_sfsize
argument_list|(
name|dp
argument_list|,
name|block
argument_list|,
operator|&
name|sfh
argument_list|)
operator|)
operator|>
name|XFS_IFORK_DSIZE
argument_list|(
name|dp
argument_list|)
condition|)
block|{
name|error
operator|=
literal|0
expr_stmt|;
goto|goto
name|out
goto|;
block|}
return|return
name|xfs_dir2_block_to_sf
argument_list|(
name|args
argument_list|,
name|dbp
argument_list|,
name|size
argument_list|,
operator|&
name|sfh
argument_list|)
return|;
name|out
label|:
if|if
condition|(
name|lbp
condition|)
name|xfs_da_buf_done
argument_list|(
name|lbp
argument_list|)
expr_stmt|;
if|if
condition|(
name|dbp
condition|)
name|xfs_da_buf_done
argument_list|(
name|dbp
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_comment
comment|/*  * Convert the shortform directory to block form.  */
end_comment

begin_function
name|int
comment|/* error */
name|xfs_dir2_sf_to_block
parameter_list|(
name|xfs_da_args_t
modifier|*
name|args
parameter_list|)
comment|/* operation arguments */
block|{
name|xfs_dir2_db_t
name|blkno
decl_stmt|;
comment|/* dir-relative block # (0) */
name|xfs_dir2_block_t
modifier|*
name|block
decl_stmt|;
comment|/* block structure */
name|xfs_dir2_leaf_entry_t
modifier|*
name|blp
decl_stmt|;
comment|/* block leaf entries */
name|xfs_dabuf_t
modifier|*
name|bp
decl_stmt|;
comment|/* block buffer */
name|xfs_dir2_block_tail_t
modifier|*
name|btp
decl_stmt|;
comment|/* block tail pointer */
name|char
modifier|*
name|buf
decl_stmt|;
comment|/* sf buffer */
name|int
name|buf_len
decl_stmt|;
name|xfs_dir2_data_entry_t
modifier|*
name|dep
decl_stmt|;
comment|/* data entry pointer */
name|xfs_inode_t
modifier|*
name|dp
decl_stmt|;
comment|/* incore directory inode */
name|int
name|dummy
decl_stmt|;
comment|/* trash */
name|xfs_dir2_data_unused_t
modifier|*
name|dup
decl_stmt|;
comment|/* unused entry pointer */
name|int
name|endoffset
decl_stmt|;
comment|/* end of data objects */
name|int
name|error
decl_stmt|;
comment|/* error return value */
name|int
name|i
decl_stmt|;
comment|/* index */
name|xfs_mount_t
modifier|*
name|mp
decl_stmt|;
comment|/* filesystem mount point */
name|int
name|needlog
decl_stmt|;
comment|/* need to log block header */
name|int
name|needscan
decl_stmt|;
comment|/* need to scan block freespc */
name|int
name|newoffset
decl_stmt|;
comment|/* offset from current entry */
name|int
name|offset
decl_stmt|;
comment|/* target block offset */
name|xfs_dir2_sf_entry_t
modifier|*
name|sfep
decl_stmt|;
comment|/* sf entry pointer */
name|xfs_dir2_sf_t
modifier|*
name|sfp
decl_stmt|;
comment|/* shortform structure */
name|xfs_dir2_data_off_t
modifier|*
name|tagp
decl_stmt|;
comment|/* end of data entry */
name|xfs_trans_t
modifier|*
name|tp
decl_stmt|;
comment|/* transaction pointer */
name|xfs_dir2_trace_args
argument_list|(
literal|"sf_to_block"
argument_list|,
name|args
argument_list|)
expr_stmt|;
name|dp
operator|=
name|args
operator|->
name|dp
expr_stmt|;
name|tp
operator|=
name|args
operator|->
name|trans
expr_stmt|;
name|mp
operator|=
name|dp
operator|->
name|i_mount
expr_stmt|;
name|ASSERT
argument_list|(
name|dp
operator|->
name|i_df
operator|.
name|if_flags
operator|&
name|XFS_IFINLINE
argument_list|)
expr_stmt|;
comment|/* 	 * Bomb out if the shortform directory is way too short. 	 */
if|if
condition|(
name|dp
operator|->
name|i_d
operator|.
name|di_size
operator|<
name|offsetof
argument_list|(
name|xfs_dir2_sf_hdr_t
argument_list|,
name|parent
argument_list|)
condition|)
block|{
name|ASSERT
argument_list|(
name|XFS_FORCED_SHUTDOWN
argument_list|(
name|mp
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|XFS_ERROR
argument_list|(
name|EIO
argument_list|)
return|;
block|}
name|ASSERT
argument_list|(
name|dp
operator|->
name|i_df
operator|.
name|if_bytes
operator|==
name|dp
operator|->
name|i_d
operator|.
name|di_size
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|dp
operator|->
name|i_df
operator|.
name|if_u1
operator|.
name|if_data
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|sfp
operator|=
operator|(
name|xfs_dir2_sf_t
operator|*
operator|)
name|dp
operator|->
name|i_df
operator|.
name|if_u1
operator|.
name|if_data
expr_stmt|;
name|ASSERT
argument_list|(
name|dp
operator|->
name|i_d
operator|.
name|di_size
operator|>=
name|XFS_DIR2_SF_HDR_SIZE
argument_list|(
name|sfp
operator|->
name|hdr
operator|.
name|i8count
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Copy the directory into the stack buffer. 	 * Then pitch the incore inode data so we can make extents. 	 */
name|buf_len
operator|=
name|dp
operator|->
name|i_df
operator|.
name|if_bytes
expr_stmt|;
name|buf
operator|=
name|kmem_alloc
argument_list|(
name|dp
operator|->
name|i_df
operator|.
name|if_bytes
argument_list|,
name|KM_SLEEP
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|buf
argument_list|,
name|sfp
argument_list|,
name|dp
operator|->
name|i_df
operator|.
name|if_bytes
argument_list|)
expr_stmt|;
name|xfs_idata_realloc
argument_list|(
name|dp
argument_list|,
operator|-
name|dp
operator|->
name|i_df
operator|.
name|if_bytes
argument_list|,
name|XFS_DATA_FORK
argument_list|)
expr_stmt|;
name|dp
operator|->
name|i_d
operator|.
name|di_size
operator|=
literal|0
expr_stmt|;
name|xfs_trans_log_inode
argument_list|(
name|tp
argument_list|,
name|dp
argument_list|,
name|XFS_ILOG_CORE
argument_list|)
expr_stmt|;
comment|/* 	 * Reset pointer - old sfp is gone. 	 */
name|sfp
operator|=
operator|(
name|xfs_dir2_sf_t
operator|*
operator|)
name|buf
expr_stmt|;
comment|/* 	 * Add block 0 to the inode. 	 */
name|error
operator|=
name|xfs_dir2_grow_inode
argument_list|(
name|args
argument_list|,
name|XFS_DIR2_DATA_SPACE
argument_list|,
operator|&
name|blkno
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|kmem_free
argument_list|(
name|buf
argument_list|,
name|buf_len
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
comment|/* 	 * Initialize the data block. 	 */
name|error
operator|=
name|xfs_dir2_data_init
argument_list|(
name|args
argument_list|,
name|blkno
argument_list|,
operator|&
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|kmem_free
argument_list|(
name|buf
argument_list|,
name|buf_len
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
name|block
operator|=
name|bp
operator|->
name|data
expr_stmt|;
name|INT_SET
argument_list|(
name|block
operator|->
name|hdr
operator|.
name|magic
argument_list|,
name|ARCH_CONVERT
argument_list|,
name|XFS_DIR2_BLOCK_MAGIC
argument_list|)
expr_stmt|;
comment|/* 	 * Compute size of block "tail" area. 	 */
name|i
operator|=
operator|(
name|uint
operator|)
sizeof|sizeof
argument_list|(
operator|*
name|btp
argument_list|)
operator|+
operator|(
name|INT_GET
argument_list|(
name|sfp
operator|->
name|hdr
operator|.
name|count
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|+
literal|2
operator|)
operator|*
operator|(
name|uint
operator|)
sizeof|sizeof
argument_list|(
name|xfs_dir2_leaf_entry_t
argument_list|)
expr_stmt|;
comment|/* 	 * The whole thing is initialized to free by the init routine. 	 * Say we're using the leaf and tail area. 	 */
name|dup
operator|=
operator|(
name|xfs_dir2_data_unused_t
operator|*
operator|)
name|block
operator|->
name|u
expr_stmt|;
name|needlog
operator|=
name|needscan
operator|=
literal|0
expr_stmt|;
name|xfs_dir2_data_use_free
argument_list|(
name|tp
argument_list|,
name|bp
argument_list|,
name|dup
argument_list|,
name|mp
operator|->
name|m_dirblksize
operator|-
name|i
argument_list|,
name|i
argument_list|,
operator|&
name|needlog
argument_list|,
operator|&
name|needscan
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|needscan
operator|==
literal|0
argument_list|)
expr_stmt|;
comment|/* 	 * Fill in the tail. 	 */
name|btp
operator|=
name|XFS_DIR2_BLOCK_TAIL_P
argument_list|(
name|mp
argument_list|,
name|block
argument_list|)
expr_stmt|;
name|INT_SET
argument_list|(
name|btp
operator|->
name|count
argument_list|,
name|ARCH_CONVERT
argument_list|,
name|INT_GET
argument_list|(
name|sfp
operator|->
name|hdr
operator|.
name|count
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|+
literal|2
argument_list|)
expr_stmt|;
comment|/* ., .. */
name|INT_ZERO
argument_list|(
name|btp
operator|->
name|stale
argument_list|,
name|ARCH_CONVERT
argument_list|)
expr_stmt|;
name|blp
operator|=
name|XFS_DIR2_BLOCK_LEAF_P_ARCH
argument_list|(
name|btp
argument_list|,
name|ARCH_CONVERT
argument_list|)
expr_stmt|;
name|endoffset
operator|=
call|(
name|uint
call|)
argument_list|(
operator|(
name|char
operator|*
operator|)
name|blp
operator|-
operator|(
name|char
operator|*
operator|)
name|block
argument_list|)
expr_stmt|;
comment|/* 	 * Remove the freespace, we'll manage it. 	 */
name|xfs_dir2_data_use_free
argument_list|(
name|tp
argument_list|,
name|bp
argument_list|,
name|dup
argument_list|,
call|(
name|xfs_dir2_data_aoff_t
call|)
argument_list|(
operator|(
name|char
operator|*
operator|)
name|dup
operator|-
operator|(
name|char
operator|*
operator|)
name|block
argument_list|)
argument_list|,
name|INT_GET
argument_list|(
name|dup
operator|->
name|length
argument_list|,
name|ARCH_CONVERT
argument_list|)
argument_list|,
operator|&
name|needlog
argument_list|,
operator|&
name|needscan
argument_list|)
expr_stmt|;
comment|/* 	 * Create entry for . 	 */
name|dep
operator|=
operator|(
name|xfs_dir2_data_entry_t
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|block
operator|+
name|XFS_DIR2_DATA_DOT_OFFSET
operator|)
expr_stmt|;
name|INT_SET
argument_list|(
name|dep
operator|->
name|inumber
argument_list|,
name|ARCH_CONVERT
argument_list|,
name|dp
operator|->
name|i_ino
argument_list|)
expr_stmt|;
name|dep
operator|->
name|namelen
operator|=
literal|1
expr_stmt|;
name|dep
operator|->
name|name
index|[
literal|0
index|]
operator|=
literal|'.'
expr_stmt|;
name|tagp
operator|=
name|XFS_DIR2_DATA_ENTRY_TAG_P
argument_list|(
name|dep
argument_list|)
expr_stmt|;
name|INT_SET
argument_list|(
operator|*
name|tagp
argument_list|,
name|ARCH_CONVERT
argument_list|,
call|(
name|xfs_dir2_data_off_t
call|)
argument_list|(
operator|(
name|char
operator|*
operator|)
name|dep
operator|-
operator|(
name|char
operator|*
operator|)
name|block
argument_list|)
argument_list|)
expr_stmt|;
name|xfs_dir2_data_log_entry
argument_list|(
name|tp
argument_list|,
name|bp
argument_list|,
name|dep
argument_list|)
expr_stmt|;
name|INT_SET
argument_list|(
name|blp
index|[
literal|0
index|]
operator|.
name|hashval
argument_list|,
name|ARCH_CONVERT
argument_list|,
name|xfs_dir_hash_dot
argument_list|)
expr_stmt|;
name|INT_SET
argument_list|(
name|blp
index|[
literal|0
index|]
operator|.
name|address
argument_list|,
name|ARCH_CONVERT
argument_list|,
name|XFS_DIR2_BYTE_TO_DATAPTR
argument_list|(
name|mp
argument_list|,
operator|(
name|char
operator|*
operator|)
name|dep
operator|-
operator|(
name|char
operator|*
operator|)
name|block
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Create entry for .. 	 */
name|dep
operator|=
operator|(
name|xfs_dir2_data_entry_t
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|block
operator|+
name|XFS_DIR2_DATA_DOTDOT_OFFSET
operator|)
expr_stmt|;
name|INT_SET
argument_list|(
name|dep
operator|->
name|inumber
argument_list|,
name|ARCH_CONVERT
argument_list|,
name|XFS_DIR2_SF_GET_INUMBER_ARCH
argument_list|(
name|sfp
argument_list|,
operator|&
name|sfp
operator|->
name|hdr
operator|.
name|parent
argument_list|,
name|ARCH_CONVERT
argument_list|)
argument_list|)
expr_stmt|;
name|dep
operator|->
name|namelen
operator|=
literal|2
expr_stmt|;
name|dep
operator|->
name|name
index|[
literal|0
index|]
operator|=
name|dep
operator|->
name|name
index|[
literal|1
index|]
operator|=
literal|'.'
expr_stmt|;
name|tagp
operator|=
name|XFS_DIR2_DATA_ENTRY_TAG_P
argument_list|(
name|dep
argument_list|)
expr_stmt|;
name|INT_SET
argument_list|(
operator|*
name|tagp
argument_list|,
name|ARCH_CONVERT
argument_list|,
call|(
name|xfs_dir2_data_off_t
call|)
argument_list|(
operator|(
name|char
operator|*
operator|)
name|dep
operator|-
operator|(
name|char
operator|*
operator|)
name|block
argument_list|)
argument_list|)
expr_stmt|;
name|xfs_dir2_data_log_entry
argument_list|(
name|tp
argument_list|,
name|bp
argument_list|,
name|dep
argument_list|)
expr_stmt|;
name|INT_SET
argument_list|(
name|blp
index|[
literal|1
index|]
operator|.
name|hashval
argument_list|,
name|ARCH_CONVERT
argument_list|,
name|xfs_dir_hash_dotdot
argument_list|)
expr_stmt|;
name|INT_SET
argument_list|(
name|blp
index|[
literal|1
index|]
operator|.
name|address
argument_list|,
name|ARCH_CONVERT
argument_list|,
name|XFS_DIR2_BYTE_TO_DATAPTR
argument_list|(
name|mp
argument_list|,
operator|(
name|char
operator|*
operator|)
name|dep
operator|-
operator|(
name|char
operator|*
operator|)
name|block
argument_list|)
argument_list|)
expr_stmt|;
name|offset
operator|=
name|XFS_DIR2_DATA_FIRST_OFFSET
expr_stmt|;
comment|/* 	 * Loop over existing entries, stuff them in. 	 */
if|if
condition|(
operator|(
name|i
operator|=
literal|0
operator|)
operator|==
name|INT_GET
argument_list|(
name|sfp
operator|->
name|hdr
operator|.
name|count
argument_list|,
name|ARCH_CONVERT
argument_list|)
condition|)
name|sfep
operator|=
name|NULL
expr_stmt|;
else|else
name|sfep
operator|=
name|XFS_DIR2_SF_FIRSTENTRY
argument_list|(
name|sfp
argument_list|)
expr_stmt|;
comment|/* 	 * Need to preserve the existing offset values in the sf directory. 	 * Insert holes (unused entries) where necessary. 	 */
while|while
condition|(
name|offset
operator|<
name|endoffset
condition|)
block|{
comment|/* 		 * sfep is null when we reach the end of the list. 		 */
if|if
condition|(
name|sfep
operator|==
name|NULL
condition|)
name|newoffset
operator|=
name|endoffset
expr_stmt|;
else|else
name|newoffset
operator|=
name|XFS_DIR2_SF_GET_OFFSET_ARCH
argument_list|(
name|sfep
argument_list|,
name|ARCH_CONVERT
argument_list|)
expr_stmt|;
comment|/* 		 * There should be a hole here, make one. 		 */
if|if
condition|(
name|offset
operator|<
name|newoffset
condition|)
block|{
name|dup
operator|=
operator|(
name|xfs_dir2_data_unused_t
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|block
operator|+
name|offset
operator|)
expr_stmt|;
name|INT_SET
argument_list|(
name|dup
operator|->
name|freetag
argument_list|,
name|ARCH_CONVERT
argument_list|,
name|XFS_DIR2_DATA_FREE_TAG
argument_list|)
expr_stmt|;
name|INT_SET
argument_list|(
name|dup
operator|->
name|length
argument_list|,
name|ARCH_CONVERT
argument_list|,
name|newoffset
operator|-
name|offset
argument_list|)
expr_stmt|;
name|INT_SET
argument_list|(
operator|*
name|XFS_DIR2_DATA_UNUSED_TAG_P_ARCH
argument_list|(
name|dup
argument_list|,
name|ARCH_CONVERT
argument_list|)
argument_list|,
name|ARCH_CONVERT
argument_list|,
call|(
name|xfs_dir2_data_off_t
call|)
argument_list|(
operator|(
name|char
operator|*
operator|)
name|dup
operator|-
operator|(
name|char
operator|*
operator|)
name|block
argument_list|)
argument_list|)
expr_stmt|;
name|xfs_dir2_data_log_unused
argument_list|(
name|tp
argument_list|,
name|bp
argument_list|,
name|dup
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|xfs_dir2_data_freeinsert
argument_list|(
operator|(
name|xfs_dir2_data_t
operator|*
operator|)
name|block
argument_list|,
name|dup
argument_list|,
operator|&
name|dummy
argument_list|)
expr_stmt|;
name|offset
operator|+=
name|INT_GET
argument_list|(
name|dup
operator|->
name|length
argument_list|,
name|ARCH_CONVERT
argument_list|)
expr_stmt|;
continue|continue;
block|}
comment|/* 		 * Copy a real entry. 		 */
name|dep
operator|=
operator|(
name|xfs_dir2_data_entry_t
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|block
operator|+
name|newoffset
operator|)
expr_stmt|;
name|INT_SET
argument_list|(
name|dep
operator|->
name|inumber
argument_list|,
name|ARCH_CONVERT
argument_list|,
name|XFS_DIR2_SF_GET_INUMBER_ARCH
argument_list|(
name|sfp
argument_list|,
name|XFS_DIR2_SF_INUMBERP
argument_list|(
name|sfep
argument_list|)
argument_list|,
name|ARCH_CONVERT
argument_list|)
argument_list|)
expr_stmt|;
name|dep
operator|->
name|namelen
operator|=
name|sfep
operator|->
name|namelen
expr_stmt|;
name|memcpy
argument_list|(
name|dep
operator|->
name|name
argument_list|,
name|sfep
operator|->
name|name
argument_list|,
name|dep
operator|->
name|namelen
argument_list|)
expr_stmt|;
name|tagp
operator|=
name|XFS_DIR2_DATA_ENTRY_TAG_P
argument_list|(
name|dep
argument_list|)
expr_stmt|;
name|INT_SET
argument_list|(
operator|*
name|tagp
argument_list|,
name|ARCH_CONVERT
argument_list|,
call|(
name|xfs_dir2_data_off_t
call|)
argument_list|(
operator|(
name|char
operator|*
operator|)
name|dep
operator|-
operator|(
name|char
operator|*
operator|)
name|block
argument_list|)
argument_list|)
expr_stmt|;
name|xfs_dir2_data_log_entry
argument_list|(
name|tp
argument_list|,
name|bp
argument_list|,
name|dep
argument_list|)
expr_stmt|;
name|INT_SET
argument_list|(
name|blp
index|[
literal|2
operator|+
name|i
index|]
operator|.
name|hashval
argument_list|,
name|ARCH_CONVERT
argument_list|,
name|xfs_da_hashname
argument_list|(
operator|(
name|char
operator|*
operator|)
name|sfep
operator|->
name|name
argument_list|,
name|sfep
operator|->
name|namelen
argument_list|)
argument_list|)
expr_stmt|;
name|INT_SET
argument_list|(
name|blp
index|[
literal|2
operator|+
name|i
index|]
operator|.
name|address
argument_list|,
name|ARCH_CONVERT
argument_list|,
name|XFS_DIR2_BYTE_TO_DATAPTR
argument_list|(
name|mp
argument_list|,
operator|(
name|char
operator|*
operator|)
name|dep
operator|-
operator|(
name|char
operator|*
operator|)
name|block
argument_list|)
argument_list|)
expr_stmt|;
name|offset
operator|=
call|(
name|int
call|)
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|tagp
operator|+
literal|1
operator|)
operator|-
operator|(
name|char
operator|*
operator|)
name|block
argument_list|)
expr_stmt|;
if|if
condition|(
operator|++
name|i
operator|==
name|INT_GET
argument_list|(
name|sfp
operator|->
name|hdr
operator|.
name|count
argument_list|,
name|ARCH_CONVERT
argument_list|)
condition|)
name|sfep
operator|=
name|NULL
expr_stmt|;
else|else
name|sfep
operator|=
name|XFS_DIR2_SF_NEXTENTRY
argument_list|(
name|sfp
argument_list|,
name|sfep
argument_list|)
expr_stmt|;
block|}
comment|/* Done with the temporary buffer */
name|kmem_free
argument_list|(
name|buf
argument_list|,
name|buf_len
argument_list|)
expr_stmt|;
comment|/* 	 * Sort the leaf entries by hash value. 	 */
name|qsort
argument_list|(
name|blp
argument_list|,
name|INT_GET
argument_list|(
name|btp
operator|->
name|count
argument_list|,
name|ARCH_CONVERT
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|blp
argument_list|)
argument_list|,
name|xfs_dir2_block_sort
argument_list|)
expr_stmt|;
comment|/* 	 * Log the leaf entry area and tail. 	 * Already logged the header in data_init, ignore needlog. 	 */
name|ASSERT
argument_list|(
name|needscan
operator|==
literal|0
argument_list|)
expr_stmt|;
name|xfs_dir2_block_log_leaf
argument_list|(
name|tp
argument_list|,
name|bp
argument_list|,
literal|0
argument_list|,
name|INT_GET
argument_list|(
name|btp
operator|->
name|count
argument_list|,
name|ARCH_CONVERT
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|xfs_dir2_block_log_tail
argument_list|(
name|tp
argument_list|,
name|bp
argument_list|)
expr_stmt|;
name|xfs_dir2_data_check
argument_list|(
name|dp
argument_list|,
name|bp
argument_list|)
expr_stmt|;
name|xfs_da_buf_done
argument_list|(
name|bp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


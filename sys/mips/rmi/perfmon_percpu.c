begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2003-2009 RMI Corporation  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. Neither the name of RMI Corporation, nor the names of its contributors,  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * RMI_BSD */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/smp.h>
end_include

begin_include
include|#
directive|include
file|<sys/pcpu.h>
end_include

begin_include
include|#
directive|include
file|<mips/rmi/xlrconfig.h>
end_include

begin_include
include|#
directive|include
file|<mips/rmi/perfmon_xlrconfig.h>
end_include

begin_include
include|#
directive|include
file|<mips/rmi/perfmon.h>
end_include

begin_include
include|#
directive|include
file|<mips/rmi/perfmon_utils.h>
end_include

begin_include
include|#
directive|include
file|<mips/rmi/pic.h>
end_include

begin_include
include|#
directive|include
file|<mips/rmi/msgring.h>
end_include

begin_define
define|#
directive|define
name|CC_SAMPLE
value|(PERF_CP2_CREDITS<<24)
end_define

begin_define
define|#
directive|define
name|CC_REG0
value|16
end_define

begin_define
define|#
directive|define
name|CC_REG1
value|17
end_define

begin_define
define|#
directive|define
name|CC_REG2
value|18
end_define

begin_define
define|#
directive|define
name|CC_REG3
value|19
end_define

begin_define
define|#
directive|define
name|CC_REG4
value|20
end_define

begin_define
define|#
directive|define
name|CC_REG5
value|21
end_define

begin_define
define|#
directive|define
name|CC_REG6
value|22
end_define

begin_define
define|#
directive|define
name|CC_REG7
value|23
end_define

begin_define
define|#
directive|define
name|CC_REG8
value|24
end_define

begin_define
define|#
directive|define
name|CC_REG9
value|25
end_define

begin_define
define|#
directive|define
name|CC_REG10
value|26
end_define

begin_define
define|#
directive|define
name|CC_REG11
value|27
end_define

begin_define
define|#
directive|define
name|CC_REG12
value|28
end_define

begin_define
define|#
directive|define
name|CC_REG13
value|29
end_define

begin_define
define|#
directive|define
name|CC_REG14
value|30
end_define

begin_define
define|#
directive|define
name|CC_REG15
value|31
end_define

begin_decl_stmt
specifier|extern
name|uint32_t
name|cpu_ltop_map
index|[
name|MAXCPU
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|struct
name|perf_area
modifier|*
name|xlr_shared_config_area
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|__inline__
name|uint32_t
name|make_cpu_tag
parameter_list|(
name|uint32_t
name|val
parameter_list|)
block|{
return|return
name|PERF_CP0_COUNTER
operator|<<
literal|24
operator||
operator|(
name|val
operator|&
literal|0xffff
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|__inline__
name|uint32_t
name|make_cp0_perf_control
parameter_list|(
name|uint32_t
name|flags
parameter_list|,
name|uint32_t
name|thread
parameter_list|,
name|uint32_t
name|event
parameter_list|)
block|{
return|return
operator|(
name|flags
operator|&
literal|0x1f
operator|)
operator||
operator|(
name|thread
operator|&
literal|0x03
operator|)
operator|<<
literal|11
operator||
operator|(
name|event
operator|&
literal|0x3f
operator|)
operator|<<
literal|5
operator||
literal|0x01
return|;
block|}
end_function

begin_function
specifier|static
name|__inline__
name|uint32_t
name|cp0_perf_control_get_thread
parameter_list|(
name|uint32_t
name|control_word
parameter_list|)
block|{
return|return
operator|(
name|control_word
operator|&
literal|0x1800
operator|)
operator|>>
literal|11
return|;
block|}
end_function

begin_function
specifier|static
name|__inline__
name|uint32_t
name|cp0_perf_control_get_event
parameter_list|(
name|uint32_t
name|control_word
parameter_list|)
block|{
return|return
operator|(
name|control_word
operator|&
literal|0x7e0
operator|)
operator|>>
literal|5
return|;
block|}
end_function

begin_function
specifier|static
name|__inline__
name|uint32_t
name|read_pic_6_timer_count
parameter_list|(
name|void
parameter_list|)
block|{
name|xlr_reg_t
modifier|*
name|mmio
init|=
name|xlr_io_mmio
argument_list|(
name|XLR_IO_PIC_OFFSET
argument_list|)
decl_stmt|;
comment|/* PIC counts down, convert it to count up */
return|return
literal|0xffffffffU
operator|-
name|xlr_read_reg
argument_list|(
name|mmio
argument_list|,
name|PIC_TIMER_6_COUNTER_0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|get_num_events
parameter_list|(
specifier|const
name|uint64_t
modifier|*
name|events
parameter_list|)
block|{
name|int
name|total
init|=
literal|0
decl_stmt|;
name|int
name|thread
decl_stmt|;
for|for
control|(
name|thread
operator|=
literal|0
init|;
name|thread
operator|<
name|NTHREADS
condition|;
name|thread
operator|++
control|)
block|{
if|if
condition|(
name|events
index|[
name|thread
index|]
operator|==
literal|0
condition|)
continue|continue;
name|total
operator|+=
name|get_set_bit_count64
argument_list|(
name|events
index|[
name|thread
index|]
argument_list|)
expr_stmt|;
block|}
return|return
name|total
return|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|get_first_control_word
parameter_list|(
name|uint32_t
name|flags
parameter_list|,
specifier|const
name|uint64_t
modifier|*
name|events
parameter_list|)
block|{
name|int
name|thread
decl_stmt|,
name|event
decl_stmt|;
for|for
control|(
name|thread
operator|=
literal|0
init|;
name|thread
operator|<
name|NTHREADS
condition|;
name|thread
operator|++
control|)
block|{
if|if
condition|(
name|events
index|[
name|thread
index|]
operator|!=
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|thread
operator|==
name|NTHREADS
condition|)
return|return
operator|-
literal|1
return|;
name|event
operator|=
name|find_first_set_bit64
argument_list|(
name|events
index|[
name|thread
index|]
argument_list|)
expr_stmt|;
return|return
name|make_cp0_perf_control
argument_list|(
name|flags
argument_list|,
name|thread
argument_list|,
name|event
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|get_next_control_word
parameter_list|(
name|uint32_t
name|current_control_word
parameter_list|,
specifier|const
name|uint64_t
modifier|*
name|events
parameter_list|)
block|{
name|int
name|thread
init|=
name|cp0_perf_control_get_thread
argument_list|(
name|current_control_word
argument_list|)
decl_stmt|;
name|int
name|event
init|=
name|cp0_perf_control_get_event
argument_list|(
name|current_control_word
argument_list|)
decl_stmt|;
name|int
name|i
decl_stmt|;
name|event
operator|=
name|find_next_set_bit64
argument_list|(
name|events
index|[
name|thread
index|]
argument_list|,
name|event
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|event
operator|==
operator|-
literal|1
operator|&&
name|i
operator|<
name|NTHREADS
condition|;
name|i
operator|++
control|)
block|{
name|thread
operator|=
operator|(
name|thread
operator|+
literal|1
operator|)
operator|%
name|NTHREADS
expr_stmt|;
if|if
condition|(
name|events
index|[
name|thread
index|]
operator|==
literal|0
condition|)
continue|continue;
name|event
operator|=
name|find_first_set_bit64
argument_list|(
name|events
index|[
name|thread
index|]
argument_list|)
expr_stmt|;
block|}
name|ASSERT
argument_list|(
name|event
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
return|return
name|make_cp0_perf_control
argument_list|(
name|current_control_word
argument_list|,
name|thread
argument_list|,
name|event
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Global state per core */
end_comment

begin_define
define|#
directive|define
name|MY_CORE_NUM
value|(cpu_ltop_map[PCPU_GET(cpuid)]/NTHREADS)
end_define

begin_define
define|#
directive|define
name|my_perf_area
value|(&(xlr_shared_config_area[MY_CORE_NUM]))
end_define

begin_decl_stmt
specifier|static
name|int
name|num_events_array
index|[
name|NCORES
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|uint32_t
name|saved_timestamp_array
index|[
name|NCORES
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|perf_config_data
name|saved_config_array
index|[
name|NCORES
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|cc_sample_array
index|[
name|NCORES
index|]
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|num_events
value|(num_events_array[MY_CORE_NUM])
end_define

begin_define
define|#
directive|define
name|saved_timestamp
value|(saved_timestamp_array[MY_CORE_NUM])
end_define

begin_define
define|#
directive|define
name|saved_config
value|(saved_config_array[MY_CORE_NUM])
end_define

begin_define
define|#
directive|define
name|cc_sample
value|(cc_sample_array[MY_CORE_NUM])
end_define

begin_function
specifier|static
name|void
name|do_sample_cc_registers
parameter_list|(
name|struct
name|sample_q
modifier|*
name|q
parameter_list|,
name|uint32_t
name|mask
parameter_list|)
block|{
name|unsigned
name|long
name|flags
decl_stmt|;
name|DPRINT
argument_list|(
literal|"Sample CC registers %x"
argument_list|,
name|mask
argument_list|)
expr_stmt|;
name|msgrng_flags_save
argument_list|(
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|mask
operator|&
literal|0x00000001
condition|)
name|put_sample
argument_list|(
name|q
argument_list|,
name|CC_SAMPLE
operator|+
literal|0
argument_list|,
name|read_cc_registers_0123
argument_list|(
name|CC_REG0
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|mask
operator|&
literal|0x00000002
condition|)
name|put_sample
argument_list|(
name|q
argument_list|,
name|CC_SAMPLE
operator|+
literal|1
argument_list|,
name|read_cc_registers_4567
argument_list|(
name|CC_REG0
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|mask
operator|&
literal|0x00000004
condition|)
name|put_sample
argument_list|(
name|q
argument_list|,
name|CC_SAMPLE
operator|+
literal|2
argument_list|,
name|read_cc_registers_0123
argument_list|(
name|CC_REG1
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|mask
operator|&
literal|0x00000008
condition|)
name|put_sample
argument_list|(
name|q
argument_list|,
name|CC_SAMPLE
operator|+
literal|3
argument_list|,
name|read_cc_registers_4567
argument_list|(
name|CC_REG1
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|mask
operator|&
literal|0x00000010
condition|)
name|put_sample
argument_list|(
name|q
argument_list|,
name|CC_SAMPLE
operator|+
literal|4
argument_list|,
name|read_cc_registers_0123
argument_list|(
name|CC_REG2
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|mask
operator|&
literal|0x00000020
condition|)
name|put_sample
argument_list|(
name|q
argument_list|,
name|CC_SAMPLE
operator|+
literal|5
argument_list|,
name|read_cc_registers_4567
argument_list|(
name|CC_REG2
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|mask
operator|&
literal|0x00000040
condition|)
name|put_sample
argument_list|(
name|q
argument_list|,
name|CC_SAMPLE
operator|+
literal|6
argument_list|,
name|read_cc_registers_0123
argument_list|(
name|CC_REG3
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|mask
operator|&
literal|0x00000080
condition|)
name|put_sample
argument_list|(
name|q
argument_list|,
name|CC_SAMPLE
operator|+
literal|7
argument_list|,
name|read_cc_registers_4567
argument_list|(
name|CC_REG3
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|mask
operator|&
literal|0x00000100
condition|)
name|put_sample
argument_list|(
name|q
argument_list|,
name|CC_SAMPLE
operator|+
literal|8
argument_list|,
name|read_cc_registers_0123
argument_list|(
name|CC_REG4
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|mask
operator|&
literal|0x00000200
condition|)
name|put_sample
argument_list|(
name|q
argument_list|,
name|CC_SAMPLE
operator|+
literal|9
argument_list|,
name|read_cc_registers_4567
argument_list|(
name|CC_REG4
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|mask
operator|&
literal|0x00000400
condition|)
name|put_sample
argument_list|(
name|q
argument_list|,
name|CC_SAMPLE
operator|+
literal|10
argument_list|,
name|read_cc_registers_0123
argument_list|(
name|CC_REG5
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|mask
operator|&
literal|0x00000800
condition|)
name|put_sample
argument_list|(
name|q
argument_list|,
name|CC_SAMPLE
operator|+
literal|11
argument_list|,
name|read_cc_registers_4567
argument_list|(
name|CC_REG5
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|mask
operator|&
literal|0x00001000
condition|)
name|put_sample
argument_list|(
name|q
argument_list|,
name|CC_SAMPLE
operator|+
literal|12
argument_list|,
name|read_cc_registers_0123
argument_list|(
name|CC_REG6
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|mask
operator|&
literal|0x00002000
condition|)
name|put_sample
argument_list|(
name|q
argument_list|,
name|CC_SAMPLE
operator|+
literal|13
argument_list|,
name|read_cc_registers_4567
argument_list|(
name|CC_REG6
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|mask
operator|&
literal|0x00004000
condition|)
name|put_sample
argument_list|(
name|q
argument_list|,
name|CC_SAMPLE
operator|+
literal|14
argument_list|,
name|read_cc_registers_0123
argument_list|(
name|CC_REG7
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|mask
operator|&
literal|0x00008000
condition|)
name|put_sample
argument_list|(
name|q
argument_list|,
name|CC_SAMPLE
operator|+
literal|15
argument_list|,
name|read_cc_registers_4567
argument_list|(
name|CC_REG7
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|mask
operator|&
literal|0x00010000
condition|)
name|put_sample
argument_list|(
name|q
argument_list|,
name|CC_SAMPLE
operator|+
literal|16
argument_list|,
name|read_cc_registers_0123
argument_list|(
name|CC_REG8
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|mask
operator|&
literal|0x00020000
condition|)
name|put_sample
argument_list|(
name|q
argument_list|,
name|CC_SAMPLE
operator|+
literal|17
argument_list|,
name|read_cc_registers_4567
argument_list|(
name|CC_REG8
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|mask
operator|&
literal|0x00040000
condition|)
name|put_sample
argument_list|(
name|q
argument_list|,
name|CC_SAMPLE
operator|+
literal|18
argument_list|,
name|read_cc_registers_0123
argument_list|(
name|CC_REG9
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|mask
operator|&
literal|0x00080000
condition|)
name|put_sample
argument_list|(
name|q
argument_list|,
name|CC_SAMPLE
operator|+
literal|19
argument_list|,
name|read_cc_registers_4567
argument_list|(
name|CC_REG9
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|mask
operator|&
literal|0x00100000
condition|)
name|put_sample
argument_list|(
name|q
argument_list|,
name|CC_SAMPLE
operator|+
literal|20
argument_list|,
name|read_cc_registers_0123
argument_list|(
name|CC_REG10
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|mask
operator|&
literal|0x00200000
condition|)
name|put_sample
argument_list|(
name|q
argument_list|,
name|CC_SAMPLE
operator|+
literal|21
argument_list|,
name|read_cc_registers_4567
argument_list|(
name|CC_REG10
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|mask
operator|&
literal|0x00400000
condition|)
name|put_sample
argument_list|(
name|q
argument_list|,
name|CC_SAMPLE
operator|+
literal|22
argument_list|,
name|read_cc_registers_0123
argument_list|(
name|CC_REG11
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|mask
operator|&
literal|0x00800000
condition|)
name|put_sample
argument_list|(
name|q
argument_list|,
name|CC_SAMPLE
operator|+
literal|23
argument_list|,
name|read_cc_registers_4567
argument_list|(
name|CC_REG11
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|mask
operator|&
literal|0x01000000
condition|)
name|put_sample
argument_list|(
name|q
argument_list|,
name|CC_SAMPLE
operator|+
literal|24
argument_list|,
name|read_cc_registers_0123
argument_list|(
name|CC_REG12
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|mask
operator|&
literal|0x02000000
condition|)
name|put_sample
argument_list|(
name|q
argument_list|,
name|CC_SAMPLE
operator|+
literal|24
argument_list|,
name|read_cc_registers_4567
argument_list|(
name|CC_REG12
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|mask
operator|&
literal|0x04000000
condition|)
name|put_sample
argument_list|(
name|q
argument_list|,
name|CC_SAMPLE
operator|+
literal|26
argument_list|,
name|read_cc_registers_0123
argument_list|(
name|CC_REG13
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|mask
operator|&
literal|0x08000000
condition|)
name|put_sample
argument_list|(
name|q
argument_list|,
name|CC_SAMPLE
operator|+
literal|27
argument_list|,
name|read_cc_registers_4567
argument_list|(
name|CC_REG13
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|mask
operator|&
literal|0x10000000
condition|)
name|put_sample
argument_list|(
name|q
argument_list|,
name|CC_SAMPLE
operator|+
literal|28
argument_list|,
name|read_cc_registers_0123
argument_list|(
name|CC_REG14
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|mask
operator|&
literal|0x20000000
condition|)
name|put_sample
argument_list|(
name|q
argument_list|,
name|CC_SAMPLE
operator|+
literal|29
argument_list|,
name|read_cc_registers_4567
argument_list|(
name|CC_REG14
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|mask
operator|&
literal|0x40000000
condition|)
name|put_sample
argument_list|(
name|q
argument_list|,
name|CC_SAMPLE
operator|+
literal|30
argument_list|,
name|read_cc_registers_0123
argument_list|(
name|CC_REG15
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|mask
operator|&
literal|0x80000000
condition|)
name|put_sample
argument_list|(
name|q
argument_list|,
name|CC_SAMPLE
operator|+
literal|31
argument_list|,
name|read_cc_registers_4567
argument_list|(
name|CC_REG15
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|msgrng_flags_restore
argument_list|(
name|flags
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|reconfigure
parameter_list|(
name|void
parameter_list|)
block|{
name|uint32_t
name|cntr_cntrl
decl_stmt|;
name|saved_config
operator|=
name|my_perf_area
operator|->
name|perf_config
expr_stmt|;
name|num_events
operator|=
name|get_num_events
argument_list|(
name|saved_config
operator|.
name|events
argument_list|)
expr_stmt|;
name|cc_sample
operator|=
name|saved_config
operator|.
name|cc_sample_rate
expr_stmt|;
name|DPRINT
argument_list|(
literal|"%d - reconfigure num_events = %d, events = %llx,%llx,%llx,%llx\n"
argument_list|,
name|processor_id
argument_list|()
argument_list|,
name|num_events
argument_list|,
name|saved_config
operator|.
name|events
index|[
literal|0
index|]
argument_list|,
name|saved_config
operator|.
name|events
index|[
literal|1
index|]
argument_list|,
name|saved_config
operator|.
name|events
index|[
literal|2
index|]
argument_list|,
name|saved_config
operator|.
name|events
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|num_events
operator|==
literal|0
condition|)
return|return;
name|cntr_cntrl
operator|=
name|get_first_control_word
argument_list|(
name|saved_config
operator|.
name|flags
argument_list|,
name|saved_config
operator|.
name|events
argument_list|)
expr_stmt|;
name|write_c0_register
argument_list|(
name|CP0_PERF_COUNTER
argument_list|,
name|PERFCNTRCTL0
argument_list|,
name|cntr_cntrl
argument_list|)
expr_stmt|;
name|write_c0_register
argument_list|(
name|CP0_PERF_COUNTER
argument_list|,
name|PERFCNTR0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* reset count */
if|if
condition|(
name|num_events
operator|>
literal|1
condition|)
block|{
name|cntr_cntrl
operator|=
name|get_next_control_word
argument_list|(
name|cntr_cntrl
argument_list|,
name|saved_config
operator|.
name|events
argument_list|)
expr_stmt|;
name|write_c0_register
argument_list|(
name|CP0_PERF_COUNTER
argument_list|,
name|PERFCNTRCTL1
argument_list|,
name|cntr_cntrl
argument_list|)
expr_stmt|;
name|write_c0_register
argument_list|(
name|CP0_PERF_COUNTER
argument_list|,
name|PERFCNTR1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* reset count */
block|}
name|saved_timestamp
operator|=
name|read_pic_6_timer_count
argument_list|()
expr_stmt|;
block|}
end_function

begin_decl_stmt
name|int
name|xlr_perfmon_no_event_count
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|xlr_perfmon_sample_count
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* timer callback routine */
end_comment

begin_function
name|void
name|xlr_perfmon_sampler
parameter_list|(
name|void
modifier|*
name|dummy
parameter_list|)
block|{
name|uint32_t
name|current_ts
decl_stmt|;
name|uint32_t
name|cntr_cntrl
init|=
literal|0
decl_stmt|;
comment|/* xlr_ack_interrupt(XLR_PERFMON_IPI_VECTOR); */
if|if
condition|(
name|my_perf_area
operator|->
name|perf_config
operator|.
name|magic
operator|!=
name|PERFMON_ACTIVE_MAGIC
condition|)
return|return;
comment|/* 	 * If there has been a change in configuation, update the 	 * configuration 	 */
if|if
condition|(
name|saved_config
operator|.
name|generation
operator|!=
name|my_perf_area
operator|->
name|perf_config
operator|.
name|generation
condition|)
block|{
name|reconfigure
argument_list|()
expr_stmt|;
return|return;
block|}
comment|/* credit counter samples if reqd */
if|if
condition|(
name|saved_config
operator|.
name|cc_register_mask
operator|&&
operator|--
name|cc_sample
operator|==
literal|0
condition|)
block|{
name|cc_sample
operator|=
name|saved_config
operator|.
name|cc_sample_rate
expr_stmt|;
name|do_sample_cc_registers
argument_list|(
operator|&
name|my_perf_area
operator|->
name|sample_fifo
argument_list|,
name|my_perf_area
operator|->
name|perf_config
operator|.
name|cc_register_mask
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|num_events
operator|==
literal|0
condition|)
block|{
name|xlr_perfmon_no_event_count
operator|++
expr_stmt|;
return|return;
block|}
comment|/* put samples in the queue */
name|current_ts
operator|=
name|read_pic_6_timer_count
argument_list|()
expr_stmt|;
name|cntr_cntrl
operator|=
name|read_c0_register
argument_list|(
name|CP0_PERF_COUNTER
argument_list|,
name|PERFCNTRCTL0
argument_list|)
expr_stmt|;
name|put_sample
argument_list|(
operator|&
name|my_perf_area
operator|->
name|sample_fifo
argument_list|,
name|make_cpu_tag
argument_list|(
name|cntr_cntrl
argument_list|)
argument_list|,
name|read_c0_register
argument_list|(
name|CP0_PERF_COUNTER
argument_list|,
name|PERFCNTR0
argument_list|)
argument_list|,
name|current_ts
operator|-
name|saved_timestamp
argument_list|)
expr_stmt|;
name|xlr_perfmon_sample_count
operator|++
expr_stmt|;
name|write_c0_register
argument_list|(
name|CP0_PERF_COUNTER
argument_list|,
name|PERFCNTR0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* reset count */
if|if
condition|(
name|num_events
operator|>
literal|1
condition|)
block|{
name|cntr_cntrl
operator|=
name|read_c0_register
argument_list|(
name|CP0_PERF_COUNTER
argument_list|,
name|PERFCNTRCTL1
argument_list|)
expr_stmt|;
name|put_sample
argument_list|(
operator|&
name|my_perf_area
operator|->
name|sample_fifo
argument_list|,
name|make_cpu_tag
argument_list|(
name|cntr_cntrl
argument_list|)
argument_list|,
name|read_c0_register
argument_list|(
name|CP0_PERF_COUNTER
argument_list|,
name|PERFCNTR1
argument_list|)
argument_list|,
name|current_ts
operator|-
name|saved_timestamp
argument_list|)
expr_stmt|;
name|xlr_perfmon_sample_count
operator|++
expr_stmt|;
name|write_c0_register
argument_list|(
name|CP0_PERF_COUNTER
argument_list|,
name|PERFCNTR1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* reset count */
if|if
condition|(
name|num_events
operator|>
literal|2
condition|)
block|{
comment|/* multiplex events */
name|cntr_cntrl
operator|=
name|get_next_control_word
argument_list|(
name|cntr_cntrl
argument_list|,
name|saved_config
operator|.
name|events
argument_list|)
expr_stmt|;
name|write_c0_register
argument_list|(
name|CP0_PERF_COUNTER
argument_list|,
name|PERFCNTRCTL0
argument_list|,
name|cntr_cntrl
argument_list|)
expr_stmt|;
name|cntr_cntrl
operator|=
name|get_next_control_word
argument_list|(
name|cntr_cntrl
argument_list|,
name|saved_config
operator|.
name|events
argument_list|)
expr_stmt|;
name|write_c0_register
argument_list|(
name|CP0_PERF_COUNTER
argument_list|,
name|PERFCNTRCTL1
argument_list|,
name|cntr_cntrl
argument_list|)
expr_stmt|;
block|}
block|}
name|saved_timestamp
operator|=
name|read_pic_6_timer_count
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Initializes time to gather CPU performance counters and credit counters  */
end_comment

begin_function
name|void
name|xlr_perfmon_init_cpu
parameter_list|(
name|void
modifier|*
name|dummy
parameter_list|)
block|{
name|int
name|processor
init|=
name|cpu_ltop_map
index|[
name|PCPU_GET
argument_list|(
name|cpuid
argument_list|)
index|]
decl_stmt|;
comment|/* run on just one thread per core */
if|if
condition|(
name|processor
operator|%
literal|4
condition|)
return|return;
name|DPRINT
argument_list|(
literal|"%d : configure with %p"
argument_list|,
name|processor
argument_list|,
name|my_perf_area
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|my_perf_area
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|my_perf_area
argument_list|)
argument_list|)
expr_stmt|;
name|init_fifo
argument_list|(
operator|&
name|my_perf_area
operator|->
name|sample_fifo
argument_list|)
expr_stmt|;
name|my_perf_area
operator|->
name|perf_config
operator|.
name|magic
operator|=
name|PERFMON_ENABLED_MAGIC
expr_stmt|;
name|my_perf_area
operator|->
name|perf_config
operator|.
name|generation
operator|=
name|PERFMON_INITIAL_GENERATION
expr_stmt|;
name|DPRINT
argument_list|(
literal|"%d : Initialize"
argument_list|,
name|processor
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

end_unit


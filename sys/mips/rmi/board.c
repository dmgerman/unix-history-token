begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*********************************************************************  *  * Copyright 2003-2006 Raza Microelectronics, Inc. (RMI). All rights  * reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  * 1. Redistributions of source code must retain the above copyright  * notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  * notice, this list of conditions and the following disclaimer in  * the documentation and/or other materials provided with the  * distribution.  *  * THIS SOFTWARE IS PROVIDED BY Raza Microelectronics, Inc. ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR  * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL RMI OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  * SUBSTITUTE GOODS OR SERVICES, LOSS OF USE, DATA, OR PROFITS, OR BUSINESS  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF  * THE POSSIBILITY OF SUCH DAMAGE.  *  * *****************************RMI_2**********************************/
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_comment
comment|/* RCS ID& Copyright macro defns */
end_comment

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<machine/cpufunc.h>
end_include

begin_include
include|#
directive|include
file|<mips/rmi/msgring.h>
end_include

begin_include
include|#
directive|include
file|<mips/rmi/rmi_boot_info.h>
end_include

begin_include
include|#
directive|include
file|<mips/rmi/board.h>
end_include

begin_include
include|#
directive|include
file|<mips/rmi/pic.h>
end_include

begin_decl_stmt
name|struct
name|stn_cc
modifier|*
name|xlr_core_cc_configs
index|[]
init|=
block|{
operator|&
name|cc_table_cpu_0
block|,
operator|&
name|cc_table_cpu_1
block|,
operator|&
name|cc_table_cpu_2
block|,
operator|&
name|cc_table_cpu_3
block|,
operator|&
name|cc_table_cpu_4
block|,
operator|&
name|cc_table_cpu_5
block|,
operator|&
name|cc_table_cpu_6
block|,
operator|&
name|cc_table_cpu_7
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|stn_cc
modifier|*
name|xls_core_cc_configs
index|[]
init|=
block|{
operator|&
name|xls_cc_table_cpu_0
block|,
operator|&
name|xls_cc_table_cpu_1
block|,
operator|&
name|xls_cc_table_cpu_2
block|,
operator|&
name|xls_cc_table_cpu_3
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|xlr_board_info
name|xlr_board_info
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|xlr_pcmcia_present
parameter_list|(
name|void
parameter_list|)
block|{
name|xlr_reg_t
modifier|*
name|mmio
init|=
name|xlr_io_mmio
argument_list|(
name|XLR_IO_GPIO_OFFSET
argument_list|)
decl_stmt|;
name|uint32_t
name|resetconf
decl_stmt|;
name|resetconf
operator|=
name|xlr_read_reg
argument_list|(
name|mmio
argument_list|,
literal|21
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
name|resetconf
operator|&
literal|0x4000
operator|)
operator|!=
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|xlr_chip_specific_overrides
parameter_list|(
name|struct
name|xlr_board_info
modifier|*
name|board
parameter_list|)
block|{
name|struct
name|xlr_gmac_block_t
modifier|*
name|blk0
decl_stmt|,
modifier|*
name|blk1
decl_stmt|,
modifier|*
name|blk2
decl_stmt|;
name|uint32_t
name|chipid
decl_stmt|;
name|uint32_t
name|revision
decl_stmt|;
name|blk0
operator|=
operator|&
name|board
operator|->
name|gmac_block
index|[
literal|0
index|]
expr_stmt|;
name|blk1
operator|=
operator|&
name|board
operator|->
name|gmac_block
index|[
literal|1
index|]
expr_stmt|;
name|blk2
operator|=
operator|&
name|board
operator|->
name|gmac_block
index|[
literal|2
index|]
expr_stmt|;
name|chipid
operator|=
name|xlr_processor_id
argument_list|()
expr_stmt|;
name|revision
operator|=
name|xlr_revision
argument_list|()
expr_stmt|;
if|if
condition|(
name|revision
operator|==
literal|0x04
condition|)
block|{
comment|/* B2 */
switch|switch
condition|(
name|chipid
condition|)
block|{
case|case
literal|0x07
case|:
comment|/* XLR 508 */
case|case
literal|0x08
case|:
comment|/* XLR 516 */
case|case
literal|0x09
case|:
comment|/* XLR 532 */
comment|/* NA[12] not available */
name|memset
argument_list|(
name|blk1
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|blk1
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|blk2
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|blk2
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x06
case|:
comment|/* XLR 308 */
comment|/* NA0 has 3 ports */
name|blk0
operator|->
name|gmac_port
index|[
literal|3
index|]
operator|.
name|valid
operator|=
literal|0
expr_stmt|;
name|blk0
operator|->
name|num_ports
operator|--
expr_stmt|;
comment|/* NA[12] not available */
name|memset
argument_list|(
name|blk1
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|blk1
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|blk2
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|blk2
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
elseif|else
if|if
condition|(
name|revision
operator|==
literal|0x91
condition|)
block|{
comment|/* C4 */
switch|switch
condition|(
name|chipid
condition|)
block|{
case|case
literal|0x0B
case|:
comment|/* XLR 508 */
case|case
literal|0x0A
case|:
comment|/* XLR 516 */
case|case
literal|0x08
case|:
comment|/* XLR 532 */
comment|/* NA[12] not available */
name|memset
argument_list|(
name|blk1
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|blk1
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|blk2
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|blk2
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x0F
case|:
comment|/* XLR 308 */
comment|/* NA0 has 3 ports */
name|blk0
operator|->
name|gmac_port
index|[
literal|3
index|]
operator|.
name|valid
operator|=
literal|0
expr_stmt|;
name|blk0
operator|->
name|num_ports
operator|--
expr_stmt|;
comment|/* NA[12] not available */
name|memset
argument_list|(
name|blk1
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|blk1
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|blk2
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|blk2
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
else|else
block|{
comment|/* other pre-production silicon */
switch|switch
condition|(
name|chipid
condition|)
block|{
comment|/* XLR 5xx */
case|case
literal|0x0B
case|:
case|case
literal|0x0A
case|:
case|case
literal|0x07
case|:
case|case
literal|0x08
case|:
case|case
literal|0x09
case|:
comment|/* NA[12] not available */
name|memset
argument_list|(
name|blk1
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|blk1
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|blk2
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|blk2
argument_list|)
argument_list|)
expr_stmt|;
break|break;
comment|/* XLR 3xx */
case|case
literal|0x0F
case|:
case|case
literal|0x06
case|:
comment|/* NA0 has 3 ports */
name|blk0
operator|->
name|gmac_port
index|[
literal|3
index|]
operator|.
name|valid
operator|=
literal|0
expr_stmt|;
name|blk0
operator|->
name|num_ports
operator|--
expr_stmt|;
comment|/* NA[12] not available */
name|memset
argument_list|(
name|blk1
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|blk1
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|blk2
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|blk2
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|xlr_board_specific_overrides
parameter_list|(
name|struct
name|xlr_board_info
modifier|*
name|board
parameter_list|)
block|{
name|struct
name|xlr_gmac_block_t
modifier|*
name|blk1
decl_stmt|,
modifier|*
name|blk2
decl_stmt|;
name|blk1
operator|=
operator|&
name|board
operator|->
name|gmac_block
index|[
literal|1
index|]
expr_stmt|;
name|blk2
operator|=
operator|&
name|board
operator|->
name|gmac_block
index|[
literal|2
index|]
expr_stmt|;
switch|switch
condition|(
name|xlr_boot1_info
operator|.
name|board_major_version
condition|)
block|{
case|case
name|RMI_XLR_BOARD_ARIZONA_I
case|:
comment|/* ATX-I has SPI-4, not XGMAC */
name|blk1
operator|->
name|type
operator|=
name|XLR_SPI4
expr_stmt|;
name|blk1
operator|->
name|enabled
operator|=
literal|0
expr_stmt|;
comment|/* nlge does not 							 support SPI-4 */
name|blk2
operator|->
name|type
operator|=
name|XLR_SPI4
expr_stmt|;
name|blk2
operator|->
name|enabled
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|RMI_XLR_BOARD_ARIZONA_II
case|:
comment|/* XGMII_A --> VSC7281, XGMII_B --> VSC7281 */
name|blk1
operator|->
name|enabled
operator|=
literal|1
expr_stmt|;
name|blk1
operator|->
name|num_ports
operator|=
literal|1
expr_stmt|;
name|blk1
operator|->
name|gmac_port
index|[
literal|0
index|]
operator|.
name|valid
operator|=
literal|1
expr_stmt|;
name|blk2
operator|->
name|enabled
operator|=
literal|1
expr_stmt|;
name|blk2
operator|->
name|num_ports
operator|=
literal|1
expr_stmt|;
name|blk2
operator|->
name|gmac_port
index|[
literal|0
index|]
operator|.
name|valid
operator|=
literal|1
expr_stmt|;
default|default:
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|quad0_xaui
parameter_list|(
name|void
parameter_list|)
block|{
name|xlr_reg_t
modifier|*
name|gpio_mmio
init|=
operator|(
name|unsigned
name|int
operator|*
operator|)
operator|(
name|DEFAULT_XLR_IO_BASE
operator|+
name|XLR_IO_GPIO_OFFSET
operator|)
decl_stmt|;
name|uint32_t
name|bit24
decl_stmt|;
name|bit24
operator|=
operator|(
name|xlr_read_reg
argument_list|(
name|gpio_mmio
argument_list|,
literal|0x15
argument_list|)
operator|>>
literal|24
operator|)
operator|&
literal|0x1
expr_stmt|;
return|return
operator|(
name|bit24
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|quad1_xaui
parameter_list|(
name|void
parameter_list|)
block|{
name|xlr_reg_t
modifier|*
name|gpio_mmio
init|=
operator|(
name|unsigned
name|int
operator|*
operator|)
operator|(
name|DEFAULT_XLR_IO_BASE
operator|+
name|XLR_IO_GPIO_OFFSET
operator|)
decl_stmt|;
name|uint32_t
name|bit25
decl_stmt|;
name|bit25
operator|=
operator|(
name|xlr_read_reg
argument_list|(
name|gpio_mmio
argument_list|,
literal|0x15
argument_list|)
operator|>>
literal|25
operator|)
operator|&
literal|0x1
expr_stmt|;
return|return
operator|(
name|bit25
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|xls_chip_specific_overrides
parameter_list|(
name|struct
name|xlr_board_info
modifier|*
name|board
parameter_list|)
block|{
name|struct
name|xlr_gmac_block_t
modifier|*
name|blk0
decl_stmt|,
modifier|*
name|blk1
decl_stmt|;
name|uint32_t
name|chipid
decl_stmt|;
name|blk0
operator|=
operator|&
name|board
operator|->
name|gmac_block
index|[
literal|0
index|]
expr_stmt|;
name|blk1
operator|=
operator|&
name|board
operator|->
name|gmac_block
index|[
literal|1
index|]
expr_stmt|;
name|chipid
operator|=
name|xlr_processor_id
argument_list|()
expr_stmt|;
switch|switch
condition|(
name|chipid
condition|)
block|{
case|case
literal|0x8E
case|:
comment|/* XLS208 */
case|case
literal|0x8F
case|:
comment|/* XLS204 */
comment|/* NA1 is not available */
name|memset
argument_list|(
name|blk1
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|blk1
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xCE
case|:
comment|/* XLS108 */
case|case
literal|0xCF
case|:
comment|/* XLS104 */
comment|/* NA0 has 3 ports */
name|blk0
operator|->
name|gmac_port
index|[
literal|3
index|]
operator|.
name|valid
operator|=
literal|0
expr_stmt|;
name|blk0
operator|->
name|num_ports
operator|--
expr_stmt|;
comment|/* NA1 is not available */
name|memset
argument_list|(
name|blk1
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|blk1
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|xls_board_specific_overrides
parameter_list|(
name|struct
name|xlr_board_info
modifier|*
name|board
parameter_list|)
block|{
name|struct
name|xlr_gmac_block_t
modifier|*
name|blk0
decl_stmt|,
modifier|*
name|blk1
decl_stmt|;
name|int
name|i
decl_stmt|;
name|blk0
operator|=
operator|&
name|board
operator|->
name|gmac_block
index|[
literal|0
index|]
expr_stmt|;
name|blk1
operator|=
operator|&
name|board
operator|->
name|gmac_block
index|[
literal|1
index|]
expr_stmt|;
switch|switch
condition|(
name|xlr_boot1_info
operator|.
name|board_major_version
condition|)
block|{
case|case
name|RMI_XLR_BOARD_ARIZONA_VI
case|:
name|blk0
operator|->
name|mode
operator|=
name|XLR_PORT0_RGMII
expr_stmt|;
name|blk0
operator|->
name|gmac_port
index|[
literal|0
index|]
operator|.
name|type
operator|=
name|XLR_RGMII
expr_stmt|;
name|blk0
operator|->
name|gmac_port
index|[
literal|0
index|]
operator|.
name|phy_addr
operator|=
literal|0
expr_stmt|;
name|blk0
operator|->
name|gmac_port
index|[
literal|0
index|]
operator|.
name|mii_addr
operator|=
name|XLR_IO_GMAC_4_OFFSET
expr_stmt|;
comment|/* Because of the Octal PHY, SGMII Quad1 is MII is also bound 		 * to the PHY attached to SGMII0_MDC/MDIO/MDINT. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
name|blk1
operator|->
name|gmac_port
index|[
name|i
index|]
operator|.
name|mii_addr
operator|=
name|XLR_IO_GMAC_0_OFFSET
expr_stmt|;
name|blk1
operator|->
name|gmac_port
index|[
name|i
index|]
operator|.
name|serdes_addr
operator|=
name|XLR_IO_GMAC_0_OFFSET
expr_stmt|;
block|}
name|blk1
operator|->
name|gmac_port
index|[
literal|1
index|]
operator|.
name|mii_addr
operator|=
name|XLR_IO_GMAC_0_OFFSET
expr_stmt|;
name|blk1
operator|->
name|gmac_port
index|[
literal|2
index|]
operator|.
name|mii_addr
operator|=
name|XLR_IO_GMAC_0_OFFSET
expr_stmt|;
name|blk1
operator|->
name|gmac_port
index|[
literal|3
index|]
operator|.
name|mii_addr
operator|=
name|XLR_IO_GMAC_0_OFFSET
expr_stmt|;
name|blk1
operator|->
name|gmac_port
index|[
literal|1
index|]
operator|.
name|serdes_addr
operator|=
name|XLR_IO_GMAC_0_OFFSET
expr_stmt|;
name|blk1
operator|->
name|gmac_port
index|[
literal|2
index|]
operator|.
name|serdes_addr
operator|=
name|XLR_IO_GMAC_0_OFFSET
expr_stmt|;
name|blk1
operator|->
name|gmac_port
index|[
literal|3
index|]
operator|.
name|serdes_addr
operator|=
name|XLR_IO_GMAC_0_OFFSET
expr_stmt|;
comment|/* RGMII MDIO interrupt is thru NA1 and SGMII MDIO  		 * interrupts for ports in blk1 are from NA0 */
name|blk0
operator|->
name|gmac_port
index|[
literal|0
index|]
operator|.
name|mdint_id
operator|=
literal|1
expr_stmt|;
name|blk1
operator|->
name|gmac_port
index|[
literal|0
index|]
operator|.
name|mdint_id
operator|=
literal|0
expr_stmt|;
name|blk1
operator|->
name|gmac_port
index|[
literal|1
index|]
operator|.
name|mdint_id
operator|=
literal|0
expr_stmt|;
name|blk1
operator|->
name|gmac_port
index|[
literal|2
index|]
operator|.
name|mdint_id
operator|=
literal|0
expr_stmt|;
name|blk1
operator|->
name|gmac_port
index|[
literal|3
index|]
operator|.
name|mdint_id
operator|=
literal|0
expr_stmt|;
comment|/* If we have a 4xx lite chip, don't enable the  		 * GMACs which are disabled in hardware */
if|if
condition|(
name|xlr_is_xls4xx_lite
argument_list|()
condition|)
block|{
name|xlr_reg_t
modifier|*
name|mmio
init|=
name|xlr_io_mmio
argument_list|(
name|XLR_IO_GPIO_OFFSET
argument_list|)
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
comment|/* Port 6& 7 are not enabled on the condor 4xx, figure 			 * this out from the GPIO fuse bank */
name|tmp
operator|=
name|xlr_read_reg
argument_list|(
name|mmio
argument_list|,
literal|35
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|tmp
operator|&
operator|(
literal|3
operator|<<
literal|28
operator|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|blk1
operator|->
name|enabled
operator|=
literal|0x3
expr_stmt|;
name|blk1
operator|->
name|gmac_port
index|[
literal|2
index|]
operator|.
name|valid
operator|=
literal|0
expr_stmt|;
name|blk1
operator|->
name|gmac_port
index|[
literal|3
index|]
operator|.
name|valid
operator|=
literal|0
expr_stmt|;
name|blk1
operator|->
name|num_ports
operator|=
literal|2
expr_stmt|;
block|}
block|}
break|break;
case|case
name|RMI_XLR_BOARD_ARIZONA_VIII
case|:
if|if
condition|(
name|blk1
operator|->
name|enabled
condition|)
block|{
comment|/* There is just one Octal PHY on the board and it is  			 * connected to the MII interface for NA Quad 0. */
name|blk1
operator|->
name|gmac_port
index|[
literal|0
index|]
operator|.
name|mii_addr
operator|=
name|XLR_IO_GMAC_0_OFFSET
expr_stmt|;
name|blk1
operator|->
name|gmac_port
index|[
literal|1
index|]
operator|.
name|mii_addr
operator|=
name|XLR_IO_GMAC_0_OFFSET
expr_stmt|;
name|blk1
operator|->
name|gmac_port
index|[
literal|2
index|]
operator|.
name|mii_addr
operator|=
name|XLR_IO_GMAC_0_OFFSET
expr_stmt|;
name|blk1
operator|->
name|gmac_port
index|[
literal|3
index|]
operator|.
name|mii_addr
operator|=
name|XLR_IO_GMAC_0_OFFSET
expr_stmt|;
block|}
break|break;
case|case
name|RMI_XLR_BOARD_ARIZONA_XI
case|:
case|case
name|RMI_XLR_BOARD_ARIZONA_XII
case|:
if|if
condition|(
name|quad0_xaui
argument_list|()
condition|)
block|{
comment|/* GMAC ports 0-3 are set to XAUI */
comment|/* only GMAC0 is active i.e, the 0-th port on this quad. 			 * Disable all the other 7 possible ports. */
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|MAX_NA_PORTS
condition|;
name|i
operator|++
control|)
block|{
name|memset
argument_list|(
operator|&
name|blk0
operator|->
name|gmac_port
index|[
name|i
index|]
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|blk0
operator|->
name|gmac_port
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* Setup for XAUI on N/w Acc0: gmac0 */
name|blk0
operator|->
name|type
operator|=
name|XLR_XGMAC
expr_stmt|;
name|blk0
operator|->
name|mode
operator|=
name|XLR_XAUI
expr_stmt|;
name|blk0
operator|->
name|num_ports
operator|=
literal|1
expr_stmt|;
name|blk0
operator|->
name|gmac_port
index|[
literal|0
index|]
operator|.
name|type
operator|=
name|XLR_XAUI
expr_stmt|;
name|blk1
operator|->
name|gmac_port
index|[
literal|0
index|]
operator|.
name|phy_addr
operator|=
literal|16
expr_stmt|;
name|blk0
operator|->
name|gmac_port
index|[
literal|0
index|]
operator|.
name|tx_bucket_id
operator|=
name|blk0
operator|->
name|station_txbase
expr_stmt|;
comment|/* Other addresses etc need not be modified as XAUI_0 			 * shares its addresses with SGMII GMAC_0, which was  			 * set in the caller. */
block|}
else|else
block|{
name|blk0
operator|->
name|num_ports
operator|=
literal|1
expr_stmt|;
comment|/* only 1 RGMII port */
name|blk0
operator|->
name|mode
operator|=
name|XLR_PORT0_RGMII
expr_stmt|;
name|blk0
operator|->
name|gmac_port
index|[
literal|0
index|]
operator|.
name|type
operator|=
name|XLR_RGMII
expr_stmt|;
name|blk0
operator|->
name|gmac_port
index|[
literal|0
index|]
operator|.
name|phy_addr
operator|=
literal|0
expr_stmt|;
name|blk0
operator|->
name|gmac_port
index|[
literal|0
index|]
operator|.
name|mii_addr
operator|=
name|XLR_IO_GMAC_0_OFFSET
expr_stmt|;
block|}
if|if
condition|(
name|quad1_xaui
argument_list|()
condition|)
block|{
comment|/* GMAC ports 4-7 are used for XAUI */
comment|/* only GMAC4 is active i.e, the 0-th port on this quad. 			 * Disable all the other 7 possible ports. */
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|MAX_NA_PORTS
condition|;
name|i
operator|++
control|)
block|{
name|memset
argument_list|(
operator|&
name|blk1
operator|->
name|gmac_port
index|[
name|i
index|]
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|blk1
operator|->
name|gmac_port
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* Setup for XAUI on N/w Acc1: gmac4 */
name|blk1
operator|->
name|type
operator|=
name|XLR_XGMAC
expr_stmt|;
name|blk1
operator|->
name|mode
operator|=
name|XLR_XAUI
expr_stmt|;
name|blk1
operator|->
name|num_ports
operator|=
literal|1
expr_stmt|;
comment|/* XAUI and SGMII ports share FMN buckets on N/w Acc 1; 			   so, station_txbase, station_rfr need not be 			   patched up. */
name|blk1
operator|->
name|gmac_port
index|[
literal|0
index|]
operator|.
name|type
operator|=
name|XLR_XAUI
expr_stmt|;
name|blk1
operator|->
name|gmac_port
index|[
literal|0
index|]
operator|.
name|phy_addr
operator|=
literal|16
expr_stmt|;
name|blk1
operator|->
name|gmac_port
index|[
literal|0
index|]
operator|.
name|tx_bucket_id
operator|=
name|blk1
operator|->
name|station_txbase
expr_stmt|;
comment|/* Other addresses etc need not be modified as XAUI_1 			 * shares its addresses with SGMII GMAC_4, which was  			 * set in the caller. */
block|}
break|break;
default|default:
break|break;
block|}
block|}
end_function

begin_comment
comment|/*  * All our knowledge of chip and board that cannot be detected by probing  * at run-time goes here  */
end_comment

begin_function
name|int
name|xlr_board_info_setup
parameter_list|()
block|{
name|struct
name|xlr_gmac_block_t
modifier|*
name|blk0
decl_stmt|,
modifier|*
name|blk1
decl_stmt|,
modifier|*
name|blk2
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* This setup code is long'ish because the same base driver 	 * (if_nlge.c) is used for different:  	 *    - CPUs (XLR/XLS) 	 *    - boards (for each CPU, multiple board configs are possible 	 *	        and available). 	 * 	 * At the time of writing, there are atleast 12 boards, 4 with XLR  	 * and 8 with XLS. This means that the base driver needs to work with 	 * 12 different configurations, with varying levels of differences.  	 * To accomodate the different configs, the xlr_board_info struct 	 * has various attributes for paramters that could be different.  	 * These attributes are setup here and can be used directly in the  	 * base driver.  	 * It was seen that the setup code is not entirely trivial and 	 * it is possible to organize it in different ways. In the following, 	 * we choose an approach that sacrifices code-compactness/speed for 	 * readability. This is because configuration code executes once 	 * per reboot and hence has a minimal performance impact. 	 * On the other hand, driver debugging/enhancements require  	 * that different engineers can quickly comprehend the setup  	 * sequence. Hence, readability is seen as the key requirement for 	 * this code. It is for the reader to decide how much of this 	 * requirement is met with the current code organization !! 	 * 	 * The initialization is organized thus:  	 * 	 * if (CPU is XLS) { 	 *    // initialize per XLS architecture 	 *       // default inits (per chip spec) 	 *       // chip-specific overrides 	 *       // board-specific overrides 	 * } else if (CPU is XLR) { 	 *    // initialize per XLR architecture 	 *       // default inits (per chip spec) 	 *       // chip-specific overrides 	 *       // board-specific overrides 	 * } 	 *  	 * For each CPU family, all the default initializations 	 * are done for a fully-loaded device of that family.  	 * This configuration is then adjusted for the actual 	 * chip id. This is followed up with board specific 	 * overrides.  	 */
comment|/* start with a clean slate */
name|memset
argument_list|(
operator|&
name|xlr_board_info
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|xlr_board_info
argument_list|)
argument_list|)
expr_stmt|;
name|xlr_board_info
operator|.
name|ata
operator|=
name|xlr_pcmcia_present
argument_list|()
expr_stmt|;
name|blk0
operator|=
operator|&
name|xlr_board_info
operator|.
name|gmac_block
index|[
literal|0
index|]
expr_stmt|;
name|blk1
operator|=
operator|&
name|xlr_board_info
operator|.
name|gmac_block
index|[
literal|1
index|]
expr_stmt|;
name|blk2
operator|=
operator|&
name|xlr_board_info
operator|.
name|gmac_block
index|[
literal|2
index|]
expr_stmt|;
if|if
condition|(
name|xlr_is_xls
argument_list|()
condition|)
block|{
name|xlr_board_info
operator|.
name|is_xls
operator|=
literal|1
expr_stmt|;
name|xlr_board_info
operator|.
name|nr_cpus
operator|=
literal|8
expr_stmt|;
name|xlr_board_info
operator|.
name|usb
operator|=
literal|1
expr_stmt|;
comment|/* Board version 8 has NAND flash */
name|xlr_board_info
operator|.
name|cfi
operator|=
operator|(
name|xlr_boot1_info
operator|.
name|board_major_version
operator|!=
name|RMI_XLR_BOARD_ARIZONA_VIII
operator|)
expr_stmt|;
name|xlr_board_info
operator|.
name|pci_irq
operator|=
literal|0
expr_stmt|;
name|xlr_board_info
operator|.
name|credit_configs
operator|=
name|xls_core_cc_configs
expr_stmt|;
name|xlr_board_info
operator|.
name|bucket_sizes
operator|=
operator|&
name|xls_bucket_sizes
expr_stmt|;
name|xlr_board_info
operator|.
name|gmacports
operator|=
name|MAX_NA_PORTS
expr_stmt|;
comment|/* ---------------- Network Acc 0 ---------------- */
name|blk0
operator|->
name|type
operator|=
name|XLR_GMAC
expr_stmt|;
name|blk0
operator|->
name|enabled
operator|=
literal|0xf
expr_stmt|;
name|blk0
operator|->
name|credit_config
operator|=
operator|&
name|xls_cc_table_gmac0
expr_stmt|;
name|blk0
operator|->
name|station_id
operator|=
name|MSGRNG_STNID_GMAC
expr_stmt|;
name|blk0
operator|->
name|station_txbase
operator|=
name|MSGRNG_STNID_GMACTX0
expr_stmt|;
name|blk0
operator|->
name|station_rfr
operator|=
name|MSGRNG_STNID_GMACRFR_0
expr_stmt|;
name|blk0
operator|->
name|mode
operator|=
name|XLR_SGMII
expr_stmt|;
name|blk0
operator|->
name|baseaddr
operator|=
name|XLR_IO_GMAC_0_OFFSET
expr_stmt|;
name|blk0
operator|->
name|baseirq
operator|=
name|PIC_GMAC_0_IRQ
expr_stmt|;
name|blk0
operator|->
name|baseinst
operator|=
literal|0
expr_stmt|;
comment|/* By default, assume SGMII is setup. But this can change based  		   on board-specific or setting-specific info. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
name|blk0
operator|->
name|gmac_port
index|[
name|i
index|]
operator|.
name|valid
operator|=
literal|1
expr_stmt|;
name|blk0
operator|->
name|gmac_port
index|[
name|i
index|]
operator|.
name|instance
operator|=
name|i
operator|+
name|blk0
operator|->
name|baseinst
expr_stmt|;
name|blk0
operator|->
name|gmac_port
index|[
name|i
index|]
operator|.
name|type
operator|=
name|XLR_SGMII
expr_stmt|;
name|blk0
operator|->
name|gmac_port
index|[
name|i
index|]
operator|.
name|phy_addr
operator|=
name|i
operator|+
literal|16
expr_stmt|;
name|blk0
operator|->
name|gmac_port
index|[
name|i
index|]
operator|.
name|tx_bucket_id
operator|=
name|blk0
operator|->
name|station_txbase
operator|+
name|i
expr_stmt|;
name|blk0
operator|->
name|gmac_port
index|[
name|i
index|]
operator|.
name|mdint_id
operator|=
literal|0
expr_stmt|;
name|blk0
operator|->
name|num_ports
operator|++
expr_stmt|;
name|blk0
operator|->
name|gmac_port
index|[
name|i
index|]
operator|.
name|base_addr
operator|=
name|XLR_IO_GMAC_0_OFFSET
operator|+
name|i
operator|*
literal|0x1000
expr_stmt|;
name|blk0
operator|->
name|gmac_port
index|[
name|i
index|]
operator|.
name|mii_addr
operator|=
name|XLR_IO_GMAC_0_OFFSET
expr_stmt|;
name|blk0
operator|->
name|gmac_port
index|[
name|i
index|]
operator|.
name|pcs_addr
operator|=
name|XLR_IO_GMAC_0_OFFSET
expr_stmt|;
name|blk0
operator|->
name|gmac_port
index|[
name|i
index|]
operator|.
name|serdes_addr
operator|=
name|XLR_IO_GMAC_0_OFFSET
expr_stmt|;
block|}
comment|/* ---------------- Network Acc 1 ---------------- */
name|blk1
operator|->
name|type
operator|=
name|XLR_GMAC
expr_stmt|;
name|blk1
operator|->
name|enabled
operator|=
literal|0xf
expr_stmt|;
name|blk1
operator|->
name|credit_config
operator|=
operator|&
name|xls_cc_table_gmac1
expr_stmt|;
name|blk1
operator|->
name|station_id
operator|=
name|MSGRNG_STNID_GMAC1
expr_stmt|;
name|blk1
operator|->
name|station_txbase
operator|=
name|MSGRNG_STNID_GMAC1_TX0
expr_stmt|;
name|blk1
operator|->
name|station_rfr
operator|=
name|MSGRNG_STNID_GMAC1_FR_0
expr_stmt|;
name|blk1
operator|->
name|mode
operator|=
name|XLR_SGMII
expr_stmt|;
name|blk1
operator|->
name|baseaddr
operator|=
name|XLR_IO_GMAC_4_OFFSET
expr_stmt|;
name|blk1
operator|->
name|baseirq
operator|=
name|PIC_XGS_0_IRQ
expr_stmt|;
name|blk1
operator|->
name|baseinst
operator|=
literal|4
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
name|blk1
operator|->
name|gmac_port
index|[
name|i
index|]
operator|.
name|valid
operator|=
literal|1
expr_stmt|;
name|blk1
operator|->
name|gmac_port
index|[
name|i
index|]
operator|.
name|instance
operator|=
name|i
operator|+
name|blk1
operator|->
name|baseinst
expr_stmt|;
name|blk1
operator|->
name|gmac_port
index|[
name|i
index|]
operator|.
name|type
operator|=
name|XLR_SGMII
expr_stmt|;
name|blk1
operator|->
name|gmac_port
index|[
name|i
index|]
operator|.
name|phy_addr
operator|=
name|i
operator|+
literal|20
expr_stmt|;
name|blk1
operator|->
name|gmac_port
index|[
name|i
index|]
operator|.
name|tx_bucket_id
operator|=
name|blk1
operator|->
name|station_txbase
operator|+
name|i
expr_stmt|;
name|blk1
operator|->
name|gmac_port
index|[
name|i
index|]
operator|.
name|mdint_id
operator|=
literal|1
expr_stmt|;
name|blk1
operator|->
name|num_ports
operator|++
expr_stmt|;
name|blk1
operator|->
name|gmac_port
index|[
name|i
index|]
operator|.
name|base_addr
operator|=
name|XLR_IO_GMAC_4_OFFSET
operator|+
name|i
operator|*
literal|0x1000
expr_stmt|;
name|blk1
operator|->
name|gmac_port
index|[
name|i
index|]
operator|.
name|mii_addr
operator|=
name|XLR_IO_GMAC_4_OFFSET
expr_stmt|;
name|blk1
operator|->
name|gmac_port
index|[
name|i
index|]
operator|.
name|pcs_addr
operator|=
name|XLR_IO_GMAC_4_OFFSET
expr_stmt|;
name|blk1
operator|->
name|gmac_port
index|[
name|i
index|]
operator|.
name|serdes_addr
operator|=
name|XLR_IO_GMAC_0_OFFSET
expr_stmt|;
block|}
comment|/* ---------------- Network Acc 2 ---------------- */
name|xlr_board_info
operator|.
name|gmac_block
index|[
literal|2
index|]
operator|.
name|enabled
operator|=
literal|0
expr_stmt|;
comment|/* disabled on XLS */
name|xls_chip_specific_overrides
argument_list|(
operator|&
name|xlr_board_info
argument_list|)
expr_stmt|;
name|xls_board_specific_overrides
argument_list|(
operator|&
name|xlr_board_info
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* XLR */
name|xlr_board_info
operator|.
name|is_xls
operator|=
literal|0
expr_stmt|;
name|xlr_board_info
operator|.
name|nr_cpus
operator|=
literal|32
expr_stmt|;
name|xlr_board_info
operator|.
name|usb
operator|=
literal|0
expr_stmt|;
name|xlr_board_info
operator|.
name|cfi
operator|=
literal|1
expr_stmt|;
name|xlr_board_info
operator|.
name|pci_irq
operator|=
literal|0
expr_stmt|;
name|xlr_board_info
operator|.
name|credit_configs
operator|=
name|xlr_core_cc_configs
expr_stmt|;
name|xlr_board_info
operator|.
name|bucket_sizes
operator|=
operator|&
name|bucket_sizes
expr_stmt|;
name|xlr_board_info
operator|.
name|gmacports
operator|=
literal|4
expr_stmt|;
comment|/* ---------------- GMAC0 ---------------- */
name|blk0
operator|->
name|type
operator|=
name|XLR_GMAC
expr_stmt|;
name|blk0
operator|->
name|enabled
operator|=
literal|0xf
expr_stmt|;
name|blk0
operator|->
name|credit_config
operator|=
operator|&
name|cc_table_gmac
expr_stmt|;
name|blk0
operator|->
name|station_id
operator|=
name|MSGRNG_STNID_GMAC
expr_stmt|;
name|blk0
operator|->
name|station_txbase
operator|=
name|MSGRNG_STNID_GMACTX0
expr_stmt|;
name|blk0
operator|->
name|station_rfr
operator|=
name|MSGRNG_STNID_GMACRFR_0
expr_stmt|;
name|blk0
operator|->
name|mode
operator|=
name|XLR_RGMII
expr_stmt|;
name|blk0
operator|->
name|baseaddr
operator|=
name|XLR_IO_GMAC_0_OFFSET
expr_stmt|;
name|blk0
operator|->
name|baseirq
operator|=
name|PIC_GMAC_0_IRQ
expr_stmt|;
name|blk0
operator|->
name|baseinst
operator|=
literal|0
expr_stmt|;
comment|/* first, do the common/easy stuff for all the ports */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
name|blk0
operator|->
name|gmac_port
index|[
name|i
index|]
operator|.
name|valid
operator|=
literal|1
expr_stmt|;
name|blk0
operator|->
name|gmac_port
index|[
name|i
index|]
operator|.
name|instance
operator|=
name|i
operator|+
name|blk0
operator|->
name|baseinst
expr_stmt|;
name|blk0
operator|->
name|gmac_port
index|[
name|i
index|]
operator|.
name|type
operator|=
name|XLR_RGMII
expr_stmt|;
name|blk0
operator|->
name|gmac_port
index|[
name|i
index|]
operator|.
name|phy_addr
operator|=
name|i
expr_stmt|;
name|blk0
operator|->
name|gmac_port
index|[
name|i
index|]
operator|.
name|tx_bucket_id
operator|=
name|blk0
operator|->
name|station_txbase
operator|+
name|i
expr_stmt|;
name|blk0
operator|->
name|gmac_port
index|[
name|i
index|]
operator|.
name|mdint_id
operator|=
literal|0
expr_stmt|;
name|blk0
operator|->
name|gmac_port
index|[
name|i
index|]
operator|.
name|base_addr
operator|=
name|XLR_IO_GMAC_0_OFFSET
operator|+
name|i
operator|*
literal|0x1000
expr_stmt|;
name|blk0
operator|->
name|gmac_port
index|[
name|i
index|]
operator|.
name|mii_addr
operator|=
name|XLR_IO_GMAC_0_OFFSET
expr_stmt|;
comment|/* RGMII ports, no PCS/SERDES */
name|blk0
operator|->
name|num_ports
operator|++
expr_stmt|;
block|}
comment|/* ---------------- XGMAC0 ---------------- */
name|blk1
operator|->
name|type
operator|=
name|XLR_XGMAC
expr_stmt|;
name|blk1
operator|->
name|mode
operator|=
name|XLR_XGMII
expr_stmt|;
name|blk1
operator|->
name|enabled
operator|=
literal|0
expr_stmt|;
name|blk1
operator|->
name|credit_config
operator|=
operator|&
name|cc_table_xgs_0
expr_stmt|;
name|blk1
operator|->
name|station_txbase
operator|=
name|MSGRNG_STNID_XGS0_TX
expr_stmt|;
name|blk1
operator|->
name|station_rfr
operator|=
name|MSGRNG_STNID_XMAC0RFR
expr_stmt|;
name|blk1
operator|->
name|station_id
operator|=
name|MSGRNG_STNID_XGS0FR
expr_stmt|;
name|blk1
operator|->
name|baseaddr
operator|=
name|XLR_IO_XGMAC_0_OFFSET
expr_stmt|;
name|blk1
operator|->
name|baseirq
operator|=
name|PIC_XGS_0_IRQ
expr_stmt|;
name|blk1
operator|->
name|baseinst
operator|=
literal|4
expr_stmt|;
name|blk1
operator|->
name|gmac_port
index|[
literal|0
index|]
operator|.
name|type
operator|=
name|XLR_XGMII
expr_stmt|;
name|blk1
operator|->
name|gmac_port
index|[
literal|0
index|]
operator|.
name|instance
operator|=
literal|0
expr_stmt|;
name|blk1
operator|->
name|gmac_port
index|[
literal|0
index|]
operator|.
name|phy_addr
operator|=
literal|0
expr_stmt|;
name|blk1
operator|->
name|gmac_port
index|[
literal|0
index|]
operator|.
name|base_addr
operator|=
name|XLR_IO_XGMAC_0_OFFSET
expr_stmt|;
name|blk1
operator|->
name|gmac_port
index|[
literal|0
index|]
operator|.
name|mii_addr
operator|=
name|XLR_IO_XGMAC_0_OFFSET
expr_stmt|;
name|blk1
operator|->
name|gmac_port
index|[
literal|0
index|]
operator|.
name|tx_bucket_id
operator|=
name|blk1
operator|->
name|station_txbase
expr_stmt|;
name|blk1
operator|->
name|gmac_port
index|[
literal|0
index|]
operator|.
name|mdint_id
operator|=
literal|1
expr_stmt|;
comment|/* ---------------- XGMAC1 ---------------- */
name|blk2
operator|->
name|type
operator|=
name|XLR_XGMAC
expr_stmt|;
name|blk2
operator|->
name|mode
operator|=
name|XLR_XGMII
expr_stmt|;
name|blk2
operator|->
name|enabled
operator|=
literal|0
expr_stmt|;
name|blk2
operator|->
name|credit_config
operator|=
operator|&
name|cc_table_xgs_1
expr_stmt|;
name|blk2
operator|->
name|station_txbase
operator|=
name|MSGRNG_STNID_XGS1_TX
expr_stmt|;
name|blk2
operator|->
name|station_rfr
operator|=
name|MSGRNG_STNID_XMAC1RFR
expr_stmt|;
name|blk2
operator|->
name|station_id
operator|=
name|MSGRNG_STNID_XGS1FR
expr_stmt|;
name|blk2
operator|->
name|baseaddr
operator|=
name|XLR_IO_XGMAC_1_OFFSET
expr_stmt|;
name|blk2
operator|->
name|baseirq
operator|=
name|PIC_XGS_1_IRQ
expr_stmt|;
name|blk2
operator|->
name|baseinst
operator|=
literal|5
expr_stmt|;
name|blk2
operator|->
name|gmac_port
index|[
literal|0
index|]
operator|.
name|type
operator|=
name|XLR_XGMII
expr_stmt|;
name|blk2
operator|->
name|gmac_port
index|[
literal|0
index|]
operator|.
name|instance
operator|=
literal|0
expr_stmt|;
name|blk2
operator|->
name|gmac_port
index|[
literal|0
index|]
operator|.
name|phy_addr
operator|=
literal|0
expr_stmt|;
name|blk2
operator|->
name|gmac_port
index|[
literal|0
index|]
operator|.
name|base_addr
operator|=
name|XLR_IO_XGMAC_1_OFFSET
expr_stmt|;
name|blk2
operator|->
name|gmac_port
index|[
literal|0
index|]
operator|.
name|mii_addr
operator|=
name|XLR_IO_XGMAC_1_OFFSET
expr_stmt|;
name|blk2
operator|->
name|gmac_port
index|[
literal|0
index|]
operator|.
name|tx_bucket_id
operator|=
name|blk2
operator|->
name|station_txbase
expr_stmt|;
name|blk2
operator|->
name|gmac_port
index|[
literal|0
index|]
operator|.
name|mdint_id
operator|=
literal|2
expr_stmt|;
comment|/* Done with default setup. Now handle chip and board-specific 		   variations. */
name|xlr_chip_specific_overrides
argument_list|(
operator|&
name|xlr_board_info
argument_list|)
expr_stmt|;
name|xlr_board_specific_overrides
argument_list|(
operator|&
name|xlr_board_info
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

end_unit


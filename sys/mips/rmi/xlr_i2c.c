begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2003-2009 RMI Corporation  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. Neither the name of RMI Corporation, nor the names of its contributors,  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * RMI_BSD */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD: src/sys/mips/xlr/xlr_i2c.c,v 1.20.8.1 2008/08/25 23:17:51 cognet Exp $"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*  * I2C driver for the Palm-BK3220 I2C Host adapter on the RMI XLR.  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<dev/iicbus/iiconf.h>
end_include

begin_include
include|#
directive|include
file|<dev/iicbus/iicbus.h>
end_include

begin_include
include|#
directive|include
file|<mips/xlr/iomap.h>
end_include

begin_include
include|#
directive|include
file|<mips/include/resource.h>
end_include

begin_include
include|#
directive|include
file|"iicbus_if.h"
end_include

begin_define
define|#
directive|define
name|DEVTOIICBUS
parameter_list|(
name|dev
parameter_list|)
value|((struct iicbus_device*)device_get_ivars(dev))
end_define

begin_define
define|#
directive|define
name|I2C_PALM_CFG
value|0x00
end_define

begin_define
define|#
directive|define
name|I2C_PALM_CLKDIV
value|0x01
end_define

begin_define
define|#
directive|define
name|I2C_PALM_DEVADDR
value|0x02
end_define

begin_define
define|#
directive|define
name|I2C_PALM_ADDR
value|0x03
end_define

begin_define
define|#
directive|define
name|I2C_PALM_DATAOUT
value|0x04
end_define

begin_define
define|#
directive|define
name|I2C_PALM_DATAIN
value|0x05
end_define

begin_define
define|#
directive|define
name|I2C_PALM_STATUS
value|0x06
end_define

begin_define
define|#
directive|define
name|I2C_PALM_STARTXFR
value|0x07
end_define

begin_define
define|#
directive|define
name|I2C_PALM_BYTECNT
value|0x08
end_define

begin_define
define|#
directive|define
name|I2C_PALM_HDSTATIM
value|0x09
end_define

begin_comment
comment|/* TEST Values!! Change as required */
end_comment

begin_define
define|#
directive|define
name|I2C_PALM_CFG_DEF
value|0x000000F8
end_define

begin_comment
comment|/* 8-Bit Addr + POR Values */
end_comment

begin_define
define|#
directive|define
name|I2C_PALM_CLKDIV_DEF
value|0x14A
end_define

begin_comment
comment|//0x00000052
end_comment

begin_define
define|#
directive|define
name|I2C_PALM_HDSTATIM_DEF
value|0x107
end_define

begin_comment
comment|//0x00000000
end_comment

begin_define
define|#
directive|define
name|I2C_PALM_STARTXFR_RD
value|0x00000001
end_define

begin_define
define|#
directive|define
name|I2C_PALM_STARTXFR_WR
value|0x00000000
end_define

begin_define
define|#
directive|define
name|PHOENIX_IO_I2C_0_OFFSET
value|0x16000
end_define

begin_define
define|#
directive|define
name|PHOENIX_IO_I2C_1_OFFSET
value|0x17000
end_define

begin_define
define|#
directive|define
name|ARIZONA_I2c_BUS
value|1
end_define

begin_decl_stmt
name|int
name|bus
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|uint8_t
name|current_slave
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|uint8_t
name|read_address
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|xlr_reg_t
modifier|*
name|iobase_i2c_regs
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|xlr_i2c_devclass
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Device methods  */
end_comment

begin_function_decl
specifier|static
name|int
name|xlr_i2c_probe
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|xlr_i2c_attach
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|xlr_i2c_detach
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|xlr_i2c_start
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|u_char
name|slave
parameter_list|,
name|int
name|timeout
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|xlr_i2c_stop
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|xlr_i2c_read
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|int
name|len
parameter_list|,
name|int
modifier|*
name|read
parameter_list|,
name|int
name|last
parameter_list|,
name|int
name|delay
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|xlr_i2c_write
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|int
name|len
parameter_list|,
name|int
modifier|*
name|sent
parameter_list|,
name|int
name|timeout
parameter_list|)
function_decl|;
end_function_decl

begin_struct
struct|struct
name|xlr_i2c_softc
block|{
name|device_t
name|dev
decl_stmt|;
comment|/* Myself */
name|struct
name|resource
modifier|*
name|mem_res
decl_stmt|;
comment|/* Memory resource */
specifier|volatile
name|int
name|flags
decl_stmt|;
define|#
directive|define
name|RXRDY
value|4
define|#
directive|define
name|TXRDY
value|0x10
name|int
name|sc_started
decl_stmt|;
name|int
name|twi_addr
decl_stmt|;
name|device_t
name|iicbus
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|MDELAY
parameter_list|(
name|a
parameter_list|)
value|{ \     unsigned long  local_loop = 0xfffff; \     while(local_loop--); \ }\  static void get_i2c_base(void)
end_define

begin_block
block|{
if|if
condition|(
name|bus
operator|==
literal|0
condition|)
name|iobase_i2c_regs
operator|=
name|xlr_io_mmio
argument_list|(
name|PHOENIX_IO_I2C_0_OFFSET
argument_list|)
expr_stmt|;
else|else
name|iobase_i2c_regs
operator|=
name|xlr_io_mmio
argument_list|(
name|PHOENIX_IO_I2C_1_OFFSET
argument_list|)
expr_stmt|;
return|return;
block|}
end_block

begin_function
specifier|static
name|void
name|palm_write
parameter_list|(
name|int
name|reg
parameter_list|,
name|int
name|value
parameter_list|)
block|{
name|get_i2c_base
argument_list|()
expr_stmt|;
name|xlr_write_reg
argument_list|(
name|iobase_i2c_regs
argument_list|,
name|reg
argument_list|,
name|value
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|palm_read
parameter_list|(
name|int
name|reg
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|;
name|get_i2c_base
argument_list|()
expr_stmt|;
name|val
operator|=
name|xlr_read_reg
argument_list|(
name|iobase_i2c_regs
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
name|int
operator|)
name|val
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|palm_addr_only
parameter_list|(
name|uint8_t
name|addr
parameter_list|,
name|uint8_t
name|offset
parameter_list|)
block|{
specifier|volatile
name|uint32_t
name|regVal
init|=
literal|0x00
decl_stmt|;
name|palm_write
argument_list|(
name|I2C_PALM_ADDR
argument_list|,
name|offset
argument_list|)
expr_stmt|;
name|palm_write
argument_list|(
name|I2C_PALM_DEVADDR
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|palm_write
argument_list|(
name|I2C_PALM_CFG
argument_list|,
literal|0xfa
argument_list|)
expr_stmt|;
name|palm_write
argument_list|(
name|I2C_PALM_STARTXFR
argument_list|,
literal|0x02
argument_list|)
expr_stmt|;
name|regVal
operator|=
name|palm_read
argument_list|(
name|I2C_PALM_STATUS
argument_list|)
expr_stmt|;
if|if
condition|(
name|regVal
operator|&
literal|0x0008
condition|)
block|{
name|printf
argument_list|(
literal|"palm_addr_only: ACKERR. Aborting...\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|palm_rx
parameter_list|(
name|uint8_t
name|addr
parameter_list|,
name|uint8_t
name|offset
parameter_list|,
name|uint8_t
name|len
parameter_list|,
name|uint8_t
modifier|*
name|buf
parameter_list|)
block|{
specifier|volatile
name|uint32_t
name|regVal
init|=
literal|0x00
decl_stmt|,
name|ctr
init|=
literal|0x00
decl_stmt|;
name|int
name|timeOut
decl_stmt|,
name|numBytes
init|=
literal|0x00
decl_stmt|;
name|palm_write
argument_list|(
name|I2C_PALM_CFG
argument_list|,
literal|0xfa
argument_list|)
expr_stmt|;
name|palm_write
argument_list|(
name|I2C_PALM_BYTECNT
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|palm_write
argument_list|(
name|I2C_PALM_DEVADDR
argument_list|,
name|addr
argument_list|)
expr_stmt|;
comment|//DEVADDR=0x4c, 0x68
name|MDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
for|for
control|(
name|numBytes
operator|=
literal|0x00
init|;
name|numBytes
operator|<
name|len
condition|;
name|numBytes
operator|++
control|)
block|{
name|palm_write
argument_list|(
name|I2C_PALM_ADDR
argument_list|,
name|offset
operator|+
name|numBytes
argument_list|)
expr_stmt|;
comment|//I2C_PALM_ADDR:offset
name|MDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ctr
condition|)
block|{
comment|/* Trigger a READ Transaction */
name|palm_write
argument_list|(
name|I2C_PALM_STARTXFR
argument_list|,
name|I2C_PALM_STARTXFR_RD
argument_list|)
expr_stmt|;
name|ctr
operator|++
expr_stmt|;
block|}
comment|/* Error Conditions [Begin] */
name|regVal
operator|=
name|palm_read
argument_list|(
name|I2C_PALM_STATUS
argument_list|)
expr_stmt|;
name|MDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|regVal
operator|&
literal|0x0008
condition|)
block|{
name|printf
argument_list|(
literal|"palm_rx: ACKERR. Aborting...\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|timeOut
operator|=
literal|10
expr_stmt|;
while|while
condition|(
operator|(
name|regVal
operator|&
literal|0x0030
operator|)
operator|&&
name|timeOut
operator|--
condition|)
block|{
name|palm_write
argument_list|(
name|I2C_PALM_STARTXFR
argument_list|,
name|I2C_PALM_STARTXFR_RD
argument_list|)
expr_stmt|;
name|regVal
operator|=
name|palm_read
argument_list|(
name|I2C_PALM_STATUS
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|timeOut
operator|==
literal|0x00
condition|)
block|{
name|printf
argument_list|(
literal|"palm_rx: TimedOut on Valid STARTXFR/Arbitration\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|timeOut
operator|=
literal|10
expr_stmt|;
comment|/* Do we have valid data from the device yet..? */
name|regVal
operator|&=
literal|0x0004
expr_stmt|;
while|while
condition|(
operator|!
name|regVal
operator|&&
name|timeOut
operator|--
condition|)
block|{
name|regVal
operator|=
name|palm_read
argument_list|(
name|I2C_PALM_STATUS
argument_list|)
operator|&
literal|0x0004
expr_stmt|;
block|}
if|if
condition|(
name|timeOut
operator|==
literal|0x00
condition|)
block|{
name|printf
argument_list|(
literal|"palm_rx: TimedOut Waiting for Valid Data\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* Error Conditions [End] */
comment|/* Read the data */
name|buf
index|[
name|numBytes
index|]
operator|=
operator|(
name|uint8_t
operator|)
name|palm_read
argument_list|(
name|I2C_PALM_DATAIN
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wait_for_idle
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|timeOut
init|=
literal|0x1000
decl_stmt|;
specifier|volatile
name|uint32_t
name|regVal
init|=
literal|0x00
decl_stmt|;
name|regVal
operator|=
name|palm_read
argument_list|(
name|I2C_PALM_STATUS
argument_list|)
operator|&
literal|0x0001
expr_stmt|;
while|while
condition|(
name|regVal
operator|&&
name|timeOut
operator|--
condition|)
block|{
name|regVal
operator|=
name|palm_read
argument_list|(
name|I2C_PALM_STATUS
argument_list|)
operator|&
literal|0x0001
expr_stmt|;
block|}
if|if
condition|(
name|timeOut
operator|==
literal|0x00
condition|)
return|return
operator|-
literal|1
return|;
comment|/* Timed Out */
else|else
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|palm_tx
parameter_list|(
name|uint8_t
name|addr
parameter_list|,
name|uint8_t
name|offset
parameter_list|,
name|uint8_t
modifier|*
name|buf
parameter_list|,
name|uint8_t
name|len
parameter_list|)
block|{
specifier|volatile
name|uint32_t
name|regVal
init|=
literal|0x00
decl_stmt|;
name|int
name|timeOut
decl_stmt|,
name|ctr
init|=
literal|0x00
decl_stmt|,
name|numBytes
init|=
name|len
decl_stmt|;
for|for
control|(
name|ctr
operator|=
literal|0x00
init|;
name|ctr
operator|<
name|len
condition|;
name|ctr
operator|++
control|)
block|{
if|if
condition|(
name|wait_for_idle
argument_list|()
operator|<
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"TimedOut on Waiting for I2C Bus Idle.\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EIO
return|;
block|}
name|palm_write
argument_list|(
name|I2C_PALM_CFG
argument_list|,
literal|0xF8
argument_list|)
expr_stmt|;
name|palm_write
argument_list|(
name|I2C_PALM_BYTECNT
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|palm_write
argument_list|(
name|I2C_PALM_DEVADDR
argument_list|,
name|addr
argument_list|)
expr_stmt|;
comment|//0x4c, 0x68
name|palm_write
argument_list|(
name|I2C_PALM_ADDR
argument_list|,
name|offset
operator|+
name|numBytes
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|//offset
name|palm_write
argument_list|(
name|I2C_PALM_DATAOUT
argument_list|,
name|buf
index|[
name|ctr
index|]
argument_list|)
expr_stmt|;
name|palm_write
argument_list|(
name|I2C_PALM_STARTXFR
argument_list|,
name|I2C_PALM_STARTXFR_WR
argument_list|)
expr_stmt|;
name|MDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|regVal
operator|=
name|palm_read
argument_list|(
name|I2C_PALM_STATUS
argument_list|)
expr_stmt|;
name|MDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|regVal
operator|&
literal|0x0008
condition|)
block|{
name|printf
argument_list|(
literal|"palm_tx: ACKERR. Aborting...\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|timeOut
operator|=
literal|0x1000
expr_stmt|;
while|while
condition|(
operator|!
operator|(
name|regVal
operator|&
literal|0x0002
operator|)
operator|&&
name|timeOut
condition|)
block|{
name|regVal
operator|=
name|palm_read
argument_list|(
name|I2C_PALM_STATUS
argument_list|)
expr_stmt|;
name|timeOut
operator|--
expr_stmt|;
block|}
if|if
condition|(
name|timeOut
operator|==
literal|0x00
condition|)
block|{
name|printf
argument_list|(
literal|"palm_tx: [TimeOut] SDOEMPTY Not Set\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|timeOut
operator|=
literal|1000
expr_stmt|;
while|while
condition|(
operator|(
name|regVal
operator|&
literal|0x0030
operator|)
operator|&&
name|timeOut
condition|)
block|{
name|palm_write
argument_list|(
name|I2C_PALM_STARTXFR
argument_list|,
name|I2C_PALM_STARTXFR_WR
argument_list|)
expr_stmt|;
name|regVal
operator|=
name|palm_read
argument_list|(
name|I2C_PALM_STATUS
argument_list|)
expr_stmt|;
name|timeOut
operator|--
expr_stmt|;
block|}
if|if
condition|(
name|timeOut
operator|==
literal|0x00
condition|)
block|{
name|printf
argument_list|(
literal|"palm_rx: TimedOut on Valid STARTXFR/Arbitration\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|numBytes
operator|--
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|xlr_i2c_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"I2C bus controller"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * We add all the devices which we know about.  * The generic attach routine will attach them if they are alive.  */
end_comment

begin_function
specifier|static
name|int
name|xlr_i2c_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|xlr_i2c_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|rid
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sc
operator|->
name|mem_res
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
operator|&
name|rid
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|mem_res
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"not able to allocate the bus resource\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|sc
operator|->
name|iicbus
operator|=
name|device_add_child
argument_list|(
name|dev
argument_list|,
literal|"iicbus"
argument_list|,
operator|-
literal|1
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|printf
argument_list|(
literal|"could not allocate iicbus instance\n"
argument_list|)
expr_stmt|;
name|bus_generic_attach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|xlr_i2c_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|bus_generic_detach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*   static int xlr_i2c_add_child(device_t dev, int order, const char *name, int unit) {     printf("********* %s ********  \n", __FUNCTION__); 	device_add_child_ordered(dev, order, name, unit);  	bus_generic_attach(dev);  	return (0); } */
end_comment

begin_function
specifier|static
name|int
name|xlr_i2c_start
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|u_char
name|slave
parameter_list|,
name|int
name|timeout
parameter_list|)
block|{
name|int
name|error
init|=
literal|0
decl_stmt|;
name|struct
name|xlr_i2c_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_started
operator|=
literal|1
expr_stmt|;
name|current_slave
operator|=
operator|(
name|slave
operator|>>
literal|1
operator|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|xlr_i2c_stop
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|int
name|error
init|=
literal|0
decl_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|xlr_i2c_read
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|int
name|len
parameter_list|,
name|int
modifier|*
name|read
parameter_list|,
name|int
name|last
parameter_list|,
name|int
name|delay
parameter_list|)
block|{
name|int
name|error
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|palm_addr_only
argument_list|(
name|current_slave
argument_list|,
name|read_address
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"I2C ADDRONLY Phase Fail.\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|palm_rx
argument_list|(
name|current_slave
argument_list|,
name|read_address
argument_list|,
name|len
argument_list|,
name|buf
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"I2C Read Fail.\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
operator|*
name|read
operator|=
name|len
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|xlr_i2c_write
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|int
name|len
parameter_list|,
name|int
modifier|*
name|sent
parameter_list|,
name|int
name|timeout
comment|/* us */
parameter_list|)
block|{
name|int
name|error
init|=
literal|0
decl_stmt|;
name|uint8_t
name|write_address
decl_stmt|;
if|if
condition|(
name|len
operator|==
literal|1
condition|)
block|{
comment|/* address for the next read*/
name|read_address
operator|=
name|buf
index|[
literal|0
index|]
expr_stmt|;
return|return
name|error
return|;
block|}
if|if
condition|(
name|len
operator|<
literal|2
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|write_address
operator|=
name|buf
index|[
literal|0
index|]
expr_stmt|;
comment|/*for write operation, buf[0] contains the register offset and          buf[1] onwards contains the value*/
name|palm_tx
argument_list|(
name|current_slave
argument_list|,
name|write_address
argument_list|,
operator|&
name|buf
index|[
literal|1
index|]
argument_list|,
name|len
operator|-
literal|1
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|xlr_i2c_callback
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|index
parameter_list|,
name|caddr_t
modifier|*
name|data
parameter_list|)
block|{
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|xlr_i2c_repeated_start
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|u_char
name|slave
parameter_list|,
name|int
name|timeout
parameter_list|)
block|{
return|return
literal|0
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|device_method_t
name|xlr_i2c_methods
index|[]
init|=
block|{
comment|/* device interface */
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|xlr_i2c_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|xlr_i2c_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|xlr_i2c_detach
argument_list|)
block|,
comment|/* iicbus interface */
name|DEVMETHOD
argument_list|(
name|iicbus_callback
argument_list|,
name|xlr_i2c_callback
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|iicbus_repeated_start
argument_list|,
name|xlr_i2c_repeated_start
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|iicbus_start
argument_list|,
name|xlr_i2c_start
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|iicbus_stop
argument_list|,
name|xlr_i2c_stop
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|iicbus_write
argument_list|,
name|xlr_i2c_write
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|iicbus_read
argument_list|,
name|xlr_i2c_read
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|xlr_i2c_driver
init|=
block|{
literal|"xlr_i2c"
block|,
name|xlr_i2c_methods
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|xlr_i2c_softc
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|xlr_i2c
argument_list|,
name|iodi
argument_list|,
name|xlr_i2c_driver
argument_list|,
name|xlr_i2c_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


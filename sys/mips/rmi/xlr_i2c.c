begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * SPDX-License-Identifier: BSD-3-Clause  *  * Copyright (c) 2003-2009 RMI Corporation  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. Neither the name of RMI Corporation, nor the names of its contributors,  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * RMI_BSD */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*  * I2C driver for the Palm-BK3220 I2C Host adapter on the RMI XLR.  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<dev/iicbus/iiconf.h>
end_include

begin_include
include|#
directive|include
file|<dev/iicbus/iicbus.h>
end_include

begin_include
include|#
directive|include
file|<mips/rmi/board.h>
end_include

begin_include
include|#
directive|include
file|<mips/rmi/iomap.h>
end_include

begin_include
include|#
directive|include
file|<mips/include/resource.h>
end_include

begin_include
include|#
directive|include
file|"iicbus_if.h"
end_include

begin_comment
comment|/* XLR I2C REGISTERS */
end_comment

begin_define
define|#
directive|define
name|XLR_I2C_CFG
value|0x00
end_define

begin_define
define|#
directive|define
name|XLR_I2C_CLKDIV
value|0x01
end_define

begin_define
define|#
directive|define
name|XLR_I2C_DEVADDR
value|0x02
end_define

begin_define
define|#
directive|define
name|XLR_I2C_ADDR
value|0x03
end_define

begin_define
define|#
directive|define
name|XLR_I2C_DATAOUT
value|0x04
end_define

begin_define
define|#
directive|define
name|XLR_I2C_DATAIN
value|0x05
end_define

begin_define
define|#
directive|define
name|XLR_I2C_STATUS
value|0x06
end_define

begin_define
define|#
directive|define
name|XLR_I2C_STARTXFR
value|0x07
end_define

begin_define
define|#
directive|define
name|XLR_I2C_BYTECNT
value|0x08
end_define

begin_define
define|#
directive|define
name|XLR_I2C_HDSTATIM
value|0x09
end_define

begin_comment
comment|/* XLR I2C REGISTERS FLAGS */
end_comment

begin_define
define|#
directive|define
name|XLR_I2C_BUS_BUSY
value|0x01
end_define

begin_define
define|#
directive|define
name|XLR_I2C_SDOEMPTY
value|0x02
end_define

begin_define
define|#
directive|define
name|XLR_I2C_RXRDY
value|0x04
end_define

begin_define
define|#
directive|define
name|XLR_I2C_ACK_ERR
value|0x08
end_define

begin_define
define|#
directive|define
name|XLR_I2C_ARB_STARTERR
value|0x30
end_define

begin_comment
comment|/* Register Programming Values!! Change as required */
end_comment

begin_define
define|#
directive|define
name|XLR_I2C_CFG_ADDR
value|0xF8
end_define

begin_comment
comment|/* 8-Bit dev Addr + POR Values */
end_comment

begin_define
define|#
directive|define
name|XLR_I2C_CFG_NOADDR
value|0xFA
end_define

begin_comment
comment|/* 8-Bit reg Addr + POR Values  : No dev addr */
end_comment

begin_define
define|#
directive|define
name|XLR_I2C_STARTXFR_ND
value|0x02
end_define

begin_comment
comment|/* No data , only addr */
end_comment

begin_define
define|#
directive|define
name|XLR_I2C_STARTXFR_RD
value|0x01
end_define

begin_comment
comment|/* Read */
end_comment

begin_define
define|#
directive|define
name|XLR_I2C_STARTXFR_WR
value|0x00
end_define

begin_comment
comment|/* Write */
end_comment

begin_define
define|#
directive|define
name|XLR_I2C_CLKDIV_DEF
value|0x14A
end_define

begin_comment
comment|/* 0x00000052 */
end_comment

begin_define
define|#
directive|define
name|XLR_I2C_HDSTATIM_DEF
value|0x107
end_define

begin_comment
comment|/* 0x00000000 */
end_comment

begin_define
define|#
directive|define
name|MAXTIME
value|0x10000
end_define

begin_define
define|#
directive|define
name|ARIZONA_I2C_BUS
value|1
end_define

begin_decl_stmt
specifier|static
name|devclass_t
name|xlr_i2c_devclass
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Device methods  */
end_comment

begin_function_decl
specifier|static
name|int
name|xlr_i2c_probe
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|xlr_i2c_attach
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|xlr_i2c_detach
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|xlr_i2c_start
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|u_char
name|slave
parameter_list|,
name|int
name|timeout
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|xlr_i2c_stop
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|xlr_i2c_read
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|int
name|len
parameter_list|,
name|int
modifier|*
name|read
parameter_list|,
name|int
name|last
parameter_list|,
name|int
name|delay
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|xlr_i2c_write
parameter_list|(
name|device_t
name|dev
parameter_list|,
specifier|const
name|char
modifier|*
name|buf
parameter_list|,
name|int
name|len
parameter_list|,
name|int
modifier|*
name|sent
parameter_list|,
name|int
name|timeout
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|xlr_i2c_callback
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|index
parameter_list|,
name|caddr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|xlr_i2c_repeated_start
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|u_char
name|slave
parameter_list|,
name|int
name|timeout
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|xlr_i2c_transfer
parameter_list|(
name|device_t
name|bus
parameter_list|,
name|struct
name|iic_msg
modifier|*
name|msgs
parameter_list|,
name|uint32_t
name|nmsgs
parameter_list|)
function_decl|;
end_function_decl

begin_struct
struct|struct
name|xlr_i2c_softc
block|{
name|device_t
name|dev
decl_stmt|;
comment|/* Self */
name|struct
name|resource
modifier|*
name|mem_res
decl_stmt|;
comment|/* Memory resource */
specifier|volatile
name|int
name|flags
decl_stmt|;
name|int
name|sc_started
decl_stmt|;
name|uint8_t
name|i2cdev_addr
decl_stmt|;
name|xlr_reg_t
modifier|*
name|iobase_i2c_regs
decl_stmt|;
name|device_t
name|iicbus
decl_stmt|;
name|struct
name|mtx
name|sc_mtx
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
name|set_i2c_base
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|xlr_i2c_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|device_get_unit
argument_list|(
name|dev
argument_list|)
operator|==
literal|0
condition|)
name|sc
operator|->
name|iobase_i2c_regs
operator|=
name|xlr_io_mmio
argument_list|(
name|XLR_IO_I2C_0_OFFSET
argument_list|)
expr_stmt|;
else|else
name|sc
operator|->
name|iobase_i2c_regs
operator|=
name|xlr_io_mmio
argument_list|(
name|XLR_IO_I2C_1_OFFSET
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|xlr_i2c_dev_write
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|reg
parameter_list|,
name|int
name|value
parameter_list|)
block|{
name|struct
name|xlr_i2c_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|xlr_write_reg
argument_list|(
name|sc
operator|->
name|iobase_i2c_regs
argument_list|,
name|reg
argument_list|,
name|value
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|xlr_i2c_dev_read
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|reg
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|;
name|struct
name|xlr_i2c_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|val
operator|=
name|xlr_read_reg
argument_list|(
name|sc
operator|->
name|iobase_i2c_regs
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
name|int
operator|)
name|val
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|xlr_i2c_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"XLR/XLS I2C bus controller"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * We add all the devices which we know about.  * The generic attach routine will attach them if they are alive.  */
end_comment

begin_function
specifier|static
name|int
name|xlr_i2c_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|int
name|rid
decl_stmt|;
name|struct
name|xlr_i2c_softc
modifier|*
name|sc
decl_stmt|;
name|device_t
name|tmpd
decl_stmt|;
if|if
condition|(
name|device_get_unit
argument_list|(
name|dev
argument_list|)
operator|!=
name|ARIZONA_I2C_BUS
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unused iicbus instance\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|set_i2c_base
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|mtx_init
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|,
literal|"xlr_i2c"
argument_list|,
literal|"xlr_i2c"
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
name|sc
operator|->
name|mem_res
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
operator|&
name|rid
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|mem_res
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"not able to allocate the bus resource\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|sc
operator|->
name|iicbus
operator|=
name|device_add_child
argument_list|(
name|dev
argument_list|,
literal|"iicbus"
argument_list|,
operator|-
literal|1
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"could not allocate iicbus instance\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|xlr_board_info
operator|.
name|xlr_i2c_device
index|[
name|I2C_RTC
index|]
operator|.
name|enabled
operator|==
literal|1
condition|)
block|{
name|tmpd
operator|=
name|device_add_child
argument_list|(
name|sc
operator|->
name|iicbus
argument_list|,
literal|"ds13rtc"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|device_set_ivars
argument_list|(
name|tmpd
argument_list|,
operator|&
name|xlr_board_info
operator|.
name|xlr_i2c_device
index|[
name|I2C_RTC
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|xlr_board_info
operator|.
name|xlr_i2c_device
index|[
name|I2C_THERMAL
index|]
operator|.
name|enabled
operator|==
literal|1
condition|)
block|{
name|tmpd
operator|=
name|device_add_child
argument_list|(
name|sc
operator|->
name|iicbus
argument_list|,
literal|"max6657"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|device_set_ivars
argument_list|(
name|tmpd
argument_list|,
operator|&
name|xlr_board_info
operator|.
name|xlr_i2c_device
index|[
name|I2C_THERMAL
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|xlr_board_info
operator|.
name|xlr_i2c_device
index|[
name|I2C_EEPROM
index|]
operator|.
name|enabled
operator|==
literal|1
condition|)
block|{
name|tmpd
operator|=
name|device_add_child
argument_list|(
name|sc
operator|->
name|iicbus
argument_list|,
literal|"at24co2n"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|device_set_ivars
argument_list|(
name|tmpd
argument_list|,
operator|&
name|xlr_board_info
operator|.
name|xlr_i2c_device
index|[
name|I2C_EEPROM
index|]
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * The old ds1374 rtc driver only handled one chip type.  The new 	 * ds13rtc driver handles all ds13xx chips, but must be told the chip 	 * type via hints.  XLR historically hasn't had a standard hints file, 	 * so set up the hint now if it isn't already there. 	 */
define|#
directive|define
name|HINTNAME
value|"hint.ds13rtc.0.compatible"
if|if
condition|(
operator|!
name|testenv
argument_list|(
name|HINTNAME
argument_list|)
condition|)
name|kern_setenv
argument_list|(
name|HINTNAME
argument_list|,
literal|"dallas,ds1374"
argument_list|)
expr_stmt|;
name|bus_generic_attach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|xlr_i2c_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|bus_generic_detach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|xlr_i2c_start
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|u_char
name|slave
parameter_list|,
name|int
name|timeout
parameter_list|)
block|{
name|int
name|error
init|=
literal|0
decl_stmt|;
name|struct
name|xlr_i2c_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_started
operator|=
literal|1
expr_stmt|;
name|sc
operator|->
name|i2cdev_addr
operator|=
operator|(
name|slave
operator|>>
literal|1
operator|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|xlr_i2c_stop
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|int
name|error
init|=
literal|0
decl_stmt|;
name|struct
name|xlr_i2c_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|xlr_i2c_read
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|int
name|len
parameter_list|,
name|int
modifier|*
name|read
parameter_list|,
name|int
name|last
parameter_list|,
name|int
name|delay
parameter_list|)
block|{
specifier|volatile
name|uint32_t
name|i2c_status
init|=
literal|0
decl_stmt|;
name|int
name|pos
init|=
literal|0
decl_stmt|;
name|int
name|timeout
init|=
literal|0
decl_stmt|;
name|xlr_i2c_dev_write
argument_list|(
name|dev
argument_list|,
name|XLR_I2C_CFG
argument_list|,
name|XLR_I2C_CFG_NOADDR
argument_list|)
expr_stmt|;
name|xlr_i2c_dev_write
argument_list|(
name|dev
argument_list|,
name|XLR_I2C_BYTECNT
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|retry
label|:
name|xlr_i2c_dev_write
argument_list|(
name|dev
argument_list|,
name|XLR_I2C_STARTXFR
argument_list|,
name|XLR_I2C_STARTXFR_RD
argument_list|)
expr_stmt|;
name|timeout
operator|=
literal|0
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
if|if
condition|(
name|timeout
operator|++
operator|>
name|MAXTIME
condition|)
return|return
operator|-
literal|1
return|;
name|i2c_status
operator|=
name|xlr_i2c_dev_read
argument_list|(
name|dev
argument_list|,
name|XLR_I2C_STATUS
argument_list|)
expr_stmt|;
if|if
condition|(
name|i2c_status
operator|&
name|XLR_I2C_RXRDY
condition|)
name|buf
index|[
name|pos
operator|++
index|]
operator|=
operator|(
name|uint8_t
operator|)
name|xlr_i2c_dev_read
argument_list|(
name|dev
argument_list|,
name|XLR_I2C_DATAIN
argument_list|)
expr_stmt|;
comment|/* ACKERR -- bail */
if|if
condition|(
name|i2c_status
operator|&
name|XLR_I2C_ACK_ERR
condition|)
return|return
operator|-
literal|1
return|;
comment|/* ACK_ERROR */
comment|/* LOST ARB or STARTERR -- repeat */
if|if
condition|(
name|i2c_status
operator|&
name|XLR_I2C_ARB_STARTERR
condition|)
goto|goto
name|retry
goto|;
comment|/* Wait for busy bit to go away */
if|if
condition|(
name|i2c_status
operator|&
name|XLR_I2C_BUS_BUSY
condition|)
continue|continue;
if|if
condition|(
name|pos
operator|==
name|len
condition|)
break|break;
block|}
operator|*
name|read
operator|=
name|pos
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|xlr_i2c_write
parameter_list|(
name|device_t
name|dev
parameter_list|,
specifier|const
name|char
modifier|*
name|buf
parameter_list|,
name|int
name|len
parameter_list|,
name|int
modifier|*
name|sent
parameter_list|,
name|int
name|timeout
comment|/* us */
parameter_list|)
block|{
specifier|volatile
name|uint32_t
name|i2c_status
init|=
literal|0x00
decl_stmt|;
name|uint8_t
name|devaddr
decl_stmt|,
name|addr
decl_stmt|;
name|struct
name|xlr_i2c_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|pos
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* the first byte of write is  addr (of register in device) */
name|addr
operator|=
name|buf
index|[
literal|0
index|]
expr_stmt|;
name|devaddr
operator|=
name|sc
operator|->
name|i2cdev_addr
expr_stmt|;
name|xlr_i2c_dev_write
argument_list|(
name|dev
argument_list|,
name|XLR_I2C_ADDR
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|xlr_i2c_dev_write
argument_list|(
name|dev
argument_list|,
name|XLR_I2C_DEVADDR
argument_list|,
name|devaddr
argument_list|)
expr_stmt|;
name|xlr_i2c_dev_write
argument_list|(
name|dev
argument_list|,
name|XLR_I2C_CFG
argument_list|,
name|XLR_I2C_CFG_ADDR
argument_list|)
expr_stmt|;
name|xlr_i2c_dev_write
argument_list|(
name|dev
argument_list|,
name|XLR_I2C_BYTECNT
argument_list|,
name|len
operator|-
literal|1
argument_list|)
expr_stmt|;
name|retry
label|:
name|pos
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|len
operator|==
literal|1
condition|)
comment|/* there is no data only address */
name|xlr_i2c_dev_write
argument_list|(
name|dev
argument_list|,
name|XLR_I2C_STARTXFR
argument_list|,
name|XLR_I2C_STARTXFR_ND
argument_list|)
expr_stmt|;
else|else
block|{
name|xlr_i2c_dev_write
argument_list|(
name|dev
argument_list|,
name|XLR_I2C_STARTXFR
argument_list|,
name|XLR_I2C_STARTXFR_WR
argument_list|)
expr_stmt|;
name|xlr_i2c_dev_write
argument_list|(
name|dev
argument_list|,
name|XLR_I2C_DATAOUT
argument_list|,
name|buf
index|[
name|pos
index|]
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
literal|1
condition|)
block|{
name|i2c_status
operator|=
name|xlr_i2c_dev_read
argument_list|(
name|dev
argument_list|,
name|XLR_I2C_STATUS
argument_list|)
expr_stmt|;
comment|/* sdo empty send next byte */
if|if
condition|(
name|i2c_status
operator|&
name|XLR_I2C_SDOEMPTY
condition|)
block|{
name|pos
operator|++
expr_stmt|;
name|xlr_i2c_dev_write
argument_list|(
name|dev
argument_list|,
name|XLR_I2C_DATAOUT
argument_list|,
name|buf
index|[
name|pos
index|]
argument_list|)
expr_stmt|;
block|}
comment|/* LOST ARB or STARTERR -- repeat */
if|if
condition|(
name|i2c_status
operator|&
name|XLR_I2C_ARB_STARTERR
condition|)
goto|goto
name|retry
goto|;
comment|/* ACKERR -- bail */
if|if
condition|(
name|i2c_status
operator|&
name|XLR_I2C_ACK_ERR
condition|)
block|{
name|printf
argument_list|(
literal|"ACK ERR : exiting\n "
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* busy try again */
if|if
condition|(
name|i2c_status
operator|&
name|XLR_I2C_BUS_BUSY
condition|)
continue|continue;
if|if
condition|(
name|pos
operator|>=
name|len
condition|)
break|break;
block|}
operator|*
name|sent
operator|=
name|len
operator|-
literal|1
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|xlr_i2c_callback
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|index
parameter_list|,
name|caddr_t
name|data
parameter_list|)
block|{
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|xlr_i2c_repeated_start
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|u_char
name|slave
parameter_list|,
name|int
name|timeout
parameter_list|)
block|{
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * I2C bus transfer for RMI boards and devices.  * Generic version of iicbus_transfer that calls the appropriate  * routines to accomplish this.  See note above about acceptable  * buffer addresses.  */
end_comment

begin_function
name|int
name|xlr_i2c_transfer
parameter_list|(
name|device_t
name|bus
parameter_list|,
name|struct
name|iic_msg
modifier|*
name|msgs
parameter_list|,
name|uint32_t
name|nmsgs
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|error
decl_stmt|,
name|lenread
decl_stmt|,
name|lenwrote
decl_stmt|;
name|u_char
name|addr
decl_stmt|;
name|addr
operator|=
name|msgs
index|[
literal|0
index|]
operator|.
name|slave
operator||
name|LSB
expr_stmt|;
name|error
operator|=
name|xlr_i2c_start
argument_list|(
name|bus
argument_list|,
name|addr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|error
operator|=
literal|0
init|;
name|i
operator|<
name|nmsgs
operator|&&
name|error
operator|==
literal|0
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|msgs
index|[
name|i
index|]
operator|.
name|flags
operator|&
name|IIC_M_RD
condition|)
block|{
name|error
operator|=
name|xlr_i2c_read
argument_list|(
operator|(
name|bus
operator|)
argument_list|,
name|msgs
index|[
name|i
index|]
operator|.
name|buf
argument_list|,
name|msgs
index|[
name|i
index|]
operator|.
name|len
argument_list|,
operator|&
name|lenread
argument_list|,
name|IIC_LAST_READ
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|error
operator|=
name|xlr_i2c_write
argument_list|(
operator|(
name|bus
operator|)
argument_list|,
name|msgs
index|[
name|i
index|]
operator|.
name|buf
argument_list|,
name|msgs
index|[
name|i
index|]
operator|.
name|len
argument_list|,
operator|&
name|lenwrote
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
name|error
operator|=
name|xlr_i2c_stop
argument_list|(
name|bus
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|device_method_t
name|xlr_i2c_methods
index|[]
init|=
block|{
comment|/* device interface */
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|xlr_i2c_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|xlr_i2c_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|xlr_i2c_detach
argument_list|)
block|,
comment|/* iicbus interface */
name|DEVMETHOD
argument_list|(
name|iicbus_callback
argument_list|,
name|xlr_i2c_callback
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|iicbus_repeated_start
argument_list|,
name|xlr_i2c_repeated_start
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|iicbus_start
argument_list|,
name|xlr_i2c_start
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|iicbus_stop
argument_list|,
name|xlr_i2c_stop
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|iicbus_write
argument_list|,
name|xlr_i2c_write
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|iicbus_read
argument_list|,
name|xlr_i2c_read
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|iicbus_transfer
argument_list|,
name|xlr_i2c_transfer
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|xlr_i2c_driver
init|=
block|{
literal|"xlr_i2c"
block|,
name|xlr_i2c_methods
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|xlr_i2c_softc
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|xlr_i2c
argument_list|,
name|iodi
argument_list|,
name|xlr_i2c_driver
argument_list|,
name|xlr_i2c_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|iicbus
argument_list|,
name|xlr_i2c
argument_list|,
name|iicbus_driver
argument_list|,
name|iicbus_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


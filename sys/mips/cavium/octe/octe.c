begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2010 Juli Mallett<jmallett@FreeBSD.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_comment
comment|/*  * Cavium Octeon Ethernet devices.  *  * XXX This file should be moved to if_octe.c  * XXX The driver may have sufficient locking but we need locking to protect  *     the interfaces presented here, right?  */
end_comment

begin_include
include|#
directive|include
file|"opt_inet.h"
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<net/bpf.h>
end_include

begin_include
include|#
directive|include
file|<net/ethernet.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_dl.h>
end_include

begin_include
include|#
directive|include
file|<net/if_media.h>
end_include

begin_include
include|#
directive|include
file|<net/if_types.h>
end_include

begin_include
include|#
directive|include
file|<net/if_var.h>
end_include

begin_include
include|#
directive|include
file|<net/if_vlan_var.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|INET
end_ifdef

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/if_ether.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<dev/mii/mii.h>
end_include

begin_include
include|#
directive|include
file|<dev/mii/miivar.h>
end_include

begin_include
include|#
directive|include
file|"wrapper-cvmx-includes.h"
end_include

begin_include
include|#
directive|include
file|"cavium-ethernet.h"
end_include

begin_include
include|#
directive|include
file|"ethernet-common.h"
end_include

begin_include
include|#
directive|include
file|"ethernet-defines.h"
end_include

begin_include
include|#
directive|include
file|"ethernet-mdio.h"
end_include

begin_include
include|#
directive|include
file|"ethernet-tx.h"
end_include

begin_include
include|#
directive|include
file|"miibus_if.h"
end_include

begin_define
define|#
directive|define
name|OCTE_TX_LOCK
parameter_list|(
name|priv
parameter_list|)
value|mtx_lock(&(priv)->tx_mtx)
end_define

begin_define
define|#
directive|define
name|OCTE_TX_UNLOCK
parameter_list|(
name|priv
parameter_list|)
value|mtx_unlock(&(priv)->tx_mtx)
end_define

begin_function_decl
specifier|static
name|int
name|octe_probe
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|octe_attach
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|octe_detach
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|octe_shutdown
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|octe_miibus_readreg
parameter_list|(
name|device_t
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|octe_miibus_writereg
parameter_list|(
name|device_t
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|octe_init
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|octe_stop
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|octe_transmit
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|octe_mii_medchange
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|octe_mii_medstat
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|,
name|struct
name|ifmediareq
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|octe_medchange
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|octe_medstat
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|,
name|struct
name|ifmediareq
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|octe_ioctl
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|,
name|u_long
parameter_list|,
name|caddr_t
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|device_method_t
name|octe_methods
index|[]
init|=
block|{
comment|/* Device interface */
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|octe_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|octe_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|octe_detach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_shutdown
argument_list|,
name|octe_shutdown
argument_list|)
block|,
comment|/* MII interface */
name|DEVMETHOD
argument_list|(
name|miibus_readreg
argument_list|,
name|octe_miibus_readreg
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|miibus_writereg
argument_list|,
name|octe_miibus_writereg
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|octe_driver
init|=
block|{
literal|"octe"
block|,
name|octe_methods
block|,
sizeof|sizeof
argument_list|(
name|cvm_oct_private_t
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|octe_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|octe
argument_list|,
name|octebus
argument_list|,
name|octe_driver
argument_list|,
name|octe_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|miibus
argument_list|,
name|octe
argument_list|,
name|miibus_driver
argument_list|,
name|miibus_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|int
name|octe_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|octe_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|cvm_oct_private_t
modifier|*
name|priv
decl_stmt|;
name|device_t
name|child
decl_stmt|;
name|unsigned
name|qos
decl_stmt|;
name|int
name|error
decl_stmt|;
name|priv
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|ifp
operator|=
name|priv
operator|->
name|ifp
expr_stmt|;
name|if_initname
argument_list|(
name|ifp
argument_list|,
name|device_get_name
argument_list|(
name|dev
argument_list|)
argument_list|,
name|device_get_unit
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|phy_id
operator|!=
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|priv
operator|->
name|phy_device
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|mii_attach
argument_list|(
name|dev
argument_list|,
operator|&
name|priv
operator|->
name|miibus
argument_list|,
name|ifp
argument_list|,
name|octe_mii_medchange
argument_list|,
name|octe_mii_medstat
argument_list|,
name|BMSR_DEFCAPMASK
argument_list|,
name|priv
operator|->
name|phy_id
argument_list|,
name|MII_OFFSET_ANY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"attaching PHYs failed\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|child
operator|=
name|device_add_child
argument_list|(
name|dev
argument_list|,
name|priv
operator|->
name|phy_device
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
name|NULL
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"missing phy %u device %s\n"
argument_list|,
name|priv
operator|->
name|phy_id
argument_list|,
name|priv
operator|->
name|phy_device
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|priv
operator|->
name|miibus
operator|==
name|NULL
condition|)
block|{
name|ifmedia_init
argument_list|(
operator|&
name|priv
operator|->
name|media
argument_list|,
literal|0
argument_list|,
name|octe_medchange
argument_list|,
name|octe_medstat
argument_list|)
expr_stmt|;
name|ifmedia_add
argument_list|(
operator|&
name|priv
operator|->
name|media
argument_list|,
name|IFM_ETHER
operator||
name|IFM_AUTO
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ifmedia_set
argument_list|(
operator|&
name|priv
operator|->
name|media
argument_list|,
name|IFM_ETHER
operator||
name|IFM_AUTO
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * XXX 	 * We don't support programming the multicast filter right now, although it 	 * ought to be easy enough.  (Presumably it's just a matter of putting 	 * multicast addresses in the CAM?) 	 */
name|ifp
operator|->
name|if_flags
operator|=
name|IFF_BROADCAST
operator||
name|IFF_SIMPLEX
operator||
name|IFF_MULTICAST
operator||
name|IFF_ALLMULTI
expr_stmt|;
name|ifp
operator|->
name|if_init
operator|=
name|octe_init
expr_stmt|;
name|ifp
operator|->
name|if_ioctl
operator|=
name|octe_ioctl
expr_stmt|;
name|priv
operator|->
name|if_flags
operator|=
name|ifp
operator|->
name|if_flags
expr_stmt|;
name|mtx_init
argument_list|(
operator|&
name|priv
operator|->
name|tx_mtx
argument_list|,
name|ifp
operator|->
name|if_xname
argument_list|,
literal|"octe tx send queue"
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
for|for
control|(
name|qos
operator|=
literal|0
init|;
name|qos
operator|<
literal|16
condition|;
name|qos
operator|++
control|)
block|{
name|mtx_init
argument_list|(
operator|&
name|priv
operator|->
name|tx_free_queue
index|[
name|qos
index|]
operator|.
name|ifq_mtx
argument_list|,
name|ifp
operator|->
name|if_xname
argument_list|,
literal|"octe tx free queue"
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
name|IFQ_SET_MAXLEN
argument_list|(
operator|&
name|priv
operator|->
name|tx_free_queue
index|[
name|qos
index|]
argument_list|,
name|MAX_OUT_QUEUE_DEPTH
argument_list|)
expr_stmt|;
block|}
name|ether_ifattach
argument_list|(
name|ifp
argument_list|,
name|priv
operator|->
name|mac
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_transmit
operator|=
name|octe_transmit
expr_stmt|;
name|ifp
operator|->
name|if_hdrlen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ether_vlan_header
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_capabilities
operator|=
name|IFCAP_VLAN_MTU
operator||
name|IFCAP_HWCSUM
expr_stmt|;
name|ifp
operator|->
name|if_capenable
operator|=
name|ifp
operator|->
name|if_capabilities
expr_stmt|;
name|ifp
operator|->
name|if_hwassist
operator|=
name|CSUM_TCP
operator||
name|CSUM_UDP
expr_stmt|;
name|OCTE_TX_LOCK
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|IFQ_SET_MAXLEN
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|,
name|MAX_OUT_QUEUE_DEPTH
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_snd
operator|.
name|ifq_drv_maxlen
operator|=
name|MAX_OUT_QUEUE_DEPTH
expr_stmt|;
name|IFQ_SET_READY
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|)
expr_stmt|;
name|OCTE_TX_UNLOCK
argument_list|(
name|priv
argument_list|)
expr_stmt|;
return|return
operator|(
name|bus_generic_attach
argument_list|(
name|dev
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|octe_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|octe_shutdown
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
return|return
operator|(
name|octe_detach
argument_list|(
name|dev
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|octe_miibus_readreg
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|phy
parameter_list|,
name|int
name|reg
parameter_list|)
block|{
name|cvm_oct_private_t
modifier|*
name|priv
decl_stmt|;
name|priv
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* 	 * Try interface-specific MII routine. 	 */
if|if
condition|(
name|priv
operator|->
name|mdio_read
operator|!=
name|NULL
condition|)
return|return
operator|(
name|priv
operator|->
name|mdio_read
argument_list|(
name|priv
operator|->
name|ifp
argument_list|,
name|phy
argument_list|,
name|reg
argument_list|)
operator|)
return|;
comment|/* 	 * Try generic MII routine. 	 */
name|KASSERT
argument_list|(
name|phy
operator|==
name|priv
operator|->
name|phy_id
argument_list|,
operator|(
literal|"read from phy %u but our phy is %u"
operator|,
name|phy
operator|,
name|priv
operator|->
name|phy_id
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|cvm_oct_mdio_read
argument_list|(
name|priv
operator|->
name|ifp
argument_list|,
name|phy
argument_list|,
name|reg
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|octe_miibus_writereg
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|phy
parameter_list|,
name|int
name|reg
parameter_list|,
name|int
name|val
parameter_list|)
block|{
name|cvm_oct_private_t
modifier|*
name|priv
decl_stmt|;
name|priv
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* 	 * Try interface-specific MII routine. 	 */
if|if
condition|(
name|priv
operator|->
name|mdio_write
operator|!=
name|NULL
condition|)
block|{
name|priv
operator|->
name|mdio_write
argument_list|(
name|priv
operator|->
name|ifp
argument_list|,
name|phy
argument_list|,
name|reg
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
comment|/* 	 * Try generic MII routine. 	 */
name|KASSERT
argument_list|(
name|phy
operator|==
name|priv
operator|->
name|phy_id
argument_list|,
operator|(
literal|"write to phy %u but our phy is %u"
operator|,
name|phy
operator|,
name|priv
operator|->
name|phy_id
operator|)
argument_list|)
expr_stmt|;
name|cvm_oct_mdio_write
argument_list|(
name|priv
operator|->
name|ifp
argument_list|,
name|phy
argument_list|,
name|reg
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|octe_init
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|cvm_oct_private_t
modifier|*
name|priv
decl_stmt|;
name|priv
operator|=
name|arg
expr_stmt|;
name|ifp
operator|=
name|priv
operator|->
name|ifp
expr_stmt|;
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
operator|!=
literal|0
condition|)
name|octe_stop
argument_list|(
name|priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|open
operator|!=
name|NULL
condition|)
name|priv
operator|->
name|open
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|ifp
operator|->
name|if_flags
operator|^
name|priv
operator|->
name|if_flags
operator|)
operator|&
operator|(
name|IFF_ALLMULTI
operator||
name|IFF_MULTICAST
operator||
name|IFF_PROMISC
operator|)
operator|)
operator|!=
literal|0
condition|)
name|cvm_oct_common_set_multicast_list
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|cvm_oct_common_set_mac_address
argument_list|(
name|ifp
argument_list|,
name|IF_LLADDR
argument_list|(
name|ifp
argument_list|)
argument_list|)
expr_stmt|;
name|cvm_oct_common_poll
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|miibus
operator|!=
name|NULL
condition|)
name|mii_mediachg
argument_list|(
name|device_get_softc
argument_list|(
name|priv
operator|->
name|miibus
argument_list|)
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator||=
name|IFF_DRV_RUNNING
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_OACTIVE
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|octe_stop
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|cvm_oct_private_t
modifier|*
name|priv
decl_stmt|;
name|priv
operator|=
name|arg
expr_stmt|;
name|ifp
operator|=
name|priv
operator|->
name|ifp
expr_stmt|;
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
name|priv
operator|->
name|stop
operator|!=
name|NULL
condition|)
name|priv
operator|->
name|stop
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_RUNNING
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|octe_transmit
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|)
block|{
name|cvm_oct_private_t
modifier|*
name|priv
decl_stmt|;
name|priv
operator|=
name|ifp
operator|->
name|if_softc
expr_stmt|;
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
operator|(
name|IFF_DRV_RUNNING
operator||
name|IFF_DRV_OACTIVE
operator|)
operator|)
operator|!=
name|IFF_DRV_RUNNING
condition|)
block|{
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
return|return
operator|(
name|cvm_oct_xmit
argument_list|(
name|m
argument_list|,
name|ifp
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|octe_mii_medchange
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|cvm_oct_private_t
modifier|*
name|priv
decl_stmt|;
name|struct
name|mii_data
modifier|*
name|mii
decl_stmt|;
name|struct
name|mii_softc
modifier|*
name|miisc
decl_stmt|;
name|priv
operator|=
name|ifp
operator|->
name|if_softc
expr_stmt|;
name|mii
operator|=
name|device_get_softc
argument_list|(
name|priv
operator|->
name|miibus
argument_list|)
expr_stmt|;
name|LIST_FOREACH
argument_list|(
argument|miisc
argument_list|,
argument|&mii->mii_phys
argument_list|,
argument|mii_list
argument_list|)
name|PHY_RESET
argument_list|(
name|miisc
argument_list|)
expr_stmt|;
name|mii_mediachg
argument_list|(
name|mii
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|octe_mii_medstat
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|ifmediareq
modifier|*
name|ifm
parameter_list|)
block|{
name|cvm_oct_private_t
modifier|*
name|priv
decl_stmt|;
name|struct
name|mii_data
modifier|*
name|mii
decl_stmt|;
name|priv
operator|=
name|ifp
operator|->
name|if_softc
expr_stmt|;
name|mii
operator|=
name|device_get_softc
argument_list|(
name|priv
operator|->
name|miibus
argument_list|)
expr_stmt|;
name|mii_pollstat
argument_list|(
name|mii
argument_list|)
expr_stmt|;
name|ifm
operator|->
name|ifm_active
operator|=
name|mii
operator|->
name|mii_media_active
expr_stmt|;
name|ifm
operator|->
name|ifm_status
operator|=
name|mii
operator|->
name|mii_media_status
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|octe_medchange
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
return|return
operator|(
name|ENOTSUP
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|octe_medstat
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|ifmediareq
modifier|*
name|ifm
parameter_list|)
block|{
name|cvm_oct_private_t
modifier|*
name|priv
decl_stmt|;
name|cvmx_helper_link_info_t
name|link_info
decl_stmt|;
name|priv
operator|=
name|ifp
operator|->
name|if_softc
expr_stmt|;
name|ifm
operator|->
name|ifm_status
operator|=
name|IFM_AVALID
expr_stmt|;
name|ifm
operator|->
name|ifm_active
operator|=
name|IFT_ETHER
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|poll
operator|==
name|NULL
condition|)
return|return;
name|priv
operator|->
name|poll
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|link_info
operator|.
name|u64
operator|=
name|priv
operator|->
name|link_info
expr_stmt|;
if|if
condition|(
operator|!
name|link_info
operator|.
name|s
operator|.
name|link_up
condition|)
return|return;
name|ifm
operator|->
name|ifm_status
operator||=
name|IFM_ACTIVE
expr_stmt|;
switch|switch
condition|(
name|link_info
operator|.
name|s
operator|.
name|speed
condition|)
block|{
case|case
literal|10
case|:
name|ifm
operator|->
name|ifm_active
operator||=
name|IFM_10_T
expr_stmt|;
break|break;
case|case
literal|100
case|:
name|ifm
operator|->
name|ifm_active
operator||=
name|IFM_100_TX
expr_stmt|;
break|break;
case|case
literal|1000
case|:
name|ifm
operator|->
name|ifm_active
operator||=
name|IFM_1000_T
expr_stmt|;
break|break;
case|case
literal|10000
case|:
name|ifm
operator|->
name|ifm_active
operator||=
name|IFM_10G_T
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|link_info
operator|.
name|s
operator|.
name|full_duplex
condition|)
name|ifm
operator|->
name|ifm_active
operator||=
name|IFM_FDX
expr_stmt|;
else|else
name|ifm
operator|->
name|ifm_active
operator||=
name|IFM_HDX
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|octe_ioctl
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|u_long
name|cmd
parameter_list|,
name|caddr_t
name|data
parameter_list|)
block|{
name|cvm_oct_private_t
modifier|*
name|priv
decl_stmt|;
name|struct
name|mii_data
modifier|*
name|mii
decl_stmt|;
name|struct
name|ifreq
modifier|*
name|ifr
decl_stmt|;
ifdef|#
directive|ifdef
name|INET
name|struct
name|ifaddr
modifier|*
name|ifa
decl_stmt|;
endif|#
directive|endif
name|int
name|error
decl_stmt|;
name|priv
operator|=
name|ifp
operator|->
name|if_softc
expr_stmt|;
name|ifr
operator|=
operator|(
expr|struct
name|ifreq
operator|*
operator|)
name|data
expr_stmt|;
ifdef|#
directive|ifdef
name|INET
name|ifa
operator|=
operator|(
expr|struct
name|ifaddr
operator|*
operator|)
name|data
expr_stmt|;
endif|#
directive|endif
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|SIOCSIFADDR
case|:
ifdef|#
directive|ifdef
name|INET
comment|/* 		 * Avoid reinitialization unless it's necessary. 		 */
if|if
condition|(
name|ifa
operator|->
name|ifa_addr
operator|->
name|sa_family
operator|==
name|AF_INET
condition|)
block|{
name|ifp
operator|->
name|if_flags
operator||=
name|IFF_UP
expr_stmt|;
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
operator|==
literal|0
condition|)
name|octe_init
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|arp_ifinit
argument_list|(
name|ifp
argument_list|,
name|ifa
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
endif|#
directive|endif
name|error
operator|=
name|ether_ioctl
argument_list|(
name|ifp
argument_list|,
name|cmd
argument_list|,
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
case|case
name|SIOCSIFFLAGS
case|:
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|==
name|priv
operator|->
name|if_flags
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_UP
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
operator|==
literal|0
condition|)
name|octe_init
argument_list|(
name|priv
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
operator|!=
literal|0
condition|)
name|octe_stop
argument_list|(
name|priv
argument_list|)
expr_stmt|;
block|}
name|priv
operator|->
name|if_flags
operator|=
name|ifp
operator|->
name|if_flags
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
case|case
name|SIOCSIFCAP
case|:
comment|/* 		 * Just change the capabilities in software, currently none 		 * require reprogramming hardware, they just toggle whether we 		 * make use of already-present facilities in software. 		 */
name|ifp
operator|->
name|if_capenable
operator|=
name|ifr
operator|->
name|ifr_reqcap
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
case|case
name|SIOCSIFMTU
case|:
name|error
operator|=
name|cvm_oct_common_change_mtu
argument_list|(
name|ifp
argument_list|,
name|ifr
operator|->
name|ifr_mtu
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
case|case
name|SIOCSIFMEDIA
case|:
case|case
name|SIOCGIFMEDIA
case|:
if|if
condition|(
name|priv
operator|->
name|miibus
operator|!=
name|NULL
condition|)
block|{
name|mii
operator|=
name|device_get_softc
argument_list|(
name|priv
operator|->
name|miibus
argument_list|)
expr_stmt|;
name|error
operator|=
name|ifmedia_ioctl
argument_list|(
name|ifp
argument_list|,
name|ifr
argument_list|,
operator|&
name|mii
operator|->
name|mii_media
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|error
operator|=
name|ifmedia_ioctl
argument_list|(
name|ifp
argument_list|,
name|ifr
argument_list|,
operator|&
name|priv
operator|->
name|media
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
default|default:
name|error
operator|=
name|ether_ioctl
argument_list|(
name|ifp
argument_list|,
name|cmd
argument_list|,
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
end_function

end_unit


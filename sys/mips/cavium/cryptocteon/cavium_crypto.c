begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * vim:sw=4 ts=8  */
end_comment

begin_comment
comment|/*  * Copyright (c) 2009 David McCullough<david.mccullough@securecomputing.com>  *  * Copyright (c) 2003-2007 Cavium Networks (support@cavium.com). All rights  * reserved.  *   * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions are met:  * 1. Redistributions of source code must retain the above copyright notice,  * this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright notice,  * this list of conditions and the following disclaimer in the documentation  * and/or other materials provided with the distribution.  * 3. All advertising materials mentioning features or use of this software  * must display the following acknowledgement:  * This product includes software developed by Cavium Networks  * 4. Cavium Networks' name may not be used to endorse or promote products  * derived from this software without specific prior written permission.  *   * This Software, including technical data, may be subject to U.S. export  * control laws, including the U.S. Export Administration Act and its  * associated regulations, and may be subject to export or import regulations  * in other countries. You warrant that You will comply strictly in all  * respects with all such regulations and acknowledge that you have the  * responsibility to obtain licenses to export, re-export or import the  * Software.  *   * TO THE MAXIMUM EXTENT PERMITTED BY LAW, THE SOFTWARE IS PROVIDED "AS IS" AND  * WITH ALL FAULTS AND CAVIUM MAKES NO PROMISES, REPRESENTATIONS OR WARRANTIES,  * EITHER EXPRESS, IMPLIED, STATUTORY, OR OTHERWISE, WITH RESPECT TO THE  * SOFTWARE, INCLUDING ITS CONDITION, ITS CONFORMITY TO ANY REPRESENTATION OR  * DESCRIPTION, OR THE EXISTENCE OF ANY LATENT OR PATENT DEFECTS, AND CAVIUM  * SPECIFICALLY DISCLAIMS ALL IMPLIED (IF ANY) WARRANTIES OF TITLE,  * MERCHANTABILITY, NONINFRINGEMENT, FITNESS FOR A PARTICULAR PURPOSE, LACK OF  * VIRUSES, ACCURACY OR COMPLETENESS, QUIET ENJOYMENT, QUIET POSSESSION OR  * CORRESPONDENCE TO DESCRIPTION. THE ENTIRE RISK ARISING OUT OF USE OR  * PERFORMANCE OF THE SOFTWARE LIES WITH YOU. */
end_comment

begin_comment
comment|/****************************************************************************/
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/uio.h>
end_include

begin_include
include|#
directive|include
file|<opencrypto/cryptodev.h>
end_include

begin_include
include|#
directive|include
file|<contrib/octeon-sdk/cvmx.h>
end_include

begin_include
include|#
directive|include
file|<mips/cavium/cryptocteon/cryptocteonvar.h>
end_include

begin_comment
comment|/****************************************************************************/
end_comment

begin_define
define|#
directive|define
name|IOV_INIT
parameter_list|(
name|iov
parameter_list|,
name|ptr
parameter_list|,
name|idx
parameter_list|,
name|len
parameter_list|)
define|\
value|do {								\ 	    (idx) = 0;							\ 	    (ptr) = (iov)[(idx)].iov_base;				\ 	    (len) = (iov)[(idx)].iov_len;				\ 	} while (0)
end_define

begin_comment
comment|/*  * XXX  * It would be better if this were an IOV_READ/IOV_WRITE macro instead so  * that we could detect overflow before it happens rather than right after,  * which is especially bad since there is usually no IOV_CONSUME after the  * final read or write.  */
end_comment

begin_define
define|#
directive|define
name|IOV_CONSUME
parameter_list|(
name|iov
parameter_list|,
name|ptr
parameter_list|,
name|idx
parameter_list|,
name|len
parameter_list|)
define|\
value|do {								\ 	    if ((len)> sizeof *(ptr)) {				\ 		(len) -= sizeof *(ptr);					\ 		(ptr)++;						\ 	    } else {							\ 		if ((len) != sizeof *(ptr))				\ 			panic("%s: went past end of iovec.", __func__);	\ 		(idx)++;						\ 		(ptr) = (iov)[(idx)].iov_base;				\ 		(len) = (iov)[(idx)].iov_len;				\ 	    }								\ 	} while (0)
end_define

begin_function
specifier|static
specifier|inline
name|unsigned
name|long
name|octeon_crypto_enable
parameter_list|(
name|void
parameter_list|)
block|{
name|register_t
name|s
decl_stmt|;
name|s
operator|=
name|intr_disable
argument_list|()
expr_stmt|;
name|mips_wr_status
argument_list|(
name|mips_rd_status
argument_list|()
operator||
name|MIPS_SR_COP_2_BIT
argument_list|)
expr_stmt|;
return|return
operator|(
name|s
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|octeon_crypto_disable
parameter_list|(
name|register_t
name|s
parameter_list|)
block|{
name|mips_wr_status
argument_list|(
name|mips_rd_status
argument_list|()
operator|&
operator|~
name|MIPS_SR_COP_2_BIT
argument_list|)
expr_stmt|;
name|intr_restore
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_function

begin_define
define|#
directive|define
name|ESP_HEADER_LENGTH
value|8
end_define

begin_define
define|#
directive|define
name|DES_CBC_IV_LENGTH
value|8
end_define

begin_define
define|#
directive|define
name|AES_CBC_IV_LENGTH
value|16
end_define

begin_define
define|#
directive|define
name|ESP_HMAC_LEN
value|12
end_define

begin_define
define|#
directive|define
name|ESP_HEADER_LENGTH
value|8
end_define

begin_define
define|#
directive|define
name|DES_CBC_IV_LENGTH
value|8
end_define

begin_comment
comment|/****************************************************************************/
end_comment

begin_define
define|#
directive|define
name|CVM_LOAD_SHA_UNIT
parameter_list|(
name|dat
parameter_list|,
name|next
parameter_list|)
value|{ \    if (next == 0) {                     \       next = 1;                         \       CVMX_MT_HSH_DAT (dat, 0);         \    } else if (next == 1) {              \       next = 2;                         \       CVMX_MT_HSH_DAT (dat, 1);         \    } else if (next == 2) {              \       next = 3;                    \       CVMX_MT_HSH_DAT (dat, 2);         \    } else if (next == 3) {              \       next = 4;                         \       CVMX_MT_HSH_DAT (dat, 3);         \    } else if (next == 4) {              \       next = 5;                           \       CVMX_MT_HSH_DAT (dat, 4);         \    } else if (next == 5) {              \       next = 6;                         \       CVMX_MT_HSH_DAT (dat, 5);         \    } else if (next == 6) {              \       next = 7;                         \       CVMX_MT_HSH_DAT (dat, 6);         \    } else {                             \      CVMX_MT_HSH_STARTSHA (dat);        \      next = 0;                          \    }                                    \ }
end_define

begin_define
define|#
directive|define
name|CVM_LOAD2_SHA_UNIT
parameter_list|(
name|dat1
parameter_list|,
name|dat2
parameter_list|,
name|next
parameter_list|)
value|{ \    if (next == 0) {                      \       CVMX_MT_HSH_DAT (dat1, 0);         \       CVMX_MT_HSH_DAT (dat2, 1);         \       next = 2;                          \    } else if (next == 1) {               \       CVMX_MT_HSH_DAT (dat1, 1);         \       CVMX_MT_HSH_DAT (dat2, 2);         \       next = 3;                          \    } else if (next == 2) {               \       CVMX_MT_HSH_DAT (dat1, 2);         \       CVMX_MT_HSH_DAT (dat2, 3);         \       next = 4;                          \    } else if (next == 3) {               \       CVMX_MT_HSH_DAT (dat1, 3);         \       CVMX_MT_HSH_DAT (dat2, 4);         \       next = 5;                          \    } else if (next == 4) {               \       CVMX_MT_HSH_DAT (dat1, 4);         \       CVMX_MT_HSH_DAT (dat2, 5);         \       next = 6;                          \    } else if (next == 5) {               \       CVMX_MT_HSH_DAT (dat1, 5);         \       CVMX_MT_HSH_DAT (dat2, 6);         \       next = 7;                          \    } else if (next == 6) {               \       CVMX_MT_HSH_DAT (dat1, 6);         \       CVMX_MT_HSH_STARTSHA (dat2);       \       next = 0;                          \    } else {                              \      CVMX_MT_HSH_STARTSHA (dat1);        \      CVMX_MT_HSH_DAT (dat2, 0);          \      next = 1;                           \    }                                     \ }
end_define

begin_comment
comment|/****************************************************************************/
end_comment

begin_define
define|#
directive|define
name|CVM_LOAD_MD5_UNIT
parameter_list|(
name|dat
parameter_list|,
name|next
parameter_list|)
value|{ \    if (next == 0) {                     \       next = 1;                         \       CVMX_MT_HSH_DAT (dat, 0);         \    } else if (next == 1) {              \       next = 2;                         \       CVMX_MT_HSH_DAT (dat, 1);         \    } else if (next == 2) {              \       next = 3;                    \       CVMX_MT_HSH_DAT (dat, 2);         \    } else if (next == 3) {              \       next = 4;                         \       CVMX_MT_HSH_DAT (dat, 3);         \    } else if (next == 4) {              \       next = 5;                           \       CVMX_MT_HSH_DAT (dat, 4);         \    } else if (next == 5) {              \       next = 6;                         \       CVMX_MT_HSH_DAT (dat, 5);         \    } else if (next == 6) {              \       next = 7;                         \       CVMX_MT_HSH_DAT (dat, 6);         \    } else {                             \      CVMX_MT_HSH_STARTMD5 (dat);        \      next = 0;                          \    }                                    \ }
end_define

begin_define
define|#
directive|define
name|CVM_LOAD2_MD5_UNIT
parameter_list|(
name|dat1
parameter_list|,
name|dat2
parameter_list|,
name|next
parameter_list|)
value|{ \    if (next == 0) {                      \       CVMX_MT_HSH_DAT (dat1, 0);         \       CVMX_MT_HSH_DAT (dat2, 1);         \       next = 2;                          \    } else if (next == 1) {               \       CVMX_MT_HSH_DAT (dat1, 1);         \       CVMX_MT_HSH_DAT (dat2, 2);         \       next = 3;                          \    } else if (next == 2) {               \       CVMX_MT_HSH_DAT (dat1, 2);         \       CVMX_MT_HSH_DAT (dat2, 3);         \       next = 4;                          \    } else if (next == 3) {               \       CVMX_MT_HSH_DAT (dat1, 3);         \       CVMX_MT_HSH_DAT (dat2, 4);         \       next = 5;                          \    } else if (next == 4) {               \       CVMX_MT_HSH_DAT (dat1, 4);         \       CVMX_MT_HSH_DAT (dat2, 5);         \       next = 6;                          \    } else if (next == 5) {               \       CVMX_MT_HSH_DAT (dat1, 5);         \       CVMX_MT_HSH_DAT (dat2, 6);         \       next = 7;                          \    } else if (next == 6) {               \       CVMX_MT_HSH_DAT (dat1, 6);         \       CVMX_MT_HSH_STARTMD5 (dat2);       \       next = 0;                          \    } else {                              \      CVMX_MT_HSH_STARTMD5 (dat1);        \      CVMX_MT_HSH_DAT (dat2, 0);          \      next = 1;                           \    }                                     \ }
end_define

begin_comment
comment|/****************************************************************************/
end_comment

begin_function
name|void
name|octo_calc_hash
parameter_list|(
name|uint8_t
name|auth
parameter_list|,
name|unsigned
name|char
modifier|*
name|key
parameter_list|,
name|uint64_t
modifier|*
name|inner
parameter_list|,
name|uint64_t
modifier|*
name|outer
parameter_list|)
block|{
name|uint8_t
name|hash_key
index|[
literal|64
index|]
decl_stmt|;
name|uint64_t
modifier|*
name|key1
decl_stmt|;
specifier|register
name|uint64_t
name|xor1
init|=
literal|0x3636363636363636ULL
decl_stmt|;
specifier|register
name|uint64_t
name|xor2
init|=
literal|0x5c5c5c5c5c5c5c5cULL
decl_stmt|;
name|register_t
name|s
decl_stmt|;
name|dprintf
argument_list|(
literal|"%s()\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|hash_key
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|hash_key
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|hash_key
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
name|key
argument_list|,
operator|(
name|auth
condition|?
literal|20
else|:
literal|16
operator|)
argument_list|)
expr_stmt|;
name|key1
operator|=
operator|(
name|uint64_t
operator|*
operator|)
name|hash_key
expr_stmt|;
name|s
operator|=
name|octeon_crypto_enable
argument_list|()
expr_stmt|;
if|if
condition|(
name|auth
condition|)
block|{
name|CVMX_MT_HSH_IV
argument_list|(
literal|0x67452301EFCDAB89ULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_IV
argument_list|(
literal|0x98BADCFE10325476ULL
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_IV
argument_list|(
literal|0xC3D2E1F000000000ULL
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|CVMX_MT_HSH_IV
argument_list|(
literal|0x0123456789ABCDEFULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_IV
argument_list|(
literal|0xFEDCBA9876543210ULL
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|CVMX_MT_HSH_DAT
argument_list|(
operator|(
operator|*
name|key1
operator|^
name|xor1
operator|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|key1
operator|++
expr_stmt|;
name|CVMX_MT_HSH_DAT
argument_list|(
operator|(
operator|*
name|key1
operator|^
name|xor1
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|key1
operator|++
expr_stmt|;
name|CVMX_MT_HSH_DAT
argument_list|(
operator|(
operator|*
name|key1
operator|^
name|xor1
operator|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|key1
operator|++
expr_stmt|;
name|CVMX_MT_HSH_DAT
argument_list|(
operator|(
operator|*
name|key1
operator|^
name|xor1
operator|)
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|key1
operator|++
expr_stmt|;
name|CVMX_MT_HSH_DAT
argument_list|(
operator|(
operator|*
name|key1
operator|^
name|xor1
operator|)
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|key1
operator|++
expr_stmt|;
name|CVMX_MT_HSH_DAT
argument_list|(
operator|(
operator|*
name|key1
operator|^
name|xor1
operator|)
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|key1
operator|++
expr_stmt|;
name|CVMX_MT_HSH_DAT
argument_list|(
operator|(
operator|*
name|key1
operator|^
name|xor1
operator|)
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|key1
operator|++
expr_stmt|;
if|if
condition|(
name|auth
condition|)
name|CVMX_MT_HSH_STARTSHA
argument_list|(
operator|(
operator|*
name|key1
operator|^
name|xor1
operator|)
argument_list|)
expr_stmt|;
else|else
name|CVMX_MT_HSH_STARTMD5
argument_list|(
operator|(
operator|*
name|key1
operator|^
name|xor1
operator|)
argument_list|)
expr_stmt|;
name|CVMX_MF_HSH_IV
argument_list|(
name|inner
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MF_HSH_IV
argument_list|(
name|inner
index|[
literal|1
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|auth
condition|)
block|{
name|inner
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|CVMX_MF_HSH_IV
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|inner
operator|)
index|[
literal|2
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
name|memset
argument_list|(
name|hash_key
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|hash_key
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|hash_key
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
name|key
argument_list|,
operator|(
name|auth
condition|?
literal|20
else|:
literal|16
operator|)
argument_list|)
expr_stmt|;
name|key1
operator|=
operator|(
name|uint64_t
operator|*
operator|)
name|hash_key
expr_stmt|;
if|if
condition|(
name|auth
condition|)
block|{
name|CVMX_MT_HSH_IV
argument_list|(
literal|0x67452301EFCDAB89ULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_IV
argument_list|(
literal|0x98BADCFE10325476ULL
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_IV
argument_list|(
literal|0xC3D2E1F000000000ULL
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|CVMX_MT_HSH_IV
argument_list|(
literal|0x0123456789ABCDEFULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_IV
argument_list|(
literal|0xFEDCBA9876543210ULL
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|CVMX_MT_HSH_DAT
argument_list|(
operator|(
operator|*
name|key1
operator|^
name|xor2
operator|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|key1
operator|++
expr_stmt|;
name|CVMX_MT_HSH_DAT
argument_list|(
operator|(
operator|*
name|key1
operator|^
name|xor2
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|key1
operator|++
expr_stmt|;
name|CVMX_MT_HSH_DAT
argument_list|(
operator|(
operator|*
name|key1
operator|^
name|xor2
operator|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|key1
operator|++
expr_stmt|;
name|CVMX_MT_HSH_DAT
argument_list|(
operator|(
operator|*
name|key1
operator|^
name|xor2
operator|)
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|key1
operator|++
expr_stmt|;
name|CVMX_MT_HSH_DAT
argument_list|(
operator|(
operator|*
name|key1
operator|^
name|xor2
operator|)
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|key1
operator|++
expr_stmt|;
name|CVMX_MT_HSH_DAT
argument_list|(
operator|(
operator|*
name|key1
operator|^
name|xor2
operator|)
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|key1
operator|++
expr_stmt|;
name|CVMX_MT_HSH_DAT
argument_list|(
operator|(
operator|*
name|key1
operator|^
name|xor2
operator|)
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|key1
operator|++
expr_stmt|;
if|if
condition|(
name|auth
condition|)
name|CVMX_MT_HSH_STARTSHA
argument_list|(
operator|(
operator|*
name|key1
operator|^
name|xor2
operator|)
argument_list|)
expr_stmt|;
else|else
name|CVMX_MT_HSH_STARTMD5
argument_list|(
operator|(
operator|*
name|key1
operator|^
name|xor2
operator|)
argument_list|)
expr_stmt|;
name|CVMX_MF_HSH_IV
argument_list|(
name|outer
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MF_HSH_IV
argument_list|(
name|outer
index|[
literal|1
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|auth
condition|)
block|{
name|outer
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|CVMX_MF_HSH_IV
argument_list|(
name|outer
index|[
literal|2
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
name|octeon_crypto_disable
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/****************************************************************************/
end_comment

begin_comment
comment|/* DES functions */
end_comment

begin_function
name|int
name|octo_des_cbc_encrypt
parameter_list|(
name|struct
name|octo_sess
modifier|*
name|od
parameter_list|,
name|struct
name|iovec
modifier|*
name|iov
parameter_list|,
name|size_t
name|iovcnt
parameter_list|,
name|size_t
name|iovlen
parameter_list|,
name|int
name|auth_off
parameter_list|,
name|int
name|auth_len
parameter_list|,
name|int
name|crypt_off
parameter_list|,
name|int
name|crypt_len
parameter_list|,
name|int
name|icv_off
parameter_list|,
name|uint8_t
modifier|*
name|ivp
parameter_list|)
block|{
name|uint64_t
modifier|*
name|data
decl_stmt|;
name|int
name|data_i
decl_stmt|,
name|data_l
decl_stmt|;
name|register_t
name|s
decl_stmt|;
name|dprintf
argument_list|(
literal|"%s()\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
name|__predict_false
argument_list|(
name|od
operator|==
name|NULL
operator|||
name|iov
operator|==
name|NULL
operator|||
name|iovlen
operator|==
literal|0
operator|||
name|ivp
operator|==
name|NULL
operator|||
operator|(
name|crypt_off
operator|&
literal|0x7
operator|)
operator|||
operator|(
name|crypt_off
operator|+
name|crypt_len
operator|>
name|iovlen
operator|)
argument_list|)
condition|)
block|{
name|dprintf
argument_list|(
literal|"%s: Bad parameters od=%p iov=%p iovlen=%jd "
literal|"auth_off=%d auth_len=%d crypt_off=%d crypt_len=%d "
literal|"icv_off=%d ivp=%p\n"
argument_list|,
name|__func__
argument_list|,
name|od
argument_list|,
name|iov
argument_list|,
name|iovlen
argument_list|,
name|auth_off
argument_list|,
name|auth_len
argument_list|,
name|crypt_off
argument_list|,
name|crypt_len
argument_list|,
name|icv_off
argument_list|,
name|ivp
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|IOV_INIT
argument_list|(
name|iov
argument_list|,
name|data
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|CVMX_PREFETCH0
argument_list|(
name|ivp
argument_list|)
expr_stmt|;
name|CVMX_PREFETCH0
argument_list|(
name|od
operator|->
name|octo_enckey
argument_list|)
expr_stmt|;
name|s
operator|=
name|octeon_crypto_enable
argument_list|()
expr_stmt|;
comment|/* load 3DES Key */
name|CVMX_MT_3DES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|od
operator|->
name|octo_encklen
operator|==
literal|24
condition|)
block|{
name|CVMX_MT_3DES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|1
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|CVMX_MT_3DES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|2
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|od
operator|->
name|octo_encklen
operator|==
literal|8
condition|)
block|{
name|CVMX_MT_3DES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|0
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|CVMX_MT_3DES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|0
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|octeon_crypto_disable
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|dprintf
argument_list|(
literal|"%s: Bad key length %d\n"
argument_list|,
name|__func__
argument_list|,
name|od
operator|->
name|octo_encklen
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|CVMX_MT_3DES_IV
argument_list|(
operator|*
operator|(
name|uint64_t
operator|*
operator|)
name|ivp
argument_list|)
expr_stmt|;
while|while
condition|(
name|crypt_off
operator|>
literal|0
condition|)
block|{
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|crypt_off
operator|-=
literal|8
expr_stmt|;
block|}
while|while
condition|(
name|crypt_len
operator|>
literal|0
condition|)
block|{
name|CVMX_MT_3DES_ENC_CBC
argument_list|(
operator|*
name|data
argument_list|)
expr_stmt|;
name|CVMX_MF_3DES_RESULT
argument_list|(
operator|*
name|data
argument_list|)
expr_stmt|;
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|crypt_len
operator|-=
literal|8
expr_stmt|;
block|}
name|octeon_crypto_disable
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|octo_des_cbc_decrypt
parameter_list|(
name|struct
name|octo_sess
modifier|*
name|od
parameter_list|,
name|struct
name|iovec
modifier|*
name|iov
parameter_list|,
name|size_t
name|iovcnt
parameter_list|,
name|size_t
name|iovlen
parameter_list|,
name|int
name|auth_off
parameter_list|,
name|int
name|auth_len
parameter_list|,
name|int
name|crypt_off
parameter_list|,
name|int
name|crypt_len
parameter_list|,
name|int
name|icv_off
parameter_list|,
name|uint8_t
modifier|*
name|ivp
parameter_list|)
block|{
name|uint64_t
modifier|*
name|data
decl_stmt|;
name|int
name|data_i
decl_stmt|,
name|data_l
decl_stmt|;
name|register_t
name|s
decl_stmt|;
name|dprintf
argument_list|(
literal|"%s()\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
name|__predict_false
argument_list|(
name|od
operator|==
name|NULL
operator|||
name|iov
operator|==
name|NULL
operator|||
name|iovlen
operator|==
literal|0
operator|||
name|ivp
operator|==
name|NULL
operator|||
operator|(
name|crypt_off
operator|&
literal|0x7
operator|)
operator|||
operator|(
name|crypt_off
operator|+
name|crypt_len
operator|>
name|iovlen
operator|)
argument_list|)
condition|)
block|{
name|dprintf
argument_list|(
literal|"%s: Bad parameters od=%p iov=%p iovlen=%jd "
literal|"auth_off=%d auth_len=%d crypt_off=%d crypt_len=%d "
literal|"icv_off=%d ivp=%p\n"
argument_list|,
name|__func__
argument_list|,
name|od
argument_list|,
name|iov
argument_list|,
name|iovlen
argument_list|,
name|auth_off
argument_list|,
name|auth_len
argument_list|,
name|crypt_off
argument_list|,
name|crypt_len
argument_list|,
name|icv_off
argument_list|,
name|ivp
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|IOV_INIT
argument_list|(
name|iov
argument_list|,
name|data
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|CVMX_PREFETCH0
argument_list|(
name|ivp
argument_list|)
expr_stmt|;
name|CVMX_PREFETCH0
argument_list|(
name|od
operator|->
name|octo_enckey
argument_list|)
expr_stmt|;
name|s
operator|=
name|octeon_crypto_enable
argument_list|()
expr_stmt|;
comment|/* load 3DES Key */
name|CVMX_MT_3DES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|od
operator|->
name|octo_encklen
operator|==
literal|24
condition|)
block|{
name|CVMX_MT_3DES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|1
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|CVMX_MT_3DES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|2
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|od
operator|->
name|octo_encklen
operator|==
literal|8
condition|)
block|{
name|CVMX_MT_3DES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|0
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|CVMX_MT_3DES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|0
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|octeon_crypto_disable
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|dprintf
argument_list|(
literal|"%s: Bad key length %d\n"
argument_list|,
name|__func__
argument_list|,
name|od
operator|->
name|octo_encklen
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|CVMX_MT_3DES_IV
argument_list|(
operator|*
operator|(
name|uint64_t
operator|*
operator|)
name|ivp
argument_list|)
expr_stmt|;
while|while
condition|(
name|crypt_off
operator|>
literal|0
condition|)
block|{
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|crypt_off
operator|-=
literal|8
expr_stmt|;
block|}
while|while
condition|(
name|crypt_len
operator|>
literal|0
condition|)
block|{
name|CVMX_MT_3DES_DEC_CBC
argument_list|(
operator|*
name|data
argument_list|)
expr_stmt|;
name|CVMX_MF_3DES_RESULT
argument_list|(
operator|*
name|data
argument_list|)
expr_stmt|;
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|crypt_len
operator|-=
literal|8
expr_stmt|;
block|}
name|octeon_crypto_disable
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/****************************************************************************/
end_comment

begin_comment
comment|/* AES functions */
end_comment

begin_function
name|int
name|octo_aes_cbc_encrypt
parameter_list|(
name|struct
name|octo_sess
modifier|*
name|od
parameter_list|,
name|struct
name|iovec
modifier|*
name|iov
parameter_list|,
name|size_t
name|iovcnt
parameter_list|,
name|size_t
name|iovlen
parameter_list|,
name|int
name|auth_off
parameter_list|,
name|int
name|auth_len
parameter_list|,
name|int
name|crypt_off
parameter_list|,
name|int
name|crypt_len
parameter_list|,
name|int
name|icv_off
parameter_list|,
name|uint8_t
modifier|*
name|ivp
parameter_list|)
block|{
name|uint64_t
modifier|*
name|data
decl_stmt|,
modifier|*
name|pdata
decl_stmt|;
name|int
name|data_i
decl_stmt|,
name|data_l
decl_stmt|;
name|register_t
name|s
decl_stmt|;
name|dprintf
argument_list|(
literal|"%s()\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
name|__predict_false
argument_list|(
name|od
operator|==
name|NULL
operator|||
name|iov
operator|==
name|NULL
operator|||
name|iovlen
operator|==
literal|0
operator|||
name|ivp
operator|==
name|NULL
operator|||
operator|(
name|crypt_off
operator|&
literal|0x7
operator|)
operator|||
operator|(
name|crypt_off
operator|+
name|crypt_len
operator|>
name|iovlen
operator|)
argument_list|)
condition|)
block|{
name|dprintf
argument_list|(
literal|"%s: Bad parameters od=%p iov=%p iovlen=%jd "
literal|"auth_off=%d auth_len=%d crypt_off=%d crypt_len=%d "
literal|"icv_off=%d ivp=%p\n"
argument_list|,
name|__func__
argument_list|,
name|od
argument_list|,
name|iov
argument_list|,
name|iovlen
argument_list|,
name|auth_off
argument_list|,
name|auth_len
argument_list|,
name|crypt_off
argument_list|,
name|crypt_len
argument_list|,
name|icv_off
argument_list|,
name|ivp
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|IOV_INIT
argument_list|(
name|iov
argument_list|,
name|data
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|CVMX_PREFETCH0
argument_list|(
name|ivp
argument_list|)
expr_stmt|;
name|CVMX_PREFETCH0
argument_list|(
name|od
operator|->
name|octo_enckey
argument_list|)
expr_stmt|;
name|s
operator|=
name|octeon_crypto_enable
argument_list|()
expr_stmt|;
comment|/* load AES Key */
name|CVMX_MT_AES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MT_AES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|1
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|od
operator|->
name|octo_encklen
operator|==
literal|16
condition|)
block|{
name|CVMX_MT_AES_KEY
argument_list|(
literal|0x0
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|CVMX_MT_AES_KEY
argument_list|(
literal|0x0
argument_list|,
literal|3
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|od
operator|->
name|octo_encklen
operator|==
literal|24
condition|)
block|{
name|CVMX_MT_AES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|2
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|CVMX_MT_AES_KEY
argument_list|(
literal|0x0
argument_list|,
literal|3
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|od
operator|->
name|octo_encklen
operator|==
literal|32
condition|)
block|{
name|CVMX_MT_AES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|2
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|CVMX_MT_AES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|3
index|]
argument_list|,
literal|3
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|octeon_crypto_disable
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|dprintf
argument_list|(
literal|"%s: Bad key length %d\n"
argument_list|,
name|__func__
argument_list|,
name|od
operator|->
name|octo_encklen
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|CVMX_MT_AES_KEYLENGTH
argument_list|(
name|od
operator|->
name|octo_encklen
operator|/
literal|8
operator|-
literal|1
argument_list|)
expr_stmt|;
name|CVMX_MT_AES_IV
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|ivp
operator|)
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MT_AES_IV
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|ivp
operator|)
index|[
literal|1
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
while|while
condition|(
name|crypt_off
operator|>
literal|0
condition|)
block|{
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|crypt_off
operator|-=
literal|8
expr_stmt|;
block|}
while|while
condition|(
name|crypt_len
operator|>
literal|0
condition|)
block|{
name|pdata
operator|=
name|data
expr_stmt|;
name|CVMX_MT_AES_ENC_CBC0
argument_list|(
operator|*
name|data
argument_list|)
expr_stmt|;
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|CVMX_MT_AES_ENC_CBC1
argument_list|(
operator|*
name|data
argument_list|)
expr_stmt|;
name|CVMX_MF_AES_RESULT
argument_list|(
operator|*
name|pdata
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MF_AES_RESULT
argument_list|(
operator|*
name|data
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|crypt_len
operator|-=
literal|16
expr_stmt|;
block|}
name|octeon_crypto_disable
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|octo_aes_cbc_decrypt
parameter_list|(
name|struct
name|octo_sess
modifier|*
name|od
parameter_list|,
name|struct
name|iovec
modifier|*
name|iov
parameter_list|,
name|size_t
name|iovcnt
parameter_list|,
name|size_t
name|iovlen
parameter_list|,
name|int
name|auth_off
parameter_list|,
name|int
name|auth_len
parameter_list|,
name|int
name|crypt_off
parameter_list|,
name|int
name|crypt_len
parameter_list|,
name|int
name|icv_off
parameter_list|,
name|uint8_t
modifier|*
name|ivp
parameter_list|)
block|{
name|uint64_t
modifier|*
name|data
decl_stmt|,
modifier|*
name|pdata
decl_stmt|;
name|int
name|data_i
decl_stmt|,
name|data_l
decl_stmt|;
name|register_t
name|s
decl_stmt|;
name|dprintf
argument_list|(
literal|"%s()\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
name|__predict_false
argument_list|(
name|od
operator|==
name|NULL
operator|||
name|iov
operator|==
name|NULL
operator|||
name|iovlen
operator|==
literal|0
operator|||
name|ivp
operator|==
name|NULL
operator|||
operator|(
name|crypt_off
operator|&
literal|0x7
operator|)
operator|||
operator|(
name|crypt_off
operator|+
name|crypt_len
operator|>
name|iovlen
operator|)
argument_list|)
condition|)
block|{
name|dprintf
argument_list|(
literal|"%s: Bad parameters od=%p iov=%p iovlen=%jd "
literal|"auth_off=%d auth_len=%d crypt_off=%d crypt_len=%d "
literal|"icv_off=%d ivp=%p\n"
argument_list|,
name|__func__
argument_list|,
name|od
argument_list|,
name|iov
argument_list|,
name|iovlen
argument_list|,
name|auth_off
argument_list|,
name|auth_len
argument_list|,
name|crypt_off
argument_list|,
name|crypt_len
argument_list|,
name|icv_off
argument_list|,
name|ivp
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|IOV_INIT
argument_list|(
name|iov
argument_list|,
name|data
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|CVMX_PREFETCH0
argument_list|(
name|ivp
argument_list|)
expr_stmt|;
name|CVMX_PREFETCH0
argument_list|(
name|od
operator|->
name|octo_enckey
argument_list|)
expr_stmt|;
name|s
operator|=
name|octeon_crypto_enable
argument_list|()
expr_stmt|;
comment|/* load AES Key */
name|CVMX_MT_AES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MT_AES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|1
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|od
operator|->
name|octo_encklen
operator|==
literal|16
condition|)
block|{
name|CVMX_MT_AES_KEY
argument_list|(
literal|0x0
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|CVMX_MT_AES_KEY
argument_list|(
literal|0x0
argument_list|,
literal|3
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|od
operator|->
name|octo_encklen
operator|==
literal|24
condition|)
block|{
name|CVMX_MT_AES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|2
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|CVMX_MT_AES_KEY
argument_list|(
literal|0x0
argument_list|,
literal|3
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|od
operator|->
name|octo_encklen
operator|==
literal|32
condition|)
block|{
name|CVMX_MT_AES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|2
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|CVMX_MT_AES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|3
index|]
argument_list|,
literal|3
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|octeon_crypto_disable
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|dprintf
argument_list|(
literal|"%s: Bad key length %d\n"
argument_list|,
name|__func__
argument_list|,
name|od
operator|->
name|octo_encklen
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|CVMX_MT_AES_KEYLENGTH
argument_list|(
name|od
operator|->
name|octo_encklen
operator|/
literal|8
operator|-
literal|1
argument_list|)
expr_stmt|;
name|CVMX_MT_AES_IV
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|ivp
operator|)
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MT_AES_IV
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|ivp
operator|)
index|[
literal|1
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
while|while
condition|(
name|crypt_off
operator|>
literal|0
condition|)
block|{
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|crypt_off
operator|-=
literal|8
expr_stmt|;
block|}
while|while
condition|(
name|crypt_len
operator|>
literal|0
condition|)
block|{
name|pdata
operator|=
name|data
expr_stmt|;
name|CVMX_MT_AES_DEC_CBC0
argument_list|(
operator|*
name|data
argument_list|)
expr_stmt|;
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|CVMX_MT_AES_DEC_CBC1
argument_list|(
operator|*
name|data
argument_list|)
expr_stmt|;
name|CVMX_MF_AES_RESULT
argument_list|(
operator|*
name|pdata
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MF_AES_RESULT
argument_list|(
operator|*
name|data
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|crypt_len
operator|-=
literal|16
expr_stmt|;
block|}
name|octeon_crypto_disable
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/****************************************************************************/
end_comment

begin_comment
comment|/* MD5 */
end_comment

begin_function
name|int
name|octo_null_md5_encrypt
parameter_list|(
name|struct
name|octo_sess
modifier|*
name|od
parameter_list|,
name|struct
name|iovec
modifier|*
name|iov
parameter_list|,
name|size_t
name|iovcnt
parameter_list|,
name|size_t
name|iovlen
parameter_list|,
name|int
name|auth_off
parameter_list|,
name|int
name|auth_len
parameter_list|,
name|int
name|crypt_off
parameter_list|,
name|int
name|crypt_len
parameter_list|,
name|int
name|icv_off
parameter_list|,
name|uint8_t
modifier|*
name|ivp
parameter_list|)
block|{
specifier|register
name|int
name|next
init|=
literal|0
decl_stmt|;
name|uint64_t
modifier|*
name|data
decl_stmt|;
name|uint64_t
name|tmp1
decl_stmt|,
name|tmp2
decl_stmt|;
name|int
name|data_i
decl_stmt|,
name|data_l
decl_stmt|,
name|alen
init|=
name|auth_len
decl_stmt|;
name|register_t
name|s
decl_stmt|;
name|dprintf
argument_list|(
literal|"%s()\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
name|__predict_false
argument_list|(
name|od
operator|==
name|NULL
operator|||
name|iov
operator|==
name|NULL
operator|||
name|iovlen
operator|==
literal|0
operator|||
operator|(
name|auth_off
operator|&
literal|0x7
operator|)
operator|||
operator|(
name|auth_off
operator|+
name|auth_len
operator|>
name|iovlen
operator|)
argument_list|)
condition|)
block|{
name|dprintf
argument_list|(
literal|"%s: Bad parameters od=%p iov=%p iovlen=%jd "
literal|"auth_off=%d auth_len=%d crypt_off=%d crypt_len=%d "
literal|"icv_off=%d ivp=%p\n"
argument_list|,
name|__func__
argument_list|,
name|od
argument_list|,
name|iov
argument_list|,
name|iovlen
argument_list|,
name|auth_off
argument_list|,
name|auth_len
argument_list|,
name|crypt_off
argument_list|,
name|crypt_len
argument_list|,
name|icv_off
argument_list|,
name|ivp
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|IOV_INIT
argument_list|(
name|iov
argument_list|,
name|data
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|s
operator|=
name|octeon_crypto_enable
argument_list|()
expr_stmt|;
comment|/* Load MD5 IV */
name|CVMX_MT_HSH_IV
argument_list|(
name|od
operator|->
name|octo_hminner
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_IV
argument_list|(
name|od
operator|->
name|octo_hminner
index|[
literal|1
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
while|while
condition|(
name|auth_off
operator|>
literal|0
condition|)
block|{
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|auth_off
operator|-=
literal|8
expr_stmt|;
block|}
while|while
condition|(
name|auth_len
operator|>
literal|0
condition|)
block|{
name|CVM_LOAD_MD5_UNIT
argument_list|(
operator|*
name|data
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|auth_len
operator|-=
literal|8
expr_stmt|;
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
block|}
comment|/* finish the hash */
name|CVMX_PREFETCH0
argument_list|(
name|od
operator|->
name|octo_hmouter
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|if (__predict_false(inplen)) { 	uint64_t tmp = 0; 	uint8_t *p = (uint8_t *)& tmp; 	p[inplen] = 0x80; 	do { 	    inplen--; 	    p[inplen] = ((uint8_t *) data)[inplen]; 	} while (inplen); 	CVM_LOAD_MD5_UNIT(tmp, next);     } else { 	CVM_LOAD_MD5_UNIT(0x8000000000000000ULL, next);     }
else|#
directive|else
name|CVM_LOAD_MD5_UNIT
argument_list|(
literal|0x8000000000000000ULL
argument_list|,
name|next
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* Finish Inner hash */
while|while
condition|(
name|next
operator|!=
literal|7
condition|)
block|{
name|CVM_LOAD_MD5_UNIT
argument_list|(
operator|(
operator|(
name|uint64_t
operator|)
literal|0x0ULL
operator|)
argument_list|,
name|next
argument_list|)
expr_stmt|;
block|}
name|CVMX_ES64
argument_list|(
name|tmp1
argument_list|,
operator|(
operator|(
name|alen
operator|+
literal|64
operator|)
operator|<<
literal|3
operator|)
argument_list|)
expr_stmt|;
name|CVM_LOAD_MD5_UNIT
argument_list|(
name|tmp1
argument_list|,
name|next
argument_list|)
expr_stmt|;
comment|/* Get the inner hash of HMAC */
name|CVMX_MF_HSH_IV
argument_list|(
name|tmp1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MF_HSH_IV
argument_list|(
name|tmp2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* Initialize hash unit */
name|CVMX_MT_HSH_IV
argument_list|(
name|od
operator|->
name|octo_hmouter
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_IV
argument_list|(
name|od
operator|->
name|octo_hmouter
index|[
literal|1
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DAT
argument_list|(
name|tmp1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DAT
argument_list|(
name|tmp2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DAT
argument_list|(
literal|0x8000000000000000ULL
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DATZ
argument_list|(
literal|3
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DATZ
argument_list|(
literal|4
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DATZ
argument_list|(
literal|5
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DATZ
argument_list|(
literal|6
argument_list|)
expr_stmt|;
name|CVMX_ES64
argument_list|(
name|tmp1
argument_list|,
operator|(
operator|(
literal|64
operator|+
literal|16
operator|)
operator|<<
literal|3
operator|)
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_STARTMD5
argument_list|(
name|tmp1
argument_list|)
expr_stmt|;
comment|/* save the HMAC */
name|IOV_INIT
argument_list|(
name|iov
argument_list|,
name|data
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
while|while
condition|(
name|icv_off
operator|>
literal|0
condition|)
block|{
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|icv_off
operator|-=
literal|8
expr_stmt|;
block|}
name|CVMX_MF_HSH_IV
argument_list|(
operator|*
name|data
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|CVMX_MF_HSH_IV
argument_list|(
name|tmp1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
operator|*
operator|(
name|uint32_t
operator|*
operator|)
name|data
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|tmp1
operator|>>
literal|32
argument_list|)
expr_stmt|;
name|octeon_crypto_disable
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/****************************************************************************/
end_comment

begin_comment
comment|/* SHA1 */
end_comment

begin_function
name|int
name|octo_null_sha1_encrypt
parameter_list|(
name|struct
name|octo_sess
modifier|*
name|od
parameter_list|,
name|struct
name|iovec
modifier|*
name|iov
parameter_list|,
name|size_t
name|iovcnt
parameter_list|,
name|size_t
name|iovlen
parameter_list|,
name|int
name|auth_off
parameter_list|,
name|int
name|auth_len
parameter_list|,
name|int
name|crypt_off
parameter_list|,
name|int
name|crypt_len
parameter_list|,
name|int
name|icv_off
parameter_list|,
name|uint8_t
modifier|*
name|ivp
parameter_list|)
block|{
specifier|register
name|int
name|next
init|=
literal|0
decl_stmt|;
name|uint64_t
modifier|*
name|data
decl_stmt|;
name|uint64_t
name|tmp1
decl_stmt|,
name|tmp2
decl_stmt|,
name|tmp3
decl_stmt|;
name|int
name|data_i
decl_stmt|,
name|data_l
decl_stmt|,
name|alen
init|=
name|auth_len
decl_stmt|;
name|register_t
name|s
decl_stmt|;
name|dprintf
argument_list|(
literal|"%s()\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
name|__predict_false
argument_list|(
name|od
operator|==
name|NULL
operator|||
name|iov
operator|==
name|NULL
operator|||
name|iovlen
operator|==
literal|0
operator|||
operator|(
name|auth_off
operator|&
literal|0x7
operator|)
operator|||
operator|(
name|auth_off
operator|+
name|auth_len
operator|>
name|iovlen
operator|)
argument_list|)
condition|)
block|{
name|dprintf
argument_list|(
literal|"%s: Bad parameters od=%p iov=%p iovlen=%jd "
literal|"auth_off=%d auth_len=%d crypt_off=%d crypt_len=%d "
literal|"icv_off=%d ivp=%p\n"
argument_list|,
name|__func__
argument_list|,
name|od
argument_list|,
name|iov
argument_list|,
name|iovlen
argument_list|,
name|auth_off
argument_list|,
name|auth_len
argument_list|,
name|crypt_off
argument_list|,
name|crypt_len
argument_list|,
name|icv_off
argument_list|,
name|ivp
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|IOV_INIT
argument_list|(
name|iov
argument_list|,
name|data
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|s
operator|=
name|octeon_crypto_enable
argument_list|()
expr_stmt|;
comment|/* Load SHA1 IV */
name|CVMX_MT_HSH_IV
argument_list|(
name|od
operator|->
name|octo_hminner
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_IV
argument_list|(
name|od
operator|->
name|octo_hminner
index|[
literal|1
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_IV
argument_list|(
name|od
operator|->
name|octo_hminner
index|[
literal|2
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
while|while
condition|(
name|auth_off
operator|>
literal|0
condition|)
block|{
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|auth_off
operator|-=
literal|8
expr_stmt|;
block|}
while|while
condition|(
name|auth_len
operator|>
literal|0
condition|)
block|{
name|CVM_LOAD_SHA_UNIT
argument_list|(
operator|*
name|data
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|auth_len
operator|-=
literal|8
expr_stmt|;
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
block|}
comment|/* finish the hash */
name|CVMX_PREFETCH0
argument_list|(
name|od
operator|->
name|octo_hmouter
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|if (__predict_false(inplen)) { 	uint64_t tmp = 0; 	uint8_t *p = (uint8_t *)& tmp; 	p[inplen] = 0x80; 	do { 	    inplen--; 	    p[inplen] = ((uint8_t *) data)[inplen]; 	} while (inplen); 	CVM_LOAD_MD5_UNIT(tmp, next);     } else { 	CVM_LOAD_MD5_UNIT(0x8000000000000000ULL, next);     }
else|#
directive|else
name|CVM_LOAD_SHA_UNIT
argument_list|(
literal|0x8000000000000000ULL
argument_list|,
name|next
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* Finish Inner hash */
while|while
condition|(
name|next
operator|!=
literal|7
condition|)
block|{
name|CVM_LOAD_SHA_UNIT
argument_list|(
operator|(
operator|(
name|uint64_t
operator|)
literal|0x0ULL
operator|)
argument_list|,
name|next
argument_list|)
expr_stmt|;
block|}
name|CVM_LOAD_SHA_UNIT
argument_list|(
call|(
name|uint64_t
call|)
argument_list|(
operator|(
name|alen
operator|+
literal|64
operator|)
operator|<<
literal|3
argument_list|)
argument_list|,
name|next
argument_list|)
expr_stmt|;
comment|/* Get the inner hash of HMAC */
name|CVMX_MF_HSH_IV
argument_list|(
name|tmp1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MF_HSH_IV
argument_list|(
name|tmp2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|tmp3
operator|=
literal|0
expr_stmt|;
name|CVMX_MF_HSH_IV
argument_list|(
name|tmp3
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* Initialize hash unit */
name|CVMX_MT_HSH_IV
argument_list|(
name|od
operator|->
name|octo_hmouter
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_IV
argument_list|(
name|od
operator|->
name|octo_hmouter
index|[
literal|1
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_IV
argument_list|(
name|od
operator|->
name|octo_hmouter
index|[
literal|2
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DAT
argument_list|(
name|tmp1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DAT
argument_list|(
name|tmp2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|tmp3
operator||=
literal|0x0000000080000000
expr_stmt|;
name|CVMX_MT_HSH_DAT
argument_list|(
name|tmp3
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DATZ
argument_list|(
literal|3
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DATZ
argument_list|(
literal|4
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DATZ
argument_list|(
literal|5
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DATZ
argument_list|(
literal|6
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_STARTSHA
argument_list|(
call|(
name|uint64_t
call|)
argument_list|(
operator|(
literal|64
operator|+
literal|20
operator|)
operator|<<
literal|3
argument_list|)
argument_list|)
expr_stmt|;
comment|/* save the HMAC */
name|IOV_INIT
argument_list|(
name|iov
argument_list|,
name|data
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
while|while
condition|(
name|icv_off
operator|>
literal|0
condition|)
block|{
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|icv_off
operator|-=
literal|8
expr_stmt|;
block|}
name|CVMX_MF_HSH_IV
argument_list|(
operator|*
name|data
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|CVMX_MF_HSH_IV
argument_list|(
name|tmp1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
operator|*
operator|(
name|uint32_t
operator|*
operator|)
name|data
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|tmp1
operator|>>
literal|32
argument_list|)
expr_stmt|;
name|octeon_crypto_disable
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/****************************************************************************/
end_comment

begin_comment
comment|/* DES MD5 */
end_comment

begin_function
name|int
name|octo_des_cbc_md5_encrypt
parameter_list|(
name|struct
name|octo_sess
modifier|*
name|od
parameter_list|,
name|struct
name|iovec
modifier|*
name|iov
parameter_list|,
name|size_t
name|iovcnt
parameter_list|,
name|size_t
name|iovlen
parameter_list|,
name|int
name|auth_off
parameter_list|,
name|int
name|auth_len
parameter_list|,
name|int
name|crypt_off
parameter_list|,
name|int
name|crypt_len
parameter_list|,
name|int
name|icv_off
parameter_list|,
name|uint8_t
modifier|*
name|ivp
parameter_list|)
block|{
specifier|register
name|int
name|next
init|=
literal|0
decl_stmt|;
union|union
block|{
name|uint32_t
name|data32
index|[
literal|2
index|]
decl_stmt|;
name|uint64_t
name|data64
index|[
literal|1
index|]
decl_stmt|;
block|}
name|mydata
union|;
name|uint64_t
modifier|*
name|data
init|=
operator|&
name|mydata
operator|.
name|data64
index|[
literal|0
index|]
decl_stmt|;
name|uint32_t
modifier|*
name|data32
decl_stmt|;
name|uint64_t
name|tmp1
decl_stmt|,
name|tmp2
decl_stmt|;
name|int
name|data_i
decl_stmt|,
name|data_l
decl_stmt|,
name|alen
init|=
name|auth_len
decl_stmt|;
name|register_t
name|s
decl_stmt|;
name|dprintf
argument_list|(
literal|"%s()\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
name|__predict_false
argument_list|(
name|od
operator|==
name|NULL
operator|||
name|iov
operator|==
name|NULL
operator|||
name|iovlen
operator|==
literal|0
operator|||
name|ivp
operator|==
name|NULL
operator|||
operator|(
name|crypt_off
operator|&
literal|0x3
operator|)
operator|||
operator|(
name|crypt_off
operator|+
name|crypt_len
operator|>
name|iovlen
operator|)
operator|||
operator|(
name|crypt_len
operator|&
literal|0x7
operator|)
operator|||
operator|(
name|auth_len
operator|&
literal|0x7
operator|)
operator|||
operator|(
name|auth_off
operator|&
literal|0x3
operator|)
operator|||
operator|(
name|auth_off
operator|+
name|auth_len
operator|>
name|iovlen
operator|)
argument_list|)
condition|)
block|{
name|dprintf
argument_list|(
literal|"%s: Bad parameters od=%p iov=%p iovlen=%jd "
literal|"auth_off=%d auth_len=%d crypt_off=%d crypt_len=%d "
literal|"icv_off=%d ivp=%p\n"
argument_list|,
name|__func__
argument_list|,
name|od
argument_list|,
name|iov
argument_list|,
name|iovlen
argument_list|,
name|auth_off
argument_list|,
name|auth_len
argument_list|,
name|crypt_off
argument_list|,
name|crypt_len
argument_list|,
name|icv_off
argument_list|,
name|ivp
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|IOV_INIT
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|CVMX_PREFETCH0
argument_list|(
name|ivp
argument_list|)
expr_stmt|;
name|CVMX_PREFETCH0
argument_list|(
name|od
operator|->
name|octo_enckey
argument_list|)
expr_stmt|;
name|s
operator|=
name|octeon_crypto_enable
argument_list|()
expr_stmt|;
comment|/* load 3DES Key */
name|CVMX_MT_3DES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|od
operator|->
name|octo_encklen
operator|==
literal|24
condition|)
block|{
name|CVMX_MT_3DES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|1
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|CVMX_MT_3DES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|2
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|od
operator|->
name|octo_encklen
operator|==
literal|8
condition|)
block|{
name|CVMX_MT_3DES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|0
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|CVMX_MT_3DES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|0
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|octeon_crypto_disable
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|dprintf
argument_list|(
literal|"%s: Bad key length %d\n"
argument_list|,
name|__func__
argument_list|,
name|od
operator|->
name|octo_encklen
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|CVMX_MT_3DES_IV
argument_list|(
operator|*
operator|(
name|uint64_t
operator|*
operator|)
name|ivp
argument_list|)
expr_stmt|;
comment|/* Load MD5 IV */
name|CVMX_MT_HSH_IV
argument_list|(
name|od
operator|->
name|octo_hminner
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_IV
argument_list|(
name|od
operator|->
name|octo_hminner
index|[
literal|1
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
while|while
condition|(
name|crypt_off
operator|>
literal|0
operator|&&
name|auth_off
operator|>
literal|0
condition|)
block|{
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|crypt_off
operator|-=
literal|4
expr_stmt|;
name|auth_off
operator|-=
literal|4
expr_stmt|;
block|}
while|while
condition|(
name|crypt_len
operator|>
literal|0
operator|||
name|auth_len
operator|>
literal|0
condition|)
block|{
name|uint32_t
modifier|*
name|first
init|=
name|data32
decl_stmt|;
name|mydata
operator|.
name|data32
index|[
literal|0
index|]
operator|=
operator|*
name|first
expr_stmt|;
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|mydata
operator|.
name|data32
index|[
literal|1
index|]
operator|=
operator|*
name|data32
expr_stmt|;
if|if
condition|(
name|crypt_off
operator|<=
literal|0
condition|)
block|{
if|if
condition|(
name|crypt_len
operator|>
literal|0
condition|)
block|{
name|CVMX_MT_3DES_ENC_CBC
argument_list|(
operator|*
name|data
argument_list|)
expr_stmt|;
name|CVMX_MF_3DES_RESULT
argument_list|(
operator|*
name|data
argument_list|)
expr_stmt|;
name|crypt_len
operator|-=
literal|8
expr_stmt|;
block|}
block|}
else|else
name|crypt_off
operator|-=
literal|8
expr_stmt|;
if|if
condition|(
name|auth_off
operator|<=
literal|0
condition|)
block|{
if|if
condition|(
name|auth_len
operator|>
literal|0
condition|)
block|{
name|CVM_LOAD_MD5_UNIT
argument_list|(
operator|*
name|data
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|auth_len
operator|-=
literal|8
expr_stmt|;
block|}
block|}
else|else
name|auth_off
operator|-=
literal|8
expr_stmt|;
operator|*
name|first
operator|=
name|mydata
operator|.
name|data32
index|[
literal|0
index|]
expr_stmt|;
operator|*
name|data32
operator|=
name|mydata
operator|.
name|data32
index|[
literal|1
index|]
expr_stmt|;
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
block|}
comment|/* finish the hash */
name|CVMX_PREFETCH0
argument_list|(
name|od
operator|->
name|octo_hmouter
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|if (__predict_false(inplen)) { 	uint64_t tmp = 0; 	uint8_t *p = (uint8_t *)& tmp; 	p[inplen] = 0x80; 	do { 	    inplen--; 	    p[inplen] = ((uint8_t *) data)[inplen]; 	} while (inplen); 	CVM_LOAD_MD5_UNIT(tmp, next);     } else { 	CVM_LOAD_MD5_UNIT(0x8000000000000000ULL, next);     }
else|#
directive|else
name|CVM_LOAD_MD5_UNIT
argument_list|(
literal|0x8000000000000000ULL
argument_list|,
name|next
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* Finish Inner hash */
while|while
condition|(
name|next
operator|!=
literal|7
condition|)
block|{
name|CVM_LOAD_MD5_UNIT
argument_list|(
operator|(
operator|(
name|uint64_t
operator|)
literal|0x0ULL
operator|)
argument_list|,
name|next
argument_list|)
expr_stmt|;
block|}
name|CVMX_ES64
argument_list|(
name|tmp1
argument_list|,
operator|(
operator|(
name|alen
operator|+
literal|64
operator|)
operator|<<
literal|3
operator|)
argument_list|)
expr_stmt|;
name|CVM_LOAD_MD5_UNIT
argument_list|(
name|tmp1
argument_list|,
name|next
argument_list|)
expr_stmt|;
comment|/* Get the inner hash of HMAC */
name|CVMX_MF_HSH_IV
argument_list|(
name|tmp1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MF_HSH_IV
argument_list|(
name|tmp2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* Initialize hash unit */
name|CVMX_MT_HSH_IV
argument_list|(
name|od
operator|->
name|octo_hmouter
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_IV
argument_list|(
name|od
operator|->
name|octo_hmouter
index|[
literal|1
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DAT
argument_list|(
name|tmp1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DAT
argument_list|(
name|tmp2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DAT
argument_list|(
literal|0x8000000000000000ULL
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DATZ
argument_list|(
literal|3
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DATZ
argument_list|(
literal|4
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DATZ
argument_list|(
literal|5
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DATZ
argument_list|(
literal|6
argument_list|)
expr_stmt|;
name|CVMX_ES64
argument_list|(
name|tmp1
argument_list|,
operator|(
operator|(
literal|64
operator|+
literal|16
operator|)
operator|<<
literal|3
operator|)
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_STARTMD5
argument_list|(
name|tmp1
argument_list|)
expr_stmt|;
comment|/* save the HMAC */
name|IOV_INIT
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
while|while
condition|(
name|icv_off
operator|>
literal|0
condition|)
block|{
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|icv_off
operator|-=
literal|4
expr_stmt|;
block|}
name|CVMX_MF_HSH_IV
argument_list|(
name|tmp1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|*
name|data32
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|tmp1
operator|>>
literal|32
argument_list|)
expr_stmt|;
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
operator|*
name|data32
operator|=
operator|(
name|uint32_t
operator|)
name|tmp1
expr_stmt|;
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|CVMX_MF_HSH_IV
argument_list|(
name|tmp1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
operator|*
name|data32
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|tmp1
operator|>>
literal|32
argument_list|)
expr_stmt|;
name|octeon_crypto_disable
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|octo_des_cbc_md5_decrypt
parameter_list|(
name|struct
name|octo_sess
modifier|*
name|od
parameter_list|,
name|struct
name|iovec
modifier|*
name|iov
parameter_list|,
name|size_t
name|iovcnt
parameter_list|,
name|size_t
name|iovlen
parameter_list|,
name|int
name|auth_off
parameter_list|,
name|int
name|auth_len
parameter_list|,
name|int
name|crypt_off
parameter_list|,
name|int
name|crypt_len
parameter_list|,
name|int
name|icv_off
parameter_list|,
name|uint8_t
modifier|*
name|ivp
parameter_list|)
block|{
specifier|register
name|int
name|next
init|=
literal|0
decl_stmt|;
union|union
block|{
name|uint32_t
name|data32
index|[
literal|2
index|]
decl_stmt|;
name|uint64_t
name|data64
index|[
literal|1
index|]
decl_stmt|;
block|}
name|mydata
union|;
name|uint64_t
modifier|*
name|data
init|=
operator|&
name|mydata
operator|.
name|data64
index|[
literal|0
index|]
decl_stmt|;
name|uint32_t
modifier|*
name|data32
decl_stmt|;
name|uint64_t
name|tmp1
decl_stmt|,
name|tmp2
decl_stmt|;
name|int
name|data_i
decl_stmt|,
name|data_l
decl_stmt|,
name|alen
init|=
name|auth_len
decl_stmt|;
name|register_t
name|s
decl_stmt|;
name|dprintf
argument_list|(
literal|"%s()\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
name|__predict_false
argument_list|(
name|od
operator|==
name|NULL
operator|||
name|iov
operator|==
name|NULL
operator|||
name|iovlen
operator|==
literal|0
operator|||
name|ivp
operator|==
name|NULL
operator|||
operator|(
name|crypt_off
operator|&
literal|0x3
operator|)
operator|||
operator|(
name|crypt_off
operator|+
name|crypt_len
operator|>
name|iovlen
operator|)
operator|||
operator|(
name|crypt_len
operator|&
literal|0x7
operator|)
operator|||
operator|(
name|auth_len
operator|&
literal|0x7
operator|)
operator|||
operator|(
name|auth_off
operator|&
literal|0x3
operator|)
operator|||
operator|(
name|auth_off
operator|+
name|auth_len
operator|>
name|iovlen
operator|)
argument_list|)
condition|)
block|{
name|dprintf
argument_list|(
literal|"%s: Bad parameters od=%p iov=%p iovlen=%jd "
literal|"auth_off=%d auth_len=%d crypt_off=%d crypt_len=%d "
literal|"icv_off=%d ivp=%p\n"
argument_list|,
name|__func__
argument_list|,
name|od
argument_list|,
name|iov
argument_list|,
name|iovlen
argument_list|,
name|auth_off
argument_list|,
name|auth_len
argument_list|,
name|crypt_off
argument_list|,
name|crypt_len
argument_list|,
name|icv_off
argument_list|,
name|ivp
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|IOV_INIT
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|CVMX_PREFETCH0
argument_list|(
name|ivp
argument_list|)
expr_stmt|;
name|CVMX_PREFETCH0
argument_list|(
name|od
operator|->
name|octo_enckey
argument_list|)
expr_stmt|;
name|s
operator|=
name|octeon_crypto_enable
argument_list|()
expr_stmt|;
comment|/* load 3DES Key */
name|CVMX_MT_3DES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|od
operator|->
name|octo_encklen
operator|==
literal|24
condition|)
block|{
name|CVMX_MT_3DES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|1
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|CVMX_MT_3DES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|2
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|od
operator|->
name|octo_encklen
operator|==
literal|8
condition|)
block|{
name|CVMX_MT_3DES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|0
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|CVMX_MT_3DES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|0
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|octeon_crypto_disable
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|dprintf
argument_list|(
literal|"%s: Bad key length %d\n"
argument_list|,
name|__func__
argument_list|,
name|od
operator|->
name|octo_encklen
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|CVMX_MT_3DES_IV
argument_list|(
operator|*
operator|(
name|uint64_t
operator|*
operator|)
name|ivp
argument_list|)
expr_stmt|;
comment|/* Load MD5 IV */
name|CVMX_MT_HSH_IV
argument_list|(
name|od
operator|->
name|octo_hminner
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_IV
argument_list|(
name|od
operator|->
name|octo_hminner
index|[
literal|1
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
while|while
condition|(
name|crypt_off
operator|>
literal|0
operator|&&
name|auth_off
operator|>
literal|0
condition|)
block|{
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|crypt_off
operator|-=
literal|4
expr_stmt|;
name|auth_off
operator|-=
literal|4
expr_stmt|;
block|}
while|while
condition|(
name|crypt_len
operator|>
literal|0
operator|||
name|auth_len
operator|>
literal|0
condition|)
block|{
name|uint32_t
modifier|*
name|first
init|=
name|data32
decl_stmt|;
name|mydata
operator|.
name|data32
index|[
literal|0
index|]
operator|=
operator|*
name|first
expr_stmt|;
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|mydata
operator|.
name|data32
index|[
literal|1
index|]
operator|=
operator|*
name|data32
expr_stmt|;
if|if
condition|(
name|auth_off
operator|<=
literal|0
condition|)
block|{
if|if
condition|(
name|auth_len
operator|>
literal|0
condition|)
block|{
name|CVM_LOAD_MD5_UNIT
argument_list|(
operator|*
name|data
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|auth_len
operator|-=
literal|8
expr_stmt|;
block|}
block|}
else|else
name|auth_off
operator|-=
literal|8
expr_stmt|;
if|if
condition|(
name|crypt_off
operator|<=
literal|0
condition|)
block|{
if|if
condition|(
name|crypt_len
operator|>
literal|0
condition|)
block|{
name|CVMX_MT_3DES_DEC_CBC
argument_list|(
operator|*
name|data
argument_list|)
expr_stmt|;
name|CVMX_MF_3DES_RESULT
argument_list|(
operator|*
name|data
argument_list|)
expr_stmt|;
name|crypt_len
operator|-=
literal|8
expr_stmt|;
block|}
block|}
else|else
name|crypt_off
operator|-=
literal|8
expr_stmt|;
operator|*
name|first
operator|=
name|mydata
operator|.
name|data32
index|[
literal|0
index|]
expr_stmt|;
operator|*
name|data32
operator|=
name|mydata
operator|.
name|data32
index|[
literal|1
index|]
expr_stmt|;
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
block|}
comment|/* finish the hash */
name|CVMX_PREFETCH0
argument_list|(
name|od
operator|->
name|octo_hmouter
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|if (__predict_false(inplen)) { 	uint64_t tmp = 0; 	uint8_t *p = (uint8_t *)& tmp; 	p[inplen] = 0x80; 	do { 	    inplen--; 	    p[inplen] = ((uint8_t *) data)[inplen]; 	} while (inplen); 	CVM_LOAD_MD5_UNIT(tmp, next);     } else { 	CVM_LOAD_MD5_UNIT(0x8000000000000000ULL, next);     }
else|#
directive|else
name|CVM_LOAD_MD5_UNIT
argument_list|(
literal|0x8000000000000000ULL
argument_list|,
name|next
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* Finish Inner hash */
while|while
condition|(
name|next
operator|!=
literal|7
condition|)
block|{
name|CVM_LOAD_MD5_UNIT
argument_list|(
operator|(
operator|(
name|uint64_t
operator|)
literal|0x0ULL
operator|)
argument_list|,
name|next
argument_list|)
expr_stmt|;
block|}
name|CVMX_ES64
argument_list|(
name|tmp1
argument_list|,
operator|(
operator|(
name|alen
operator|+
literal|64
operator|)
operator|<<
literal|3
operator|)
argument_list|)
expr_stmt|;
name|CVM_LOAD_MD5_UNIT
argument_list|(
name|tmp1
argument_list|,
name|next
argument_list|)
expr_stmt|;
comment|/* Get the inner hash of HMAC */
name|CVMX_MF_HSH_IV
argument_list|(
name|tmp1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MF_HSH_IV
argument_list|(
name|tmp2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* Initialize hash unit */
name|CVMX_MT_HSH_IV
argument_list|(
name|od
operator|->
name|octo_hmouter
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_IV
argument_list|(
name|od
operator|->
name|octo_hmouter
index|[
literal|1
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DAT
argument_list|(
name|tmp1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DAT
argument_list|(
name|tmp2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DAT
argument_list|(
literal|0x8000000000000000ULL
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DATZ
argument_list|(
literal|3
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DATZ
argument_list|(
literal|4
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DATZ
argument_list|(
literal|5
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DATZ
argument_list|(
literal|6
argument_list|)
expr_stmt|;
name|CVMX_ES64
argument_list|(
name|tmp1
argument_list|,
operator|(
operator|(
literal|64
operator|+
literal|16
operator|)
operator|<<
literal|3
operator|)
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_STARTMD5
argument_list|(
name|tmp1
argument_list|)
expr_stmt|;
comment|/* save the HMAC */
name|IOV_INIT
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
while|while
condition|(
name|icv_off
operator|>
literal|0
condition|)
block|{
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|icv_off
operator|-=
literal|4
expr_stmt|;
block|}
name|CVMX_MF_HSH_IV
argument_list|(
name|tmp1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|*
name|data32
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|tmp1
operator|>>
literal|32
argument_list|)
expr_stmt|;
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
operator|*
name|data32
operator|=
operator|(
name|uint32_t
operator|)
name|tmp1
expr_stmt|;
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|CVMX_MF_HSH_IV
argument_list|(
name|tmp1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
operator|*
name|data32
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|tmp1
operator|>>
literal|32
argument_list|)
expr_stmt|;
name|octeon_crypto_disable
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/****************************************************************************/
end_comment

begin_comment
comment|/* DES SHA */
end_comment

begin_function
name|int
name|octo_des_cbc_sha1_encrypt
parameter_list|(
name|struct
name|octo_sess
modifier|*
name|od
parameter_list|,
name|struct
name|iovec
modifier|*
name|iov
parameter_list|,
name|size_t
name|iovcnt
parameter_list|,
name|size_t
name|iovlen
parameter_list|,
name|int
name|auth_off
parameter_list|,
name|int
name|auth_len
parameter_list|,
name|int
name|crypt_off
parameter_list|,
name|int
name|crypt_len
parameter_list|,
name|int
name|icv_off
parameter_list|,
name|uint8_t
modifier|*
name|ivp
parameter_list|)
block|{
specifier|register
name|int
name|next
init|=
literal|0
decl_stmt|;
union|union
block|{
name|uint32_t
name|data32
index|[
literal|2
index|]
decl_stmt|;
name|uint64_t
name|data64
index|[
literal|1
index|]
decl_stmt|;
block|}
name|mydata
union|;
name|uint64_t
modifier|*
name|data
init|=
operator|&
name|mydata
operator|.
name|data64
index|[
literal|0
index|]
decl_stmt|;
name|uint32_t
modifier|*
name|data32
decl_stmt|;
name|uint64_t
name|tmp1
decl_stmt|,
name|tmp2
decl_stmt|,
name|tmp3
decl_stmt|;
name|int
name|data_i
decl_stmt|,
name|data_l
decl_stmt|,
name|alen
init|=
name|auth_len
decl_stmt|;
name|register_t
name|s
decl_stmt|;
name|dprintf
argument_list|(
literal|"%s()\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
name|__predict_false
argument_list|(
name|od
operator|==
name|NULL
operator|||
name|iov
operator|==
name|NULL
operator|||
name|iovlen
operator|==
literal|0
operator|||
name|ivp
operator|==
name|NULL
operator|||
operator|(
name|crypt_off
operator|&
literal|0x3
operator|)
operator|||
operator|(
name|crypt_off
operator|+
name|crypt_len
operator|>
name|iovlen
operator|)
operator|||
operator|(
name|crypt_len
operator|&
literal|0x7
operator|)
operator|||
operator|(
name|auth_len
operator|&
literal|0x7
operator|)
operator|||
operator|(
name|auth_off
operator|&
literal|0x3
operator|)
operator|||
operator|(
name|auth_off
operator|+
name|auth_len
operator|>
name|iovlen
operator|)
argument_list|)
condition|)
block|{
name|dprintf
argument_list|(
literal|"%s: Bad parameters od=%p iov=%p iovlen=%jd "
literal|"auth_off=%d auth_len=%d crypt_off=%d crypt_len=%d "
literal|"icv_off=%d ivp=%p\n"
argument_list|,
name|__func__
argument_list|,
name|od
argument_list|,
name|iov
argument_list|,
name|iovlen
argument_list|,
name|auth_off
argument_list|,
name|auth_len
argument_list|,
name|crypt_off
argument_list|,
name|crypt_len
argument_list|,
name|icv_off
argument_list|,
name|ivp
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|IOV_INIT
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|CVMX_PREFETCH0
argument_list|(
name|ivp
argument_list|)
expr_stmt|;
name|CVMX_PREFETCH0
argument_list|(
name|od
operator|->
name|octo_enckey
argument_list|)
expr_stmt|;
name|s
operator|=
name|octeon_crypto_enable
argument_list|()
expr_stmt|;
comment|/* load 3DES Key */
name|CVMX_MT_3DES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|od
operator|->
name|octo_encklen
operator|==
literal|24
condition|)
block|{
name|CVMX_MT_3DES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|1
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|CVMX_MT_3DES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|2
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|od
operator|->
name|octo_encklen
operator|==
literal|8
condition|)
block|{
name|CVMX_MT_3DES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|0
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|CVMX_MT_3DES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|0
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|octeon_crypto_disable
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|dprintf
argument_list|(
literal|"%s: Bad key length %d\n"
argument_list|,
name|__func__
argument_list|,
name|od
operator|->
name|octo_encklen
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|CVMX_MT_3DES_IV
argument_list|(
operator|*
operator|(
name|uint64_t
operator|*
operator|)
name|ivp
argument_list|)
expr_stmt|;
comment|/* Load SHA1 IV */
name|CVMX_MT_HSH_IV
argument_list|(
name|od
operator|->
name|octo_hminner
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_IV
argument_list|(
name|od
operator|->
name|octo_hminner
index|[
literal|1
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_IV
argument_list|(
name|od
operator|->
name|octo_hminner
index|[
literal|2
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
while|while
condition|(
name|crypt_off
operator|>
literal|0
operator|&&
name|auth_off
operator|>
literal|0
condition|)
block|{
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|crypt_off
operator|-=
literal|4
expr_stmt|;
name|auth_off
operator|-=
literal|4
expr_stmt|;
block|}
while|while
condition|(
name|crypt_len
operator|>
literal|0
operator|||
name|auth_len
operator|>
literal|0
condition|)
block|{
name|uint32_t
modifier|*
name|first
init|=
name|data32
decl_stmt|;
name|mydata
operator|.
name|data32
index|[
literal|0
index|]
operator|=
operator|*
name|first
expr_stmt|;
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|mydata
operator|.
name|data32
index|[
literal|1
index|]
operator|=
operator|*
name|data32
expr_stmt|;
if|if
condition|(
name|crypt_off
operator|<=
literal|0
condition|)
block|{
if|if
condition|(
name|crypt_len
operator|>
literal|0
condition|)
block|{
name|CVMX_MT_3DES_ENC_CBC
argument_list|(
operator|*
name|data
argument_list|)
expr_stmt|;
name|CVMX_MF_3DES_RESULT
argument_list|(
operator|*
name|data
argument_list|)
expr_stmt|;
name|crypt_len
operator|-=
literal|8
expr_stmt|;
block|}
block|}
else|else
name|crypt_off
operator|-=
literal|8
expr_stmt|;
if|if
condition|(
name|auth_off
operator|<=
literal|0
condition|)
block|{
if|if
condition|(
name|auth_len
operator|>
literal|0
condition|)
block|{
name|CVM_LOAD_SHA_UNIT
argument_list|(
operator|*
name|data
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|auth_len
operator|-=
literal|8
expr_stmt|;
block|}
block|}
else|else
name|auth_off
operator|-=
literal|8
expr_stmt|;
operator|*
name|first
operator|=
name|mydata
operator|.
name|data32
index|[
literal|0
index|]
expr_stmt|;
operator|*
name|data32
operator|=
name|mydata
operator|.
name|data32
index|[
literal|1
index|]
expr_stmt|;
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
block|}
comment|/* finish the hash */
name|CVMX_PREFETCH0
argument_list|(
name|od
operator|->
name|octo_hmouter
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|if (__predict_false(inplen)) { 	uint64_t tmp = 0; 	uint8_t *p = (uint8_t *)& tmp; 	p[inplen] = 0x80; 	do { 	    inplen--; 	    p[inplen] = ((uint8_t *) data)[inplen]; 	} while (inplen); 	CVM_LOAD_SHA_UNIT(tmp, next);     } else { 	CVM_LOAD_SHA_UNIT(0x8000000000000000ULL, next);     }
else|#
directive|else
name|CVM_LOAD_SHA_UNIT
argument_list|(
literal|0x8000000000000000ULL
argument_list|,
name|next
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* Finish Inner hash */
while|while
condition|(
name|next
operator|!=
literal|7
condition|)
block|{
name|CVM_LOAD_SHA_UNIT
argument_list|(
operator|(
operator|(
name|uint64_t
operator|)
literal|0x0ULL
operator|)
argument_list|,
name|next
argument_list|)
expr_stmt|;
block|}
name|CVM_LOAD_SHA_UNIT
argument_list|(
call|(
name|uint64_t
call|)
argument_list|(
operator|(
name|alen
operator|+
literal|64
operator|)
operator|<<
literal|3
argument_list|)
argument_list|,
name|next
argument_list|)
expr_stmt|;
comment|/* Get the inner hash of HMAC */
name|CVMX_MF_HSH_IV
argument_list|(
name|tmp1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MF_HSH_IV
argument_list|(
name|tmp2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|tmp3
operator|=
literal|0
expr_stmt|;
name|CVMX_MF_HSH_IV
argument_list|(
name|tmp3
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* Initialize hash unit */
name|CVMX_MT_HSH_IV
argument_list|(
name|od
operator|->
name|octo_hmouter
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_IV
argument_list|(
name|od
operator|->
name|octo_hmouter
index|[
literal|1
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_IV
argument_list|(
name|od
operator|->
name|octo_hmouter
index|[
literal|2
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DAT
argument_list|(
name|tmp1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DAT
argument_list|(
name|tmp2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|tmp3
operator||=
literal|0x0000000080000000
expr_stmt|;
name|CVMX_MT_HSH_DAT
argument_list|(
name|tmp3
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DATZ
argument_list|(
literal|3
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DATZ
argument_list|(
literal|4
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DATZ
argument_list|(
literal|5
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DATZ
argument_list|(
literal|6
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_STARTSHA
argument_list|(
call|(
name|uint64_t
call|)
argument_list|(
operator|(
literal|64
operator|+
literal|20
operator|)
operator|<<
literal|3
argument_list|)
argument_list|)
expr_stmt|;
comment|/* save the HMAC */
name|IOV_INIT
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
while|while
condition|(
name|icv_off
operator|>
literal|0
condition|)
block|{
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|icv_off
operator|-=
literal|4
expr_stmt|;
block|}
name|CVMX_MF_HSH_IV
argument_list|(
name|tmp1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|*
name|data32
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|tmp1
operator|>>
literal|32
argument_list|)
expr_stmt|;
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
operator|*
name|data32
operator|=
operator|(
name|uint32_t
operator|)
name|tmp1
expr_stmt|;
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|CVMX_MF_HSH_IV
argument_list|(
name|tmp1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
operator|*
name|data32
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|tmp1
operator|>>
literal|32
argument_list|)
expr_stmt|;
name|octeon_crypto_disable
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|octo_des_cbc_sha1_decrypt
parameter_list|(
name|struct
name|octo_sess
modifier|*
name|od
parameter_list|,
name|struct
name|iovec
modifier|*
name|iov
parameter_list|,
name|size_t
name|iovcnt
parameter_list|,
name|size_t
name|iovlen
parameter_list|,
name|int
name|auth_off
parameter_list|,
name|int
name|auth_len
parameter_list|,
name|int
name|crypt_off
parameter_list|,
name|int
name|crypt_len
parameter_list|,
name|int
name|icv_off
parameter_list|,
name|uint8_t
modifier|*
name|ivp
parameter_list|)
block|{
specifier|register
name|int
name|next
init|=
literal|0
decl_stmt|;
union|union
block|{
name|uint32_t
name|data32
index|[
literal|2
index|]
decl_stmt|;
name|uint64_t
name|data64
index|[
literal|1
index|]
decl_stmt|;
block|}
name|mydata
union|;
name|uint64_t
modifier|*
name|data
init|=
operator|&
name|mydata
operator|.
name|data64
index|[
literal|0
index|]
decl_stmt|;
name|uint32_t
modifier|*
name|data32
decl_stmt|;
name|uint64_t
name|tmp1
decl_stmt|,
name|tmp2
decl_stmt|,
name|tmp3
decl_stmt|;
name|int
name|data_i
decl_stmt|,
name|data_l
decl_stmt|,
name|alen
init|=
name|auth_len
decl_stmt|;
name|register_t
name|s
decl_stmt|;
name|dprintf
argument_list|(
literal|"%s()\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
name|__predict_false
argument_list|(
name|od
operator|==
name|NULL
operator|||
name|iov
operator|==
name|NULL
operator|||
name|iovlen
operator|==
literal|0
operator|||
name|ivp
operator|==
name|NULL
operator|||
operator|(
name|crypt_off
operator|&
literal|0x3
operator|)
operator|||
operator|(
name|crypt_off
operator|+
name|crypt_len
operator|>
name|iovlen
operator|)
operator|||
operator|(
name|crypt_len
operator|&
literal|0x7
operator|)
operator|||
operator|(
name|auth_len
operator|&
literal|0x7
operator|)
operator|||
operator|(
name|auth_off
operator|&
literal|0x3
operator|)
operator|||
operator|(
name|auth_off
operator|+
name|auth_len
operator|>
name|iovlen
operator|)
argument_list|)
condition|)
block|{
name|dprintf
argument_list|(
literal|"%s: Bad parameters od=%p iov=%p iovlen=%jd "
literal|"auth_off=%d auth_len=%d crypt_off=%d crypt_len=%d "
literal|"icv_off=%d ivp=%p\n"
argument_list|,
name|__func__
argument_list|,
name|od
argument_list|,
name|iov
argument_list|,
name|iovlen
argument_list|,
name|auth_off
argument_list|,
name|auth_len
argument_list|,
name|crypt_off
argument_list|,
name|crypt_len
argument_list|,
name|icv_off
argument_list|,
name|ivp
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|IOV_INIT
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|CVMX_PREFETCH0
argument_list|(
name|ivp
argument_list|)
expr_stmt|;
name|CVMX_PREFETCH0
argument_list|(
name|od
operator|->
name|octo_enckey
argument_list|)
expr_stmt|;
name|s
operator|=
name|octeon_crypto_enable
argument_list|()
expr_stmt|;
comment|/* load 3DES Key */
name|CVMX_MT_3DES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|od
operator|->
name|octo_encklen
operator|==
literal|24
condition|)
block|{
name|CVMX_MT_3DES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|1
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|CVMX_MT_3DES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|2
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|od
operator|->
name|octo_encklen
operator|==
literal|8
condition|)
block|{
name|CVMX_MT_3DES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|0
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|CVMX_MT_3DES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|0
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|octeon_crypto_disable
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|dprintf
argument_list|(
literal|"%s: Bad key length %d\n"
argument_list|,
name|__func__
argument_list|,
name|od
operator|->
name|octo_encklen
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|CVMX_MT_3DES_IV
argument_list|(
operator|*
operator|(
name|uint64_t
operator|*
operator|)
name|ivp
argument_list|)
expr_stmt|;
comment|/* Load SHA1 IV */
name|CVMX_MT_HSH_IV
argument_list|(
name|od
operator|->
name|octo_hminner
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_IV
argument_list|(
name|od
operator|->
name|octo_hminner
index|[
literal|1
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_IV
argument_list|(
name|od
operator|->
name|octo_hminner
index|[
literal|2
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
while|while
condition|(
name|crypt_off
operator|>
literal|0
operator|&&
name|auth_off
operator|>
literal|0
condition|)
block|{
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|crypt_off
operator|-=
literal|4
expr_stmt|;
name|auth_off
operator|-=
literal|4
expr_stmt|;
block|}
while|while
condition|(
name|crypt_len
operator|>
literal|0
operator|||
name|auth_len
operator|>
literal|0
condition|)
block|{
name|uint32_t
modifier|*
name|first
init|=
name|data32
decl_stmt|;
name|mydata
operator|.
name|data32
index|[
literal|0
index|]
operator|=
operator|*
name|first
expr_stmt|;
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|mydata
operator|.
name|data32
index|[
literal|1
index|]
operator|=
operator|*
name|data32
expr_stmt|;
if|if
condition|(
name|auth_off
operator|<=
literal|0
condition|)
block|{
if|if
condition|(
name|auth_len
operator|>
literal|0
condition|)
block|{
name|CVM_LOAD_SHA_UNIT
argument_list|(
operator|*
name|data
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|auth_len
operator|-=
literal|8
expr_stmt|;
block|}
block|}
else|else
name|auth_off
operator|-=
literal|8
expr_stmt|;
if|if
condition|(
name|crypt_off
operator|<=
literal|0
condition|)
block|{
if|if
condition|(
name|crypt_len
operator|>
literal|0
condition|)
block|{
name|CVMX_MT_3DES_DEC_CBC
argument_list|(
operator|*
name|data
argument_list|)
expr_stmt|;
name|CVMX_MF_3DES_RESULT
argument_list|(
operator|*
name|data
argument_list|)
expr_stmt|;
name|crypt_len
operator|-=
literal|8
expr_stmt|;
block|}
block|}
else|else
name|crypt_off
operator|-=
literal|8
expr_stmt|;
operator|*
name|first
operator|=
name|mydata
operator|.
name|data32
index|[
literal|0
index|]
expr_stmt|;
operator|*
name|data32
operator|=
name|mydata
operator|.
name|data32
index|[
literal|1
index|]
expr_stmt|;
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
block|}
comment|/* finish the hash */
name|CVMX_PREFETCH0
argument_list|(
name|od
operator|->
name|octo_hmouter
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|if (__predict_false(inplen)) { 	uint64_t tmp = 0; 	uint8_t *p = (uint8_t *)& tmp; 	p[inplen] = 0x80; 	do { 	    inplen--; 	    p[inplen] = ((uint8_t *) data)[inplen]; 	} while (inplen); 	CVM_LOAD_SHA_UNIT(tmp, next);     } else { 	CVM_LOAD_SHA_UNIT(0x8000000000000000ULL, next);     }
else|#
directive|else
name|CVM_LOAD_SHA_UNIT
argument_list|(
literal|0x8000000000000000ULL
argument_list|,
name|next
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* Finish Inner hash */
while|while
condition|(
name|next
operator|!=
literal|7
condition|)
block|{
name|CVM_LOAD_SHA_UNIT
argument_list|(
operator|(
operator|(
name|uint64_t
operator|)
literal|0x0ULL
operator|)
argument_list|,
name|next
argument_list|)
expr_stmt|;
block|}
name|CVM_LOAD_SHA_UNIT
argument_list|(
call|(
name|uint64_t
call|)
argument_list|(
operator|(
name|alen
operator|+
literal|64
operator|)
operator|<<
literal|3
argument_list|)
argument_list|,
name|next
argument_list|)
expr_stmt|;
comment|/* Get the inner hash of HMAC */
name|CVMX_MF_HSH_IV
argument_list|(
name|tmp1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MF_HSH_IV
argument_list|(
name|tmp2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|tmp3
operator|=
literal|0
expr_stmt|;
name|CVMX_MF_HSH_IV
argument_list|(
name|tmp3
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* Initialize hash unit */
name|CVMX_MT_HSH_IV
argument_list|(
name|od
operator|->
name|octo_hmouter
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_IV
argument_list|(
name|od
operator|->
name|octo_hmouter
index|[
literal|1
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_IV
argument_list|(
name|od
operator|->
name|octo_hmouter
index|[
literal|2
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DAT
argument_list|(
name|tmp1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DAT
argument_list|(
name|tmp2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|tmp3
operator||=
literal|0x0000000080000000
expr_stmt|;
name|CVMX_MT_HSH_DAT
argument_list|(
name|tmp3
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DATZ
argument_list|(
literal|3
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DATZ
argument_list|(
literal|4
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DATZ
argument_list|(
literal|5
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DATZ
argument_list|(
literal|6
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_STARTSHA
argument_list|(
call|(
name|uint64_t
call|)
argument_list|(
operator|(
literal|64
operator|+
literal|20
operator|)
operator|<<
literal|3
argument_list|)
argument_list|)
expr_stmt|;
comment|/* save the HMAC */
name|IOV_INIT
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
while|while
condition|(
name|icv_off
operator|>
literal|0
condition|)
block|{
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|icv_off
operator|-=
literal|4
expr_stmt|;
block|}
name|CVMX_MF_HSH_IV
argument_list|(
name|tmp1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|*
name|data32
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|tmp1
operator|>>
literal|32
argument_list|)
expr_stmt|;
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
operator|*
name|data32
operator|=
operator|(
name|uint32_t
operator|)
name|tmp1
expr_stmt|;
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|CVMX_MF_HSH_IV
argument_list|(
name|tmp1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
operator|*
name|data32
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|tmp1
operator|>>
literal|32
argument_list|)
expr_stmt|;
name|octeon_crypto_disable
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/****************************************************************************/
end_comment

begin_comment
comment|/* AES MD5 */
end_comment

begin_function
name|int
name|octo_aes_cbc_md5_encrypt
parameter_list|(
name|struct
name|octo_sess
modifier|*
name|od
parameter_list|,
name|struct
name|iovec
modifier|*
name|iov
parameter_list|,
name|size_t
name|iovcnt
parameter_list|,
name|size_t
name|iovlen
parameter_list|,
name|int
name|auth_off
parameter_list|,
name|int
name|auth_len
parameter_list|,
name|int
name|crypt_off
parameter_list|,
name|int
name|crypt_len
parameter_list|,
name|int
name|icv_off
parameter_list|,
name|uint8_t
modifier|*
name|ivp
parameter_list|)
block|{
specifier|register
name|int
name|next
init|=
literal|0
decl_stmt|;
union|union
block|{
name|uint32_t
name|data32
index|[
literal|2
index|]
decl_stmt|;
name|uint64_t
name|data64
index|[
literal|1
index|]
decl_stmt|;
block|}
name|mydata
index|[
literal|2
index|]
union|;
name|uint64_t
modifier|*
name|pdata
init|=
operator|&
name|mydata
index|[
literal|0
index|]
operator|.
name|data64
index|[
literal|0
index|]
decl_stmt|;
name|uint64_t
modifier|*
name|data
init|=
operator|&
name|mydata
index|[
literal|1
index|]
operator|.
name|data64
index|[
literal|0
index|]
decl_stmt|;
name|uint32_t
modifier|*
name|data32
decl_stmt|;
name|uint64_t
name|tmp1
decl_stmt|,
name|tmp2
decl_stmt|;
name|int
name|data_i
decl_stmt|,
name|data_l
decl_stmt|,
name|alen
init|=
name|auth_len
decl_stmt|;
name|register_t
name|s
decl_stmt|;
name|dprintf
argument_list|(
literal|"%s()\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
name|__predict_false
argument_list|(
name|od
operator|==
name|NULL
operator|||
name|iov
operator|==
name|NULL
operator|||
name|iovlen
operator|==
literal|0
operator|||
name|ivp
operator|==
name|NULL
operator|||
operator|(
name|crypt_off
operator|&
literal|0x3
operator|)
operator|||
operator|(
name|crypt_off
operator|+
name|crypt_len
operator|>
name|iovlen
operator|)
operator|||
operator|(
name|crypt_len
operator|&
literal|0x7
operator|)
operator|||
operator|(
name|auth_len
operator|&
literal|0x7
operator|)
operator|||
operator|(
name|auth_off
operator|&
literal|0x3
operator|)
operator|||
operator|(
name|auth_off
operator|+
name|auth_len
operator|>
name|iovlen
operator|)
argument_list|)
condition|)
block|{
name|dprintf
argument_list|(
literal|"%s: Bad parameters od=%p iov=%p iovlen=%jd "
literal|"auth_off=%d auth_len=%d crypt_off=%d crypt_len=%d "
literal|"icv_off=%d ivp=%p\n"
argument_list|,
name|__func__
argument_list|,
name|od
argument_list|,
name|iov
argument_list|,
name|iovlen
argument_list|,
name|auth_off
argument_list|,
name|auth_len
argument_list|,
name|crypt_off
argument_list|,
name|crypt_len
argument_list|,
name|icv_off
argument_list|,
name|ivp
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|IOV_INIT
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|CVMX_PREFETCH0
argument_list|(
name|ivp
argument_list|)
expr_stmt|;
name|CVMX_PREFETCH0
argument_list|(
name|od
operator|->
name|octo_enckey
argument_list|)
expr_stmt|;
name|s
operator|=
name|octeon_crypto_enable
argument_list|()
expr_stmt|;
comment|/* load AES Key */
name|CVMX_MT_AES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MT_AES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|1
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|od
operator|->
name|octo_encklen
operator|==
literal|16
condition|)
block|{
name|CVMX_MT_AES_KEY
argument_list|(
literal|0x0
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|CVMX_MT_AES_KEY
argument_list|(
literal|0x0
argument_list|,
literal|3
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|od
operator|->
name|octo_encklen
operator|==
literal|24
condition|)
block|{
name|CVMX_MT_AES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|2
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|CVMX_MT_AES_KEY
argument_list|(
literal|0x0
argument_list|,
literal|3
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|od
operator|->
name|octo_encklen
operator|==
literal|32
condition|)
block|{
name|CVMX_MT_AES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|2
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|CVMX_MT_AES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|3
index|]
argument_list|,
literal|3
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|octeon_crypto_disable
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|dprintf
argument_list|(
literal|"%s: Bad key length %d\n"
argument_list|,
name|__func__
argument_list|,
name|od
operator|->
name|octo_encklen
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|CVMX_MT_AES_KEYLENGTH
argument_list|(
name|od
operator|->
name|octo_encklen
operator|/
literal|8
operator|-
literal|1
argument_list|)
expr_stmt|;
name|CVMX_MT_AES_IV
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|ivp
operator|)
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MT_AES_IV
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|ivp
operator|)
index|[
literal|1
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* Load MD5 IV */
name|CVMX_MT_HSH_IV
argument_list|(
name|od
operator|->
name|octo_hminner
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_IV
argument_list|(
name|od
operator|->
name|octo_hminner
index|[
literal|1
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
while|while
condition|(
name|crypt_off
operator|>
literal|0
operator|&&
name|auth_off
operator|>
literal|0
condition|)
block|{
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|crypt_off
operator|-=
literal|4
expr_stmt|;
name|auth_off
operator|-=
literal|4
expr_stmt|;
block|}
while|while
condition|(
name|crypt_len
operator|>
literal|0
operator|||
name|auth_len
operator|>
literal|0
condition|)
block|{
name|uint32_t
modifier|*
name|pdata32
index|[
literal|3
index|]
decl_stmt|;
name|pdata32
index|[
literal|0
index|]
operator|=
name|data32
expr_stmt|;
name|mydata
index|[
literal|0
index|]
operator|.
name|data32
index|[
literal|0
index|]
operator|=
operator|*
name|data32
expr_stmt|;
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|pdata32
index|[
literal|1
index|]
operator|=
name|data32
expr_stmt|;
name|mydata
index|[
literal|0
index|]
operator|.
name|data32
index|[
literal|1
index|]
operator|=
operator|*
name|data32
expr_stmt|;
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|pdata32
index|[
literal|2
index|]
operator|=
name|data32
expr_stmt|;
name|mydata
index|[
literal|1
index|]
operator|.
name|data32
index|[
literal|0
index|]
operator|=
operator|*
name|data32
expr_stmt|;
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|mydata
index|[
literal|1
index|]
operator|.
name|data32
index|[
literal|1
index|]
operator|=
operator|*
name|data32
expr_stmt|;
if|if
condition|(
name|crypt_off
operator|<=
literal|0
condition|)
block|{
if|if
condition|(
name|crypt_len
operator|>
literal|0
condition|)
block|{
name|CVMX_MT_AES_ENC_CBC0
argument_list|(
operator|*
name|pdata
argument_list|)
expr_stmt|;
name|CVMX_MT_AES_ENC_CBC1
argument_list|(
operator|*
name|data
argument_list|)
expr_stmt|;
name|CVMX_MF_AES_RESULT
argument_list|(
operator|*
name|pdata
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MF_AES_RESULT
argument_list|(
operator|*
name|data
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|crypt_len
operator|-=
literal|16
expr_stmt|;
block|}
block|}
else|else
name|crypt_off
operator|-=
literal|16
expr_stmt|;
if|if
condition|(
name|auth_off
operator|<=
literal|0
condition|)
block|{
if|if
condition|(
name|auth_len
operator|>
literal|0
condition|)
block|{
name|CVM_LOAD_MD5_UNIT
argument_list|(
operator|*
name|pdata
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|CVM_LOAD_MD5_UNIT
argument_list|(
operator|*
name|data
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|auth_len
operator|-=
literal|16
expr_stmt|;
block|}
block|}
else|else
name|auth_off
operator|-=
literal|16
expr_stmt|;
operator|*
name|pdata32
index|[
literal|0
index|]
operator|=
name|mydata
index|[
literal|0
index|]
operator|.
name|data32
index|[
literal|0
index|]
expr_stmt|;
operator|*
name|pdata32
index|[
literal|1
index|]
operator|=
name|mydata
index|[
literal|0
index|]
operator|.
name|data32
index|[
literal|1
index|]
expr_stmt|;
operator|*
name|pdata32
index|[
literal|2
index|]
operator|=
name|mydata
index|[
literal|1
index|]
operator|.
name|data32
index|[
literal|0
index|]
expr_stmt|;
operator|*
name|data32
operator|=
name|mydata
index|[
literal|1
index|]
operator|.
name|data32
index|[
literal|1
index|]
expr_stmt|;
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
block|}
comment|/* finish the hash */
name|CVMX_PREFETCH0
argument_list|(
name|od
operator|->
name|octo_hmouter
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|if (__predict_false(inplen)) { 	uint64_t tmp = 0; 	uint8_t *p = (uint8_t *)& tmp; 	p[inplen] = 0x80; 	do { 	    inplen--; 	    p[inplen] = ((uint8_t *) data)[inplen]; 	} while (inplen); 	CVM_LOAD_MD5_UNIT(tmp, next);     } else { 	CVM_LOAD_MD5_UNIT(0x8000000000000000ULL, next);     }
else|#
directive|else
name|CVM_LOAD_MD5_UNIT
argument_list|(
literal|0x8000000000000000ULL
argument_list|,
name|next
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* Finish Inner hash */
while|while
condition|(
name|next
operator|!=
literal|7
condition|)
block|{
name|CVM_LOAD_MD5_UNIT
argument_list|(
operator|(
operator|(
name|uint64_t
operator|)
literal|0x0ULL
operator|)
argument_list|,
name|next
argument_list|)
expr_stmt|;
block|}
name|CVMX_ES64
argument_list|(
name|tmp1
argument_list|,
operator|(
operator|(
name|alen
operator|+
literal|64
operator|)
operator|<<
literal|3
operator|)
argument_list|)
expr_stmt|;
name|CVM_LOAD_MD5_UNIT
argument_list|(
name|tmp1
argument_list|,
name|next
argument_list|)
expr_stmt|;
comment|/* Get the inner hash of HMAC */
name|CVMX_MF_HSH_IV
argument_list|(
name|tmp1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MF_HSH_IV
argument_list|(
name|tmp2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* Initialize hash unit */
name|CVMX_MT_HSH_IV
argument_list|(
name|od
operator|->
name|octo_hmouter
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_IV
argument_list|(
name|od
operator|->
name|octo_hmouter
index|[
literal|1
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DAT
argument_list|(
name|tmp1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DAT
argument_list|(
name|tmp2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DAT
argument_list|(
literal|0x8000000000000000ULL
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DATZ
argument_list|(
literal|3
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DATZ
argument_list|(
literal|4
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DATZ
argument_list|(
literal|5
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DATZ
argument_list|(
literal|6
argument_list|)
expr_stmt|;
name|CVMX_ES64
argument_list|(
name|tmp1
argument_list|,
operator|(
operator|(
literal|64
operator|+
literal|16
operator|)
operator|<<
literal|3
operator|)
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_STARTMD5
argument_list|(
name|tmp1
argument_list|)
expr_stmt|;
comment|/* save the HMAC */
name|IOV_INIT
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
while|while
condition|(
name|icv_off
operator|>
literal|0
condition|)
block|{
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|icv_off
operator|-=
literal|4
expr_stmt|;
block|}
name|CVMX_MF_HSH_IV
argument_list|(
name|tmp1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|*
name|data32
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|tmp1
operator|>>
literal|32
argument_list|)
expr_stmt|;
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
operator|*
name|data32
operator|=
operator|(
name|uint32_t
operator|)
name|tmp1
expr_stmt|;
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|CVMX_MF_HSH_IV
argument_list|(
name|tmp1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
operator|*
name|data32
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|tmp1
operator|>>
literal|32
argument_list|)
expr_stmt|;
name|octeon_crypto_disable
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|octo_aes_cbc_md5_decrypt
parameter_list|(
name|struct
name|octo_sess
modifier|*
name|od
parameter_list|,
name|struct
name|iovec
modifier|*
name|iov
parameter_list|,
name|size_t
name|iovcnt
parameter_list|,
name|size_t
name|iovlen
parameter_list|,
name|int
name|auth_off
parameter_list|,
name|int
name|auth_len
parameter_list|,
name|int
name|crypt_off
parameter_list|,
name|int
name|crypt_len
parameter_list|,
name|int
name|icv_off
parameter_list|,
name|uint8_t
modifier|*
name|ivp
parameter_list|)
block|{
specifier|register
name|int
name|next
init|=
literal|0
decl_stmt|;
union|union
block|{
name|uint32_t
name|data32
index|[
literal|2
index|]
decl_stmt|;
name|uint64_t
name|data64
index|[
literal|1
index|]
decl_stmt|;
block|}
name|mydata
index|[
literal|2
index|]
union|;
name|uint64_t
modifier|*
name|pdata
init|=
operator|&
name|mydata
index|[
literal|0
index|]
operator|.
name|data64
index|[
literal|0
index|]
decl_stmt|;
name|uint64_t
modifier|*
name|data
init|=
operator|&
name|mydata
index|[
literal|1
index|]
operator|.
name|data64
index|[
literal|0
index|]
decl_stmt|;
name|uint32_t
modifier|*
name|data32
decl_stmt|;
name|uint64_t
name|tmp1
decl_stmt|,
name|tmp2
decl_stmt|;
name|int
name|data_i
decl_stmt|,
name|data_l
decl_stmt|,
name|alen
init|=
name|auth_len
decl_stmt|;
name|register_t
name|s
decl_stmt|;
name|dprintf
argument_list|(
literal|"%s()\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
name|__predict_false
argument_list|(
name|od
operator|==
name|NULL
operator|||
name|iov
operator|==
name|NULL
operator|||
name|iovlen
operator|==
literal|0
operator|||
name|ivp
operator|==
name|NULL
operator|||
operator|(
name|crypt_off
operator|&
literal|0x3
operator|)
operator|||
operator|(
name|crypt_off
operator|+
name|crypt_len
operator|>
name|iovlen
operator|)
operator|||
operator|(
name|crypt_len
operator|&
literal|0x7
operator|)
operator|||
operator|(
name|auth_len
operator|&
literal|0x7
operator|)
operator|||
operator|(
name|auth_off
operator|&
literal|0x3
operator|)
operator|||
operator|(
name|auth_off
operator|+
name|auth_len
operator|>
name|iovlen
operator|)
argument_list|)
condition|)
block|{
name|dprintf
argument_list|(
literal|"%s: Bad parameters od=%p iov=%p iovlen=%jd "
literal|"auth_off=%d auth_len=%d crypt_off=%d crypt_len=%d "
literal|"icv_off=%d ivp=%p\n"
argument_list|,
name|__func__
argument_list|,
name|od
argument_list|,
name|iov
argument_list|,
name|iovlen
argument_list|,
name|auth_off
argument_list|,
name|auth_len
argument_list|,
name|crypt_off
argument_list|,
name|crypt_len
argument_list|,
name|icv_off
argument_list|,
name|ivp
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|IOV_INIT
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|CVMX_PREFETCH0
argument_list|(
name|ivp
argument_list|)
expr_stmt|;
name|CVMX_PREFETCH0
argument_list|(
name|od
operator|->
name|octo_enckey
argument_list|)
expr_stmt|;
name|s
operator|=
name|octeon_crypto_enable
argument_list|()
expr_stmt|;
comment|/* load AES Key */
name|CVMX_MT_AES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MT_AES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|1
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|od
operator|->
name|octo_encklen
operator|==
literal|16
condition|)
block|{
name|CVMX_MT_AES_KEY
argument_list|(
literal|0x0
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|CVMX_MT_AES_KEY
argument_list|(
literal|0x0
argument_list|,
literal|3
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|od
operator|->
name|octo_encklen
operator|==
literal|24
condition|)
block|{
name|CVMX_MT_AES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|2
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|CVMX_MT_AES_KEY
argument_list|(
literal|0x0
argument_list|,
literal|3
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|od
operator|->
name|octo_encklen
operator|==
literal|32
condition|)
block|{
name|CVMX_MT_AES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|2
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|CVMX_MT_AES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|3
index|]
argument_list|,
literal|3
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|octeon_crypto_disable
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|dprintf
argument_list|(
literal|"%s: Bad key length %d\n"
argument_list|,
name|__func__
argument_list|,
name|od
operator|->
name|octo_encklen
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|CVMX_MT_AES_KEYLENGTH
argument_list|(
name|od
operator|->
name|octo_encklen
operator|/
literal|8
operator|-
literal|1
argument_list|)
expr_stmt|;
name|CVMX_MT_AES_IV
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|ivp
operator|)
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MT_AES_IV
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|ivp
operator|)
index|[
literal|1
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* Load MD5 IV */
name|CVMX_MT_HSH_IV
argument_list|(
name|od
operator|->
name|octo_hminner
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_IV
argument_list|(
name|od
operator|->
name|octo_hminner
index|[
literal|1
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
while|while
condition|(
name|crypt_off
operator|>
literal|0
operator|&&
name|auth_off
operator|>
literal|0
condition|)
block|{
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|crypt_off
operator|-=
literal|4
expr_stmt|;
name|auth_off
operator|-=
literal|4
expr_stmt|;
block|}
while|while
condition|(
name|crypt_len
operator|>
literal|0
operator|||
name|auth_len
operator|>
literal|0
condition|)
block|{
name|uint32_t
modifier|*
name|pdata32
index|[
literal|3
index|]
decl_stmt|;
name|pdata32
index|[
literal|0
index|]
operator|=
name|data32
expr_stmt|;
name|mydata
index|[
literal|0
index|]
operator|.
name|data32
index|[
literal|0
index|]
operator|=
operator|*
name|data32
expr_stmt|;
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|pdata32
index|[
literal|1
index|]
operator|=
name|data32
expr_stmt|;
name|mydata
index|[
literal|0
index|]
operator|.
name|data32
index|[
literal|1
index|]
operator|=
operator|*
name|data32
expr_stmt|;
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|pdata32
index|[
literal|2
index|]
operator|=
name|data32
expr_stmt|;
name|mydata
index|[
literal|1
index|]
operator|.
name|data32
index|[
literal|0
index|]
operator|=
operator|*
name|data32
expr_stmt|;
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|mydata
index|[
literal|1
index|]
operator|.
name|data32
index|[
literal|1
index|]
operator|=
operator|*
name|data32
expr_stmt|;
if|if
condition|(
name|auth_off
operator|<=
literal|0
condition|)
block|{
if|if
condition|(
name|auth_len
operator|>
literal|0
condition|)
block|{
name|CVM_LOAD_MD5_UNIT
argument_list|(
operator|*
name|pdata
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|CVM_LOAD_MD5_UNIT
argument_list|(
operator|*
name|data
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|auth_len
operator|-=
literal|16
expr_stmt|;
block|}
block|}
else|else
name|auth_off
operator|-=
literal|16
expr_stmt|;
if|if
condition|(
name|crypt_off
operator|<=
literal|0
condition|)
block|{
if|if
condition|(
name|crypt_len
operator|>
literal|0
condition|)
block|{
name|CVMX_MT_AES_DEC_CBC0
argument_list|(
operator|*
name|pdata
argument_list|)
expr_stmt|;
name|CVMX_MT_AES_DEC_CBC1
argument_list|(
operator|*
name|data
argument_list|)
expr_stmt|;
name|CVMX_MF_AES_RESULT
argument_list|(
operator|*
name|pdata
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MF_AES_RESULT
argument_list|(
operator|*
name|data
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|crypt_len
operator|-=
literal|16
expr_stmt|;
block|}
block|}
else|else
name|crypt_off
operator|-=
literal|16
expr_stmt|;
operator|*
name|pdata32
index|[
literal|0
index|]
operator|=
name|mydata
index|[
literal|0
index|]
operator|.
name|data32
index|[
literal|0
index|]
expr_stmt|;
operator|*
name|pdata32
index|[
literal|1
index|]
operator|=
name|mydata
index|[
literal|0
index|]
operator|.
name|data32
index|[
literal|1
index|]
expr_stmt|;
operator|*
name|pdata32
index|[
literal|2
index|]
operator|=
name|mydata
index|[
literal|1
index|]
operator|.
name|data32
index|[
literal|0
index|]
expr_stmt|;
operator|*
name|data32
operator|=
name|mydata
index|[
literal|1
index|]
operator|.
name|data32
index|[
literal|1
index|]
expr_stmt|;
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
block|}
comment|/* finish the hash */
name|CVMX_PREFETCH0
argument_list|(
name|od
operator|->
name|octo_hmouter
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|if (__predict_false(inplen)) { 	uint64_t tmp = 0; 	uint8_t *p = (uint8_t *)& tmp; 	p[inplen] = 0x80; 	do { 	    inplen--; 	    p[inplen] = ((uint8_t *) data)[inplen]; 	} while (inplen); 	CVM_LOAD_MD5_UNIT(tmp, next);     } else { 	CVM_LOAD_MD5_UNIT(0x8000000000000000ULL, next);     }
else|#
directive|else
name|CVM_LOAD_MD5_UNIT
argument_list|(
literal|0x8000000000000000ULL
argument_list|,
name|next
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* Finish Inner hash */
while|while
condition|(
name|next
operator|!=
literal|7
condition|)
block|{
name|CVM_LOAD_MD5_UNIT
argument_list|(
operator|(
operator|(
name|uint64_t
operator|)
literal|0x0ULL
operator|)
argument_list|,
name|next
argument_list|)
expr_stmt|;
block|}
name|CVMX_ES64
argument_list|(
name|tmp1
argument_list|,
operator|(
operator|(
name|alen
operator|+
literal|64
operator|)
operator|<<
literal|3
operator|)
argument_list|)
expr_stmt|;
name|CVM_LOAD_MD5_UNIT
argument_list|(
name|tmp1
argument_list|,
name|next
argument_list|)
expr_stmt|;
comment|/* Get the inner hash of HMAC */
name|CVMX_MF_HSH_IV
argument_list|(
name|tmp1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MF_HSH_IV
argument_list|(
name|tmp2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* Initialize hash unit */
name|CVMX_MT_HSH_IV
argument_list|(
name|od
operator|->
name|octo_hmouter
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_IV
argument_list|(
name|od
operator|->
name|octo_hmouter
index|[
literal|1
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DAT
argument_list|(
name|tmp1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DAT
argument_list|(
name|tmp2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DAT
argument_list|(
literal|0x8000000000000000ULL
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DATZ
argument_list|(
literal|3
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DATZ
argument_list|(
literal|4
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DATZ
argument_list|(
literal|5
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DATZ
argument_list|(
literal|6
argument_list|)
expr_stmt|;
name|CVMX_ES64
argument_list|(
name|tmp1
argument_list|,
operator|(
operator|(
literal|64
operator|+
literal|16
operator|)
operator|<<
literal|3
operator|)
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_STARTMD5
argument_list|(
name|tmp1
argument_list|)
expr_stmt|;
comment|/* save the HMAC */
name|IOV_INIT
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
while|while
condition|(
name|icv_off
operator|>
literal|0
condition|)
block|{
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|icv_off
operator|-=
literal|4
expr_stmt|;
block|}
name|CVMX_MF_HSH_IV
argument_list|(
name|tmp1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|*
name|data32
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|tmp1
operator|>>
literal|32
argument_list|)
expr_stmt|;
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
operator|*
name|data32
operator|=
operator|(
name|uint32_t
operator|)
name|tmp1
expr_stmt|;
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|CVMX_MF_HSH_IV
argument_list|(
name|tmp1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
operator|*
name|data32
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|tmp1
operator|>>
literal|32
argument_list|)
expr_stmt|;
name|octeon_crypto_disable
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/****************************************************************************/
end_comment

begin_comment
comment|/* AES SHA1 */
end_comment

begin_function
name|int
name|octo_aes_cbc_sha1_encrypt
parameter_list|(
name|struct
name|octo_sess
modifier|*
name|od
parameter_list|,
name|struct
name|iovec
modifier|*
name|iov
parameter_list|,
name|size_t
name|iovcnt
parameter_list|,
name|size_t
name|iovlen
parameter_list|,
name|int
name|auth_off
parameter_list|,
name|int
name|auth_len
parameter_list|,
name|int
name|crypt_off
parameter_list|,
name|int
name|crypt_len
parameter_list|,
name|int
name|icv_off
parameter_list|,
name|uint8_t
modifier|*
name|ivp
parameter_list|)
block|{
specifier|register
name|int
name|next
init|=
literal|0
decl_stmt|;
union|union
block|{
name|uint32_t
name|data32
index|[
literal|2
index|]
decl_stmt|;
name|uint64_t
name|data64
index|[
literal|1
index|]
decl_stmt|;
block|}
name|mydata
index|[
literal|2
index|]
union|;
name|uint64_t
modifier|*
name|pdata
init|=
operator|&
name|mydata
index|[
literal|0
index|]
operator|.
name|data64
index|[
literal|0
index|]
decl_stmt|;
name|uint64_t
modifier|*
name|data
init|=
operator|&
name|mydata
index|[
literal|1
index|]
operator|.
name|data64
index|[
literal|0
index|]
decl_stmt|;
name|uint32_t
modifier|*
name|data32
decl_stmt|;
name|uint64_t
name|tmp1
decl_stmt|,
name|tmp2
decl_stmt|,
name|tmp3
decl_stmt|;
name|int
name|data_i
decl_stmt|,
name|data_l
decl_stmt|,
name|alen
init|=
name|auth_len
decl_stmt|;
name|register_t
name|s
decl_stmt|;
name|dprintf
argument_list|(
literal|"%s()\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
name|__predict_false
argument_list|(
name|od
operator|==
name|NULL
operator|||
name|iov
operator|==
name|NULL
operator|||
name|iovlen
operator|==
literal|0
operator|||
name|ivp
operator|==
name|NULL
operator|||
operator|(
name|crypt_off
operator|&
literal|0x3
operator|)
operator|||
operator|(
name|crypt_off
operator|+
name|crypt_len
operator|>
name|iovlen
operator|)
operator|||
operator|(
name|crypt_len
operator|&
literal|0x7
operator|)
operator|||
operator|(
name|auth_len
operator|&
literal|0x7
operator|)
operator|||
operator|(
name|auth_off
operator|&
literal|0x3
operator|)
operator|||
operator|(
name|auth_off
operator|+
name|auth_len
operator|>
name|iovlen
operator|)
argument_list|)
condition|)
block|{
name|dprintf
argument_list|(
literal|"%s: Bad parameters od=%p iov=%p iovlen=%jd "
literal|"auth_off=%d auth_len=%d crypt_off=%d crypt_len=%d "
literal|"icv_off=%d ivp=%p\n"
argument_list|,
name|__func__
argument_list|,
name|od
argument_list|,
name|iov
argument_list|,
name|iovlen
argument_list|,
name|auth_off
argument_list|,
name|auth_len
argument_list|,
name|crypt_off
argument_list|,
name|crypt_len
argument_list|,
name|icv_off
argument_list|,
name|ivp
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|IOV_INIT
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|CVMX_PREFETCH0
argument_list|(
name|ivp
argument_list|)
expr_stmt|;
name|CVMX_PREFETCH0
argument_list|(
name|od
operator|->
name|octo_enckey
argument_list|)
expr_stmt|;
name|s
operator|=
name|octeon_crypto_enable
argument_list|()
expr_stmt|;
comment|/* load AES Key */
name|CVMX_MT_AES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MT_AES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|1
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|od
operator|->
name|octo_encklen
operator|==
literal|16
condition|)
block|{
name|CVMX_MT_AES_KEY
argument_list|(
literal|0x0
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|CVMX_MT_AES_KEY
argument_list|(
literal|0x0
argument_list|,
literal|3
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|od
operator|->
name|octo_encklen
operator|==
literal|24
condition|)
block|{
name|CVMX_MT_AES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|2
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|CVMX_MT_AES_KEY
argument_list|(
literal|0x0
argument_list|,
literal|3
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|od
operator|->
name|octo_encklen
operator|==
literal|32
condition|)
block|{
name|CVMX_MT_AES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|2
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|CVMX_MT_AES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|3
index|]
argument_list|,
literal|3
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|octeon_crypto_disable
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|dprintf
argument_list|(
literal|"%s: Bad key length %d\n"
argument_list|,
name|__func__
argument_list|,
name|od
operator|->
name|octo_encklen
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|CVMX_MT_AES_KEYLENGTH
argument_list|(
name|od
operator|->
name|octo_encklen
operator|/
literal|8
operator|-
literal|1
argument_list|)
expr_stmt|;
name|CVMX_MT_AES_IV
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|ivp
operator|)
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MT_AES_IV
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|ivp
operator|)
index|[
literal|1
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* Load SHA IV */
name|CVMX_MT_HSH_IV
argument_list|(
name|od
operator|->
name|octo_hminner
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_IV
argument_list|(
name|od
operator|->
name|octo_hminner
index|[
literal|1
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_IV
argument_list|(
name|od
operator|->
name|octo_hminner
index|[
literal|2
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
while|while
condition|(
name|crypt_off
operator|>
literal|0
operator|&&
name|auth_off
operator|>
literal|0
condition|)
block|{
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|crypt_off
operator|-=
literal|4
expr_stmt|;
name|auth_off
operator|-=
literal|4
expr_stmt|;
block|}
while|while
condition|(
name|crypt_len
operator|>
literal|0
operator|||
name|auth_len
operator|>
literal|0
condition|)
block|{
name|uint32_t
modifier|*
name|pdata32
index|[
literal|3
index|]
decl_stmt|;
name|pdata32
index|[
literal|0
index|]
operator|=
name|data32
expr_stmt|;
name|mydata
index|[
literal|0
index|]
operator|.
name|data32
index|[
literal|0
index|]
operator|=
operator|*
name|data32
expr_stmt|;
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|pdata32
index|[
literal|1
index|]
operator|=
name|data32
expr_stmt|;
name|mydata
index|[
literal|0
index|]
operator|.
name|data32
index|[
literal|1
index|]
operator|=
operator|*
name|data32
expr_stmt|;
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|pdata32
index|[
literal|2
index|]
operator|=
name|data32
expr_stmt|;
name|mydata
index|[
literal|1
index|]
operator|.
name|data32
index|[
literal|0
index|]
operator|=
operator|*
name|data32
expr_stmt|;
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|mydata
index|[
literal|1
index|]
operator|.
name|data32
index|[
literal|1
index|]
operator|=
operator|*
name|data32
expr_stmt|;
if|if
condition|(
name|crypt_off
operator|<=
literal|0
condition|)
block|{
if|if
condition|(
name|crypt_len
operator|>
literal|0
condition|)
block|{
name|CVMX_MT_AES_ENC_CBC0
argument_list|(
operator|*
name|pdata
argument_list|)
expr_stmt|;
name|CVMX_MT_AES_ENC_CBC1
argument_list|(
operator|*
name|data
argument_list|)
expr_stmt|;
name|CVMX_MF_AES_RESULT
argument_list|(
operator|*
name|pdata
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MF_AES_RESULT
argument_list|(
operator|*
name|data
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|crypt_len
operator|-=
literal|16
expr_stmt|;
block|}
block|}
else|else
name|crypt_off
operator|-=
literal|16
expr_stmt|;
if|if
condition|(
name|auth_off
operator|<=
literal|0
condition|)
block|{
if|if
condition|(
name|auth_len
operator|>
literal|0
condition|)
block|{
name|CVM_LOAD_SHA_UNIT
argument_list|(
operator|*
name|pdata
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|CVM_LOAD_SHA_UNIT
argument_list|(
operator|*
name|data
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|auth_len
operator|-=
literal|16
expr_stmt|;
block|}
block|}
else|else
name|auth_off
operator|-=
literal|16
expr_stmt|;
operator|*
name|pdata32
index|[
literal|0
index|]
operator|=
name|mydata
index|[
literal|0
index|]
operator|.
name|data32
index|[
literal|0
index|]
expr_stmt|;
operator|*
name|pdata32
index|[
literal|1
index|]
operator|=
name|mydata
index|[
literal|0
index|]
operator|.
name|data32
index|[
literal|1
index|]
expr_stmt|;
operator|*
name|pdata32
index|[
literal|2
index|]
operator|=
name|mydata
index|[
literal|1
index|]
operator|.
name|data32
index|[
literal|0
index|]
expr_stmt|;
operator|*
name|data32
operator|=
name|mydata
index|[
literal|1
index|]
operator|.
name|data32
index|[
literal|1
index|]
expr_stmt|;
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
block|}
comment|/* finish the hash */
name|CVMX_PREFETCH0
argument_list|(
name|od
operator|->
name|octo_hmouter
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|if (__predict_false(inplen)) { 	uint64_t tmp = 0; 	uint8_t *p = (uint8_t *)& tmp; 	p[inplen] = 0x80; 	do { 	    inplen--; 	    p[inplen] = ((uint8_t *) data)[inplen]; 	} while (inplen); 	CVM_LOAD_SHA_UNIT(tmp, next);     } else { 	CVM_LOAD_SHA_UNIT(0x8000000000000000ULL, next);     }
else|#
directive|else
name|CVM_LOAD_SHA_UNIT
argument_list|(
literal|0x8000000000000000ULL
argument_list|,
name|next
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* Finish Inner hash */
while|while
condition|(
name|next
operator|!=
literal|7
condition|)
block|{
name|CVM_LOAD_SHA_UNIT
argument_list|(
operator|(
operator|(
name|uint64_t
operator|)
literal|0x0ULL
operator|)
argument_list|,
name|next
argument_list|)
expr_stmt|;
block|}
name|CVM_LOAD_SHA_UNIT
argument_list|(
call|(
name|uint64_t
call|)
argument_list|(
operator|(
name|alen
operator|+
literal|64
operator|)
operator|<<
literal|3
argument_list|)
argument_list|,
name|next
argument_list|)
expr_stmt|;
comment|/* Get the inner hash of HMAC */
name|CVMX_MF_HSH_IV
argument_list|(
name|tmp1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MF_HSH_IV
argument_list|(
name|tmp2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|tmp3
operator|=
literal|0
expr_stmt|;
name|CVMX_MF_HSH_IV
argument_list|(
name|tmp3
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* Initialize hash unit */
name|CVMX_MT_HSH_IV
argument_list|(
name|od
operator|->
name|octo_hmouter
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_IV
argument_list|(
name|od
operator|->
name|octo_hmouter
index|[
literal|1
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_IV
argument_list|(
name|od
operator|->
name|octo_hmouter
index|[
literal|2
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DAT
argument_list|(
name|tmp1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DAT
argument_list|(
name|tmp2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|tmp3
operator||=
literal|0x0000000080000000
expr_stmt|;
name|CVMX_MT_HSH_DAT
argument_list|(
name|tmp3
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DATZ
argument_list|(
literal|3
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DATZ
argument_list|(
literal|4
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DATZ
argument_list|(
literal|5
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DATZ
argument_list|(
literal|6
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_STARTSHA
argument_list|(
call|(
name|uint64_t
call|)
argument_list|(
operator|(
literal|64
operator|+
literal|20
operator|)
operator|<<
literal|3
argument_list|)
argument_list|)
expr_stmt|;
comment|/* finish the hash */
name|CVMX_PREFETCH0
argument_list|(
name|od
operator|->
name|octo_hmouter
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|if (__predict_false(inplen)) { 	uint64_t tmp = 0; 	uint8_t *p = (uint8_t *)& tmp; 	p[inplen] = 0x80; 	do { 	    inplen--; 	    p[inplen] = ((uint8_t *) data)[inplen]; 	} while (inplen); 	CVM_LOAD_MD5_UNIT(tmp, next);     } else { 	CVM_LOAD_MD5_UNIT(0x8000000000000000ULL, next);     }
else|#
directive|else
name|CVM_LOAD_MD5_UNIT
argument_list|(
literal|0x8000000000000000ULL
argument_list|,
name|next
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* save the HMAC */
name|IOV_INIT
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
while|while
condition|(
name|icv_off
operator|>
literal|0
condition|)
block|{
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|icv_off
operator|-=
literal|4
expr_stmt|;
block|}
name|CVMX_MF_HSH_IV
argument_list|(
name|tmp1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|*
name|data32
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|tmp1
operator|>>
literal|32
argument_list|)
expr_stmt|;
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
operator|*
name|data32
operator|=
operator|(
name|uint32_t
operator|)
name|tmp1
expr_stmt|;
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|CVMX_MF_HSH_IV
argument_list|(
name|tmp1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
operator|*
name|data32
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|tmp1
operator|>>
literal|32
argument_list|)
expr_stmt|;
name|octeon_crypto_disable
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|octo_aes_cbc_sha1_decrypt
parameter_list|(
name|struct
name|octo_sess
modifier|*
name|od
parameter_list|,
name|struct
name|iovec
modifier|*
name|iov
parameter_list|,
name|size_t
name|iovcnt
parameter_list|,
name|size_t
name|iovlen
parameter_list|,
name|int
name|auth_off
parameter_list|,
name|int
name|auth_len
parameter_list|,
name|int
name|crypt_off
parameter_list|,
name|int
name|crypt_len
parameter_list|,
name|int
name|icv_off
parameter_list|,
name|uint8_t
modifier|*
name|ivp
parameter_list|)
block|{
specifier|register
name|int
name|next
init|=
literal|0
decl_stmt|;
union|union
block|{
name|uint32_t
name|data32
index|[
literal|2
index|]
decl_stmt|;
name|uint64_t
name|data64
index|[
literal|1
index|]
decl_stmt|;
block|}
name|mydata
index|[
literal|2
index|]
union|;
name|uint64_t
modifier|*
name|pdata
init|=
operator|&
name|mydata
index|[
literal|0
index|]
operator|.
name|data64
index|[
literal|0
index|]
decl_stmt|;
name|uint64_t
modifier|*
name|data
init|=
operator|&
name|mydata
index|[
literal|1
index|]
operator|.
name|data64
index|[
literal|0
index|]
decl_stmt|;
name|uint32_t
modifier|*
name|data32
decl_stmt|;
name|uint64_t
name|tmp1
decl_stmt|,
name|tmp2
decl_stmt|,
name|tmp3
decl_stmt|;
name|int
name|data_i
decl_stmt|,
name|data_l
decl_stmt|,
name|alen
init|=
name|auth_len
decl_stmt|;
name|register_t
name|s
decl_stmt|;
name|dprintf
argument_list|(
literal|"%s()\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
name|__predict_false
argument_list|(
name|od
operator|==
name|NULL
operator|||
name|iov
operator|==
name|NULL
operator|||
name|iovlen
operator|==
literal|0
operator|||
name|ivp
operator|==
name|NULL
operator|||
operator|(
name|crypt_off
operator|&
literal|0x3
operator|)
operator|||
operator|(
name|crypt_off
operator|+
name|crypt_len
operator|>
name|iovlen
operator|)
operator|||
operator|(
name|crypt_len
operator|&
literal|0x7
operator|)
operator|||
operator|(
name|auth_len
operator|&
literal|0x7
operator|)
operator|||
operator|(
name|auth_off
operator|&
literal|0x3
operator|)
operator|||
operator|(
name|auth_off
operator|+
name|auth_len
operator|>
name|iovlen
operator|)
argument_list|)
condition|)
block|{
name|dprintf
argument_list|(
literal|"%s: Bad parameters od=%p iov=%p iovlen=%jd "
literal|"auth_off=%d auth_len=%d crypt_off=%d crypt_len=%d "
literal|"icv_off=%d ivp=%p\n"
argument_list|,
name|__func__
argument_list|,
name|od
argument_list|,
name|iov
argument_list|,
name|iovlen
argument_list|,
name|auth_off
argument_list|,
name|auth_len
argument_list|,
name|crypt_off
argument_list|,
name|crypt_len
argument_list|,
name|icv_off
argument_list|,
name|ivp
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|IOV_INIT
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|CVMX_PREFETCH0
argument_list|(
name|ivp
argument_list|)
expr_stmt|;
name|CVMX_PREFETCH0
argument_list|(
name|od
operator|->
name|octo_enckey
argument_list|)
expr_stmt|;
name|s
operator|=
name|octeon_crypto_enable
argument_list|()
expr_stmt|;
comment|/* load AES Key */
name|CVMX_MT_AES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MT_AES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|1
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|od
operator|->
name|octo_encklen
operator|==
literal|16
condition|)
block|{
name|CVMX_MT_AES_KEY
argument_list|(
literal|0x0
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|CVMX_MT_AES_KEY
argument_list|(
literal|0x0
argument_list|,
literal|3
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|od
operator|->
name|octo_encklen
operator|==
literal|24
condition|)
block|{
name|CVMX_MT_AES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|2
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|CVMX_MT_AES_KEY
argument_list|(
literal|0x0
argument_list|,
literal|3
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|od
operator|->
name|octo_encklen
operator|==
literal|32
condition|)
block|{
name|CVMX_MT_AES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|2
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|CVMX_MT_AES_KEY
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|od
operator|->
name|octo_enckey
operator|)
index|[
literal|3
index|]
argument_list|,
literal|3
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|octeon_crypto_disable
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|dprintf
argument_list|(
literal|"%s: Bad key length %d\n"
argument_list|,
name|__func__
argument_list|,
name|od
operator|->
name|octo_encklen
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|CVMX_MT_AES_KEYLENGTH
argument_list|(
name|od
operator|->
name|octo_encklen
operator|/
literal|8
operator|-
literal|1
argument_list|)
expr_stmt|;
name|CVMX_MT_AES_IV
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|ivp
operator|)
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MT_AES_IV
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|ivp
operator|)
index|[
literal|1
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* Load MD5 IV */
name|CVMX_MT_HSH_IV
argument_list|(
name|od
operator|->
name|octo_hminner
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_IV
argument_list|(
name|od
operator|->
name|octo_hminner
index|[
literal|1
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_IV
argument_list|(
name|od
operator|->
name|octo_hminner
index|[
literal|2
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
while|while
condition|(
name|crypt_off
operator|>
literal|0
operator|&&
name|auth_off
operator|>
literal|0
condition|)
block|{
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|crypt_off
operator|-=
literal|4
expr_stmt|;
name|auth_off
operator|-=
literal|4
expr_stmt|;
block|}
while|while
condition|(
name|crypt_len
operator|>
literal|0
operator|||
name|auth_len
operator|>
literal|0
condition|)
block|{
name|uint32_t
modifier|*
name|pdata32
index|[
literal|3
index|]
decl_stmt|;
name|pdata32
index|[
literal|0
index|]
operator|=
name|data32
expr_stmt|;
name|mydata
index|[
literal|0
index|]
operator|.
name|data32
index|[
literal|0
index|]
operator|=
operator|*
name|data32
expr_stmt|;
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|pdata32
index|[
literal|1
index|]
operator|=
name|data32
expr_stmt|;
name|mydata
index|[
literal|0
index|]
operator|.
name|data32
index|[
literal|1
index|]
operator|=
operator|*
name|data32
expr_stmt|;
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|pdata32
index|[
literal|2
index|]
operator|=
name|data32
expr_stmt|;
name|mydata
index|[
literal|1
index|]
operator|.
name|data32
index|[
literal|0
index|]
operator|=
operator|*
name|data32
expr_stmt|;
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|mydata
index|[
literal|1
index|]
operator|.
name|data32
index|[
literal|1
index|]
operator|=
operator|*
name|data32
expr_stmt|;
if|if
condition|(
name|auth_off
operator|<=
literal|0
condition|)
block|{
if|if
condition|(
name|auth_len
operator|>
literal|0
condition|)
block|{
name|CVM_LOAD_SHA_UNIT
argument_list|(
operator|*
name|pdata
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|CVM_LOAD_SHA_UNIT
argument_list|(
operator|*
name|data
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|auth_len
operator|-=
literal|16
expr_stmt|;
block|}
block|}
else|else
name|auth_off
operator|-=
literal|16
expr_stmt|;
if|if
condition|(
name|crypt_off
operator|<=
literal|0
condition|)
block|{
if|if
condition|(
name|crypt_len
operator|>
literal|0
condition|)
block|{
name|CVMX_MT_AES_DEC_CBC0
argument_list|(
operator|*
name|pdata
argument_list|)
expr_stmt|;
name|CVMX_MT_AES_DEC_CBC1
argument_list|(
operator|*
name|data
argument_list|)
expr_stmt|;
name|CVMX_MF_AES_RESULT
argument_list|(
operator|*
name|pdata
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MF_AES_RESULT
argument_list|(
operator|*
name|data
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|crypt_len
operator|-=
literal|16
expr_stmt|;
block|}
block|}
else|else
name|crypt_off
operator|-=
literal|16
expr_stmt|;
operator|*
name|pdata32
index|[
literal|0
index|]
operator|=
name|mydata
index|[
literal|0
index|]
operator|.
name|data32
index|[
literal|0
index|]
expr_stmt|;
operator|*
name|pdata32
index|[
literal|1
index|]
operator|=
name|mydata
index|[
literal|0
index|]
operator|.
name|data32
index|[
literal|1
index|]
expr_stmt|;
operator|*
name|pdata32
index|[
literal|2
index|]
operator|=
name|mydata
index|[
literal|1
index|]
operator|.
name|data32
index|[
literal|0
index|]
expr_stmt|;
operator|*
name|data32
operator|=
name|mydata
index|[
literal|1
index|]
operator|.
name|data32
index|[
literal|1
index|]
expr_stmt|;
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
block|}
comment|/* finish the hash */
name|CVMX_PREFETCH0
argument_list|(
name|od
operator|->
name|octo_hmouter
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|if (__predict_false(inplen)) { 	uint64_t tmp = 0; 	uint8_t *p = (uint8_t *)& tmp; 	p[inplen] = 0x80; 	do { 	    inplen--; 	    p[inplen] = ((uint8_t *) data)[inplen]; 	} while (inplen); 	CVM_LOAD_SHA_UNIT(tmp, next);     } else { 	CVM_LOAD_SHA_UNIT(0x8000000000000000ULL, next);     }
else|#
directive|else
name|CVM_LOAD_SHA_UNIT
argument_list|(
literal|0x8000000000000000ULL
argument_list|,
name|next
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* Finish Inner hash */
while|while
condition|(
name|next
operator|!=
literal|7
condition|)
block|{
name|CVM_LOAD_SHA_UNIT
argument_list|(
operator|(
operator|(
name|uint64_t
operator|)
literal|0x0ULL
operator|)
argument_list|,
name|next
argument_list|)
expr_stmt|;
block|}
name|CVM_LOAD_SHA_UNIT
argument_list|(
call|(
name|uint64_t
call|)
argument_list|(
operator|(
name|alen
operator|+
literal|64
operator|)
operator|<<
literal|3
argument_list|)
argument_list|,
name|next
argument_list|)
expr_stmt|;
comment|/* Get the inner hash of HMAC */
name|CVMX_MF_HSH_IV
argument_list|(
name|tmp1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MF_HSH_IV
argument_list|(
name|tmp2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|tmp3
operator|=
literal|0
expr_stmt|;
name|CVMX_MF_HSH_IV
argument_list|(
name|tmp3
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* Initialize hash unit */
name|CVMX_MT_HSH_IV
argument_list|(
name|od
operator|->
name|octo_hmouter
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_IV
argument_list|(
name|od
operator|->
name|octo_hmouter
index|[
literal|1
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_IV
argument_list|(
name|od
operator|->
name|octo_hmouter
index|[
literal|2
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DAT
argument_list|(
name|tmp1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DAT
argument_list|(
name|tmp2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|tmp3
operator||=
literal|0x0000000080000000
expr_stmt|;
name|CVMX_MT_HSH_DAT
argument_list|(
name|tmp3
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DATZ
argument_list|(
literal|3
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DATZ
argument_list|(
literal|4
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DATZ
argument_list|(
literal|5
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_DATZ
argument_list|(
literal|6
argument_list|)
expr_stmt|;
name|CVMX_MT_HSH_STARTSHA
argument_list|(
call|(
name|uint64_t
call|)
argument_list|(
operator|(
literal|64
operator|+
literal|20
operator|)
operator|<<
literal|3
argument_list|)
argument_list|)
expr_stmt|;
comment|/* finish the hash */
name|CVMX_PREFETCH0
argument_list|(
name|od
operator|->
name|octo_hmouter
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|if (__predict_false(inplen)) { 	uint64_t tmp = 0; 	uint8_t *p = (uint8_t *)& tmp; 	p[inplen] = 0x80; 	do { 	    inplen--; 	    p[inplen] = ((uint8_t *) data)[inplen]; 	} while (inplen); 	CVM_LOAD_MD5_UNIT(tmp, next);     } else { 	CVM_LOAD_MD5_UNIT(0x8000000000000000ULL, next);     }
else|#
directive|else
name|CVM_LOAD_MD5_UNIT
argument_list|(
literal|0x8000000000000000ULL
argument_list|,
name|next
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* save the HMAC */
name|IOV_INIT
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
while|while
condition|(
name|icv_off
operator|>
literal|0
condition|)
block|{
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|icv_off
operator|-=
literal|4
expr_stmt|;
block|}
name|CVMX_MF_HSH_IV
argument_list|(
name|tmp1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|*
name|data32
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|tmp1
operator|>>
literal|32
argument_list|)
expr_stmt|;
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
operator|*
name|data32
operator|=
operator|(
name|uint32_t
operator|)
name|tmp1
expr_stmt|;
name|IOV_CONSUME
argument_list|(
name|iov
argument_list|,
name|data32
argument_list|,
name|data_i
argument_list|,
name|data_l
argument_list|)
expr_stmt|;
name|CVMX_MF_HSH_IV
argument_list|(
name|tmp1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
operator|*
name|data32
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|tmp1
operator|>>
literal|32
argument_list|)
expr_stmt|;
name|octeon_crypto_disable
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/****************************************************************************/
end_comment

end_unit


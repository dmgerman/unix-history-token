begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*------------------------------------------------------------------  * octeon_fpa.c        Free Pool Allocator  *  *------------------------------------------------------------------  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm.h>
end_include

begin_include
include|#
directive|include
file|<vm/pmap.h>
end_include

begin_include
include|#
directive|include
file|<mips/cavium/octeon_pcmap_regs.h>
end_include

begin_include
include|#
directive|include
file|"octeon_fpa.h"
end_include

begin_define
define|#
directive|define
name|FPA_DEBUG
value|1
end_define

begin_comment
comment|/*  * octeon_dump_fpa  *  */
end_comment

begin_function
name|void
name|octeon_dump_fpa
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|octeon_fpa_ctl_status_t
name|status
decl_stmt|;
name|octeon_fpa_queue_available_t
name|q_avail
decl_stmt|;
name|status
operator|.
name|word64
operator|=
name|oct_read64
argument_list|(
name|OCTEON_FPA_CTL_STATUS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|status
operator|.
name|bits
operator|.
name|enb
condition|)
block|{
name|printf
argument_list|(
literal|"\n  FPA Disabled"
argument_list|)
expr_stmt|;
comment|/*          * No dumping if disabled          */
return|return;
block|}
name|printf
argument_list|(
literal|" FPA  Ctrl-Status-reg 0x%llX := 0x%llX  EN %X  M1_E %X  M0_E %X\n"
argument_list|,
name|OCTEON_FPA_CTL_STATUS
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|status
operator|.
name|word64
argument_list|,
name|status
operator|.
name|bits
operator|.
name|enb
argument_list|,
name|status
operator|.
name|bits
operator|.
name|mem1_err
argument_list|,
name|status
operator|.
name|bits
operator|.
name|mem0_err
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|OCTEON_FPA_QUEUES
condition|;
name|i
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"   Pool: %d\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|q_avail
operator|.
name|word64
operator|=
name|oct_read64
argument_list|(
operator|(
name|OCTEON_FPA_QUEUE_AVAILABLE
operator|+
operator|(
name|i
operator|)
operator|*
literal|8ull
operator|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"   Avail-reg 0x%llX :=   Size: 0x%X\n"
argument_list|,
operator|(
name|OCTEON_FPA_QUEUE_AVAILABLE
operator|+
operator|(
name|i
operator|)
operator|*
literal|8ull
operator|)
argument_list|,
name|q_avail
operator|.
name|bits
operator|.
name|queue_size
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|octeon_dump_fpa_pool
parameter_list|(
name|u_int
name|pool
parameter_list|)
block|{
name|octeon_fpa_ctl_status_t
name|status
decl_stmt|;
name|octeon_fpa_queue_available_t
name|q_avail
decl_stmt|;
name|status
operator|.
name|word64
operator|=
name|oct_read64
argument_list|(
name|OCTEON_FPA_CTL_STATUS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|status
operator|.
name|bits
operator|.
name|enb
condition|)
block|{
name|printf
argument_list|(
literal|"\n  FPA Disabled"
argument_list|)
expr_stmt|;
comment|/*          * No dumping if disabled          */
return|return;
block|}
name|printf
argument_list|(
literal|" FPA  Ctrl-Status-reg 0x%llX := 0x%llX  EN %X  M1_E %X  M0_E %X\n"
argument_list|,
name|OCTEON_FPA_CTL_STATUS
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|status
operator|.
name|word64
argument_list|,
name|status
operator|.
name|bits
operator|.
name|enb
argument_list|,
name|status
operator|.
name|bits
operator|.
name|mem1_err
argument_list|,
name|status
operator|.
name|bits
operator|.
name|mem0_err
argument_list|)
expr_stmt|;
name|q_avail
operator|.
name|word64
operator|=
name|oct_read64
argument_list|(
operator|(
name|OCTEON_FPA_QUEUE_AVAILABLE
operator|+
operator|(
name|pool
operator|)
operator|*
literal|8ull
operator|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"   FPA Pool: %u   Avail-reg 0x%llX :=   Size: 0x%X\n"
argument_list|,
name|pool
argument_list|,
operator|(
name|OCTEON_FPA_QUEUE_AVAILABLE
operator|+
operator|(
name|pool
operator|)
operator|*
literal|8ull
operator|)
argument_list|,
name|q_avail
operator|.
name|bits
operator|.
name|queue_size
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|u_int
name|octeon_fpa_pool_size
parameter_list|(
name|u_int
name|pool
parameter_list|)
block|{
name|octeon_fpa_queue_available_t
name|q_avail
decl_stmt|;
name|u_int
name|size
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|pool
operator|<
literal|7
condition|)
block|{
name|q_avail
operator|.
name|word64
operator|=
name|oct_read64
argument_list|(
operator|(
name|OCTEON_FPA_QUEUE_AVAILABLE
operator|+
operator|(
name|pool
operator|)
operator|*
literal|8ull
operator|)
argument_list|)
expr_stmt|;
name|size
operator|=
name|q_avail
operator|.
name|bits
operator|.
name|queue_size
expr_stmt|;
block|}
return|return
operator|(
name|size
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * octeon_enable_fpa  *  * configure fpa with defaults and then mark it enabled.  */
end_comment

begin_function
name|void
name|octeon_enable_fpa
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|octeon_fpa_ctl_status_t
name|status
decl_stmt|;
name|octeon_fpa_fpf_marks_t
name|marks
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|OCTEON_FPA_QUEUES
condition|;
name|i
operator|++
control|)
block|{
name|marks
operator|.
name|word64
operator|=
name|oct_read64
argument_list|(
operator|(
name|OCTEON_FPA_FPF_MARKS
operator|+
operator|(
name|i
operator|)
operator|*
literal|8ull
operator|)
argument_list|)
expr_stmt|;
name|marks
operator|.
name|bits
operator|.
name|fpf_wr
operator|=
literal|0xe0
expr_stmt|;
name|oct_write64
argument_list|(
operator|(
name|OCTEON_FPA_FPF_MARKS
operator|+
operator|(
name|i
operator|)
operator|*
literal|8ull
operator|)
argument_list|,
name|marks
operator|.
name|word64
argument_list|)
expr_stmt|;
block|}
comment|/* Enforce a 10 cycle delay between config and enable */
name|octeon_wait
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|status
operator|.
name|word64
operator|=
literal|0
expr_stmt|;
name|status
operator|.
name|bits
operator|.
name|enb
operator|=
literal|1
expr_stmt|;
name|oct_write64
argument_list|(
name|OCTEON_FPA_CTL_STATUS
argument_list|,
name|status
operator|.
name|word64
argument_list|)
expr_stmt|;
block|}
end_function

begin_define
define|#
directive|define
name|FPA_DEBUG_TERSE
value|1
end_define

begin_comment
comment|/*  * octeon_fpa_fill_pool_mem  *  * Fill the specified FPA pool with elem_num number of  * elements of size elem_size_words * 8  */
end_comment

begin_function
name|void
name|octeon_fpa_fill_pool_mem
parameter_list|(
name|u_int
name|pool
parameter_list|,
name|u_int
name|elem_size_words
parameter_list|,
name|u_int
name|elem_num
parameter_list|)
block|{
name|void
modifier|*
name|memory
decl_stmt|;
name|u_int
name|bytes
decl_stmt|,
name|elem_size_bytes
decl_stmt|;
name|u_int
name|block_size
decl_stmt|;
ifdef|#
directive|ifdef
name|FPA_DEBUG
name|u_int
name|elems
init|=
name|elem_num
decl_stmt|;
name|printf
argument_list|(
literal|" FPA fill: Pool %u  elem_size_words %u   Num: %u\n"
argument_list|,
name|pool
argument_list|,
name|elem_size_words
argument_list|,
name|elem_num
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|elem_size_bytes
operator|=
name|elem_size_words
operator|*
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
expr_stmt|;
name|block_size
operator|=
name|OCTEON_ALIGN
argument_list|(
name|elem_size_bytes
argument_list|)
expr_stmt|;
comment|//    block_size = ((elem_size_bytes / OCTEON_FPA_POOL_ALIGNMENT) + 1) * OCTEON_FPA_POOL_ALIGNMENT;
name|bytes
operator|=
operator|(
name|elem_num
operator|*
name|block_size
operator|)
expr_stmt|;
ifdef|#
directive|ifdef
name|FPA_DEBUG
name|printf
argument_list|(
literal|" elem_size_bytes = words * 8 = %u;  block_size %u\n"
argument_list|,
name|elem_size_bytes
argument_list|,
name|block_size
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|FPA_DEBUG
name|int
name|block
init|=
literal|0
decl_stmt|;
name|printf
argument_list|(
literal|" %% Filling Pool %u  with %u blocks of %u bytes  %u words\n"
argument_list|,
name|pool
argument_list|,
name|elem_num
argument_list|,
name|elem_size_bytes
argument_list|,
name|elem_size_words
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|//    memory = malloc(bytes, M_DEVBUF, M_NOWAIT | M_ZERO);
name|memory
operator|=
name|contigmalloc
argument_list|(
name|bytes
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|,
literal|0
argument_list|,
literal|0x20000000
argument_list|,
name|OCTEON_FPA_POOL_ALIGNMENT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|memory
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|" %% FPA pool %u could not be filled with %u bytes\n"
argument_list|,
name|pool
argument_list|,
name|bytes
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/*      * Forward Align allocated mem to needed alignment. Don't worry about growth, we      * already preallocated extra      */
ifdef|#
directive|ifdef
name|FPA_DEBUG
name|printf
argument_list|(
literal|" %% Huge MemBlock  %p   Bytes %u\n"
argument_list|,
name|memory
argument_list|,
name|bytes
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|memory
operator|=
operator|(
name|void
operator|*
operator|)
name|OCTEON_ALIGN
argument_list|(
name|memory
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|FPA_DEBUG_TERSE
name|printf
argument_list|(
literal|"FPA fill: %u  Count: %u  SizeBytes: %u  SizeBytesAligned: %u  1st: %p = 0x%X\n"
argument_list|,
name|pool
argument_list|,
name|elem_num
argument_list|,
name|elem_size_bytes
argument_list|,
name|block_size
argument_list|,
name|memory
argument_list|,
operator|(
name|void
operator|*
operator|)
name|OCTEON_PTR2PHYS
argument_list|(
name|memory
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|//    memory = (void *) ((((u_int) memory / OCTEON_FPA_POOL_ALIGNMENT) + 1) * OCTEON_FPA_POOL_ALIGNMENT);
while|while
condition|(
name|elem_num
operator|--
condition|)
block|{
ifdef|#
directive|ifdef
name|FPA_DEBUG
if|if
condition|(
operator|(
operator|(
name|elems
operator|-
name|elem_num
operator|)
operator|<
literal|4
operator|)
operator|||
operator|(
name|elem_num
operator|<
literal|4
operator|)
condition|)
name|printf
argument_list|(
literal|" %% Block %d:  %p  Phys 0x%X   Bytes %u\n"
argument_list|,
name|block
argument_list|,
name|memory
argument_list|,
name|OCTEON_PTR2PHYS
argument_list|(
name|memory
argument_list|)
argument_list|,
name|elem_size_bytes
argument_list|)
expr_stmt|;
name|block
operator|++
expr_stmt|;
endif|#
directive|endif
name|octeon_fpa_free
argument_list|(
name|memory
argument_list|,
name|pool
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|memory
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
operator|(
name|u_long
operator|)
name|memory
operator|)
operator|+
name|block_size
operator|)
expr_stmt|;
block|}
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/***********************license start***************  *  Copyright (c) 2003-2008 Cavium Networks (support@cavium.com). All rights  *  reserved.  *  *  *  Redistribution and use in source and binary forms, with or without  *  modification, are permitted provided that the following conditions are  *  met:  *  *      * Redistributions of source code must retain the above copyright  *        notice, this list of conditions and the following disclaimer.  *  *      * Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials provided  *        with the distribution.  *  *      * Neither the name of Cavium Networks nor the names of  *        its contributors may be used to endorse or promote products  *        derived from this software without specific prior written  *        permission.  *  *  TO THE MAXIMUM EXTENT PERMITTED BY LAW, THE SOFTWARE IS PROVIDED "AS IS"  *  AND WITH ALL FAULTS AND CAVIUM NETWORKS MAKES NO PROMISES, REPRESENTATIONS  *  OR WARRANTIES, EITHER EXPRESS, IMPLIED, STATUTORY, OR OTHERWISE, WITH  *  RESPECT TO THE SOFTWARE, INCLUDING ITS CONDITION, ITS CONFORMITY TO ANY  *  REPRESENTATION OR DESCRIPTION, OR THE EXISTENCE OF ANY LATENT OR PATENT  *  DEFECTS, AND CAVIUM SPECIFICALLY DISCLAIMS ALL IMPLIED (IF ANY) WARRANTIES  *  OF TITLE, MERCHANTABILITY, NONINFRINGEMENT, FITNESS FOR A PARTICULAR  *  PURPOSE, LACK OF VIRUSES, ACCURACY OR COMPLETENESS, QUIET ENJOYMENT, QUIET  *  POSSESSION OR CORRESPONDENCE TO DESCRIPTION.  THE ENTIRE RISK ARISING OUT  *  OF USE OR PERFORMANCE OF THE SOFTWARE LIES WITH YOU.  *  *  *  For any questions regarding licensing please contact marketing@caviumnetworks.com  *  ***********************license end**************************************/
end_comment

begin_comment
comment|/*------------------------------------------------------------------  * octeon_pko.c      Packet Output Unit  *  *------------------------------------------------------------------  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm.h>
end_include

begin_include
include|#
directive|include
file|<vm/pmap.h>
end_include

begin_include
include|#
directive|include
file|<mips/cavium/octeon_pcmap_regs.h>
end_include

begin_include
include|#
directive|include
file|"octeon_fau.h"
end_include

begin_include
include|#
directive|include
file|"octeon_fpa.h"
end_include

begin_include
include|#
directive|include
file|"octeon_pko.h"
end_include

begin_comment
comment|/*  *  */
end_comment

begin_function
specifier|static
name|void
name|octeon_pko_clear_port_counts
parameter_list|(
name|u_int
name|port
parameter_list|)
block|{
name|u_int
name|port_num
decl_stmt|;
name|octeon_pko_read_idx_t
name|octeon_pko_idx
decl_stmt|;
name|octeon_pko_idx
operator|.
name|word64
operator|=
literal|0
expr_stmt|;
name|octeon_pko_idx
operator|.
name|bits
operator|.
name|idx
operator|=
name|port
expr_stmt|;
name|octeon_pko_idx
operator|.
name|bits
operator|.
name|inc
operator|=
literal|0
expr_stmt|;
name|oct_write64
argument_list|(
name|OCTEON_PKO_REG_READ_IDX
argument_list|,
name|octeon_pko_idx
operator|.
name|word64
argument_list|)
expr_stmt|;
name|port_num
operator|=
name|port
expr_stmt|;
name|oct_write64
argument_list|(
name|OCTEON_PKO_MEM_COUNT0
argument_list|,
name|port_num
argument_list|)
expr_stmt|;
name|port_num
operator|=
name|port
expr_stmt|;
name|oct_write64
argument_list|(
name|OCTEON_PKO_MEM_COUNT1
argument_list|,
name|port_num
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * octeon_pko_init  *  */
end_comment

begin_function
name|void
name|octeon_pko_init
parameter_list|(
name|void
parameter_list|)
block|{
name|u_int
name|queue
decl_stmt|,
name|port
decl_stmt|;
name|octeon_pko_read_idx_t
name|octeon_pko_idx
decl_stmt|;
name|octeon_pko_queue_cfg_t
name|octeon_pko_queue_cfg
decl_stmt|;
for|for
control|(
name|port
operator|=
literal|0
init|;
name|port
operator|<
name|OCTEON_PKO_PORTS_MAX
condition|;
name|port
operator|++
control|)
block|{
name|octeon_pko_clear_port_counts
argument_list|(
name|port
argument_list|)
expr_stmt|;
block|}
name|octeon_pko_idx
operator|.
name|word64
operator|=
literal|0
expr_stmt|;
name|octeon_pko_idx
operator|.
name|bits
operator|.
name|idx
operator|=
literal|0
expr_stmt|;
name|octeon_pko_idx
operator|.
name|bits
operator|.
name|inc
operator|=
literal|1
expr_stmt|;
name|oct_write64
argument_list|(
name|OCTEON_PKO_REG_READ_IDX
argument_list|,
name|octeon_pko_idx
operator|.
name|word64
argument_list|)
expr_stmt|;
for|for
control|(
name|queue
operator|=
literal|0
init|;
name|queue
operator|<
name|OCTEON_PKO_QUEUES_MAX
condition|;
name|queue
operator|++
control|)
block|{
name|octeon_pko_queue_cfg
operator|.
name|word64
operator|=
literal|0
expr_stmt|;
name|octeon_pko_queue_cfg
operator|.
name|bits
operator|.
name|queue
operator|=
name|queue
expr_stmt|;
name|octeon_pko_queue_cfg
operator|.
name|bits
operator|.
name|port
operator|=
name|OCTEON_PKO_PORT_ILLEGAL
expr_stmt|;
name|octeon_pko_queue_cfg
operator|.
name|bits
operator|.
name|buf_ptr
operator|=
literal|0
expr_stmt|;
name|oct_write64
argument_list|(
name|OCTEON_PKO_MEM_QUEUE_PTRS
argument_list|,
name|octeon_pko_queue_cfg
operator|.
name|word64
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * octeon_pko_enable  *  * enable pko  */
end_comment

begin_function
name|void
name|octeon_pko_enable
parameter_list|(
name|void
parameter_list|)
block|{
comment|/*      * PKO enable      */
name|oct_write64
argument_list|(
name|OCTEON_PKO_REG_FLAGS
argument_list|,
literal|3
argument_list|)
expr_stmt|;
comment|/*  octeon_pko_enable() */
block|}
end_function

begin_comment
comment|/*  * octeon_pko_disable  *  * disable pko  */
end_comment

begin_function
name|void
name|octeon_pko_disable
parameter_list|(
name|void
parameter_list|)
block|{
comment|/*      * PKO disable      */
name|oct_write64
argument_list|(
name|OCTEON_PKO_REG_FLAGS
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/*  pko_disable() */
block|}
end_function

begin_comment
comment|/*  * octeon_pko_config_cmdbuf_global_defaults  *  */
end_comment

begin_function
name|void
name|octeon_pko_config_cmdbuf_global_defaults
parameter_list|(
name|u_int
name|cmdbuf_pool
parameter_list|,
name|u_int
name|cmdbuf_pool_elem_size
parameter_list|)
block|{
name|octeon_pko_pool_cfg_t
name|octeon_pko_pool_config
decl_stmt|;
name|octeon_pko_pool_config
operator|.
name|word64
operator|=
literal|0
expr_stmt|;
name|octeon_pko_pool_config
operator|.
name|bits
operator|.
name|pool
operator|=
name|cmdbuf_pool
expr_stmt|;
name|octeon_pko_pool_config
operator|.
name|bits
operator|.
name|size
operator|=
name|cmdbuf_pool_elem_size
expr_stmt|;
name|oct_write64
argument_list|(
name|OCTEON_PKO_CMD_BUF
argument_list|,
name|octeon_pko_pool_config
operator|.
name|word64
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * octeon_pko_config_rgmx_ports  *  * Configure rgmx pko.  Always enables 4 + 4 ports  */
end_comment

begin_function
name|void
name|octeon_pko_config_rgmx_ports
parameter_list|(
name|void
parameter_list|)
block|{
name|octeon_pko_reg_gmx_port_mode_t
name|octeon_pko_gmx_mode
decl_stmt|;
name|octeon_pko_gmx_mode
operator|.
name|word64
operator|=
literal|0
expr_stmt|;
name|octeon_pko_gmx_mode
operator|.
name|bits
operator|.
name|mode0
operator|=
literal|2
expr_stmt|;
comment|/* 16>> 2 == 4 ports */
name|octeon_pko_gmx_mode
operator|.
name|bits
operator|.
name|mode1
operator|=
literal|2
expr_stmt|;
comment|/* 16>> 2 == 4 ports */
name|oct_write64
argument_list|(
name|OCTEON_PKO_GMX_PORT_MODE
argument_list|,
name|octeon_pko_gmx_mode
operator|.
name|word64
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * octeon_pko_config  *  * Configure PKO  *  */
end_comment

begin_function
name|void
name|octeon_pko_config
parameter_list|(
name|void
parameter_list|)
block|{ }
end_function

begin_comment
comment|/*  * octeon_pko_get_port_status  *  * Get the status counters for a PKO port.  *  * port_num Port number to get statistics for.  * clear    Set to 1 to clear the counters after they are read  * status   Where to put the results.  */
end_comment

begin_function
name|void
name|octeon_pko_get_port_status
parameter_list|(
name|u_int
name|port
parameter_list|,
name|u_int
name|clear
parameter_list|,
name|octeon_pko_port_status_t
modifier|*
name|status
parameter_list|)
block|{
name|octeon_word_t
name|packet_num
decl_stmt|;
name|octeon_pko_read_idx_t
name|octeon_pko_idx
decl_stmt|;
name|packet_num
operator|.
name|word64
operator|=
literal|0
expr_stmt|;
name|octeon_pko_idx
operator|.
name|word64
operator|=
literal|0
expr_stmt|;
name|octeon_pko_idx
operator|.
name|bits
operator|.
name|idx
operator|=
name|port
expr_stmt|;
name|octeon_pko_idx
operator|.
name|bits
operator|.
name|inc
operator|=
literal|0
expr_stmt|;
name|oct_write64
argument_list|(
name|OCTEON_PKO_REG_READ_IDX
argument_list|,
name|octeon_pko_idx
operator|.
name|word64
argument_list|)
expr_stmt|;
name|packet_num
operator|.
name|word64
operator|=
name|oct_read64
argument_list|(
name|OCTEON_PKO_MEM_COUNT0
argument_list|)
expr_stmt|;
name|status
operator|->
name|packets
operator|=
name|packet_num
operator|.
name|bits
operator|.
name|word32lo
expr_stmt|;
name|status
operator|->
name|octets
operator|=
name|oct_read64
argument_list|(
name|OCTEON_PKO_MEM_COUNT1
argument_list|)
expr_stmt|;
name|status
operator|->
name|doorbell
operator|=
name|oct_read64
argument_list|(
name|OCTEON_PKO_MEM_DEBUG9
argument_list|)
expr_stmt|;
name|status
operator|->
name|doorbell
operator|=
operator|(
name|status
operator|->
name|doorbell
operator|>>
literal|8
operator|)
operator|&
literal|0xfffff
expr_stmt|;
if|if
condition|(
name|clear
condition|)
block|{
name|octeon_pko_clear_port_counts
argument_list|(
name|port
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function_decl
specifier|static
name|void
name|octeon_pko_doorbell_data_dump
parameter_list|(
name|uint64_t
name|port
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|void
name|octeon_pko_doorbell_data_dump
parameter_list|(
name|uint64_t
name|port
parameter_list|)
block|{
name|octeon_pko_port_status_t
name|status
decl_stmt|;
name|octeon_pko_get_port_status
argument_list|(
name|port
argument_list|,
literal|0
argument_list|,
operator|&
name|status
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n Port #%lld  Pkts %ld   Bytes %lld  DoorBell %lld"
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|port
argument_list|,
name|status
operator|.
name|packets
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|status
operator|.
name|octets
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|status
operator|.
name|doorbell
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * octeon_pko_show  *  * Show the OCTEON_PKO status& configs  */
end_comment

begin_function
name|void
name|octeon_pko_show
parameter_list|(
name|u_int
name|start_port
parameter_list|,
name|u_int
name|end_port
parameter_list|)
block|{
name|u_int
name|queue
decl_stmt|,
name|queue_max
decl_stmt|,
name|gmx_int0_ports
decl_stmt|,
name|gmx_int1_ports
decl_stmt|;
name|u_int
name|port
decl_stmt|;
name|uint64_t
name|val64
decl_stmt|;
name|octeon_pko_port_status_t
name|status
decl_stmt|;
name|octeon_pko_pool_cfg_t
name|octeon_pko_pool_config
decl_stmt|;
name|octeon_pko_read_idx_t
name|octeon_pko_idx
decl_stmt|;
name|octeon_pko_queue_mode_t
name|octeon_pko_queue_mode
decl_stmt|;
name|octeon_pko_reg_gmx_port_mode_t
name|octeon_pko_gmx_mode
decl_stmt|;
name|octeon_pko_crc_ports_enable_t
name|octeon_pko_crc_ports
decl_stmt|;
name|octeon_pko_queue_cfg_t
name|octeon_pko_queue_cfg
decl_stmt|;
name|printf
argument_list|(
literal|"\n\nPKO Status:"
argument_list|)
expr_stmt|;
name|val64
operator|=
name|oct_read64
argument_list|(
name|OCTEON_PKO_REG_FLAGS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|val64
operator|&
literal|0x3
operator|)
operator|!=
literal|0x3
condition|)
block|{
name|printf
argument_list|(
literal|"  Disabled"
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"  Enabled"
argument_list|)
expr_stmt|;
block|}
name|octeon_pko_queue_mode
operator|.
name|word64
operator|=
name|oct_read64
argument_list|(
name|OCTEON_PKO_QUEUE_MODE
argument_list|)
expr_stmt|;
name|queue_max
operator|=
operator|(
literal|128
operator|>>
name|octeon_pko_queue_mode
operator|.
name|bits
operator|.
name|mode
operator|)
expr_stmt|;
name|octeon_pko_gmx_mode
operator|.
name|word64
operator|=
name|oct_read64
argument_list|(
name|OCTEON_PKO_GMX_PORT_MODE
argument_list|)
expr_stmt|;
name|gmx_int0_ports
operator|=
operator|(
literal|16
operator|>>
name|octeon_pko_gmx_mode
operator|.
name|bits
operator|.
name|mode0
operator|)
expr_stmt|;
name|gmx_int1_ports
operator|=
operator|(
literal|16
operator|>>
name|octeon_pko_gmx_mode
operator|.
name|bits
operator|.
name|mode1
operator|)
expr_stmt|;
name|octeon_pko_crc_ports
operator|.
name|word64
operator|=
name|oct_read64
argument_list|(
name|OCTEON_PKO_REG_CRC_ENABLE
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n Total Queues: 0..%d  Ports GMX0 %d   GMX1 %d  CRC 0x%X"
argument_list|,
name|queue_max
operator|-
literal|1
argument_list|,
name|gmx_int0_ports
argument_list|,
name|gmx_int1_ports
argument_list|,
name|octeon_pko_crc_ports
operator|.
name|bits
operator|.
name|crc_ports_mask
argument_list|)
expr_stmt|;
name|octeon_pko_pool_config
operator|.
name|word64
operator|=
name|oct_read64
argument_list|(
name|OCTEON_PKO_CMD_BUF
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n  CmdBuf Pool: %d    CmdBuf  Size in Words: %d  Bytes: %d"
argument_list|,
name|octeon_pko_pool_config
operator|.
name|bits
operator|.
name|pool
argument_list|,
name|octeon_pko_pool_config
operator|.
name|bits
operator|.
name|size
argument_list|,
name|octeon_pko_pool_config
operator|.
name|bits
operator|.
name|size
operator|*
literal|8
argument_list|)
expr_stmt|;
name|octeon_pko_idx
operator|.
name|word64
operator|=
literal|0
expr_stmt|;
name|octeon_pko_idx
operator|.
name|bits
operator|.
name|idx
operator|=
literal|0
expr_stmt|;
name|octeon_pko_idx
operator|.
name|bits
operator|.
name|inc
operator|=
literal|1
expr_stmt|;
name|oct_write64
argument_list|(
name|OCTEON_PKO_REG_READ_IDX
argument_list|,
name|octeon_pko_idx
operator|.
name|word64
argument_list|)
expr_stmt|;
for|for
control|(
name|queue
operator|=
literal|0
init|;
name|queue
operator|<
name|queue_max
condition|;
name|queue
operator|++
control|)
block|{
name|octeon_pko_queue_cfg
operator|.
name|word64
operator|=
name|oct_read64
argument_list|(
name|OCTEON_PKO_MEM_QUEUE_PTRS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|octeon_pko_queue_cfg
operator|.
name|bits
operator|.
name|buf_ptr
condition|)
continue|continue;
name|printf
argument_list|(
literal|"\n  Port # %d   Queue %3d   [%d]  BufPtr: 0x%llX Mask: %X%s"
argument_list|,
name|octeon_pko_queue_cfg
operator|.
name|bits
operator|.
name|port
argument_list|,
name|octeon_pko_queue_cfg
operator|.
name|bits
operator|.
name|queue
argument_list|,
name|octeon_pko_queue_cfg
operator|.
name|bits
operator|.
name|index
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|octeon_pko_queue_cfg
operator|.
name|bits
operator|.
name|buf_ptr
argument_list|,
name|octeon_pko_queue_cfg
operator|.
name|bits
operator|.
name|qos_mask
argument_list|,
operator|(
name|octeon_pko_queue_cfg
operator|.
name|bits
operator|.
name|tail
operator|)
condition|?
literal|"  Last"
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|port
operator|=
name|start_port
init|;
name|port
operator|<
operator|(
name|end_port
operator|+
literal|1
operator|)
condition|;
name|port
operator|++
control|)
block|{
name|octeon_pko_get_port_status
argument_list|(
name|port
argument_list|,
literal|0
argument_list|,
operator|&
name|status
argument_list|)
expr_stmt|;
name|octeon_pko_doorbell_data_dump
argument_list|(
name|port
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * octeon_pko_config_port  *  * Configure a output port and the associated queues for use.  *  */
end_comment

begin_function
name|octeon_pko_status_t
name|octeon_pko_config_port
parameter_list|(
name|u_int
name|port
parameter_list|,
name|u_int
name|base_queue
parameter_list|,
name|u_int
name|num_queues
parameter_list|,
specifier|const
name|u_int
name|priority
index|[]
parameter_list|,
name|u_int
name|pko_output_cmdbuf_fpa_pool
parameter_list|,
name|octeon_pko_sw_queue_info_t
name|sw_queues
index|[]
parameter_list|)
block|{
name|octeon_pko_status_t
name|result_code
decl_stmt|;
name|u_int
name|queue
decl_stmt|;
name|octeon_pko_queue_cfg_t
name|qconfig
decl_stmt|;
if|if
condition|(
operator|(
name|port
operator|>=
name|OCTEON_PKO_PORTS_MAX
operator|)
operator|&&
operator|(
name|port
operator|!=
name|OCTEON_PKO_PORT_ILLEGAL
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"\n%% Error: octeon_pko_config_port: Invalid port %u"
argument_list|,
name|port
argument_list|)
expr_stmt|;
return|return
operator|(
name|OCTEON_PKO_INVALID_PORT
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|base_queue
operator|+
name|num_queues
operator|)
operator|>
name|OCTEON_PKO_QUEUES_MAX
condition|)
block|{
name|printf
argument_list|(
literal|"\n%% Error: octeon_pko_config_port: Invalid queue range"
argument_list|)
expr_stmt|;
return|return
operator|(
name|OCTEON_PKO_INVALID_QUEUE
operator|)
return|;
block|}
name|result_code
operator|=
name|OCTEON_PKO_SUCCESS
expr_stmt|;
for|for
control|(
name|queue
operator|=
literal|0
init|;
name|queue
operator|<
name|num_queues
condition|;
name|queue
operator|++
control|)
block|{
name|uint64_t
name|buf_ptr
init|=
literal|0
decl_stmt|;
name|qconfig
operator|.
name|word64
operator|=
literal|0
expr_stmt|;
name|qconfig
operator|.
name|bits
operator|.
name|tail
operator|=
operator|(
name|queue
operator|==
operator|(
name|num_queues
operator|-
literal|1
operator|)
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|qconfig
operator|.
name|bits
operator|.
name|index
operator|=
name|queue
expr_stmt|;
name|qconfig
operator|.
name|bits
operator|.
name|port
operator|=
name|port
expr_stmt|;
name|qconfig
operator|.
name|bits
operator|.
name|queue
operator|=
name|base_queue
operator|+
name|queue
expr_stmt|;
comment|/* Convert the priority into an enable bit field. */
comment|/* Try to space the bits out evenly so the pkts don't get grouped up */
switch|switch
condition|(
operator|(
name|int
operator|)
name|priority
index|[
name|queue
index|]
condition|)
block|{
case|case
literal|0
case|:
name|qconfig
operator|.
name|bits
operator|.
name|qos_mask
operator|=
literal|0x00
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|qconfig
operator|.
name|bits
operator|.
name|qos_mask
operator|=
literal|0x01
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|qconfig
operator|.
name|bits
operator|.
name|qos_mask
operator|=
literal|0x11
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|qconfig
operator|.
name|bits
operator|.
name|qos_mask
operator|=
literal|0x49
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|qconfig
operator|.
name|bits
operator|.
name|qos_mask
operator|=
literal|0x55
expr_stmt|;
break|break;
case|case
literal|5
case|:
name|qconfig
operator|.
name|bits
operator|.
name|qos_mask
operator|=
literal|0x57
expr_stmt|;
break|break;
case|case
literal|6
case|:
name|qconfig
operator|.
name|bits
operator|.
name|qos_mask
operator|=
literal|0x77
expr_stmt|;
break|break;
case|case
literal|7
case|:
name|qconfig
operator|.
name|bits
operator|.
name|qos_mask
operator|=
literal|0x7f
expr_stmt|;
break|break;
case|case
literal|8
case|:
name|qconfig
operator|.
name|bits
operator|.
name|qos_mask
operator|=
literal|0xff
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"\n%% Error: octeon_pko_config_port Invalid priority %llu"
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|priority
index|[
name|queue
index|]
argument_list|)
expr_stmt|;
name|qconfig
operator|.
name|bits
operator|.
name|qos_mask
operator|=
literal|0xff
expr_stmt|;
name|result_code
operator|=
name|OCTEON_PKO_INVALID_PRIORITY
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|port
operator|!=
name|OCTEON_PKO_PORT_ILLEGAL
condition|)
block|{
name|buf_ptr
operator|=
name|octeon_fpa_alloc_phys
argument_list|(
name|pko_output_cmdbuf_fpa_pool
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|buf_ptr
condition|)
block|{
name|printf
argument_list|(
literal|"\n%% Error: octeon_pko_config_port: Unable to allocate"
argument_list|)
expr_stmt|;
return|return
operator|(
name|OCTEON_PKO_NO_MEMORY
operator|)
return|;
block|}
name|sw_queues
index|[
name|queue
index|]
operator|.
name|xmit_command_state
operator|=
operator|(
name|buf_ptr
operator|<<
name|OCTEON_PKO_INDEX_BITS
operator|)
expr_stmt|;
name|octeon_spinlock_init
argument_list|(
operator|&
operator|(
name|sw_queues
index|[
name|queue
index|]
operator|.
name|lock
operator|)
argument_list|)
expr_stmt|;
comment|//#define DEBUG_TX
ifdef|#
directive|ifdef
name|DEBUG_TX
name|printf
argument_list|(
literal|" PKO: port %u pool: %u  base+queue %u %u %u  buf_ptr: 0x%llX\n"
argument_list|,
name|port
argument_list|,
name|pko_output_cmdbuf_fpa_pool
argument_list|,
name|base_queue
argument_list|,
name|queue
argument_list|,
name|base_queue
operator|+
name|queue
argument_list|,
name|buf_ptr
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|qconfig
operator|.
name|bits
operator|.
name|buf_ptr
operator|=
name|buf_ptr
expr_stmt|;
name|oct_write64
argument_list|(
name|OCTEON_PKO_MEM_QUEUE_PTRS
argument_list|,
name|qconfig
operator|.
name|word64
argument_list|)
expr_stmt|;
block|}
block|}
return|return
operator|(
name|result_code
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*-  * Copyright (c) 2010 Hans Petter Selasky. All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_comment
comment|/*  * This file contains the driver for Octeon Executive Library USB  * Controller driver API.  */
end_comment

begin_comment
comment|/* TODO: The root HUB port callback is not yet implemented. */
end_comment

begin_include
include|#
directive|include
file|<sys/stdint.h>
end_include

begin_include
include|#
directive|include
file|<sys/stddef.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<sys/condvar.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/sx.h>
end_include

begin_include
include|#
directive|include
file|<sys/unistd.h>
end_include

begin_include
include|#
directive|include
file|<sys/callout.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/priv.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usbdi.h>
end_include

begin_define
define|#
directive|define
name|USB_DEBUG_VAR
value|octusbdebug
end_define

begin_include
include|#
directive|include
file|<dev/usb/usb_core.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb_debug.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb_busdma.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb_process.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb_transfer.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb_device.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb_hub.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb_util.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb_controller.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb_bus.h>
end_include

begin_include
include|#
directive|include
file|<contrib/octeon-sdk/cvmx.h>
end_include

begin_include
include|#
directive|include
file|<contrib/octeon-sdk/cvmx-usb.h>
end_include

begin_include
include|#
directive|include
file|<mips/cavium/usb/octusb.h>
end_include

begin_define
define|#
directive|define
name|OCTUSB_BUS2SC
parameter_list|(
name|bus
parameter_list|)
define|\
value|((struct octusb_softc *)(((uint8_t *)(bus)) - \     ((uint8_t *)&(((struct octusb_softc *)0)->sc_bus))))
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|USB_DEBUG
end_ifdef

begin_decl_stmt
specifier|static
name|int
name|octusbdebug
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_expr_stmt
specifier|static
name|SYSCTL_NODE
argument_list|(
name|_hw_usb
argument_list|,
name|OID_AUTO
argument_list|,
name|octusb
argument_list|,
name|CTLFLAG_RW
argument_list|,
literal|0
argument_list|,
literal|"OCTUSB"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_hw_usb_octusb
argument_list|,
name|OID_AUTO
argument_list|,
name|debug
argument_list|,
name|CTLFLAG_RWTUN
argument_list|,
operator|&
name|octusbdebug
argument_list|,
literal|0
argument_list|,
literal|"OCTUSB debug level"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_struct
struct|struct
name|octusb_std_temp
block|{
name|octusb_cmd_t
modifier|*
name|func
decl_stmt|;
name|struct
name|octusb_td
modifier|*
name|td
decl_stmt|;
name|struct
name|octusb_td
modifier|*
name|td_next
decl_stmt|;
name|struct
name|usb_page_cache
modifier|*
name|pc
decl_stmt|;
name|uint32_t
name|offset
decl_stmt|;
name|uint32_t
name|len
decl_stmt|;
name|uint8_t
name|short_pkt
decl_stmt|;
name|uint8_t
name|setup_alt_next
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|extern
name|struct
name|usb_bus_methods
name|octusb_bus_methods
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|struct
name|usb_pipe_methods
name|octusb_device_bulk_methods
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|struct
name|usb_pipe_methods
name|octusb_device_ctrl_methods
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|struct
name|usb_pipe_methods
name|octusb_device_intr_methods
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|struct
name|usb_pipe_methods
name|octusb_device_isoc_methods
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|octusb_standard_done
parameter_list|(
name|struct
name|usb_xfer
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|octusb_device_done
parameter_list|(
name|struct
name|usb_xfer
modifier|*
parameter_list|,
name|usb_error_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|octusb_timeout
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|octusb_do_poll
parameter_list|(
name|struct
name|usb_bus
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|cvmx_usb_speed_t
name|octusb_convert_speed
parameter_list|(
name|enum
name|usb_dev_speed
name|speed
parameter_list|)
block|{
empty_stmt|;
comment|/* indent fix */
switch|switch
condition|(
name|speed
condition|)
block|{
case|case
name|USB_SPEED_HIGH
case|:
return|return
operator|(
name|CVMX_USB_SPEED_HIGH
operator|)
return|;
case|case
name|USB_SPEED_FULL
case|:
return|return
operator|(
name|CVMX_USB_SPEED_FULL
operator|)
return|;
default|default:
return|return
operator|(
name|CVMX_USB_SPEED_LOW
operator|)
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|cvmx_usb_transfer_t
name|octusb_convert_ep_type
parameter_list|(
name|uint8_t
name|ep_type
parameter_list|)
block|{
empty_stmt|;
comment|/* indent fix */
switch|switch
condition|(
name|ep_type
operator|&
name|UE_XFERTYPE
condition|)
block|{
case|case
name|UE_CONTROL
case|:
return|return
operator|(
name|CVMX_USB_TRANSFER_CONTROL
operator|)
return|;
case|case
name|UE_INTERRUPT
case|:
return|return
operator|(
name|CVMX_USB_TRANSFER_INTERRUPT
operator|)
return|;
case|case
name|UE_ISOCHRONOUS
case|:
return|return
operator|(
name|CVMX_USB_TRANSFER_ISOCHRONOUS
operator|)
return|;
case|case
name|UE_BULK
case|:
return|return
operator|(
name|CVMX_USB_TRANSFER_BULK
operator|)
return|;
default|default:
return|return
operator|(
literal|0
operator|)
return|;
comment|/* should not happen */
block|}
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|octusb_host_alloc_endpoint
parameter_list|(
name|struct
name|octusb_td
modifier|*
name|td
parameter_list|)
block|{
name|struct
name|octusb_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|ep_handle
decl_stmt|;
if|if
condition|(
name|td
operator|->
name|qh
operator|->
name|fixup_pending
condition|)
return|return
operator|(
literal|1
operator|)
return|;
comment|/* busy */
if|if
condition|(
name|td
operator|->
name|qh
operator|->
name|ep_allocated
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* success */
comment|/* get softc */
name|sc
operator|=
name|td
operator|->
name|qh
operator|->
name|sc
expr_stmt|;
name|ep_handle
operator|=
name|cvmx_usb_open_pipe
argument_list|(
operator|&
name|sc
operator|->
name|sc_port
index|[
name|td
operator|->
name|qh
operator|->
name|root_port_index
index|]
operator|.
name|state
argument_list|,
literal|0
argument_list|,
name|td
operator|->
name|qh
operator|->
name|dev_addr
argument_list|,
name|td
operator|->
name|qh
operator|->
name|ep_num
operator|&
name|UE_ADDR
argument_list|,
name|octusb_convert_speed
argument_list|(
name|td
operator|->
name|qh
operator|->
name|dev_speed
argument_list|)
argument_list|,
name|td
operator|->
name|qh
operator|->
name|max_packet_size
argument_list|,
name|octusb_convert_ep_type
argument_list|(
name|td
operator|->
name|qh
operator|->
name|ep_type
argument_list|)
argument_list|,
operator|(
name|td
operator|->
name|qh
operator|->
name|ep_num
operator|&
name|UE_DIR_IN
operator|)
condition|?
name|CVMX_USB_DIRECTION_IN
else|:
name|CVMX_USB_DIRECTION_OUT
argument_list|,
name|td
operator|->
name|qh
operator|->
name|ep_interval
argument_list|,
operator|(
name|td
operator|->
name|qh
operator|->
name|dev_speed
operator|==
name|USB_SPEED_HIGH
operator|)
condition|?
name|td
operator|->
name|qh
operator|->
name|ep_mult
else|:
literal|0
argument_list|,
name|td
operator|->
name|qh
operator|->
name|hs_hub_addr
argument_list|,
name|td
operator|->
name|qh
operator|->
name|hs_hub_port
argument_list|)
expr_stmt|;
if|if
condition|(
name|ep_handle
operator|<
literal|0
condition|)
block|{
name|DPRINTFN
argument_list|(
literal|1
argument_list|,
literal|"cvmx_usb_open_pipe failed: %d\n"
argument_list|,
name|ep_handle
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
comment|/* busy */
block|}
name|cvmx_usb_set_toggle
argument_list|(
operator|&
name|sc
operator|->
name|sc_port
index|[
name|td
operator|->
name|qh
operator|->
name|root_port_index
index|]
operator|.
name|state
argument_list|,
name|ep_handle
argument_list|,
name|td
operator|->
name|qh
operator|->
name|ep_toggle_next
argument_list|)
expr_stmt|;
name|td
operator|->
name|qh
operator|->
name|fixup_handle
operator|=
operator|-
literal|1
expr_stmt|;
name|td
operator|->
name|qh
operator|->
name|fixup_complete
operator|=
literal|0
expr_stmt|;
name|td
operator|->
name|qh
operator|->
name|fixup_len
operator|=
literal|0
expr_stmt|;
name|td
operator|->
name|qh
operator|->
name|fixup_off
operator|=
literal|0
expr_stmt|;
name|td
operator|->
name|qh
operator|->
name|fixup_pending
operator|=
literal|0
expr_stmt|;
name|td
operator|->
name|qh
operator|->
name|fixup_actlen
operator|=
literal|0
expr_stmt|;
name|td
operator|->
name|qh
operator|->
name|ep_handle
operator|=
name|ep_handle
expr_stmt|;
name|td
operator|->
name|qh
operator|->
name|ep_allocated
operator|=
literal|1
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
comment|/* success */
block|}
end_function

begin_function
specifier|static
name|void
name|octusb_host_free_endpoint
parameter_list|(
name|struct
name|octusb_td
modifier|*
name|td
parameter_list|)
block|{
name|struct
name|octusb_softc
modifier|*
name|sc
decl_stmt|;
if|if
condition|(
name|td
operator|->
name|qh
operator|->
name|ep_allocated
operator|==
literal|0
condition|)
return|return;
comment|/* get softc */
name|sc
operator|=
name|td
operator|->
name|qh
operator|->
name|sc
expr_stmt|;
if|if
condition|(
name|td
operator|->
name|qh
operator|->
name|fixup_handle
operator|>=
literal|0
condition|)
block|{
comment|/* cancel, if any */
name|cvmx_usb_cancel
argument_list|(
operator|&
name|sc
operator|->
name|sc_port
index|[
name|td
operator|->
name|qh
operator|->
name|root_port_index
index|]
operator|.
name|state
argument_list|,
name|td
operator|->
name|qh
operator|->
name|ep_handle
argument_list|,
name|td
operator|->
name|qh
operator|->
name|fixup_handle
argument_list|)
expr_stmt|;
block|}
name|cvmx_usb_close_pipe
argument_list|(
operator|&
name|sc
operator|->
name|sc_port
index|[
name|td
operator|->
name|qh
operator|->
name|root_port_index
index|]
operator|.
name|state
argument_list|,
name|td
operator|->
name|qh
operator|->
name|ep_handle
argument_list|)
expr_stmt|;
name|td
operator|->
name|qh
operator|->
name|ep_allocated
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|octusb_complete_cb
parameter_list|(
name|cvmx_usb_state_t
modifier|*
name|state
parameter_list|,
name|cvmx_usb_callback_t
name|reason
parameter_list|,
name|cvmx_usb_complete_t
name|status
parameter_list|,
name|int
name|pipe_handle
parameter_list|,
name|int
name|submit_handle
parameter_list|,
name|int
name|bytes_transferred
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|octusb_td
modifier|*
name|td
decl_stmt|;
if|if
condition|(
name|reason
operator|!=
name|CVMX_USB_CALLBACK_TRANSFER_COMPLETE
condition|)
return|return;
name|td
operator|=
name|user_data
expr_stmt|;
name|td
operator|->
name|qh
operator|->
name|fixup_complete
operator|=
literal|1
expr_stmt|;
name|td
operator|->
name|qh
operator|->
name|fixup_pending
operator|=
literal|0
expr_stmt|;
name|td
operator|->
name|qh
operator|->
name|fixup_actlen
operator|=
name|bytes_transferred
expr_stmt|;
name|td
operator|->
name|qh
operator|->
name|fixup_handle
operator|=
operator|-
literal|1
expr_stmt|;
switch|switch
condition|(
name|status
condition|)
block|{
case|case
name|CVMX_USB_COMPLETE_SUCCESS
case|:
case|case
name|CVMX_USB_COMPLETE_SHORT
case|:
name|td
operator|->
name|error_any
operator|=
literal|0
expr_stmt|;
name|td
operator|->
name|error_stall
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|CVMX_USB_COMPLETE_STALL
case|:
name|td
operator|->
name|error_stall
operator|=
literal|1
expr_stmt|;
name|td
operator|->
name|error_any
operator|=
literal|1
expr_stmt|;
break|break;
default|default:
name|td
operator|->
name|error_any
operator|=
literal|1
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|octusb_host_control_header_tx
parameter_list|(
name|struct
name|octusb_td
modifier|*
name|td
parameter_list|)
block|{
name|int
name|status
decl_stmt|;
comment|/* allocate endpoint and check pending */
if|if
condition|(
name|octusb_host_alloc_endpoint
argument_list|(
name|td
argument_list|)
condition|)
return|return
operator|(
literal|1
operator|)
return|;
comment|/* busy */
comment|/* check error */
if|if
condition|(
name|td
operator|->
name|error_any
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* done */
if|if
condition|(
name|td
operator|->
name|qh
operator|->
name|fixup_complete
operator|!=
literal|0
condition|)
block|{
comment|/* clear complete flag */
name|td
operator|->
name|qh
operator|->
name|fixup_complete
operator|=
literal|0
expr_stmt|;
comment|/* flush data */
name|usb_pc_cpu_invalidate
argument_list|(
name|td
operator|->
name|qh
operator|->
name|fixup_pc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
comment|/* done */
block|}
comment|/* verify length */
if|if
condition|(
name|td
operator|->
name|remainder
operator|!=
literal|8
condition|)
block|{
name|td
operator|->
name|error_any
operator|=
literal|1
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
comment|/* done */
block|}
name|usbd_copy_out
argument_list|(
name|td
operator|->
name|pc
argument_list|,
name|td
operator|->
name|offset
argument_list|,
name|td
operator|->
name|qh
operator|->
name|fixup_buf
argument_list|,
literal|8
argument_list|)
expr_stmt|;
comment|/* update offset and remainder */
name|td
operator|->
name|offset
operator|+=
literal|8
expr_stmt|;
name|td
operator|->
name|remainder
operator|-=
literal|8
expr_stmt|;
comment|/* setup data length and offset */
name|td
operator|->
name|qh
operator|->
name|fixup_len
operator|=
name|UGETW
argument_list|(
name|td
operator|->
name|qh
operator|->
name|fixup_buf
operator|+
literal|6
argument_list|)
expr_stmt|;
name|td
operator|->
name|qh
operator|->
name|fixup_off
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|td
operator|->
name|qh
operator|->
name|fixup_len
operator|>
operator|(
name|OCTUSB_MAX_FIXUP
operator|-
literal|8
operator|)
condition|)
block|{
name|td
operator|->
name|error_any
operator|=
literal|1
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
comment|/* done */
block|}
comment|/* do control IN request */
if|if
condition|(
name|td
operator|->
name|qh
operator|->
name|fixup_buf
index|[
literal|0
index|]
operator|&
name|UE_DIR_IN
condition|)
block|{
name|struct
name|octusb_softc
modifier|*
name|sc
decl_stmt|;
comment|/* get softc */
name|sc
operator|=
name|td
operator|->
name|qh
operator|->
name|sc
expr_stmt|;
comment|/* flush data */
name|usb_pc_cpu_flush
argument_list|(
name|td
operator|->
name|qh
operator|->
name|fixup_pc
argument_list|)
expr_stmt|;
name|status
operator|=
name|cvmx_usb_submit_control
argument_list|(
operator|&
name|sc
operator|->
name|sc_port
index|[
name|td
operator|->
name|qh
operator|->
name|root_port_index
index|]
operator|.
name|state
argument_list|,
name|td
operator|->
name|qh
operator|->
name|ep_handle
argument_list|,
name|td
operator|->
name|qh
operator|->
name|fixup_phys
argument_list|,
name|td
operator|->
name|qh
operator|->
name|fixup_phys
operator|+
literal|8
argument_list|,
name|td
operator|->
name|qh
operator|->
name|fixup_len
argument_list|,
operator|&
name|octusb_complete_cb
argument_list|,
name|td
argument_list|)
expr_stmt|;
comment|/* check status */
if|if
condition|(
name|status
operator|<
literal|0
condition|)
block|{
name|td
operator|->
name|error_any
operator|=
literal|1
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
comment|/* done */
block|}
name|td
operator|->
name|qh
operator|->
name|fixup_handle
operator|=
name|status
expr_stmt|;
name|td
operator|->
name|qh
operator|->
name|fixup_pending
operator|=
literal|1
expr_stmt|;
name|td
operator|->
name|qh
operator|->
name|fixup_complete
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
comment|/* busy */
block|}
return|return
operator|(
literal|0
operator|)
return|;
comment|/* done */
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|octusb_host_control_data_tx
parameter_list|(
name|struct
name|octusb_td
modifier|*
name|td
parameter_list|)
block|{
name|uint32_t
name|rem
decl_stmt|;
comment|/* allocate endpoint and check pending */
if|if
condition|(
name|octusb_host_alloc_endpoint
argument_list|(
name|td
argument_list|)
condition|)
return|return
operator|(
literal|1
operator|)
return|;
comment|/* busy */
comment|/* check error */
if|if
condition|(
name|td
operator|->
name|error_any
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* done */
name|rem
operator|=
name|td
operator|->
name|qh
operator|->
name|fixup_len
operator|-
name|td
operator|->
name|qh
operator|->
name|fixup_off
expr_stmt|;
if|if
condition|(
name|td
operator|->
name|remainder
operator|>
name|rem
condition|)
block|{
name|td
operator|->
name|error_any
operator|=
literal|1
expr_stmt|;
name|DPRINTFN
argument_list|(
literal|1
argument_list|,
literal|"Excess setup transmit data\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
comment|/* done */
block|}
name|usbd_copy_out
argument_list|(
name|td
operator|->
name|pc
argument_list|,
name|td
operator|->
name|offset
argument_list|,
name|td
operator|->
name|qh
operator|->
name|fixup_buf
operator|+
name|td
operator|->
name|qh
operator|->
name|fixup_off
operator|+
literal|8
argument_list|,
name|td
operator|->
name|remainder
argument_list|)
expr_stmt|;
name|td
operator|->
name|offset
operator|+=
name|td
operator|->
name|remainder
expr_stmt|;
name|td
operator|->
name|qh
operator|->
name|fixup_off
operator|+=
name|td
operator|->
name|remainder
expr_stmt|;
name|td
operator|->
name|remainder
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
comment|/* done */
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|octusb_host_control_data_rx
parameter_list|(
name|struct
name|octusb_td
modifier|*
name|td
parameter_list|)
block|{
name|uint32_t
name|rem
decl_stmt|;
comment|/* allocate endpoint and check pending */
if|if
condition|(
name|octusb_host_alloc_endpoint
argument_list|(
name|td
argument_list|)
condition|)
return|return
operator|(
literal|1
operator|)
return|;
comment|/* busy */
comment|/* check error */
if|if
condition|(
name|td
operator|->
name|error_any
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* done */
comment|/* copy data from buffer */
name|rem
operator|=
name|td
operator|->
name|qh
operator|->
name|fixup_actlen
operator|-
name|td
operator|->
name|qh
operator|->
name|fixup_off
expr_stmt|;
if|if
condition|(
name|rem
operator|>
name|td
operator|->
name|remainder
condition|)
name|rem
operator|=
name|td
operator|->
name|remainder
expr_stmt|;
name|usbd_copy_in
argument_list|(
name|td
operator|->
name|pc
argument_list|,
name|td
operator|->
name|offset
argument_list|,
name|td
operator|->
name|qh
operator|->
name|fixup_buf
operator|+
name|td
operator|->
name|qh
operator|->
name|fixup_off
operator|+
literal|8
argument_list|,
name|rem
argument_list|)
expr_stmt|;
name|td
operator|->
name|offset
operator|+=
name|rem
expr_stmt|;
name|td
operator|->
name|remainder
operator|-=
name|rem
expr_stmt|;
name|td
operator|->
name|qh
operator|->
name|fixup_off
operator|+=
name|rem
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
comment|/* done */
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|octusb_host_control_status_tx
parameter_list|(
name|struct
name|octusb_td
modifier|*
name|td
parameter_list|)
block|{
name|int
name|status
decl_stmt|;
comment|/* allocate endpoint and check pending */
if|if
condition|(
name|octusb_host_alloc_endpoint
argument_list|(
name|td
argument_list|)
condition|)
return|return
operator|(
literal|1
operator|)
return|;
comment|/* busy */
comment|/* check error */
if|if
condition|(
name|td
operator|->
name|error_any
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* done */
if|if
condition|(
name|td
operator|->
name|qh
operator|->
name|fixup_complete
operator|!=
literal|0
condition|)
block|{
comment|/* clear complete flag */
name|td
operator|->
name|qh
operator|->
name|fixup_complete
operator|=
literal|0
expr_stmt|;
comment|/* done */
return|return
operator|(
literal|0
operator|)
return|;
block|}
comment|/* do control IN request */
if|if
condition|(
operator|!
operator|(
name|td
operator|->
name|qh
operator|->
name|fixup_buf
index|[
literal|0
index|]
operator|&
name|UE_DIR_IN
operator|)
condition|)
block|{
name|struct
name|octusb_softc
modifier|*
name|sc
decl_stmt|;
comment|/* get softc */
name|sc
operator|=
name|td
operator|->
name|qh
operator|->
name|sc
expr_stmt|;
comment|/* flush data */
name|usb_pc_cpu_flush
argument_list|(
name|td
operator|->
name|qh
operator|->
name|fixup_pc
argument_list|)
expr_stmt|;
comment|/* start USB transfer */
name|status
operator|=
name|cvmx_usb_submit_control
argument_list|(
operator|&
name|sc
operator|->
name|sc_port
index|[
name|td
operator|->
name|qh
operator|->
name|root_port_index
index|]
operator|.
name|state
argument_list|,
name|td
operator|->
name|qh
operator|->
name|ep_handle
argument_list|,
name|td
operator|->
name|qh
operator|->
name|fixup_phys
argument_list|,
name|td
operator|->
name|qh
operator|->
name|fixup_phys
operator|+
literal|8
argument_list|,
name|td
operator|->
name|qh
operator|->
name|fixup_len
argument_list|,
operator|&
name|octusb_complete_cb
argument_list|,
name|td
argument_list|)
expr_stmt|;
comment|/* check status */
if|if
condition|(
name|status
operator|<
literal|0
condition|)
block|{
name|td
operator|->
name|error_any
operator|=
literal|1
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
comment|/* done */
block|}
name|td
operator|->
name|qh
operator|->
name|fixup_handle
operator|=
name|status
expr_stmt|;
name|td
operator|->
name|qh
operator|->
name|fixup_pending
operator|=
literal|1
expr_stmt|;
name|td
operator|->
name|qh
operator|->
name|fixup_complete
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
comment|/* busy */
block|}
return|return
operator|(
literal|0
operator|)
return|;
comment|/* done */
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|octusb_non_control_data_tx
parameter_list|(
name|struct
name|octusb_td
modifier|*
name|td
parameter_list|)
block|{
name|struct
name|octusb_softc
modifier|*
name|sc
decl_stmt|;
name|uint32_t
name|rem
decl_stmt|;
name|int
name|status
decl_stmt|;
comment|/* allocate endpoint and check pending */
if|if
condition|(
name|octusb_host_alloc_endpoint
argument_list|(
name|td
argument_list|)
condition|)
return|return
operator|(
literal|1
operator|)
return|;
comment|/* busy */
comment|/* check error */
if|if
condition|(
name|td
operator|->
name|error_any
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* done */
if|if
condition|(
operator|(
name|td
operator|->
name|qh
operator|->
name|fixup_complete
operator|!=
literal|0
operator|)
operator|&&
operator|(
operator|(
name|td
operator|->
name|qh
operator|->
name|ep_type
operator|&
name|UE_XFERTYPE
operator|)
operator|==
name|UE_ISOCHRONOUS
operator|)
condition|)
block|{
name|td
operator|->
name|qh
operator|->
name|fixup_complete
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
comment|/* done */
block|}
comment|/* check complete */
if|if
condition|(
name|td
operator|->
name|remainder
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|td
operator|->
name|short_pkt
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* complete */
comment|/* else need to send a zero length packet */
name|rem
operator|=
literal|0
expr_stmt|;
name|td
operator|->
name|short_pkt
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
comment|/* get maximum length */
name|rem
operator|=
name|OCTUSB_MAX_FIXUP
operator|%
name|td
operator|->
name|qh
operator|->
name|max_frame_size
expr_stmt|;
name|rem
operator|=
name|OCTUSB_MAX_FIXUP
operator|-
name|rem
expr_stmt|;
if|if
condition|(
name|rem
operator|==
literal|0
condition|)
block|{
comment|/* should not happen */
name|DPRINTFN
argument_list|(
literal|1
argument_list|,
literal|"Fixup buffer is too small\n"
argument_list|)
expr_stmt|;
name|td
operator|->
name|error_any
operator|=
literal|1
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
comment|/* done */
block|}
comment|/* get minimum length */
if|if
condition|(
name|rem
operator|>
name|td
operator|->
name|remainder
condition|)
block|{
name|rem
operator|=
name|td
operator|->
name|remainder
expr_stmt|;
if|if
condition|(
operator|(
name|rem
operator|==
literal|0
operator|)
operator|||
operator|(
name|rem
operator|%
name|td
operator|->
name|qh
operator|->
name|max_frame_size
operator|)
condition|)
name|td
operator|->
name|short_pkt
operator|=
literal|1
expr_stmt|;
block|}
comment|/* copy data into fixup buffer */
name|usbd_copy_out
argument_list|(
name|td
operator|->
name|pc
argument_list|,
name|td
operator|->
name|offset
argument_list|,
name|td
operator|->
name|qh
operator|->
name|fixup_buf
argument_list|,
name|rem
argument_list|)
expr_stmt|;
comment|/* flush data */
name|usb_pc_cpu_flush
argument_list|(
name|td
operator|->
name|qh
operator|->
name|fixup_pc
argument_list|)
expr_stmt|;
comment|/* pre-increment TX buffer offset */
name|td
operator|->
name|offset
operator|+=
name|rem
expr_stmt|;
name|td
operator|->
name|remainder
operator|-=
name|rem
expr_stmt|;
block|}
comment|/* get softc */
name|sc
operator|=
name|td
operator|->
name|qh
operator|->
name|sc
expr_stmt|;
switch|switch
condition|(
name|td
operator|->
name|qh
operator|->
name|ep_type
operator|&
name|UE_XFERTYPE
condition|)
block|{
case|case
name|UE_ISOCHRONOUS
case|:
name|td
operator|->
name|qh
operator|->
name|iso_pkt
operator|.
name|offset
operator|=
literal|0
expr_stmt|;
name|td
operator|->
name|qh
operator|->
name|iso_pkt
operator|.
name|length
operator|=
name|rem
expr_stmt|;
name|td
operator|->
name|qh
operator|->
name|iso_pkt
operator|.
name|status
operator|=
literal|0
expr_stmt|;
comment|/* start USB transfer */
name|status
operator|=
name|cvmx_usb_submit_isochronous
argument_list|(
operator|&
name|sc
operator|->
name|sc_port
index|[
name|td
operator|->
name|qh
operator|->
name|root_port_index
index|]
operator|.
name|state
argument_list|,
name|td
operator|->
name|qh
operator|->
name|ep_handle
argument_list|,
literal|1
argument_list|,
name|CVMX_USB_ISOCHRONOUS_FLAGS_ALLOW_SHORT
operator||
name|CVMX_USB_ISOCHRONOUS_FLAGS_ASAP
argument_list|,
literal|1
argument_list|,
operator|&
name|td
operator|->
name|qh
operator|->
name|iso_pkt
argument_list|,
name|td
operator|->
name|qh
operator|->
name|fixup_phys
argument_list|,
name|rem
argument_list|,
operator|&
name|octusb_complete_cb
argument_list|,
name|td
argument_list|)
expr_stmt|;
break|break;
case|case
name|UE_BULK
case|:
comment|/* start USB transfer */
name|status
operator|=
name|cvmx_usb_submit_bulk
argument_list|(
operator|&
name|sc
operator|->
name|sc_port
index|[
name|td
operator|->
name|qh
operator|->
name|root_port_index
index|]
operator|.
name|state
argument_list|,
name|td
operator|->
name|qh
operator|->
name|ep_handle
argument_list|,
name|td
operator|->
name|qh
operator|->
name|fixup_phys
argument_list|,
name|rem
argument_list|,
operator|&
name|octusb_complete_cb
argument_list|,
name|td
argument_list|)
expr_stmt|;
break|break;
case|case
name|UE_INTERRUPT
case|:
comment|/* start USB transfer (interrupt or interrupt) */
name|status
operator|=
name|cvmx_usb_submit_interrupt
argument_list|(
operator|&
name|sc
operator|->
name|sc_port
index|[
name|td
operator|->
name|qh
operator|->
name|root_port_index
index|]
operator|.
name|state
argument_list|,
name|td
operator|->
name|qh
operator|->
name|ep_handle
argument_list|,
name|td
operator|->
name|qh
operator|->
name|fixup_phys
argument_list|,
name|rem
argument_list|,
operator|&
name|octusb_complete_cb
argument_list|,
name|td
argument_list|)
expr_stmt|;
break|break;
default|default:
name|status
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
comment|/* check status */
if|if
condition|(
name|status
operator|<
literal|0
condition|)
block|{
name|td
operator|->
name|error_any
operator|=
literal|1
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
comment|/* done */
block|}
name|td
operator|->
name|qh
operator|->
name|fixup_handle
operator|=
name|status
expr_stmt|;
name|td
operator|->
name|qh
operator|->
name|fixup_len
operator|=
name|rem
expr_stmt|;
name|td
operator|->
name|qh
operator|->
name|fixup_pending
operator|=
literal|1
expr_stmt|;
name|td
operator|->
name|qh
operator|->
name|fixup_complete
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
comment|/* busy */
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|octusb_non_control_data_rx
parameter_list|(
name|struct
name|octusb_td
modifier|*
name|td
parameter_list|)
block|{
name|struct
name|octusb_softc
modifier|*
name|sc
decl_stmt|;
name|uint32_t
name|rem
decl_stmt|;
name|int
name|status
decl_stmt|;
name|uint8_t
name|got_short
decl_stmt|;
comment|/* allocate endpoint and check pending */
if|if
condition|(
name|octusb_host_alloc_endpoint
argument_list|(
name|td
argument_list|)
condition|)
return|return
operator|(
literal|1
operator|)
return|;
comment|/* busy */
comment|/* check error */
if|if
condition|(
name|td
operator|->
name|error_any
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* done */
name|got_short
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|td
operator|->
name|qh
operator|->
name|fixup_complete
operator|!=
literal|0
condition|)
block|{
comment|/* invalidate data */
name|usb_pc_cpu_invalidate
argument_list|(
name|td
operator|->
name|qh
operator|->
name|fixup_pc
argument_list|)
expr_stmt|;
name|rem
operator|=
name|td
operator|->
name|qh
operator|->
name|fixup_actlen
expr_stmt|;
comment|/* verify transfer length */
if|if
condition|(
name|rem
operator|!=
name|td
operator|->
name|qh
operator|->
name|fixup_len
condition|)
block|{
if|if
condition|(
name|rem
operator|<
name|td
operator|->
name|qh
operator|->
name|fixup_len
condition|)
block|{
comment|/* we have a short packet */
name|td
operator|->
name|short_pkt
operator|=
literal|1
expr_stmt|;
name|got_short
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
comment|/* invalid USB packet */
name|td
operator|->
name|error_any
operator|=
literal|1
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
comment|/* we are complete */
block|}
block|}
comment|/* copy data into fixup buffer */
name|usbd_copy_in
argument_list|(
name|td
operator|->
name|pc
argument_list|,
name|td
operator|->
name|offset
argument_list|,
name|td
operator|->
name|qh
operator|->
name|fixup_buf
argument_list|,
name|rem
argument_list|)
expr_stmt|;
comment|/* post-increment RX buffer offset */
name|td
operator|->
name|offset
operator|+=
name|rem
expr_stmt|;
name|td
operator|->
name|remainder
operator|-=
name|rem
expr_stmt|;
name|td
operator|->
name|qh
operator|->
name|fixup_complete
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|td
operator|->
name|qh
operator|->
name|ep_type
operator|&
name|UE_XFERTYPE
operator|)
operator|==
name|UE_ISOCHRONOUS
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* done */
block|}
comment|/* check if we are complete */
if|if
condition|(
operator|(
name|td
operator|->
name|remainder
operator|==
literal|0
operator|)
operator|||
name|got_short
condition|)
block|{
if|if
condition|(
name|td
operator|->
name|short_pkt
condition|)
block|{
comment|/* we are complete */
return|return
operator|(
literal|0
operator|)
return|;
block|}
comment|/* else need to receive a zero length packet */
name|rem
operator|=
literal|0
expr_stmt|;
name|td
operator|->
name|short_pkt
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
comment|/* get maximum length */
name|rem
operator|=
name|OCTUSB_MAX_FIXUP
operator|%
name|td
operator|->
name|qh
operator|->
name|max_frame_size
expr_stmt|;
name|rem
operator|=
name|OCTUSB_MAX_FIXUP
operator|-
name|rem
expr_stmt|;
if|if
condition|(
name|rem
operator|==
literal|0
condition|)
block|{
comment|/* should not happen */
name|DPRINTFN
argument_list|(
literal|1
argument_list|,
literal|"Fixup buffer is too small\n"
argument_list|)
expr_stmt|;
name|td
operator|->
name|error_any
operator|=
literal|1
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
comment|/* done */
block|}
comment|/* get minimum length */
if|if
condition|(
name|rem
operator|>
name|td
operator|->
name|remainder
condition|)
name|rem
operator|=
name|td
operator|->
name|remainder
expr_stmt|;
block|}
comment|/* invalidate data */
name|usb_pc_cpu_invalidate
argument_list|(
name|td
operator|->
name|qh
operator|->
name|fixup_pc
argument_list|)
expr_stmt|;
comment|/* get softc */
name|sc
operator|=
name|td
operator|->
name|qh
operator|->
name|sc
expr_stmt|;
switch|switch
condition|(
name|td
operator|->
name|qh
operator|->
name|ep_type
operator|&
name|UE_XFERTYPE
condition|)
block|{
case|case
name|UE_ISOCHRONOUS
case|:
name|td
operator|->
name|qh
operator|->
name|iso_pkt
operator|.
name|offset
operator|=
literal|0
expr_stmt|;
name|td
operator|->
name|qh
operator|->
name|iso_pkt
operator|.
name|length
operator|=
name|rem
expr_stmt|;
name|td
operator|->
name|qh
operator|->
name|iso_pkt
operator|.
name|status
operator|=
literal|0
expr_stmt|;
comment|/* start USB transfer */
name|status
operator|=
name|cvmx_usb_submit_isochronous
argument_list|(
operator|&
name|sc
operator|->
name|sc_port
index|[
name|td
operator|->
name|qh
operator|->
name|root_port_index
index|]
operator|.
name|state
argument_list|,
name|td
operator|->
name|qh
operator|->
name|ep_handle
argument_list|,
literal|1
argument_list|,
name|CVMX_USB_ISOCHRONOUS_FLAGS_ALLOW_SHORT
operator||
name|CVMX_USB_ISOCHRONOUS_FLAGS_ASAP
argument_list|,
literal|1
argument_list|,
operator|&
name|td
operator|->
name|qh
operator|->
name|iso_pkt
argument_list|,
name|td
operator|->
name|qh
operator|->
name|fixup_phys
argument_list|,
name|rem
argument_list|,
operator|&
name|octusb_complete_cb
argument_list|,
name|td
argument_list|)
expr_stmt|;
break|break;
case|case
name|UE_BULK
case|:
comment|/* start USB transfer */
name|status
operator|=
name|cvmx_usb_submit_bulk
argument_list|(
operator|&
name|sc
operator|->
name|sc_port
index|[
name|td
operator|->
name|qh
operator|->
name|root_port_index
index|]
operator|.
name|state
argument_list|,
name|td
operator|->
name|qh
operator|->
name|ep_handle
argument_list|,
name|td
operator|->
name|qh
operator|->
name|fixup_phys
argument_list|,
name|rem
argument_list|,
operator|&
name|octusb_complete_cb
argument_list|,
name|td
argument_list|)
expr_stmt|;
break|break;
case|case
name|UE_INTERRUPT
case|:
comment|/* start USB transfer */
name|status
operator|=
name|cvmx_usb_submit_interrupt
argument_list|(
operator|&
name|sc
operator|->
name|sc_port
index|[
name|td
operator|->
name|qh
operator|->
name|root_port_index
index|]
operator|.
name|state
argument_list|,
name|td
operator|->
name|qh
operator|->
name|ep_handle
argument_list|,
name|td
operator|->
name|qh
operator|->
name|fixup_phys
argument_list|,
name|rem
argument_list|,
operator|&
name|octusb_complete_cb
argument_list|,
name|td
argument_list|)
expr_stmt|;
break|break;
default|default:
name|status
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
comment|/* check status */
if|if
condition|(
name|status
operator|<
literal|0
condition|)
block|{
name|td
operator|->
name|error_any
operator|=
literal|1
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
comment|/* done */
block|}
name|td
operator|->
name|qh
operator|->
name|fixup_handle
operator|=
name|status
expr_stmt|;
name|td
operator|->
name|qh
operator|->
name|fixup_len
operator|=
name|rem
expr_stmt|;
name|td
operator|->
name|qh
operator|->
name|fixup_pending
operator|=
literal|1
expr_stmt|;
name|td
operator|->
name|qh
operator|->
name|fixup_complete
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
comment|/* busy */
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|octusb_xfer_do_fifo
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|)
block|{
name|struct
name|octusb_td
modifier|*
name|td
decl_stmt|;
name|DPRINTFN
argument_list|(
literal|8
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|td
operator|=
name|xfer
operator|->
name|td_transfer_cache
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
if|if
condition|(
call|(
name|td
operator|->
name|func
call|)
argument_list|(
name|td
argument_list|)
condition|)
block|{
comment|/* operation in progress */
break|break;
block|}
if|if
condition|(
operator|(
operator|(
name|void
operator|*
operator|)
name|td
operator|)
operator|==
name|xfer
operator|->
name|td_transfer_last
condition|)
block|{
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|td
operator|->
name|error_any
condition|)
block|{
goto|goto
name|done
goto|;
block|}
elseif|else
if|if
condition|(
name|td
operator|->
name|remainder
operator|>
literal|0
condition|)
block|{
comment|/* 			 * We had a short transfer. If there is no 			 * alternate next, stop processing ! 			 */
if|if
condition|(
name|td
operator|->
name|alt_next
operator|==
literal|0
condition|)
goto|goto
name|done
goto|;
block|}
comment|/* 		 * Fetch the next transfer descriptor and transfer 		 * some flags to the next transfer descriptor 		 */
name|td
operator|=
name|td
operator|->
name|obj_next
expr_stmt|;
name|xfer
operator|->
name|td_transfer_cache
operator|=
name|td
expr_stmt|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
comment|/* not complete */
name|done
label|:
comment|/* compute all actual lengths */
name|octusb_standard_done
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
comment|/* complete */
block|}
end_function

begin_function
specifier|static
name|usb_error_t
name|octusb_standard_done_sub
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|)
block|{
name|struct
name|octusb_td
modifier|*
name|td
decl_stmt|;
name|uint32_t
name|len
decl_stmt|;
name|usb_error_t
name|error
decl_stmt|;
name|DPRINTFN
argument_list|(
literal|8
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|td
operator|=
name|xfer
operator|->
name|td_transfer_cache
expr_stmt|;
do|do
block|{
name|len
operator|=
name|td
operator|->
name|remainder
expr_stmt|;
if|if
condition|(
name|xfer
operator|->
name|aframes
operator|!=
name|xfer
operator|->
name|nframes
condition|)
block|{
comment|/* 		         * Verify the length and subtract 		         * the remainder from "frlengths[]": 		         */
if|if
condition|(
name|len
operator|>
name|xfer
operator|->
name|frlengths
index|[
name|xfer
operator|->
name|aframes
index|]
condition|)
block|{
name|td
operator|->
name|error_any
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|xfer
operator|->
name|frlengths
index|[
name|xfer
operator|->
name|aframes
index|]
operator|-=
name|len
expr_stmt|;
block|}
block|}
comment|/* Check for transfer error */
if|if
condition|(
name|td
operator|->
name|error_any
condition|)
block|{
comment|/* the transfer is finished */
name|error
operator|=
name|td
operator|->
name|error_stall
condition|?
name|USB_ERR_STALLED
else|:
name|USB_ERR_IOERROR
expr_stmt|;
name|td
operator|=
name|NULL
expr_stmt|;
break|break;
block|}
comment|/* Check for short transfer */
if|if
condition|(
name|len
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|xfer
operator|->
name|flags_int
operator|.
name|short_frames_ok
condition|)
block|{
comment|/* follow alt next */
if|if
condition|(
name|td
operator|->
name|alt_next
condition|)
block|{
name|td
operator|=
name|td
operator|->
name|obj_next
expr_stmt|;
block|}
else|else
block|{
name|td
operator|=
name|NULL
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* the transfer is finished */
name|td
operator|=
name|NULL
expr_stmt|;
block|}
name|error
operator|=
literal|0
expr_stmt|;
break|break;
block|}
name|td
operator|=
name|td
operator|->
name|obj_next
expr_stmt|;
comment|/* this USB frame is complete */
name|error
operator|=
literal|0
expr_stmt|;
break|break;
block|}
do|while
condition|(
literal|0
condition|)
do|;
comment|/* update transfer cache */
name|xfer
operator|->
name|td_transfer_cache
operator|=
name|td
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|octusb_standard_done
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|)
block|{
name|struct
name|octusb_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|octusb_qh
modifier|*
name|qh
decl_stmt|;
name|usb_error_t
name|error
init|=
literal|0
decl_stmt|;
name|DPRINTFN
argument_list|(
literal|12
argument_list|,
literal|"xfer=%p endpoint=%p transfer done\n"
argument_list|,
name|xfer
argument_list|,
name|xfer
operator|->
name|endpoint
argument_list|)
expr_stmt|;
comment|/* reset scanner */
name|xfer
operator|->
name|td_transfer_cache
operator|=
name|xfer
operator|->
name|td_transfer_first
expr_stmt|;
if|if
condition|(
name|xfer
operator|->
name|flags_int
operator|.
name|control_xfr
condition|)
block|{
if|if
condition|(
name|xfer
operator|->
name|flags_int
operator|.
name|control_hdr
condition|)
name|error
operator|=
name|octusb_standard_done_sub
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
name|xfer
operator|->
name|aframes
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|xfer
operator|->
name|td_transfer_cache
operator|==
name|NULL
condition|)
goto|goto
name|done
goto|;
block|}
while|while
condition|(
name|xfer
operator|->
name|aframes
operator|!=
name|xfer
operator|->
name|nframes
condition|)
block|{
name|error
operator|=
name|octusb_standard_done_sub
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
name|xfer
operator|->
name|aframes
operator|++
expr_stmt|;
if|if
condition|(
name|xfer
operator|->
name|td_transfer_cache
operator|==
name|NULL
condition|)
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|xfer
operator|->
name|flags_int
operator|.
name|control_xfr
operator|&&
operator|!
name|xfer
operator|->
name|flags_int
operator|.
name|control_act
condition|)
name|error
operator|=
name|octusb_standard_done_sub
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
name|done
label|:
comment|/* update data toggle */
name|qh
operator|=
name|xfer
operator|->
name|qh_start
index|[
literal|0
index|]
expr_stmt|;
name|sc
operator|=
name|qh
operator|->
name|sc
expr_stmt|;
name|xfer
operator|->
name|endpoint
operator|->
name|toggle_next
operator|=
name|cvmx_usb_get_toggle
argument_list|(
operator|&
name|sc
operator|->
name|sc_port
index|[
name|qh
operator|->
name|root_port_index
index|]
operator|.
name|state
argument_list|,
name|qh
operator|->
name|ep_handle
argument_list|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|octusb_device_done
argument_list|(
name|xfer
argument_list|,
name|error
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|octusb_interrupt_poll
parameter_list|(
name|struct
name|octusb_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|usb_xfer
modifier|*
name|xfer
decl_stmt|;
name|uint8_t
name|x
decl_stmt|;
comment|/* poll all ports */
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|!=
name|sc
operator|->
name|sc_noport
condition|;
name|x
operator|++
control|)
name|cvmx_usb_poll
argument_list|(
operator|&
name|sc
operator|->
name|sc_port
index|[
name|x
index|]
operator|.
name|state
argument_list|)
expr_stmt|;
name|repeat
label|:
name|TAILQ_FOREACH
argument_list|(
argument|xfer
argument_list|,
argument|&sc->sc_bus.intr_q.head
argument_list|,
argument|wait_entry
argument_list|)
block|{
if|if
condition|(
operator|!
name|octusb_xfer_do_fifo
argument_list|(
name|xfer
argument_list|)
condition|)
block|{
comment|/* queue has been modified */
goto|goto
name|repeat
goto|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|octusb_start_standard_chain
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|)
block|{
name|DPRINTFN
argument_list|(
literal|8
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
comment|/* poll one time */
if|if
condition|(
name|octusb_xfer_do_fifo
argument_list|(
name|xfer
argument_list|)
condition|)
block|{
comment|/* put transfer on interrupt queue */
name|usbd_transfer_enqueue
argument_list|(
operator|&
name|xfer
operator|->
name|xroot
operator|->
name|bus
operator|->
name|intr_q
argument_list|,
name|xfer
argument_list|)
expr_stmt|;
comment|/* start timeout, if any */
if|if
condition|(
name|xfer
operator|->
name|timeout
operator|!=
literal|0
condition|)
block|{
name|usbd_transfer_timeout_ms
argument_list|(
name|xfer
argument_list|,
operator|&
name|octusb_timeout
argument_list|,
name|xfer
operator|->
name|timeout
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|void
name|octusb_iterate_hw_softc
parameter_list|(
name|struct
name|usb_bus
modifier|*
name|bus
parameter_list|,
name|usb_bus_mem_sub_cb_t
modifier|*
name|cb
parameter_list|)
block|{  }
end_function

begin_function
name|usb_error_t
name|octusb_init
parameter_list|(
name|struct
name|octusb_softc
modifier|*
name|sc
parameter_list|)
block|{
name|cvmx_usb_initialize_flags_t
name|flags
decl_stmt|;
name|int
name|status
decl_stmt|;
name|uint8_t
name|x
decl_stmt|;
comment|/* flush all cache into memory */
name|usb_bus_mem_flush_all
argument_list|(
operator|&
name|sc
operator|->
name|sc_bus
argument_list|,
operator|&
name|octusb_iterate_hw_softc
argument_list|)
expr_stmt|;
comment|/* set up the bus struct */
name|sc
operator|->
name|sc_bus
operator|.
name|methods
operator|=
operator|&
name|octusb_bus_methods
expr_stmt|;
comment|/* get number of ports */
name|sc
operator|->
name|sc_noport
operator|=
name|cvmx_usb_get_num_ports
argument_list|()
expr_stmt|;
comment|/* check number of ports */
if|if
condition|(
name|sc
operator|->
name|sc_noport
operator|>
name|OCTUSB_MAX_PORTS
condition|)
name|sc
operator|->
name|sc_noport
operator|=
name|OCTUSB_MAX_PORTS
expr_stmt|;
comment|/* set USB revision */
name|sc
operator|->
name|sc_bus
operator|.
name|usbrev
operator|=
name|USB_REV_2_0
expr_stmt|;
comment|/* flags for port initialization */
name|flags
operator|=
name|CVMX_USB_INITIALIZE_FLAGS_CLOCK_AUTO
expr_stmt|;
ifdef|#
directive|ifdef
name|USB_DEBUG
if|if
condition|(
name|octusbdebug
operator|>
literal|100
condition|)
name|flags
operator||=
name|CVMX_USB_INITIALIZE_FLAGS_DEBUG_ALL
expr_stmt|;
endif|#
directive|endif
name|USB_BUS_LOCK
argument_list|(
operator|&
name|sc
operator|->
name|sc_bus
argument_list|)
expr_stmt|;
comment|/* setup all ports */
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|!=
name|sc
operator|->
name|sc_noport
condition|;
name|x
operator|++
control|)
block|{
name|status
operator|=
name|cvmx_usb_initialize
argument_list|(
operator|&
name|sc
operator|->
name|sc_port
index|[
name|x
index|]
operator|.
name|state
argument_list|,
name|x
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|<
literal|0
condition|)
name|sc
operator|->
name|sc_port
index|[
name|x
index|]
operator|.
name|disabled
operator|=
literal|1
expr_stmt|;
block|}
name|USB_BUS_UNLOCK
argument_list|(
operator|&
name|sc
operator|->
name|sc_bus
argument_list|)
expr_stmt|;
comment|/* catch lost interrupts */
name|octusb_do_poll
argument_list|(
operator|&
name|sc
operator|->
name|sc_bus
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|usb_error_t
name|octusb_uninit
parameter_list|(
name|struct
name|octusb_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint8_t
name|x
decl_stmt|;
name|USB_BUS_LOCK
argument_list|(
operator|&
name|sc
operator|->
name|sc_bus
argument_list|)
expr_stmt|;
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|!=
name|sc
operator|->
name|sc_noport
condition|;
name|x
operator|++
control|)
block|{
if|if
condition|(
name|sc
operator|->
name|sc_port
index|[
name|x
index|]
operator|.
name|disabled
operator|==
literal|0
condition|)
name|cvmx_usb_shutdown
argument_list|(
operator|&
name|sc
operator|->
name|sc_port
index|[
name|x
index|]
operator|.
name|state
argument_list|)
expr_stmt|;
block|}
name|USB_BUS_UNLOCK
argument_list|(
operator|&
name|sc
operator|->
name|sc_bus
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|octusb_suspend
parameter_list|(
name|struct
name|octusb_softc
modifier|*
name|sc
parameter_list|)
block|{
comment|/* TODO */
block|}
end_function

begin_function
specifier|static
name|void
name|octusb_resume
parameter_list|(
name|struct
name|octusb_softc
modifier|*
name|sc
parameter_list|)
block|{
comment|/* TODO */
block|}
end_function

begin_comment
comment|/*------------------------------------------------------------------------*  *	octusb_interrupt - OCTUSB interrupt handler  *------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|octusb_interrupt
parameter_list|(
name|struct
name|octusb_softc
modifier|*
name|sc
parameter_list|)
block|{
name|USB_BUS_LOCK
argument_list|(
operator|&
name|sc
operator|->
name|sc_bus
argument_list|)
expr_stmt|;
name|DPRINTFN
argument_list|(
literal|16
argument_list|,
literal|"real interrupt\n"
argument_list|)
expr_stmt|;
comment|/* poll all the USB transfers */
name|octusb_interrupt_poll
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|USB_BUS_UNLOCK
argument_list|(
operator|&
name|sc
operator|->
name|sc_bus
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*------------------------------------------------------------------------*  *	octusb_timeout - OCTUSB transfer timeout handler  *------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|octusb_timeout
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|usb_xfer
modifier|*
name|xfer
init|=
name|arg
decl_stmt|;
name|DPRINTF
argument_list|(
literal|"xfer=%p\n"
argument_list|,
name|xfer
argument_list|)
expr_stmt|;
name|USB_BUS_LOCK_ASSERT
argument_list|(
name|xfer
operator|->
name|xroot
operator|->
name|bus
argument_list|,
name|MA_OWNED
argument_list|)
expr_stmt|;
comment|/* transfer is transferred */
name|octusb_device_done
argument_list|(
name|xfer
argument_list|,
name|USB_ERR_TIMEOUT
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*------------------------------------------------------------------------*  *	octusb_do_poll - OCTUSB poll transfers  *------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|octusb_do_poll
parameter_list|(
name|struct
name|usb_bus
modifier|*
name|bus
parameter_list|)
block|{
name|struct
name|octusb_softc
modifier|*
name|sc
init|=
name|OCTUSB_BUS2SC
argument_list|(
name|bus
argument_list|)
decl_stmt|;
name|USB_BUS_LOCK
argument_list|(
operator|&
name|sc
operator|->
name|sc_bus
argument_list|)
expr_stmt|;
name|octusb_interrupt_poll
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|USB_BUS_UNLOCK
argument_list|(
operator|&
name|sc
operator|->
name|sc_bus
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|octusb_setup_standard_chain_sub
parameter_list|(
name|struct
name|octusb_std_temp
modifier|*
name|temp
parameter_list|)
block|{
name|struct
name|octusb_td
modifier|*
name|td
decl_stmt|;
comment|/* get current Transfer Descriptor */
name|td
operator|=
name|temp
operator|->
name|td_next
expr_stmt|;
name|temp
operator|->
name|td
operator|=
name|td
expr_stmt|;
comment|/* prepare for next TD */
name|temp
operator|->
name|td_next
operator|=
name|td
operator|->
name|obj_next
expr_stmt|;
comment|/* fill out the Transfer Descriptor */
name|td
operator|->
name|func
operator|=
name|temp
operator|->
name|func
expr_stmt|;
name|td
operator|->
name|pc
operator|=
name|temp
operator|->
name|pc
expr_stmt|;
name|td
operator|->
name|offset
operator|=
name|temp
operator|->
name|offset
expr_stmt|;
name|td
operator|->
name|remainder
operator|=
name|temp
operator|->
name|len
expr_stmt|;
name|td
operator|->
name|error_any
operator|=
literal|0
expr_stmt|;
name|td
operator|->
name|error_stall
operator|=
literal|0
expr_stmt|;
name|td
operator|->
name|short_pkt
operator|=
name|temp
operator|->
name|short_pkt
expr_stmt|;
name|td
operator|->
name|alt_next
operator|=
name|temp
operator|->
name|setup_alt_next
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|octusb_setup_standard_chain
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|)
block|{
name|struct
name|octusb_std_temp
name|temp
decl_stmt|;
name|struct
name|octusb_td
modifier|*
name|td
decl_stmt|;
name|uint32_t
name|x
decl_stmt|;
name|DPRINTFN
argument_list|(
literal|9
argument_list|,
literal|"addr=%d endpt=%d sumlen=%d speed=%d\n"
argument_list|,
name|xfer
operator|->
name|address
argument_list|,
name|UE_GET_ADDR
argument_list|(
name|xfer
operator|->
name|endpointno
argument_list|)
argument_list|,
name|xfer
operator|->
name|sumlen
argument_list|,
name|usbd_get_speed
argument_list|(
name|xfer
operator|->
name|xroot
operator|->
name|udev
argument_list|)
argument_list|)
expr_stmt|;
comment|/* setup starting point */
name|td
operator|=
name|xfer
operator|->
name|td_start
index|[
literal|0
index|]
expr_stmt|;
name|xfer
operator|->
name|td_transfer_first
operator|=
name|td
expr_stmt|;
name|xfer
operator|->
name|td_transfer_cache
operator|=
name|td
expr_stmt|;
name|temp
operator|.
name|td
operator|=
name|NULL
expr_stmt|;
name|temp
operator|.
name|td_next
operator|=
name|td
expr_stmt|;
name|temp
operator|.
name|setup_alt_next
operator|=
name|xfer
operator|->
name|flags_int
operator|.
name|short_frames_ok
expr_stmt|;
name|temp
operator|.
name|offset
operator|=
literal|0
expr_stmt|;
comment|/* check if we should prepend a setup message */
if|if
condition|(
name|xfer
operator|->
name|flags_int
operator|.
name|control_xfr
condition|)
block|{
if|if
condition|(
name|xfer
operator|->
name|flags_int
operator|.
name|control_hdr
condition|)
block|{
name|temp
operator|.
name|func
operator|=
operator|&
name|octusb_host_control_header_tx
expr_stmt|;
name|temp
operator|.
name|len
operator|=
name|xfer
operator|->
name|frlengths
index|[
literal|0
index|]
expr_stmt|;
name|temp
operator|.
name|pc
operator|=
name|xfer
operator|->
name|frbuffers
operator|+
literal|0
expr_stmt|;
name|temp
operator|.
name|short_pkt
operator|=
name|temp
operator|.
name|len
condition|?
literal|1
else|:
literal|0
expr_stmt|;
comment|/* check for last frame */
if|if
condition|(
name|xfer
operator|->
name|nframes
operator|==
literal|1
condition|)
block|{
comment|/* 				 * no STATUS stage yet, SETUP is 				 * last 				 */
if|if
condition|(
name|xfer
operator|->
name|flags_int
operator|.
name|control_act
condition|)
name|temp
operator|.
name|setup_alt_next
operator|=
literal|0
expr_stmt|;
block|}
name|octusb_setup_standard_chain_sub
argument_list|(
operator|&
name|temp
argument_list|)
expr_stmt|;
block|}
name|x
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|x
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|x
operator|!=
name|xfer
operator|->
name|nframes
condition|)
block|{
if|if
condition|(
name|xfer
operator|->
name|endpointno
operator|&
name|UE_DIR_IN
condition|)
block|{
if|if
condition|(
name|xfer
operator|->
name|flags_int
operator|.
name|control_xfr
condition|)
name|temp
operator|.
name|func
operator|=
operator|&
name|octusb_host_control_data_rx
expr_stmt|;
else|else
name|temp
operator|.
name|func
operator|=
operator|&
name|octusb_non_control_data_rx
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|xfer
operator|->
name|flags_int
operator|.
name|control_xfr
condition|)
name|temp
operator|.
name|func
operator|=
operator|&
name|octusb_host_control_data_tx
expr_stmt|;
else|else
name|temp
operator|.
name|func
operator|=
operator|&
name|octusb_non_control_data_tx
expr_stmt|;
block|}
comment|/* setup "pc" pointer */
name|temp
operator|.
name|pc
operator|=
name|xfer
operator|->
name|frbuffers
operator|+
name|x
expr_stmt|;
block|}
while|while
condition|(
name|x
operator|!=
name|xfer
operator|->
name|nframes
condition|)
block|{
comment|/* DATA0 or DATA1 message */
name|temp
operator|.
name|len
operator|=
name|xfer
operator|->
name|frlengths
index|[
name|x
index|]
expr_stmt|;
name|x
operator|++
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|xfer
operator|->
name|nframes
condition|)
block|{
if|if
condition|(
name|xfer
operator|->
name|flags_int
operator|.
name|control_xfr
condition|)
block|{
comment|/* no STATUS stage yet, DATA is last */
if|if
condition|(
name|xfer
operator|->
name|flags_int
operator|.
name|control_act
condition|)
name|temp
operator|.
name|setup_alt_next
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|temp
operator|.
name|setup_alt_next
operator|=
literal|0
expr_stmt|;
block|}
block|}
if|if
condition|(
name|temp
operator|.
name|len
operator|==
literal|0
condition|)
block|{
comment|/* make sure that we send an USB packet */
name|temp
operator|.
name|short_pkt
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
comment|/* regular data transfer */
name|temp
operator|.
name|short_pkt
operator|=
operator|(
name|xfer
operator|->
name|flags
operator|.
name|force_short_xfer
operator|)
condition|?
literal|0
else|:
literal|1
expr_stmt|;
block|}
name|octusb_setup_standard_chain_sub
argument_list|(
operator|&
name|temp
argument_list|)
expr_stmt|;
if|if
condition|(
name|xfer
operator|->
name|flags_int
operator|.
name|isochronous_xfr
condition|)
block|{
comment|/* get next data offset */
name|temp
operator|.
name|offset
operator|+=
name|temp
operator|.
name|len
expr_stmt|;
block|}
else|else
block|{
comment|/* get next Page Cache pointer */
name|temp
operator|.
name|pc
operator|=
name|xfer
operator|->
name|frbuffers
operator|+
name|x
expr_stmt|;
block|}
block|}
comment|/* check if we should append a status stage */
if|if
condition|(
name|xfer
operator|->
name|flags_int
operator|.
name|control_xfr
operator|&&
operator|!
name|xfer
operator|->
name|flags_int
operator|.
name|control_act
condition|)
block|{
name|temp
operator|.
name|func
operator|=
operator|&
name|octusb_host_control_status_tx
expr_stmt|;
name|temp
operator|.
name|len
operator|=
literal|0
expr_stmt|;
name|temp
operator|.
name|pc
operator|=
name|NULL
expr_stmt|;
name|temp
operator|.
name|short_pkt
operator|=
literal|0
expr_stmt|;
name|temp
operator|.
name|setup_alt_next
operator|=
literal|0
expr_stmt|;
name|octusb_setup_standard_chain_sub
argument_list|(
operator|&
name|temp
argument_list|)
expr_stmt|;
block|}
comment|/* must have at least one frame! */
name|td
operator|=
name|temp
operator|.
name|td
expr_stmt|;
name|xfer
operator|->
name|td_transfer_last
operator|=
name|td
expr_stmt|;
comment|/* properly setup QH */
name|td
operator|->
name|qh
operator|->
name|ep_allocated
operator|=
literal|0
expr_stmt|;
name|td
operator|->
name|qh
operator|->
name|ep_toggle_next
operator|=
name|xfer
operator|->
name|endpoint
operator|->
name|toggle_next
condition|?
literal|1
else|:
literal|0
expr_stmt|;
block|}
end_function

begin_comment
comment|/*------------------------------------------------------------------------*  *	octusb_device_done - OCTUSB transfers done code  *  * NOTE: This function can be called more than one time in a row.  *------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|octusb_device_done
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|,
name|usb_error_t
name|error
parameter_list|)
block|{
name|USB_BUS_LOCK_ASSERT
argument_list|(
name|xfer
operator|->
name|xroot
operator|->
name|bus
argument_list|,
name|MA_OWNED
argument_list|)
expr_stmt|;
name|DPRINTFN
argument_list|(
literal|2
argument_list|,
literal|"xfer=%p, endpoint=%p, error=%d\n"
argument_list|,
name|xfer
argument_list|,
name|xfer
operator|->
name|endpoint
argument_list|,
name|error
argument_list|)
expr_stmt|;
comment|/* 	 * 1) Free any endpoints. 	 * 2) Control transfers can be split and we should not re-open 	 *    the data pipe between transactions unless there is an error. 	 */
if|if
condition|(
operator|(
name|xfer
operator|->
name|flags_int
operator|.
name|control_act
operator|==
literal|0
operator|)
operator|||
operator|(
name|error
operator|!=
literal|0
operator|)
condition|)
block|{
name|struct
name|octusb_td
modifier|*
name|td
decl_stmt|;
name|td
operator|=
name|xfer
operator|->
name|td_start
index|[
literal|0
index|]
expr_stmt|;
name|octusb_host_free_endpoint
argument_list|(
name|td
argument_list|)
expr_stmt|;
block|}
comment|/* dequeue transfer and start next transfer */
name|usbd_transfer_done
argument_list|(
name|xfer
argument_list|,
name|error
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*------------------------------------------------------------------------*  * octusb bulk support  *------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|octusb_device_bulk_open
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|)
block|{
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|octusb_device_bulk_close
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|)
block|{
name|octusb_device_done
argument_list|(
name|xfer
argument_list|,
name|USB_ERR_CANCELLED
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|octusb_device_bulk_enter
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|)
block|{
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|octusb_device_bulk_start
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|)
block|{
comment|/* setup TDs */
name|octusb_setup_standard_chain
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
name|octusb_start_standard_chain
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
name|struct
name|usb_pipe_methods
name|octusb_device_bulk_methods
init|=
block|{
operator|.
name|open
operator|=
name|octusb_device_bulk_open
block|,
operator|.
name|close
operator|=
name|octusb_device_bulk_close
block|,
operator|.
name|enter
operator|=
name|octusb_device_bulk_enter
block|,
operator|.
name|start
operator|=
name|octusb_device_bulk_start
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*------------------------------------------------------------------------*  * octusb control support  *------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|octusb_device_ctrl_open
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|)
block|{
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|octusb_device_ctrl_close
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|)
block|{
name|octusb_device_done
argument_list|(
name|xfer
argument_list|,
name|USB_ERR_CANCELLED
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|octusb_device_ctrl_enter
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|)
block|{
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|octusb_device_ctrl_start
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|)
block|{
comment|/* setup TDs */
name|octusb_setup_standard_chain
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
name|octusb_start_standard_chain
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
name|struct
name|usb_pipe_methods
name|octusb_device_ctrl_methods
init|=
block|{
operator|.
name|open
operator|=
name|octusb_device_ctrl_open
block|,
operator|.
name|close
operator|=
name|octusb_device_ctrl_close
block|,
operator|.
name|enter
operator|=
name|octusb_device_ctrl_enter
block|,
operator|.
name|start
operator|=
name|octusb_device_ctrl_start
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*------------------------------------------------------------------------*  * octusb interrupt support  *------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|octusb_device_intr_open
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|)
block|{
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|octusb_device_intr_close
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|)
block|{
name|octusb_device_done
argument_list|(
name|xfer
argument_list|,
name|USB_ERR_CANCELLED
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|octusb_device_intr_enter
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|)
block|{
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|octusb_device_intr_start
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|)
block|{
comment|/* setup TDs */
name|octusb_setup_standard_chain
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
name|octusb_start_standard_chain
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
name|struct
name|usb_pipe_methods
name|octusb_device_intr_methods
init|=
block|{
operator|.
name|open
operator|=
name|octusb_device_intr_open
block|,
operator|.
name|close
operator|=
name|octusb_device_intr_close
block|,
operator|.
name|enter
operator|=
name|octusb_device_intr_enter
block|,
operator|.
name|start
operator|=
name|octusb_device_intr_start
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*------------------------------------------------------------------------*  * octusb isochronous support  *------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|octusb_device_isoc_open
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|)
block|{
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|octusb_device_isoc_close
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|)
block|{
name|octusb_device_done
argument_list|(
name|xfer
argument_list|,
name|USB_ERR_CANCELLED
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|octusb_device_isoc_enter
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|)
block|{
name|struct
name|octusb_softc
modifier|*
name|sc
init|=
name|OCTUSB_BUS2SC
argument_list|(
name|xfer
operator|->
name|xroot
operator|->
name|bus
argument_list|)
decl_stmt|;
name|uint32_t
name|temp
decl_stmt|;
name|uint32_t
name|frame_count
decl_stmt|;
name|uint32_t
name|fs_frames
decl_stmt|;
name|DPRINTFN
argument_list|(
literal|5
argument_list|,
literal|"xfer=%p next=%d nframes=%d\n"
argument_list|,
name|xfer
argument_list|,
name|xfer
operator|->
name|endpoint
operator|->
name|isoc_next
argument_list|,
name|xfer
operator|->
name|nframes
argument_list|)
expr_stmt|;
comment|/* get the current frame index */
name|frame_count
operator|=
name|cvmx_usb_get_frame_number
argument_list|(
operator|&
name|sc
operator|->
name|sc_port
index|[
name|xfer
operator|->
name|xroot
operator|->
name|udev
operator|->
name|port_index
index|]
operator|.
name|state
argument_list|)
expr_stmt|;
comment|/* 	 * check if the frame index is within the window where the frames 	 * will be inserted 	 */
name|temp
operator|=
operator|(
name|frame_count
operator|-
name|xfer
operator|->
name|endpoint
operator|->
name|isoc_next
operator|)
operator|&
literal|0x7FF
expr_stmt|;
if|if
condition|(
name|usbd_get_speed
argument_list|(
name|xfer
operator|->
name|xroot
operator|->
name|udev
argument_list|)
operator|==
name|USB_SPEED_HIGH
condition|)
block|{
name|fs_frames
operator|=
operator|(
name|xfer
operator|->
name|nframes
operator|+
literal|7
operator|)
operator|/
literal|8
expr_stmt|;
block|}
else|else
block|{
name|fs_frames
operator|=
name|xfer
operator|->
name|nframes
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|xfer
operator|->
name|endpoint
operator|->
name|is_synced
operator|==
literal|0
operator|)
operator|||
operator|(
name|temp
operator|<
name|fs_frames
operator|)
condition|)
block|{
comment|/* 		 * If there is data underflow or the pipe queue is 		 * empty we schedule the transfer a few frames ahead 		 * of the current frame position. Else two isochronous 		 * transfers might overlap. 		 */
name|xfer
operator|->
name|endpoint
operator|->
name|isoc_next
operator|=
operator|(
name|frame_count
operator|+
literal|3
operator|)
operator|&
literal|0x7FF
expr_stmt|;
name|xfer
operator|->
name|endpoint
operator|->
name|is_synced
operator|=
literal|1
expr_stmt|;
name|DPRINTFN
argument_list|(
literal|2
argument_list|,
literal|"start next=%d\n"
argument_list|,
name|xfer
operator|->
name|endpoint
operator|->
name|isoc_next
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * compute how many milliseconds the insertion is ahead of the 	 * current frame position: 	 */
name|temp
operator|=
operator|(
name|xfer
operator|->
name|endpoint
operator|->
name|isoc_next
operator|-
name|frame_count
operator|)
operator|&
literal|0x7FF
expr_stmt|;
comment|/* 	 * pre-compute when the isochronous transfer will be finished: 	 */
name|xfer
operator|->
name|isoc_time_complete
operator|=
name|usb_isoc_time_expand
argument_list|(
operator|&
name|sc
operator|->
name|sc_bus
argument_list|,
name|frame_count
argument_list|)
operator|+
name|temp
operator|+
name|fs_frames
expr_stmt|;
comment|/* compute frame number for next insertion */
name|xfer
operator|->
name|endpoint
operator|->
name|isoc_next
operator|+=
name|fs_frames
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|octusb_device_isoc_start
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|)
block|{
comment|/* setup TDs */
name|octusb_setup_standard_chain
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
name|octusb_start_standard_chain
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
name|struct
name|usb_pipe_methods
name|octusb_device_isoc_methods
init|=
block|{
operator|.
name|open
operator|=
name|octusb_device_isoc_open
block|,
operator|.
name|close
operator|=
name|octusb_device_isoc_close
block|,
operator|.
name|enter
operator|=
name|octusb_device_isoc_enter
block|,
operator|.
name|start
operator|=
name|octusb_device_isoc_start
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*------------------------------------------------------------------------*  * OCTUSB root HUB support  *------------------------------------------------------------------------*  * Simulate a hardware HUB by handling all the necessary requests.  *------------------------------------------------------------------------*/
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|usb_device_descriptor
name|octusb_devd
init|=
block|{
operator|.
name|bLength
operator|=
sizeof|sizeof
argument_list|(
name|octusb_devd
argument_list|)
block|,
operator|.
name|bDescriptorType
operator|=
name|UDESC_DEVICE
block|,
operator|.
name|bcdUSB
operator|=
block|{
literal|0x00
block|,
literal|0x02
block|}
block|,
operator|.
name|bDeviceClass
operator|=
name|UDCLASS_HUB
block|,
operator|.
name|bDeviceSubClass
operator|=
name|UDSUBCLASS_HUB
block|,
operator|.
name|bDeviceProtocol
operator|=
name|UDPROTO_FSHUB
block|,
operator|.
name|bMaxPacketSize
operator|=
literal|64
block|,
operator|.
name|idVendor
operator|=
block|{
literal|0
block|}
block|,
operator|.
name|idProduct
operator|=
block|{
literal|0
block|}
block|,
operator|.
name|bcdDevice
operator|=
block|{
literal|0x00
block|,
literal|0x01
block|}
block|,
operator|.
name|iManufacturer
operator|=
literal|1
block|,
operator|.
name|iProduct
operator|=
literal|2
block|,
operator|.
name|iSerialNumber
operator|=
literal|0
block|,
operator|.
name|bNumConfigurations
operator|=
literal|1
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|usb_device_qualifier
name|octusb_odevd
init|=
block|{
operator|.
name|bLength
operator|=
sizeof|sizeof
argument_list|(
name|octusb_odevd
argument_list|)
block|,
operator|.
name|bDescriptorType
operator|=
name|UDESC_DEVICE_QUALIFIER
block|,
operator|.
name|bcdUSB
operator|=
block|{
literal|0x00
block|,
literal|0x02
block|}
block|,
operator|.
name|bDeviceClass
operator|=
name|UDCLASS_HUB
block|,
operator|.
name|bDeviceSubClass
operator|=
name|UDSUBCLASS_HUB
block|,
operator|.
name|bDeviceProtocol
operator|=
name|UDPROTO_FSHUB
block|,
operator|.
name|bMaxPacketSize0
operator|=
literal|0
block|,
operator|.
name|bNumConfigurations
operator|=
literal|0
block|,
operator|.
name|bReserved
operator|=
literal|0
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|octusb_config_desc
name|octusb_confd
init|=
block|{
operator|.
name|confd
operator|=
block|{
operator|.
name|bLength
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|usb_config_descriptor
argument_list|)
block|,
operator|.
name|bDescriptorType
operator|=
name|UDESC_CONFIG
block|,
operator|.
name|wTotalLength
index|[
literal|0
index|]
operator|=
sizeof|sizeof
argument_list|(
name|octusb_confd
argument_list|)
block|,
operator|.
name|bNumInterface
operator|=
literal|1
block|,
operator|.
name|bConfigurationValue
operator|=
literal|1
block|,
operator|.
name|iConfiguration
operator|=
literal|0
block|,
operator|.
name|bmAttributes
operator|=
name|UC_SELF_POWERED
block|,
operator|.
name|bMaxPower
operator|=
literal|0
comment|/* max power */
block|}
block|,
operator|.
name|ifcd
operator|=
block|{
operator|.
name|bLength
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|usb_interface_descriptor
argument_list|)
block|,
operator|.
name|bDescriptorType
operator|=
name|UDESC_INTERFACE
block|,
operator|.
name|bNumEndpoints
operator|=
literal|1
block|,
operator|.
name|bInterfaceClass
operator|=
name|UICLASS_HUB
block|,
operator|.
name|bInterfaceSubClass
operator|=
name|UISUBCLASS_HUB
block|,
operator|.
name|bInterfaceProtocol
operator|=
name|UIPROTO_FSHUB
block|, 	}
block|,
operator|.
name|endpd
operator|=
block|{
operator|.
name|bLength
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|usb_endpoint_descriptor
argument_list|)
block|,
operator|.
name|bDescriptorType
operator|=
name|UDESC_ENDPOINT
block|,
operator|.
name|bEndpointAddress
operator|=
name|UE_DIR_IN
operator||
name|OCTUSB_INTR_ENDPT
block|,
operator|.
name|bmAttributes
operator|=
name|UE_INTERRUPT
block|,
operator|.
name|wMaxPacketSize
index|[
literal|0
index|]
operator|=
literal|8
block|,
comment|/* max packet (63 ports) */
operator|.
name|bInterval
operator|=
literal|255
block|, 	}
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|usb_hub_descriptor_min
name|octusb_hubd
init|=
block|{
operator|.
name|bDescLength
operator|=
sizeof|sizeof
argument_list|(
name|octusb_hubd
argument_list|)
block|,
operator|.
name|bDescriptorType
operator|=
name|UDESC_HUB
block|,
operator|.
name|bNbrPorts
operator|=
literal|2
block|,
operator|.
name|wHubCharacteristics
operator|=
block|{
name|UHD_PWR_NO_SWITCH
operator||
name|UHD_OC_INDIVIDUAL
block|,
literal|0
block|}
block|,
operator|.
name|bPwrOn2PwrGood
operator|=
literal|50
block|,
operator|.
name|bHubContrCurrent
operator|=
literal|0
block|,
operator|.
name|DeviceRemovable
operator|=
block|{
literal|0x00
block|}
block|,
comment|/* all ports are removable */
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|usb_error_t
name|octusb_roothub_exec
parameter_list|(
name|struct
name|usb_device
modifier|*
name|udev
parameter_list|,
name|struct
name|usb_device_request
modifier|*
name|req
parameter_list|,
specifier|const
name|void
modifier|*
modifier|*
name|pptr
parameter_list|,
name|uint16_t
modifier|*
name|plength
parameter_list|)
block|{
name|struct
name|octusb_softc
modifier|*
name|sc
init|=
name|OCTUSB_BUS2SC
argument_list|(
name|udev
operator|->
name|bus
argument_list|)
decl_stmt|;
specifier|const
name|void
modifier|*
name|ptr
decl_stmt|;
specifier|const
name|char
modifier|*
name|str_ptr
decl_stmt|;
name|uint16_t
name|value
decl_stmt|;
name|uint16_t
name|index
decl_stmt|;
name|uint16_t
name|status
decl_stmt|;
name|uint16_t
name|change
decl_stmt|;
name|uint16_t
name|len
decl_stmt|;
name|usb_error_t
name|err
decl_stmt|;
name|cvmx_usb_port_status_t
name|usb_port_status
decl_stmt|;
name|USB_BUS_LOCK_ASSERT
argument_list|(
operator|&
name|sc
operator|->
name|sc_bus
argument_list|,
name|MA_OWNED
argument_list|)
expr_stmt|;
comment|/* XXX disable power save mode, hence it is not supported */
name|udev
operator|->
name|power_mode
operator|=
name|USB_POWER_MODE_ON
expr_stmt|;
comment|/* buffer reset */
name|ptr
operator|=
operator|(
specifier|const
name|void
operator|*
operator|)
operator|&
name|sc
operator|->
name|sc_hub_desc
operator|.
name|temp
expr_stmt|;
name|len
operator|=
literal|0
expr_stmt|;
name|err
operator|=
literal|0
expr_stmt|;
name|value
operator|=
name|UGETW
argument_list|(
name|req
operator|->
name|wValue
argument_list|)
expr_stmt|;
name|index
operator|=
name|UGETW
argument_list|(
name|req
operator|->
name|wIndex
argument_list|)
expr_stmt|;
name|DPRINTFN
argument_list|(
literal|3
argument_list|,
literal|"type=0x%02x request=0x%02x wLen=0x%04x "
literal|"wValue=0x%04x wIndex=0x%04x\n"
argument_list|,
name|req
operator|->
name|bmRequestType
argument_list|,
name|req
operator|->
name|bRequest
argument_list|,
name|UGETW
argument_list|(
name|req
operator|->
name|wLength
argument_list|)
argument_list|,
name|value
argument_list|,
name|index
argument_list|)
expr_stmt|;
define|#
directive|define
name|C
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|)
value|((x) | ((y)<< 8))
switch|switch
condition|(
name|C
argument_list|(
name|req
operator|->
name|bRequest
argument_list|,
name|req
operator|->
name|bmRequestType
argument_list|)
condition|)
block|{
case|case
name|C
argument_list|(
name|UR_CLEAR_FEATURE
argument_list|,
name|UT_WRITE_DEVICE
argument_list|)
case|:
case|case
name|C
argument_list|(
name|UR_CLEAR_FEATURE
argument_list|,
name|UT_WRITE_INTERFACE
argument_list|)
case|:
case|case
name|C
argument_list|(
name|UR_CLEAR_FEATURE
argument_list|,
name|UT_WRITE_ENDPOINT
argument_list|)
case|:
break|break;
case|case
name|C
argument_list|(
name|UR_GET_CONFIG
argument_list|,
name|UT_READ_DEVICE
argument_list|)
case|:
name|len
operator|=
literal|1
expr_stmt|;
name|sc
operator|->
name|sc_hub_desc
operator|.
name|temp
index|[
literal|0
index|]
operator|=
name|sc
operator|->
name|sc_conf
expr_stmt|;
break|break;
case|case
name|C
argument_list|(
name|UR_GET_DESCRIPTOR
argument_list|,
name|UT_READ_DEVICE
argument_list|)
case|:
switch|switch
condition|(
name|value
operator|>>
literal|8
condition|)
block|{
case|case
name|UDESC_DEVICE
case|:
if|if
condition|(
operator|(
name|value
operator|&
literal|0xff
operator|)
operator|!=
literal|0
condition|)
block|{
name|err
operator|=
name|USB_ERR_IOERROR
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|len
operator|=
sizeof|sizeof
argument_list|(
name|octusb_devd
argument_list|)
expr_stmt|;
name|ptr
operator|=
operator|(
specifier|const
name|void
operator|*
operator|)
operator|&
name|octusb_devd
expr_stmt|;
break|break;
case|case
name|UDESC_DEVICE_QUALIFIER
case|:
if|if
condition|(
operator|(
name|value
operator|&
literal|0xff
operator|)
operator|!=
literal|0
condition|)
block|{
name|err
operator|=
name|USB_ERR_IOERROR
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|len
operator|=
sizeof|sizeof
argument_list|(
name|octusb_odevd
argument_list|)
expr_stmt|;
name|ptr
operator|=
operator|(
specifier|const
name|void
operator|*
operator|)
operator|&
name|octusb_odevd
expr_stmt|;
break|break;
case|case
name|UDESC_CONFIG
case|:
if|if
condition|(
operator|(
name|value
operator|&
literal|0xff
operator|)
operator|!=
literal|0
condition|)
block|{
name|err
operator|=
name|USB_ERR_IOERROR
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|len
operator|=
sizeof|sizeof
argument_list|(
name|octusb_confd
argument_list|)
expr_stmt|;
name|ptr
operator|=
operator|(
specifier|const
name|void
operator|*
operator|)
operator|&
name|octusb_confd
expr_stmt|;
break|break;
case|case
name|UDESC_STRING
case|:
switch|switch
condition|(
name|value
operator|&
literal|0xff
condition|)
block|{
case|case
literal|0
case|:
comment|/* Language table */
name|str_ptr
operator|=
literal|"\001"
expr_stmt|;
break|break;
case|case
literal|1
case|:
comment|/* Vendor */
name|str_ptr
operator|=
literal|"Cavium Networks"
expr_stmt|;
break|break;
case|case
literal|2
case|:
comment|/* Product */
name|str_ptr
operator|=
literal|"OCTUSB Root HUB"
expr_stmt|;
break|break;
default|default:
name|str_ptr
operator|=
literal|""
expr_stmt|;
break|break;
block|}
name|len
operator|=
name|usb_make_str_desc
argument_list|(
name|sc
operator|->
name|sc_hub_desc
operator|.
name|temp
argument_list|,
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|sc_hub_desc
operator|.
name|temp
argument_list|)
argument_list|,
name|str_ptr
argument_list|)
expr_stmt|;
break|break;
default|default:
name|err
operator|=
name|USB_ERR_IOERROR
expr_stmt|;
goto|goto
name|done
goto|;
block|}
break|break;
case|case
name|C
argument_list|(
name|UR_GET_INTERFACE
argument_list|,
name|UT_READ_INTERFACE
argument_list|)
case|:
name|len
operator|=
literal|1
expr_stmt|;
name|sc
operator|->
name|sc_hub_desc
operator|.
name|temp
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|C
argument_list|(
name|UR_GET_STATUS
argument_list|,
name|UT_READ_DEVICE
argument_list|)
case|:
name|len
operator|=
literal|2
expr_stmt|;
name|USETW
argument_list|(
name|sc
operator|->
name|sc_hub_desc
operator|.
name|stat
operator|.
name|wStatus
argument_list|,
name|UDS_SELF_POWERED
argument_list|)
expr_stmt|;
break|break;
case|case
name|C
argument_list|(
name|UR_GET_STATUS
argument_list|,
name|UT_READ_INTERFACE
argument_list|)
case|:
case|case
name|C
argument_list|(
name|UR_GET_STATUS
argument_list|,
name|UT_READ_ENDPOINT
argument_list|)
case|:
name|len
operator|=
literal|2
expr_stmt|;
name|USETW
argument_list|(
name|sc
operator|->
name|sc_hub_desc
operator|.
name|stat
operator|.
name|wStatus
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|C
argument_list|(
name|UR_SET_ADDRESS
argument_list|,
name|UT_WRITE_DEVICE
argument_list|)
case|:
if|if
condition|(
name|value
operator|>=
name|OCTUSB_MAX_DEVICES
condition|)
block|{
name|err
operator|=
name|USB_ERR_IOERROR
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|sc
operator|->
name|sc_addr
operator|=
name|value
expr_stmt|;
break|break;
case|case
name|C
argument_list|(
name|UR_SET_CONFIG
argument_list|,
name|UT_WRITE_DEVICE
argument_list|)
case|:
if|if
condition|(
operator|(
name|value
operator|!=
literal|0
operator|)
operator|&&
operator|(
name|value
operator|!=
literal|1
operator|)
condition|)
block|{
name|err
operator|=
name|USB_ERR_IOERROR
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|sc
operator|->
name|sc_conf
operator|=
name|value
expr_stmt|;
break|break;
case|case
name|C
argument_list|(
name|UR_SET_DESCRIPTOR
argument_list|,
name|UT_WRITE_DEVICE
argument_list|)
case|:
break|break;
case|case
name|C
argument_list|(
name|UR_SET_FEATURE
argument_list|,
name|UT_WRITE_DEVICE
argument_list|)
case|:
case|case
name|C
argument_list|(
name|UR_SET_FEATURE
argument_list|,
name|UT_WRITE_INTERFACE
argument_list|)
case|:
case|case
name|C
argument_list|(
name|UR_SET_FEATURE
argument_list|,
name|UT_WRITE_ENDPOINT
argument_list|)
case|:
name|err
operator|=
name|USB_ERR_IOERROR
expr_stmt|;
goto|goto
name|done
goto|;
case|case
name|C
argument_list|(
name|UR_SET_INTERFACE
argument_list|,
name|UT_WRITE_INTERFACE
argument_list|)
case|:
break|break;
case|case
name|C
argument_list|(
name|UR_SYNCH_FRAME
argument_list|,
name|UT_WRITE_ENDPOINT
argument_list|)
case|:
break|break;
comment|/* Hub requests */
case|case
name|C
argument_list|(
name|UR_CLEAR_FEATURE
argument_list|,
name|UT_WRITE_CLASS_DEVICE
argument_list|)
case|:
break|break;
case|case
name|C
argument_list|(
name|UR_CLEAR_FEATURE
argument_list|,
name|UT_WRITE_CLASS_OTHER
argument_list|)
case|:
name|DPRINTFN
argument_list|(
literal|4
argument_list|,
literal|"UR_CLEAR_PORT_FEATURE "
literal|"port=%d feature=%d\n"
argument_list|,
name|index
argument_list|,
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|index
operator|<
literal|1
operator|)
operator|||
operator|(
name|index
operator|>
name|sc
operator|->
name|sc_noport
operator|)
operator|||
name|sc
operator|->
name|sc_port
index|[
name|index
operator|-
literal|1
index|]
operator|.
name|disabled
condition|)
block|{
name|err
operator|=
name|USB_ERR_IOERROR
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|index
operator|--
expr_stmt|;
switch|switch
condition|(
name|value
condition|)
block|{
case|case
name|UHF_PORT_ENABLE
case|:
name|cvmx_usb_disable
argument_list|(
operator|&
name|sc
operator|->
name|sc_port
index|[
name|index
index|]
operator|.
name|state
argument_list|)
expr_stmt|;
break|break;
case|case
name|UHF_PORT_SUSPEND
case|:
case|case
name|UHF_PORT_RESET
case|:
break|break;
case|case
name|UHF_C_PORT_CONNECTION
case|:
name|cvmx_usb_set_status
argument_list|(
operator|&
name|sc
operator|->
name|sc_port
index|[
name|index
index|]
operator|.
name|state
argument_list|,
name|cvmx_usb_get_status
argument_list|(
operator|&
name|sc
operator|->
name|sc_port
index|[
name|index
index|]
operator|.
name|state
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|UHF_C_PORT_ENABLE
case|:
name|cvmx_usb_set_status
argument_list|(
operator|&
name|sc
operator|->
name|sc_port
index|[
name|index
index|]
operator|.
name|state
argument_list|,
name|cvmx_usb_get_status
argument_list|(
operator|&
name|sc
operator|->
name|sc_port
index|[
name|index
index|]
operator|.
name|state
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|UHF_C_PORT_OVER_CURRENT
case|:
name|cvmx_usb_set_status
argument_list|(
operator|&
name|sc
operator|->
name|sc_port
index|[
name|index
index|]
operator|.
name|state
argument_list|,
name|cvmx_usb_get_status
argument_list|(
operator|&
name|sc
operator|->
name|sc_port
index|[
name|index
index|]
operator|.
name|state
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|UHF_C_PORT_RESET
case|:
name|sc
operator|->
name|sc_isreset
operator|=
literal|0
expr_stmt|;
goto|goto
name|done
goto|;
case|case
name|UHF_C_PORT_SUSPEND
case|:
break|break;
case|case
name|UHF_PORT_CONNECTION
case|:
case|case
name|UHF_PORT_OVER_CURRENT
case|:
case|case
name|UHF_PORT_POWER
case|:
case|case
name|UHF_PORT_LOW_SPEED
case|:
default|default:
name|err
operator|=
name|USB_ERR_IOERROR
expr_stmt|;
goto|goto
name|done
goto|;
block|}
break|break;
case|case
name|C
argument_list|(
name|UR_GET_DESCRIPTOR
argument_list|,
name|UT_READ_CLASS_DEVICE
argument_list|)
case|:
if|if
condition|(
operator|(
name|value
operator|&
literal|0xff
operator|)
operator|!=
literal|0
condition|)
block|{
name|err
operator|=
name|USB_ERR_IOERROR
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|sc
operator|->
name|sc_hubd
operator|=
name|octusb_hubd
expr_stmt|;
name|sc
operator|->
name|sc_hubd
operator|.
name|bNbrPorts
operator|=
name|sc
operator|->
name|sc_noport
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|sc_hubd
argument_list|)
expr_stmt|;
name|ptr
operator|=
operator|(
specifier|const
name|void
operator|*
operator|)
operator|&
name|sc
operator|->
name|sc_hubd
expr_stmt|;
break|break;
case|case
name|C
argument_list|(
name|UR_GET_STATUS
argument_list|,
name|UT_READ_CLASS_DEVICE
argument_list|)
case|:
name|len
operator|=
literal|16
expr_stmt|;
name|memset
argument_list|(
name|sc
operator|->
name|sc_hub_desc
operator|.
name|temp
argument_list|,
literal|0
argument_list|,
literal|16
argument_list|)
expr_stmt|;
break|break;
case|case
name|C
argument_list|(
name|UR_GET_STATUS
argument_list|,
name|UT_READ_CLASS_OTHER
argument_list|)
case|:
if|if
condition|(
operator|(
name|index
operator|<
literal|1
operator|)
operator|||
operator|(
name|index
operator|>
name|sc
operator|->
name|sc_noport
operator|)
operator|||
name|sc
operator|->
name|sc_port
index|[
name|index
operator|-
literal|1
index|]
operator|.
name|disabled
condition|)
block|{
name|err
operator|=
name|USB_ERR_IOERROR
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|index
operator|--
expr_stmt|;
name|usb_port_status
operator|=
name|cvmx_usb_get_status
argument_list|(
operator|&
name|sc
operator|->
name|sc_port
index|[
name|index
index|]
operator|.
name|state
argument_list|)
expr_stmt|;
name|status
operator|=
name|change
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|usb_port_status
operator|.
name|connected
condition|)
name|status
operator||=
name|UPS_CURRENT_CONNECT_STATUS
expr_stmt|;
if|if
condition|(
name|usb_port_status
operator|.
name|port_enabled
condition|)
name|status
operator||=
name|UPS_PORT_ENABLED
expr_stmt|;
if|if
condition|(
name|usb_port_status
operator|.
name|port_over_current
condition|)
name|status
operator||=
name|UPS_OVERCURRENT_INDICATOR
expr_stmt|;
if|if
condition|(
name|usb_port_status
operator|.
name|port_powered
condition|)
name|status
operator||=
name|UPS_PORT_POWER
expr_stmt|;
switch|switch
condition|(
name|usb_port_status
operator|.
name|port_speed
condition|)
block|{
case|case
name|CVMX_USB_SPEED_HIGH
case|:
name|status
operator||=
name|UPS_HIGH_SPEED
expr_stmt|;
break|break;
case|case
name|CVMX_USB_SPEED_FULL
case|:
break|break;
default|default:
name|status
operator||=
name|UPS_LOW_SPEED
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|usb_port_status
operator|.
name|connect_change
condition|)
name|change
operator||=
name|UPS_C_CONNECT_STATUS
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_isreset
condition|)
name|change
operator||=
name|UPS_C_PORT_RESET
expr_stmt|;
name|USETW
argument_list|(
name|sc
operator|->
name|sc_hub_desc
operator|.
name|ps
operator|.
name|wPortStatus
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|sc
operator|->
name|sc_hub_desc
operator|.
name|ps
operator|.
name|wPortChange
argument_list|,
name|change
argument_list|)
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|sc_hub_desc
operator|.
name|ps
argument_list|)
expr_stmt|;
break|break;
case|case
name|C
argument_list|(
name|UR_SET_DESCRIPTOR
argument_list|,
name|UT_WRITE_CLASS_DEVICE
argument_list|)
case|:
name|err
operator|=
name|USB_ERR_IOERROR
expr_stmt|;
goto|goto
name|done
goto|;
case|case
name|C
argument_list|(
name|UR_SET_FEATURE
argument_list|,
name|UT_WRITE_CLASS_DEVICE
argument_list|)
case|:
break|break;
case|case
name|C
argument_list|(
name|UR_SET_FEATURE
argument_list|,
name|UT_WRITE_CLASS_OTHER
argument_list|)
case|:
if|if
condition|(
operator|(
name|index
operator|<
literal|1
operator|)
operator|||
operator|(
name|index
operator|>
name|sc
operator|->
name|sc_noport
operator|)
operator|||
name|sc
operator|->
name|sc_port
index|[
name|index
operator|-
literal|1
index|]
operator|.
name|disabled
condition|)
block|{
name|err
operator|=
name|USB_ERR_IOERROR
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|index
operator|--
expr_stmt|;
switch|switch
condition|(
name|value
condition|)
block|{
case|case
name|UHF_PORT_ENABLE
case|:
break|break;
case|case
name|UHF_PORT_RESET
case|:
name|cvmx_usb_disable
argument_list|(
operator|&
name|sc
operator|->
name|sc_port
index|[
name|index
index|]
operator|.
name|state
argument_list|)
expr_stmt|;
if|if
condition|(
name|cvmx_usb_enable
argument_list|(
operator|&
name|sc
operator|->
name|sc_port
index|[
name|index
index|]
operator|.
name|state
argument_list|)
condition|)
block|{
name|err
operator|=
name|USB_ERR_IOERROR
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|sc
operator|->
name|sc_isreset
operator|=
literal|1
expr_stmt|;
goto|goto
name|done
goto|;
case|case
name|UHF_PORT_POWER
case|:
comment|/* pretend we turned on power */
goto|goto
name|done
goto|;
case|case
name|UHF_PORT_SUSPEND
case|:
case|case
name|UHF_C_PORT_CONNECTION
case|:
case|case
name|UHF_C_PORT_ENABLE
case|:
case|case
name|UHF_C_PORT_OVER_CURRENT
case|:
case|case
name|UHF_PORT_CONNECTION
case|:
case|case
name|UHF_PORT_OVER_CURRENT
case|:
case|case
name|UHF_PORT_LOW_SPEED
case|:
case|case
name|UHF_C_PORT_SUSPEND
case|:
case|case
name|UHF_C_PORT_RESET
case|:
default|default:
name|err
operator|=
name|USB_ERR_IOERROR
expr_stmt|;
goto|goto
name|done
goto|;
block|}
break|break;
default|default:
name|err
operator|=
name|USB_ERR_IOERROR
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|done
label|:
operator|*
name|plength
operator|=
name|len
expr_stmt|;
operator|*
name|pptr
operator|=
name|ptr
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|octusb_xfer_setup
parameter_list|(
name|struct
name|usb_setup_params
modifier|*
name|parm
parameter_list|)
block|{
name|struct
name|usb_page_search
name|page_info
decl_stmt|;
name|struct
name|usb_page_cache
modifier|*
name|pc
decl_stmt|;
name|struct
name|octusb_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|octusb_qh
modifier|*
name|qh
decl_stmt|;
name|struct
name|usb_xfer
modifier|*
name|xfer
decl_stmt|;
name|struct
name|usb_device
modifier|*
name|hub
decl_stmt|;
name|void
modifier|*
name|last_obj
decl_stmt|;
name|uint32_t
name|n
decl_stmt|;
name|uint32_t
name|ntd
decl_stmt|;
name|sc
operator|=
name|OCTUSB_BUS2SC
argument_list|(
name|parm
operator|->
name|udev
operator|->
name|bus
argument_list|)
expr_stmt|;
name|xfer
operator|=
name|parm
operator|->
name|curr_xfer
expr_stmt|;
name|qh
operator|=
name|NULL
expr_stmt|;
comment|/* 	 * NOTE: This driver does not use any of the parameters that 	 * are computed from the following values. Just set some 	 * reasonable dummies: 	 */
name|parm
operator|->
name|hc_max_packet_size
operator|=
literal|0x400
expr_stmt|;
name|parm
operator|->
name|hc_max_packet_count
operator|=
literal|3
expr_stmt|;
name|parm
operator|->
name|hc_max_frame_size
operator|=
literal|0xC00
expr_stmt|;
name|usbd_transfer_setup_sub
argument_list|(
name|parm
argument_list|)
expr_stmt|;
if|if
condition|(
name|parm
operator|->
name|err
condition|)
return|return;
comment|/* Allocate a queue head */
if|if
condition|(
name|usbd_transfer_setup_sub_malloc
argument_list|(
name|parm
argument_list|,
operator|&
name|pc
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|octusb_qh
argument_list|)
argument_list|,
name|USB_HOST_ALIGN
argument_list|,
literal|1
argument_list|)
condition|)
block|{
name|parm
operator|->
name|err
operator|=
name|USB_ERR_NOMEM
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|parm
operator|->
name|buf
condition|)
block|{
name|usbd_get_page
argument_list|(
name|pc
argument_list|,
literal|0
argument_list|,
operator|&
name|page_info
argument_list|)
expr_stmt|;
name|qh
operator|=
name|page_info
operator|.
name|buffer
expr_stmt|;
comment|/* fill out QH */
name|qh
operator|->
name|sc
operator|=
name|OCTUSB_BUS2SC
argument_list|(
name|xfer
operator|->
name|xroot
operator|->
name|bus
argument_list|)
expr_stmt|;
name|qh
operator|->
name|max_frame_size
operator|=
name|xfer
operator|->
name|max_frame_size
expr_stmt|;
name|qh
operator|->
name|max_packet_size
operator|=
name|xfer
operator|->
name|max_packet_size
expr_stmt|;
name|qh
operator|->
name|ep_num
operator|=
name|xfer
operator|->
name|endpointno
expr_stmt|;
name|qh
operator|->
name|ep_type
operator|=
name|xfer
operator|->
name|endpoint
operator|->
name|edesc
operator|->
name|bmAttributes
expr_stmt|;
name|qh
operator|->
name|dev_addr
operator|=
name|xfer
operator|->
name|address
expr_stmt|;
name|qh
operator|->
name|dev_speed
operator|=
name|usbd_get_speed
argument_list|(
name|xfer
operator|->
name|xroot
operator|->
name|udev
argument_list|)
expr_stmt|;
name|qh
operator|->
name|root_port_index
operator|=
name|xfer
operator|->
name|xroot
operator|->
name|udev
operator|->
name|port_index
expr_stmt|;
comment|/* We need Octeon USB HUB's port index, not the local port */
name|hub
operator|=
name|xfer
operator|->
name|xroot
operator|->
name|udev
operator|->
name|parent_hub
expr_stmt|;
while|while
condition|(
name|hub
operator|&&
name|hub
operator|->
name|parent_hub
condition|)
block|{
name|qh
operator|->
name|root_port_index
operator|=
name|hub
operator|->
name|port_index
expr_stmt|;
name|hub
operator|=
name|hub
operator|->
name|parent_hub
expr_stmt|;
block|}
switch|switch
condition|(
name|xfer
operator|->
name|endpoint
operator|->
name|edesc
operator|->
name|bmAttributes
operator|&
name|UE_XFERTYPE
condition|)
block|{
case|case
name|UE_INTERRUPT
case|:
if|if
condition|(
name|usbd_get_speed
argument_list|(
name|xfer
operator|->
name|xroot
operator|->
name|udev
argument_list|)
operator|==
name|USB_SPEED_HIGH
condition|)
name|qh
operator|->
name|ep_interval
operator|=
name|xfer
operator|->
name|interval
operator|*
literal|8
expr_stmt|;
else|else
name|qh
operator|->
name|ep_interval
operator|=
name|xfer
operator|->
name|interval
operator|*
literal|1
expr_stmt|;
break|break;
case|case
name|UE_ISOCHRONOUS
case|:
name|qh
operator|->
name|ep_interval
operator|=
literal|1
operator|<<
name|xfer
operator|->
name|fps_shift
expr_stmt|;
break|break;
default|default:
name|qh
operator|->
name|ep_interval
operator|=
literal|0
expr_stmt|;
break|break;
block|}
name|qh
operator|->
name|ep_mult
operator|=
name|xfer
operator|->
name|max_packet_count
operator|&
literal|3
expr_stmt|;
name|qh
operator|->
name|hs_hub_addr
operator|=
name|xfer
operator|->
name|xroot
operator|->
name|udev
operator|->
name|hs_hub_addr
expr_stmt|;
name|qh
operator|->
name|hs_hub_port
operator|=
name|xfer
operator|->
name|xroot
operator|->
name|udev
operator|->
name|hs_port_no
expr_stmt|;
block|}
name|xfer
operator|->
name|qh_start
index|[
literal|0
index|]
operator|=
name|qh
expr_stmt|;
comment|/* Allocate a fixup buffer */
if|if
condition|(
name|usbd_transfer_setup_sub_malloc
argument_list|(
name|parm
argument_list|,
operator|&
name|pc
argument_list|,
name|OCTUSB_MAX_FIXUP
argument_list|,
name|OCTUSB_MAX_FIXUP
argument_list|,
literal|1
argument_list|)
condition|)
block|{
name|parm
operator|->
name|err
operator|=
name|USB_ERR_NOMEM
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|parm
operator|->
name|buf
condition|)
block|{
name|usbd_get_page
argument_list|(
name|pc
argument_list|,
literal|0
argument_list|,
operator|&
name|page_info
argument_list|)
expr_stmt|;
name|qh
operator|->
name|fixup_phys
operator|=
name|page_info
operator|.
name|physaddr
expr_stmt|;
name|qh
operator|->
name|fixup_pc
operator|=
name|pc
expr_stmt|;
name|qh
operator|->
name|fixup_buf
operator|=
name|page_info
operator|.
name|buffer
expr_stmt|;
block|}
comment|/* Allocate transfer descriptors */
name|last_obj
operator|=
name|NULL
expr_stmt|;
name|ntd
operator|=
name|xfer
operator|->
name|nframes
operator|+
literal|1
comment|/* STATUS */
operator|+
literal|1
comment|/* SYNC */
expr_stmt|;
if|if
condition|(
name|usbd_transfer_setup_sub_malloc
argument_list|(
name|parm
argument_list|,
operator|&
name|pc
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|octusb_td
argument_list|)
argument_list|,
name|USB_HOST_ALIGN
argument_list|,
name|ntd
argument_list|)
condition|)
block|{
name|parm
operator|->
name|err
operator|=
name|USB_ERR_NOMEM
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|parm
operator|->
name|buf
condition|)
block|{
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|!=
name|ntd
condition|;
name|n
operator|++
control|)
block|{
name|struct
name|octusb_td
modifier|*
name|td
decl_stmt|;
name|usbd_get_page
argument_list|(
name|pc
operator|+
name|n
argument_list|,
literal|0
argument_list|,
operator|&
name|page_info
argument_list|)
expr_stmt|;
name|td
operator|=
name|page_info
operator|.
name|buffer
expr_stmt|;
name|td
operator|->
name|qh
operator|=
name|qh
expr_stmt|;
name|td
operator|->
name|obj_next
operator|=
name|last_obj
expr_stmt|;
name|last_obj
operator|=
name|td
expr_stmt|;
block|}
block|}
name|xfer
operator|->
name|td_start
index|[
literal|0
index|]
operator|=
name|last_obj
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|octusb_ep_init
parameter_list|(
name|struct
name|usb_device
modifier|*
name|udev
parameter_list|,
name|struct
name|usb_endpoint_descriptor
modifier|*
name|edesc
parameter_list|,
name|struct
name|usb_endpoint
modifier|*
name|ep
parameter_list|)
block|{
name|struct
name|octusb_softc
modifier|*
name|sc
init|=
name|OCTUSB_BUS2SC
argument_list|(
name|udev
operator|->
name|bus
argument_list|)
decl_stmt|;
name|DPRINTFN
argument_list|(
literal|2
argument_list|,
literal|"endpoint=%p, addr=%d, endpt=%d, mode=%d (%d)\n"
argument_list|,
name|ep
argument_list|,
name|udev
operator|->
name|address
argument_list|,
name|edesc
operator|->
name|bEndpointAddress
argument_list|,
name|udev
operator|->
name|flags
operator|.
name|usb_mode
argument_list|,
name|sc
operator|->
name|sc_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|udev
operator|->
name|device_index
operator|!=
name|sc
operator|->
name|sc_addr
condition|)
block|{
switch|switch
condition|(
name|edesc
operator|->
name|bmAttributes
operator|&
name|UE_XFERTYPE
condition|)
block|{
case|case
name|UE_CONTROL
case|:
name|ep
operator|->
name|methods
operator|=
operator|&
name|octusb_device_ctrl_methods
expr_stmt|;
break|break;
case|case
name|UE_INTERRUPT
case|:
name|ep
operator|->
name|methods
operator|=
operator|&
name|octusb_device_intr_methods
expr_stmt|;
break|break;
case|case
name|UE_ISOCHRONOUS
case|:
if|if
condition|(
name|udev
operator|->
name|speed
operator|!=
name|USB_SPEED_LOW
condition|)
name|ep
operator|->
name|methods
operator|=
operator|&
name|octusb_device_isoc_methods
expr_stmt|;
break|break;
case|case
name|UE_BULK
case|:
name|ep
operator|->
name|methods
operator|=
operator|&
name|octusb_device_bulk_methods
expr_stmt|;
break|break;
default|default:
comment|/* do nothing */
break|break;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|octusb_xfer_unsetup
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|)
block|{
name|DPRINTF
argument_list|(
literal|"Nothing to do.\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|octusb_get_dma_delay
parameter_list|(
name|struct
name|usb_device
modifier|*
name|udev
parameter_list|,
name|uint32_t
modifier|*
name|pus
parameter_list|)
block|{
comment|/* DMA delay - wait until any use of memory is finished */
operator|*
name|pus
operator|=
operator|(
literal|2125
operator|)
expr_stmt|;
comment|/* microseconds */
block|}
end_function

begin_function
specifier|static
name|void
name|octusb_device_resume
parameter_list|(
name|struct
name|usb_device
modifier|*
name|udev
parameter_list|)
block|{
name|DPRINTF
argument_list|(
literal|"Nothing to do.\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|octusb_device_suspend
parameter_list|(
name|struct
name|usb_device
modifier|*
name|udev
parameter_list|)
block|{
name|DPRINTF
argument_list|(
literal|"Nothing to do.\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|octusb_set_hw_power
parameter_list|(
name|struct
name|usb_bus
modifier|*
name|bus
parameter_list|)
block|{
name|DPRINTF
argument_list|(
literal|"Nothing to do.\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|octusb_set_hw_power_sleep
parameter_list|(
name|struct
name|usb_bus
modifier|*
name|bus
parameter_list|,
name|uint32_t
name|state
parameter_list|)
block|{
name|struct
name|octusb_softc
modifier|*
name|sc
init|=
name|OCTUSB_BUS2SC
argument_list|(
name|bus
argument_list|)
decl_stmt|;
switch|switch
condition|(
name|state
condition|)
block|{
case|case
name|USB_HW_POWER_SUSPEND
case|:
name|octusb_suspend
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
case|case
name|USB_HW_POWER_SHUTDOWN
case|:
name|octusb_uninit
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
case|case
name|USB_HW_POWER_RESUME
case|:
name|octusb_resume
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
end_function

begin_decl_stmt
name|struct
name|usb_bus_methods
name|octusb_bus_methods
init|=
block|{
operator|.
name|endpoint_init
operator|=
name|octusb_ep_init
block|,
operator|.
name|xfer_setup
operator|=
name|octusb_xfer_setup
block|,
operator|.
name|xfer_unsetup
operator|=
name|octusb_xfer_unsetup
block|,
operator|.
name|get_dma_delay
operator|=
name|octusb_get_dma_delay
block|,
operator|.
name|device_resume
operator|=
name|octusb_device_resume
block|,
operator|.
name|device_suspend
operator|=
name|octusb_device_suspend
block|,
operator|.
name|set_hw_power
operator|=
name|octusb_set_hw_power
block|,
operator|.
name|set_hw_power_sleep
operator|=
name|octusb_set_hw_power_sleep
block|,
operator|.
name|roothub_exec
operator|=
name|octusb_roothub_exec
block|,
operator|.
name|xfer_poll
operator|=
name|octusb_do_poll
block|, }
decl_stmt|;
end_decl_stmt

end_unit


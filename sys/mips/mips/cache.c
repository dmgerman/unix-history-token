begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*      $NetBSD: cache.c,v 1.33 2005/12/24 23:24:01 perry Exp $ */
end_comment

begin_comment
comment|/*-  * Copyright 2001, 2002 Wasabi Systems, Inc.  * All rights reserved.  *  * Written by Jason R. Thorpe and Simon Burge for Wasabi Systems, Inc.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. All advertising materials mentioning features or use of this software  *    must display the following acknowledgement:  *      This product includes software developed for the NetBSD Project by  *      Wasabi Systems, Inc.  * 4. The name of Wasabi Systems, Inc. may not be used to endorse  *    or promote products derived from this software without specific prior  *    written permission.  *  * THIS SOFTWARE IS PROVIDED BY WASABI SYSTEMS, INC. ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED  * TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL WASABI SYSTEMS, INC  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE  * POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_comment
comment|/*-  * Copyright 2000, 2001  * Broadcom Corporation. All rights reserved.  *   * This software is furnished under license and may be used and copied only  * in accordance with the following terms and conditions.  Subject to these  * conditions, you may download, copy, install, use, modify and distribute  * modified or unmodified copies of this software in source and/or binary  * form. No title or ownership is transferred hereby.  *   * 1) Any source code used, modified or distributed must reproduce and  *    retain this copyright notice and list of conditions as they appear in  *    the source file.  *   * 2) No right is granted to use any trade name, trademark, or logo of  *    Broadcom Corporation.  The "Broadcom Corporation" name may not be  *    used to endorse or promote products derived from this software  *    without the prior written permission of Broadcom Corporation.  *  * 3) THIS SOFTWARE IS PROVIDED "AS-IS" AND ANY EXPRESS OR IMPLIED  *    WARRANTIES, INCLUDING BUT NOT LIMITED TO, ANY IMPLIED WARRANTIES OF  *    MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, OR  *    NON-INFRINGEMENT ARE DISCLAIMED. IN NO EVENT SHALL BROADCOM BE LIABLE  *    FOR ANY DAMAGES WHATSOEVER, AND IN PARTICULAR, BROADCOM SHALL NOT BE  *    LIABLE FOR DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR  *    CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  *    SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR  *    BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,  *    WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE  *    OR OTHERWISE), EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|"opt_cputype.h"
end_include

begin_include
include|#
directive|include
file|<machine/cpuinfo.h>
end_include

begin_include
include|#
directive|include
file|<machine/cache.h>
end_include

begin_decl_stmt
name|struct
name|mips_cache_ops
name|mips_cache_ops
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|mips_config_cache
parameter_list|(
name|struct
name|mips_cpuinfo
modifier|*
name|cpuinfo
parameter_list|)
block|{
switch|switch
condition|(
name|cpuinfo
operator|->
name|l1
operator|.
name|ic_linesize
condition|)
block|{
case|case
literal|16
case|:
name|mips_cache_ops
operator|.
name|mco_icache_sync_all
operator|=
name|mipsNN_icache_sync_all_16
expr_stmt|;
name|mips_cache_ops
operator|.
name|mco_icache_sync_range
operator|=
name|mipsNN_icache_sync_range_16
expr_stmt|;
name|mips_cache_ops
operator|.
name|mco_icache_sync_range_index
operator|=
name|mipsNN_icache_sync_range_index_16
expr_stmt|;
break|break;
case|case
literal|32
case|:
name|mips_cache_ops
operator|.
name|mco_icache_sync_all
operator|=
name|mipsNN_icache_sync_all_32
expr_stmt|;
name|mips_cache_ops
operator|.
name|mco_icache_sync_range
operator|=
name|mipsNN_icache_sync_range_32
expr_stmt|;
name|mips_cache_ops
operator|.
name|mco_icache_sync_range_index
operator|=
name|mipsNN_icache_sync_range_index_32
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|TARGET_OCTEON
case|case
literal|128
case|:
name|mips_cache_ops
operator|.
name|mco_icache_sync_all
operator|=
name|mipsNN_icache_sync_all_128
expr_stmt|;
name|mips_cache_ops
operator|.
name|mco_icache_sync_range
operator|=
name|mipsNN_icache_sync_range_128
expr_stmt|;
name|mips_cache_ops
operator|.
name|mco_icache_sync_range_index
operator|=
name|mipsNN_icache_sync_range_index_128
expr_stmt|;
break|break;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|MIPS_DISABLE_L1_CACHE
case|case
literal|0
case|:
name|mips_cache_ops
operator|.
name|mco_icache_sync_all
operator|=
name|cache_noop
expr_stmt|;
name|mips_cache_ops
operator|.
name|mco_icache_sync_range
operator|=
operator|(
name|void
argument_list|(
operator|*
argument_list|)
argument_list|(
name|vaddr_t
argument_list|,
name|vsize_t
argument_list|)
operator|)
name|cache_noop
expr_stmt|;
name|mips_cache_ops
operator|.
name|mco_icache_sync_range_index
operator|=
operator|(
name|void
argument_list|(
operator|*
argument_list|)
argument_list|(
name|vaddr_t
argument_list|,
name|vsize_t
argument_list|)
operator|)
name|cache_noop
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
name|panic
argument_list|(
literal|"no Icache ops for %d byte lines"
argument_list|,
name|cpuinfo
operator|->
name|l1
operator|.
name|ic_linesize
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|cpuinfo
operator|->
name|l1
operator|.
name|dc_linesize
condition|)
block|{
case|case
literal|16
case|:
name|mips_cache_ops
operator|.
name|mco_pdcache_wbinv_all
operator|=
name|mips_cache_ops
operator|.
name|mco_intern_pdcache_wbinv_all
operator|=
name|mipsNN_pdcache_wbinv_all_16
expr_stmt|;
name|mips_cache_ops
operator|.
name|mco_pdcache_wbinv_range
operator|=
name|mipsNN_pdcache_wbinv_range_16
expr_stmt|;
name|mips_cache_ops
operator|.
name|mco_pdcache_wbinv_range_index
operator|=
name|mips_cache_ops
operator|.
name|mco_intern_pdcache_wbinv_range_index
operator|=
name|mipsNN_pdcache_wbinv_range_index_16
expr_stmt|;
name|mips_cache_ops
operator|.
name|mco_pdcache_inv_range
operator|=
name|mipsNN_pdcache_inv_range_16
expr_stmt|;
name|mips_cache_ops
operator|.
name|mco_pdcache_wb_range
operator|=
name|mips_cache_ops
operator|.
name|mco_intern_pdcache_wb_range
operator|=
name|mipsNN_pdcache_wb_range_16
expr_stmt|;
break|break;
case|case
literal|32
case|:
name|mips_cache_ops
operator|.
name|mco_pdcache_wbinv_all
operator|=
name|mips_cache_ops
operator|.
name|mco_intern_pdcache_wbinv_all
operator|=
name|mipsNN_pdcache_wbinv_all_32
expr_stmt|;
name|mips_cache_ops
operator|.
name|mco_pdcache_wbinv_range
operator|=
name|mipsNN_pdcache_wbinv_range_32
expr_stmt|;
name|mips_cache_ops
operator|.
name|mco_pdcache_wbinv_range_index
operator|=
name|mips_cache_ops
operator|.
name|mco_intern_pdcache_wbinv_range_index
operator|=
name|mipsNN_pdcache_wbinv_range_index_32
expr_stmt|;
name|mips_cache_ops
operator|.
name|mco_pdcache_inv_range
operator|=
name|mipsNN_pdcache_inv_range_32
expr_stmt|;
name|mips_cache_ops
operator|.
name|mco_pdcache_wb_range
operator|=
name|mips_cache_ops
operator|.
name|mco_intern_pdcache_wb_range
operator|=
name|mipsNN_pdcache_wb_range_32
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|TARGET_OCTEON
case|case
literal|128
case|:
name|mips_cache_ops
operator|.
name|mco_pdcache_wbinv_all
operator|=
name|mips_cache_ops
operator|.
name|mco_intern_pdcache_wbinv_all
operator|=
name|mipsNN_pdcache_wbinv_all_128
expr_stmt|;
name|mips_cache_ops
operator|.
name|mco_pdcache_wbinv_range
operator|=
name|mipsNN_pdcache_wbinv_range_128
expr_stmt|;
name|mips_cache_ops
operator|.
name|mco_pdcache_wbinv_range_index
operator|=
name|mips_cache_ops
operator|.
name|mco_intern_pdcache_wbinv_range_index
operator|=
name|mipsNN_pdcache_wbinv_range_index_128
expr_stmt|;
name|mips_cache_ops
operator|.
name|mco_pdcache_inv_range
operator|=
name|mipsNN_pdcache_inv_range_128
expr_stmt|;
name|mips_cache_ops
operator|.
name|mco_pdcache_wb_range
operator|=
name|mips_cache_ops
operator|.
name|mco_intern_pdcache_wb_range
operator|=
name|mipsNN_pdcache_wb_range_128
expr_stmt|;
break|break;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|MIPS_DISABLE_L1_CACHE
case|case
literal|0
case|:
name|mips_cache_ops
operator|.
name|mco_pdcache_wbinv_all
operator|=
name|cache_noop
expr_stmt|;
name|mips_cache_ops
operator|.
name|mco_intern_pdcache_wbinv_all
operator|=
name|cache_noop
expr_stmt|;
name|mips_cache_ops
operator|.
name|mco_pdcache_wbinv_range
operator|=
operator|(
name|void
argument_list|(
operator|*
argument_list|)
argument_list|(
name|vaddr_t
argument_list|,
name|vsize_t
argument_list|)
operator|)
name|cache_noop
expr_stmt|;
name|mips_cache_ops
operator|.
name|mco_pdcache_wbinv_range_index
operator|=
operator|(
name|void
argument_list|(
operator|*
argument_list|)
argument_list|(
name|vaddr_t
argument_list|,
name|vsize_t
argument_list|)
operator|)
name|cache_noop
expr_stmt|;
name|mips_cache_ops
operator|.
name|mco_intern_pdcache_wbinv_range_index
operator|=
operator|(
name|void
argument_list|(
operator|*
argument_list|)
argument_list|(
name|vaddr_t
argument_list|,
name|vsize_t
argument_list|)
operator|)
name|cache_noop
expr_stmt|;
name|mips_cache_ops
operator|.
name|mco_pdcache_inv_range
operator|=
operator|(
name|void
argument_list|(
operator|*
argument_list|)
argument_list|(
name|vaddr_t
argument_list|,
name|vsize_t
argument_list|)
operator|)
name|cache_noop
expr_stmt|;
name|mips_cache_ops
operator|.
name|mco_pdcache_wb_range
operator|=
operator|(
name|void
argument_list|(
operator|*
argument_list|)
argument_list|(
name|vaddr_t
argument_list|,
name|vsize_t
argument_list|)
operator|)
name|cache_noop
expr_stmt|;
name|mips_cache_ops
operator|.
name|mco_intern_pdcache_wb_range
operator|=
operator|(
name|void
argument_list|(
operator|*
argument_list|)
argument_list|(
name|vaddr_t
argument_list|,
name|vsize_t
argument_list|)
operator|)
name|cache_noop
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
name|panic
argument_list|(
literal|"no Dcache ops for %d byte lines"
argument_list|,
name|cpuinfo
operator|->
name|l1
operator|.
name|dc_linesize
argument_list|)
expr_stmt|;
block|}
name|mipsNN_cache_init
argument_list|(
name|cpuinfo
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|if (mips_cpu_flags& 	    (CPU_MIPS_D_CACHE_COHERENT | CPU_MIPS_I_D_CACHE_COHERENT)) {
ifdef|#
directive|ifdef
name|CACHE_DEBUG
block|printf("  Dcache is coherent\n");
endif|#
directive|endif
block|mips_cache_ops.mco_pdcache_wbinv_all = cache_noop; 		mips_cache_ops.mco_pdcache_wbinv_range = 		    (void (*)(vaddr_t, vsize_t))cache_noop; 		mips_cache_ops.mco_pdcache_wbinv_range_index = 		    (void (*)(vaddr_t, vsize_t))cache_noop; 		mips_cache_ops.mco_pdcache_inv_range = 		    (void (*)(vaddr_t, vsize_t))cache_noop; 		mips_cache_ops.mco_pdcache_wb_range = 		    (void (*)(vaddr_t, vsize_t))cache_noop; 	} 	if (mips_cpu_flags& CPU_MIPS_I_D_CACHE_COHERENT) {
ifdef|#
directive|ifdef
name|CACHE_DEBUG
block|printf("  Icache is coherent against Dcache\n");
endif|#
directive|endif
block|mips_cache_ops.mco_intern_pdcache_wbinv_all = 		    cache_noop; 		mips_cache_ops.mco_intern_pdcache_wbinv_range_index = 		    (void (*)(vaddr_t, vsize_t))cache_noop; 		mips_cache_ops.mco_intern_pdcache_wb_range = 		    (void (*)(vaddr_t, vsize_t))cache_noop; 	}
endif|#
directive|endif
comment|/* Check that all cache ops are set up. */
comment|/* must have primary Icache */
if|if
condition|(
name|cpuinfo
operator|->
name|l1
operator|.
name|ic_size
condition|)
block|{
if|if
condition|(
operator|!
name|mips_cache_ops
operator|.
name|mco_icache_sync_all
condition|)
name|panic
argument_list|(
literal|"no icache_sync_all cache op"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mips_cache_ops
operator|.
name|mco_icache_sync_range
condition|)
name|panic
argument_list|(
literal|"no icache_sync_range cache op"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mips_cache_ops
operator|.
name|mco_icache_sync_range_index
condition|)
name|panic
argument_list|(
literal|"no icache_sync_range_index cache op"
argument_list|)
expr_stmt|;
block|}
comment|/* must have primary Dcache */
if|if
condition|(
name|cpuinfo
operator|->
name|l1
operator|.
name|dc_size
condition|)
block|{
if|if
condition|(
operator|!
name|mips_cache_ops
operator|.
name|mco_pdcache_wbinv_all
condition|)
name|panic
argument_list|(
literal|"no pdcache_wbinv_all"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mips_cache_ops
operator|.
name|mco_pdcache_wbinv_range
condition|)
name|panic
argument_list|(
literal|"no pdcache_wbinv_range"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mips_cache_ops
operator|.
name|mco_pdcache_wbinv_range_index
condition|)
name|panic
argument_list|(
literal|"no pdcache_wbinv_range_index"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mips_cache_ops
operator|.
name|mco_pdcache_inv_range
condition|)
name|panic
argument_list|(
literal|"no pdcache_inv_range"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mips_cache_ops
operator|.
name|mco_pdcache_wb_range
condition|)
name|panic
argument_list|(
literal|"no pdcache_wb_range"
argument_list|)
expr_stmt|;
block|}
comment|/* XXXMIPS: No secondary cache handlers yet */
ifdef|#
directive|ifdef
name|notyet
if|if
condition|(
name|mips_sdcache_size
condition|)
block|{
if|if
condition|(
operator|!
name|mips_cache_ops
operator|.
name|mco_sdcache_wbinv_all
condition|)
name|panic
argument_list|(
literal|"no sdcache_wbinv_all"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mips_cache_ops
operator|.
name|mco_sdcache_wbinv_range
condition|)
name|panic
argument_list|(
literal|"no sdcache_wbinv_range"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mips_cache_ops
operator|.
name|mco_sdcache_wbinv_range_index
condition|)
name|panic
argument_list|(
literal|"no sdcache_wbinv_range_index"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mips_cache_ops
operator|.
name|mco_sdcache_inv_range
condition|)
name|panic
argument_list|(
literal|"no sdcache_inv_range"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mips_cache_ops
operator|.
name|mco_sdcache_wb_range
condition|)
name|panic
argument_list|(
literal|"no sdcache_wb_range"
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
block|}
end_function

end_unit


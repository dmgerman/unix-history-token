begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2013 SRI International  * All rights reserved.  *  * This software was developed by SRI International and the University of  * Cambridge Computer Laboratory under DARPA/AFRL contract (FA8750-10-C-0237)  * ("CTSRD"), as part of the DARPA CRASH research programme.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/intr_machdep.h>
end_include

begin_include
include|#
directive|include
file|<dev/ofw/ofw_bus.h>
end_include

begin_include
include|#
directive|include
file|<dev/ofw/ofw_bus_subr.h>
end_include

begin_include
include|#
directive|include
file|<dev/fdt/fdt_common.h>
end_include

begin_include
include|#
directive|include
file|"fdt_ic_if.h"
end_include

begin_struct_decl
struct_decl|struct
name|beripic_softc
struct_decl|;
end_struct_decl

begin_function_decl
specifier|static
name|uint64_t
name|bp_read_cfg
parameter_list|(
name|struct
name|beripic_softc
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bp_write_cfg
parameter_list|(
name|struct
name|beripic_softc
modifier|*
parameter_list|,
name|int
parameter_list|,
name|uint64_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bp_detach_resources
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|char
modifier|*
name|bp_strconfig
parameter_list|(
name|uint64_t
parameter_list|,
name|char
modifier|*
parameter_list|,
name|size_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bp_config_source
parameter_list|(
name|device_t
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|,
name|u_long
parameter_list|,
name|u_long
parameter_list|)
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|__mips__
end_ifdef

begin_function_decl
specifier|static
name|void
name|bp_set_counter_name
parameter_list|(
name|device_t
parameter_list|,
name|device_t
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|int
name|beripic_fdt_probe
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|beripic_fdt_attach
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|beripic_activate_intr
parameter_list|(
name|device_t
parameter_list|,
name|struct
name|resource
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|resource
modifier|*
name|beripic_alloc_intr
parameter_list|(
name|device_t
parameter_list|,
name|device_t
parameter_list|,
name|int
modifier|*
parameter_list|,
name|u_long
parameter_list|,
name|u_int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|beripic_config_intr
parameter_list|(
name|device_t
parameter_list|,
name|int
parameter_list|,
name|enum
name|intr_trigger
parameter_list|,
name|enum
name|intr_polarity
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|beripic_release_intr
parameter_list|(
name|device_t
parameter_list|,
name|struct
name|resource
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|beripic_setup_intr
parameter_list|(
name|device_t
parameter_list|,
name|device_t
parameter_list|,
name|struct
name|resource
modifier|*
parameter_list|,
name|int
parameter_list|,
name|driver_filter_t
modifier|*
parameter_list|,
name|driver_intr_t
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|,
name|void
modifier|*
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|beripic_teardown_intr
parameter_list|(
name|device_t
parameter_list|,
name|device_t
parameter_list|,
name|struct
name|resource
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|beripic_filter
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|beripic_intr
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_define
define|#
directive|define
name|BP_MAX_HARD_IRQS
value|6
end_define

begin_define
define|#
directive|define
name|BP_FIRST_SOFT
value|64
end_define

begin_struct
struct|struct
name|beripic_softc
block|{
name|device_t
name|bp_dev
decl_stmt|;
name|struct
name|resource
modifier|*
name|bp_cfg_res
decl_stmt|;
name|struct
name|resource
modifier|*
name|bp_read_res
decl_stmt|;
name|struct
name|resource
modifier|*
name|bp_set_res
decl_stmt|;
name|struct
name|resource
modifier|*
name|bp_clear_res
decl_stmt|;
name|int
name|bp_cfg_rid
decl_stmt|;
name|int
name|bp_read_rid
decl_stmt|;
name|int
name|bp_set_rid
decl_stmt|;
name|int
name|bp_clear_rid
decl_stmt|;
name|bus_space_tag_t
name|bp_cfg_bst
decl_stmt|;
name|bus_space_tag_t
name|bp_read_bst
decl_stmt|;
name|bus_space_tag_t
name|bp_set_bst
decl_stmt|;
name|bus_space_tag_t
name|bp_clear_bst
decl_stmt|;
name|bus_space_handle_t
name|bp_cfg_bsh
decl_stmt|;
name|bus_space_handle_t
name|bp_read_bsh
decl_stmt|;
name|bus_space_handle_t
name|bp_set_bsh
decl_stmt|;
name|bus_space_handle_t
name|bp_clear_bsh
decl_stmt|;
name|struct
name|resource
modifier|*
name|bp_irqs
index|[
name|BP_MAX_HARD_IRQS
index|]
decl_stmt|;
name|int
name|bp_irq_rids
index|[
name|BP_MAX_HARD_IRQS
index|]
decl_stmt|;
name|int
name|bp_nirqs
decl_stmt|;
name|int
name|bp_next_irq
decl_stmt|;
name|int
name|bp_next_tid
decl_stmt|;
name|int
name|bp_nthreads
decl_stmt|;
name|int
name|bp_nhard
decl_stmt|;
name|int
name|bp_nsoft
decl_stmt|;
name|int
name|bp_nsrcs
decl_stmt|;
name|struct
name|rman
name|bp_src_rman
decl_stmt|;
ifdef|#
directive|ifdef
name|__mips__
name|mips_intrcnt_t
modifier|*
name|bp_counters
decl_stmt|;
endif|#
directive|endif
name|struct
name|mtx
name|bp_cfgmtx
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|beripic_intr_arg
block|{
name|driver_filter_t
modifier|*
name|filter
decl_stmt|;
name|driver_intr_t
modifier|*
name|intr
decl_stmt|;
name|void
modifier|*
name|arg
decl_stmt|;
name|struct
name|resource
modifier|*
name|irq
decl_stmt|;
ifdef|#
directive|ifdef
name|__mips__
name|mips_intrcnt_t
name|counter
decl_stmt|;
endif|#
directive|endif
block|}
struct|;
end_struct

begin_struct
struct|struct
name|beripic_cookie
block|{
name|struct
name|beripic_intr_arg
modifier|*
name|bpia
decl_stmt|;
name|struct
name|resource
modifier|*
name|hirq
decl_stmt|;
name|void
modifier|*
name|cookie
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|BP_CFG_MASK_E
value|0x80000000ull
end_define

begin_define
define|#
directive|define
name|BP_CFG_SHIFT_E
value|31
end_define

begin_define
define|#
directive|define
name|BP_CFG_MASK_TID
value|0x7FFFFF00ull
end_define

begin_comment
comment|/* Depends on CPU */
end_comment

begin_define
define|#
directive|define
name|BP_CFG_SHIFT_TID
value|8
end_define

begin_define
define|#
directive|define
name|BP_CFG_MASK_IRQ
value|0x0000000Full
end_define

begin_define
define|#
directive|define
name|BP_CFG_SHIFT_IRQ
value|0
end_define

begin_define
define|#
directive|define
name|BP_CFG_VALID
value|(BP_CFG_MASK_E|BP_CFG_MASK_TID|BP_CFG_MASK_IRQ)
end_define

begin_define
define|#
directive|define
name|BP_CFG_RESERVED
value|~BP_CFG_VALID
end_define

begin_define
define|#
directive|define
name|BP_CFG_ENABLED
parameter_list|(
name|cfg
parameter_list|)
value|(((cfg)& BP_CFG_MASK_E)>> BP_CFG_SHIFT_E)
end_define

begin_define
define|#
directive|define
name|BP_CFG_TID
parameter_list|(
name|cfg
parameter_list|)
value|(((cfg)& BP_CFG_MASK_TID)>> BP_CFG_SHIFT_TID)
end_define

begin_define
define|#
directive|define
name|BP_CFG_IRQ
parameter_list|(
name|cfg
parameter_list|)
value|(((cfg)& BP_CFG_MASK_IRQ)>> BP_CFG_SHIFT_IRQ)
end_define

begin_expr_stmt
name|MALLOC_DEFINE
argument_list|(
name|M_BERIPIC
argument_list|,
literal|"beripic"
argument_list|,
literal|"beripic memory"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|uint64_t
name|bp_read_cfg
parameter_list|(
name|struct
name|beripic_softc
modifier|*
name|sc
parameter_list|,
name|int
name|irq
parameter_list|)
block|{
name|KASSERT
argument_list|(
operator|(
name|irq
operator|>=
literal|0
operator|&&
name|irq
operator|<
name|sc
operator|->
name|bp_nsrcs
operator|)
argument_list|,
operator|(
literal|"IRQ of of range %d (0-%d)"
operator|,
name|irq
operator|,
name|sc
operator|->
name|bp_nsrcs
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|bus_space_read_8
argument_list|(
name|sc
operator|->
name|bp_cfg_bst
argument_list|,
name|sc
operator|->
name|bp_cfg_bsh
argument_list|,
name|irq
operator|*
literal|8
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bp_write_cfg
parameter_list|(
name|struct
name|beripic_softc
modifier|*
name|sc
parameter_list|,
name|int
name|irq
parameter_list|,
name|uint64_t
name|config
parameter_list|)
block|{
name|KASSERT
argument_list|(
operator|(
name|irq
operator|>=
literal|0
operator|&&
name|irq
operator|<
name|sc
operator|->
name|bp_nsrcs
operator|)
argument_list|,
operator|(
literal|"IRQ of of range %d (0-%d)"
operator|,
name|irq
operator|,
name|sc
operator|->
name|bp_nsrcs
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
name|bus_space_write_8
argument_list|(
name|sc
operator|->
name|bp_cfg_bst
argument_list|,
name|sc
operator|->
name|bp_cfg_bsh
argument_list|,
name|irq
operator|*
literal|8
argument_list|,
name|config
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bp_detach_resources
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|beripic_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|i
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|bp_cfg_res
operator|!=
name|NULL
condition|)
block|{
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|sc
operator|->
name|bp_cfg_rid
argument_list|,
name|sc
operator|->
name|bp_cfg_res
argument_list|)
expr_stmt|;
name|sc
operator|->
name|bp_cfg_res
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|bp_read_res
operator|!=
name|NULL
condition|)
block|{
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|sc
operator|->
name|bp_read_rid
argument_list|,
name|sc
operator|->
name|bp_read_res
argument_list|)
expr_stmt|;
name|sc
operator|->
name|bp_read_res
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|bp_set_res
operator|!=
name|NULL
condition|)
block|{
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|sc
operator|->
name|bp_set_rid
argument_list|,
name|sc
operator|->
name|bp_set_res
argument_list|)
expr_stmt|;
name|sc
operator|->
name|bp_set_res
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|bp_clear_res
operator|!=
name|NULL
condition|)
block|{
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|sc
operator|->
name|bp_clear_rid
argument_list|,
name|sc
operator|->
name|bp_clear_res
argument_list|)
expr_stmt|;
name|sc
operator|->
name|bp_clear_res
operator|=
name|NULL
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
name|sc
operator|->
name|bp_nirqs
operator|-
literal|1
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
block|{
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
name|sc
operator|->
name|bp_irq_rids
index|[
name|i
index|]
argument_list|,
name|sc
operator|->
name|bp_irqs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|sc
operator|->
name|bp_nirqs
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|bp_strconfig
parameter_list|(
name|uint64_t
name|config
parameter_list|,
name|char
modifier|*
name|configstr
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
if|if
condition|(
name|snprintf
argument_list|(
name|configstr
argument_list|,
name|len
argument_list|,
literal|"%s tid: %llu hardintr %llu"
argument_list|,
name|BP_CFG_ENABLED
argument_list|(
name|config
argument_list|)
condition|?
literal|"enabled"
else|:
literal|"disabled"
argument_list|,
name|BP_CFG_TID
argument_list|(
name|config
argument_list|)
argument_list|,
name|BP_CFG_IRQ
argument_list|(
name|config
argument_list|)
argument_list|)
operator|>
name|len
operator|-
literal|1
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
return|return
operator|(
name|configstr
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bp_config_source
parameter_list|(
name|device_t
name|ic
parameter_list|,
name|int
name|src
parameter_list|,
name|int
name|enable
parameter_list|,
name|u_long
name|tid
parameter_list|,
name|u_long
name|irq
parameter_list|)
block|{
name|struct
name|beripic_softc
modifier|*
name|sc
decl_stmt|;
name|uint64_t
name|config
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|ic
argument_list|)
expr_stmt|;
name|config
operator|=
literal|0
expr_stmt|;
name|config
operator||=
name|enable
operator|<<
name|BP_CFG_SHIFT_E
expr_stmt|;
name|config
operator||=
name|tid
operator|<<
name|BP_CFG_SHIFT_TID
expr_stmt|;
name|config
operator||=
name|irq
operator|<<
name|BP_CFG_SHIFT_IRQ
expr_stmt|;
name|bp_write_cfg
argument_list|(
name|sc
argument_list|,
name|src
argument_list|,
name|config
argument_list|)
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|__mips__
end_ifdef

begin_function
specifier|static
name|void
name|bp_set_counter_name
parameter_list|(
name|device_t
name|ic
parameter_list|,
name|device_t
name|child
parameter_list|,
name|int
name|src
parameter_list|)
block|{
name|struct
name|beripic_softc
modifier|*
name|sc
decl_stmt|;
name|char
name|name
index|[
name|MAXCOMLEN
operator|+
literal|1
index|]
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|ic
argument_list|)
expr_stmt|;
if|if
condition|(
name|snprintf
argument_list|(
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|name
argument_list|)
argument_list|,
literal|"bp%dsrc%d%s%s%s"
argument_list|,
name|device_get_unit
argument_list|(
name|ic
argument_list|)
argument_list|,
name|src
argument_list|,
name|src
operator|<
name|sc
operator|->
name|bp_nhard
condition|?
literal|""
else|:
literal|"s"
argument_list|,
name|child
operator|==
name|NULL
condition|?
literal|""
else|:
literal|" "
argument_list|,
name|child
operator|==
name|NULL
condition|?
literal|" "
else|:
name|device_get_nameunit
argument_list|(
name|child
argument_list|)
argument_list|)
operator|>=
sizeof|sizeof
argument_list|(
name|name
argument_list|)
condition|)
name|name
index|[
sizeof|sizeof
argument_list|(
name|name
argument_list|)
operator|-
literal|2
index|]
operator|=
literal|'+'
expr_stmt|;
name|mips_intrcnt_setname
argument_list|(
name|sc
operator|->
name|bp_counters
index|[
name|src
index|]
argument_list|,
name|name
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|int
name|beripic_fdt_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
if|if
condition|(
operator|!
name|ofw_bus_is_compatible
argument_list|(
name|dev
argument_list|,
literal|"sri-cambridge,beri-pic"
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"BERI Programmable Interrupt Controller"
argument_list|)
expr_stmt|;
return|return
operator|(
name|BUS_PROBE_DEFAULT
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|beripic_fdt_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|char
name|configstr
index|[
literal|64
index|]
decl_stmt|;
name|struct
name|beripic_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|fdt_ic
modifier|*
name|fic
decl_stmt|;
name|pcell_t
name|nhard
decl_stmt|,
name|nsoft
decl_stmt|;
name|phandle_t
name|ph
decl_stmt|;
name|int
name|error
decl_stmt|,
name|i
decl_stmt|,
name|src
decl_stmt|;
name|uint64_t
name|config
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sc
operator|->
name|bp_dev
operator|=
name|dev
expr_stmt|;
name|mtx_init
argument_list|(
operator|&
name|sc
operator|->
name|bp_cfgmtx
argument_list|,
literal|"beripic config lock"
argument_list|,
name|NULL
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
comment|/* 	 * FDT lists CONFIG, IP_READ, IP_SET, and IP_CLEAR registers as 	 * seperate memory regions in that order. 	 */
name|sc
operator|->
name|bp_cfg_rid
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|bp_cfg_res
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
operator|&
name|sc
operator|->
name|bp_cfg_rid
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|bp_cfg_res
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"failed to map config memory"
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENXIO
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|bp_dev
argument_list|,
literal|"config region at mem %p-%p\n"
argument_list|,
operator|(
name|void
operator|*
operator|)
name|rman_get_start
argument_list|(
name|sc
operator|->
name|bp_cfg_res
argument_list|)
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
name|rman_get_start
argument_list|(
name|sc
operator|->
name|bp_cfg_res
argument_list|)
operator|+
name|rman_get_size
argument_list|(
name|sc
operator|->
name|bp_cfg_res
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|bp_read_rid
operator|=
literal|1
expr_stmt|;
name|sc
operator|->
name|bp_read_res
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
operator|&
name|sc
operator|->
name|bp_read_rid
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|bp_read_res
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"failed to map IP read memory"
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENXIO
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|bp_dev
argument_list|,
literal|"IP read region at mem %p-%p\n"
argument_list|,
operator|(
name|void
operator|*
operator|)
name|rman_get_start
argument_list|(
name|sc
operator|->
name|bp_read_res
argument_list|)
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
name|rman_get_start
argument_list|(
name|sc
operator|->
name|bp_read_res
argument_list|)
operator|+
name|rman_get_size
argument_list|(
name|sc
operator|->
name|bp_read_res
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|bp_set_rid
operator|=
literal|2
expr_stmt|;
name|sc
operator|->
name|bp_set_res
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
operator|&
name|sc
operator|->
name|bp_set_rid
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|bp_set_res
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"failed to map IP read memory"
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENXIO
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|bp_dev
argument_list|,
literal|"IP set region at mem %p-%p\n"
argument_list|,
operator|(
name|void
operator|*
operator|)
name|rman_get_start
argument_list|(
name|sc
operator|->
name|bp_set_res
argument_list|)
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
name|rman_get_start
argument_list|(
name|sc
operator|->
name|bp_set_res
argument_list|)
operator|+
name|rman_get_size
argument_list|(
name|sc
operator|->
name|bp_set_res
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|bp_clear_rid
operator|=
literal|3
expr_stmt|;
name|sc
operator|->
name|bp_clear_res
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
operator|&
name|sc
operator|->
name|bp_clear_rid
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|bp_clear_res
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"failed to map IP read memory"
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENXIO
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|bp_dev
argument_list|,
literal|"IP clear region at mem %p-%p\n"
argument_list|,
operator|(
name|void
operator|*
operator|)
name|rman_get_start
argument_list|(
name|sc
operator|->
name|bp_clear_res
argument_list|)
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
name|rman_get_start
argument_list|(
name|sc
operator|->
name|bp_clear_res
argument_list|)
operator|+
name|rman_get_size
argument_list|(
name|sc
operator|->
name|bp_clear_res
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|BP_MAX_HARD_IRQS
condition|;
name|i
operator|++
control|)
block|{
name|sc
operator|->
name|bp_irq_rids
index|[
name|i
index|]
operator|=
name|i
expr_stmt|;
name|sc
operator|->
name|bp_irqs
index|[
name|i
index|]
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
operator|&
name|sc
operator|->
name|bp_irq_rids
index|[
name|i
index|]
argument_list|,
name|RF_ACTIVE
operator||
name|RF_SHAREABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|bp_irqs
index|[
name|i
index|]
operator|==
name|NULL
condition|)
break|break;
block|}
if|if
condition|(
name|i
operator|==
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"failed to allocate any parent IRQs!"
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENXIO
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|sc
operator|->
name|bp_nirqs
operator|=
name|i
expr_stmt|;
name|ph
operator|=
name|ofw_bus_gen_get_node
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|,
name|dev
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|SMP
name|sc
operator|->
name|bp_nthreads
operator|=
literal|1
expr_stmt|;
else|#
directive|else
name|sc
operator|->
name|bp_nthreads
operator|=
literal|1
expr_stmt|;
comment|/* XXX: get nthreads from cpu(s) somehow */
endif|#
directive|endif
if|if
condition|(
name|OF_getprop
argument_list|(
name|ph
argument_list|,
literal|"hard-interrupt-sources"
argument_list|,
operator|&
name|nhard
argument_list|,
sizeof|sizeof
argument_list|(
name|nhard
argument_list|)
argument_list|)
operator|<=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"failed to get number of hard sources"
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENXIO
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|OF_getprop
argument_list|(
name|ph
argument_list|,
literal|"soft-interrupt-sources"
argument_list|,
operator|&
name|nsoft
argument_list|,
sizeof|sizeof
argument_list|(
name|nsoft
argument_list|)
argument_list|)
operator|<=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"failed to get number of soft sources"
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENXIO
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|sc
operator|->
name|bp_nhard
operator|=
name|nhard
expr_stmt|;
name|sc
operator|->
name|bp_nsoft
operator|=
name|nsoft
expr_stmt|;
name|sc
operator|->
name|bp_nsrcs
operator|=
name|sc
operator|->
name|bp_nhard
operator|+
name|sc
operator|->
name|bp_nsoft
expr_stmt|;
comment|/* XXX: should deal with gap between hard and soft */
name|KASSERT
argument_list|(
name|sc
operator|->
name|bp_nhard
operator|<=
name|BP_FIRST_SOFT
argument_list|,
operator|(
literal|"too many hard sources"
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|rman_get_size
argument_list|(
name|sc
operator|->
name|bp_cfg_res
argument_list|)
operator|/
literal|8
operator|==
name|sc
operator|->
name|bp_nsrcs
argument_list|,
operator|(
literal|"config space size does not match sources"
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|sc
operator|->
name|bp_nhard
operator|%
literal|64
operator|==
literal|0
argument_list|,
operator|(
literal|"Non-multiple of 64 intr counts not supported"
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|sc
operator|->
name|bp_nsoft
operator|%
literal|64
operator|==
literal|0
argument_list|,
operator|(
literal|"Non-multiple of 64 intr counts not supported"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%d hard and %d soft sources\n"
argument_list|,
name|sc
operator|->
name|bp_nhard
argument_list|,
name|sc
operator|->
name|bp_nsoft
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|__mips__
name|sc
operator|->
name|bp_counters
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|sc
operator|->
name|bp_counters
argument_list|)
operator|*
name|sc
operator|->
name|bp_nsrcs
argument_list|,
name|M_BERIPIC
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|bp_nsrcs
condition|;
name|i
operator|++
control|)
block|{
name|sc
operator|->
name|bp_counters
index|[
name|i
index|]
operator|=
name|mips_intrcnt_create
argument_list|(
literal|""
argument_list|)
expr_stmt|;
name|bp_set_counter_name
argument_list|(
name|dev
argument_list|,
name|NULL
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|sc
operator|->
name|bp_src_rman
operator|.
name|rm_start
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|bp_src_rman
operator|.
name|rm_end
operator|=
name|sc
operator|->
name|bp_nsrcs
operator|-
literal|1
expr_stmt|;
name|sc
operator|->
name|bp_src_rman
operator|.
name|rm_type
operator|=
name|RMAN_ARRAY
expr_stmt|;
name|sc
operator|->
name|bp_src_rman
operator|.
name|rm_descr
operator|=
literal|"Interrupt source"
expr_stmt|;
if|if
condition|(
name|rman_init
argument_list|(
operator|&
operator|(
name|sc
operator|->
name|bp_src_rman
operator|)
argument_list|)
operator|!=
literal|0
operator|||
name|rman_manage_region
argument_list|(
operator|&
operator|(
name|sc
operator|->
name|bp_src_rman
operator|)
argument_list|,
literal|0
argument_list|,
name|sc
operator|->
name|bp_nsrcs
operator|-
literal|1
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Failed to set up sources rman"
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENXIO
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|sc
operator|->
name|bp_cfg_bst
operator|=
name|rman_get_bustag
argument_list|(
name|sc
operator|->
name|bp_cfg_res
argument_list|)
expr_stmt|;
name|sc
operator|->
name|bp_cfg_bsh
operator|=
name|rman_get_bushandle
argument_list|(
name|sc
operator|->
name|bp_cfg_res
argument_list|)
expr_stmt|;
name|sc
operator|->
name|bp_read_bst
operator|=
name|rman_get_bustag
argument_list|(
name|sc
operator|->
name|bp_read_res
argument_list|)
expr_stmt|;
name|sc
operator|->
name|bp_read_bsh
operator|=
name|rman_get_bushandle
argument_list|(
name|sc
operator|->
name|bp_read_res
argument_list|)
expr_stmt|;
name|sc
operator|->
name|bp_set_bst
operator|=
name|rman_get_bustag
argument_list|(
name|sc
operator|->
name|bp_set_res
argument_list|)
expr_stmt|;
name|sc
operator|->
name|bp_set_bsh
operator|=
name|rman_get_bushandle
argument_list|(
name|sc
operator|->
name|bp_set_res
argument_list|)
expr_stmt|;
name|sc
operator|->
name|bp_clear_bst
operator|=
name|rman_get_bustag
argument_list|(
name|sc
operator|->
name|bp_clear_res
argument_list|)
expr_stmt|;
name|sc
operator|->
name|bp_clear_bsh
operator|=
name|rman_get_bushandle
argument_list|(
name|sc
operator|->
name|bp_clear_res
argument_list|)
expr_stmt|;
for|for
control|(
name|src
operator|=
literal|0
init|;
name|src
operator|<
name|sc
operator|->
name|bp_nsrcs
condition|;
name|src
operator|++
control|)
block|{
name|config
operator|=
name|bp_read_cfg
argument_list|(
name|sc
argument_list|,
name|src
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|==
literal|0
condition|)
continue|continue;
if|if
condition|(
name|bootverbose
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"initial config: src %d: %s\n"
argument_list|,
name|src
argument_list|,
name|bp_strconfig
argument_list|(
name|config
argument_list|,
name|configstr
argument_list|,
sizeof|sizeof
argument_list|(
name|configstr
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|&
name|BP_CFG_RESERVED
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"reserved bits not 0: 0x%016jx\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|config
argument_list|)
expr_stmt|;
block|}
name|bp_config_source
argument_list|(
name|dev
argument_list|,
name|src
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|fic
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|fic
argument_list|)
argument_list|,
name|M_BERIPIC
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|fic
operator|->
name|iph
operator|=
name|ph
expr_stmt|;
name|fic
operator|->
name|dev
operator|=
name|dev
expr_stmt|;
name|SLIST_INSERT_HEAD
argument_list|(
operator|&
name|fdt_ic_list_head
argument_list|,
name|fic
argument_list|,
name|fdt_ics
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|err
label|:
name|bp_detach_resources
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|resource
modifier|*
name|beripic_alloc_intr
parameter_list|(
name|device_t
name|ic
parameter_list|,
name|device_t
name|child
parameter_list|,
name|int
modifier|*
name|rid
parameter_list|,
name|u_long
name|irq
parameter_list|,
name|u_int
name|flags
parameter_list|)
block|{
name|struct
name|beripic_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|resource
modifier|*
name|rv
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|ic
argument_list|)
expr_stmt|;
name|rv
operator|=
name|rman_reserve_resource
argument_list|(
operator|&
operator|(
name|sc
operator|->
name|bp_src_rman
operator|)
argument_list|,
name|irq
argument_list|,
name|irq
argument_list|,
literal|1
argument_list|,
name|flags
argument_list|,
name|child
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|==
name|NULL
condition|)
name|printf
argument_list|(
literal|"%s: could not reserve source interrupt for %s\n"
argument_list|,
name|__func__
argument_list|,
name|device_get_nameunit
argument_list|(
name|child
argument_list|)
argument_list|)
expr_stmt|;
name|rman_set_rid
argument_list|(
name|rv
argument_list|,
operator|*
name|rid
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|RF_ACTIVE
operator|)
operator|&&
name|beripic_activate_intr
argument_list|(
name|ic
argument_list|,
name|rv
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s: could not activate interrupt\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|rman_release_resource
argument_list|(
name|rv
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
return|return
operator|(
name|rv
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|beripic_release_intr
parameter_list|(
name|device_t
name|ic
parameter_list|,
name|struct
name|resource
modifier|*
name|r
parameter_list|)
block|{
return|return
operator|(
name|rman_release_resource
argument_list|(
name|r
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|beripic_activate_intr
parameter_list|(
name|device_t
name|ic
parameter_list|,
name|struct
name|resource
modifier|*
name|r
parameter_list|)
block|{
return|return
operator|(
name|rman_activate_resource
argument_list|(
name|r
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|beripic_deactivate_intr
parameter_list|(
name|device_t
name|ic
parameter_list|,
name|struct
name|resource
modifier|*
name|r
parameter_list|)
block|{
return|return
operator|(
name|rman_deactivate_resource
argument_list|(
name|r
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|beripic_config_intr
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|irq
parameter_list|,
name|enum
name|intr_trigger
name|trig
parameter_list|,
name|enum
name|intr_polarity
name|pol
parameter_list|)
block|{
if|if
condition|(
name|trig
operator|!=
name|INTR_TRIGGER_CONFORM
operator|||
name|pol
operator|!=
name|INTR_POLARITY_CONFORM
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|beripic_setup_intr
parameter_list|(
name|device_t
name|ic
parameter_list|,
name|device_t
name|child
parameter_list|,
name|struct
name|resource
modifier|*
name|irq
parameter_list|,
name|int
name|flags
parameter_list|,
name|driver_filter_t
modifier|*
name|filter
parameter_list|,
name|driver_intr_t
modifier|*
name|intr
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|,
name|void
modifier|*
modifier|*
name|cookiep
parameter_list|)
block|{
name|struct
name|beripic_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|beripic_intr_arg
modifier|*
name|bpia
decl_stmt|;
name|struct
name|beripic_cookie
modifier|*
name|bpc
decl_stmt|;
name|int
name|error
decl_stmt|;
name|u_long
name|hirq
decl_stmt|,
name|src
decl_stmt|,
name|tid
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|ic
argument_list|)
expr_stmt|;
name|src
operator|=
name|rman_get_start
argument_list|(
name|irq
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|src
operator|<
name|sc
operator|->
name|bp_nsrcs
argument_list|,
operator|(
literal|"source (%lu) out of range 0-%d"
operator|,
name|src
operator|,
name|sc
operator|->
name|bp_nsrcs
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
name|bpia
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|bpia
argument_list|)
argument_list|,
name|M_BERIPIC
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|bpia
operator|->
name|filter
operator|=
name|filter
expr_stmt|;
name|bpia
operator|->
name|intr
operator|=
name|intr
expr_stmt|;
name|bpia
operator|->
name|arg
operator|=
name|arg
expr_stmt|;
name|bpia
operator|->
name|irq
operator|=
name|irq
expr_stmt|;
ifdef|#
directive|ifdef
name|__mips__
name|bpia
operator|->
name|counter
operator|=
name|sc
operator|->
name|bp_counters
index|[
name|src
index|]
expr_stmt|;
name|bp_set_counter_name
argument_list|(
name|ic
argument_list|,
name|child
argument_list|,
name|src
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|bpc
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|bpc
argument_list|)
argument_list|,
name|M_BERIPIC
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|bpc
operator|->
name|bpia
operator|=
name|bpia
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
operator|(
name|sc
operator|->
name|bp_cfgmtx
operator|)
argument_list|)
expr_stmt|;
name|bpc
operator|->
name|hirq
operator|=
name|sc
operator|->
name|bp_irqs
index|[
name|sc
operator|->
name|bp_next_irq
index|]
expr_stmt|;
name|hirq
operator|=
name|rman_get_start
argument_list|(
name|bpc
operator|->
name|hirq
argument_list|)
expr_stmt|;
name|tid
operator|=
name|sc
operator|->
name|bp_next_tid
expr_stmt|;
name|error
operator|=
name|BUS_SETUP_INTR
argument_list|(
name|device_get_parent
argument_list|(
name|ic
argument_list|)
argument_list|,
name|ic
argument_list|,
name|bpc
operator|->
name|hirq
argument_list|,
name|flags
argument_list|,
name|beripic_filter
argument_list|,
name|intr
operator|==
name|NULL
condition|?
name|NULL
else|:
name|beripic_intr
argument_list|,
name|bpia
argument_list|,
operator|&
operator|(
name|bpc
operator|->
name|cookie
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|err
goto|;
ifdef|#
directive|ifdef
name|NOTYET
ifdef|#
directive|ifdef
name|SMP
comment|/* XXX: bind ithread to cpu */
name|sc
operator|->
name|bp_next_tid
operator|++
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|bp_next_tid
operator|>=
name|sc
operator|->
name|bp_nthreads
condition|)
name|sc
operator|->
name|bp_next_tid
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
endif|#
directive|endif
if|if
condition|(
name|sc
operator|->
name|bp_next_tid
operator|==
literal|0
condition|)
block|{
name|sc
operator|->
name|bp_next_irq
operator|++
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|bp_next_irq
operator|>=
name|sc
operator|->
name|bp_nirqs
condition|)
name|sc
operator|->
name|bp_next_irq
operator|=
literal|0
expr_stmt|;
block|}
name|mtx_unlock
argument_list|(
operator|&
operator|(
name|sc
operator|->
name|bp_cfgmtx
operator|)
argument_list|)
expr_stmt|;
operator|*
name|cookiep
operator|=
name|bpc
expr_stmt|;
name|bp_config_source
argument_list|(
name|ic
argument_list|,
name|rman_get_start
argument_list|(
name|irq
argument_list|)
argument_list|,
literal|1
argument_list|,
name|tid
argument_list|,
name|hirq
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|err
label|:
name|free
argument_list|(
name|bpc
argument_list|,
name|M_BERIPIC
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|bpia
argument_list|,
name|M_BERIPIC
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|beripic_teardown_intr
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|device_t
name|child
parameter_list|,
name|struct
name|resource
modifier|*
name|irq
parameter_list|,
name|void
modifier|*
name|cookie
parameter_list|)
block|{
name|struct
name|beripic_cookie
modifier|*
name|bpc
decl_stmt|;
name|int
name|error
decl_stmt|;
name|bpc
operator|=
name|cookie
expr_stmt|;
name|bp_config_source
argument_list|(
name|dev
argument_list|,
name|rman_get_start
argument_list|(
name|irq
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|bpc
operator|->
name|bpia
argument_list|,
name|M_BERIPIC
argument_list|)
expr_stmt|;
name|error
operator|=
name|BUS_TEARDOWN_INTR
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|,
name|dev
argument_list|,
name|bpc
operator|->
name|hirq
argument_list|,
name|bpc
operator|->
name|cookie
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|bpc
argument_list|,
name|M_BERIPIC
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|beripic_filter
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|beripic_intr_arg
modifier|*
name|bpic
decl_stmt|;
name|bpic
operator|=
name|arg
expr_stmt|;
ifdef|#
directive|ifdef
name|__mips__
name|mips_intrcnt_inc
argument_list|(
name|bpic
operator|->
name|counter
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* XXX: Add a check that our source is high */
if|if
condition|(
name|bpic
operator|->
name|filter
operator|==
name|NULL
condition|)
return|return
operator|(
name|FILTER_SCHEDULE_THREAD
operator|)
return|;
return|return
operator|(
name|bpic
operator|->
name|filter
argument_list|(
name|bpic
operator|->
name|arg
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|beripic_intr
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|beripic_intr_arg
modifier|*
name|bpic
decl_stmt|;
name|bpic
operator|=
name|arg
expr_stmt|;
name|KASSERT
argument_list|(
name|bpic
operator|->
name|intr
operator|!=
name|NULL
argument_list|,
operator|(
literal|"%s installed, but no child intr"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
name|bpic
operator|->
name|intr
argument_list|(
name|bpic
operator|->
name|arg
argument_list|)
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|SMP
end_ifdef

begin_function
specifier|static
name|void
name|beripic_setup_ipi
parameter_list|(
name|device_t
name|ic
parameter_list|,
name|u_int
name|tid
parameter_list|,
name|u_int
name|ipi_irq
parameter_list|)
block|{
name|bp_config_source
argument_list|(
name|ic
argument_list|,
name|BP_FIRST_SOFT
operator|+
name|tid
argument_list|,
literal|1
argument_list|,
name|tid
argument_list|,
name|ipi_irq
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|beripic_send_ipi
parameter_list|(
name|device_t
name|ic
parameter_list|,
name|u_int
name|tid
parameter_list|)
block|{
name|struct
name|beripic_softc
modifier|*
name|sc
decl_stmt|;
name|uint64_t
name|bit
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|ic
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|tid
operator|<
name|sc
operator|->
name|bp_nsoft
argument_list|,
operator|(
literal|"tid (%d) too large\n"
operator|,
name|tid
operator|)
argument_list|)
expr_stmt|;
name|bit
operator|=
literal|1ULL
operator|<<
operator|(
name|tid
operator|%
literal|64
operator|)
expr_stmt|;
name|bus_space_write_8
argument_list|(
name|sc
operator|->
name|bp_set_bst
argument_list|,
name|sc
operator|->
name|bp_set_bsh
argument_list|,
operator|(
name|BP_FIRST_SOFT
operator|/
literal|8
operator|)
operator|+
operator|(
name|tid
operator|/
literal|64
operator|)
argument_list|,
name|bit
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|beripic_clear_ipi
parameter_list|(
name|device_t
name|ic
parameter_list|,
name|u_int
name|tid
parameter_list|)
block|{
name|struct
name|beripic_softc
modifier|*
name|sc
decl_stmt|;
name|uint64_t
name|bit
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|ic
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|tid
operator|<
name|sc
operator|->
name|bp_nsoft
argument_list|,
operator|(
literal|"tid (%d) to large\n"
operator|,
name|tid
operator|)
argument_list|)
expr_stmt|;
name|bit
operator|=
literal|1ULL
operator|<<
operator|(
name|tid
operator|%
literal|64
operator|)
expr_stmt|;
name|bus_space_write_8
argument_list|(
name|sc
operator|->
name|bp_clear_bst
argument_list|,
name|sc
operator|->
name|bp_clear_bsh
argument_list|,
operator|(
name|BP_FIRST_SOFT
operator|/
literal|8
operator|)
operator|+
operator|(
name|tid
operator|/
literal|64
operator|)
argument_list|,
name|bit
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
name|devclass_t
name|beripic_devclass
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|device_method_t
name|beripic_fdt_methods
index|[]
init|=
block|{
comment|/* Device interface */
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|beripic_fdt_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|beripic_fdt_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|fdt_ic_activate_intr
argument_list|,
name|beripic_activate_intr
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|fdt_ic_alloc_intr
argument_list|,
name|beripic_alloc_intr
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|fdt_ic_config_intr
argument_list|,
name|beripic_config_intr
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|fdt_ic_deactivate_intr
argument_list|,
name|beripic_deactivate_intr
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|fdt_ic_release_intr
argument_list|,
name|beripic_release_intr
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|fdt_ic_setup_intr
argument_list|,
name|beripic_setup_intr
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|fdt_ic_teardown_intr
argument_list|,
name|beripic_teardown_intr
argument_list|)
block|,
ifdef|#
directive|ifdef
name|SMP
name|DEVMETHOD
argument_list|(
name|fdt_ic_setup_ipi
argument_list|,
name|beripic_setup_ipi
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|fdt_ic_clear_ipi
argument_list|,
name|beripic_clear_ipi
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|fdt_ic_send_ipi
argument_list|,
name|beripic_send_ipi
argument_list|)
block|,
endif|#
directive|endif
block|{
literal|0
block|,
literal|0
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|beripic_fdt_driver
init|=
block|{
literal|"beripic"
block|,
name|beripic_fdt_methods
block|,
expr|sizeof
operator|(
expr|struct
name|beripic_softc
operator|)
block|}
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|beripic
argument_list|,
name|simplebus
argument_list|,
name|beripic_fdt_driver
argument_list|,
name|beripic_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


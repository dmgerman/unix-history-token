begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2006 Wojciech A. Koszek<wkoszek@FreeBSD.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/imgact.h>
end_include

begin_include
include|#
directive|include
file|<sys/bio.h>
end_include

begin_include
include|#
directive|include
file|<sys/buf.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/cpu.h>
end_include

begin_include
include|#
directive|include
file|<sys/cons.h>
end_include

begin_include
include|#
directive|include
file|<sys/exec.h>
end_include

begin_include
include|#
directive|include
file|<sys/ucontext.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/kdb.h>
end_include

begin_include
include|#
directive|include
file|<sys/ptrace.h>
end_include

begin_include
include|#
directive|include
file|<sys/reboot.h>
end_include

begin_include
include|#
directive|include
file|<sys/signalvar.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysent.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysproto.h>
end_include

begin_include
include|#
directive|include
file|<sys/user.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm_object.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm_page.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm_pager.h>
end_include

begin_include
include|#
directive|include
file|<machine/atomic.h>
end_include

begin_include
include|#
directive|include
file|<machine/cache.h>
end_include

begin_include
include|#
directive|include
file|<machine/clock.h>
end_include

begin_include
include|#
directive|include
file|<machine/cpu.h>
end_include

begin_include
include|#
directive|include
file|<machine/cpuregs.h>
end_include

begin_include
include|#
directive|include
file|<machine/cpufunc.h>
end_include

begin_include
include|#
directive|include
file|<mips/octeon1/octeon_pcmap_regs.h>
end_include

begin_include
include|#
directive|include
file|<mips/octeon1/octeonreg.h>
end_include

begin_include
include|#
directive|include
file|<machine/hwfunc.h>
end_include

begin_include
include|#
directive|include
file|<machine/intr_machdep.h>
end_include

begin_include
include|#
directive|include
file|<machine/locore.h>
end_include

begin_include
include|#
directive|include
file|<machine/md_var.h>
end_include

begin_include
include|#
directive|include
file|<machine/pcpu.h>
end_include

begin_include
include|#
directive|include
file|<machine/pte.h>
end_include

begin_include
include|#
directive|include
file|<machine/trap.h>
end_include

begin_include
include|#
directive|include
file|<machine/vmparam.h>
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__mips_n64
argument_list|)
end_if

begin_define
define|#
directive|define
name|MAX_APP_DESC_ADDR
value|0xffffffffafffffff
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|MAX_APP_DESC_ADDR
value|0xafffffff
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|extern
name|int
modifier|*
name|edata
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
modifier|*
name|end
decl_stmt|;
end_decl_stmt

begin_function_decl
name|uint64_t
name|ciu_get_en_reg_addr_new
parameter_list|(
name|int
name|corenum
parameter_list|,
name|int
name|intx
parameter_list|,
name|int
name|enx
parameter_list|,
name|int
name|ciu_ip
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|ciu_dump_interrutps_enabled
parameter_list|(
name|int
name|core_num
parameter_list|,
name|int
name|intx
parameter_list|,
name|int
name|enx
parameter_list|,
name|int
name|ciu_ip
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|octeon_boot_params_init
parameter_list|(
name|register_t
name|ptr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint64_t
name|ciu_get_intr_sum_reg_addr
parameter_list|(
name|int
name|core_num
parameter_list|,
name|int
name|intx
parameter_list|,
name|int
name|enx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint64_t
name|ciu_get_intr_en_reg_addr
parameter_list|(
name|int
name|core_num
parameter_list|,
name|int
name|intx
parameter_list|,
name|int
name|enx
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|void
name|platform_cpu_init
parameter_list|()
block|{
comment|/* Nothing special yet */
block|}
end_function

begin_comment
comment|/*  * Perform a board-level soft-reset.  */
end_comment

begin_function
name|void
name|platform_reset
parameter_list|(
name|void
parameter_list|)
block|{
operator|(
operator|(
name|void
argument_list|(
operator|*
argument_list|)
argument_list|(
name|void
argument_list|)
operator|)
literal|0x1fc00000
operator|)
operator|(
operator|)
expr_stmt|;
comment|/* Jump to this hex address */
block|}
end_function

begin_function
specifier|static
specifier|inline
name|uint32_t
name|octeon_disable_interrupts
parameter_list|(
name|void
parameter_list|)
block|{
name|uint32_t
name|status_bits
decl_stmt|;
name|status_bits
operator|=
name|mips_rd_status
argument_list|()
expr_stmt|;
name|mips_wr_status
argument_list|(
name|status_bits
operator|&
operator|~
name|MIPS_SR_INT_IE
argument_list|)
expr_stmt|;
return|return
operator|(
name|status_bits
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|octeon_set_interrupts
parameter_list|(
name|uint32_t
name|status_bits
parameter_list|)
block|{
name|mips_wr_status
argument_list|(
name|status_bits
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|octeon_led_write_char
parameter_list|(
name|int
name|char_position
parameter_list|,
name|char
name|val
parameter_list|)
block|{
name|uint64_t
name|ptr
init|=
operator|(
name|OCTEON_CHAR_LED_BASE_ADDR
operator||
literal|0xf8
operator|)
decl_stmt|;
if|if
condition|(
operator|!
name|octeon_board_real
argument_list|()
condition|)
return|return;
name|char_position
operator|&=
literal|0x7
expr_stmt|;
comment|/* only 8 chars */
name|ptr
operator|+=
name|char_position
expr_stmt|;
name|oct_write8_x8
argument_list|(
name|ptr
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|octeon_led_write_char0
parameter_list|(
name|char
name|val
parameter_list|)
block|{
name|uint64_t
name|ptr
init|=
operator|(
name|OCTEON_CHAR_LED_BASE_ADDR
operator||
literal|0xf8
operator|)
decl_stmt|;
if|if
condition|(
operator|!
name|octeon_board_real
argument_list|()
condition|)
return|return;
name|oct_write8_x8
argument_list|(
name|ptr
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|octeon_led_write_hexchar
parameter_list|(
name|int
name|char_position
parameter_list|,
name|char
name|hexval
parameter_list|)
block|{
name|uint64_t
name|ptr
init|=
operator|(
name|OCTEON_CHAR_LED_BASE_ADDR
operator||
literal|0xf8
operator|)
decl_stmt|;
name|char
name|char1
decl_stmt|,
name|char2
decl_stmt|;
if|if
condition|(
operator|!
name|octeon_board_real
argument_list|()
condition|)
return|return;
name|char1
operator|=
operator|(
name|hexval
operator|>>
literal|4
operator|)
operator|&
literal|0x0f
expr_stmt|;
name|char1
operator|=
operator|(
name|char1
operator|<
literal|10
operator|)
condition|?
name|char1
operator|+
literal|'0'
else|:
name|char1
operator|+
literal|'7'
expr_stmt|;
name|char2
operator|=
operator|(
name|hexval
operator|&
literal|0x0f
operator|)
expr_stmt|;
name|char2
operator|=
operator|(
name|char2
operator|<
literal|10
operator|)
condition|?
name|char2
operator|+
literal|'0'
else|:
name|char2
operator|+
literal|'7'
expr_stmt|;
name|char_position
operator|&=
literal|0x7
expr_stmt|;
comment|/* only 8 chars */
if|if
condition|(
name|char_position
operator|>
literal|6
condition|)
name|char_position
operator|=
literal|6
expr_stmt|;
name|ptr
operator|+=
name|char_position
expr_stmt|;
name|oct_write8_x8
argument_list|(
name|ptr
argument_list|,
name|char1
argument_list|)
expr_stmt|;
name|ptr
operator|++
expr_stmt|;
name|oct_write8_x8
argument_list|(
name|ptr
argument_list|,
name|char2
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|octeon_led_write_string
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|)
block|{
name|uint64_t
name|ptr
init|=
operator|(
name|OCTEON_CHAR_LED_BASE_ADDR
operator||
literal|0xf8
operator|)
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|octeon_board_real
argument_list|()
condition|)
return|return;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
operator|,
name|ptr
operator|++
control|)
block|{
if|if
condition|(
name|str
operator|&&
operator|*
name|str
condition|)
name|oct_write8_x8
argument_list|(
name|ptr
argument_list|,
operator|*
name|str
operator|++
argument_list|)
expr_stmt|;
else|else
name|oct_write8_x8
argument_list|(
name|ptr
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
name|oct_read64
argument_list|(
name|OCTEON_MIO_BOOT_BIST_STAT
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_decl_stmt
specifier|static
name|char
name|progress
index|[
literal|8
index|]
init|=
block|{
literal|'-'
block|,
literal|'/'
block|,
literal|'|'
block|,
literal|'\\'
block|,
literal|'-'
block|,
literal|'/'
block|,
literal|'|'
block|,
literal|'\\'
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|octeon_led_run_wheel
parameter_list|(
name|int
modifier|*
name|prog_count
parameter_list|,
name|int
name|led_position
parameter_list|)
block|{
if|if
condition|(
operator|!
name|octeon_board_real
argument_list|()
condition|)
return|return;
name|octeon_led_write_char
argument_list|(
name|led_position
argument_list|,
name|progress
index|[
operator|*
name|prog_count
index|]
argument_list|)
expr_stmt|;
operator|*
name|prog_count
operator|+=
literal|1
expr_stmt|;
operator|*
name|prog_count
operator|&=
literal|0x7
expr_stmt|;
block|}
end_function

begin_define
define|#
directive|define
name|LSR_DATAREADY
value|0x01
end_define

begin_comment
comment|/* Data ready */
end_comment

begin_define
define|#
directive|define
name|LSR_THRE
value|0x20
end_define

begin_comment
comment|/* Transmit holding register empty */
end_comment

begin_define
define|#
directive|define
name|LSR_TEMT
value|0x40
end_define

begin_comment
comment|/* Transmitter Empty. THR, TSR& FIFO */
end_comment

begin_define
define|#
directive|define
name|USR_TXFIFO_NOTFULL
value|0x02
end_define

begin_comment
comment|/* Uart TX FIFO Not full */
end_comment

begin_comment
comment|/*  * octeon_uart_write_byte  *   * Put out a single byte off of uart port.  */
end_comment

begin_function
name|void
name|octeon_uart_write_byte
parameter_list|(
name|int
name|uart_index
parameter_list|,
name|uint8_t
name|ch
parameter_list|)
block|{
name|uint64_t
name|val
decl_stmt|,
name|val2
decl_stmt|;
if|if
condition|(
name|uart_index
operator|<
literal|0
operator|||
name|uart_index
operator|>
literal|1
condition|)
return|return;
while|while
condition|(
literal|1
condition|)
block|{
name|val
operator|=
name|oct_read64
argument_list|(
name|OCTEON_MIO_UART0_LSR
operator|+
operator|(
name|uart_index
operator|*
literal|0x400
operator|)
argument_list|)
expr_stmt|;
name|val2
operator|=
name|oct_read64
argument_list|(
name|OCTEON_MIO_UART0_USR
operator|+
operator|(
name|uart_index
operator|*
literal|0x400
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
operator|(
name|uint8_t
operator|)
name|val
operator|)
operator|&
name|LSR_THRE
operator|)
operator|||
operator|(
operator|(
operator|(
name|uint8_t
operator|)
name|val2
operator|)
operator|&
name|USR_TXFIFO_NOTFULL
operator|)
condition|)
block|{
break|break;
block|}
block|}
comment|/* Write the byte */
name|oct_write8
argument_list|(
name|OCTEON_MIO_UART0_THR
operator|+
operator|(
name|uart_index
operator|*
literal|0x400
operator|)
argument_list|,
operator|(
name|uint64_t
operator|)
name|ch
argument_list|)
expr_stmt|;
comment|/* Force Flush the IOBus */
name|oct_read64
argument_list|(
name|OCTEON_MIO_BOOT_BIST_STAT
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|octeon_uart_write_byte0
parameter_list|(
name|uint8_t
name|ch
parameter_list|)
block|{
name|uint64_t
name|val
decl_stmt|,
name|val2
decl_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|val
operator|=
name|oct_read64
argument_list|(
name|OCTEON_MIO_UART0_LSR
argument_list|)
expr_stmt|;
name|val2
operator|=
name|oct_read64
argument_list|(
name|OCTEON_MIO_UART0_USR
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
operator|(
name|uint8_t
operator|)
name|val
operator|)
operator|&
name|LSR_THRE
operator|)
operator|||
operator|(
operator|(
operator|(
name|uint8_t
operator|)
name|val2
operator|)
operator|&
name|USR_TXFIFO_NOTFULL
operator|)
condition|)
block|{
break|break;
block|}
block|}
comment|/* Write the byte */
name|oct_write8
argument_list|(
name|OCTEON_MIO_UART0_THR
argument_list|,
operator|(
name|uint64_t
operator|)
name|ch
argument_list|)
expr_stmt|;
comment|/* Force Flush the IOBus */
name|oct_read64
argument_list|(
name|OCTEON_MIO_BOOT_BIST_STAT
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * octeon_uart_write_string  *   */
end_comment

begin_function
name|void
name|octeon_uart_write_string
parameter_list|(
name|int
name|uart_index
parameter_list|,
specifier|const
name|char
modifier|*
name|str
parameter_list|)
block|{
comment|/* Just loop writing one byte at a time */
while|while
condition|(
operator|*
name|str
condition|)
block|{
name|octeon_uart_write_byte
argument_list|(
name|uart_index
argument_list|,
operator|*
name|str
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|str
operator|==
literal|'\n'
condition|)
block|{
name|octeon_uart_write_byte
argument_list|(
name|uart_index
argument_list|,
literal|'\r'
argument_list|)
expr_stmt|;
block|}
name|str
operator|++
expr_stmt|;
block|}
block|}
end_function

begin_decl_stmt
specifier|static
name|char
name|wstr
index|[
literal|30
index|]
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|octeon_led_write_hex
parameter_list|(
name|uint32_t
name|wl
parameter_list|)
block|{
name|char
name|nbuf
index|[
literal|80
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|nbuf
argument_list|,
literal|"%X"
argument_list|,
name|wl
argument_list|)
expr_stmt|;
name|octeon_led_write_string
argument_list|(
name|nbuf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|octeon_uart_write_hex2
parameter_list|(
name|uint32_t
name|wl
parameter_list|,
name|uint32_t
name|wh
parameter_list|)
block|{
name|sprintf
argument_list|(
name|wstr
argument_list|,
literal|"0x%X-0x%X  "
argument_list|,
name|wh
argument_list|,
name|wl
argument_list|)
expr_stmt|;
name|octeon_uart_write_string
argument_list|(
literal|0
argument_list|,
name|wstr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|octeon_uart_write_hex
parameter_list|(
name|uint32_t
name|wl
parameter_list|)
block|{
name|sprintf
argument_list|(
name|wstr
argument_list|,
literal|" 0x%X  "
argument_list|,
name|wl
argument_list|)
expr_stmt|;
name|octeon_uart_write_string
argument_list|(
literal|0
argument_list|,
name|wstr
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * octeon_wait_uart_flush  */
end_comment

begin_function
name|void
name|octeon_wait_uart_flush
parameter_list|(
name|int
name|uart_index
parameter_list|,
name|uint8_t
name|ch
parameter_list|)
block|{
name|uint64_t
name|val
decl_stmt|;
name|int64_t
name|val3
decl_stmt|;
name|uint32_t
name|cpu_status_bits
decl_stmt|;
if|if
condition|(
name|uart_index
operator|<
literal|0
operator|||
name|uart_index
operator|>
literal|1
condition|)
return|return;
name|cpu_status_bits
operator|=
name|octeon_disable_interrupts
argument_list|()
expr_stmt|;
comment|/* Force Flush the IOBus */
name|oct_read64
argument_list|(
name|OCTEON_MIO_BOOT_BIST_STAT
argument_list|)
expr_stmt|;
for|for
control|(
name|val3
operator|=
literal|0xfffffffff
init|;
name|val3
operator|>
literal|0
condition|;
name|val3
operator|--
control|)
block|{
name|val
operator|=
name|oct_read64
argument_list|(
name|OCTEON_MIO_UART0_LSR
operator|+
operator|(
name|uart_index
operator|*
literal|0x400
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|uint8_t
operator|)
name|val
operator|)
operator|&
name|LSR_TEMT
condition|)
break|break;
block|}
name|octeon_set_interrupts
argument_list|(
name|cpu_status_bits
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * octeon_debug_symbol  *  * Does nothing.  * Used to mark the point for simulator to begin tracing  */
end_comment

begin_function
name|void
name|octeon_debug_symbol
parameter_list|(
name|void
parameter_list|)
block|{ }
end_function

begin_function
name|void
name|octeon_ciu_stop_gtimer
parameter_list|(
name|int
name|timer
parameter_list|)
block|{
name|oct_write64
argument_list|(
name|OCTEON_CIU_GENTIMER_ADDR
argument_list|(
name|timer
argument_list|)
argument_list|,
literal|0ll
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|octeon_ciu_start_gtimer
parameter_list|(
name|int
name|timer
parameter_list|,
name|u_int
name|one_shot
parameter_list|,
name|uint64_t
name|time_cycles
parameter_list|)
block|{
name|octeon_ciu_gentimer
name|gentimer
decl_stmt|;
name|gentimer
operator|.
name|word64
operator|=
literal|0
expr_stmt|;
name|gentimer
operator|.
name|bits
operator|.
name|one_shot
operator|=
name|one_shot
expr_stmt|;
name|gentimer
operator|.
name|bits
operator|.
name|len
operator|=
name|time_cycles
operator|-
literal|1
expr_stmt|;
name|oct_write64
argument_list|(
name|OCTEON_CIU_GENTIMER_ADDR
argument_list|(
name|timer
argument_list|)
argument_list|,
name|gentimer
operator|.
name|word64
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * octeon_ciu_reset  *  * Shutdown all CIU to IP2, IP3 mappings  */
end_comment

begin_function
name|void
name|octeon_ciu_reset
parameter_list|(
name|void
parameter_list|)
block|{
name|octeon_ciu_stop_gtimer
argument_list|(
name|CIU_GENTIMER_NUM_0
argument_list|)
expr_stmt|;
name|octeon_ciu_stop_gtimer
argument_list|(
name|CIU_GENTIMER_NUM_1
argument_list|)
expr_stmt|;
name|octeon_ciu_stop_gtimer
argument_list|(
name|CIU_GENTIMER_NUM_2
argument_list|)
expr_stmt|;
name|octeon_ciu_stop_gtimer
argument_list|(
name|CIU_GENTIMER_NUM_3
argument_list|)
expr_stmt|;
name|ciu_disable_intr
argument_list|(
name|CIU_THIS_CORE
argument_list|,
name|CIU_INT_0
argument_list|,
name|CIU_EN_0
argument_list|)
expr_stmt|;
name|ciu_disable_intr
argument_list|(
name|CIU_THIS_CORE
argument_list|,
name|CIU_INT_0
argument_list|,
name|CIU_EN_1
argument_list|)
expr_stmt|;
name|ciu_disable_intr
argument_list|(
name|CIU_THIS_CORE
argument_list|,
name|CIU_INT_1
argument_list|,
name|CIU_EN_0
argument_list|)
expr_stmt|;
name|ciu_disable_intr
argument_list|(
name|CIU_THIS_CORE
argument_list|,
name|CIU_INT_1
argument_list|,
name|CIU_EN_1
argument_list|)
expr_stmt|;
name|ciu_clear_int_summary
argument_list|(
name|CIU_THIS_CORE
argument_list|,
name|CIU_INT_0
argument_list|,
name|CIU_EN_0
argument_list|,
literal|0ll
argument_list|)
expr_stmt|;
name|ciu_clear_int_summary
argument_list|(
name|CIU_THIS_CORE
argument_list|,
name|CIU_INT_1
argument_list|,
name|CIU_EN_0
argument_list|,
literal|0ll
argument_list|)
expr_stmt|;
name|ciu_clear_int_summary
argument_list|(
name|CIU_THIS_CORE
argument_list|,
name|CIU_INT_1
argument_list|,
name|CIU_EN_1
argument_list|,
literal|0ll
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * mips_disable_interrupt_controllers  *  * Disable interrupts in the CPU controller  */
end_comment

begin_function
name|void
name|mips_disable_interrupt_controls
parameter_list|(
name|void
parameter_list|)
block|{
comment|/* 	 * Disable interrupts in CIU. 	 */
name|octeon_ciu_reset
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * ciu_get_intr_sum_reg_addr  */
end_comment

begin_function
specifier|static
name|uint64_t
name|ciu_get_intr_sum_reg_addr
parameter_list|(
name|int
name|core_num
parameter_list|,
name|int
name|intx
parameter_list|,
name|int
name|enx
parameter_list|)
block|{
name|uint64_t
name|ciu_intr_sum_reg_addr
decl_stmt|;
if|if
condition|(
name|enx
operator|==
name|CIU_EN_0
condition|)
name|ciu_intr_sum_reg_addr
operator|=
name|OCTEON_CIU_SUMMARY_BASE_ADDR
operator|+
operator|(
name|core_num
operator|*
literal|0x10
operator|)
operator|+
operator|(
name|intx
operator|*
literal|0x8
operator|)
expr_stmt|;
else|else
name|ciu_intr_sum_reg_addr
operator|=
name|OCTEON_CIU_SUMMARY_INT1_ADDR
expr_stmt|;
return|return
operator|(
name|ciu_intr_sum_reg_addr
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * ciu_get_intr_en_reg_addr  */
end_comment

begin_function
specifier|static
name|uint64_t
name|ciu_get_intr_en_reg_addr
parameter_list|(
name|int
name|core_num
parameter_list|,
name|int
name|intx
parameter_list|,
name|int
name|enx
parameter_list|)
block|{
name|uint64_t
name|ciu_intr_reg_addr
decl_stmt|;
name|ciu_intr_reg_addr
operator|=
name|OCTEON_CIU_ENABLE_BASE_ADDR
operator|+
operator|(
operator|(
name|enx
operator|==
literal|0
operator|)
condition|?
literal|0x0
else|:
literal|0x8
operator|)
operator|+
operator|(
name|intx
operator|*
literal|0x10
operator|)
operator|+
operator|(
name|core_num
operator|*
literal|0x20
operator|)
expr_stmt|;
return|return
operator|(
name|ciu_intr_reg_addr
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * ciu_get_intr_reg_addr  *  * 200 ---int0,en0 ip2  * 208 ---int0,en1 ip2 ----> this is wrong... this is watchdog  *   * 210 ---int0,en0 ip3 --  * 218 ---int0,en1 ip3 ----> same here.. .this is watchdog... right?  *   * 220 ---int1,en0 ip2  * 228 ---int1,en1 ip2  * 230 ---int1,en0 ip3 --  * 238 ---int1,en1 ip3  *  */
end_comment

begin_function
name|uint64_t
name|ciu_get_en_reg_addr_new
parameter_list|(
name|int
name|corenum
parameter_list|,
name|int
name|intx
parameter_list|,
name|int
name|enx
parameter_list|,
name|int
name|ciu_ip
parameter_list|)
block|{
name|uint64_t
name|ciu_intr_reg_addr
init|=
name|OCTEON_CIU_ENABLE_BASE_ADDR
decl_stmt|;
comment|/* XXX kasserts? */
if|if
condition|(
name|enx
operator|<
name|CIU_EN_0
operator|||
name|enx
operator|>
name|CIU_EN_1
condition|)
block|{
name|printf
argument_list|(
literal|"%s: invalid enx value %d, should be %d or %d\n"
argument_list|,
name|__FUNCTION__
argument_list|,
name|enx
argument_list|,
name|CIU_EN_0
argument_list|,
name|CIU_EN_1
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|intx
operator|<
name|CIU_INT_0
operator|||
name|intx
operator|>
name|CIU_INT_1
condition|)
block|{
name|printf
argument_list|(
literal|"%s: invalid intx value %d, should be %d or %d\n"
argument_list|,
name|__FUNCTION__
argument_list|,
name|enx
argument_list|,
name|CIU_INT_0
argument_list|,
name|CIU_INT_1
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|ciu_ip
operator|<
name|CIU_MIPS_IP2
operator|||
name|ciu_ip
operator|>
name|CIU_MIPS_IP3
condition|)
block|{
name|printf
argument_list|(
literal|"%s: invalid ciu_ip value %d, should be %d or %d\n"
argument_list|,
name|__FUNCTION__
argument_list|,
name|ciu_ip
argument_list|,
name|CIU_MIPS_IP2
argument_list|,
name|CIU_MIPS_IP3
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|ciu_intr_reg_addr
operator|+=
operator|(
name|enx
operator|*
literal|0x8
operator|)
expr_stmt|;
name|ciu_intr_reg_addr
operator|+=
operator|(
name|ciu_ip
operator|*
literal|0x10
operator|)
expr_stmt|;
name|ciu_intr_reg_addr
operator|+=
operator|(
name|intx
operator|*
literal|0x20
operator|)
expr_stmt|;
return|return
operator|(
name|ciu_intr_reg_addr
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * ciu_get_int_summary  */
end_comment

begin_function
name|uint64_t
name|ciu_get_int_summary
parameter_list|(
name|int
name|core_num
parameter_list|,
name|int
name|intx
parameter_list|,
name|int
name|enx
parameter_list|)
block|{
name|uint64_t
name|ciu_intr_sum_reg_addr
decl_stmt|;
if|if
condition|(
name|core_num
operator|==
name|CIU_THIS_CORE
condition|)
name|core_num
operator|=
name|octeon_get_core_num
argument_list|()
expr_stmt|;
name|ciu_intr_sum_reg_addr
operator|=
name|ciu_get_intr_sum_reg_addr
argument_list|(
name|core_num
argument_list|,
name|intx
argument_list|,
name|enx
argument_list|)
expr_stmt|;
return|return
operator|(
name|oct_read64
argument_list|(
name|ciu_intr_sum_reg_addr
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|//#define DEBUG_CIU 1
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|DEBUG_CIU
end_ifdef

begin_define
define|#
directive|define
name|DEBUG_CIU_SUM
value|1
end_define

begin_define
define|#
directive|define
name|DEBUG_CIU_EN
value|1
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * ciu_clear_int_summary  */
end_comment

begin_function
name|void
name|ciu_clear_int_summary
parameter_list|(
name|int
name|core_num
parameter_list|,
name|int
name|intx
parameter_list|,
name|int
name|enx
parameter_list|,
name|uint64_t
name|write_bits
parameter_list|)
block|{
name|uint32_t
name|cpu_status_bits
decl_stmt|;
name|uint64_t
name|ciu_intr_sum_reg_addr
decl_stmt|;
comment|//#define DEBUG_CIU_SUM 1
ifdef|#
directive|ifdef
name|DEBUG_CIU_SUM
name|uint64_t
name|ciu_intr_sum_bits
decl_stmt|;
endif|#
directive|endif
if|if
condition|(
name|core_num
operator|==
name|CIU_THIS_CORE
condition|)
block|{
name|core_num
operator|=
name|octeon_get_core_num
argument_list|()
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|DEBUG_CIU_SUM
name|printf
argument_list|(
literal|" CIU: core %u clear sum IntX %u  Enx %u  Bits: 0x%llX\n"
argument_list|,
name|core_num
argument_list|,
name|intx
argument_list|,
name|enx
argument_list|,
name|write_bits
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|cpu_status_bits
operator|=
name|octeon_disable_interrupts
argument_list|()
expr_stmt|;
name|ciu_intr_sum_reg_addr
operator|=
name|ciu_get_intr_sum_reg_addr
argument_list|(
name|core_num
argument_list|,
name|intx
argument_list|,
name|enx
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG_CIU_SUM
name|ciu_intr_sum_bits
operator|=
name|oct_read64
argument_list|(
name|ciu_intr_sum_reg_addr
argument_list|)
expr_stmt|;
comment|/* unneeded dummy read */
name|printf
argument_list|(
literal|" CIU: status: 0x%X  reg_addr: 0x%llX   Val: 0x%llX   ->  0x%llX"
argument_list|,
name|cpu_status_bits
argument_list|,
name|ciu_intr_sum_reg_addr
argument_list|,
name|ciu_intr_sum_bits
argument_list|,
name|ciu_intr_sum_bits
operator||
name|write_bits
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|oct_write64
argument_list|(
name|ciu_intr_sum_reg_addr
argument_list|,
name|write_bits
argument_list|)
expr_stmt|;
name|oct_read64
argument_list|(
name|OCTEON_MIO_BOOT_BIST_STAT
argument_list|)
expr_stmt|;
comment|/* Bus Barrier */
ifdef|#
directive|ifdef
name|DEBUG_CIU_SUM
name|printf
argument_list|(
literal|" Readback: 0x%llX\n\n   "
argument_list|,
operator|(
name|uint64_t
operator|)
name|oct_read64
argument_list|(
name|ciu_intr_sum_reg_addr
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|octeon_set_interrupts
argument_list|(
name|cpu_status_bits
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * ciu_disable_intr  */
end_comment

begin_function
name|void
name|ciu_disable_intr
parameter_list|(
name|int
name|core_num
parameter_list|,
name|int
name|intx
parameter_list|,
name|int
name|enx
parameter_list|)
block|{
name|uint32_t
name|cpu_status_bits
decl_stmt|;
name|uint64_t
name|ciu_intr_reg_addr
decl_stmt|;
if|if
condition|(
name|core_num
operator|==
name|CIU_THIS_CORE
condition|)
name|core_num
operator|=
name|octeon_get_core_num
argument_list|()
expr_stmt|;
name|cpu_status_bits
operator|=
name|octeon_disable_interrupts
argument_list|()
expr_stmt|;
name|ciu_intr_reg_addr
operator|=
name|ciu_get_intr_en_reg_addr
argument_list|(
name|core_num
argument_list|,
name|intx
argument_list|,
name|enx
argument_list|)
expr_stmt|;
name|oct_read64
argument_list|(
name|ciu_intr_reg_addr
argument_list|)
expr_stmt|;
comment|/* Dummy read */
name|oct_write64
argument_list|(
name|ciu_intr_reg_addr
argument_list|,
literal|0LL
argument_list|)
expr_stmt|;
name|oct_read64
argument_list|(
name|OCTEON_MIO_BOOT_BIST_STAT
argument_list|)
expr_stmt|;
comment|/* Bus Barrier */
name|octeon_set_interrupts
argument_list|(
name|cpu_status_bits
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ciu_dump_interrutps_enabled
parameter_list|(
name|int
name|core_num
parameter_list|,
name|int
name|intx
parameter_list|,
name|int
name|enx
parameter_list|,
name|int
name|ciu_ip
parameter_list|)
block|{
name|uint64_t
name|ciu_intr_reg_addr
decl_stmt|;
name|uint64_t
name|ciu_intr_bits
decl_stmt|;
if|if
condition|(
name|core_num
operator|==
name|CIU_THIS_CORE
condition|)
block|{
name|core_num
operator|=
name|octeon_get_core_num
argument_list|()
expr_stmt|;
block|}
ifndef|#
directive|ifndef
name|OCTEON_SMP_1
name|ciu_intr_reg_addr
operator|=
name|ciu_get_intr_en_reg_addr
argument_list|(
name|core_num
argument_list|,
name|intx
argument_list|,
name|enx
argument_list|)
expr_stmt|;
else|#
directive|else
name|ciu_intr_reg_addr
operator|=
name|ciu_get_en_reg_addr_new
argument_list|(
name|core_num
argument_list|,
name|intx
argument_list|,
name|enx
argument_list|,
name|ciu_ip
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|ciu_intr_reg_addr
condition|)
block|{
name|printf
argument_list|(
literal|"Bad call to %s\n"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
while|while
condition|(
literal|1
condition|)
empty_stmt|;
return|return;
block|}
name|ciu_intr_bits
operator|=
name|oct_read64
argument_list|(
name|ciu_intr_reg_addr
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" CIU core %d  int: %d  en: %d  ip: %d  Add: %#llx  enabled: %#llx  SR: %x\n"
argument_list|,
name|core_num
argument_list|,
name|intx
argument_list|,
name|enx
argument_list|,
name|ciu_ip
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|ciu_intr_reg_addr
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|ciu_intr_bits
argument_list|,
name|mips_rd_status
argument_list|()
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * ciu_enable_interrupts  */
end_comment

begin_function
name|void
name|ciu_enable_interrupts
parameter_list|(
name|int
name|core_num
parameter_list|,
name|int
name|intx
parameter_list|,
name|int
name|enx
parameter_list|,
name|uint64_t
name|set_these_interrupt_bits
parameter_list|,
name|int
name|ciu_ip
parameter_list|)
block|{
name|uint32_t
name|cpu_status_bits
decl_stmt|;
name|uint64_t
name|ciu_intr_reg_addr
decl_stmt|;
name|uint64_t
name|ciu_intr_bits
decl_stmt|;
if|if
condition|(
name|core_num
operator|==
name|CIU_THIS_CORE
condition|)
name|core_num
operator|=
name|octeon_get_core_num
argument_list|()
expr_stmt|;
comment|//#define DEBUG_CIU_EN 1
ifdef|#
directive|ifdef
name|DEBUG_CIU_EN
name|printf
argument_list|(
literal|" CIU: core %u enabling Intx %u  Enx %u IP %d  Bits: 0x%llX\n"
argument_list|,
name|core_num
argument_list|,
name|intx
argument_list|,
name|enx
argument_list|,
name|ciu_ip
argument_list|,
name|set_these_interrupt_bits
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|cpu_status_bits
operator|=
name|octeon_disable_interrupts
argument_list|()
expr_stmt|;
ifndef|#
directive|ifndef
name|OCTEON_SMP_1
name|ciu_intr_reg_addr
operator|=
name|ciu_get_intr_en_reg_addr
argument_list|(
name|core_num
argument_list|,
name|intx
argument_list|,
name|enx
argument_list|)
expr_stmt|;
else|#
directive|else
name|ciu_intr_reg_addr
operator|=
name|ciu_get_en_reg_addr_new
argument_list|(
name|core_num
argument_list|,
name|intx
argument_list|,
name|enx
argument_list|,
name|ciu_ip
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|ciu_intr_reg_addr
condition|)
block|{
name|printf
argument_list|(
literal|"Bad call to %s\n"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
while|while
condition|(
literal|1
condition|)
empty_stmt|;
return|return;
comment|/* XXX */
block|}
name|ciu_intr_bits
operator|=
name|oct_read64
argument_list|(
name|ciu_intr_reg_addr
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG_CIU_EN
name|printf
argument_list|(
literal|" CIU: status: 0x%X  reg_addr: 0x%llX   Val: 0x%llX   ->  0x%llX"
argument_list|,
name|cpu_status_bits
argument_list|,
name|ciu_intr_reg_addr
argument_list|,
name|ciu_intr_bits
argument_list|,
name|ciu_intr_bits
operator||
name|set_these_interrupt_bits
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|ciu_intr_bits
operator||=
name|set_these_interrupt_bits
expr_stmt|;
name|oct_write64
argument_list|(
name|ciu_intr_reg_addr
argument_list|,
name|ciu_intr_bits
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|OCTEON_SMP
name|mips_wbflush
argument_list|()
expr_stmt|;
endif|#
directive|endif
name|oct_read64
argument_list|(
name|OCTEON_MIO_BOOT_BIST_STAT
argument_list|)
expr_stmt|;
comment|/* Bus Barrier */
ifdef|#
directive|ifdef
name|DEBUG_CIU_EN
name|printf
argument_list|(
literal|" Readback: 0x%llX\n\n   "
argument_list|,
operator|(
name|uint64_t
operator|)
name|oct_read64
argument_list|(
name|ciu_intr_reg_addr
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|octeon_set_interrupts
argument_list|(
name|cpu_status_bits
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|platform_start
parameter_list|(
name|__register_t
name|a0
parameter_list|,
name|__register_t
name|a1
parameter_list|,
name|__register_t
name|a2
name|__unused
parameter_list|,
name|__register_t
name|a3
parameter_list|)
block|{
name|uint64_t
name|platform_counter_freq
decl_stmt|;
name|vm_offset_t
name|kernend
decl_stmt|;
name|int
name|argc
init|=
name|a0
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
init|=
operator|(
name|char
operator|*
operator|*
operator|)
name|a1
decl_stmt|;
name|int
name|i
decl_stmt|,
name|mem
decl_stmt|;
comment|/* clear the BSS and SBSS segments */
name|kernend
operator|=
name|round_page
argument_list|(
operator|(
name|vm_offset_t
operator|)
operator|&
name|end
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|edata
argument_list|,
literal|0
argument_list|,
name|kernend
operator|-
call|(
name|vm_offset_t
call|)
argument_list|(
operator|&
name|edata
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Initialize pcpu stuff */
name|mips_pcpu_init
argument_list|()
expr_stmt|;
name|octeon_boot_params_init
argument_list|(
name|a3
argument_list|)
expr_stmt|;
comment|/* XXX octeon boot decriptor has args in it... */
name|octeon_ciu_reset
argument_list|()
expr_stmt|;
name|octeon_uart_write_string
argument_list|(
literal|0
argument_list|,
literal|"Platform Starting\n"
argument_list|)
expr_stmt|;
comment|/* 	 * Looking for mem=XXM argument 	 */
name|mem
operator|=
literal|0
expr_stmt|;
comment|/* Just something to start with */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|strncmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"mem="
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
name|mem
operator|=
name|strtol
argument_list|(
name|argv
index|[
name|i
index|]
operator|+
literal|4
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|bootverbose
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|mem
operator|>
literal|0
condition|)
name|realmem
operator|=
name|btoc
argument_list|(
name|mem
operator|<<
literal|20
argument_list|)
expr_stmt|;
else|else
name|realmem
operator|=
name|btoc
argument_list|(
literal|32
operator|<<
literal|20
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|10
condition|;
name|i
operator|++
control|)
name|phys_avail
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
comment|/* phys_avail regions are in bytes */
name|phys_avail
index|[
literal|0
index|]
operator|=
name|MIPS_KSEG0_TO_PHYS
argument_list|(
operator|(
name|vm_offset_t
operator|)
operator|&
name|end
argument_list|)
expr_stmt|;
name|phys_avail
index|[
literal|1
index|]
operator|=
name|ctob
argument_list|(
name|realmem
argument_list|)
expr_stmt|;
name|physmem
operator|=
name|realmem
expr_stmt|;
name|pmap_bootstrap
argument_list|()
expr_stmt|;
name|mips_proc0_init
argument_list|()
expr_stmt|;
name|init_param1
argument_list|()
expr_stmt|;
comment|/* TODO: parse argc,argv */
name|platform_counter_freq
operator|=
literal|330000000UL
expr_stmt|;
comment|/* XXX: from idt */
name|mips_timer_init_params
argument_list|(
name|platform_counter_freq
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|cninit
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"cmd line: "
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"%s "
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|init_param2
argument_list|(
name|physmem
argument_list|)
expr_stmt|;
name|mips_cpu_init
argument_list|()
expr_stmt|;
name|mutex_init
argument_list|()
expr_stmt|;
ifdef|#
directive|ifdef
name|DDB
name|kdb_init
argument_list|()
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/*  ****************************************************************************************  *  * APP/BOOT  DESCRIPTOR  STUFF  *  ****************************************************************************************  */
end_comment

begin_comment
comment|/* Define the struct that is initialized by the bootloader used by the   * startup code.  *  * Copyright (c) 2004, 2005, 2006 Cavium Networks.  *  * The authors hereby grant permission to use, copy, modify, distribute,  * and license this software and its documentation for any purpose, provided  * that existing copyright notices are retained in all copies and that this  * notice is included verbatim in any distributions. No written agreement,  * license, or royalty fee is required for any of the authorized uses.  * Modifications to this software may be copyrighted by their authors  * and need not follow the licensing terms described here, provided that  * the new terms are clearly indicated on the first page of each file where  * they apply.  */
end_comment

begin_define
define|#
directive|define
name|OCTEON_CURRENT_DESC_VERSION
value|6
end_define

begin_define
define|#
directive|define
name|OCTEON_ARGV_MAX_ARGS
value|(64)
end_define

begin_define
define|#
directive|define
name|OCTOEN_SERIAL_LEN
value|20
end_define

begin_typedef
typedef|typedef
struct|struct
block|{
comment|/* Start of block referenced by assembly code - do not change! */
name|uint32_t
name|desc_version
decl_stmt|;
name|uint32_t
name|desc_size
decl_stmt|;
name|uint64_t
name|stack_top
decl_stmt|;
name|uint64_t
name|heap_base
decl_stmt|;
name|uint64_t
name|heap_end
decl_stmt|;
name|uint64_t
name|entry_point
decl_stmt|;
comment|/* Only used by bootloader */
name|uint64_t
name|desc_vaddr
decl_stmt|;
comment|/* End of This block referenced by assembly code - do not change! */
name|uint32_t
name|exception_base_addr
decl_stmt|;
name|uint32_t
name|stack_size
decl_stmt|;
name|uint32_t
name|heap_size
decl_stmt|;
name|uint32_t
name|argc
decl_stmt|;
comment|/* Argc count for application */
name|uint32_t
name|argv
index|[
name|OCTEON_ARGV_MAX_ARGS
index|]
decl_stmt|;
name|uint32_t
name|flags
decl_stmt|;
name|uint32_t
name|core_mask
decl_stmt|;
name|uint32_t
name|dram_size
decl_stmt|;
comment|/**< DRAM size in megabyes */
name|uint32_t
name|phy_mem_desc_addr
decl_stmt|;
comment|/**< physical address of free memory descriptor block*/
name|uint32_t
name|debugger_flags_base_addr
decl_stmt|;
comment|/**< used to pass flags from app to debugger */
name|uint32_t
name|eclock_hz
decl_stmt|;
comment|/**< CPU clock speed, in hz */
name|uint32_t
name|dclock_hz
decl_stmt|;
comment|/**< DRAM clock speed, in hz */
name|uint32_t
name|spi_clock_hz
decl_stmt|;
comment|/**< SPI4 clock in hz */
name|uint16_t
name|board_type
decl_stmt|;
name|uint8_t
name|board_rev_major
decl_stmt|;
name|uint8_t
name|board_rev_minor
decl_stmt|;
name|uint16_t
name|chip_type
decl_stmt|;
name|uint8_t
name|chip_rev_major
decl_stmt|;
name|uint8_t
name|chip_rev_minor
decl_stmt|;
name|char
name|board_serial_number
index|[
name|OCTOEN_SERIAL_LEN
index|]
decl_stmt|;
name|uint8_t
name|mac_addr_base
index|[
literal|6
index|]
decl_stmt|;
name|uint8_t
name|mac_addr_count
decl_stmt|;
name|uint64_t
name|cvmx_desc_vaddr
decl_stmt|;
block|}
name|octeon_boot_descriptor_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
block|{
name|uint32_t
name|major_version
decl_stmt|;
name|uint32_t
name|minor_version
decl_stmt|;
name|uint64_t
name|stack_top
decl_stmt|;
name|uint64_t
name|heap_base
decl_stmt|;
name|uint64_t
name|heap_end
decl_stmt|;
name|uint64_t
name|desc_vaddr
decl_stmt|;
name|uint32_t
name|exception_base_addr
decl_stmt|;
name|uint32_t
name|stack_size
decl_stmt|;
name|uint32_t
name|flags
decl_stmt|;
name|uint32_t
name|core_mask
decl_stmt|;
name|uint32_t
name|dram_size
decl_stmt|;
comment|/**< DRAM size in megabyes */
name|uint32_t
name|phy_mem_desc_addr
decl_stmt|;
comment|/**< physical address of free memory descriptor block*/
name|uint32_t
name|debugger_flags_base_addr
decl_stmt|;
comment|/**< used to pass flags from app to debugger */
name|uint32_t
name|eclock_hz
decl_stmt|;
comment|/**< CPU clock speed, in hz */
name|uint32_t
name|dclock_hz
decl_stmt|;
comment|/**< DRAM clock speed, in hz */
name|uint32_t
name|spi_clock_hz
decl_stmt|;
comment|/**< SPI4 clock in hz */
name|uint16_t
name|board_type
decl_stmt|;
name|uint8_t
name|board_rev_major
decl_stmt|;
name|uint8_t
name|board_rev_minor
decl_stmt|;
name|uint16_t
name|chip_type
decl_stmt|;
name|uint8_t
name|chip_rev_major
decl_stmt|;
name|uint8_t
name|chip_rev_minor
decl_stmt|;
name|char
name|board_serial_number
index|[
name|OCTOEN_SERIAL_LEN
index|]
decl_stmt|;
name|uint8_t
name|mac_addr_base
index|[
literal|6
index|]
decl_stmt|;
name|uint8_t
name|mac_addr_count
decl_stmt|;
block|}
name|cvmx_bootinfo_t
typedef|;
end_typedef

begin_decl_stmt
name|uint32_t
name|octeon_cpu_clock
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|uint64_t
name|octeon_dram
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|uint32_t
name|octeon_bd_ver
init|=
literal|0
decl_stmt|,
name|octeon_cvmx_bd_ver
init|=
literal|0
decl_stmt|,
name|octeon_board_rev_major
decl_stmt|,
name|octeon_board_rev_minor
decl_stmt|,
name|octeon_board_type
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|uint8_t
name|octeon_mac_addr
index|[
literal|6
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|octeon_core_mask
decl_stmt|,
name|octeon_mac_addr_count
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|octeon_chip_rev_major
init|=
literal|0
decl_stmt|,
name|octeon_chip_rev_minor
init|=
literal|0
decl_stmt|,
name|octeon_chip_type
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int32_t
name|app_descriptor_addr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|octeon_boot_descriptor_t
modifier|*
name|app_desc_ptr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|cvmx_bootinfo_t
modifier|*
name|cvmx_desc_ptr
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|OCTEON_BOARD_TYPE_NONE
value|0
end_define

begin_define
define|#
directive|define
name|OCTEON_BOARD_TYPE_SIM
value|1
end_define

begin_define
define|#
directive|define
name|OCTEON_CLOCK_MIN
value|(100 * 1000 * 1000)
end_define

begin_define
define|#
directive|define
name|OCTEON_CLOCK_MAX
value|(800 * 1000 * 1000)
end_define

begin_define
define|#
directive|define
name|OCTEON_DRAM_DEFAULT
value|(256 * 1024 * 1024)
end_define

begin_define
define|#
directive|define
name|OCTEON_DRAM_MIN
value|30
end_define

begin_define
define|#
directive|define
name|OCTEON_DRAM_MAX
value|3000
end_define

begin_function
name|int
name|octeon_board_real
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
operator|(
name|octeon_board_type
operator|==
name|OCTEON_BOARD_TYPE_NONE
operator|)
operator|||
operator|(
name|octeon_board_type
operator|==
name|OCTEON_BOARD_TYPE_SIM
operator|)
operator|||
operator|!
name|octeon_board_rev_major
condition|)
return|return
literal|0
return|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|octeon_process_app_desc_ver_unknown
parameter_list|(
name|void
parameter_list|)
block|{
name|printf
argument_list|(
literal|" Unknown Boot-Descriptor: Using Defaults\n"
argument_list|)
expr_stmt|;
name|octeon_cpu_clock
operator|=
name|OCTEON_CLOCK_DEFAULT
expr_stmt|;
name|octeon_dram
operator|=
name|OCTEON_DRAM_DEFAULT
expr_stmt|;
name|octeon_board_rev_major
operator|=
name|octeon_board_rev_minor
operator|=
name|octeon_board_type
operator|=
literal|0
expr_stmt|;
name|octeon_core_mask
operator|=
literal|1
expr_stmt|;
name|octeon_cpu_clock
operator|=
name|OCTEON_CLOCK_DEFAULT
expr_stmt|;
name|octeon_chip_type
operator|=
name|octeon_chip_rev_major
operator|=
name|octeon_chip_rev_minor
operator|=
literal|0
expr_stmt|;
name|octeon_mac_addr
index|[
literal|0
index|]
operator|=
literal|0x00
expr_stmt|;
name|octeon_mac_addr
index|[
literal|1
index|]
operator|=
literal|0x0f
expr_stmt|;
name|octeon_mac_addr
index|[
literal|2
index|]
operator|=
literal|0xb7
expr_stmt|;
name|octeon_mac_addr
index|[
literal|3
index|]
operator|=
literal|0x10
expr_stmt|;
name|octeon_mac_addr
index|[
literal|4
index|]
operator|=
literal|0x09
expr_stmt|;
name|octeon_mac_addr
index|[
literal|5
index|]
operator|=
literal|0x06
expr_stmt|;
name|octeon_mac_addr_count
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|octeon_process_app_desc_ver_6
parameter_list|(
name|void
parameter_list|)
block|{
comment|/* XXX Why is 0x00000000ffffffffULL a bad value?  */
if|if
condition|(
name|app_desc_ptr
operator|->
name|cvmx_desc_vaddr
operator|==
literal|0
operator|||
name|app_desc_ptr
operator|->
name|cvmx_desc_vaddr
operator|==
literal|0xfffffffful
condition|)
block|{
name|printf
argument_list|(
literal|"Bad cvmx_desc_ptr %p\n"
argument_list|,
name|cvmx_desc_ptr
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
name|cvmx_desc_ptr
operator|=
operator|(
name|cvmx_bootinfo_t
operator|*
operator|)
operator|(
name|intptr_t
operator|)
name|app_desc_ptr
operator|->
name|cvmx_desc_vaddr
expr_stmt|;
name|cvmx_desc_ptr
operator|=
operator|(
name|cvmx_bootinfo_t
operator|*
operator|)
operator|(
operator|(
name|intptr_t
operator|)
name|cvmx_desc_ptr
operator||
name|MIPS_KSEG0_START
operator|)
expr_stmt|;
name|octeon_cvmx_bd_ver
operator|=
operator|(
name|cvmx_desc_ptr
operator|->
name|major_version
operator|*
literal|100
operator|)
operator|+
name|cvmx_desc_ptr
operator|->
name|minor_version
expr_stmt|;
comment|/* Too early for panic? */
if|if
condition|(
name|cvmx_desc_ptr
operator|->
name|major_version
operator|!=
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"Incompatible CVMX descriptor from bootloader: %d.%d %p\n"
argument_list|,
operator|(
name|int
operator|)
name|cvmx_desc_ptr
operator|->
name|major_version
argument_list|,
operator|(
name|int
operator|)
name|cvmx_desc_ptr
operator|->
name|minor_version
argument_list|,
name|cvmx_desc_ptr
argument_list|)
expr_stmt|;
while|while
condition|(
literal|1
condition|)
empty_stmt|;
comment|/*  Never return */
return|return
literal|1
return|;
comment|/*  Satisfy the compiler */
block|}
name|octeon_core_mask
operator|=
name|cvmx_desc_ptr
operator|->
name|core_mask
expr_stmt|;
name|octeon_cpu_clock
operator|=
name|cvmx_desc_ptr
operator|->
name|eclock_hz
expr_stmt|;
name|octeon_board_type
operator|=
name|cvmx_desc_ptr
operator|->
name|board_type
expr_stmt|;
name|octeon_board_rev_major
operator|=
name|cvmx_desc_ptr
operator|->
name|board_rev_major
expr_stmt|;
name|octeon_board_rev_minor
operator|=
name|cvmx_desc_ptr
operator|->
name|board_rev_minor
expr_stmt|;
name|octeon_chip_type
operator|=
name|cvmx_desc_ptr
operator|->
name|chip_type
expr_stmt|;
name|octeon_chip_rev_major
operator|=
name|cvmx_desc_ptr
operator|->
name|chip_rev_major
expr_stmt|;
name|octeon_chip_rev_minor
operator|=
name|cvmx_desc_ptr
operator|->
name|chip_rev_minor
expr_stmt|;
name|octeon_mac_addr
index|[
literal|0
index|]
operator|=
name|cvmx_desc_ptr
operator|->
name|mac_addr_base
index|[
literal|0
index|]
expr_stmt|;
name|octeon_mac_addr
index|[
literal|1
index|]
operator|=
name|cvmx_desc_ptr
operator|->
name|mac_addr_base
index|[
literal|1
index|]
expr_stmt|;
name|octeon_mac_addr
index|[
literal|2
index|]
operator|=
name|cvmx_desc_ptr
operator|->
name|mac_addr_base
index|[
literal|2
index|]
expr_stmt|;
name|octeon_mac_addr
index|[
literal|3
index|]
operator|=
name|cvmx_desc_ptr
operator|->
name|mac_addr_base
index|[
literal|3
index|]
expr_stmt|;
name|octeon_mac_addr
index|[
literal|4
index|]
operator|=
name|cvmx_desc_ptr
operator|->
name|mac_addr_base
index|[
literal|4
index|]
expr_stmt|;
name|octeon_mac_addr
index|[
literal|5
index|]
operator|=
name|cvmx_desc_ptr
operator|->
name|mac_addr_base
index|[
literal|5
index|]
expr_stmt|;
name|octeon_mac_addr_count
operator|=
name|cvmx_desc_ptr
operator|->
name|mac_addr_count
expr_stmt|;
if|if
condition|(
name|app_desc_ptr
operator|->
name|dram_size
operator|>
literal|16
operator|*
literal|1024
operator|*
literal|1024
condition|)
name|octeon_dram
operator|=
operator|(
name|uint64_t
operator|)
name|app_desc_ptr
operator|->
name|dram_size
expr_stmt|;
else|else
name|octeon_dram
operator|=
operator|(
name|uint64_t
operator|)
name|app_desc_ptr
operator|->
name|dram_size
operator|<<
literal|20
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|octeon_process_app_desc_ver_3_4_5
parameter_list|(
name|void
parameter_list|)
block|{
name|octeon_cvmx_bd_ver
operator|=
name|octeon_bd_ver
expr_stmt|;
name|octeon_core_mask
operator|=
name|app_desc_ptr
operator|->
name|core_mask
expr_stmt|;
if|if
condition|(
name|app_desc_ptr
operator|->
name|desc_version
operator|>
literal|3
condition|)
name|octeon_cpu_clock
operator|=
name|app_desc_ptr
operator|->
name|eclock_hz
expr_stmt|;
else|else
name|octeon_cpu_clock
operator|=
name|OCTEON_CLOCK_DEFAULT
expr_stmt|;
if|if
condition|(
name|app_desc_ptr
operator|->
name|dram_size
operator|>
literal|16
operator|*
literal|1024
operator|*
literal|1024
condition|)
name|octeon_dram
operator|=
operator|(
name|uint64_t
operator|)
name|app_desc_ptr
operator|->
name|dram_size
expr_stmt|;
else|else
name|octeon_dram
operator|=
operator|(
name|uint64_t
operator|)
name|app_desc_ptr
operator|->
name|dram_size
operator|<<
literal|20
expr_stmt|;
if|if
condition|(
name|app_desc_ptr
operator|->
name|desc_version
operator|>
literal|4
condition|)
block|{
name|octeon_board_type
operator|=
name|app_desc_ptr
operator|->
name|board_type
expr_stmt|;
name|octeon_board_rev_major
operator|=
name|app_desc_ptr
operator|->
name|board_rev_major
expr_stmt|;
name|octeon_board_rev_minor
operator|=
name|app_desc_ptr
operator|->
name|board_rev_minor
expr_stmt|;
name|octeon_chip_type
operator|=
name|app_desc_ptr
operator|->
name|chip_type
expr_stmt|;
name|octeon_chip_rev_major
operator|=
name|app_desc_ptr
operator|->
name|chip_rev_major
expr_stmt|;
name|octeon_chip_rev_minor
operator|=
name|app_desc_ptr
operator|->
name|chip_rev_minor
expr_stmt|;
name|octeon_mac_addr
index|[
literal|0
index|]
operator|=
name|app_desc_ptr
operator|->
name|mac_addr_base
index|[
literal|0
index|]
expr_stmt|;
name|octeon_mac_addr
index|[
literal|1
index|]
operator|=
name|app_desc_ptr
operator|->
name|mac_addr_base
index|[
literal|1
index|]
expr_stmt|;
name|octeon_mac_addr
index|[
literal|2
index|]
operator|=
name|app_desc_ptr
operator|->
name|mac_addr_base
index|[
literal|2
index|]
expr_stmt|;
name|octeon_mac_addr
index|[
literal|3
index|]
operator|=
name|app_desc_ptr
operator|->
name|mac_addr_base
index|[
literal|3
index|]
expr_stmt|;
name|octeon_mac_addr
index|[
literal|4
index|]
operator|=
name|app_desc_ptr
operator|->
name|mac_addr_base
index|[
literal|4
index|]
expr_stmt|;
name|octeon_mac_addr
index|[
literal|5
index|]
operator|=
name|app_desc_ptr
operator|->
name|mac_addr_base
index|[
literal|5
index|]
expr_stmt|;
name|octeon_mac_addr_count
operator|=
name|app_desc_ptr
operator|->
name|mac_addr_count
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|octeon_boot_params_init
parameter_list|(
name|register_t
name|ptr
parameter_list|)
block|{
name|int
name|bad_desc
init|=
literal|1
decl_stmt|;
if|if
condition|(
name|ptr
operator|!=
literal|0
operator|&&
name|ptr
operator|<
name|MAX_APP_DESC_ADDR
condition|)
block|{
name|app_desc_ptr
operator|=
operator|(
name|octeon_boot_descriptor_t
operator|*
operator|)
operator|(
name|intptr_t
operator|)
name|ptr
expr_stmt|;
name|octeon_bd_ver
operator|=
name|app_desc_ptr
operator|->
name|desc_version
expr_stmt|;
if|if
condition|(
operator|(
name|octeon_bd_ver
operator|>=
literal|3
operator|)
operator|&&
operator|(
name|octeon_bd_ver
operator|<=
literal|5
operator|)
condition|)
name|bad_desc
operator|=
name|octeon_process_app_desc_ver_3_4_5
argument_list|()
expr_stmt|;
elseif|else
if|if
condition|(
name|app_desc_ptr
operator|->
name|desc_version
operator|==
literal|6
condition|)
name|bad_desc
operator|=
name|octeon_process_app_desc_ver_6
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|bad_desc
condition|)
name|octeon_process_app_desc_ver_unknown
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"Boot Descriptor Ver: %u -> %u/%u"
argument_list|,
name|octeon_bd_ver
argument_list|,
name|octeon_cvmx_bd_ver
operator|/
literal|100
argument_list|,
name|octeon_cvmx_bd_ver
operator|%
literal|100
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  CPU clock: %uMHz\n"
argument_list|,
name|octeon_cpu_clock
operator|/
literal|1000000
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  Dram: %u MB"
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|octeon_dram
operator|>>
literal|20
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  Board Type: %u  Revision: %u/%u\n"
argument_list|,
name|octeon_board_type
argument_list|,
name|octeon_board_rev_major
argument_list|,
name|octeon_board_rev_minor
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  Octeon Chip: %u  Rev %u/%u"
argument_list|,
name|octeon_chip_type
argument_list|,
name|octeon_chip_rev_major
argument_list|,
name|octeon_chip_rev_minor
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  Mac Address %02X.%02X.%02X.%02X.%02X.%02X\n"
argument_list|,
name|octeon_mac_addr
index|[
literal|0
index|]
argument_list|,
name|octeon_mac_addr
index|[
literal|1
index|]
argument_list|,
name|octeon_mac_addr
index|[
literal|2
index|]
argument_list|,
name|octeon_mac_addr
index|[
literal|3
index|]
argument_list|,
name|octeon_mac_addr
index|[
literal|4
index|]
argument_list|,
name|octeon_mac_addr
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright 2003-2011 Netlogic Microsystems (Netlogic). All rights  * reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions are  * met:  *  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in  *    the documentation and/or other materials provided with the  *    distribution.  *  * THIS SOFTWARE IS PROVIDED BY Netlogic Microsystems ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR  * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL NETLOGIC OR CONTRIBUTORS BE  * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF  * THE POSSIBILITY OF SUCH DAMAGE.  *  * NETLOGIC_BSD */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<net/ethernet.h>
end_include

begin_include
include|#
directive|include
file|<mips/nlm/hal/mips-extns.h>
end_include

begin_include
include|#
directive|include
file|<mips/nlm/hal/haldefs.h>
end_include

begin_include
include|#
directive|include
file|<mips/nlm/hal/iomap.h>
end_include

begin_include
include|#
directive|include
file|<mips/nlm/hal/fmn.h>
end_include

begin_include
include|#
directive|include
file|<mips/nlm/hal/pic.h>
end_include

begin_include
include|#
directive|include
file|<mips/nlm/hal/sys.h>
end_include

begin_include
include|#
directive|include
file|<mips/nlm/hal/nae.h>
end_include

begin_include
include|#
directive|include
file|<mips/nlm/hal/uart.h>
end_include

begin_include
include|#
directive|include
file|<mips/nlm/hal/poe.h>
end_include

begin_include
include|#
directive|include
file|<mips/nlm/xlp.h>
end_include

begin_include
include|#
directive|include
file|<mips/nlm/board.h>
end_include

begin_include
include|#
directive|include
file|<mips/nlm/msgring.h>
end_include

begin_decl_stmt
specifier|static
name|uint8_t
name|board_eeprom_buf
index|[
name|EEPROM_SIZE
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|board_eeprom_set
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|xlp_board_info
name|xlp_board_info
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|vfbid_tbl
block|{
name|int
name|vfbid
decl_stmt|;
name|int
name|dest_vc
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* XXXJC : this should be derived from msg thread mask */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|vfbid_tbl
name|nlm_vfbid
index|[]
init|=
block|{
comment|/* NULL FBID should map to cpu0 to detect NAE send msg errors */
block|{
literal|127
block|,
literal|0
block|}
block|,
comment|/* NAE<-> NAE mappings */
block|{
literal|51
block|,
literal|1019
block|}
block|,
block|{
literal|50
block|,
literal|1018
block|}
block|,
block|{
literal|49
block|,
literal|1017
block|}
block|,
block|{
literal|48
block|,
literal|1016
block|}
block|,
block|{
literal|47
block|,
literal|1015
block|}
block|,
block|{
literal|46
block|,
literal|1014
block|}
block|,
block|{
literal|45
block|,
literal|1013
block|}
block|,
block|{
literal|44
block|,
literal|1012
block|}
block|,
block|{
literal|43
block|,
literal|1011
block|}
block|,
block|{
literal|42
block|,
literal|1010
block|}
block|,
block|{
literal|41
block|,
literal|1009
block|}
block|,
block|{
literal|40
block|,
literal|1008
block|}
block|,
block|{
literal|39
block|,
literal|1007
block|}
block|,
block|{
literal|38
block|,
literal|1006
block|}
block|,
block|{
literal|37
block|,
literal|1005
block|}
block|,
block|{
literal|36
block|,
literal|1004
block|}
block|,
block|{
literal|35
block|,
literal|1003
block|}
block|,
block|{
literal|34
block|,
literal|1002
block|}
block|,
block|{
literal|33
block|,
literal|1001
block|}
block|,
block|{
literal|32
block|,
literal|1000
block|}
block|,
comment|/* NAE<-> CPU mappings, freeback got to vc 3 of each thread */
block|{
literal|31
block|,
literal|127
block|}
block|,
block|{
literal|30
block|,
literal|123
block|}
block|,
block|{
literal|29
block|,
literal|119
block|}
block|,
block|{
literal|28
block|,
literal|115
block|}
block|,
block|{
literal|27
block|,
literal|111
block|}
block|,
block|{
literal|26
block|,
literal|107
block|}
block|,
block|{
literal|25
block|,
literal|103
block|}
block|,
block|{
literal|24
block|,
literal|99
block|}
block|,
block|{
literal|23
block|,
literal|95
block|}
block|,
block|{
literal|22
block|,
literal|91
block|}
block|,
block|{
literal|21
block|,
literal|87
block|}
block|,
block|{
literal|20
block|,
literal|83
block|}
block|,
block|{
literal|19
block|,
literal|79
block|}
block|,
block|{
literal|18
block|,
literal|75
block|}
block|,
block|{
literal|17
block|,
literal|71
block|}
block|,
block|{
literal|16
block|,
literal|67
block|}
block|,
block|{
literal|15
block|,
literal|63
block|}
block|,
block|{
literal|14
block|,
literal|59
block|}
block|,
block|{
literal|13
block|,
literal|55
block|}
block|,
block|{
literal|12
block|,
literal|51
block|}
block|,
block|{
literal|11
block|,
literal|47
block|}
block|,
block|{
literal|10
block|,
literal|43
block|}
block|,
block|{
literal|9
block|,
literal|39
block|}
block|,
block|{
literal|8
block|,
literal|35
block|}
block|,
block|{
literal|7
block|,
literal|31
block|}
block|,
block|{
literal|6
block|,
literal|27
block|}
block|,
block|{
literal|5
block|,
literal|23
block|}
block|,
block|{
literal|4
block|,
literal|19
block|}
block|,
block|{
literal|3
block|,
literal|15
block|}
block|,
block|{
literal|2
block|,
literal|11
block|}
block|,
block|{
literal|1
block|,
literal|7
block|}
block|,
block|{
literal|0
block|,
literal|3
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|vfbid_tbl
name|nlm3xx_vfbid
index|[]
init|=
block|{
comment|/* NULL FBID should map to cpu0 to detect NAE send msg errors */
block|{
literal|127
block|,
literal|0
block|}
block|,
comment|/* NAE<-> NAE mappings */
block|{
literal|39
block|,
literal|503
block|}
block|,
block|{
literal|38
block|,
literal|502
block|}
block|,
block|{
literal|37
block|,
literal|501
block|}
block|,
block|{
literal|36
block|,
literal|500
block|}
block|,
block|{
literal|35
block|,
literal|499
block|}
block|,
block|{
literal|34
block|,
literal|498
block|}
block|,
block|{
literal|33
block|,
literal|497
block|}
block|,
block|{
literal|32
block|,
literal|496
block|}
block|,
comment|/* NAE<-> CPU mappings, freeback got to vc 3 of each thread */
block|{
literal|31
block|,
literal|127
block|}
block|,
block|{
literal|30
block|,
literal|123
block|}
block|,
block|{
literal|29
block|,
literal|119
block|}
block|,
block|{
literal|28
block|,
literal|115
block|}
block|,
block|{
literal|27
block|,
literal|111
block|}
block|,
block|{
literal|26
block|,
literal|107
block|}
block|,
block|{
literal|25
block|,
literal|103
block|}
block|,
block|{
literal|24
block|,
literal|99
block|}
block|,
block|{
literal|23
block|,
literal|95
block|}
block|,
block|{
literal|22
block|,
literal|91
block|}
block|,
block|{
literal|21
block|,
literal|87
block|}
block|,
block|{
literal|20
block|,
literal|83
block|}
block|,
block|{
literal|19
block|,
literal|79
block|}
block|,
block|{
literal|18
block|,
literal|75
block|}
block|,
block|{
literal|17
block|,
literal|71
block|}
block|,
block|{
literal|16
block|,
literal|67
block|}
block|,
block|{
literal|15
block|,
literal|63
block|}
block|,
block|{
literal|14
block|,
literal|59
block|}
block|,
block|{
literal|13
block|,
literal|55
block|}
block|,
block|{
literal|12
block|,
literal|51
block|}
block|,
block|{
literal|11
block|,
literal|47
block|}
block|,
block|{
literal|10
block|,
literal|43
block|}
block|,
block|{
literal|9
block|,
literal|39
block|}
block|,
block|{
literal|8
block|,
literal|35
block|}
block|,
block|{
literal|7
block|,
literal|31
block|}
block|,
block|{
literal|6
block|,
literal|27
block|}
block|,
block|{
literal|5
block|,
literal|23
block|}
block|,
block|{
literal|4
block|,
literal|19
block|}
block|,
block|{
literal|3
block|,
literal|15
block|}
block|,
block|{
literal|2
block|,
literal|11
block|}
block|,
block|{
literal|1
block|,
literal|7
block|}
block|,
block|{
literal|0
block|,
literal|3
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|nlm_get_vfbid_mapping
parameter_list|(
name|int
name|vfbid
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|nentries
decl_stmt|;
name|struct
name|vfbid_tbl
modifier|*
name|p
decl_stmt|;
if|if
condition|(
name|nlm_is_xlp3xx
argument_list|()
condition|)
block|{
name|nentries
operator|=
sizeof|sizeof
argument_list|(
name|nlm3xx_vfbid
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|vfbid_tbl
argument_list|)
expr_stmt|;
name|p
operator|=
name|nlm3xx_vfbid
expr_stmt|;
block|}
else|else
block|{
name|nentries
operator|=
sizeof|sizeof
argument_list|(
name|nlm_vfbid
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|vfbid_tbl
argument_list|)
expr_stmt|;
name|p
operator|=
name|nlm_vfbid
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nentries
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|p
index|[
name|i
index|]
operator|.
name|vfbid
operator|==
name|vfbid
condition|)
return|return
operator|(
name|p
index|[
name|i
index|]
operator|.
name|dest_vc
operator|)
return|;
block|}
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_function

begin_function
name|int
name|nlm_get_poe_distvec
parameter_list|(
name|int
name|vec
parameter_list|,
name|uint32_t
modifier|*
name|distvec
parameter_list|)
block|{
if|if
condition|(
name|vec
operator|!=
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
comment|/* we support just vec 0 */
name|nlm_calc_poe_distvec
argument_list|(
name|xlp_msg_thread_mask
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0x1
operator|<<
name|XLPGE_RX_VC
argument_list|,
name|distvec
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * All our knowledge of chip and board that cannot be detected by probing  * at run-time goes here  */
end_comment

begin_function
name|void
name|xlpge_get_macaddr
parameter_list|(
name|uint8_t
modifier|*
name|macaddr
parameter_list|)
block|{
if|if
condition|(
name|board_eeprom_set
operator|==
literal|0
condition|)
block|{
comment|/* No luck, take some reasonable value */
name|macaddr
index|[
literal|0
index|]
operator|=
literal|0x00
expr_stmt|;
name|macaddr
index|[
literal|1
index|]
operator|=
literal|0x0f
expr_stmt|;
name|macaddr
index|[
literal|2
index|]
operator|=
literal|0x30
expr_stmt|;
name|macaddr
index|[
literal|3
index|]
operator|=
literal|0x20
expr_stmt|;
name|macaddr
index|[
literal|4
index|]
operator|=
literal|0x0d
expr_stmt|;
name|macaddr
index|[
literal|5
index|]
operator|=
literal|0x5b
expr_stmt|;
block|}
else|else
name|memcpy
argument_list|(
name|macaddr
argument_list|,
operator|&
name|board_eeprom_buf
index|[
name|EEPROM_MACADDR_OFFSET
index|]
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|nlm_setup_port_defaults
parameter_list|(
name|struct
name|xlp_port_ivars
modifier|*
name|p
parameter_list|)
block|{
name|p
operator|->
name|loopback_mode
operator|=
literal|0
expr_stmt|;
name|p
operator|->
name|num_channels
operator|=
literal|1
expr_stmt|;
name|p
operator|->
name|free_desc_sizes
operator|=
literal|2048
expr_stmt|;
name|p
operator|->
name|vlan_pri_en
operator|=
literal|0
expr_stmt|;
name|p
operator|->
name|hw_parser_en
operator|=
literal|1
expr_stmt|;
name|p
operator|->
name|ieee1588_userval
operator|=
literal|0
expr_stmt|;
name|p
operator|->
name|ieee1588_ptpoff
operator|=
literal|0
expr_stmt|;
name|p
operator|->
name|ieee1588_tmr1
operator|=
literal|0
expr_stmt|;
name|p
operator|->
name|ieee1588_tmr2
operator|=
literal|0
expr_stmt|;
name|p
operator|->
name|ieee1588_tmr3
operator|=
literal|0
expr_stmt|;
name|p
operator|->
name|ieee1588_inc_intg
operator|=
literal|0
expr_stmt|;
name|p
operator|->
name|ieee1588_inc_den
operator|=
literal|1
expr_stmt|;
name|p
operator|->
name|ieee1588_inc_num
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|nlm_is_xlp3xx
argument_list|()
condition|)
block|{
name|p
operator|->
name|stg2_fifo_size
operator|=
name|XLP3XX_STG2_FIFO_SZ
expr_stmt|;
name|p
operator|->
name|eh_fifo_size
operator|=
name|XLP3XX_EH_FIFO_SZ
expr_stmt|;
name|p
operator|->
name|frout_fifo_size
operator|=
name|XLP3XX_FROUT_FIFO_SZ
expr_stmt|;
name|p
operator|->
name|ms_fifo_size
operator|=
name|XLP3XX_MS_FIFO_SZ
expr_stmt|;
name|p
operator|->
name|pkt_fifo_size
operator|=
name|XLP3XX_PKT_FIFO_SZ
expr_stmt|;
name|p
operator|->
name|pktlen_fifo_size
operator|=
name|XLP3XX_PKTLEN_FIFO_SZ
expr_stmt|;
name|p
operator|->
name|max_stg2_offset
operator|=
name|XLP3XX_MAX_STG2_OFFSET
expr_stmt|;
name|p
operator|->
name|max_eh_offset
operator|=
name|XLP3XX_MAX_EH_OFFSET
expr_stmt|;
name|p
operator|->
name|max_frout_offset
operator|=
name|XLP3XX_MAX_FREE_OUT_OFFSET
expr_stmt|;
name|p
operator|->
name|max_ms_offset
operator|=
name|XLP3XX_MAX_MS_OFFSET
expr_stmt|;
name|p
operator|->
name|max_pmem_offset
operator|=
name|XLP3XX_MAX_PMEM_OFFSET
expr_stmt|;
name|p
operator|->
name|stg1_2_credit
operator|=
name|XLP3XX_STG1_2_CREDIT
expr_stmt|;
name|p
operator|->
name|stg2_eh_credit
operator|=
name|XLP3XX_STG2_EH_CREDIT
expr_stmt|;
name|p
operator|->
name|stg2_frout_credit
operator|=
name|XLP3XX_STG2_FROUT_CREDIT
expr_stmt|;
name|p
operator|->
name|stg2_ms_credit
operator|=
name|XLP3XX_STG2_MS_CREDIT
expr_stmt|;
block|}
else|else
block|{
name|p
operator|->
name|stg2_fifo_size
operator|=
name|XLP8XX_STG2_FIFO_SZ
expr_stmt|;
name|p
operator|->
name|eh_fifo_size
operator|=
name|XLP8XX_EH_FIFO_SZ
expr_stmt|;
name|p
operator|->
name|frout_fifo_size
operator|=
name|XLP8XX_FROUT_FIFO_SZ
expr_stmt|;
name|p
operator|->
name|ms_fifo_size
operator|=
name|XLP8XX_MS_FIFO_SZ
expr_stmt|;
name|p
operator|->
name|pkt_fifo_size
operator|=
name|XLP8XX_PKT_FIFO_SZ
expr_stmt|;
name|p
operator|->
name|pktlen_fifo_size
operator|=
name|XLP8XX_PKTLEN_FIFO_SZ
expr_stmt|;
name|p
operator|->
name|max_stg2_offset
operator|=
name|XLP8XX_MAX_STG2_OFFSET
expr_stmt|;
name|p
operator|->
name|max_eh_offset
operator|=
name|XLP8XX_MAX_EH_OFFSET
expr_stmt|;
name|p
operator|->
name|max_frout_offset
operator|=
name|XLP8XX_MAX_FREE_OUT_OFFSET
expr_stmt|;
name|p
operator|->
name|max_ms_offset
operator|=
name|XLP8XX_MAX_MS_OFFSET
expr_stmt|;
name|p
operator|->
name|max_pmem_offset
operator|=
name|XLP8XX_MAX_PMEM_OFFSET
expr_stmt|;
name|p
operator|->
name|stg1_2_credit
operator|=
name|XLP8XX_STG1_2_CREDIT
expr_stmt|;
name|p
operator|->
name|stg2_eh_credit
operator|=
name|XLP8XX_STG2_EH_CREDIT
expr_stmt|;
name|p
operator|->
name|stg2_frout_credit
operator|=
name|XLP8XX_STG2_FROUT_CREDIT
expr_stmt|;
name|p
operator|->
name|stg2_ms_credit
operator|=
name|XLP8XX_STG2_MS_CREDIT
expr_stmt|;
block|}
switch|switch
condition|(
name|p
operator|->
name|type
condition|)
block|{
case|case
name|SGMIIC
case|:
name|p
operator|->
name|num_free_descs
operator|=
literal|52
expr_stmt|;
name|p
operator|->
name|iface_fifo_size
operator|=
literal|13
expr_stmt|;
name|p
operator|->
name|rxbuf_size
operator|=
literal|128
expr_stmt|;
name|p
operator|->
name|rx_slots_reqd
operator|=
name|SGMII_CAL_SLOTS
expr_stmt|;
name|p
operator|->
name|tx_slots_reqd
operator|=
name|SGMII_CAL_SLOTS
expr_stmt|;
if|if
condition|(
name|nlm_is_xlp3xx
argument_list|()
condition|)
name|p
operator|->
name|pseq_fifo_size
operator|=
literal|30
expr_stmt|;
else|else
name|p
operator|->
name|pseq_fifo_size
operator|=
literal|62
expr_stmt|;
break|break;
case|case
name|ILC
case|:
name|p
operator|->
name|num_free_descs
operator|=
literal|150
expr_stmt|;
name|p
operator|->
name|rxbuf_size
operator|=
literal|944
expr_stmt|;
name|p
operator|->
name|rx_slots_reqd
operator|=
name|IL8_CAL_SLOTS
expr_stmt|;
name|p
operator|->
name|tx_slots_reqd
operator|=
name|IL8_CAL_SLOTS
expr_stmt|;
name|p
operator|->
name|pseq_fifo_size
operator|=
literal|225
expr_stmt|;
name|p
operator|->
name|iface_fifo_size
operator|=
literal|55
expr_stmt|;
break|break;
case|case
name|XAUIC
case|:
default|default:
name|p
operator|->
name|num_free_descs
operator|=
literal|150
expr_stmt|;
name|p
operator|->
name|rxbuf_size
operator|=
literal|944
expr_stmt|;
name|p
operator|->
name|rx_slots_reqd
operator|=
name|XAUI_CAL_SLOTS
expr_stmt|;
name|p
operator|->
name|tx_slots_reqd
operator|=
name|XAUI_CAL_SLOTS
expr_stmt|;
if|if
condition|(
name|nlm_is_xlp3xx
argument_list|()
condition|)
block|{
name|p
operator|->
name|pseq_fifo_size
operator|=
literal|120
expr_stmt|;
name|p
operator|->
name|iface_fifo_size
operator|=
literal|52
expr_stmt|;
block|}
else|else
block|{
name|p
operator|->
name|pseq_fifo_size
operator|=
literal|225
expr_stmt|;
name|p
operator|->
name|iface_fifo_size
operator|=
literal|55
expr_stmt|;
block|}
break|break;
block|}
block|}
end_function

begin_comment
comment|/* XLP 8XX evaluation boards have the following phy-addr  * assignment. There are two external mdio buses in XLP --  * bus 0 and bus 1. The management ports (16 and 17) are  * on mdio bus 0 while blocks/complexes[0 to 3] are all   * on mdio bus 1. The phy_addr on bus 0 (mgmt ports 16  * and 17) match the port numbers.  * These are the details:  * block  port   phy_addr   mdio_bus  * ====================================  * 0         0     4          1  * 0         1     7          1  * 0         2     6          1  * 0         3     5          1  * 1         0     8          1  * 1         1     11         1  * 1         2     10         1  * 1         3     9          1  * 2         0     0          1  * 2         1     3          1  * 2         2     2          1  * 2         3     1          1  * 3         0     12         1  * 3         1     15         1  * 3         2     14         1  * 3         3     13         1  *  * 4         0     16         0   * 4         1     17         0  *  * The XLP 3XX evaluation boards have the following phy-addr  * assignments.  * block  port   phy_addr   mdio_bus  * ====================================  * 0         0     4          0  * 0         1     7          0  * 0         2     6          0  * 0         3     5          0  * 1         0     8          0  * 1         1     11         0  * 1         2     10         0  * 1         3     9          0  */
end_comment

begin_function
specifier|static
name|void
name|nlm_board_get_phyaddr
parameter_list|(
name|int
name|block
parameter_list|,
name|int
name|port
parameter_list|,
name|int
modifier|*
name|phyaddr
parameter_list|)
block|{
switch|switch
condition|(
name|block
condition|)
block|{
case|case
literal|0
case|:
switch|switch
condition|(
name|port
condition|)
block|{
case|case
literal|0
case|:
operator|*
name|phyaddr
operator|=
literal|4
expr_stmt|;
break|break;
case|case
literal|1
case|:
operator|*
name|phyaddr
operator|=
literal|7
expr_stmt|;
break|break;
case|case
literal|2
case|:
operator|*
name|phyaddr
operator|=
literal|6
expr_stmt|;
break|break;
case|case
literal|3
case|:
operator|*
name|phyaddr
operator|=
literal|5
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|1
case|:
switch|switch
condition|(
name|port
condition|)
block|{
case|case
literal|0
case|:
operator|*
name|phyaddr
operator|=
literal|8
expr_stmt|;
break|break;
case|case
literal|1
case|:
operator|*
name|phyaddr
operator|=
literal|11
expr_stmt|;
break|break;
case|case
literal|2
case|:
operator|*
name|phyaddr
operator|=
literal|10
expr_stmt|;
break|break;
case|case
literal|3
case|:
operator|*
name|phyaddr
operator|=
literal|9
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|2
case|:
switch|switch
condition|(
name|port
condition|)
block|{
case|case
literal|0
case|:
operator|*
name|phyaddr
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|1
case|:
operator|*
name|phyaddr
operator|=
literal|3
expr_stmt|;
break|break;
case|case
literal|2
case|:
operator|*
name|phyaddr
operator|=
literal|2
expr_stmt|;
break|break;
case|case
literal|3
case|:
operator|*
name|phyaddr
operator|=
literal|1
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|3
case|:
switch|switch
condition|(
name|port
condition|)
block|{
case|case
literal|0
case|:
operator|*
name|phyaddr
operator|=
literal|12
expr_stmt|;
break|break;
case|case
literal|1
case|:
operator|*
name|phyaddr
operator|=
literal|15
expr_stmt|;
break|break;
case|case
literal|2
case|:
operator|*
name|phyaddr
operator|=
literal|14
expr_stmt|;
break|break;
case|case
literal|3
case|:
operator|*
name|phyaddr
operator|=
literal|13
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|4
case|:
switch|switch
condition|(
name|port
condition|)
block|{
comment|/* management SGMII */
case|case
literal|0
case|:
operator|*
name|phyaddr
operator|=
literal|16
expr_stmt|;
break|break;
case|case
literal|1
case|:
operator|*
name|phyaddr
operator|=
literal|17
expr_stmt|;
break|break;
block|}
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|nlm_print_processor_info
parameter_list|(
name|void
parameter_list|)
block|{
name|uint32_t
name|procid
decl_stmt|;
name|int
name|prid
decl_stmt|,
name|rev
decl_stmt|;
name|char
modifier|*
name|chip
decl_stmt|,
modifier|*
name|revstr
decl_stmt|;
name|procid
operator|=
name|mips_rd_prid
argument_list|()
expr_stmt|;
name|prid
operator|=
operator|(
name|procid
operator|>>
literal|8
operator|)
operator|&
literal|0xff
expr_stmt|;
name|rev
operator|=
name|procid
operator|&
literal|0xff
expr_stmt|;
switch|switch
condition|(
name|prid
condition|)
block|{
case|case
name|CHIP_PROCESSOR_ID_XLP_8XX
case|:
name|chip
operator|=
literal|"XLP 832"
expr_stmt|;
break|break;
case|case
name|CHIP_PROCESSOR_ID_XLP_3XX
case|:
name|chip
operator|=
literal|"XLP 3xx"
expr_stmt|;
break|break;
case|case
name|CHIP_PROCESSOR_ID_XLP_432
case|:
case|case
name|CHIP_PROCESSOR_ID_XLP_416
case|:
name|chip
operator|=
literal|"XLP 4xx"
expr_stmt|;
break|break;
default|default:
name|chip
operator|=
literal|"XLP ?xx"
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
name|rev
condition|)
block|{
case|case
literal|0
case|:
name|revstr
operator|=
literal|"A0"
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|revstr
operator|=
literal|"A1"
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|revstr
operator|=
literal|"A2"
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|revstr
operator|=
literal|"B0"
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|revstr
operator|=
literal|"B1"
expr_stmt|;
break|break;
default|default:
name|revstr
operator|=
literal|"??"
expr_stmt|;
break|break;
block|}
name|printf
argument_list|(
literal|"Processor info:\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  Netlogic %s %s [%x]\n"
argument_list|,
name|chip
argument_list|,
name|revstr
argument_list|,
name|procid
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * All our knowledge of chip and board that cannot be detected by probing   * at run-time goes here  */
end_comment

begin_function
specifier|static
name|int
name|nlm_setup_xlp_board
parameter_list|(
name|int
name|node
parameter_list|)
block|{
name|struct
name|xlp_board_info
modifier|*
name|boardp
decl_stmt|;
name|struct
name|xlp_node_info
modifier|*
name|nodep
decl_stmt|;
name|struct
name|xlp_nae_ivars
modifier|*
name|naep
decl_stmt|;
name|struct
name|xlp_block_ivars
modifier|*
name|blockp
decl_stmt|;
name|struct
name|xlp_port_ivars
modifier|*
name|portp
decl_stmt|;
name|uint64_t
name|cpldbase
decl_stmt|,
name|nae_pcibase
decl_stmt|;
name|int
name|block
decl_stmt|,
name|port
decl_stmt|,
name|rv
decl_stmt|,
name|dbtype
decl_stmt|,
name|usecpld
init|=
literal|0
decl_stmt|,
name|evp
init|=
literal|0
decl_stmt|,
name|svp
init|=
literal|0
decl_stmt|;
name|uint8_t
modifier|*
name|b
decl_stmt|;
comment|/* start with a clean slate */
name|boardp
operator|=
operator|&
name|xlp_board_info
expr_stmt|;
if|if
condition|(
name|boardp
operator|->
name|nodemask
operator|==
literal|0
condition|)
name|memset
argument_list|(
name|boardp
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|xlp_board_info
argument_list|)
argument_list|)
expr_stmt|;
name|boardp
operator|->
name|nodemask
operator||=
operator|(
literal|1
operator|<<
name|node
operator|)
expr_stmt|;
name|nlm_print_processor_info
argument_list|()
expr_stmt|;
name|b
operator|=
name|board_eeprom_buf
expr_stmt|;
name|rv
operator|=
name|nlm_board_eeprom_read
argument_list|(
name|node
argument_list|,
name|EEPROM_I2CBUS
argument_list|,
name|EEPROM_I2CADDR
argument_list|,
literal|0
argument_list|,
name|b
argument_list|,
name|EEPROM_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|==
literal|0
condition|)
block|{
name|board_eeprom_set
operator|=
literal|1
expr_stmt|;
name|printf
argument_list|(
literal|"Board info (EEPROM on i2c@%d at %#X):\n"
argument_list|,
name|EEPROM_I2CBUS
argument_list|,
name|EEPROM_I2CADDR
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  Model:      %7.7s %2.2s\n"
argument_list|,
operator|&
name|b
index|[
literal|16
index|]
argument_list|,
operator|&
name|b
index|[
literal|24
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  Serial #:   %3.3s-%2.2s\n"
argument_list|,
operator|&
name|b
index|[
literal|27
index|]
argument_list|,
operator|&
name|b
index|[
literal|31
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  MAC addr:   %02x:%02x:%02x:%02x:%02x:%02x\n"
argument_list|,
name|b
index|[
literal|2
index|]
argument_list|,
name|b
index|[
literal|3
index|]
argument_list|,
name|b
index|[
literal|4
index|]
argument_list|,
name|b
index|[
literal|5
index|]
argument_list|,
name|b
index|[
literal|6
index|]
argument_list|,
name|b
index|[
literal|7
index|]
argument_list|)
expr_stmt|;
block|}
else|else
name|printf
argument_list|(
literal|"Board Info: Error on EEPROM read (i2c@%d %#X).\n"
argument_list|,
name|EEPROM_I2CBUS
argument_list|,
name|EEPROM_I2CADDR
argument_list|)
expr_stmt|;
name|nae_pcibase
operator|=
name|nlm_get_nae_pcibase
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|nodep
operator|=
operator|&
name|boardp
operator|->
name|nodes
index|[
name|node
index|]
expr_stmt|;
name|naep
operator|=
operator|&
name|nodep
operator|->
name|nae_ivars
expr_stmt|;
name|naep
operator|->
name|node
operator|=
name|node
expr_stmt|;
comment|/* frequency at which network block runs */
name|naep
operator|->
name|freq
operator|=
literal|500
expr_stmt|;
comment|/* CRC16 polynomial used for flow table generation */
name|naep
operator|->
name|flow_crc_poly
operator|=
literal|0xffff
expr_stmt|;
name|naep
operator|->
name|hw_parser_en
operator|=
literal|1
expr_stmt|;
name|naep
operator|->
name|prepad_en
operator|=
literal|1
expr_stmt|;
name|naep
operator|->
name|prepad_size
operator|=
literal|3
expr_stmt|;
comment|/* size in 16 byte units */
name|naep
operator|->
name|ieee_1588_en
operator|=
literal|1
expr_stmt|;
name|naep
operator|->
name|ilmask
operator|=
literal|0x0
expr_stmt|;
comment|/* set this based on daughter card */
name|naep
operator|->
name|xauimask
operator|=
literal|0x0
expr_stmt|;
comment|/* set this based on daughter card */
name|naep
operator|->
name|sgmiimask
operator|=
literal|0x0
expr_stmt|;
comment|/* set this based on daughter card */
name|naep
operator|->
name|nblocks
operator|=
name|nae_num_complex
argument_list|(
name|nae_pcibase
argument_list|)
expr_stmt|;
if|if
condition|(
name|strncmp
argument_list|(
operator|&
name|b
index|[
literal|16
index|]
argument_list|,
literal|"PCIE"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
name|usecpld
operator|=
literal|0
expr_stmt|;
comment|/* XLP PCIe card */
comment|/* Broadcom's XLP PCIe card has the following 		 * blocks fixed. 		 * blk 0-XAUI, 1-XAUI, 4-SGMII(one port) */
name|naep
operator|->
name|blockmask
operator|=
literal|0x13
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
operator|&
name|b
index|[
literal|16
index|]
argument_list|,
literal|"MB-EVP"
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
condition|)
block|{
name|usecpld
operator|=
literal|1
expr_stmt|;
comment|/* XLP non-PCIe card which has CPLD */
name|evp
operator|=
literal|1
expr_stmt|;
name|naep
operator|->
name|blockmask
operator|=
operator|(
literal|1
operator|<<
name|naep
operator|->
name|nblocks
operator|)
operator|-
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|strncmp
argument_list|(
operator|&
name|b
index|[
literal|16
index|]
argument_list|,
literal|"MB-S"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
operator|)
operator|||
operator|(
name|strncmp
argument_list|(
operator|&
name|b
index|[
literal|16
index|]
argument_list|,
literal|"MB_S"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
operator|)
condition|)
block|{
name|usecpld
operator|=
literal|1
expr_stmt|;
comment|/* XLP non-PCIe card which has CPLD */
name|svp
operator|=
literal|1
expr_stmt|;
comment|/* 3xx chip reports one block extra which is a bug */
name|naep
operator|->
name|nblocks
operator|=
name|naep
operator|->
name|nblocks
operator|-
literal|1
expr_stmt|;
name|naep
operator|->
name|blockmask
operator|=
operator|(
literal|1
operator|<<
name|naep
operator|->
name|nblocks
operator|)
operator|-
literal|1
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"ERROR!!! Board type:%7s didn't match any board"
literal|" type we support\n"
argument_list|,
operator|&
name|b
index|[
literal|16
index|]
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|cpldbase
operator|=
name|nlm_board_cpld_base
argument_list|(
name|node
argument_list|,
name|XLP_EVB_CPLD_CHIPSELECT
argument_list|)
expr_stmt|;
comment|/* pretty print network config */
name|printf
argument_list|(
literal|"Network config"
argument_list|)
expr_stmt|;
if|if
condition|(
name|usecpld
condition|)
name|printf
argument_list|(
literal|"(from CPLD@%d):\n"
argument_list|,
name|XLP_EVB_CPLD_CHIPSELECT
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"(defaults):\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  NAE@%d Blocks: "
argument_list|,
name|node
argument_list|)
expr_stmt|;
for|for
control|(
name|block
operator|=
literal|0
init|;
name|block
operator|<
name|naep
operator|->
name|nblocks
condition|;
name|block
operator|++
control|)
block|{
name|char
modifier|*
name|s
init|=
literal|"???"
decl_stmt|;
if|if
condition|(
operator|(
name|naep
operator|->
name|blockmask
operator|&
operator|(
literal|1
operator|<<
name|block
operator|)
operator|)
operator|==
literal|0
condition|)
continue|continue;
name|blockp
operator|=
operator|&
name|naep
operator|->
name|block_ivars
index|[
name|block
index|]
expr_stmt|;
name|blockp
operator|->
name|block
operator|=
name|block
expr_stmt|;
if|if
condition|(
name|usecpld
condition|)
name|dbtype
operator|=
name|nlm_board_cpld_dboard_type
argument_list|(
name|cpldbase
argument_list|,
name|block
argument_list|)
expr_stmt|;
else|else
name|dbtype
operator|=
name|DCARD_XAUI
expr_stmt|;
comment|/* default XAUI */
comment|/* XLP PCIe cards */
if|if
condition|(
operator|(
operator|!
name|evp
operator|&&
operator|!
name|svp
operator|)
operator|&&
operator|(
operator|(
name|block
operator|==
literal|2
operator|)
operator|||
operator|(
name|block
operator|==
literal|3
operator|)
operator|)
condition|)
name|dbtype
operator|=
name|DCARD_NOT_PRSNT
expr_stmt|;
if|if
condition|(
name|block
operator|==
literal|4
condition|)
block|{
comment|/* management block 4 on 8xx or XLP PCIe */
name|blockp
operator|->
name|type
operator|=
name|SGMIIC
expr_stmt|;
if|if
condition|(
name|evp
condition|)
name|blockp
operator|->
name|portmask
operator|=
literal|0x3
expr_stmt|;
else|else
name|blockp
operator|->
name|portmask
operator|=
literal|0x1
expr_stmt|;
name|naep
operator|->
name|sgmiimask
operator||=
operator|(
literal|1
operator|<<
name|block
operator|)
expr_stmt|;
block|}
else|else
block|{
switch|switch
condition|(
name|dbtype
condition|)
block|{
case|case
name|DCARD_ILAKEN
case|:
name|blockp
operator|->
name|type
operator|=
name|ILC
expr_stmt|;
name|blockp
operator|->
name|portmask
operator|=
literal|0x1
expr_stmt|;
name|naep
operator|->
name|ilmask
operator||=
operator|(
literal|1
operator|<<
name|block
operator|)
expr_stmt|;
break|break;
case|case
name|DCARD_SGMII
case|:
name|blockp
operator|->
name|type
operator|=
name|SGMIIC
expr_stmt|;
name|blockp
operator|->
name|portmask
operator|=
literal|0xf
expr_stmt|;
name|naep
operator|->
name|sgmiimask
operator||=
operator|(
literal|1
operator|<<
name|block
operator|)
expr_stmt|;
break|break;
case|case
name|DCARD_XAUI
case|:
name|blockp
operator|->
name|type
operator|=
name|XAUIC
expr_stmt|;
name|blockp
operator|->
name|portmask
operator|=
literal|0x1
expr_stmt|;
name|naep
operator|->
name|xauimask
operator||=
operator|(
literal|1
operator|<<
name|block
operator|)
expr_stmt|;
break|break;
default|default:
comment|/* DCARD_NOT_PRSNT */
name|blockp
operator|->
name|type
operator|=
name|UNKNOWN
expr_stmt|;
name|blockp
operator|->
name|portmask
operator|=
literal|0
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|blockp
operator|->
name|type
operator|!=
name|UNKNOWN
condition|)
block|{
for|for
control|(
name|port
operator|=
literal|0
init|;
name|port
operator|<
name|PORTS_PER_CMPLX
condition|;
name|port
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|blockp
operator|->
name|portmask
operator|&
operator|(
literal|1
operator|<<
name|port
operator|)
operator|)
operator|==
literal|0
condition|)
continue|continue;
name|portp
operator|=
operator|&
name|blockp
operator|->
name|port_ivars
index|[
name|port
index|]
expr_stmt|;
name|nlm_board_get_phyaddr
argument_list|(
name|block
argument_list|,
name|port
argument_list|,
operator|&
name|portp
operator|->
name|phy_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|svp
operator|||
operator|(
name|block
operator|==
literal|4
operator|)
condition|)
name|portp
operator|->
name|mdio_bus
operator|=
literal|0
expr_stmt|;
else|else
name|portp
operator|->
name|mdio_bus
operator|=
literal|1
expr_stmt|;
name|portp
operator|->
name|port
operator|=
name|port
expr_stmt|;
name|portp
operator|->
name|block
operator|=
name|block
expr_stmt|;
name|portp
operator|->
name|node
operator|=
name|node
expr_stmt|;
name|portp
operator|->
name|type
operator|=
name|blockp
operator|->
name|type
expr_stmt|;
name|nlm_setup_port_defaults
argument_list|(
name|portp
argument_list|)
expr_stmt|;
block|}
block|}
switch|switch
condition|(
name|blockp
operator|->
name|type
condition|)
block|{
case|case
name|SGMIIC
case|:
name|s
operator|=
literal|"SGMII"
expr_stmt|;
break|break;
case|case
name|XAUIC
case|:
name|s
operator|=
literal|"XAUI"
expr_stmt|;
break|break;
case|case
name|ILC
case|:
name|s
operator|=
literal|"IL"
expr_stmt|;
break|break;
block|}
name|printf
argument_list|(
literal|" [%d %s]"
argument_list|,
name|block
argument_list|,
name|s
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|nlm_board_info_setup
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
name|nlm_setup_xlp_board
argument_list|(
literal|0
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


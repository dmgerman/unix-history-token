begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2003-2012 Broadcom Corporation  * All Rights Reserved  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in  *    the documentation and/or other materials provided with the  *    distribution.  *  * THIS SOFTWARE IS PROVIDED BY BROADCOM ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED  * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED. IN NO EVENT SHALL BROADCOM OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR  * BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,  * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE  * OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN  * IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/limits.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_define
define|#
directive|define
name|__RMAN_RESOURCE_VISIBLE
end_define

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<sys/taskqueue.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_var.h>
end_include

begin_include
include|#
directive|include
file|<net/if_arp.h>
end_include

begin_include
include|#
directive|include
file|<net/ethernet.h>
end_include

begin_include
include|#
directive|include
file|<net/if_dl.h>
end_include

begin_include
include|#
directive|include
file|<net/if_media.h>
end_include

begin_include
include|#
directive|include
file|<net/bpf.h>
end_include

begin_include
include|#
directive|include
file|<net/if_types.h>
end_include

begin_include
include|#
directive|include
file|<net/if_vlan_var.h>
end_include

begin_include
include|#
directive|include
file|<dev/pci/pcivar.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_systm.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm.h>
end_include

begin_include
include|#
directive|include
file|<vm/pmap.h>
end_include

begin_include
include|#
directive|include
file|<vm/uma.h>
end_include

begin_include
include|#
directive|include
file|<machine/reg.h>
end_include

begin_include
include|#
directive|include
file|<machine/cpu.h>
end_include

begin_include
include|#
directive|include
file|<machine/mips_opcode.h>
end_include

begin_include
include|#
directive|include
file|<machine/asm.h>
end_include

begin_include
include|#
directive|include
file|<machine/cpuregs.h>
end_include

begin_include
include|#
directive|include
file|<machine/param.h>
end_include

begin_include
include|#
directive|include
file|<machine/intr_machdep.h>
end_include

begin_include
include|#
directive|include
file|<machine/clock.h>
end_include

begin_comment
comment|/* for DELAY */
end_comment

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<mips/nlm/hal/haldefs.h>
end_include

begin_include
include|#
directive|include
file|<mips/nlm/hal/iomap.h>
end_include

begin_include
include|#
directive|include
file|<mips/nlm/hal/mips-extns.h>
end_include

begin_include
include|#
directive|include
file|<mips/nlm/hal/cop2.h>
end_include

begin_include
include|#
directive|include
file|<mips/nlm/hal/fmn.h>
end_include

begin_include
include|#
directive|include
file|<mips/nlm/hal/sys.h>
end_include

begin_include
include|#
directive|include
file|<mips/nlm/hal/nae.h>
end_include

begin_include
include|#
directive|include
file|<mips/nlm/hal/mdio.h>
end_include

begin_include
include|#
directive|include
file|<mips/nlm/hal/sgmii.h>
end_include

begin_include
include|#
directive|include
file|<mips/nlm/hal/xaui.h>
end_include

begin_include
include|#
directive|include
file|<mips/nlm/hal/poe.h>
end_include

begin_include
include|#
directive|include
file|<ucore_app_bin.h>
end_include

begin_include
include|#
directive|include
file|<mips/nlm/hal/ucore_loader.h>
end_include

begin_include
include|#
directive|include
file|<mips/nlm/xlp.h>
end_include

begin_include
include|#
directive|include
file|<mips/nlm/board.h>
end_include

begin_include
include|#
directive|include
file|<mips/nlm/msgring.h>
end_include

begin_include
include|#
directive|include
file|<dev/mii/mii.h>
end_include

begin_include
include|#
directive|include
file|<dev/mii/miivar.h>
end_include

begin_include
include|#
directive|include
file|"miidevs.h"
end_include

begin_include
include|#
directive|include
file|<dev/mii/brgphyreg.h>
end_include

begin_include
include|#
directive|include
file|"miibus_if.h"
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<mips/nlm/dev/net/xlpge.h>
end_include

begin_comment
comment|/*#define XLP_DRIVER_LOOPBACK*/
end_comment

begin_decl_stmt
specifier|static
name|struct
name|nae_port_config
name|nae_port_config
index|[
literal|64
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|poe_cl_tbl
index|[
name|MAX_POE_CLASSES
index|]
init|=
block|{
literal|0x0
block|,
literal|0x249249
block|,
literal|0x492492
block|,
literal|0x6db6db
block|,
literal|0x924924
block|,
literal|0xb6db6d
block|,
literal|0xdb6db6
block|,
literal|0xffffff
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* #define DUMP_PACKET */
end_comment

begin_function
specifier|static
name|uint64_t
name|nlm_paddr_ld
parameter_list|(
name|uint64_t
name|paddr
parameter_list|)
block|{
name|uint64_t
name|xkaddr
init|=
literal|0x9800000000000000
operator||
name|paddr
decl_stmt|;
return|return
operator|(
name|nlm_load_dword_daddr
argument_list|(
name|xkaddr
argument_list|)
operator|)
return|;
block|}
end_function

begin_decl_stmt
name|struct
name|nlm_xlp_portdata
name|ifp_ports
index|[
literal|64
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|uma_zone_t
name|nl_tx_desc_zone
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* This implementation will register the following tree of device  * registration:  *                      pcibus  *                       |  *                      xlpnae (1 instance - virtual entity)  *                       |  *                     xlpge  *      (18 sgmii / 4 xaui / 2 interlaken instances)  *                       |  *                    miibus  */
end_comment

begin_function_decl
specifier|static
name|int
name|nlm_xlpnae_probe
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nlm_xlpnae_attach
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nlm_xlpnae_detach
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nlm_xlpnae_suspend
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nlm_xlpnae_resume
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nlm_xlpnae_shutdown
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|device_method_t
name|nlm_xlpnae_methods
index|[]
init|=
block|{
comment|/* Methods from the device interface */
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|nlm_xlpnae_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|nlm_xlpnae_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|nlm_xlpnae_detach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_suspend
argument_list|,
name|nlm_xlpnae_suspend
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_resume
argument_list|,
name|nlm_xlpnae_resume
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_shutdown
argument_list|,
name|nlm_xlpnae_shutdown
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|bus_driver_added
argument_list|,
name|bus_generic_driver_added
argument_list|)
block|,
name|DEVMETHOD_END
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|nlm_xlpnae_driver
init|=
block|{
literal|"xlpnae"
block|,
name|nlm_xlpnae_methods
block|,
expr|sizeof
operator|(
expr|struct
name|nlm_xlpnae_softc
operator|)
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|nlm_xlpnae_devclass
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|int
name|nlm_xlpge_probe
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nlm_xlpge_attach
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nlm_xlpge_detach
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nlm_xlpge_suspend
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nlm_xlpge_resume
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nlm_xlpge_shutdown
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* mii override functions */
end_comment

begin_function_decl
specifier|static
name|int
name|nlm_xlpge_mii_read
parameter_list|(
name|struct
name|device
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nlm_xlpge_mii_write
parameter_list|(
name|struct
name|device
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|nlm_xlpge_mii_statchg
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|device_method_t
name|nlm_xlpge_methods
index|[]
init|=
block|{
comment|/* Methods from the device interface */
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|nlm_xlpge_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|nlm_xlpge_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|nlm_xlpge_detach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_suspend
argument_list|,
name|nlm_xlpge_suspend
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_resume
argument_list|,
name|nlm_xlpge_resume
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_shutdown
argument_list|,
name|nlm_xlpge_shutdown
argument_list|)
block|,
comment|/* Methods from the nexus bus needed for explicitly 	 * probing children when driver is loaded as a kernel module 	 */
name|DEVMETHOD
argument_list|(
name|miibus_readreg
argument_list|,
name|nlm_xlpge_mii_read
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|miibus_writereg
argument_list|,
name|nlm_xlpge_mii_write
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|miibus_statchg
argument_list|,
name|nlm_xlpge_mii_statchg
argument_list|)
block|,
comment|/* Terminate method list */
name|DEVMETHOD_END
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|nlm_xlpge_driver
init|=
block|{
literal|"xlpge"
block|,
name|nlm_xlpge_methods
block|,
expr|sizeof
operator|(
expr|struct
name|nlm_xlpge_softc
operator|)
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|nlm_xlpge_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|xlpnae
argument_list|,
name|pci
argument_list|,
name|nlm_xlpnae_driver
argument_list|,
name|nlm_xlpnae_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|xlpge
argument_list|,
name|xlpnae
argument_list|,
name|nlm_xlpge_driver
argument_list|,
name|nlm_xlpge_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|miibus
argument_list|,
name|xlpge
argument_list|,
name|miibus_driver
argument_list|,
name|miibus_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|pci
argument_list|,
name|xlpnae
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|xlpnae
argument_list|,
name|xlpge
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|xlpge
argument_list|,
name|ether
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|xlpge
argument_list|,
name|miibus
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_define
define|#
directive|define
name|SGMII_RCV_CONTEXT_WIDTH
value|8
end_define

begin_comment
comment|/* prototypes */
end_comment

begin_function_decl
specifier|static
name|void
name|nlm_xlpge_msgring_handler
parameter_list|(
name|int
name|vc
parameter_list|,
name|int
name|size
parameter_list|,
name|int
name|code
parameter_list|,
name|int
name|srcid
parameter_list|,
name|struct
name|nlm_fmn_msg
modifier|*
name|msg
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|nlm_xlpge_submit_rx_free_desc
parameter_list|(
name|struct
name|nlm_xlpge_softc
modifier|*
name|sc
parameter_list|,
name|int
name|num
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|nlm_xlpge_init
parameter_list|(
name|void
modifier|*
name|addr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|nlm_xlpge_port_disable
parameter_list|(
name|struct
name|nlm_xlpge_softc
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|nlm_xlpge_port_enable
parameter_list|(
name|struct
name|nlm_xlpge_softc
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* globals */
end_comment

begin_decl_stmt
name|int
name|dbg_on
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|cntx2port
index|[
literal|524
index|]
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|__inline
name|void
name|atomic_incr_long
parameter_list|(
name|unsigned
name|long
modifier|*
name|addr
parameter_list|)
block|{
name|atomic_add_long
argument_list|(
name|addr
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * xlpnae driver implementation  */
end_comment

begin_function
specifier|static
name|int
name|nlm_xlpnae_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
if|if
condition|(
name|pci_get_vendor
argument_list|(
name|dev
argument_list|)
operator|!=
name|PCI_VENDOR_NETLOGIC
operator|||
name|pci_get_device
argument_list|(
name|dev
argument_list|)
operator|!=
name|PCI_DEVICE_ID_NLM_NAE
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
return|return
operator|(
name|BUS_PROBE_DEFAULT
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|nlm_xlpnae_print_frin_desc_carving
parameter_list|(
name|struct
name|nlm_xlpnae_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|intf
decl_stmt|;
name|uint32_t
name|value
decl_stmt|;
name|int
name|start
decl_stmt|,
name|size
decl_stmt|;
comment|/* XXXJC: use max_ports instead of 20 ? */
for|for
control|(
name|intf
operator|=
literal|0
init|;
name|intf
operator|<
literal|20
condition|;
name|intf
operator|++
control|)
block|{
name|nlm_write_nae_reg
argument_list|(
name|sc
operator|->
name|base
argument_list|,
name|NAE_FREE_IN_FIFO_CFG
argument_list|,
operator|(
literal|0x80000000
operator||
name|intf
operator|)
argument_list|)
expr_stmt|;
name|value
operator|=
name|nlm_read_nae_reg
argument_list|(
name|sc
operator|->
name|base
argument_list|,
name|NAE_FREE_IN_FIFO_CFG
argument_list|)
expr_stmt|;
name|size
operator|=
literal|2
operator|*
operator|(
operator|(
name|value
operator|>>
literal|20
operator|)
operator|&
literal|0x3ff
operator|)
expr_stmt|;
name|start
operator|=
literal|2
operator|*
operator|(
operator|(
name|value
operator|>>
literal|8
operator|)
operator|&
literal|0x1ff
operator|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|nlm_config_egress
parameter_list|(
name|struct
name|nlm_xlpnae_softc
modifier|*
name|sc
parameter_list|,
name|int
name|nblock
parameter_list|,
name|int
name|context_base
parameter_list|,
name|int
name|hwport
parameter_list|,
name|int
name|max_channels
parameter_list|)
block|{
name|int
name|offset
decl_stmt|,
name|num_channels
decl_stmt|;
name|uint32_t
name|data
decl_stmt|;
name|num_channels
operator|=
name|sc
operator|->
name|portcfg
index|[
name|hwport
index|]
operator|.
name|num_channels
expr_stmt|;
name|data
operator|=
operator|(
literal|2048
operator|<<
literal|12
operator|)
operator||
operator|(
name|hwport
operator|<<
literal|4
operator|)
operator||
literal|1
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|sc
operator|->
name|base
argument_list|,
name|NAE_TX_IF_BURSTMAX_CMD
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|data
operator|=
operator|(
operator|(
name|context_base
operator|+
name|num_channels
operator|-
literal|1
operator|)
operator|<<
literal|22
operator|)
operator||
operator|(
name|context_base
operator|<<
literal|12
operator|)
operator||
operator|(
name|hwport
operator|<<
literal|4
operator|)
operator||
literal|1
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|sc
operator|->
name|base
argument_list|,
name|NAE_TX_DDR_ACTVLIST_CMD
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|config_egress_fifo_carvings
argument_list|(
name|sc
operator|->
name|base
argument_list|,
name|hwport
argument_list|,
name|context_base
argument_list|,
name|num_channels
argument_list|,
name|max_channels
argument_list|,
name|sc
operator|->
name|portcfg
argument_list|)
expr_stmt|;
name|config_egress_fifo_credits
argument_list|(
name|sc
operator|->
name|base
argument_list|,
name|hwport
argument_list|,
name|context_base
argument_list|,
name|num_channels
argument_list|,
name|max_channels
argument_list|,
name|sc
operator|->
name|portcfg
argument_list|)
expr_stmt|;
name|data
operator|=
name|nlm_read_nae_reg
argument_list|(
name|sc
operator|->
name|base
argument_list|,
name|NAE_DMA_TX_CREDIT_TH
argument_list|)
expr_stmt|;
name|data
operator||=
operator|(
literal|1
operator|<<
literal|25
operator|)
operator||
operator|(
literal|1
operator|<<
literal|24
operator|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|sc
operator|->
name|base
argument_list|,
name|NAE_DMA_TX_CREDIT_TH
argument_list|,
name|data
argument_list|)
expr_stmt|;
for|for
control|(
name|offset
operator|=
literal|0
init|;
name|offset
operator|<
name|num_channels
condition|;
name|offset
operator|++
control|)
block|{
name|nlm_write_nae_reg
argument_list|(
name|sc
operator|->
name|base
argument_list|,
name|NAE_TX_SCHED_MAP_CMD1
argument_list|,
name|NAE_DRR_QUANTA
argument_list|)
expr_stmt|;
name|data
operator|=
operator|(
name|hwport
operator|<<
literal|15
operator|)
operator||
operator|(
operator|(
name|context_base
operator|+
name|offset
operator|)
operator|<<
literal|5
operator|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|cmplx_type
index|[
name|nblock
index|]
operator|==
name|ILC
condition|)
name|data
operator||=
operator|(
name|offset
operator|<<
literal|20
operator|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|sc
operator|->
name|base
argument_list|,
name|NAE_TX_SCHED_MAP_CMD0
argument_list|,
name|data
operator||
literal|1
argument_list|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|sc
operator|->
name|base
argument_list|,
name|NAE_TX_SCHED_MAP_CMD0
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|xlpnae_get_maxchannels
parameter_list|(
name|struct
name|nlm_xlpnae_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|maxchans
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|max_ports
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|sc
operator|->
name|portcfg
index|[
name|i
index|]
operator|.
name|type
operator|==
name|UNKNOWN
condition|)
continue|continue;
name|maxchans
operator|+=
name|sc
operator|->
name|portcfg
index|[
name|i
index|]
operator|.
name|num_channels
expr_stmt|;
block|}
return|return
operator|(
name|maxchans
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|nlm_setup_interface
parameter_list|(
name|struct
name|nlm_xlpnae_softc
modifier|*
name|sc
parameter_list|,
name|int
name|nblock
parameter_list|,
name|int
name|port
parameter_list|,
name|uint32_t
name|cur_flow_base
parameter_list|,
name|uint32_t
name|flow_mask
parameter_list|,
name|int
name|max_channels
parameter_list|,
name|int
name|context
parameter_list|)
block|{
name|uint64_t
name|nae_base
init|=
name|sc
operator|->
name|base
decl_stmt|;
name|int
name|mtu
init|=
literal|1536
decl_stmt|;
comment|/* XXXJC: don't hard code */
name|uint32_t
name|ucore_mask
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|cmplx_type
index|[
name|nblock
index|]
operator|==
name|XAUIC
condition|)
name|nlm_config_xaui
argument_list|(
name|nae_base
argument_list|,
name|nblock
argument_list|,
name|mtu
argument_list|,
name|mtu
argument_list|,
name|sc
operator|->
name|portcfg
index|[
name|port
index|]
operator|.
name|vlan_pri_en
argument_list|)
expr_stmt|;
name|nlm_config_freein_fifo_uniq_cfg
argument_list|(
name|nae_base
argument_list|,
name|port
argument_list|,
name|sc
operator|->
name|portcfg
index|[
name|port
index|]
operator|.
name|free_desc_sizes
argument_list|)
expr_stmt|;
name|nlm_config_ucore_iface_mask_cfg
argument_list|(
name|nae_base
argument_list|,
name|port
argument_list|,
name|sc
operator|->
name|portcfg
index|[
name|port
index|]
operator|.
name|ucore_mask
argument_list|)
expr_stmt|;
name|nlm_program_flow_cfg
argument_list|(
name|nae_base
argument_list|,
name|port
argument_list|,
name|cur_flow_base
argument_list|,
name|flow_mask
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|cmplx_type
index|[
name|nblock
index|]
operator|==
name|SGMIIC
condition|)
name|nlm_configure_sgmii_interface
argument_list|(
name|nae_base
argument_list|,
name|nblock
argument_list|,
name|port
argument_list|,
name|mtu
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|nlm_config_egress
argument_list|(
name|sc
argument_list|,
name|nblock
argument_list|,
name|context
argument_list|,
name|port
argument_list|,
name|max_channels
argument_list|)
expr_stmt|;
name|nlm_nae_init_netior
argument_list|(
name|nae_base
argument_list|,
name|sc
operator|->
name|nblocks
argument_list|)
expr_stmt|;
name|nlm_nae_open_if
argument_list|(
name|nae_base
argument_list|,
name|nblock
argument_list|,
name|sc
operator|->
name|cmplx_type
index|[
name|nblock
index|]
argument_list|,
name|port
argument_list|,
name|sc
operator|->
name|portcfg
index|[
name|port
index|]
operator|.
name|free_desc_sizes
argument_list|)
expr_stmt|;
comment|/*  XXXJC: check mask calculation */
name|ucore_mask
operator|=
operator|(
literal|1
operator|<<
name|sc
operator|->
name|nucores
operator|)
operator|-
literal|1
expr_stmt|;
name|nlm_nae_init_ucore
argument_list|(
name|nae_base
argument_list|,
name|port
argument_list|,
name|ucore_mask
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|nlm_setup_interfaces
parameter_list|(
name|struct
name|nlm_xlpnae_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint64_t
name|nae_base
decl_stmt|;
name|uint32_t
name|cur_slot
decl_stmt|,
name|cur_slot_base
decl_stmt|;
name|uint32_t
name|cur_flow_base
decl_stmt|,
name|port
decl_stmt|,
name|flow_mask
decl_stmt|;
name|int
name|max_channels
decl_stmt|;
name|int
name|i
decl_stmt|,
name|context
decl_stmt|;
name|cur_slot
operator|=
literal|0
expr_stmt|;
name|cur_slot_base
operator|=
literal|0
expr_stmt|;
name|cur_flow_base
operator|=
literal|0
expr_stmt|;
name|nae_base
operator|=
name|sc
operator|->
name|base
expr_stmt|;
name|flow_mask
operator|=
name|nlm_get_flow_mask
argument_list|(
name|sc
operator|->
name|total_num_ports
argument_list|)
expr_stmt|;
comment|/* calculate max_channels */
name|max_channels
operator|=
name|xlpnae_get_maxchannels
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|port
operator|=
literal|0
expr_stmt|;
name|context
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|max_ports
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|sc
operator|->
name|portcfg
index|[
name|i
index|]
operator|.
name|type
operator|==
name|UNKNOWN
condition|)
continue|continue;
name|nlm_setup_interface
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|portcfg
index|[
name|i
index|]
operator|.
name|block
argument_list|,
name|i
argument_list|,
name|cur_flow_base
argument_list|,
name|flow_mask
argument_list|,
name|max_channels
argument_list|,
name|context
argument_list|)
expr_stmt|;
name|cur_flow_base
operator|+=
name|sc
operator|->
name|per_port_num_flows
expr_stmt|;
name|context
operator|+=
name|sc
operator|->
name|portcfg
index|[
name|i
index|]
operator|.
name|num_channels
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|nlm_xlpnae_init
parameter_list|(
name|int
name|node
parameter_list|,
name|struct
name|nlm_xlpnae_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint64_t
name|nae_base
decl_stmt|;
name|uint32_t
name|ucoremask
init|=
literal|0
decl_stmt|;
name|uint32_t
name|val
decl_stmt|;
name|int
name|i
decl_stmt|;
name|nae_base
operator|=
name|sc
operator|->
name|base
expr_stmt|;
name|nlm_nae_flush_free_fifo
argument_list|(
name|nae_base
argument_list|,
name|sc
operator|->
name|nblocks
argument_list|)
expr_stmt|;
name|nlm_deflate_frin_fifo_carving
argument_list|(
name|nae_base
argument_list|,
name|sc
operator|->
name|max_ports
argument_list|)
expr_stmt|;
name|nlm_reset_nae
argument_list|(
name|node
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|nucores
condition|;
name|i
operator|++
control|)
comment|/* XXXJC: code repeated below */
name|ucoremask
operator||=
operator|(
literal|0x1
operator|<<
name|i
operator|)
expr_stmt|;
name|printf
argument_list|(
literal|"Loading 0x%x ucores with microcode\n"
argument_list|,
name|ucoremask
argument_list|)
expr_stmt|;
name|nlm_ucore_load_all
argument_list|(
name|nae_base
argument_list|,
name|ucoremask
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|val
operator|=
name|nlm_set_device_frequency
argument_list|(
name|node
argument_list|,
name|DFS_DEVICE_NAE
argument_list|,
name|sc
operator|->
name|freq
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Setup NAE frequency to %dMHz\n"
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|nlm_mdio_reset_all
argument_list|(
name|nae_base
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Initialze SGMII PCS for blocks 0x%x\n"
argument_list|,
name|sc
operator|->
name|sgmiimask
argument_list|)
expr_stmt|;
name|nlm_sgmii_pcs_init
argument_list|(
name|nae_base
argument_list|,
name|sc
operator|->
name|sgmiimask
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Initialze XAUI PCS for blocks 0x%x\n"
argument_list|,
name|sc
operator|->
name|xauimask
argument_list|)
expr_stmt|;
name|nlm_xaui_pcs_init
argument_list|(
name|nae_base
argument_list|,
name|sc
operator|->
name|xauimask
argument_list|)
expr_stmt|;
comment|/* clear NETIOR soft reset */
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_LANE_CFG_SOFTRESET
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
comment|/* Disable RX enable bit in RX_CONFIG */
name|val
operator|=
name|nlm_read_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_RX_CONFIG
argument_list|)
expr_stmt|;
name|val
operator|&=
literal|0xfffffffe
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_RX_CONFIG
argument_list|,
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|nlm_is_xlp8xx_ax
argument_list|()
operator|==
literal|0
condition|)
block|{
name|val
operator|=
name|nlm_read_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_TX_CONFIG
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
operator|(
literal|1
operator|<<
literal|3
operator|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_TX_CONFIG
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
name|nlm_setup_poe_class_config
argument_list|(
name|nae_base
argument_list|,
name|MAX_POE_CLASSES
argument_list|,
name|sc
operator|->
name|ncontexts
argument_list|,
name|poe_cl_tbl
argument_list|)
expr_stmt|;
name|nlm_setup_vfbid_mapping
argument_list|(
name|nae_base
argument_list|)
expr_stmt|;
name|nlm_setup_flow_crc_poly
argument_list|(
name|nae_base
argument_list|,
name|sc
operator|->
name|flow_crc_poly
argument_list|)
expr_stmt|;
name|nlm_setup_rx_cal_cfg
argument_list|(
name|nae_base
argument_list|,
name|sc
operator|->
name|max_ports
argument_list|,
name|sc
operator|->
name|portcfg
argument_list|)
expr_stmt|;
comment|/* note: xlp8xx Ax does not have Tx Calendering */
if|if
condition|(
operator|!
name|nlm_is_xlp8xx_ax
argument_list|()
condition|)
name|nlm_setup_tx_cal_cfg
argument_list|(
name|nae_base
argument_list|,
name|sc
operator|->
name|max_ports
argument_list|,
name|sc
operator|->
name|portcfg
argument_list|)
expr_stmt|;
name|nlm_setup_interfaces
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|nlm_config_poe
argument_list|(
name|sc
operator|->
name|poe_base
argument_list|,
name|sc
operator|->
name|poedv_base
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|hw_parser_en
condition|)
name|nlm_enable_hardware_parser
argument_list|(
name|nae_base
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|prepad_en
condition|)
name|nlm_prepad_enable
argument_list|(
name|nae_base
argument_list|,
name|sc
operator|->
name|prepad_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|ieee_1588_en
condition|)
name|nlm_setup_1588_timer
argument_list|(
name|sc
operator|->
name|base
argument_list|,
name|sc
operator|->
name|portcfg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|nlm_xlpnae_update_pde
parameter_list|(
name|void
modifier|*
name|dummy
name|__unused
parameter_list|)
block|{
name|struct
name|nlm_xlpnae_softc
modifier|*
name|sc
decl_stmt|;
name|uint32_t
name|dv
index|[
name|NUM_WORDS_PER_DV
index|]
decl_stmt|;
name|device_t
name|dev
decl_stmt|;
name|int
name|vec
decl_stmt|;
name|dev
operator|=
name|devclass_get_device
argument_list|(
name|devclass_find
argument_list|(
literal|"xlpnae"
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|nlm_write_poe_reg
argument_list|(
name|sc
operator|->
name|poe_base
argument_list|,
name|POE_DISTR_EN
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|vec
operator|=
literal|0
init|;
name|vec
operator|<
name|NUM_DIST_VEC
condition|;
name|vec
operator|++
control|)
block|{
if|if
condition|(
name|nlm_get_poe_distvec
argument_list|(
name|vec
argument_list|,
name|dv
argument_list|)
operator|!=
literal|0
condition|)
continue|continue;
name|nlm_write_poe_distvec
argument_list|(
name|sc
operator|->
name|poedv_base
argument_list|,
name|vec
argument_list|,
name|dv
argument_list|)
expr_stmt|;
block|}
name|nlm_write_poe_reg
argument_list|(
name|sc
operator|->
name|poe_base
argument_list|,
name|POE_DISTR_EN
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_expr_stmt
name|SYSINIT
argument_list|(
name|nlm_xlpnae_update_pde
argument_list|,
name|SI_SUB_SMP
argument_list|,
name|SI_ORDER_ANY
argument_list|,
name|nlm_xlpnae_update_pde
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* configuration common for sgmii, xaui, ilaken goes here */
end_comment

begin_function
specifier|static
name|void
name|nlm_setup_portcfg
parameter_list|(
name|struct
name|nlm_xlpnae_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|xlp_nae_ivars
modifier|*
name|naep
parameter_list|,
name|int
name|block
parameter_list|,
name|int
name|port
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|uint32_t
name|ucore_mask
init|=
literal|0
decl_stmt|;
name|struct
name|xlp_block_ivars
modifier|*
name|bp
decl_stmt|;
name|struct
name|xlp_port_ivars
modifier|*
name|p
decl_stmt|;
name|bp
operator|=
operator|&
operator|(
name|naep
operator|->
name|block_ivars
index|[
name|block
index|]
operator|)
expr_stmt|;
name|p
operator|=
operator|&
operator|(
name|bp
operator|->
name|port_ivars
index|[
name|port
operator|&
literal|0x3
index|]
operator|)
expr_stmt|;
name|sc
operator|->
name|portcfg
index|[
name|port
index|]
operator|.
name|node
operator|=
name|p
operator|->
name|node
expr_stmt|;
name|sc
operator|->
name|portcfg
index|[
name|port
index|]
operator|.
name|block
operator|=
name|p
operator|->
name|block
expr_stmt|;
name|sc
operator|->
name|portcfg
index|[
name|port
index|]
operator|.
name|port
operator|=
name|p
operator|->
name|port
expr_stmt|;
name|sc
operator|->
name|portcfg
index|[
name|port
index|]
operator|.
name|type
operator|=
name|p
operator|->
name|type
expr_stmt|;
name|sc
operator|->
name|portcfg
index|[
name|port
index|]
operator|.
name|mdio_bus
operator|=
name|p
operator|->
name|mdio_bus
expr_stmt|;
name|sc
operator|->
name|portcfg
index|[
name|port
index|]
operator|.
name|phy_addr
operator|=
name|p
operator|->
name|phy_addr
expr_stmt|;
name|sc
operator|->
name|portcfg
index|[
name|port
index|]
operator|.
name|loopback_mode
operator|=
name|p
operator|->
name|loopback_mode
expr_stmt|;
name|sc
operator|->
name|portcfg
index|[
name|port
index|]
operator|.
name|num_channels
operator|=
name|p
operator|->
name|num_channels
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|free_desc_sizes
operator|!=
name|MCLBYTES
condition|)
block|{
name|printf
argument_list|(
literal|"[%d, %d] Error: free_desc_sizes %d != %d\n"
argument_list|,
name|block
argument_list|,
name|port
argument_list|,
name|p
operator|->
name|free_desc_sizes
argument_list|,
name|MCLBYTES
argument_list|)
expr_stmt|;
return|return;
block|}
name|sc
operator|->
name|portcfg
index|[
name|port
index|]
operator|.
name|free_desc_sizes
operator|=
name|p
operator|->
name|free_desc_sizes
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|nucores
condition|;
name|i
operator|++
control|)
comment|/* XXXJC: configure this */
name|ucore_mask
operator||=
operator|(
literal|0x1
operator|<<
name|i
operator|)
expr_stmt|;
name|sc
operator|->
name|portcfg
index|[
name|port
index|]
operator|.
name|ucore_mask
operator|=
name|ucore_mask
expr_stmt|;
name|sc
operator|->
name|portcfg
index|[
name|port
index|]
operator|.
name|vlan_pri_en
operator|=
name|p
operator|->
name|vlan_pri_en
expr_stmt|;
name|sc
operator|->
name|portcfg
index|[
name|port
index|]
operator|.
name|num_free_descs
operator|=
name|p
operator|->
name|num_free_descs
expr_stmt|;
name|sc
operator|->
name|portcfg
index|[
name|port
index|]
operator|.
name|iface_fifo_size
operator|=
name|p
operator|->
name|iface_fifo_size
expr_stmt|;
name|sc
operator|->
name|portcfg
index|[
name|port
index|]
operator|.
name|rxbuf_size
operator|=
name|p
operator|->
name|rxbuf_size
expr_stmt|;
name|sc
operator|->
name|portcfg
index|[
name|port
index|]
operator|.
name|rx_slots_reqd
operator|=
name|p
operator|->
name|rx_slots_reqd
expr_stmt|;
name|sc
operator|->
name|portcfg
index|[
name|port
index|]
operator|.
name|tx_slots_reqd
operator|=
name|p
operator|->
name|tx_slots_reqd
expr_stmt|;
name|sc
operator|->
name|portcfg
index|[
name|port
index|]
operator|.
name|pseq_fifo_size
operator|=
name|p
operator|->
name|pseq_fifo_size
expr_stmt|;
name|sc
operator|->
name|portcfg
index|[
name|port
index|]
operator|.
name|stg2_fifo_size
operator|=
name|p
operator|->
name|stg2_fifo_size
expr_stmt|;
name|sc
operator|->
name|portcfg
index|[
name|port
index|]
operator|.
name|eh_fifo_size
operator|=
name|p
operator|->
name|eh_fifo_size
expr_stmt|;
name|sc
operator|->
name|portcfg
index|[
name|port
index|]
operator|.
name|frout_fifo_size
operator|=
name|p
operator|->
name|frout_fifo_size
expr_stmt|;
name|sc
operator|->
name|portcfg
index|[
name|port
index|]
operator|.
name|ms_fifo_size
operator|=
name|p
operator|->
name|ms_fifo_size
expr_stmt|;
name|sc
operator|->
name|portcfg
index|[
name|port
index|]
operator|.
name|pkt_fifo_size
operator|=
name|p
operator|->
name|pkt_fifo_size
expr_stmt|;
name|sc
operator|->
name|portcfg
index|[
name|port
index|]
operator|.
name|pktlen_fifo_size
operator|=
name|p
operator|->
name|pktlen_fifo_size
expr_stmt|;
name|sc
operator|->
name|portcfg
index|[
name|port
index|]
operator|.
name|max_stg2_offset
operator|=
name|p
operator|->
name|max_stg2_offset
expr_stmt|;
name|sc
operator|->
name|portcfg
index|[
name|port
index|]
operator|.
name|max_eh_offset
operator|=
name|p
operator|->
name|max_eh_offset
expr_stmt|;
name|sc
operator|->
name|portcfg
index|[
name|port
index|]
operator|.
name|max_frout_offset
operator|=
name|p
operator|->
name|max_frout_offset
expr_stmt|;
name|sc
operator|->
name|portcfg
index|[
name|port
index|]
operator|.
name|max_ms_offset
operator|=
name|p
operator|->
name|max_ms_offset
expr_stmt|;
name|sc
operator|->
name|portcfg
index|[
name|port
index|]
operator|.
name|max_pmem_offset
operator|=
name|p
operator|->
name|max_pmem_offset
expr_stmt|;
name|sc
operator|->
name|portcfg
index|[
name|port
index|]
operator|.
name|stg1_2_credit
operator|=
name|p
operator|->
name|stg1_2_credit
expr_stmt|;
name|sc
operator|->
name|portcfg
index|[
name|port
index|]
operator|.
name|stg2_eh_credit
operator|=
name|p
operator|->
name|stg2_eh_credit
expr_stmt|;
name|sc
operator|->
name|portcfg
index|[
name|port
index|]
operator|.
name|stg2_frout_credit
operator|=
name|p
operator|->
name|stg2_frout_credit
expr_stmt|;
name|sc
operator|->
name|portcfg
index|[
name|port
index|]
operator|.
name|stg2_ms_credit
operator|=
name|p
operator|->
name|stg2_ms_credit
expr_stmt|;
name|sc
operator|->
name|portcfg
index|[
name|port
index|]
operator|.
name|ieee1588_inc_intg
operator|=
name|p
operator|->
name|ieee1588_inc_intg
expr_stmt|;
name|sc
operator|->
name|portcfg
index|[
name|port
index|]
operator|.
name|ieee1588_inc_den
operator|=
name|p
operator|->
name|ieee1588_inc_den
expr_stmt|;
name|sc
operator|->
name|portcfg
index|[
name|port
index|]
operator|.
name|ieee1588_inc_num
operator|=
name|p
operator|->
name|ieee1588_inc_num
expr_stmt|;
name|sc
operator|->
name|portcfg
index|[
name|port
index|]
operator|.
name|ieee1588_userval
operator|=
name|p
operator|->
name|ieee1588_userval
expr_stmt|;
name|sc
operator|->
name|portcfg
index|[
name|port
index|]
operator|.
name|ieee1588_ptpoff
operator|=
name|p
operator|->
name|ieee1588_ptpoff
expr_stmt|;
name|sc
operator|->
name|portcfg
index|[
name|port
index|]
operator|.
name|ieee1588_tmr1
operator|=
name|p
operator|->
name|ieee1588_tmr1
expr_stmt|;
name|sc
operator|->
name|portcfg
index|[
name|port
index|]
operator|.
name|ieee1588_tmr2
operator|=
name|p
operator|->
name|ieee1588_tmr2
expr_stmt|;
name|sc
operator|->
name|portcfg
index|[
name|port
index|]
operator|.
name|ieee1588_tmr3
operator|=
name|p
operator|->
name|ieee1588_tmr3
expr_stmt|;
name|sc
operator|->
name|total_free_desc
operator|+=
name|sc
operator|->
name|portcfg
index|[
name|port
index|]
operator|.
name|free_desc_sizes
expr_stmt|;
name|sc
operator|->
name|total_num_ports
operator|++
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|nlm_xlpnae_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|xlp_nae_ivars
modifier|*
name|nae_ivars
decl_stmt|;
name|struct
name|nlm_xlpnae_softc
modifier|*
name|sc
decl_stmt|;
name|device_t
name|tmpd
decl_stmt|;
name|uint32_t
name|dv
index|[
name|NUM_WORDS_PER_DV
index|]
decl_stmt|;
name|int
name|port
decl_stmt|,
name|i
decl_stmt|,
name|j
decl_stmt|,
name|nchan
decl_stmt|,
name|nblock
decl_stmt|,
name|node
decl_stmt|,
name|qstart
decl_stmt|,
name|qnum
decl_stmt|;
name|int
name|offset
decl_stmt|,
name|context
decl_stmt|,
name|txq_base
decl_stmt|,
name|rxvcbase
decl_stmt|;
name|uint64_t
name|poe_pcibase
decl_stmt|,
name|nae_pcibase
decl_stmt|;
name|node
operator|=
name|pci_get_slot
argument_list|(
name|dev
argument_list|)
operator|/
literal|8
expr_stmt|;
name|nae_ivars
operator|=
operator|&
name|xlp_board_info
operator|.
name|nodes
index|[
name|node
index|]
operator|.
name|nae_ivars
expr_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sc
operator|->
name|xlpnae_dev
operator|=
name|dev
expr_stmt|;
name|sc
operator|->
name|node
operator|=
name|nae_ivars
operator|->
name|node
expr_stmt|;
name|sc
operator|->
name|base
operator|=
name|nlm_get_nae_regbase
argument_list|(
name|sc
operator|->
name|node
argument_list|)
expr_stmt|;
name|sc
operator|->
name|poe_base
operator|=
name|nlm_get_poe_regbase
argument_list|(
name|sc
operator|->
name|node
argument_list|)
expr_stmt|;
name|sc
operator|->
name|poedv_base
operator|=
name|nlm_get_poedv_regbase
argument_list|(
name|sc
operator|->
name|node
argument_list|)
expr_stmt|;
name|sc
operator|->
name|portcfg
operator|=
name|nae_port_config
expr_stmt|;
name|sc
operator|->
name|blockmask
operator|=
name|nae_ivars
operator|->
name|blockmask
expr_stmt|;
name|sc
operator|->
name|ilmask
operator|=
name|nae_ivars
operator|->
name|ilmask
expr_stmt|;
name|sc
operator|->
name|xauimask
operator|=
name|nae_ivars
operator|->
name|xauimask
expr_stmt|;
name|sc
operator|->
name|sgmiimask
operator|=
name|nae_ivars
operator|->
name|sgmiimask
expr_stmt|;
name|sc
operator|->
name|nblocks
operator|=
name|nae_ivars
operator|->
name|nblocks
expr_stmt|;
name|sc
operator|->
name|freq
operator|=
name|nae_ivars
operator|->
name|freq
expr_stmt|;
comment|/* flow table generation is done by CRC16 polynomial */
name|sc
operator|->
name|flow_crc_poly
operator|=
name|nae_ivars
operator|->
name|flow_crc_poly
expr_stmt|;
name|sc
operator|->
name|hw_parser_en
operator|=
name|nae_ivars
operator|->
name|hw_parser_en
expr_stmt|;
name|sc
operator|->
name|prepad_en
operator|=
name|nae_ivars
operator|->
name|prepad_en
expr_stmt|;
name|sc
operator|->
name|prepad_size
operator|=
name|nae_ivars
operator|->
name|prepad_size
expr_stmt|;
name|sc
operator|->
name|ieee_1588_en
operator|=
name|nae_ivars
operator|->
name|ieee_1588_en
expr_stmt|;
name|nae_pcibase
operator|=
name|nlm_get_nae_pcibase
argument_list|(
name|sc
operator|->
name|node
argument_list|)
expr_stmt|;
name|sc
operator|->
name|ncontexts
operator|=
name|nlm_read_reg
argument_list|(
name|nae_pcibase
argument_list|,
name|XLP_PCI_DEVINFO_REG5
argument_list|)
expr_stmt|;
name|sc
operator|->
name|nucores
operator|=
name|nlm_num_uengines
argument_list|(
name|nae_pcibase
argument_list|)
expr_stmt|;
for|for
control|(
name|nblock
operator|=
literal|0
init|;
name|nblock
operator|<
name|sc
operator|->
name|nblocks
condition|;
name|nblock
operator|++
control|)
block|{
name|sc
operator|->
name|cmplx_type
index|[
name|nblock
index|]
operator|=
name|nae_ivars
operator|->
name|block_ivars
index|[
name|nblock
index|]
operator|.
name|type
expr_stmt|;
name|sc
operator|->
name|portmask
index|[
name|nblock
index|]
operator|=
name|nae_ivars
operator|->
name|block_ivars
index|[
name|nblock
index|]
operator|.
name|portmask
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|ncontexts
condition|;
name|i
operator|++
control|)
name|cntx2port
index|[
name|i
index|]
operator|=
literal|18
expr_stmt|;
comment|/* 18 is an invalid port */
if|if
condition|(
name|sc
operator|->
name|nblocks
operator|==
literal|5
condition|)
name|sc
operator|->
name|max_ports
operator|=
literal|18
expr_stmt|;
comment|/* 8xx has a block 4 with 2 ports */
else|else
name|sc
operator|->
name|max_ports
operator|=
name|sc
operator|->
name|nblocks
operator|*
name|PORTS_PER_CMPLX
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|max_ports
condition|;
name|i
operator|++
control|)
name|sc
operator|->
name|portcfg
index|[
name|i
index|]
operator|.
name|type
operator|=
name|UNKNOWN
expr_stmt|;
comment|/* Port Not Present */
comment|/* 	 * Now setup all internal fifo carvings based on 	 * total number of ports in the system 	 */
name|sc
operator|->
name|total_free_desc
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|total_num_ports
operator|=
literal|0
expr_stmt|;
name|port
operator|=
literal|0
expr_stmt|;
name|context
operator|=
literal|0
expr_stmt|;
name|txq_base
operator|=
name|nlm_qidstart
argument_list|(
name|nae_pcibase
argument_list|)
expr_stmt|;
name|rxvcbase
operator|=
name|txq_base
operator|+
name|sc
operator|->
name|ncontexts
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|nblocks
condition|;
name|i
operator|++
control|)
block|{
name|uint32_t
name|portmask
decl_stmt|;
if|if
condition|(
operator|(
name|nae_ivars
operator|->
name|blockmask
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
operator|)
operator|==
literal|0
condition|)
block|{
name|port
operator|+=
literal|4
expr_stmt|;
continue|continue;
block|}
name|portmask
operator|=
name|nae_ivars
operator|->
name|block_ivars
index|[
name|i
index|]
operator|.
name|portmask
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|PORTS_PER_CMPLX
condition|;
name|j
operator|++
operator|,
name|port
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|portmask
operator|&
operator|(
literal|1
operator|<<
name|j
operator|)
operator|)
operator|==
literal|0
condition|)
continue|continue;
name|nlm_setup_portcfg
argument_list|(
name|sc
argument_list|,
name|nae_ivars
argument_list|,
name|i
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|nchan
operator|=
name|sc
operator|->
name|portcfg
index|[
name|port
index|]
operator|.
name|num_channels
expr_stmt|;
for|for
control|(
name|offset
operator|=
literal|0
init|;
name|offset
operator|<
name|nchan
condition|;
name|offset
operator|++
control|)
name|cntx2port
index|[
name|context
operator|+
name|offset
index|]
operator|=
name|port
expr_stmt|;
name|sc
operator|->
name|portcfg
index|[
name|port
index|]
operator|.
name|txq
operator|=
name|txq_base
operator|+
name|context
expr_stmt|;
name|sc
operator|->
name|portcfg
index|[
name|port
index|]
operator|.
name|rxfreeq
operator|=
name|rxvcbase
operator|+
name|port
expr_stmt|;
name|context
operator|+=
name|nchan
expr_stmt|;
block|}
block|}
name|poe_pcibase
operator|=
name|nlm_get_poe_pcibase
argument_list|(
name|sc
operator|->
name|node
argument_list|)
expr_stmt|;
name|sc
operator|->
name|per_port_num_flows
operator|=
name|nlm_poe_max_flows
argument_list|(
name|poe_pcibase
argument_list|)
operator|/
name|sc
operator|->
name|total_num_ports
expr_stmt|;
comment|/* zone for P2P descriptors */
name|nl_tx_desc_zone
operator|=
name|uma_zcreate
argument_list|(
literal|"NL Tx Desc"
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|xlpge_tx_desc
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NAE_CACHELINE_SIZE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* NAE FMN messages have CMS src station id's in the 	 * range of qstart to qnum. 	 */
name|qstart
operator|=
name|nlm_qidstart
argument_list|(
name|nae_pcibase
argument_list|)
expr_stmt|;
name|qnum
operator|=
name|nlm_qnum
argument_list|(
name|nae_pcibase
argument_list|)
expr_stmt|;
if|if
condition|(
name|register_msgring_handler
argument_list|(
name|qstart
argument_list|,
name|qstart
operator|+
name|qnum
operator|-
literal|1
argument_list|,
name|nlm_xlpge_msgring_handler
argument_list|,
name|sc
argument_list|)
condition|)
block|{
name|panic
argument_list|(
literal|"Couldn't register NAE msgring handler\n"
argument_list|)
expr_stmt|;
block|}
comment|/* POE FMN messages have CMS src station id's in the 	 * range of qstart to qnum. 	 */
name|qstart
operator|=
name|nlm_qidstart
argument_list|(
name|poe_pcibase
argument_list|)
expr_stmt|;
name|qnum
operator|=
name|nlm_qnum
argument_list|(
name|poe_pcibase
argument_list|)
expr_stmt|;
if|if
condition|(
name|register_msgring_handler
argument_list|(
name|qstart
argument_list|,
name|qstart
operator|+
name|qnum
operator|-
literal|1
argument_list|,
name|nlm_xlpge_msgring_handler
argument_list|,
name|sc
argument_list|)
condition|)
block|{
name|panic
argument_list|(
literal|"Couldn't register POE msgring handler\n"
argument_list|)
expr_stmt|;
block|}
name|nlm_xlpnae_init
argument_list|(
name|node
argument_list|,
name|sc
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|max_ports
condition|;
name|i
operator|++
control|)
block|{
name|char
name|desc
index|[
literal|32
index|]
decl_stmt|;
name|int
name|block
decl_stmt|,
name|port
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|portcfg
index|[
name|i
index|]
operator|.
name|type
operator|==
name|UNKNOWN
condition|)
continue|continue;
name|block
operator|=
name|sc
operator|->
name|portcfg
index|[
name|i
index|]
operator|.
name|block
expr_stmt|;
name|port
operator|=
name|sc
operator|->
name|portcfg
index|[
name|i
index|]
operator|.
name|port
expr_stmt|;
name|tmpd
operator|=
name|device_add_child
argument_list|(
name|dev
argument_list|,
literal|"xlpge"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|device_set_ivars
argument_list|(
name|tmpd
argument_list|,
operator|&
operator|(
name|nae_ivars
operator|->
name|block_ivars
index|[
name|block
index|]
operator|.
name|port_ivars
index|[
name|port
index|]
operator|)
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|desc
argument_list|,
literal|"XLP NAE Port %d,%d"
argument_list|,
name|block
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|device_set_desc_copy
argument_list|(
name|tmpd
argument_list|,
name|desc
argument_list|)
expr_stmt|;
block|}
name|nlm_setup_iface_fifo_cfg
argument_list|(
name|sc
operator|->
name|base
argument_list|,
name|sc
operator|->
name|max_ports
argument_list|,
name|sc
operator|->
name|portcfg
argument_list|)
expr_stmt|;
name|nlm_setup_rx_base_config
argument_list|(
name|sc
operator|->
name|base
argument_list|,
name|sc
operator|->
name|max_ports
argument_list|,
name|sc
operator|->
name|portcfg
argument_list|)
expr_stmt|;
name|nlm_setup_rx_buf_config
argument_list|(
name|sc
operator|->
name|base
argument_list|,
name|sc
operator|->
name|max_ports
argument_list|,
name|sc
operator|->
name|portcfg
argument_list|)
expr_stmt|;
name|nlm_setup_freein_fifo_cfg
argument_list|(
name|sc
operator|->
name|base
argument_list|,
name|sc
operator|->
name|portcfg
argument_list|)
expr_stmt|;
name|nlm_program_nae_parser_seq_fifo
argument_list|(
name|sc
operator|->
name|base
argument_list|,
name|sc
operator|->
name|max_ports
argument_list|,
name|sc
operator|->
name|portcfg
argument_list|)
expr_stmt|;
name|nlm_xlpnae_print_frin_desc_carving
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|bus_generic_probe
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|bus_generic_attach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* 	 * Enable only boot cpu at this point, full distribution comes 	 * only after SMP is started 	 */
name|nlm_write_poe_reg
argument_list|(
name|sc
operator|->
name|poe_base
argument_list|,
name|POE_DISTR_EN
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|nlm_calc_poe_distvec
argument_list|(
literal|0x1
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0x1
operator|<<
name|XLPGE_RX_VC
argument_list|,
name|dv
argument_list|)
expr_stmt|;
name|nlm_write_poe_distvec
argument_list|(
name|sc
operator|->
name|poedv_base
argument_list|,
literal|0
argument_list|,
name|dv
argument_list|)
expr_stmt|;
name|nlm_write_poe_reg
argument_list|(
name|sc
operator|->
name|poe_base
argument_list|,
name|POE_DISTR_EN
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nlm_xlpnae_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
comment|/*  TODO - free zone here */
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nlm_xlpnae_suspend
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nlm_xlpnae_resume
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nlm_xlpnae_shutdown
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * xlpge driver implementation  */
end_comment

begin_function
specifier|static
name|void
name|nlm_xlpge_mac_set_rx_mode
parameter_list|(
name|struct
name|nlm_xlpge_softc
modifier|*
name|sc
parameter_list|)
block|{
if|if
condition|(
name|sc
operator|->
name|if_flags
operator|&
name|IFF_PROMISC
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|type
operator|==
name|SGMIIC
condition|)
name|nlm_nae_setup_rx_mode_sgmii
argument_list|(
name|sc
operator|->
name|base_addr
argument_list|,
name|sc
operator|->
name|block
argument_list|,
name|sc
operator|->
name|port
argument_list|,
name|sc
operator|->
name|type
argument_list|,
literal|1
comment|/* broadcast */
argument_list|,
literal|1
comment|/* multicast */
argument_list|,
literal|0
comment|/* pause */
argument_list|,
literal|1
comment|/* promisc */
argument_list|)
expr_stmt|;
else|else
name|nlm_nae_setup_rx_mode_xaui
argument_list|(
name|sc
operator|->
name|base_addr
argument_list|,
name|sc
operator|->
name|block
argument_list|,
name|sc
operator|->
name|port
argument_list|,
name|sc
operator|->
name|type
argument_list|,
literal|1
comment|/* broadcast */
argument_list|,
literal|1
comment|/* multicast */
argument_list|,
literal|0
comment|/* pause */
argument_list|,
literal|1
comment|/* promisc */
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|sc
operator|->
name|type
operator|==
name|SGMIIC
condition|)
name|nlm_nae_setup_rx_mode_sgmii
argument_list|(
name|sc
operator|->
name|base_addr
argument_list|,
name|sc
operator|->
name|block
argument_list|,
name|sc
operator|->
name|port
argument_list|,
name|sc
operator|->
name|type
argument_list|,
literal|1
comment|/* broadcast */
argument_list|,
literal|1
comment|/* multicast */
argument_list|,
literal|0
comment|/* pause */
argument_list|,
literal|0
comment|/* promisc */
argument_list|)
expr_stmt|;
else|else
name|nlm_nae_setup_rx_mode_xaui
argument_list|(
name|sc
operator|->
name|base_addr
argument_list|,
name|sc
operator|->
name|block
argument_list|,
name|sc
operator|->
name|port
argument_list|,
name|sc
operator|->
name|type
argument_list|,
literal|1
comment|/* broadcast */
argument_list|,
literal|1
comment|/* multicast */
argument_list|,
literal|0
comment|/* pause */
argument_list|,
literal|0
comment|/* promisc */
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|nlm_xlpge_ioctl
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|u_long
name|command
parameter_list|,
name|caddr_t
name|data
parameter_list|)
block|{
name|struct
name|mii_data
modifier|*
name|mii
decl_stmt|;
name|struct
name|nlm_xlpge_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|ifreq
modifier|*
name|ifr
decl_stmt|;
name|int
name|error
decl_stmt|;
name|sc
operator|=
name|ifp
operator|->
name|if_softc
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
name|ifr
operator|=
operator|(
expr|struct
name|ifreq
operator|*
operator|)
name|data
expr_stmt|;
switch|switch
condition|(
name|command
condition|)
block|{
case|case
name|SIOCSIFFLAGS
case|:
name|XLPGE_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|if_flags
operator|=
name|ifp
operator|->
name|if_flags
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_UP
condition|)
block|{
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
operator|==
literal|0
condition|)
name|nlm_xlpge_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
else|else
name|nlm_xlpge_port_enable
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|nlm_xlpge_mac_set_rx_mode
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|link
operator|=
name|NLM_LINK_UP
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
name|nlm_xlpge_port_disable
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|link
operator|=
name|NLM_LINK_DOWN
expr_stmt|;
block|}
name|XLPGE_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|SIOCGIFMEDIA
case|:
case|case
name|SIOCSIFMEDIA
case|:
if|if
condition|(
name|sc
operator|->
name|mii_bus
operator|!=
name|NULL
condition|)
block|{
name|mii
operator|=
name|device_get_softc
argument_list|(
name|sc
operator|->
name|mii_bus
argument_list|)
expr_stmt|;
name|error
operator|=
name|ifmedia_ioctl
argument_list|(
name|ifp
argument_list|,
name|ifr
argument_list|,
operator|&
name|mii
operator|->
name|mii_media
argument_list|,
name|command
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|error
operator|=
name|ether_ioctl
argument_list|(
name|ifp
argument_list|,
name|command
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|xlpge_tx
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|mbuf
modifier|*
name|mbuf_chain
parameter_list|)
block|{
name|struct
name|nlm_fmn_msg
name|msg
decl_stmt|;
name|struct
name|xlpge_tx_desc
modifier|*
name|p2p
decl_stmt|;
name|struct
name|nlm_xlpge_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|vm_paddr_t
name|paddr
decl_stmt|;
name|int
name|fbid
decl_stmt|,
name|dst
decl_stmt|,
name|pos
decl_stmt|,
name|err
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|,
name|tx_msgstatus
decl_stmt|,
name|retries
decl_stmt|;
name|err
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|mbuf_chain
operator|==
name|NULL
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|sc
operator|=
name|ifp
operator|->
name|if_softc
expr_stmt|;
name|p2p
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
operator|||
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_OACTIVE
condition|)
block|{
name|err
operator|=
name|ENXIO
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
comment|/* free a few in coming messages on the fb vc */
name|xlp_handle_msg_vc
argument_list|(
literal|1
operator|<<
name|XLPGE_FB_VC
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* vfb id table is setup to map cpu to vc 3 of the cpu */
name|fbid
operator|=
name|nlm_cpuid
argument_list|()
expr_stmt|;
name|dst
operator|=
name|sc
operator|->
name|txq
expr_stmt|;
name|pos
operator|=
literal|0
expr_stmt|;
name|p2p
operator|=
name|uma_zalloc
argument_list|(
name|nl_tx_desc_zone
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|p2p
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"alloc fail\n"
argument_list|)
expr_stmt|;
name|err
operator|=
name|ENOBUFS
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
for|for
control|(
name|m
operator|=
name|mbuf_chain
init|;
name|m
operator|!=
name|NULL
condition|;
name|m
operator|=
name|m
operator|->
name|m_next
control|)
block|{
name|vm_offset_t
name|buf
init|=
operator|(
name|vm_offset_t
operator|)
name|m
operator|->
name|m_data
decl_stmt|;
name|int
name|len
init|=
name|m
operator|->
name|m_len
decl_stmt|;
name|int
name|frag_sz
decl_stmt|;
name|uint64_t
name|desc
decl_stmt|;
comment|/*printf("m_data = %p len %d\n", m->m_data, len); */
while|while
condition|(
name|len
condition|)
block|{
if|if
condition|(
name|pos
operator|==
name|XLP_NTXFRAGS
operator|-
literal|3
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|xlpge_dev
argument_list|,
literal|"packet defrag %d\n"
argument_list|,
name|m_length
argument_list|(
name|mbuf_chain
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|ENOBUFS
expr_stmt|;
comment|/* TODO fix error */
goto|goto
name|fail
goto|;
block|}
name|paddr
operator|=
name|vtophys
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|frag_sz
operator|=
name|PAGE_SIZE
operator|-
operator|(
name|buf
operator|&
name|PAGE_MASK
operator|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
name|frag_sz
condition|)
name|frag_sz
operator|=
name|len
expr_stmt|;
name|desc
operator|=
name|nae_tx_desc
argument_list|(
name|P2D_NEOP
argument_list|,
literal|0
argument_list|,
literal|127
argument_list|,
name|frag_sz
argument_list|,
name|paddr
argument_list|)
expr_stmt|;
name|p2p
operator|->
name|frag
index|[
name|pos
index|]
operator|=
name|htobe64
argument_list|(
name|desc
argument_list|)
expr_stmt|;
name|pos
operator|++
expr_stmt|;
name|len
operator|-=
name|frag_sz
expr_stmt|;
name|buf
operator|+=
name|frag_sz
expr_stmt|;
block|}
block|}
name|KASSERT
argument_list|(
name|pos
operator|!=
literal|0
argument_list|,
operator|(
literal|"Zero-length mbuf chain?\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Make the last one P2D EOP */
name|p2p
operator|->
name|frag
index|[
name|pos
operator|-
literal|1
index|]
operator||=
name|htobe64
argument_list|(
operator|(
name|uint64_t
operator|)
name|P2D_EOP
operator|<<
literal|62
argument_list|)
expr_stmt|;
comment|/* stash useful pointers in the desc */
name|p2p
operator|->
name|frag
index|[
name|XLP_NTXFRAGS
operator|-
literal|3
index|]
operator|=
literal|0xf00bad
expr_stmt|;
name|p2p
operator|->
name|frag
index|[
name|XLP_NTXFRAGS
operator|-
literal|2
index|]
operator|=
operator|(
name|uintptr_t
operator|)
name|p2p
expr_stmt|;
name|p2p
operator|->
name|frag
index|[
name|XLP_NTXFRAGS
operator|-
literal|1
index|]
operator|=
operator|(
name|uintptr_t
operator|)
name|mbuf_chain
expr_stmt|;
name|paddr
operator|=
name|vtophys
argument_list|(
name|p2p
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msg
index|[
literal|0
index|]
operator|=
name|nae_tx_desc
argument_list|(
name|P2P
argument_list|,
literal|0
argument_list|,
name|fbid
argument_list|,
name|pos
argument_list|,
name|paddr
argument_list|)
expr_stmt|;
for|for
control|(
name|retries
operator|=
literal|16
init|;
name|retries
operator|>
literal|0
condition|;
name|retries
operator|--
control|)
block|{
name|ret
operator|=
name|nlm_fmn_msgsend
argument_list|(
name|dst
argument_list|,
literal|1
argument_list|,
name|FMN_SWCODE_NAE
argument_list|,
operator|&
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|fail
label|:
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
block|{
name|tx_msgstatus
operator|=
name|nlm_read_c2_txmsgstatus
argument_list|()
expr_stmt|;
if|if
condition|(
operator|(
name|tx_msgstatus
operator|>>
literal|24
operator|)
operator|&
literal|0x1
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|xlpge_dev
argument_list|,
literal|"Transmit queue full - "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|tx_msgstatus
operator|>>
literal|3
operator|)
operator|&
literal|0x1
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|xlpge_dev
argument_list|,
literal|"ECC error - "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|tx_msgstatus
operator|>>
literal|2
operator|)
operator|&
literal|0x1
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|xlpge_dev
argument_list|,
literal|"Pending Sync - "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|tx_msgstatus
operator|>>
literal|1
operator|)
operator|&
literal|0x1
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|xlpge_dev
argument_list|,
literal|"Insufficient input queue credits - "
argument_list|)
expr_stmt|;
if|if
condition|(
name|tx_msgstatus
operator|&
literal|0x1
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|xlpge_dev
argument_list|,
literal|"Insufficient output queue credits - "
argument_list|)
expr_stmt|;
block|}
name|device_printf
argument_list|(
name|sc
operator|->
name|xlpge_dev
argument_list|,
literal|"Send failed! err = %d\n"
argument_list|,
name|err
argument_list|)
expr_stmt|;
if|if
condition|(
name|p2p
condition|)
name|uma_zfree
argument_list|(
name|nl_tx_desc_zone
argument_list|,
name|p2p
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|mbuf_chain
argument_list|)
expr_stmt|;
name|if_inc_counter
argument_list|(
name|ifp
argument_list|,
name|IFCOUNTER_IQDROPS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nlm_xlpge_gmac_config_speed
parameter_list|(
name|struct
name|nlm_xlpge_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|mii_data
modifier|*
name|mii
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|type
operator|==
name|XAUIC
operator|||
name|sc
operator|->
name|type
operator|==
name|ILC
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|sc
operator|->
name|mii_bus
condition|)
block|{
name|mii
operator|=
name|device_get_softc
argument_list|(
name|sc
operator|->
name|mii_bus
argument_list|)
expr_stmt|;
name|mii_pollstat
argument_list|(
name|mii
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|nlm_xlpge_port_disable
parameter_list|(
name|struct
name|nlm_xlpge_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|xlpge_if
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_RUNNING
expr_stmt|;
name|callout_stop
argument_list|(
operator|&
name|sc
operator|->
name|xlpge_callout
argument_list|)
expr_stmt|;
name|nlm_mac_disable
argument_list|(
name|sc
operator|->
name|base_addr
argument_list|,
name|sc
operator|->
name|block
argument_list|,
name|sc
operator|->
name|type
argument_list|,
name|sc
operator|->
name|port
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|nlm_mii_pollstat
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|nlm_xlpge_softc
modifier|*
name|sc
init|=
operator|(
expr|struct
name|nlm_xlpge_softc
operator|*
operator|)
name|arg
decl_stmt|;
name|struct
name|mii_data
modifier|*
name|mii
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|mii_bus
condition|)
block|{
name|mii
operator|=
name|device_get_softc
argument_list|(
name|sc
operator|->
name|mii_bus
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|mii
operator|!=
name|NULL
argument_list|,
operator|(
literal|"mii ptr is NULL"
operator|)
argument_list|)
expr_stmt|;
name|mii_pollstat
argument_list|(
name|mii
argument_list|)
expr_stmt|;
name|callout_reset
argument_list|(
operator|&
name|sc
operator|->
name|xlpge_callout
argument_list|,
name|hz
argument_list|,
name|nlm_mii_pollstat
argument_list|,
name|sc
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|nlm_xlpge_port_enable
parameter_list|(
name|struct
name|nlm_xlpge_softc
modifier|*
name|sc
parameter_list|)
block|{
if|if
condition|(
operator|(
name|sc
operator|->
name|type
operator|!=
name|SGMIIC
operator|)
operator|&&
operator|(
name|sc
operator|->
name|type
operator|!=
name|XAUIC
operator|)
condition|)
return|return;
name|nlm_mac_enable
argument_list|(
name|sc
operator|->
name|base_addr
argument_list|,
name|sc
operator|->
name|block
argument_list|,
name|sc
operator|->
name|type
argument_list|,
name|sc
operator|->
name|port
argument_list|)
expr_stmt|;
name|nlm_mii_pollstat
argument_list|(
operator|(
name|void
operator|*
operator|)
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|nlm_xlpge_init
parameter_list|(
name|void
modifier|*
name|addr
parameter_list|)
block|{
name|struct
name|nlm_xlpge_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|struct
name|mii_data
modifier|*
name|mii
init|=
name|NULL
decl_stmt|;
name|sc
operator|=
operator|(
expr|struct
name|nlm_xlpge_softc
operator|*
operator|)
name|addr
expr_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|xlpge_if
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
return|return;
if|if
condition|(
name|sc
operator|->
name|mii_bus
condition|)
block|{
name|mii
operator|=
name|device_get_softc
argument_list|(
name|sc
operator|->
name|mii_bus
argument_list|)
expr_stmt|;
name|mii_mediachg
argument_list|(
name|mii
argument_list|)
expr_stmt|;
block|}
name|nlm_xlpge_gmac_config_speed
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator||=
name|IFF_DRV_RUNNING
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_OACTIVE
expr_stmt|;
name|nlm_xlpge_port_enable
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* start the callout */
name|callout_reset
argument_list|(
operator|&
name|sc
operator|->
name|xlpge_callout
argument_list|,
name|hz
argument_list|,
name|nlm_mii_pollstat
argument_list|,
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Read the MAC address from FDT or board eeprom.  */
end_comment

begin_function
specifier|static
name|void
name|xlpge_read_mac_addr
parameter_list|(
name|struct
name|nlm_xlpge_softc
modifier|*
name|sc
parameter_list|)
block|{
name|xlpge_get_macaddr
argument_list|(
name|sc
operator|->
name|dev_addr
argument_list|)
expr_stmt|;
comment|/* last octet is port specific */
name|sc
operator|->
name|dev_addr
index|[
literal|5
index|]
operator|+=
operator|(
name|sc
operator|->
name|block
operator|*
literal|4
operator|)
operator|+
name|sc
operator|->
name|port
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|type
operator|==
name|SGMIIC
condition|)
name|nlm_nae_setup_mac_addr_sgmii
argument_list|(
name|sc
operator|->
name|base_addr
argument_list|,
name|sc
operator|->
name|block
argument_list|,
name|sc
operator|->
name|port
argument_list|,
name|sc
operator|->
name|type
argument_list|,
name|sc
operator|->
name|dev_addr
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|sc
operator|->
name|type
operator|==
name|XAUIC
condition|)
name|nlm_nae_setup_mac_addr_xaui
argument_list|(
name|sc
operator|->
name|base_addr
argument_list|,
name|sc
operator|->
name|block
argument_list|,
name|sc
operator|->
name|port
argument_list|,
name|sc
operator|->
name|type
argument_list|,
name|sc
operator|->
name|dev_addr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|xlpge_mediachange
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|xlpge_mediastatus
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|ifmediareq
modifier|*
name|ifmr
parameter_list|)
block|{
name|struct
name|nlm_xlpge_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|mii_data
modifier|*
name|md
decl_stmt|;
name|md
operator|=
name|NULL
expr_stmt|;
name|sc
operator|=
name|ifp
operator|->
name|if_softc
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|mii_bus
condition|)
name|md
operator|=
name|device_get_softc
argument_list|(
name|sc
operator|->
name|mii_bus
argument_list|)
expr_stmt|;
name|ifmr
operator|->
name|ifm_status
operator|=
name|IFM_AVALID
expr_stmt|;
name|ifmr
operator|->
name|ifm_active
operator|=
name|IFM_ETHER
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|link
operator|==
name|NLM_LINK_DOWN
condition|)
return|return;
if|if
condition|(
name|md
operator|!=
name|NULL
condition|)
name|ifmr
operator|->
name|ifm_active
operator|=
name|md
operator|->
name|mii_media
operator|.
name|ifm_cur
operator|->
name|ifm_media
expr_stmt|;
name|ifmr
operator|->
name|ifm_status
operator||=
name|IFM_ACTIVE
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|nlm_xlpge_ifinit
parameter_list|(
name|struct
name|nlm_xlpge_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|device_t
name|dev
decl_stmt|;
name|int
name|port
init|=
name|sc
operator|->
name|block
operator|*
literal|4
operator|+
name|sc
operator|->
name|port
decl_stmt|;
name|dev
operator|=
name|sc
operator|->
name|xlpge_dev
expr_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|xlpge_if
operator|=
name|if_alloc
argument_list|(
name|IFT_ETHER
argument_list|)
expr_stmt|;
comment|/*(sc->network_sc)->ifp_ports[port].xlpge_if = ifp;*/
name|ifp_ports
index|[
name|port
index|]
operator|.
name|xlpge_if
operator|=
name|ifp
expr_stmt|;
if|if
condition|(
name|ifp
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"cannot if_alloc()\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOSPC
operator|)
return|;
block|}
name|ifp
operator|->
name|if_softc
operator|=
name|sc
expr_stmt|;
name|if_initname
argument_list|(
name|ifp
argument_list|,
name|device_get_name
argument_list|(
name|dev
argument_list|)
argument_list|,
name|device_get_unit
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_flags
operator|=
name|IFF_BROADCAST
operator||
name|IFF_SIMPLEX
operator||
name|IFF_MULTICAST
expr_stmt|;
name|sc
operator|->
name|if_flags
operator|=
name|ifp
operator|->
name|if_flags
expr_stmt|;
comment|/*ifp->if_capabilities = IFCAP_TXCSUM | IFCAP_VLAN_HWTAGGING;*/
name|ifp
operator|->
name|if_capabilities
operator|=
literal|0
expr_stmt|;
name|ifp
operator|->
name|if_capenable
operator|=
name|ifp
operator|->
name|if_capabilities
expr_stmt|;
name|ifp
operator|->
name|if_ioctl
operator|=
name|nlm_xlpge_ioctl
expr_stmt|;
name|ifp
operator|->
name|if_init
operator|=
name|nlm_xlpge_init
expr_stmt|;
name|ifp
operator|->
name|if_hwassist
operator|=
literal|0
expr_stmt|;
name|ifp
operator|->
name|if_snd
operator|.
name|ifq_drv_maxlen
operator|=
name|NLM_XLPGE_TXQ_SIZE
expr_stmt|;
comment|/* TODO: make this a sysint */
name|IFQ_SET_MAXLEN
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|,
name|ifp
operator|->
name|if_snd
operator|.
name|ifq_drv_maxlen
argument_list|)
expr_stmt|;
name|IFQ_SET_READY
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|)
expr_stmt|;
name|ifmedia_init
argument_list|(
operator|&
name|sc
operator|->
name|xlpge_mii
operator|.
name|mii_media
argument_list|,
literal|0
argument_list|,
name|xlpge_mediachange
argument_list|,
name|xlpge_mediastatus
argument_list|)
expr_stmt|;
name|ifmedia_add
argument_list|(
operator|&
name|sc
operator|->
name|xlpge_mii
operator|.
name|mii_media
argument_list|,
name|IFM_ETHER
operator||
name|IFM_AUTO
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ifmedia_set
argument_list|(
operator|&
name|sc
operator|->
name|xlpge_mii
operator|.
name|mii_media
argument_list|,
name|IFM_ETHER
operator||
name|IFM_AUTO
argument_list|)
expr_stmt|;
name|sc
operator|->
name|xlpge_mii
operator|.
name|mii_media
operator|.
name|ifm_media
operator|=
name|sc
operator|->
name|xlpge_mii
operator|.
name|mii_media
operator|.
name|ifm_cur
operator|->
name|ifm_media
expr_stmt|;
name|xlpge_read_mac_addr
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ether_ifattach
argument_list|(
name|ifp
argument_list|,
name|sc
operator|->
name|dev_addr
argument_list|)
expr_stmt|;
comment|/* override if_transmit : per ifnet(9), do it after if_attach */
name|ifp
operator|->
name|if_transmit
operator|=
name|xlpge_tx
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nlm_xlpge_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
return|return
operator|(
name|BUS_PROBE_DEFAULT
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|get_buf
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|mbuf
modifier|*
name|m_new
decl_stmt|;
name|uint64_t
modifier|*
name|md
decl_stmt|;
ifdef|#
directive|ifdef
name|INVARIANTS
name|vm_paddr_t
name|temp1
decl_stmt|,
name|temp2
decl_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|(
name|m_new
operator|=
name|m_getcl
argument_list|(
name|M_NOWAIT
argument_list|,
name|MT_DATA
argument_list|,
name|M_PKTHDR
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|m_new
operator|->
name|m_len
operator|=
name|m_new
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|MCLBYTES
expr_stmt|;
name|KASSERT
argument_list|(
operator|(
operator|(
name|uintptr_t
operator|)
name|m_new
operator|->
name|m_data
operator|&
operator|(
name|NAE_CACHELINE_SIZE
operator|-
literal|1
operator|)
operator|)
operator|==
literal|0
argument_list|,
operator|(
literal|"m_new->m_data is not cacheline aligned"
operator|)
argument_list|)
expr_stmt|;
name|md
operator|=
operator|(
name|uint64_t
operator|*
operator|)
name|m_new
operator|->
name|m_data
expr_stmt|;
name|md
index|[
literal|0
index|]
operator|=
operator|(
name|intptr_t
operator|)
name|m_new
expr_stmt|;
comment|/* Back Ptr */
name|md
index|[
literal|1
index|]
operator|=
literal|0xf00bad
expr_stmt|;
name|m_adj
argument_list|(
name|m_new
argument_list|,
name|NAE_CACHELINE_SIZE
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|INVARIANTS
name|temp1
operator|=
name|vtophys
argument_list|(
operator|(
name|vm_offset_t
operator|)
name|m_new
operator|->
name|m_data
argument_list|)
expr_stmt|;
name|temp2
operator|=
name|vtophys
argument_list|(
operator|(
name|vm_offset_t
operator|)
name|m_new
operator|->
name|m_data
operator|+
literal|1536
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
operator|(
name|temp1
operator|+
literal|1536
operator|)
operator|==
name|temp2
argument_list|,
operator|(
literal|"Alloced buffer is not contiguous"
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
operator|(
name|void
operator|*
operator|)
name|m_new
operator|->
name|m_data
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|nlm_xlpge_mii_init
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|struct
name|nlm_xlpge_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
name|error
operator|=
name|mii_attach
argument_list|(
name|dev
argument_list|,
operator|&
name|sc
operator|->
name|mii_bus
argument_list|,
name|sc
operator|->
name|xlpge_if
argument_list|,
name|xlpge_mediachange
argument_list|,
name|xlpge_mediastatus
argument_list|,
name|BMSR_DEFCAPMASK
argument_list|,
name|sc
operator|->
name|phy_addr
argument_list|,
name|MII_OFFSET_ANY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"attaching PHYs failed\n"
argument_list|)
expr_stmt|;
name|sc
operator|->
name|mii_bus
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|mii_bus
operator|!=
name|NULL
condition|)
block|{
comment|/* enable MDIO interrupts in the PHY */
comment|/* XXXJC: TODO */
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|xlpge_stats_sysctl
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|struct
name|nlm_xlpge_softc
modifier|*
name|sc
decl_stmt|;
name|uint32_t
name|val
decl_stmt|;
name|int
name|reg
decl_stmt|,
name|field
decl_stmt|;
name|sc
operator|=
name|arg1
expr_stmt|;
name|field
operator|=
name|arg2
expr_stmt|;
name|reg
operator|=
name|SGMII_STATS_MLR
argument_list|(
name|sc
operator|->
name|block
argument_list|,
name|sc
operator|->
name|port
argument_list|)
operator|+
name|field
expr_stmt|;
name|val
operator|=
name|nlm_read_nae_reg
argument_list|(
name|sc
operator|->
name|base_addr
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
operator|(
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|val
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|nlm_xlpge_setup_stats_sysctl
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|struct
name|nlm_xlpge_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|sysctl_ctx_list
modifier|*
name|ctx
decl_stmt|;
name|struct
name|sysctl_oid_list
modifier|*
name|child
decl_stmt|;
name|struct
name|sysctl_oid
modifier|*
name|tree
decl_stmt|;
name|ctx
operator|=
name|device_get_sysctl_ctx
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|tree
operator|=
name|device_get_sysctl_tree
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|child
operator|=
name|SYSCTL_CHILDREN
argument_list|(
name|tree
argument_list|)
expr_stmt|;
define|#
directive|define
name|XLPGE_STAT
parameter_list|(
name|name
parameter_list|,
name|offset
parameter_list|,
name|desc
parameter_list|)
define|\
value|SYSCTL_ADD_PROC(ctx, child, OID_AUTO, name,	\ 	    CTLTYPE_UINT | CTLFLAG_RD, sc, offset,	\ 	    xlpge_stats_sysctl, "IU", desc)
name|XLPGE_STAT
argument_list|(
literal|"tr127"
argument_list|,
name|nlm_sgmii_stats_tr127
argument_list|,
literal|"TxRx 64 - 127 Bytes"
argument_list|)
expr_stmt|;
name|XLPGE_STAT
argument_list|(
literal|"tr255"
argument_list|,
name|nlm_sgmii_stats_tr255
argument_list|,
literal|"TxRx 128 - 255 Bytes"
argument_list|)
expr_stmt|;
name|XLPGE_STAT
argument_list|(
literal|"tr511"
argument_list|,
name|nlm_sgmii_stats_tr511
argument_list|,
literal|"TxRx 256 - 511 Bytes"
argument_list|)
expr_stmt|;
name|XLPGE_STAT
argument_list|(
literal|"tr1k"
argument_list|,
name|nlm_sgmii_stats_tr1k
argument_list|,
literal|"TxRx 512 - 1023 Bytes"
argument_list|)
expr_stmt|;
name|XLPGE_STAT
argument_list|(
literal|"trmax"
argument_list|,
name|nlm_sgmii_stats_trmax
argument_list|,
literal|"TxRx 1024 - 1518 Bytes"
argument_list|)
expr_stmt|;
name|XLPGE_STAT
argument_list|(
literal|"trmgv"
argument_list|,
name|nlm_sgmii_stats_trmgv
argument_list|,
literal|"TxRx 1519 - 1522 Bytes"
argument_list|)
expr_stmt|;
name|XLPGE_STAT
argument_list|(
literal|"rbyt"
argument_list|,
name|nlm_sgmii_stats_rbyt
argument_list|,
literal|"Rx Bytes"
argument_list|)
expr_stmt|;
name|XLPGE_STAT
argument_list|(
literal|"rpkt"
argument_list|,
name|nlm_sgmii_stats_rpkt
argument_list|,
literal|"Rx Packets"
argument_list|)
expr_stmt|;
name|XLPGE_STAT
argument_list|(
literal|"rfcs"
argument_list|,
name|nlm_sgmii_stats_rfcs
argument_list|,
literal|"Rx FCS Error"
argument_list|)
expr_stmt|;
name|XLPGE_STAT
argument_list|(
literal|"rmca"
argument_list|,
name|nlm_sgmii_stats_rmca
argument_list|,
literal|"Rx Multicast Packets"
argument_list|)
expr_stmt|;
name|XLPGE_STAT
argument_list|(
literal|"rbca"
argument_list|,
name|nlm_sgmii_stats_rbca
argument_list|,
literal|"Rx Broadcast Packets"
argument_list|)
expr_stmt|;
name|XLPGE_STAT
argument_list|(
literal|"rxcf"
argument_list|,
name|nlm_sgmii_stats_rxcf
argument_list|,
literal|"Rx Control Frames"
argument_list|)
expr_stmt|;
name|XLPGE_STAT
argument_list|(
literal|"rxpf"
argument_list|,
name|nlm_sgmii_stats_rxpf
argument_list|,
literal|"Rx Pause Frames"
argument_list|)
expr_stmt|;
name|XLPGE_STAT
argument_list|(
literal|"rxuo"
argument_list|,
name|nlm_sgmii_stats_rxuo
argument_list|,
literal|"Rx Unknown Opcode"
argument_list|)
expr_stmt|;
name|XLPGE_STAT
argument_list|(
literal|"raln"
argument_list|,
name|nlm_sgmii_stats_raln
argument_list|,
literal|"Rx Alignment Errors"
argument_list|)
expr_stmt|;
name|XLPGE_STAT
argument_list|(
literal|"rflr"
argument_list|,
name|nlm_sgmii_stats_rflr
argument_list|,
literal|"Rx Framelength Errors"
argument_list|)
expr_stmt|;
name|XLPGE_STAT
argument_list|(
literal|"rcde"
argument_list|,
name|nlm_sgmii_stats_rcde
argument_list|,
literal|"Rx Code Errors"
argument_list|)
expr_stmt|;
name|XLPGE_STAT
argument_list|(
literal|"rcse"
argument_list|,
name|nlm_sgmii_stats_rcse
argument_list|,
literal|"Rx Carrier Sense Errors"
argument_list|)
expr_stmt|;
name|XLPGE_STAT
argument_list|(
literal|"rund"
argument_list|,
name|nlm_sgmii_stats_rund
argument_list|,
literal|"Rx Undersize Packet Errors"
argument_list|)
expr_stmt|;
name|XLPGE_STAT
argument_list|(
literal|"rovr"
argument_list|,
name|nlm_sgmii_stats_rovr
argument_list|,
literal|"Rx Oversize Packet Errors"
argument_list|)
expr_stmt|;
name|XLPGE_STAT
argument_list|(
literal|"rfrg"
argument_list|,
name|nlm_sgmii_stats_rfrg
argument_list|,
literal|"Rx Fragments"
argument_list|)
expr_stmt|;
name|XLPGE_STAT
argument_list|(
literal|"rjbr"
argument_list|,
name|nlm_sgmii_stats_rjbr
argument_list|,
literal|"Rx Jabber"
argument_list|)
expr_stmt|;
name|XLPGE_STAT
argument_list|(
literal|"tbyt"
argument_list|,
name|nlm_sgmii_stats_tbyt
argument_list|,
literal|"Tx Bytes"
argument_list|)
expr_stmt|;
name|XLPGE_STAT
argument_list|(
literal|"tpkt"
argument_list|,
name|nlm_sgmii_stats_tpkt
argument_list|,
literal|"Tx Packets"
argument_list|)
expr_stmt|;
name|XLPGE_STAT
argument_list|(
literal|"tmca"
argument_list|,
name|nlm_sgmii_stats_tmca
argument_list|,
literal|"Tx Multicast Packets"
argument_list|)
expr_stmt|;
name|XLPGE_STAT
argument_list|(
literal|"tbca"
argument_list|,
name|nlm_sgmii_stats_tbca
argument_list|,
literal|"Tx Broadcast Packets"
argument_list|)
expr_stmt|;
name|XLPGE_STAT
argument_list|(
literal|"txpf"
argument_list|,
name|nlm_sgmii_stats_txpf
argument_list|,
literal|"Tx Pause Frame"
argument_list|)
expr_stmt|;
name|XLPGE_STAT
argument_list|(
literal|"tdfr"
argument_list|,
name|nlm_sgmii_stats_tdfr
argument_list|,
literal|"Tx Deferral Packets"
argument_list|)
expr_stmt|;
name|XLPGE_STAT
argument_list|(
literal|"tedf"
argument_list|,
name|nlm_sgmii_stats_tedf
argument_list|,
literal|"Tx Excessive Deferral Pkts"
argument_list|)
expr_stmt|;
name|XLPGE_STAT
argument_list|(
literal|"tscl"
argument_list|,
name|nlm_sgmii_stats_tscl
argument_list|,
literal|"Tx Single Collisions"
argument_list|)
expr_stmt|;
name|XLPGE_STAT
argument_list|(
literal|"tmcl"
argument_list|,
name|nlm_sgmii_stats_tmcl
argument_list|,
literal|"Tx Multiple Collisions"
argument_list|)
expr_stmt|;
name|XLPGE_STAT
argument_list|(
literal|"tlcl"
argument_list|,
name|nlm_sgmii_stats_tlcl
argument_list|,
literal|"Tx Late Collision Pkts"
argument_list|)
expr_stmt|;
name|XLPGE_STAT
argument_list|(
literal|"txcl"
argument_list|,
name|nlm_sgmii_stats_txcl
argument_list|,
literal|"Tx Excessive Collisions"
argument_list|)
expr_stmt|;
name|XLPGE_STAT
argument_list|(
literal|"tncl"
argument_list|,
name|nlm_sgmii_stats_tncl
argument_list|,
literal|"Tx Total Collisions"
argument_list|)
expr_stmt|;
name|XLPGE_STAT
argument_list|(
literal|"tjbr"
argument_list|,
name|nlm_sgmii_stats_tjbr
argument_list|,
literal|"Tx Jabber Frames"
argument_list|)
expr_stmt|;
name|XLPGE_STAT
argument_list|(
literal|"tfcs"
argument_list|,
name|nlm_sgmii_stats_tfcs
argument_list|,
literal|"Tx FCS Errors"
argument_list|)
expr_stmt|;
name|XLPGE_STAT
argument_list|(
literal|"txcf"
argument_list|,
name|nlm_sgmii_stats_txcf
argument_list|,
literal|"Tx Control Frames"
argument_list|)
expr_stmt|;
name|XLPGE_STAT
argument_list|(
literal|"tovr"
argument_list|,
name|nlm_sgmii_stats_tovr
argument_list|,
literal|"Tx Oversize Frames"
argument_list|)
expr_stmt|;
name|XLPGE_STAT
argument_list|(
literal|"tund"
argument_list|,
name|nlm_sgmii_stats_tund
argument_list|,
literal|"Tx Undersize Frames"
argument_list|)
expr_stmt|;
name|XLPGE_STAT
argument_list|(
literal|"tfrg"
argument_list|,
name|nlm_sgmii_stats_tfrg
argument_list|,
literal|"Tx Fragments"
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|XLPGE_STAT
block|}
end_function

begin_function
specifier|static
name|int
name|nlm_xlpge_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|xlp_port_ivars
modifier|*
name|pv
decl_stmt|;
name|struct
name|nlm_xlpge_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|port
decl_stmt|;
name|pv
operator|=
name|device_get_ivars
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sc
operator|->
name|xlpge_dev
operator|=
name|dev
expr_stmt|;
name|sc
operator|->
name|mii_bus
operator|=
name|NULL
expr_stmt|;
name|sc
operator|->
name|block
operator|=
name|pv
operator|->
name|block
expr_stmt|;
name|sc
operator|->
name|node
operator|=
name|pv
operator|->
name|node
expr_stmt|;
name|sc
operator|->
name|port
operator|=
name|pv
operator|->
name|port
expr_stmt|;
name|sc
operator|->
name|type
operator|=
name|pv
operator|->
name|type
expr_stmt|;
name|sc
operator|->
name|xlpge_if
operator|=
name|NULL
expr_stmt|;
name|sc
operator|->
name|phy_addr
operator|=
name|pv
operator|->
name|phy_addr
expr_stmt|;
name|sc
operator|->
name|mdio_bus
operator|=
name|pv
operator|->
name|mdio_bus
expr_stmt|;
name|sc
operator|->
name|portcfg
operator|=
name|nae_port_config
expr_stmt|;
name|sc
operator|->
name|hw_parser_en
operator|=
name|pv
operator|->
name|hw_parser_en
expr_stmt|;
comment|/* default settings */
name|sc
operator|->
name|speed
operator|=
name|NLM_SGMII_SPEED_10
expr_stmt|;
name|sc
operator|->
name|duplexity
operator|=
name|NLM_SGMII_DUPLEX_FULL
expr_stmt|;
name|sc
operator|->
name|link
operator|=
name|NLM_LINK_DOWN
expr_stmt|;
name|sc
operator|->
name|flowctrl
operator|=
name|NLM_FLOWCTRL_DISABLED
expr_stmt|;
name|sc
operator|->
name|network_sc
operator|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|base_addr
operator|=
name|sc
operator|->
name|network_sc
operator|->
name|base
expr_stmt|;
name|sc
operator|->
name|prepad_en
operator|=
name|sc
operator|->
name|network_sc
operator|->
name|prepad_en
expr_stmt|;
name|sc
operator|->
name|prepad_size
operator|=
name|sc
operator|->
name|network_sc
operator|->
name|prepad_size
expr_stmt|;
name|callout_init
argument_list|(
operator|&
name|sc
operator|->
name|xlpge_callout
argument_list|,
name|CALLOUT_MPSAFE
argument_list|)
expr_stmt|;
name|XLPGE_LOCK_INIT
argument_list|(
name|sc
argument_list|,
name|device_get_nameunit
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
name|port
operator|=
operator|(
name|sc
operator|->
name|block
operator|*
literal|4
operator|)
operator|+
name|sc
operator|->
name|port
expr_stmt|;
name|sc
operator|->
name|nfree_desc
operator|=
name|nae_port_config
index|[
name|port
index|]
operator|.
name|num_free_descs
expr_stmt|;
name|sc
operator|->
name|txq
operator|=
name|nae_port_config
index|[
name|port
index|]
operator|.
name|txq
expr_stmt|;
name|sc
operator|->
name|rxfreeq
operator|=
name|nae_port_config
index|[
name|port
index|]
operator|.
name|rxfreeq
expr_stmt|;
name|nlm_xlpge_submit_rx_free_desc
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|nfree_desc
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|hw_parser_en
condition|)
name|nlm_enable_hardware_parser_per_port
argument_list|(
name|sc
operator|->
name|base_addr
argument_list|,
name|sc
operator|->
name|block
argument_list|,
name|sc
operator|->
name|port
argument_list|)
expr_stmt|;
name|nlm_xlpge_ifinit
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ifp_ports
index|[
name|port
index|]
operator|.
name|xlpge_sc
operator|=
name|sc
expr_stmt|;
name|nlm_xlpge_mii_init
argument_list|(
name|dev
argument_list|,
name|sc
argument_list|)
expr_stmt|;
name|nlm_xlpge_setup_stats_sysctl
argument_list|(
name|dev
argument_list|,
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nlm_xlpge_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nlm_xlpge_suspend
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nlm_xlpge_resume
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nlm_xlpge_shutdown
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * miibus function with custom implementation  */
end_comment

begin_function
specifier|static
name|int
name|nlm_xlpge_mii_read
parameter_list|(
name|struct
name|device
modifier|*
name|dev
parameter_list|,
name|int
name|phyaddr
parameter_list|,
name|int
name|regidx
parameter_list|)
block|{
name|struct
name|nlm_xlpge_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|val
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|type
operator|==
name|SGMIIC
condition|)
name|val
operator|=
name|nlm_gmac_mdio_read
argument_list|(
name|sc
operator|->
name|base_addr
argument_list|,
name|sc
operator|->
name|mdio_bus
argument_list|,
name|BLOCK_7
argument_list|,
name|LANE_CFG
argument_list|,
name|phyaddr
argument_list|,
name|regidx
argument_list|)
expr_stmt|;
else|else
name|val
operator|=
literal|0xffff
expr_stmt|;
return|return
operator|(
name|val
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nlm_xlpge_mii_write
parameter_list|(
name|struct
name|device
modifier|*
name|dev
parameter_list|,
name|int
name|phyaddr
parameter_list|,
name|int
name|regidx
parameter_list|,
name|int
name|val
parameter_list|)
block|{
name|struct
name|nlm_xlpge_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|type
operator|==
name|SGMIIC
condition|)
name|nlm_gmac_mdio_write
argument_list|(
name|sc
operator|->
name|base_addr
argument_list|,
name|sc
operator|->
name|mdio_bus
argument_list|,
name|BLOCK_7
argument_list|,
name|LANE_CFG
argument_list|,
name|phyaddr
argument_list|,
name|regidx
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|nlm_xlpge_mii_statchg
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|nlm_xlpge_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|mii_data
modifier|*
name|mii
decl_stmt|;
name|char
modifier|*
name|speed
decl_stmt|,
modifier|*
name|duplexity
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|mii_bus
operator|==
name|NULL
condition|)
return|return;
name|mii
operator|=
name|device_get_softc
argument_list|(
name|sc
operator|->
name|mii_bus
argument_list|)
expr_stmt|;
if|if
condition|(
name|mii
operator|->
name|mii_media_status
operator|&
name|IFM_ACTIVE
condition|)
block|{
if|if
condition|(
name|IFM_SUBTYPE
argument_list|(
name|mii
operator|->
name|mii_media_active
argument_list|)
operator|==
name|IFM_10_T
condition|)
block|{
name|sc
operator|->
name|speed
operator|=
name|NLM_SGMII_SPEED_10
expr_stmt|;
name|speed
operator|=
literal|"10Mbps"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|IFM_SUBTYPE
argument_list|(
name|mii
operator|->
name|mii_media_active
argument_list|)
operator|==
name|IFM_100_TX
condition|)
block|{
name|sc
operator|->
name|speed
operator|=
name|NLM_SGMII_SPEED_100
expr_stmt|;
name|speed
operator|=
literal|"100Mbps"
expr_stmt|;
block|}
else|else
block|{
comment|/* default to 1G */
name|sc
operator|->
name|speed
operator|=
name|NLM_SGMII_SPEED_1000
expr_stmt|;
name|speed
operator|=
literal|"1Gbps"
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|mii
operator|->
name|mii_media_active
operator|&
name|IFM_GMASK
operator|)
operator|==
name|IFM_FDX
condition|)
block|{
name|sc
operator|->
name|duplexity
operator|=
name|NLM_SGMII_DUPLEX_FULL
expr_stmt|;
name|duplexity
operator|=
literal|"full"
expr_stmt|;
block|}
else|else
block|{
name|sc
operator|->
name|duplexity
operator|=
name|NLM_SGMII_DUPLEX_HALF
expr_stmt|;
name|duplexity
operator|=
literal|"half"
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Port [%d, %d] setup with speed=%s duplex=%s\n"
argument_list|,
name|sc
operator|->
name|block
argument_list|,
name|sc
operator|->
name|port
argument_list|,
name|speed
argument_list|,
name|duplexity
argument_list|)
expr_stmt|;
name|nlm_nae_setup_mac
argument_list|(
name|sc
operator|->
name|base_addr
argument_list|,
name|sc
operator|->
name|block
argument_list|,
name|sc
operator|->
name|port
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|sc
operator|->
name|speed
argument_list|,
name|sc
operator|->
name|duplexity
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * xlpge support function implementations  */
end_comment

begin_function
specifier|static
name|void
name|nlm_xlpge_release_mbuf
parameter_list|(
name|uint64_t
name|paddr
parameter_list|)
block|{
name|uint64_t
name|mag
decl_stmt|,
name|desc
decl_stmt|,
name|mbuf
decl_stmt|;
name|paddr
operator|+=
operator|(
name|XLP_NTXFRAGS
operator|-
literal|3
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
expr_stmt|;
name|mag
operator|=
name|nlm_paddr_ld
argument_list|(
name|paddr
argument_list|)
expr_stmt|;
name|desc
operator|=
name|nlm_paddr_ld
argument_list|(
name|paddr
operator|+
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
argument_list|)
expr_stmt|;
name|mbuf
operator|=
name|nlm_paddr_ld
argument_list|(
name|paddr
operator|+
literal|2
operator|*
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|mag
operator|!=
literal|0xf00bad
condition|)
block|{
comment|/* somebody else packet Error - FIXME in intialization */
name|printf
argument_list|(
literal|"cpu %d: ERR Tx packet paddr %jx, mag %jx, desc %jx mbuf %jx\n"
argument_list|,
name|nlm_cpuid
argument_list|()
argument_list|,
operator|(
name|uintmax_t
operator|)
name|paddr
argument_list|,
operator|(
name|uintmax_t
operator|)
name|mag
argument_list|,
operator|(
name|intmax_t
operator|)
name|desc
argument_list|,
operator|(
name|uintmax_t
operator|)
name|mbuf
argument_list|)
expr_stmt|;
return|return;
block|}
name|m_freem
argument_list|(
operator|(
expr|struct
name|mbuf
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|mbuf
argument_list|)
expr_stmt|;
name|uma_zfree
argument_list|(
name|nl_tx_desc_zone
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|desc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|nlm_xlpge_rx
parameter_list|(
name|struct
name|nlm_xlpge_softc
modifier|*
name|sc
parameter_list|,
name|int
name|port
parameter_list|,
name|vm_paddr_t
name|paddr
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|vm_offset_t
name|temp
decl_stmt|;
name|unsigned
name|long
name|mag
decl_stmt|;
name|int
name|prepad_size
decl_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|xlpge_if
expr_stmt|;
name|temp
operator|=
name|nlm_paddr_ld
argument_list|(
name|paddr
operator|-
name|NAE_CACHELINE_SIZE
argument_list|)
expr_stmt|;
name|mag
operator|=
name|nlm_paddr_ld
argument_list|(
name|paddr
operator|-
name|NAE_CACHELINE_SIZE
operator|+
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
argument_list|)
expr_stmt|;
name|m
operator|=
operator|(
expr|struct
name|mbuf
operator|*
operator|)
operator|(
name|intptr_t
operator|)
name|temp
expr_stmt|;
if|if
condition|(
name|mag
operator|!=
literal|0xf00bad
condition|)
block|{
comment|/* somebody else packet Error - FIXME in intialization */
name|printf
argument_list|(
literal|"cpu %d: ERR Rx packet paddr %jx, temp %p, mag %lx\n"
argument_list|,
name|nlm_cpuid
argument_list|()
argument_list|,
operator|(
name|uintmax_t
operator|)
name|paddr
argument_list|,
operator|(
name|void
operator|*
operator|)
name|temp
argument_list|,
name|mag
argument_list|)
expr_stmt|;
return|return;
block|}
name|m
operator|->
name|m_pkthdr
operator|.
name|rcvif
operator|=
name|ifp
expr_stmt|;
ifdef|#
directive|ifdef
name|DUMP_PACKET
block|{
name|int
name|i
init|=
literal|0
decl_stmt|,
name|j
init|=
literal|64
decl_stmt|;
name|unsigned
name|char
modifier|*
name|buf
init|=
operator|(
name|char
operator|*
operator|)
name|m
operator|->
name|m_data
decl_stmt|;
name|printf
argument_list|(
literal|"(cpu_%d: nlge_rx, !RX_COPY) Rx Packet: length=%d\n"
argument_list|,
name|nlm_cpuid
argument_list|()
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
name|j
condition|)
name|j
operator|=
name|len
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|prepad_en
condition|)
name|j
operator|+=
operator|(
operator|(
name|sc
operator|->
name|prepad_size
operator|+
literal|1
operator|)
operator|*
literal|16
operator|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|j
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|&&
operator|(
name|i
operator|%
literal|16
operator|)
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%02x "
argument_list|,
name|buf
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|sc
operator|->
name|prepad_en
condition|)
block|{
name|prepad_size
operator|=
operator|(
operator|(
name|sc
operator|->
name|prepad_size
operator|+
literal|1
operator|)
operator|*
literal|16
operator|)
expr_stmt|;
name|m
operator|->
name|m_data
operator|+=
name|prepad_size
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|m
operator|->
name|m_len
operator|=
operator|(
name|len
operator|-
name|prepad_size
operator|)
expr_stmt|;
block|}
else|else
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|m
operator|->
name|m_len
operator|=
name|len
expr_stmt|;
name|if_inc_counter
argument_list|(
name|ifp
argument_list|,
name|IFCOUNTER_IPACKETS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|XLP_DRIVER_LOOPBACK
if|if
condition|(
name|port
operator|==
literal|16
operator|||
name|port
operator|==
literal|17
condition|)
call|(
modifier|*
name|ifp
operator|->
name|if_input
call|)
argument_list|(
name|ifp
argument_list|,
name|m
argument_list|)
expr_stmt|;
else|else
name|xlpge_tx
argument_list|(
name|ifp
argument_list|,
name|m
argument_list|)
expr_stmt|;
else|#
directive|else
call|(
modifier|*
name|ifp
operator|->
name|if_input
call|)
argument_list|(
name|ifp
argument_list|,
name|m
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_function
name|void
name|nlm_xlpge_submit_rx_free_desc
parameter_list|(
name|struct
name|nlm_xlpge_softc
modifier|*
name|sc
parameter_list|,
name|int
name|num
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|size
decl_stmt|,
name|ret
decl_stmt|,
name|n
decl_stmt|;
name|struct
name|nlm_fmn_msg
name|msg
decl_stmt|;
name|void
modifier|*
name|ptr
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num
condition|;
name|i
operator|++
control|)
block|{
name|memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|ptr
operator|=
name|get_buf
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|ptr
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|xlpge_dev
argument_list|,
literal|"Cannot allocate mbuf\n"
argument_list|)
expr_stmt|;
break|break;
block|}
name|msg
operator|.
name|msg
index|[
literal|0
index|]
operator|=
name|vtophys
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|.
name|msg
index|[
literal|0
index|]
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Bad ptr for %p\n"
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
break|break;
block|}
name|size
operator|=
literal|1
expr_stmt|;
name|n
operator|=
literal|0
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
comment|/* on success returns 1, else 0 */
name|ret
operator|=
name|nlm_fmn_msgsend
argument_list|(
name|sc
operator|->
name|rxfreeq
argument_list|,
name|size
argument_list|,
literal|0
argument_list|,
operator|&
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
name|n
operator|++
operator|>
literal|10000
condition|)
block|{
name|printf
argument_list|(
literal|"Too many credit fails for send free desc\n"
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
block|}
end_function

begin_function
name|void
name|nlm_xlpge_msgring_handler
parameter_list|(
name|int
name|vc
parameter_list|,
name|int
name|size
parameter_list|,
name|int
name|code
parameter_list|,
name|int
name|src_id
parameter_list|,
name|struct
name|nlm_fmn_msg
modifier|*
name|msg
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|uint64_t
name|phys_addr
decl_stmt|;
name|struct
name|nlm_xlpnae_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|nlm_xlpge_softc
modifier|*
name|xlpge_sc
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|uint32_t
name|context
decl_stmt|;
name|uint32_t
name|port
init|=
literal|0
decl_stmt|;
name|uint32_t
name|length
decl_stmt|;
name|sc
operator|=
operator|(
expr|struct
name|nlm_xlpnae_softc
operator|*
operator|)
name|data
expr_stmt|;
name|KASSERT
argument_list|(
name|sc
operator|!=
name|NULL
argument_list|,
operator|(
literal|"Null sc in msgring handler"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|size
operator|==
literal|1
condition|)
block|{
comment|/* process transmit complete */
name|phys_addr
operator|=
name|msg
operator|->
name|msg
index|[
literal|0
index|]
operator|&
literal|0xffffffffffULL
expr_stmt|;
comment|/* context is SGMII_RCV_CONTEXT_NUM + three bit vlan type 		 * or vlan priority 		 */
name|context
operator|=
operator|(
name|msg
operator|->
name|msg
index|[
literal|0
index|]
operator|>>
literal|40
operator|)
operator|&
literal|0x3fff
expr_stmt|;
name|port
operator|=
name|cntx2port
index|[
name|context
index|]
expr_stmt|;
if|if
condition|(
name|port
operator|>=
name|XLP_MAX_PORTS
condition|)
block|{
name|printf
argument_list|(
literal|"%s:%d Bad port %d (context=%d)\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|port
argument_list|,
name|context
argument_list|)
expr_stmt|;
return|return;
block|}
name|ifp
operator|=
name|ifp_ports
index|[
name|port
index|]
operator|.
name|xlpge_if
expr_stmt|;
name|xlpge_sc
operator|=
name|ifp_ports
index|[
name|port
index|]
operator|.
name|xlpge_sc
expr_stmt|;
name|nlm_xlpge_release_mbuf
argument_list|(
name|phys_addr
argument_list|)
expr_stmt|;
name|if_inc_counter
argument_list|(
name|ifp
argument_list|,
name|IFCOUNTER_OPACKETS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|size
operator|>
literal|1
condition|)
block|{
comment|/* Recieve packet */
name|phys_addr
operator|=
name|msg
operator|->
name|msg
index|[
literal|1
index|]
operator|&
literal|0xffffffffc0ULL
expr_stmt|;
name|length
operator|=
operator|(
name|msg
operator|->
name|msg
index|[
literal|1
index|]
operator|>>
literal|40
operator|)
operator|&
literal|0x3fff
expr_stmt|;
name|length
operator|-=
name|MAC_CRC_LEN
expr_stmt|;
comment|/* context is SGMII_RCV_CONTEXT_NUM + three bit vlan type 		 * or vlan priority 		 */
name|context
operator|=
operator|(
name|msg
operator|->
name|msg
index|[
literal|1
index|]
operator|>>
literal|54
operator|)
operator|&
literal|0x3ff
expr_stmt|;
name|port
operator|=
name|cntx2port
index|[
name|context
index|]
expr_stmt|;
if|if
condition|(
name|port
operator|>=
name|XLP_MAX_PORTS
condition|)
block|{
name|printf
argument_list|(
literal|"%s:%d Bad port %d (context=%d)\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|port
argument_list|,
name|context
argument_list|)
expr_stmt|;
return|return;
block|}
name|ifp
operator|=
name|ifp_ports
index|[
name|port
index|]
operator|.
name|xlpge_if
expr_stmt|;
name|xlpge_sc
operator|=
name|ifp_ports
index|[
name|port
index|]
operator|.
name|xlpge_sc
expr_stmt|;
name|nlm_xlpge_rx
argument_list|(
name|xlpge_sc
argument_list|,
name|port
argument_list|,
name|phys_addr
argument_list|,
name|length
argument_list|)
expr_stmt|;
comment|/* return back a free descriptor to NA */
name|nlm_xlpge_submit_rx_free_desc
argument_list|(
name|xlpge_sc
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
end_function

end_unit


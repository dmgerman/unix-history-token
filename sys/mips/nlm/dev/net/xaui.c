begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2003-2012 Broadcom Corporation  * All Rights Reserved  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in  *    the documentation and/or other materials provided with the  *    distribution.  *   * THIS SOFTWARE IS PROVIDED BY BROADCOM ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED  * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED. IN NO EVENT SHALL BROADCOM OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR  * BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,  * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE  * OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN  * IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<mips/nlm/hal/mips-extns.h>
end_include

begin_include
include|#
directive|include
file|<mips/nlm/hal/haldefs.h>
end_include

begin_include
include|#
directive|include
file|<mips/nlm/hal/iomap.h>
end_include

begin_include
include|#
directive|include
file|<mips/nlm/hal/sys.h>
end_include

begin_include
include|#
directive|include
file|<mips/nlm/hal/nae.h>
end_include

begin_include
include|#
directive|include
file|<mips/nlm/hal/mdio.h>
end_include

begin_include
include|#
directive|include
file|<mips/nlm/hal/sgmii.h>
end_include

begin_include
include|#
directive|include
file|<mips/nlm/hal/xaui.h>
end_include

begin_include
include|#
directive|include
file|<mips/nlm/xlp.h>
end_include

begin_function
name|void
name|nlm_xaui_pcs_init
parameter_list|(
name|uint64_t
name|nae_base
parameter_list|,
name|int
name|xaui_cplx_mask
parameter_list|)
block|{
name|int
name|block
decl_stmt|,
name|lane_ctrl
decl_stmt|,
name|reg
decl_stmt|;
name|int
name|cplx_lane_enable
decl_stmt|;
name|int
name|lane_enable
init|=
literal|0
decl_stmt|;
name|uint32_t
name|regval
decl_stmt|;
name|cplx_lane_enable
operator|=
name|LM_XAUI
operator||
operator|(
name|LM_XAUI
operator|<<
literal|4
operator|)
operator||
operator|(
name|LM_XAUI
operator|<<
literal|8
operator|)
operator||
operator|(
name|LM_XAUI
operator|<<
literal|12
operator|)
expr_stmt|;
if|if
condition|(
name|xaui_cplx_mask
operator|==
literal|0
condition|)
return|return;
comment|/* write 0x2 to enable SGMII for all lane */
name|block
operator|=
literal|7
expr_stmt|;
if|if
condition|(
name|xaui_cplx_mask
operator|&
literal|0x3
condition|)
block|{
comment|/* Complexes 0, 1 */
name|lane_enable
operator|=
name|nlm_read_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_REG
argument_list|(
name|block
argument_list|,
name|LANE_CFG
argument_list|,
name|LANE_CFG_CPLX_0_1
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|xaui_cplx_mask
operator|&
literal|0x1
condition|)
block|{
comment|/* Complex 0 */
name|lane_enable
operator|&=
operator|~
operator|(
literal|0xFFFF
operator|)
expr_stmt|;
name|lane_enable
operator||=
name|cplx_lane_enable
expr_stmt|;
block|}
if|if
condition|(
name|xaui_cplx_mask
operator|&
literal|0x2
condition|)
block|{
comment|/* Complex 1 */
name|lane_enable
operator|&=
operator|~
operator|(
literal|0xFFFF
operator|<<
literal|16
operator|)
expr_stmt|;
name|lane_enable
operator||=
operator|(
name|cplx_lane_enable
operator|<<
literal|16
operator|)
expr_stmt|;
block|}
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_REG
argument_list|(
name|block
argument_list|,
name|LANE_CFG
argument_list|,
name|LANE_CFG_CPLX_0_1
argument_list|)
argument_list|,
name|lane_enable
argument_list|)
expr_stmt|;
block|}
name|lane_enable
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|xaui_cplx_mask
operator|&
literal|0xc
condition|)
block|{
comment|/* Complexes 2, 3 */
name|lane_enable
operator|=
name|nlm_read_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_REG
argument_list|(
name|block
argument_list|,
name|LANE_CFG
argument_list|,
name|LANE_CFG_CPLX_2_3
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|xaui_cplx_mask
operator|&
literal|0x4
condition|)
block|{
comment|/* Complex 2 */
name|lane_enable
operator|&=
operator|~
operator|(
literal|0xFFFF
operator|)
expr_stmt|;
name|lane_enable
operator||=
name|cplx_lane_enable
expr_stmt|;
block|}
if|if
condition|(
name|xaui_cplx_mask
operator|&
literal|0x8
condition|)
block|{
comment|/* Complex 3 */
name|lane_enable
operator|&=
operator|~
operator|(
literal|0xFFFF
operator|<<
literal|16
operator|)
expr_stmt|;
name|lane_enable
operator||=
operator|(
name|cplx_lane_enable
operator|<<
literal|16
operator|)
expr_stmt|;
block|}
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_REG
argument_list|(
name|block
argument_list|,
name|LANE_CFG
argument_list|,
name|LANE_CFG_CPLX_2_3
argument_list|)
argument_list|,
name|lane_enable
argument_list|)
expr_stmt|;
block|}
comment|/* Bring txpll out of reset */
for|for
control|(
name|block
operator|=
literal|0
init|;
name|block
operator|<
literal|4
condition|;
name|block
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|xaui_cplx_mask
operator|&
operator|(
literal|1
operator|<<
name|block
operator|)
operator|)
operator|==
literal|0
condition|)
continue|continue;
for|for
control|(
name|lane_ctrl
operator|=
name|PHY_LANE_0_CTRL
init|;
name|lane_ctrl
operator|<=
name|PHY_LANE_3_CTRL
condition|;
name|lane_ctrl
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|nlm_is_xlp8xx_ax
argument_list|()
condition|)
name|xlp_nae_lane_reset_txpll
argument_list|(
name|nae_base
argument_list|,
name|block
argument_list|,
name|lane_ctrl
argument_list|,
name|PHYMODE_XAUI
argument_list|)
expr_stmt|;
else|else
name|xlp_ax_nae_lane_reset_txpll
argument_list|(
name|nae_base
argument_list|,
name|block
argument_list|,
name|lane_ctrl
argument_list|,
name|PHYMODE_XAUI
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Wait for Rx& TX clock stable */
for|for
control|(
name|block
operator|=
literal|0
init|;
name|block
operator|<
literal|4
condition|;
name|block
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|xaui_cplx_mask
operator|&
operator|(
literal|1
operator|<<
name|block
operator|)
operator|)
operator|==
literal|0
condition|)
continue|continue;
for|for
control|(
name|lane_ctrl
operator|=
name|PHY_LANE_0_CTRL
init|;
name|lane_ctrl
operator|<=
name|PHY_LANE_3_CTRL
condition|;
name|lane_ctrl
operator|++
control|)
block|{
name|reg
operator|=
name|NAE_REG
argument_list|(
name|block
argument_list|,
name|PHY
argument_list|,
name|lane_ctrl
operator|-
literal|4
argument_list|)
expr_stmt|;
comment|/* Wait for TX clock to be set */
do|do
block|{
name|regval
operator|=
name|nlm_read_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
operator|(
name|regval
operator|&
name|LANE_TX_CLK
operator|)
operator|==
literal|0
condition|)
do|;
comment|/* Wait for RX clock to be set */
do|do
block|{
name|regval
operator|=
name|nlm_read_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
operator|(
name|regval
operator|&
name|LANE_RX_CLK
operator|)
operator|==
literal|0
condition|)
do|;
comment|/* Wait for XAUI Lane fault to be cleared */
do|do
block|{
name|regval
operator|=
name|nlm_read_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
operator|(
name|regval
operator|&
name|XAUI_LANE_FAULT
operator|)
operator|!=
literal|0
condition|)
do|;
block|}
block|}
block|}
end_function

begin_function
name|void
name|nlm_nae_setup_rx_mode_xaui
parameter_list|(
name|uint64_t
name|base
parameter_list|,
name|int
name|nblock
parameter_list|,
name|int
name|iface
parameter_list|,
name|int
name|port_type
parameter_list|,
name|int
name|broadcast_en
parameter_list|,
name|int
name|multicast_en
parameter_list|,
name|int
name|pause_en
parameter_list|,
name|int
name|promisc_en
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|;
name|val
operator|=
operator|(
operator|(
name|broadcast_en
operator|&
literal|0x1
operator|)
operator|<<
literal|10
operator|)
operator||
operator|(
operator|(
name|pause_en
operator|&
literal|0x1
operator|)
operator|<<
literal|9
operator|)
operator||
operator|(
operator|(
name|multicast_en
operator|&
literal|0x1
operator|)
operator|<<
literal|8
operator|)
operator||
operator|(
operator|(
name|promisc_en
operator|&
literal|0x1
operator|)
operator|<<
literal|7
operator|)
operator||
comment|/* unicast_enable - enables promisc mode */
literal|1
expr_stmt|;
comment|/* MAC address is always valid */
name|nlm_write_nae_reg
argument_list|(
name|base
argument_list|,
name|XAUI_MAC_FILTER_CFG
argument_list|(
name|nblock
argument_list|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|nlm_nae_setup_mac_addr_xaui
parameter_list|(
name|uint64_t
name|base
parameter_list|,
name|int
name|nblock
parameter_list|,
name|int
name|iface
parameter_list|,
name|int
name|port_type
parameter_list|,
name|unsigned
name|char
modifier|*
name|mac_addr
parameter_list|)
block|{
name|nlm_write_nae_reg
argument_list|(
name|base
argument_list|,
name|XAUI_MAC_ADDR0_LO
argument_list|(
name|nblock
argument_list|)
argument_list|,
operator|(
name|mac_addr
index|[
literal|5
index|]
operator|<<
literal|24
operator|)
operator||
operator|(
name|mac_addr
index|[
literal|4
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
name|mac_addr
index|[
literal|3
index|]
operator|<<
literal|8
operator|)
operator||
name|mac_addr
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|base
argument_list|,
name|XAUI_MAC_ADDR0_HI
argument_list|(
name|nblock
argument_list|)
argument_list|,
operator|(
name|mac_addr
index|[
literal|1
index|]
operator|<<
literal|24
operator|)
operator||
operator|(
name|mac_addr
index|[
literal|0
index|]
operator|<<
literal|16
operator|)
argument_list|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|base
argument_list|,
name|XAUI_MAC_ADDR_MASK0_LO
argument_list|(
name|nblock
argument_list|)
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|base
argument_list|,
name|XAUI_MAC_ADDR_MASK0_HI
argument_list|(
name|nblock
argument_list|)
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|nlm_nae_setup_rx_mode_xaui
argument_list|(
name|base
argument_list|,
name|nblock
argument_list|,
name|iface
argument_list|,
name|XAUIC
argument_list|,
literal|1
argument_list|,
comment|/* broadcast enabled */
literal|1
argument_list|,
comment|/* multicast enabled */
literal|0
argument_list|,
comment|/* do not accept pause frames */
literal|0
comment|/* promisc mode disabled */
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|nlm_config_xaui_mtu
parameter_list|(
name|uint64_t
name|nae_base
parameter_list|,
name|int
name|nblock
parameter_list|,
name|int
name|max_tx_frame_sz
parameter_list|,
name|int
name|max_rx_frame_sz
parameter_list|)
block|{
name|uint32_t
name|tx_words
init|=
name|max_tx_frame_sz
operator|>>
literal|2
decl_stmt|;
comment|/* max_tx_frame_sz / 4 */
comment|/* write max frame length */
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|XAUI_MAX_FRAME_LEN
argument_list|(
name|nblock
argument_list|)
argument_list|,
operator|(
operator|(
name|tx_words
operator|&
literal|0x3ff
operator|)
operator|<<
literal|16
operator|)
operator||
operator|(
name|max_rx_frame_sz
operator|&
literal|0xffff
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|nlm_config_xaui
parameter_list|(
name|uint64_t
name|nae_base
parameter_list|,
name|int
name|nblock
parameter_list|,
name|int
name|max_tx_frame_sz
parameter_list|,
name|int
name|max_rx_frame_sz
parameter_list|,
name|int
name|vlan_pri_en
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|;
name|val
operator|=
name|nlm_read_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|XAUI_NETIOR_XGMAC_CTRL1
argument_list|(
name|nblock
argument_list|)
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
operator|(
literal|0x1
operator|<<
literal|11
operator|)
expr_stmt|;
comment|/* clear soft reset */
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|XAUI_NETIOR_XGMAC_CTRL1
argument_list|(
name|nblock
argument_list|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
name|nlm_read_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|XAUI_NETIOR_XGMAC_CTRL1
argument_list|(
name|nblock
argument_list|)
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
operator|(
literal|0x3
operator|<<
literal|11
operator|)
expr_stmt|;
comment|/* clear soft reset and hard reset */
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|XAUI_NETIOR_XGMAC_CTRL1
argument_list|(
name|nblock
argument_list|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|XAUI_CONFIG0
argument_list|(
name|nblock
argument_list|)
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|XAUI_CONFIG0
argument_list|(
name|nblock
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Enable tx/rx frame */
name|val
operator|=
literal|0x000010A8
expr_stmt|;
name|val
operator||=
name|XAUI_CONFIG_LENCHK
expr_stmt|;
name|val
operator||=
name|XAUI_CONFIG_GENFCS
expr_stmt|;
name|val
operator||=
name|XAUI_CONFIG_PAD_64
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|XAUI_CONFIG1
argument_list|(
name|nblock
argument_list|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
comment|/* write max frame length */
name|nlm_config_xaui_mtu
argument_list|(
name|nae_base
argument_list|,
name|nblock
argument_list|,
name|max_tx_frame_sz
argument_list|,
name|max_rx_frame_sz
argument_list|)
expr_stmt|;
comment|/* set stats counter */
name|val
operator|=
name|nlm_read_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|XAUI_NETIOR_XGMAC_CTRL1
argument_list|(
name|nblock
argument_list|)
argument_list|)
expr_stmt|;
name|val
operator||=
operator|(
literal|0x1
operator|<<
name|NETIOR_XGMAC_VLAN_DC_POS
operator|)
expr_stmt|;
name|val
operator||=
operator|(
literal|0x1
operator|<<
name|NETIOR_XGMAC_STATS_EN_POS
operator|)
expr_stmt|;
if|if
condition|(
name|vlan_pri_en
condition|)
block|{
name|val
operator||=
operator|(
literal|0x1
operator|<<
name|NETIOR_XGMAC_TX_PFC_EN_POS
operator|)
expr_stmt|;
name|val
operator||=
operator|(
literal|0x1
operator|<<
name|NETIOR_XGMAC_RX_PFC_EN_POS
operator|)
expr_stmt|;
name|val
operator||=
operator|(
literal|0x1
operator|<<
name|NETIOR_XGMAC_TX_PAUSE_POS
operator|)
expr_stmt|;
block|}
else|else
block|{
name|val
operator|&=
operator|~
operator|(
literal|0x1
operator|<<
name|NETIOR_XGMAC_TX_PFC_EN_POS
operator|)
expr_stmt|;
name|val
operator||=
operator|(
literal|0x1
operator|<<
name|NETIOR_XGMAC_TX_PAUSE_POS
operator|)
expr_stmt|;
block|}
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|XAUI_NETIOR_XGMAC_CTRL1
argument_list|(
name|nblock
argument_list|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
comment|/* configure on / off timer */
if|if
condition|(
name|vlan_pri_en
condition|)
name|val
operator|=
literal|0xF1230000
expr_stmt|;
comment|/* PFC mode, offtimer = 0xf123, ontimer = 0 */
else|else
name|val
operator|=
literal|0x0000F123
expr_stmt|;
comment|/* link level FC mode, offtimer = 0xf123 */
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|XAUI_NETIOR_XGMAC_CTRL2
argument_list|(
name|nblock
argument_list|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
comment|/* set xaui tx threshold */
name|val
operator|=
name|nlm_read_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|XAUI_NETIOR_XGMAC_CTRL3
argument_list|(
name|nblock
argument_list|)
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
operator|(
literal|0x1f
operator|<<
literal|10
operator|)
expr_stmt|;
name|val
operator||=
operator|~
operator|(
literal|15
operator|<<
literal|10
operator|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|XAUI_NETIOR_XGMAC_CTRL3
argument_list|(
name|nblock
argument_list|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2003-2012 Broadcom Corporation  * All Rights Reserved  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in  *    the documentation and/or other materials provided with the  *    distribution.  *   * THIS SOFTWARE IS PROVIDED BY BROADCOM ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED  * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED. IN NO EVENT SHALL BROADCOM OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR  * BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,  * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE  * OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN  * IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<mips/nlm/hal/mips-extns.h>
end_include

begin_include
include|#
directive|include
file|<mips/nlm/hal/haldefs.h>
end_include

begin_include
include|#
directive|include
file|<mips/nlm/hal/iomap.h>
end_include

begin_include
include|#
directive|include
file|<mips/nlm/hal/sys.h>
end_include

begin_include
include|#
directive|include
file|<mips/nlm/hal/nae.h>
end_include

begin_include
include|#
directive|include
file|<mips/nlm/hal/mdio.h>
end_include

begin_include
include|#
directive|include
file|<mips/nlm/hal/sgmii.h>
end_include

begin_include
include|#
directive|include
file|<mips/nlm/hal/xaui.h>
end_include

begin_include
include|#
directive|include
file|<mips/nlm/board.h>
end_include

begin_include
include|#
directive|include
file|<mips/nlm/xlp.h>
end_include

begin_function
name|void
name|nlm_nae_flush_free_fifo
parameter_list|(
name|uint64_t
name|nae_base
parameter_list|,
name|int
name|nblocks
parameter_list|)
block|{
name|uint32_t
name|data
decl_stmt|,
name|fifo_mask
decl_stmt|;
name|fifo_mask
operator|=
operator|(
literal|1
operator|<<
operator|(
literal|4
operator|*
name|nblocks
operator|)
operator|)
operator|-
literal|1
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_RX_FREE_FIFO_POP
argument_list|,
name|fifo_mask
argument_list|)
expr_stmt|;
do|do
block|{
name|data
operator|=
name|nlm_read_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_RX_FREE_FIFO_POP
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|data
operator|!=
name|fifo_mask
condition|)
do|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_RX_FREE_FIFO_POP
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|nlm_program_nae_parser_seq_fifo
parameter_list|(
name|uint64_t
name|nae_base
parameter_list|,
name|int
name|maxports
parameter_list|,
name|struct
name|nae_port_config
modifier|*
name|cfg
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|;
name|int
name|start
init|=
literal|0
decl_stmt|,
name|size
decl_stmt|,
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|maxports
condition|;
name|i
operator|++
control|)
block|{
name|size
operator|=
name|cfg
index|[
name|i
index|]
operator|.
name|pseq_fifo_size
expr_stmt|;
name|val
operator|=
operator|(
operator|(
operator|(
name|size
operator|&
literal|0x1fff
operator|)
operator|<<
literal|17
operator|)
operator||
operator|(
operator|(
name|start
operator|&
literal|0xfff
operator|)
operator|<<
literal|5
operator|)
operator||
operator|(
name|i
operator|&
literal|0x1f
operator|)
operator|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_PARSER_SEQ_FIFO_CFG
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|start
operator|+=
name|size
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|nlm_setup_rx_cal_cfg
parameter_list|(
name|uint64_t
name|nae_base
parameter_list|,
name|int
name|total_num_ports
parameter_list|,
name|struct
name|nae_port_config
modifier|*
name|cfg
parameter_list|)
block|{
name|int
name|rx_slots
init|=
literal|0
decl_stmt|,
name|port
decl_stmt|;
name|int
name|cal_len
decl_stmt|,
name|cal
init|=
literal|0
decl_stmt|,
name|last_free
init|=
literal|0
decl_stmt|;
name|uint32_t
name|val
decl_stmt|;
for|for
control|(
name|port
operator|=
literal|0
init|;
name|port
operator|<
name|total_num_ports
condition|;
name|port
operator|++
control|)
block|{
if|if
condition|(
name|cfg
index|[
name|port
index|]
operator|.
name|rx_slots_reqd
condition|)
name|rx_slots
operator|+=
name|cfg
index|[
name|port
index|]
operator|.
name|rx_slots_reqd
expr_stmt|;
if|if
condition|(
name|rx_slots
operator|>
name|MAX_CAL_SLOTS
condition|)
block|{
name|rx_slots
operator|=
name|MAX_CAL_SLOTS
expr_stmt|;
break|break;
block|}
block|}
name|cal_len
operator|=
name|rx_slots
operator|-
literal|1
expr_stmt|;
do|do
block|{
if|if
condition|(
name|cal
operator|>=
name|MAX_CAL_SLOTS
condition|)
break|break;
name|last_free
operator|=
name|cal
expr_stmt|;
for|for
control|(
name|port
operator|=
literal|0
init|;
name|port
operator|<
name|total_num_ports
condition|;
name|port
operator|++
control|)
block|{
if|if
condition|(
name|cfg
index|[
name|port
index|]
operator|.
name|rx_slots_reqd
operator|>
literal|0
condition|)
block|{
name|val
operator|=
operator|(
name|cal_len
operator|<<
literal|16
operator|)
operator||
operator|(
name|port
operator|<<
literal|8
operator|)
operator||
name|cal
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_RX_IF_SLOT_CAL
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|cal
operator|++
expr_stmt|;
name|cfg
index|[
name|port
index|]
operator|.
name|rx_slots_reqd
operator|--
expr_stmt|;
block|}
block|}
if|if
condition|(
name|last_free
operator|==
name|cal
condition|)
break|break;
block|}
do|while
condition|(
literal|1
condition|)
do|;
block|}
end_function

begin_function
name|void
name|nlm_setup_tx_cal_cfg
parameter_list|(
name|uint64_t
name|nae_base
parameter_list|,
name|int
name|total_num_ports
parameter_list|,
name|struct
name|nae_port_config
modifier|*
name|cfg
parameter_list|)
block|{
name|int
name|tx_slots
init|=
literal|0
decl_stmt|,
name|port
decl_stmt|;
name|int
name|cal
init|=
literal|0
decl_stmt|,
name|last_free
init|=
literal|0
decl_stmt|;
name|uint32_t
name|val
decl_stmt|;
for|for
control|(
name|port
operator|=
literal|0
init|;
name|port
operator|<
name|total_num_ports
condition|;
name|port
operator|++
control|)
block|{
if|if
condition|(
name|cfg
index|[
name|port
index|]
operator|.
name|tx_slots_reqd
condition|)
name|tx_slots
operator|+=
name|cfg
index|[
name|port
index|]
operator|.
name|tx_slots_reqd
expr_stmt|;
if|if
condition|(
name|tx_slots
operator|>
name|MAX_CAL_SLOTS
condition|)
block|{
name|tx_slots
operator|=
name|MAX_CAL_SLOTS
expr_stmt|;
break|break;
block|}
block|}
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_EGR_NIOR_CAL_LEN_REG
argument_list|,
name|tx_slots
operator|-
literal|1
argument_list|)
expr_stmt|;
do|do
block|{
if|if
condition|(
name|cal
operator|>=
name|MAX_CAL_SLOTS
condition|)
break|break;
name|last_free
operator|=
name|cal
expr_stmt|;
for|for
control|(
name|port
operator|=
literal|0
init|;
name|port
operator|<
name|total_num_ports
condition|;
name|port
operator|++
control|)
block|{
if|if
condition|(
name|cfg
index|[
name|port
index|]
operator|.
name|tx_slots_reqd
operator|>
literal|0
condition|)
block|{
name|val
operator|=
operator|(
name|port
operator|<<
literal|7
operator|)
operator||
operator|(
name|cal
operator|<<
literal|1
operator|)
operator||
literal|1
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_EGR_NIOR_CRDT_CAL_PROG
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|cal
operator|++
expr_stmt|;
name|cfg
index|[
name|port
index|]
operator|.
name|tx_slots_reqd
operator|--
expr_stmt|;
block|}
block|}
if|if
condition|(
name|last_free
operator|==
name|cal
condition|)
break|break;
block|}
do|while
condition|(
literal|1
condition|)
do|;
block|}
end_function

begin_function
name|void
name|nlm_deflate_frin_fifo_carving
parameter_list|(
name|uint64_t
name|nae_base
parameter_list|,
name|int
name|total_num_ports
parameter_list|)
block|{
specifier|const
name|int
name|minimum_size
init|=
literal|8
decl_stmt|;
name|uint32_t
name|value
decl_stmt|;
name|int
name|intf
decl_stmt|,
name|start
decl_stmt|;
for|for
control|(
name|intf
operator|=
literal|0
init|;
name|intf
operator|<
name|total_num_ports
condition|;
name|intf
operator|++
control|)
block|{
name|start
operator|=
name|minimum_size
operator|*
name|intf
expr_stmt|;
name|value
operator|=
operator|(
name|minimum_size
operator|<<
literal|20
operator|)
operator||
operator|(
name|start
operator|<<
literal|8
operator|)
operator||
operator|(
name|intf
operator|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_FREE_IN_FIFO_CFG
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|nlm_reset_nae
parameter_list|(
name|int
name|node
parameter_list|)
block|{
name|uint64_t
name|sysbase
decl_stmt|;
name|uint64_t
name|nae_base
decl_stmt|;
name|uint64_t
name|nae_pcibase
decl_stmt|;
name|uint32_t
name|rx_config
decl_stmt|;
name|uint32_t
name|bar0
decl_stmt|;
name|int
name|reset_bit
decl_stmt|;
name|sysbase
operator|=
name|nlm_get_sys_regbase
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|nae_base
operator|=
name|nlm_get_nae_regbase
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|nae_pcibase
operator|=
name|nlm_get_nae_pcibase
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|bar0
operator|=
name|nlm_read_pci_reg
argument_list|(
name|nae_pcibase
argument_list|,
name|XLP_PCI_CFGREG4
argument_list|)
expr_stmt|;
if|#
directive|if
name|BYTE_ORDER
operator|==
name|LITTLE_ENDIAN
if|if
condition|(
name|nlm_is_xlp8xx_ax
argument_list|()
condition|)
block|{
name|uint8_t
name|val
decl_stmt|;
comment|/* membar fixup */
name|val
operator|=
operator|(
name|bar0
operator|>>
literal|24
operator|)
operator|&
literal|0xff
expr_stmt|;
name|bar0
operator|=
operator|(
name|val
operator|<<
literal|24
operator|)
operator||
operator|(
name|val
operator|<<
literal|16
operator|)
operator||
operator|(
name|val
operator|<<
literal|8
operator|)
operator||
name|val
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|nlm_is_xlp3xx
argument_list|()
condition|)
name|reset_bit
operator|=
literal|6
expr_stmt|;
else|else
name|reset_bit
operator|=
literal|9
expr_stmt|;
comment|/* Reset NAE */
name|nlm_write_sys_reg
argument_list|(
name|sysbase
argument_list|,
name|SYS_RESET
argument_list|,
operator|(
literal|1
operator|<<
name|reset_bit
operator|)
argument_list|)
expr_stmt|;
comment|/* XXXJC - 1s delay here may be too high */
name|DELAY
argument_list|(
literal|1000000
argument_list|)
expr_stmt|;
name|nlm_write_sys_reg
argument_list|(
name|sysbase
argument_list|,
name|SYS_RESET
argument_list|,
operator|(
literal|0
operator|<<
name|reset_bit
operator|)
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1000000
argument_list|)
expr_stmt|;
name|rx_config
operator|=
name|nlm_read_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_RX_CONFIG
argument_list|)
expr_stmt|;
name|nlm_write_pci_reg
argument_list|(
name|nae_pcibase
argument_list|,
name|XLP_PCI_CFGREG4
argument_list|,
name|bar0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|nlm_setup_poe_class_config
parameter_list|(
name|uint64_t
name|nae_base
parameter_list|,
name|int
name|max_poe_classes
parameter_list|,
name|int
name|num_contexts
parameter_list|,
name|int
modifier|*
name|poe_cl_tbl
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|;
name|int
name|i
decl_stmt|,
name|max_poe_class_ctxt_tbl_sz
decl_stmt|;
name|max_poe_class_ctxt_tbl_sz
operator|=
name|num_contexts
operator|/
name|max_poe_classes
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|max_poe_class_ctxt_tbl_sz
condition|;
name|i
operator|++
control|)
block|{
name|val
operator|=
operator|(
name|poe_cl_tbl
index|[
operator|(
name|i
operator|/
name|max_poe_classes
operator|)
operator|&
literal|0x7
index|]
operator|<<
literal|8
operator|)
operator||
name|i
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_POE_CLASS_SETUP_CFG
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|nlm_setup_vfbid_mapping
parameter_list|(
name|uint64_t
name|nae_base
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|;
name|int
name|dest_vc
decl_stmt|,
name|vfbid
decl_stmt|;
comment|/* 127 is max vfbid */
for|for
control|(
name|vfbid
operator|=
literal|127
init|;
name|vfbid
operator|>=
literal|0
condition|;
name|vfbid
operator|--
control|)
block|{
name|dest_vc
operator|=
name|nlm_get_vfbid_mapping
argument_list|(
name|vfbid
argument_list|)
expr_stmt|;
if|if
condition|(
name|dest_vc
operator|<
literal|0
condition|)
continue|continue;
name|val
operator|=
operator|(
name|dest_vc
operator|<<
literal|16
operator|)
operator||
operator|(
name|vfbid
operator|<<
literal|4
operator|)
operator||
literal|1
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_VFBID_DESTMAP_CMD
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|nlm_setup_flow_crc_poly
parameter_list|(
name|uint64_t
name|nae_base
parameter_list|,
name|uint32_t
name|poly
parameter_list|)
block|{
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_FLOW_CRC16_POLY_CFG
argument_list|,
name|poly
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|nlm_setup_iface_fifo_cfg
parameter_list|(
name|uint64_t
name|nae_base
parameter_list|,
name|int
name|maxports
parameter_list|,
name|struct
name|nae_port_config
modifier|*
name|cfg
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
name|int
name|fifo_xoff_thresh
init|=
literal|12
decl_stmt|;
name|int
name|i
decl_stmt|,
name|size
decl_stmt|;
name|int
name|cur_iface_start
init|=
literal|0
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|maxports
condition|;
name|i
operator|++
control|)
block|{
name|size
operator|=
name|cfg
index|[
name|i
index|]
operator|.
name|iface_fifo_size
expr_stmt|;
name|reg
operator|=
operator|(
operator|(
name|fifo_xoff_thresh
operator|<<
literal|25
operator|)
operator||
operator|(
operator|(
name|size
operator|&
literal|0x1ff
operator|)
operator|<<
literal|16
operator|)
operator||
operator|(
operator|(
name|cur_iface_start
operator|&
literal|0xff
operator|)
operator|<<
literal|8
operator|)
operator||
operator|(
name|i
operator|&
literal|0x1f
operator|)
operator|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_IFACE_FIFO_CFG
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|cur_iface_start
operator|+=
name|size
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|nlm_setup_rx_base_config
parameter_list|(
name|uint64_t
name|nae_base
parameter_list|,
name|int
name|maxports
parameter_list|,
name|struct
name|nae_port_config
modifier|*
name|cfg
parameter_list|)
block|{
name|int
name|base
init|=
literal|0
decl_stmt|;
name|uint32_t
name|val
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|id
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|maxports
operator|/
literal|2
operator|)
condition|;
name|i
operator|++
control|)
block|{
name|id
operator|=
literal|0x12
operator|+
name|i
expr_stmt|;
comment|/* RX_IF_BASE_CONFIG0 */
name|val
operator|=
operator|(
name|base
operator|&
literal|0x3ff
operator|)
expr_stmt|;
name|base
operator|+=
name|cfg
index|[
operator|(
name|i
operator|*
literal|2
operator|)
index|]
operator|.
name|num_channels
expr_stmt|;
name|val
operator||=
operator|(
operator|(
name|base
operator|&
literal|0x3ff
operator|)
operator|<<
literal|16
operator|)
expr_stmt|;
name|base
operator|+=
name|cfg
index|[
operator|(
name|i
operator|*
literal|2
operator|)
operator|+
literal|1
index|]
operator|.
name|num_channels
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_REG
argument_list|(
literal|7
argument_list|,
literal|0
argument_list|,
name|id
argument_list|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|nlm_setup_rx_buf_config
parameter_list|(
name|uint64_t
name|nae_base
parameter_list|,
name|int
name|maxports
parameter_list|,
name|struct
name|nae_port_config
modifier|*
name|cfg
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|;
name|int
name|i
decl_stmt|,
name|sz
decl_stmt|,
name|k
decl_stmt|;
name|int
name|context
init|=
literal|0
decl_stmt|;
name|int
name|base
init|=
literal|0
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|maxports
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|cfg
index|[
name|i
index|]
operator|.
name|type
operator|==
name|UNKNOWN
condition|)
continue|continue;
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
name|cfg
index|[
name|i
index|]
operator|.
name|num_channels
condition|;
name|k
operator|++
control|)
block|{
comment|/* write index (context num) */
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_RXBUF_BASE_DPTH_ADDR
argument_list|,
operator|(
name|context
operator|+
name|k
operator|)
argument_list|)
expr_stmt|;
comment|/* write value (rx buf sizes) */
name|sz
operator|=
name|cfg
index|[
name|i
index|]
operator|.
name|rxbuf_size
expr_stmt|;
name|val
operator|=
literal|0x80000000
operator||
operator|(
operator|(
name|base
operator|<<
literal|2
operator|)
operator|&
literal|0x3fff
operator|)
expr_stmt|;
comment|/* base */
name|val
operator||=
operator|(
operator|(
operator|(
name|sz
operator|<<
literal|2
operator|)
operator|&
literal|0x3fff
operator|)
operator|<<
literal|16
operator|)
expr_stmt|;
comment|/* size */
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_RXBUF_BASE_DPTH
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_RXBUF_BASE_DPTH
argument_list|,
operator|(
literal|0x7fffffff
operator|&
name|val
operator|)
argument_list|)
expr_stmt|;
name|base
operator|+=
name|sz
expr_stmt|;
block|}
name|context
operator|+=
name|cfg
index|[
name|i
index|]
operator|.
name|num_channels
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|nlm_setup_freein_fifo_cfg
parameter_list|(
name|uint64_t
name|nae_base
parameter_list|,
name|struct
name|nae_port_config
modifier|*
name|cfg
parameter_list|)
block|{
name|int
name|size
decl_stmt|,
name|i
decl_stmt|;
name|uint32_t
name|reg
decl_stmt|;
name|int
name|start
init|=
literal|0
decl_stmt|,
name|maxbufpool
decl_stmt|;
if|if
condition|(
name|nlm_is_xlp8xx
argument_list|()
condition|)
name|maxbufpool
operator|=
name|MAX_FREE_FIFO_POOL_8XX
expr_stmt|;
else|else
name|maxbufpool
operator|=
name|MAX_FREE_FIFO_POOL_3XX
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|maxbufpool
condition|;
name|i
operator|++
control|)
block|{
comment|/* Each entry represents 2 descs; hence division by 2 */
name|size
operator|=
operator|(
name|cfg
index|[
name|i
index|]
operator|.
name|num_free_descs
operator|/
literal|2
operator|)
expr_stmt|;
if|if
condition|(
name|size
operator|==
literal|0
condition|)
name|size
operator|=
literal|8
expr_stmt|;
name|reg
operator|=
operator|(
operator|(
name|size
operator|&
literal|0x3ff
operator|)
operator|<<
literal|20
operator|)
operator||
comment|/* fcSize */
operator|(
operator|(
name|start
operator|&
literal|0x1ff
operator|)
operator|<<
literal|8
operator|)
operator||
comment|/* fcStart */
operator|(
name|i
operator|&
literal|0x1f
operator|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_FREE_IN_FIFO_CFG
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|start
operator|+=
name|size
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* XXX function name */
end_comment

begin_function
name|int
name|nlm_get_flow_mask
parameter_list|(
name|int
name|num_ports
parameter_list|)
block|{
specifier|const
name|int
name|max_bits
init|=
literal|5
decl_stmt|;
comment|/* upto 32 ports */
name|int
name|i
decl_stmt|;
comment|/* Compute the number of bits to needed to 	 * represent all the ports */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|max_bits
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|num_ports
operator|<=
operator|(
literal|2
operator|<<
name|i
operator|)
condition|)
return|return
operator|(
name|i
operator|+
literal|1
operator|)
return|;
block|}
return|return
operator|(
name|max_bits
operator|)
return|;
block|}
end_function

begin_function
name|void
name|nlm_program_flow_cfg
parameter_list|(
name|uint64_t
name|nae_base
parameter_list|,
name|int
name|port
parameter_list|,
name|uint32_t
name|cur_flow_base
parameter_list|,
name|uint32_t
name|flow_mask
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|;
name|val
operator|=
operator|(
name|cur_flow_base
operator|<<
literal|16
operator|)
operator||
name|port
expr_stmt|;
name|val
operator||=
operator|(
operator|(
name|flow_mask
operator|&
literal|0x1f
operator|)
operator|<<
literal|8
operator|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_FLOW_BASEMASK_CFG
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|xlp_ax_nae_lane_reset_txpll
parameter_list|(
name|uint64_t
name|nae_base
parameter_list|,
name|int
name|block
parameter_list|,
name|int
name|lane_ctrl
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|uint32_t
name|val
init|=
literal|0
decl_stmt|,
name|saved_data
decl_stmt|;
name|int
name|rext_sel
init|=
literal|0
decl_stmt|;
name|val
operator|=
name|PHY_LANE_CTRL_RST
operator||
name|PHY_LANE_CTRL_PWRDOWN
operator||
operator|(
name|mode
operator|<<
name|PHY_LANE_CTRL_PHYMODE_POS
operator|)
expr_stmt|;
comment|/* set comma bypass for XAUI */
if|if
condition|(
name|mode
operator|!=
name|PHYMODE_SGMII
condition|)
name|val
operator||=
name|PHY_LANE_CTRL_BPC_XAUI
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_REG
argument_list|(
name|block
argument_list|,
name|PHY
argument_list|,
name|lane_ctrl
argument_list|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|lane_ctrl
operator|!=
literal|4
condition|)
block|{
name|rext_sel
operator|=
operator|(
literal|1
operator|<<
literal|23
operator|)
expr_stmt|;
if|if
condition|(
name|mode
operator|!=
name|PHYMODE_SGMII
condition|)
name|rext_sel
operator||=
name|PHY_LANE_CTRL_BPC_XAUI
expr_stmt|;
name|val
operator|=
name|nlm_read_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_REG
argument_list|(
name|block
argument_list|,
name|PHY
argument_list|,
name|lane_ctrl
argument_list|)
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
name|PHY_LANE_CTRL_RST
expr_stmt|;
name|val
operator||=
name|rext_sel
expr_stmt|;
comment|/* Resetting PMA for non-zero lanes */
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_REG
argument_list|(
name|block
argument_list|,
name|PHY
argument_list|,
name|lane_ctrl
argument_list|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|20000
argument_list|)
expr_stmt|;
comment|/* 20 ms delay, XXXJC: needed? */
name|val
operator||=
name|PHY_LANE_CTRL_RST
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_REG
argument_list|(
name|block
argument_list|,
name|PHY
argument_list|,
name|lane_ctrl
argument_list|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
literal|0
expr_stmt|;
block|}
comment|/* Come out of reset for TXPLL */
name|saved_data
operator|=
name|nlm_read_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_REG
argument_list|(
name|block
argument_list|,
name|PHY
argument_list|,
name|lane_ctrl
argument_list|)
argument_list|)
operator|&
literal|0xFFC00000
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_REG
argument_list|(
name|block
argument_list|,
name|PHY
argument_list|,
name|lane_ctrl
argument_list|)
argument_list|,
operator|(
literal|0x66
operator|<<
name|PHY_LANE_CTRL_ADDR_POS
operator|)
operator||
name|PHY_LANE_CTRL_CMD_READ
operator||
name|PHY_LANE_CTRL_CMD_START
operator||
name|PHY_LANE_CTRL_RST
operator||
name|rext_sel
operator||
name|val
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
operator|(
name|val
operator|=
name|nlm_read_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_REG
argument_list|(
name|block
argument_list|,
name|PHY
argument_list|,
name|lane_ctrl
argument_list|)
argument_list|)
operator|)
operator|&
name|PHY_LANE_CTRL_CMD_PENDING
operator|)
condition|)
empty_stmt|;
name|val
operator|&=
literal|0xFF
expr_stmt|;
comment|/* set bit[4] to 0 */
name|val
operator|&=
operator|~
operator|(
literal|1
operator|<<
literal|4
operator|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_REG
argument_list|(
name|block
argument_list|,
name|PHY
argument_list|,
name|lane_ctrl
argument_list|)
argument_list|,
operator|(
literal|0x66
operator|<<
name|PHY_LANE_CTRL_ADDR_POS
operator|)
operator||
name|PHY_LANE_CTRL_CMD_WRITE
operator||
name|PHY_LANE_CTRL_CMD_START
operator||
operator|(
literal|0x0
operator|<<
literal|19
operator|)
comment|/* (0x4<< 19) */
operator||
name|rext_sel
operator||
name|saved_data
operator||
name|val
argument_list|)
expr_stmt|;
comment|/* re-do */
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_REG
argument_list|(
name|block
argument_list|,
name|PHY
argument_list|,
name|lane_ctrl
argument_list|)
argument_list|,
operator|(
literal|0x66
operator|<<
name|PHY_LANE_CTRL_ADDR_POS
operator|)
operator||
name|PHY_LANE_CTRL_CMD_WRITE
operator||
name|PHY_LANE_CTRL_CMD_START
operator||
operator|(
literal|0x0
operator|<<
literal|19
operator|)
comment|/* (0x4<< 19) */
operator||
name|rext_sel
operator||
name|saved_data
operator||
name|val
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
operator|(
operator|(
name|val
operator|=
name|nlm_read_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_REG
argument_list|(
name|block
argument_list|,
name|PHY
argument_list|,
operator|(
name|lane_ctrl
operator|-
name|PHY_LANE_0_CTRL
operator|)
argument_list|)
argument_list|)
operator|)
operator|&
name|PHY_LANE_STAT_PCR
operator|)
condition|)
empty_stmt|;
comment|/* Clear the Power Down bit */
name|val
operator|=
name|nlm_read_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_REG
argument_list|(
name|block
argument_list|,
name|PHY
argument_list|,
name|lane_ctrl
argument_list|)
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
operator|(
operator|(
literal|1
operator|<<
literal|29
operator|)
operator||
operator|(
literal|0x7ffff
operator|)
operator|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_REG
argument_list|(
name|block
argument_list|,
name|PHY
argument_list|,
name|lane_ctrl
argument_list|)
argument_list|,
operator|(
name|rext_sel
operator||
name|val
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|xlp_nae_lane_reset_txpll
parameter_list|(
name|uint64_t
name|nae_base
parameter_list|,
name|int
name|block
parameter_list|,
name|int
name|lane_ctrl
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|uint32_t
name|val
init|=
literal|0
decl_stmt|;
name|int
name|rext_sel
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|lane_ctrl
operator|!=
literal|4
condition|)
name|rext_sel
operator|=
operator|(
literal|1
operator|<<
literal|23
operator|)
expr_stmt|;
name|val
operator|=
name|nlm_read_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_REG
argument_list|(
name|block
argument_list|,
name|PHY
argument_list|,
name|lane_ctrl
argument_list|)
argument_list|)
expr_stmt|;
comment|/* set comma bypass for XAUI */
if|if
condition|(
name|mode
operator|!=
name|PHYMODE_SGMII
condition|)
name|val
operator||=
name|PHY_LANE_CTRL_BPC_XAUI
expr_stmt|;
name|val
operator||=
literal|0x100000
expr_stmt|;
name|val
operator||=
operator|(
name|mode
operator|<<
name|PHY_LANE_CTRL_PHYMODE_POS
operator|)
expr_stmt|;
name|val
operator|&=
operator|~
operator|(
literal|0x20000
operator|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_REG
argument_list|(
name|block
argument_list|,
name|PHY
argument_list|,
name|lane_ctrl
argument_list|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
name|nlm_read_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_REG
argument_list|(
name|block
argument_list|,
name|PHY
argument_list|,
name|lane_ctrl
argument_list|)
argument_list|)
expr_stmt|;
name|val
operator||=
literal|0x40000000
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_REG
argument_list|(
name|block
argument_list|,
name|PHY
argument_list|,
name|lane_ctrl
argument_list|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
comment|/* clear the power down bit */
name|val
operator|=
name|nlm_read_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_REG
argument_list|(
name|block
argument_list|,
name|PHY
argument_list|,
name|lane_ctrl
argument_list|)
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
operator|(
operator|(
literal|1
operator|<<
literal|29
operator|)
operator||
operator|(
literal|0x7ffff
operator|)
operator|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_REG
argument_list|(
name|block
argument_list|,
name|PHY
argument_list|,
name|lane_ctrl
argument_list|)
argument_list|,
name|rext_sel
operator||
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|xlp_nae_config_lane_gmac
parameter_list|(
name|uint64_t
name|nae_base
parameter_list|,
name|int
name|cplx_mask
parameter_list|)
block|{
name|int
name|block
decl_stmt|,
name|lane_ctrl
decl_stmt|;
name|int
name|cplx_lane_enable
decl_stmt|;
name|int
name|lane_enable
init|=
literal|0
decl_stmt|;
name|cplx_lane_enable
operator|=
name|LM_SGMII
operator||
operator|(
name|LM_SGMII
operator|<<
literal|4
operator|)
operator||
operator|(
name|LM_SGMII
operator|<<
literal|8
operator|)
operator||
operator|(
name|LM_SGMII
operator|<<
literal|12
operator|)
expr_stmt|;
comment|/*  Lane mode progamming */
name|block
operator|=
literal|7
expr_stmt|;
comment|/* Complexes 0, 1 */
if|if
condition|(
name|cplx_mask
operator|&
literal|0x1
condition|)
name|lane_enable
operator||=
name|cplx_lane_enable
expr_stmt|;
if|if
condition|(
name|cplx_mask
operator|&
literal|0x2
condition|)
name|lane_enable
operator||=
operator|(
name|cplx_lane_enable
operator|<<
literal|16
operator|)
expr_stmt|;
if|if
condition|(
name|lane_enable
condition|)
block|{
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_REG
argument_list|(
name|block
argument_list|,
name|LANE_CFG
argument_list|,
name|LANE_CFG_CPLX_0_1
argument_list|)
argument_list|,
name|lane_enable
argument_list|)
expr_stmt|;
name|lane_enable
operator|=
literal|0
expr_stmt|;
block|}
comment|/* Complexes 2 3 */
if|if
condition|(
name|cplx_mask
operator|&
literal|0x4
condition|)
name|lane_enable
operator||=
name|cplx_lane_enable
expr_stmt|;
if|if
condition|(
name|cplx_mask
operator|&
literal|0x8
condition|)
name|lane_enable
operator||=
operator|(
name|cplx_lane_enable
operator|<<
literal|16
operator|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_REG
argument_list|(
name|block
argument_list|,
name|LANE_CFG
argument_list|,
name|LANE_CFG_CPLX_2_3
argument_list|)
argument_list|,
name|lane_enable
argument_list|)
expr_stmt|;
comment|/* complex 4 */
comment|/* XXXJC : fix duplicate code */
if|if
condition|(
name|cplx_mask
operator|&
literal|0x10
condition|)
block|{
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_REG
argument_list|(
name|block
argument_list|,
name|LANE_CFG
argument_list|,
name|LANE_CFG_CPLX_4
argument_list|)
argument_list|,
operator|(
operator|(
name|LM_SGMII
operator|<<
literal|4
operator|)
operator||
name|LM_SGMII
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|lane_ctrl
operator|=
name|PHY_LANE_0_CTRL
init|;
name|lane_ctrl
operator|<=
name|PHY_LANE_1_CTRL
condition|;
name|lane_ctrl
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|nlm_is_xlp8xx_ax
argument_list|()
condition|)
name|xlp_nae_lane_reset_txpll
argument_list|(
name|nae_base
argument_list|,
literal|4
argument_list|,
name|lane_ctrl
argument_list|,
name|PHYMODE_SGMII
argument_list|)
expr_stmt|;
else|else
name|xlp_ax_nae_lane_reset_txpll
argument_list|(
name|nae_base
argument_list|,
literal|4
argument_list|,
name|lane_ctrl
argument_list|,
name|PHYMODE_SGMII
argument_list|)
expr_stmt|;
block|}
block|}
for|for
control|(
name|block
operator|=
literal|0
init|;
name|block
operator|<
literal|4
condition|;
name|block
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|cplx_mask
operator|&
operator|(
literal|1
operator|<<
name|block
operator|)
operator|)
operator|==
literal|0
condition|)
continue|continue;
for|for
control|(
name|lane_ctrl
operator|=
name|PHY_LANE_0_CTRL
init|;
name|lane_ctrl
operator|<=
name|PHY_LANE_3_CTRL
condition|;
name|lane_ctrl
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|nlm_is_xlp8xx_ax
argument_list|()
condition|)
name|xlp_nae_lane_reset_txpll
argument_list|(
name|nae_base
argument_list|,
name|block
argument_list|,
name|lane_ctrl
argument_list|,
name|PHYMODE_SGMII
argument_list|)
expr_stmt|;
else|else
name|xlp_ax_nae_lane_reset_txpll
argument_list|(
name|nae_base
argument_list|,
name|block
argument_list|,
name|lane_ctrl
argument_list|,
name|PHYMODE_SGMII
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|void
name|config_egress_fifo_carvings
parameter_list|(
name|uint64_t
name|nae_base
parameter_list|,
name|int
name|hwport
parameter_list|,
name|int
name|start_ctxt
parameter_list|,
name|int
name|num_ctxts
parameter_list|,
name|int
name|max_ctxts
parameter_list|,
name|struct
name|nae_port_config
modifier|*
name|cfg
parameter_list|)
block|{
specifier|static
name|uint32_t
name|cur_start
index|[
literal|6
index|]
init|=
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
name|uint32_t
name|data
init|=
literal|0
decl_stmt|;
name|uint32_t
name|start
init|=
literal|0
decl_stmt|,
name|size
decl_stmt|,
name|offset
decl_stmt|;
name|int
name|i
decl_stmt|,
name|limit
decl_stmt|;
name|limit
operator|=
name|start_ctxt
operator|+
name|num_ctxts
expr_stmt|;
comment|/* Stage 2 FIFO */
name|start
operator|=
name|cur_start
index|[
literal|0
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
name|start_ctxt
init|;
name|i
operator|<
name|limit
condition|;
name|i
operator|++
control|)
block|{
name|size
operator|=
name|cfg
index|[
name|hwport
index|]
operator|.
name|stg2_fifo_size
operator|/
name|max_ctxts
expr_stmt|;
if|if
condition|(
name|size
condition|)
name|offset
operator|=
name|size
operator|-
literal|1
expr_stmt|;
else|else
name|offset
operator|=
name|size
expr_stmt|;
if|if
condition|(
name|offset
operator|>
name|cfg
index|[
name|hwport
index|]
operator|.
name|max_stg2_offset
condition|)
name|offset
operator|=
name|cfg
index|[
name|hwport
index|]
operator|.
name|max_stg2_offset
expr_stmt|;
name|data
operator|=
name|offset
operator|<<
literal|23
operator||
name|start
operator|<<
literal|11
operator||
name|i
operator|<<
literal|1
operator||
literal|1
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_STG2_PMEM_PROG
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|start
operator|+=
name|size
expr_stmt|;
block|}
name|cur_start
index|[
literal|0
index|]
operator|=
name|start
expr_stmt|;
comment|/* EH FIFO */
name|start
operator|=
name|cur_start
index|[
literal|1
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
name|start_ctxt
init|;
name|i
operator|<
name|limit
condition|;
name|i
operator|++
control|)
block|{
name|size
operator|=
name|cfg
index|[
name|hwport
index|]
operator|.
name|eh_fifo_size
operator|/
name|max_ctxts
expr_stmt|;
if|if
condition|(
name|size
condition|)
name|offset
operator|=
name|size
operator|-
literal|1
expr_stmt|;
else|else
name|offset
operator|=
name|size
expr_stmt|;
if|if
condition|(
name|offset
operator|>
name|cfg
index|[
name|hwport
index|]
operator|.
name|max_eh_offset
condition|)
name|offset
operator|=
name|cfg
index|[
name|hwport
index|]
operator|.
name|max_eh_offset
expr_stmt|;
name|data
operator|=
name|offset
operator|<<
literal|23
operator||
name|start
operator|<<
literal|11
operator||
name|i
operator|<<
literal|1
operator||
literal|1
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_EH_PMEM_PROG
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|start
operator|+=
name|size
expr_stmt|;
block|}
name|cur_start
index|[
literal|1
index|]
operator|=
name|start
expr_stmt|;
comment|/* FROUT FIFO */
name|start
operator|=
name|cur_start
index|[
literal|2
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
name|start_ctxt
init|;
name|i
operator|<
name|limit
condition|;
name|i
operator|++
control|)
block|{
name|size
operator|=
name|cfg
index|[
name|hwport
index|]
operator|.
name|frout_fifo_size
operator|/
name|max_ctxts
expr_stmt|;
if|if
condition|(
name|size
condition|)
name|offset
operator|=
name|size
operator|-
literal|1
expr_stmt|;
else|else
name|offset
operator|=
name|size
expr_stmt|;
if|if
condition|(
name|offset
operator|>
name|cfg
index|[
name|hwport
index|]
operator|.
name|max_frout_offset
condition|)
name|offset
operator|=
name|cfg
index|[
name|hwport
index|]
operator|.
name|max_frout_offset
expr_stmt|;
name|data
operator|=
name|offset
operator|<<
literal|23
operator||
name|start
operator|<<
literal|11
operator||
name|i
operator|<<
literal|1
operator||
literal|1
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_FREE_PMEM_PROG
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|start
operator|+=
name|size
expr_stmt|;
block|}
name|cur_start
index|[
literal|2
index|]
operator|=
name|start
expr_stmt|;
comment|/* MS FIFO */
name|start
operator|=
name|cur_start
index|[
literal|3
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
name|start_ctxt
init|;
name|i
operator|<
name|limit
condition|;
name|i
operator|++
control|)
block|{
name|size
operator|=
name|cfg
index|[
name|hwport
index|]
operator|.
name|ms_fifo_size
operator|/
name|max_ctxts
expr_stmt|;
if|if
condition|(
name|size
condition|)
name|offset
operator|=
name|size
operator|-
literal|1
expr_stmt|;
else|else
name|offset
operator|=
name|size
expr_stmt|;
if|if
condition|(
name|offset
operator|>
name|cfg
index|[
name|hwport
index|]
operator|.
name|max_ms_offset
condition|)
name|offset
operator|=
name|cfg
index|[
name|hwport
index|]
operator|.
name|max_ms_offset
expr_stmt|;
name|data
operator|=
name|offset
operator|<<
literal|22
operator||
comment|/* FIXME in PRM */
name|start
operator|<<
literal|11
operator||
name|i
operator|<<
literal|1
operator||
literal|1
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_STR_PMEM_CMD
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|start
operator|+=
name|size
expr_stmt|;
block|}
name|cur_start
index|[
literal|3
index|]
operator|=
name|start
expr_stmt|;
comment|/* PKT FIFO */
name|start
operator|=
name|cur_start
index|[
literal|4
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
name|start_ctxt
init|;
name|i
operator|<
name|limit
condition|;
name|i
operator|++
control|)
block|{
name|size
operator|=
name|cfg
index|[
name|hwport
index|]
operator|.
name|pkt_fifo_size
operator|/
name|max_ctxts
expr_stmt|;
if|if
condition|(
name|size
condition|)
name|offset
operator|=
name|size
operator|-
literal|1
expr_stmt|;
else|else
name|offset
operator|=
name|size
expr_stmt|;
if|if
condition|(
name|offset
operator|>
name|cfg
index|[
name|hwport
index|]
operator|.
name|max_pmem_offset
condition|)
name|offset
operator|=
name|cfg
index|[
name|hwport
index|]
operator|.
name|max_pmem_offset
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_TX_PKT_PMEM_CMD1
argument_list|,
name|offset
argument_list|)
expr_stmt|;
name|data
operator|=
name|start
operator|<<
literal|11
operator||
name|i
operator|<<
literal|1
operator||
literal|1
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_TX_PKT_PMEM_CMD0
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|start
operator|+=
name|size
expr_stmt|;
block|}
name|cur_start
index|[
literal|4
index|]
operator|=
name|start
expr_stmt|;
comment|/* PKT LEN FIFO */
name|start
operator|=
name|cur_start
index|[
literal|5
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
name|start_ctxt
init|;
name|i
operator|<
name|limit
condition|;
name|i
operator|++
control|)
block|{
name|size
operator|=
name|cfg
index|[
name|hwport
index|]
operator|.
name|pktlen_fifo_size
operator|/
name|max_ctxts
expr_stmt|;
if|if
condition|(
name|size
condition|)
name|offset
operator|=
name|size
operator|-
literal|1
expr_stmt|;
else|else
name|offset
operator|=
name|size
expr_stmt|;
name|data
operator|=
name|offset
operator|<<
literal|22
operator||
name|start
operator|<<
literal|11
operator||
name|i
operator|<<
literal|1
operator||
literal|1
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_TX_PKTLEN_PMEM_CMD
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|start
operator|+=
name|size
expr_stmt|;
block|}
name|cur_start
index|[
literal|5
index|]
operator|=
name|start
expr_stmt|;
block|}
end_function

begin_function
name|void
name|config_egress_fifo_credits
parameter_list|(
name|uint64_t
name|nae_base
parameter_list|,
name|int
name|hwport
parameter_list|,
name|int
name|start_ctxt
parameter_list|,
name|int
name|num_ctxts
parameter_list|,
name|int
name|max_ctxts
parameter_list|,
name|struct
name|nae_port_config
modifier|*
name|cfg
parameter_list|)
block|{
name|uint32_t
name|data
decl_stmt|,
name|credit
decl_stmt|,
name|max_credit
decl_stmt|;
name|int
name|i
decl_stmt|,
name|limit
decl_stmt|;
name|limit
operator|=
name|start_ctxt
operator|+
name|num_ctxts
expr_stmt|;
comment|/* Stage1 -> Stage2 */
name|max_credit
operator|=
name|cfg
index|[
name|hwport
index|]
operator|.
name|max_stg2_offset
operator|+
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
name|start_ctxt
init|;
name|i
operator|<
name|limit
condition|;
name|i
operator|++
control|)
block|{
name|credit
operator|=
name|cfg
index|[
name|hwport
index|]
operator|.
name|stg1_2_credit
operator|/
name|max_ctxts
expr_stmt|;
if|if
condition|(
name|credit
operator|>
name|max_credit
condition|)
name|credit
operator|=
name|max_credit
expr_stmt|;
name|data
operator|=
name|credit
operator|<<
literal|16
operator||
name|i
operator|<<
literal|4
operator||
literal|1
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_STG1_STG2CRDT_CMD
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
comment|/* Stage2 -> EH */
name|max_credit
operator|=
name|cfg
index|[
name|hwport
index|]
operator|.
name|max_eh_offset
operator|+
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
name|start_ctxt
init|;
name|i
operator|<
name|limit
condition|;
name|i
operator|++
control|)
block|{
name|credit
operator|=
name|cfg
index|[
name|hwport
index|]
operator|.
name|stg2_eh_credit
operator|/
name|max_ctxts
expr_stmt|;
if|if
condition|(
name|credit
operator|>
name|max_credit
condition|)
name|credit
operator|=
name|max_credit
expr_stmt|;
name|data
operator|=
name|credit
operator|<<
literal|16
operator||
name|i
operator|<<
literal|4
operator||
literal|1
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_STG2_EHCRDT_CMD
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
comment|/* Stage2 -> Frout */
name|max_credit
operator|=
name|cfg
index|[
name|hwport
index|]
operator|.
name|max_frout_offset
operator|+
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
name|start_ctxt
init|;
name|i
operator|<
name|limit
condition|;
name|i
operator|++
control|)
block|{
name|credit
operator|=
name|cfg
index|[
name|hwport
index|]
operator|.
name|stg2_frout_credit
operator|/
name|max_ctxts
expr_stmt|;
if|if
condition|(
name|credit
operator|>
name|max_credit
condition|)
name|credit
operator|=
name|max_credit
expr_stmt|;
name|data
operator|=
name|credit
operator|<<
literal|16
operator||
name|i
operator|<<
literal|4
operator||
literal|1
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_EH_FREECRDT_CMD
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
comment|/* Stage2 -> MS */
name|max_credit
operator|=
name|cfg
index|[
name|hwport
index|]
operator|.
name|max_ms_offset
operator|+
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
name|start_ctxt
init|;
name|i
operator|<
name|limit
condition|;
name|i
operator|++
control|)
block|{
name|credit
operator|=
name|cfg
index|[
name|hwport
index|]
operator|.
name|stg2_ms_credit
operator|/
name|max_ctxts
expr_stmt|;
if|if
condition|(
name|credit
operator|>
name|max_credit
condition|)
name|credit
operator|=
name|max_credit
expr_stmt|;
name|data
operator|=
name|credit
operator|<<
literal|16
operator||
name|i
operator|<<
literal|4
operator||
literal|1
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_STG2_STRCRDT_CMD
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|nlm_config_freein_fifo_uniq_cfg
parameter_list|(
name|uint64_t
name|nae_base
parameter_list|,
name|int
name|port
parameter_list|,
name|int
name|nblock_free_desc
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|;
name|int
name|size_in_clines
decl_stmt|;
name|size_in_clines
operator|=
operator|(
name|nblock_free_desc
operator|/
name|NAE_CACHELINE_SIZE
operator|)
expr_stmt|;
name|val
operator|=
operator|(
name|size_in_clines
operator|<<
literal|8
operator|)
operator||
operator|(
name|port
operator|&
literal|0x1f
operator|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_FREEIN_FIFO_UNIQ_SZ_CFG
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* XXXJC: redundant, see ucore_spray_config() */
end_comment

begin_function
name|void
name|nlm_config_ucore_iface_mask_cfg
parameter_list|(
name|uint64_t
name|nae_base
parameter_list|,
name|int
name|port
parameter_list|,
name|int
name|nblock_ucore_mask
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|;
name|val
operator|=
operator|(
literal|0x1U
operator|<<
literal|31
operator|)
operator||
operator|(
operator|(
name|nblock_ucore_mask
operator|&
literal|0xffff
operator|)
operator|<<
literal|8
operator|)
operator||
operator|(
name|port
operator|&
literal|0x1f
operator|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_UCORE_IFACEMASK_CFG
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|nlm_nae_init_netior
parameter_list|(
name|uint64_t
name|nae_base
parameter_list|,
name|int
name|nblocks
parameter_list|)
block|{
name|uint32_t
name|ctrl1
decl_stmt|,
name|ctrl2
decl_stmt|,
name|ctrl3
decl_stmt|;
if|if
condition|(
name|nblocks
operator|==
literal|5
condition|)
name|ctrl3
operator|=
literal|0x07
operator|<<
literal|18
expr_stmt|;
else|else
name|ctrl3
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|nblocks
condition|)
block|{
case|case
literal|2
case|:
name|ctrl1
operator|=
literal|0xff
expr_stmt|;
name|ctrl2
operator|=
literal|0x0707
expr_stmt|;
break|break;
case|case
literal|4
case|:
case|case
literal|5
case|:
name|ctrl1
operator|=
literal|0xfffff
expr_stmt|;
name|ctrl2
operator|=
literal|0x07070707
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"WARNING: unsupported blocks %d\n"
argument_list|,
name|nblocks
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_LANE_CFG_SOFTRESET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_NETIOR_MISC_CTRL3
argument_list|,
name|ctrl3
argument_list|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_NETIOR_MISC_CTRL2
argument_list|,
name|ctrl2
argument_list|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_NETIOR_MISC_CTRL1
argument_list|,
name|ctrl1
argument_list|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_NETIOR_MISC_CTRL1
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|void
name|nlm_nae_init_ingress
parameter_list|(
name|uint64_t
name|nae_base
parameter_list|,
name|uint32_t
name|desc_size
parameter_list|)
block|{
name|uint32_t
name|rx_cfg
decl_stmt|;
name|uint32_t
name|parser_threshold
init|=
literal|384
decl_stmt|;
name|rx_cfg
operator|=
name|nlm_read_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_RX_CONFIG
argument_list|)
expr_stmt|;
name|rx_cfg
operator|&=
operator|~
operator|(
literal|0x3
operator|<<
literal|1
operator|)
expr_stmt|;
comment|/* reset max message size */
name|rx_cfg
operator|&=
operator|~
operator|(
literal|0xff
operator|<<
literal|4
operator|)
expr_stmt|;
comment|/* clear freein desc cluster size */
name|rx_cfg
operator|&=
operator|~
operator|(
literal|0x3f
operator|<<
literal|24
operator|)
expr_stmt|;
comment|/* reset rx status mask */
comment|/*XXX: why not 7f */
name|rx_cfg
operator||=
literal|1
expr_stmt|;
comment|/* rx enable */
name|rx_cfg
operator||=
operator|(
literal|0x0
operator|<<
literal|1
operator|)
expr_stmt|;
comment|/* max message size */
name|rx_cfg
operator||=
operator|(
literal|0x43
operator|&
literal|0x7f
operator|)
operator|<<
literal|24
expr_stmt|;
comment|/* rx status mask */
name|rx_cfg
operator||=
operator|(
operator|(
name|desc_size
operator|/
literal|64
operator|)
operator|&
literal|0xff
operator|)
operator|<<
literal|4
expr_stmt|;
comment|/* freein desc cluster size */
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_RX_CONFIG
argument_list|,
name|rx_cfg
argument_list|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_PARSER_CONFIG
argument_list|,
operator|(
name|parser_threshold
operator|&
literal|0x3ff
operator|)
operator||
operator|(
operator|(
operator|(
name|parser_threshold
operator|/
name|desc_size
operator|)
operator|+
literal|1
operator|)
operator|&
literal|0xff
operator|)
operator|<<
literal|12
operator||
operator|(
operator|(
operator|(
name|parser_threshold
operator|/
literal|64
operator|)
operator|%
name|desc_size
operator|)
operator|&
literal|0xff
operator|)
operator|<<
literal|20
argument_list|)
expr_stmt|;
comment|/*nlm_write_nae_reg(nae_base, NAE_RX_FREE_FIFO_THRESH, 33);*/
block|}
end_function

begin_function
name|void
name|nlm_nae_init_egress
parameter_list|(
name|uint64_t
name|nae_base
parameter_list|)
block|{
name|uint32_t
name|tx_cfg
decl_stmt|;
name|tx_cfg
operator|=
name|nlm_read_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_TX_CONFIG
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|nlm_is_xlp8xx_ax
argument_list|()
condition|)
block|{
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_TX_CONFIG
argument_list|,
name|tx_cfg
operator||
literal|0x1
operator||
comment|/* tx enable */
literal|0x2
operator||
comment|/* tx ace */
literal|0x4
operator||
comment|/* tx compatible */
operator|(
literal|1
operator|<<
literal|3
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_TX_CONFIG
argument_list|,
name|tx_cfg
operator||
literal|0x1
operator||
comment|/* tx enable */
literal|0x2
argument_list|)
expr_stmt|;
comment|/* tx ace */
block|}
block|}
end_function

begin_function
name|uint32_t
name|ucore_spray_config
parameter_list|(
name|uint32_t
name|interface
parameter_list|,
name|uint32_t
name|ucore_mask
parameter_list|,
name|int
name|cmd
parameter_list|)
block|{
return|return
operator|(
operator|(
name|cmd
operator|&
literal|0x1
operator|)
operator|<<
literal|31
operator|)
operator||
operator|(
operator|(
name|ucore_mask
operator|&
literal|0xffff
operator|)
operator|<<
literal|8
operator|)
operator||
operator|(
name|interface
operator|&
literal|0x1f
operator|)
return|;
block|}
end_function

begin_function
name|void
name|nlm_nae_init_ucore
parameter_list|(
name|uint64_t
name|nae_base
parameter_list|,
name|int
name|if_num
parameter_list|,
name|u_int
name|ucore_mask
parameter_list|)
block|{
name|uint32_t
name|ucfg
decl_stmt|;
name|ucfg
operator|=
name|ucore_spray_config
argument_list|(
name|if_num
argument_list|,
name|ucore_mask
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* 1 : write */
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_UCORE_IFACEMASK_CFG
argument_list|,
name|ucfg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|uint64_t
name|nae_tx_desc
parameter_list|(
name|u_int
name|type
parameter_list|,
name|u_int
name|rdex
parameter_list|,
name|u_int
name|fbid
parameter_list|,
name|u_int
name|len
parameter_list|,
name|uint64_t
name|addr
parameter_list|)
block|{
return|return
operator|(
operator|(
name|uint64_t
operator|)
name|type
operator|<<
literal|62
operator|)
operator||
operator|(
operator|(
name|uint64_t
operator|)
name|rdex
operator|<<
literal|61
operator|)
operator||
operator|(
operator|(
name|uint64_t
operator|)
name|fbid
operator|<<
literal|54
operator|)
operator||
operator|(
operator|(
name|uint64_t
operator|)
name|len
operator|<<
literal|40
operator|)
operator||
name|addr
return|;
block|}
end_function

begin_function
name|void
name|nlm_setup_l2type
parameter_list|(
name|uint64_t
name|nae_base
parameter_list|,
name|int
name|hwport
parameter_list|,
name|uint32_t
name|l2extlen
parameter_list|,
name|uint32_t
name|l2extoff
parameter_list|,
name|uint32_t
name|extra_hdrsize
parameter_list|,
name|uint32_t
name|proto_offset
parameter_list|,
name|uint32_t
name|fixed_hdroff
parameter_list|,
name|uint32_t
name|l2proto
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|;
name|val
operator|=
operator|(
operator|(
name|l2extlen
operator|&
literal|0x3f
operator|)
operator|<<
literal|26
operator|)
operator||
operator|(
operator|(
name|l2extoff
operator|&
literal|0x3f
operator|)
operator|<<
literal|20
operator|)
operator||
operator|(
operator|(
name|extra_hdrsize
operator|&
literal|0x3f
operator|)
operator|<<
literal|14
operator|)
operator||
operator|(
operator|(
name|proto_offset
operator|&
literal|0x3f
operator|)
operator|<<
literal|8
operator|)
operator||
operator|(
operator|(
name|fixed_hdroff
operator|&
literal|0x3f
operator|)
operator|<<
literal|2
operator|)
operator||
operator|(
name|l2proto
operator|&
literal|0x3
operator|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
operator|(
name|NAE_L2_TYPE_PORT0
operator|+
name|hwport
operator|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|nlm_setup_l3ctable_mask
parameter_list|(
name|uint64_t
name|nae_base
parameter_list|,
name|int
name|hwport
parameter_list|,
name|uint32_t
name|ptmask
parameter_list|,
name|uint32_t
name|l3portmask
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|;
name|val
operator|=
operator|(
operator|(
name|ptmask
operator|&
literal|0x1
operator|)
operator|<<
literal|6
operator|)
operator||
operator|(
operator|(
name|l3portmask
operator|&
literal|0x1
operator|)
operator|<<
literal|5
operator|)
operator||
operator|(
name|hwport
operator|&
literal|0x1f
operator|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_L3_CTABLE_MASK0
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|nlm_setup_l3ctable_even
parameter_list|(
name|uint64_t
name|nae_base
parameter_list|,
name|int
name|entry
parameter_list|,
name|uint32_t
name|l3hdroff
parameter_list|,
name|uint32_t
name|ipcsum_en
parameter_list|,
name|uint32_t
name|l4protooff
parameter_list|,
name|uint32_t
name|l2proto
parameter_list|,
name|uint32_t
name|eth_type
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|;
name|val
operator|=
operator|(
operator|(
name|l3hdroff
operator|&
literal|0x3f
operator|)
operator|<<
literal|26
operator|)
operator||
operator|(
operator|(
name|l4protooff
operator|&
literal|0x3f
operator|)
operator|<<
literal|20
operator|)
operator||
operator|(
operator|(
name|ipcsum_en
operator|&
literal|0x1
operator|)
operator|<<
literal|18
operator|)
operator||
operator|(
operator|(
name|l2proto
operator|&
literal|0x3
operator|)
operator|<<
literal|16
operator|)
operator||
operator|(
name|eth_type
operator|&
literal|0xffff
operator|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
operator|(
name|NAE_L3CTABLE0
operator|+
operator|(
name|entry
operator|*
literal|2
operator|)
operator|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|nlm_setup_l3ctable_odd
parameter_list|(
name|uint64_t
name|nae_base
parameter_list|,
name|int
name|entry
parameter_list|,
name|uint32_t
name|l3off0
parameter_list|,
name|uint32_t
name|l3len0
parameter_list|,
name|uint32_t
name|l3off1
parameter_list|,
name|uint32_t
name|l3len1
parameter_list|,
name|uint32_t
name|l3off2
parameter_list|,
name|uint32_t
name|l3len2
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|;
name|val
operator|=
operator|(
operator|(
name|l3off0
operator|&
literal|0x3f
operator|)
operator|<<
literal|26
operator|)
operator||
operator|(
operator|(
name|l3len0
operator|&
literal|0x1f
operator|)
operator|<<
literal|21
operator|)
operator||
operator|(
operator|(
name|l3off1
operator|&
literal|0x3f
operator|)
operator|<<
literal|15
operator|)
operator||
operator|(
operator|(
name|l3len1
operator|&
literal|0x1f
operator|)
operator|<<
literal|10
operator|)
operator||
operator|(
operator|(
name|l3off2
operator|&
literal|0x3f
operator|)
operator|<<
literal|4
operator|)
operator||
operator|(
name|l3len2
operator|&
literal|0xf
operator|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
operator|(
name|NAE_L3CTABLE0
operator|+
operator|(
operator|(
name|entry
operator|*
literal|2
operator|)
operator|+
literal|1
operator|)
operator|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|nlm_setup_l4ctable_even
parameter_list|(
name|uint64_t
name|nae_base
parameter_list|,
name|int
name|entry
parameter_list|,
name|uint32_t
name|im
parameter_list|,
name|uint32_t
name|l3cm
parameter_list|,
name|uint32_t
name|l4pm
parameter_list|,
name|uint32_t
name|port
parameter_list|,
name|uint32_t
name|l3camaddr
parameter_list|,
name|uint32_t
name|l4proto
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|;
name|val
operator|=
operator|(
operator|(
name|im
operator|&
literal|0x1
operator|)
operator|<<
literal|19
operator|)
operator||
operator|(
operator|(
name|l3cm
operator|&
literal|0x1
operator|)
operator|<<
literal|18
operator|)
operator||
operator|(
operator|(
name|l4pm
operator|&
literal|0x1
operator|)
operator|<<
literal|17
operator|)
operator||
operator|(
operator|(
name|port
operator|&
literal|0x1f
operator|)
operator|<<
literal|12
operator|)
operator||
operator|(
operator|(
name|l3camaddr
operator|&
literal|0xf
operator|)
operator|<<
literal|8
operator|)
operator||
operator|(
name|l4proto
operator|&
literal|0xff
operator|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
operator|(
name|NAE_L4CTABLE0
operator|+
operator|(
name|entry
operator|*
literal|2
operator|)
operator|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|nlm_setup_l4ctable_odd
parameter_list|(
name|uint64_t
name|nae_base
parameter_list|,
name|int
name|entry
parameter_list|,
name|uint32_t
name|l4off0
parameter_list|,
name|uint32_t
name|l4len0
parameter_list|,
name|uint32_t
name|l4off1
parameter_list|,
name|uint32_t
name|l4len1
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|;
name|val
operator|=
operator|(
operator|(
name|l4off0
operator|&
literal|0x3f
operator|)
operator|<<
literal|21
operator|)
operator||
operator|(
operator|(
name|l4len0
operator|&
literal|0xf
operator|)
operator|<<
literal|17
operator|)
operator||
operator|(
operator|(
name|l4off1
operator|&
literal|0x3f
operator|)
operator|<<
literal|11
operator|)
operator||
operator|(
name|l4len1
operator|&
literal|0xf
operator|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
operator|(
name|NAE_L4CTABLE0
operator|+
operator|(
operator|(
name|entry
operator|*
literal|2
operator|)
operator|+
literal|1
operator|)
operator|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|nlm_enable_hardware_parser
parameter_list|(
name|uint64_t
name|nae_base
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|;
name|val
operator|=
name|nlm_read_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_RX_CONFIG
argument_list|)
expr_stmt|;
name|val
operator||=
operator|(
literal|1
operator|<<
literal|12
operator|)
expr_stmt|;
comment|/* hardware parser enable */
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_RX_CONFIG
argument_list|,
name|val
argument_list|)
expr_stmt|;
comment|/***********************************************  	 * program L3 CAM table 	 ***********************************************/
comment|/* 	 *  entry-0 is ipv4 MPLS type 1 label  	 */
comment|/* l3hdroff = 4 bytes, ether_type = 0x8847 for MPLS_type1 */
name|nlm_setup_l3ctable_even
argument_list|(
name|nae_base
argument_list|,
literal|0
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
literal|9
argument_list|,
literal|1
argument_list|,
literal|0x8847
argument_list|)
expr_stmt|;
comment|/* l3off0 (8 bytes) -> l3len0 (1 byte) := ip proto 	 * l3off1 (12 bytes) -> l3len1 (4 bytes) := src ip 	 * l3off2 (16 bytes) -> l3len2 (4 bytes) := dst ip 	 */
name|nlm_setup_l3ctable_odd
argument_list|(
name|nae_base
argument_list|,
literal|0
argument_list|,
literal|9
argument_list|,
literal|1
argument_list|,
literal|12
argument_list|,
literal|4
argument_list|,
literal|16
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/* 	 * entry-1 is for ethernet IPv4 packets 	 */
name|nlm_setup_l3ctable_even
argument_list|(
name|nae_base
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|9
argument_list|,
literal|1
argument_list|,
literal|0x0800
argument_list|)
expr_stmt|;
comment|/* l3off0 (8 bytes) -> l3len0 (1 byte) := ip proto 	 * l3off1 (12 bytes) -> l3len1 (4 bytes) := src ip 	 * l3off2 (16 bytes) -> l3len2 (4 bytes) := dst ip 	 */
name|nlm_setup_l3ctable_odd
argument_list|(
name|nae_base
argument_list|,
literal|1
argument_list|,
literal|9
argument_list|,
literal|1
argument_list|,
literal|12
argument_list|,
literal|4
argument_list|,
literal|16
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/* 	 * entry-2 is for ethernet IPv6 packets 	 */
name|nlm_setup_l3ctable_even
argument_list|(
name|nae_base
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|6
argument_list|,
literal|1
argument_list|,
literal|0x86dd
argument_list|)
expr_stmt|;
comment|/* l3off0 (6 bytes) -> l3len0 (1 byte) := next header (ip proto) 	 * l3off1 (8 bytes) -> l3len1 (16 bytes) := src ip 	 * l3off2 (24 bytes) -> l3len2 (16 bytes) := dst ip 	 */
name|nlm_setup_l3ctable_odd
argument_list|(
name|nae_base
argument_list|,
literal|2
argument_list|,
literal|6
argument_list|,
literal|1
argument_list|,
literal|8
argument_list|,
literal|16
argument_list|,
literal|24
argument_list|,
literal|16
argument_list|)
expr_stmt|;
comment|/* 	 * entry-3 is for ethernet ARP packets 	 */
name|nlm_setup_l3ctable_even
argument_list|(
name|nae_base
argument_list|,
literal|3
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|9
argument_list|,
literal|1
argument_list|,
literal|0x0806
argument_list|)
expr_stmt|;
comment|/* extract 30 bytes from packet start */
name|nlm_setup_l3ctable_odd
argument_list|(
name|nae_base
argument_list|,
literal|3
argument_list|,
literal|0
argument_list|,
literal|30
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* 	 * entry-4 is for ethernet FCoE packets 	 */
name|nlm_setup_l3ctable_even
argument_list|(
name|nae_base
argument_list|,
literal|4
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|9
argument_list|,
literal|1
argument_list|,
literal|0x8906
argument_list|)
expr_stmt|;
comment|/* FCoE packet consists of 4 byte start-of-frame, 	 * and 24 bytes of frame header, followed by 	 * 64 bytes of optional-header (ESP, network..),  	 * 2048 bytes of payload, 36 bytes of optional 	 * "fill bytes" or ESP trailer, 4 bytes of CRC, 	 * and 4 bytes of end-of-frame 	 * We extract the first 4 + 24 = 28 bytes  	 */
name|nlm_setup_l3ctable_odd
argument_list|(
name|nae_base
argument_list|,
literal|4
argument_list|,
literal|0
argument_list|,
literal|28
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* 	 * entry-5 is for vlan tagged frames (0x8100) 	 */
name|nlm_setup_l3ctable_even
argument_list|(
name|nae_base
argument_list|,
literal|5
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|9
argument_list|,
literal|1
argument_list|,
literal|0x8100
argument_list|)
expr_stmt|;
comment|/* we extract 31 bytes from the payload */
name|nlm_setup_l3ctable_odd
argument_list|(
name|nae_base
argument_list|,
literal|5
argument_list|,
literal|0
argument_list|,
literal|31
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* 	 * entry-6 is for ieee 802.1ad provider bridging 	 * tagged frames (0x88a8) 	 */
name|nlm_setup_l3ctable_even
argument_list|(
name|nae_base
argument_list|,
literal|6
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|9
argument_list|,
literal|1
argument_list|,
literal|0x88a8
argument_list|)
expr_stmt|;
comment|/* we extract 31 bytes from the payload */
name|nlm_setup_l3ctable_odd
argument_list|(
name|nae_base
argument_list|,
literal|6
argument_list|,
literal|0
argument_list|,
literal|31
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* 	 * entry-7 is for Cisco's Q-in-Q tagged frames (0x9100) 	 */
name|nlm_setup_l3ctable_even
argument_list|(
name|nae_base
argument_list|,
literal|7
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|9
argument_list|,
literal|1
argument_list|,
literal|0x9100
argument_list|)
expr_stmt|;
comment|/* we extract 31 bytes from the payload */
name|nlm_setup_l3ctable_odd
argument_list|(
name|nae_base
argument_list|,
literal|7
argument_list|,
literal|0
argument_list|,
literal|31
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* 	 * entry-8 is for Ethernet Jumbo frames (0x8870) 	 */
name|nlm_setup_l3ctable_even
argument_list|(
name|nae_base
argument_list|,
literal|8
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|9
argument_list|,
literal|1
argument_list|,
literal|0x8870
argument_list|)
expr_stmt|;
comment|/* we extract 31 bytes from the payload */
name|nlm_setup_l3ctable_odd
argument_list|(
name|nae_base
argument_list|,
literal|8
argument_list|,
literal|0
argument_list|,
literal|31
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* 	 * entry-9 is for MPLS Multicast frames (0x8848) 	 */
name|nlm_setup_l3ctable_even
argument_list|(
name|nae_base
argument_list|,
literal|9
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|9
argument_list|,
literal|1
argument_list|,
literal|0x8848
argument_list|)
expr_stmt|;
comment|/* we extract 31 bytes from the payload */
name|nlm_setup_l3ctable_odd
argument_list|(
name|nae_base
argument_list|,
literal|9
argument_list|,
literal|0
argument_list|,
literal|31
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* 	 * entry-10 is for IEEE 802.1ae MAC Security frames (0x88e5) 	 */
name|nlm_setup_l3ctable_even
argument_list|(
name|nae_base
argument_list|,
literal|10
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|9
argument_list|,
literal|1
argument_list|,
literal|0x88e5
argument_list|)
expr_stmt|;
comment|/* we extract 31 bytes from the payload */
name|nlm_setup_l3ctable_odd
argument_list|(
name|nae_base
argument_list|,
literal|10
argument_list|,
literal|0
argument_list|,
literal|31
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* 	 * entry-11 is for PTP frames (0x88f7) 	 */
name|nlm_setup_l3ctable_even
argument_list|(
name|nae_base
argument_list|,
literal|11
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|9
argument_list|,
literal|1
argument_list|,
literal|0x88f7
argument_list|)
expr_stmt|;
comment|/* PTP messages can be sent as UDP messages over 	 * IPv4 or IPv6; and as a raw ethernet message 	 * with ethertype 0x88f7. The message contents 	 * are the same for UDP or ethernet based encapsulations 	 * The header is 34 bytes long, and we extract 	 * it all out. 	 */
name|nlm_setup_l3ctable_odd
argument_list|(
name|nae_base
argument_list|,
literal|11
argument_list|,
literal|0
argument_list|,
literal|31
argument_list|,
literal|31
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* 	 * entry-12 is for ethernet Link Control Protocol (LCP) 	 * used with PPPoE 	 */
name|nlm_setup_l3ctable_even
argument_list|(
name|nae_base
argument_list|,
literal|12
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|9
argument_list|,
literal|1
argument_list|,
literal|0xc021
argument_list|)
expr_stmt|;
comment|/* LCP packet consists of 1 byte of code, 1 byte of 	 * identifier and two bytes of length followed by 	 * data (upto length bytes). 	 * We extract 4 bytes from start of packet 	 */
name|nlm_setup_l3ctable_odd
argument_list|(
name|nae_base
argument_list|,
literal|12
argument_list|,
literal|0
argument_list|,
literal|4
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* 	 * entry-13 is for ethernet Link Quality Report (0xc025) 	 * used with PPPoE 	 */
name|nlm_setup_l3ctable_even
argument_list|(
name|nae_base
argument_list|,
literal|13
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|9
argument_list|,
literal|1
argument_list|,
literal|0xc025
argument_list|)
expr_stmt|;
comment|/* We extract 31 bytes from packet start */
name|nlm_setup_l3ctable_odd
argument_list|(
name|nae_base
argument_list|,
literal|13
argument_list|,
literal|0
argument_list|,
literal|31
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* 	 * entry-14 is for PPPoE Session (0x8864) 	 */
name|nlm_setup_l3ctable_even
argument_list|(
name|nae_base
argument_list|,
literal|14
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|9
argument_list|,
literal|1
argument_list|,
literal|0x8864
argument_list|)
expr_stmt|;
comment|/* We extract 31 bytes from packet start */
name|nlm_setup_l3ctable_odd
argument_list|(
name|nae_base
argument_list|,
literal|14
argument_list|,
literal|0
argument_list|,
literal|31
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* 	 * entry-15 - default entry 	 */
name|nlm_setup_l3ctable_even
argument_list|(
name|nae_base
argument_list|,
literal|15
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0x0000
argument_list|)
expr_stmt|;
comment|/* We extract 31 bytes from packet start */
name|nlm_setup_l3ctable_odd
argument_list|(
name|nae_base
argument_list|,
literal|15
argument_list|,
literal|0
argument_list|,
literal|31
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/***********************************************  	 * program L4 CAM table 	 ***********************************************/
comment|/* 	 * entry-0 - tcp packets (0x6) 	 */
name|nlm_setup_l4ctable_even
argument_list|(
name|nae_base
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0x6
argument_list|)
expr_stmt|;
comment|/* tcp header is 20 bytes without tcp options  	 * We extract 20 bytes from tcp start */
name|nlm_setup_l4ctable_odd
argument_list|(
name|nae_base
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|15
argument_list|,
literal|15
argument_list|,
literal|5
argument_list|)
expr_stmt|;
comment|/* 	 * entry-1 - udp packets (0x11) 	 */
name|nlm_setup_l4ctable_even
argument_list|(
name|nae_base
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0x11
argument_list|)
expr_stmt|;
comment|/* udp header is 8 bytes in size. 	 * We extract 8 bytes from udp start */
name|nlm_setup_l4ctable_odd
argument_list|(
name|nae_base
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
literal|8
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* 	 * entry-2 - sctp packets (0x84) 	 */
name|nlm_setup_l4ctable_even
argument_list|(
name|nae_base
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0x84
argument_list|)
expr_stmt|;
comment|/* sctp packets have a 12 byte generic header 	 * and various chunks. 	 * We extract 12 bytes from sctp start */
name|nlm_setup_l4ctable_odd
argument_list|(
name|nae_base
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|,
literal|12
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* 	 * entry-3 - RDP packets (0x1b) 	 */
name|nlm_setup_l4ctable_even
argument_list|(
name|nae_base
argument_list|,
literal|3
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0x1b
argument_list|)
expr_stmt|;
comment|/* RDP packets have 18 bytes of generic header  	 * before variable header starts. 	 * We extract 18 bytes from rdp start */
name|nlm_setup_l4ctable_odd
argument_list|(
name|nae_base
argument_list|,
literal|3
argument_list|,
literal|0
argument_list|,
literal|15
argument_list|,
literal|15
argument_list|,
literal|3
argument_list|)
expr_stmt|;
comment|/* 	 * entry-4 - DCCP packets (0x21) 	 */
name|nlm_setup_l4ctable_even
argument_list|(
name|nae_base
argument_list|,
literal|4
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0x21
argument_list|)
expr_stmt|;
comment|/* DCCP has two types of generic headers of 	 * sizes 16 bytes and 12 bytes if X = 1. 	 * We extract 16 bytes from dccp start */
name|nlm_setup_l4ctable_odd
argument_list|(
name|nae_base
argument_list|,
literal|4
argument_list|,
literal|0
argument_list|,
literal|15
argument_list|,
literal|15
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* 	 * entry-5 - ipv6 encapsulated in ipv4 packets (0x29) 	 */
name|nlm_setup_l4ctable_even
argument_list|(
name|nae_base
argument_list|,
literal|5
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0x29
argument_list|)
expr_stmt|;
comment|/* ipv4 header is 20 bytes excluding IP options. 	 * We extract 20 bytes from IPv4 start */
name|nlm_setup_l4ctable_odd
argument_list|(
name|nae_base
argument_list|,
literal|5
argument_list|,
literal|0
argument_list|,
literal|15
argument_list|,
literal|15
argument_list|,
literal|5
argument_list|)
expr_stmt|;
comment|/* 	 * entry-6 - ip in ip encapsulation packets (0x04) 	 */
name|nlm_setup_l4ctable_even
argument_list|(
name|nae_base
argument_list|,
literal|6
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0x04
argument_list|)
expr_stmt|;
comment|/* ipv4 header is 20 bytes excluding IP options. 	 * We extract 20 bytes from ipv4 start */
name|nlm_setup_l4ctable_odd
argument_list|(
name|nae_base
argument_list|,
literal|6
argument_list|,
literal|0
argument_list|,
literal|15
argument_list|,
literal|15
argument_list|,
literal|5
argument_list|)
expr_stmt|;
comment|/* 	 * entry-7 - default entry (0x0) 	 */
name|nlm_setup_l4ctable_even
argument_list|(
name|nae_base
argument_list|,
literal|7
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
comment|/* We extract 20 bytes from packet start */
name|nlm_setup_l4ctable_odd
argument_list|(
name|nae_base
argument_list|,
literal|7
argument_list|,
literal|0
argument_list|,
literal|15
argument_list|,
literal|15
argument_list|,
literal|5
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|nlm_enable_hardware_parser_per_port
parameter_list|(
name|uint64_t
name|nae_base
parameter_list|,
name|int
name|block
parameter_list|,
name|int
name|port
parameter_list|)
block|{
name|int
name|hwport
init|=
operator|(
name|block
operator|*
literal|4
operator|)
operator|+
operator|(
name|port
operator|&
literal|0x3
operator|)
decl_stmt|;
comment|/* program L2 and L3 header extraction for each port */
comment|/* enable ethernet L2 mode on port */
name|nlm_setup_l2type
argument_list|(
name|nae_base
argument_list|,
name|hwport
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* l2proto and ethtype included in l3cam */
name|nlm_setup_l3ctable_mask
argument_list|(
name|nae_base
argument_list|,
name|hwport
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|nlm_prepad_enable
parameter_list|(
name|uint64_t
name|nae_base
parameter_list|,
name|int
name|size
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|;
name|val
operator|=
name|nlm_read_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_RX_CONFIG
argument_list|)
expr_stmt|;
name|val
operator||=
operator|(
literal|1
operator|<<
literal|13
operator|)
expr_stmt|;
comment|/* prepad enable */
name|val
operator||=
operator|(
operator|(
name|size
operator|&
literal|0x3
operator|)
operator|<<
literal|22
operator|)
expr_stmt|;
comment|/* prepad size */
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_RX_CONFIG
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|nlm_setup_1588_timer
parameter_list|(
name|uint64_t
name|nae_base
parameter_list|,
name|struct
name|nae_port_config
modifier|*
name|cfg
parameter_list|)
block|{
name|uint32_t
name|hi
decl_stmt|,
name|lo
decl_stmt|,
name|val
decl_stmt|;
name|hi
operator|=
name|cfg
index|[
literal|0
index|]
operator|.
name|ieee1588_userval
operator|>>
literal|32
expr_stmt|;
name|lo
operator|=
name|cfg
index|[
literal|0
index|]
operator|.
name|ieee1588_userval
operator|&
literal|0xffffffff
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_1588_PTP_USER_VALUE_HI
argument_list|,
name|hi
argument_list|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_1588_PTP_USER_VALUE_LO
argument_list|,
name|lo
argument_list|)
expr_stmt|;
name|hi
operator|=
name|cfg
index|[
literal|0
index|]
operator|.
name|ieee1588_ptpoff
operator|>>
literal|32
expr_stmt|;
name|lo
operator|=
name|cfg
index|[
literal|0
index|]
operator|.
name|ieee1588_ptpoff
operator|&
literal|0xffffffff
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_1588_PTP_OFFSET_HI
argument_list|,
name|hi
argument_list|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_1588_PTP_OFFSET_LO
argument_list|,
name|lo
argument_list|)
expr_stmt|;
name|hi
operator|=
name|cfg
index|[
literal|0
index|]
operator|.
name|ieee1588_tmr1
operator|>>
literal|32
expr_stmt|;
name|lo
operator|=
name|cfg
index|[
literal|0
index|]
operator|.
name|ieee1588_tmr1
operator|&
literal|0xffffffff
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_1588_PTP_TMR1_HI
argument_list|,
name|hi
argument_list|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_1588_PTP_TMR1_LO
argument_list|,
name|lo
argument_list|)
expr_stmt|;
name|hi
operator|=
name|cfg
index|[
literal|0
index|]
operator|.
name|ieee1588_tmr2
operator|>>
literal|32
expr_stmt|;
name|lo
operator|=
name|cfg
index|[
literal|0
index|]
operator|.
name|ieee1588_tmr2
operator|&
literal|0xffffffff
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_1588_PTP_TMR2_HI
argument_list|,
name|hi
argument_list|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_1588_PTP_TMR2_LO
argument_list|,
name|lo
argument_list|)
expr_stmt|;
name|hi
operator|=
name|cfg
index|[
literal|0
index|]
operator|.
name|ieee1588_tmr3
operator|>>
literal|32
expr_stmt|;
name|lo
operator|=
name|cfg
index|[
literal|0
index|]
operator|.
name|ieee1588_tmr3
operator|&
literal|0xffffffff
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_1588_PTP_TMR3_HI
argument_list|,
name|hi
argument_list|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_1588_PTP_TMR3_LO
argument_list|,
name|lo
argument_list|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_1588_PTP_INC_INTG
argument_list|,
name|cfg
index|[
literal|0
index|]
operator|.
name|ieee1588_inc_intg
argument_list|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_1588_PTP_INC_NUM
argument_list|,
name|cfg
index|[
literal|0
index|]
operator|.
name|ieee1588_inc_num
argument_list|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_1588_PTP_INC_DEN
argument_list|,
name|cfg
index|[
literal|0
index|]
operator|.
name|ieee1588_inc_den
argument_list|)
expr_stmt|;
name|val
operator|=
name|nlm_read_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_1588_PTP_CONTROL
argument_list|)
expr_stmt|;
comment|/* set and clear freq_mul = 1 */
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_1588_PTP_CONTROL
argument_list|,
name|val
operator||
operator|(
literal|0x1
operator|<<
literal|1
operator|)
argument_list|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_1588_PTP_CONTROL
argument_list|,
name|val
argument_list|)
expr_stmt|;
comment|/* set and clear load_user_val = 1 */
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_1588_PTP_CONTROL
argument_list|,
name|val
operator||
operator|(
literal|0x1
operator|<<
literal|6
operator|)
argument_list|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_1588_PTP_CONTROL
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|nlm_mac_enable
parameter_list|(
name|uint64_t
name|nae_base
parameter_list|,
name|int
name|nblock
parameter_list|,
name|int
name|port_type
parameter_list|,
name|int
name|port
parameter_list|)
block|{
name|uint32_t
name|mac_cfg1
decl_stmt|,
name|xaui_cfg
decl_stmt|;
name|uint32_t
name|netwk_inf
decl_stmt|;
name|int
name|iface
init|=
name|port
operator|&
literal|0x3
decl_stmt|;
switch|switch
condition|(
name|port_type
condition|)
block|{
case|case
name|SGMIIC
case|:
name|netwk_inf
operator|=
name|nlm_read_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|SGMII_NET_IFACE_CTRL
argument_list|(
name|nblock
argument_list|,
name|iface
argument_list|)
argument_list|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|SGMII_NET_IFACE_CTRL
argument_list|(
name|nblock
argument_list|,
name|iface
argument_list|)
argument_list|,
name|netwk_inf
operator||
operator|(
literal|1
operator|<<
literal|2
operator|)
argument_list|)
expr_stmt|;
comment|/* enable tx */
name|mac_cfg1
operator|=
name|nlm_read_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|SGMII_MAC_CONF1
argument_list|(
name|nblock
argument_list|,
name|iface
argument_list|)
argument_list|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|SGMII_MAC_CONF1
argument_list|(
name|nblock
argument_list|,
name|iface
argument_list|)
argument_list|,
name|mac_cfg1
operator||
operator|(
literal|1
operator|<<
literal|2
operator|)
operator||
comment|/* rx enable */
literal|1
argument_list|)
expr_stmt|;
comment|/* tx enable */
break|break;
case|case
name|XAUIC
case|:
name|xaui_cfg
operator|=
name|nlm_read_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|XAUI_CONFIG1
argument_list|(
name|nblock
argument_list|)
argument_list|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|XAUI_CONFIG1
argument_list|(
name|nblock
argument_list|)
argument_list|,
name|xaui_cfg
operator||
name|XAUI_CONFIG_TFEN
operator||
name|XAUI_CONFIG_RFEN
argument_list|)
expr_stmt|;
break|break;
case|case
name|ILC
case|:
break|break;
block|}
block|}
end_function

begin_function
name|void
name|nlm_mac_disable
parameter_list|(
name|uint64_t
name|nae_base
parameter_list|,
name|int
name|nblock
parameter_list|,
name|int
name|port_type
parameter_list|,
name|int
name|port
parameter_list|)
block|{
name|uint32_t
name|mac_cfg1
decl_stmt|,
name|xaui_cfg
decl_stmt|;
name|uint32_t
name|netwk_inf
decl_stmt|;
name|int
name|iface
init|=
name|port
operator|&
literal|0x3
decl_stmt|;
switch|switch
condition|(
name|port_type
condition|)
block|{
case|case
name|SGMIIC
case|:
name|mac_cfg1
operator|=
name|nlm_read_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|SGMII_MAC_CONF1
argument_list|(
name|nblock
argument_list|,
name|iface
argument_list|)
argument_list|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|SGMII_MAC_CONF1
argument_list|(
name|nblock
argument_list|,
name|iface
argument_list|)
argument_list|,
name|mac_cfg1
operator|&
operator|~
operator|(
operator|(
literal|1
operator|<<
literal|2
operator|)
operator||
comment|/* rx enable */
literal|1
operator|)
argument_list|)
expr_stmt|;
comment|/* tx enable */
name|netwk_inf
operator|=
name|nlm_read_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|SGMII_NET_IFACE_CTRL
argument_list|(
name|nblock
argument_list|,
name|iface
argument_list|)
argument_list|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|SGMII_NET_IFACE_CTRL
argument_list|(
name|nblock
argument_list|,
name|iface
argument_list|)
argument_list|,
name|netwk_inf
operator|&
operator|~
operator|(
literal|1
operator|<<
literal|2
operator|)
argument_list|)
expr_stmt|;
comment|/* enable tx */
break|break;
case|case
name|XAUIC
case|:
name|xaui_cfg
operator|=
name|nlm_read_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|XAUI_CONFIG1
argument_list|(
name|nblock
argument_list|)
argument_list|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|XAUI_CONFIG1
argument_list|(
name|nblock
argument_list|)
argument_list|,
name|xaui_cfg
operator|&
operator|~
operator|(
name|XAUI_CONFIG_TFEN
operator||
name|XAUI_CONFIG_RFEN
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|ILC
case|:
break|break;
block|}
block|}
end_function

begin_comment
comment|/*  * Set IOR credits for the ports in ifmask to valmask  */
end_comment

begin_function
specifier|static
name|void
name|nlm_nae_set_ior_credit
parameter_list|(
name|uint64_t
name|nae_base
parameter_list|,
name|uint32_t
name|ifmask
parameter_list|,
name|uint32_t
name|valmask
parameter_list|)
block|{
name|uint32_t
name|tx_config
decl_stmt|,
name|tx_ior_credit
decl_stmt|;
name|tx_ior_credit
operator|=
name|nlm_read_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_TX_IORCRDT_INIT
argument_list|)
expr_stmt|;
name|tx_ior_credit
operator|&=
operator|~
name|ifmask
expr_stmt|;
name|tx_ior_credit
operator||=
name|valmask
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_TX_IORCRDT_INIT
argument_list|,
name|tx_ior_credit
argument_list|)
expr_stmt|;
name|tx_config
operator|=
name|nlm_read_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_TX_CONFIG
argument_list|)
expr_stmt|;
comment|/* need to toggle these bits for credits to be loaded */
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_TX_CONFIG
argument_list|,
name|tx_config
operator||
operator|(
name|TXINITIORCR
argument_list|(
name|ifmask
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_TX_CONFIG
argument_list|,
name|tx_config
operator|&
operator|~
operator|(
name|TXINITIORCR
argument_list|(
name|ifmask
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|nlm_nae_open_if
parameter_list|(
name|uint64_t
name|nae_base
parameter_list|,
name|int
name|nblock
parameter_list|,
name|int
name|port_type
parameter_list|,
name|int
name|port
parameter_list|,
name|uint32_t
name|desc_size
parameter_list|)
block|{
name|uint32_t
name|netwk_inf
decl_stmt|;
name|uint32_t
name|mac_cfg1
decl_stmt|,
name|netior_ctrl3
decl_stmt|;
name|int
name|iface
decl_stmt|,
name|iface_ctrl_reg
decl_stmt|,
name|iface_ctrl3_reg
decl_stmt|,
name|conf1_reg
decl_stmt|,
name|conf2_reg
decl_stmt|;
switch|switch
condition|(
name|port_type
condition|)
block|{
case|case
name|XAUIC
case|:
name|netwk_inf
operator|=
name|nlm_read_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|XAUI_NETIOR_XGMAC_CTRL1
argument_list|(
name|nblock
argument_list|)
argument_list|)
expr_stmt|;
name|netwk_inf
operator||=
operator|(
literal|1
operator|<<
name|NETIOR_XGMAC_STATS_CLR_POS
operator|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|XAUI_NETIOR_XGMAC_CTRL1
argument_list|(
name|nblock
argument_list|)
argument_list|,
name|netwk_inf
argument_list|)
expr_stmt|;
name|nlm_nae_set_ior_credit
argument_list|(
name|nae_base
argument_list|,
literal|0xf
operator|<<
name|port
argument_list|,
literal|0xf
operator|<<
name|port
argument_list|)
expr_stmt|;
break|break;
case|case
name|ILC
case|:
name|nlm_nae_set_ior_credit
argument_list|(
name|nae_base
argument_list|,
literal|0xff
operator|<<
name|port
argument_list|,
literal|0xff
operator|<<
name|port
argument_list|)
expr_stmt|;
break|break;
case|case
name|SGMIIC
case|:
name|nlm_nae_set_ior_credit
argument_list|(
name|nae_base
argument_list|,
literal|0x1
operator|<<
name|port
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* 		 * XXXJC: split this and merge to sgmii.c 		 * some of this is duplicated from there. 		 */
comment|/* init phy id to access internal PCS */
name|iface
operator|=
name|port
operator|&
literal|0x3
expr_stmt|;
name|iface_ctrl_reg
operator|=
name|SGMII_NET_IFACE_CTRL
argument_list|(
name|nblock
argument_list|,
name|iface
argument_list|)
expr_stmt|;
name|conf1_reg
operator|=
name|SGMII_MAC_CONF1
argument_list|(
name|nblock
argument_list|,
name|iface
argument_list|)
expr_stmt|;
name|conf2_reg
operator|=
name|SGMII_MAC_CONF2
argument_list|(
name|nblock
argument_list|,
name|iface
argument_list|)
expr_stmt|;
name|netwk_inf
operator|=
name|nlm_read_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|iface_ctrl_reg
argument_list|)
expr_stmt|;
name|netwk_inf
operator|&=
literal|0x7ffffff
expr_stmt|;
name|netwk_inf
operator||=
operator|(
name|port
operator|<<
literal|27
operator|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|iface_ctrl_reg
argument_list|,
name|netwk_inf
argument_list|)
expr_stmt|;
comment|/* Sofreset sgmii port - set bit 11 to 0  */
name|netwk_inf
operator|&=
literal|0xfffff7ff
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|iface_ctrl_reg
argument_list|,
name|netwk_inf
argument_list|)
expr_stmt|;
comment|/* Reset Gmac */
name|mac_cfg1
operator|=
name|nlm_read_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|conf1_reg
argument_list|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|conf1_reg
argument_list|,
name|mac_cfg1
operator||
operator|(
literal|1U
operator|<<
literal|31
operator|)
operator||
comment|/* soft reset */
operator|(
literal|1
operator|<<
literal|2
operator|)
operator||
comment|/* rx enable */
operator|(
literal|1
operator|)
argument_list|)
expr_stmt|;
comment|/* tx enable */
comment|/* default to 1G */
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|conf2_reg
argument_list|,
operator|(
literal|0x7
operator|<<
literal|12
operator|)
operator||
comment|/* interface preamble length */
operator|(
literal|0x2
operator|<<
literal|8
operator|)
operator||
comment|/* interface mode */
operator|(
literal|0x1
operator|<<
literal|2
operator|)
operator||
comment|/* pad crc enable */
operator|(
literal|0x1
operator|)
argument_list|)
expr_stmt|;
comment|/* full duplex */
comment|/* clear gmac reset */
name|mac_cfg1
operator|=
name|nlm_read_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|conf1_reg
argument_list|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|conf1_reg
argument_list|,
name|mac_cfg1
operator|&
operator|~
operator|(
literal|1U
operator|<<
literal|31
operator|)
argument_list|)
expr_stmt|;
comment|/* clear speed debug bit */
name|iface_ctrl3_reg
operator|=
name|SGMII_NET_IFACE_CTRL3
argument_list|(
name|nblock
argument_list|,
name|iface
argument_list|)
expr_stmt|;
name|netior_ctrl3
operator|=
name|nlm_read_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|iface_ctrl3_reg
argument_list|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|iface_ctrl3_reg
argument_list|,
name|netior_ctrl3
operator|&
operator|~
operator|(
literal|1
operator|<<
literal|6
operator|)
argument_list|)
expr_stmt|;
comment|/* disable TX, RX for now */
name|mac_cfg1
operator|=
name|nlm_read_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|conf1_reg
argument_list|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|conf1_reg
argument_list|,
name|mac_cfg1
operator|&
operator|~
operator|(
literal|0x5
operator|)
argument_list|)
expr_stmt|;
name|netwk_inf
operator|=
name|nlm_read_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|iface_ctrl_reg
argument_list|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|iface_ctrl_reg
argument_list|,
name|netwk_inf
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|2
operator|)
argument_list|)
expr_stmt|;
comment|/* clear stats counters */
name|netwk_inf
operator|=
name|nlm_read_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|iface_ctrl_reg
argument_list|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|iface_ctrl_reg
argument_list|,
name|netwk_inf
operator||
operator|(
literal|1
operator|<<
literal|15
operator|)
argument_list|)
expr_stmt|;
comment|/* enable stats counters */
name|netwk_inf
operator|=
name|nlm_read_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|iface_ctrl_reg
argument_list|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|iface_ctrl_reg
argument_list|,
operator|(
name|netwk_inf
operator|&
operator|~
operator|(
literal|1
operator|<<
literal|15
operator|)
operator|)
operator||
operator|(
literal|1
operator|<<
literal|16
operator|)
argument_list|)
expr_stmt|;
comment|/* flow control? */
name|mac_cfg1
operator|=
name|nlm_read_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|conf1_reg
argument_list|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|conf1_reg
argument_list|,
name|mac_cfg1
operator||
operator|(
literal|0x3
operator|<<
literal|4
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|nlm_nae_init_ingress
argument_list|(
name|nae_base
argument_list|,
name|desc_size
argument_list|)
expr_stmt|;
name|nlm_nae_init_egress
argument_list|(
name|nae_base
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


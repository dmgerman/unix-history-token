begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2003-2012 Broadcom Corporation  * All Rights Reserved  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in  *    the documentation and/or other materials provided with the  *    distribution.  *  * THIS SOFTWARE IS PROVIDED BY BROADCOM ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED  * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED. IN NO EVENT SHALL BROADCOM OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR  * BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,  * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE  * OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN  * IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<mips/nlm/hal/mips-extns.h>
end_include

begin_include
include|#
directive|include
file|<mips/nlm/hal/haldefs.h>
end_include

begin_include
include|#
directive|include
file|<mips/nlm/hal/iomap.h>
end_include

begin_include
include|#
directive|include
file|<mips/nlm/hal/sys.h>
end_include

begin_include
include|#
directive|include
file|<mips/nlm/hal/nae.h>
end_include

begin_include
include|#
directive|include
file|<mips/nlm/hal/mdio.h>
end_include

begin_include
include|#
directive|include
file|<mips/nlm/hal/sgmii.h>
end_include

begin_function
name|void
name|nlm_configure_sgmii_interface
parameter_list|(
name|uint64_t
name|nae_base
parameter_list|,
name|int
name|block
parameter_list|,
name|int
name|port
parameter_list|,
name|int
name|mtu
parameter_list|,
name|int
name|loopback
parameter_list|)
block|{
name|uint32_t
name|data1
decl_stmt|,
name|data2
decl_stmt|;
comment|/* Apply a soft reset */
name|data1
operator|=
operator|(
literal|0x1
operator|<<
literal|31
operator|)
expr_stmt|;
comment|/* soft reset */
if|if
condition|(
name|loopback
condition|)
name|data1
operator||=
operator|(
literal|0x01
operator|<<
literal|8
operator|)
expr_stmt|;
name|data1
operator||=
operator|(
literal|0x01
operator|<<
literal|2
operator|)
expr_stmt|;
comment|/* Rx enable */
name|data1
operator||=
literal|0x01
expr_stmt|;
comment|/* Tx enable */
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_REG
argument_list|(
name|block
argument_list|,
name|port
argument_list|,
name|MAC_CONF1
argument_list|)
argument_list|,
name|data1
argument_list|)
expr_stmt|;
name|data2
operator|=
operator|(
literal|0x7
operator|<<
literal|12
operator|)
operator||
comment|/* pre-amble length=7 */
operator|(
literal|0x2
operator|<<
literal|8
operator|)
operator||
comment|/* byteMode */
literal|0x1
expr_stmt|;
comment|/* fullDuplex */
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_REG
argument_list|(
name|block
argument_list|,
name|port
argument_list|,
name|MAC_CONF2
argument_list|)
argument_list|,
name|data2
argument_list|)
expr_stmt|;
comment|/* Remove a soft reset */
name|data1
operator|&=
operator|~
operator|(
literal|0x01
operator|<<
literal|31
operator|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|NAE_REG
argument_list|(
name|block
argument_list|,
name|port
argument_list|,
name|MAC_CONF1
argument_list|)
argument_list|,
name|data1
argument_list|)
expr_stmt|;
comment|/* setup sgmii max frame length */
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|SGMII_MAX_FRAME
argument_list|(
name|block
argument_list|,
name|port
argument_list|)
argument_list|,
name|mtu
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|nlm_sgmii_pcs_init
parameter_list|(
name|uint64_t
name|nae_base
parameter_list|,
name|uint32_t
name|cplx_mask
parameter_list|)
block|{
name|xlp_nae_config_lane_gmac
argument_list|(
name|nae_base
argument_list|,
name|cplx_mask
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|nlm_nae_setup_mac
parameter_list|(
name|uint64_t
name|nae_base
parameter_list|,
name|int
name|nblock
parameter_list|,
name|int
name|iface
parameter_list|,
name|int
name|reset
parameter_list|,
name|int
name|rx_en
parameter_list|,
name|int
name|tx_en
parameter_list|,
name|int
name|speed
parameter_list|,
name|int
name|duplex
parameter_list|)
block|{
name|uint32_t
name|mac_cfg1
decl_stmt|,
name|mac_cfg2
decl_stmt|,
name|netwk_inf
decl_stmt|;
name|mac_cfg1
operator|=
name|nlm_read_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|SGMII_MAC_CONF1
argument_list|(
name|nblock
argument_list|,
name|iface
argument_list|)
argument_list|)
expr_stmt|;
name|mac_cfg2
operator|=
name|nlm_read_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|SGMII_MAC_CONF2
argument_list|(
name|nblock
argument_list|,
name|iface
argument_list|)
argument_list|)
expr_stmt|;
name|netwk_inf
operator|=
name|nlm_read_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|SGMII_NET_IFACE_CTRL
argument_list|(
name|nblock
argument_list|,
name|iface
argument_list|)
argument_list|)
expr_stmt|;
name|mac_cfg1
operator|&=
operator|~
operator|(
literal|0x1
operator|<<
literal|31
operator|)
expr_stmt|;
comment|/* remove reset */
name|mac_cfg1
operator|&=
operator|~
operator|(
literal|0x1
operator|<<
literal|2
operator|)
expr_stmt|;
comment|/* remove rx */
name|mac_cfg1
operator|&=
operator|~
operator|(
literal|0x1
operator|)
expr_stmt|;
comment|/* remove tx */
name|mac_cfg2
operator|&=
operator|~
operator|(
literal|0x3
operator|<<
literal|8
operator|)
expr_stmt|;
comment|/* remove interface mode bits */
name|mac_cfg2
operator|&=
operator|~
operator|(
literal|0x1
operator|)
expr_stmt|;
comment|/* remove duplex */
name|netwk_inf
operator|&=
operator|~
operator|(
literal|0x1
operator|<<
literal|2
operator|)
expr_stmt|;
comment|/* remove tx */
name|netwk_inf
operator|&=
operator|~
operator|(
literal|0x3
operator|)
expr_stmt|;
comment|/* remove speed */
switch|switch
condition|(
name|speed
condition|)
block|{
case|case
name|NLM_SGMII_SPEED_10
case|:
name|netwk_inf
operator||=
literal|0x0
expr_stmt|;
comment|/* 2.5 Mhz clock for 10 Mbps */
name|mac_cfg2
operator||=
operator|(
literal|0x1
operator|<<
literal|8
operator|)
expr_stmt|;
comment|/* enable 10/100 Mbps */
break|break;
case|case
name|NLM_SGMII_SPEED_100
case|:
name|netwk_inf
operator||=
literal|0x1
expr_stmt|;
comment|/* 25 Mhz clock for 100 Mbps */
name|mac_cfg2
operator||=
operator|(
literal|0x1
operator|<<
literal|8
operator|)
expr_stmt|;
comment|/* enable 10/100 Mbps */
break|break;
default|default:
comment|/* make it as 1G */
name|netwk_inf
operator||=
literal|0x2
expr_stmt|;
comment|/* 125 Mhz clock for 1G */
name|mac_cfg2
operator||=
operator|(
literal|0x2
operator|<<
literal|8
operator|)
expr_stmt|;
comment|/* enable 1G */
break|break;
block|}
if|if
condition|(
name|reset
condition|)
name|mac_cfg1
operator||=
operator|(
literal|0x1
operator|<<
literal|31
operator|)
expr_stmt|;
comment|/* set reset */
if|if
condition|(
name|rx_en
condition|)
name|mac_cfg1
operator||=
operator|(
literal|0x1
operator|<<
literal|2
operator|)
expr_stmt|;
comment|/* set rx */
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|SGMII_NET_IFACE_CTRL
argument_list|(
name|nblock
argument_list|,
name|iface
argument_list|)
argument_list|,
name|netwk_inf
argument_list|)
expr_stmt|;
if|if
condition|(
name|tx_en
condition|)
block|{
name|mac_cfg1
operator||=
literal|0x1
expr_stmt|;
comment|/* set tx */
name|netwk_inf
operator||=
operator|(
literal|0x1
operator|<<
literal|2
operator|)
expr_stmt|;
comment|/* set tx */
block|}
switch|switch
condition|(
name|duplex
condition|)
block|{
case|case
name|NLM_SGMII_DUPLEX_HALF
case|:
comment|/* duplexity is already set to half duplex */
break|break;
default|default:
name|mac_cfg2
operator||=
literal|0x1
expr_stmt|;
comment|/* set full duplex */
block|}
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|SGMII_MAC_CONF1
argument_list|(
name|nblock
argument_list|,
name|iface
argument_list|)
argument_list|,
name|mac_cfg1
argument_list|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|SGMII_MAC_CONF2
argument_list|(
name|nblock
argument_list|,
name|iface
argument_list|)
argument_list|,
name|mac_cfg2
argument_list|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|nae_base
argument_list|,
name|SGMII_NET_IFACE_CTRL
argument_list|(
name|nblock
argument_list|,
name|iface
argument_list|)
argument_list|,
name|netwk_inf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|nlm_nae_setup_rx_mode_sgmii
parameter_list|(
name|uint64_t
name|base
parameter_list|,
name|int
name|nblock
parameter_list|,
name|int
name|iface
parameter_list|,
name|int
name|port_type
parameter_list|,
name|int
name|broadcast_en
parameter_list|,
name|int
name|multicast_en
parameter_list|,
name|int
name|pause_en
parameter_list|,
name|int
name|promisc_en
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|;
comment|/* bit[17] of vlan_typefilter - allows packet matching in MAC. 	 * When DA filtering is disabled, this bit and bit[16] should 	 * be zero. 	 * bit[16] of vlan_typefilter - Allows hash matching to be used 	 * for DA filtering. When DA filtering is disabled, this bit and 	 * bit[17] should be zero. 	 * Both bits have to be set only if you want to turn on both 	 * features / modes. 	 */
if|if
condition|(
name|promisc_en
operator|==
literal|1
condition|)
block|{
name|val
operator|=
name|nlm_read_nae_reg
argument_list|(
name|base
argument_list|,
name|SGMII_NETIOR_VLANTYPE_FILTER
argument_list|(
name|nblock
argument_list|,
name|iface
argument_list|)
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|(
operator|~
operator|(
literal|0x3
operator|<<
literal|16
operator|)
operator|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|base
argument_list|,
name|SGMII_NETIOR_VLANTYPE_FILTER
argument_list|(
name|nblock
argument_list|,
name|iface
argument_list|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|val
operator|=
name|nlm_read_nae_reg
argument_list|(
name|base
argument_list|,
name|SGMII_NETIOR_VLANTYPE_FILTER
argument_list|(
name|nblock
argument_list|,
name|iface
argument_list|)
argument_list|)
expr_stmt|;
name|val
operator||=
operator|(
literal|0x1
operator|<<
literal|17
operator|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|base
argument_list|,
name|SGMII_NETIOR_VLANTYPE_FILTER
argument_list|(
name|nblock
argument_list|,
name|iface
argument_list|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
name|val
operator|=
operator|(
operator|(
name|broadcast_en
operator|&
literal|0x1
operator|)
operator|<<
literal|10
operator|)
operator||
operator|(
operator|(
name|pause_en
operator|&
literal|0x1
operator|)
operator|<<
literal|9
operator|)
operator||
operator|(
operator|(
name|multicast_en
operator|&
literal|0x1
operator|)
operator|<<
literal|8
operator|)
operator||
operator|(
operator|(
name|promisc_en
operator|&
literal|0x1
operator|)
operator|<<
literal|7
operator|)
operator||
comment|/* unicast_enable - enables promisc mode */
literal|1
expr_stmt|;
comment|/* MAC address is always valid */
name|nlm_write_nae_reg
argument_list|(
name|base
argument_list|,
name|SGMII_MAC_FILTER_CONFIG
argument_list|(
name|nblock
argument_list|,
name|iface
argument_list|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|nlm_nae_setup_mac_addr_sgmii
parameter_list|(
name|uint64_t
name|base
parameter_list|,
name|int
name|nblock
parameter_list|,
name|int
name|iface
parameter_list|,
name|int
name|port_type
parameter_list|,
name|uint8_t
modifier|*
name|mac_addr
parameter_list|)
block|{
name|nlm_write_nae_reg
argument_list|(
name|base
argument_list|,
name|SGMII_MAC_ADDR0_LO
argument_list|(
name|nblock
argument_list|,
name|iface
argument_list|)
argument_list|,
operator|(
name|mac_addr
index|[
literal|5
index|]
operator|<<
literal|24
operator|)
operator||
operator|(
name|mac_addr
index|[
literal|4
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
name|mac_addr
index|[
literal|3
index|]
operator|<<
literal|8
operator|)
operator||
name|mac_addr
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|base
argument_list|,
name|SGMII_MAC_ADDR0_HI
argument_list|(
name|nblock
argument_list|,
name|iface
argument_list|)
argument_list|,
operator|(
name|mac_addr
index|[
literal|1
index|]
operator|<<
literal|24
operator|)
operator||
operator|(
name|mac_addr
index|[
literal|0
index|]
operator|<<
literal|16
operator|)
argument_list|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|base
argument_list|,
name|SGMII_MAC_ADDR_MASK0_LO
argument_list|(
name|nblock
argument_list|,
name|iface
argument_list|)
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|nlm_write_nae_reg
argument_list|(
name|base
argument_list|,
name|SGMII_MAC_ADDR_MASK0_HI
argument_list|(
name|nblock
argument_list|,
name|iface
argument_list|)
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|nlm_nae_setup_rx_mode_sgmii
argument_list|(
name|base
argument_list|,
name|nblock
argument_list|,
name|iface
argument_list|,
name|SGMIIC
argument_list|,
literal|1
argument_list|,
comment|/* broadcast enabled */
literal|1
argument_list|,
comment|/* multicast enabled */
literal|0
argument_list|,
comment|/* do not accept pause frames */
literal|0
comment|/* promisc mode disabled */
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


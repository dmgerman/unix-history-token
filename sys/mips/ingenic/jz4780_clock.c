begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright 2015 Alexander Kabaev<kan@FreeBSD.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_comment
comment|/*  * Ingenic JZ4780 CGU driver.  *  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<sys/resource.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<dev/fdt/fdt_common.h>
end_include

begin_include
include|#
directive|include
file|<dev/ofw/ofw_bus.h>
end_include

begin_include
include|#
directive|include
file|<dev/ofw/ofw_bus_subr.h>
end_include

begin_include
include|#
directive|include
file|<mips/ingenic/jz4780_clk.h>
end_include

begin_include
include|#
directive|include
file|<mips/ingenic/jz4780_regs.h>
end_include

begin_include
include|#
directive|include
file|<mips/ingenic/jz4780_clock.h>
end_include

begin_include
include|#
directive|include
file|"clkdev_if.h"
end_include

begin_include
include|#
directive|include
file|<gnu/dts/include/dt-bindings/clock/jz4780-cgu.h>
end_include

begin_comment
comment|/**********************************************************************  *  JZ4780 CGU clock domain  **********************************************************************/
end_comment

begin_struct
struct|struct
name|jz4780_clock_softc
block|{
name|device_t
name|dev
decl_stmt|;
name|struct
name|resource
modifier|*
name|res
index|[
literal|1
index|]
decl_stmt|;
name|struct
name|mtx
name|mtx
decl_stmt|;
name|struct
name|clkdom
modifier|*
name|clkdom
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|struct
name|resource_spec
name|jz4780_clock_spec
index|[]
init|=
block|{
block|{
name|SYS_RES_MEMORY
block|,
literal|0
block|,
name|RF_ACTIVE
block|}
block|,
block|{
operator|-
literal|1
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|jz4780_clk_pll_def
block|{
name|uint16_t
name|clk_id
decl_stmt|;
name|uint16_t
name|clk_reg
decl_stmt|;
specifier|const
name|char
modifier|*
name|clk_name
decl_stmt|;
specifier|const
name|char
modifier|*
name|clk_pname
index|[
literal|1
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|PLL
parameter_list|(
name|_id
parameter_list|,
name|cname
parameter_list|,
name|pname
parameter_list|,
name|reg
parameter_list|)
value|{		\ 	.clk_id		= _id,			\ 	.clk_reg	= reg,			\ 	.clk_name	= cname,		\ 	.clk_pname[0]	= pname,		\ }
end_define

begin_struct
struct|struct
name|jz4780_clk_gate_def
block|{
name|uint16_t
name|clk_id
decl_stmt|;
name|uint16_t
name|clk_bit
decl_stmt|;
specifier|const
name|char
modifier|*
name|clk_name
decl_stmt|;
specifier|const
name|char
modifier|*
name|clk_pname
index|[
literal|1
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|GATE
parameter_list|(
name|_id
parameter_list|,
name|cname
parameter_list|,
name|pname
parameter_list|,
name|bit
parameter_list|)
value|{		\ 	.clk_id		= _id,			\ 	.clk_bit	= bit,			\ 	.clk_name	= cname,		\ 	.clk_pname[0]	= pname,		\ }
end_define

begin_define
define|#
directive|define
name|MUX
parameter_list|(
name|reg
parameter_list|,
name|shift
parameter_list|,
name|bits
parameter_list|,
name|map
parameter_list|)
define|\
value|.clk_mux.mux_reg = (reg),				\     .clk_mux.mux_shift = (shift),			\     .clk_mux.mux_bits = (bits),				\     .clk_mux.mux_map = (map),
end_define

begin_define
define|#
directive|define
name|NO_MUX
end_define

begin_define
define|#
directive|define
name|DIV
parameter_list|(
name|reg
parameter_list|,
name|shift
parameter_list|,
name|lg
parameter_list|,
name|bits
parameter_list|,
name|ce
parameter_list|,
name|st
parameter_list|,
name|bb
parameter_list|)
define|\
value|.clk_div.div_reg = (reg),				\     .clk_div.div_shift = (shift),			\     .clk_div.div_bits = (bits),				\     .clk_div.div_lg = (lg),				\     .clk_div.div_ce_bit = (ce),				\     .clk_div.div_st_bit = (st),				\     .clk_div.div_busy_bit = (bb),
end_define

begin_define
define|#
directive|define
name|NO_DIV
define|\
value|#define GATEBIT(bit)					\     .clk_gate_bit = (bit),
end_define

begin_define
define|#
directive|define
name|NO_GATE
define|\
value|.clk_gate_bit = (-1),
end_define

begin_define
define|#
directive|define
name|PLIST
parameter_list|(
name|pnames
modifier|...
parameter_list|)
define|\
value|.clk_pnames = { pnames },
end_define

begin_define
define|#
directive|define
name|GENCLK
parameter_list|(
name|id
parameter_list|,
name|name
parameter_list|,
name|type
parameter_list|,
name|parents
parameter_list|,
name|mux
parameter_list|,
name|div
parameter_list|,
name|gt
parameter_list|)
value|{	\ 	.clk_id		= id,				\ 	.clk_type       = type,				\ 	.clk_name	= name,				\ 	parents						\ 	mux						\ 	div						\ 	gt						\ }
end_define

begin_comment
comment|/* PLL definitions */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|jz4780_clk_pll_def
name|pll_clks
index|[]
init|=
block|{
name|PLL
argument_list|(
name|JZ4780_CLK_APLL
argument_list|,
literal|"apll"
argument_list|,
literal|"ext"
argument_list|,
name|JZ_CPAPCR
argument_list|)
block|,
name|PLL
argument_list|(
name|JZ4780_CLK_MPLL
argument_list|,
literal|"mpll"
argument_list|,
literal|"ext"
argument_list|,
name|JZ_CPMPCR
argument_list|)
block|,
name|PLL
argument_list|(
name|JZ4780_CLK_EPLL
argument_list|,
literal|"epll"
argument_list|,
literal|"ext"
argument_list|,
name|JZ_CPEPCR
argument_list|)
block|,
name|PLL
argument_list|(
name|JZ4780_CLK_VPLL
argument_list|,
literal|"vpll"
argument_list|,
literal|"ext"
argument_list|,
name|JZ_CPVPCR
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* OTG PHY clock (reuse gate def structure */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|jz4780_clk_gate_def
name|otg_clks
index|[]
init|=
block|{
name|GATE
argument_list|(
name|JZ4780_CLK_OTGPHY
argument_list|,
literal|"otg_phy"
argument_list|,
literal|"ext"
argument_list|,
literal|0
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|jz4780_clk_descr
name|gen_clks
index|[]
init|=
block|{
name|GENCLK
argument_list|(
name|JZ4780_CLK_SCLKA
argument_list|,
literal|"sclk_a"
argument_list|,
name|CLK_MASK_MUX
argument_list|,
name|PLIST
argument_list|(
literal|"apll"
argument_list|,
literal|"ext"
argument_list|,
literal|"rtc"
argument_list|)
argument_list|,
name|MUX
argument_list|(
name|JZ_CPCCR
argument_list|,
literal|30
argument_list|,
literal|2
argument_list|,
literal|0x7
argument_list|)
argument_list|,
name|NO_DIV
argument_list|,
name|NO_GATE
argument_list|)
block|,
name|GENCLK
argument_list|(
name|JZ4780_CLK_CPUMUX
argument_list|,
literal|"cpumux"
argument_list|,
name|CLK_MASK_MUX
argument_list|,
name|PLIST
argument_list|(
literal|"sclk_a"
argument_list|,
literal|"mpll"
argument_list|,
literal|"epll"
argument_list|)
argument_list|,
name|MUX
argument_list|(
name|JZ_CPCCR
argument_list|,
literal|28
argument_list|,
literal|2
argument_list|,
literal|0x7
argument_list|)
argument_list|,
name|NO_DIV
argument_list|,
name|NO_GATE
argument_list|)
block|,
name|GENCLK
argument_list|(
name|JZ4780_CLK_CPU
argument_list|,
literal|"cpu"
argument_list|,
name|CLK_MASK_DIV
argument_list|,
name|PLIST
argument_list|(
literal|"cpumux"
argument_list|)
argument_list|,
name|NO_MUX
argument_list|,
name|DIV
argument_list|(
name|JZ_CPCCR
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|4
argument_list|,
literal|22
argument_list|,
operator|-
literal|1
argument_list|,
operator|-
literal|1
argument_list|)
argument_list|,
name|NO_GATE
argument_list|)
block|,
name|GENCLK
argument_list|(
name|JZ4780_CLK_L2CACHE
argument_list|,
literal|"l2cache"
argument_list|,
name|CLK_MASK_DIV
argument_list|,
name|PLIST
argument_list|(
literal|"cpumux"
argument_list|)
argument_list|,
name|NO_MUX
argument_list|,
name|DIV
argument_list|(
name|JZ_CPCCR
argument_list|,
literal|4
argument_list|,
literal|0
argument_list|,
literal|4
argument_list|,
operator|-
literal|1
argument_list|,
operator|-
literal|1
argument_list|,
operator|-
literal|1
argument_list|)
argument_list|,
name|NO_GATE
argument_list|)
block|,
name|GENCLK
argument_list|(
name|JZ4780_CLK_AHB0
argument_list|,
literal|"ahb0"
argument_list|,
name|CLK_MASK_MUX
operator||
name|CLK_MASK_DIV
argument_list|,
name|PLIST
argument_list|(
literal|"sclk_a"
argument_list|,
literal|"mpll"
argument_list|,
literal|"epll"
argument_list|)
argument_list|,
name|MUX
argument_list|(
name|JZ_CPCCR
argument_list|,
literal|26
argument_list|,
literal|2
argument_list|,
literal|0x7
argument_list|)
argument_list|,
name|DIV
argument_list|(
name|JZ_CPCCR
argument_list|,
literal|8
argument_list|,
literal|0
argument_list|,
literal|4
argument_list|,
literal|21
argument_list|,
operator|-
literal|1
argument_list|,
operator|-
literal|1
argument_list|)
argument_list|,
name|NO_GATE
argument_list|)
block|,
name|GENCLK
argument_list|(
name|JZ4780_CLK_AHB2PMUX
argument_list|,
literal|"ahb2_apb_mux"
argument_list|,
name|CLK_MASK_MUX
argument_list|,
name|PLIST
argument_list|(
literal|"sclk_a"
argument_list|,
literal|"mpll"
argument_list|,
literal|"rtc"
argument_list|)
argument_list|,
name|MUX
argument_list|(
name|JZ_CPCCR
argument_list|,
literal|24
argument_list|,
literal|2
argument_list|,
literal|0x7
argument_list|)
argument_list|,
name|NO_DIV
argument_list|,
name|NO_GATE
argument_list|)
block|,
name|GENCLK
argument_list|(
name|JZ4780_CLK_AHB2
argument_list|,
literal|"ahb2"
argument_list|,
name|CLK_MASK_DIV
argument_list|,
name|PLIST
argument_list|(
literal|"ahb2_apb_mux"
argument_list|)
argument_list|,
name|NO_MUX
argument_list|,
name|DIV
argument_list|(
name|JZ_CPCCR
argument_list|,
literal|12
argument_list|,
literal|0
argument_list|,
literal|4
argument_list|,
literal|20
argument_list|,
operator|-
literal|1
argument_list|,
operator|-
literal|1
argument_list|)
argument_list|,
name|NO_GATE
argument_list|)
block|,
name|GENCLK
argument_list|(
name|JZ4780_CLK_PCLK
argument_list|,
literal|"pclk"
argument_list|,
name|CLK_MASK_DIV
argument_list|,
name|PLIST
argument_list|(
literal|"ahb2_apb_mux"
argument_list|)
argument_list|,
name|NO_MUX
argument_list|,
name|DIV
argument_list|(
name|JZ_CPCCR
argument_list|,
literal|16
argument_list|,
literal|0
argument_list|,
literal|4
argument_list|,
literal|20
argument_list|,
operator|-
literal|1
argument_list|,
operator|-
literal|1
argument_list|)
argument_list|,
name|NO_GATE
argument_list|)
block|,
name|GENCLK
argument_list|(
name|JZ4780_CLK_DDR
argument_list|,
literal|"ddr"
argument_list|,
name|CLK_MASK_MUX
operator||
name|CLK_MASK_DIV
argument_list|,
name|PLIST
argument_list|(
literal|"sclk_a"
argument_list|,
literal|"mpll"
argument_list|)
argument_list|,
name|MUX
argument_list|(
name|JZ_DDCDR
argument_list|,
literal|30
argument_list|,
literal|2
argument_list|,
literal|0x6
argument_list|)
argument_list|,
name|DIV
argument_list|(
name|JZ_DDCDR
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|4
argument_list|,
literal|29
argument_list|,
literal|28
argument_list|,
literal|27
argument_list|)
argument_list|,
name|NO_GATE
argument_list|)
block|,
name|GENCLK
argument_list|(
name|JZ4780_CLK_VPU
argument_list|,
literal|"vpu"
argument_list|,
name|CLK_MASK_MUX
operator||
name|CLK_MASK_DIV
operator||
name|CLK_MASK_GATE
argument_list|,
name|PLIST
argument_list|(
literal|"sclk_a"
argument_list|,
literal|"mpll"
argument_list|,
literal|"epll"
argument_list|)
argument_list|,
name|MUX
argument_list|(
name|JZ_VPUCDR
argument_list|,
literal|30
argument_list|,
literal|2
argument_list|,
literal|0xe
argument_list|)
argument_list|,
name|DIV
argument_list|(
name|JZ_VPUCDR
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|4
argument_list|,
literal|29
argument_list|,
literal|28
argument_list|,
literal|27
argument_list|)
argument_list|,
name|GATEBIT
argument_list|(
literal|32
operator|+
literal|2
argument_list|)
argument_list|)
block|,
name|GENCLK
argument_list|(
name|JZ4780_CLK_I2SPLL
argument_list|,
literal|"i2s_pll"
argument_list|,
name|CLK_MASK_MUX
operator||
name|CLK_MASK_DIV
argument_list|,
name|PLIST
argument_list|(
literal|"sclk_a"
argument_list|,
literal|"epll"
argument_list|)
argument_list|,
name|MUX
argument_list|(
name|JZ_I2SCDR
argument_list|,
literal|30
argument_list|,
literal|1
argument_list|,
literal|0xc
argument_list|)
argument_list|,
name|DIV
argument_list|(
name|JZ_I2SCDR
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|8
argument_list|,
literal|29
argument_list|,
literal|28
argument_list|,
literal|27
argument_list|)
argument_list|,
name|NO_GATE
argument_list|)
block|,
name|GENCLK
argument_list|(
name|JZ4780_CLK_I2S
argument_list|,
literal|"i2s"
argument_list|,
name|CLK_MASK_MUX
argument_list|,
name|PLIST
argument_list|(
literal|"ext"
argument_list|,
literal|"i2s_pll"
argument_list|)
argument_list|,
name|MUX
argument_list|(
name|JZ_I2SCDR
argument_list|,
literal|31
argument_list|,
literal|1
argument_list|,
literal|0xc
argument_list|)
argument_list|,
name|NO_DIV
argument_list|,
name|NO_GATE
argument_list|)
block|,
name|GENCLK
argument_list|(
name|JZ4780_CLK_LCD0PIXCLK
argument_list|,
literal|"lcd0pixclk"
argument_list|,
name|CLK_MASK_MUX
operator||
name|CLK_MASK_DIV
argument_list|,
name|PLIST
argument_list|(
literal|"sclk_a"
argument_list|,
literal|"mpll"
argument_list|,
literal|"vpll"
argument_list|)
argument_list|,
name|MUX
argument_list|(
name|JZ_LP0CDR
argument_list|,
literal|30
argument_list|,
literal|2
argument_list|,
literal|0xe
argument_list|)
argument_list|,
name|DIV
argument_list|(
name|JZ_LP0CDR
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|8
argument_list|,
literal|28
argument_list|,
literal|27
argument_list|,
literal|26
argument_list|)
argument_list|,
name|NO_GATE
argument_list|)
block|,
name|GENCLK
argument_list|(
name|JZ4780_CLK_LCD1PIXCLK
argument_list|,
literal|"lcd1pixclk"
argument_list|,
name|CLK_MASK_MUX
operator||
name|CLK_MASK_DIV
argument_list|,
name|PLIST
argument_list|(
literal|"sclk_a"
argument_list|,
literal|"mpll"
argument_list|,
literal|"vpll"
argument_list|)
argument_list|,
name|MUX
argument_list|(
name|JZ_LP1CDR
argument_list|,
literal|30
argument_list|,
literal|2
argument_list|,
literal|0xe
argument_list|)
argument_list|,
name|DIV
argument_list|(
name|JZ_LP1CDR
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|8
argument_list|,
literal|28
argument_list|,
literal|27
argument_list|,
literal|26
argument_list|)
argument_list|,
name|NO_GATE
argument_list|)
block|,
name|GENCLK
argument_list|(
name|JZ4780_CLK_MSCMUX
argument_list|,
literal|"msc_mux"
argument_list|,
name|CLK_MASK_MUX
argument_list|,
name|PLIST
argument_list|(
literal|"sclk_a"
argument_list|,
literal|"mpll"
argument_list|)
argument_list|,
name|MUX
argument_list|(
name|JZ_MSC0CDR
argument_list|,
literal|30
argument_list|,
literal|2
argument_list|,
literal|0x6
argument_list|)
argument_list|,
name|NO_DIV
argument_list|,
name|NO_GATE
argument_list|)
block|,
name|GENCLK
argument_list|(
name|JZ4780_CLK_MSC0
argument_list|,
literal|"msc0"
argument_list|,
name|CLK_MASK_DIV
operator||
name|CLK_MASK_GATE
argument_list|,
name|PLIST
argument_list|(
literal|"msc_mux"
argument_list|)
argument_list|,
name|NO_MUX
argument_list|,
name|DIV
argument_list|(
name|JZ_MSC0CDR
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|8
argument_list|,
literal|29
argument_list|,
literal|28
argument_list|,
literal|27
argument_list|)
argument_list|,
name|GATEBIT
argument_list|(
literal|3
argument_list|)
argument_list|)
block|,
name|GENCLK
argument_list|(
name|JZ4780_CLK_MSC1
argument_list|,
literal|"msc1"
argument_list|,
name|CLK_MASK_DIV
operator||
name|CLK_MASK_GATE
argument_list|,
name|PLIST
argument_list|(
literal|"msc_mux"
argument_list|)
argument_list|,
name|NO_MUX
argument_list|,
name|DIV
argument_list|(
name|JZ_MSC1CDR
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|8
argument_list|,
literal|29
argument_list|,
literal|28
argument_list|,
literal|27
argument_list|)
argument_list|,
name|GATEBIT
argument_list|(
literal|11
argument_list|)
argument_list|)
block|,
name|GENCLK
argument_list|(
name|JZ4780_CLK_MSC2
argument_list|,
literal|"msc2"
argument_list|,
name|CLK_MASK_DIV
operator||
name|CLK_MASK_GATE
argument_list|,
name|PLIST
argument_list|(
literal|"msc_mux"
argument_list|)
argument_list|,
name|NO_MUX
argument_list|,
name|DIV
argument_list|(
name|JZ_MSC2CDR
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|8
argument_list|,
literal|29
argument_list|,
literal|28
argument_list|,
literal|27
argument_list|)
argument_list|,
name|GATEBIT
argument_list|(
literal|12
argument_list|)
argument_list|)
block|,
name|GENCLK
argument_list|(
name|JZ4780_CLK_UHC
argument_list|,
literal|"uhc"
argument_list|,
name|CLK_MASK_MUX
operator||
name|CLK_MASK_DIV
operator||
name|CLK_MASK_GATE
argument_list|,
name|PLIST
argument_list|(
literal|"sclk_a"
argument_list|,
literal|"mpll"
argument_list|,
literal|"epll"
argument_list|,
literal|"otg_phy"
argument_list|)
argument_list|,
name|MUX
argument_list|(
name|JZ_UHCCDR
argument_list|,
literal|30
argument_list|,
literal|2
argument_list|,
literal|0xf
argument_list|)
argument_list|,
name|DIV
argument_list|(
name|JZ_UHCCDR
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|8
argument_list|,
literal|29
argument_list|,
literal|28
argument_list|,
literal|27
argument_list|)
argument_list|,
name|GATEBIT
argument_list|(
literal|24
argument_list|)
argument_list|)
block|,
name|GENCLK
argument_list|(
name|JZ4780_CLK_SSIPLL
argument_list|,
literal|"ssi_pll"
argument_list|,
name|CLK_MASK_MUX
operator||
name|CLK_MASK_DIV
argument_list|,
name|PLIST
argument_list|(
literal|"sclk_a"
argument_list|,
literal|"mpll"
argument_list|)
argument_list|,
name|MUX
argument_list|(
name|JZ_SSICDR
argument_list|,
literal|30
argument_list|,
literal|1
argument_list|,
literal|0xc
argument_list|)
argument_list|,
name|DIV
argument_list|(
name|JZ_SSICDR
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|8
argument_list|,
literal|29
argument_list|,
literal|28
argument_list|,
literal|27
argument_list|)
argument_list|,
name|NO_GATE
argument_list|)
block|,
name|GENCLK
argument_list|(
name|JZ4780_CLK_SSI
argument_list|,
literal|"ssi"
argument_list|,
name|CLK_MASK_MUX
argument_list|,
name|PLIST
argument_list|(
literal|"ext"
argument_list|,
literal|"ssi_pll"
argument_list|)
argument_list|,
name|MUX
argument_list|(
name|JZ_SSICDR
argument_list|,
literal|31
argument_list|,
literal|1
argument_list|,
literal|0xc
argument_list|)
argument_list|,
name|NO_DIV
argument_list|,
name|NO_GATE
argument_list|)
block|,
name|GENCLK
argument_list|(
name|JZ4780_CLK_CIMMCLK
argument_list|,
literal|"cim_mclk"
argument_list|,
name|CLK_MASK_MUX
operator||
name|CLK_MASK_DIV
argument_list|,
name|PLIST
argument_list|(
literal|"sclk_a"
argument_list|,
literal|"mpll"
argument_list|)
argument_list|,
name|MUX
argument_list|(
name|JZ_CIMCDR
argument_list|,
literal|31
argument_list|,
literal|1
argument_list|,
literal|0xc
argument_list|)
argument_list|,
name|DIV
argument_list|(
name|JZ_CIMCDR
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|8
argument_list|,
literal|30
argument_list|,
literal|29
argument_list|,
literal|28
argument_list|)
argument_list|,
name|NO_GATE
argument_list|)
block|,
name|GENCLK
argument_list|(
name|JZ4780_CLK_PCMPLL
argument_list|,
literal|"pcm_pll"
argument_list|,
name|CLK_MASK_MUX
operator||
name|CLK_MASK_DIV
argument_list|,
name|PLIST
argument_list|(
literal|"sclk_a"
argument_list|,
literal|"mpll"
argument_list|,
literal|"epll"
argument_list|,
literal|"vpll"
argument_list|)
argument_list|,
name|MUX
argument_list|(
name|JZ_PCMCDR
argument_list|,
literal|29
argument_list|,
literal|2
argument_list|,
literal|0xf
argument_list|)
argument_list|,
name|DIV
argument_list|(
name|JZ_PCMCDR
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|8
argument_list|,
literal|28
argument_list|,
literal|27
argument_list|,
literal|26
argument_list|)
argument_list|,
name|NO_GATE
argument_list|)
block|,
name|GENCLK
argument_list|(
name|JZ4780_CLK_PCM
argument_list|,
literal|"pcm"
argument_list|,
name|CLK_MASK_MUX
operator||
name|CLK_MASK_GATE
argument_list|,
name|PLIST
argument_list|(
literal|"ext"
argument_list|,
literal|"pcm_pll"
argument_list|)
argument_list|,
name|MUX
argument_list|(
name|JZ_PCMCDR
argument_list|,
literal|31
argument_list|,
literal|1
argument_list|,
literal|0xc
argument_list|)
argument_list|,
name|NO_DIV
argument_list|,
name|GATEBIT
argument_list|(
literal|32
operator|+
literal|3
argument_list|)
argument_list|)
block|,
name|GENCLK
argument_list|(
name|JZ4780_CLK_GPU
argument_list|,
literal|"gpu"
argument_list|,
name|CLK_MASK_MUX
operator||
name|CLK_MASK_DIV
operator||
name|CLK_MASK_GATE
argument_list|,
name|PLIST
argument_list|(
literal|"sclk_a"
argument_list|,
literal|"mpll"
argument_list|,
literal|"epll"
argument_list|)
argument_list|,
name|MUX
argument_list|(
name|JZ_GPUCDR
argument_list|,
literal|30
argument_list|,
literal|2
argument_list|,
literal|0x7
argument_list|)
argument_list|,
name|DIV
argument_list|(
name|JZ_GPUCDR
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|4
argument_list|,
literal|29
argument_list|,
literal|28
argument_list|,
literal|27
argument_list|)
argument_list|,
name|GATEBIT
argument_list|(
literal|32
operator|+
literal|4
argument_list|)
argument_list|)
block|,
name|GENCLK
argument_list|(
name|JZ4780_CLK_HDMI
argument_list|,
literal|"hdmi"
argument_list|,
name|CLK_MASK_MUX
operator||
name|CLK_MASK_DIV
operator||
name|CLK_MASK_GATE
argument_list|,
name|PLIST
argument_list|(
literal|"sclk_a"
argument_list|,
literal|"mpll"
argument_list|,
literal|"vpll"
argument_list|)
argument_list|,
name|MUX
argument_list|(
name|JZ_HDMICDR
argument_list|,
literal|30
argument_list|,
literal|2
argument_list|,
literal|0xe
argument_list|)
argument_list|,
name|DIV
argument_list|(
name|JZ_HDMICDR
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|8
argument_list|,
literal|29
argument_list|,
literal|28
argument_list|,
literal|26
argument_list|)
argument_list|,
name|GATEBIT
argument_list|(
literal|32
operator|+
literal|9
argument_list|)
argument_list|)
block|,
name|GENCLK
argument_list|(
name|JZ4780_CLK_BCH
argument_list|,
literal|"bch"
argument_list|,
name|CLK_MASK_MUX
operator||
name|CLK_MASK_DIV
operator||
name|CLK_MASK_GATE
argument_list|,
name|PLIST
argument_list|(
literal|"sclk_a"
argument_list|,
literal|"mpll"
argument_list|,
literal|"epll"
argument_list|)
argument_list|,
name|MUX
argument_list|(
name|JZ_BCHCDR
argument_list|,
literal|30
argument_list|,
literal|2
argument_list|,
literal|0x7
argument_list|)
argument_list|,
name|DIV
argument_list|(
name|JZ_BCHCDR
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|4
argument_list|,
literal|29
argument_list|,
literal|28
argument_list|,
literal|27
argument_list|)
argument_list|,
name|GATEBIT
argument_list|(
literal|1
argument_list|)
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|jz4780_clk_gate_def
name|gate_clks
index|[]
init|=
block|{
name|GATE
argument_list|(
name|JZ4780_CLK_NEMC
argument_list|,
literal|"nemc"
argument_list|,
literal|"ahb2"
argument_list|,
literal|0
argument_list|)
block|,
name|GATE
argument_list|(
name|JZ4780_CLK_OTG0
argument_list|,
literal|"otg0"
argument_list|,
literal|"ext"
argument_list|,
literal|2
argument_list|)
block|,
name|GATE
argument_list|(
name|JZ4780_CLK_SSI0
argument_list|,
literal|"ssi0"
argument_list|,
literal|"ssi"
argument_list|,
literal|4
argument_list|)
block|,
name|GATE
argument_list|(
name|JZ4780_CLK_SMB0
argument_list|,
literal|"smb0"
argument_list|,
literal|"pclk"
argument_list|,
literal|5
argument_list|)
block|,
name|GATE
argument_list|(
name|JZ4780_CLK_SMB1
argument_list|,
literal|"smb1"
argument_list|,
literal|"pclk"
argument_list|,
literal|6
argument_list|)
block|,
name|GATE
argument_list|(
name|JZ4780_CLK_SCC
argument_list|,
literal|"scc"
argument_list|,
literal|"ext"
argument_list|,
literal|7
argument_list|)
block|,
name|GATE
argument_list|(
name|JZ4780_CLK_AIC
argument_list|,
literal|"aic"
argument_list|,
literal|"ext"
argument_list|,
literal|8
argument_list|)
block|,
name|GATE
argument_list|(
name|JZ4780_CLK_TSSI0
argument_list|,
literal|"tssi0"
argument_list|,
literal|"ext"
argument_list|,
literal|9
argument_list|)
block|,
name|GATE
argument_list|(
name|JZ4780_CLK_OWI
argument_list|,
literal|"owi"
argument_list|,
literal|"ext"
argument_list|,
literal|10
argument_list|)
block|,
name|GATE
argument_list|(
name|JZ4780_CLK_KBC
argument_list|,
literal|"kbc"
argument_list|,
literal|"ext"
argument_list|,
literal|13
argument_list|)
block|,
name|GATE
argument_list|(
name|JZ4780_CLK_SADC
argument_list|,
literal|"sadc"
argument_list|,
literal|"ext"
argument_list|,
literal|14
argument_list|)
block|,
name|GATE
argument_list|(
name|JZ4780_CLK_UART0
argument_list|,
literal|"uart0"
argument_list|,
literal|"ext"
argument_list|,
literal|15
argument_list|)
block|,
name|GATE
argument_list|(
name|JZ4780_CLK_UART1
argument_list|,
literal|"uart1"
argument_list|,
literal|"ext"
argument_list|,
literal|16
argument_list|)
block|,
name|GATE
argument_list|(
name|JZ4780_CLK_UART2
argument_list|,
literal|"uart2"
argument_list|,
literal|"ext"
argument_list|,
literal|17
argument_list|)
block|,
name|GATE
argument_list|(
name|JZ4780_CLK_UART3
argument_list|,
literal|"uart3"
argument_list|,
literal|"ext"
argument_list|,
literal|18
argument_list|)
block|,
name|GATE
argument_list|(
name|JZ4780_CLK_SSI1
argument_list|,
literal|"ssi1"
argument_list|,
literal|"ssi"
argument_list|,
literal|19
argument_list|)
block|,
name|GATE
argument_list|(
name|JZ4780_CLK_SSI2
argument_list|,
literal|"ssi2"
argument_list|,
literal|"ssi"
argument_list|,
literal|20
argument_list|)
block|,
name|GATE
argument_list|(
name|JZ4780_CLK_PDMA
argument_list|,
literal|"pdma"
argument_list|,
literal|"ext"
argument_list|,
literal|21
argument_list|)
block|,
name|GATE
argument_list|(
name|JZ4780_CLK_GPS
argument_list|,
literal|"gps"
argument_list|,
literal|"ext"
argument_list|,
literal|22
argument_list|)
block|,
name|GATE
argument_list|(
name|JZ4780_CLK_MAC
argument_list|,
literal|"mac"
argument_list|,
literal|"ext"
argument_list|,
literal|23
argument_list|)
block|,
name|GATE
argument_list|(
name|JZ4780_CLK_SMB2
argument_list|,
literal|"smb2"
argument_list|,
literal|"pclk"
argument_list|,
literal|25
argument_list|)
block|,
name|GATE
argument_list|(
name|JZ4780_CLK_CIM
argument_list|,
literal|"cim"
argument_list|,
literal|"ext"
argument_list|,
literal|26
argument_list|)
block|,
name|GATE
argument_list|(
name|JZ4780_CLK_LCD
argument_list|,
literal|"lcd"
argument_list|,
literal|"ext"
argument_list|,
literal|28
argument_list|)
block|,
name|GATE
argument_list|(
name|JZ4780_CLK_TVE
argument_list|,
literal|"tve"
argument_list|,
literal|"lcd"
argument_list|,
literal|27
argument_list|)
block|,
name|GATE
argument_list|(
name|JZ4780_CLK_IPU
argument_list|,
literal|"ipu"
argument_list|,
literal|"ext"
argument_list|,
literal|29
argument_list|)
block|,
name|GATE
argument_list|(
name|JZ4780_CLK_DDR0
argument_list|,
literal|"ddr0"
argument_list|,
literal|"ddr"
argument_list|,
literal|30
argument_list|)
block|,
name|GATE
argument_list|(
name|JZ4780_CLK_DDR1
argument_list|,
literal|"ddr1"
argument_list|,
literal|"ddr"
argument_list|,
literal|31
argument_list|)
block|,
name|GATE
argument_list|(
name|JZ4780_CLK_SMB3
argument_list|,
literal|"smb3"
argument_list|,
literal|"pclk"
argument_list|,
literal|32
operator|+
literal|0
argument_list|)
block|,
name|GATE
argument_list|(
name|JZ4780_CLK_TSSI1
argument_list|,
literal|"tssi1"
argument_list|,
literal|"ext"
argument_list|,
literal|32
operator|+
literal|1
argument_list|)
block|,
name|GATE
argument_list|(
name|JZ4780_CLK_COMPRESS
argument_list|,
literal|"compress"
argument_list|,
literal|"ext"
argument_list|,
literal|32
operator|+
literal|5
argument_list|)
block|,
name|GATE
argument_list|(
name|JZ4780_CLK_AIC1
argument_list|,
literal|"aic1"
argument_list|,
literal|"ext"
argument_list|,
literal|32
operator|+
literal|6
argument_list|)
block|,
name|GATE
argument_list|(
name|JZ4780_CLK_GPVLC
argument_list|,
literal|"gpvlc"
argument_list|,
literal|"ext"
argument_list|,
literal|32
operator|+
literal|7
argument_list|)
block|,
name|GATE
argument_list|(
name|JZ4780_CLK_OTG1
argument_list|,
literal|"otg1"
argument_list|,
literal|"ext"
argument_list|,
literal|32
operator|+
literal|8
argument_list|)
block|,
name|GATE
argument_list|(
name|JZ4780_CLK_UART4
argument_list|,
literal|"uart4"
argument_list|,
literal|"ext"
argument_list|,
literal|32
operator|+
literal|10
argument_list|)
block|,
name|GATE
argument_list|(
name|JZ4780_CLK_AHBMON
argument_list|,
literal|"ahb_mon"
argument_list|,
literal|"ext"
argument_list|,
literal|32
operator|+
literal|11
argument_list|)
block|,
name|GATE
argument_list|(
name|JZ4780_CLK_SMB4
argument_list|,
literal|"smb4"
argument_list|,
literal|"pclk"
argument_list|,
literal|32
operator|+
literal|12
argument_list|)
block|,
name|GATE
argument_list|(
name|JZ4780_CLK_DES
argument_list|,
literal|"des"
argument_list|,
literal|"ext"
argument_list|,
literal|32
operator|+
literal|13
argument_list|)
block|,
name|GATE
argument_list|(
name|JZ4780_CLK_X2D
argument_list|,
literal|"x2d"
argument_list|,
literal|"ext"
argument_list|,
literal|32
operator|+
literal|14
argument_list|)
block|,
name|GATE
argument_list|(
name|JZ4780_CLK_CORE1
argument_list|,
literal|"core1"
argument_list|,
literal|"cpu"
argument_list|,
literal|32
operator|+
literal|15
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|jz4780_clock_register
parameter_list|(
name|struct
name|jz4780_clock_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|ret
decl_stmt|;
comment|/* Register PLLs */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nitems
argument_list|(
name|pll_clks
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|clknode_init_def
name|clkdef
decl_stmt|;
name|clkdef
operator|.
name|id
operator|=
name|pll_clks
index|[
name|i
index|]
operator|.
name|clk_id
expr_stmt|;
name|clkdef
operator|.
name|name
operator|=
name|__DECONST
argument_list|(
name|char
operator|*
argument_list|,
name|pll_clks
index|[
name|i
index|]
operator|.
name|clk_name
argument_list|)
expr_stmt|;
name|clkdef
operator|.
name|parent_names
operator|=
name|pll_clks
index|[
name|i
index|]
operator|.
name|clk_pname
expr_stmt|;
name|clkdef
operator|.
name|parent_cnt
operator|=
literal|1
expr_stmt|;
name|clkdef
operator|.
name|flags
operator|=
name|CLK_NODE_STATIC_STRINGS
expr_stmt|;
name|ret
operator|=
name|jz4780_clk_pll_register
argument_list|(
name|sc
operator|->
name|clkdom
argument_list|,
operator|&
name|clkdef
argument_list|,
operator|&
name|sc
operator|->
name|mtx
argument_list|,
name|sc
operator|->
name|res
index|[
literal|0
index|]
argument_list|,
name|pll_clks
index|[
name|i
index|]
operator|.
name|clk_reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
return|return
operator|(
name|ret
operator|)
return|;
block|}
comment|/* Register OTG clock */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nitems
argument_list|(
name|otg_clks
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|clknode_init_def
name|clkdef
decl_stmt|;
name|clkdef
operator|.
name|id
operator|=
name|otg_clks
index|[
name|i
index|]
operator|.
name|clk_id
expr_stmt|;
name|clkdef
operator|.
name|name
operator|=
name|__DECONST
argument_list|(
name|char
operator|*
argument_list|,
name|otg_clks
index|[
name|i
index|]
operator|.
name|clk_name
argument_list|)
expr_stmt|;
name|clkdef
operator|.
name|parent_names
operator|=
name|otg_clks
index|[
name|i
index|]
operator|.
name|clk_pname
expr_stmt|;
name|clkdef
operator|.
name|parent_cnt
operator|=
literal|1
expr_stmt|;
name|clkdef
operator|.
name|flags
operator|=
name|CLK_NODE_STATIC_STRINGS
expr_stmt|;
name|ret
operator|=
name|jz4780_clk_otg_register
argument_list|(
name|sc
operator|->
name|clkdom
argument_list|,
operator|&
name|clkdef
argument_list|,
operator|&
name|sc
operator|->
name|mtx
argument_list|,
name|sc
operator|->
name|res
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
return|return
operator|(
name|ret
operator|)
return|;
block|}
comment|/* Register muxes and divisors */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nitems
argument_list|(
name|gen_clks
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|ret
operator|=
name|jz4780_clk_gen_register
argument_list|(
name|sc
operator|->
name|clkdom
argument_list|,
operator|&
name|gen_clks
index|[
name|i
index|]
argument_list|,
operator|&
name|sc
operator|->
name|mtx
argument_list|,
name|sc
operator|->
name|res
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
return|return
operator|(
name|ret
operator|)
return|;
block|}
comment|/* Register simple gates */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nitems
argument_list|(
name|gate_clks
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|clk_gate_def
name|gatedef
decl_stmt|;
name|gatedef
operator|.
name|clkdef
operator|.
name|id
operator|=
name|gate_clks
index|[
name|i
index|]
operator|.
name|clk_id
expr_stmt|;
name|gatedef
operator|.
name|clkdef
operator|.
name|name
operator|=
name|__DECONST
argument_list|(
name|char
operator|*
argument_list|,
name|gate_clks
index|[
name|i
index|]
operator|.
name|clk_name
argument_list|)
expr_stmt|;
name|gatedef
operator|.
name|clkdef
operator|.
name|parent_names
operator|=
name|gate_clks
index|[
name|i
index|]
operator|.
name|clk_pname
expr_stmt|;
name|gatedef
operator|.
name|clkdef
operator|.
name|parent_cnt
operator|=
literal|1
expr_stmt|;
name|gatedef
operator|.
name|clkdef
operator|.
name|flags
operator|=
name|CLK_NODE_STATIC_STRINGS
expr_stmt|;
if|if
condition|(
name|gate_clks
index|[
name|i
index|]
operator|.
name|clk_bit
operator|<
literal|32
condition|)
block|{
name|gatedef
operator|.
name|offset
operator|=
name|JZ_CLKGR0
expr_stmt|;
name|gatedef
operator|.
name|shift
operator|=
name|gate_clks
index|[
name|i
index|]
operator|.
name|clk_bit
expr_stmt|;
block|}
else|else
block|{
name|gatedef
operator|.
name|offset
operator|=
name|JZ_CLKGR1
expr_stmt|;
name|gatedef
operator|.
name|shift
operator|=
name|gate_clks
index|[
name|i
index|]
operator|.
name|clk_bit
operator|-
literal|32
expr_stmt|;
block|}
name|gatedef
operator|.
name|mask
operator|=
literal|1
expr_stmt|;
name|gatedef
operator|.
name|on_value
operator|=
literal|0
expr_stmt|;
name|gatedef
operator|.
name|off_value
operator|=
literal|1
expr_stmt|;
name|gatedef
operator|.
name|gate_flags
operator|=
literal|0
expr_stmt|;
name|ret
operator|=
name|clknode_gate_register
argument_list|(
name|sc
operator|->
name|clkdom
argument_list|,
operator|&
name|gatedef
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
return|return
operator|(
name|ret
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|jz4780_clock_fixup
parameter_list|(
name|struct
name|jz4780_clock_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|clknode
modifier|*
name|clk_uhc
decl_stmt|;
name|int
name|ret
decl_stmt|;
comment|/* 	 * Make UHC mux use MPLL as the source. It defaults to OTG_PHY 	 * and that somehow just does not work. 	 */
name|clkdom_xlock
argument_list|(
name|sc
operator|->
name|clkdom
argument_list|)
expr_stmt|;
comment|/* Assume the worst */
name|ret
operator|=
name|ENXIO
expr_stmt|;
name|clk_uhc
operator|=
name|clknode_find_by_id
argument_list|(
name|sc
operator|->
name|clkdom
argument_list|,
name|JZ4780_CLK_UHC
argument_list|)
expr_stmt|;
if|if
condition|(
name|clk_uhc
operator|!=
name|NULL
condition|)
block|{
name|ret
operator|=
name|clknode_set_parent_by_name
argument_list|(
name|clk_uhc
argument_list|,
literal|"mpll"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"unable to reparent uhc clock\n"
argument_list|)
expr_stmt|;
else|else
name|ret
operator|=
name|clknode_set_freq
argument_list|(
name|clk_uhc
argument_list|,
literal|48000000
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"unable to init uhc clock\n"
argument_list|)
expr_stmt|;
block|}
else|else
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"unable to lookup uhc clock\n"
argument_list|)
expr_stmt|;
name|clkdom_unlock
argument_list|(
name|sc
operator|->
name|clkdom
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_define
define|#
directive|define
name|CGU_LOCK
parameter_list|(
name|sc
parameter_list|)
value|mtx_lock(&(sc)->mtx)
end_define

begin_define
define|#
directive|define
name|CGU_UNLOCK
parameter_list|(
name|sc
parameter_list|)
value|mtx_unlock(&(sc)->mtx)
end_define

begin_define
define|#
directive|define
name|CGU_LOCK_INIT
parameter_list|(
name|sc
parameter_list|)
define|\
value|mtx_init(&(sc)->mtx, device_get_nameunit((sc)->dev),	\     "jz4780-cgu", MTX_DEF)
end_define

begin_define
define|#
directive|define
name|CGU_LOCK_DESTROY
parameter_list|(
name|sc
parameter_list|)
value|mtx_destroy(&(sc)->mtx);
end_define

begin_define
define|#
directive|define
name|CSR_WRITE_4
parameter_list|(
name|sc
parameter_list|,
name|reg
parameter_list|,
name|val
parameter_list|)
value|bus_write_4((sc)->res[0], (reg), (val))
end_define

begin_define
define|#
directive|define
name|CSR_READ_4
parameter_list|(
name|sc
parameter_list|,
name|reg
parameter_list|)
value|bus_read_4((sc)->res[0], (reg))
end_define

begin_function
specifier|static
name|int
name|jz4780_clock_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
if|if
condition|(
operator|!
name|ofw_bus_status_okay
argument_list|(
name|dev
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
operator|!
name|ofw_bus_is_compatible
argument_list|(
name|dev
argument_list|,
literal|"ingenic,jz4780-cgu"
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"Ingenic jz4780 CGU"
argument_list|)
expr_stmt|;
return|return
operator|(
name|BUS_PROBE_DEFAULT
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|jz4780_clock_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|jz4780_clock_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|bus_alloc_resources
argument_list|(
name|dev
argument_list|,
name|jz4780_clock_spec
argument_list|,
name|sc
operator|->
name|res
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"could not allocate resources for device\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|sc
operator|->
name|dev
operator|=
name|dev
expr_stmt|;
name|CGU_LOCK_INIT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|clkdom
operator|=
name|clkdom_create
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|clkdom
operator|==
name|NULL
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|jz4780_clock_register
argument_list|(
name|sc
argument_list|)
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|clkdom_finit
argument_list|(
name|sc
operator|->
name|clkdom
argument_list|)
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|jz4780_clock_fixup
argument_list|(
name|sc
argument_list|)
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|bootverbose
condition|)
name|clkdom_dump
argument_list|(
name|sc
operator|->
name|clkdom
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail
label|:
name|bus_release_resources
argument_list|(
name|dev
argument_list|,
name|jz4780_clock_spec
argument_list|,
name|sc
operator|->
name|res
argument_list|)
expr_stmt|;
name|CGU_LOCK_DESTROY
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|jz4780_clock_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|jz4780_clock_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|bus_release_resources
argument_list|(
name|dev
argument_list|,
name|jz4780_clock_spec
argument_list|,
name|sc
operator|->
name|res
argument_list|)
expr_stmt|;
name|CGU_LOCK_DESTROY
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|jz4780_clock_write_4
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|bus_addr_t
name|addr
parameter_list|,
name|uint32_t
name|val
parameter_list|)
block|{
name|struct
name|jz4780_clock_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|addr
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|jz4780_clock_read_4
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|bus_addr_t
name|addr
parameter_list|,
name|uint32_t
modifier|*
name|val
parameter_list|)
block|{
name|struct
name|jz4780_clock_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
operator|*
name|val
operator|=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|addr
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|jz4780_clock_modify_4
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|bus_addr_t
name|addr
parameter_list|,
name|uint32_t
name|clear_mask
parameter_list|,
name|uint32_t
name|set_mask
parameter_list|)
block|{
name|struct
name|jz4780_clock_softc
modifier|*
name|sc
decl_stmt|;
name|uint32_t
name|val
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|val
operator|=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|val
operator|&=
name|clear_mask
expr_stmt|;
name|val
operator||=
name|set_mask
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|addr
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|jz4780_clock_device_lock
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|jz4780_clock_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|CGU_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|jz4780_clock_device_unlock
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|jz4780_clock_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|CGU_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
name|device_method_t
name|jz4780_clock_methods
index|[]
init|=
block|{
comment|/* Device interface */
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|jz4780_clock_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|jz4780_clock_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|jz4780_clock_detach
argument_list|)
block|,
comment|/* Clock device interface */
name|DEVMETHOD
argument_list|(
name|clkdev_write_4
argument_list|,
name|jz4780_clock_write_4
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|clkdev_read_4
argument_list|,
name|jz4780_clock_read_4
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|clkdev_modify_4
argument_list|,
name|jz4780_clock_modify_4
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|clkdev_device_lock
argument_list|,
name|jz4780_clock_device_lock
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|clkdev_device_unlock
argument_list|,
name|jz4780_clock_device_unlock
argument_list|)
block|,
name|DEVMETHOD_END
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|jz4780_clock_driver
init|=
block|{
literal|"cgu"
block|,
name|jz4780_clock_methods
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|jz4780_clock_softc
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|jz4780_clock_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|EARLY_DRIVER_MODULE
argument_list|(
name|jz4780_clock
argument_list|,
name|simplebus
argument_list|,
name|jz4780_clock_driver
argument_list|,
name|jz4780_clock_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|BUS_PASS_CPU
operator|+
name|BUS_PASS_ORDER_LATE
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|int
name|jz4780_ehci_clk_config
parameter_list|(
name|struct
name|jz4780_clock_softc
modifier|*
name|sc
parameter_list|)
block|{
name|clk_t
name|phy_clk
decl_stmt|,
name|ext_clk
decl_stmt|;
name|uint64_t
name|phy_freq
decl_stmt|;
name|int
name|err
decl_stmt|;
name|phy_clk
operator|=
name|NULL
expr_stmt|;
name|ext_clk
operator|=
name|NULL
expr_stmt|;
name|err
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* Set phy timing by copying it from ext */
if|if
condition|(
name|clk_get_by_id
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|sc
operator|->
name|clkdom
argument_list|,
name|JZ4780_CLK_OTGPHY
argument_list|,
operator|&
name|phy_clk
argument_list|)
operator|!=
literal|0
condition|)
goto|goto
name|done
goto|;
if|if
condition|(
name|clk_get_parent
argument_list|(
name|phy_clk
argument_list|,
operator|&
name|ext_clk
argument_list|)
operator|!=
literal|0
condition|)
goto|goto
name|done
goto|;
if|if
condition|(
name|clk_get_freq
argument_list|(
name|ext_clk
argument_list|,
operator|&
name|phy_freq
argument_list|)
operator|!=
literal|0
condition|)
goto|goto
name|done
goto|;
if|if
condition|(
name|clk_set_freq
argument_list|(
name|phy_clk
argument_list|,
name|phy_freq
argument_list|,
literal|0
argument_list|)
operator|!=
literal|0
condition|)
goto|goto
name|done
goto|;
name|err
operator|=
literal|0
expr_stmt|;
name|done
label|:
name|clk_release
argument_list|(
name|ext_clk
argument_list|)
expr_stmt|;
name|clk_release
argument_list|(
name|phy_clk
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
name|int
name|jz4780_ohci_enable
parameter_list|(
name|void
parameter_list|)
block|{
name|device_t
name|dev
decl_stmt|;
name|struct
name|jz4780_clock_softc
modifier|*
name|sc
decl_stmt|;
name|uint32_t
name|reg
decl_stmt|;
name|dev
operator|=
name|devclass_get_device
argument_list|(
name|jz4780_clock_devclass
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev
operator|==
name|NULL
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|CGU_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Do not force port1 to suspend mode */
name|reg
operator|=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|JZ_OPCR
argument_list|)
expr_stmt|;
name|reg
operator||=
name|OPCR_SPENDN1
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|JZ_OPCR
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|CGU_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|jz4780_ehci_enable
parameter_list|(
name|void
parameter_list|)
block|{
name|device_t
name|dev
decl_stmt|;
name|struct
name|jz4780_clock_softc
modifier|*
name|sc
decl_stmt|;
name|uint32_t
name|reg
decl_stmt|;
name|dev
operator|=
name|devclass_get_device
argument_list|(
name|jz4780_clock_devclass
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev
operator|==
name|NULL
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* 	 * EHCI should use MPPL as a parent, but Linux configures OTG 	 * clock anyway. Follow their lead blindly. 	 */
if|if
condition|(
name|jz4780_ehci_clk_config
argument_list|(
name|sc
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|CGU_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Enable OTG, should not be necessary since we use PLL clock */
name|reg
operator|=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|JZ_USBPCR
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
operator|(
name|PCR_OTG_DISABLE
operator|)
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|JZ_USBPCR
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Do not force port1 to suspend mode */
name|reg
operator|=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|JZ_OPCR
argument_list|)
expr_stmt|;
name|reg
operator||=
name|OPCR_SPENDN1
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|JZ_OPCR
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* D- pulldown */
name|reg
operator|=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|JZ_USBPCR1
argument_list|)
expr_stmt|;
name|reg
operator||=
name|PCR_DMPD1
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|JZ_USBPCR1
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* D+ pulldown */
name|reg
operator|=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|JZ_USBPCR1
argument_list|)
expr_stmt|;
name|reg
operator||=
name|PCR_DPPD1
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|JZ_USBPCR1
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* 16 bit bus witdth for port 1*/
name|reg
operator|=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|JZ_USBPCR1
argument_list|)
expr_stmt|;
name|reg
operator||=
name|PCR_WORD_I_F1
operator||
name|PCR_WORD_I_F0
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|JZ_USBPCR1
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Reset USB */
name|reg
operator|=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|JZ_USBPCR
argument_list|)
expr_stmt|;
name|reg
operator||=
name|PCR_POR
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|JZ_USBPCR
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|reg
operator|=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|JZ_USBPCR
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
operator|(
name|PCR_POR
operator|)
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|JZ_USBPCR
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Soft-reset USB */
name|reg
operator|=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|JZ_SRBC
argument_list|)
expr_stmt|;
name|reg
operator||=
name|SRBC_UHC_SR
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|JZ_SRBC
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* 300ms */
name|DELAY
argument_list|(
literal|300
operator|*
name|hz
operator|/
literal|1000
argument_list|)
expr_stmt|;
name|reg
operator|=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|JZ_SRBC
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
operator|(
name|SRBC_UHC_SR
operator|)
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|JZ_SRBC
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* 300ms */
name|DELAY
argument_list|(
literal|300
operator|*
name|hz
operator|/
literal|1000
argument_list|)
expr_stmt|;
name|CGU_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_define
define|#
directive|define
name|USBRESET_DETECT_TIME
value|0x96
end_define

begin_function
name|int
name|jz4780_otg_enable
parameter_list|(
name|void
parameter_list|)
block|{
name|device_t
name|dev
decl_stmt|;
name|struct
name|jz4780_clock_softc
modifier|*
name|sc
decl_stmt|;
name|uint32_t
name|reg
decl_stmt|;
name|dev
operator|=
name|devclass_get_device
argument_list|(
name|jz4780_clock_devclass
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev
operator|==
name|NULL
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|CGU_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Select Synopsys OTG mode */
name|reg
operator|=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|JZ_USBPCR1
argument_list|)
expr_stmt|;
name|reg
operator||=
name|PCR_SYNOPSYS
expr_stmt|;
comment|/* Set UTMI bus width to 16 bit */
name|reg
operator||=
name|PCR_WORD_I_F0
operator||
name|PCR_WORD_I_F1
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|JZ_USBPCR1
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Blah */
name|reg
operator|=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|JZ_USBVBFIL
argument_list|)
expr_stmt|;
name|reg
operator|=
name|REG_SET
argument_list|(
name|reg
argument_list|,
name|USBVBFIL_IDDIGFIL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|reg
operator|=
name|REG_SET
argument_list|(
name|reg
argument_list|,
name|USBVBFIL_USBVBFIL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|JZ_USBVBFIL
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Setup reset detect time */
name|reg
operator|=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|JZ_USBRDT
argument_list|)
expr_stmt|;
name|reg
operator|=
name|REG_SET
argument_list|(
name|reg
argument_list|,
name|USBRDT_USBRDT
argument_list|,
name|USBRESET_DETECT_TIME
argument_list|)
expr_stmt|;
name|reg
operator||=
name|USBRDT_VBFIL_LD_EN
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|JZ_USBRDT
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Setup USBPCR bits */
name|reg
operator|=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|JZ_USBPCR
argument_list|)
expr_stmt|;
name|reg
operator||=
name|PCR_USB_MODE
expr_stmt|;
name|reg
operator||=
name|PCR_COMMONONN
expr_stmt|;
name|reg
operator||=
name|PCR_VBUSVLDEXT
expr_stmt|;
name|reg
operator||=
name|PCR_VBUSVLDEXTSEL
expr_stmt|;
name|reg
operator|&=
operator|~
operator|(
name|PCR_OTG_DISABLE
operator|)
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|JZ_USBPCR
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Reset USB */
name|reg
operator|=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|JZ_USBPCR
argument_list|)
expr_stmt|;
name|reg
operator||=
name|PCR_POR
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|JZ_USBPCR
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
name|reg
operator|=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|JZ_USBPCR
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
operator|(
name|PCR_POR
operator|)
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|JZ_USBPCR
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Unsuspend OTG port */
name|reg
operator|=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|JZ_OPCR
argument_list|)
expr_stmt|;
name|reg
operator||=
name|OPCR_SPENDN0
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|JZ_OPCR
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|CGU_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


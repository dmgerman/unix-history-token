begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2016 Stanislav Galabov.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<machine/fdt.h>
end_include

begin_include
include|#
directive|include
file|<dev/ofw/openfirm.h>
end_include

begin_include
include|#
directive|include
file|<dev/ofw/ofw_bus.h>
end_include

begin_include
include|#
directive|include
file|<dev/ofw/ofw_bus_subr.h>
end_include

begin_include
include|#
directive|include
file|<dev/fdt/fdt_common.h>
end_include

begin_include
include|#
directive|include
file|<dev/fdt/fdt_clock.h>
end_include

begin_include
include|#
directive|include
file|<mips/mediatek/fdt_reset.h>
end_include

begin_include
include|#
directive|include
file|<mips/mediatek/mtk_sysctl.h>
end_include

begin_include
include|#
directive|include
file|<mips/mediatek/mtk_soc.h>
end_include

begin_decl_stmt
specifier|static
name|uint32_t
name|mtk_soc_socid
init|=
name|MTK_SOC_UNKNOWN
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|uint32_t
name|mtk_soc_uartclk
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|uint32_t
name|mtk_soc_cpuclk
init|=
name|MTK_CPU_CLK_880MHZ
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|uint32_t
name|mtk_soc_timerclk
init|=
name|MTK_CPU_CLK_880MHZ
operator|/
literal|2
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|ofw_compat_data
name|compat_data
index|[]
init|=
block|{
block|{
literal|"ralink,rt2880-soc"
block|,
name|MTK_SOC_RT2880
block|}
block|,
block|{
literal|"ralink,rt3050-soc"
block|,
name|MTK_SOC_RT3050
block|}
block|,
block|{
literal|"ralink,rt3052-soc"
block|,
name|MTK_SOC_RT3052
block|}
block|,
block|{
literal|"ralink,rt3350-soc"
block|,
name|MTK_SOC_RT3350
block|}
block|,
block|{
literal|"ralink,rt3352-soc"
block|,
name|MTK_SOC_RT3352
block|}
block|,
block|{
literal|"ralink,rt3662-soc"
block|,
name|MTK_SOC_RT3662
block|}
block|,
block|{
literal|"ralink,rt3883-soc"
block|,
name|MTK_SOC_RT3883
block|}
block|,
block|{
literal|"ralink,rt5350-soc"
block|,
name|MTK_SOC_RT5350
block|}
block|,
block|{
literal|"ralink,mtk7620a-soc"
block|,
name|MTK_SOC_MT7620A
block|}
block|,
block|{
literal|"ralink,mt7620a-soc"
block|,
name|MTK_SOC_MT7620A
block|}
block|,
block|{
literal|"ralink,mtk7620n-soc"
block|,
name|MTK_SOC_MT7620N
block|}
block|,
block|{
literal|"ralink,mt7620n-soc"
block|,
name|MTK_SOC_MT7620N
block|}
block|,
block|{
literal|"mediatek,mtk7621-soc"
block|,
name|MTK_SOC_MT7621
block|}
block|,
block|{
literal|"mediatek,mt7621-soc"
block|,
name|MTK_SOC_MT7621
block|}
block|,
block|{
literal|"ralink,mt7621-soc"
block|,
name|MTK_SOC_MT7621
block|}
block|,
block|{
literal|"ralink,mtk7621-soc"
block|,
name|MTK_SOC_MT7621
block|}
block|,
block|{
literal|"ralink,mtk7628an-soc"
block|,
name|MTK_SOC_MT7628
block|}
block|,
block|{
literal|"mediatek,mt7628an-soc"
block|,
name|MTK_SOC_MT7628
block|}
block|,
block|{
literal|"ralink,mtk7688-soc"
block|,
name|MTK_SOC_MT7688
block|}
block|,
comment|/* Sentinel */
block|{
name|NULL
block|,
name|MTK_SOC_UNKNOWN
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|uint32_t
name|mtk_detect_cpuclk_rt2880
parameter_list|(
name|bus_space_tag_t
name|bst
parameter_list|,
name|bus_space_handle_t
name|bsh
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|;
name|val
operator|=
name|bus_space_read_4
argument_list|(
name|bst
argument_list|,
name|bsh
argument_list|,
name|SYSCTL_SYSCFG
argument_list|)
expr_stmt|;
name|val
operator|>>=
name|RT2880_CPU_CLKSEL_OFF
expr_stmt|;
name|val
operator|&=
name|RT2880_CPU_CLKSEL_MSK
expr_stmt|;
switch|switch
condition|(
name|val
condition|)
block|{
case|case
literal|0
case|:
return|return
operator|(
name|MTK_CPU_CLK_250MHZ
operator|)
return|;
case|case
literal|1
case|:
return|return
operator|(
name|MTK_CPU_CLK_266MHZ
operator|)
return|;
case|case
literal|2
case|:
return|return
operator|(
name|MTK_CPU_CLK_280MHZ
operator|)
return|;
case|case
literal|3
case|:
return|return
operator|(
name|MTK_CPU_CLK_300MHZ
operator|)
return|;
block|}
comment|/* Never reached */
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|mtk_detect_cpuclk_rt305x
parameter_list|(
name|bus_space_tag_t
name|bst
parameter_list|,
name|bus_space_handle_t
name|bsh
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|;
name|val
operator|=
name|bus_space_read_4
argument_list|(
name|bst
argument_list|,
name|bsh
argument_list|,
name|SYSCTL_CHIPID0_3
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|==
name|RT3350_CHIPID0_3
condition|)
return|return
operator|(
name|MTK_CPU_CLK_320MHZ
operator|)
return|;
name|val
operator|=
name|bus_space_read_4
argument_list|(
name|bst
argument_list|,
name|bsh
argument_list|,
name|SYSCTL_SYSCFG
argument_list|)
expr_stmt|;
name|val
operator|>>=
name|RT305X_CPU_CLKSEL_OFF
expr_stmt|;
name|val
operator|&=
name|RT305X_CPU_CLKSEL_MSK
expr_stmt|;
return|return
operator|(
operator|(
name|val
operator|==
literal|0
operator|)
condition|?
name|MTK_CPU_CLK_320MHZ
else|:
name|MTK_CPU_CLK_384MHZ
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|mtk_detect_cpuclk_rt3352
parameter_list|(
name|bus_space_tag_t
name|bst
parameter_list|,
name|bus_space_handle_t
name|bsh
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|;
name|val
operator|=
name|bus_space_read_4
argument_list|(
name|bst
argument_list|,
name|bsh
argument_list|,
name|SYSCTL_SYSCFG
argument_list|)
expr_stmt|;
name|val
operator|>>=
name|RT3352_CPU_CLKSEL_OFF
expr_stmt|;
name|val
operator|&=
name|RT3352_CPU_CLKSEL_MSK
expr_stmt|;
if|if
condition|(
name|val
condition|)
return|return
operator|(
name|MTK_CPU_CLK_400MHZ
operator|)
return|;
return|return
operator|(
name|MTK_CPU_CLK_384MHZ
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|mtk_detect_cpuclk_rt3883
parameter_list|(
name|bus_space_tag_t
name|bst
parameter_list|,
name|bus_space_handle_t
name|bsh
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|;
name|val
operator|=
name|bus_space_read_4
argument_list|(
name|bst
argument_list|,
name|bsh
argument_list|,
name|SYSCTL_SYSCFG
argument_list|)
expr_stmt|;
name|val
operator|>>=
name|RT3883_CPU_CLKSEL_OFF
expr_stmt|;
name|val
operator|&=
name|RT3883_CPU_CLKSEL_MSK
expr_stmt|;
switch|switch
condition|(
name|val
condition|)
block|{
case|case
literal|0
case|:
return|return
operator|(
name|MTK_CPU_CLK_250MHZ
operator|)
return|;
case|case
literal|1
case|:
return|return
operator|(
name|MTK_CPU_CLK_384MHZ
operator|)
return|;
case|case
literal|2
case|:
return|return
operator|(
name|MTK_CPU_CLK_480MHZ
operator|)
return|;
case|case
literal|3
case|:
return|return
operator|(
name|MTK_CPU_CLK_500MHZ
operator|)
return|;
block|}
comment|/* Never reached */
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|mtk_detect_cpuclk_rt5350
parameter_list|(
name|bus_space_tag_t
name|bst
parameter_list|,
name|bus_space_handle_t
name|bsh
parameter_list|)
block|{
name|uint32_t
name|val1
decl_stmt|,
name|val2
decl_stmt|;
name|val1
operator|=
name|val2
operator|=
name|bus_space_read_4
argument_list|(
name|bst
argument_list|,
name|bsh
argument_list|,
name|SYSCTL_SYSCFG
argument_list|)
expr_stmt|;
name|val1
operator|>>=
name|RT5350_CPU_CLKSEL_OFF1
expr_stmt|;
name|val2
operator|>>=
name|RT5350_CPU_CLKSEL_OFF2
expr_stmt|;
name|val1
operator|&=
name|RT5350_CPU_CLKSEL_MSK
expr_stmt|;
name|val2
operator|&=
name|RT5350_CPU_CLKSEL_MSK
expr_stmt|;
name|val1
operator||=
operator|(
name|val2
operator|<<
literal|1
operator|)
expr_stmt|;
switch|switch
condition|(
name|val1
condition|)
block|{
case|case
literal|0
case|:
return|return
operator|(
name|MTK_CPU_CLK_360MHZ
operator|)
return|;
case|case
literal|1
case|:
comment|/* Reserved value, but we return UNKNOWN */
return|return
operator|(
name|MTK_CPU_CLK_UNKNOWN
operator|)
return|;
case|case
literal|2
case|:
return|return
operator|(
name|MTK_CPU_CLK_320MHZ
operator|)
return|;
case|case
literal|3
case|:
return|return
operator|(
name|MTK_CPU_CLK_300MHZ
operator|)
return|;
block|}
comment|/* Never reached */
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|mtk_detect_cpuclk_mt7620
parameter_list|(
name|bus_space_tag_t
name|bst
parameter_list|,
name|bus_space_handle_t
name|bsh
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|,
name|mul
decl_stmt|,
name|div
decl_stmt|,
name|res
decl_stmt|;
name|val
operator|=
name|bus_space_read_4
argument_list|(
name|bst
argument_list|,
name|bsh
argument_list|,
name|SYSCTL_MT7620_CPLL_CFG1
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|&
name|MT7620_CPU_CLK_AUX0
condition|)
return|return
operator|(
name|MTK_CPU_CLK_480MHZ
operator|)
return|;
name|val
operator|=
name|bus_space_read_4
argument_list|(
name|bst
argument_list|,
name|bsh
argument_list|,
name|SYSCTL_MT7620_CPLL_CFG0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|val
operator|&
name|MT7620_CPLL_SW_CFG
operator|)
condition|)
return|return
operator|(
name|MTK_CPU_CLK_600MHZ
operator|)
return|;
name|mul
operator|=
name|MT7620_PLL_MULT_RATIO_BASE
operator|+
operator|(
operator|(
name|val
operator|>>
name|MT7620_PLL_MULT_RATIO_OFF
operator|)
operator|&
name|MT7620_PLL_MULT_RATIO_MSK
operator|)
expr_stmt|;
name|div
operator|=
operator|(
name|val
operator|>>
name|MT7620_PLL_DIV_RATIO_OFF
operator|)
operator|&
name|MT7620_PLL_DIV_RATIO_MSK
expr_stmt|;
if|if
condition|(
name|div
operator|!=
name|MT7620_PLL_DIV_RATIO_MSK
condition|)
name|div
operator|+=
name|MT7620_PLL_DIV_RATIO_BASE
expr_stmt|;
else|else
name|div
operator|=
name|MT7620_PLL_DIV_RATIO_MAX
expr_stmt|;
name|res
operator|=
operator|(
name|MT7620_XTAL_40
operator|*
name|mul
operator|)
operator|/
name|div
expr_stmt|;
return|return
operator|(
name|MTK_MHZ
argument_list|(
name|res
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|mtk_detect_cpuclk_mt7621
parameter_list|(
name|bus_space_tag_t
name|bst
parameter_list|,
name|bus_space_handle_t
name|bsh
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|,
name|div
decl_stmt|,
name|res
decl_stmt|;
name|val
operator|=
name|bus_space_read_4
argument_list|(
name|bst
argument_list|,
name|bsh
argument_list|,
name|SYSCTL_CLKCFG0
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|&
name|MT7621_USES_MEMDIV
condition|)
block|{
name|div
operator|=
name|bus_space_read_4
argument_list|(
name|bst
argument_list|,
name|bsh
argument_list|,
name|MTK_MT7621_CLKDIV_REG
argument_list|)
expr_stmt|;
name|div
operator|>>=
name|MT7621_MEMDIV_OFF
expr_stmt|;
name|div
operator|&=
name|MT7621_MEMDIV_MSK
expr_stmt|;
name|div
operator|+=
name|MT7621_MEMDIV_BASE
expr_stmt|;
name|val
operator|=
name|bus_space_read_4
argument_list|(
name|bst
argument_list|,
name|bsh
argument_list|,
name|SYSCTL_SYSCFG
argument_list|)
expr_stmt|;
name|val
operator|>>=
name|MT7621_CLKSEL_OFF
expr_stmt|;
name|val
operator|&=
name|MT7621_CLKSEL_MSK
expr_stmt|;
if|if
condition|(
name|val
operator|>=
name|MT7621_CLKSEL_25MHZ_VAL
condition|)
name|res
operator|=
name|div
operator|*
name|MT7621_CLKSEL_25MHZ
expr_stmt|;
elseif|else
if|if
condition|(
name|val
operator|>=
name|MT7621_CLKSEL_20MHZ_VAL
condition|)
name|res
operator|=
name|div
operator|*
name|MT7621_CLKSEL_20MHZ
expr_stmt|;
else|else
name|res
operator|=
name|div
operator|*
literal|0
expr_stmt|;
comment|/* XXX: not sure about this */
block|}
else|else
block|{
name|val
operator|=
name|bus_space_read_4
argument_list|(
name|bst
argument_list|,
name|bsh
argument_list|,
name|SYSCTL_CUR_CLK_STS
argument_list|)
expr_stmt|;
name|div
operator|=
operator|(
name|val
operator|>>
name|MT7621_CLK_STS_DIV_OFF
operator|)
operator|&
name|MT7621_CLK_STS_MSK
expr_stmt|;
name|val
operator|&=
name|MT7621_CLK_STS_MSK
expr_stmt|;
name|res
operator|=
operator|(
name|MT7621_CLK_STS_BASE
operator|*
name|val
operator|)
operator|/
name|div
expr_stmt|;
block|}
return|return
operator|(
name|MTK_MHZ
argument_list|(
name|res
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|mtk_detect_cpuclk_mt7628
parameter_list|(
name|bus_space_tag_t
name|bst
parameter_list|,
name|bus_space_handle_t
name|bsh
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|;
name|val
operator|=
name|bus_space_read_4
argument_list|(
name|bst
argument_list|,
name|bsh
argument_list|,
name|SYSCTL_SYSCFG
argument_list|)
expr_stmt|;
name|val
operator|>>=
name|MT7628_CPU_CLKSEL_OFF
expr_stmt|;
name|val
operator|&=
name|MT7628_CPU_CLKSEL_MSK
expr_stmt|;
if|if
condition|(
name|val
condition|)
return|return
operator|(
name|MTK_CPU_CLK_580MHZ
operator|)
return|;
return|return
operator|(
name|MTK_CPU_CLK_575MHZ
operator|)
return|;
block|}
end_function

begin_function
name|void
name|mtk_soc_try_early_detect
parameter_list|(
name|void
parameter_list|)
block|{
name|bus_space_tag_t
name|bst
decl_stmt|;
name|bus_space_handle_t
name|bsh
decl_stmt|;
name|uint32_t
name|base
decl_stmt|;
name|phandle_t
name|node
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|(
name|node
operator|=
name|OF_finddevice
argument_list|(
literal|"/"
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
return|return;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|compat_data
index|[
name|i
index|]
operator|.
name|ocd_str
operator|!=
name|NULL
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ofw_bus_node_is_compatible
argument_list|(
name|node
argument_list|,
name|compat_data
index|[
name|i
index|]
operator|.
name|ocd_str
argument_list|)
condition|)
block|{
name|mtk_soc_socid
operator|=
name|compat_data
index|[
name|i
index|]
operator|.
name|ocd_data
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|mtk_soc_socid
operator|==
name|MTK_SOC_UNKNOWN
condition|)
block|{
comment|/* We don't know the SoC, so we don't know how to get clocks */
return|return;
block|}
name|bst
operator|=
name|fdtbus_bs_tag
expr_stmt|;
if|if
condition|(
name|mtk_soc_socid
operator|==
name|MTK_SOC_RT2880
condition|)
name|base
operator|=
name|MTK_RT2880_BASE
expr_stmt|;
elseif|else
if|if
condition|(
name|mtk_soc_socid
operator|==
name|MTK_SOC_MT7621
condition|)
name|base
operator|=
name|MTK_MT7621_BASE
expr_stmt|;
else|else
name|base
operator|=
name|MTK_DEFAULT_BASE
expr_stmt|;
if|if
condition|(
name|bus_space_map
argument_list|(
name|bst
argument_list|,
name|base
argument_list|,
name|MTK_DEFAULT_SIZE
argument_list|,
literal|0
argument_list|,
operator|&
name|bsh
argument_list|)
condition|)
return|return;
comment|/* First, figure out the CPU clock */
switch|switch
condition|(
name|mtk_soc_socid
condition|)
block|{
case|case
name|MTK_SOC_RT2880
case|:
name|mtk_soc_cpuclk
operator|=
name|mtk_detect_cpuclk_rt2880
argument_list|(
name|bst
argument_list|,
name|bsh
argument_list|)
expr_stmt|;
break|break;
case|case
name|MTK_SOC_RT3050
case|:
comment|/* fallthrough */
case|case
name|MTK_SOC_RT3052
case|:
case|case
name|MTK_SOC_RT3350
case|:
name|mtk_soc_cpuclk
operator|=
name|mtk_detect_cpuclk_rt305x
argument_list|(
name|bst
argument_list|,
name|bsh
argument_list|)
expr_stmt|;
break|break;
case|case
name|MTK_SOC_RT3352
case|:
name|mtk_soc_cpuclk
operator|=
name|mtk_detect_cpuclk_rt3352
argument_list|(
name|bst
argument_list|,
name|bsh
argument_list|)
expr_stmt|;
break|break;
case|case
name|MTK_SOC_RT3662
case|:
comment|/* fallthrough */
case|case
name|MTK_SOC_RT3883
case|:
name|mtk_soc_cpuclk
operator|=
name|mtk_detect_cpuclk_rt3883
argument_list|(
name|bst
argument_list|,
name|bsh
argument_list|)
expr_stmt|;
break|break;
case|case
name|MTK_SOC_RT5350
case|:
name|mtk_soc_cpuclk
operator|=
name|mtk_detect_cpuclk_rt5350
argument_list|(
name|bst
argument_list|,
name|bsh
argument_list|)
expr_stmt|;
break|break;
case|case
name|MTK_SOC_MT7620A
case|:
comment|/* fallthrough */
case|case
name|MTK_SOC_MT7620N
case|:
name|mtk_soc_cpuclk
operator|=
name|mtk_detect_cpuclk_mt7620
argument_list|(
name|bst
argument_list|,
name|bsh
argument_list|)
expr_stmt|;
break|break;
case|case
name|MTK_SOC_MT7621
case|:
name|mtk_soc_cpuclk
operator|=
name|mtk_detect_cpuclk_mt7621
argument_list|(
name|bst
argument_list|,
name|bsh
argument_list|)
expr_stmt|;
break|break;
case|case
name|MTK_SOC_MT7628
case|:
comment|/* fallthrough */
case|case
name|MTK_SOC_MT7688
case|:
name|mtk_soc_cpuclk
operator|=
name|mtk_detect_cpuclk_mt7628
argument_list|(
name|bst
argument_list|,
name|bsh
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|/* We don't know the SoC, so we can't find the CPU clock */
break|break;
block|}
comment|/* Now figure out the timer clock */
if|if
condition|(
name|mtk_soc_socid
operator|==
name|MTK_SOC_MT7621
condition|)
block|{
ifdef|#
directive|ifdef
name|notyet
comment|/*  		 * We use the GIC timer for timing source and its clock freq is 		 * the same as the CPU's clock freq 		 */
name|mtk_soc_timerclk
operator|=
name|mtk_soc_cpuclk
expr_stmt|;
else|#
directive|else
comment|/* 		 * When GIC timer and MIPS timer are ready to co-exist and 		 * GIC timer is actually implemented, we need to switch to it. 		 * Until then we use a fake GIC timer, which is actually a 		 * normal MIPS ticker, so the timer clock is half the CPU clock 		 */
name|mtk_soc_timerclk
operator|=
name|mtk_soc_cpuclk
operator|/
literal|2
expr_stmt|;
endif|#
directive|endif
block|}
else|else
block|{
comment|/* 		 * We use the MIPS ticker for the rest for now, so 		 * the CPU clock is divided by 2 		 */
name|mtk_soc_timerclk
operator|=
name|mtk_soc_cpuclk
operator|/
literal|2
expr_stmt|;
block|}
switch|switch
condition|(
name|mtk_soc_socid
condition|)
block|{
case|case
name|MTK_SOC_RT2880
case|:
name|mtk_soc_uartclk
operator|=
name|mtk_soc_cpuclk
operator|/
name|MTK_UARTDIV_2
expr_stmt|;
break|break;
case|case
name|MTK_SOC_RT3350
case|:
comment|/* fallthrough */
case|case
name|MTK_SOC_RT3050
case|:
comment|/* fallthrough */
case|case
name|MTK_SOC_RT3052
case|:
comment|/* UART clock is CPU clock / 3 */
name|mtk_soc_uartclk
operator|=
name|mtk_soc_cpuclk
operator|/
name|MTK_UARTDIV_3
expr_stmt|;
break|break;
case|case
name|MTK_SOC_RT3352
case|:
comment|/* fallthrough */
case|case
name|MTK_SOC_RT3662
case|:
comment|/* fallthrough */
case|case
name|MTK_SOC_RT3883
case|:
comment|/* fallthrough */
case|case
name|MTK_SOC_RT5350
case|:
comment|/* fallthrough */
case|case
name|MTK_SOC_MT7620A
case|:
comment|/* fallthrough */
case|case
name|MTK_SOC_MT7620N
case|:
comment|/* fallthrough */
case|case
name|MTK_SOC_MT7628
case|:
comment|/* fallthrough */
case|case
name|MTK_SOC_MT7688
case|:
comment|/* UART clock is always 40MHz */
name|mtk_soc_uartclk
operator|=
name|MTK_UART_CLK_40MHZ
expr_stmt|;
break|break;
case|case
name|MTK_SOC_MT7621
case|:
comment|/* UART clock is always 50MHz */
name|mtk_soc_uartclk
operator|=
name|MTK_UART_CLK_50MHZ
expr_stmt|;
break|break;
default|default:
comment|/* We don't know the SoC, so we don't know the UART clock */
break|break;
block|}
name|bus_space_unmap
argument_list|(
name|bst
argument_list|,
name|bsh
argument_list|,
name|MTK_DEFAULT_SIZE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|uint32_t
name|mtk_soc_get_uartclk
parameter_list|(
name|void
parameter_list|)
block|{
return|return
name|mtk_soc_uartclk
return|;
block|}
end_function

begin_function
name|uint32_t
name|mtk_soc_get_cpuclk
parameter_list|(
name|void
parameter_list|)
block|{
return|return
name|mtk_soc_cpuclk
return|;
block|}
end_function

begin_function
name|uint32_t
name|mtk_soc_get_timerclk
parameter_list|(
name|void
parameter_list|)
block|{
return|return
name|mtk_soc_timerclk
return|;
block|}
end_function

begin_function
name|uint32_t
name|mtk_soc_get_socid
parameter_list|(
name|void
parameter_list|)
block|{
return|return
name|mtk_soc_socid
return|;
block|}
end_function

begin_comment
comment|/*  * The following are generic reset and clock functions  */
end_comment

begin_comment
comment|/* Default reset time is 100ms */
end_comment

begin_define
define|#
directive|define
name|DEFAULT_RESET_TIME
value|100000
end_define

begin_function
name|int
name|mtk_soc_reset_device
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|int
name|res
decl_stmt|;
name|res
operator|=
name|fdt_reset_assert_all
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
literal|0
condition|)
block|{
name|DELAY
argument_list|(
name|DEFAULT_RESET_TIME
argument_list|)
expr_stmt|;
name|res
operator|=
name|fdt_reset_deassert_all
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
literal|0
condition|)
name|DELAY
argument_list|(
name|DEFAULT_RESET_TIME
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|res
operator|)
return|;
block|}
end_function

begin_function
name|int
name|mtk_soc_stop_clock
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
return|return
operator|(
name|fdt_clock_disable_all
argument_list|(
name|dev
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|mtk_soc_start_clock
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
return|return
operator|(
name|fdt_clock_enable_all
argument_list|(
name|dev
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|mtk_soc_assert_reset
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
return|return
operator|(
name|fdt_reset_assert_all
argument_list|(
name|dev
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|mtk_soc_deassert_reset
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
return|return
operator|(
name|fdt_reset_deassert_all
argument_list|(
name|dev
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|void
name|mtk_soc_reset
parameter_list|(
name|void
parameter_list|)
block|{
name|mtk_sysctl_clr_set
argument_list|(
name|SYSCTL_RSTCTRL
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|mtk_sysctl_clr_set
argument_list|(
name|SYSCTL_RSTCTRL
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


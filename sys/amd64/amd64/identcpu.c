begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 1992 Terrence R. Lambert.  * Copyright (c) 1982, 1987, 1990 The Regents of the University of California.  * Copyright (c) 1997 KATO Takenori.  * All rights reserved.  *  * This code is derived from software contributed to Berkeley by  * William Jolitz.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. All advertising materials mentioning features or use of this software  *    must display the following acknowledgement:  *	This product includes software developed by the University of  *	California, Berkeley and its contributors.  * 4. Neither the name of the University nor the names of its contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  *	from: Id: machdep.c,v 1.193 1996/06/18 01:22:04 bde Exp  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"opt_cpu.h"
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/cpu.h>
end_include

begin_include
include|#
directive|include
file|<sys/eventhandler.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/power.h>
end_include

begin_include
include|#
directive|include
file|<machine/asmacros.h>
end_include

begin_include
include|#
directive|include
file|<machine/clock.h>
end_include

begin_include
include|#
directive|include
file|<machine/cputypes.h>
end_include

begin_include
include|#
directive|include
file|<machine/frame.h>
end_include

begin_include
include|#
directive|include
file|<machine/intr_machdep.h>
end_include

begin_include
include|#
directive|include
file|<machine/segments.h>
end_include

begin_include
include|#
directive|include
file|<machine/specialreg.h>
end_include

begin_include
include|#
directive|include
file|<machine/md_var.h>
end_include

begin_include
include|#
directive|include
file|<amd64/isa/icu.h>
end_include

begin_comment
comment|/* XXX - should be in header file: */
end_comment

begin_function_decl
name|void
name|printcpuinfo
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|identify_cpu
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|earlysetcpuclass
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|panicifcpuunsupported
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|print_AMD_info
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|print_AMD_assoc
parameter_list|(
name|int
name|i
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
name|int
name|cpu_class
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|machine
index|[]
init|=
literal|"amd64"
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|SYSCTL_STRING
argument_list|(
name|_hw
argument_list|,
name|HW_MACHINE
argument_list|,
name|machine
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|machine
argument_list|,
literal|0
argument_list|,
literal|"Machine class"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|char
name|cpu_model
index|[
literal|128
index|]
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|SYSCTL_STRING
argument_list|(
name|_hw
argument_list|,
name|HW_MODEL
argument_list|,
name|model
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|cpu_model
argument_list|,
literal|0
argument_list|,
literal|"Machine model"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|int
name|hw_clockrate
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_hw
argument_list|,
name|OID_AUTO
argument_list|,
name|clockrate
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|hw_clockrate
argument_list|,
literal|0
argument_list|,
literal|"CPU instruction clock rate"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|char
name|cpu_brand
index|[
literal|48
index|]
decl_stmt|;
end_decl_stmt

begin_struct
specifier|static
struct|struct
block|{
name|char
modifier|*
name|cpu_name
decl_stmt|;
name|int
name|cpu_class
decl_stmt|;
block|}
name|amd64_cpus
index|[]
init|=
block|{
block|{
literal|"Clawhammer"
block|,
name|CPUCLASS_K8
block|}
block|,
comment|/* CPU_CLAWHAMMER */
block|{
literal|"Sledgehammer"
block|,
name|CPUCLASS_K8
block|}
block|,
comment|/* CPU_SLEDGEHAMMER */
block|}
struct|;
end_struct

begin_function
name|void
name|printcpuinfo
parameter_list|(
name|void
parameter_list|)
block|{
name|u_int
name|regs
index|[
literal|4
index|]
decl_stmt|,
name|i
decl_stmt|;
name|char
modifier|*
name|brand
decl_stmt|;
name|cpu_class
operator|=
name|amd64_cpus
index|[
name|cpu
index|]
operator|.
name|cpu_class
expr_stmt|;
name|printf
argument_list|(
literal|"CPU: "
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|cpu_model
argument_list|,
name|amd64_cpus
index|[
name|cpu
index|]
operator|.
name|cpu_name
argument_list|,
sizeof|sizeof
argument_list|(
name|cpu_model
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Check for extended CPUID information and a processor name. */
if|if
condition|(
name|cpu_exthigh
operator|>=
literal|0x80000004
condition|)
block|{
name|brand
operator|=
name|cpu_brand
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0x80000002
init|;
name|i
operator|<
literal|0x80000005
condition|;
name|i
operator|++
control|)
block|{
name|do_cpuid
argument_list|(
name|i
argument_list|,
name|regs
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|brand
argument_list|,
name|regs
argument_list|,
sizeof|sizeof
argument_list|(
name|regs
argument_list|)
argument_list|)
expr_stmt|;
name|brand
operator|+=
sizeof|sizeof
argument_list|(
name|regs
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|cpu_vendor
argument_list|,
literal|"GenuineIntel"
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* Please make up your mind folks! */
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"EM64T"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|cpu_vendor
argument_list|,
literal|"AuthenticAMD"
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* 		 * Values taken from AMD Processor Recognition 		 * http://www.amd.com/K6/k6docs/pdf/20734g.pdf 		 * (also describes ``Features'' encodings. 		 */
name|strcpy
argument_list|(
name|cpu_model
argument_list|,
literal|"AMD "
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cpu_id
operator|&
literal|0xF00
condition|)
block|{
case|case
literal|0xf00
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"AMD64 Processor"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"Unknown"
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
comment|/* 	 * Replace cpu_model with cpu_brand minus leading spaces if 	 * we have one. 	 */
name|brand
operator|=
name|cpu_brand
expr_stmt|;
while|while
condition|(
operator|*
name|brand
operator|==
literal|' '
condition|)
operator|++
name|brand
expr_stmt|;
if|if
condition|(
operator|*
name|brand
operator|!=
literal|'\0'
condition|)
name|strcpy
argument_list|(
name|cpu_model
argument_list|,
name|brand
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s ("
argument_list|,
name|cpu_model
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cpu_class
condition|)
block|{
case|case
name|CPUCLASS_K8
case|:
name|hw_clockrate
operator|=
operator|(
name|tsc_freq
operator|+
literal|5000
operator|)
operator|/
literal|1000000
expr_stmt|;
name|printf
argument_list|(
literal|"%jd.%02d-MHz "
argument_list|,
call|(
name|intmax_t
call|)
argument_list|(
name|tsc_freq
operator|+
literal|4999
argument_list|)
operator|/
literal|1000000
argument_list|,
call|(
name|u_int
call|)
argument_list|(
operator|(
name|tsc_freq
operator|+
literal|4999
operator|)
operator|/
literal|10000
argument_list|)
operator|%
literal|100
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"K8"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"Unknown"
argument_list|)
expr_stmt|;
comment|/* will panic below... */
block|}
name|printf
argument_list|(
literal|"-class CPU)\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|cpu_vendor
condition|)
name|printf
argument_list|(
literal|"  Origin = \"%s\""
argument_list|,
name|cpu_vendor
argument_list|)
expr_stmt|;
if|if
condition|(
name|cpu_id
condition|)
name|printf
argument_list|(
literal|"  Id = 0x%x"
argument_list|,
name|cpu_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|cpu_vendor
argument_list|,
literal|"GenuineIntel"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|cpu_vendor
argument_list|,
literal|"AuthenticAMD"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"  Stepping = %u"
argument_list|,
name|cpu_id
operator|&
literal|0xf
argument_list|)
expr_stmt|;
if|if
condition|(
name|cpu_high
operator|>
literal|0
condition|)
block|{
name|u_int
name|cmp
init|=
literal|1
decl_stmt|,
name|htt
init|=
literal|1
decl_stmt|;
comment|/* 			 * Here we should probably set up flags indicating 			 * whether or not various features are available. 			 * The interesting ones are probably VME, PSE, PAE, 			 * and PGE.  The code already assumes without bothering 			 * to check that all CPUs>= Pentium have a TSC and 			 * MSRs. 			 */
name|printf
argument_list|(
literal|"\n  Features=0x%b"
argument_list|,
name|cpu_feature
argument_list|,
literal|"\020"
literal|"\001FPU"
comment|/* Integral FPU */
literal|"\002VME"
comment|/* Extended VM86 mode support */
literal|"\003DE"
comment|/* Debugging Extensions (CR4.DE) */
literal|"\004PSE"
comment|/* 4MByte page tables */
literal|"\005TSC"
comment|/* Timestamp counter */
literal|"\006MSR"
comment|/* Machine specific registers */
literal|"\007PAE"
comment|/* Physical address extension */
literal|"\010MCE"
comment|/* Machine Check support */
literal|"\011CX8"
comment|/* CMPEXCH8 instruction */
literal|"\012APIC"
comment|/* SMP local APIC */
literal|"\013oldMTRR"
comment|/* Previous implementation of MTRR */
literal|"\014SEP"
comment|/* Fast System Call */
literal|"\015MTRR"
comment|/* Memory Type Range Registers */
literal|"\016PGE"
comment|/* PG_G (global bit) support */
literal|"\017MCA"
comment|/* Machine Check Architecture */
literal|"\020CMOV"
comment|/* CMOV instruction */
literal|"\021PAT"
comment|/* Page attributes table */
literal|"\022PSE36"
comment|/* 36 bit address space support */
literal|"\023PN"
comment|/* Processor Serial number */
literal|"\024CLFLUSH"
comment|/* Has the CLFLUSH instruction */
literal|"\025<b20>"
literal|"\026DTS"
comment|/* Debug Trace Store */
literal|"\027ACPI"
comment|/* ACPI support */
literal|"\030MMX"
comment|/* MMX instructions */
literal|"\031FXSR"
comment|/* FXSAVE/FXRSTOR */
literal|"\032SSE"
comment|/* Streaming SIMD Extensions */
literal|"\033SSE2"
comment|/* Streaming SIMD Extensions #2 */
literal|"\034SS"
comment|/* Self snoop */
literal|"\035HTT"
comment|/* Hyperthreading (see EBX bit 16-23) */
literal|"\036TM"
comment|/* Thermal Monitor clock slowdown */
literal|"\037IA64"
comment|/* CPU can execute IA64 instructions */
literal|"\040PBE"
comment|/* Pending Break Enable */
argument_list|)
expr_stmt|;
if|if
condition|(
name|cpu_feature2
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"\n  Features2=0x%b"
argument_list|,
name|cpu_feature2
argument_list|,
literal|"\020"
literal|"\001SSE3"
comment|/* SSE3 */
literal|"\002<b1>"
literal|"\003DTES64"
comment|/* 64-bit Debug Trace */
literal|"\004MON"
comment|/* MONITOR/MWAIT Instructions */
literal|"\005DS_CPL"
comment|/* CPL Qualified Debug Store */
literal|"\006VMX"
comment|/* Virtual Machine Extensions */
literal|"\007SMX"
comment|/* Safer Mode Extensions */
literal|"\010EST"
comment|/* Enhanced SpeedStep */
literal|"\011TM2"
comment|/* Thermal Monitor 2 */
literal|"\012SSSE3"
comment|/* SSSE3 */
literal|"\013CNXT-ID"
comment|/* L1 context ID available */
literal|"\014<b11>"
literal|"\015<b12>"
literal|"\016CX16"
comment|/* CMPXCHG16B Instruction */
literal|"\017xTPR"
comment|/* Send Task Priority Messages*/
literal|"\020PDCM"
comment|/* Perf/Debug Capability MSR */
literal|"\021<b16>"
literal|"\022<b17>"
literal|"\023DCA"
comment|/* Direct Cache Access */
literal|"\024SSE4.1"
literal|"\025SSE4.2"
literal|"\026x2APIC"
comment|/* xAPIC Extensions */
literal|"\027<b22>"
literal|"\030POPCNT"
literal|"\031<b24>"
literal|"\032<b25>"
literal|"\033XSAVE"
literal|"\034OSXSAVE"
literal|"\035<b28>"
literal|"\036<b29>"
literal|"\037<b30>"
literal|"\040<b31>"
argument_list|)
expr_stmt|;
block|}
comment|/* 			 * AMD64 Architecture Programmer's Manual Volume 3: 			 * General-Purpose and System Instructions 			 * http://www.amd.com/us-en/assets/content_type/white_papers_and_tech_docs/24594.pdf 			 * 			 * IA-32 Intel Architecture Software Developer's Manual, 			 * Volume 2A: Instruction Set Reference, A-M 			 * ftp://download.intel.com/design/Pentium4/manuals/25366617.pdf 			 */
if|if
condition|(
name|amd_feature
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"\n  AMD Features=0x%b"
argument_list|,
name|amd_feature
argument_list|,
literal|"\020"
comment|/* in hex */
literal|"\001<s0>"
comment|/* Same */
literal|"\002<s1>"
comment|/* Same */
literal|"\003<s2>"
comment|/* Same */
literal|"\004<s3>"
comment|/* Same */
literal|"\005<s4>"
comment|/* Same */
literal|"\006<s5>"
comment|/* Same */
literal|"\007<s6>"
comment|/* Same */
literal|"\010<s7>"
comment|/* Same */
literal|"\011<s8>"
comment|/* Same */
literal|"\012<s9>"
comment|/* Same */
literal|"\013<b10>"
comment|/* Undefined */
literal|"\014SYSCALL"
comment|/* Have SYSCALL/SYSRET */
literal|"\015<s12>"
comment|/* Same */
literal|"\016<s13>"
comment|/* Same */
literal|"\017<s14>"
comment|/* Same */
literal|"\020<s15>"
comment|/* Same */
literal|"\021<s16>"
comment|/* Same */
literal|"\022<s17>"
comment|/* Same */
literal|"\023<b18>"
comment|/* Reserved, unknown */
literal|"\024MP"
comment|/* Multiprocessor Capable */
literal|"\025NX"
comment|/* Has EFER.NXE, NX */
literal|"\026<b21>"
comment|/* Undefined */
literal|"\027MMX+"
comment|/* AMD MMX Extensions */
literal|"\030<s23>"
comment|/* Same */
literal|"\031<s24>"
comment|/* Same */
literal|"\032FFXSR"
comment|/* Fast FXSAVE/FXRSTOR */
literal|"\033Page1GB"
comment|/* 1-GB large page support */
literal|"\034RDTSCP"
comment|/* RDTSCP */
literal|"\035<b28>"
comment|/* Undefined */
literal|"\036LM"
comment|/* 64 bit long mode */
literal|"\0373DNow!+"
comment|/* AMD 3DNow! Extensions */
literal|"\0403DNow!"
comment|/* AMD 3DNow! */
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|amd_feature2
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"\n  AMD Features2=0x%b"
argument_list|,
name|amd_feature2
argument_list|,
literal|"\020"
literal|"\001LAHF"
comment|/* LAHF/SAHF in long mode */
literal|"\002CMP"
comment|/* CMP legacy */
literal|"\003SVM"
comment|/* Secure Virtual Mode */
literal|"\004ExtAPIC"
comment|/* Extended APIC register */
literal|"\005CR8"
comment|/* CR8 in legacy mode */
literal|"\006ABM"
comment|/* LZCNT instruction */
literal|"\007SSE4A"
comment|/* SSE4A */
literal|"\010MAS"
comment|/* Misaligned SSE mode */
literal|"\011Prefetch"
comment|/* 3DNow! Prefetch/PrefetchW */
literal|"\012OSVW"
comment|/* OS visible workaround */
literal|"\013IBS"
comment|/* Instruction based sampling */
literal|"\014SSE5"
comment|/* SSE5 */
literal|"\015SKINIT"
comment|/* SKINIT/STGI */
literal|"\016WDT"
comment|/* Watchdog timer */
literal|"\017<b14>"
literal|"\020<b15>"
literal|"\021<b16>"
literal|"\022<b17>"
literal|"\023<b18>"
literal|"\024<b19>"
literal|"\025<b20>"
literal|"\026<b21>"
literal|"\027<b22>"
literal|"\030<b23>"
literal|"\031<b24>"
literal|"\032<b25>"
literal|"\033<b26>"
literal|"\034<b27>"
literal|"\035<b28>"
literal|"\036<b29>"
literal|"\037<b30>"
literal|"\040<b31>"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|cpu_feature
operator|&
name|CPUID_HTT
operator|&&
name|strcmp
argument_list|(
name|cpu_vendor
argument_list|,
literal|"AuthenticAMD"
argument_list|)
operator|==
literal|0
condition|)
name|cpu_feature
operator|&=
operator|~
name|CPUID_HTT
expr_stmt|;
comment|/* 			 * If this CPU supports P-state invariant TSC then 			 * mention the capability. 			 */
if|if
condition|(
operator|!
name|tsc_is_invariant
operator|&&
operator|(
name|strcmp
argument_list|(
name|cpu_vendor
argument_list|,
literal|"AuthenticAMD"
argument_list|)
operator|==
literal|0
operator|&&
operator|(
operator|(
name|amd_pminfo
operator|&
name|AMDPM_TSC_INVARIANT
operator|)
operator|!=
literal|0
operator|||
name|AMD64_CPU_FAMILY
argument_list|(
name|cpu_id
argument_list|)
operator|>=
literal|0x10
operator|||
name|cpu_id
operator|==
literal|0x60fb2
operator|)
operator|)
condition|)
block|{
name|tsc_is_invariant
operator|=
literal|1
expr_stmt|;
name|printf
argument_list|(
literal|"\n  TSC: P-state invariant"
argument_list|)
expr_stmt|;
block|}
comment|/* 			 * If this CPU supports HTT or CMP then mention the 			 * number of physical/logical cores it contains. 			 */
if|if
condition|(
name|cpu_feature
operator|&
name|CPUID_HTT
condition|)
name|htt
operator|=
operator|(
name|cpu_procinfo
operator|&
name|CPUID_HTT_CORES
operator|)
operator|>>
literal|16
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|cpu_vendor
argument_list|,
literal|"AuthenticAMD"
argument_list|)
operator|==
literal|0
operator|&&
operator|(
name|amd_feature2
operator|&
name|AMDID2_CMP
operator|)
condition|)
name|cmp
operator|=
operator|(
name|cpu_procinfo2
operator|&
name|AMDID_CMP_CORES
operator|)
operator|+
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|cpu_vendor
argument_list|,
literal|"GenuineIntel"
argument_list|)
operator|==
literal|0
operator|&&
operator|(
name|cpu_high
operator|>=
literal|4
operator|)
condition|)
block|{
name|cpuid_count
argument_list|(
literal|4
argument_list|,
literal|0
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|regs
index|[
literal|0
index|]
operator|&
literal|0x1f
operator|)
operator|!=
literal|0
condition|)
name|cmp
operator|=
operator|(
operator|(
name|regs
index|[
literal|0
index|]
operator|>>
literal|26
operator|)
operator|&
literal|0x3f
operator|)
operator|+
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|cmp
operator|>
literal|1
condition|)
name|printf
argument_list|(
literal|"\n  Cores per package: %d"
argument_list|,
name|cmp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|htt
operator|/
name|cmp
operator|)
operator|>
literal|1
condition|)
name|printf
argument_list|(
literal|"\n  Logical CPUs per core: %d"
argument_list|,
name|htt
operator|/
name|cmp
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Avoid ugly blank lines: only print newline when we have to. */
if|if
condition|(
operator|*
name|cpu_vendor
operator|||
name|cpu_id
condition|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bootverbose
condition|)
return|return;
if|if
condition|(
name|strcmp
argument_list|(
name|cpu_vendor
argument_list|,
literal|"AuthenticAMD"
argument_list|)
operator|==
literal|0
condition|)
name|print_AMD_info
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|void
name|panicifcpuunsupported
parameter_list|(
name|void
parameter_list|)
block|{
ifndef|#
directive|ifndef
name|HAMMER
error|#
directive|error
literal|"You need to specify a cpu type"
endif|#
directive|endif
comment|/* 	 * Now that we have told the user what they have, 	 * let them know if that machine type isn't configured. 	 */
switch|switch
condition|(
name|cpu_class
condition|)
block|{
case|case
name|CPUCLASS_X86
case|:
ifndef|#
directive|ifndef
name|HAMMER
case|case
name|CPUCLASS_K8
case|:
endif|#
directive|endif
name|panic
argument_list|(
literal|"CPU class not configured"
argument_list|)
expr_stmt|;
default|default:
break|break;
block|}
block|}
end_function

begin_comment
comment|/* Update TSC freq with the value indicated by the caller. */
end_comment

begin_function
specifier|static
name|void
name|tsc_freq_changed
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
specifier|const
name|struct
name|cf_level
modifier|*
name|level
parameter_list|,
name|int
name|status
parameter_list|)
block|{
comment|/* 	 * If there was an error during the transition or 	 * TSC is P-state invariant, don't do anything. 	 */
if|if
condition|(
name|status
operator|!=
literal|0
operator|||
name|tsc_is_invariant
condition|)
return|return;
comment|/* Total setting for this level gives the new frequency in MHz. */
name|hw_clockrate
operator|=
name|level
operator|->
name|total_set
operator|.
name|freq
expr_stmt|;
block|}
end_function

begin_expr_stmt
name|EVENTHANDLER_DEFINE
argument_list|(
name|cpufreq_post_change
argument_list|,
name|tsc_freq_changed
argument_list|,
name|NULL
argument_list|,
name|EVENTHANDLER_PRI_ANY
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*  * Final stage of CPU identification. -- Should I check TI?  */
end_comment

begin_function
name|void
name|identify_cpu
parameter_list|(
name|void
parameter_list|)
block|{
name|u_int
name|regs
index|[
literal|4
index|]
decl_stmt|;
name|do_cpuid
argument_list|(
literal|0
argument_list|,
name|regs
argument_list|)
expr_stmt|;
name|cpu_high
operator|=
name|regs
index|[
literal|0
index|]
expr_stmt|;
operator|(
operator|(
name|u_int
operator|*
operator|)
operator|&
name|cpu_vendor
operator|)
index|[
literal|0
index|]
operator|=
name|regs
index|[
literal|1
index|]
expr_stmt|;
operator|(
operator|(
name|u_int
operator|*
operator|)
operator|&
name|cpu_vendor
operator|)
index|[
literal|1
index|]
operator|=
name|regs
index|[
literal|3
index|]
expr_stmt|;
operator|(
operator|(
name|u_int
operator|*
operator|)
operator|&
name|cpu_vendor
operator|)
index|[
literal|2
index|]
operator|=
name|regs
index|[
literal|2
index|]
expr_stmt|;
name|cpu_vendor
index|[
literal|12
index|]
operator|=
literal|'\0'
expr_stmt|;
name|do_cpuid
argument_list|(
literal|1
argument_list|,
name|regs
argument_list|)
expr_stmt|;
name|cpu_id
operator|=
name|regs
index|[
literal|0
index|]
expr_stmt|;
name|cpu_procinfo
operator|=
name|regs
index|[
literal|1
index|]
expr_stmt|;
name|cpu_feature
operator|=
name|regs
index|[
literal|3
index|]
expr_stmt|;
name|cpu_feature2
operator|=
name|regs
index|[
literal|2
index|]
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|cpu_vendor
argument_list|,
literal|"GenuineIntel"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|cpu_vendor
argument_list|,
literal|"AuthenticAMD"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|do_cpuid
argument_list|(
literal|0x80000000
argument_list|,
name|regs
argument_list|)
expr_stmt|;
name|cpu_exthigh
operator|=
name|regs
index|[
literal|0
index|]
expr_stmt|;
block|}
if|if
condition|(
name|cpu_exthigh
operator|>=
literal|0x80000001
condition|)
block|{
name|do_cpuid
argument_list|(
literal|0x80000001
argument_list|,
name|regs
argument_list|)
expr_stmt|;
name|amd_feature
operator|=
name|regs
index|[
literal|3
index|]
operator|&
operator|~
operator|(
name|cpu_feature
operator|&
literal|0x0183f3ff
operator|)
expr_stmt|;
name|amd_feature2
operator|=
name|regs
index|[
literal|2
index|]
expr_stmt|;
block|}
if|if
condition|(
name|cpu_exthigh
operator|>=
literal|0x80000007
condition|)
block|{
name|do_cpuid
argument_list|(
literal|0x80000007
argument_list|,
name|regs
argument_list|)
expr_stmt|;
name|amd_pminfo
operator|=
name|regs
index|[
literal|3
index|]
expr_stmt|;
block|}
if|if
condition|(
name|cpu_exthigh
operator|>=
literal|0x80000008
condition|)
block|{
name|do_cpuid
argument_list|(
literal|0x80000008
argument_list|,
name|regs
argument_list|)
expr_stmt|;
name|cpu_procinfo2
operator|=
name|regs
index|[
literal|2
index|]
expr_stmt|;
block|}
comment|/* XXX */
name|cpu
operator|=
name|CPU_CLAWHAMMER
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_AMD_assoc
parameter_list|(
name|int
name|i
parameter_list|)
block|{
if|if
condition|(
name|i
operator|==
literal|255
condition|)
name|printf
argument_list|(
literal|", fully associative\n"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|", %d-way associative\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_AMD_l2_assoc
parameter_list|(
name|int
name|i
parameter_list|)
block|{
switch|switch
condition|(
name|i
operator|&
literal|0x0f
condition|)
block|{
case|case
literal|0
case|:
name|printf
argument_list|(
literal|", disabled/not present\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|printf
argument_list|(
literal|", direct mapped\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|printf
argument_list|(
literal|", 2-way associative\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|printf
argument_list|(
literal|", 4-way associative\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|6
case|:
name|printf
argument_list|(
literal|", 8-way associative\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|8
case|:
name|printf
argument_list|(
literal|", 16-way associative\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|15
case|:
name|printf
argument_list|(
literal|", fully associative\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|", reserved configuration\n"
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|print_AMD_info
parameter_list|(
name|void
parameter_list|)
block|{
name|u_int
name|regs
index|[
literal|4
index|]
decl_stmt|;
if|if
condition|(
name|cpu_exthigh
operator|<
literal|0x80000005
condition|)
return|return;
name|do_cpuid
argument_list|(
literal|0x80000005
argument_list|,
name|regs
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"L1 2MB data TLB: %d entries"
argument_list|,
operator|(
name|regs
index|[
literal|0
index|]
operator|>>
literal|16
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|print_AMD_assoc
argument_list|(
name|regs
index|[
literal|0
index|]
operator|>>
literal|24
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"L1 2MB instruction TLB: %d entries"
argument_list|,
name|regs
index|[
literal|0
index|]
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|print_AMD_assoc
argument_list|(
operator|(
name|regs
index|[
literal|0
index|]
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"L1 4KB data TLB: %d entries"
argument_list|,
operator|(
name|regs
index|[
literal|1
index|]
operator|>>
literal|16
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|print_AMD_assoc
argument_list|(
name|regs
index|[
literal|1
index|]
operator|>>
literal|24
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"L1 4KB instruction TLB: %d entries"
argument_list|,
name|regs
index|[
literal|1
index|]
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|print_AMD_assoc
argument_list|(
operator|(
name|regs
index|[
literal|1
index|]
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"L1 data cache: %d kbytes"
argument_list|,
name|regs
index|[
literal|2
index|]
operator|>>
literal|24
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|", %d bytes/line"
argument_list|,
name|regs
index|[
literal|2
index|]
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|", %d lines/tag"
argument_list|,
operator|(
name|regs
index|[
literal|2
index|]
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|print_AMD_assoc
argument_list|(
operator|(
name|regs
index|[
literal|2
index|]
operator|>>
literal|16
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"L1 instruction cache: %d kbytes"
argument_list|,
name|regs
index|[
literal|3
index|]
operator|>>
literal|24
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|", %d bytes/line"
argument_list|,
name|regs
index|[
literal|3
index|]
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|", %d lines/tag"
argument_list|,
operator|(
name|regs
index|[
literal|3
index|]
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|print_AMD_assoc
argument_list|(
operator|(
name|regs
index|[
literal|3
index|]
operator|>>
literal|16
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
if|if
condition|(
name|cpu_exthigh
operator|>=
literal|0x80000006
condition|)
block|{
name|do_cpuid
argument_list|(
literal|0x80000006
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|regs
index|[
literal|0
index|]
operator|>>
literal|16
operator|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"L2 2MB data TLB: %d entries"
argument_list|,
operator|(
name|regs
index|[
literal|0
index|]
operator|>>
literal|16
operator|)
operator|&
literal|0xfff
argument_list|)
expr_stmt|;
name|print_AMD_l2_assoc
argument_list|(
name|regs
index|[
literal|0
index|]
operator|>>
literal|28
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"L2 2MB instruction TLB: %d entries"
argument_list|,
name|regs
index|[
literal|0
index|]
operator|&
literal|0xfff
argument_list|)
expr_stmt|;
name|print_AMD_l2_assoc
argument_list|(
operator|(
name|regs
index|[
literal|0
index|]
operator|>>
literal|28
operator|)
operator|&
literal|0xf
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"L2 2MB unified TLB: %d entries"
argument_list|,
name|regs
index|[
literal|0
index|]
operator|&
literal|0xfff
argument_list|)
expr_stmt|;
name|print_AMD_l2_assoc
argument_list|(
operator|(
name|regs
index|[
literal|0
index|]
operator|>>
literal|28
operator|)
operator|&
literal|0xf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|regs
index|[
literal|1
index|]
operator|>>
literal|16
operator|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"L2 4KB data TLB: %d entries"
argument_list|,
operator|(
name|regs
index|[
literal|1
index|]
operator|>>
literal|16
operator|)
operator|&
literal|0xfff
argument_list|)
expr_stmt|;
name|print_AMD_l2_assoc
argument_list|(
name|regs
index|[
literal|1
index|]
operator|>>
literal|28
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"L2 4KB instruction TLB: %d entries"
argument_list|,
operator|(
name|regs
index|[
literal|1
index|]
operator|>>
literal|16
operator|)
operator|&
literal|0xfff
argument_list|)
expr_stmt|;
name|print_AMD_l2_assoc
argument_list|(
operator|(
name|regs
index|[
literal|1
index|]
operator|>>
literal|28
operator|)
operator|&
literal|0xf
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"L2 4KB unified TLB: %d entries"
argument_list|,
operator|(
name|regs
index|[
literal|1
index|]
operator|>>
literal|16
operator|)
operator|&
literal|0xfff
argument_list|)
expr_stmt|;
name|print_AMD_l2_assoc
argument_list|(
operator|(
name|regs
index|[
literal|1
index|]
operator|>>
literal|28
operator|)
operator|&
literal|0xf
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"L2 unified cache: %d kbytes"
argument_list|,
name|regs
index|[
literal|2
index|]
operator|>>
literal|16
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|", %d bytes/line"
argument_list|,
name|regs
index|[
literal|2
index|]
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|", %d lines/tag"
argument_list|,
operator|(
name|regs
index|[
literal|2
index|]
operator|>>
literal|8
operator|)
operator|&
literal|0x0f
argument_list|)
expr_stmt|;
name|print_AMD_l2_assoc
argument_list|(
operator|(
name|regs
index|[
literal|2
index|]
operator|>>
literal|12
operator|)
operator|&
literal|0x0f
argument_list|)
expr_stmt|;
block|}
block|}
end_function

end_unit


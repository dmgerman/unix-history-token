begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2016, Anish Gupta (anish@freebsd.org)  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice unmodified, this list of conditions, and the following  *    disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/pcpu.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<sys/smp.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm.h>
end_include

begin_include
include|#
directive|include
file|<vm/pmap.h>
end_include

begin_include
include|#
directive|include
file|<dev/pci/pcivar.h>
end_include

begin_include
include|#
directive|include
file|<dev/pci/pcireg.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<machine/vmm.h>
end_include

begin_include
include|#
directive|include
file|<machine/pmap.h>
end_include

begin_include
include|#
directive|include
file|<machine/vmparam.h>
end_include

begin_include
include|#
directive|include
file|<machine/pci_cfgreg.h>
end_include

begin_include
include|#
directive|include
file|"pcib_if.h"
end_include

begin_include
include|#
directive|include
file|"io/iommu.h"
end_include

begin_include
include|#
directive|include
file|"amdvi_priv.h"
end_include

begin_expr_stmt
name|SYSCTL_DECL
argument_list|(
name|_hw_vmm
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|SYSCTL_NODE
argument_list|(
name|_hw_vmm
argument_list|,
name|OID_AUTO
argument_list|,
name|amdvi
argument_list|,
name|CTLFLAG_RW
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
end_expr_stmt

begin_define
define|#
directive|define
name|MOD_INC
parameter_list|(
name|a
parameter_list|,
name|s
parameter_list|,
name|m
parameter_list|)
value|(((a) + (s)) % ((m) * (s)))
end_define

begin_define
define|#
directive|define
name|MOD_DEC
parameter_list|(
name|a
parameter_list|,
name|s
parameter_list|,
name|m
parameter_list|)
value|(((a) - (s)) % ((m) * (s)))
end_define

begin_comment
comment|/* Print RID or device ID in PCI string format. */
end_comment

begin_define
define|#
directive|define
name|RID2PCI_STR
parameter_list|(
name|d
parameter_list|)
value|PCI_RID2BUS(d), PCI_RID2SLOT(d), PCI_RID2FUNC(d)
end_define

begin_function_decl
specifier|static
name|void
name|amdvi_dump_cmds
parameter_list|(
name|struct
name|amdvi_softc
modifier|*
name|softc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|amdvi_print_dev_cap
parameter_list|(
name|struct
name|amdvi_softc
modifier|*
name|softc
parameter_list|)
function_decl|;
end_function_decl

begin_expr_stmt
name|MALLOC_DEFINE
argument_list|(
name|M_AMDVI
argument_list|,
literal|"amdvi"
argument_list|,
literal|"amdvi"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|extern
name|device_t
modifier|*
name|ivhd_devs
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|ivhd_count
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_hw_vmm_amdvi
argument_list|,
name|OID_AUTO
argument_list|,
name|count
argument_list|,
name|CTLFLAG_RDTUN
argument_list|,
operator|&
name|ivhd_count
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|int
name|amdvi_enable_user
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_hw_vmm_amdvi
argument_list|,
name|OID_AUTO
argument_list|,
name|enable
argument_list|,
name|CTLFLAG_RDTUN
argument_list|,
operator|&
name|amdvi_enable_user
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"hw.vmm.amdvi_enable"
argument_list|,
operator|&
name|amdvi_enable_user
argument_list|)
expr_stmt|;
end_expr_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|AMDVI_ATS_ENABLE
end_ifdef

begin_comment
comment|/* XXX: ATS is not tested. */
end_comment

begin_decl_stmt
specifier|static
name|int
name|amdvi_enable_iotlb
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_hw_vmm_amdvi
argument_list|,
name|OID_AUTO
argument_list|,
name|iotlb_enabled
argument_list|,
name|CTLFLAG_RDTUN
argument_list|,
operator|&
name|amdvi_enable_iotlb
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"hw.vmm.enable_iotlb"
argument_list|,
operator|&
name|amdvi_enable_iotlb
argument_list|)
expr_stmt|;
end_expr_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|static
name|int
name|amdvi_host_ptp
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Use page tables for host. */
end_comment

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_hw_vmm_amdvi
argument_list|,
name|OID_AUTO
argument_list|,
name|host_ptp
argument_list|,
name|CTLFLAG_RDTUN
argument_list|,
operator|&
name|amdvi_host_ptp
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"hw.vmm.amdvi.host_ptp"
argument_list|,
operator|&
name|amdvi_host_ptp
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* Page table level used<= supported by h/w[v1=7]. */
end_comment

begin_decl_stmt
specifier|static
name|int
name|amdvi_ptp_level
init|=
literal|4
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_hw_vmm_amdvi
argument_list|,
name|OID_AUTO
argument_list|,
name|ptp_level
argument_list|,
name|CTLFLAG_RDTUN
argument_list|,
operator|&
name|amdvi_ptp_level
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"hw.vmm.amdvi.ptp_level"
argument_list|,
operator|&
name|amdvi_ptp_level
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* Disable fault event reporting. */
end_comment

begin_decl_stmt
specifier|static
name|int
name|amdvi_disable_io_fault
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_hw_vmm_amdvi
argument_list|,
name|OID_AUTO
argument_list|,
name|disable_io_fault
argument_list|,
name|CTLFLAG_RDTUN
argument_list|,
operator|&
name|amdvi_disable_io_fault
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"hw.vmm.amdvi.disable_io_fault"
argument_list|,
operator|&
name|amdvi_disable_io_fault
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|uint32_t
name|amdvi_dom_id
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* 0 is reserved for host. */
end_comment

begin_expr_stmt
name|SYSCTL_UINT
argument_list|(
name|_hw_vmm_amdvi
argument_list|,
name|OID_AUTO
argument_list|,
name|domain_id
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|amdvi_dom_id
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*  * Device table entry.  * Bus(256) x Dev(32) x Fun(8) x DTE(256 bits or 32 bytes).  *	= 256 * 2 * PAGE_SIZE.  */
end_comment

begin_function_decl
specifier|static
name|struct
name|amdvi_dte
name|amdvi_dte
index|[
name|PCI_NUM_DEV_MAX
index|]
name|__aligned
parameter_list|(
name|PAGE_SIZE
parameter_list|)
function_decl|;
end_function_decl

begin_expr_stmt
name|CTASSERT
argument_list|(
name|PCI_NUM_DEV_MAX
operator|==
literal|0x10000
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|CTASSERT
argument_list|(
sizeof|sizeof
argument_list|(
name|amdvi_dte
argument_list|)
operator|==
literal|0x200000
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|SLIST_HEAD
argument_list|(
argument_list|,
argument|amdvi_domain
argument_list|)
name|dom_head
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
specifier|inline
name|void
name|amdvi_pci_write
parameter_list|(
name|struct
name|amdvi_softc
modifier|*
name|softc
parameter_list|,
name|int
name|off
parameter_list|,
name|uint32_t
name|data
parameter_list|)
block|{
name|pci_cfgregwrite
argument_list|(
name|PCI_RID2BUS
argument_list|(
name|softc
operator|->
name|pci_rid
argument_list|)
argument_list|,
name|PCI_RID2SLOT
argument_list|(
name|softc
operator|->
name|pci_rid
argument_list|)
argument_list|,
name|PCI_RID2FUNC
argument_list|(
name|softc
operator|->
name|pci_rid
argument_list|)
argument_list|,
name|off
argument_list|,
name|data
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|uint32_t
name|amdvi_pci_read
parameter_list|(
name|struct
name|amdvi_softc
modifier|*
name|softc
parameter_list|,
name|int
name|off
parameter_list|)
block|{
return|return
operator|(
name|pci_cfgregread
argument_list|(
name|PCI_RID2BUS
argument_list|(
name|softc
operator|->
name|pci_rid
argument_list|)
argument_list|,
name|PCI_RID2SLOT
argument_list|(
name|softc
operator|->
name|pci_rid
argument_list|)
argument_list|,
name|PCI_RID2FUNC
argument_list|(
name|softc
operator|->
name|pci_rid
argument_list|)
argument_list|,
name|off
argument_list|,
literal|4
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|amdvi_find_pci_cap
parameter_list|(
name|struct
name|amdvi_softc
modifier|*
name|softc
parameter_list|,
name|uint8_t
name|capability
parameter_list|,
name|int
modifier|*
name|off
parameter_list|)
block|{
name|uint32_t
name|read
decl_stmt|;
name|uint8_t
name|ptr
decl_stmt|;
name|read
operator|=
name|amdvi_pci_read
argument_list|(
name|softc
argument_list|,
name|PCIR_COMMAND
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|read
operator|>>
literal|16
operator|)
operator|&
name|PCIM_STATUS_CAPPRESENT
operator|)
operator|==
literal|0
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
comment|/* Read the starting of capability pointer. */
name|read
operator|=
name|amdvi_pci_read
argument_list|(
name|softc
argument_list|,
name|PCIR_CAP_PTR
argument_list|)
expr_stmt|;
name|ptr
operator|=
name|read
operator|&
literal|0xFF
expr_stmt|;
while|while
condition|(
name|ptr
operator|!=
literal|0
condition|)
block|{
name|read
operator|=
name|amdvi_pci_read
argument_list|(
name|softc
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|read
operator|&
literal|0xFF
operator|)
operator|==
name|capability
condition|)
block|{
operator|*
name|off
operator|=
name|ptr
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|ptr
operator|=
operator|(
name|read
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
block|}
return|return
operator|(
name|ENOENT
operator|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|AMDVI_ATS_ENABLE
end_ifdef

begin_comment
comment|/* XXX: Should be in pci.c */
end_comment

begin_comment
comment|/*  * Check if device has ATS capability and its enabled.  * If ATS is absent or disabled, return (-1), otherwise ATS  * queue length.  */
end_comment

begin_function
specifier|static
name|int
name|amdvi_find_ats_qlen
parameter_list|(
name|uint16_t
name|devid
parameter_list|)
block|{
name|device_t
name|dev
decl_stmt|;
name|uint32_t
name|off
decl_stmt|,
name|cap
decl_stmt|;
name|int
name|qlen
init|=
operator|-
literal|1
decl_stmt|;
name|dev
operator|=
name|pci_find_bsf
argument_list|(
name|PCI_RID2BUS
argument_list|(
name|devid
argument_list|)
argument_list|,
name|PCI_RID2SLOT
argument_list|(
name|devid
argument_list|)
argument_list|,
name|PCI_RID2FUNC
argument_list|(
name|devid
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dev
condition|)
block|{
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
define|#
directive|define
name|PCIM_ATS_EN
value|BIT(31)
if|if
condition|(
name|pci_find_extcap
argument_list|(
name|dev
argument_list|,
name|PCIZ_ATS
argument_list|,
operator|&
name|off
argument_list|)
operator|==
literal|0
condition|)
block|{
name|cap
operator|=
name|pci_read_config
argument_list|(
name|dev
argument_list|,
name|off
operator|+
literal|4
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|qlen
operator|=
operator|(
name|cap
operator|&
literal|0x1F
operator|)
expr_stmt|;
name|qlen
operator|=
name|qlen
condition|?
name|qlen
else|:
literal|32
expr_stmt|;
name|printf
argument_list|(
literal|"AMD-Vi: PCI device %d.%d.%d ATS %s qlen=%d\n"
argument_list|,
name|RID2PCI_STR
argument_list|(
name|devid
argument_list|)
argument_list|,
operator|(
name|cap
operator|&
name|PCIM_ATS_EN
operator|)
condition|?
literal|"enabled"
else|:
literal|"Disabled"
argument_list|,
name|qlen
argument_list|)
expr_stmt|;
name|qlen
operator|=
operator|(
name|cap
operator|&
name|PCIM_ATS_EN
operator|)
condition|?
name|qlen
else|:
operator|-
literal|1
expr_stmt|;
block|}
return|return
operator|(
name|qlen
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Check if an endpoint device support device IOTLB or ATS.  */
end_comment

begin_function
specifier|static
specifier|inline
name|bool
name|amdvi_dev_support_iotlb
parameter_list|(
name|struct
name|amdvi_softc
modifier|*
name|softc
parameter_list|,
name|uint16_t
name|devid
parameter_list|)
block|{
name|struct
name|ivhd_dev_cfg
modifier|*
name|cfg
decl_stmt|;
name|int
name|qlen
decl_stmt|,
name|i
decl_stmt|;
name|bool
name|pci_ats
decl_stmt|,
name|ivhd_ats
decl_stmt|;
name|qlen
operator|=
name|amdvi_find_ats_qlen
argument_list|(
name|devid
argument_list|)
expr_stmt|;
if|if
condition|(
name|qlen
operator|<
literal|0
condition|)
return|return
operator|(
name|false
operator|)
return|;
name|KASSERT
argument_list|(
name|softc
argument_list|,
operator|(
literal|"softc is NULL"
operator|)
argument_list|)
expr_stmt|;
name|cfg
operator|=
name|softc
operator|->
name|dev_cfg
expr_stmt|;
name|ivhd_ats
operator|=
name|false
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|softc
operator|->
name|dev_cfg_cnt
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|cfg
operator|->
name|start_id
operator|<=
name|devid
operator|)
operator|&&
operator|(
name|cfg
operator|->
name|end_id
operator|>=
name|devid
operator|)
condition|)
block|{
name|ivhd_ats
operator|=
name|cfg
operator|->
name|enable_ats
expr_stmt|;
break|break;
block|}
name|cfg
operator|++
expr_stmt|;
block|}
name|pci_ats
operator|=
operator|(
name|qlen
operator|<
literal|0
operator|)
condition|?
name|false
else|:
name|true
expr_stmt|;
if|if
condition|(
name|pci_ats
operator|!=
name|ivhd_ats
condition|)
name|device_printf
argument_list|(
name|softc
operator|->
name|dev
argument_list|,
literal|"BIOS bug: mismatch in ATS setting for %d.%d.%d,"
literal|"ATS inv qlen = %d\n"
argument_list|,
name|RID2PCI_STR
argument_list|(
name|devid
argument_list|)
argument_list|,
name|qlen
argument_list|)
expr_stmt|;
comment|/* Ignore IVRS setting and respect PCI setting. */
return|return
operator|(
name|pci_ats
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* Enable IOTLB support for IOMMU if its supported. */
end_comment

begin_function
specifier|static
specifier|inline
name|void
name|amdvi_hw_enable_iotlb
parameter_list|(
name|struct
name|amdvi_softc
modifier|*
name|softc
parameter_list|)
block|{
ifndef|#
directive|ifndef
name|AMDVI_ATS_ENABLE
name|softc
operator|->
name|iotlb
operator|=
name|false
expr_stmt|;
else|#
directive|else
name|bool
name|supported
decl_stmt|;
name|supported
operator|=
operator|(
name|softc
operator|->
name|ivhd_flag
operator|&
name|IVHD_FLAG_IOTLB
operator|)
condition|?
name|true
else|:
name|false
expr_stmt|;
if|if
condition|(
name|softc
operator|->
name|pci_cap
operator|&
name|AMDVI_PCI_CAP_IOTLB
condition|)
block|{
if|if
condition|(
operator|!
name|supported
condition|)
name|device_printf
argument_list|(
name|softc
operator|->
name|dev
argument_list|,
literal|"IOTLB disabled by BIOS.\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|supported
operator|&&
operator|!
name|amdvi_enable_iotlb
condition|)
block|{
name|device_printf
argument_list|(
name|softc
operator|->
name|dev
argument_list|,
literal|"IOTLB disabled by user.\n"
argument_list|)
expr_stmt|;
name|supported
operator|=
name|false
expr_stmt|;
block|}
block|}
else|else
name|supported
operator|=
name|false
expr_stmt|;
name|softc
operator|->
name|iotlb
operator|=
name|supported
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|int
name|amdvi_init_cmd
parameter_list|(
name|struct
name|amdvi_softc
modifier|*
name|softc
parameter_list|)
block|{
name|struct
name|amdvi_ctrl
modifier|*
name|ctrl
init|=
name|softc
operator|->
name|ctrl
decl_stmt|;
name|ctrl
operator|->
name|cmd
operator|.
name|len
operator|=
literal|8
expr_stmt|;
comment|/* Use 256 command buffer entries. */
name|softc
operator|->
name|cmd_max
operator|=
literal|1
operator|<<
name|ctrl
operator|->
name|cmd
operator|.
name|len
expr_stmt|;
name|softc
operator|->
name|cmd
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|amdvi_cmd
argument_list|)
operator|*
name|softc
operator|->
name|cmd_max
argument_list|,
name|M_AMDVI
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|uintptr_t
operator|)
name|softc
operator|->
name|cmd
operator|&
name|PAGE_MASK
condition|)
name|panic
argument_list|(
literal|"AMDVi: Command buffer not aligned on page boundary."
argument_list|)
expr_stmt|;
name|ctrl
operator|->
name|cmd
operator|.
name|base
operator|=
name|vtophys
argument_list|(
name|softc
operator|->
name|cmd
argument_list|)
operator|/
name|PAGE_SIZE
expr_stmt|;
comment|/* 	 * XXX: Reset the h/w pointers in case IOMMU is restarting, 	 * h/w doesn't clear these pointers based on empirical data. 	 */
name|ctrl
operator|->
name|cmd_tail
operator|=
literal|0
expr_stmt|;
name|ctrl
operator|->
name|cmd_head
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Note: Update tail pointer after we have written the command since tail  * pointer update cause h/w to execute new commands, see section 3.3  * of AMD IOMMU spec ver 2.0.  */
end_comment

begin_comment
comment|/* Get the command tail pointer w/o updating it. */
end_comment

begin_function
specifier|static
name|struct
name|amdvi_cmd
modifier|*
name|amdvi_get_cmd_tail
parameter_list|(
name|struct
name|amdvi_softc
modifier|*
name|softc
parameter_list|)
block|{
name|struct
name|amdvi_ctrl
modifier|*
name|ctrl
decl_stmt|;
name|struct
name|amdvi_cmd
modifier|*
name|tail
decl_stmt|;
name|KASSERT
argument_list|(
name|softc
argument_list|,
operator|(
literal|"softc is NULL"
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|softc
operator|->
name|cmd
operator|!=
name|NULL
argument_list|,
operator|(
literal|"cmd is NULL"
operator|)
argument_list|)
expr_stmt|;
name|ctrl
operator|=
name|softc
operator|->
name|ctrl
expr_stmt|;
name|KASSERT
argument_list|(
name|ctrl
operator|!=
name|NULL
argument_list|,
operator|(
literal|"ctrl is NULL"
operator|)
argument_list|)
expr_stmt|;
name|tail
operator|=
operator|(
expr|struct
name|amdvi_cmd
operator|*
operator|)
operator|(
operator|(
name|uint8_t
operator|*
operator|)
name|softc
operator|->
name|cmd
operator|+
name|ctrl
operator|->
name|cmd_tail
operator|)
expr_stmt|;
return|return
operator|(
name|tail
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Update the command tail pointer which will start command execution.  */
end_comment

begin_function
specifier|static
name|void
name|amdvi_update_cmd_tail
parameter_list|(
name|struct
name|amdvi_softc
modifier|*
name|softc
parameter_list|)
block|{
name|struct
name|amdvi_ctrl
modifier|*
name|ctrl
decl_stmt|;
name|int
name|size
decl_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|amdvi_cmd
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|softc
operator|->
name|cmd
operator|!=
name|NULL
argument_list|,
operator|(
literal|"cmd is NULL"
operator|)
argument_list|)
expr_stmt|;
name|ctrl
operator|=
name|softc
operator|->
name|ctrl
expr_stmt|;
name|KASSERT
argument_list|(
name|ctrl
operator|!=
name|NULL
argument_list|,
operator|(
literal|"ctrl is NULL"
operator|)
argument_list|)
expr_stmt|;
name|ctrl
operator|->
name|cmd_tail
operator|=
name|MOD_INC
argument_list|(
name|ctrl
operator|->
name|cmd_tail
argument_list|,
name|size
argument_list|,
name|softc
operator|->
name|cmd_max
argument_list|)
expr_stmt|;
name|softc
operator|->
name|total_cmd
operator|++
expr_stmt|;
ifdef|#
directive|ifdef
name|AMDVI_DEBUG_CMD
name|device_printf
argument_list|(
name|softc
operator|->
name|dev
argument_list|,
literal|"cmd_tail: %s Tail:0x%x, Head:0x%x.\n"
argument_list|,
name|ctrl
operator|->
name|cmd_tail
argument_list|,
name|ctrl
operator|->
name|cmd_head
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/*  * Various commands supported by IOMMU.  */
end_comment

begin_comment
comment|/* Completion wait command. */
end_comment

begin_function
specifier|static
name|void
name|amdvi_cmd_cmp
parameter_list|(
name|struct
name|amdvi_softc
modifier|*
name|softc
parameter_list|,
specifier|const
name|uint64_t
name|data
parameter_list|)
block|{
name|struct
name|amdvi_cmd
modifier|*
name|cmd
decl_stmt|;
name|uint64_t
name|pa
decl_stmt|;
name|cmd
operator|=
name|amdvi_get_cmd_tail
argument_list|(
name|softc
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|cmd
operator|!=
name|NULL
argument_list|,
operator|(
literal|"Cmd is NULL"
operator|)
argument_list|)
expr_stmt|;
name|pa
operator|=
name|vtophys
argument_list|(
operator|&
name|softc
operator|->
name|cmp_data
argument_list|)
expr_stmt|;
name|cmd
operator|->
name|opcode
operator|=
name|AMDVI_CMP_WAIT_OPCODE
expr_stmt|;
name|cmd
operator|->
name|word0
operator|=
operator|(
name|pa
operator|&
literal|0xFFFFFFF8
operator|)
operator||
operator|(
name|AMDVI_CMP_WAIT_STORE
operator|)
expr_stmt|;
comment|//(AMDVI_CMP_WAIT_FLUSH | AMDVI_CMP_WAIT_STORE);
name|cmd
operator|->
name|word1
operator|=
operator|(
name|pa
operator|>>
literal|32
operator|)
operator|&
literal|0xFFFFF
expr_stmt|;
name|cmd
operator|->
name|addr
operator|=
name|data
expr_stmt|;
name|amdvi_update_cmd_tail
argument_list|(
name|softc
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Invalidate device table entry. */
end_comment

begin_function
specifier|static
name|void
name|amdvi_cmd_inv_dte
parameter_list|(
name|struct
name|amdvi_softc
modifier|*
name|softc
parameter_list|,
name|uint16_t
name|devid
parameter_list|)
block|{
name|struct
name|amdvi_cmd
modifier|*
name|cmd
decl_stmt|;
name|cmd
operator|=
name|amdvi_get_cmd_tail
argument_list|(
name|softc
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|cmd
operator|!=
name|NULL
argument_list|,
operator|(
literal|"Cmd is NULL"
operator|)
argument_list|)
expr_stmt|;
name|cmd
operator|->
name|opcode
operator|=
name|AMDVI_INVD_DTE_OPCODE
expr_stmt|;
name|cmd
operator|->
name|word0
operator|=
name|devid
expr_stmt|;
name|amdvi_update_cmd_tail
argument_list|(
name|softc
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|AMDVI_DEBUG_CMD
name|device_printf
argument_list|(
name|softc
operator|->
name|dev
argument_list|,
literal|"Invalidated DTE:0x%x\n"
argument_list|,
name|devid
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/* Invalidate IOMMU page, use for invalidation of domain. */
end_comment

begin_function
specifier|static
name|void
name|amdvi_cmd_inv_iommu_pages
parameter_list|(
name|struct
name|amdvi_softc
modifier|*
name|softc
parameter_list|,
name|uint16_t
name|domain_id
parameter_list|,
name|uint64_t
name|addr
parameter_list|,
name|bool
name|guest_nested
parameter_list|,
name|bool
name|pde
parameter_list|,
name|bool
name|page
parameter_list|)
block|{
name|struct
name|amdvi_cmd
modifier|*
name|cmd
decl_stmt|;
name|cmd
operator|=
name|amdvi_get_cmd_tail
argument_list|(
name|softc
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|cmd
operator|!=
name|NULL
argument_list|,
operator|(
literal|"Cmd is NULL"
operator|)
argument_list|)
expr_stmt|;
name|cmd
operator|->
name|opcode
operator|=
name|AMDVI_INVD_PAGE_OPCODE
expr_stmt|;
name|cmd
operator|->
name|word1
operator|=
name|domain_id
expr_stmt|;
comment|/* 	 * Invalidate all addresses for this domain. 	 */
name|cmd
operator|->
name|addr
operator|=
name|addr
expr_stmt|;
name|cmd
operator|->
name|addr
operator||=
name|pde
condition|?
name|AMDVI_INVD_PAGE_PDE
else|:
literal|0
expr_stmt|;
name|cmd
operator|->
name|addr
operator||=
name|page
condition|?
name|AMDVI_INVD_PAGE_S
else|:
literal|0
expr_stmt|;
name|amdvi_update_cmd_tail
argument_list|(
name|softc
argument_list|)
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|AMDVI_ATS_ENABLE
end_ifdef

begin_comment
comment|/* Invalidate device IOTLB. */
end_comment

begin_function
specifier|static
name|void
name|amdvi_cmd_inv_iotlb
parameter_list|(
name|struct
name|amdvi_softc
modifier|*
name|softc
parameter_list|,
name|uint16_t
name|devid
parameter_list|)
block|{
name|struct
name|amdvi_cmd
modifier|*
name|cmd
decl_stmt|;
name|int
name|qlen
decl_stmt|;
if|if
condition|(
operator|!
name|softc
operator|->
name|iotlb
condition|)
return|return;
name|qlen
operator|=
name|amdvi_find_ats_qlen
argument_list|(
name|devid
argument_list|)
expr_stmt|;
if|if
condition|(
name|qlen
operator|<
literal|0
condition|)
block|{
name|panic
argument_list|(
literal|"AMDVI: Invalid ATS qlen(%d) for device %d.%d.%d\n"
argument_list|,
name|qlen
argument_list|,
name|RID2PCI_STR
argument_list|(
name|devid
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|cmd
operator|=
name|amdvi_get_cmd_tail
argument_list|(
name|softc
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|cmd
operator|!=
name|NULL
argument_list|,
operator|(
literal|"Cmd is NULL"
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|AMDVI_DEBUG_CMD
name|device_printf
argument_list|(
name|softc
operator|->
name|dev
argument_list|,
literal|"Invalidate IOTLB devID 0x%x"
literal|" Qlen:%d\n"
argument_list|,
name|devid
argument_list|,
name|qlen
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|cmd
operator|->
name|opcode
operator|=
name|AMDVI_INVD_IOTLB_OPCODE
expr_stmt|;
name|cmd
operator|->
name|word0
operator|=
name|devid
expr_stmt|;
name|cmd
operator|->
name|word1
operator|=
name|qlen
expr_stmt|;
name|cmd
operator|->
name|addr
operator|=
name|AMDVI_INVD_IOTLB_ALL_ADDR
operator||
name|AMDVI_INVD_IOTLB_S
expr_stmt|;
name|amdvi_update_cmd_tail
argument_list|(
name|softc
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|notyet
end_ifdef

begin_comment
comment|/* For Interrupt Remap. */
end_comment

begin_function
specifier|static
name|void
name|amdvi_cmd_inv_intr_map
parameter_list|(
name|struct
name|amdvi_softc
modifier|*
name|softc
parameter_list|,
name|uint16_t
name|devid
parameter_list|)
block|{
name|struct
name|amdvi_cmd
modifier|*
name|cmd
decl_stmt|;
name|cmd
operator|=
name|amdvi_get_cmd_tail
argument_list|(
name|softc
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|cmd
operator|!=
name|NULL
argument_list|,
operator|(
literal|"Cmd is NULL"
operator|)
argument_list|)
expr_stmt|;
name|cmd
operator|->
name|opcode
operator|=
name|AMDVI_INVD_INTR_OPCODE
expr_stmt|;
name|cmd
operator|->
name|word0
operator|=
name|devid
expr_stmt|;
name|amdvi_update_cmd_tail
argument_list|(
name|softc
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|AMDVI_DEBUG_CMD
name|device_printf
argument_list|(
name|softc
operator|->
name|dev
argument_list|,
literal|"Invalidate INTR map of devID 0x%x\n"
argument_list|,
name|devid
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* Invalidate domain using INVALIDATE_IOMMU_PAGES command. */
end_comment

begin_function
specifier|static
name|void
name|amdvi_inv_domain
parameter_list|(
name|struct
name|amdvi_softc
modifier|*
name|softc
parameter_list|,
name|uint16_t
name|domain_id
parameter_list|)
block|{
name|struct
name|amdvi_cmd
modifier|*
name|cmd
decl_stmt|;
name|cmd
operator|=
name|amdvi_get_cmd_tail
argument_list|(
name|softc
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|cmd
operator|!=
name|NULL
argument_list|,
operator|(
literal|"Cmd is NULL"
operator|)
argument_list|)
expr_stmt|;
comment|/* 	 * See section 3.3.3 of IOMMU spec rev 2.0, software note 	 * for invalidating domain. 	 */
name|amdvi_cmd_inv_iommu_pages
argument_list|(
name|softc
argument_list|,
name|domain_id
argument_list|,
name|AMDVI_INVD_PAGE_ALL_ADDR
argument_list|,
name|false
argument_list|,
name|true
argument_list|,
name|true
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|AMDVI_DEBUG_CMD
name|device_printf
argument_list|(
name|softc
operator|->
name|dev
argument_list|,
literal|"Invalidate domain:0x%x\n"
argument_list|,
name|domain_id
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|bool
name|amdvi_cmp_wait
parameter_list|(
name|struct
name|amdvi_softc
modifier|*
name|softc
parameter_list|)
block|{
name|struct
name|amdvi_ctrl
modifier|*
name|ctrl
decl_stmt|;
specifier|const
name|uint64_t
name|VERIFY
init|=
literal|0xA5A5
decl_stmt|;
specifier|volatile
name|uint64_t
modifier|*
name|read
decl_stmt|;
name|int
name|i
decl_stmt|;
name|bool
name|status
decl_stmt|;
name|ctrl
operator|=
name|softc
operator|->
name|ctrl
expr_stmt|;
name|read
operator|=
operator|&
name|softc
operator|->
name|cmp_data
expr_stmt|;
operator|*
name|read
operator|=
literal|0
expr_stmt|;
name|amdvi_cmd_cmp
argument_list|(
name|softc
argument_list|,
name|VERIFY
argument_list|)
expr_stmt|;
comment|/* Wait for h/w to update completion data. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|100
operator|&&
operator|(
operator|*
name|read
operator|!=
name|VERIFY
operator|)
condition|;
name|i
operator|++
control|)
block|{
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
comment|/* 1 ms */
block|}
name|status
operator|=
operator|(
name|VERIFY
operator|==
name|softc
operator|->
name|cmp_data
operator|)
condition|?
name|true
else|:
name|false
expr_stmt|;
ifdef|#
directive|ifdef
name|AMDVI_DEBUG_CMD
if|if
condition|(
name|status
condition|)
name|device_printf
argument_list|(
name|softc
operator|->
name|dev
argument_list|,
literal|"CMD completion DONE Tail:0x%x, "
literal|"Head:0x%x, loop:%d.\n"
argument_list|,
name|ctrl
operator|->
name|cmd_tail
argument_list|,
name|ctrl
operator|->
name|cmd_head
argument_list|,
name|loop
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|amdvi_wait
parameter_list|(
name|struct
name|amdvi_softc
modifier|*
name|softc
parameter_list|)
block|{
name|struct
name|amdvi_ctrl
modifier|*
name|ctrl
decl_stmt|;
name|int
name|i
decl_stmt|;
name|KASSERT
argument_list|(
name|softc
argument_list|,
operator|(
literal|"softc is NULL"
operator|)
argument_list|)
expr_stmt|;
name|ctrl
operator|=
name|softc
operator|->
name|ctrl
expr_stmt|;
name|KASSERT
argument_list|(
name|ctrl
operator|!=
name|NULL
argument_list|,
operator|(
literal|"ctrl is NULL"
operator|)
argument_list|)
expr_stmt|;
comment|/* Don't wait if h/w is not enabled. */
if|if
condition|(
operator|(
name|ctrl
operator|->
name|control
operator|&
name|AMDVI_CTRL_EN
operator|)
operator|==
literal|0
condition|)
return|return;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|10
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|amdvi_cmp_wait
argument_list|(
name|softc
argument_list|)
condition|)
return|return;
block|}
name|device_printf
argument_list|(
name|softc
operator|->
name|dev
argument_list|,
literal|"Error: completion failed"
literal|" tail:0x%x, head:0x%x.\n"
argument_list|,
name|ctrl
operator|->
name|cmd_tail
argument_list|,
name|ctrl
operator|->
name|cmd_head
argument_list|)
expr_stmt|;
name|amdvi_dump_cmds
argument_list|(
name|softc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|amdvi_dump_cmds
parameter_list|(
name|struct
name|amdvi_softc
modifier|*
name|softc
parameter_list|)
block|{
name|struct
name|amdvi_ctrl
modifier|*
name|ctrl
decl_stmt|;
name|struct
name|amdvi_cmd
modifier|*
name|cmd
decl_stmt|;
name|int
name|off
decl_stmt|,
name|i
decl_stmt|;
name|ctrl
operator|=
name|softc
operator|->
name|ctrl
expr_stmt|;
name|device_printf
argument_list|(
name|softc
operator|->
name|dev
argument_list|,
literal|"Dump all the commands:\n"
argument_list|)
expr_stmt|;
comment|/* 	 * If h/w is stuck in completion, it is the previous command, 	 * start dumping from previous command onward. 	 */
name|off
operator|=
name|MOD_DEC
argument_list|(
name|ctrl
operator|->
name|cmd_head
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|amdvi_cmd
argument_list|)
argument_list|,
name|softc
operator|->
name|cmd_max
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|off
operator|!=
name|ctrl
operator|->
name|cmd_tail
operator|&&
name|i
operator|<
name|softc
operator|->
name|cmd_max
condition|;
name|i
operator|++
control|)
block|{
name|cmd
operator|=
operator|(
expr|struct
name|amdvi_cmd
operator|*
operator|)
operator|(
operator|(
name|uint8_t
operator|*
operator|)
name|softc
operator|->
name|cmd
operator|+
name|off
operator|)
expr_stmt|;
name|printf
argument_list|(
literal|"  [CMD%d, off:0x%x] opcode= 0x%x 0x%x"
literal|" 0x%x 0x%lx\n"
argument_list|,
name|i
argument_list|,
name|off
argument_list|,
name|cmd
operator|->
name|opcode
argument_list|,
name|cmd
operator|->
name|word0
argument_list|,
name|cmd
operator|->
name|word1
argument_list|,
name|cmd
operator|->
name|addr
argument_list|)
expr_stmt|;
name|off
operator|=
operator|(
name|off
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|amdvi_cmd
argument_list|)
operator|)
operator|%
operator|(
name|softc
operator|->
name|cmd_max
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|amdvi_cmd
argument_list|)
operator|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|amdvi_init_event
parameter_list|(
name|struct
name|amdvi_softc
modifier|*
name|softc
parameter_list|)
block|{
name|struct
name|amdvi_ctrl
modifier|*
name|ctrl
decl_stmt|;
name|ctrl
operator|=
name|softc
operator|->
name|ctrl
expr_stmt|;
name|ctrl
operator|->
name|event
operator|.
name|len
operator|=
literal|8
expr_stmt|;
name|softc
operator|->
name|event_max
operator|=
literal|1
operator|<<
name|ctrl
operator|->
name|event
operator|.
name|len
expr_stmt|;
name|softc
operator|->
name|event
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|amdvi_event
argument_list|)
operator|*
name|softc
operator|->
name|event_max
argument_list|,
name|M_AMDVI
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|uintptr_t
operator|)
name|softc
operator|->
name|event
operator|&
name|PAGE_MASK
condition|)
block|{
name|device_printf
argument_list|(
name|softc
operator|->
name|dev
argument_list|,
literal|"Event buffer not aligned on page."
argument_list|)
expr_stmt|;
return|return
operator|(
name|false
operator|)
return|;
block|}
name|ctrl
operator|->
name|event
operator|.
name|base
operator|=
name|vtophys
argument_list|(
name|softc
operator|->
name|event
argument_list|)
operator|/
name|PAGE_SIZE
expr_stmt|;
comment|/* Reset the pointers. */
name|ctrl
operator|->
name|evt_head
operator|=
literal|0
expr_stmt|;
name|ctrl
operator|->
name|evt_tail
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|amdvi_decode_evt_flag
parameter_list|(
name|uint16_t
name|flag
parameter_list|)
block|{
name|flag
operator|&=
name|AMDVI_EVENT_FLAG_MASK
expr_stmt|;
name|printf
argument_list|(
literal|"0x%b]\n"
argument_list|,
name|flag
argument_list|,
literal|"\020"
literal|"\001GN"
literal|"\002NX"
literal|"\003US"
literal|"\004I"
literal|"\005PR"
literal|"\006RW"
literal|"\007PE"
literal|"\010RZ"
literal|"\011TR"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* See section 2.5.4 of AMD IOMMU spec ver 2.62.*/
end_comment

begin_function
specifier|static
specifier|inline
name|void
name|amdvi_decode_evt_flag_type
parameter_list|(
name|uint8_t
name|type
parameter_list|)
block|{
switch|switch
condition|(
name|AMDVI_EVENT_FLAG_TYPE
argument_list|(
name|type
argument_list|)
condition|)
block|{
case|case
literal|0
case|:
name|printf
argument_list|(
literal|"RSVD\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|printf
argument_list|(
literal|"Master Abort\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|printf
argument_list|(
literal|"Target Abort\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|printf
argument_list|(
literal|"Data Err\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|amdvi_decode_inv_dte_evt
parameter_list|(
name|uint16_t
name|devid
parameter_list|,
name|uint16_t
name|domid
parameter_list|,
name|uint64_t
name|addr
parameter_list|,
name|uint16_t
name|flag
parameter_list|)
block|{
name|printf
argument_list|(
literal|"\t[IO_PAGE_FAULT EVT: devId:0x%x DomId:0x%x"
literal|" Addr:0x%lx"
argument_list|,
name|devid
argument_list|,
name|domid
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|amdvi_decode_evt_flag
argument_list|(
name|flag
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|amdvi_decode_pf_evt
parameter_list|(
name|uint16_t
name|devid
parameter_list|,
name|uint16_t
name|domid
parameter_list|,
name|uint64_t
name|addr
parameter_list|,
name|uint16_t
name|flag
parameter_list|)
block|{
name|printf
argument_list|(
literal|"\t[IO_PAGE_FAULT EVT: devId:0x%x DomId:0x%x"
literal|" Addr:0x%lx"
argument_list|,
name|devid
argument_list|,
name|domid
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|amdvi_decode_evt_flag
argument_list|(
name|flag
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|amdvi_decode_dte_hwerr_evt
parameter_list|(
name|uint16_t
name|devid
parameter_list|,
name|uint16_t
name|domid
parameter_list|,
name|uint64_t
name|addr
parameter_list|,
name|uint16_t
name|flag
parameter_list|)
block|{
name|printf
argument_list|(
literal|"\t[DEV_TAB_HW_ERR EVT: devId:0x%x DomId:0x%x"
literal|" Addr:0x%lx"
argument_list|,
name|devid
argument_list|,
name|domid
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|amdvi_decode_evt_flag
argument_list|(
name|flag
argument_list|)
expr_stmt|;
name|amdvi_decode_evt_flag_type
argument_list|(
name|flag
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|amdvi_decode_page_hwerr_evt
parameter_list|(
name|uint16_t
name|devid
parameter_list|,
name|uint16_t
name|domid
parameter_list|,
name|uint64_t
name|addr
parameter_list|,
name|uint16_t
name|flag
parameter_list|)
block|{
name|printf
argument_list|(
literal|"\t[PAGE_TAB_HW_ERR EVT: devId:0x%x DomId:0x%x"
literal|" Addr:0x%lx"
argument_list|,
name|devid
argument_list|,
name|domid
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|amdvi_decode_evt_flag
argument_list|(
name|flag
argument_list|)
expr_stmt|;
name|amdvi_decode_evt_flag_type
argument_list|(
name|AMDVI_EVENT_FLAG_TYPE
argument_list|(
name|flag
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|amdvi_decode_evt
parameter_list|(
name|struct
name|amdvi_event
modifier|*
name|evt
parameter_list|)
block|{
name|struct
name|amdvi_cmd
modifier|*
name|cmd
decl_stmt|;
switch|switch
condition|(
name|evt
operator|->
name|opcode
condition|)
block|{
case|case
name|AMDVI_EVENT_INVALID_DTE
case|:
name|amdvi_decode_inv_dte_evt
argument_list|(
name|evt
operator|->
name|devid
argument_list|,
name|evt
operator|->
name|pasid_domid
argument_list|,
name|evt
operator|->
name|addr
argument_list|,
name|evt
operator|->
name|flag
argument_list|)
expr_stmt|;
break|break;
case|case
name|AMDVI_EVENT_PFAULT
case|:
name|amdvi_decode_pf_evt
argument_list|(
name|evt
operator|->
name|devid
argument_list|,
name|evt
operator|->
name|pasid_domid
argument_list|,
name|evt
operator|->
name|addr
argument_list|,
name|evt
operator|->
name|flag
argument_list|)
expr_stmt|;
break|break;
case|case
name|AMDVI_EVENT_DTE_HW_ERROR
case|:
name|amdvi_decode_dte_hwerr_evt
argument_list|(
name|evt
operator|->
name|devid
argument_list|,
name|evt
operator|->
name|pasid_domid
argument_list|,
name|evt
operator|->
name|addr
argument_list|,
name|evt
operator|->
name|flag
argument_list|)
expr_stmt|;
break|break;
case|case
name|AMDVI_EVENT_PAGE_HW_ERROR
case|:
name|amdvi_decode_page_hwerr_evt
argument_list|(
name|evt
operator|->
name|devid
argument_list|,
name|evt
operator|->
name|pasid_domid
argument_list|,
name|evt
operator|->
name|addr
argument_list|,
name|evt
operator|->
name|flag
argument_list|)
expr_stmt|;
break|break;
case|case
name|AMDVI_EVENT_ILLEGAL_CMD
case|:
comment|/* FALL THROUGH */
case|case
name|AMDVI_EVENT_CMD_HW_ERROR
case|:
name|printf
argument_list|(
literal|"\t[%s EVT]"
argument_list|,
operator|(
name|evt
operator|->
name|opcode
operator|==
name|AMDVI_EVENT_ILLEGAL_CMD
operator|)
condition|?
literal|"ILLEGAL CMD"
else|:
literal|"CMD HW ERR"
argument_list|)
expr_stmt|;
name|cmd
operator|=
operator|(
expr|struct
name|amdvi_cmd
operator|*
operator|)
name|PHYS_TO_DMAP
argument_list|(
name|evt
operator|->
name|addr
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tCMD opcode= 0x%x 0x%x 0x%x 0x%lx\n"
argument_list|,
name|cmd
operator|->
name|opcode
argument_list|,
name|cmd
operator|->
name|word0
argument_list|,
name|cmd
operator|->
name|word1
argument_list|,
name|cmd
operator|->
name|addr
argument_list|)
expr_stmt|;
break|break;
case|case
name|AMDVI_EVENT_IOTLB_TIMEOUT
case|:
name|printf
argument_list|(
literal|"\t[IOTLB_INV_TIMEOUT devid:0x%x addr:0x%lx"
argument_list|,
name|evt
operator|->
name|devid
argument_list|,
name|evt
operator|->
name|addr
argument_list|)
expr_stmt|;
break|break;
case|case
name|AMDVI_EVENT_INVALID_DTE_REQ
case|:
name|printf
argument_list|(
literal|"\t[INV_DTE devid:0x%x addr:0x%lx type:0x%x tr:%d]\n"
argument_list|,
name|evt
operator|->
name|devid
argument_list|,
name|evt
operator|->
name|addr
argument_list|,
name|evt
operator|->
name|flag
operator|>>
literal|9
argument_list|,
operator|(
name|evt
operator|->
name|flag
operator|>>
literal|8
operator|)
operator|&
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|AMDVI_EVENT_INVALID_PPR_REQ
case|:
case|case
name|AMDVI_EVENT_COUNTER_ZERO
case|:
name|printf
argument_list|(
literal|"AMD-Vi: v2 events.\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"Unsupported AMD-Vi event:%d"
argument_list|,
name|evt
operator|->
name|opcode
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|amdvi_print_events
parameter_list|(
name|struct
name|amdvi_softc
modifier|*
name|softc
parameter_list|)
block|{
name|struct
name|amdvi_ctrl
modifier|*
name|ctrl
decl_stmt|;
name|struct
name|amdvi_event
modifier|*
name|event
decl_stmt|;
name|int
name|i
decl_stmt|,
name|size
decl_stmt|;
name|ctrl
operator|=
name|softc
operator|->
name|ctrl
expr_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|amdvi_event
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|softc
operator|->
name|event_max
condition|;
name|i
operator|++
control|)
block|{
name|event
operator|=
operator|&
name|softc
operator|->
name|event
index|[
name|ctrl
operator|->
name|evt_head
operator|/
name|size
index|]
expr_stmt|;
if|if
condition|(
operator|!
name|event
operator|->
name|opcode
condition|)
break|break;
name|device_printf
argument_list|(
name|softc
operator|->
name|dev
argument_list|,
literal|"\t[Event%d: Head:0x%x Tail:0x%x]\n"
argument_list|,
name|i
argument_list|,
name|ctrl
operator|->
name|evt_head
argument_list|,
name|ctrl
operator|->
name|evt_tail
argument_list|)
expr_stmt|;
name|amdvi_decode_evt
argument_list|(
name|event
argument_list|)
expr_stmt|;
name|ctrl
operator|->
name|evt_head
operator|=
name|MOD_INC
argument_list|(
name|ctrl
operator|->
name|evt_head
argument_list|,
name|size
argument_list|,
name|softc
operator|->
name|event_max
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|amdvi_init_dte
parameter_list|(
name|struct
name|amdvi_softc
modifier|*
name|softc
parameter_list|)
block|{
name|struct
name|amdvi_ctrl
modifier|*
name|ctrl
decl_stmt|;
name|ctrl
operator|=
name|softc
operator|->
name|ctrl
expr_stmt|;
name|ctrl
operator|->
name|dte
operator|.
name|base
operator|=
name|vtophys
argument_list|(
name|amdvi_dte
argument_list|)
operator|/
name|PAGE_SIZE
expr_stmt|;
name|ctrl
operator|->
name|dte
operator|.
name|size
operator|=
literal|0x1FF
expr_stmt|;
comment|/* 2MB device table. */
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Not all capabilities of IOMMU are available in ACPI IVHD flag  * or EFR entry, read directly from device.  */
end_comment

begin_function
specifier|static
name|int
name|amdvi_print_pci_cap
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|amdvi_softc
modifier|*
name|softc
decl_stmt|;
name|uint32_t
name|off
decl_stmt|,
name|cap
decl_stmt|;
name|softc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|off
operator|=
name|softc
operator|->
name|cap_off
expr_stmt|;
comment|/* 	 * Section 3.7.1 of IOMMU sepc rev 2.0. 	 * Read capability from device. 	 */
name|cap
operator|=
name|amdvi_pci_read
argument_list|(
name|softc
argument_list|,
name|off
argument_list|)
expr_stmt|;
comment|/* Make sure capability type[18:16] is 3. */
name|KASSERT
argument_list|(
operator|(
operator|(
operator|(
name|cap
operator|>>
literal|16
operator|)
operator|&
literal|0x7
operator|)
operator|==
literal|0x3
operator|)
argument_list|,
operator|(
literal|"Not a IOMMU capability 0x%x@0x%x"
operator|,
name|cap
operator|,
name|off
operator|)
argument_list|)
expr_stmt|;
name|softc
operator|->
name|pci_cap
operator|=
name|cap
operator|>>
literal|24
expr_stmt|;
name|device_printf
argument_list|(
name|softc
operator|->
name|dev
argument_list|,
literal|"PCI cap 0x%x@0x%x feature:%b\n"
argument_list|,
name|cap
argument_list|,
name|off
argument_list|,
name|softc
operator|->
name|pci_cap
argument_list|,
literal|"\020\001IOTLB\002HT\003NPCache\004EFR"
argument_list|)
expr_stmt|;
comment|/* IOMMU spec Rev 2.0, section 3.7.2.1 */
name|softc
operator|->
name|pci_efr
operator|=
name|softc
operator|->
name|ctrl
operator|->
name|ex_feature
expr_stmt|;
if|if
condition|(
name|softc
operator|->
name|pci_efr
condition|)
block|{
name|device_printf
argument_list|(
name|softc
operator|->
name|dev
argument_list|,
literal|"PCI extended Feature:%b\n"
argument_list|,
operator|(
name|int
operator|)
name|softc
operator|->
name|pci_efr
argument_list|,
literal|"\020\001PreFSup\002PPRSup\003XTSup\004NXSup\006IASup"
literal|"\007GASup\008HESup\009PCSup"
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|softc
operator|->
name|dev
argument_list|,
literal|"PCI HATS = %d GATS = %d GLXSup = %d, max PASID: 0x%x "
argument_list|,
call|(
name|int
call|)
argument_list|(
operator|(
name|softc
operator|->
name|pci_efr
operator|>>
literal|10
operator|)
operator|&
literal|0x3
argument_list|)
argument_list|,
call|(
name|int
call|)
argument_list|(
operator|(
name|softc
operator|->
name|pci_efr
operator|>>
literal|12
operator|)
operator|&
literal|0x3
argument_list|)
argument_list|,
call|(
name|int
call|)
argument_list|(
operator|(
name|softc
operator|->
name|pci_efr
operator|>>
literal|14
operator|)
operator|&
literal|0x3
argument_list|)
argument_list|,
call|(
name|int
call|)
argument_list|(
operator|(
name|softc
operator|->
name|pci_efr
operator|>>
literal|32
operator|)
operator|&
literal|0x1F
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|amdvi_event_intr
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|amdvi_softc
modifier|*
name|softc
decl_stmt|;
name|struct
name|amdvi_ctrl
modifier|*
name|ctrl
decl_stmt|;
name|softc
operator|=
operator|(
expr|struct
name|amdvi_softc
operator|*
operator|)
name|arg
expr_stmt|;
name|ctrl
operator|=
name|softc
operator|->
name|ctrl
expr_stmt|;
name|device_printf
argument_list|(
name|softc
operator|->
name|dev
argument_list|,
literal|"EVT INTR %ld Status:0x%x"
literal|" EVT Head:0x%x Tail:0x%x]\n"
argument_list|,
name|softc
operator|->
name|event_intr_cnt
operator|++
argument_list|,
name|ctrl
operator|->
name|status
argument_list|,
name|ctrl
operator|->
name|evt_head
argument_list|,
name|ctrl
operator|->
name|evt_tail
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  [CMD Total 0x%lx] Tail:0x%x, Head:0x%x.\n"
argument_list|,
name|softc
operator|->
name|total_cmd
argument_list|,
name|ctrl
operator|->
name|cmd_tail
argument_list|,
name|ctrl
operator|->
name|cmd_head
argument_list|)
expr_stmt|;
name|amdvi_print_events
argument_list|(
name|softc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|amdvi_free_evt_intr_res
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|amdvi_softc
modifier|*
name|softc
decl_stmt|;
name|softc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|softc
operator|->
name|event_tag
operator|!=
name|NULL
condition|)
block|{
name|bus_teardown_intr
argument_list|(
name|dev
argument_list|,
name|softc
operator|->
name|event_res
argument_list|,
name|softc
operator|->
name|event_tag
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|softc
operator|->
name|event_res
operator|!=
name|NULL
condition|)
block|{
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
name|softc
operator|->
name|event_rid
argument_list|,
name|softc
operator|->
name|event_res
argument_list|)
expr_stmt|;
block|}
name|bus_delete_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
name|softc
operator|->
name|event_rid
argument_list|)
expr_stmt|;
name|PCIB_RELEASE_MSI
argument_list|(
name|device_get_parent
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
argument_list|,
name|dev
argument_list|,
literal|1
argument_list|,
operator|&
name|softc
operator|->
name|event_irq
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|bool
name|amdvi_alloc_intr_resources
parameter_list|(
name|struct
name|amdvi_softc
modifier|*
name|softc
parameter_list|)
block|{
name|device_t
name|dev
decl_stmt|,
name|pcib
decl_stmt|;
name|uint64_t
name|msi_addr
decl_stmt|;
name|uint32_t
name|msi_data
decl_stmt|,
name|temp
decl_stmt|;
name|int
name|err
decl_stmt|,
name|msi_off
decl_stmt|;
name|dev
operator|=
name|softc
operator|->
name|dev
expr_stmt|;
name|pcib
operator|=
name|device_get_parent
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
name|softc
operator|->
name|event_irq
operator|=
operator|-
literal|1
expr_stmt|;
name|softc
operator|->
name|event_rid
operator|=
literal|0
expr_stmt|;
comment|/* 	 * Section 3.7.1 of IOMMU rev 2.0. With MSI, there is only one 	 * interrupt. XXX: Enable MSI/X support. 	 */
name|err
operator|=
name|PCIB_ALLOC_MSI
argument_list|(
name|pcib
argument_list|,
name|dev
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
operator|&
name|softc
operator|->
name|event_irq
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Couldn't find event MSI IRQ resource.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOENT
operator|)
return|;
block|}
name|err
operator|=
name|bus_set_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
name|softc
operator|->
name|event_rid
argument_list|,
name|softc
operator|->
name|event_irq
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Couldn't set event MSI resource.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|softc
operator|->
name|event_res
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
operator|&
name|softc
operator|->
name|event_rid
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|softc
operator|->
name|event_res
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Unable to allocate event INTR resource.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
if|if
condition|(
name|bus_setup_intr
argument_list|(
name|dev
argument_list|,
name|softc
operator|->
name|event_res
argument_list|,
name|INTR_TYPE_MISC
operator||
name|INTR_MPSAFE
argument_list|,
name|NULL
argument_list|,
name|amdvi_event_intr
argument_list|,
name|softc
argument_list|,
operator|&
name|softc
operator|->
name|event_tag
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Fail to setup event intr\n"
argument_list|)
expr_stmt|;
name|bus_release_resource
argument_list|(
name|softc
operator|->
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
name|softc
operator|->
name|event_rid
argument_list|,
name|softc
operator|->
name|event_res
argument_list|)
expr_stmt|;
name|softc
operator|->
name|event_res
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|bus_describe_intr
argument_list|(
name|dev
argument_list|,
name|softc
operator|->
name|event_res
argument_list|,
name|softc
operator|->
name|event_tag
argument_list|,
literal|"fault"
argument_list|)
expr_stmt|;
name|err
operator|=
name|amdvi_find_pci_cap
argument_list|(
name|softc
argument_list|,
name|PCIY_MSI
argument_list|,
operator|&
name|msi_off
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Couldn't find MSI capability, err = %d.\n"
argument_list|,
name|err
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
name|err
operator|=
name|PCIB_MAP_MSI
argument_list|(
name|pcib
argument_list|,
name|dev
argument_list|,
name|softc
operator|->
name|event_irq
argument_list|,
operator|&
name|msi_addr
argument_list|,
operator|&
name|msi_data
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Event interrupt config failed, err=%d.\n"
argument_list|,
name|err
argument_list|)
expr_stmt|;
name|amdvi_free_evt_intr_res
argument_list|(
name|softc
operator|->
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
comment|/* Configure MSI */
name|amdvi_pci_write
argument_list|(
name|softc
argument_list|,
name|msi_off
operator|+
name|PCIR_MSI_ADDR
argument_list|,
name|msi_addr
argument_list|)
expr_stmt|;
name|amdvi_pci_write
argument_list|(
name|softc
argument_list|,
name|msi_off
operator|+
name|PCIR_MSI_ADDR_HIGH
argument_list|,
name|msi_addr
operator|>>
literal|32
argument_list|)
expr_stmt|;
name|amdvi_pci_write
argument_list|(
name|softc
argument_list|,
name|msi_off
operator|+
name|PCIR_MSI_DATA_64BIT
argument_list|,
name|msi_data
argument_list|)
expr_stmt|;
comment|/* Now enable MSI interrupt. */
name|temp
operator|=
name|amdvi_pci_read
argument_list|(
name|softc
argument_list|,
name|msi_off
argument_list|)
expr_stmt|;
name|temp
operator||=
operator|(
name|PCIM_MSICTRL_MSI_ENABLE
operator|<<
literal|16
operator|)
expr_stmt|;
comment|/* MSI enable. */
name|amdvi_pci_write
argument_list|(
name|softc
argument_list|,
name|msi_off
argument_list|,
name|temp
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|amdvi_print_dev_cap
parameter_list|(
name|struct
name|amdvi_softc
modifier|*
name|softc
parameter_list|)
block|{
name|struct
name|ivhd_dev_cfg
modifier|*
name|cfg
decl_stmt|;
name|int
name|i
decl_stmt|;
name|cfg
operator|=
name|softc
operator|->
name|dev_cfg
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|softc
operator|->
name|dev_cfg_cnt
condition|;
name|i
operator|++
control|)
block|{
name|device_printf
argument_list|(
name|softc
operator|->
name|dev
argument_list|,
literal|"device [0x%x - 0x%x]"
literal|"config:%b%s\n"
argument_list|,
name|cfg
operator|->
name|start_id
argument_list|,
name|cfg
operator|->
name|end_id
argument_list|,
name|cfg
operator|->
name|data
argument_list|,
literal|"\020\001INIT\002ExtInt\003NMI"
literal|"\007LINT0\008LINT1"
argument_list|,
name|cfg
operator|->
name|enable_ats
condition|?
literal|"ATS enabled"
else|:
literal|""
argument_list|)
expr_stmt|;
name|cfg
operator|++
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|amdvi_handle_sysctl
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|struct
name|amdvi_softc
modifier|*
name|softc
decl_stmt|;
name|int
name|result
decl_stmt|,
name|type
decl_stmt|,
name|error
init|=
literal|0
decl_stmt|;
name|softc
operator|=
operator|(
expr|struct
name|amdvi_softc
operator|*
operator|)
name|arg1
expr_stmt|;
name|type
operator|=
name|arg2
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
literal|0
case|:
name|result
operator|=
name|softc
operator|->
name|ctrl
operator|->
name|cmd_head
expr_stmt|;
name|error
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|result
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|result
operator|=
name|softc
operator|->
name|ctrl
operator|->
name|cmd_tail
expr_stmt|;
name|error
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|result
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|result
operator|=
name|softc
operator|->
name|ctrl
operator|->
name|evt_head
expr_stmt|;
name|error
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|result
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|result
operator|=
name|softc
operator|->
name|ctrl
operator|->
name|evt_tail
expr_stmt|;
name|error
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|result
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
break|break;
default|default:
name|device_printf
argument_list|(
name|softc
operator|->
name|dev
argument_list|,
literal|"Unknown sysctl:%d\n"
argument_list|,
name|type
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|amdvi_add_sysctl
parameter_list|(
name|struct
name|amdvi_softc
modifier|*
name|softc
parameter_list|)
block|{
name|struct
name|sysctl_oid_list
modifier|*
name|child
decl_stmt|;
name|struct
name|sysctl_ctx_list
modifier|*
name|ctx
decl_stmt|;
name|device_t
name|dev
decl_stmt|;
name|dev
operator|=
name|softc
operator|->
name|dev
expr_stmt|;
name|ctx
operator|=
name|device_get_sysctl_ctx
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|child
operator|=
name|SYSCTL_CHILDREN
argument_list|(
name|device_get_sysctl_tree
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|child
argument_list|,
name|OID_AUTO
argument_list|,
literal|"event_intr_count"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|softc
operator|->
name|event_intr_cnt
argument_list|,
literal|"Event interrupt count"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|child
argument_list|,
name|OID_AUTO
argument_list|,
literal|"command_count"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|softc
operator|->
name|total_cmd
argument_list|,
literal|"Command submitted count"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|child
argument_list|,
name|OID_AUTO
argument_list|,
literal|"pci_rid"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|(
name|int
operator|*
operator|)
operator|&
name|softc
operator|->
name|pci_rid
argument_list|,
literal|0
argument_list|,
literal|"IOMMU RID"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|child
argument_list|,
name|OID_AUTO
argument_list|,
literal|"start_dev_rid"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|(
name|int
operator|*
operator|)
operator|&
name|softc
operator|->
name|start_dev_rid
argument_list|,
literal|0
argument_list|,
literal|"Start of device under this IOMMU"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|child
argument_list|,
name|OID_AUTO
argument_list|,
literal|"end_dev_rid"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|(
name|int
operator|*
operator|)
operator|&
name|softc
operator|->
name|end_dev_rid
argument_list|,
literal|0
argument_list|,
literal|"End of device under this IOMMU"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
name|ctx
argument_list|,
name|child
argument_list|,
name|OID_AUTO
argument_list|,
literal|"command_head"
argument_list|,
name|CTLTYPE_UINT
operator||
name|CTLFLAG_RD
argument_list|,
name|softc
argument_list|,
literal|0
argument_list|,
name|amdvi_handle_sysctl
argument_list|,
literal|"IU"
argument_list|,
literal|"Command head"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
name|ctx
argument_list|,
name|child
argument_list|,
name|OID_AUTO
argument_list|,
literal|"command_tail"
argument_list|,
name|CTLTYPE_UINT
operator||
name|CTLFLAG_RD
argument_list|,
name|softc
argument_list|,
literal|1
argument_list|,
name|amdvi_handle_sysctl
argument_list|,
literal|"IU"
argument_list|,
literal|"Command tail"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
name|ctx
argument_list|,
name|child
argument_list|,
name|OID_AUTO
argument_list|,
literal|"event_head"
argument_list|,
name|CTLTYPE_UINT
operator||
name|CTLFLAG_RD
argument_list|,
name|softc
argument_list|,
literal|2
argument_list|,
name|amdvi_handle_sysctl
argument_list|,
literal|"IU"
argument_list|,
literal|"Command head"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
name|ctx
argument_list|,
name|child
argument_list|,
name|OID_AUTO
argument_list|,
literal|"event_tail"
argument_list|,
name|CTLTYPE_UINT
operator||
name|CTLFLAG_RD
argument_list|,
name|softc
argument_list|,
literal|3
argument_list|,
name|amdvi_handle_sysctl
argument_list|,
literal|"IU"
argument_list|,
literal|"Command tail"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|amdvi_setup_hw
parameter_list|(
name|struct
name|amdvi_softc
modifier|*
name|softc
parameter_list|)
block|{
name|device_t
name|dev
decl_stmt|;
name|int
name|status
decl_stmt|;
name|dev
operator|=
name|softc
operator|->
name|dev
expr_stmt|;
name|amdvi_hw_enable_iotlb
argument_list|(
name|softc
argument_list|)
expr_stmt|;
name|amdvi_print_dev_cap
argument_list|(
name|softc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|status
operator|=
name|amdvi_print_pci_cap
argument_list|(
name|dev
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"PCI capability.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|status
operator|=
name|amdvi_init_cmd
argument_list|(
name|softc
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Couldn't configure command buffer.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|status
operator|=
name|amdvi_init_event
argument_list|(
name|softc
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Couldn't configure event buffer.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|status
operator|=
name|amdvi_init_dte
argument_list|(
name|softc
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Couldn't configure device table.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|status
operator|=
name|amdvi_alloc_intr_resources
argument_list|(
name|softc
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
return|return
operator|(
name|status
operator|)
return|;
block|}
name|amdvi_add_sysctl
argument_list|(
name|softc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|amdvi_teardown_hw
parameter_list|(
name|struct
name|amdvi_softc
modifier|*
name|softc
parameter_list|)
block|{
name|device_t
name|dev
decl_stmt|;
name|dev
operator|=
name|softc
operator|->
name|dev
expr_stmt|;
comment|/*  	 * Called after disable, h/w is stopped by now, free all the resources.  	 */
name|amdvi_free_evt_intr_res
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|softc
operator|->
name|cmd
condition|)
name|free
argument_list|(
name|softc
operator|->
name|cmd
argument_list|,
name|M_AMDVI
argument_list|)
expr_stmt|;
if|if
condition|(
name|softc
operator|->
name|event
condition|)
name|free
argument_list|(
name|softc
operator|->
name|event
argument_list|,
name|M_AMDVI
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*********** bhyve interfaces *********************/
end_comment

begin_function
specifier|static
name|int
name|amdvi_init
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
operator|!
name|ivhd_count
condition|)
block|{
return|return
operator|(
name|EIO
operator|)
return|;
block|}
if|if
condition|(
operator|!
name|amdvi_enable_user
operator|&&
name|ivhd_count
condition|)
block|{
name|printf
argument_list|(
literal|"bhyve: Found %d AMD-Vi/IOMMU device(s), "
literal|"use hw.vmm.amdvi_enable=1 to enable pass-through.\n"
argument_list|,
name|ivhd_count
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|amdvi_cleanup
parameter_list|(
name|void
parameter_list|)
block|{
comment|/* Nothing. */
block|}
end_function

begin_function
specifier|static
name|uint16_t
name|amdvi_domainId
parameter_list|(
name|void
parameter_list|)
block|{
comment|/* 	 * If we hit maximum domain limit, rollover leaving host 	 * domain(0). 	 * XXX: make sure that this domain is not used. 	 */
if|if
condition|(
name|amdvi_dom_id
operator|==
name|AMDVI_MAX_DOMAIN
condition|)
name|amdvi_dom_id
operator|=
literal|1
expr_stmt|;
return|return
operator|(
operator|(
name|uint16_t
operator|)
name|amdvi_dom_id
operator|++
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|amdvi_do_inv_domain
parameter_list|(
name|uint16_t
name|domain_id
parameter_list|,
name|bool
name|create
parameter_list|)
block|{
name|struct
name|amdvi_softc
modifier|*
name|softc
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ivhd_count
condition|;
name|i
operator|++
control|)
block|{
name|softc
operator|=
name|device_get_softc
argument_list|(
name|ivhd_devs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|softc
argument_list|,
operator|(
literal|"softc is NULL"
operator|)
argument_list|)
expr_stmt|;
comment|/* 		 * If not present pages are cached, invalidate page after 		 * creating domain. 		 */
if|#
directive|if
literal|0
block|if (create&& ((softc->pci_cap& AMDVI_PCI_CAP_NPCACHE) == 0)) 			continue;
endif|#
directive|endif
name|amdvi_inv_domain
argument_list|(
name|softc
argument_list|,
name|domain_id
argument_list|)
expr_stmt|;
name|amdvi_wait
argument_list|(
name|softc
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|amdvi_create_domain
parameter_list|(
name|vm_paddr_t
name|maxaddr
parameter_list|)
block|{
name|struct
name|amdvi_domain
modifier|*
name|dom
decl_stmt|;
name|dom
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|amdvi_domain
argument_list|)
argument_list|,
name|M_AMDVI
argument_list|,
name|M_ZERO
operator||
name|M_WAITOK
argument_list|)
expr_stmt|;
name|dom
operator|->
name|id
operator|=
name|amdvi_domainId
argument_list|()
expr_stmt|;
comment|//dom->maxaddr = maxaddr;
ifdef|#
directive|ifdef
name|AMDVI_DEBUG_CMD
name|printf
argument_list|(
literal|"Created domain #%d\n"
argument_list|,
name|dom
operator|->
name|id
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* 	 * Host domain(#0) don't create translation table. 	 */
if|if
condition|(
name|dom
operator|->
name|id
operator|||
name|amdvi_host_ptp
condition|)
name|dom
operator|->
name|ptp
operator|=
name|malloc
argument_list|(
name|PAGE_SIZE
argument_list|,
name|M_AMDVI
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|dom
operator|->
name|ptp_level
operator|=
name|amdvi_ptp_level
expr_stmt|;
name|amdvi_do_inv_domain
argument_list|(
name|dom
operator|->
name|id
argument_list|,
name|true
argument_list|)
expr_stmt|;
name|SLIST_INSERT_HEAD
argument_list|(
operator|&
name|dom_head
argument_list|,
name|dom
argument_list|,
name|next
argument_list|)
expr_stmt|;
return|return
operator|(
name|dom
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|amdvi_free_ptp
parameter_list|(
name|uint64_t
modifier|*
name|ptp
parameter_list|,
name|int
name|level
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|level
operator|<
literal|1
condition|)
return|return;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NPTEPG
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|ptp
index|[
name|i
index|]
operator|&
name|AMDVI_PT_PRESENT
operator|)
operator|==
literal|0
condition|)
continue|continue;
comment|/* XXX: Add super-page or PTE mapping> 4KB. */
ifdef|#
directive|ifdef
name|notyet
comment|/* Super-page mapping. */
if|if
condition|(
name|AMDVI_PD_SUPER
argument_list|(
name|ptp
index|[
name|i
index|]
argument_list|)
condition|)
continue|continue;
endif|#
directive|endif
name|amdvi_free_ptp
argument_list|(
operator|(
name|uint64_t
operator|*
operator|)
name|PHYS_TO_DMAP
argument_list|(
name|ptp
index|[
name|i
index|]
operator|&
name|AMDVI_PT_MASK
argument_list|)
argument_list|,
name|level
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|ptp
argument_list|,
name|M_AMDVI
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|amdvi_destroy_domain
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|amdvi_domain
modifier|*
name|domain
decl_stmt|;
name|domain
operator|=
operator|(
expr|struct
name|amdvi_domain
operator|*
operator|)
name|arg
expr_stmt|;
name|KASSERT
argument_list|(
name|domain
argument_list|,
operator|(
literal|"domain is NULL"
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|AMDVI_DEBUG_CMD
name|printf
argument_list|(
literal|"Destroying domain %d\n"
argument_list|,
name|domain
operator|->
name|id
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|domain
operator|->
name|ptp
condition|)
name|amdvi_free_ptp
argument_list|(
name|domain
operator|->
name|ptp
argument_list|,
name|domain
operator|->
name|ptp_level
argument_list|)
expr_stmt|;
name|amdvi_do_inv_domain
argument_list|(
name|domain
operator|->
name|id
argument_list|,
name|false
argument_list|)
expr_stmt|;
name|SLIST_REMOVE
argument_list|(
operator|&
name|dom_head
argument_list|,
name|domain
argument_list|,
name|amdvi_domain
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|domain
argument_list|,
name|M_AMDVI
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|uint64_t
name|amdvi_set_pt
parameter_list|(
name|uint64_t
modifier|*
name|pt
parameter_list|,
name|int
name|level
parameter_list|,
name|vm_paddr_t
name|gpa
parameter_list|,
name|vm_paddr_t
name|hpa
parameter_list|,
name|uint64_t
name|pg_size
parameter_list|,
name|bool
name|create
parameter_list|)
block|{
name|uint64_t
modifier|*
name|page
decl_stmt|,
name|pa
decl_stmt|;
name|int
name|shift
decl_stmt|,
name|index
decl_stmt|;
specifier|const
name|int
name|PT_SHIFT
init|=
literal|9
decl_stmt|;
specifier|const
name|int
name|PT_INDEX_MASK
init|=
operator|(
literal|1
operator|<<
name|PT_SHIFT
operator|)
operator|-
literal|1
decl_stmt|;
comment|/* Based on PT_SHIFT */
if|if
condition|(
operator|!
name|pg_size
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|hpa
operator|&
operator|(
name|pg_size
operator|-
literal|1
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"HPA is not size aligned.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|gpa
operator|&
operator|(
name|pg_size
operator|-
literal|1
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"HPA is not size aligned.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|shift
operator|=
name|PML4SHIFT
expr_stmt|;
while|while
condition|(
operator|(
name|shift
operator|>
name|PAGE_SHIFT
operator|)
operator|&&
operator|(
name|pg_size
operator|<
operator|(
literal|1UL
operator|<<
name|shift
operator|)
operator|)
condition|)
block|{
name|index
operator|=
operator|(
name|gpa
operator|>>
name|shift
operator|)
operator|&
name|PT_INDEX_MASK
expr_stmt|;
if|if
condition|(
operator|(
name|pt
index|[
name|index
index|]
operator|==
literal|0
operator|)
operator|&&
name|create
condition|)
block|{
name|page
operator|=
name|malloc
argument_list|(
name|PAGE_SIZE
argument_list|,
name|M_AMDVI
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|pa
operator|=
name|vtophys
argument_list|(
name|page
argument_list|)
expr_stmt|;
name|pt
index|[
name|index
index|]
operator|=
name|pa
operator||
name|AMDVI_PT_PRESENT
operator||
name|AMDVI_PT_RW
operator||
operator|(
operator|(
name|level
operator|-
literal|1
operator|)
operator|<<
name|AMDVI_PD_LEVEL_SHIFT
operator|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|AMDVI_DEBUG_PTE
if|if
condition|(
operator|(
name|gpa
operator|%
literal|0x1000000
operator|)
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"[level%d, shift = %d]PTE:0x%lx\n"
argument_list|,
name|level
argument_list|,
name|shift
argument_list|,
name|pt
index|[
name|index
index|]
argument_list|)
expr_stmt|;
endif|#
directive|endif
define|#
directive|define
name|PTE2PA
parameter_list|(
name|x
parameter_list|)
value|((uint64_t)(x)& AMDVI_PT_MASK)
name|pa
operator|=
name|PTE2PA
argument_list|(
name|pt
index|[
name|index
index|]
argument_list|)
expr_stmt|;
name|pt
operator|=
operator|(
name|uint64_t
operator|*
operator|)
name|PHYS_TO_DMAP
argument_list|(
name|pa
argument_list|)
expr_stmt|;
name|shift
operator|-=
name|PT_SHIFT
expr_stmt|;
name|level
operator|--
expr_stmt|;
block|}
comment|/* Leaf entry. */
name|index
operator|=
operator|(
name|gpa
operator|>>
name|shift
operator|)
operator|&
name|PT_INDEX_MASK
expr_stmt|;
if|if
condition|(
name|create
condition|)
block|{
name|pt
index|[
name|index
index|]
operator|=
name|hpa
operator||
name|AMDVI_PT_RW
operator||
name|AMDVI_PT_PRESENT
expr_stmt|;
block|}
else|else
name|pt
index|[
name|index
index|]
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|AMDVI_DEBUG_PTE
if|if
condition|(
operator|(
name|gpa
operator|%
literal|0x1000000
operator|)
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"[Last level%d, shift = %d]PTE:0x%lx\n"
argument_list|,
name|level
argument_list|,
name|shift
argument_list|,
name|pt
index|[
name|index
index|]
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
literal|1ULL
operator|<<
name|shift
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint64_t
name|amdvi_update_mapping
parameter_list|(
name|struct
name|amdvi_domain
modifier|*
name|domain
parameter_list|,
name|vm_paddr_t
name|gpa
parameter_list|,
name|vm_paddr_t
name|hpa
parameter_list|,
name|uint64_t
name|size
parameter_list|,
name|bool
name|create
parameter_list|)
block|{
name|uint64_t
name|mapped
decl_stmt|,
modifier|*
name|ptp
decl_stmt|,
name|len
decl_stmt|;
name|int
name|level
decl_stmt|;
name|KASSERT
argument_list|(
name|domain
argument_list|,
operator|(
literal|"domain is NULL"
operator|)
argument_list|)
expr_stmt|;
name|level
operator|=
name|domain
operator|->
name|ptp_level
expr_stmt|;
name|KASSERT
argument_list|(
name|level
argument_list|,
operator|(
literal|"Page table level is 0"
operator|)
argument_list|)
expr_stmt|;
name|ptp
operator|=
name|domain
operator|->
name|ptp
expr_stmt|;
name|KASSERT
argument_list|(
name|ptp
argument_list|,
operator|(
literal|"PTP is NULL"
operator|)
argument_list|)
expr_stmt|;
name|mapped
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|mapped
operator|<
name|size
condition|)
block|{
name|len
operator|=
name|amdvi_set_pt
argument_list|(
name|ptp
argument_list|,
name|level
argument_list|,
name|gpa
operator|+
name|mapped
argument_list|,
name|hpa
operator|+
name|mapped
argument_list|,
name|PAGE_SIZE
argument_list|,
name|create
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|len
condition|)
block|{
name|printf
argument_list|(
literal|"Error: Couldn't map HPA:0x%lx GPA:0x%lx\n"
argument_list|,
name|hpa
argument_list|,
name|gpa
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|mapped
operator|+=
name|len
expr_stmt|;
block|}
return|return
operator|(
name|mapped
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint64_t
name|amdvi_create_mapping
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|vm_paddr_t
name|gpa
parameter_list|,
name|vm_paddr_t
name|hpa
parameter_list|,
name|uint64_t
name|len
parameter_list|)
block|{
name|struct
name|amdvi_domain
modifier|*
name|domain
decl_stmt|;
name|domain
operator|=
operator|(
expr|struct
name|amdvi_domain
operator|*
operator|)
name|arg
expr_stmt|;
if|if
condition|(
name|domain
operator|->
name|id
operator|&&
operator|!
name|domain
operator|->
name|ptp
condition|)
block|{
name|printf
argument_list|(
literal|"ptp is NULL"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* 	 * If host domain is created w/o page table, skip IOMMU page 	 * table set-up. 	 */
if|if
condition|(
name|domain
operator|->
name|ptp
condition|)
return|return
operator|(
name|amdvi_update_mapping
argument_list|(
name|domain
argument_list|,
name|gpa
argument_list|,
name|hpa
argument_list|,
name|len
argument_list|,
name|true
argument_list|)
operator|)
return|;
else|else
return|return
operator|(
name|len
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint64_t
name|amdvi_destroy_mapping
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|vm_paddr_t
name|gpa
parameter_list|,
name|uint64_t
name|len
parameter_list|)
block|{
name|struct
name|amdvi_domain
modifier|*
name|domain
decl_stmt|;
name|domain
operator|=
operator|(
expr|struct
name|amdvi_domain
operator|*
operator|)
name|arg
expr_stmt|;
comment|/* 	 * If host domain is created w/o page table, skip IOMMU page 	 * table set-up. 	 */
if|if
condition|(
name|domain
operator|->
name|ptp
condition|)
return|return
operator|(
name|amdvi_update_mapping
argument_list|(
name|domain
argument_list|,
name|gpa
argument_list|,
literal|0
argument_list|,
name|len
argument_list|,
name|false
argument_list|)
operator|)
return|;
return|return
operator|(
name|len
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|amdvi_softc
modifier|*
name|amdvi_find_iommu
parameter_list|(
name|uint16_t
name|devid
parameter_list|)
block|{
name|struct
name|amdvi_softc
modifier|*
name|softc
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ivhd_count
condition|;
name|i
operator|++
control|)
block|{
name|softc
operator|=
name|device_get_softc
argument_list|(
name|ivhd_devs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|devid
operator|>=
name|softc
operator|->
name|start_dev_rid
operator|)
operator|&&
operator|(
name|devid
operator|<=
name|softc
operator|->
name|end_dev_rid
operator|)
condition|)
return|return
operator|(
name|softc
operator|)
return|;
block|}
comment|/* 	 * XXX: BIOS bug, device not in IVRS table, assume its from first IOMMU. 	 */
name|printf
argument_list|(
literal|"BIOS bug device(%d.%d.%d) doesn't have IVHD entry.\n"
argument_list|,
name|RID2PCI_STR
argument_list|(
name|devid
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|device_get_softc
argument_list|(
name|ivhd_devs
index|[
literal|0
index|]
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Set-up device table entry.  * IOMMU spec Rev 2.0, section 3.2.2.2, some of the fields must  * be set concurrently, e.g. read and write bits.  */
end_comment

begin_function
specifier|static
name|void
name|amdvi_set_dte
parameter_list|(
name|struct
name|amdvi_domain
modifier|*
name|domain
parameter_list|,
name|uint16_t
name|devid
parameter_list|,
name|bool
name|enable
parameter_list|)
block|{
name|struct
name|amdvi_softc
modifier|*
name|softc
decl_stmt|;
name|struct
name|amdvi_dte
name|temp
decl_stmt|;
name|softc
operator|=
name|amdvi_find_iommu
argument_list|(
name|devid
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|softc
argument_list|,
operator|(
literal|"softc is NULL for pci_rid:0x%x\n"
operator|,
name|devid
operator|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|temp
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|amdvi_dte
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|AMDVI_ATS_ENABLE
comment|/* If IOMMU and device support IOTLB, enable it. */
if|if
condition|(
name|amdvi_dev_support_iotlb
argument_list|(
name|softc
argument_list|,
name|devid
argument_list|)
operator|&&
name|softc
operator|->
name|iotlb
condition|)
name|temp
operator|.
name|iotlb_enable
operator|=
literal|1
expr_stmt|;
endif|#
directive|endif
comment|/* Avoid duplicate I/O faults. */
name|temp
operator|.
name|sup_second_io_fault
operator|=
literal|1
expr_stmt|;
name|temp
operator|.
name|sup_all_io_fault
operator|=
name|amdvi_disable_io_fault
expr_stmt|;
name|temp
operator|.
name|dt_valid
operator|=
literal|1
expr_stmt|;
name|temp
operator|.
name|domain_id
operator|=
name|domain
operator|->
name|id
expr_stmt|;
if|if
condition|(
name|enable
condition|)
block|{
if|if
condition|(
name|domain
operator|->
name|ptp
condition|)
block|{
name|temp
operator|.
name|pt_base
operator|=
name|vtophys
argument_list|(
name|domain
operator|->
name|ptp
argument_list|)
operator|>>
literal|12
expr_stmt|;
name|temp
operator|.
name|pt_level
operator|=
name|amdvi_ptp_level
expr_stmt|;
block|}
comment|/* 		 * XXX: Page table valid[TV] bit must be set even if host domain 		 * page tables are not enabled. 		 */
name|temp
operator|.
name|pt_valid
operator|=
literal|1
expr_stmt|;
name|temp
operator|.
name|read_allow
operator|=
literal|1
expr_stmt|;
name|temp
operator|.
name|write_allow
operator|=
literal|1
expr_stmt|;
block|}
name|amdvi_dte
index|[
name|devid
index|]
operator|=
name|temp
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|amdvi_inv_device
parameter_list|(
name|uint16_t
name|devid
parameter_list|)
block|{
name|struct
name|amdvi_softc
modifier|*
name|softc
decl_stmt|;
name|softc
operator|=
name|amdvi_find_iommu
argument_list|(
name|devid
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|softc
argument_list|,
operator|(
literal|"softc is NULL"
operator|)
argument_list|)
expr_stmt|;
name|amdvi_cmd_inv_dte
argument_list|(
name|softc
argument_list|,
name|devid
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|AMDVI_ATS_ENABLE
if|if
condition|(
name|amdvi_dev_support_iotlb
argument_list|(
name|softc
argument_list|,
name|devid
argument_list|)
condition|)
name|amdvi_cmd_inv_iotlb
argument_list|(
name|softc
argument_list|,
name|devid
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|amdvi_wait
argument_list|(
name|softc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|amdvi_add_device
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|uint16_t
name|devid
parameter_list|)
block|{
name|struct
name|amdvi_domain
modifier|*
name|domain
decl_stmt|;
name|domain
operator|=
operator|(
expr|struct
name|amdvi_domain
operator|*
operator|)
name|arg
expr_stmt|;
name|KASSERT
argument_list|(
name|domain
operator|!=
name|NULL
argument_list|,
operator|(
literal|"domain is NULL"
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|AMDVI_DEBUG_CMD
name|printf
argument_list|(
literal|"Assigning device(%d.%d.%d) to domain:%d\n"
argument_list|,
name|RID2PCI_STR
argument_list|(
name|devid
argument_list|)
argument_list|,
name|domain
operator|->
name|id
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|amdvi_set_dte
argument_list|(
name|domain
argument_list|,
name|devid
argument_list|,
name|true
argument_list|)
expr_stmt|;
name|amdvi_inv_device
argument_list|(
name|devid
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|amdvi_remove_device
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|uint16_t
name|devid
parameter_list|)
block|{
name|struct
name|amdvi_domain
modifier|*
name|domain
decl_stmt|;
name|domain
operator|=
operator|(
expr|struct
name|amdvi_domain
operator|*
operator|)
name|arg
expr_stmt|;
ifdef|#
directive|ifdef
name|AMDVI_DEBUG_CMD
name|printf
argument_list|(
literal|"Remove device(0x%x) from domain:%d\n"
argument_list|,
name|devid
argument_list|,
name|domain
operator|->
name|id
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|amdvi_set_dte
argument_list|(
name|domain
argument_list|,
name|devid
argument_list|,
name|false
argument_list|)
expr_stmt|;
name|amdvi_inv_device
argument_list|(
name|devid
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|amdvi_enable
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|amdvi_ctrl
modifier|*
name|ctrl
decl_stmt|;
name|struct
name|amdvi_softc
modifier|*
name|softc
decl_stmt|;
name|uint64_t
name|val
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ivhd_count
condition|;
name|i
operator|++
control|)
block|{
name|softc
operator|=
name|device_get_softc
argument_list|(
name|ivhd_devs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|softc
argument_list|,
operator|(
literal|"softc is NULL\n"
operator|)
argument_list|)
expr_stmt|;
name|ctrl
operator|=
name|softc
operator|->
name|ctrl
expr_stmt|;
name|KASSERT
argument_list|(
name|ctrl
argument_list|,
operator|(
literal|"ctrl is NULL\n"
operator|)
argument_list|)
expr_stmt|;
name|val
operator|=
operator|(
name|AMDVI_CTRL_EN
operator||
name|AMDVI_CTRL_CMD
operator||
name|AMDVI_CTRL_ELOG
operator||
name|AMDVI_CTRL_ELOGINT
operator||
name|AMDVI_CTRL_INV_TO_1S
operator|)
expr_stmt|;
if|if
condition|(
name|softc
operator|->
name|ivhd_flag
operator|&
name|IVHD_FLAG_COH
condition|)
name|val
operator||=
name|AMDVI_CTRL_COH
expr_stmt|;
if|if
condition|(
name|softc
operator|->
name|ivhd_flag
operator|&
name|IVHD_FLAG_HTT
condition|)
name|val
operator||=
name|AMDVI_CTRL_HTT
expr_stmt|;
if|if
condition|(
name|softc
operator|->
name|ivhd_flag
operator|&
name|IVHD_FLAG_RPPW
condition|)
name|val
operator||=
name|AMDVI_CTRL_RPPW
expr_stmt|;
if|if
condition|(
name|softc
operator|->
name|ivhd_flag
operator|&
name|IVHD_FLAG_PPW
condition|)
name|val
operator||=
name|AMDVI_CTRL_PPW
expr_stmt|;
if|if
condition|(
name|softc
operator|->
name|ivhd_flag
operator|&
name|IVHD_FLAG_ISOC
condition|)
name|val
operator||=
name|AMDVI_CTRL_ISOC
expr_stmt|;
name|ctrl
operator|->
name|control
operator|=
name|val
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|amdvi_disable
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|amdvi_ctrl
modifier|*
name|ctrl
decl_stmt|;
name|struct
name|amdvi_softc
modifier|*
name|softc
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ivhd_count
condition|;
name|i
operator|++
control|)
block|{
name|softc
operator|=
name|device_get_softc
argument_list|(
name|ivhd_devs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|softc
argument_list|,
operator|(
literal|"softc is NULL\n"
operator|)
argument_list|)
expr_stmt|;
name|ctrl
operator|=
name|softc
operator|->
name|ctrl
expr_stmt|;
name|KASSERT
argument_list|(
name|ctrl
argument_list|,
operator|(
literal|"ctrl is NULL\n"
operator|)
argument_list|)
expr_stmt|;
name|ctrl
operator|->
name|control
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|amdvi_inv_tlb
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|amdvi_domain
modifier|*
name|domain
decl_stmt|;
name|domain
operator|=
operator|(
expr|struct
name|amdvi_domain
operator|*
operator|)
name|arg
expr_stmt|;
name|KASSERT
argument_list|(
name|domain
argument_list|,
operator|(
literal|"domain is NULL"
operator|)
argument_list|)
expr_stmt|;
name|amdvi_do_inv_domain
argument_list|(
name|domain
operator|->
name|id
argument_list|,
name|false
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
name|struct
name|iommu_ops
name|iommu_ops_amd
init|=
block|{
name|amdvi_init
block|,
name|amdvi_cleanup
block|,
name|amdvi_enable
block|,
name|amdvi_disable
block|,
name|amdvi_create_domain
block|,
name|amdvi_destroy_domain
block|,
name|amdvi_create_mapping
block|,
name|amdvi_destroy_mapping
block|,
name|amdvi_add_device
block|,
name|amdvi_remove_device
block|,
name|amdvi_inv_tlb
block|}
decl_stmt|;
end_decl_stmt

end_unit


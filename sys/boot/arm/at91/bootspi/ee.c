begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/******************************************************************************  *  * Filename: eeprom.c  *  * Instantiation of eeprom routines  *  * Revision information:  *  * 28AUG2004	kb_admin	initial creation - adapted from Atmel sources  * 12JAN2005	kb_admin	fixed clock generation, write polling, init  *  * BEGIN_KBDD_BLOCK  * No warranty, expressed or implied, is included with this software.  It is  * provided "AS IS" and no warranty of any kind including statutory or aspects  * relating to merchantability or fitness for any purpose is provided.  All  * intellectual property rights of others is maintained with the respective  * owners.  This software is not copyrighted and is intended for reference  * only.  * END_BLOCK  *  * $FreeBSD$  *****************************************************************************/
end_comment

begin_include
include|#
directive|include
file|"at91rm9200_lowlevel.h"
end_include

begin_include
include|#
directive|include
file|"at91rm9200.h"
end_include

begin_include
include|#
directive|include
file|"lib.h"
end_include

begin_include
include|#
directive|include
file|"ee.h"
end_include

begin_comment
comment|/******************************* GLOBALS *************************************/
end_comment

begin_comment
comment|/*********************** PRIVATE FUNCTIONS/DATA ******************************/
end_comment

begin_comment
comment|/* Use a macro to calculate the TWI clock generator value to save code space. */
end_comment

begin_define
define|#
directive|define
name|AT91C_TWSI_CLOCK
value|100000
end_define

begin_define
define|#
directive|define
name|TWSI_EEPROM_ADDRESS
value|0x40
end_define

begin_define
define|#
directive|define
name|TWI_CLK_BASE_DIV
value|((AT91C_MASTER_CLOCK/(4*AT91C_TWSI_CLOCK)) - 2)
end_define

begin_define
define|#
directive|define
name|SET_TWI_CLOCK
value|((0x00010000) | (TWI_CLK_BASE_DIV) | (TWI_CLK_BASE_DIV<< 8))
end_define

begin_comment
comment|/*************************** GLOBAL FUNCTIONS ********************************/
end_comment

begin_comment
comment|/*  * .KB_C_FN_DEFINITION_START  * void InitEEPROM(void)  *  This global function initializes the EEPROM interface (TWI).  Intended  * to be called a single time.  * .KB_C_FN_DEFINITION_END  */
end_comment

begin_function
name|void
name|EEInit
parameter_list|(
name|void
parameter_list|)
block|{
name|AT91PS_TWI
name|twiPtr
init|=
operator|(
name|AT91PS_TWI
operator|)
name|AT91C_BASE_TWI
decl_stmt|;
name|AT91PS_PIO
name|pPio
init|=
operator|(
name|AT91PS_PIO
operator|)
name|AT91C_BASE_PIOA
decl_stmt|;
name|AT91PS_PMC
name|pPMC
init|=
operator|(
name|AT91PS_PMC
operator|)
name|AT91C_BASE_PMC
decl_stmt|;
name|pPio
operator|->
name|PIO_ASR
operator|=
name|AT91C_PA25_TWD
operator||
name|AT91C_PA26_TWCK
expr_stmt|;
name|pPio
operator|->
name|PIO_PDR
operator|=
name|AT91C_PA25_TWD
operator||
name|AT91C_PA26_TWCK
expr_stmt|;
name|pPio
operator|->
name|PIO_MDDR
operator|=
operator|~
name|AT91C_PA25_TWD
expr_stmt|;
name|pPio
operator|->
name|PIO_MDER
operator|=
name|AT91C_PA25_TWD
expr_stmt|;
name|pPMC
operator|->
name|PMC_PCER
operator|=
literal|1u
operator|<<
name|AT91C_ID_TWI
expr_stmt|;
name|twiPtr
operator|->
name|TWI_IDR
operator|=
literal|0xffffffffu
expr_stmt|;
name|twiPtr
operator|->
name|TWI_CR
operator|=
name|AT91C_TWI_SWRST
expr_stmt|;
name|twiPtr
operator|->
name|TWI_CR
operator|=
name|AT91C_TWI_MSEN
operator||
name|AT91C_TWI_SVDIS
expr_stmt|;
name|twiPtr
operator|->
name|TWI_CWGR
operator|=
name|SET_TWI_CLOCK
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|unsigned
name|iicaddr
parameter_list|(
name|unsigned
name|ee_off
parameter_list|)
block|{
return|return
operator|(
name|TWSI_EEPROM_ADDRESS
operator||
operator|(
operator|(
name|ee_off
operator|>>
literal|8
operator|)
operator|&
literal|0x7
operator|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * .KB_C_FN_DEFINITION_START  * void ReadEEPROM(unsigned ee_addr, char *data_addr, unsigned size)  *  This global function reads data from the eeprom at ee_addr storing data  * to data_addr for size bytes.  Assume the TWI has been initialized.  * This function does not utilize the page read mode to simplify the code.  * .KB_C_FN_DEFINITION_END  */
end_comment

begin_function
name|void
name|EERead
parameter_list|(
name|unsigned
name|ee_off
parameter_list|,
name|char
modifier|*
name|data_addr
parameter_list|,
name|unsigned
name|size
parameter_list|)
block|{
specifier|const
name|AT91PS_TWI
name|twiPtr
init|=
name|AT91C_BASE_TWI
decl_stmt|;
name|unsigned
name|int
name|status
decl_stmt|;
if|if
condition|(
operator|(
name|ee_off
operator|&
operator|~
literal|0xff
operator|)
operator|!=
operator|(
operator|(
name|ee_off
operator|+
name|size
operator|)
operator|&
operator|~
literal|0xff
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"Crosses page boundary: 0x%x 0x%x\n"
argument_list|,
name|ee_off
argument_list|,
name|size
argument_list|)
expr_stmt|;
return|return;
block|}
name|status
operator|=
name|twiPtr
operator|->
name|TWI_SR
expr_stmt|;
name|status
operator|=
name|twiPtr
operator|->
name|TWI_RHR
expr_stmt|;
name|twiPtr
operator|->
name|TWI_MMR
operator|=
operator|(
name|iicaddr
argument_list|(
name|ee_off
argument_list|)
operator|<<
literal|16
operator|)
operator||
name|AT91C_TWI_IADRSZ_1_BYTE
operator||
name|AT91C_TWI_MREAD
expr_stmt|;
name|twiPtr
operator|->
name|TWI_IADR
operator|=
name|ee_off
operator|&
literal|0xff
expr_stmt|;
name|twiPtr
operator|->
name|TWI_CR
operator|=
name|AT91C_TWI_START
expr_stmt|;
while|while
condition|(
name|size
operator|--
operator|>
literal|1
condition|)
block|{
while|while
condition|(
operator|!
operator|(
name|twiPtr
operator|->
name|TWI_SR
operator|&
name|AT91C_TWI_RXRDY
operator|)
condition|)
continue|continue;
operator|*
operator|(
name|data_addr
operator|++
operator|)
operator|=
name|twiPtr
operator|->
name|TWI_RHR
expr_stmt|;
block|}
name|twiPtr
operator|->
name|TWI_CR
operator|=
name|AT91C_TWI_STOP
expr_stmt|;
name|status
operator|=
name|twiPtr
operator|->
name|TWI_SR
expr_stmt|;
while|while
condition|(
operator|!
operator|(
name|twiPtr
operator|->
name|TWI_SR
operator|&
name|AT91C_TWI_TXCOMP
operator|)
condition|)
continue|continue;
operator|*
name|data_addr
operator|=
name|twiPtr
operator|->
name|TWI_RHR
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * .KB_C_FN_DEFINITION_START  * void WriteEEPROM(unsigned ee_off, char *data_addr, unsigned size)  *  This global function writes data to the eeprom at ee_off using data  * from data_addr for size bytes.  Assume the TWI has been initialized.  * This function does not utilize the page write mode as the write time is  * much greater than the time required to access the device for byte-write  * functionality.  This allows the function to be much simpler.  * .KB_C_FN_DEFINITION_END  */
end_comment

begin_function
name|void
name|EEWrite
parameter_list|(
name|unsigned
name|ee_off
parameter_list|,
specifier|const
name|char
modifier|*
name|data_addr
parameter_list|,
name|unsigned
name|size
parameter_list|)
block|{
specifier|const
name|AT91PS_TWI
name|twiPtr
init|=
name|AT91C_BASE_TWI
decl_stmt|;
name|unsigned
name|status
decl_stmt|;
name|char
name|test_data
decl_stmt|;
while|while
condition|(
name|size
operator|--
condition|)
block|{
comment|// Set the TWI Master Mode Register
name|twiPtr
operator|->
name|TWI_MMR
operator|=
operator|(
name|iicaddr
argument_list|(
name|ee_off
argument_list|)
operator|<<
literal|16
operator|)
operator||
name|AT91C_TWI_IADRSZ_1_BYTE
expr_stmt|;
name|twiPtr
operator|->
name|TWI_IADR
operator|=
name|ee_off
operator|++
expr_stmt|;
name|status
operator|=
name|twiPtr
operator|->
name|TWI_SR
expr_stmt|;
comment|// Load one data byte
name|twiPtr
operator|->
name|TWI_THR
operator|=
operator|*
operator|(
name|data_addr
operator|++
operator|)
expr_stmt|;
name|twiPtr
operator|->
name|TWI_CR
operator|=
name|AT91C_TWI_START
expr_stmt|;
while|while
condition|(
operator|!
operator|(
name|twiPtr
operator|->
name|TWI_SR
operator|&
name|AT91C_TWI_TXRDY
operator|)
condition|)
continue|continue;
name|twiPtr
operator|->
name|TWI_CR
operator|=
name|AT91C_TWI_STOP
expr_stmt|;
name|status
operator|=
name|twiPtr
operator|->
name|TWI_SR
expr_stmt|;
while|while
condition|(
operator|!
operator|(
name|twiPtr
operator|->
name|TWI_SR
operator|&
name|AT91C_TWI_TXCOMP
operator|)
condition|)
continue|continue;
comment|// wait for write operation to complete, it is done once
comment|// we can read it back...
name|EERead
argument_list|(
name|ee_off
argument_list|,
operator|&
name|test_data
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
end_function

end_unit


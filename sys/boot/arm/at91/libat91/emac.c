begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/******************************************************************************  *  * Filename: emac.c  *  * Instantiation of routines for MAC/ethernet functions supporting tftp.  *  * Revision information:  *  * 28AUG2004	kb_admin	initial creation  * 08JAN2005	kb_admin	added tftp download  *					also adapted from external sources  *  * BEGIN_KBDD_BLOCK  * No warranty, expressed or implied, is included with this software.  It is  * provided "AS IS" and no warranty of any kind including statutory or aspects  * relating to merchantability or fitness for any purpose is provided.  All  * intellectual property rights of others is maintained with the respective  * owners.  This software is not copyrighted and is intended for reference  * only.  * END_BLOCK  *  * $FreeBSD$  *****************************************************************************/
end_comment

begin_include
include|#
directive|include
file|"at91rm9200.h"
end_include

begin_include
include|#
directive|include
file|"emac.h"
end_include

begin_include
include|#
directive|include
file|"p_string.h"
end_include

begin_include
include|#
directive|include
file|"at91rm9200_lowlevel.h"
end_include

begin_include
include|#
directive|include
file|"lib.h"
end_include

begin_comment
comment|/******************************* GLOBALS *************************************/
end_comment

begin_comment
comment|/*********************** PRIVATE FUNCTIONS/DATA ******************************/
end_comment

begin_decl_stmt
specifier|static
name|unsigned
name|localMACSet
decl_stmt|,
name|serverMACSet
decl_stmt|,
name|MAC_init
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|char
name|localMACAddr
index|[
literal|6
index|]
decl_stmt|,
name|serverMACAddr
index|[
literal|6
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|localIPAddr
decl_stmt|,
name|serverIPAddr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|short
name|serverPort
decl_stmt|,
name|localPort
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|ackBlock
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|lastAddress
decl_stmt|,
name|lastSize
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|dlAddress
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|transmitBuffer
index|[
literal|1024
operator|/
sizeof|sizeof
argument_list|(
name|unsigned
argument_list|)
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|tftpSendPacket
index|[
literal|256
operator|/
sizeof|sizeof
argument_list|(
name|unsigned
argument_list|)
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|receive_descriptor_t
modifier|*
name|p_rxBD
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * .KB_C_FN_DEFINITION_START  * unsigned short IP_checksum(unsigned short *p, int len)  *  This private function calculates the IP checksum for various headers.  * .KB_C_FN_DEFINITION_END  */
end_comment

begin_function
specifier|static
name|unsigned
name|short
name|IP_checksum
parameter_list|(
name|void
modifier|*
name|cp
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|unsigned
name|i
decl_stmt|,
name|t
decl_stmt|;
name|unsigned
name|short
modifier|*
name|p
init|=
operator|(
name|unsigned
name|short
operator|*
operator|)
name|cp
decl_stmt|;
name|len
operator|&=
operator|~
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|t
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|+=
literal|2
operator|,
operator|++
name|p
control|)
name|t
operator|+=
name|SWAP16
argument_list|(
operator|*
name|p
argument_list|)
expr_stmt|;
name|t
operator|=
operator|(
name|t
operator|&
literal|0xffff
operator|)
operator|+
operator|(
name|t
operator|>>
literal|16
operator|)
expr_stmt|;
return|return
operator|(
operator|~
name|t
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * .KB_C_FN_DEFINITION_START  * void GetServerAddress(void)  *  This private function sends an ARP request to determine the server MAC.  * .KB_C_FN_DEFINITION_END  */
end_comment

begin_function
specifier|static
name|void
name|GetServerAddress
parameter_list|(
name|void
parameter_list|)
block|{
name|arp_header_t
modifier|*
name|p_ARP
decl_stmt|;
name|p_ARP
operator|=
operator|(
name|arp_header_t
operator|*
operator|)
name|transmitBuffer
expr_stmt|;
name|p_memset
argument_list|(
operator|(
name|char
operator|*
operator|)
name|p_ARP
operator|->
name|dest_mac
argument_list|,
literal|0xFF
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|p_memcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|p_ARP
operator|->
name|src_mac
argument_list|,
operator|(
name|char
operator|*
operator|)
name|localMACAddr
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|p_ARP
operator|->
name|frame_type
operator|=
name|SWAP16
argument_list|(
name|PROTOCOL_ARP
argument_list|)
expr_stmt|;
name|p_ARP
operator|->
name|hard_type
operator|=
name|SWAP16
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|p_ARP
operator|->
name|prot_type
operator|=
name|SWAP16
argument_list|(
name|PROTOCOL_IP
argument_list|)
expr_stmt|;
name|p_ARP
operator|->
name|hard_size
operator|=
literal|6
expr_stmt|;
name|p_ARP
operator|->
name|prot_size
operator|=
literal|4
expr_stmt|;
name|p_ARP
operator|->
name|operation
operator|=
name|SWAP16
argument_list|(
name|ARP_REQUEST
argument_list|)
expr_stmt|;
name|p_memcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|p_ARP
operator|->
name|sender_mac
argument_list|,
operator|(
name|char
operator|*
operator|)
name|localMACAddr
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|p_memcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|p_ARP
operator|->
name|sender_ip
argument_list|,
operator|(
name|char
operator|*
operator|)
name|localIPAddr
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|p_memset
argument_list|(
operator|(
name|char
operator|*
operator|)
name|p_ARP
operator|->
name|target_mac
argument_list|,
literal|0
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|p_memcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|p_ARP
operator|->
name|target_ip
argument_list|,
operator|(
name|char
operator|*
operator|)
name|serverIPAddr
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|// wait until transmit is available
while|while
condition|(
operator|!
operator|(
operator|*
name|AT91C_EMAC_TSR
operator|&
name|AT91C_EMAC_BNQ
operator|)
condition|)
empty_stmt|;
operator|*
name|AT91C_EMAC_TSR
operator||=
name|AT91C_EMAC_COMP
expr_stmt|;
operator|*
name|AT91C_EMAC_TAR
operator|=
operator|(
name|unsigned
operator|)
name|transmitBuffer
expr_stmt|;
operator|*
name|AT91C_EMAC_TCR
operator|=
literal|0x40
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * .KB_C_FN_DEFINITION_START  * void Send_TFTP_Packet(char *tftpData, unsigned tftpLength)  *  This private function initializes and send a TFTP packet.  * .KB_C_FN_DEFINITION_END  */
end_comment

begin_function
specifier|static
name|void
name|Send_TFTP_Packet
parameter_list|(
name|char
modifier|*
name|tftpData
parameter_list|,
name|unsigned
name|tftpLength
parameter_list|)
block|{
name|transmit_header_t
modifier|*
name|macHdr
init|=
operator|(
name|transmit_header_t
operator|*
operator|)
name|tftpSendPacket
decl_stmt|;
name|ip_header_t
modifier|*
name|ipHdr
decl_stmt|;
name|udp_header_t
modifier|*
name|udpHdr
decl_stmt|;
name|unsigned
name|t_checksum
decl_stmt|;
name|p_memcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|macHdr
operator|->
name|dest_mac
argument_list|,
operator|(
name|char
operator|*
operator|)
name|serverMACAddr
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|p_memcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|macHdr
operator|->
name|src_mac
argument_list|,
operator|(
name|char
operator|*
operator|)
name|localMACAddr
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|macHdr
operator|->
name|proto_mac
operator|=
name|SWAP16
argument_list|(
name|PROTOCOL_IP
argument_list|)
expr_stmt|;
name|ipHdr
operator|=
operator|&
name|macHdr
operator|->
name|iphdr
expr_stmt|;
name|ipHdr
operator|->
name|ip_v_hl
operator|=
literal|0x45
expr_stmt|;
name|ipHdr
operator|->
name|ip_tos
operator|=
literal|0
expr_stmt|;
name|ipHdr
operator|->
name|ip_len
operator|=
name|SWAP16
argument_list|(
literal|28
operator|+
name|tftpLength
argument_list|)
expr_stmt|;
name|ipHdr
operator|->
name|ip_id
operator|=
literal|0
expr_stmt|;
name|ipHdr
operator|->
name|ip_off
operator|=
name|SWAP16
argument_list|(
literal|0x4000
argument_list|)
expr_stmt|;
name|ipHdr
operator|->
name|ip_ttl
operator|=
literal|64
expr_stmt|;
name|ipHdr
operator|->
name|ip_p
operator|=
name|PROTOCOL_UDP
expr_stmt|;
name|ipHdr
operator|->
name|ip_sum
operator|=
literal|0
expr_stmt|;
name|p_memcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|ipHdr
operator|->
name|ip_src
argument_list|,
operator|(
name|char
operator|*
operator|)
name|localIPAddr
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|p_memcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|ipHdr
operator|->
name|ip_dst
argument_list|,
operator|(
name|char
operator|*
operator|)
name|serverIPAddr
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|ipHdr
operator|->
name|ip_sum
operator|=
name|SWAP16
argument_list|(
name|IP_checksum
argument_list|(
name|ipHdr
argument_list|,
literal|20
argument_list|)
argument_list|)
expr_stmt|;
name|udpHdr
operator|=
operator|(
name|udp_header_t
operator|*
operator|)
operator|(
name|ipHdr
operator|+
literal|1
operator|)
expr_stmt|;
name|udpHdr
operator|->
name|src_port
operator|=
name|localPort
expr_stmt|;
name|udpHdr
operator|->
name|dst_port
operator|=
name|serverPort
expr_stmt|;
name|udpHdr
operator|->
name|udp_len
operator|=
name|SWAP16
argument_list|(
literal|8
operator|+
name|tftpLength
argument_list|)
expr_stmt|;
name|udpHdr
operator|->
name|udp_cksum
operator|=
literal|0
expr_stmt|;
name|p_memcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|udpHdr
operator|+
literal|8
argument_list|,
name|tftpData
argument_list|,
name|tftpLength
argument_list|)
expr_stmt|;
name|t_checksum
operator|=
name|IP_checksum
argument_list|(
operator|(
name|char
operator|*
operator|)
name|ipHdr
operator|+
literal|12
argument_list|,
operator|(
literal|16
operator|+
name|tftpLength
operator|)
argument_list|)
expr_stmt|;
name|t_checksum
operator|=
operator|(
operator|~
name|t_checksum
operator|)
operator|&
literal|0xFFFF
expr_stmt|;
name|t_checksum
operator|+=
literal|25
operator|+
name|tftpLength
expr_stmt|;
name|t_checksum
operator|=
operator|(
name|t_checksum
operator|&
literal|0xffff
operator|)
operator|+
operator|(
name|t_checksum
operator|>>
literal|16
operator|)
expr_stmt|;
name|t_checksum
operator|=
operator|(
operator|~
name|t_checksum
operator|)
operator|&
literal|0xFFFF
expr_stmt|;
name|udpHdr
operator|->
name|udp_cksum
operator|=
name|SWAP16
argument_list|(
name|t_checksum
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
operator|(
operator|*
name|AT91C_EMAC_TSR
operator|&
name|AT91C_EMAC_BNQ
operator|)
condition|)
empty_stmt|;
operator|*
name|AT91C_EMAC_TSR
operator||=
name|AT91C_EMAC_COMP
expr_stmt|;
operator|*
name|AT91C_EMAC_TAR
operator|=
operator|(
name|unsigned
operator|)
name|tftpSendPacket
expr_stmt|;
operator|*
name|AT91C_EMAC_TCR
operator|=
literal|42
operator|+
name|tftpLength
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * .KB_C_FN_DEFINITION_START  * void TFTP_RequestFile(char *filename)  *  This private function sends a RRQ packet to the server.  * .KB_C_FN_DEFINITION_END  */
end_comment

begin_function
specifier|static
name|void
name|TFTP_RequestFile
parameter_list|(
name|char
modifier|*
name|filename
parameter_list|)
block|{
name|tftp_header_t
name|tftpHeader
decl_stmt|;
name|char
modifier|*
name|cPtr
decl_stmt|,
modifier|*
name|ePtr
decl_stmt|,
modifier|*
name|mPtr
decl_stmt|;
name|unsigned
name|length
decl_stmt|;
name|tftpHeader
operator|.
name|opcode
operator|=
name|SWAP16
argument_list|(
name|TFTP_RRQ_OPCODE
argument_list|)
expr_stmt|;
name|cPtr
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
operator|(
name|tftpHeader
operator|.
name|block_num
operator|)
expr_stmt|;
name|ePtr
operator|=
name|p_strcpy
argument_list|(
name|cPtr
argument_list|,
name|filename
argument_list|)
expr_stmt|;
name|mPtr
operator|=
name|p_strcpy
argument_list|(
name|ePtr
argument_list|,
literal|"octet"
argument_list|)
expr_stmt|;
name|length
operator|=
name|mPtr
operator|-
name|cPtr
expr_stmt|;
name|length
operator|+=
literal|2
expr_stmt|;
name|Send_TFTP_Packet
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|tftpHeader
argument_list|,
name|length
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * .KB_C_FN_DEFINITION_START  * void TFTP_ACK_Data(char *data, unsigned short block_num, unsigned short len)  *  This private function sends an ACK packet to the server.  * .KB_C_FN_DEFINITION_END  */
end_comment

begin_function
specifier|static
name|void
name|TFTP_ACK_Data
parameter_list|(
name|char
modifier|*
name|data
parameter_list|,
name|unsigned
name|short
name|block_num
parameter_list|,
name|unsigned
name|short
name|len
parameter_list|)
block|{
name|tftp_header_t
name|tftpHeader
decl_stmt|;
if|if
condition|(
name|block_num
operator|==
name|SWAP16
argument_list|(
name|ackBlock
operator|+
literal|1
argument_list|)
condition|)
block|{
operator|++
name|ackBlock
expr_stmt|;
name|p_memcpy
argument_list|(
name|dlAddress
argument_list|,
name|data
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|dlAddress
operator|+=
name|len
expr_stmt|;
name|lastSize
operator|+=
name|len
expr_stmt|;
block|}
name|tftpHeader
operator|.
name|opcode
operator|=
name|SWAP16
argument_list|(
name|TFTP_ACK_OPCODE
argument_list|)
expr_stmt|;
name|tftpHeader
operator|.
name|block_num
operator|=
name|block_num
expr_stmt|;
name|Send_TFTP_Packet
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|tftpHeader
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|512
condition|)
name|ackBlock
operator|=
operator|-
literal|2
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * .KB_C_FN_DEFINITION_START  * void CheckForNewPacket(ip_header_t *pHeader)  *  This private function polls for received ethernet packets and handles  * any here.  * .KB_C_FN_DEFINITION_END  */
end_comment

begin_function
specifier|static
name|void
name|CheckForNewPacket
parameter_list|(
name|void
parameter_list|)
block|{
name|unsigned
name|short
modifier|*
name|pFrameType
decl_stmt|;
name|unsigned
name|i
decl_stmt|;
name|char
modifier|*
name|pData
decl_stmt|;
name|ip_header_t
modifier|*
name|pIpHeader
decl_stmt|;
name|arp_header_t
modifier|*
name|p_ARP
decl_stmt|;
name|int
name|process
init|=
literal|0
decl_stmt|;
name|process
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_RX_PACKETS
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|p_rxBD
index|[
name|i
index|]
operator|.
name|address
operator|&
literal|0x1
condition|)
block|{
name|process
operator|=
literal|1
expr_stmt|;
operator|(
operator|*
name|AT91C_EMAC_RSR
operator|)
operator||=
operator|(
operator|*
name|AT91C_EMAC_RSR
operator|)
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
operator|!
name|process
condition|)
return|return ;
name|process
operator|=
name|i
expr_stmt|;
name|pFrameType
operator|=
operator|(
name|unsigned
name|short
operator|*
operator|)
operator|(
operator|(
name|p_rxBD
index|[
name|i
index|]
operator|.
name|address
operator|&
literal|0xFFFFFFFC
operator|)
operator|+
literal|12
operator|)
expr_stmt|;
name|pData
operator|=
operator|(
name|char
operator|*
operator|)
operator|(
name|p_rxBD
index|[
name|i
index|]
operator|.
name|address
operator|&
literal|0xFFFFFFFC
operator|)
expr_stmt|;
switch|switch
condition|(
name|SWAP16
argument_list|(
operator|*
name|pFrameType
argument_list|)
condition|)
block|{
case|case
name|PROTOCOL_ARP
case|:
name|p_ARP
operator|=
operator|(
name|arp_header_t
operator|*
operator|)
name|pData
expr_stmt|;
name|i
operator|=
name|SWAP16
argument_list|(
name|p_ARP
operator|->
name|operation
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
name|ARP_REPLY
condition|)
block|{
comment|// check if new server info is available
if|if
condition|(
operator|(
operator|!
name|serverMACSet
operator|)
operator|&&
operator|(
operator|!
operator|(
name|p_memcmp
argument_list|(
operator|(
name|char
operator|*
operator|)
name|p_ARP
operator|->
name|sender_ip
argument_list|,
operator|(
name|char
operator|*
operator|)
name|serverIPAddr
argument_list|,
literal|4
argument_list|)
operator|)
operator|)
condition|)
block|{
name|serverMACSet
operator|=
literal|1
expr_stmt|;
name|p_memcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|serverMACAddr
argument_list|,
operator|(
name|char
operator|*
operator|)
name|p_ARP
operator|->
name|sender_mac
argument_list|,
literal|6
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|i
operator|==
name|ARP_REQUEST
condition|)
block|{
comment|// ARP REPLY operation
name|p_ARP
operator|->
name|operation
operator|=
name|SWAP16
argument_list|(
name|ARP_REPLY
argument_list|)
expr_stmt|;
comment|// Swap the src/dst MAC addr
name|p_memcpy
argument_list|(
name|p_ARP
operator|->
name|dest_mac
argument_list|,
name|p_ARP
operator|->
name|src_mac
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|p_memcpy
argument_list|(
name|p_ARP
operator|->
name|src_mac
argument_list|,
name|localMACAddr
argument_list|,
literal|6
argument_list|)
expr_stmt|;
comment|// Do IP and MAC addr at same time.
name|p_memcpy
argument_list|(
name|p_ARP
operator|->
name|target_mac
argument_list|,
name|p_ARP
operator|->
name|sender_mac
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|p_memcpy
argument_list|(
name|p_ARP
operator|->
name|sender_mac
argument_list|,
name|localMACAddr
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|p_memcpy
argument_list|(
name|p_ARP
operator|->
name|sender_ip
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|localIPAddr
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
operator|*
name|AT91C_EMAC_TSR
operator|&
name|AT91C_EMAC_BNQ
operator|)
condition|)
break|break;
operator|*
name|AT91C_EMAC_TSR
operator||=
name|AT91C_EMAC_COMP
expr_stmt|;
operator|*
name|AT91C_EMAC_TAR
operator|=
operator|(
name|unsigned
operator|)
name|pData
expr_stmt|;
operator|*
name|AT91C_EMAC_TCR
operator|=
literal|0x40
expr_stmt|;
block|}
break|break;
case|case
name|PROTOCOL_IP
case|:
name|pIpHeader
operator|=
operator|(
name|ip_header_t
operator|*
operator|)
operator|(
name|pData
operator|+
literal|14
operator|)
expr_stmt|;
switch|switch
condition|(
name|pIpHeader
operator|->
name|ip_p
condition|)
block|{
case|case
name|PROTOCOL_UDP
case|:
block|{
name|udp_header_t
modifier|*
name|udpHdr
decl_stmt|;
name|tftp_header_t
modifier|*
name|tftpHdr
decl_stmt|;
name|udpHdr
operator|=
operator|(
name|udp_header_t
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|pIpHeader
operator|+
literal|20
operator|)
expr_stmt|;
name|tftpHdr
operator|=
operator|(
name|tftp_header_t
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|udpHdr
operator|+
literal|8
operator|)
expr_stmt|;
if|if
condition|(
name|udpHdr
operator|->
name|dst_port
operator|!=
name|localPort
condition|)
break|break;
if|if
condition|(
name|tftpHdr
operator|->
name|opcode
operator|!=
name|SWAP16
argument_list|(
name|TFTP_DATA_OPCODE
argument_list|)
condition|)
break|break;
if|if
condition|(
name|ackBlock
operator|==
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|tftpHdr
operator|->
name|block_num
operator|!=
name|SWAP16
argument_list|(
literal|1
argument_list|)
condition|)
break|break;
name|serverPort
operator|=
name|udpHdr
operator|->
name|src_port
expr_stmt|;
name|ackBlock
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|serverPort
operator|!=
name|udpHdr
operator|->
name|src_port
condition|)
break|break;
name|TFTP_ACK_Data
argument_list|(
name|tftpHdr
operator|->
name|data
argument_list|,
name|tftpHdr
operator|->
name|block_num
argument_list|,
name|SWAP16
argument_list|(
name|udpHdr
operator|->
name|udp_len
argument_list|)
operator|-
literal|12
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
break|break;
block|}
break|break;
default|default:
break|break;
block|}
name|p_rxBD
index|[
name|process
index|]
operator|.
name|address
operator|&=
operator|~
literal|0x01
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * .KB_C_FN_DEFINITION_START  * unsigned short AT91F_MII_ReadPhy (AT91PS_EMAC pEmac, unsigned char addr)  *  This private function reads the PHY device.  * .KB_C_FN_DEFINITION_END  */
end_comment

begin_function
specifier|static
name|unsigned
name|short
name|AT91F_MII_ReadPhy
parameter_list|(
name|AT91PS_EMAC
name|pEmac
parameter_list|,
name|unsigned
name|char
name|addr
parameter_list|)
block|{
name|unsigned
name|value
init|=
literal|0x60020000
operator||
operator|(
name|addr
operator|<<
literal|18
operator|)
decl_stmt|;
name|pEmac
operator|->
name|EMAC_CTL
operator||=
name|AT91C_EMAC_MPE
expr_stmt|;
name|pEmac
operator|->
name|EMAC_MAN
operator|=
name|value
expr_stmt|;
while|while
condition|(
operator|!
operator|(
operator|(
name|pEmac
operator|->
name|EMAC_SR
operator|)
operator|&
name|AT91C_EMAC_IDLE
operator|)
condition|)
empty_stmt|;
name|pEmac
operator|->
name|EMAC_CTL
operator|&=
operator|~
name|AT91C_EMAC_MPE
expr_stmt|;
return|return
operator|(
name|pEmac
operator|->
name|EMAC_MAN
operator|&
literal|0x0000ffff
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * .KB_C_FN_DEFINITION_START  * void MII_GetLinkSpeed(AT91PS_EMAC pEmac)  *  This private function determines the link speed set by the PHY.  * .KB_C_FN_DEFINITION_END  */
end_comment

begin_function
specifier|static
name|void
name|MII_GetLinkSpeed
parameter_list|(
name|AT91PS_EMAC
name|pEmac
parameter_list|)
block|{
name|unsigned
name|short
name|stat2
decl_stmt|;
name|unsigned
name|update
init|=
literal|0
decl_stmt|;
name|stat2
operator|=
name|AT91F_MII_ReadPhy
argument_list|(
name|pEmac
argument_list|,
name|MII_STS2_REG
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|stat2
operator|&
literal|0x400
operator|)
condition|)
block|{
return|return ;
block|}
elseif|else
if|if
condition|(
name|stat2
operator|&
literal|0x4000
condition|)
block|{
name|update
operator||=
name|AT91C_EMAC_SPD
expr_stmt|;
if|if
condition|(
name|stat2
operator|&
literal|0x200
condition|)
block|{
name|update
operator||=
name|AT91C_EMAC_FD
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|stat2
operator|&
literal|0x200
condition|)
block|{
name|update
operator||=
name|AT91C_EMAC_FD
expr_stmt|;
block|}
name|pEmac
operator|->
name|EMAC_CFG
operator|=
operator|(
name|pEmac
operator|->
name|EMAC_CFG
operator|&
operator|~
operator|(
name|AT91C_EMAC_SPD
operator||
name|AT91C_EMAC_FD
operator|)
operator|)
operator||
name|update
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * .KB_C_FN_DEFINITION_START  * void AT91F_EmacEntry(void)  *  This private function initializes the EMAC on the chip.  * .KB_C_FN_DEFINITION_END  */
end_comment

begin_function
specifier|static
name|void
name|AT91F_EmacEntry
parameter_list|(
name|void
parameter_list|)
block|{
name|unsigned
name|i
decl_stmt|;
name|char
modifier|*
name|pRxPacket
init|=
operator|(
name|char
operator|*
operator|)
name|RX_DATA_START
decl_stmt|;
name|AT91PS_EMAC
name|pEmac
init|=
name|AT91C_BASE_EMAC
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_RX_PACKETS
condition|;
operator|++
name|i
control|)
block|{
name|p_rxBD
index|[
name|i
index|]
operator|.
name|address
operator|=
operator|(
name|unsigned
operator|)
name|pRxPacket
expr_stmt|;
name|p_rxBD
index|[
name|i
index|]
operator|.
name|size
operator|=
literal|0
expr_stmt|;
name|pRxPacket
operator|+=
name|RX_PACKET_SIZE
expr_stmt|;
block|}
comment|// Set the WRAP bit at the end of the list descriptor
name|p_rxBD
index|[
name|MAX_RX_PACKETS
operator|-
literal|1
index|]
operator|.
name|address
operator||=
literal|0x02
expr_stmt|;
name|pEmac
operator|->
name|EMAC_CTL
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|pEmac
operator|->
name|EMAC_SR
operator|&
name|AT91C_EMAC_LINK
operator|)
condition|)
name|MII_GetLinkSpeed
argument_list|(
name|pEmac
argument_list|)
expr_stmt|;
comment|// the sequence write EMAC_SA1L and write EMAC_SA1H must be respected
name|pEmac
operator|->
name|EMAC_SA1L
operator|=
operator|(
operator|(
name|unsigned
operator|)
name|localMACAddr
index|[
literal|2
index|]
operator|<<
literal|24
operator|)
operator||
operator|(
operator|(
name|unsigned
operator|)
name|localMACAddr
index|[
literal|3
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
operator|(
name|int
operator|)
name|localMACAddr
index|[
literal|4
index|]
operator|<<
literal|8
operator|)
operator||
name|localMACAddr
index|[
literal|5
index|]
expr_stmt|;
name|pEmac
operator|->
name|EMAC_SA1H
operator|=
operator|(
operator|(
name|unsigned
operator|)
name|localMACAddr
index|[
literal|0
index|]
operator|<<
literal|8
operator|)
operator||
name|localMACAddr
index|[
literal|1
index|]
expr_stmt|;
name|pEmac
operator|->
name|EMAC_RBQP
operator|=
operator|(
name|unsigned
operator|)
name|p_rxBD
expr_stmt|;
name|pEmac
operator|->
name|EMAC_RSR
operator||=
operator|(
name|AT91C_EMAC_OVR
operator||
name|AT91C_EMAC_REC
operator||
name|AT91C_EMAC_BNA
operator|)
expr_stmt|;
name|pEmac
operator|->
name|EMAC_CFG
operator||=
name|AT91C_EMAC_CAF
expr_stmt|;
name|pEmac
operator|->
name|EMAC_CFG
operator|=
operator|(
name|pEmac
operator|->
name|EMAC_CFG
operator|&
operator|~
operator|(
name|AT91C_EMAC_CLK
operator|)
operator|)
operator||
name|AT91C_EMAC_CLK_HCLK_32
expr_stmt|;
name|pEmac
operator|->
name|EMAC_CTL
operator||=
operator|(
name|AT91C_EMAC_TE
operator||
name|AT91C_EMAC_RE
operator|)
expr_stmt|;
name|pEmac
operator|->
name|EMAC_TAR
operator|=
operator|(
name|unsigned
operator|)
name|transmitBuffer
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ************************** GLOBAL FUNCTIONS ********************************/
end_comment

begin_comment
comment|/*  * .KB_C_FN_DEFINITION_START  * void SetMACAddress(unsigned low_address, unsigned high_address)  *  This global function sets the MAC address.  low_address is the first  * four bytes while high_address is the last 2 bytes of the 48-bit value.  * .KB_C_FN_DEFINITION_END  */
end_comment

begin_function
name|void
name|SetMACAddress
parameter_list|(
name|unsigned
name|low_address
parameter_list|,
name|unsigned
name|high_address
parameter_list|)
block|{
name|AT91PS_EMAC
name|pEmac
init|=
name|AT91C_BASE_EMAC
decl_stmt|;
name|AT91PS_PMC
name|pPMC
init|=
name|AT91C_BASE_PMC
decl_stmt|;
comment|/* enable the peripheral clock before using EMAC */
name|pPMC
operator|->
name|PMC_PCER
operator|=
operator|(
operator|(
name|unsigned
operator|)
literal|1
operator|<<
name|AT91C_ID_EMAC
operator|)
expr_stmt|;
name|pEmac
operator|->
name|EMAC_SA1L
operator|=
name|low_address
expr_stmt|;
name|pEmac
operator|->
name|EMAC_SA1H
operator|=
operator|(
name|high_address
operator|&
literal|0x0000ffff
operator|)
expr_stmt|;
name|localMACAddr
index|[
literal|0
index|]
operator|=
operator|(
name|low_address
operator|>>
literal|0
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|localMACAddr
index|[
literal|1
index|]
operator|=
operator|(
name|low_address
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|localMACAddr
index|[
literal|2
index|]
operator|=
operator|(
name|low_address
operator|>>
literal|16
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|localMACAddr
index|[
literal|3
index|]
operator|=
operator|(
name|low_address
operator|>>
literal|24
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|localMACAddr
index|[
literal|4
index|]
operator|=
operator|(
name|high_address
operator|>>
literal|0
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|localMACAddr
index|[
literal|5
index|]
operator|=
operator|(
name|high_address
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|localMACSet
operator|=
literal|1
expr_stmt|;
comment|// low_address& 0x000000ff = first byte in address
comment|// low_address& 0x0000ff00 = next
comment|// low_address& 0x00ff0000 = next
comment|// low_address& 0xff000000 = next
comment|// high_address& 0x000000ff = next
comment|// high_address& 0x0000ff00 = last byte in address
block|}
end_function

begin_comment
comment|/*  * .KB_C_FN_DEFINITION_START  * void SetServerIPAddress(unsigned address)  *  This global function sets the IP of the TFTP download server.  * .KB_C_FN_DEFINITION_END  */
end_comment

begin_function
name|void
name|SetServerIPAddress
parameter_list|(
name|unsigned
name|address
parameter_list|)
block|{
comment|// force update in case the IP has changed
name|serverMACSet
operator|=
literal|0
expr_stmt|;
name|serverIPAddr
operator|=
name|address
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * .KB_C_FN_DEFINITION_START  * void SetLocalIPAddress(unsigned address)  *  This global function sets the IP of this module.  * .KB_C_FN_DEFINITION_END  */
end_comment

begin_function
name|void
name|SetLocalIPAddress
parameter_list|(
name|unsigned
name|address
parameter_list|)
block|{
comment|// force update in case the IP has changed
name|serverMACSet
operator|=
literal|0
expr_stmt|;
name|localIPAddr
operator|=
name|address
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * .KB_C_FN_DEFINITION_START  * void TFTP_Download(unsigned address, char *filename)  *  This global function initiates and processes a tftp download request.  * The server IP, local IP, local MAC must be set before this function is  * executed.  * .KB_C_FN_DEFINITION_END  */
end_comment

begin_function
name|void
name|TFTP_Download
parameter_list|(
name|unsigned
name|address
parameter_list|,
name|char
modifier|*
name|filename
parameter_list|)
block|{
name|unsigned
name|thisSeconds
decl_stmt|,
name|running
decl_stmt|,
name|state
decl_stmt|;
name|int
name|timeout
decl_stmt|,
name|tickUpdate
decl_stmt|;
if|if
condition|(
operator|!
name|address
condition|)
block|{
comment|// report last transfer information
name|printf
argument_list|(
literal|"Last tftp transfer info --\r\n"
literal|"address: 0x%x\r\n"
literal|"   size: 0x%x\r\n"
argument_list|,
name|lastAddress
argument_list|,
name|lastSize
argument_list|)
expr_stmt|;
return|return ;
block|}
if|if
condition|(
operator|(
operator|!
name|localMACSet
operator|)
operator|||
operator|(
operator|!
name|localIPAddr
operator|)
operator|||
operator|(
operator|!
name|serverIPAddr
operator|)
condition|)
return|return ;
if|if
condition|(
operator|!
name|MAC_init
condition|)
block|{
name|AT91C_BASE_PMC
operator|->
name|PMC_PCER
operator|=
literal|1u
operator|<<
name|AT91C_ID_EMAC
expr_stmt|;
name|AT91C_BASE_PIOA
operator|->
name|PIO_ASR
operator|=
name|AT91C_PA14_ERXER
operator||
name|AT91C_PA12_ERX0
operator||
name|AT91C_PA13_ERX1
operator||
name|AT91C_PA8_ETXEN
operator||
name|AT91C_PA16_EMDIO
operator||
name|AT91C_PA9_ETX0
operator||
name|AT91C_PA10_ETX1
operator||
name|AT91C_PA11_ECRS_ECRSDV
operator||
name|AT91C_PA15_EMDC
operator||
name|AT91C_PA7_ETXCK_EREFCK
expr_stmt|;
name|AT91C_BASE_PIOA
operator|->
name|PIO_BSR
operator|=
literal|0
expr_stmt|;
name|AT91C_BASE_PIOA
operator|->
name|PIO_PDR
operator|=
name|AT91C_PA14_ERXER
operator||
name|AT91C_PA12_ERX0
operator||
name|AT91C_PA13_ERX1
operator||
name|AT91C_PA8_ETXEN
operator||
name|AT91C_PA16_EMDIO
operator||
name|AT91C_PA9_ETX0
operator||
name|AT91C_PA10_ETX1
operator||
name|AT91C_PA11_ECRS_ECRSDV
operator||
name|AT91C_PA15_EMDC
operator||
name|AT91C_PA7_ETXCK_EREFCK
expr_stmt|;
name|AT91C_BASE_PIOB
operator|->
name|PIO_ASR
operator|=
literal|0
expr_stmt|;
name|AT91C_BASE_PIOB
operator|->
name|PIO_BSR
operator|=
name|AT91C_PB12_ETX2
operator||
name|AT91C_PB13_ETX3
operator||
name|AT91C_PB14_ETXER
operator||
name|AT91C_PB15_ERX2
operator||
name|AT91C_PB16_ERX3
operator||
name|AT91C_PB17_ERXDV
operator||
name|AT91C_PB18_ECOL
operator||
name|AT91C_PB19_ERXCK
expr_stmt|;
name|AT91C_BASE_PIOB
operator|->
name|PIO_PDR
operator|=
name|AT91C_PB12_ETX2
operator||
name|AT91C_PB13_ETX3
operator||
name|AT91C_PB14_ETXER
operator||
name|AT91C_PB15_ERX2
operator||
name|AT91C_PB16_ERX3
operator||
name|AT91C_PB17_ERXDV
operator||
name|AT91C_PB18_ECOL
operator||
name|AT91C_PB19_ERXCK
expr_stmt|;
name|MAC_init
operator|=
literal|1
expr_stmt|;
block|}
name|AT91F_EmacEntry
argument_list|()
expr_stmt|;
name|GetServerAddress
argument_list|()
expr_stmt|;
name|lastAddress
operator|=
name|address
expr_stmt|;
name|dlAddress
operator|=
operator|(
name|char
operator|*
operator|)
name|address
expr_stmt|;
name|lastSize
operator|=
literal|0
expr_stmt|;
name|running
operator|=
literal|1
expr_stmt|;
name|state
operator|=
name|TFTP_WAITING_SERVER_MAC
expr_stmt|;
name|timeout
operator|=
literal|10
expr_stmt|;
name|thisSeconds
operator|=
name|GetSeconds
argument_list|()
expr_stmt|;
name|serverPort
operator|=
name|SWAP16
argument_list|(
literal|69
argument_list|)
expr_stmt|;
name|localPort
operator|++
expr_stmt|;
comment|/* In network byte order, but who cares */
name|ackBlock
operator|=
operator|-
literal|1
expr_stmt|;
while|while
condition|(
name|running
operator|&&
name|timeout
condition|)
block|{
name|CheckForNewPacket
argument_list|()
expr_stmt|;
name|tickUpdate
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|thisSeconds
operator|!=
name|GetSeconds
argument_list|()
condition|)
block|{
name|tickUpdate
operator|=
literal|1
expr_stmt|;
operator|--
name|timeout
expr_stmt|;
name|thisSeconds
operator|=
name|GetSeconds
argument_list|()
expr_stmt|;
block|}
switch|switch
condition|(
name|state
condition|)
block|{
case|case
name|TFTP_WAITING_SERVER_MAC
case|:
if|if
condition|(
name|serverMACSet
condition|)
block|{
name|state
operator|=
name|TFTP_SEND_REQUEST
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|tickUpdate
condition|)
name|GetServerAddress
argument_list|()
expr_stmt|;
break|break;
case|case
name|TFTP_SEND_REQUEST
case|:
comment|// send request for file
if|if
condition|(
name|ackBlock
operator|!=
operator|-
literal|1
condition|)
block|{
name|state
operator|=
name|TFTP_GET_DATA
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|tickUpdate
condition|)
name|TFTP_RequestFile
argument_list|(
name|filename
argument_list|)
expr_stmt|;
break|break;
case|case
name|TFTP_GET_DATA
case|:
comment|// receiving data
if|if
condition|(
name|ackBlock
operator|==
operator|-
literal|2
condition|)
block|{
name|state
operator|=
name|TFTP_COMPLETE
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|TFTP_COMPLETE
case|:
default|default:
name|running
operator|=
literal|0
expr_stmt|;
break|break;
block|}
block|}
block|}
end_function

begin_comment
comment|/*  * .KB_C_FN_DEFINITION_START  * void EMAC_Init(void)  *  This global function initializes variables used in tftp transfers.  * .KB_C_FN_DEFINITION_END  */
end_comment

begin_function
name|void
name|EMAC_Init
parameter_list|(
name|void
parameter_list|)
block|{
name|p_rxBD
operator|=
operator|(
name|receive_descriptor_t
operator|*
operator|)
name|RX_BUFFER_START
expr_stmt|;
name|localMACSet
operator|=
literal|0
expr_stmt|;
name|serverMACSet
operator|=
literal|0
expr_stmt|;
name|localPort
operator|=
name|SWAP16
argument_list|(
literal|0x8002
argument_list|)
expr_stmt|;
name|lastAddress
operator|=
literal|0
expr_stmt|;
name|lastSize
operator|=
literal|0
expr_stmt|;
name|MAC_init
operator|=
literal|0
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*******************************************************************************  *  * Filename: emac.c  *  * Instantiation of routines for MAC/ethernet functions supporting tftp.  *  * Revision information:  *  * 28AUG2004	kb_admin	initial creation  * 08JAN2005	kb_admin	added tftp download  *					also adapted from external sources  *  * BEGIN_KBDD_BLOCK  * No warranty, expressed or implied, is included with this software.  It is  * provided "AS IS" and no warranty of any kind including statutory or aspects  * relating to merchantability or fitness for any purpose is provided.  All  * intellectual property rights of others is maintained with the respective  * owners.  This software is not copyrighted and is intended for reference  * only.  * END_BLOCK  *   * $FreeBSD$  ******************************************************************************/
end_comment

begin_include
include|#
directive|include
file|"at91rm9200.h"
end_include

begin_include
include|#
directive|include
file|"at91rm9200_lowlevel.h"
end_include

begin_include
include|#
directive|include
file|"emac.h"
end_include

begin_include
include|#
directive|include
file|"lib.h"
end_include

begin_comment
comment|/* ****************************** GLOBALS *************************************/
end_comment

begin_comment
comment|/* ********************** PRIVATE FUNCTIONS/DATA ******************************/
end_comment

begin_decl_stmt
specifier|static
name|receive_descriptor_t
modifier|*
name|p_rxBD
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|short
name|localPort
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|short
name|serverPort
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|serverMACSet
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|localIPSet
decl_stmt|,
name|serverIPSet
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|lastSize
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|char
name|serverMACAddr
index|[
literal|6
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|char
name|localIPAddr
index|[
literal|4
index|]
decl_stmt|,
name|serverIPAddr
index|[
literal|4
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|ackBlock
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|dlAddress
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|transmitBuffer
index|[
literal|1024
operator|/
sizeof|sizeof
argument_list|(
name|unsigned
argument_list|)
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|tftpSendPacket
index|[
literal|256
operator|/
sizeof|sizeof
argument_list|(
name|unsigned
argument_list|)
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * .KB_C_FN_DEFINITION_START  * unsigned short IP_checksum(unsigned short *p, int len)  *  This private function calculates the IP checksum for various headers.  * .KB_C_FN_DEFINITION_END  */
end_comment

begin_function
specifier|static
name|unsigned
name|short
name|IP_checksum
parameter_list|(
name|unsigned
name|short
modifier|*
name|p
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|unsigned
name|i
decl_stmt|,
name|t
decl_stmt|;
name|len
operator|&=
operator|~
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|t
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|+=
literal|2
operator|,
operator|++
name|p
control|)
name|t
operator|+=
name|SWAP16
argument_list|(
operator|*
name|p
argument_list|)
expr_stmt|;
name|t
operator|=
operator|(
name|t
operator|&
literal|0xffff
operator|)
operator|+
operator|(
name|t
operator|>>
literal|16
operator|)
expr_stmt|;
return|return
operator|(
operator|~
name|t
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * .KB_C_FN_DEFINITION_START  * void GetServerAddress(void)  *  This private function sends an ARP request to determine the server MAC.  * .KB_C_FN_DEFINITION_END  */
end_comment

begin_function
specifier|static
name|void
name|GetServerAddress
parameter_list|(
name|void
parameter_list|)
block|{
name|arp_header_t
modifier|*
name|p_ARP
decl_stmt|;
name|p_ARP
operator|=
operator|(
name|arp_header_t
operator|*
operator|)
name|transmitBuffer
expr_stmt|;
name|p_memset
argument_list|(
operator|(
name|char
operator|*
operator|)
name|p_ARP
operator|->
name|dest_mac
argument_list|,
literal|0xFF
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|p_ARP
operator|->
name|src_mac
argument_list|,
name|localMACAddr
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|p_ARP
operator|->
name|frame_type
operator|=
name|SWAP16
argument_list|(
name|PROTOCOL_ARP
argument_list|)
expr_stmt|;
name|p_ARP
operator|->
name|hard_type
operator|=
name|SWAP16
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|p_ARP
operator|->
name|prot_type
operator|=
name|SWAP16
argument_list|(
name|PROTOCOL_IP
argument_list|)
expr_stmt|;
name|p_ARP
operator|->
name|hard_size
operator|=
literal|6
expr_stmt|;
name|p_ARP
operator|->
name|prot_size
operator|=
literal|4
expr_stmt|;
name|p_ARP
operator|->
name|operation
operator|=
name|SWAP16
argument_list|(
name|ARP_REQUEST
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|p_ARP
operator|->
name|sender_mac
argument_list|,
name|localMACAddr
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|p_ARP
operator|->
name|sender_ip
argument_list|,
name|localIPAddr
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|p_memset
argument_list|(
operator|(
name|char
operator|*
operator|)
name|p_ARP
operator|->
name|target_mac
argument_list|,
literal|0
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|p_ARP
operator|->
name|target_ip
argument_list|,
name|serverIPAddr
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|// wait until transmit is available
while|while
condition|(
operator|!
operator|(
operator|*
name|AT91C_EMAC_TSR
operator|&
name|AT91C_EMAC_BNQ
operator|)
condition|)
empty_stmt|;
operator|*
name|AT91C_EMAC_TSR
operator||=
name|AT91C_EMAC_COMP
expr_stmt|;
operator|*
name|AT91C_EMAC_TAR
operator|=
operator|(
name|unsigned
operator|)
name|transmitBuffer
expr_stmt|;
operator|*
name|AT91C_EMAC_TCR
operator|=
literal|0x40
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * .KB_C_FN_DEFINITION_START  * void Send_TFTP_Packet(char *tftpData, unsigned tftpLength)  *  This private function initializes and send a TFTP packet.  * .KB_C_FN_DEFINITION_END  */
end_comment

begin_function
specifier|static
name|void
name|Send_TFTP_Packet
parameter_list|(
name|char
modifier|*
name|tftpData
parameter_list|,
name|unsigned
name|tftpLength
parameter_list|)
block|{
name|transmit_header_t
modifier|*
name|macHdr
init|=
operator|(
name|transmit_header_t
operator|*
operator|)
name|tftpSendPacket
decl_stmt|;
name|ip_header_t
modifier|*
name|ipHdr
decl_stmt|;
name|udp_header_t
modifier|*
name|udpHdr
decl_stmt|;
name|unsigned
name|t_checksum
decl_stmt|;
name|memcpy
argument_list|(
name|macHdr
operator|->
name|dest_mac
argument_list|,
name|serverMACAddr
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|macHdr
operator|->
name|src_mac
argument_list|,
name|localMACAddr
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|macHdr
operator|->
name|proto_mac
operator|=
name|SWAP16
argument_list|(
name|PROTOCOL_IP
argument_list|)
expr_stmt|;
name|ipHdr
operator|=
operator|(
name|ip_header_t
operator|*
operator|)
operator|&
name|macHdr
operator|->
name|packet_length
expr_stmt|;
name|ipHdr
operator|->
name|ip_v_hl
operator|=
literal|0x45
expr_stmt|;
name|ipHdr
operator|->
name|ip_tos
operator|=
literal|0
expr_stmt|;
name|ipHdr
operator|->
name|ip_len
operator|=
name|SWAP16
argument_list|(
literal|28
operator|+
name|tftpLength
argument_list|)
expr_stmt|;
name|ipHdr
operator|->
name|ip_id
operator|=
literal|0
expr_stmt|;
name|ipHdr
operator|->
name|ip_off
operator|=
name|SWAP16
argument_list|(
literal|0x4000
argument_list|)
expr_stmt|;
name|ipHdr
operator|->
name|ip_ttl
operator|=
literal|64
expr_stmt|;
name|ipHdr
operator|->
name|ip_p
operator|=
name|PROTOCOL_UDP
expr_stmt|;
name|ipHdr
operator|->
name|ip_sum
operator|=
literal|0
expr_stmt|;
name|memcpy
argument_list|(
name|ipHdr
operator|->
name|ip_src
argument_list|,
name|localIPAddr
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|ipHdr
operator|->
name|ip_dst
argument_list|,
name|serverIPAddr
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|ipHdr
operator|->
name|ip_sum
operator|=
name|SWAP16
argument_list|(
name|IP_checksum
argument_list|(
operator|(
name|unsigned
name|short
operator|*
operator|)
name|ipHdr
argument_list|,
literal|20
argument_list|)
argument_list|)
expr_stmt|;
name|udpHdr
operator|=
operator|(
name|udp_header_t
operator|*
operator|)
operator|(
name|ipHdr
operator|+
literal|1
operator|)
expr_stmt|;
name|udpHdr
operator|->
name|src_port
operator|=
name|localPort
expr_stmt|;
name|udpHdr
operator|->
name|dst_port
operator|=
name|serverPort
expr_stmt|;
name|udpHdr
operator|->
name|udp_len
operator|=
name|SWAP16
argument_list|(
literal|8
operator|+
name|tftpLength
argument_list|)
expr_stmt|;
name|udpHdr
operator|->
name|udp_cksum
operator|=
literal|0
expr_stmt|;
name|memcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|udpHdr
operator|+
literal|8
argument_list|,
name|tftpData
argument_list|,
name|tftpLength
argument_list|)
expr_stmt|;
name|t_checksum
operator|=
name|IP_checksum
argument_list|(
operator|(
name|unsigned
name|short
operator|*
operator|)
name|ipHdr
operator|+
literal|6
argument_list|,
operator|(
literal|16
operator|+
name|tftpLength
operator|)
argument_list|)
expr_stmt|;
name|t_checksum
operator|=
operator|(
operator|~
name|t_checksum
operator|)
operator|&
literal|0xFFFF
expr_stmt|;
name|t_checksum
operator|+=
literal|25
operator|+
name|tftpLength
expr_stmt|;
name|t_checksum
operator|=
operator|(
name|t_checksum
operator|&
literal|0xffff
operator|)
operator|+
operator|(
name|t_checksum
operator|>>
literal|16
operator|)
expr_stmt|;
name|t_checksum
operator|=
operator|(
operator|~
name|t_checksum
operator|)
operator|&
literal|0xFFFF
expr_stmt|;
name|udpHdr
operator|->
name|udp_cksum
operator|=
name|SWAP16
argument_list|(
name|t_checksum
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
operator|(
operator|*
name|AT91C_EMAC_TSR
operator|&
name|AT91C_EMAC_BNQ
operator|)
condition|)
empty_stmt|;
operator|*
name|AT91C_EMAC_TSR
operator||=
name|AT91C_EMAC_COMP
expr_stmt|;
operator|*
name|AT91C_EMAC_TAR
operator|=
operator|(
name|unsigned
operator|)
name|tftpSendPacket
expr_stmt|;
operator|*
name|AT91C_EMAC_TCR
operator|=
literal|42
operator|+
name|tftpLength
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * .KB_C_FN_DEFINITION_START  * void TFTP_RequestFile(char *filename)  *  This private function sends a RRQ packet to the server.  * .KB_C_FN_DEFINITION_END  */
end_comment

begin_function
specifier|static
name|void
name|TFTP_RequestFile
parameter_list|(
name|char
modifier|*
name|filename
parameter_list|)
block|{
name|tftp_header_t
name|tftpHeader
decl_stmt|;
name|char
modifier|*
name|cPtr
decl_stmt|,
modifier|*
name|ePtr
decl_stmt|,
modifier|*
name|mPtr
decl_stmt|;
name|unsigned
name|length
decl_stmt|;
name|tftpHeader
operator|.
name|opcode
operator|=
name|TFTP_RRQ_OPCODE
expr_stmt|;
name|cPtr
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
operator|(
name|tftpHeader
operator|.
name|block_num
operator|)
expr_stmt|;
name|ePtr
operator|=
name|strcpy
argument_list|(
name|cPtr
argument_list|,
name|filename
argument_list|)
expr_stmt|;
name|mPtr
operator|=
name|strcpy
argument_list|(
name|ePtr
argument_list|,
literal|"octet"
argument_list|)
expr_stmt|;
name|length
operator|=
name|mPtr
operator|-
name|cPtr
expr_stmt|;
name|length
operator|+=
literal|2
expr_stmt|;
name|Send_TFTP_Packet
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|tftpHeader
argument_list|,
name|length
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * .KB_C_FN_DEFINITION_START  * void TFTP_ACK_Data(char *data, unsigned short block_num, unsigned short len)  *  This private function sends an ACK packet to the server.  * .KB_C_FN_DEFINITION_END  */
end_comment

begin_function
specifier|static
name|void
name|TFTP_ACK_Data
parameter_list|(
name|char
modifier|*
name|data
parameter_list|,
name|unsigned
name|short
name|block_num
parameter_list|,
name|unsigned
name|short
name|len
parameter_list|)
block|{
name|tftp_header_t
name|tftpHeader
decl_stmt|;
if|if
condition|(
name|block_num
operator|==
operator|(
name|ackBlock
operator|+
literal|1
operator|)
condition|)
block|{
operator|++
name|ackBlock
expr_stmt|;
name|memcpy
argument_list|(
name|dlAddress
argument_list|,
name|data
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|dlAddress
operator|+=
name|len
expr_stmt|;
name|lastSize
operator|+=
name|len
expr_stmt|;
if|if
condition|(
name|ackBlock
operator|%
literal|128
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"tftp: %u kB\r"
argument_list|,
name|lastSize
operator|/
literal|1024
argument_list|)
expr_stmt|;
block|}
name|tftpHeader
operator|.
name|opcode
operator|=
name|TFTP_ACK_OPCODE
expr_stmt|;
name|tftpHeader
operator|.
name|block_num
operator|=
name|SWAP16
argument_list|(
name|ackBlock
argument_list|)
expr_stmt|;
name|Send_TFTP_Packet
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|tftpHeader
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|512
condition|)
block|{
name|ackBlock
operator|=
operator|-
literal|2
expr_stmt|;
name|printf
argument_list|(
literal|"tftp: %u byte\n"
argument_list|,
name|lastSize
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * .KB_C_FN_DEFINITION_START  * void CheckForNewPacket(ip_header_t *pHeader)  *  This private function polls for received ethernet packets and handles  * any here.  * .KB_C_FN_DEFINITION_END  */
end_comment

begin_function
specifier|static
name|int
name|CheckForNewPacket
parameter_list|(
name|ip_header_t
modifier|*
name|pHeader
parameter_list|)
block|{
name|unsigned
name|short
modifier|*
name|pFrameType
decl_stmt|;
name|unsigned
name|i
decl_stmt|;
name|char
modifier|*
name|pData
decl_stmt|;
name|ip_header_t
modifier|*
name|pIpHeader
decl_stmt|;
name|arp_header_t
modifier|*
name|p_ARP
decl_stmt|;
name|int
name|process
init|=
literal|0
decl_stmt|;
name|process
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_RX_PACKETS
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|p_rxBD
index|[
name|i
index|]
operator|.
name|address
operator|&
literal|0x1
condition|)
block|{
name|process
operator|=
literal|1
expr_stmt|;
operator|(
operator|*
name|AT91C_EMAC_RSR
operator|)
operator||=
operator|(
operator|*
name|AT91C_EMAC_RSR
operator|)
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
operator|!
name|process
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|process
operator|=
name|i
expr_stmt|;
name|pFrameType
operator|=
operator|(
name|unsigned
name|short
operator|*
operator|)
operator|(
operator|(
name|p_rxBD
index|[
name|i
index|]
operator|.
name|address
operator|&
literal|0xFFFFFFFC
operator|)
operator|+
literal|12
operator|)
expr_stmt|;
name|pData
operator|=
operator|(
name|char
operator|*
operator|)
operator|(
name|p_rxBD
index|[
name|i
index|]
operator|.
name|address
operator|&
literal|0xFFFFFFFC
operator|)
expr_stmt|;
switch|switch
condition|(
operator|*
name|pFrameType
condition|)
block|{
case|case
name|SWAP16
argument_list|(
name|PROTOCOL_ARP
argument_list|)
case|:
name|p_ARP
operator|=
operator|(
name|arp_header_t
operator|*
operator|)
name|pData
expr_stmt|;
if|if
condition|(
name|p_ARP
operator|->
name|operation
operator|==
name|SWAP16
argument_list|(
name|ARP_REPLY
argument_list|)
condition|)
block|{
comment|// check if new server info is available
if|if
condition|(
operator|(
operator|!
name|serverMACSet
operator|)
operator|&&
operator|(
operator|!
operator|(
name|p_memcmp
argument_list|(
operator|(
name|char
operator|*
operator|)
name|p_ARP
operator|->
name|sender_ip
argument_list|,
operator|(
name|char
operator|*
operator|)
name|serverIPAddr
argument_list|,
literal|4
argument_list|)
operator|)
operator|)
condition|)
block|{
name|serverMACSet
operator|=
literal|1
expr_stmt|;
name|memcpy
argument_list|(
name|serverMACAddr
argument_list|,
name|p_ARP
operator|->
name|sender_mac
argument_list|,
literal|6
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|p_ARP
operator|->
name|operation
operator|==
name|SWAP16
argument_list|(
name|ARP_REQUEST
argument_list|)
condition|)
block|{
comment|// ARP REPLY operation
name|p_ARP
operator|->
name|operation
operator|=
name|SWAP16
argument_list|(
name|ARP_REPLY
argument_list|)
expr_stmt|;
comment|// Fill the dest address and src address
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|6
condition|;
name|i
operator|++
control|)
block|{
comment|// swap ethernet dest address and ethernet src address
name|pData
index|[
name|i
index|]
operator|=
name|pData
index|[
name|i
operator|+
literal|6
index|]
expr_stmt|;
name|pData
index|[
name|i
operator|+
literal|6
index|]
operator|=
name|localMACAddr
index|[
name|i
index|]
expr_stmt|;
comment|// swap sender ethernet address and target ethernet address
name|pData
index|[
name|i
operator|+
literal|22
index|]
operator|=
name|localMACAddr
index|[
name|i
index|]
expr_stmt|;
name|pData
index|[
name|i
operator|+
literal|32
index|]
operator|=
name|pData
index|[
name|i
operator|+
literal|6
index|]
expr_stmt|;
block|}
comment|// swap sender IP address and target IP address
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
name|pData
index|[
name|i
operator|+
literal|38
index|]
operator|=
name|pData
index|[
name|i
operator|+
literal|28
index|]
expr_stmt|;
name|pData
index|[
name|i
operator|+
literal|28
index|]
operator|=
name|localIPAddr
index|[
name|i
index|]
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|(
operator|*
name|AT91C_EMAC_TSR
operator|&
name|AT91C_EMAC_BNQ
operator|)
condition|)
break|break;
operator|*
name|AT91C_EMAC_TSR
operator||=
name|AT91C_EMAC_COMP
expr_stmt|;
operator|*
name|AT91C_EMAC_TAR
operator|=
operator|(
name|unsigned
operator|)
name|pData
expr_stmt|;
operator|*
name|AT91C_EMAC_TCR
operator|=
literal|0x40
expr_stmt|;
block|}
break|break;
case|case
name|SWAP16
argument_list|(
name|PROTOCOL_IP
argument_list|)
case|:
name|pIpHeader
operator|=
operator|(
name|ip_header_t
operator|*
operator|)
operator|(
name|pData
operator|+
literal|14
operator|)
expr_stmt|;
name|memcpy
argument_list|(
name|pHeader
argument_list|,
name|pIpHeader
argument_list|,
sizeof|sizeof
argument_list|(
name|ip_header_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pIpHeader
operator|->
name|ip_p
operator|==
name|PROTOCOL_UDP
condition|)
block|{
name|udp_header_t
modifier|*
name|udpHdr
decl_stmt|;
name|tftp_header_t
modifier|*
name|tftpHdr
decl_stmt|;
name|udpHdr
operator|=
operator|(
name|udp_header_t
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|pIpHeader
operator|+
literal|20
operator|)
expr_stmt|;
name|tftpHdr
operator|=
operator|(
name|tftp_header_t
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|udpHdr
operator|+
literal|8
operator|)
expr_stmt|;
if|if
condition|(
name|udpHdr
operator|->
name|dst_port
operator|!=
name|localPort
condition|)
break|break;
if|if
condition|(
name|tftpHdr
operator|->
name|opcode
operator|!=
name|TFTP_DATA_OPCODE
condition|)
break|break;
if|if
condition|(
name|ackBlock
operator|==
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|tftpHdr
operator|->
name|block_num
operator|!=
name|SWAP16
argument_list|(
literal|1
argument_list|)
condition|)
break|break;
name|serverPort
operator|=
name|udpHdr
operator|->
name|src_port
expr_stmt|;
name|ackBlock
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|serverPort
operator|!=
name|udpHdr
operator|->
name|src_port
condition|)
break|break;
name|TFTP_ACK_Data
argument_list|(
name|tftpHdr
operator|->
name|data
argument_list|,
name|SWAP16
argument_list|(
name|tftpHdr
operator|->
name|block_num
argument_list|)
argument_list|,
name|SWAP16
argument_list|(
name|udpHdr
operator|->
name|udp_len
argument_list|)
operator|-
literal|12
argument_list|)
expr_stmt|;
block|}
block|}
name|p_rxBD
index|[
name|process
index|]
operator|.
name|address
operator|&=
operator|~
literal|0x01
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * .KB_C_FN_DEFINITION_START  * unsigned short AT91F_MII_ReadPhy (AT91PS_EMAC pEmac, unsigned char addr)  *  This private function reads the PHY device.  * .KB_C_FN_DEFINITION_END  */
end_comment

begin_function
specifier|static
name|unsigned
name|short
name|AT91F_MII_ReadPhy
parameter_list|(
name|AT91PS_EMAC
name|pEmac
parameter_list|,
name|unsigned
name|char
name|addr
parameter_list|)
block|{
name|unsigned
name|value
init|=
literal|0x60020000
operator||
operator|(
name|addr
operator|<<
literal|18
operator|)
decl_stmt|;
name|pEmac
operator|->
name|EMAC_CTL
operator||=
name|AT91C_EMAC_MPE
expr_stmt|;
name|pEmac
operator|->
name|EMAC_MAN
operator|=
name|value
expr_stmt|;
while|while
condition|(
operator|!
operator|(
operator|(
name|pEmac
operator|->
name|EMAC_SR
operator|)
operator|&
name|AT91C_EMAC_IDLE
operator|)
condition|)
empty_stmt|;
name|pEmac
operator|->
name|EMAC_CTL
operator|&=
operator|~
name|AT91C_EMAC_MPE
expr_stmt|;
return|return
operator|(
name|pEmac
operator|->
name|EMAC_MAN
operator|&
literal|0x0000ffff
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * .KB_C_FN_DEFINITION_START  * unsigned short AT91F_MII_ReadPhy (AT91PS_EMAC pEmac, unsigned char addr)  *  This private function reads the PHY device.  * .KB_C_FN_DEFINITION_END  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|BOOT_TSC
end_ifdef

begin_function
specifier|static
name|unsigned
name|short
name|AT91F_MII_WritePhy
parameter_list|(
name|AT91PS_EMAC
name|pEmac
parameter_list|,
name|unsigned
name|char
name|addr
parameter_list|,
name|unsigned
name|short
name|s
parameter_list|)
block|{
name|unsigned
name|value
init|=
literal|0x50020000
operator||
operator|(
name|addr
operator|<<
literal|18
operator|)
operator||
name|s
decl_stmt|;
name|pEmac
operator|->
name|EMAC_CTL
operator||=
name|AT91C_EMAC_MPE
expr_stmt|;
name|pEmac
operator|->
name|EMAC_MAN
operator|=
name|value
expr_stmt|;
while|while
condition|(
operator|!
operator|(
operator|(
name|pEmac
operator|->
name|EMAC_SR
operator|)
operator|&
name|AT91C_EMAC_IDLE
operator|)
condition|)
empty_stmt|;
name|pEmac
operator|->
name|EMAC_CTL
operator|&=
operator|~
name|AT91C_EMAC_MPE
expr_stmt|;
return|return
operator|(
name|pEmac
operator|->
name|EMAC_MAN
operator|&
literal|0x0000ffff
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * .KB_C_FN_DEFINITION_START  * void MII_GetLinkSpeed(AT91PS_EMAC pEmac)  *  This private function determines the link speed set by the PHY.  * .KB_C_FN_DEFINITION_END  */
end_comment

begin_function
specifier|static
name|void
name|MII_GetLinkSpeed
parameter_list|(
name|AT91PS_EMAC
name|pEmac
parameter_list|)
block|{
name|unsigned
name|short
name|stat2
decl_stmt|;
name|unsigned
name|update
decl_stmt|;
ifdef|#
directive|ifdef
name|BOOT_TSC
name|unsigned
name|sec
decl_stmt|;
name|int
name|i
decl_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|BOOT_KB9202
name|stat2
operator|=
name|AT91F_MII_ReadPhy
argument_list|(
name|pEmac
argument_list|,
name|MII_STS2_REG
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|stat2
operator|&
name|MII_STS2_LINK
operator|)
condition|)
return|return ;
name|update
operator|=
name|pEmac
operator|->
name|EMAC_CFG
operator|&
operator|~
operator|(
name|AT91C_EMAC_SPD
operator||
name|AT91C_EMAC_FD
operator|)
expr_stmt|;
if|if
condition|(
name|stat2
operator|&
name|MII_STS2_100TX
condition|)
name|update
operator||=
name|AT91C_EMAC_SPD
expr_stmt|;
if|if
condition|(
name|stat2
operator|&
name|MII_STS2_FDX
condition|)
name|update
operator||=
name|AT91C_EMAC_FD
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|BOOT_TSC
while|while
condition|(
literal|1
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|10
condition|;
name|i
operator|++
control|)
block|{
name|stat2
operator|=
name|AT91F_MII_ReadPhy
argument_list|(
name|pEmac
argument_list|,
name|MII_STS_REG
argument_list|)
expr_stmt|;
if|if
condition|(
name|stat2
operator|&
name|MII_STS_LINK_STAT
condition|)
break|break;
name|printf
argument_list|(
literal|"."
argument_list|)
expr_stmt|;
name|sec
operator|=
name|GetSeconds
argument_list|()
expr_stmt|;
while|while
condition|(
name|GetSeconds
argument_list|()
operator|<=
name|sec
condition|)
continue|continue;
block|}
if|if
condition|(
name|stat2
operator|&
name|MII_STS_LINK_STAT
condition|)
break|break;
name|printf
argument_list|(
literal|"Resetting MII..."
argument_list|)
expr_stmt|;
name|AT91F_MII_WritePhy
argument_list|(
name|pEmac
argument_list|,
literal|0x0
argument_list|,
literal|0x8000
argument_list|)
expr_stmt|;
while|while
condition|(
name|AT91F_MII_ReadPhy
argument_list|(
name|pEmac
argument_list|,
literal|0x0
argument_list|)
operator|&
literal|0x8000
condition|)
continue|continue;
block|}
name|printf
argument_list|(
literal|"emac: link"
argument_list|)
expr_stmt|;
name|stat2
operator|=
name|AT91F_MII_ReadPhy
argument_list|(
name|pEmac
argument_list|,
name|MII_SPEC_STS_REG
argument_list|)
expr_stmt|;
name|update
operator|=
name|pEmac
operator|->
name|EMAC_CFG
operator|&
operator|~
operator|(
name|AT91C_EMAC_SPD
operator||
name|AT91C_EMAC_FD
operator|)
expr_stmt|;
if|if
condition|(
name|stat2
operator|&
operator|(
name|MII_SSTS_100FDX
operator||
name|MII_SSTS_100HDX
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|" 100TX"
argument_list|)
expr_stmt|;
name|update
operator||=
name|AT91C_EMAC_SPD
expr_stmt|;
block|}
if|if
condition|(
name|stat2
operator|&
operator|(
name|MII_SSTS_100FDX
operator||
name|MII_SSTS_10FDX
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|" FDX"
argument_list|)
expr_stmt|;
name|update
operator||=
name|AT91C_EMAC_FD
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pEmac
operator|->
name|EMAC_CFG
operator|=
name|update
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * .KB_C_FN_DEFINITION_START  * void AT91F_EmacEntry(void)  *  This private function initializes the EMAC on the chip.  * .KB_C_FN_DEFINITION_END  */
end_comment

begin_function
specifier|static
name|void
name|AT91F_EmacEntry
parameter_list|(
name|void
parameter_list|)
block|{
name|unsigned
name|i
decl_stmt|;
name|char
modifier|*
name|pRxPacket
init|=
operator|(
name|char
operator|*
operator|)
name|RX_DATA_START
decl_stmt|;
name|AT91PS_EMAC
name|pEmac
init|=
name|AT91C_BASE_EMAC
decl_stmt|;
name|p_rxBD
operator|=
operator|(
name|receive_descriptor_t
operator|*
operator|)
name|RX_BUFFER_START
expr_stmt|;
name|localPort
operator|=
name|SWAP16
argument_list|(
literal|0x8002
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_RX_PACKETS
condition|;
operator|++
name|i
control|)
block|{
name|p_rxBD
index|[
name|i
index|]
operator|.
name|address
operator|=
operator|(
name|unsigned
operator|)
name|pRxPacket
expr_stmt|;
name|p_rxBD
index|[
name|i
index|]
operator|.
name|size
operator|=
literal|0
expr_stmt|;
name|pRxPacket
operator|+=
name|RX_PACKET_SIZE
expr_stmt|;
block|}
comment|// Set the WRAP bit at the end of the list descriptor
name|p_rxBD
index|[
name|MAX_RX_PACKETS
operator|-
literal|1
index|]
operator|.
name|address
operator||=
literal|0x02
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|pEmac
operator|->
name|EMAC_SR
operator|&
name|AT91C_EMAC_LINK
operator|)
condition|)
name|MII_GetLinkSpeed
argument_list|(
name|pEmac
argument_list|)
expr_stmt|;
name|pEmac
operator|->
name|EMAC_RBQP
operator|=
operator|(
name|unsigned
operator|)
name|p_rxBD
expr_stmt|;
name|pEmac
operator|->
name|EMAC_RSR
operator||=
operator|(
name|AT91C_EMAC_OVR
operator||
name|AT91C_EMAC_REC
operator||
name|AT91C_EMAC_BNA
operator|)
expr_stmt|;
name|pEmac
operator|->
name|EMAC_CTL
operator|=
name|AT91C_EMAC_TE
operator||
name|AT91C_EMAC_RE
expr_stmt|;
name|pEmac
operator|->
name|EMAC_TAR
operator|=
operator|(
name|unsigned
operator|)
name|transmitBuffer
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ************************** GLOBAL FUNCTIONS ********************************/
end_comment

begin_comment
comment|/*  * .KB_C_FN_DEFINITION_START  * void SetServerIPAddress(unsigned address)  *  This global function sets the IP of the TFTP download server.  * .KB_C_FN_DEFINITION_END  */
end_comment

begin_function
name|void
name|SetServerIPAddress
parameter_list|(
name|unsigned
name|address
parameter_list|)
block|{
comment|// force update in case the IP has changed
name|serverMACSet
operator|=
literal|0
expr_stmt|;
name|serverIPAddr
index|[
literal|0
index|]
operator|=
operator|(
name|address
operator|>>
literal|24
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|serverIPAddr
index|[
literal|1
index|]
operator|=
operator|(
name|address
operator|>>
literal|16
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|serverIPAddr
index|[
literal|2
index|]
operator|=
operator|(
name|address
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|serverIPAddr
index|[
literal|3
index|]
operator|=
operator|(
name|address
operator|>>
literal|0
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|serverIPSet
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * .KB_C_FN_DEFINITION_START  * void SetLocalIPAddress(unsigned address)  *  This global function sets the IP of this module.  * .KB_C_FN_DEFINITION_END  */
end_comment

begin_function
name|void
name|SetLocalIPAddress
parameter_list|(
name|unsigned
name|address
parameter_list|)
block|{
comment|// force update in case the IP has changed
name|serverMACSet
operator|=
literal|0
expr_stmt|;
name|localIPAddr
index|[
literal|0
index|]
operator|=
operator|(
name|address
operator|>>
literal|24
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|localIPAddr
index|[
literal|1
index|]
operator|=
operator|(
name|address
operator|>>
literal|16
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|localIPAddr
index|[
literal|2
index|]
operator|=
operator|(
name|address
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|localIPAddr
index|[
literal|3
index|]
operator|=
operator|(
name|address
operator|>>
literal|0
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|localIPSet
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * .KB_C_FN_DEFINITION_START  * void TFTP_Download(unsigned address, char *filename)  *  This global function initiates and processes a tftp download request.  * The server IP, local IP, local MAC must be set before this function is  * executed.  * .KB_C_FN_DEFINITION_END  */
end_comment

begin_function
name|void
name|TFTP_Download
parameter_list|(
name|unsigned
name|address
parameter_list|,
name|char
modifier|*
name|filename
parameter_list|)
block|{
name|ip_header_t
name|IpHeader
decl_stmt|;
name|unsigned
name|thisSeconds
decl_stmt|;
name|int
name|timeout
decl_stmt|;
if|if
condition|(
operator|(
operator|!
name|localMACSet
operator|)
operator|||
operator|(
operator|!
name|localIPSet
operator|)
operator|||
operator|(
operator|!
name|serverIPSet
operator|)
condition|)
return|return ;
name|AT91F_EmacEntry
argument_list|()
expr_stmt|;
name|GetServerAddress
argument_list|()
expr_stmt|;
name|dlAddress
operator|=
operator|(
name|char
operator|*
operator|)
name|address
expr_stmt|;
name|lastSize
operator|=
literal|0
expr_stmt|;
name|timeout
operator|=
literal|10
expr_stmt|;
name|thisSeconds
operator|=
name|GetSeconds
argument_list|()
operator|+
literal|1
expr_stmt|;
name|serverPort
operator|=
name|SWAP16
argument_list|(
literal|69
argument_list|)
expr_stmt|;
operator|++
name|localPort
expr_stmt|;
name|ackBlock
operator|=
operator|-
literal|1
expr_stmt|;
while|while
condition|(
name|timeout
condition|)
block|{
if|if
condition|(
name|CheckForNewPacket
argument_list|(
operator|&
name|IpHeader
argument_list|)
condition|)
block|{
if|if
condition|(
name|ackBlock
operator|==
operator|-
literal|2
condition|)
break|break;
name|timeout
operator|=
literal|10
expr_stmt|;
name|thisSeconds
operator|=
name|GetSeconds
argument_list|()
operator|+
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|GetSeconds
argument_list|()
operator|>
name|thisSeconds
condition|)
block|{
operator|--
name|timeout
expr_stmt|;
name|thisSeconds
operator|=
name|GetSeconds
argument_list|()
operator|+
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|serverMACSet
condition|)
name|GetServerAddress
argument_list|()
expr_stmt|;
elseif|else
if|if
condition|(
name|ackBlock
operator|==
operator|-
literal|1
condition|)
name|TFTP_RequestFile
argument_list|(
name|filename
argument_list|)
expr_stmt|;
else|else
block|{
comment|// Be sure to send a NAK, which is done by
comment|// ACKing the last block we got.
name|TFTP_ACK_Data
argument_list|(
literal|0
argument_list|,
name|ackBlock
argument_list|,
literal|512
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\nNAK %u\n"
argument_list|,
name|ackBlock
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|timeout
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"TFTP TIMEOUT!\n"
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


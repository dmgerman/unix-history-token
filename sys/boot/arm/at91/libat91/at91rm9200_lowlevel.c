begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2006 M. Warner Losh.  All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  *  * This software is derived from software provide by Kwikbyte who specifically  * disclaimed copyright on the code.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|"at91rm9200.h"
end_include

begin_include
include|#
directive|include
file|"at91rm9200_lowlevel.h"
end_include

begin_decl_stmt
specifier|extern
name|int
name|__bss_start__
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|__bss_end__
index|[]
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|BAUD
value|115200
end_define

begin_define
define|#
directive|define
name|AT91C_US_ASYNC_MODE
value|(AT91C_US_USMODE_NORMAL | AT91C_US_NBSTOP_1_BIT | \ 		AT91C_US_PAR_NONE | AT91C_US_CHRL_8_BITS | AT91C_US_CLKS_CLOCK)
end_define

begin_comment
comment|/*  * void DefaultSystemInit(void)  *  Load the system with sane values based on how the system is configured.  *  at91rm9200_lowlevel.h is expected to define the necessary parameters.  */
end_comment

begin_function
name|void
name|_init
parameter_list|(
name|void
parameter_list|)
block|{
name|int
modifier|*
name|i
decl_stmt|;
name|AT91PS_USART
name|pUSART
init|=
operator|(
name|AT91PS_USART
operator|)
name|AT91C_BASE_DBGU
decl_stmt|;
name|AT91PS_PDC
name|pPDC
init|=
operator|(
name|AT91PS_PDC
operator|)
operator|&
operator|(
name|pUSART
operator|->
name|US_RPR
operator|)
decl_stmt|;
specifier|register
name|unsigned
name|value
decl_stmt|;
specifier|volatile
name|sdram_size_t
modifier|*
name|p
init|=
operator|(
name|sdram_size_t
operator|*
operator|)
name|SDRAM_BASE
decl_stmt|;
name|AT91C_BASE_ST
operator|->
name|ST_RTMR
operator|=
literal|1
expr_stmt|;
ifdef|#
directive|ifdef
name|BOOT_TSC
comment|// For the TSC board, we turn ON the one LED we have while
comment|// early in boot.
name|AT91C_BASE_PIOC
operator|->
name|PIO_PER
operator|=
name|AT91C_PIO_PC10
expr_stmt|;
name|AT91C_BASE_PIOC
operator|->
name|PIO_OER
operator|=
name|AT91C_PIO_PC10
expr_stmt|;
name|AT91C_BASE_PIOC
operator|->
name|PIO_CODR
operator|=
name|AT91C_PIO_PC10
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|BOOT_KB920X
name|AT91C_BASE_PIOC
operator|->
name|PIO_PER
operator|=
name|AT91C_PIO_PC18
operator||
name|AT91C_PIO_PC19
operator||
name|AT91C_PIO_PC20
expr_stmt|;
name|AT91C_BASE_PIOC
operator|->
name|PIO_OER
operator|=
name|AT91C_PIO_PC18
operator||
name|AT91C_PIO_PC19
operator||
name|AT91C_PIO_PC20
expr_stmt|;
name|AT91C_BASE_PIOC
operator|->
name|PIO_SODR
operator|=
name|AT91C_PIO_PC18
operator||
name|AT91C_PIO_PC19
operator||
name|AT91C_PIO_PC20
expr_stmt|;
name|AT91C_BASE_PIOC
operator|->
name|PIO_CODR
operator|=
name|AT91C_PIO_PC18
expr_stmt|;
endif|#
directive|endif
comment|// configure clocks
comment|// assume:
comment|//    main osc = 10Mhz
comment|//    PLLB configured for 96MHz (48MHz after div)
comment|//    CSS = PLLB
comment|// set PLLA = 180MHz
comment|// assume main osc = 10Mhz
comment|// div = 5 , out = 2 (150MHz = 240MHz)
name|value
operator|=
name|AT91C_BASE_CKGR
operator|->
name|CKGR_PLLAR
expr_stmt|;
name|value
operator|&=
operator|~
operator|(
name|AT91C_CKGR_DIVA
operator||
name|AT91C_CKGR_OUTA
operator||
name|AT91C_CKGR_MULA
operator|)
expr_stmt|;
name|value
operator||=
name|OSC_MAIN_FREQ_DIV
operator||
name|AT91C_CKGR_OUTA_2
operator||
name|AT91C_CKGR_SRCA
operator||
operator|(
operator|(
name|OSC_MAIN_MULT
operator|-
literal|1
operator|)
operator|<<
literal|16
operator|)
expr_stmt|;
name|AT91C_BASE_CKGR
operator|->
name|CKGR_PLLAR
operator|=
name|value
expr_stmt|;
comment|// wait for lock
while|while
condition|(
operator|!
operator|(
name|AT91C_BASE_PMC
operator|->
name|PMC_SR
operator|&
name|AT91C_PMC_LOCKA
operator|)
condition|)
continue|continue;
comment|// change divider = 3, pres = 1
name|value
operator|=
name|AT91C_BASE_PMC
operator|->
name|PMC_MCKR
expr_stmt|;
name|value
operator|&=
operator|~
operator|(
name|AT91C_PMC_MDIV
operator||
name|AT91C_PMC_PRES
operator|)
expr_stmt|;
name|value
operator||=
name|AT91C_PMC_MDIV_3
operator||
name|AT91C_PMC_PRES_CLK
expr_stmt|;
name|AT91C_BASE_PMC
operator|->
name|PMC_MCKR
operator|=
name|value
expr_stmt|;
comment|// wait for update
while|while
condition|(
operator|!
operator|(
name|AT91C_BASE_PMC
operator|->
name|PMC_SR
operator|&
name|AT91C_PMC_MCKRDY
operator|)
condition|)
continue|continue;
comment|// change CSS = PLLA
name|value
operator|&=
operator|~
name|AT91C_PMC_CSS
expr_stmt|;
name|value
operator||=
name|AT91C_PMC_CSS_PLLA_CLK
expr_stmt|;
name|AT91C_BASE_PMC
operator|->
name|PMC_MCKR
operator|=
name|value
expr_stmt|;
comment|// wait for update
while|while
condition|(
operator|!
operator|(
name|AT91C_BASE_PMC
operator|->
name|PMC_SR
operator|&
name|AT91C_PMC_MCKRDY
operator|)
condition|)
continue|continue;
ifdef|#
directive|ifdef
name|BOOT_KB920X
comment|// setup flash access (allow ample margin)
comment|// 9 wait states, 1 setup, 1 hold, 1 float for 8-bit device
operator|(
operator|(
name|AT91PS_SMC2
operator|)
name|AT91C_BASE_SMC2
operator|)
operator|->
name|SMC2_CSR
index|[
literal|0
index|]
operator|=
name|AT91C_SMC2_WSEN
operator||
operator|(
literal|9
operator|&
name|AT91C_SMC2_NWS
operator|)
operator||
operator|(
operator|(
literal|1
operator|<<
literal|8
operator|)
operator|&
name|AT91C_SMC2_TDF
operator|)
operator||
name|AT91C_SMC2_DBW_8
operator||
operator|(
operator|(
literal|1
operator|<<
literal|24
operator|)
operator|&
name|AT91C_SMC2_RWSETUP
operator|)
operator||
operator|(
operator|(
literal|1
operator|<<
literal|29
operator|)
operator|&
name|AT91C_SMC2_RWHOLD
operator|)
expr_stmt|;
endif|#
directive|endif
comment|// setup SDRAM access
comment|// EBI chip-select register (CS1 = SDRAM controller)
comment|// 9 col, 13row, 4 bank, CAS2
comment|// write recovery = 2 (Twr)
comment|// row cycle = 5 (Trc)
comment|// precharge delay = 2 (Trp)
comment|// row to col delay 2 (Trcd)
comment|// active to precharge = 4 (Tras)
comment|// exit self refresh to active = 6 (Txsr)
name|value
operator|=
operator|(
operator|(
name|AT91PS_EBI
operator|)
name|AT91C_BASE_EBI
operator|)
operator|->
name|EBI_CSA
expr_stmt|;
name|value
operator|&=
operator|~
name|AT91C_EBI_CS1A
expr_stmt|;
name|value
operator||=
name|AT91C_EBI_CS1A_SDRAMC
expr_stmt|;
name|AT91C_BASE_EBI
operator|->
name|EBI_CSA
operator|=
name|value
expr_stmt|;
name|AT91C_BASE_SDRC
operator|->
name|SDRC_CR
operator|=
name|AT91C_SDRC_NC_9
operator||
name|AT91C_SDRC_NR_13
operator||
name|AT91C_SDRC_NB_4_BANKS
operator||
name|AT91C_SDRC_CAS_2
operator||
operator|(
operator|(
literal|2
operator|<<
literal|7
operator|)
operator|&
name|AT91C_SDRC_TWR
operator|)
operator||
operator|(
operator|(
literal|5
operator|<<
literal|11
operator|)
operator|&
name|AT91C_SDRC_TRC
operator|)
operator||
operator|(
operator|(
literal|2
operator|<<
literal|15
operator|)
operator|&
name|AT91C_SDRC_TRP
operator|)
operator||
operator|(
operator|(
literal|2
operator|<<
literal|19
operator|)
operator|&
name|AT91C_SDRC_TRCD
operator|)
operator||
operator|(
operator|(
literal|4
operator|<<
literal|23
operator|)
operator|&
name|AT91C_SDRC_TRAS
operator|)
operator||
operator|(
operator|(
literal|6
operator|<<
literal|27
operator|)
operator|&
name|AT91C_SDRC_TXSR
operator|)
expr_stmt|;
comment|// Step 1: We assume 200us of idle time.
comment|// Step 2: Issue an all banks precharge command
name|AT91C_BASE_SDRC
operator|->
name|SDRC_MR
operator|=
name|SDRAM_WIDTH
operator||
name|AT91C_SDRC_MODE_PRCGALL_CMD
expr_stmt|;
operator|*
name|p
operator|=
literal|0
expr_stmt|;
comment|// Step 3: Issue 8 Auto-refresh (CBR) cycles
name|AT91C_BASE_SDRC
operator|->
name|SDRC_MR
operator|=
name|SDRAM_WIDTH
operator||
name|AT91C_SDRC_MODE_RFSH_CMD
expr_stmt|;
operator|*
name|p
operator|=
literal|0
expr_stmt|;
operator|*
name|p
operator|=
literal|0
expr_stmt|;
operator|*
name|p
operator|=
literal|0
expr_stmt|;
operator|*
name|p
operator|=
literal|0
expr_stmt|;
operator|*
name|p
operator|=
literal|0
expr_stmt|;
operator|*
name|p
operator|=
literal|0
expr_stmt|;
operator|*
name|p
operator|=
literal|0
expr_stmt|;
operator|*
name|p
operator|=
literal|0
expr_stmt|;
comment|// Step 4: Issue an Mode Set Register (MRS) cycle to program in
comment|// the parameters that we setup in the SDRC_CR register above.
name|AT91C_BASE_SDRC
operator|->
name|SDRC_MR
operator|=
name|SDRAM_WIDTH
operator||
name|AT91C_SDRC_MODE_LMR_CMD
expr_stmt|;
operator|*
name|p
operator|=
literal|0
expr_stmt|;
comment|// Step 5: set the refresh timer and access memory to start it
comment|// running.  We have to wait 3 clocks after the LMR_CMD above,
comment|// and this fits the bill nicely.
name|AT91C_BASE_SDRC
operator|->
name|SDRC_TR
operator|=
literal|7
operator|*
name|AT91C_MASTER_CLOCK
operator|/
literal|1000000
expr_stmt|;
operator|*
name|p
operator|=
literal|0
expr_stmt|;
comment|// Step 6: Set normal mode.
name|AT91C_BASE_SDRC
operator|->
name|SDRC_MR
operator|=
name|SDRAM_WIDTH
operator||
name|AT91C_SDRC_MODE_NORMAL_CMD
expr_stmt|;
operator|*
name|p
operator|=
literal|0
expr_stmt|;
if|#
directive|if
name|SDRAM_WIDTH
operator|==
name|AT91C_SDRC_DBW_32_BITS
comment|// Turn on the upper 16 bits on the SDRAM bus.
name|AT91C_BASE_PIOC
operator|->
name|PIO_ASR
operator|=
literal|0xffff0000
expr_stmt|;
name|AT91C_BASE_PIOC
operator|->
name|PIO_PDR
operator|=
literal|0xffff0000
expr_stmt|;
endif|#
directive|endif
comment|// Configure DBGU -use local routine optimized for space
name|AT91C_BASE_PIOA
operator|->
name|PIO_ASR
operator|=
name|AT91C_PA31_DTXD
operator||
name|AT91C_PA30_DRXD
expr_stmt|;
name|AT91C_BASE_PIOA
operator|->
name|PIO_PDR
operator|=
name|AT91C_PA31_DTXD
operator||
name|AT91C_PA30_DRXD
expr_stmt|;
name|pUSART
operator|->
name|US_IDR
operator|=
operator|(
name|unsigned
name|int
operator|)
operator|-
literal|1
expr_stmt|;
name|pUSART
operator|->
name|US_CR
operator|=
name|AT91C_US_RSTRX
operator||
name|AT91C_US_RSTTX
operator||
name|AT91C_US_RXDIS
operator||
name|AT91C_US_TXDIS
expr_stmt|;
name|pUSART
operator|->
name|US_BRGR
operator|=
operator|(
operator|(
operator|(
operator|(
name|AT91C_MASTER_CLOCK
operator|*
literal|10
operator|)
operator|/
operator|(
name|BAUD
operator|*
literal|16
operator|)
operator|)
operator|+
literal|5
operator|)
operator|/
literal|10
operator|)
expr_stmt|;
name|pUSART
operator|->
name|US_TTGR
operator|=
literal|0
expr_stmt|;
name|pPDC
operator|->
name|PDC_PTCR
operator|=
name|AT91C_PDC_RXTDIS
expr_stmt|;
name|pPDC
operator|->
name|PDC_PTCR
operator|=
name|AT91C_PDC_TXTDIS
expr_stmt|;
name|pPDC
operator|->
name|PDC_TNPR
operator|=
literal|0
expr_stmt|;
name|pPDC
operator|->
name|PDC_TNCR
operator|=
literal|0
expr_stmt|;
name|pPDC
operator|->
name|PDC_RNPR
operator|=
literal|0
expr_stmt|;
name|pPDC
operator|->
name|PDC_RNCR
operator|=
literal|0
expr_stmt|;
name|pPDC
operator|->
name|PDC_TPR
operator|=
literal|0
expr_stmt|;
name|pPDC
operator|->
name|PDC_TCR
operator|=
literal|0
expr_stmt|;
name|pPDC
operator|->
name|PDC_RPR
operator|=
literal|0
expr_stmt|;
name|pPDC
operator|->
name|PDC_RCR
operator|=
literal|0
expr_stmt|;
name|pPDC
operator|->
name|PDC_PTCR
operator|=
name|AT91C_PDC_RXTEN
expr_stmt|;
name|pPDC
operator|->
name|PDC_PTCR
operator|=
name|AT91C_PDC_TXTEN
expr_stmt|;
name|pUSART
operator|->
name|US_MR
operator|=
name|AT91C_US_ASYNC_MODE
expr_stmt|;
name|pUSART
operator|->
name|US_CR
operator|=
name|AT91C_US_TXEN
expr_stmt|;
name|pUSART
operator|->
name|US_CR
operator|=
name|AT91C_US_RXEN
expr_stmt|;
comment|/* Zero BSS now that we have memory setup */
name|i
operator|=
operator|(
name|int
operator|*
operator|)
name|__bss_start__
expr_stmt|;
while|while
condition|(
name|i
operator|<
operator|(
name|int
operator|*
operator|)
name|__bss_end__
condition|)
operator|*
name|i
operator|++
operator|=
literal|0
expr_stmt|;
block|}
end_function

end_unit


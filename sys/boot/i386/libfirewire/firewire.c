begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2004 Hidetoshi Shimokawa<simokawa@FreeBSD.ORG>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*  * FireWire disk device handling.  *   */
end_comment

begin_include
include|#
directive|include
file|<stand.h>
end_include

begin_include
include|#
directive|include
file|<machine/bootinfo.h>
end_include

begin_include
include|#
directive|include
file|<stdarg.h>
end_include

begin_include
include|#
directive|include
file|<bootstrap.h>
end_include

begin_include
include|#
directive|include
file|<btxv86.h>
end_include

begin_include
include|#
directive|include
file|<libi386.h>
end_include

begin_include
include|#
directive|include
file|"fwohci.h"
end_include

begin_include
include|#
directive|include
file|<dev/dcons/dcons.h>
end_include

begin_comment
comment|/* XXX */
end_comment

begin_define
define|#
directive|define
name|BIT4x2
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|)
value|uint8_t  y:4, x:4
end_define

begin_define
define|#
directive|define
name|BIT16x2
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|)
value|uint32_t y:16, x:16
end_define

begin_define
define|#
directive|define
name|_KERNEL
end_define

begin_include
include|#
directive|include
file|<dev/firewire/iec13213.h>
end_include

begin_decl_stmt
specifier|extern
name|uint32_t
name|dcons_paddr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|struct
name|console
name|dconsole
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|crom_src_buf
block|{
name|struct
name|crom_src
name|src
decl_stmt|;
name|struct
name|crom_chunk
name|root
decl_stmt|;
name|struct
name|crom_chunk
name|vendor
decl_stmt|;
name|struct
name|crom_chunk
name|hw
decl_stmt|;
comment|/* for dcons */
name|struct
name|crom_chunk
name|unit
decl_stmt|;
name|struct
name|crom_chunk
name|spec
decl_stmt|;
name|struct
name|crom_chunk
name|ver
decl_stmt|;
block|}
struct|;
end_struct

begin_function_decl
specifier|static
name|int
name|fw_init
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|fw_strategy
parameter_list|(
name|void
modifier|*
name|devdata
parameter_list|,
name|int
name|flag
parameter_list|,
name|daddr_t
name|dblk
parameter_list|,
name|size_t
name|offset
parameter_list|,
name|size_t
name|size
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
modifier|*
name|rsize
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|fw_open
parameter_list|(
name|struct
name|open_file
modifier|*
name|f
parameter_list|,
modifier|...
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|fw_close
parameter_list|(
name|struct
name|open_file
modifier|*
name|f
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|fw_print
parameter_list|(
name|int
name|verbose
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|fw_cleanup
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|fw_enable
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
name|struct
name|devsw
name|fwohci
init|=
block|{
literal|"FW1394"
block|,
comment|/* 7 chars at most */
name|DEVT_NET
block|,
name|fw_init
block|,
name|fw_strategy
block|,
name|fw_open
block|,
name|fw_close
block|,
name|noioctl
block|,
name|fw_print
block|,
name|fw_cleanup
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|fwohci_softc
name|fwinfo
index|[
name|MAX_OHCI
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|fw_initialized
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|fw_probe
parameter_list|(
name|int
name|index
parameter_list|,
name|struct
name|fwohci_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|sc
operator|->
name|state
operator|=
name|FWOHCI_STATE_INIT
expr_stmt|;
name|err
operator|=
name|biospci_find_devclass
argument_list|(
literal|0x0c0010
comment|/* Serial:FireWire:OHCI */
argument_list|,
name|index
comment|/* index */
argument_list|,
operator|&
name|sc
operator|->
name|locator
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
block|{
name|sc
operator|->
name|state
operator|=
name|FWOHCI_STATE_DEAD
expr_stmt|;
return|return;
block|}
name|biospci_write_config
argument_list|(
name|sc
operator|->
name|locator
argument_list|,
literal|0x4
comment|/* command */
argument_list|,
literal|0x6
comment|/* enable bus master and memory mapped I/O */
argument_list|,
literal|1
comment|/* word */
argument_list|)
expr_stmt|;
name|biospci_read_config
argument_list|(
name|sc
operator|->
name|locator
argument_list|,
literal|0x00
comment|/*devid*/
argument_list|,
literal|2
comment|/*dword*/
argument_list|,
operator|&
name|sc
operator|->
name|devid
argument_list|)
expr_stmt|;
name|biospci_read_config
argument_list|(
name|sc
operator|->
name|locator
argument_list|,
literal|0x10
comment|/*base_addr*/
argument_list|,
literal|2
comment|/*dword*/
argument_list|,
operator|&
name|sc
operator|->
name|base_addr
argument_list|)
expr_stmt|;
name|sc
operator|->
name|handle
operator|=
operator|(
name|uint32_t
operator|)
name|PTOV
argument_list|(
name|sc
operator|->
name|base_addr
argument_list|)
expr_stmt|;
name|sc
operator|->
name|bus_id
operator|=
name|OREAD
argument_list|(
name|sc
argument_list|,
name|OHCI_BUS_ID
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|fw_init
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|avail
decl_stmt|;
name|struct
name|fwohci_softc
modifier|*
name|sc
decl_stmt|;
if|if
condition|(
name|fw_initialized
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|avail
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_OHCI
condition|;
name|i
operator|++
control|)
block|{
name|sc
operator|=
operator|&
name|fwinfo
index|[
name|i
index|]
expr_stmt|;
name|fw_probe
argument_list|(
name|i
argument_list|,
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|state
operator|==
name|FWOHCI_STATE_DEAD
condition|)
break|break;
name|avail
operator|++
expr_stmt|;
break|break;
block|}
name|fw_initialized
operator|=
literal|1
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Print information about OHCI chips  */
end_comment

begin_function
specifier|static
name|int
name|fw_print
parameter_list|(
name|int
name|verbose
parameter_list|)
block|{
name|char
name|line
index|[
literal|80
index|]
decl_stmt|;
name|int
name|i
decl_stmt|,
name|ret
init|=
literal|0
decl_stmt|;
name|struct
name|fwohci_softc
modifier|*
name|sc
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_OHCI
condition|;
name|i
operator|++
control|)
block|{
name|sc
operator|=
operator|&
name|fwinfo
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|state
operator|==
name|FWOHCI_STATE_DEAD
condition|)
break|break;
name|snprintf
argument_list|(
name|line
argument_list|,
sizeof|sizeof
argument_list|(
name|line
argument_list|)
argument_list|,
literal|"%d: locator=0x%04x devid=0x%08x"
literal|" base_addr=0x%08x handle=0x%08x bus_id=0x%08x\n"
argument_list|,
name|i
argument_list|,
name|sc
operator|->
name|locator
argument_list|,
name|sc
operator|->
name|devid
argument_list|,
name|sc
operator|->
name|base_addr
argument_list|,
name|sc
operator|->
name|handle
argument_list|,
name|sc
operator|->
name|bus_id
argument_list|)
expr_stmt|;
name|ret
operator|=
name|pager_output
argument_list|(
name|line
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
break|break;
block|}
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|fw_open
parameter_list|(
name|struct
name|open_file
modifier|*
name|f
parameter_list|,
modifier|...
parameter_list|)
block|{
if|#
directive|if
literal|0
block|va_list			ap;     struct i386_devdesc		*dev;     struct open_disk		*od;     int				error;      va_start(ap, f);     dev = va_arg(ap, struct i386_devdesc *);     va_end(ap);
endif|#
directive|endif
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|fw_close
parameter_list|(
name|struct
name|open_file
modifier|*
name|f
parameter_list|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|fw_cleanup
parameter_list|()
block|{
name|struct
name|dcons_buf
modifier|*
name|db
decl_stmt|;
comment|/* invalidate dcons buffer */
if|if
condition|(
name|dcons_paddr
condition|)
block|{
name|db
operator|=
operator|(
expr|struct
name|dcons_buf
operator|*
operator|)
name|PTOV
argument_list|(
name|dcons_paddr
argument_list|)
expr_stmt|;
name|db
operator|->
name|magic
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|fw_strategy
parameter_list|(
name|void
modifier|*
name|devdata
parameter_list|,
name|int
name|rw
parameter_list|,
name|daddr_t
name|dblk
parameter_list|,
name|size_t
name|offset
parameter_list|,
name|size_t
name|size
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
modifier|*
name|rsize
parameter_list|)
block|{
return|return
operator|(
name|EIO
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|fw_init_crom
parameter_list|(
name|struct
name|fwohci_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|crom_src
modifier|*
name|src
decl_stmt|;
name|printf
argument_list|(
literal|"fw_init_crom\n"
argument_list|)
expr_stmt|;
name|sc
operator|->
name|crom_src_buf
operator|=
operator|(
expr|struct
name|crom_src_buf
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|crom_src_buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|crom_src_buf
operator|==
name|NULL
condition|)
return|return;
name|src
operator|=
operator|&
name|sc
operator|->
name|crom_src_buf
operator|->
name|src
expr_stmt|;
name|bzero
argument_list|(
name|src
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|crom_src
argument_list|)
argument_list|)
expr_stmt|;
comment|/* BUS info sample */
name|src
operator|->
name|hdr
operator|.
name|info_len
operator|=
literal|4
expr_stmt|;
name|src
operator|->
name|businfo
operator|.
name|bus_name
operator|=
name|CSR_BUS_NAME_IEEE1394
expr_stmt|;
name|src
operator|->
name|businfo
operator|.
name|irmc
operator|=
literal|1
expr_stmt|;
name|src
operator|->
name|businfo
operator|.
name|cmc
operator|=
literal|1
expr_stmt|;
name|src
operator|->
name|businfo
operator|.
name|isc
operator|=
literal|1
expr_stmt|;
name|src
operator|->
name|businfo
operator|.
name|bmc
operator|=
literal|1
expr_stmt|;
name|src
operator|->
name|businfo
operator|.
name|pmc
operator|=
literal|0
expr_stmt|;
name|src
operator|->
name|businfo
operator|.
name|cyc_clk_acc
operator|=
literal|100
expr_stmt|;
name|src
operator|->
name|businfo
operator|.
name|max_rec
operator|=
name|sc
operator|->
name|maxrec
expr_stmt|;
name|src
operator|->
name|businfo
operator|.
name|max_rom
operator|=
name|MAXROM_4
expr_stmt|;
define|#
directive|define
name|FW_GENERATION_CHANGEABLE
value|2
name|src
operator|->
name|businfo
operator|.
name|generation
operator|=
name|FW_GENERATION_CHANGEABLE
expr_stmt|;
name|src
operator|->
name|businfo
operator|.
name|link_spd
operator|=
name|sc
operator|->
name|speed
expr_stmt|;
name|src
operator|->
name|businfo
operator|.
name|eui64
operator|.
name|hi
operator|=
name|sc
operator|->
name|eui
operator|.
name|hi
expr_stmt|;
name|src
operator|->
name|businfo
operator|.
name|eui64
operator|.
name|lo
operator|=
name|sc
operator|->
name|eui
operator|.
name|lo
expr_stmt|;
name|STAILQ_INIT
argument_list|(
operator|&
name|src
operator|->
name|chunk_list
argument_list|)
expr_stmt|;
name|sc
operator|->
name|crom_src
operator|=
name|src
expr_stmt|;
name|sc
operator|->
name|crom_root
operator|=
operator|&
name|sc
operator|->
name|crom_src_buf
operator|->
name|root
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|fw_reset_crom
parameter_list|(
name|struct
name|fwohci_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|crom_src_buf
modifier|*
name|buf
decl_stmt|;
name|struct
name|crom_src
modifier|*
name|src
decl_stmt|;
name|struct
name|crom_chunk
modifier|*
name|root
decl_stmt|;
name|printf
argument_list|(
literal|"fw_reset\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|crom_src_buf
operator|==
name|NULL
condition|)
name|fw_init_crom
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|buf
operator|=
name|sc
operator|->
name|crom_src_buf
expr_stmt|;
name|src
operator|=
name|sc
operator|->
name|crom_src
expr_stmt|;
name|root
operator|=
name|sc
operator|->
name|crom_root
expr_stmt|;
name|STAILQ_INIT
argument_list|(
operator|&
name|src
operator|->
name|chunk_list
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|root
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|crom_chunk
argument_list|)
argument_list|)
expr_stmt|;
name|crom_add_chunk
argument_list|(
name|src
argument_list|,
name|NULL
argument_list|,
name|root
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|crom_add_entry
argument_list|(
name|root
argument_list|,
name|CSRKEY_NCAP
argument_list|,
literal|0x0083c0
argument_list|)
expr_stmt|;
comment|/* XXX */
comment|/* private company_id */
name|crom_add_entry
argument_list|(
name|root
argument_list|,
name|CSRKEY_VENDOR
argument_list|,
name|CSRVAL_VENDOR_PRIVATE
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|__DragonFly__
name|crom_add_simple_text
argument_list|(
name|src
argument_list|,
name|root
argument_list|,
operator|&
name|buf
operator|->
name|vendor
argument_list|,
literal|"DragonFly Project"
argument_list|)
expr_stmt|;
else|#
directive|else
name|crom_add_simple_text
argument_list|(
name|src
argument_list|,
name|root
argument_list|,
operator|&
name|buf
operator|->
name|vendor
argument_list|,
literal|"FreeBSD Project"
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_define
define|#
directive|define
name|ADDR_HI
parameter_list|(
name|x
parameter_list|)
value|(((x)>> 24)& 0xffffff)
end_define

begin_define
define|#
directive|define
name|ADDR_LO
parameter_list|(
name|x
parameter_list|)
value|((x)& 0xffffff)
end_define

begin_function
specifier|static
name|void
name|dcons_crom
parameter_list|(
name|struct
name|fwohci_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|crom_src_buf
modifier|*
name|buf
decl_stmt|;
name|struct
name|crom_src
modifier|*
name|src
decl_stmt|;
name|struct
name|crom_chunk
modifier|*
name|root
decl_stmt|;
name|buf
operator|=
name|sc
operator|->
name|crom_src_buf
expr_stmt|;
name|src
operator|=
name|sc
operator|->
name|crom_src
expr_stmt|;
name|root
operator|=
name|sc
operator|->
name|crom_root
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|buf
operator|->
name|unit
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|crom_chunk
argument_list|)
argument_list|)
expr_stmt|;
name|crom_add_chunk
argument_list|(
name|src
argument_list|,
name|root
argument_list|,
operator|&
name|buf
operator|->
name|unit
argument_list|,
name|CROM_UDIR
argument_list|)
expr_stmt|;
name|crom_add_entry
argument_list|(
operator|&
name|buf
operator|->
name|unit
argument_list|,
name|CSRKEY_SPEC
argument_list|,
name|CSRVAL_VENDOR_PRIVATE
argument_list|)
expr_stmt|;
name|crom_add_simple_text
argument_list|(
name|src
argument_list|,
operator|&
name|buf
operator|->
name|unit
argument_list|,
operator|&
name|buf
operator|->
name|spec
argument_list|,
literal|"FreeBSD"
argument_list|)
expr_stmt|;
name|crom_add_entry
argument_list|(
operator|&
name|buf
operator|->
name|unit
argument_list|,
name|CSRKEY_VER
argument_list|,
name|DCONS_CSR_VAL_VER
argument_list|)
expr_stmt|;
name|crom_add_simple_text
argument_list|(
name|src
argument_list|,
operator|&
name|buf
operator|->
name|unit
argument_list|,
operator|&
name|buf
operator|->
name|ver
argument_list|,
literal|"dcons"
argument_list|)
expr_stmt|;
name|crom_add_entry
argument_list|(
operator|&
name|buf
operator|->
name|unit
argument_list|,
name|DCONS_CSR_KEY_HI
argument_list|,
name|ADDR_HI
argument_list|(
name|dcons_paddr
argument_list|)
argument_list|)
expr_stmt|;
name|crom_add_entry
argument_list|(
operator|&
name|buf
operator|->
name|unit
argument_list|,
name|DCONS_CSR_KEY_LO
argument_list|,
name|ADDR_LO
argument_list|(
name|dcons_paddr
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|fw_crom
parameter_list|(
name|struct
name|fwohci_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|crom_src
modifier|*
name|src
decl_stmt|;
name|void
modifier|*
name|newrom
decl_stmt|;
name|fw_reset_crom
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|dcons_crom
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|newrom
operator|=
name|malloc
argument_list|(
name|CROMSIZE
argument_list|)
expr_stmt|;
name|src
operator|=
operator|&
name|sc
operator|->
name|crom_src_buf
operator|->
name|src
expr_stmt|;
name|crom_load
argument_list|(
name|src
argument_list|,
operator|(
name|uint32_t
operator|*
operator|)
name|newrom
argument_list|,
name|CROMSIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|bcmp
argument_list|(
name|newrom
argument_list|,
name|sc
operator|->
name|config_rom
argument_list|,
name|CROMSIZE
argument_list|)
operator|!=
literal|0
condition|)
block|{
comment|/* Bump generation and reload. */
name|src
operator|->
name|businfo
operator|.
name|generation
operator|++
expr_stmt|;
comment|/* Handle generation count wraps. */
if|if
condition|(
name|src
operator|->
name|businfo
operator|.
name|generation
operator|<
literal|2
condition|)
name|src
operator|->
name|businfo
operator|.
name|generation
operator|=
literal|2
expr_stmt|;
comment|/* Recalculate CRC to account for generation change. */
name|crom_load
argument_list|(
name|src
argument_list|,
operator|(
name|uint32_t
operator|*
operator|)
name|newrom
argument_list|,
name|CROMSIZE
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|newrom
argument_list|,
operator|(
name|void
operator|*
operator|)
name|sc
operator|->
name|config_rom
argument_list|,
name|CROMSIZE
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|newrom
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|fw_busreset
parameter_list|(
name|struct
name|fwohci_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|count
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|state
operator|<
name|FWOHCI_STATE_ENABLED
condition|)
block|{
name|printf
argument_list|(
literal|"fwohci not enabled\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|CMD_OK
operator|)
return|;
block|}
name|fw_crom
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|fwohci_ibr
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|count
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|sc
operator|->
name|state
operator|<
name|FWOHCI_STATE_NORMAL
condition|)
block|{
name|fwohci_poll
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|count
operator|++
expr_stmt|;
if|if
condition|(
name|count
operator|>
literal|1000
condition|)
block|{
name|printf
argument_list|(
literal|"give up to wait bus initialize\n"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
name|printf
argument_list|(
literal|"poll count = %d\n"
argument_list|,
name|count
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|void
name|fw_enable
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|fwohci_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|fw_initialized
operator|==
literal|0
condition|)
name|fw_init
argument_list|()
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_OHCI
condition|;
name|i
operator|++
control|)
block|{
name|sc
operator|=
operator|&
name|fwinfo
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|state
operator|!=
name|FWOHCI_STATE_INIT
condition|)
break|break;
name|sc
operator|->
name|config_rom
operator|=
operator|(
name|uint32_t
operator|*
operator|)
operator|(
operator|(
operator|(
name|uint32_t
operator|)
name|sc
operator|->
name|config_rom_buf
operator|+
operator|(
name|CROMSIZE
operator|-
literal|1
operator|)
operator|)
operator|&
operator|~
operator|(
name|CROMSIZE
operator|-
literal|1
operator|)
operator|)
expr_stmt|;
if|#
directive|if
literal|0
block|printf("configrom: %08p %08p\n", 			sc->config_rom_buf, sc->config_rom);
endif|#
directive|endif
if|if
condition|(
name|fwohci_init
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
operator|==
literal|0
condition|)
block|{
name|sc
operator|->
name|state
operator|=
name|FWOHCI_STATE_ENABLED
expr_stmt|;
name|fw_busreset
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
else|else
name|sc
operator|->
name|state
operator|=
name|FWOHCI_STATE_DEAD
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|fw_poll
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|fwohci_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|fw_initialized
operator|==
literal|0
condition|)
return|return;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_OHCI
condition|;
name|i
operator|++
control|)
block|{
name|sc
operator|=
operator|&
name|fwinfo
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|state
operator|<
name|FWOHCI_STATE_ENABLED
condition|)
break|break;
name|fwohci_poll
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_if
if|#
directive|if
literal|0
end_if

begin_comment
comment|/* for debug */
end_comment

begin_endif
unit|static int fw_busreset_cmd(int argc, char *argv[]) { 	struct fwohci_softc *sc; 	int i;  	for (i = 0; i< MAX_OHCI; i ++) { 		sc =&fwinfo[i]; 		if (sc->state< FWOHCI_STATE_INIT) 			break; 		fw_busreset(sc); 	} 	return(CMD_OK); }  static int fw_poll_cmd(int argc, char *argv[]) { 	fw_poll(); 	return(CMD_OK); }  static int fw_enable_cmd(int argc, char *argv[]) { 	fw_print(0); 	fw_enable(); 	return(CMD_OK); }   static int dcons_enable(int argc, char *argv[]) { 	dconsole.c_init(0); 	fw_enable(); 	dconsole.c_flags |= C_ACTIVEIN | C_ACTIVEOUT; 	return(CMD_OK); }  static int dcons_read(int argc, char *argv[]) { 	char c; 	while (dconsole.c_ready()) { 		c = dconsole.c_in(); 		printf("%c", c); 	} 	printf("\r\n"); 	return(CMD_OK); }  static int dcons_write(int argc, char *argv[]) { 	int len, i; 	if (argc< 2) 		return(CMD_OK);  	len = strlen(argv[1]); 	for (i = 0; i< len; i ++) 		dconsole.c_out(argv[1][i]); 	dconsole.c_out('\r'); 	dconsole.c_out('\n'); 	return(CMD_OK); } COMMAND_SET(firewire, "firewire", "enable firewire", fw_enable_cmd); COMMAND_SET(fwbusreset, "fwbusreset", "firewire busreset", fw_busreset_cmd); COMMAND_SET(fwpoll, "fwpoll", "firewire poll", fw_poll_cmd); COMMAND_SET(dcons, "dcons", "enable dcons", dcons_enable); COMMAND_SET(dread, "dread", "read from dcons", dcons_read); COMMAND_SET(dwrite, "dwrite", "write to dcons", dcons_write);
endif|#
directive|endif
end_endif

end_unit


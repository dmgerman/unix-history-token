begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/******************************************************************* ** s e a r c h . c ** Forth Inspired Command Language ** ANS Forth SEARCH and SEARCH-EXT word-set written in C ** Author: John Sadler (john_sadler@alum.mit.edu) ** Created: 6 June 2000 ** $Id: search.c,v 1.4 2001-04-26 21:41:31-07 jsadler Exp jsadler $ *******************************************************************/
end_comment

begin_comment
comment|/* ** Copyright (c) 1997-2001 John Sadler (john_sadler@alum.mit.edu) ** All rights reserved. ** ** Get the latest Ficl release at http://ficl.sourceforge.net ** ** L I C E N S E  and  D I S C L A I M E R **  ** Redistribution and use in source and binary forms, with or without ** modification, are permitted provided that the following conditions ** are met: ** 1. Redistributions of source code must retain the above copyright **    notice, this list of conditions and the following disclaimer. ** 2. Redistributions in binary form must reproduce the above copyright **    notice, this list of conditions and the following disclaimer in the **    documentation and/or other materials provided with the distribution. ** ** THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND ** ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE ** IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ** ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE ** FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL ** DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS ** OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) ** HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT ** LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY ** OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF ** SUCH DAMAGE. ** ** I am interested in hearing from anyone who uses ficl. If you have ** a problem, a success story, a defect, an enhancement request, or ** if you would like to contribute to the ficl release, please send ** contact me by email at the address above. ** ** $Id: search.c,v 1.4 2001-04-26 21:41:31-07 jsadler Exp jsadler $ */
end_comment

begin_comment
comment|/* $FreeBSD$ */
end_comment

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|"ficl.h"
end_include

begin_include
include|#
directive|include
file|"math64.h"
end_include

begin_comment
comment|/**************************************************************************                         d e f i n i t i o n s ** SEARCH ( -- ) ** Make the compilation word list the same as the first word list in the ** search order. Specifies that the names of subsequent definitions will ** be placed in the compilation word list. Subsequent changes in the search ** order will not affect the compilation word list.  **************************************************************************/
end_comment

begin_function
specifier|static
name|void
name|definitions
parameter_list|(
name|FICL_VM
modifier|*
name|pVM
parameter_list|)
block|{
name|FICL_DICT
modifier|*
name|pDict
init|=
name|ficlGetDict
argument_list|()
decl_stmt|;
name|assert
argument_list|(
name|pDict
argument_list|)
expr_stmt|;
if|if
condition|(
name|pDict
operator|->
name|nLists
operator|<
literal|1
condition|)
block|{
name|vmThrowErr
argument_list|(
name|pVM
argument_list|,
literal|"DEFINITIONS error - empty search order"
argument_list|)
expr_stmt|;
block|}
name|pDict
operator|->
name|pCompile
operator|=
name|pDict
operator|->
name|pSearch
index|[
name|pDict
operator|->
name|nLists
operator|-
literal|1
index|]
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/**************************************************************************                         f o r t h - w o r d l i s t ** SEARCH ( -- wid ) ** Return wid, the identifier of the word list that includes all standard ** words provided by the implementation. This word list is initially the ** compilation word list and is part of the initial search order.  **************************************************************************/
end_comment

begin_function
specifier|static
name|void
name|forthWordlist
parameter_list|(
name|FICL_VM
modifier|*
name|pVM
parameter_list|)
block|{
name|FICL_HASH
modifier|*
name|pHash
init|=
name|ficlGetDict
argument_list|()
operator|->
name|pForthWords
decl_stmt|;
name|stackPushPtr
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|,
name|pHash
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/**************************************************************************                         g e t - c u r r e n t ** SEARCH ( -- wid ) ** Return wid, the identifier of the compilation word list.  **************************************************************************/
end_comment

begin_function
specifier|static
name|void
name|getCurrent
parameter_list|(
name|FICL_VM
modifier|*
name|pVM
parameter_list|)
block|{
name|ficlLockDictionary
argument_list|(
name|TRUE
argument_list|)
expr_stmt|;
name|stackPushPtr
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|,
name|ficlGetDict
argument_list|()
operator|->
name|pCompile
argument_list|)
expr_stmt|;
name|ficlLockDictionary
argument_list|(
name|FALSE
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/**************************************************************************                         g e t - o r d e r ** SEARCH ( -- widn ... wid1 n ) ** Returns the number of word lists n in the search order and the word list ** identifiers widn ... wid1 identifying these word lists. wid1 identifies ** the word list that is searched first, and widn the word list that is ** searched last. The search order is unaffected. **************************************************************************/
end_comment

begin_function
specifier|static
name|void
name|getOrder
parameter_list|(
name|FICL_VM
modifier|*
name|pVM
parameter_list|)
block|{
name|FICL_DICT
modifier|*
name|pDict
init|=
name|ficlGetDict
argument_list|()
decl_stmt|;
name|int
name|nLists
init|=
name|pDict
operator|->
name|nLists
decl_stmt|;
name|int
name|i
decl_stmt|;
name|ficlLockDictionary
argument_list|(
name|TRUE
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nLists
condition|;
name|i
operator|++
control|)
block|{
name|stackPushPtr
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|,
name|pDict
operator|->
name|pSearch
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|stackPushUNS
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|,
name|nLists
argument_list|)
expr_stmt|;
name|ficlLockDictionary
argument_list|(
name|FALSE
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/**************************************************************************                         s e a r c h - w o r d l i s t ** SEARCH ( c-addr u wid -- 0 | xt 1 | xt -1 ) ** Find the definition identified by the string c-addr u in the word list ** identified by wid. If the definition is not found, return zero. If the ** definition is found, return its execution token xt and one (1) if the ** definition is immediate, minus-one (-1) otherwise.  **************************************************************************/
end_comment

begin_function
specifier|static
name|void
name|searchWordlist
parameter_list|(
name|FICL_VM
modifier|*
name|pVM
parameter_list|)
block|{
name|STRINGINFO
name|si
decl_stmt|;
name|UNS16
name|hashCode
decl_stmt|;
name|FICL_WORD
modifier|*
name|pFW
decl_stmt|;
name|FICL_HASH
modifier|*
name|pHash
init|=
name|stackPopPtr
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|)
decl_stmt|;
name|si
operator|.
name|count
operator|=
operator|(
name|FICL_COUNT
operator|)
name|stackPopUNS
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|)
expr_stmt|;
name|si
operator|.
name|cp
operator|=
name|stackPopPtr
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|)
expr_stmt|;
name|hashCode
operator|=
name|hashHashCode
argument_list|(
name|si
argument_list|)
expr_stmt|;
name|ficlLockDictionary
argument_list|(
name|TRUE
argument_list|)
expr_stmt|;
name|pFW
operator|=
name|hashLookup
argument_list|(
name|pHash
argument_list|,
name|si
argument_list|,
name|hashCode
argument_list|)
expr_stmt|;
name|ficlLockDictionary
argument_list|(
name|FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|pFW
condition|)
block|{
name|stackPushPtr
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|,
name|pFW
argument_list|)
expr_stmt|;
name|stackPushINT
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|,
operator|(
name|wordIsImmediate
argument_list|(
name|pFW
argument_list|)
condition|?
literal|1
else|:
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|stackPushUNS
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_comment
comment|/**************************************************************************                         s e t - c u r r e n t ** SEARCH ( wid -- ) ** Set the compilation word list to the word list identified by wid.  **************************************************************************/
end_comment

begin_function
specifier|static
name|void
name|setCurrent
parameter_list|(
name|FICL_VM
modifier|*
name|pVM
parameter_list|)
block|{
name|FICL_HASH
modifier|*
name|pHash
init|=
name|stackPopPtr
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|)
decl_stmt|;
name|FICL_DICT
modifier|*
name|pDict
init|=
name|ficlGetDict
argument_list|()
decl_stmt|;
name|ficlLockDictionary
argument_list|(
name|TRUE
argument_list|)
expr_stmt|;
name|pDict
operator|->
name|pCompile
operator|=
name|pHash
expr_stmt|;
name|ficlLockDictionary
argument_list|(
name|FALSE
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/**************************************************************************                         s e t - o r d e r ** SEARCH ( widn ... wid1 n -- ) ** Set the search order to the word lists identified by widn ... wid1. ** Subsequently, word list wid1 will be searched first, and word list ** widn searched last. If n is zero, empty the search order. If n is minus ** one, set the search order to the implementation-defined minimum ** search order. The minimum search order shall include the words ** FORTH-WORDLIST and SET-ORDER. A system shall allow n to ** be at least eight. **************************************************************************/
end_comment

begin_function
specifier|static
name|void
name|setOrder
parameter_list|(
name|FICL_VM
modifier|*
name|pVM
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|nLists
init|=
name|stackPopINT
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|)
decl_stmt|;
name|FICL_DICT
modifier|*
name|dp
init|=
name|ficlGetDict
argument_list|()
decl_stmt|;
if|if
condition|(
name|nLists
operator|>
name|FICL_DEFAULT_VOCS
condition|)
block|{
name|vmThrowErr
argument_list|(
name|pVM
argument_list|,
literal|"set-order error: list would be too large"
argument_list|)
expr_stmt|;
block|}
name|ficlLockDictionary
argument_list|(
name|TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|nLists
operator|>=
literal|0
condition|)
block|{
name|dp
operator|->
name|nLists
operator|=
name|nLists
expr_stmt|;
for|for
control|(
name|i
operator|=
name|nLists
operator|-
literal|1
init|;
name|i
operator|>=
literal|0
condition|;
operator|--
name|i
control|)
block|{
name|dp
operator|->
name|pSearch
index|[
name|i
index|]
operator|=
name|stackPopPtr
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|dictResetSearchOrder
argument_list|(
name|dp
argument_list|)
expr_stmt|;
block|}
name|ficlLockDictionary
argument_list|(
name|FALSE
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/**************************************************************************                         f i c l - w o r d l i s t ** SEARCH ( -- wid ) ** Create a new empty word list, returning its word list identifier wid. ** The new word list may be returned from a pool of preallocated word ** lists or may be dynamically allocated in data space. A system shall ** allow the creation of at least 8 new word lists in addition to any ** provided as part of the system.  ** Notes:  ** 1. ficl creates a new single-list hash in the dictionary and returns **    its address. ** 2. ficl-wordlist takes an arg off the stack indicating the number of **    hash entries in the wordlist. Ficl 2.02 and later define WORDLIST as **    : wordlist 1 ficl-wordlist ; **************************************************************************/
end_comment

begin_function
specifier|static
name|void
name|ficlWordlist
parameter_list|(
name|FICL_VM
modifier|*
name|pVM
parameter_list|)
block|{
name|FICL_DICT
modifier|*
name|dp
init|=
name|ficlGetDict
argument_list|()
decl_stmt|;
name|FICL_HASH
modifier|*
name|pHash
decl_stmt|;
name|FICL_UNS
name|nBuckets
decl_stmt|;
if|#
directive|if
name|FICL_ROBUST
operator|>
literal|1
name|vmCheckStack
argument_list|(
name|pVM
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|nBuckets
operator|=
name|stackPopUNS
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|)
expr_stmt|;
name|pHash
operator|=
name|dictCreateWordlist
argument_list|(
name|dp
argument_list|,
name|nBuckets
argument_list|)
expr_stmt|;
name|stackPushPtr
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|,
name|pHash
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/**************************************************************************                         S E A R C H> ** ficl  ( -- wid ) ** Pop wid off the search order. Error if the search order is empty **************************************************************************/
end_comment

begin_function
specifier|static
name|void
name|searchPop
parameter_list|(
name|FICL_VM
modifier|*
name|pVM
parameter_list|)
block|{
name|FICL_DICT
modifier|*
name|dp
init|=
name|ficlGetDict
argument_list|()
decl_stmt|;
name|int
name|nLists
decl_stmt|;
name|ficlLockDictionary
argument_list|(
name|TRUE
argument_list|)
expr_stmt|;
name|nLists
operator|=
name|dp
operator|->
name|nLists
expr_stmt|;
if|if
condition|(
name|nLists
operator|==
literal|0
condition|)
block|{
name|vmThrowErr
argument_list|(
name|pVM
argument_list|,
literal|"search> error: empty search order"
argument_list|)
expr_stmt|;
block|}
name|stackPushPtr
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|,
name|dp
operator|->
name|pSearch
index|[
operator|--
name|dp
operator|->
name|nLists
index|]
argument_list|)
expr_stmt|;
name|ficlLockDictionary
argument_list|(
name|FALSE
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/**************************************************************************> S E A R C H ** ficl  ( wid -- ) ** Push wid onto the search order. Error if the search order is full. **************************************************************************/
end_comment

begin_function
specifier|static
name|void
name|searchPush
parameter_list|(
name|FICL_VM
modifier|*
name|pVM
parameter_list|)
block|{
name|FICL_DICT
modifier|*
name|dp
init|=
name|ficlGetDict
argument_list|()
decl_stmt|;
name|ficlLockDictionary
argument_list|(
name|TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|dp
operator|->
name|nLists
operator|>
name|FICL_DEFAULT_VOCS
condition|)
block|{
name|vmThrowErr
argument_list|(
name|pVM
argument_list|,
literal|">search error: search order overflow"
argument_list|)
expr_stmt|;
block|}
name|dp
operator|->
name|pSearch
index|[
name|dp
operator|->
name|nLists
operator|++
index|]
operator|=
name|stackPopPtr
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|)
expr_stmt|;
name|ficlLockDictionary
argument_list|(
name|FALSE
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/**************************************************************************                         W I D - G E T - N A M E ** ficl  ( wid -- c-addr u ) ** Get wid's (optional) name and push onto stack as a counted string **************************************************************************/
end_comment

begin_function
specifier|static
name|void
name|widGetName
parameter_list|(
name|FICL_VM
modifier|*
name|pVM
parameter_list|)
block|{
name|FICL_HASH
modifier|*
name|pHash
init|=
name|vmPop
argument_list|(
name|pVM
argument_list|)
operator|.
name|p
decl_stmt|;
name|char
modifier|*
name|cp
init|=
name|pHash
operator|->
name|name
decl_stmt|;
name|int
name|len
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|cp
condition|)
name|len
operator|=
name|strlen
argument_list|(
name|cp
argument_list|)
expr_stmt|;
name|vmPush
argument_list|(
name|pVM
argument_list|,
name|LVALUEtoCELL
argument_list|(
name|cp
argument_list|)
argument_list|)
expr_stmt|;
name|vmPush
argument_list|(
name|pVM
argument_list|,
name|LVALUEtoCELL
argument_list|(
name|len
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/**************************************************************************                         W I D - S E T - N A M E ** ficl  ( wid c-addr -- ) ** Set wid's name pointer to the \0 terminated string address supplied **************************************************************************/
end_comment

begin_function
specifier|static
name|void
name|widSetName
parameter_list|(
name|FICL_VM
modifier|*
name|pVM
parameter_list|)
block|{
name|char
modifier|*
name|cp
init|=
operator|(
name|char
operator|*
operator|)
name|vmPop
argument_list|(
name|pVM
argument_list|)
operator|.
name|p
decl_stmt|;
name|FICL_HASH
modifier|*
name|pHash
init|=
name|vmPop
argument_list|(
name|pVM
argument_list|)
operator|.
name|p
decl_stmt|;
name|pHash
operator|->
name|name
operator|=
name|cp
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/**************************************************************************                         setParentWid ** FICL ** setparentwid   ( parent-wid wid -- ) ** Set WID's link field to the parent-wid. search-wordlist will  ** iterate through all the links when finding words in the child wid. **************************************************************************/
end_comment

begin_function
specifier|static
name|void
name|setParentWid
parameter_list|(
name|FICL_VM
modifier|*
name|pVM
parameter_list|)
block|{
name|FICL_HASH
modifier|*
name|parent
decl_stmt|,
modifier|*
name|child
decl_stmt|;
if|#
directive|if
name|FICL_ROBUST
operator|>
literal|1
name|vmCheckStack
argument_list|(
name|pVM
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|child
operator|=
operator|(
name|FICL_HASH
operator|*
operator|)
name|stackPopPtr
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|)
expr_stmt|;
name|parent
operator|=
operator|(
name|FICL_HASH
operator|*
operator|)
name|stackPopPtr
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|)
expr_stmt|;
name|child
operator|->
name|link
operator|=
name|parent
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/**************************************************************************                         f i c l C o m p i l e S e a r c h ** Builds the primitive wordset and the environment-query namespace. **************************************************************************/
end_comment

begin_function
name|void
name|ficlCompileSearch
parameter_list|(
name|FICL_SYSTEM
modifier|*
name|pSys
parameter_list|)
block|{
name|FICL_DICT
modifier|*
name|dp
init|=
name|pSys
operator|->
name|dp
decl_stmt|;
name|assert
argument_list|(
name|dp
argument_list|)
expr_stmt|;
comment|/*     ** optional SEARCH-ORDER word set      */
name|dictAppendWord
argument_list|(
name|dp
argument_list|,
literal|">search"
argument_list|,
name|searchPush
argument_list|,
name|FW_DEFAULT
argument_list|)
expr_stmt|;
name|dictAppendWord
argument_list|(
name|dp
argument_list|,
literal|"search>"
argument_list|,
name|searchPop
argument_list|,
name|FW_DEFAULT
argument_list|)
expr_stmt|;
name|dictAppendWord
argument_list|(
name|dp
argument_list|,
literal|"definitions"
argument_list|,
name|definitions
argument_list|,
name|FW_DEFAULT
argument_list|)
expr_stmt|;
name|dictAppendWord
argument_list|(
name|dp
argument_list|,
literal|"forth-wordlist"
argument_list|,
name|forthWordlist
argument_list|,
name|FW_DEFAULT
argument_list|)
expr_stmt|;
name|dictAppendWord
argument_list|(
name|dp
argument_list|,
literal|"get-current"
argument_list|,
name|getCurrent
argument_list|,
name|FW_DEFAULT
argument_list|)
expr_stmt|;
name|dictAppendWord
argument_list|(
name|dp
argument_list|,
literal|"get-order"
argument_list|,
name|getOrder
argument_list|,
name|FW_DEFAULT
argument_list|)
expr_stmt|;
name|dictAppendWord
argument_list|(
name|dp
argument_list|,
literal|"search-wordlist"
argument_list|,
name|searchWordlist
argument_list|,
name|FW_DEFAULT
argument_list|)
expr_stmt|;
name|dictAppendWord
argument_list|(
name|dp
argument_list|,
literal|"set-current"
argument_list|,
name|setCurrent
argument_list|,
name|FW_DEFAULT
argument_list|)
expr_stmt|;
name|dictAppendWord
argument_list|(
name|dp
argument_list|,
literal|"set-order"
argument_list|,
name|setOrder
argument_list|,
name|FW_DEFAULT
argument_list|)
expr_stmt|;
name|dictAppendWord
argument_list|(
name|dp
argument_list|,
literal|"ficl-wordlist"
argument_list|,
name|ficlWordlist
argument_list|,
name|FW_DEFAULT
argument_list|)
expr_stmt|;
comment|/*     ** Set SEARCH environment query values     */
name|ficlSetEnv
argument_list|(
literal|"search-order"
argument_list|,
name|FICL_TRUE
argument_list|)
expr_stmt|;
name|ficlSetEnv
argument_list|(
literal|"search-order-ext"
argument_list|,
name|FICL_TRUE
argument_list|)
expr_stmt|;
name|ficlSetEnv
argument_list|(
literal|"wordlists"
argument_list|,
name|FICL_DEFAULT_VOCS
argument_list|)
expr_stmt|;
name|dictAppendWord
argument_list|(
name|dp
argument_list|,
literal|"wid-get-name"
argument_list|,
name|widGetName
argument_list|,
name|FW_DEFAULT
argument_list|)
expr_stmt|;
name|dictAppendWord
argument_list|(
name|dp
argument_list|,
literal|"wid-set-name"
argument_list|,
name|widSetName
argument_list|,
name|FW_DEFAULT
argument_list|)
expr_stmt|;
name|dictAppendWord
argument_list|(
name|dp
argument_list|,
literal|"wid-set-super"
argument_list|,
name|setParentWid
argument_list|,
name|FW_DEFAULT
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

end_unit


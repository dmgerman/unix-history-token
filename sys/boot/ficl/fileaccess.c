begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* $FreeBSD$ */
end_comment

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|"ficl.h"
end_include

begin_if
if|#
directive|if
name|FICL_WANT_FILE
end_if

begin_comment
comment|/* ** ** fileaccess.c ** ** Implements all of the File Access word set that can be implemented in portable C. ** */
end_comment

begin_function
specifier|static
name|void
name|pushIor
parameter_list|(
name|FICL_VM
modifier|*
name|pVM
parameter_list|,
name|int
name|success
parameter_list|)
block|{
name|int
name|ior
decl_stmt|;
if|if
condition|(
name|success
condition|)
name|ior
operator|=
literal|0
expr_stmt|;
else|else
name|ior
operator|=
name|errno
expr_stmt|;
name|stackPushINT
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|,
name|ior
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ficlFopen
parameter_list|(
name|FICL_VM
modifier|*
name|pVM
parameter_list|,
name|char
modifier|*
name|writeMode
parameter_list|)
comment|/* ( c-addr u fam -- fileid ior ) */
block|{
name|int
name|fam
init|=
name|stackPopINT
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|)
decl_stmt|;
name|int
name|length
init|=
name|stackPopINT
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|)
decl_stmt|;
name|void
modifier|*
name|address
init|=
operator|(
name|void
operator|*
operator|)
name|stackPopPtr
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|)
decl_stmt|;
name|char
name|mode
index|[
literal|4
index|]
decl_stmt|;
name|FILE
modifier|*
name|f
decl_stmt|;
name|char
modifier|*
name|filename
init|=
operator|(
name|char
operator|*
operator|)
name|alloca
argument_list|(
name|length
operator|+
literal|1
argument_list|)
decl_stmt|;
name|memcpy
argument_list|(
name|filename
argument_list|,
name|address
argument_list|,
name|length
argument_list|)
expr_stmt|;
name|filename
index|[
name|length
index|]
operator|=
literal|0
expr_stmt|;
operator|*
name|mode
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|FICL_FAM_OPEN_MODE
argument_list|(
name|fam
argument_list|)
condition|)
block|{
case|case
literal|0
case|:
name|stackPushPtr
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|stackPushINT
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|,
name|EINVAL
argument_list|)
expr_stmt|;
return|return;
case|case
name|FICL_FAM_READ
case|:
name|strcat
argument_list|(
name|mode
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
break|break;
case|case
name|FICL_FAM_WRITE
case|:
name|strcat
argument_list|(
name|mode
argument_list|,
name|writeMode
argument_list|)
expr_stmt|;
break|break;
case|case
name|FICL_FAM_READ
operator||
name|FICL_FAM_WRITE
case|:
name|strcat
argument_list|(
name|mode
argument_list|,
name|writeMode
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|mode
argument_list|,
literal|"+"
argument_list|)
expr_stmt|;
break|break;
block|}
name|strcat
argument_list|(
name|mode
argument_list|,
operator|(
name|fam
operator|&
name|FICL_FAM_BINARY
operator|)
condition|?
literal|"b"
else|:
literal|"t"
argument_list|)
expr_stmt|;
name|f
operator|=
name|fopen
argument_list|(
name|filename
argument_list|,
name|mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|==
name|NULL
condition|)
name|stackPushPtr
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
else|else
block|{
name|ficlFILE
modifier|*
name|ff
init|=
operator|(
name|ficlFILE
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|ficlFILE
argument_list|)
argument_list|)
decl_stmt|;
name|strcpy
argument_list|(
name|ff
operator|->
name|filename
argument_list|,
name|filename
argument_list|)
expr_stmt|;
name|ff
operator|->
name|f
operator|=
name|f
expr_stmt|;
name|stackPushPtr
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|,
name|ff
argument_list|)
expr_stmt|;
name|fseek
argument_list|(
name|f
argument_list|,
literal|0
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
block|}
name|pushIor
argument_list|(
name|pVM
argument_list|,
name|f
operator|!=
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ficlOpenFile
parameter_list|(
name|FICL_VM
modifier|*
name|pVM
parameter_list|)
comment|/* ( c-addr u fam -- fileid ior ) */
block|{
name|ficlFopen
argument_list|(
name|pVM
argument_list|,
literal|"a"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ficlCreateFile
parameter_list|(
name|FICL_VM
modifier|*
name|pVM
parameter_list|)
comment|/* ( c-addr u fam -- fileid ior ) */
block|{
name|ficlFopen
argument_list|(
name|pVM
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|closeFiclFILE
parameter_list|(
name|ficlFILE
modifier|*
name|ff
parameter_list|)
comment|/* ( fileid -- ior ) */
block|{
name|FILE
modifier|*
name|f
init|=
name|ff
operator|->
name|f
decl_stmt|;
name|free
argument_list|(
name|ff
argument_list|)
expr_stmt|;
return|return
operator|!
name|fclose
argument_list|(
name|f
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ficlCloseFile
parameter_list|(
name|FICL_VM
modifier|*
name|pVM
parameter_list|)
comment|/* ( fileid -- ior ) */
block|{
name|ficlFILE
modifier|*
name|ff
init|=
operator|(
name|ficlFILE
operator|*
operator|)
name|stackPopPtr
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|)
decl_stmt|;
name|pushIor
argument_list|(
name|pVM
argument_list|,
name|closeFiclFILE
argument_list|(
name|ff
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ficlDeleteFile
parameter_list|(
name|FICL_VM
modifier|*
name|pVM
parameter_list|)
comment|/* ( c-addr u -- ior ) */
block|{
name|int
name|length
init|=
name|stackPopINT
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|)
decl_stmt|;
name|void
modifier|*
name|address
init|=
operator|(
name|void
operator|*
operator|)
name|stackPopPtr
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|)
decl_stmt|;
name|char
modifier|*
name|filename
init|=
operator|(
name|char
operator|*
operator|)
name|alloca
argument_list|(
name|length
operator|+
literal|1
argument_list|)
decl_stmt|;
name|memcpy
argument_list|(
name|filename
argument_list|,
name|address
argument_list|,
name|length
argument_list|)
expr_stmt|;
name|filename
index|[
name|length
index|]
operator|=
literal|0
expr_stmt|;
name|pushIor
argument_list|(
name|pVM
argument_list|,
operator|!
name|unlink
argument_list|(
name|filename
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ficlRenameFile
parameter_list|(
name|FICL_VM
modifier|*
name|pVM
parameter_list|)
comment|/* ( c-addr1 u1 c-addr2 u2 -- ior ) */
block|{
name|int
name|length
decl_stmt|;
name|void
modifier|*
name|address
decl_stmt|;
name|char
modifier|*
name|from
decl_stmt|;
name|char
modifier|*
name|to
decl_stmt|;
name|length
operator|=
name|stackPopINT
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|)
expr_stmt|;
name|address
operator|=
operator|(
name|void
operator|*
operator|)
name|stackPopPtr
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|)
expr_stmt|;
name|to
operator|=
operator|(
name|char
operator|*
operator|)
name|alloca
argument_list|(
name|length
operator|+
literal|1
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|to
argument_list|,
name|address
argument_list|,
name|length
argument_list|)
expr_stmt|;
name|to
index|[
name|length
index|]
operator|=
literal|0
expr_stmt|;
name|length
operator|=
name|stackPopINT
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|)
expr_stmt|;
name|address
operator|=
operator|(
name|void
operator|*
operator|)
name|stackPopPtr
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|)
expr_stmt|;
name|from
operator|=
operator|(
name|char
operator|*
operator|)
name|alloca
argument_list|(
name|length
operator|+
literal|1
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|from
argument_list|,
name|address
argument_list|,
name|length
argument_list|)
expr_stmt|;
name|from
index|[
name|length
index|]
operator|=
literal|0
expr_stmt|;
name|pushIor
argument_list|(
name|pVM
argument_list|,
operator|!
name|rename
argument_list|(
name|from
argument_list|,
name|to
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ficlFileStatus
parameter_list|(
name|FICL_VM
modifier|*
name|pVM
parameter_list|)
comment|/* ( c-addr u -- x ior ) */
block|{
name|struct
name|stat
name|statbuf
decl_stmt|;
name|int
name|length
init|=
name|stackPopINT
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|)
decl_stmt|;
name|void
modifier|*
name|address
init|=
operator|(
name|void
operator|*
operator|)
name|stackPopPtr
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|)
decl_stmt|;
name|char
modifier|*
name|filename
init|=
operator|(
name|char
operator|*
operator|)
name|alloca
argument_list|(
name|length
operator|+
literal|1
argument_list|)
decl_stmt|;
name|memcpy
argument_list|(
name|filename
argument_list|,
name|address
argument_list|,
name|length
argument_list|)
expr_stmt|;
name|filename
index|[
name|length
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|stat
argument_list|(
name|filename
argument_list|,
operator|&
name|statbuf
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/*         ** the "x" left on the stack is implementation-defined.         ** I push the file's access mode (readable, writeable, is directory, etc)         ** as defined by ANSI C.         */
name|stackPushINT
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|,
name|statbuf
operator|.
name|st_mode
argument_list|)
expr_stmt|;
name|stackPushINT
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|stackPushINT
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|stackPushINT
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|,
name|ENOENT
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ficlFilePosition
parameter_list|(
name|FICL_VM
modifier|*
name|pVM
parameter_list|)
comment|/* ( fileid -- ud ior ) */
block|{
name|ficlFILE
modifier|*
name|ff
init|=
operator|(
name|ficlFILE
operator|*
operator|)
name|stackPopPtr
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|)
decl_stmt|;
name|long
name|ud
init|=
name|ftell
argument_list|(
name|ff
operator|->
name|f
argument_list|)
decl_stmt|;
name|stackPushINT
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|,
name|ud
argument_list|)
expr_stmt|;
name|pushIor
argument_list|(
name|pVM
argument_list|,
name|ud
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|long
name|fileSize
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|)
block|{
name|struct
name|stat
name|statbuf
decl_stmt|;
name|statbuf
operator|.
name|st_size
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|fstat
argument_list|(
name|fileno
argument_list|(
name|f
argument_list|)
argument_list|,
operator|&
name|statbuf
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|statbuf
operator|.
name|st_size
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ficlFileSize
parameter_list|(
name|FICL_VM
modifier|*
name|pVM
parameter_list|)
comment|/* ( fileid -- ud ior ) */
block|{
name|ficlFILE
modifier|*
name|ff
init|=
operator|(
name|ficlFILE
operator|*
operator|)
name|stackPopPtr
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|)
decl_stmt|;
name|long
name|ud
init|=
name|fileSize
argument_list|(
name|ff
operator|->
name|f
argument_list|)
decl_stmt|;
name|stackPushINT
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|,
name|ud
argument_list|)
expr_stmt|;
name|pushIor
argument_list|(
name|pVM
argument_list|,
name|ud
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_define
define|#
directive|define
name|nLINEBUF
value|256
end_define

begin_function
specifier|static
name|void
name|ficlIncludeFile
parameter_list|(
name|FICL_VM
modifier|*
name|pVM
parameter_list|)
comment|/* ( i*x fileid -- j*x ) */
block|{
name|ficlFILE
modifier|*
name|ff
init|=
operator|(
name|ficlFILE
operator|*
operator|)
name|stackPopPtr
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|)
decl_stmt|;
name|CELL
name|id
init|=
name|pVM
operator|->
name|sourceID
decl_stmt|;
name|int
name|result
init|=
name|VM_OUTOFTEXT
decl_stmt|;
name|long
name|currentPosition
decl_stmt|,
name|totalSize
decl_stmt|;
name|long
name|size
decl_stmt|;
name|pVM
operator|->
name|sourceID
operator|.
name|p
operator|=
operator|(
name|void
operator|*
operator|)
name|ff
expr_stmt|;
name|currentPosition
operator|=
name|ftell
argument_list|(
name|ff
operator|->
name|f
argument_list|)
expr_stmt|;
name|totalSize
operator|=
name|fileSize
argument_list|(
name|ff
operator|->
name|f
argument_list|)
expr_stmt|;
name|size
operator|=
name|totalSize
operator|-
name|currentPosition
expr_stmt|;
if|if
condition|(
operator|(
name|totalSize
operator|!=
operator|-
literal|1
operator|)
operator|&&
operator|(
name|currentPosition
operator|!=
operator|-
literal|1
operator|)
operator|&&
operator|(
name|size
operator|>
literal|0
operator|)
condition|)
block|{
name|char
modifier|*
name|buffer
init|=
operator|(
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|size
argument_list|)
decl_stmt|;
name|long
name|got
init|=
name|fread
argument_list|(
name|buffer
argument_list|,
literal|1
argument_list|,
name|size
argument_list|,
name|ff
operator|->
name|f
argument_list|)
decl_stmt|;
if|if
condition|(
name|got
operator|==
name|size
condition|)
name|result
operator|=
name|ficlExecC
argument_list|(
name|pVM
argument_list|,
name|buffer
argument_list|,
name|size
argument_list|)
expr_stmt|;
block|}
if|#
directive|if
literal|0
block|ficlFILE *ff = (ficlFILE *)stackPopPtr(pVM->pStack);     CELL id = pVM->sourceID;     char    cp[nLINEBUF];     int     nLine = 0;     int     keepGoing;     int     result;     pVM->sourceID.p = (void *)ff;
comment|/* feed each line to ficlExec */
block|keepGoing = TRUE;     while (keepGoing&& fgets(cp, nLINEBUF, ff->f))     {         int len = strlen(cp) - 1;          nLine++;         if (len<= 0)             continue;          if (cp[len] == '\n')             cp[len] = '\0';          result = ficlExec(pVM, cp);          switch (result)         {             case VM_OUTOFTEXT:             case VM_USEREXIT:                 break;              default:                 pVM->sourceID = id;                 keepGoing = FALSE;                 break;          }     }
endif|#
directive|endif
comment|/* 0 */
comment|/*     ** Pass an empty line with SOURCE-ID == -1 to flush     ** any pending REFILLs (as required by FILE wordset)     */
name|pVM
operator|->
name|sourceID
operator|.
name|i
operator|=
operator|-
literal|1
expr_stmt|;
name|ficlExec
argument_list|(
name|pVM
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|pVM
operator|->
name|sourceID
operator|=
name|id
expr_stmt|;
name|closeFiclFILE
argument_list|(
name|ff
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ficlReadFile
parameter_list|(
name|FICL_VM
modifier|*
name|pVM
parameter_list|)
comment|/* ( c-addr u1 fileid -- u2 ior ) */
block|{
name|ficlFILE
modifier|*
name|ff
init|=
operator|(
name|ficlFILE
operator|*
operator|)
name|stackPopPtr
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|)
decl_stmt|;
name|int
name|length
init|=
name|stackPopINT
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|)
decl_stmt|;
name|void
modifier|*
name|address
init|=
operator|(
name|void
operator|*
operator|)
name|stackPopPtr
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|)
decl_stmt|;
name|int
name|result
decl_stmt|;
name|clearerr
argument_list|(
name|ff
operator|->
name|f
argument_list|)
expr_stmt|;
name|result
operator|=
name|fread
argument_list|(
name|address
argument_list|,
literal|1
argument_list|,
name|length
argument_list|,
name|ff
operator|->
name|f
argument_list|)
expr_stmt|;
name|stackPushINT
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|,
name|result
argument_list|)
expr_stmt|;
name|pushIor
argument_list|(
name|pVM
argument_list|,
name|ferror
argument_list|(
name|ff
operator|->
name|f
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ficlReadLine
parameter_list|(
name|FICL_VM
modifier|*
name|pVM
parameter_list|)
comment|/* ( c-addr u1 fileid -- u2 flag ior ) */
block|{
name|ficlFILE
modifier|*
name|ff
init|=
operator|(
name|ficlFILE
operator|*
operator|)
name|stackPopPtr
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|)
decl_stmt|;
name|int
name|length
init|=
name|stackPopINT
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|)
decl_stmt|;
name|char
modifier|*
name|address
init|=
operator|(
name|char
operator|*
operator|)
name|stackPopPtr
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|)
decl_stmt|;
name|int
name|error
decl_stmt|;
name|int
name|flag
decl_stmt|;
if|if
condition|(
name|feof
argument_list|(
name|ff
operator|->
name|f
argument_list|)
condition|)
block|{
name|stackPushINT
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|stackPushINT
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|stackPushINT
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
name|clearerr
argument_list|(
name|ff
operator|->
name|f
argument_list|)
expr_stmt|;
operator|*
name|address
operator|=
literal|0
expr_stmt|;
name|fgets
argument_list|(
name|address
argument_list|,
name|length
argument_list|,
name|ff
operator|->
name|f
argument_list|)
expr_stmt|;
name|error
operator|=
name|ferror
argument_list|(
name|ff
operator|->
name|f
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|stackPushINT
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|stackPushINT
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|stackPushINT
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return;
block|}
name|length
operator|=
name|strlen
argument_list|(
name|address
argument_list|)
expr_stmt|;
name|flag
operator|=
operator|(
name|length
operator|>
literal|0
operator|)
expr_stmt|;
if|if
condition|(
name|length
operator|&&
operator|(
operator|(
name|address
index|[
name|length
operator|-
literal|1
index|]
operator|==
literal|'\r'
operator|)
operator|||
operator|(
name|address
index|[
name|length
operator|-
literal|1
index|]
operator|==
literal|'\n'
operator|)
operator|)
condition|)
name|length
operator|--
expr_stmt|;
name|stackPushINT
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|,
name|length
argument_list|)
expr_stmt|;
name|stackPushINT
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|,
name|flag
argument_list|)
expr_stmt|;
name|stackPushINT
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* ior */
block|}
end_function

begin_function
specifier|static
name|void
name|ficlWriteFile
parameter_list|(
name|FICL_VM
modifier|*
name|pVM
parameter_list|)
comment|/* ( c-addr u1 fileid -- ior ) */
block|{
name|ficlFILE
modifier|*
name|ff
init|=
operator|(
name|ficlFILE
operator|*
operator|)
name|stackPopPtr
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|)
decl_stmt|;
name|int
name|length
init|=
name|stackPopINT
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|)
decl_stmt|;
name|void
modifier|*
name|address
init|=
operator|(
name|void
operator|*
operator|)
name|stackPopPtr
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|)
decl_stmt|;
name|clearerr
argument_list|(
name|ff
operator|->
name|f
argument_list|)
expr_stmt|;
name|fwrite
argument_list|(
name|address
argument_list|,
literal|1
argument_list|,
name|length
argument_list|,
name|ff
operator|->
name|f
argument_list|)
expr_stmt|;
name|pushIor
argument_list|(
name|pVM
argument_list|,
name|ferror
argument_list|(
name|ff
operator|->
name|f
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ficlWriteLine
parameter_list|(
name|FICL_VM
modifier|*
name|pVM
parameter_list|)
comment|/* ( c-addr u1 fileid -- ior ) */
block|{
name|ficlFILE
modifier|*
name|ff
init|=
operator|(
name|ficlFILE
operator|*
operator|)
name|stackPopPtr
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|)
decl_stmt|;
name|size_t
name|length
init|=
operator|(
name|size_t
operator|)
name|stackPopINT
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|)
decl_stmt|;
name|void
modifier|*
name|address
init|=
operator|(
name|void
operator|*
operator|)
name|stackPopPtr
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|)
decl_stmt|;
name|clearerr
argument_list|(
name|ff
operator|->
name|f
argument_list|)
expr_stmt|;
if|if
condition|(
name|fwrite
argument_list|(
name|address
argument_list|,
literal|1
argument_list|,
name|length
argument_list|,
name|ff
operator|->
name|f
argument_list|)
operator|==
name|length
condition|)
name|fwrite
argument_list|(
literal|"\n"
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|ff
operator|->
name|f
argument_list|)
expr_stmt|;
name|pushIor
argument_list|(
name|pVM
argument_list|,
name|ferror
argument_list|(
name|ff
operator|->
name|f
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ficlRepositionFile
parameter_list|(
name|FICL_VM
modifier|*
name|pVM
parameter_list|)
comment|/* ( ud fileid -- ior ) */
block|{
name|ficlFILE
modifier|*
name|ff
init|=
operator|(
name|ficlFILE
operator|*
operator|)
name|stackPopPtr
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|)
decl_stmt|;
name|size_t
name|ud
init|=
operator|(
name|size_t
operator|)
name|stackPopINT
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|)
decl_stmt|;
name|pushIor
argument_list|(
name|pVM
argument_list|,
name|fseek
argument_list|(
name|ff
operator|->
name|f
argument_list|,
name|ud
argument_list|,
name|SEEK_SET
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ficlFlushFile
parameter_list|(
name|FICL_VM
modifier|*
name|pVM
parameter_list|)
comment|/* ( fileid -- ior ) */
block|{
name|ficlFILE
modifier|*
name|ff
init|=
operator|(
name|ficlFILE
operator|*
operator|)
name|stackPopPtr
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|)
decl_stmt|;
name|pushIor
argument_list|(
name|pVM
argument_list|,
name|fflush
argument_list|(
name|ff
operator|->
name|f
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_if
if|#
directive|if
name|FICL_HAVE_FTRUNCATE
end_if

begin_function
specifier|static
name|void
name|ficlResizeFile
parameter_list|(
name|FICL_VM
modifier|*
name|pVM
parameter_list|)
comment|/* ( ud fileid -- ior ) */
block|{
name|ficlFILE
modifier|*
name|ff
init|=
operator|(
name|ficlFILE
operator|*
operator|)
name|stackPopPtr
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|)
decl_stmt|;
name|size_t
name|ud
init|=
operator|(
name|size_t
operator|)
name|stackPopINT
argument_list|(
name|pVM
operator|->
name|pStack
argument_list|)
decl_stmt|;
name|pushIor
argument_list|(
name|pVM
argument_list|,
name|ftruncate
argument_list|(
name|fileno
argument_list|(
name|ff
operator|->
name|f
argument_list|)
argument_list|,
name|ud
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* FICL_HAVE_FTRUNCATE */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* FICL_WANT_FILE */
end_comment

begin_function
name|void
name|ficlCompileFile
parameter_list|(
name|FICL_SYSTEM
modifier|*
name|pSys
parameter_list|)
block|{
if|#
directive|if
name|FICL_WANT_FILE
name|FICL_DICT
modifier|*
name|dp
init|=
name|pSys
operator|->
name|dp
decl_stmt|;
name|assert
argument_list|(
name|dp
argument_list|)
expr_stmt|;
name|dictAppendWord
argument_list|(
name|dp
argument_list|,
literal|"create-file"
argument_list|,
name|ficlCreateFile
argument_list|,
name|FW_DEFAULT
argument_list|)
expr_stmt|;
name|dictAppendWord
argument_list|(
name|dp
argument_list|,
literal|"open-file"
argument_list|,
name|ficlOpenFile
argument_list|,
name|FW_DEFAULT
argument_list|)
expr_stmt|;
name|dictAppendWord
argument_list|(
name|dp
argument_list|,
literal|"close-file"
argument_list|,
name|ficlCloseFile
argument_list|,
name|FW_DEFAULT
argument_list|)
expr_stmt|;
name|dictAppendWord
argument_list|(
name|dp
argument_list|,
literal|"include-file"
argument_list|,
name|ficlIncludeFile
argument_list|,
name|FW_DEFAULT
argument_list|)
expr_stmt|;
name|dictAppendWord
argument_list|(
name|dp
argument_list|,
literal|"read-file"
argument_list|,
name|ficlReadFile
argument_list|,
name|FW_DEFAULT
argument_list|)
expr_stmt|;
name|dictAppendWord
argument_list|(
name|dp
argument_list|,
literal|"read-line"
argument_list|,
name|ficlReadLine
argument_list|,
name|FW_DEFAULT
argument_list|)
expr_stmt|;
name|dictAppendWord
argument_list|(
name|dp
argument_list|,
literal|"write-file"
argument_list|,
name|ficlWriteFile
argument_list|,
name|FW_DEFAULT
argument_list|)
expr_stmt|;
name|dictAppendWord
argument_list|(
name|dp
argument_list|,
literal|"write-line"
argument_list|,
name|ficlWriteLine
argument_list|,
name|FW_DEFAULT
argument_list|)
expr_stmt|;
name|dictAppendWord
argument_list|(
name|dp
argument_list|,
literal|"file-position"
argument_list|,
name|ficlFilePosition
argument_list|,
name|FW_DEFAULT
argument_list|)
expr_stmt|;
name|dictAppendWord
argument_list|(
name|dp
argument_list|,
literal|"file-size"
argument_list|,
name|ficlFileSize
argument_list|,
name|FW_DEFAULT
argument_list|)
expr_stmt|;
name|dictAppendWord
argument_list|(
name|dp
argument_list|,
literal|"reposition-file"
argument_list|,
name|ficlRepositionFile
argument_list|,
name|FW_DEFAULT
argument_list|)
expr_stmt|;
name|dictAppendWord
argument_list|(
name|dp
argument_list|,
literal|"file-status"
argument_list|,
name|ficlFileStatus
argument_list|,
name|FW_DEFAULT
argument_list|)
expr_stmt|;
name|dictAppendWord
argument_list|(
name|dp
argument_list|,
literal|"flush-file"
argument_list|,
name|ficlFlushFile
argument_list|,
name|FW_DEFAULT
argument_list|)
expr_stmt|;
name|dictAppendWord
argument_list|(
name|dp
argument_list|,
literal|"delete-file"
argument_list|,
name|ficlDeleteFile
argument_list|,
name|FW_DEFAULT
argument_list|)
expr_stmt|;
name|dictAppendWord
argument_list|(
name|dp
argument_list|,
literal|"rename-file"
argument_list|,
name|ficlRenameFile
argument_list|,
name|FW_DEFAULT
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|FICL_HAVE_FTRUNCATE
name|dictAppendWord
argument_list|(
name|dp
argument_list|,
literal|"resize-file"
argument_list|,
name|ficlResizeFile
argument_list|,
name|FW_DEFAULT
argument_list|)
expr_stmt|;
name|ficlSetEnv
argument_list|(
name|pSys
argument_list|,
literal|"file"
argument_list|,
name|FICL_TRUE
argument_list|)
expr_stmt|;
name|ficlSetEnv
argument_list|(
name|pSys
argument_list|,
literal|"file-ext"
argument_list|,
name|FICL_TRUE
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* FICL_HAVE_FTRUNCATE */
else|#
directive|else
operator|(
name|void
operator|)
name|pSys
expr_stmt|;
endif|#
directive|endif
comment|/* FICL_WANT_FILE */
block|}
end_function

end_unit


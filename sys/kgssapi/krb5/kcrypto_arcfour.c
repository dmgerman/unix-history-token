begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2008 Isilon Inc http://www.isilon.com/  * Authors: Doug Rabson<dfr@rabson.org>  * Developed with Red Inc: Alfred Perlstein<alfred@freebsd.org>  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/md5.h>
end_include

begin_include
include|#
directive|include
file|<sys/kobj.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<crypto/rc4/rc4.h>
end_include

begin_include
include|#
directive|include
file|<kgssapi/gssapi.h>
end_include

begin_include
include|#
directive|include
file|<kgssapi/gssapi_impl.h>
end_include

begin_include
include|#
directive|include
file|"kcrypto.h"
end_include

begin_function
specifier|static
name|void
name|arcfour_init
parameter_list|(
name|struct
name|krb5_key_state
modifier|*
name|ks
parameter_list|)
block|{
name|ks
operator|->
name|ks_priv
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|arcfour_destroy
parameter_list|(
name|struct
name|krb5_key_state
modifier|*
name|ks
parameter_list|)
block|{  }
end_function

begin_function
specifier|static
name|void
name|arcfour_set_key
parameter_list|(
name|struct
name|krb5_key_state
modifier|*
name|ks
parameter_list|,
specifier|const
name|void
modifier|*
name|in
parameter_list|)
block|{
name|void
modifier|*
name|kp
init|=
name|ks
operator|->
name|ks_key
decl_stmt|;
if|if
condition|(
name|kp
operator|!=
name|in
condition|)
name|bcopy
argument_list|(
name|in
argument_list|,
name|kp
argument_list|,
literal|16
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|arcfour_random_to_key
parameter_list|(
name|struct
name|krb5_key_state
modifier|*
name|ks
parameter_list|,
specifier|const
name|void
modifier|*
name|in
parameter_list|)
block|{
name|arcfour_set_key
argument_list|(
name|ks
argument_list|,
name|in
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|arcfour_hmac
parameter_list|(
name|uint8_t
modifier|*
name|key
parameter_list|,
name|uint8_t
modifier|*
name|data
parameter_list|,
name|size_t
name|datalen
parameter_list|,
name|uint8_t
modifier|*
name|result
parameter_list|)
block|{
name|uint8_t
name|buf
index|[
literal|64
index|]
decl_stmt|;
name|MD5_CTX
name|md5
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
name|buf
index|[
name|i
index|]
operator|=
name|key
index|[
name|i
index|]
operator|^
literal|0x36
expr_stmt|;
for|for
control|(
init|;
name|i
operator|<
literal|64
condition|;
name|i
operator|++
control|)
name|buf
index|[
name|i
index|]
operator|=
literal|0x36
expr_stmt|;
name|MD5Init
argument_list|(
operator|&
name|md5
argument_list|)
expr_stmt|;
name|MD5Update
argument_list|(
operator|&
name|md5
argument_list|,
name|buf
argument_list|,
literal|64
argument_list|)
expr_stmt|;
name|MD5Update
argument_list|(
operator|&
name|md5
argument_list|,
name|data
argument_list|,
name|datalen
argument_list|)
expr_stmt|;
name|MD5Final
argument_list|(
name|result
argument_list|,
operator|&
name|md5
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
name|buf
index|[
name|i
index|]
operator|=
name|key
index|[
name|i
index|]
operator|^
literal|0x5c
expr_stmt|;
for|for
control|(
init|;
name|i
operator|<
literal|64
condition|;
name|i
operator|++
control|)
name|buf
index|[
name|i
index|]
operator|=
literal|0x5c
expr_stmt|;
name|MD5Init
argument_list|(
operator|&
name|md5
argument_list|)
expr_stmt|;
name|MD5Update
argument_list|(
operator|&
name|md5
argument_list|,
name|buf
argument_list|,
literal|64
argument_list|)
expr_stmt|;
name|MD5Update
argument_list|(
operator|&
name|md5
argument_list|,
name|result
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|MD5Final
argument_list|(
name|result
argument_list|,
operator|&
name|md5
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|arcfour_derive_key
parameter_list|(
specifier|const
name|struct
name|krb5_key_state
modifier|*
name|ks
parameter_list|,
name|uint32_t
name|usage
parameter_list|,
name|uint8_t
modifier|*
name|newkey
parameter_list|)
block|{
name|uint8_t
name|t
index|[
literal|4
index|]
decl_stmt|;
name|t
index|[
literal|0
index|]
operator|=
operator|(
name|usage
operator|>>
literal|24
operator|)
expr_stmt|;
name|t
index|[
literal|1
index|]
operator|=
operator|(
name|usage
operator|>>
literal|16
operator|)
expr_stmt|;
name|t
index|[
literal|2
index|]
operator|=
operator|(
name|usage
operator|>>
literal|8
operator|)
expr_stmt|;
name|t
index|[
literal|3
index|]
operator|=
operator|(
name|usage
operator|>>
literal|0
operator|)
expr_stmt|;
if|if
condition|(
name|ks
operator|->
name|ks_class
operator|->
name|ec_type
operator|==
name|ETYPE_ARCFOUR_HMAC_MD5_56
condition|)
block|{
name|uint8_t
name|L40
index|[
literal|14
index|]
init|=
literal|"fortybits"
decl_stmt|;
name|bcopy
argument_list|(
name|t
argument_list|,
name|L40
operator|+
literal|10
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|arcfour_hmac
argument_list|(
name|ks
operator|->
name|ks_key
argument_list|,
name|L40
argument_list|,
literal|14
argument_list|,
name|newkey
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|newkey
operator|+
literal|7
argument_list|,
literal|0xab
argument_list|,
literal|9
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|arcfour_hmac
argument_list|(
name|ks
operator|->
name|ks_key
argument_list|,
name|t
argument_list|,
literal|4
argument_list|,
name|newkey
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|rc4_crypt_int
parameter_list|(
name|void
modifier|*
name|rs
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|,
name|u_int
name|len
parameter_list|)
block|{
name|rc4_crypt
argument_list|(
name|rs
argument_list|,
name|buf
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|arcfour_encrypt
parameter_list|(
specifier|const
name|struct
name|krb5_key_state
modifier|*
name|ks
parameter_list|,
name|struct
name|mbuf
modifier|*
name|inout
parameter_list|,
name|size_t
name|skip
parameter_list|,
name|size_t
name|len
parameter_list|,
name|void
modifier|*
name|ivec
parameter_list|,
name|size_t
name|ivlen
parameter_list|)
block|{
name|struct
name|rc4_state
name|rs
decl_stmt|;
name|uint8_t
name|newkey
index|[
literal|16
index|]
decl_stmt|;
name|arcfour_derive_key
argument_list|(
name|ks
argument_list|,
literal|0
argument_list|,
name|newkey
argument_list|)
expr_stmt|;
comment|/* 	 * If we have an IV, then generate a new key from it using HMAC. 	 */
if|if
condition|(
name|ivec
condition|)
block|{
name|uint8_t
name|kk
index|[
literal|16
index|]
decl_stmt|;
name|arcfour_hmac
argument_list|(
name|newkey
argument_list|,
name|ivec
argument_list|,
name|ivlen
argument_list|,
name|kk
argument_list|)
expr_stmt|;
name|rc4_init
argument_list|(
operator|&
name|rs
argument_list|,
name|kk
argument_list|,
literal|16
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|rc4_init
argument_list|(
operator|&
name|rs
argument_list|,
name|newkey
argument_list|,
literal|16
argument_list|)
expr_stmt|;
block|}
name|m_apply
argument_list|(
name|inout
argument_list|,
name|skip
argument_list|,
name|len
argument_list|,
name|rc4_crypt_int
argument_list|,
operator|&
name|rs
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|MD5Update_int
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|,
name|u_int
name|len
parameter_list|)
block|{
name|MD5Update
argument_list|(
name|ctx
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|arcfour_checksum
parameter_list|(
specifier|const
name|struct
name|krb5_key_state
modifier|*
name|ks
parameter_list|,
name|int
name|usage
parameter_list|,
name|struct
name|mbuf
modifier|*
name|inout
parameter_list|,
name|size_t
name|skip
parameter_list|,
name|size_t
name|inlen
parameter_list|,
name|size_t
name|outlen
parameter_list|)
block|{
name|MD5_CTX
name|md5
decl_stmt|;
name|uint8_t
name|Ksign
index|[
literal|16
index|]
decl_stmt|;
name|uint8_t
name|t
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|sgn_cksum
index|[
literal|16
index|]
decl_stmt|;
name|arcfour_hmac
argument_list|(
name|ks
operator|->
name|ks_key
argument_list|,
literal|"signaturekey"
argument_list|,
literal|13
argument_list|,
name|Ksign
argument_list|)
expr_stmt|;
name|t
index|[
literal|0
index|]
operator|=
name|usage
operator|>>
literal|0
expr_stmt|;
name|t
index|[
literal|1
index|]
operator|=
name|usage
operator|>>
literal|8
expr_stmt|;
name|t
index|[
literal|2
index|]
operator|=
name|usage
operator|>>
literal|16
expr_stmt|;
name|t
index|[
literal|3
index|]
operator|=
name|usage
operator|>>
literal|24
expr_stmt|;
name|MD5Init
argument_list|(
operator|&
name|md5
argument_list|)
expr_stmt|;
name|MD5Update
argument_list|(
operator|&
name|md5
argument_list|,
name|t
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|m_apply
argument_list|(
name|inout
argument_list|,
name|skip
argument_list|,
name|inlen
argument_list|,
name|MD5Update_int
argument_list|,
operator|&
name|md5
argument_list|)
expr_stmt|;
name|MD5Final
argument_list|(
name|sgn_cksum
argument_list|,
operator|&
name|md5
argument_list|)
expr_stmt|;
name|arcfour_hmac
argument_list|(
name|Ksign
argument_list|,
name|sgn_cksum
argument_list|,
literal|16
argument_list|,
name|sgn_cksum
argument_list|)
expr_stmt|;
name|m_copyback
argument_list|(
name|inout
argument_list|,
name|skip
operator|+
name|inlen
argument_list|,
name|outlen
argument_list|,
name|sgn_cksum
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
name|struct
name|krb5_encryption_class
name|krb5_arcfour_encryption_class
init|=
block|{
literal|"arcfour-hmac-md5"
block|,
comment|/* name */
name|ETYPE_ARCFOUR_HMAC_MD5
block|,
comment|/* etype */
literal|0
block|,
comment|/* flags */
literal|1
block|,
comment|/* blocklen */
literal|1
block|,
comment|/* msgblocklen */
literal|8
block|,
comment|/* checksumlen */
literal|128
block|,
comment|/* keybits */
literal|16
block|,
comment|/* keylen */
name|arcfour_init
block|,
name|arcfour_destroy
block|,
name|arcfour_set_key
block|,
name|arcfour_random_to_key
block|,
name|arcfour_encrypt
block|,
name|arcfour_encrypt
block|,
name|arcfour_checksum
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|krb5_encryption_class
name|krb5_arcfour_56_encryption_class
init|=
block|{
literal|"arcfour-hmac-md5-56"
block|,
comment|/* name */
name|ETYPE_ARCFOUR_HMAC_MD5_56
block|,
comment|/* etype */
literal|0
block|,
comment|/* flags */
literal|1
block|,
comment|/* blocklen */
literal|1
block|,
comment|/* msgblocklen */
literal|8
block|,
comment|/* checksumlen */
literal|128
block|,
comment|/* keybits */
literal|16
block|,
comment|/* keylen */
name|arcfour_init
block|,
name|arcfour_destroy
block|,
name|arcfour_set_key
block|,
name|arcfour_random_to_key
block|,
name|arcfour_encrypt
block|,
name|arcfour_encrypt
block|,
name|arcfour_checksum
block|}
decl_stmt|;
end_decl_stmt

end_unit


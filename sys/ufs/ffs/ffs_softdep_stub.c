begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright 1998 Marshall Kirk McKusick. All Rights Reserved.  *  * The soft updates code is derived from the appendix of a University  * of Michigan technical report (Gregory R. Ganger and Yale N. Patt,  * "Soft Updates: A Solution to the Metadata Update Problem in File  * Systems", CSE-TR-254-95, August 1995).  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. None of the names of McKusick, Ganger, or the University of Michigan  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY MARSHALL KIRK MCKUSICK ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL MARSHALL KIRK MCKUSICK BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  *	from: @(#)ffs_softdep_stub.c	9.1 (McKusick) 7/10/97  */
end_comment

begin_comment
comment|/*   * Use this file as ffs_softdep.c if you do not wish the real ffs_softdep.c  * to be included in your system. (e.g for legal reasons )  * The real files are in /usr/src/contrib/sys/softupdates.  * You must copy them here before you can use soft updates.  * Read the README for legal and technical information.  */
end_comment

begin_include
include|#
directive|include
file|"opt_ffs.h"
end_include

begin_if
if|#
directive|if
operator|(
name|SOFTUPDATES
operator|==
literal|0
operator|)
end_if

begin_comment
comment|/* SOFTUPDATES not configured in, use these stubs. */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/vnode.h>
end_include

begin_include
include|#
directive|include
file|<ufs/ufs/quota.h>
end_include

begin_include
include|#
directive|include
file|<ufs/ufs/inode.h>
end_include

begin_include
include|#
directive|include
file|<ufs/ffs/ffs_extern.h>
end_include

begin_include
include|#
directive|include
file|<ufs/ufs/ufs_extern.h>
end_include

begin_function
name|int
name|softdep_flushfiles
parameter_list|(
name|oldmnt
parameter_list|,
name|flags
parameter_list|,
name|p
parameter_list|)
name|struct
name|mount
modifier|*
name|oldmnt
decl_stmt|;
name|int
name|flags
decl_stmt|;
name|struct
name|proc
modifier|*
name|p
decl_stmt|;
block|{
name|panic
argument_list|(
literal|"softdep_flushfiles called"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|softdep_mount
parameter_list|(
name|devvp
parameter_list|,
name|mp
parameter_list|,
name|fs
parameter_list|,
name|cred
parameter_list|)
name|struct
name|vnode
modifier|*
name|devvp
decl_stmt|;
name|struct
name|mount
modifier|*
name|mp
decl_stmt|;
name|struct
name|fs
modifier|*
name|fs
decl_stmt|;
name|struct
name|ucred
modifier|*
name|cred
decl_stmt|;
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|void
name|softdep_initialize
parameter_list|()
block|{
return|return;
block|}
end_function

begin_function
name|void
name|softdep_setup_inomapdep
parameter_list|(
name|bp
parameter_list|,
name|ip
parameter_list|,
name|newinum
parameter_list|)
name|struct
name|buf
modifier|*
name|bp
decl_stmt|;
name|struct
name|inode
modifier|*
name|ip
decl_stmt|;
name|ino_t
name|newinum
decl_stmt|;
block|{
name|panic
argument_list|(
literal|"softdep_setup_inomapdep called"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|softdep_setup_blkmapdep
parameter_list|(
name|bp
parameter_list|,
name|fs
parameter_list|,
name|newblkno
parameter_list|)
name|struct
name|buf
modifier|*
name|bp
decl_stmt|;
name|struct
name|fs
modifier|*
name|fs
decl_stmt|;
name|ufs_daddr_t
name|newblkno
decl_stmt|;
block|{
name|panic
argument_list|(
literal|"softdep_setup_blkmapdep called"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|softdep_setup_allocdirect
parameter_list|(
name|ip
parameter_list|,
name|lbn
parameter_list|,
name|newblkno
parameter_list|,
name|oldblkno
parameter_list|,
name|newsize
parameter_list|,
name|oldsize
parameter_list|,
name|bp
parameter_list|)
name|struct
name|inode
modifier|*
name|ip
decl_stmt|;
name|ufs_lbn_t
name|lbn
decl_stmt|;
name|ufs_daddr_t
name|newblkno
decl_stmt|;
name|ufs_daddr_t
name|oldblkno
decl_stmt|;
name|long
name|newsize
decl_stmt|;
name|long
name|oldsize
decl_stmt|;
name|struct
name|buf
modifier|*
name|bp
decl_stmt|;
block|{
name|panic
argument_list|(
literal|"softdep_setup_allocdirect called"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|softdep_setup_allocindir_page
parameter_list|(
name|ip
parameter_list|,
name|lbn
parameter_list|,
name|bp
parameter_list|,
name|ptrno
parameter_list|,
name|newblkno
parameter_list|,
name|oldblkno
parameter_list|,
name|nbp
parameter_list|)
name|struct
name|inode
modifier|*
name|ip
decl_stmt|;
name|ufs_lbn_t
name|lbn
decl_stmt|;
name|struct
name|buf
modifier|*
name|bp
decl_stmt|;
name|int
name|ptrno
decl_stmt|;
name|ufs_daddr_t
name|newblkno
decl_stmt|;
name|ufs_daddr_t
name|oldblkno
decl_stmt|;
name|struct
name|buf
modifier|*
name|nbp
decl_stmt|;
block|{
name|panic
argument_list|(
literal|"softdep_setup_allocindir_page called"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|softdep_setup_allocindir_meta
parameter_list|(
name|nbp
parameter_list|,
name|ip
parameter_list|,
name|bp
parameter_list|,
name|ptrno
parameter_list|,
name|newblkno
parameter_list|)
name|struct
name|buf
modifier|*
name|nbp
decl_stmt|;
name|struct
name|inode
modifier|*
name|ip
decl_stmt|;
name|struct
name|buf
modifier|*
name|bp
decl_stmt|;
name|int
name|ptrno
decl_stmt|;
name|ufs_daddr_t
name|newblkno
decl_stmt|;
block|{
name|panic
argument_list|(
literal|"softdep_setup_allocindir_meta called"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|softdep_setup_freeblocks
parameter_list|(
name|ip
parameter_list|,
name|length
parameter_list|)
name|struct
name|inode
modifier|*
name|ip
decl_stmt|;
name|off_t
name|length
decl_stmt|;
block|{
name|panic
argument_list|(
literal|"softdep_setup_freeblocks called"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* XXX needed to change this for FreeBSD.. hit poul */
end_comment

begin_function
name|void
name|softdep_freefile
parameter_list|(
name|pvp
parameter_list|,
name|ino
parameter_list|,
name|mode
parameter_list|)
name|struct
name|vnode
modifier|*
name|pvp
decl_stmt|;
name|ino_t
name|ino
decl_stmt|;
name|int
name|mode
decl_stmt|;
block|{
name|panic
argument_list|(
literal|"softdep_freefile called"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|softdep_setup_directory_add
parameter_list|(
name|bp
parameter_list|,
name|dp
parameter_list|,
name|diroffset
parameter_list|,
name|newinum
parameter_list|,
name|newdirbp
parameter_list|)
name|struct
name|buf
modifier|*
name|bp
decl_stmt|;
name|struct
name|inode
modifier|*
name|dp
decl_stmt|;
name|off_t
name|diroffset
decl_stmt|;
name|long
name|newinum
decl_stmt|;
name|struct
name|buf
modifier|*
name|newdirbp
decl_stmt|;
block|{
name|panic
argument_list|(
literal|"softdep_setup_directory_add called"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|softdep_change_directoryentry_offset
parameter_list|(
name|dp
parameter_list|,
name|base
parameter_list|,
name|oldloc
parameter_list|,
name|newloc
parameter_list|,
name|entrysize
parameter_list|)
name|struct
name|inode
modifier|*
name|dp
decl_stmt|;
name|caddr_t
name|base
decl_stmt|;
name|caddr_t
name|oldloc
decl_stmt|;
name|caddr_t
name|newloc
decl_stmt|;
name|int
name|entrysize
decl_stmt|;
block|{
name|panic
argument_list|(
literal|"softdep_change_directoryentry_offset called"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|softdep_setup_remove
parameter_list|(
name|bp
parameter_list|,
name|dp
parameter_list|,
name|ip
parameter_list|,
name|isrmdir
parameter_list|)
name|struct
name|buf
modifier|*
name|bp
decl_stmt|;
name|struct
name|inode
modifier|*
name|dp
decl_stmt|;
name|struct
name|inode
modifier|*
name|ip
decl_stmt|;
name|int
name|isrmdir
decl_stmt|;
block|{
name|panic
argument_list|(
literal|"softdep_setup_remove called"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|softdep_setup_directory_change
parameter_list|(
name|bp
parameter_list|,
name|dp
parameter_list|,
name|ip
parameter_list|,
name|newinum
parameter_list|,
name|isrmdir
parameter_list|)
name|struct
name|buf
modifier|*
name|bp
decl_stmt|;
name|struct
name|inode
modifier|*
name|dp
decl_stmt|;
name|struct
name|inode
modifier|*
name|ip
decl_stmt|;
name|long
name|newinum
decl_stmt|;
name|int
name|isrmdir
decl_stmt|;
block|{
name|panic
argument_list|(
literal|"softdep_setup_directory_change called"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|softdep_increase_linkcnt
parameter_list|(
name|ip
parameter_list|)
name|struct
name|inode
modifier|*
name|ip
decl_stmt|;
block|{
name|panic
argument_list|(
literal|"softdep_increase_linkcnt called"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|softdep_load_inodeblock
parameter_list|(
name|ip
parameter_list|)
name|struct
name|inode
modifier|*
name|ip
decl_stmt|;
block|{
name|panic
argument_list|(
literal|"softdep_load_inodeblock called"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|softdep_update_inodeblock
parameter_list|(
name|ip
parameter_list|,
name|bp
parameter_list|,
name|waitfor
parameter_list|)
name|struct
name|inode
modifier|*
name|ip
decl_stmt|;
name|struct
name|buf
modifier|*
name|bp
decl_stmt|;
name|int
name|waitfor
decl_stmt|;
block|{
name|panic
argument_list|(
literal|"softdep_update_inodeblock called"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|softdep_fsync
parameter_list|(
name|vp
parameter_list|)
name|struct
name|vnode
modifier|*
name|vp
decl_stmt|;
block|{
name|panic
argument_list|(
literal|"softdep_fsync called"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EIO
operator|)
return|;
block|}
end_function

begin_function
name|int
name|softdep_sync_metadata
parameter_list|(
name|ap
parameter_list|)
name|struct
name|vop_fsync_args
comment|/* { 		struct vnode *a_vp; 		struct ucred *a_cred; 		int a_waitfor; 		struct proc *a_p; 	} */
modifier|*
name|ap
decl_stmt|;
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* SOFTUPDATES not configured in */
end_comment

end_unit


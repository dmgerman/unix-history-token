begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1990,1991 Regents of The University of Michigan.  * All Rights Reserved.  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/errno.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/socketvar.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/route.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_undef
undef|#
directive|undef
name|s_net
end_undef

begin_include
include|#
directive|include
file|<netinet/if_ether.h>
end_include

begin_include
include|#
directive|include
file|"at.h"
end_include

begin_include
include|#
directive|include
file|"at_var.h"
end_include

begin_include
include|#
directive|include
file|"aarp.h"
end_include

begin_include
include|#
directive|include
file|"phase2.h"
end_include

begin_include
include|#
directive|include
file|<netatalk/at_extern.h>
end_include

begin_function_decl
specifier|static
name|int
name|aa_addrangeroute
parameter_list|(
name|struct
name|ifaddr
modifier|*
name|ifa
parameter_list|,
name|int
name|first
parameter_list|,
name|int
name|last
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|aa_addsingleroute
parameter_list|(
name|struct
name|ifaddr
modifier|*
name|ifa
parameter_list|,
name|struct
name|at_addr
modifier|*
name|addr
parameter_list|,
name|struct
name|at_addr
modifier|*
name|mask
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|aa_delsingleroute
parameter_list|(
name|struct
name|ifaddr
modifier|*
name|ifa
parameter_list|,
name|struct
name|at_addr
modifier|*
name|addr
parameter_list|,
name|struct
name|at_addr
modifier|*
name|mask
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|aa_dosingleroute
parameter_list|(
name|struct
name|ifaddr
modifier|*
name|ifa
parameter_list|,
name|struct
name|at_addr
modifier|*
name|addr
parameter_list|,
name|struct
name|at_addr
modifier|*
name|mask
parameter_list|,
name|int
name|cmd
parameter_list|,
name|int
name|flags
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|at_scrub
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|at_ifaddr
modifier|*
name|aa
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|at_ifinit
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|at_ifaddr
modifier|*
name|aa
parameter_list|,
name|struct
name|sockaddr_at
modifier|*
name|sat
parameter_list|)
function_decl|;
end_function_decl

begin_define
define|#
directive|define
name|sateqaddr
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
value|((a)->sat_len == (b)->sat_len&& \ 		    (a)->sat_family == (b)->sat_family&& \ 		    (a)->sat_addr.s_net == (b)->sat_addr.s_net&& \ 		    (a)->sat_addr.s_node == (b)->sat_addr.s_node )
end_define

begin_function
name|int
name|at_control
parameter_list|(
name|int
name|cmd
parameter_list|,
name|caddr_t
name|data
parameter_list|,
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|proc
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|ifreq
modifier|*
name|ifr
init|=
operator|(
expr|struct
name|ifreq
operator|*
operator|)
name|data
decl_stmt|;
name|struct
name|sockaddr_at
modifier|*
name|sat
decl_stmt|;
name|struct
name|netrange
modifier|*
name|nr
decl_stmt|;
name|struct
name|at_aliasreq
modifier|*
name|ifra
init|=
operator|(
expr|struct
name|at_aliasreq
operator|*
operator|)
name|data
decl_stmt|;
name|struct
name|at_ifaddr
modifier|*
name|aa0
decl_stmt|;
name|struct
name|at_ifaddr
modifier|*
name|aa
init|=
literal|0
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|struct
name|ifaddr
modifier|*
name|ifa
decl_stmt|;
if|if
condition|(
name|ifp
condition|)
block|{
for|for
control|(
name|aa
operator|=
name|at_ifaddr
init|;
name|aa
condition|;
name|aa
operator|=
name|aa
operator|->
name|aa_next
control|)
block|{
if|if
condition|(
name|aa
operator|->
name|aa_ifp
operator|==
name|ifp
condition|)
break|break;
block|}
block|}
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|SIOCAIFADDR
case|:
case|case
name|SIOCDIFADDR
case|:
if|if
condition|(
name|ifra
operator|->
name|ifra_addr
operator|.
name|sat_family
operator|==
name|AF_APPLETALK
condition|)
block|{
for|for
control|(
init|;
name|aa
condition|;
name|aa
operator|=
name|aa
operator|->
name|aa_next
control|)
block|{
if|if
condition|(
name|aa
operator|->
name|aa_ifp
operator|==
name|ifp
operator|&&
name|sateqaddr
argument_list|(
operator|&
name|aa
operator|->
name|aa_addr
argument_list|,
operator|&
name|ifra
operator|->
name|ifra_addr
argument_list|)
condition|)
block|{
break|break;
block|}
block|}
block|}
if|if
condition|(
name|cmd
operator|==
name|SIOCDIFADDR
operator|&&
name|aa
operator|==
literal|0
condition|)
block|{
return|return
operator|(
name|EADDRNOTAVAIL
operator|)
return|;
block|}
comment|/*FALLTHROUGH*/
case|case
name|SIOCSIFADDR
case|:
if|if
condition|(
name|suser
argument_list|(
name|p
operator|->
name|p_ucred
argument_list|,
operator|&
name|p
operator|->
name|p_acflag
argument_list|)
condition|)
block|{
return|return
operator|(
name|EPERM
operator|)
return|;
block|}
name|sat
operator|=
name|satosat
argument_list|(
operator|&
name|ifr
operator|->
name|ifr_addr
argument_list|)
expr_stmt|;
name|nr
operator|=
operator|(
expr|struct
name|netrange
operator|*
operator|)
name|sat
operator|->
name|sat_zero
expr_stmt|;
if|if
condition|(
name|nr
operator|->
name|nr_phase
operator|==
literal|1
condition|)
block|{
for|for
control|(
init|;
name|aa
condition|;
name|aa
operator|=
name|aa
operator|->
name|aa_next
control|)
block|{
if|if
condition|(
name|aa
operator|->
name|aa_ifp
operator|==
name|ifp
operator|&&
operator|(
name|aa
operator|->
name|aa_flags
operator|&
name|AFA_PHASE2
operator|)
operator|==
literal|0
condition|)
block|{
break|break;
block|}
block|}
block|}
else|else
block|{
comment|/* default to phase 2 */
for|for
control|(
init|;
name|aa
condition|;
name|aa
operator|=
name|aa
operator|->
name|aa_next
control|)
block|{
if|if
condition|(
name|aa
operator|->
name|aa_ifp
operator|==
name|ifp
operator|&&
operator|(
name|aa
operator|->
name|aa_flags
operator|&
name|AFA_PHASE2
operator|)
condition|)
block|{
break|break;
block|}
block|}
block|}
if|if
condition|(
name|ifp
operator|==
literal|0
condition|)
name|panic
argument_list|(
literal|"at_control"
argument_list|)
expr_stmt|;
if|if
condition|(
name|aa
operator|==
operator|(
expr|struct
name|at_ifaddr
operator|*
operator|)
literal|0
condition|)
block|{
name|m
operator|=
name|m_getclr
argument_list|(
name|M_WAIT
argument_list|,
name|MT_IFADDR
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
operator|(
expr|struct
name|mbuf
operator|*
operator|)
name|NULL
condition|)
block|{
return|return
operator|(
name|ENOBUFS
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|aa
operator|=
name|at_ifaddr
operator|)
operator|!=
name|NULL
condition|)
block|{
comment|/* 		 * Don't let the loopback be first, since the first 		 * address is the machine's default address for 		 * binding. 		 */
if|if
condition|(
name|at_ifaddr
operator|->
name|aa_ifp
operator|->
name|if_flags
operator|&
name|IFF_LOOPBACK
condition|)
block|{
name|aa
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|at_ifaddr
operator|*
argument_list|)
expr_stmt|;
name|aa
operator|->
name|aa_next
operator|=
name|at_ifaddr
expr_stmt|;
name|at_ifaddr
operator|=
name|aa
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
init|;
name|aa
operator|->
name|aa_next
condition|;
name|aa
operator|=
name|aa
operator|->
name|aa_next
control|)
empty_stmt|;
name|aa
operator|->
name|aa_next
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|at_ifaddr
operator|*
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|at_ifaddr
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|at_ifaddr
operator|*
argument_list|)
expr_stmt|;
block|}
name|aa
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|at_ifaddr
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ifa
operator|=
name|ifp
operator|->
name|if_addrlist
operator|)
operator|!=
name|NULL
condition|)
block|{
for|for
control|(
init|;
name|ifa
operator|->
name|ifa_next
condition|;
name|ifa
operator|=
name|ifa
operator|->
name|ifa_next
control|)
empty_stmt|;
name|ifa
operator|->
name|ifa_next
operator|=
operator|(
expr|struct
name|ifaddr
operator|*
operator|)
name|aa
expr_stmt|;
block|}
else|else
block|{
name|ifp
operator|->
name|if_addrlist
operator|=
operator|(
expr|struct
name|ifaddr
operator|*
operator|)
name|aa
expr_stmt|;
block|}
name|aa
operator|->
name|aa_ifa
operator|.
name|ifa_addr
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|aa
operator|->
name|aa_addr
expr_stmt|;
name|aa
operator|->
name|aa_ifa
operator|.
name|ifa_dstaddr
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|aa
operator|->
name|aa_dstaddr
expr_stmt|;
name|aa
operator|->
name|aa_ifa
operator|.
name|ifa_netmask
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|aa
operator|->
name|aa_netmask
expr_stmt|;
comment|/* 	     * Set/clear the phase 2 bit. 	     */
if|if
condition|(
name|nr
operator|->
name|nr_phase
operator|==
literal|1
condition|)
block|{
name|aa
operator|->
name|aa_flags
operator|&=
operator|~
name|AFA_PHASE2
expr_stmt|;
block|}
else|else
block|{
name|aa
operator|->
name|aa_flags
operator||=
name|AFA_PHASE2
expr_stmt|;
block|}
name|aa
operator|->
name|aa_ifp
operator|=
name|ifp
expr_stmt|;
block|}
else|else
block|{
name|at_scrub
argument_list|(
name|ifp
argument_list|,
name|aa
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SIOCGIFADDR
case|:
name|sat
operator|=
name|satosat
argument_list|(
operator|&
name|ifr
operator|->
name|ifr_addr
argument_list|)
expr_stmt|;
name|nr
operator|=
operator|(
expr|struct
name|netrange
operator|*
operator|)
name|sat
operator|->
name|sat_zero
expr_stmt|;
if|if
condition|(
name|nr
operator|->
name|nr_phase
operator|==
literal|1
condition|)
block|{
for|for
control|(
init|;
name|aa
condition|;
name|aa
operator|=
name|aa
operator|->
name|aa_next
control|)
block|{
if|if
condition|(
name|aa
operator|->
name|aa_ifp
operator|==
name|ifp
operator|&&
operator|(
name|aa
operator|->
name|aa_flags
operator|&
name|AFA_PHASE2
operator|)
operator|==
literal|0
condition|)
block|{
break|break;
block|}
block|}
block|}
else|else
block|{
comment|/* default to phase 2 */
for|for
control|(
init|;
name|aa
condition|;
name|aa
operator|=
name|aa
operator|->
name|aa_next
control|)
block|{
if|if
condition|(
name|aa
operator|->
name|aa_ifp
operator|==
name|ifp
operator|&&
operator|(
name|aa
operator|->
name|aa_flags
operator|&
name|AFA_PHASE2
operator|)
condition|)
block|{
break|break;
block|}
block|}
block|}
if|if
condition|(
name|aa
operator|==
operator|(
expr|struct
name|at_ifaddr
operator|*
operator|)
literal|0
condition|)
return|return
operator|(
name|EADDRNOTAVAIL
operator|)
return|;
break|break;
block|}
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|SIOCGIFADDR
case|:
name|sat
operator|=
operator|(
expr|struct
name|sockaddr_at
operator|*
operator|)
operator|&
name|ifr
operator|->
name|ifr_addr
expr_stmt|;
operator|*
name|sat
operator|=
name|aa
operator|->
name|aa_addr
expr_stmt|;
operator|(
operator|(
expr|struct
name|netrange
operator|*
operator|)
operator|&
name|sat
operator|->
name|sat_zero
operator|)
operator|->
name|nr_phase
operator|=
operator|(
name|aa
operator|->
name|aa_flags
operator|&
name|AFA_PHASE2
operator|)
condition|?
literal|2
else|:
literal|1
expr_stmt|;
operator|(
operator|(
expr|struct
name|netrange
operator|*
operator|)
operator|&
name|sat
operator|->
name|sat_zero
operator|)
operator|->
name|nr_firstnet
operator|=
name|aa
operator|->
name|aa_firstnet
expr_stmt|;
operator|(
operator|(
expr|struct
name|netrange
operator|*
operator|)
operator|&
name|sat
operator|->
name|sat_zero
operator|)
operator|->
name|nr_lastnet
operator|=
name|aa
operator|->
name|aa_lastnet
expr_stmt|;
break|break;
case|case
name|SIOCSIFADDR
case|:
return|return
operator|(
name|at_ifinit
argument_list|(
name|ifp
argument_list|,
name|aa
argument_list|,
operator|(
expr|struct
name|sockaddr_at
operator|*
operator|)
operator|&
name|ifr
operator|->
name|ifr_addr
argument_list|)
operator|)
return|;
case|case
name|SIOCAIFADDR
case|:
if|if
condition|(
name|sateqaddr
argument_list|(
operator|&
name|ifra
operator|->
name|ifra_addr
argument_list|,
operator|&
name|aa
operator|->
name|aa_addr
argument_list|)
condition|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
return|return
operator|(
name|at_ifinit
argument_list|(
name|ifp
argument_list|,
name|aa
argument_list|,
operator|(
expr|struct
name|sockaddr_at
operator|*
operator|)
operator|&
name|ifr
operator|->
name|ifr_addr
argument_list|)
operator|)
return|;
case|case
name|SIOCDIFADDR
case|:
name|at_scrub
argument_list|(
name|ifp
argument_list|,
name|aa
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ifa
operator|=
name|ifp
operator|->
name|if_addrlist
operator|)
operator|==
operator|(
expr|struct
name|ifaddr
operator|*
operator|)
name|aa
condition|)
block|{
name|ifp
operator|->
name|if_addrlist
operator|=
name|ifa
operator|->
name|ifa_next
expr_stmt|;
block|}
else|else
block|{
while|while
condition|(
name|ifa
operator|->
name|ifa_next
operator|&&
operator|(
name|ifa
operator|->
name|ifa_next
operator|!=
operator|(
expr|struct
name|ifaddr
operator|*
operator|)
name|aa
operator|)
condition|)
block|{
name|ifa
operator|=
name|ifa
operator|->
name|ifa_next
expr_stmt|;
block|}
if|if
condition|(
name|ifa
operator|->
name|ifa_next
condition|)
block|{
name|ifa
operator|->
name|ifa_next
operator|=
operator|(
operator|(
expr|struct
name|ifaddr
operator|*
operator|)
name|aa
operator|)
operator|->
name|ifa_next
expr_stmt|;
block|}
else|else
block|{
name|panic
argument_list|(
literal|"at_control"
argument_list|)
expr_stmt|;
block|}
block|}
name|aa0
operator|=
name|aa
expr_stmt|;
if|if
condition|(
name|aa0
operator|==
operator|(
name|aa
operator|=
name|at_ifaddr
operator|)
condition|)
block|{
name|at_ifaddr
operator|=
name|aa
operator|->
name|aa_next
expr_stmt|;
block|}
else|else
block|{
while|while
condition|(
name|aa
operator|->
name|aa_next
operator|&&
operator|(
name|aa
operator|->
name|aa_next
operator|!=
name|aa0
operator|)
condition|)
block|{
name|aa
operator|=
name|aa
operator|->
name|aa_next
expr_stmt|;
block|}
if|if
condition|(
name|aa
operator|->
name|aa_next
condition|)
block|{
name|aa
operator|->
name|aa_next
operator|=
name|aa0
operator|->
name|aa_next
expr_stmt|;
block|}
else|else
block|{
name|panic
argument_list|(
literal|"at_control"
argument_list|)
expr_stmt|;
block|}
block|}
name|m_free
argument_list|(
name|dtom
argument_list|(
name|aa0
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
if|if
condition|(
name|ifp
operator|==
literal|0
operator|||
name|ifp
operator|->
name|if_ioctl
operator|==
literal|0
condition|)
return|return
operator|(
name|EOPNOTSUPP
operator|)
return|;
return|return
operator|(
call|(
modifier|*
name|ifp
operator|->
name|if_ioctl
call|)
argument_list|(
name|ifp
argument_list|,
name|cmd
argument_list|,
name|data
argument_list|)
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|at_scrub
parameter_list|(
name|ifp
parameter_list|,
name|aa
parameter_list|)
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|struct
name|at_ifaddr
modifier|*
name|aa
decl_stmt|;
block|{
name|int
name|error
decl_stmt|;
if|if
condition|(
name|aa
operator|->
name|aa_flags
operator|&
name|AFA_ROUTE
condition|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|rtinit
argument_list|(
operator|&
operator|(
name|aa
operator|->
name|aa_ifa
operator|)
argument_list|,
name|RTM_DELETE
argument_list|,
operator|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_LOOPBACK
operator|)
condition|?
name|RTF_HOST
else|:
literal|0
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
return|return
operator|(
name|error
operator|)
return|;
block|}
name|aa
operator|->
name|aa_ifa
operator|.
name|ifa_flags
operator|&=
operator|~
name|IFA_ROUTE
expr_stmt|;
name|aa
operator|->
name|aa_flags
operator|&=
operator|~
name|AFA_ROUTE
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|at_ifinit
parameter_list|(
name|ifp
parameter_list|,
name|aa
parameter_list|,
name|sat
parameter_list|)
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|struct
name|at_ifaddr
modifier|*
name|aa
decl_stmt|;
name|struct
name|sockaddr_at
modifier|*
name|sat
decl_stmt|;
block|{
name|struct
name|netrange
name|nr
decl_stmt|,
name|onr
decl_stmt|;
name|struct
name|sockaddr_at
name|oldaddr
decl_stmt|;
name|int
name|s
init|=
name|splimp
argument_list|()
decl_stmt|,
name|error
init|=
literal|0
decl_stmt|,
name|i
decl_stmt|,
name|j
decl_stmt|;
name|int
name|flags
init|=
name|RTF_UP
decl_stmt|,
name|netinc
decl_stmt|,
name|nodeinc
decl_stmt|,
name|nnets
decl_stmt|;
name|u_short
name|net
decl_stmt|;
name|oldaddr
operator|=
name|aa
operator|->
name|aa_addr
expr_stmt|;
name|bzero
argument_list|(
name|AA_SAT
argument_list|(
name|aa
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_at
argument_list|)
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|sat
operator|->
name|sat_zero
argument_list|,
operator|&
name|nr
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|netrange
argument_list|)
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|sat
operator|->
name|sat_zero
argument_list|,
name|AA_SAT
argument_list|(
name|aa
argument_list|)
operator|->
name|sat_zero
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|netrange
argument_list|)
argument_list|)
expr_stmt|;
name|nnets
operator|=
name|ntohs
argument_list|(
name|nr
operator|.
name|nr_lastnet
argument_list|)
operator|-
name|ntohs
argument_list|(
name|nr
operator|.
name|nr_firstnet
argument_list|)
operator|+
literal|1
expr_stmt|;
name|onr
operator|.
name|nr_firstnet
operator|=
name|aa
operator|->
name|aa_firstnet
expr_stmt|;
name|onr
operator|.
name|nr_lastnet
operator|=
name|aa
operator|->
name|aa_lastnet
expr_stmt|;
name|aa
operator|->
name|aa_firstnet
operator|=
name|nr
operator|.
name|nr_firstnet
expr_stmt|;
name|aa
operator|->
name|aa_lastnet
operator|=
name|nr
operator|.
name|nr_lastnet
expr_stmt|;
comment|/* XXX ALC */
name|printf
argument_list|(
literal|"at_ifinit: %s: %u.%u range %u-%u phase %d\n"
argument_list|,
name|ifp
operator|->
name|if_name
argument_list|,
name|ntohs
argument_list|(
name|sat
operator|->
name|sat_addr
operator|.
name|s_net
argument_list|)
argument_list|,
name|sat
operator|->
name|sat_addr
operator|.
name|s_node
argument_list|,
name|ntohs
argument_list|(
name|aa
operator|->
name|aa_firstnet
argument_list|)
argument_list|,
name|ntohs
argument_list|(
name|aa
operator|->
name|aa_lastnet
argument_list|)
argument_list|,
operator|(
name|aa
operator|->
name|aa_flags
operator|&
name|AFA_PHASE2
operator|)
condition|?
literal|2
else|:
literal|1
argument_list|)
expr_stmt|;
comment|/*      * We could eliminate the need for a second phase 1 probe (post      * autoconf) if we check whether we're resetting the node. Note      * that phase 1 probes use only nodes, not net.node pairs.  Under      * phase 2, both the net and node must be the same.      */
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_LOOPBACK
condition|)
block|{
name|AA_SAT
argument_list|(
name|aa
argument_list|)
operator|->
name|sat_len
operator|=
name|sat
operator|->
name|sat_len
expr_stmt|;
name|AA_SAT
argument_list|(
name|aa
argument_list|)
operator|->
name|sat_family
operator|=
name|AF_APPLETALK
expr_stmt|;
name|AA_SAT
argument_list|(
name|aa
argument_list|)
operator|->
name|sat_addr
operator|.
name|s_net
operator|=
name|sat
operator|->
name|sat_addr
operator|.
name|s_net
expr_stmt|;
name|AA_SAT
argument_list|(
name|aa
argument_list|)
operator|->
name|sat_addr
operator|.
name|s_node
operator|=
name|sat
operator|->
name|sat_addr
operator|.
name|s_node
expr_stmt|;
if|#
directive|if
literal|0
block|} else if ( fp->if_flags& IFF_POINTOPOINT) {
comment|/* unimplemented */
endif|#
directive|endif
block|}
else|else
block|{
name|aa
operator|->
name|aa_flags
operator||=
name|AFA_PROBING
expr_stmt|;
name|AA_SAT
argument_list|(
name|aa
argument_list|)
operator|->
name|sat_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_at
argument_list|)
expr_stmt|;
name|AA_SAT
argument_list|(
name|aa
argument_list|)
operator|->
name|sat_family
operator|=
name|AF_APPLETALK
expr_stmt|;
if|if
condition|(
name|aa
operator|->
name|aa_flags
operator|&
name|AFA_PHASE2
condition|)
block|{
if|if
condition|(
name|sat
operator|->
name|sat_addr
operator|.
name|s_net
operator|==
name|ATADDR_ANYNET
condition|)
block|{
if|if
condition|(
name|nnets
operator|!=
literal|1
condition|)
block|{
name|net
operator|=
name|ntohs
argument_list|(
name|nr
operator|.
name|nr_firstnet
argument_list|)
operator|+
name|time
operator|.
name|tv_sec
operator|%
operator|(
name|nnets
operator|-
literal|1
operator|)
expr_stmt|;
block|}
else|else
block|{
name|net
operator|=
name|ntohs
argument_list|(
name|nr
operator|.
name|nr_firstnet
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|ntohs
argument_list|(
name|sat
operator|->
name|sat_addr
operator|.
name|s_net
argument_list|)
operator|<
name|ntohs
argument_list|(
name|nr
operator|.
name|nr_firstnet
argument_list|)
operator|||
name|ntohs
argument_list|(
name|sat
operator|->
name|sat_addr
operator|.
name|s_net
argument_list|)
operator|>
name|ntohs
argument_list|(
name|nr
operator|.
name|nr_lastnet
argument_list|)
condition|)
block|{
name|aa
operator|->
name|aa_addr
operator|=
name|oldaddr
expr_stmt|;
name|aa
operator|->
name|aa_firstnet
operator|=
name|onr
operator|.
name|nr_firstnet
expr_stmt|;
name|aa
operator|->
name|aa_lastnet
operator|=
name|onr
operator|.
name|nr_lastnet
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
name|net
operator|=
name|ntohs
argument_list|(
name|sat
operator|->
name|sat_addr
operator|.
name|s_net
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|net
operator|=
name|ntohs
argument_list|(
name|sat
operator|->
name|sat_addr
operator|.
name|s_net
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sat
operator|->
name|sat_addr
operator|.
name|s_node
operator|==
name|ATADDR_ANYNODE
condition|)
block|{
name|AA_SAT
argument_list|(
name|aa
argument_list|)
operator|->
name|sat_addr
operator|.
name|s_node
operator|=
name|time
operator|.
name|tv_sec
expr_stmt|;
block|}
else|else
block|{
name|AA_SAT
argument_list|(
name|aa
argument_list|)
operator|->
name|sat_addr
operator|.
name|s_node
operator|=
name|sat
operator|->
name|sat_addr
operator|.
name|s_node
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
name|nnets
operator|,
name|netinc
operator|=
literal|1
init|;
name|i
operator|>
literal|0
condition|;
name|net
operator|=
name|ntohs
argument_list|(
name|nr
operator|.
name|nr_firstnet
argument_list|)
operator|+
operator|(
operator|(
name|net
operator|-
name|ntohs
argument_list|(
name|nr
operator|.
name|nr_firstnet
argument_list|)
operator|+
name|netinc
operator|)
operator|%
name|nnets
operator|)
operator|,
name|i
operator|--
control|)
block|{
name|AA_SAT
argument_list|(
name|aa
argument_list|)
operator|->
name|sat_addr
operator|.
name|s_net
operator|=
name|htons
argument_list|(
name|net
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
operator|,
name|nodeinc
operator|=
name|time
operator|.
name|tv_sec
operator||
literal|1
init|;
name|j
operator|<
literal|256
condition|;
name|j
operator|++
operator|,
name|AA_SAT
argument_list|(
name|aa
argument_list|)
operator|->
name|sat_addr
operator|.
name|s_node
operator|+=
name|nodeinc
control|)
block|{
if|if
condition|(
name|AA_SAT
argument_list|(
name|aa
argument_list|)
operator|->
name|sat_addr
operator|.
name|s_node
operator|>
literal|253
operator|||
name|AA_SAT
argument_list|(
name|aa
argument_list|)
operator|->
name|sat_addr
operator|.
name|s_node
operator|<
literal|1
condition|)
block|{
continue|continue;
block|}
name|aa
operator|->
name|aa_probcnt
operator|=
literal|10
expr_stmt|;
name|timeout
argument_list|(
operator|(
name|timeout_func_t
operator|)
name|aarpprobe
argument_list|,
operator|(
name|caddr_t
operator|)
name|ifp
argument_list|,
name|hz
operator|/
literal|5
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|tsleep
argument_list|(
name|aa
argument_list|,
name|PPAUSE
operator||
name|PCATCH
argument_list|,
literal|"at_ifinit"
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"at_ifinit: why did this happen?!\n"
argument_list|)
expr_stmt|;
name|aa
operator|->
name|aa_addr
operator|=
name|oldaddr
expr_stmt|;
name|aa
operator|->
name|aa_firstnet
operator|=
name|onr
operator|.
name|nr_firstnet
expr_stmt|;
name|aa
operator|->
name|aa_lastnet
operator|=
name|onr
operator|.
name|nr_lastnet
expr_stmt|;
return|return
operator|(
name|EINTR
operator|)
return|;
block|}
name|s
operator|=
name|splimp
argument_list|()
expr_stmt|;
if|if
condition|(
operator|(
name|aa
operator|->
name|aa_flags
operator|&
name|AFA_PROBING
operator|)
operator|==
literal|0
condition|)
block|{
break|break;
block|}
block|}
if|if
condition|(
operator|(
name|aa
operator|->
name|aa_flags
operator|&
name|AFA_PROBING
operator|)
operator|==
literal|0
condition|)
block|{
break|break;
block|}
comment|/* reset node for next network */
name|AA_SAT
argument_list|(
name|aa
argument_list|)
operator|->
name|sat_addr
operator|.
name|s_node
operator|=
name|time
operator|.
name|tv_sec
expr_stmt|;
block|}
if|if
condition|(
name|aa
operator|->
name|aa_flags
operator|&
name|AFA_PROBING
condition|)
block|{
name|aa
operator|->
name|aa_addr
operator|=
name|oldaddr
expr_stmt|;
name|aa
operator|->
name|aa_firstnet
operator|=
name|onr
operator|.
name|nr_firstnet
expr_stmt|;
name|aa
operator|->
name|aa_lastnet
operator|=
name|onr
operator|.
name|nr_lastnet
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
operator|(
name|EADDRINUSE
operator|)
return|;
block|}
block|}
if|if
condition|(
name|ifp
operator|->
name|if_ioctl
operator|&&
operator|(
name|error
operator|=
call|(
modifier|*
name|ifp
operator|->
name|if_ioctl
call|)
argument_list|(
name|ifp
argument_list|,
name|SIOCSIFADDR
argument_list|,
operator|(
name|caddr_t
operator|)
name|aa
argument_list|)
operator|)
condition|)
block|{
name|aa
operator|->
name|aa_addr
operator|=
name|oldaddr
expr_stmt|;
name|aa
operator|->
name|aa_firstnet
operator|=
name|onr
operator|.
name|nr_firstnet
expr_stmt|;
name|aa
operator|->
name|aa_lastnet
operator|=
name|onr
operator|.
name|nr_lastnet
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
comment|/* Initialize netmask and broadcast address */
name|bzero
argument_list|(
operator|&
name|aa
operator|->
name|aa_netmask
argument_list|,
sizeof|sizeof
argument_list|(
name|aa
operator|->
name|aa_netmask
argument_list|)
argument_list|)
expr_stmt|;
name|aa
operator|->
name|aa_ifa
operator|.
name|ifa_netmask
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|aa
operator|->
name|aa_netmask
expr_stmt|;
name|aa
operator|->
name|aa_netmask
operator|.
name|sat_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_at
argument_list|)
expr_stmt|;
name|aa
operator|->
name|aa_netmask
operator|.
name|sat_family
operator|=
name|AF_APPLETALK
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|aa
operator|->
name|aa_broadaddr
argument_list|,
sizeof|sizeof
argument_list|(
name|aa
operator|->
name|aa_broadaddr
argument_list|)
argument_list|)
expr_stmt|;
name|aa
operator|->
name|aa_ifa
operator|.
name|ifa_broadaddr
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|aa
operator|->
name|aa_broadaddr
expr_stmt|;
name|aa
operator|->
name|aa_broadaddr
operator|.
name|sat_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_at
argument_list|)
expr_stmt|;
name|aa
operator|->
name|aa_broadaddr
operator|.
name|sat_family
operator|=
name|AF_APPLETALK
expr_stmt|;
comment|/* "Add a route to the network" */
name|aa
operator|->
name|aa_ifa
operator|.
name|ifa_metric
operator|=
name|ifp
operator|->
name|if_metric
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_BROADCAST
condition|)
block|{
name|aa
operator|->
name|aa_broadaddr
operator|.
name|sat_addr
operator|.
name|s_net
operator|=
name|htons
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|aa
operator|->
name|aa_broadaddr
operator|.
name|sat_addr
operator|.
name|s_node
operator|=
literal|0xff
expr_stmt|;
name|aa
operator|->
name|aa_netmask
operator|.
name|sat_addr
operator|.
name|s_net
operator|=
name|htons
argument_list|(
literal|0xffff
argument_list|)
expr_stmt|;
comment|/* XXX */
name|aa
operator|->
name|aa_netmask
operator|.
name|sat_addr
operator|.
name|s_node
operator|=
literal|0
expr_stmt|;
comment|/* XXX */
block|}
elseif|else
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_LOOPBACK
condition|)
block|{
name|aa
operator|->
name|aa_ifa
operator|.
name|ifa_dstaddr
operator|=
name|aa
operator|->
name|aa_ifa
operator|.
name|ifa_addr
expr_stmt|;
name|aa
operator|->
name|aa_netmask
operator|.
name|sat_addr
operator|.
name|s_net
operator|=
name|htons
argument_list|(
literal|0xffff
argument_list|)
expr_stmt|;
comment|/* XXX */
name|aa
operator|->
name|aa_netmask
operator|.
name|sat_addr
operator|.
name|s_node
operator|=
literal|0xff
expr_stmt|;
comment|/* XXX */
name|flags
operator||=
name|RTF_HOST
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_POINTOPOINT
condition|)
block|{
name|aa
operator|->
name|aa_ifa
operator|.
name|ifa_dstaddr
operator|=
name|aa
operator|->
name|aa_ifa
operator|.
name|ifa_addr
expr_stmt|;
name|aa
operator|->
name|aa_netmask
operator|.
name|sat_addr
operator|.
name|s_net
operator|=
name|htons
argument_list|(
literal|0xffff
argument_list|)
expr_stmt|;
name|aa
operator|->
name|aa_netmask
operator|.
name|sat_addr
operator|.
name|s_node
operator|=
name|htons
argument_list|(
literal|0xffff
argument_list|)
expr_stmt|;
name|flags
operator||=
name|RTF_HOST
expr_stmt|;
block|}
name|error
operator|=
name|rtinit
argument_list|(
operator|&
name|aa
operator|->
name|aa_ifa
argument_list|,
name|RTM_ADD
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|if ( ifp->if_flags& IFF_LOOPBACK ) { 	struct at_addr	rtaddr, rtmask;  	bzero(&rtaddr, sizeof(rtaddr)); 	bzero(&rtmask, sizeof(rtmask)); 	rtaddr.s_net = AA_SAT( aa )->sat_addr.s_net; 	rtaddr.s_node = AA_SAT( aa )->sat_addr.s_node; 	rtmask.s_net = 0xffff; 	rtmask.s_node = 0xff;  	error = aa_addsingleroute(&aa->aa_ifa,&rtaddr,&rtmask);      } else {
comment|/* Install routes for our own network, and then also for        all networks above and below it in the network range */
block|error = aa_addrangeroute(&aa->aa_ifa, 		ntohs(aa->aa_addr.sat_addr.s_net), 		ntohs(aa->aa_addr.sat_addr.s_net) + 1); 	if (!error&& ntohs(aa->aa_firstnet)< ntohs(aa->aa_addr.sat_addr.s_net)) 	    error = aa_addrangeroute(&aa->aa_ifa, 		  ntohs(aa->aa_firstnet), ntohs(aa->aa_addr.sat_addr.s_net)); 	if (!error&& ntohs(aa->aa_addr.sat_addr.s_net)< ntohs(aa->aa_lastnet)) 	    error = aa_addrangeroute(&aa->aa_ifa, 		  ntohs(aa->aa_addr.sat_addr.s_net) + 1, 		  ntohs(aa->aa_lastnet) + 1);     }
endif|#
directive|endif
if|if
condition|(
name|error
condition|)
block|{
name|aa
operator|->
name|aa_addr
operator|=
name|oldaddr
expr_stmt|;
name|aa
operator|->
name|aa_firstnet
operator|=
name|onr
operator|.
name|nr_firstnet
expr_stmt|;
name|aa
operator|->
name|aa_lastnet
operator|=
name|onr
operator|.
name|nr_lastnet
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|aa
operator|->
name|aa_ifa
operator|.
name|ifa_flags
operator||=
name|IFA_ROUTE
expr_stmt|;
name|aa
operator|->
name|aa_flags
operator||=
name|AFA_ROUTE
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|at_broadcast
parameter_list|(
name|sat
parameter_list|)
name|struct
name|sockaddr_at
modifier|*
name|sat
decl_stmt|;
block|{
name|struct
name|at_ifaddr
modifier|*
name|aa
decl_stmt|;
if|if
condition|(
name|sat
operator|->
name|sat_addr
operator|.
name|s_node
operator|!=
name|ATADDR_BCAST
condition|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|sat
operator|->
name|sat_addr
operator|.
name|s_net
operator|==
name|ATADDR_ANYNET
condition|)
block|{
return|return
operator|(
literal|1
operator|)
return|;
block|}
else|else
block|{
for|for
control|(
name|aa
operator|=
name|at_ifaddr
init|;
name|aa
condition|;
name|aa
operator|=
name|aa
operator|->
name|aa_next
control|)
block|{
if|if
condition|(
operator|(
name|aa
operator|->
name|aa_ifp
operator|->
name|if_flags
operator|&
name|IFF_BROADCAST
operator|)
operator|&&
operator|(
name|ntohs
argument_list|(
name|sat
operator|->
name|sat_addr
operator|.
name|s_net
argument_list|)
operator|>=
name|ntohs
argument_list|(
name|aa
operator|->
name|aa_firstnet
argument_list|)
operator|&&
name|ntohs
argument_list|(
name|sat
operator|->
name|sat_addr
operator|.
name|s_net
argument_list|)
operator|<=
name|ntohs
argument_list|(
name|aa
operator|->
name|aa_lastnet
argument_list|)
operator|)
condition|)
block|{
return|return
operator|(
literal|1
operator|)
return|;
block|}
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * aa_addrangeroute()  *  * Add a route for a range of networks from bot to top - 1.  * Algorithm:  *  * Split the range into three subranges such that the middle  * subrange is from (base + 2^N) to (base + 2^N + 2^(N-1)) for  * some N. Then add a route for the middle range and recurse on  * the upper and lower sub-ranges. As a degenerate case, it may  * be that the middle subrange is empty.  */
end_comment

begin_function
specifier|static
name|int
name|aa_addrangeroute
parameter_list|(
name|struct
name|ifaddr
modifier|*
name|ifa
parameter_list|,
name|int
name|bot
parameter_list|,
name|int
name|top
parameter_list|)
block|{
name|int
name|base
decl_stmt|,
name|mask
decl_stmt|,
name|mbot
decl_stmt|,
name|mtop
decl_stmt|;
name|int
name|a
decl_stmt|,
name|b
decl_stmt|,
name|abit
decl_stmt|,
name|bbit
decl_stmt|,
name|error
decl_stmt|;
name|struct
name|at_addr
name|rtaddr
decl_stmt|,
name|rtmask
decl_stmt|;
comment|/* Special case the whole range */
if|if
condition|(
name|bot
operator|==
literal|0
operator|&&
name|top
operator|==
literal|0xffff
condition|)
block|{
name|bzero
argument_list|(
operator|&
name|rtaddr
argument_list|,
sizeof|sizeof
argument_list|(
name|rtaddr
argument_list|)
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|rtmask
argument_list|,
sizeof|sizeof
argument_list|(
name|rtmask
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|aa_addsingleroute
argument_list|(
name|ifa
argument_list|,
operator|&
name|rtaddr
argument_list|,
operator|&
name|rtmask
argument_list|)
operator|)
return|;
block|}
if|if
condition|(
name|top
operator|<=
name|bot
condition|)
name|panic
argument_list|(
literal|"aa_addrangeroute"
argument_list|)
expr_stmt|;
comment|/* Mask out the high order bits on which both bounds agree */
for|for
control|(
name|mask
operator|=
literal|0xffff
init|;
operator|(
name|bot
operator|&
name|mask
operator|)
operator|!=
operator|(
name|top
operator|&
name|mask
operator|)
condition|;
name|mask
operator|<<=
literal|1
control|)
empty_stmt|;
name|base
operator|=
name|bot
operator|&
name|mask
expr_stmt|;
name|a
operator|=
name|bot
operator|&
operator|~
name|mask
expr_stmt|;
name|b
operator|=
name|top
operator|&
operator|~
name|mask
expr_stmt|;
comment|/* Find suitable powers of two between a and b we can make a route with */
for|for
control|(
name|bbit
operator|=
literal|0x8000
init|;
name|bbit
operator|>
name|b
condition|;
name|bbit
operator|>>=
literal|1
control|)
empty_stmt|;
if|if
condition|(
name|a
operator|==
literal|0
condition|)
name|abit
operator|=
literal|0
expr_stmt|;
else|else
block|{
for|for
control|(
name|abit
operator|=
literal|0x0001
init|;
name|a
operator|>
name|abit
condition|;
name|abit
operator|<<=
literal|1
control|)
empty_stmt|;
if|if
condition|(
operator|(
name|abit
operator|<<
literal|1
operator|)
operator|>
name|bbit
condition|)
name|bbit
operator|=
name|abit
expr_stmt|;
else|else
name|bbit
operator|=
name|abit
operator|<<
literal|1
expr_stmt|;
block|}
comment|/* Now we have a "square" middle chunk from abit to bbit, possibly empty */
name|mbot
operator|=
name|base
operator|+
name|abit
expr_stmt|;
name|mtop
operator|=
name|base
operator|+
name|bbit
expr_stmt|;
name|mask
operator|=
operator|~
operator|(
name|bbit
operator|-
literal|1
operator|)
expr_stmt|;
comment|/* Route to the middle chunk */
if|if
condition|(
name|mbot
operator|<
name|mtop
condition|)
block|{
name|bzero
argument_list|(
operator|&
name|rtaddr
argument_list|,
sizeof|sizeof
argument_list|(
name|rtaddr
argument_list|)
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|rtmask
argument_list|,
sizeof|sizeof
argument_list|(
name|rtmask
argument_list|)
argument_list|)
expr_stmt|;
name|rtaddr
operator|.
name|s_net
operator|=
name|htons
argument_list|(
operator|(
name|u_short
operator|)
name|mbot
argument_list|)
expr_stmt|;
name|rtmask
operator|.
name|s_net
operator|=
name|htons
argument_list|(
operator|(
name|u_short
operator|)
name|mask
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|aa_addsingleroute
argument_list|(
name|ifa
argument_list|,
operator|&
name|rtaddr
argument_list|,
operator|&
name|rtmask
argument_list|)
operator|)
condition|)
return|return
operator|(
name|error
operator|)
return|;
block|}
comment|/* Recurse on the upper and lower chunks we didn't get to */
if|if
condition|(
name|bot
operator|<
name|mbot
condition|)
if|if
condition|(
operator|(
name|error
operator|=
name|aa_addrangeroute
argument_list|(
name|ifa
argument_list|,
name|bot
argument_list|,
name|mbot
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
name|mbot
operator|<
name|mtop
condition|)
name|aa_delsingleroute
argument_list|(
name|ifa
argument_list|,
operator|&
name|rtaddr
argument_list|,
operator|&
name|rtmask
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
if|if
condition|(
name|mtop
operator|<
name|top
condition|)
if|if
condition|(
operator|(
name|error
operator|=
name|aa_addrangeroute
argument_list|(
name|ifa
argument_list|,
name|mtop
argument_list|,
name|top
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
name|mbot
operator|<
name|mtop
condition|)
name|aa_delsingleroute
argument_list|(
name|ifa
argument_list|,
operator|&
name|rtaddr
argument_list|,
operator|&
name|rtmask
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|aa_addsingleroute
parameter_list|(
name|struct
name|ifaddr
modifier|*
name|ifa
parameter_list|,
name|struct
name|at_addr
modifier|*
name|addr
parameter_list|,
name|struct
name|at_addr
modifier|*
name|mask
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
name|printf
argument_list|(
literal|"aa_addsingleroute: %x.%x mask %x.%x ...\n"
argument_list|,
name|ntohs
argument_list|(
name|addr
operator|->
name|s_net
argument_list|)
argument_list|,
name|addr
operator|->
name|s_node
argument_list|,
name|ntohs
argument_list|(
name|mask
operator|->
name|s_net
argument_list|)
argument_list|,
name|mask
operator|->
name|s_node
argument_list|)
expr_stmt|;
name|error
operator|=
name|aa_dosingleroute
argument_list|(
name|ifa
argument_list|,
name|addr
argument_list|,
name|mask
argument_list|,
name|RTM_ADD
argument_list|,
name|RTF_UP
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
name|printf
argument_list|(
literal|"error %d\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|aa_delsingleroute
parameter_list|(
name|struct
name|ifaddr
modifier|*
name|ifa
parameter_list|,
name|struct
name|at_addr
modifier|*
name|addr
parameter_list|,
name|struct
name|at_addr
modifier|*
name|mask
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
name|error
operator|=
name|aa_dosingleroute
argument_list|(
name|ifa
argument_list|,
name|addr
argument_list|,
name|mask
argument_list|,
name|RTM_DELETE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
name|printf
argument_list|(
literal|"aa_delsingleroute: error %d\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|aa_dosingleroute
parameter_list|(
name|struct
name|ifaddr
modifier|*
name|ifa
parameter_list|,
name|struct
name|at_addr
modifier|*
name|at_addr
parameter_list|,
name|struct
name|at_addr
modifier|*
name|at_mask
parameter_list|,
name|int
name|cmd
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
name|struct
name|sockaddr_at
name|addr
decl_stmt|,
name|mask
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|addr
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|mask
argument_list|,
sizeof|sizeof
argument_list|(
name|mask
argument_list|)
argument_list|)
expr_stmt|;
name|addr
operator|.
name|sat_family
operator|=
name|AF_APPLETALK
expr_stmt|;
name|addr
operator|.
name|sat_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_at
argument_list|)
expr_stmt|;
name|addr
operator|.
name|sat_addr
operator|.
name|s_net
operator|=
name|at_addr
operator|->
name|s_net
expr_stmt|;
name|addr
operator|.
name|sat_addr
operator|.
name|s_node
operator|=
name|at_addr
operator|->
name|s_node
expr_stmt|;
name|mask
operator|.
name|sat_addr
operator|.
name|s_net
operator|=
name|at_mask
operator|->
name|s_net
expr_stmt|;
name|mask
operator|.
name|sat_addr
operator|.
name|s_node
operator|=
name|at_mask
operator|->
name|s_node
expr_stmt|;
if|if
condition|(
name|at_mask
operator|->
name|s_node
condition|)
name|flags
operator||=
name|RTF_HOST
expr_stmt|;
return|return
operator|(
name|rtrequest
argument_list|(
name|cmd
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|addr
argument_list|,
name|ifa
operator|->
name|ifa_addr
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|mask
argument_list|,
name|flags
argument_list|,
name|NULL
argument_list|)
operator|)
return|;
block|}
end_function

begin_if
if|#
directive|if
literal|0
end_if

begin_endif
unit|static void aa_clean(void) {     struct at_ifaddr	*aa;     struct ifaddr	*ifa;     struct ifnet	*ifp;      while ( aa = at_ifaddr ) { 	ifp = aa->aa_ifp; 	at_scrub( ifp, aa ); 	at_ifaddr = aa->aa_next; 	if (( ifa = ifp->if_addrlist ) == (struct ifaddr *)aa ) { 	    ifp->if_addrlist = ifa->ifa_next; 	} else { 	    while ( ifa->ifa_next&& 		    ( ifa->ifa_next != (struct ifaddr *)aa )) { 		ifa = ifa->ifa_next; 	    } 	    if ( ifa->ifa_next ) { 		ifa->ifa_next = ((struct ifaddr *)aa)->ifa_next; 	    } else { 		panic( "at_entry" ); 	    } 	}     } }
endif|#
directive|endif
end_endif

end_unit


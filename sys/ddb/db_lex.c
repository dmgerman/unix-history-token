begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Mach Operating System  * Copyright (c) 1991,1990 Carnegie Mellon University  * All Rights Reserved.  *  * Permission to use, copy, modify and distribute this software and its  * documentation is hereby granted, provided that both the copyright  * notice and this permission notice appear in all copies of the  * software, derivative works or modified versions, and any portions  * thereof, and that both notices appear in supporting documentation.  *  * CARNEGIE MELLON ALLOWS FREE USE OF THIS SOFTWARE IN ITS  * CONDITION.  CARNEGIE MELLON DISCLAIMS ANY LIABILITY OF ANY KIND FOR  * ANY DAMAGES WHATSOEVER RESULTING FROM THE USE OF THIS SOFTWARE.  *  * Carnegie Mellon requests users of this software to return to  *  *  Software Distribution Coordinator  or  Software.Distribution@CS.CMU.EDU  *  School of Computer Science  *  Carnegie Mellon University  *  Pittsburgh PA 15213-3890  *  * any improvements or extensions that they make and grant Carnegie the  * rights to redistribute these changes.  *  *	$Id: db_lex.c,v 1.6 1995/05/30 07:57:00 rgrimes Exp $  */
end_comment

begin_comment
comment|/*  *	Author: David B. Golub, Carnegie Mellon University  *	Date:	7/90  */
end_comment

begin_comment
comment|/*  * Lexical analyzer.  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<ddb/ddb.h>
end_include

begin_include
include|#
directive|include
file|<ddb/db_lex.h>
end_include

begin_decl_stmt
name|char
name|db_line
index|[
literal|120
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|db_lp
decl_stmt|,
modifier|*
name|db_endlp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|db_lex
name|__P
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|db_read_line
parameter_list|()
block|{
name|int
name|i
decl_stmt|;
name|i
operator|=
name|db_readline
argument_list|(
name|db_line
argument_list|,
sizeof|sizeof
argument_list|(
name|db_line
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* EOI */
name|db_lp
operator|=
name|db_line
expr_stmt|;
name|db_endlp
operator|=
name|db_lp
operator|+
name|i
expr_stmt|;
return|return
operator|(
name|i
operator|)
return|;
block|}
end_function

begin_function
name|void
name|db_flush_line
parameter_list|()
block|{
name|db_lp
operator|=
name|db_line
expr_stmt|;
name|db_endlp
operator|=
name|db_line
expr_stmt|;
block|}
end_function

begin_decl_stmt
name|int
name|db_look_char
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|db_read_char
parameter_list|()
block|{
name|int
name|c
decl_stmt|;
if|if
condition|(
name|db_look_char
operator|!=
literal|0
condition|)
block|{
name|c
operator|=
name|db_look_char
expr_stmt|;
name|db_look_char
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|db_lp
operator|>=
name|db_endlp
condition|)
name|c
operator|=
operator|-
literal|1
expr_stmt|;
else|else
name|c
operator|=
operator|*
name|db_lp
operator|++
expr_stmt|;
return|return
operator|(
name|c
operator|)
return|;
block|}
end_function

begin_function
name|void
name|db_unread_char
parameter_list|(
name|c
parameter_list|)
name|int
name|c
decl_stmt|;
block|{
name|db_look_char
operator|=
name|c
expr_stmt|;
block|}
end_function

begin_decl_stmt
name|int
name|db_look_token
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|db_unread_token
parameter_list|(
name|t
parameter_list|)
name|int
name|t
decl_stmt|;
block|{
name|db_look_token
operator|=
name|t
expr_stmt|;
block|}
end_function

begin_function
name|int
name|db_read_token
parameter_list|()
block|{
name|int
name|t
decl_stmt|;
if|if
condition|(
name|db_look_token
condition|)
block|{
name|t
operator|=
name|db_look_token
expr_stmt|;
name|db_look_token
operator|=
literal|0
expr_stmt|;
block|}
else|else
name|t
operator|=
name|db_lex
argument_list|()
expr_stmt|;
return|return
operator|(
name|t
operator|)
return|;
block|}
end_function

begin_decl_stmt
name|int
name|db_tok_number
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|db_tok_string
index|[
name|TOK_STRING_SIZE
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|db_radix
init|=
literal|16
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|db_flush_lex
parameter_list|()
block|{
name|db_flush_line
argument_list|()
expr_stmt|;
name|db_look_char
operator|=
literal|0
expr_stmt|;
name|db_look_token
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|db_lex
parameter_list|()
block|{
name|int
name|c
decl_stmt|;
name|c
operator|=
name|db_read_char
argument_list|()
expr_stmt|;
while|while
condition|(
name|c
operator|<=
literal|' '
operator|||
name|c
operator|>
literal|'~'
condition|)
block|{
if|if
condition|(
name|c
operator|==
literal|'\n'
operator|||
name|c
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
name|tEOL
operator|)
return|;
name|c
operator|=
name|db_read_char
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|c
operator|>=
literal|'0'
operator|&&
name|c
operator|<=
literal|'9'
condition|)
block|{
comment|/* number */
name|int
name|r
decl_stmt|,
name|digit
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|c
operator|>
literal|'0'
condition|)
name|r
operator|=
name|db_radix
expr_stmt|;
else|else
block|{
name|c
operator|=
name|db_read_char
argument_list|()
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|'O'
operator|||
name|c
operator|==
literal|'o'
condition|)
name|r
operator|=
literal|8
expr_stmt|;
elseif|else
if|if
condition|(
name|c
operator|==
literal|'T'
operator|||
name|c
operator|==
literal|'t'
condition|)
name|r
operator|=
literal|10
expr_stmt|;
elseif|else
if|if
condition|(
name|c
operator|==
literal|'X'
operator|||
name|c
operator|==
literal|'x'
condition|)
name|r
operator|=
literal|16
expr_stmt|;
else|else
block|{
name|r
operator|=
name|db_radix
expr_stmt|;
name|db_unread_char
argument_list|(
name|c
argument_list|)
expr_stmt|;
block|}
name|c
operator|=
name|db_read_char
argument_list|()
expr_stmt|;
block|}
name|db_tok_number
operator|=
literal|0
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|c
operator|>=
literal|'0'
operator|&&
name|c
operator|<=
operator|(
operator|(
name|r
operator|==
literal|8
operator|)
condition|?
literal|'7'
else|:
literal|'9'
operator|)
condition|)
name|digit
operator|=
name|c
operator|-
literal|'0'
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|==
literal|16
operator|&&
operator|(
operator|(
name|c
operator|>=
literal|'A'
operator|&&
name|c
operator|<=
literal|'F'
operator|)
operator|||
operator|(
name|c
operator|>=
literal|'a'
operator|&&
name|c
operator|<=
literal|'f'
operator|)
operator|)
condition|)
block|{
if|if
condition|(
name|c
operator|>=
literal|'a'
condition|)
name|digit
operator|=
name|c
operator|-
literal|'a'
operator|+
literal|10
expr_stmt|;
elseif|else
if|if
condition|(
name|c
operator|>=
literal|'A'
condition|)
name|digit
operator|=
name|c
operator|-
literal|'A'
operator|+
literal|10
expr_stmt|;
block|}
else|else
break|break;
name|db_tok_number
operator|=
name|db_tok_number
operator|*
name|r
operator|+
name|digit
expr_stmt|;
name|c
operator|=
name|db_read_char
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|c
operator|>=
literal|'0'
operator|&&
name|c
operator|<=
literal|'9'
operator|)
operator|||
operator|(
name|c
operator|>=
literal|'A'
operator|&&
name|c
operator|<=
literal|'Z'
operator|)
operator|||
operator|(
name|c
operator|>=
literal|'a'
operator|&&
name|c
operator|<=
literal|'z'
operator|)
operator|||
operator|(
name|c
operator|==
literal|'_'
operator|)
condition|)
block|{
name|db_error
argument_list|(
literal|"Bad character in number\n"
argument_list|)
expr_stmt|;
name|db_flush_lex
argument_list|()
expr_stmt|;
return|return
operator|(
name|tEOF
operator|)
return|;
block|}
name|db_unread_char
argument_list|(
name|c
argument_list|)
expr_stmt|;
return|return
operator|(
name|tNUMBER
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|c
operator|>=
literal|'A'
operator|&&
name|c
operator|<=
literal|'Z'
operator|)
operator|||
operator|(
name|c
operator|>=
literal|'a'
operator|&&
name|c
operator|<=
literal|'z'
operator|)
operator|||
name|c
operator|==
literal|'_'
operator|||
name|c
operator|==
literal|'\\'
condition|)
block|{
comment|/* string */
name|char
modifier|*
name|cp
decl_stmt|;
name|cp
operator|=
name|db_tok_string
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|'\\'
condition|)
block|{
name|c
operator|=
name|db_read_char
argument_list|()
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|'\n'
operator|||
name|c
operator|==
operator|-
literal|1
condition|)
name|db_error
argument_list|(
literal|"Bad escape\n"
argument_list|)
expr_stmt|;
block|}
operator|*
name|cp
operator|++
operator|=
name|c
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|c
operator|=
name|db_read_char
argument_list|()
expr_stmt|;
if|if
condition|(
operator|(
name|c
operator|>=
literal|'A'
operator|&&
name|c
operator|<=
literal|'Z'
operator|)
operator|||
operator|(
name|c
operator|>=
literal|'a'
operator|&&
name|c
operator|<=
literal|'z'
operator|)
operator|||
operator|(
name|c
operator|>=
literal|'0'
operator|&&
name|c
operator|<=
literal|'9'
operator|)
operator|||
name|c
operator|==
literal|'_'
operator|||
name|c
operator|==
literal|'\\'
operator|||
name|c
operator|==
literal|':'
condition|)
block|{
if|if
condition|(
name|c
operator|==
literal|'\\'
condition|)
block|{
name|c
operator|=
name|db_read_char
argument_list|()
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|'\n'
operator|||
name|c
operator|==
operator|-
literal|1
condition|)
name|db_error
argument_list|(
literal|"Bad escape\n"
argument_list|)
expr_stmt|;
block|}
operator|*
name|cp
operator|++
operator|=
name|c
expr_stmt|;
if|if
condition|(
name|cp
operator|==
name|db_tok_string
operator|+
sizeof|sizeof
argument_list|(
name|db_tok_string
argument_list|)
condition|)
block|{
name|db_error
argument_list|(
literal|"String too long\n"
argument_list|)
expr_stmt|;
name|db_flush_lex
argument_list|()
expr_stmt|;
return|return
operator|(
name|tEOF
operator|)
return|;
block|}
continue|continue;
block|}
else|else
block|{
operator|*
name|cp
operator|=
literal|'\0'
expr_stmt|;
break|break;
block|}
block|}
name|db_unread_char
argument_list|(
name|c
argument_list|)
expr_stmt|;
return|return
operator|(
name|tIDENT
operator|)
return|;
block|}
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'+'
case|:
return|return
operator|(
name|tPLUS
operator|)
return|;
case|case
literal|'-'
case|:
return|return
operator|(
name|tMINUS
operator|)
return|;
case|case
literal|'.'
case|:
name|c
operator|=
name|db_read_char
argument_list|()
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|'.'
condition|)
return|return
operator|(
name|tDOTDOT
operator|)
return|;
name|db_unread_char
argument_list|(
name|c
argument_list|)
expr_stmt|;
return|return
operator|(
name|tDOT
operator|)
return|;
case|case
literal|'*'
case|:
return|return
operator|(
name|tSTAR
operator|)
return|;
case|case
literal|'/'
case|:
return|return
operator|(
name|tSLASH
operator|)
return|;
case|case
literal|'='
case|:
return|return
operator|(
name|tEQ
operator|)
return|;
case|case
literal|'%'
case|:
return|return
operator|(
name|tPCT
operator|)
return|;
case|case
literal|'#'
case|:
return|return
operator|(
name|tHASH
operator|)
return|;
case|case
literal|'('
case|:
return|return
operator|(
name|tLPAREN
operator|)
return|;
case|case
literal|')'
case|:
return|return
operator|(
name|tRPAREN
operator|)
return|;
case|case
literal|','
case|:
return|return
operator|(
name|tCOMMA
operator|)
return|;
case|case
literal|'"'
case|:
return|return
operator|(
name|tDITTO
operator|)
return|;
case|case
literal|'$'
case|:
return|return
operator|(
name|tDOLLAR
operator|)
return|;
case|case
literal|'!'
case|:
return|return
operator|(
name|tEXCL
operator|)
return|;
case|case
literal|'<'
case|:
name|c
operator|=
name|db_read_char
argument_list|()
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|'<'
condition|)
return|return
operator|(
name|tSHIFT_L
operator|)
return|;
name|db_unread_char
argument_list|(
name|c
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'>'
case|:
name|c
operator|=
name|db_read_char
argument_list|()
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|'>'
condition|)
return|return
operator|(
name|tSHIFT_R
operator|)
return|;
name|db_unread_char
argument_list|(
name|c
argument_list|)
expr_stmt|;
break|break;
case|case
operator|-
literal|1
case|:
return|return
operator|(
name|tEOF
operator|)
return|;
block|}
name|db_printf
argument_list|(
literal|"Bad character\n"
argument_list|)
expr_stmt|;
name|db_flush_lex
argument_list|()
expr_stmt|;
return|return
operator|(
name|tEOF
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2011 Alexander Motin<mav@FreeBSD.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHORS AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHORS OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/bio.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/kobj.h>
end_include

begin_include
include|#
directive|include
file|<sys/limits.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/taskqueue.h>
end_include

begin_include
include|#
directive|include
file|<geom/geom.h>
end_include

begin_include
include|#
directive|include
file|"geom/raid/g_raid.h"
end_include

begin_include
include|#
directive|include
file|"g_raid_md_if.h"
end_include

begin_expr_stmt
specifier|static
name|MALLOC_DEFINE
argument_list|(
name|M_MD_SII
argument_list|,
literal|"md_sii_data"
argument_list|,
literal|"GEOM_RAID SiI metadata"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_struct
struct|struct
name|sii_raid_conf
block|{
name|uint16_t
name|ata_params_00_53
index|[
literal|54
index|]
decl_stmt|;
name|uint64_t
name|total_sectors
decl_stmt|;
comment|/* 54 - 57 */
name|uint16_t
name|ata_params_58_81
index|[
literal|72
index|]
decl_stmt|;
name|uint16_t
name|product_id
decl_stmt|;
comment|/* 130 */
name|uint16_t
name|vendor_id
decl_stmt|;
comment|/* 131 */
name|uint16_t
name|version_minor
decl_stmt|;
comment|/* 132 */
name|uint16_t
name|version_major
decl_stmt|;
comment|/* 133 */
name|uint8_t
name|timestamp
index|[
literal|6
index|]
decl_stmt|;
comment|/* 134 - 136 */
name|uint16_t
name|strip_sectors
decl_stmt|;
comment|/* 137 */
name|uint16_t
name|dummy_2
decl_stmt|;
name|uint8_t
name|disk_number
decl_stmt|;
comment|/* 139 */
name|uint8_t
name|type
decl_stmt|;
define|#
directive|define
name|SII_T_RAID0
value|0x00
define|#
directive|define
name|SII_T_RAID1
value|0x01
define|#
directive|define
name|SII_T_RAID01
value|0x02
define|#
directive|define
name|SII_T_SPARE
value|0x03
define|#
directive|define
name|SII_T_CONCAT
value|0x04
define|#
directive|define
name|SII_T_RAID5
value|0x10
define|#
directive|define
name|SII_T_RESERVED
value|0xfd
define|#
directive|define
name|SII_T_JBOD
value|0xff
name|uint8_t
name|raid0_disks
decl_stmt|;
comment|/* 140 */
name|uint8_t
name|raid0_ident
decl_stmt|;
name|uint8_t
name|raid1_disks
decl_stmt|;
comment|/* 141 */
name|uint8_t
name|raid1_ident
decl_stmt|;
name|uint64_t
name|rebuild_lba
decl_stmt|;
comment|/* 142 - 145 */
name|uint32_t
name|generation
decl_stmt|;
comment|/* 146 - 147 */
name|uint8_t
name|disk_status
decl_stmt|;
comment|/* 148 */
define|#
directive|define
name|SII_S_CURRENT
value|0x01
define|#
directive|define
name|SII_S_REBUILD
value|0x02
define|#
directive|define
name|SII_S_DROPPED
value|0x03
define|#
directive|define
name|SII_S_REMOVED
value|0x04
name|uint8_t
name|raid_status
decl_stmt|;
define|#
directive|define
name|SII_S_ONLINE
value|0x01
define|#
directive|define
name|SII_S_AVAILABLE
value|0x02
name|uint8_t
name|raid_location
decl_stmt|;
comment|/* 149 */
name|uint8_t
name|disk_location
decl_stmt|;
name|uint8_t
name|auto_rebuild
decl_stmt|;
comment|/* 150 */
define|#
directive|define
name|SII_R_REBUILD
value|0x00
define|#
directive|define
name|SII_R_NOREBUILD
value|0xff
name|uint8_t
name|dummy_3
decl_stmt|;
name|uint8_t
name|name
index|[
literal|16
index|]
decl_stmt|;
comment|/* 151 - 158 */
name|uint16_t
name|checksum
decl_stmt|;
comment|/* 159 */
name|uint16_t
name|ata_params_160_255
index|[
literal|96
index|]
decl_stmt|;
block|}
name|__packed
struct|;
end_struct

begin_struct
struct|struct
name|g_raid_md_sii_perdisk
block|{
name|struct
name|sii_raid_conf
modifier|*
name|pd_meta
decl_stmt|;
name|int
name|pd_disk_pos
decl_stmt|;
name|off_t
name|pd_disk_size
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|g_raid_md_sii_object
block|{
name|struct
name|g_raid_md_object
name|mdio_base
decl_stmt|;
name|uint8_t
name|mdio_timestamp
index|[
literal|6
index|]
decl_stmt|;
name|uint8_t
name|mdio_location
decl_stmt|;
name|uint32_t
name|mdio_generation
decl_stmt|;
name|struct
name|sii_raid_conf
modifier|*
name|mdio_meta
decl_stmt|;
name|struct
name|callout
name|mdio_start_co
decl_stmt|;
comment|/* STARTING state timer. */
name|int
name|mdio_total_disks
decl_stmt|;
name|int
name|mdio_disks_present
decl_stmt|;
name|int
name|mdio_started
decl_stmt|;
name|int
name|mdio_incomplete
decl_stmt|;
name|struct
name|root_hold_token
modifier|*
name|mdio_rootmount
decl_stmt|;
comment|/* Root mount delay token. */
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|g_raid_md_create_t
name|g_raid_md_create_sii
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|g_raid_md_taste_t
name|g_raid_md_taste_sii
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|g_raid_md_event_t
name|g_raid_md_event_sii
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|g_raid_md_ctl_t
name|g_raid_md_ctl_sii
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|g_raid_md_write_t
name|g_raid_md_write_sii
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|g_raid_md_fail_disk_t
name|g_raid_md_fail_disk_sii
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|g_raid_md_free_disk_t
name|g_raid_md_free_disk_sii
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|g_raid_md_free_t
name|g_raid_md_free_sii
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|kobj_method_t
name|g_raid_md_sii_methods
index|[]
init|=
block|{
name|KOBJMETHOD
argument_list|(
name|g_raid_md_create
argument_list|,
name|g_raid_md_create_sii
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|g_raid_md_taste
argument_list|,
name|g_raid_md_taste_sii
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|g_raid_md_event
argument_list|,
name|g_raid_md_event_sii
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|g_raid_md_ctl
argument_list|,
name|g_raid_md_ctl_sii
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|g_raid_md_write
argument_list|,
name|g_raid_md_write_sii
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|g_raid_md_fail_disk
argument_list|,
name|g_raid_md_fail_disk_sii
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|g_raid_md_free_disk
argument_list|,
name|g_raid_md_free_disk_sii
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|g_raid_md_free
argument_list|,
name|g_raid_md_free_sii
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|g_raid_md_class
name|g_raid_md_sii_class
init|=
block|{
literal|"SiI"
block|,
name|g_raid_md_sii_methods
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|g_raid_md_sii_object
argument_list|)
block|,
operator|.
name|mdc_priority
operator|=
literal|100
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|g_raid_md_sii_print
parameter_list|(
name|struct
name|sii_raid_conf
modifier|*
name|meta
parameter_list|)
block|{
if|if
condition|(
name|g_raid_debug
operator|<
literal|1
condition|)
return|return;
name|printf
argument_list|(
literal|"********* ATA SiI RAID Metadata *********\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"total_sectors       %llu\n"
argument_list|,
operator|(
name|long
name|long
name|unsigned
operator|)
name|meta
operator|->
name|total_sectors
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"product_id          0x%04x\n"
argument_list|,
name|meta
operator|->
name|product_id
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"vendor_id           0x%04x\n"
argument_list|,
name|meta
operator|->
name|vendor_id
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"version_minor       0x%04x\n"
argument_list|,
name|meta
operator|->
name|version_minor
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"version_major       0x%04x\n"
argument_list|,
name|meta
operator|->
name|version_major
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"timestamp           0x%02x%02x%02x%02x%02x%02x\n"
argument_list|,
name|meta
operator|->
name|timestamp
index|[
literal|5
index|]
argument_list|,
name|meta
operator|->
name|timestamp
index|[
literal|4
index|]
argument_list|,
name|meta
operator|->
name|timestamp
index|[
literal|3
index|]
argument_list|,
name|meta
operator|->
name|timestamp
index|[
literal|2
index|]
argument_list|,
name|meta
operator|->
name|timestamp
index|[
literal|1
index|]
argument_list|,
name|meta
operator|->
name|timestamp
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"strip_sectors       %d\n"
argument_list|,
name|meta
operator|->
name|strip_sectors
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"disk_number         %d\n"
argument_list|,
name|meta
operator|->
name|disk_number
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"type                0x%02x\n"
argument_list|,
name|meta
operator|->
name|type
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"raid0_disks         %d\n"
argument_list|,
name|meta
operator|->
name|raid0_disks
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"raid0_ident         %d\n"
argument_list|,
name|meta
operator|->
name|raid0_ident
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"raid1_disks         %d\n"
argument_list|,
name|meta
operator|->
name|raid1_disks
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"raid1_ident         %d\n"
argument_list|,
name|meta
operator|->
name|raid1_ident
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"rebuild_lba         %llu\n"
argument_list|,
operator|(
name|long
name|long
name|unsigned
operator|)
name|meta
operator|->
name|rebuild_lba
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"generation          %d\n"
argument_list|,
name|meta
operator|->
name|generation
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"disk_status         %d\n"
argument_list|,
name|meta
operator|->
name|disk_status
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"raid_status         %d\n"
argument_list|,
name|meta
operator|->
name|raid_status
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"raid_location       %d\n"
argument_list|,
name|meta
operator|->
name|raid_location
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"disk_location       %d\n"
argument_list|,
name|meta
operator|->
name|disk_location
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"auto_rebuild        %d\n"
argument_list|,
name|meta
operator|->
name|auto_rebuild
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"name<%.16s>\n"
argument_list|,
name|meta
operator|->
name|name
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"checksum            0x%04x\n"
argument_list|,
name|meta
operator|->
name|checksum
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"=================================================\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|sii_raid_conf
modifier|*
name|sii_meta_copy
parameter_list|(
name|struct
name|sii_raid_conf
modifier|*
name|meta
parameter_list|)
block|{
name|struct
name|sii_raid_conf
modifier|*
name|nmeta
decl_stmt|;
name|nmeta
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|meta
argument_list|)
argument_list|,
name|M_MD_SII
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|nmeta
argument_list|,
name|meta
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|meta
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|nmeta
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sii_meta_total_disks
parameter_list|(
name|struct
name|sii_raid_conf
modifier|*
name|meta
parameter_list|)
block|{
switch|switch
condition|(
name|meta
operator|->
name|type
condition|)
block|{
case|case
name|SII_T_RAID0
case|:
case|case
name|SII_T_RAID5
case|:
case|case
name|SII_T_CONCAT
case|:
return|return
operator|(
name|meta
operator|->
name|raid0_disks
operator|)
return|;
case|case
name|SII_T_RAID1
case|:
return|return
operator|(
name|meta
operator|->
name|raid1_disks
operator|)
return|;
case|case
name|SII_T_RAID01
case|:
return|return
operator|(
name|meta
operator|->
name|raid0_disks
operator|*
name|meta
operator|->
name|raid1_disks
operator|)
return|;
case|case
name|SII_T_SPARE
case|:
case|case
name|SII_T_JBOD
case|:
return|return
operator|(
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sii_meta_disk_pos
parameter_list|(
name|struct
name|sii_raid_conf
modifier|*
name|meta
parameter_list|,
name|struct
name|sii_raid_conf
modifier|*
name|pdmeta
parameter_list|)
block|{
if|if
condition|(
name|pdmeta
operator|->
name|type
operator|==
name|SII_T_SPARE
condition|)
return|return
operator|(
operator|-
literal|3
operator|)
return|;
if|if
condition|(
name|memcmp
argument_list|(
operator|&
name|meta
operator|->
name|timestamp
argument_list|,
operator|&
name|pdmeta
operator|->
name|timestamp
argument_list|,
literal|6
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
switch|switch
condition|(
name|pdmeta
operator|->
name|type
condition|)
block|{
case|case
name|SII_T_RAID0
case|:
case|case
name|SII_T_RAID1
case|:
case|case
name|SII_T_RAID5
case|:
case|case
name|SII_T_CONCAT
case|:
return|return
operator|(
name|pdmeta
operator|->
name|disk_number
operator|)
return|;
case|case
name|SII_T_RAID01
case|:
return|return
operator|(
name|pdmeta
operator|->
name|raid1_ident
operator|*
name|pdmeta
operator|->
name|raid1_disks
operator|+
name|pdmeta
operator|->
name|raid0_ident
operator|)
return|;
case|case
name|SII_T_JBOD
case|:
return|return
operator|(
literal|0
operator|)
return|;
block|}
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|sii_meta_get_name
parameter_list|(
name|struct
name|sii_raid_conf
modifier|*
name|meta
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|strncpy
argument_list|(
name|buf
argument_list|,
name|meta
operator|->
name|name
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|buf
index|[
literal|16
index|]
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|15
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
block|{
if|if
condition|(
name|buf
index|[
name|i
index|]
operator|>
literal|0x20
condition|)
break|break;
name|buf
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|sii_meta_put_name
parameter_list|(
name|struct
name|sii_raid_conf
modifier|*
name|meta
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|memset
argument_list|(
name|meta
operator|->
name|name
argument_list|,
literal|0x20
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|meta
operator|->
name|name
argument_list|,
name|buf
argument_list|,
name|MIN
argument_list|(
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|16
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|sii_raid_conf
modifier|*
name|sii_meta_read
parameter_list|(
name|struct
name|g_consumer
modifier|*
name|cp
parameter_list|)
block|{
name|struct
name|g_provider
modifier|*
name|pp
decl_stmt|;
name|struct
name|sii_raid_conf
modifier|*
name|meta
decl_stmt|;
name|char
modifier|*
name|buf
decl_stmt|;
name|int
name|error
decl_stmt|,
name|i
decl_stmt|;
name|uint16_t
name|checksum
decl_stmt|,
modifier|*
name|ptr
decl_stmt|;
name|pp
operator|=
name|cp
operator|->
name|provider
expr_stmt|;
comment|/* Read the anchor sector. */
name|buf
operator|=
name|g_read_data
argument_list|(
name|cp
argument_list|,
name|pp
operator|->
name|mediasize
operator|-
name|pp
operator|->
name|sectorsize
argument_list|,
name|pp
operator|->
name|sectorsize
argument_list|,
operator|&
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
block|{
name|G_RAID_DEBUG
argument_list|(
literal|1
argument_list|,
literal|"Cannot read metadata from %s (error=%d)."
argument_list|,
name|pp
operator|->
name|name
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|meta
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|meta
argument_list|)
argument_list|,
name|M_MD_SII
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|meta
argument_list|,
name|buf
argument_list|,
name|min
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|meta
argument_list|)
argument_list|,
name|pp
operator|->
name|sectorsize
argument_list|)
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
comment|/* Check vendor ID. */
if|if
condition|(
name|meta
operator|->
name|vendor_id
operator|!=
literal|0x1095
condition|)
block|{
name|G_RAID_DEBUG
argument_list|(
literal|1
argument_list|,
literal|"SiI vendor ID check failed on %s (0x%04x)"
argument_list|,
name|pp
operator|->
name|name
argument_list|,
name|meta
operator|->
name|vendor_id
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|meta
argument_list|,
name|M_MD_SII
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
comment|/* Check metadata major version. */
if|if
condition|(
name|meta
operator|->
name|version_major
operator|!=
literal|2
condition|)
block|{
name|G_RAID_DEBUG
argument_list|(
literal|1
argument_list|,
literal|"SiI version check failed on %s (%d.%d)"
argument_list|,
name|pp
operator|->
name|name
argument_list|,
name|meta
operator|->
name|version_major
argument_list|,
name|meta
operator|->
name|version_minor
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|meta
argument_list|,
name|M_MD_SII
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
comment|/* Check metadata checksum. */
for|for
control|(
name|checksum
operator|=
literal|0
operator|,
name|ptr
operator|=
operator|(
name|uint16_t
operator|*
operator|)
name|meta
operator|,
name|i
operator|=
literal|0
init|;
name|i
operator|<=
literal|159
condition|;
name|i
operator|++
control|)
name|checksum
operator|+=
operator|*
name|ptr
operator|++
expr_stmt|;
if|if
condition|(
name|checksum
operator|!=
literal|0
condition|)
block|{
name|G_RAID_DEBUG
argument_list|(
literal|1
argument_list|,
literal|"SiI checksum check failed on %s"
argument_list|,
name|pp
operator|->
name|name
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|meta
argument_list|,
name|M_MD_SII
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
comment|/* Check raid type. */
if|if
condition|(
name|meta
operator|->
name|type
operator|!=
name|SII_T_RAID0
operator|&&
name|meta
operator|->
name|type
operator|!=
name|SII_T_RAID1
operator|&&
name|meta
operator|->
name|type
operator|!=
name|SII_T_RAID01
operator|&&
name|meta
operator|->
name|type
operator|!=
name|SII_T_SPARE
operator|&&
name|meta
operator|->
name|type
operator|!=
name|SII_T_RAID5
operator|&&
name|meta
operator|->
name|type
operator|!=
name|SII_T_CONCAT
operator|&&
name|meta
operator|->
name|type
operator|!=
name|SII_T_JBOD
condition|)
block|{
name|G_RAID_DEBUG
argument_list|(
literal|1
argument_list|,
literal|"SiI unknown RAID level on %s (0x%02x)"
argument_list|,
name|pp
operator|->
name|name
argument_list|,
name|meta
operator|->
name|type
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|meta
argument_list|,
name|M_MD_SII
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
return|return
operator|(
name|meta
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sii_meta_write
parameter_list|(
name|struct
name|g_consumer
modifier|*
name|cp
parameter_list|,
name|struct
name|sii_raid_conf
modifier|*
name|meta
parameter_list|)
block|{
name|struct
name|g_provider
modifier|*
name|pp
decl_stmt|;
name|char
modifier|*
name|buf
decl_stmt|;
name|int
name|error
decl_stmt|,
name|i
decl_stmt|;
name|uint16_t
name|checksum
decl_stmt|,
modifier|*
name|ptr
decl_stmt|;
name|pp
operator|=
name|cp
operator|->
name|provider
expr_stmt|;
comment|/* Recalculate checksum for case if metadata were changed. */
name|meta
operator|->
name|checksum
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|checksum
operator|=
literal|0
operator|,
name|ptr
operator|=
operator|(
name|uint16_t
operator|*
operator|)
name|meta
operator|,
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|159
condition|;
name|i
operator|++
control|)
name|checksum
operator|+=
operator|*
name|ptr
operator|++
expr_stmt|;
name|meta
operator|->
name|checksum
operator|-=
name|checksum
expr_stmt|;
comment|/* Create and fill buffer. */
name|buf
operator|=
name|malloc
argument_list|(
name|pp
operator|->
name|sectorsize
argument_list|,
name|M_MD_SII
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|buf
argument_list|,
name|meta
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|meta
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Write 4 copies of metadata. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
name|error
operator|=
name|g_write_data
argument_list|(
name|cp
argument_list|,
name|pp
operator|->
name|mediasize
operator|-
operator|(
name|pp
operator|->
name|sectorsize
operator|*
operator|(
literal|1
operator|+
literal|0x200
operator|*
name|i
operator|)
operator|)
argument_list|,
name|buf
argument_list|,
name|pp
operator|->
name|sectorsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|G_RAID_DEBUG
argument_list|(
literal|1
argument_list|,
literal|"Cannot write metadata to %s (error=%d)."
argument_list|,
name|pp
operator|->
name|name
argument_list|,
name|error
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|free
argument_list|(
name|buf
argument_list|,
name|M_MD_SII
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sii_meta_erase
parameter_list|(
name|struct
name|g_consumer
modifier|*
name|cp
parameter_list|)
block|{
name|struct
name|g_provider
modifier|*
name|pp
decl_stmt|;
name|char
modifier|*
name|buf
decl_stmt|;
name|int
name|error
decl_stmt|,
name|i
decl_stmt|;
name|pp
operator|=
name|cp
operator|->
name|provider
expr_stmt|;
name|buf
operator|=
name|malloc
argument_list|(
name|pp
operator|->
name|sectorsize
argument_list|,
name|M_MD_SII
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
comment|/* Write 4 copies of metadata. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
name|error
operator|=
name|g_write_data
argument_list|(
name|cp
argument_list|,
name|pp
operator|->
name|mediasize
operator|-
operator|(
name|pp
operator|->
name|sectorsize
operator|*
operator|(
literal|1
operator|+
literal|0x200
operator|*
name|i
operator|)
operator|)
argument_list|,
name|buf
argument_list|,
name|pp
operator|->
name|sectorsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|G_RAID_DEBUG
argument_list|(
literal|1
argument_list|,
literal|"Cannot erase metadata on %s (error=%d)."
argument_list|,
name|pp
operator|->
name|name
argument_list|,
name|error
argument_list|)
expr_stmt|;
block|}
block|}
name|free
argument_list|(
name|buf
argument_list|,
name|M_MD_SII
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sii_meta_write_spare
parameter_list|(
name|struct
name|g_consumer
modifier|*
name|cp
parameter_list|)
block|{
name|struct
name|sii_raid_conf
modifier|*
name|meta
decl_stmt|;
name|int
name|error
decl_stmt|;
name|meta
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|meta
argument_list|)
argument_list|,
name|M_MD_SII
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|meta
operator|->
name|total_sectors
operator|=
name|cp
operator|->
name|provider
operator|->
name|mediasize
operator|/
name|cp
operator|->
name|provider
operator|->
name|sectorsize
operator|-
literal|0x800
expr_stmt|;
name|meta
operator|->
name|vendor_id
operator|=
literal|0x1095
expr_stmt|;
name|meta
operator|->
name|version_minor
operator|=
literal|0
expr_stmt|;
name|meta
operator|->
name|version_major
operator|=
literal|2
expr_stmt|;
name|meta
operator|->
name|timestamp
index|[
literal|0
index|]
operator|=
name|arc4random
argument_list|()
expr_stmt|;
name|meta
operator|->
name|timestamp
index|[
literal|1
index|]
operator|=
name|arc4random
argument_list|()
expr_stmt|;
name|meta
operator|->
name|timestamp
index|[
literal|2
index|]
operator|=
name|arc4random
argument_list|()
expr_stmt|;
name|meta
operator|->
name|timestamp
index|[
literal|3
index|]
operator|=
name|arc4random
argument_list|()
expr_stmt|;
name|meta
operator|->
name|timestamp
index|[
literal|4
index|]
operator|=
name|arc4random
argument_list|()
expr_stmt|;
name|meta
operator|->
name|timestamp
index|[
literal|5
index|]
operator|=
name|arc4random
argument_list|()
expr_stmt|;
name|meta
operator|->
name|type
operator|=
name|SII_T_SPARE
expr_stmt|;
name|meta
operator|->
name|generation
operator|=
literal|1
expr_stmt|;
name|meta
operator|->
name|raid1_ident
operator|=
literal|0xff
expr_stmt|;
name|meta
operator|->
name|raid_location
operator|=
name|arc4random
argument_list|()
expr_stmt|;
name|error
operator|=
name|sii_meta_write
argument_list|(
name|cp
argument_list|,
name|meta
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|meta
argument_list|,
name|M_MD_SII
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|g_raid_disk
modifier|*
name|g_raid_md_sii_get_disk
parameter_list|(
name|struct
name|g_raid_softc
modifier|*
name|sc
parameter_list|,
name|int
name|id
parameter_list|)
block|{
name|struct
name|g_raid_disk
modifier|*
name|disk
decl_stmt|;
name|struct
name|g_raid_md_sii_perdisk
modifier|*
name|pd
decl_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|disk
argument_list|,
argument|&sc->sc_disks
argument_list|,
argument|d_next
argument_list|)
block|{
name|pd
operator|=
operator|(
expr|struct
name|g_raid_md_sii_perdisk
operator|*
operator|)
name|disk
operator|->
name|d_md_data
expr_stmt|;
if|if
condition|(
name|pd
operator|->
name|pd_disk_pos
operator|==
name|id
condition|)
break|break;
block|}
return|return
operator|(
name|disk
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|g_raid_md_sii_supported
parameter_list|(
name|int
name|level
parameter_list|,
name|int
name|qual
parameter_list|,
name|int
name|disks
parameter_list|,
name|int
name|force
parameter_list|)
block|{
if|if
condition|(
name|disks
operator|>
literal|8
condition|)
return|return
operator|(
literal|0
operator|)
return|;
switch|switch
condition|(
name|level
condition|)
block|{
case|case
name|G_RAID_VOLUME_RL_RAID0
case|:
if|if
condition|(
name|disks
operator|<
literal|1
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
operator|!
name|force
operator|&&
operator|(
name|disks
operator|<
literal|2
operator|||
name|disks
operator|>
literal|6
operator|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
break|break;
case|case
name|G_RAID_VOLUME_RL_RAID1
case|:
if|if
condition|(
name|disks
operator|<
literal|1
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
operator|!
name|force
operator|&&
operator|(
name|disks
operator|!=
literal|2
operator|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
break|break;
case|case
name|G_RAID_VOLUME_RL_RAID1E
case|:
if|if
condition|(
name|disks
operator|<
literal|2
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|disks
operator|%
literal|2
operator|!=
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
operator|!
name|force
operator|&&
operator|(
name|disks
operator|<
literal|4
operator|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
break|break;
case|case
name|G_RAID_VOLUME_RL_SINGLE
case|:
if|if
condition|(
name|disks
operator|!=
literal|1
condition|)
return|return
operator|(
literal|0
operator|)
return|;
break|break;
case|case
name|G_RAID_VOLUME_RL_CONCAT
case|:
if|if
condition|(
name|disks
operator|<
literal|2
condition|)
return|return
operator|(
literal|0
operator|)
return|;
break|break;
case|case
name|G_RAID_VOLUME_RL_RAID5
case|:
if|if
condition|(
name|disks
operator|<
literal|3
condition|)
return|return
operator|(
literal|0
operator|)
return|;
break|break;
default|default:
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|qual
operator|!=
name|G_RAID_VOLUME_RLQ_NONE
condition|)
return|return
operator|(
literal|0
operator|)
return|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|g_raid_md_sii_start_disk
parameter_list|(
name|struct
name|g_raid_disk
modifier|*
name|disk
parameter_list|)
block|{
name|struct
name|g_raid_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|g_raid_subdisk
modifier|*
name|sd
decl_stmt|,
modifier|*
name|tmpsd
decl_stmt|;
name|struct
name|g_raid_disk
modifier|*
name|olddisk
decl_stmt|,
modifier|*
name|tmpdisk
decl_stmt|;
name|struct
name|g_raid_md_object
modifier|*
name|md
decl_stmt|;
name|struct
name|g_raid_md_sii_object
modifier|*
name|mdi
decl_stmt|;
name|struct
name|g_raid_md_sii_perdisk
modifier|*
name|pd
decl_stmt|,
modifier|*
name|oldpd
decl_stmt|;
name|struct
name|sii_raid_conf
modifier|*
name|meta
decl_stmt|;
name|int
name|disk_pos
decl_stmt|,
name|resurrection
init|=
literal|0
decl_stmt|;
name|sc
operator|=
name|disk
operator|->
name|d_softc
expr_stmt|;
name|md
operator|=
name|sc
operator|->
name|sc_md
expr_stmt|;
name|mdi
operator|=
operator|(
expr|struct
name|g_raid_md_sii_object
operator|*
operator|)
name|md
expr_stmt|;
name|meta
operator|=
name|mdi
operator|->
name|mdio_meta
expr_stmt|;
name|pd
operator|=
operator|(
expr|struct
name|g_raid_md_sii_perdisk
operator|*
operator|)
name|disk
operator|->
name|d_md_data
expr_stmt|;
name|olddisk
operator|=
name|NULL
expr_stmt|;
comment|/* Find disk position in metadata by it's serial. */
if|if
condition|(
name|pd
operator|->
name|pd_meta
operator|!=
name|NULL
condition|)
name|disk_pos
operator|=
name|sii_meta_disk_pos
argument_list|(
name|meta
argument_list|,
name|pd
operator|->
name|pd_meta
argument_list|)
expr_stmt|;
else|else
name|disk_pos
operator|=
operator|-
literal|3
expr_stmt|;
if|if
condition|(
name|disk_pos
operator|<
literal|0
condition|)
block|{
name|G_RAID_DEBUG1
argument_list|(
literal|1
argument_list|,
name|sc
argument_list|,
literal|"Unknown, probably new or stale disk"
argument_list|)
expr_stmt|;
comment|/* If we are in the start process, that's all for now. */
if|if
condition|(
operator|!
name|mdi
operator|->
name|mdio_started
condition|)
goto|goto
name|nofit
goto|;
comment|/* 		 * If we have already started - try to get use of the disk. 		 * Try to replace OFFLINE disks first, then FAILED. 		 */
name|TAILQ_FOREACH
argument_list|(
argument|tmpdisk
argument_list|,
argument|&sc->sc_disks
argument_list|,
argument|d_next
argument_list|)
block|{
if|if
condition|(
name|tmpdisk
operator|->
name|d_state
operator|!=
name|G_RAID_DISK_S_OFFLINE
operator|&&
name|tmpdisk
operator|->
name|d_state
operator|!=
name|G_RAID_DISK_S_FAILED
condition|)
continue|continue;
comment|/* Make sure this disk is big enough. */
name|TAILQ_FOREACH
argument_list|(
argument|sd
argument_list|,
argument|&tmpdisk->d_subdisks
argument_list|,
argument|sd_next
argument_list|)
block|{
if|if
condition|(
name|sd
operator|->
name|sd_offset
operator|+
name|sd
operator|->
name|sd_size
operator|+
literal|512
operator|>
name|pd
operator|->
name|pd_disk_size
condition|)
block|{
name|G_RAID_DEBUG1
argument_list|(
literal|1
argument_list|,
name|sc
argument_list|,
literal|"Disk too small (%ju< %ju)"
argument_list|,
name|pd
operator|->
name|pd_disk_size
argument_list|,
name|sd
operator|->
name|sd_offset
operator|+
name|sd
operator|->
name|sd_size
operator|+
literal|512
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|sd
operator|!=
name|NULL
condition|)
continue|continue;
if|if
condition|(
name|tmpdisk
operator|->
name|d_state
operator|==
name|G_RAID_DISK_S_OFFLINE
condition|)
block|{
name|olddisk
operator|=
name|tmpdisk
expr_stmt|;
break|break;
block|}
elseif|else
if|if
condition|(
name|olddisk
operator|==
name|NULL
condition|)
name|olddisk
operator|=
name|tmpdisk
expr_stmt|;
block|}
if|if
condition|(
name|olddisk
operator|==
name|NULL
condition|)
block|{
name|nofit
label|:
if|if
condition|(
name|disk_pos
operator|==
operator|-
literal|3
operator|||
name|pd
operator|->
name|pd_disk_pos
operator|==
operator|-
literal|3
condition|)
block|{
name|g_raid_change_disk_state
argument_list|(
name|disk
argument_list|,
name|G_RAID_DISK_S_SPARE
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
else|else
block|{
name|g_raid_change_disk_state
argument_list|(
name|disk
argument_list|,
name|G_RAID_DISK_S_STALE
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
name|oldpd
operator|=
operator|(
expr|struct
name|g_raid_md_sii_perdisk
operator|*
operator|)
name|olddisk
operator|->
name|d_md_data
expr_stmt|;
name|disk_pos
operator|=
name|oldpd
operator|->
name|pd_disk_pos
expr_stmt|;
name|resurrection
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|olddisk
operator|==
name|NULL
condition|)
block|{
comment|/* Find placeholder by position. */
name|olddisk
operator|=
name|g_raid_md_sii_get_disk
argument_list|(
name|sc
argument_list|,
name|disk_pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|olddisk
operator|==
name|NULL
condition|)
name|panic
argument_list|(
literal|"No disk at position %d!"
argument_list|,
name|disk_pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|olddisk
operator|->
name|d_state
operator|!=
name|G_RAID_DISK_S_OFFLINE
condition|)
block|{
name|G_RAID_DEBUG1
argument_list|(
literal|1
argument_list|,
name|sc
argument_list|,
literal|"More then one disk for pos %d"
argument_list|,
name|disk_pos
argument_list|)
expr_stmt|;
name|g_raid_change_disk_state
argument_list|(
name|disk
argument_list|,
name|G_RAID_DISK_S_STALE
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|oldpd
operator|=
operator|(
expr|struct
name|g_raid_md_sii_perdisk
operator|*
operator|)
name|olddisk
operator|->
name|d_md_data
expr_stmt|;
block|}
comment|/* Replace failed disk or placeholder with new disk. */
name|TAILQ_FOREACH_SAFE
argument_list|(
argument|sd
argument_list|,
argument|&olddisk->d_subdisks
argument_list|,
argument|sd_next
argument_list|,
argument|tmpsd
argument_list|)
block|{
name|TAILQ_REMOVE
argument_list|(
operator|&
name|olddisk
operator|->
name|d_subdisks
argument_list|,
name|sd
argument_list|,
name|sd_next
argument_list|)
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|disk
operator|->
name|d_subdisks
argument_list|,
name|sd
argument_list|,
name|sd_next
argument_list|)
expr_stmt|;
name|sd
operator|->
name|sd_disk
operator|=
name|disk
expr_stmt|;
block|}
name|oldpd
operator|->
name|pd_disk_pos
operator|=
operator|-
literal|2
expr_stmt|;
name|pd
operator|->
name|pd_disk_pos
operator|=
name|disk_pos
expr_stmt|;
comment|/* If it was placeholder -- destroy it. */
if|if
condition|(
name|olddisk
operator|->
name|d_state
operator|==
name|G_RAID_DISK_S_OFFLINE
condition|)
block|{
name|g_raid_destroy_disk
argument_list|(
name|olddisk
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Otherwise, make it STALE_FAILED. */
name|g_raid_change_disk_state
argument_list|(
name|olddisk
argument_list|,
name|G_RAID_DISK_S_STALE_FAILED
argument_list|)
expr_stmt|;
block|}
comment|/* Welcome the new disk. */
if|if
condition|(
name|resurrection
condition|)
name|g_raid_change_disk_state
argument_list|(
name|disk
argument_list|,
name|G_RAID_DISK_S_ACTIVE
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|pd
operator|->
name|pd_meta
operator|->
name|disk_status
operator|==
name|SII_S_CURRENT
operator|||
name|pd
operator|->
name|pd_meta
operator|->
name|disk_status
operator|==
name|SII_S_REBUILD
condition|)
name|g_raid_change_disk_state
argument_list|(
name|disk
argument_list|,
name|G_RAID_DISK_S_ACTIVE
argument_list|)
expr_stmt|;
else|else
name|g_raid_change_disk_state
argument_list|(
name|disk
argument_list|,
name|G_RAID_DISK_S_FAILED
argument_list|)
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|sd
argument_list|,
argument|&disk->d_subdisks
argument_list|,
argument|sd_next
argument_list|)
block|{
comment|/* 		 * Different disks may have different sizes, 		 * in concat mode. Update from real disk size. 		 */
if|if
condition|(
name|meta
operator|->
name|type
operator|==
name|SII_T_CONCAT
operator|||
name|meta
operator|->
name|type
operator|==
name|SII_T_JBOD
condition|)
name|sd
operator|->
name|sd_size
operator|=
name|pd
operator|->
name|pd_disk_size
operator|-
literal|0x800
operator|*
literal|512
expr_stmt|;
if|if
condition|(
name|resurrection
condition|)
block|{
comment|/* New or ex-spare disk. */
name|g_raid_change_subdisk_state
argument_list|(
name|sd
argument_list|,
name|G_RAID_SUBDISK_S_NEW
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pd
operator|->
name|pd_meta
operator|->
name|disk_status
operator|==
name|SII_S_REBUILD
condition|)
block|{
comment|/* Rebuilding disk. */
name|g_raid_change_subdisk_state
argument_list|(
name|sd
argument_list|,
name|G_RAID_SUBDISK_S_REBUILD
argument_list|)
expr_stmt|;
if|if
condition|(
name|pd
operator|->
name|pd_meta
operator|->
name|generation
operator|==
name|meta
operator|->
name|generation
condition|)
name|sd
operator|->
name|sd_rebuild_pos
operator|=
name|pd
operator|->
name|pd_meta
operator|->
name|rebuild_lba
operator|*
literal|512
expr_stmt|;
else|else
name|sd
operator|->
name|sd_rebuild_pos
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pd
operator|->
name|pd_meta
operator|->
name|disk_status
operator|==
name|SII_S_CURRENT
condition|)
block|{
if|if
condition|(
name|pd
operator|->
name|pd_meta
operator|->
name|raid_status
operator|==
name|SII_S_ONLINE
operator|||
name|pd
operator|->
name|pd_meta
operator|->
name|generation
operator|!=
name|meta
operator|->
name|generation
condition|)
block|{
comment|/* Dirty or resyncing disk. */
name|g_raid_change_subdisk_state
argument_list|(
name|sd
argument_list|,
name|G_RAID_SUBDISK_S_STALE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Up to date disk. */
name|g_raid_change_subdisk_state
argument_list|(
name|sd
argument_list|,
name|G_RAID_SUBDISK_S_ACTIVE
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|g_raid_change_subdisk_state
argument_list|(
name|sd
argument_list|,
name|G_RAID_SUBDISK_S_FAILED
argument_list|)
expr_stmt|;
block|}
name|g_raid_event_send
argument_list|(
name|sd
argument_list|,
name|G_RAID_SUBDISK_E_NEW
argument_list|,
name|G_RAID_EVENT_SUBDISK
argument_list|)
expr_stmt|;
block|}
comment|/* Update status of our need for spare. */
if|if
condition|(
name|mdi
operator|->
name|mdio_started
condition|)
block|{
name|mdi
operator|->
name|mdio_incomplete
operator|=
operator|(
name|g_raid_ndisks
argument_list|(
name|sc
argument_list|,
name|G_RAID_DISK_S_ACTIVE
argument_list|)
operator|<
name|mdi
operator|->
name|mdio_total_disks
operator|)
expr_stmt|;
block|}
return|return
operator|(
name|resurrection
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|g_disk_md_sii_retaste
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|int
name|pending
parameter_list|)
block|{
name|G_RAID_DEBUG
argument_list|(
literal|1
argument_list|,
literal|"Array is not complete, trying to retaste."
argument_list|)
expr_stmt|;
name|g_retaste
argument_list|(
operator|&
name|g_raid_class
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|arg
argument_list|,
name|M_MD_SII
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|g_raid_md_sii_refill
parameter_list|(
name|struct
name|g_raid_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|g_raid_md_object
modifier|*
name|md
decl_stmt|;
name|struct
name|g_raid_md_sii_object
modifier|*
name|mdi
decl_stmt|;
name|struct
name|sii_raid_conf
modifier|*
name|meta
decl_stmt|;
name|struct
name|g_raid_disk
modifier|*
name|disk
decl_stmt|;
name|struct
name|task
modifier|*
name|task
decl_stmt|;
name|int
name|update
decl_stmt|,
name|na
decl_stmt|;
name|md
operator|=
name|sc
operator|->
name|sc_md
expr_stmt|;
name|mdi
operator|=
operator|(
expr|struct
name|g_raid_md_sii_object
operator|*
operator|)
name|md
expr_stmt|;
name|meta
operator|=
name|mdi
operator|->
name|mdio_meta
expr_stmt|;
name|update
operator|=
literal|0
expr_stmt|;
do|do
block|{
comment|/* Make sure we miss anything. */
name|na
operator|=
name|g_raid_ndisks
argument_list|(
name|sc
argument_list|,
name|G_RAID_DISK_S_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|na
operator|==
name|mdi
operator|->
name|mdio_total_disks
condition|)
break|break;
name|G_RAID_DEBUG1
argument_list|(
literal|1
argument_list|,
name|md
operator|->
name|mdo_softc
argument_list|,
literal|"Array is not complete (%d of %d), "
literal|"trying to refill."
argument_list|,
name|na
argument_list|,
name|mdi
operator|->
name|mdio_total_disks
argument_list|)
expr_stmt|;
comment|/* Try to get use some of STALE disks. */
name|TAILQ_FOREACH
argument_list|(
argument|disk
argument_list|,
argument|&sc->sc_disks
argument_list|,
argument|d_next
argument_list|)
block|{
if|if
condition|(
name|disk
operator|->
name|d_state
operator|==
name|G_RAID_DISK_S_STALE
condition|)
block|{
name|update
operator|+=
name|g_raid_md_sii_start_disk
argument_list|(
name|disk
argument_list|)
expr_stmt|;
if|if
condition|(
name|disk
operator|->
name|d_state
operator|==
name|G_RAID_DISK_S_ACTIVE
condition|)
break|break;
block|}
block|}
if|if
condition|(
name|disk
operator|!=
name|NULL
condition|)
continue|continue;
comment|/* Try to get use some of SPARE disks. */
name|TAILQ_FOREACH
argument_list|(
argument|disk
argument_list|,
argument|&sc->sc_disks
argument_list|,
argument|d_next
argument_list|)
block|{
if|if
condition|(
name|disk
operator|->
name|d_state
operator|==
name|G_RAID_DISK_S_SPARE
condition|)
block|{
name|update
operator|+=
name|g_raid_md_sii_start_disk
argument_list|(
name|disk
argument_list|)
expr_stmt|;
if|if
condition|(
name|disk
operator|->
name|d_state
operator|==
name|G_RAID_DISK_S_ACTIVE
condition|)
break|break;
block|}
block|}
block|}
do|while
condition|(
name|disk
operator|!=
name|NULL
condition|)
do|;
comment|/* Write new metadata if we changed something. */
if|if
condition|(
name|update
condition|)
block|{
name|g_raid_md_write_sii
argument_list|(
name|md
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|meta
operator|=
name|mdi
operator|->
name|mdio_meta
expr_stmt|;
block|}
comment|/* Update status of our need for spare. */
name|mdi
operator|->
name|mdio_incomplete
operator|=
operator|(
name|g_raid_ndisks
argument_list|(
name|sc
argument_list|,
name|G_RAID_DISK_S_ACTIVE
argument_list|)
operator|<
name|mdi
operator|->
name|mdio_total_disks
operator|)
expr_stmt|;
comment|/* Request retaste hoping to find spare. */
if|if
condition|(
name|mdi
operator|->
name|mdio_incomplete
condition|)
block|{
name|task
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|task
argument_list|)
argument_list|,
name|M_MD_SII
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|TASK_INIT
argument_list|(
name|task
argument_list|,
literal|0
argument_list|,
name|g_disk_md_sii_retaste
argument_list|,
name|task
argument_list|)
expr_stmt|;
name|taskqueue_enqueue
argument_list|(
name|taskqueue_swi
argument_list|,
name|task
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|g_raid_md_sii_start
parameter_list|(
name|struct
name|g_raid_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|g_raid_md_object
modifier|*
name|md
decl_stmt|;
name|struct
name|g_raid_md_sii_object
modifier|*
name|mdi
decl_stmt|;
name|struct
name|g_raid_md_sii_perdisk
modifier|*
name|pd
decl_stmt|;
name|struct
name|sii_raid_conf
modifier|*
name|meta
decl_stmt|;
name|struct
name|g_raid_volume
modifier|*
name|vol
decl_stmt|;
name|struct
name|g_raid_subdisk
modifier|*
name|sd
decl_stmt|;
name|struct
name|g_raid_disk
modifier|*
name|disk
decl_stmt|,
modifier|*
name|best
decl_stmt|;
name|off_t
name|size
decl_stmt|;
name|int
name|j
decl_stmt|,
name|disk_pos
decl_stmt|;
name|uint32_t
name|gendiff
decl_stmt|,
name|bestgendiff
decl_stmt|;
name|char
name|buf
index|[
literal|17
index|]
decl_stmt|;
name|md
operator|=
name|sc
operator|->
name|sc_md
expr_stmt|;
name|mdi
operator|=
operator|(
expr|struct
name|g_raid_md_sii_object
operator|*
operator|)
name|md
expr_stmt|;
name|meta
operator|=
name|mdi
operator|->
name|mdio_meta
expr_stmt|;
comment|/* Create volumes and subdisks. */
name|sii_meta_get_name
argument_list|(
name|meta
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|vol
operator|=
name|g_raid_create_volume
argument_list|(
name|sc
argument_list|,
name|buf
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|vol
operator|->
name|v_mediasize
operator|=
operator|(
name|off_t
operator|)
name|meta
operator|->
name|total_sectors
operator|*
literal|512
expr_stmt|;
if|if
condition|(
name|meta
operator|->
name|type
operator|==
name|SII_T_RAID0
condition|)
block|{
name|vol
operator|->
name|v_raid_level
operator|=
name|G_RAID_VOLUME_RL_RAID0
expr_stmt|;
name|size
operator|=
name|vol
operator|->
name|v_mediasize
operator|/
name|mdi
operator|->
name|mdio_total_disks
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|meta
operator|->
name|type
operator|==
name|SII_T_RAID1
condition|)
block|{
name|vol
operator|->
name|v_raid_level
operator|=
name|G_RAID_VOLUME_RL_RAID1
expr_stmt|;
name|size
operator|=
name|vol
operator|->
name|v_mediasize
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|meta
operator|->
name|type
operator|==
name|SII_T_RAID01
condition|)
block|{
name|vol
operator|->
name|v_raid_level
operator|=
name|G_RAID_VOLUME_RL_RAID1E
expr_stmt|;
name|size
operator|=
name|vol
operator|->
name|v_mediasize
operator|/
operator|(
name|mdi
operator|->
name|mdio_total_disks
operator|/
literal|2
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|meta
operator|->
name|type
operator|==
name|SII_T_CONCAT
condition|)
block|{
if|if
condition|(
name|mdi
operator|->
name|mdio_total_disks
operator|==
literal|1
condition|)
name|vol
operator|->
name|v_raid_level
operator|=
name|G_RAID_VOLUME_RL_SINGLE
expr_stmt|;
else|else
name|vol
operator|->
name|v_raid_level
operator|=
name|G_RAID_VOLUME_RL_CONCAT
expr_stmt|;
name|size
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|meta
operator|->
name|type
operator|==
name|SII_T_RAID5
condition|)
block|{
name|vol
operator|->
name|v_raid_level
operator|=
name|G_RAID_VOLUME_RL_RAID5
expr_stmt|;
name|size
operator|=
name|vol
operator|->
name|v_mediasize
operator|/
operator|(
name|mdi
operator|->
name|mdio_total_disks
operator|-
literal|1
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|meta
operator|->
name|type
operator|==
name|SII_T_JBOD
condition|)
block|{
name|vol
operator|->
name|v_raid_level
operator|=
name|G_RAID_VOLUME_RL_SINGLE
expr_stmt|;
name|size
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|vol
operator|->
name|v_raid_level
operator|=
name|G_RAID_VOLUME_RL_UNKNOWN
expr_stmt|;
name|size
operator|=
literal|0
expr_stmt|;
block|}
name|vol
operator|->
name|v_raid_level_qualifier
operator|=
name|G_RAID_VOLUME_RLQ_NONE
expr_stmt|;
name|vol
operator|->
name|v_strip_size
operator|=
name|meta
operator|->
name|strip_sectors
operator|*
literal|512
expr_stmt|;
comment|//ZZZ
name|vol
operator|->
name|v_disks_count
operator|=
name|mdi
operator|->
name|mdio_total_disks
expr_stmt|;
name|vol
operator|->
name|v_sectorsize
operator|=
literal|512
expr_stmt|;
comment|//ZZZ
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|vol
operator|->
name|v_disks_count
condition|;
name|j
operator|++
control|)
block|{
name|sd
operator|=
operator|&
name|vol
operator|->
name|v_subdisks
index|[
name|j
index|]
expr_stmt|;
name|sd
operator|->
name|sd_offset
operator|=
literal|0
expr_stmt|;
name|sd
operator|->
name|sd_size
operator|=
name|size
expr_stmt|;
block|}
name|g_raid_start_volume
argument_list|(
name|vol
argument_list|)
expr_stmt|;
comment|/* Create disk placeholders to store data for later writing. */
for|for
control|(
name|disk_pos
operator|=
literal|0
init|;
name|disk_pos
operator|<
name|mdi
operator|->
name|mdio_total_disks
condition|;
name|disk_pos
operator|++
control|)
block|{
name|pd
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|pd
argument_list|)
argument_list|,
name|M_MD_SII
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|pd
operator|->
name|pd_disk_pos
operator|=
name|disk_pos
expr_stmt|;
name|disk
operator|=
name|g_raid_create_disk
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|disk
operator|->
name|d_md_data
operator|=
operator|(
name|void
operator|*
operator|)
name|pd
expr_stmt|;
name|disk
operator|->
name|d_state
operator|=
name|G_RAID_DISK_S_OFFLINE
expr_stmt|;
name|sd
operator|=
operator|&
name|vol
operator|->
name|v_subdisks
index|[
name|disk_pos
index|]
expr_stmt|;
name|sd
operator|->
name|sd_disk
operator|=
name|disk
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|disk
operator|->
name|d_subdisks
argument_list|,
name|sd
argument_list|,
name|sd_next
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Make all disks found till the moment take their places 	 * in order of their generation numbers. 	 */
do|do
block|{
name|best
operator|=
name|NULL
expr_stmt|;
name|bestgendiff
operator|=
literal|0xffffffff
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|disk
argument_list|,
argument|&sc->sc_disks
argument_list|,
argument|d_next
argument_list|)
block|{
if|if
condition|(
name|disk
operator|->
name|d_state
operator|!=
name|G_RAID_DISK_S_NONE
condition|)
continue|continue;
name|pd
operator|=
name|disk
operator|->
name|d_md_data
expr_stmt|;
if|if
condition|(
name|pd
operator|->
name|pd_meta
operator|==
name|NULL
condition|)
name|gendiff
operator|=
literal|0xfffffffe
expr_stmt|;
else|else
name|gendiff
operator|=
name|meta
operator|->
name|generation
operator|-
name|pd
operator|->
name|pd_meta
operator|->
name|generation
expr_stmt|;
if|if
condition|(
name|gendiff
operator|<
name|bestgendiff
condition|)
block|{
name|best
operator|=
name|disk
expr_stmt|;
name|bestgendiff
operator|=
name|gendiff
expr_stmt|;
block|}
block|}
if|if
condition|(
name|best
operator|!=
name|NULL
condition|)
name|g_raid_md_sii_start_disk
argument_list|(
name|best
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|best
operator|!=
name|NULL
condition|)
do|;
name|mdi
operator|->
name|mdio_started
operator|=
literal|1
expr_stmt|;
name|G_RAID_DEBUG1
argument_list|(
literal|0
argument_list|,
name|sc
argument_list|,
literal|"Array started."
argument_list|)
expr_stmt|;
name|g_raid_md_write_sii
argument_list|(
name|md
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* Pickup any STALE/SPARE disks to refill array if needed. */
name|g_raid_md_sii_refill
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|g_raid_event_send
argument_list|(
name|vol
argument_list|,
name|G_RAID_VOLUME_E_START
argument_list|,
name|G_RAID_EVENT_VOLUME
argument_list|)
expr_stmt|;
name|callout_stop
argument_list|(
operator|&
name|mdi
operator|->
name|mdio_start_co
argument_list|)
expr_stmt|;
name|G_RAID_DEBUG1
argument_list|(
literal|1
argument_list|,
name|sc
argument_list|,
literal|"root_mount_rel %p"
argument_list|,
name|mdi
operator|->
name|mdio_rootmount
argument_list|)
expr_stmt|;
name|root_mount_rel
argument_list|(
name|mdi
operator|->
name|mdio_rootmount
argument_list|)
expr_stmt|;
name|mdi
operator|->
name|mdio_rootmount
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|g_raid_md_sii_new_disk
parameter_list|(
name|struct
name|g_raid_disk
modifier|*
name|disk
parameter_list|)
block|{
name|struct
name|g_raid_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|g_raid_md_object
modifier|*
name|md
decl_stmt|;
name|struct
name|g_raid_md_sii_object
modifier|*
name|mdi
decl_stmt|;
name|struct
name|sii_raid_conf
modifier|*
name|pdmeta
decl_stmt|;
name|struct
name|g_raid_md_sii_perdisk
modifier|*
name|pd
decl_stmt|;
name|sc
operator|=
name|disk
operator|->
name|d_softc
expr_stmt|;
name|md
operator|=
name|sc
operator|->
name|sc_md
expr_stmt|;
name|mdi
operator|=
operator|(
expr|struct
name|g_raid_md_sii_object
operator|*
operator|)
name|md
expr_stmt|;
name|pd
operator|=
operator|(
expr|struct
name|g_raid_md_sii_perdisk
operator|*
operator|)
name|disk
operator|->
name|d_md_data
expr_stmt|;
name|pdmeta
operator|=
name|pd
operator|->
name|pd_meta
expr_stmt|;
if|if
condition|(
name|mdi
operator|->
name|mdio_started
condition|)
block|{
if|if
condition|(
name|g_raid_md_sii_start_disk
argument_list|(
name|disk
argument_list|)
condition|)
name|g_raid_md_write_sii
argument_list|(
name|md
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|mdi
operator|->
name|mdio_meta
operator|==
name|NULL
operator|||
operator|(
call|(
name|int32_t
call|)
argument_list|(
name|pdmeta
operator|->
name|generation
operator|-
name|mdi
operator|->
name|mdio_generation
argument_list|)
operator|)
operator|>
literal|0
condition|)
block|{
name|G_RAID_DEBUG1
argument_list|(
literal|1
argument_list|,
name|sc
argument_list|,
literal|"Newer disk"
argument_list|)
expr_stmt|;
if|if
condition|(
name|mdi
operator|->
name|mdio_meta
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|mdi
operator|->
name|mdio_meta
argument_list|,
name|M_MD_SII
argument_list|)
expr_stmt|;
name|mdi
operator|->
name|mdio_meta
operator|=
name|sii_meta_copy
argument_list|(
name|pdmeta
argument_list|)
expr_stmt|;
name|mdi
operator|->
name|mdio_generation
operator|=
name|mdi
operator|->
name|mdio_meta
operator|->
name|generation
expr_stmt|;
name|mdi
operator|->
name|mdio_total_disks
operator|=
name|sii_meta_total_disks
argument_list|(
name|pdmeta
argument_list|)
expr_stmt|;
name|mdi
operator|->
name|mdio_disks_present
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pdmeta
operator|->
name|generation
operator|==
name|mdi
operator|->
name|mdio_generation
condition|)
block|{
name|mdi
operator|->
name|mdio_disks_present
operator|++
expr_stmt|;
name|G_RAID_DEBUG1
argument_list|(
literal|1
argument_list|,
name|sc
argument_list|,
literal|"Matching disk (%d of %d up)"
argument_list|,
name|mdi
operator|->
name|mdio_disks_present
argument_list|,
name|mdi
operator|->
name|mdio_total_disks
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|G_RAID_DEBUG1
argument_list|(
literal|1
argument_list|,
name|sc
argument_list|,
literal|"Older disk"
argument_list|)
expr_stmt|;
block|}
comment|/* If we collected all needed disks - start array. */
if|if
condition|(
name|mdi
operator|->
name|mdio_disks_present
operator|==
name|mdi
operator|->
name|mdio_total_disks
condition|)
name|g_raid_md_sii_start
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|g_raid_sii_go
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|g_raid_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|g_raid_md_object
modifier|*
name|md
decl_stmt|;
name|struct
name|g_raid_md_sii_object
modifier|*
name|mdi
decl_stmt|;
name|sc
operator|=
name|arg
expr_stmt|;
name|md
operator|=
name|sc
operator|->
name|sc_md
expr_stmt|;
name|mdi
operator|=
operator|(
expr|struct
name|g_raid_md_sii_object
operator|*
operator|)
name|md
expr_stmt|;
if|if
condition|(
operator|!
name|mdi
operator|->
name|mdio_started
condition|)
block|{
name|G_RAID_DEBUG1
argument_list|(
literal|0
argument_list|,
name|sc
argument_list|,
literal|"Force array start due to timeout."
argument_list|)
expr_stmt|;
name|g_raid_event_send
argument_list|(
name|sc
argument_list|,
name|G_RAID_NODE_E_START
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|g_raid_md_create_sii
parameter_list|(
name|struct
name|g_raid_md_object
modifier|*
name|md
parameter_list|,
name|struct
name|g_class
modifier|*
name|mp
parameter_list|,
name|struct
name|g_geom
modifier|*
modifier|*
name|gp
parameter_list|)
block|{
name|struct
name|g_raid_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|g_raid_md_sii_object
modifier|*
name|mdi
decl_stmt|;
name|char
name|name
index|[
literal|32
index|]
decl_stmt|;
name|mdi
operator|=
operator|(
expr|struct
name|g_raid_md_sii_object
operator|*
operator|)
name|md
expr_stmt|;
name|mdi
operator|->
name|mdio_timestamp
index|[
literal|5
index|]
operator|=
name|arc4random
argument_list|()
expr_stmt|;
name|mdi
operator|->
name|mdio_timestamp
index|[
literal|4
index|]
operator|=
name|arc4random
argument_list|()
expr_stmt|;
name|mdi
operator|->
name|mdio_timestamp
index|[
literal|3
index|]
operator|=
name|arc4random
argument_list|()
expr_stmt|;
name|mdi
operator|->
name|mdio_timestamp
index|[
literal|2
index|]
operator|=
name|arc4random
argument_list|()
expr_stmt|;
name|mdi
operator|->
name|mdio_timestamp
index|[
literal|1
index|]
operator|=
name|arc4random
argument_list|()
expr_stmt|;
name|mdi
operator|->
name|mdio_timestamp
index|[
literal|0
index|]
operator|=
name|arc4random
argument_list|()
expr_stmt|;
name|mdi
operator|->
name|mdio_location
operator|=
name|arc4random
argument_list|()
expr_stmt|;
name|mdi
operator|->
name|mdio_generation
operator|=
literal|0
expr_stmt|;
name|snprintf
argument_list|(
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|name
argument_list|)
argument_list|,
literal|"SiI-%02x%02x%02x%02x%02x%02x"
argument_list|,
name|mdi
operator|->
name|mdio_timestamp
index|[
literal|5
index|]
argument_list|,
name|mdi
operator|->
name|mdio_timestamp
index|[
literal|4
index|]
argument_list|,
name|mdi
operator|->
name|mdio_timestamp
index|[
literal|3
index|]
argument_list|,
name|mdi
operator|->
name|mdio_timestamp
index|[
literal|2
index|]
argument_list|,
name|mdi
operator|->
name|mdio_timestamp
index|[
literal|1
index|]
argument_list|,
name|mdi
operator|->
name|mdio_timestamp
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|sc
operator|=
name|g_raid_create_node
argument_list|(
name|mp
argument_list|,
name|name
argument_list|,
name|md
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|==
name|NULL
condition|)
return|return
operator|(
name|G_RAID_MD_TASTE_FAIL
operator|)
return|;
name|md
operator|->
name|mdo_softc
operator|=
name|sc
expr_stmt|;
operator|*
name|gp
operator|=
name|sc
operator|->
name|sc_geom
expr_stmt|;
return|return
operator|(
name|G_RAID_MD_TASTE_NEW
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|g_raid_md_taste_sii
parameter_list|(
name|struct
name|g_raid_md_object
modifier|*
name|md
parameter_list|,
name|struct
name|g_class
modifier|*
name|mp
parameter_list|,
name|struct
name|g_consumer
modifier|*
name|cp
parameter_list|,
name|struct
name|g_geom
modifier|*
modifier|*
name|gp
parameter_list|)
block|{
name|struct
name|g_consumer
modifier|*
name|rcp
decl_stmt|;
name|struct
name|g_provider
modifier|*
name|pp
decl_stmt|;
name|struct
name|g_raid_md_sii_object
modifier|*
name|mdi
decl_stmt|,
modifier|*
name|mdi1
decl_stmt|;
name|struct
name|g_raid_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|g_raid_disk
modifier|*
name|disk
decl_stmt|;
name|struct
name|sii_raid_conf
modifier|*
name|meta
decl_stmt|;
name|struct
name|g_raid_md_sii_perdisk
modifier|*
name|pd
decl_stmt|;
name|struct
name|g_geom
modifier|*
name|geom
decl_stmt|;
name|int
name|error
decl_stmt|,
name|disk_pos
decl_stmt|,
name|result
decl_stmt|,
name|spare
decl_stmt|,
name|len
decl_stmt|;
name|char
name|name
index|[
literal|32
index|]
decl_stmt|;
name|uint16_t
name|vendor
decl_stmt|;
name|G_RAID_DEBUG
argument_list|(
literal|1
argument_list|,
literal|"Tasting SiI on %s"
argument_list|,
name|cp
operator|->
name|provider
operator|->
name|name
argument_list|)
expr_stmt|;
name|mdi
operator|=
operator|(
expr|struct
name|g_raid_md_sii_object
operator|*
operator|)
name|md
expr_stmt|;
name|pp
operator|=
name|cp
operator|->
name|provider
expr_stmt|;
comment|/* Read metadata from device. */
name|meta
operator|=
name|NULL
expr_stmt|;
name|spare
operator|=
literal|0
expr_stmt|;
name|vendor
operator|=
literal|0xffff
expr_stmt|;
name|disk_pos
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|g_access
argument_list|(
name|cp
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|G_RAID_MD_TASTE_FAIL
operator|)
return|;
name|g_topology_unlock
argument_list|()
expr_stmt|;
name|len
operator|=
literal|2
expr_stmt|;
if|if
condition|(
name|pp
operator|->
name|geom
operator|->
name|rank
operator|==
literal|1
condition|)
name|g_io_getattr
argument_list|(
literal|"GEOM::hba_vendor"
argument_list|,
name|cp
argument_list|,
operator|&
name|len
argument_list|,
operator|&
name|vendor
argument_list|)
expr_stmt|;
name|meta
operator|=
name|sii_meta_read
argument_list|(
name|cp
argument_list|)
expr_stmt|;
name|g_topology_lock
argument_list|()
expr_stmt|;
name|g_access
argument_list|(
name|cp
argument_list|,
operator|-
literal|1
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|meta
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|g_raid_aggressive_spare
condition|)
block|{
if|if
condition|(
name|vendor
operator|==
literal|0x1095
condition|)
block|{
name|G_RAID_DEBUG
argument_list|(
literal|1
argument_list|,
literal|"No SiI metadata, forcing spare."
argument_list|)
expr_stmt|;
name|spare
operator|=
literal|2
expr_stmt|;
goto|goto
name|search
goto|;
block|}
else|else
block|{
name|G_RAID_DEBUG
argument_list|(
literal|1
argument_list|,
literal|"SiI vendor mismatch 0x%04x != 0x1095"
argument_list|,
name|vendor
argument_list|)
expr_stmt|;
block|}
block|}
return|return
operator|(
name|G_RAID_MD_TASTE_FAIL
operator|)
return|;
block|}
comment|/* Check this disk position in obtained metadata. */
name|disk_pos
operator|=
name|sii_meta_disk_pos
argument_list|(
name|meta
argument_list|,
name|meta
argument_list|)
expr_stmt|;
if|if
condition|(
name|disk_pos
operator|==
operator|-
literal|1
condition|)
block|{
name|G_RAID_DEBUG
argument_list|(
literal|1
argument_list|,
literal|"SiI disk position not found"
argument_list|)
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
comment|/* Metadata valid. Print it. */
name|g_raid_md_sii_print
argument_list|(
name|meta
argument_list|)
expr_stmt|;
name|G_RAID_DEBUG
argument_list|(
literal|1
argument_list|,
literal|"SiI disk position %d"
argument_list|,
name|disk_pos
argument_list|)
expr_stmt|;
name|spare
operator|=
operator|(
name|meta
operator|->
name|type
operator|==
name|SII_T_SPARE
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|search
label|:
comment|/* Search for matching node. */
name|sc
operator|=
name|NULL
expr_stmt|;
name|mdi1
operator|=
name|NULL
expr_stmt|;
name|LIST_FOREACH
argument_list|(
argument|geom
argument_list|,
argument|&mp->geom
argument_list|,
argument|geom
argument_list|)
block|{
name|sc
operator|=
name|geom
operator|->
name|softc
expr_stmt|;
if|if
condition|(
name|sc
operator|==
name|NULL
condition|)
continue|continue;
if|if
condition|(
name|sc
operator|->
name|sc_stopping
operator|!=
literal|0
condition|)
continue|continue;
if|if
condition|(
name|sc
operator|->
name|sc_md
operator|->
name|mdo_class
operator|!=
name|md
operator|->
name|mdo_class
condition|)
continue|continue;
name|mdi1
operator|=
operator|(
expr|struct
name|g_raid_md_sii_object
operator|*
operator|)
name|sc
operator|->
name|sc_md
expr_stmt|;
if|if
condition|(
name|spare
condition|)
block|{
if|if
condition|(
name|mdi1
operator|->
name|mdio_incomplete
condition|)
break|break;
block|}
else|else
block|{
if|if
condition|(
name|mdi1
operator|->
name|mdio_location
operator|==
name|meta
operator|->
name|raid_location
operator|&&
name|memcmp
argument_list|(
operator|&
name|mdi1
operator|->
name|mdio_timestamp
argument_list|,
operator|&
name|meta
operator|->
name|timestamp
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
block|}
comment|/* Found matching node. */
if|if
condition|(
name|geom
operator|!=
name|NULL
condition|)
block|{
name|G_RAID_DEBUG
argument_list|(
literal|1
argument_list|,
literal|"Found matching array %s"
argument_list|,
name|sc
operator|->
name|sc_name
argument_list|)
expr_stmt|;
name|result
operator|=
name|G_RAID_MD_TASTE_EXISTING
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|spare
condition|)
block|{
comment|/* Not found needy node -- left for later. */
name|G_RAID_DEBUG
argument_list|(
literal|1
argument_list|,
literal|"Spare is not needed at this time"
argument_list|)
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
else|else
block|{
comment|/* Not found matching node -- create one. */
name|result
operator|=
name|G_RAID_MD_TASTE_NEW
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|mdi
operator|->
name|mdio_timestamp
argument_list|,
operator|&
name|meta
operator|->
name|timestamp
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|mdi
operator|->
name|mdio_location
operator|=
name|meta
operator|->
name|raid_location
expr_stmt|;
name|snprintf
argument_list|(
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|name
argument_list|)
argument_list|,
literal|"SiI-%02x%02x%02x%02x%02x%02x"
argument_list|,
name|mdi
operator|->
name|mdio_timestamp
index|[
literal|5
index|]
argument_list|,
name|mdi
operator|->
name|mdio_timestamp
index|[
literal|4
index|]
argument_list|,
name|mdi
operator|->
name|mdio_timestamp
index|[
literal|3
index|]
argument_list|,
name|mdi
operator|->
name|mdio_timestamp
index|[
literal|2
index|]
argument_list|,
name|mdi
operator|->
name|mdio_timestamp
index|[
literal|1
index|]
argument_list|,
name|mdi
operator|->
name|mdio_timestamp
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|sc
operator|=
name|g_raid_create_node
argument_list|(
name|mp
argument_list|,
name|name
argument_list|,
name|md
argument_list|)
expr_stmt|;
name|md
operator|->
name|mdo_softc
operator|=
name|sc
expr_stmt|;
name|geom
operator|=
name|sc
operator|->
name|sc_geom
expr_stmt|;
name|callout_init
argument_list|(
operator|&
name|mdi
operator|->
name|mdio_start_co
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|callout_reset
argument_list|(
operator|&
name|mdi
operator|->
name|mdio_start_co
argument_list|,
name|g_raid_start_timeout
operator|*
name|hz
argument_list|,
name|g_raid_sii_go
argument_list|,
name|sc
argument_list|)
expr_stmt|;
name|mdi
operator|->
name|mdio_rootmount
operator|=
name|root_mount_hold
argument_list|(
literal|"GRAID-SiI"
argument_list|)
expr_stmt|;
name|G_RAID_DEBUG1
argument_list|(
literal|1
argument_list|,
name|sc
argument_list|,
literal|"root_mount_hold %p"
argument_list|,
name|mdi
operator|->
name|mdio_rootmount
argument_list|)
expr_stmt|;
block|}
name|rcp
operator|=
name|g_new_consumer
argument_list|(
name|geom
argument_list|)
expr_stmt|;
name|g_attach
argument_list|(
name|rcp
argument_list|,
name|pp
argument_list|)
expr_stmt|;
if|if
condition|(
name|g_access
argument_list|(
name|rcp
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|!=
literal|0
condition|)
empty_stmt|;
comment|//goto fail1;
name|g_topology_unlock
argument_list|()
expr_stmt|;
name|sx_xlock
argument_list|(
operator|&
name|sc
operator|->
name|sc_lock
argument_list|)
expr_stmt|;
name|pd
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|pd
argument_list|)
argument_list|,
name|M_MD_SII
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|pd
operator|->
name|pd_meta
operator|=
name|meta
expr_stmt|;
if|if
condition|(
name|spare
operator|==
literal|2
condition|)
block|{
name|pd
operator|->
name|pd_disk_pos
operator|=
operator|-
literal|3
expr_stmt|;
block|}
else|else
block|{
name|pd
operator|->
name|pd_disk_pos
operator|=
operator|-
literal|1
expr_stmt|;
block|}
name|pd
operator|->
name|pd_disk_size
operator|=
name|pp
operator|->
name|mediasize
expr_stmt|;
name|disk
operator|=
name|g_raid_create_disk
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|disk
operator|->
name|d_md_data
operator|=
operator|(
name|void
operator|*
operator|)
name|pd
expr_stmt|;
name|disk
operator|->
name|d_consumer
operator|=
name|rcp
expr_stmt|;
name|rcp
operator|->
name|private
operator|=
name|disk
expr_stmt|;
comment|/* Read kernel dumping information. */
name|disk
operator|->
name|d_kd
operator|.
name|offset
operator|=
literal|0
expr_stmt|;
name|disk
operator|->
name|d_kd
operator|.
name|length
operator|=
name|OFF_MAX
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
name|disk
operator|->
name|d_kd
argument_list|)
expr_stmt|;
name|error
operator|=
name|g_io_getattr
argument_list|(
literal|"GEOM::kerneldump"
argument_list|,
name|rcp
argument_list|,
operator|&
name|len
argument_list|,
operator|&
name|disk
operator|->
name|d_kd
argument_list|)
expr_stmt|;
if|if
condition|(
name|disk
operator|->
name|d_kd
operator|.
name|di
operator|.
name|dumper
operator|==
name|NULL
condition|)
name|G_RAID_DEBUG1
argument_list|(
literal|2
argument_list|,
name|sc
argument_list|,
literal|"Dumping not supported by %s: %d."
argument_list|,
name|rcp
operator|->
name|provider
operator|->
name|name
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|g_raid_md_sii_new_disk
argument_list|(
name|disk
argument_list|)
expr_stmt|;
name|sx_xunlock
argument_list|(
operator|&
name|sc
operator|->
name|sc_lock
argument_list|)
expr_stmt|;
name|g_topology_lock
argument_list|()
expr_stmt|;
operator|*
name|gp
operator|=
name|geom
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
name|fail1
label|:
name|free
argument_list|(
name|meta
argument_list|,
name|M_MD_SII
argument_list|)
expr_stmt|;
return|return
operator|(
name|G_RAID_MD_TASTE_FAIL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|g_raid_md_event_sii
parameter_list|(
name|struct
name|g_raid_md_object
modifier|*
name|md
parameter_list|,
name|struct
name|g_raid_disk
modifier|*
name|disk
parameter_list|,
name|u_int
name|event
parameter_list|)
block|{
name|struct
name|g_raid_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|g_raid_subdisk
modifier|*
name|sd
decl_stmt|;
name|struct
name|g_raid_md_sii_object
modifier|*
name|mdi
decl_stmt|;
name|struct
name|g_raid_md_sii_perdisk
modifier|*
name|pd
decl_stmt|;
name|sc
operator|=
name|md
operator|->
name|mdo_softc
expr_stmt|;
name|mdi
operator|=
operator|(
expr|struct
name|g_raid_md_sii_object
operator|*
operator|)
name|md
expr_stmt|;
if|if
condition|(
name|disk
operator|==
name|NULL
condition|)
block|{
switch|switch
condition|(
name|event
condition|)
block|{
case|case
name|G_RAID_NODE_E_START
case|:
if|if
condition|(
operator|!
name|mdi
operator|->
name|mdio_started
condition|)
name|g_raid_md_sii_start
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|pd
operator|=
operator|(
expr|struct
name|g_raid_md_sii_perdisk
operator|*
operator|)
name|disk
operator|->
name|d_md_data
expr_stmt|;
switch|switch
condition|(
name|event
condition|)
block|{
case|case
name|G_RAID_DISK_E_DISCONNECTED
case|:
comment|/* If disk was assigned, just update statuses. */
if|if
condition|(
name|pd
operator|->
name|pd_disk_pos
operator|>=
literal|0
condition|)
block|{
name|g_raid_change_disk_state
argument_list|(
name|disk
argument_list|,
name|G_RAID_DISK_S_OFFLINE
argument_list|)
expr_stmt|;
if|if
condition|(
name|disk
operator|->
name|d_consumer
condition|)
block|{
name|g_raid_kill_consumer
argument_list|(
name|sc
argument_list|,
name|disk
operator|->
name|d_consumer
argument_list|)
expr_stmt|;
name|disk
operator|->
name|d_consumer
operator|=
name|NULL
expr_stmt|;
block|}
name|TAILQ_FOREACH
argument_list|(
argument|sd
argument_list|,
argument|&disk->d_subdisks
argument_list|,
argument|sd_next
argument_list|)
block|{
name|g_raid_change_subdisk_state
argument_list|(
name|sd
argument_list|,
name|G_RAID_SUBDISK_S_NONE
argument_list|)
expr_stmt|;
name|g_raid_event_send
argument_list|(
name|sd
argument_list|,
name|G_RAID_SUBDISK_E_DISCONNECTED
argument_list|,
name|G_RAID_EVENT_SUBDISK
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* Otherwise -- delete. */
name|g_raid_change_disk_state
argument_list|(
name|disk
argument_list|,
name|G_RAID_DISK_S_NONE
argument_list|)
expr_stmt|;
name|g_raid_destroy_disk
argument_list|(
name|disk
argument_list|)
expr_stmt|;
block|}
comment|/* Write updated metadata to all disks. */
name|g_raid_md_write_sii
argument_list|(
name|md
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* Check if anything left except placeholders. */
if|if
condition|(
name|g_raid_ndisks
argument_list|(
name|sc
argument_list|,
operator|-
literal|1
argument_list|)
operator|==
name|g_raid_ndisks
argument_list|(
name|sc
argument_list|,
name|G_RAID_DISK_S_OFFLINE
argument_list|)
condition|)
name|g_raid_destroy_node
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
name|g_raid_md_sii_refill
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
return|return
operator|(
operator|-
literal|2
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|g_raid_md_ctl_sii
parameter_list|(
name|struct
name|g_raid_md_object
modifier|*
name|md
parameter_list|,
name|struct
name|gctl_req
modifier|*
name|req
parameter_list|)
block|{
name|struct
name|g_raid_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|g_raid_volume
modifier|*
name|vol
decl_stmt|;
name|struct
name|g_raid_subdisk
modifier|*
name|sd
decl_stmt|;
name|struct
name|g_raid_disk
modifier|*
name|disk
decl_stmt|;
name|struct
name|g_raid_md_sii_object
modifier|*
name|mdi
decl_stmt|;
name|struct
name|g_raid_md_sii_perdisk
modifier|*
name|pd
decl_stmt|;
name|struct
name|g_consumer
modifier|*
name|cp
decl_stmt|;
name|struct
name|g_provider
modifier|*
name|pp
decl_stmt|;
name|char
name|arg
index|[
literal|16
index|]
decl_stmt|;
specifier|const
name|char
modifier|*
name|verb
decl_stmt|,
modifier|*
name|volname
decl_stmt|,
modifier|*
name|levelname
decl_stmt|,
modifier|*
name|diskname
decl_stmt|;
name|int
modifier|*
name|nargs
decl_stmt|,
modifier|*
name|force
decl_stmt|;
name|off_t
name|size
decl_stmt|,
name|sectorsize
decl_stmt|,
name|strip
decl_stmt|;
name|intmax_t
modifier|*
name|sizearg
decl_stmt|,
modifier|*
name|striparg
decl_stmt|;
name|int
name|numdisks
decl_stmt|,
name|i
decl_stmt|,
name|len
decl_stmt|,
name|level
decl_stmt|,
name|qual
decl_stmt|,
name|update
decl_stmt|;
name|int
name|error
decl_stmt|;
name|sc
operator|=
name|md
operator|->
name|mdo_softc
expr_stmt|;
name|mdi
operator|=
operator|(
expr|struct
name|g_raid_md_sii_object
operator|*
operator|)
name|md
expr_stmt|;
name|verb
operator|=
name|gctl_get_param
argument_list|(
name|req
argument_list|,
literal|"verb"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|nargs
operator|=
name|gctl_get_paraml
argument_list|(
name|req
argument_list|,
literal|"nargs"
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|nargs
argument_list|)
argument_list|)
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|verb
argument_list|,
literal|"label"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|*
name|nargs
operator|<
literal|4
condition|)
block|{
name|gctl_error
argument_list|(
name|req
argument_list|,
literal|"Invalid number of arguments."
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|volname
operator|=
name|gctl_get_asciiparam
argument_list|(
name|req
argument_list|,
literal|"arg1"
argument_list|)
expr_stmt|;
if|if
condition|(
name|volname
operator|==
name|NULL
condition|)
block|{
name|gctl_error
argument_list|(
name|req
argument_list|,
literal|"No volume name."
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|2
operator|)
return|;
block|}
name|levelname
operator|=
name|gctl_get_asciiparam
argument_list|(
name|req
argument_list|,
literal|"arg2"
argument_list|)
expr_stmt|;
if|if
condition|(
name|levelname
operator|==
name|NULL
condition|)
block|{
name|gctl_error
argument_list|(
name|req
argument_list|,
literal|"No RAID level."
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|3
operator|)
return|;
block|}
if|if
condition|(
name|g_raid_volume_str2level
argument_list|(
name|levelname
argument_list|,
operator|&
name|level
argument_list|,
operator|&
name|qual
argument_list|)
condition|)
block|{
name|gctl_error
argument_list|(
name|req
argument_list|,
literal|"Unknown RAID level '%s'."
argument_list|,
name|levelname
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|4
operator|)
return|;
block|}
name|numdisks
operator|=
operator|*
name|nargs
operator|-
literal|3
expr_stmt|;
name|force
operator|=
name|gctl_get_paraml
argument_list|(
name|req
argument_list|,
literal|"force"
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|force
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|g_raid_md_sii_supported
argument_list|(
name|level
argument_list|,
name|qual
argument_list|,
name|numdisks
argument_list|,
name|force
condition|?
operator|*
name|force
else|:
literal|0
argument_list|)
condition|)
block|{
name|gctl_error
argument_list|(
name|req
argument_list|,
literal|"Unsupported RAID level "
literal|"(0x%02x/0x%02x), or number of disks (%d)."
argument_list|,
name|level
argument_list|,
name|qual
argument_list|,
name|numdisks
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|5
operator|)
return|;
block|}
comment|/* Search for disks, connect them and probe. */
name|size
operator|=
literal|0x7fffffffffffffffllu
expr_stmt|;
name|sectorsize
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|numdisks
condition|;
name|i
operator|++
control|)
block|{
name|snprintf
argument_list|(
name|arg
argument_list|,
sizeof|sizeof
argument_list|(
name|arg
argument_list|)
argument_list|,
literal|"arg%d"
argument_list|,
name|i
operator|+
literal|3
argument_list|)
expr_stmt|;
name|diskname
operator|=
name|gctl_get_asciiparam
argument_list|(
name|req
argument_list|,
name|arg
argument_list|)
expr_stmt|;
if|if
condition|(
name|diskname
operator|==
name|NULL
condition|)
block|{
name|gctl_error
argument_list|(
name|req
argument_list|,
literal|"No disk name (%s)."
argument_list|,
name|arg
argument_list|)
expr_stmt|;
name|error
operator|=
operator|-
literal|6
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|diskname
argument_list|,
literal|"NONE"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|cp
operator|=
name|NULL
expr_stmt|;
name|pp
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|g_topology_lock
argument_list|()
expr_stmt|;
name|cp
operator|=
name|g_raid_open_consumer
argument_list|(
name|sc
argument_list|,
name|diskname
argument_list|)
expr_stmt|;
if|if
condition|(
name|cp
operator|==
name|NULL
condition|)
block|{
name|gctl_error
argument_list|(
name|req
argument_list|,
literal|"Can't open '%s'."
argument_list|,
name|diskname
argument_list|)
expr_stmt|;
name|g_topology_unlock
argument_list|()
expr_stmt|;
name|error
operator|=
operator|-
literal|7
expr_stmt|;
break|break;
block|}
name|pp
operator|=
name|cp
operator|->
name|provider
expr_stmt|;
block|}
name|pd
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|pd
argument_list|)
argument_list|,
name|M_MD_SII
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|pd
operator|->
name|pd_disk_pos
operator|=
name|i
expr_stmt|;
name|disk
operator|=
name|g_raid_create_disk
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|disk
operator|->
name|d_md_data
operator|=
operator|(
name|void
operator|*
operator|)
name|pd
expr_stmt|;
name|disk
operator|->
name|d_consumer
operator|=
name|cp
expr_stmt|;
if|if
condition|(
name|cp
operator|==
name|NULL
condition|)
continue|continue;
name|cp
operator|->
name|private
operator|=
name|disk
expr_stmt|;
name|g_topology_unlock
argument_list|()
expr_stmt|;
comment|/* Read kernel dumping information. */
name|disk
operator|->
name|d_kd
operator|.
name|offset
operator|=
literal|0
expr_stmt|;
name|disk
operator|->
name|d_kd
operator|.
name|length
operator|=
name|OFF_MAX
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
name|disk
operator|->
name|d_kd
argument_list|)
expr_stmt|;
name|g_io_getattr
argument_list|(
literal|"GEOM::kerneldump"
argument_list|,
name|cp
argument_list|,
operator|&
name|len
argument_list|,
operator|&
name|disk
operator|->
name|d_kd
argument_list|)
expr_stmt|;
if|if
condition|(
name|disk
operator|->
name|d_kd
operator|.
name|di
operator|.
name|dumper
operator|==
name|NULL
condition|)
name|G_RAID_DEBUG1
argument_list|(
literal|2
argument_list|,
name|sc
argument_list|,
literal|"Dumping not supported by %s."
argument_list|,
name|cp
operator|->
name|provider
operator|->
name|name
argument_list|)
expr_stmt|;
name|pd
operator|->
name|pd_disk_size
operator|=
name|pp
operator|->
name|mediasize
expr_stmt|;
if|if
condition|(
name|size
operator|>
name|pp
operator|->
name|mediasize
condition|)
name|size
operator|=
name|pp
operator|->
name|mediasize
expr_stmt|;
if|if
condition|(
name|sectorsize
operator|<
name|pp
operator|->
name|sectorsize
condition|)
name|sectorsize
operator|=
name|pp
operator|->
name|sectorsize
expr_stmt|;
block|}
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
comment|/* Reserve space for metadata. */
name|size
operator|-=
literal|0x800
operator|*
name|sectorsize
expr_stmt|;
comment|/* Handle size argument. */
name|len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|sizearg
argument_list|)
expr_stmt|;
name|sizearg
operator|=
name|gctl_get_param
argument_list|(
name|req
argument_list|,
literal|"size"
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|sizearg
operator|!=
name|NULL
operator|&&
name|len
operator|==
sizeof|sizeof
argument_list|(
operator|*
name|sizearg
argument_list|)
operator|&&
operator|*
name|sizearg
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|*
name|sizearg
operator|>
name|size
condition|)
block|{
name|gctl_error
argument_list|(
name|req
argument_list|,
literal|"Size too big %lld> %lld."
argument_list|,
operator|(
name|long
name|long
operator|)
operator|*
name|sizearg
argument_list|,
operator|(
name|long
name|long
operator|)
name|size
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|9
operator|)
return|;
block|}
name|size
operator|=
operator|*
name|sizearg
expr_stmt|;
block|}
comment|/* Handle strip argument. */
name|strip
operator|=
literal|131072
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|striparg
argument_list|)
expr_stmt|;
name|striparg
operator|=
name|gctl_get_param
argument_list|(
name|req
argument_list|,
literal|"strip"
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|striparg
operator|!=
name|NULL
operator|&&
name|len
operator|==
sizeof|sizeof
argument_list|(
operator|*
name|striparg
argument_list|)
operator|&&
operator|*
name|striparg
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|*
name|striparg
operator|<
name|sectorsize
condition|)
block|{
name|gctl_error
argument_list|(
name|req
argument_list|,
literal|"Strip size too small."
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|10
operator|)
return|;
block|}
if|if
condition|(
operator|*
name|striparg
operator|%
name|sectorsize
operator|!=
literal|0
condition|)
block|{
name|gctl_error
argument_list|(
name|req
argument_list|,
literal|"Incorrect strip size."
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|11
operator|)
return|;
block|}
if|if
condition|(
name|strip
operator|>
literal|65535
operator|*
name|sectorsize
condition|)
block|{
name|gctl_error
argument_list|(
name|req
argument_list|,
literal|"Strip size too big."
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|12
operator|)
return|;
block|}
name|strip
operator|=
operator|*
name|striparg
expr_stmt|;
block|}
comment|/* Round size down to strip or sector. */
if|if
condition|(
name|level
operator|==
name|G_RAID_VOLUME_RL_RAID1
condition|)
name|size
operator|-=
operator|(
name|size
operator|%
name|sectorsize
operator|)
expr_stmt|;
elseif|else
if|if
condition|(
name|level
operator|==
name|G_RAID_VOLUME_RL_RAID1E
operator|&&
operator|(
name|numdisks
operator|&
literal|1
operator|)
operator|!=
literal|0
condition|)
name|size
operator|-=
operator|(
name|size
operator|%
operator|(
literal|2
operator|*
name|strip
operator|)
operator|)
expr_stmt|;
else|else
name|size
operator|-=
operator|(
name|size
operator|%
name|strip
operator|)
expr_stmt|;
if|if
condition|(
name|size
operator|<=
literal|0
condition|)
block|{
name|gctl_error
argument_list|(
name|req
argument_list|,
literal|"Size too small."
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|13
operator|)
return|;
block|}
if|if
condition|(
name|size
operator|>
literal|0xffffffffffffllu
operator|*
name|sectorsize
condition|)
block|{
name|gctl_error
argument_list|(
name|req
argument_list|,
literal|"Size too big."
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|14
operator|)
return|;
block|}
comment|/* We have all we need, create things: volume, ... */
name|mdi
operator|->
name|mdio_total_disks
operator|=
name|numdisks
expr_stmt|;
name|mdi
operator|->
name|mdio_started
operator|=
literal|1
expr_stmt|;
name|vol
operator|=
name|g_raid_create_volume
argument_list|(
name|sc
argument_list|,
name|volname
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|vol
operator|->
name|v_md_data
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
name|intptr_t
operator|)
literal|0
expr_stmt|;
name|vol
operator|->
name|v_raid_level
operator|=
name|level
expr_stmt|;
name|vol
operator|->
name|v_raid_level_qualifier
operator|=
name|G_RAID_VOLUME_RLQ_NONE
expr_stmt|;
name|vol
operator|->
name|v_strip_size
operator|=
name|strip
expr_stmt|;
name|vol
operator|->
name|v_disks_count
operator|=
name|numdisks
expr_stmt|;
if|if
condition|(
name|level
operator|==
name|G_RAID_VOLUME_RL_RAID0
operator|||
name|level
operator|==
name|G_RAID_VOLUME_RL_CONCAT
operator|||
name|level
operator|==
name|G_RAID_VOLUME_RL_SINGLE
condition|)
name|vol
operator|->
name|v_mediasize
operator|=
name|size
operator|*
name|numdisks
expr_stmt|;
elseif|else
if|if
condition|(
name|level
operator|==
name|G_RAID_VOLUME_RL_RAID1
condition|)
name|vol
operator|->
name|v_mediasize
operator|=
name|size
expr_stmt|;
elseif|else
if|if
condition|(
name|level
operator|==
name|G_RAID_VOLUME_RL_RAID5
condition|)
name|vol
operator|->
name|v_mediasize
operator|=
name|size
operator|*
operator|(
name|numdisks
operator|-
literal|1
operator|)
expr_stmt|;
else|else
block|{
comment|/* RAID1E */
name|vol
operator|->
name|v_mediasize
operator|=
operator|(
operator|(
name|size
operator|*
name|numdisks
operator|)
operator|/
name|strip
operator|/
literal|2
operator|)
operator|*
name|strip
expr_stmt|;
block|}
name|vol
operator|->
name|v_sectorsize
operator|=
name|sectorsize
expr_stmt|;
name|g_raid_start_volume
argument_list|(
name|vol
argument_list|)
expr_stmt|;
comment|/* , and subdisks. */
name|TAILQ_FOREACH
argument_list|(
argument|disk
argument_list|,
argument|&sc->sc_disks
argument_list|,
argument|d_next
argument_list|)
block|{
name|pd
operator|=
operator|(
expr|struct
name|g_raid_md_sii_perdisk
operator|*
operator|)
name|disk
operator|->
name|d_md_data
expr_stmt|;
name|sd
operator|=
operator|&
name|vol
operator|->
name|v_subdisks
index|[
name|pd
operator|->
name|pd_disk_pos
index|]
expr_stmt|;
name|sd
operator|->
name|sd_disk
operator|=
name|disk
expr_stmt|;
name|sd
operator|->
name|sd_offset
operator|=
literal|0
expr_stmt|;
name|sd
operator|->
name|sd_size
operator|=
name|size
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|disk
operator|->
name|d_subdisks
argument_list|,
name|sd
argument_list|,
name|sd_next
argument_list|)
expr_stmt|;
if|if
condition|(
name|sd
operator|->
name|sd_disk
operator|->
name|d_consumer
operator|!=
name|NULL
condition|)
block|{
name|g_raid_change_disk_state
argument_list|(
name|disk
argument_list|,
name|G_RAID_DISK_S_ACTIVE
argument_list|)
expr_stmt|;
name|g_raid_change_subdisk_state
argument_list|(
name|sd
argument_list|,
name|G_RAID_SUBDISK_S_ACTIVE
argument_list|)
expr_stmt|;
name|g_raid_event_send
argument_list|(
name|sd
argument_list|,
name|G_RAID_SUBDISK_E_NEW
argument_list|,
name|G_RAID_EVENT_SUBDISK
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|g_raid_change_disk_state
argument_list|(
name|disk
argument_list|,
name|G_RAID_DISK_S_OFFLINE
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Write metadata based on created entities. */
name|G_RAID_DEBUG1
argument_list|(
literal|0
argument_list|,
name|sc
argument_list|,
literal|"Array started."
argument_list|)
expr_stmt|;
name|g_raid_md_write_sii
argument_list|(
name|md
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* Pickup any STALE/SPARE disks to refill array if needed. */
name|g_raid_md_sii_refill
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|g_raid_event_send
argument_list|(
name|vol
argument_list|,
name|G_RAID_VOLUME_E_START
argument_list|,
name|G_RAID_EVENT_VOLUME
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|verb
argument_list|,
literal|"delete"
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* Check if some volume is still open. */
name|force
operator|=
name|gctl_get_paraml
argument_list|(
name|req
argument_list|,
literal|"force"
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|force
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|force
operator|!=
name|NULL
operator|&&
operator|*
name|force
operator|==
literal|0
operator|&&
name|g_raid_nopens
argument_list|(
name|sc
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|gctl_error
argument_list|(
name|req
argument_list|,
literal|"Some volume is still open."
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|4
operator|)
return|;
block|}
name|TAILQ_FOREACH
argument_list|(
argument|disk
argument_list|,
argument|&sc->sc_disks
argument_list|,
argument|d_next
argument_list|)
block|{
if|if
condition|(
name|disk
operator|->
name|d_consumer
condition|)
name|sii_meta_erase
argument_list|(
name|disk
operator|->
name|d_consumer
argument_list|)
expr_stmt|;
block|}
name|g_raid_destroy_node
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|verb
argument_list|,
literal|"remove"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|verb
argument_list|,
literal|"fail"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|*
name|nargs
operator|<
literal|2
condition|)
block|{
name|gctl_error
argument_list|(
name|req
argument_list|,
literal|"Invalid number of arguments."
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
operator|*
name|nargs
condition|;
name|i
operator|++
control|)
block|{
name|snprintf
argument_list|(
name|arg
argument_list|,
sizeof|sizeof
argument_list|(
name|arg
argument_list|)
argument_list|,
literal|"arg%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|diskname
operator|=
name|gctl_get_asciiparam
argument_list|(
name|req
argument_list|,
name|arg
argument_list|)
expr_stmt|;
if|if
condition|(
name|diskname
operator|==
name|NULL
condition|)
block|{
name|gctl_error
argument_list|(
name|req
argument_list|,
literal|"No disk name (%s)."
argument_list|,
name|arg
argument_list|)
expr_stmt|;
name|error
operator|=
operator|-
literal|2
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|strncmp
argument_list|(
name|diskname
argument_list|,
literal|"/dev/"
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
condition|)
name|diskname
operator|+=
literal|5
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|disk
argument_list|,
argument|&sc->sc_disks
argument_list|,
argument|d_next
argument_list|)
block|{
if|if
condition|(
name|disk
operator|->
name|d_consumer
operator|!=
name|NULL
operator|&&
name|disk
operator|->
name|d_consumer
operator|->
name|provider
operator|!=
name|NULL
operator|&&
name|strcmp
argument_list|(
name|disk
operator|->
name|d_consumer
operator|->
name|provider
operator|->
name|name
argument_list|,
name|diskname
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|disk
operator|==
name|NULL
condition|)
block|{
name|gctl_error
argument_list|(
name|req
argument_list|,
literal|"Disk '%s' not found."
argument_list|,
name|diskname
argument_list|)
expr_stmt|;
name|error
operator|=
operator|-
literal|3
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|verb
argument_list|,
literal|"fail"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|g_raid_md_fail_disk_sii
argument_list|(
name|md
argument_list|,
name|NULL
argument_list|,
name|disk
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|pd
operator|=
operator|(
expr|struct
name|g_raid_md_sii_perdisk
operator|*
operator|)
name|disk
operator|->
name|d_md_data
expr_stmt|;
comment|/* Erase metadata on deleting disk. */
name|sii_meta_erase
argument_list|(
name|disk
operator|->
name|d_consumer
argument_list|)
expr_stmt|;
comment|/* If disk was assigned, just update statuses. */
if|if
condition|(
name|pd
operator|->
name|pd_disk_pos
operator|>=
literal|0
condition|)
block|{
name|g_raid_change_disk_state
argument_list|(
name|disk
argument_list|,
name|G_RAID_DISK_S_OFFLINE
argument_list|)
expr_stmt|;
name|g_raid_kill_consumer
argument_list|(
name|sc
argument_list|,
name|disk
operator|->
name|d_consumer
argument_list|)
expr_stmt|;
name|disk
operator|->
name|d_consumer
operator|=
name|NULL
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|sd
argument_list|,
argument|&disk->d_subdisks
argument_list|,
argument|sd_next
argument_list|)
block|{
name|g_raid_change_subdisk_state
argument_list|(
name|sd
argument_list|,
name|G_RAID_SUBDISK_S_NONE
argument_list|)
expr_stmt|;
name|g_raid_event_send
argument_list|(
name|sd
argument_list|,
name|G_RAID_SUBDISK_E_DISCONNECTED
argument_list|,
name|G_RAID_EVENT_SUBDISK
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* Otherwise -- delete. */
name|g_raid_change_disk_state
argument_list|(
name|disk
argument_list|,
name|G_RAID_DISK_S_NONE
argument_list|)
expr_stmt|;
name|g_raid_destroy_disk
argument_list|(
name|disk
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Write updated metadata to remaining disks. */
name|g_raid_md_write_sii
argument_list|(
name|md
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* Check if anything left except placeholders. */
if|if
condition|(
name|g_raid_ndisks
argument_list|(
name|sc
argument_list|,
operator|-
literal|1
argument_list|)
operator|==
name|g_raid_ndisks
argument_list|(
name|sc
argument_list|,
name|G_RAID_DISK_S_OFFLINE
argument_list|)
condition|)
name|g_raid_destroy_node
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
name|g_raid_md_sii_refill
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|verb
argument_list|,
literal|"insert"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|*
name|nargs
operator|<
literal|2
condition|)
block|{
name|gctl_error
argument_list|(
name|req
argument_list|,
literal|"Invalid number of arguments."
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|update
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
operator|*
name|nargs
condition|;
name|i
operator|++
control|)
block|{
comment|/* Get disk name. */
name|snprintf
argument_list|(
name|arg
argument_list|,
sizeof|sizeof
argument_list|(
name|arg
argument_list|)
argument_list|,
literal|"arg%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|diskname
operator|=
name|gctl_get_asciiparam
argument_list|(
name|req
argument_list|,
name|arg
argument_list|)
expr_stmt|;
if|if
condition|(
name|diskname
operator|==
name|NULL
condition|)
block|{
name|gctl_error
argument_list|(
name|req
argument_list|,
literal|"No disk name (%s)."
argument_list|,
name|arg
argument_list|)
expr_stmt|;
name|error
operator|=
operator|-
literal|3
expr_stmt|;
break|break;
block|}
comment|/* Try to find provider with specified name. */
name|g_topology_lock
argument_list|()
expr_stmt|;
name|cp
operator|=
name|g_raid_open_consumer
argument_list|(
name|sc
argument_list|,
name|diskname
argument_list|)
expr_stmt|;
if|if
condition|(
name|cp
operator|==
name|NULL
condition|)
block|{
name|gctl_error
argument_list|(
name|req
argument_list|,
literal|"Can't open disk '%s'."
argument_list|,
name|diskname
argument_list|)
expr_stmt|;
name|g_topology_unlock
argument_list|()
expr_stmt|;
name|error
operator|=
operator|-
literal|4
expr_stmt|;
break|break;
block|}
name|pp
operator|=
name|cp
operator|->
name|provider
expr_stmt|;
name|pd
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|pd
argument_list|)
argument_list|,
name|M_MD_SII
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|pd
operator|->
name|pd_disk_pos
operator|=
operator|-
literal|3
expr_stmt|;
name|pd
operator|->
name|pd_disk_size
operator|=
name|pp
operator|->
name|mediasize
expr_stmt|;
name|disk
operator|=
name|g_raid_create_disk
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|disk
operator|->
name|d_consumer
operator|=
name|cp
expr_stmt|;
name|disk
operator|->
name|d_consumer
operator|->
name|private
operator|=
name|disk
expr_stmt|;
name|disk
operator|->
name|d_md_data
operator|=
operator|(
name|void
operator|*
operator|)
name|pd
expr_stmt|;
name|cp
operator|->
name|private
operator|=
name|disk
expr_stmt|;
name|g_topology_unlock
argument_list|()
expr_stmt|;
comment|/* Read kernel dumping information. */
name|disk
operator|->
name|d_kd
operator|.
name|offset
operator|=
literal|0
expr_stmt|;
name|disk
operator|->
name|d_kd
operator|.
name|length
operator|=
name|OFF_MAX
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
name|disk
operator|->
name|d_kd
argument_list|)
expr_stmt|;
name|g_io_getattr
argument_list|(
literal|"GEOM::kerneldump"
argument_list|,
name|cp
argument_list|,
operator|&
name|len
argument_list|,
operator|&
name|disk
operator|->
name|d_kd
argument_list|)
expr_stmt|;
if|if
condition|(
name|disk
operator|->
name|d_kd
operator|.
name|di
operator|.
name|dumper
operator|==
name|NULL
condition|)
name|G_RAID_DEBUG1
argument_list|(
literal|2
argument_list|,
name|sc
argument_list|,
literal|"Dumping not supported by %s."
argument_list|,
name|cp
operator|->
name|provider
operator|->
name|name
argument_list|)
expr_stmt|;
comment|/* Welcome the "new" disk. */
name|update
operator|+=
name|g_raid_md_sii_start_disk
argument_list|(
name|disk
argument_list|)
expr_stmt|;
if|if
condition|(
name|disk
operator|->
name|d_state
operator|==
name|G_RAID_DISK_S_SPARE
condition|)
block|{
name|sii_meta_write_spare
argument_list|(
name|cp
argument_list|)
expr_stmt|;
name|g_raid_destroy_disk
argument_list|(
name|disk
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|disk
operator|->
name|d_state
operator|!=
name|G_RAID_DISK_S_ACTIVE
condition|)
block|{
name|gctl_error
argument_list|(
name|req
argument_list|,
literal|"Disk '%s' doesn't fit."
argument_list|,
name|diskname
argument_list|)
expr_stmt|;
name|g_raid_destroy_disk
argument_list|(
name|disk
argument_list|)
expr_stmt|;
name|error
operator|=
operator|-
literal|8
expr_stmt|;
break|break;
block|}
block|}
comment|/* Write new metadata if we changed something. */
if|if
condition|(
name|update
condition|)
name|g_raid_md_write_sii
argument_list|(
name|md
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|gctl_error
argument_list|(
name|req
argument_list|,
literal|"Command '%s' is not supported."
argument_list|,
name|verb
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|100
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|g_raid_md_write_sii
parameter_list|(
name|struct
name|g_raid_md_object
modifier|*
name|md
parameter_list|,
name|struct
name|g_raid_volume
modifier|*
name|tvol
parameter_list|,
name|struct
name|g_raid_subdisk
modifier|*
name|tsd
parameter_list|,
name|struct
name|g_raid_disk
modifier|*
name|tdisk
parameter_list|)
block|{
name|struct
name|g_raid_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|g_raid_volume
modifier|*
name|vol
decl_stmt|;
name|struct
name|g_raid_subdisk
modifier|*
name|sd
decl_stmt|;
name|struct
name|g_raid_disk
modifier|*
name|disk
decl_stmt|;
name|struct
name|g_raid_md_sii_object
modifier|*
name|mdi
decl_stmt|;
name|struct
name|g_raid_md_sii_perdisk
modifier|*
name|pd
decl_stmt|;
name|struct
name|sii_raid_conf
modifier|*
name|meta
decl_stmt|;
name|int
name|i
decl_stmt|;
name|sc
operator|=
name|md
operator|->
name|mdo_softc
expr_stmt|;
name|mdi
operator|=
operator|(
expr|struct
name|g_raid_md_sii_object
operator|*
operator|)
name|md
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_stopping
operator|==
name|G_RAID_DESTROY_HARD
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* Bump generation. Newly written metadata may differ from previous. */
name|mdi
operator|->
name|mdio_generation
operator|++
expr_stmt|;
comment|/* There is only one volume. */
name|vol
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|sc
operator|->
name|sc_volumes
argument_list|)
expr_stmt|;
comment|/* Fill global fields. */
name|meta
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|meta
argument_list|)
argument_list|,
name|M_MD_SII
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|mdi
operator|->
name|mdio_meta
condition|)
name|memcpy
argument_list|(
name|meta
argument_list|,
name|mdi
operator|->
name|mdio_meta
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|meta
argument_list|)
argument_list|)
expr_stmt|;
name|meta
operator|->
name|total_sectors
operator|=
name|vol
operator|->
name|v_mediasize
operator|/
name|vol
operator|->
name|v_sectorsize
expr_stmt|;
name|meta
operator|->
name|vendor_id
operator|=
literal|0x1095
expr_stmt|;
name|meta
operator|->
name|version_minor
operator|=
literal|0
expr_stmt|;
name|meta
operator|->
name|version_major
operator|=
literal|2
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|meta
operator|->
name|timestamp
argument_list|,
operator|&
name|mdi
operator|->
name|mdio_timestamp
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|meta
operator|->
name|strip_sectors
operator|=
name|vol
operator|->
name|v_strip_size
operator|/
name|vol
operator|->
name|v_sectorsize
expr_stmt|;
if|if
condition|(
name|vol
operator|->
name|v_raid_level
operator|==
name|G_RAID_VOLUME_RL_RAID0
condition|)
block|{
name|meta
operator|->
name|type
operator|=
name|SII_T_RAID0
expr_stmt|;
name|meta
operator|->
name|raid0_disks
operator|=
name|vol
operator|->
name|v_disks_count
expr_stmt|;
name|meta
operator|->
name|raid1_disks
operator|=
literal|0xff
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|vol
operator|->
name|v_raid_level
operator|==
name|G_RAID_VOLUME_RL_RAID1
condition|)
block|{
name|meta
operator|->
name|type
operator|=
name|SII_T_RAID1
expr_stmt|;
name|meta
operator|->
name|raid0_disks
operator|=
literal|0xff
expr_stmt|;
name|meta
operator|->
name|raid1_disks
operator|=
name|vol
operator|->
name|v_disks_count
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|vol
operator|->
name|v_raid_level
operator|==
name|G_RAID_VOLUME_RL_RAID1E
condition|)
block|{
name|meta
operator|->
name|type
operator|=
name|SII_T_RAID01
expr_stmt|;
name|meta
operator|->
name|raid0_disks
operator|=
name|vol
operator|->
name|v_disks_count
operator|/
literal|2
expr_stmt|;
name|meta
operator|->
name|raid1_disks
operator|=
literal|2
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|vol
operator|->
name|v_raid_level
operator|==
name|G_RAID_VOLUME_RL_CONCAT
operator|||
name|vol
operator|->
name|v_raid_level
operator|==
name|G_RAID_VOLUME_RL_SINGLE
condition|)
block|{
name|meta
operator|->
name|type
operator|=
name|SII_T_JBOD
expr_stmt|;
name|meta
operator|->
name|raid0_disks
operator|=
name|vol
operator|->
name|v_disks_count
expr_stmt|;
name|meta
operator|->
name|raid1_disks
operator|=
literal|0xff
expr_stmt|;
block|}
else|else
block|{
name|meta
operator|->
name|type
operator|=
name|SII_T_RAID5
expr_stmt|;
name|meta
operator|->
name|raid0_disks
operator|=
name|vol
operator|->
name|v_disks_count
expr_stmt|;
name|meta
operator|->
name|raid1_disks
operator|=
literal|0xff
expr_stmt|;
block|}
name|meta
operator|->
name|generation
operator|=
name|mdi
operator|->
name|mdio_generation
expr_stmt|;
name|meta
operator|->
name|raid_status
operator|=
name|vol
operator|->
name|v_dirty
condition|?
name|SII_S_ONLINE
else|:
name|SII_S_AVAILABLE
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|vol
operator|->
name|v_disks_count
condition|;
name|i
operator|++
control|)
block|{
name|sd
operator|=
operator|&
name|vol
operator|->
name|v_subdisks
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|sd
operator|->
name|sd_state
operator|==
name|G_RAID_SUBDISK_S_STALE
operator|||
name|sd
operator|->
name|sd_state
operator|==
name|G_RAID_SUBDISK_S_RESYNC
condition|)
name|meta
operator|->
name|raid_status
operator|=
name|SII_S_ONLINE
expr_stmt|;
block|}
name|meta
operator|->
name|raid_location
operator|=
name|mdi
operator|->
name|mdio_location
expr_stmt|;
name|sii_meta_put_name
argument_list|(
name|meta
argument_list|,
name|vol
operator|->
name|v_name
argument_list|)
expr_stmt|;
comment|/* We are done. Print meta data and store them to disks. */
if|if
condition|(
name|mdi
operator|->
name|mdio_meta
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|mdi
operator|->
name|mdio_meta
argument_list|,
name|M_MD_SII
argument_list|)
expr_stmt|;
name|mdi
operator|->
name|mdio_meta
operator|=
name|meta
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|disk
argument_list|,
argument|&sc->sc_disks
argument_list|,
argument|d_next
argument_list|)
block|{
name|pd
operator|=
operator|(
expr|struct
name|g_raid_md_sii_perdisk
operator|*
operator|)
name|disk
operator|->
name|d_md_data
expr_stmt|;
if|if
condition|(
name|disk
operator|->
name|d_state
operator|!=
name|G_RAID_DISK_S_ACTIVE
condition|)
continue|continue;
if|if
condition|(
name|pd
operator|->
name|pd_meta
operator|!=
name|NULL
condition|)
block|{
name|free
argument_list|(
name|pd
operator|->
name|pd_meta
argument_list|,
name|M_MD_SII
argument_list|)
expr_stmt|;
name|pd
operator|->
name|pd_meta
operator|=
name|NULL
expr_stmt|;
block|}
name|pd
operator|->
name|pd_meta
operator|=
name|sii_meta_copy
argument_list|(
name|meta
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sd
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|disk
operator|->
name|d_subdisks
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|sd
operator|->
name|sd_state
operator|<
name|G_RAID_SUBDISK_S_NEW
condition|)
name|pd
operator|->
name|pd_meta
operator|->
name|disk_status
operator|=
name|SII_S_DROPPED
expr_stmt|;
elseif|else
if|if
condition|(
name|sd
operator|->
name|sd_state
operator|<
name|G_RAID_SUBDISK_S_STALE
condition|)
block|{
name|pd
operator|->
name|pd_meta
operator|->
name|disk_status
operator|=
name|SII_S_REBUILD
expr_stmt|;
name|pd
operator|->
name|pd_meta
operator|->
name|rebuild_lba
operator|=
name|sd
operator|->
name|sd_rebuild_pos
operator|/
name|vol
operator|->
name|v_sectorsize
expr_stmt|;
block|}
else|else
name|pd
operator|->
name|pd_meta
operator|->
name|disk_status
operator|=
name|SII_S_CURRENT
expr_stmt|;
if|if
condition|(
name|vol
operator|->
name|v_raid_level
operator|==
name|G_RAID_VOLUME_RL_RAID1
condition|)
block|{
name|pd
operator|->
name|pd_meta
operator|->
name|disk_number
operator|=
name|sd
operator|->
name|sd_pos
expr_stmt|;
name|pd
operator|->
name|pd_meta
operator|->
name|raid0_ident
operator|=
literal|0xff
expr_stmt|;
name|pd
operator|->
name|pd_meta
operator|->
name|raid1_ident
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|vol
operator|->
name|v_raid_level
operator|==
name|G_RAID_VOLUME_RL_RAID1E
condition|)
block|{
name|pd
operator|->
name|pd_meta
operator|->
name|disk_number
operator|=
name|sd
operator|->
name|sd_pos
operator|/
name|meta
operator|->
name|raid1_disks
expr_stmt|;
name|pd
operator|->
name|pd_meta
operator|->
name|raid0_ident
operator|=
name|sd
operator|->
name|sd_pos
operator|%
name|meta
operator|->
name|raid1_disks
expr_stmt|;
name|pd
operator|->
name|pd_meta
operator|->
name|raid1_ident
operator|=
name|sd
operator|->
name|sd_pos
operator|/
name|meta
operator|->
name|raid1_disks
expr_stmt|;
block|}
else|else
block|{
name|pd
operator|->
name|pd_meta
operator|->
name|disk_number
operator|=
name|sd
operator|->
name|sd_pos
expr_stmt|;
name|pd
operator|->
name|pd_meta
operator|->
name|raid0_ident
operator|=
literal|0
expr_stmt|;
name|pd
operator|->
name|pd_meta
operator|->
name|raid1_ident
operator|=
literal|0xff
expr_stmt|;
block|}
block|}
name|G_RAID_DEBUG
argument_list|(
literal|1
argument_list|,
literal|"Writing SiI metadata to %s"
argument_list|,
name|g_raid_get_diskname
argument_list|(
name|disk
argument_list|)
argument_list|)
expr_stmt|;
name|g_raid_md_sii_print
argument_list|(
name|pd
operator|->
name|pd_meta
argument_list|)
expr_stmt|;
name|sii_meta_write
argument_list|(
name|disk
operator|->
name|d_consumer
argument_list|,
name|pd
operator|->
name|pd_meta
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|g_raid_md_fail_disk_sii
parameter_list|(
name|struct
name|g_raid_md_object
modifier|*
name|md
parameter_list|,
name|struct
name|g_raid_subdisk
modifier|*
name|tsd
parameter_list|,
name|struct
name|g_raid_disk
modifier|*
name|tdisk
parameter_list|)
block|{
name|struct
name|g_raid_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|g_raid_md_sii_object
modifier|*
name|mdi
decl_stmt|;
name|struct
name|g_raid_md_sii_perdisk
modifier|*
name|pd
decl_stmt|;
name|struct
name|g_raid_subdisk
modifier|*
name|sd
decl_stmt|;
name|sc
operator|=
name|md
operator|->
name|mdo_softc
expr_stmt|;
name|mdi
operator|=
operator|(
expr|struct
name|g_raid_md_sii_object
operator|*
operator|)
name|md
expr_stmt|;
name|pd
operator|=
operator|(
expr|struct
name|g_raid_md_sii_perdisk
operator|*
operator|)
name|tdisk
operator|->
name|d_md_data
expr_stmt|;
comment|/* We can't fail disk that is not a part of array now. */
if|if
condition|(
name|pd
operator|->
name|pd_disk_pos
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
comment|/* 	 * Mark disk as failed in metadata and try to write that metadata 	 * to the disk itself to prevent it's later resurrection as STALE. 	 */
if|if
condition|(
name|tdisk
operator|->
name|d_consumer
condition|)
block|{
if|if
condition|(
name|pd
operator|->
name|pd_meta
condition|)
block|{
name|pd
operator|->
name|pd_meta
operator|->
name|disk_status
operator|=
name|SII_S_REMOVED
expr_stmt|;
name|sii_meta_write
argument_list|(
name|tdisk
operator|->
name|d_consumer
argument_list|,
name|pd
operator|->
name|pd_meta
argument_list|)
expr_stmt|;
block|}
else|else
name|sii_meta_erase
argument_list|(
name|tdisk
operator|->
name|d_consumer
argument_list|)
expr_stmt|;
block|}
comment|/* Change states. */
name|g_raid_change_disk_state
argument_list|(
name|tdisk
argument_list|,
name|G_RAID_DISK_S_FAILED
argument_list|)
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|sd
argument_list|,
argument|&tdisk->d_subdisks
argument_list|,
argument|sd_next
argument_list|)
block|{
name|g_raid_change_subdisk_state
argument_list|(
name|sd
argument_list|,
name|G_RAID_SUBDISK_S_FAILED
argument_list|)
expr_stmt|;
name|g_raid_event_send
argument_list|(
name|sd
argument_list|,
name|G_RAID_SUBDISK_E_FAILED
argument_list|,
name|G_RAID_EVENT_SUBDISK
argument_list|)
expr_stmt|;
block|}
comment|/* Write updated metadata to remaining disks. */
name|g_raid_md_write_sii
argument_list|(
name|md
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|tdisk
argument_list|)
expr_stmt|;
comment|/* Check if anything left except placeholders. */
if|if
condition|(
name|g_raid_ndisks
argument_list|(
name|sc
argument_list|,
operator|-
literal|1
argument_list|)
operator|==
name|g_raid_ndisks
argument_list|(
name|sc
argument_list|,
name|G_RAID_DISK_S_OFFLINE
argument_list|)
condition|)
name|g_raid_destroy_node
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
name|g_raid_md_sii_refill
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|g_raid_md_free_disk_sii
parameter_list|(
name|struct
name|g_raid_md_object
modifier|*
name|md
parameter_list|,
name|struct
name|g_raid_disk
modifier|*
name|disk
parameter_list|)
block|{
name|struct
name|g_raid_md_sii_perdisk
modifier|*
name|pd
decl_stmt|;
name|pd
operator|=
operator|(
expr|struct
name|g_raid_md_sii_perdisk
operator|*
operator|)
name|disk
operator|->
name|d_md_data
expr_stmt|;
if|if
condition|(
name|pd
operator|->
name|pd_meta
operator|!=
name|NULL
condition|)
block|{
name|free
argument_list|(
name|pd
operator|->
name|pd_meta
argument_list|,
name|M_MD_SII
argument_list|)
expr_stmt|;
name|pd
operator|->
name|pd_meta
operator|=
name|NULL
expr_stmt|;
block|}
name|free
argument_list|(
name|pd
argument_list|,
name|M_MD_SII
argument_list|)
expr_stmt|;
name|disk
operator|->
name|d_md_data
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|g_raid_md_free_sii
parameter_list|(
name|struct
name|g_raid_md_object
modifier|*
name|md
parameter_list|)
block|{
name|struct
name|g_raid_md_sii_object
modifier|*
name|mdi
decl_stmt|;
name|mdi
operator|=
operator|(
expr|struct
name|g_raid_md_sii_object
operator|*
operator|)
name|md
expr_stmt|;
if|if
condition|(
operator|!
name|mdi
operator|->
name|mdio_started
condition|)
block|{
name|mdi
operator|->
name|mdio_started
operator|=
literal|0
expr_stmt|;
name|callout_stop
argument_list|(
operator|&
name|mdi
operator|->
name|mdio_start_co
argument_list|)
expr_stmt|;
name|G_RAID_DEBUG1
argument_list|(
literal|1
argument_list|,
name|md
operator|->
name|mdo_softc
argument_list|,
literal|"root_mount_rel %p"
argument_list|,
name|mdi
operator|->
name|mdio_rootmount
argument_list|)
expr_stmt|;
name|root_mount_rel
argument_list|(
name|mdi
operator|->
name|mdio_rootmount
argument_list|)
expr_stmt|;
name|mdi
operator|->
name|mdio_rootmount
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|mdi
operator|->
name|mdio_meta
operator|!=
name|NULL
condition|)
block|{
name|free
argument_list|(
name|mdi
operator|->
name|mdio_meta
argument_list|,
name|M_MD_SII
argument_list|)
expr_stmt|;
name|mdi
operator|->
name|mdio_meta
operator|=
name|NULL
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_expr_stmt
name|G_RAID_MD_DECLARE
argument_list|(
name|g_raid_md_sii
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2012 Alexander Motin<mav@FreeBSD.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHORS AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHORS OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/bio.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/kobj.h>
end_include

begin_include
include|#
directive|include
file|<sys/limits.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/clock.h>
end_include

begin_include
include|#
directive|include
file|<geom/geom.h>
end_include

begin_include
include|#
directive|include
file|"geom/raid/g_raid.h"
end_include

begin_include
include|#
directive|include
file|"geom/raid/md_ddf.h"
end_include

begin_include
include|#
directive|include
file|"g_raid_md_if.h"
end_include

begin_expr_stmt
specifier|static
name|MALLOC_DEFINE
argument_list|(
name|M_MD_DDF
argument_list|,
literal|"md_ddf_data"
argument_list|,
literal|"GEOM_RAID DDF metadata"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_define
define|#
directive|define
name|DDF_MAX_DISKS_HARD
value|128
end_define

begin_define
define|#
directive|define
name|DDF_MAX_DISKS
value|16
end_define

begin_define
define|#
directive|define
name|DDF_MAX_VDISKS
value|7
end_define

begin_define
define|#
directive|define
name|DDF_MAX_PARTITIONS
value|1
end_define

begin_define
define|#
directive|define
name|DECADE
value|(3600*24*(365*10+2))
end_define

begin_comment
comment|/* 10 years in seconds. */
end_comment

begin_struct
struct|struct
name|ddf_meta
block|{
name|u_int
name|sectorsize
decl_stmt|;
name|u_int
name|bigendian
decl_stmt|;
name|struct
name|ddf_header
modifier|*
name|hdr
decl_stmt|;
name|struct
name|ddf_cd_record
modifier|*
name|cdr
decl_stmt|;
name|struct
name|ddf_pd_record
modifier|*
name|pdr
decl_stmt|;
name|struct
name|ddf_vd_record
modifier|*
name|vdr
decl_stmt|;
name|void
modifier|*
name|cr
decl_stmt|;
name|struct
name|ddf_pdd_record
modifier|*
name|pdd
decl_stmt|;
name|struct
name|ddf_bbm_log
modifier|*
name|bbm
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|ddf_vol_meta
block|{
name|u_int
name|sectorsize
decl_stmt|;
name|u_int
name|bigendian
decl_stmt|;
name|struct
name|ddf_header
modifier|*
name|hdr
decl_stmt|;
name|struct
name|ddf_cd_record
modifier|*
name|cdr
decl_stmt|;
name|struct
name|ddf_vd_entry
modifier|*
name|vde
decl_stmt|;
name|struct
name|ddf_vdc_record
modifier|*
name|vdc
decl_stmt|;
name|struct
name|ddf_vdc_record
modifier|*
name|bvdc
index|[
name|DDF_MAX_DISKS_HARD
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|g_raid_md_ddf_perdisk
block|{
name|struct
name|ddf_meta
name|pd_meta
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|g_raid_md_ddf_pervolume
block|{
name|struct
name|ddf_vol_meta
name|pv_meta
decl_stmt|;
name|int
name|pv_started
decl_stmt|;
name|struct
name|callout
name|pv_start_co
decl_stmt|;
comment|/* STARTING state timer. */
block|}
struct|;
end_struct

begin_struct
struct|struct
name|g_raid_md_ddf_object
block|{
name|struct
name|g_raid_md_object
name|mdio_base
decl_stmt|;
name|u_int
name|mdio_bigendian
decl_stmt|;
name|struct
name|ddf_meta
name|mdio_meta
decl_stmt|;
name|int
name|mdio_starting
decl_stmt|;
name|struct
name|callout
name|mdio_start_co
decl_stmt|;
comment|/* STARTING state timer. */
name|int
name|mdio_started
decl_stmt|;
name|struct
name|root_hold_token
modifier|*
name|mdio_rootmount
decl_stmt|;
comment|/* Root mount delay token. */
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|g_raid_md_create_req_t
name|g_raid_md_create_req_ddf
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|g_raid_md_taste_t
name|g_raid_md_taste_ddf
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|g_raid_md_event_t
name|g_raid_md_event_ddf
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|g_raid_md_volume_event_t
name|g_raid_md_volume_event_ddf
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|g_raid_md_ctl_t
name|g_raid_md_ctl_ddf
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|g_raid_md_write_t
name|g_raid_md_write_ddf
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|g_raid_md_fail_disk_t
name|g_raid_md_fail_disk_ddf
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|g_raid_md_free_disk_t
name|g_raid_md_free_disk_ddf
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|g_raid_md_free_volume_t
name|g_raid_md_free_volume_ddf
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|g_raid_md_free_t
name|g_raid_md_free_ddf
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|kobj_method_t
name|g_raid_md_ddf_methods
index|[]
init|=
block|{
name|KOBJMETHOD
argument_list|(
name|g_raid_md_create_req
argument_list|,
name|g_raid_md_create_req_ddf
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|g_raid_md_taste
argument_list|,
name|g_raid_md_taste_ddf
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|g_raid_md_event
argument_list|,
name|g_raid_md_event_ddf
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|g_raid_md_volume_event
argument_list|,
name|g_raid_md_volume_event_ddf
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|g_raid_md_ctl
argument_list|,
name|g_raid_md_ctl_ddf
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|g_raid_md_write
argument_list|,
name|g_raid_md_write_ddf
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|g_raid_md_fail_disk
argument_list|,
name|g_raid_md_fail_disk_ddf
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|g_raid_md_free_disk
argument_list|,
name|g_raid_md_free_disk_ddf
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|g_raid_md_free_volume
argument_list|,
name|g_raid_md_free_volume_ddf
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|g_raid_md_free
argument_list|,
name|g_raid_md_free_ddf
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|g_raid_md_class
name|g_raid_md_ddf_class
init|=
block|{
literal|"DDF"
block|,
name|g_raid_md_ddf_methods
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|g_raid_md_ddf_object
argument_list|)
block|,
operator|.
name|mdc_enable
operator|=
literal|1
block|,
operator|.
name|mdc_priority
operator|=
literal|100
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|GET8
parameter_list|(
name|m
parameter_list|,
name|f
parameter_list|)
value|((m)->f)
end_define

begin_define
define|#
directive|define
name|GET16
parameter_list|(
name|m
parameter_list|,
name|f
parameter_list|)
value|((m)->bigendian ? be16dec(&(m)->f) : le16dec(&(m)->f))
end_define

begin_define
define|#
directive|define
name|GET32
parameter_list|(
name|m
parameter_list|,
name|f
parameter_list|)
value|((m)->bigendian ? be32dec(&(m)->f) : le32dec(&(m)->f))
end_define

begin_define
define|#
directive|define
name|GET64
parameter_list|(
name|m
parameter_list|,
name|f
parameter_list|)
value|((m)->bigendian ? be64dec(&(m)->f) : le64dec(&(m)->f))
end_define

begin_define
define|#
directive|define
name|GET8D
parameter_list|(
name|m
parameter_list|,
name|f
parameter_list|)
value|(f)
end_define

begin_define
define|#
directive|define
name|GET16D
parameter_list|(
name|m
parameter_list|,
name|f
parameter_list|)
value|((m)->bigendian ? be16dec(&f) : le16dec(&f))
end_define

begin_define
define|#
directive|define
name|GET32D
parameter_list|(
name|m
parameter_list|,
name|f
parameter_list|)
value|((m)->bigendian ? be32dec(&f) : le32dec(&f))
end_define

begin_define
define|#
directive|define
name|GET64D
parameter_list|(
name|m
parameter_list|,
name|f
parameter_list|)
value|((m)->bigendian ? be64dec(&f) : le64dec(&f))
end_define

begin_define
define|#
directive|define
name|GET8P
parameter_list|(
name|m
parameter_list|,
name|f
parameter_list|)
value|(*(f))
end_define

begin_define
define|#
directive|define
name|GET16P
parameter_list|(
name|m
parameter_list|,
name|f
parameter_list|)
value|((m)->bigendian ? be16dec(f) : le16dec(f))
end_define

begin_define
define|#
directive|define
name|GET32P
parameter_list|(
name|m
parameter_list|,
name|f
parameter_list|)
value|((m)->bigendian ? be32dec(f) : le32dec(f))
end_define

begin_define
define|#
directive|define
name|GET64P
parameter_list|(
name|m
parameter_list|,
name|f
parameter_list|)
value|((m)->bigendian ? be64dec(f) : le64dec(f))
end_define

begin_define
define|#
directive|define
name|SET8P
parameter_list|(
name|m
parameter_list|,
name|f
parameter_list|,
name|v
parameter_list|)
define|\
value|(*(f) = (v))
end_define

begin_define
define|#
directive|define
name|SET16P
parameter_list|(
name|m
parameter_list|,
name|f
parameter_list|,
name|v
parameter_list|)
define|\
value|do {								\ 		if ((m)->bigendian)					\ 			be16enc((f), (v));				\ 		else							\ 			le16enc((f), (v));				\ 	} while (0)
end_define

begin_define
define|#
directive|define
name|SET32P
parameter_list|(
name|m
parameter_list|,
name|f
parameter_list|,
name|v
parameter_list|)
define|\
value|do {								\ 		if ((m)->bigendian)					\ 			be32enc((f), (v));				\ 		else							\ 			le32enc((f), (v));				\ 	} while (0)
end_define

begin_define
define|#
directive|define
name|SET64P
parameter_list|(
name|m
parameter_list|,
name|f
parameter_list|,
name|v
parameter_list|)
define|\
value|do {								\ 		if ((m)->bigendian)					\ 			be64enc((f), (v));				\ 		else							\ 			le64enc((f), (v));				\ 	} while (0)
end_define

begin_define
define|#
directive|define
name|SET8
parameter_list|(
name|m
parameter_list|,
name|f
parameter_list|,
name|v
parameter_list|)
value|SET8P((m),&((m)->f), (v))
end_define

begin_define
define|#
directive|define
name|SET16
parameter_list|(
name|m
parameter_list|,
name|f
parameter_list|,
name|v
parameter_list|)
value|SET16P((m),&((m)->f), (v))
end_define

begin_define
define|#
directive|define
name|SET32
parameter_list|(
name|m
parameter_list|,
name|f
parameter_list|,
name|v
parameter_list|)
value|SET32P((m),&((m)->f), (v))
end_define

begin_define
define|#
directive|define
name|SET64
parameter_list|(
name|m
parameter_list|,
name|f
parameter_list|,
name|v
parameter_list|)
value|SET64P((m),&((m)->f), (v))
end_define

begin_define
define|#
directive|define
name|SET8D
parameter_list|(
name|m
parameter_list|,
name|f
parameter_list|,
name|v
parameter_list|)
value|SET8P((m),&(f), (v))
end_define

begin_define
define|#
directive|define
name|SET16D
parameter_list|(
name|m
parameter_list|,
name|f
parameter_list|,
name|v
parameter_list|)
value|SET16P((m),&(f), (v))
end_define

begin_define
define|#
directive|define
name|SET32D
parameter_list|(
name|m
parameter_list|,
name|f
parameter_list|,
name|v
parameter_list|)
value|SET32P((m),&(f), (v))
end_define

begin_define
define|#
directive|define
name|SET64D
parameter_list|(
name|m
parameter_list|,
name|f
parameter_list|,
name|v
parameter_list|)
value|SET64P((m),&(f), (v))
end_define

begin_define
define|#
directive|define
name|GETCRNUM
parameter_list|(
name|m
parameter_list|)
value|(GET32((m), hdr->cr_length) /			\ 	GET16((m), hdr->Configuration_Record_Length))
end_define

begin_define
define|#
directive|define
name|GETVDCPTR
parameter_list|(
name|m
parameter_list|,
name|n
parameter_list|)
value|((struct ddf_vdc_record *)((uint8_t *)(m)->cr +	\ 	(n) * GET16((m), hdr->Configuration_Record_Length) *		\ 	(m)->sectorsize))
end_define

begin_define
define|#
directive|define
name|GETSAPTR
parameter_list|(
name|m
parameter_list|,
name|n
parameter_list|)
value|((struct ddf_sa_record *)((uint8_t *)(m)->cr +	\ 	(n) * GET16((m), hdr->Configuration_Record_Length) *		\ 	(m)->sectorsize))
end_define

begin_function
specifier|static
name|int
name|isff
parameter_list|(
name|uint8_t
modifier|*
name|buf
parameter_list|,
name|int
name|size
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|size
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|buf
index|[
name|i
index|]
operator|!=
literal|0xff
condition|)
return|return
operator|(
literal|0
operator|)
return|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_guid
parameter_list|(
name|uint8_t
modifier|*
name|buf
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|ascii
decl_stmt|;
name|ascii
operator|=
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|24
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|buf
index|[
name|i
index|]
operator|!=
literal|0
operator|&&
operator|(
name|buf
index|[
name|i
index|]
operator|<
literal|' '
operator|||
name|buf
index|[
name|i
index|]
operator|>
literal|127
operator|)
condition|)
block|{
name|ascii
operator|=
literal|0
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|ascii
condition|)
block|{
name|printf
argument_list|(
literal|"'%.24s'"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|24
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"%02x"
argument_list|,
name|buf
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|g_raid_md_ddf_print
parameter_list|(
name|struct
name|ddf_meta
modifier|*
name|meta
parameter_list|)
block|{
name|struct
name|ddf_vdc_record
modifier|*
name|vdc
decl_stmt|;
name|struct
name|ddf_vuc_record
modifier|*
name|vuc
decl_stmt|;
name|struct
name|ddf_sa_record
modifier|*
name|sa
decl_stmt|;
name|uint64_t
modifier|*
name|val2
decl_stmt|;
name|uint32_t
name|val
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|k
decl_stmt|,
name|num
decl_stmt|,
name|num2
decl_stmt|;
if|if
condition|(
name|g_raid_debug
operator|<
literal|1
condition|)
return|return;
name|printf
argument_list|(
literal|"********* DDF Metadata *********\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"**** Header ****\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"DDF_Header_GUID      "
argument_list|)
expr_stmt|;
name|print_guid
argument_list|(
name|meta
operator|->
name|hdr
operator|->
name|DDF_Header_GUID
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"DDF_rev              %8.8s\n"
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|meta
operator|->
name|hdr
operator|->
name|DDF_rev
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Sequence_Number      0x%08x\n"
argument_list|,
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|Sequence_Number
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"TimeStamp            0x%08x\n"
argument_list|,
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|TimeStamp
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Open_Flag            0x%02x\n"
argument_list|,
name|GET16
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|Open_Flag
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Foreign_Flag         0x%02x\n"
argument_list|,
name|GET16
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|Foreign_Flag
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Diskgrouping         0x%02x\n"
argument_list|,
name|GET16
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|Diskgrouping
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Primary_Header_LBA   %ju\n"
argument_list|,
name|GET64
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|Primary_Header_LBA
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Secondary_Header_LBA %ju\n"
argument_list|,
name|GET64
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|Secondary_Header_LBA
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"WorkSpace_Length     %u\n"
argument_list|,
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|WorkSpace_Length
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"WorkSpace_LBA        %ju\n"
argument_list|,
name|GET64
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|WorkSpace_LBA
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Max_PD_Entries       %u\n"
argument_list|,
name|GET16
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|Max_PD_Entries
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Max_VD_Entries       %u\n"
argument_list|,
name|GET16
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|Max_VD_Entries
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Max_Partitions       %u\n"
argument_list|,
name|GET16
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|Max_Partitions
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Configuration_Record_Length %u\n"
argument_list|,
name|GET16
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|Configuration_Record_Length
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Max_Primary_Element_Entries %u\n"
argument_list|,
name|GET16
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|Max_Primary_Element_Entries
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Controller Data      %u:%u\n"
argument_list|,
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|cd_section
argument_list|)
argument_list|,
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|cd_length
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Physical Disk        %u:%u\n"
argument_list|,
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|pdr_section
argument_list|)
argument_list|,
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|pdr_length
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Virtual Disk         %u:%u\n"
argument_list|,
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|vdr_section
argument_list|)
argument_list|,
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|vdr_length
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Configuration Recs   %u:%u\n"
argument_list|,
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|cr_section
argument_list|)
argument_list|,
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|cr_length
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Physical Disk Recs   %u:%u\n"
argument_list|,
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|pdd_section
argument_list|)
argument_list|,
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|pdd_length
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"BBM Log              %u:%u\n"
argument_list|,
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|bbmlog_section
argument_list|)
argument_list|,
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|bbmlog_length
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Diagnostic Space     %u:%u\n"
argument_list|,
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|Diagnostic_Space
argument_list|)
argument_list|,
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|Diagnostic_Space_Length
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Vendor_Specific_Logs %u:%u\n"
argument_list|,
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|Vendor_Specific_Logs
argument_list|)
argument_list|,
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|Vendor_Specific_Logs_Length
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"**** Controler Data ****\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Controller_GUID      "
argument_list|)
expr_stmt|;
name|print_guid
argument_list|(
name|meta
operator|->
name|cdr
operator|->
name|Controller_GUID
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Controller_Type      0x%04x%04x 0x%04x%04x\n"
argument_list|,
name|GET16
argument_list|(
name|meta
argument_list|,
name|cdr
operator|->
name|Controller_Type
operator|.
name|Vendor_ID
argument_list|)
argument_list|,
name|GET16
argument_list|(
name|meta
argument_list|,
name|cdr
operator|->
name|Controller_Type
operator|.
name|Device_ID
argument_list|)
argument_list|,
name|GET16
argument_list|(
name|meta
argument_list|,
name|cdr
operator|->
name|Controller_Type
operator|.
name|SubVendor_ID
argument_list|)
argument_list|,
name|GET16
argument_list|(
name|meta
argument_list|,
name|cdr
operator|->
name|Controller_Type
operator|.
name|SubDevice_ID
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Product_ID           '%.16s'\n"
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|meta
operator|->
name|cdr
operator|->
name|Product_ID
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"**** Physical Disk Records ****\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Populated_PDEs       %u\n"
argument_list|,
name|GET16
argument_list|(
name|meta
argument_list|,
name|pdr
operator|->
name|Populated_PDEs
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Max_PDE_Supported    %u\n"
argument_list|,
name|GET16
argument_list|(
name|meta
argument_list|,
name|pdr
operator|->
name|Max_PDE_Supported
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|GET16
argument_list|(
name|meta
argument_list|,
name|pdr
operator|->
name|Populated_PDEs
argument_list|)
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|isff
argument_list|(
name|meta
operator|->
name|pdr
operator|->
name|entry
index|[
name|j
index|]
operator|.
name|PD_GUID
argument_list|,
literal|24
argument_list|)
condition|)
continue|continue;
if|if
condition|(
name|GET32
argument_list|(
name|meta
argument_list|,
name|pdr
operator|->
name|entry
index|[
name|j
index|]
operator|.
name|PD_Reference
argument_list|)
operator|==
literal|0xffffffff
condition|)
continue|continue;
name|printf
argument_list|(
literal|"PD_GUID              "
argument_list|)
expr_stmt|;
name|print_guid
argument_list|(
name|meta
operator|->
name|pdr
operator|->
name|entry
index|[
name|j
index|]
operator|.
name|PD_GUID
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"PD_Reference         0x%08x\n"
argument_list|,
name|GET32
argument_list|(
name|meta
argument_list|,
name|pdr
operator|->
name|entry
index|[
name|j
index|]
operator|.
name|PD_Reference
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"PD_Type              0x%04x\n"
argument_list|,
name|GET16
argument_list|(
name|meta
argument_list|,
name|pdr
operator|->
name|entry
index|[
name|j
index|]
operator|.
name|PD_Type
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"PD_State             0x%04x\n"
argument_list|,
name|GET16
argument_list|(
name|meta
argument_list|,
name|pdr
operator|->
name|entry
index|[
name|j
index|]
operator|.
name|PD_State
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Configured_Size      %ju\n"
argument_list|,
name|GET64
argument_list|(
name|meta
argument_list|,
name|pdr
operator|->
name|entry
index|[
name|j
index|]
operator|.
name|Configured_Size
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Block_Size           %u\n"
argument_list|,
name|GET16
argument_list|(
name|meta
argument_list|,
name|pdr
operator|->
name|entry
index|[
name|j
index|]
operator|.
name|Block_Size
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"**** Virtual Disk Records ****\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Populated_VDEs       %u\n"
argument_list|,
name|GET16
argument_list|(
name|meta
argument_list|,
name|vdr
operator|->
name|Populated_VDEs
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Max_VDE_Supported    %u\n"
argument_list|,
name|GET16
argument_list|(
name|meta
argument_list|,
name|vdr
operator|->
name|Max_VDE_Supported
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|GET16
argument_list|(
name|meta
argument_list|,
name|vdr
operator|->
name|Populated_VDEs
argument_list|)
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|isff
argument_list|(
name|meta
operator|->
name|vdr
operator|->
name|entry
index|[
name|j
index|]
operator|.
name|VD_GUID
argument_list|,
literal|24
argument_list|)
condition|)
continue|continue;
name|printf
argument_list|(
literal|"VD_GUID              "
argument_list|)
expr_stmt|;
name|print_guid
argument_list|(
name|meta
operator|->
name|vdr
operator|->
name|entry
index|[
name|j
index|]
operator|.
name|VD_GUID
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"VD_Number            0x%04x\n"
argument_list|,
name|GET16
argument_list|(
name|meta
argument_list|,
name|vdr
operator|->
name|entry
index|[
name|j
index|]
operator|.
name|VD_Number
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"VD_Type              0x%04x\n"
argument_list|,
name|GET16
argument_list|(
name|meta
argument_list|,
name|vdr
operator|->
name|entry
index|[
name|j
index|]
operator|.
name|VD_Type
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"VD_State             0x%02x\n"
argument_list|,
name|GET8
argument_list|(
name|meta
argument_list|,
name|vdr
operator|->
name|entry
index|[
name|j
index|]
operator|.
name|VD_State
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Init_State           0x%02x\n"
argument_list|,
name|GET8
argument_list|(
name|meta
argument_list|,
name|vdr
operator|->
name|entry
index|[
name|j
index|]
operator|.
name|Init_State
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Drive_Failures_Remaining %u\n"
argument_list|,
name|GET8
argument_list|(
name|meta
argument_list|,
name|vdr
operator|->
name|entry
index|[
name|j
index|]
operator|.
name|Drive_Failures_Remaining
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"VD_Name              '%.16s'\n"
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|meta
operator|->
name|vdr
operator|->
name|entry
index|[
name|j
index|]
operator|.
name|VD_Name
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"**** Configuration Records ****\n"
argument_list|)
expr_stmt|;
name|num
operator|=
name|GETCRNUM
argument_list|(
name|meta
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|num
condition|;
name|j
operator|++
control|)
block|{
name|vdc
operator|=
name|GETVDCPTR
argument_list|(
name|meta
argument_list|,
name|j
argument_list|)
expr_stmt|;
name|val
operator|=
name|GET32D
argument_list|(
name|meta
argument_list|,
name|vdc
operator|->
name|Signature
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|val
condition|)
block|{
case|case
name|DDF_VDCR_SIGNATURE
case|:
name|printf
argument_list|(
literal|"** Virtual Disk Configuration **\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"VD_GUID              "
argument_list|)
expr_stmt|;
name|print_guid
argument_list|(
name|vdc
operator|->
name|VD_GUID
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Timestamp            0x%08x\n"
argument_list|,
name|GET32D
argument_list|(
name|meta
argument_list|,
name|vdc
operator|->
name|Timestamp
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Sequence_Number      0x%08x\n"
argument_list|,
name|GET32D
argument_list|(
name|meta
argument_list|,
name|vdc
operator|->
name|Sequence_Number
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Primary_Element_Count %u\n"
argument_list|,
name|GET16D
argument_list|(
name|meta
argument_list|,
name|vdc
operator|->
name|Primary_Element_Count
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Stripe_Size          %u\n"
argument_list|,
name|GET8D
argument_list|(
name|meta
argument_list|,
name|vdc
operator|->
name|Stripe_Size
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Primary_RAID_Level   0x%02x\n"
argument_list|,
name|GET8D
argument_list|(
name|meta
argument_list|,
name|vdc
operator|->
name|Primary_RAID_Level
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"RLQ                  0x%02x\n"
argument_list|,
name|GET8D
argument_list|(
name|meta
argument_list|,
name|vdc
operator|->
name|RLQ
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Secondary_Element_Count %u\n"
argument_list|,
name|GET8D
argument_list|(
name|meta
argument_list|,
name|vdc
operator|->
name|Secondary_Element_Count
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Secondary_Element_Seq %u\n"
argument_list|,
name|GET8D
argument_list|(
name|meta
argument_list|,
name|vdc
operator|->
name|Secondary_Element_Seq
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Secondary_RAID_Level 0x%02x\n"
argument_list|,
name|GET8D
argument_list|(
name|meta
argument_list|,
name|vdc
operator|->
name|Secondary_RAID_Level
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Block_Count          %ju\n"
argument_list|,
name|GET64D
argument_list|(
name|meta
argument_list|,
name|vdc
operator|->
name|Block_Count
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"VD_Size              %ju\n"
argument_list|,
name|GET64D
argument_list|(
name|meta
argument_list|,
name|vdc
operator|->
name|VD_Size
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Block_Size           %u\n"
argument_list|,
name|GET16D
argument_list|(
name|meta
argument_list|,
name|vdc
operator|->
name|Block_Size
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Rotate_Parity_count  %u\n"
argument_list|,
name|GET8D
argument_list|(
name|meta
argument_list|,
name|vdc
operator|->
name|Rotate_Parity_count
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Associated_Spare_Disks"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|GET32D
argument_list|(
name|meta
argument_list|,
name|vdc
operator|->
name|Associated_Spares
index|[
name|i
index|]
argument_list|)
operator|!=
literal|0xffffffff
condition|)
name|printf
argument_list|(
literal|" 0x%08x"
argument_list|,
name|GET32D
argument_list|(
name|meta
argument_list|,
name|vdc
operator|->
name|Associated_Spares
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Cache_Flags          %016jx\n"
argument_list|,
name|GET64D
argument_list|(
name|meta
argument_list|,
name|vdc
operator|->
name|Cache_Flags
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"BG_Rate              %u\n"
argument_list|,
name|GET8D
argument_list|(
name|meta
argument_list|,
name|vdc
operator|->
name|BG_Rate
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"MDF_Parity_Disks     %u\n"
argument_list|,
name|GET8D
argument_list|(
name|meta
argument_list|,
name|vdc
operator|->
name|MDF_Parity_Disks
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"MDF_Parity_Generator_Polynomial 0x%04x\n"
argument_list|,
name|GET16D
argument_list|(
name|meta
argument_list|,
name|vdc
operator|->
name|MDF_Parity_Generator_Polynomial
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"MDF_Constant_Generation_Method 0x%02x\n"
argument_list|,
name|GET8D
argument_list|(
name|meta
argument_list|,
name|vdc
operator|->
name|MDF_Constant_Generation_Method
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Physical_Disks      "
argument_list|)
expr_stmt|;
name|num2
operator|=
name|GET16D
argument_list|(
name|meta
argument_list|,
name|vdc
operator|->
name|Primary_Element_Count
argument_list|)
expr_stmt|;
name|val2
operator|=
operator|(
name|uint64_t
operator|*
operator|)
operator|&
operator|(
name|vdc
operator|->
name|Physical_Disk_Sequence
index|[
name|GET16
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|Max_Primary_Element_Entries
argument_list|)
index|]
operator|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num2
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|" 0x%08x @ %ju"
argument_list|,
name|GET32D
argument_list|(
name|meta
argument_list|,
name|vdc
operator|->
name|Physical_Disk_Sequence
index|[
name|i
index|]
argument_list|)
argument_list|,
name|GET64P
argument_list|(
name|meta
argument_list|,
name|val2
operator|+
name|i
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|DDF_VUCR_SIGNATURE
case|:
name|printf
argument_list|(
literal|"** Vendor Unique Configuration **\n"
argument_list|)
expr_stmt|;
name|vuc
operator|=
operator|(
expr|struct
name|ddf_vuc_record
operator|*
operator|)
name|vdc
expr_stmt|;
name|printf
argument_list|(
literal|"VD_GUID              "
argument_list|)
expr_stmt|;
name|print_guid
argument_list|(
name|vuc
operator|->
name|VD_GUID
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|DDF_SA_SIGNATURE
case|:
name|printf
argument_list|(
literal|"** Spare Assignment Configuration **\n"
argument_list|)
expr_stmt|;
name|sa
operator|=
operator|(
expr|struct
name|ddf_sa_record
operator|*
operator|)
name|vdc
expr_stmt|;
name|printf
argument_list|(
literal|"Timestamp            0x%08x\n"
argument_list|,
name|GET32D
argument_list|(
name|meta
argument_list|,
name|sa
operator|->
name|Timestamp
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Spare_Type           0x%02x\n"
argument_list|,
name|GET8D
argument_list|(
name|meta
argument_list|,
name|sa
operator|->
name|Spare_Type
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Populated_SAEs       %u\n"
argument_list|,
name|GET16D
argument_list|(
name|meta
argument_list|,
name|sa
operator|->
name|Populated_SAEs
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"MAX_SAE_Supported    %u\n"
argument_list|,
name|GET16D
argument_list|(
name|meta
argument_list|,
name|sa
operator|->
name|MAX_SAE_Supported
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|GET16D
argument_list|(
name|meta
argument_list|,
name|sa
operator|->
name|Populated_SAEs
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|isff
argument_list|(
name|sa
operator|->
name|entry
index|[
name|i
index|]
operator|.
name|VD_GUID
argument_list|,
literal|24
argument_list|)
condition|)
continue|continue;
name|printf
argument_list|(
literal|"VD_GUID             "
argument_list|)
expr_stmt|;
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
literal|24
condition|;
name|k
operator|++
control|)
name|printf
argument_list|(
literal|"%02x"
argument_list|,
name|sa
operator|->
name|entry
index|[
name|i
index|]
operator|.
name|VD_GUID
index|[
name|k
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Secondary_Element   %u\n"
argument_list|,
name|GET16D
argument_list|(
name|meta
argument_list|,
name|sa
operator|->
name|entry
index|[
name|i
index|]
operator|.
name|Secondary_Element
argument_list|)
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|0x00000000
case|:
case|case
literal|0xFFFFFFFF
case|:
break|break;
default|default:
name|printf
argument_list|(
literal|"Unknown configuration signature %08x\n"
argument_list|,
name|val
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|printf
argument_list|(
literal|"**** Physical Disk Data ****\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"PD_GUID              "
argument_list|)
expr_stmt|;
name|print_guid
argument_list|(
name|meta
operator|->
name|pdd
operator|->
name|PD_GUID
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"PD_Reference         0x%08x\n"
argument_list|,
name|GET32
argument_list|(
name|meta
argument_list|,
name|pdd
operator|->
name|PD_Reference
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Forced_Ref_Flag      0x%02x\n"
argument_list|,
name|GET8
argument_list|(
name|meta
argument_list|,
name|pdd
operator|->
name|Forced_Ref_Flag
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Forced_PD_GUID_Flag  0x%02x\n"
argument_list|,
name|GET8
argument_list|(
name|meta
argument_list|,
name|pdd
operator|->
name|Forced_PD_GUID_Flag
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|ddf_meta_find_pd
parameter_list|(
name|struct
name|ddf_meta
modifier|*
name|meta
parameter_list|,
name|uint8_t
modifier|*
name|GUID
parameter_list|,
name|uint32_t
name|PD_Reference
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|GET16
argument_list|(
name|meta
argument_list|,
name|pdr
operator|->
name|Populated_PDEs
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|GUID
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|memcmp
argument_list|(
name|meta
operator|->
name|pdr
operator|->
name|entry
index|[
name|i
index|]
operator|.
name|PD_GUID
argument_list|,
name|GUID
argument_list|,
literal|24
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|i
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|PD_Reference
operator|!=
literal|0xffffffff
condition|)
block|{
if|if
condition|(
name|GET32
argument_list|(
name|meta
argument_list|,
name|pdr
operator|->
name|entry
index|[
name|i
index|]
operator|.
name|PD_Reference
argument_list|)
operator|==
name|PD_Reference
condition|)
return|return
operator|(
name|i
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|isff
argument_list|(
name|meta
operator|->
name|pdr
operator|->
name|entry
index|[
name|i
index|]
operator|.
name|PD_GUID
argument_list|,
literal|24
argument_list|)
condition|)
return|return
operator|(
name|i
operator|)
return|;
block|}
if|if
condition|(
name|GUID
operator|==
name|NULL
operator|&&
name|PD_Reference
operator|==
literal|0xffffffff
condition|)
block|{
if|if
condition|(
name|i
operator|>=
name|GET16
argument_list|(
name|meta
argument_list|,
name|pdr
operator|->
name|Max_PDE_Supported
argument_list|)
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|SET16
argument_list|(
name|meta
argument_list|,
name|pdr
operator|->
name|Populated_PDEs
argument_list|,
name|i
operator|+
literal|1
argument_list|)
expr_stmt|;
return|return
operator|(
name|i
operator|)
return|;
block|}
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ddf_meta_find_vd
parameter_list|(
name|struct
name|ddf_meta
modifier|*
name|meta
parameter_list|,
name|uint8_t
modifier|*
name|GUID
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|GET16
argument_list|(
name|meta
argument_list|,
name|vdr
operator|->
name|Populated_VDEs
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|GUID
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|memcmp
argument_list|(
name|meta
operator|->
name|vdr
operator|->
name|entry
index|[
name|i
index|]
operator|.
name|VD_GUID
argument_list|,
name|GUID
argument_list|,
literal|24
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|i
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|isff
argument_list|(
name|meta
operator|->
name|vdr
operator|->
name|entry
index|[
name|i
index|]
operator|.
name|VD_GUID
argument_list|,
literal|24
argument_list|)
condition|)
return|return
operator|(
name|i
operator|)
return|;
block|}
if|if
condition|(
name|GUID
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|i
operator|>=
name|GET16
argument_list|(
name|meta
argument_list|,
name|vdr
operator|->
name|Max_VDE_Supported
argument_list|)
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|SET16
argument_list|(
name|meta
argument_list|,
name|vdr
operator|->
name|Populated_VDEs
argument_list|,
name|i
operator|+
literal|1
argument_list|)
expr_stmt|;
return|return
operator|(
name|i
operator|)
return|;
block|}
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|ddf_vdc_record
modifier|*
name|ddf_meta_find_vdc
parameter_list|(
name|struct
name|ddf_meta
modifier|*
name|meta
parameter_list|,
name|uint8_t
modifier|*
name|GUID
parameter_list|)
block|{
name|struct
name|ddf_vdc_record
modifier|*
name|vdc
decl_stmt|;
name|int
name|i
decl_stmt|,
name|num
decl_stmt|;
name|num
operator|=
name|GETCRNUM
argument_list|(
name|meta
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num
condition|;
name|i
operator|++
control|)
block|{
name|vdc
operator|=
name|GETVDCPTR
argument_list|(
name|meta
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|GUID
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|GET32D
argument_list|(
name|meta
argument_list|,
name|vdc
operator|->
name|Signature
argument_list|)
operator|==
name|DDF_VDCR_SIGNATURE
operator|&&
name|memcmp
argument_list|(
name|vdc
operator|->
name|VD_GUID
argument_list|,
name|GUID
argument_list|,
literal|24
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|vdc
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|GET32D
argument_list|(
name|meta
argument_list|,
name|vdc
operator|->
name|Signature
argument_list|)
operator|==
literal|0xffffffff
operator|||
name|GET32D
argument_list|(
name|meta
argument_list|,
name|vdc
operator|->
name|Signature
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|vdc
operator|)
return|;
block|}
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ddf_meta_count_vdc
parameter_list|(
name|struct
name|ddf_meta
modifier|*
name|meta
parameter_list|,
name|uint8_t
modifier|*
name|GUID
parameter_list|)
block|{
name|struct
name|ddf_vdc_record
modifier|*
name|vdc
decl_stmt|;
name|int
name|i
decl_stmt|,
name|num
decl_stmt|,
name|cnt
decl_stmt|;
name|cnt
operator|=
literal|0
expr_stmt|;
name|num
operator|=
name|GETCRNUM
argument_list|(
name|meta
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num
condition|;
name|i
operator|++
control|)
block|{
name|vdc
operator|=
name|GETVDCPTR
argument_list|(
name|meta
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|GET32D
argument_list|(
name|meta
argument_list|,
name|vdc
operator|->
name|Signature
argument_list|)
operator|!=
name|DDF_VDCR_SIGNATURE
condition|)
continue|continue;
if|if
condition|(
name|GUID
operator|==
name|NULL
operator|||
name|memcmp
argument_list|(
name|vdc
operator|->
name|VD_GUID
argument_list|,
name|GUID
argument_list|,
literal|24
argument_list|)
operator|==
literal|0
condition|)
name|cnt
operator|++
expr_stmt|;
block|}
return|return
operator|(
name|cnt
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ddf_meta_find_disk
parameter_list|(
name|struct
name|ddf_vol_meta
modifier|*
name|vmeta
parameter_list|,
name|uint32_t
name|PD_Reference
parameter_list|,
name|int
modifier|*
name|bvdp
parameter_list|,
name|int
modifier|*
name|posp
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|bvd
decl_stmt|,
name|pos
decl_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|bvd
operator|=
literal|0
init|;
name|bvd
operator|<
name|GET8
argument_list|(
name|vmeta
argument_list|,
name|vdc
operator|->
name|Secondary_Element_Count
argument_list|)
condition|;
name|bvd
operator|++
control|)
block|{
if|if
condition|(
name|vmeta
operator|->
name|bvdc
index|[
name|bvd
index|]
operator|==
name|NULL
condition|)
block|{
name|i
operator|+=
name|GET16
argument_list|(
name|vmeta
argument_list|,
name|vdc
operator|->
name|Primary_Element_Count
argument_list|)
expr_stmt|;
comment|// XXX
continue|continue;
block|}
for|for
control|(
name|pos
operator|=
literal|0
init|;
name|pos
operator|<
name|GET16
argument_list|(
name|vmeta
argument_list|,
name|bvdc
index|[
name|bvd
index|]
operator|->
name|Primary_Element_Count
argument_list|)
condition|;
name|pos
operator|++
operator|,
name|i
operator|++
control|)
block|{
if|if
condition|(
name|GET32
argument_list|(
name|vmeta
argument_list|,
name|bvdc
index|[
name|bvd
index|]
operator|->
name|Physical_Disk_Sequence
index|[
name|pos
index|]
argument_list|)
operator|==
name|PD_Reference
condition|)
block|{
if|if
condition|(
name|bvdp
operator|!=
name|NULL
condition|)
operator|*
name|bvdp
operator|=
name|bvd
expr_stmt|;
if|if
condition|(
name|posp
operator|!=
name|NULL
condition|)
operator|*
name|posp
operator|=
name|pos
expr_stmt|;
return|return
operator|(
name|i
operator|)
return|;
block|}
block|}
block|}
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|ddf_sa_record
modifier|*
name|ddf_meta_find_sa
parameter_list|(
name|struct
name|ddf_meta
modifier|*
name|meta
parameter_list|,
name|int
name|create
parameter_list|)
block|{
name|struct
name|ddf_sa_record
modifier|*
name|sa
decl_stmt|;
name|int
name|i
decl_stmt|,
name|num
decl_stmt|;
name|num
operator|=
name|GETCRNUM
argument_list|(
name|meta
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num
condition|;
name|i
operator|++
control|)
block|{
name|sa
operator|=
name|GETSAPTR
argument_list|(
name|meta
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|GET32D
argument_list|(
name|meta
argument_list|,
name|sa
operator|->
name|Signature
argument_list|)
operator|==
name|DDF_SA_SIGNATURE
condition|)
return|return
operator|(
name|sa
operator|)
return|;
block|}
if|if
condition|(
name|create
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num
condition|;
name|i
operator|++
control|)
block|{
name|sa
operator|=
name|GETSAPTR
argument_list|(
name|meta
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|GET32D
argument_list|(
name|meta
argument_list|,
name|sa
operator|->
name|Signature
argument_list|)
operator|==
literal|0xffffffff
operator|||
name|GET32D
argument_list|(
name|meta
argument_list|,
name|sa
operator|->
name|Signature
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|sa
operator|)
return|;
block|}
block|}
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ddf_meta_create
parameter_list|(
name|struct
name|g_raid_disk
modifier|*
name|disk
parameter_list|,
name|struct
name|ddf_meta
modifier|*
name|sample
parameter_list|)
block|{
name|struct
name|timespec
name|ts
decl_stmt|;
name|struct
name|clocktime
name|ct
decl_stmt|;
name|struct
name|g_raid_md_ddf_perdisk
modifier|*
name|pd
decl_stmt|;
name|struct
name|g_raid_md_ddf_object
modifier|*
name|mdi
decl_stmt|;
name|struct
name|ddf_meta
modifier|*
name|meta
decl_stmt|;
name|struct
name|ddf_pd_entry
modifier|*
name|pde
decl_stmt|;
name|off_t
name|anchorlba
decl_stmt|;
name|u_int
name|ss
decl_stmt|,
name|pos
decl_stmt|,
name|size
decl_stmt|;
name|int
name|len
decl_stmt|,
name|error
decl_stmt|;
name|char
name|serial_buffer
index|[
literal|24
index|]
decl_stmt|;
if|if
condition|(
name|sample
operator|->
name|hdr
operator|==
name|NULL
condition|)
name|sample
operator|=
name|NULL
expr_stmt|;
name|mdi
operator|=
operator|(
expr|struct
name|g_raid_md_ddf_object
operator|*
operator|)
name|disk
operator|->
name|d_softc
operator|->
name|sc_md
expr_stmt|;
name|pd
operator|=
operator|(
expr|struct
name|g_raid_md_ddf_perdisk
operator|*
operator|)
name|disk
operator|->
name|d_md_data
expr_stmt|;
name|meta
operator|=
operator|&
name|pd
operator|->
name|pd_meta
expr_stmt|;
name|ss
operator|=
name|disk
operator|->
name|d_consumer
operator|->
name|provider
operator|->
name|sectorsize
expr_stmt|;
name|anchorlba
operator|=
name|disk
operator|->
name|d_consumer
operator|->
name|provider
operator|->
name|mediasize
operator|/
name|ss
operator|-
literal|1
expr_stmt|;
name|meta
operator|->
name|sectorsize
operator|=
name|ss
expr_stmt|;
name|meta
operator|->
name|bigendian
operator|=
name|sample
condition|?
name|sample
operator|->
name|bigendian
else|:
name|mdi
operator|->
name|mdio_bigendian
expr_stmt|;
name|getnanotime
argument_list|(
operator|&
name|ts
argument_list|)
expr_stmt|;
name|clock_ts_to_ct
argument_list|(
operator|&
name|ts
argument_list|,
operator|&
name|ct
argument_list|)
expr_stmt|;
comment|/* Header */
name|meta
operator|->
name|hdr
operator|=
name|malloc
argument_list|(
name|ss
argument_list|,
name|M_MD_DDF
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|meta
operator|->
name|hdr
argument_list|,
literal|0xff
argument_list|,
name|ss
argument_list|)
expr_stmt|;
if|if
condition|(
name|sample
condition|)
block|{
name|memcpy
argument_list|(
name|meta
operator|->
name|hdr
argument_list|,
name|sample
operator|->
name|hdr
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ddf_header
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ss
operator|!=
name|sample
operator|->
name|sectorsize
condition|)
block|{
name|SET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|WorkSpace_Length
argument_list|,
operator|(
name|GET32
argument_list|(
name|sample
argument_list|,
name|hdr
operator|->
name|WorkSpace_Length
argument_list|)
operator|*
name|sample
operator|->
name|sectorsize
operator|+
name|ss
operator|-
literal|1
operator|)
operator|/
name|ss
argument_list|)
expr_stmt|;
name|SET16
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|Configuration_Record_Length
argument_list|,
operator|(
name|GET16
argument_list|(
name|sample
argument_list|,
name|hdr
operator|->
name|Configuration_Record_Length
argument_list|)
operator|*
name|sample
operator|->
name|sectorsize
operator|+
name|ss
operator|-
literal|1
operator|)
operator|/
name|ss
argument_list|)
expr_stmt|;
name|SET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|cd_length
argument_list|,
operator|(
name|GET32
argument_list|(
name|sample
argument_list|,
name|hdr
operator|->
name|cd_length
argument_list|)
operator|*
name|sample
operator|->
name|sectorsize
operator|+
name|ss
operator|-
literal|1
operator|)
operator|/
name|ss
argument_list|)
expr_stmt|;
name|SET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|pdr_length
argument_list|,
operator|(
name|GET32
argument_list|(
name|sample
argument_list|,
name|hdr
operator|->
name|pdr_length
argument_list|)
operator|*
name|sample
operator|->
name|sectorsize
operator|+
name|ss
operator|-
literal|1
operator|)
operator|/
name|ss
argument_list|)
expr_stmt|;
name|SET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|vdr_length
argument_list|,
operator|(
name|GET32
argument_list|(
name|sample
argument_list|,
name|hdr
operator|->
name|vdr_length
argument_list|)
operator|*
name|sample
operator|->
name|sectorsize
operator|+
name|ss
operator|-
literal|1
operator|)
operator|/
name|ss
argument_list|)
expr_stmt|;
name|SET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|cr_length
argument_list|,
operator|(
name|GET32
argument_list|(
name|sample
argument_list|,
name|hdr
operator|->
name|cr_length
argument_list|)
operator|*
name|sample
operator|->
name|sectorsize
operator|+
name|ss
operator|-
literal|1
operator|)
operator|/
name|ss
argument_list|)
expr_stmt|;
name|SET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|pdd_length
argument_list|,
operator|(
name|GET32
argument_list|(
name|sample
argument_list|,
name|hdr
operator|->
name|pdd_length
argument_list|)
operator|*
name|sample
operator|->
name|sectorsize
operator|+
name|ss
operator|-
literal|1
operator|)
operator|/
name|ss
argument_list|)
expr_stmt|;
name|SET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|bbmlog_length
argument_list|,
operator|(
name|GET32
argument_list|(
name|sample
argument_list|,
name|hdr
operator|->
name|bbmlog_length
argument_list|)
operator|*
name|sample
operator|->
name|sectorsize
operator|+
name|ss
operator|-
literal|1
operator|)
operator|/
name|ss
argument_list|)
expr_stmt|;
name|SET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|Diagnostic_Space
argument_list|,
operator|(
name|GET32
argument_list|(
name|sample
argument_list|,
name|hdr
operator|->
name|bbmlog_length
argument_list|)
operator|*
name|sample
operator|->
name|sectorsize
operator|+
name|ss
operator|-
literal|1
operator|)
operator|/
name|ss
argument_list|)
expr_stmt|;
name|SET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|Vendor_Specific_Logs
argument_list|,
operator|(
name|GET32
argument_list|(
name|sample
argument_list|,
name|hdr
operator|->
name|bbmlog_length
argument_list|)
operator|*
name|sample
operator|->
name|sectorsize
operator|+
name|ss
operator|-
literal|1
operator|)
operator|/
name|ss
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|SET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|Signature
argument_list|,
name|DDF_HEADER_SIGNATURE
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|meta
operator|->
name|hdr
operator|->
name|DDF_Header_GUID
argument_list|,
literal|25
argument_list|,
literal|"FreeBSD %08x%08x"
argument_list|,
call|(
name|u_int
call|)
argument_list|(
name|ts
operator|.
name|tv_sec
operator|-
name|DECADE
argument_list|)
argument_list|,
name|arc4random
argument_list|()
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|meta
operator|->
name|hdr
operator|->
name|DDF_rev
argument_list|,
literal|"02.00.00"
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|SET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|TimeStamp
argument_list|,
operator|(
name|ts
operator|.
name|tv_sec
operator|-
name|DECADE
operator|)
argument_list|)
expr_stmt|;
name|SET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|WorkSpace_Length
argument_list|,
literal|16
operator|*
literal|1024
operator|*
literal|1024
operator|/
name|ss
argument_list|)
expr_stmt|;
name|SET16
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|Max_PD_Entries
argument_list|,
name|DDF_MAX_DISKS
operator|-
literal|1
argument_list|)
expr_stmt|;
name|SET16
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|Max_VD_Entries
argument_list|,
name|DDF_MAX_VDISKS
argument_list|)
expr_stmt|;
name|SET16
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|Max_Partitions
argument_list|,
name|DDF_MAX_PARTITIONS
argument_list|)
expr_stmt|;
name|SET16
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|Max_Primary_Element_Entries
argument_list|,
name|DDF_MAX_DISKS
argument_list|)
expr_stmt|;
name|SET16
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|Configuration_Record_Length
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|ddf_vdc_record
argument_list|)
operator|+
operator|(
literal|4
operator|+
literal|8
operator|)
operator|*
name|GET16
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|Max_Primary_Element_Entries
argument_list|)
operator|+
name|ss
operator|-
literal|1
operator|)
operator|/
name|ss
argument_list|)
expr_stmt|;
name|SET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|cd_length
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|ddf_cd_record
argument_list|)
operator|+
name|ss
operator|-
literal|1
operator|)
operator|/
name|ss
argument_list|)
expr_stmt|;
name|SET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|pdr_length
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|ddf_pd_record
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|ddf_pd_entry
argument_list|)
operator|*
name|GET16
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|Max_PD_Entries
argument_list|)
operator|+
name|ss
operator|-
literal|1
operator|)
operator|/
name|ss
argument_list|)
expr_stmt|;
name|SET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|vdr_length
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|ddf_vd_record
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|ddf_vd_entry
argument_list|)
operator|*
name|GET16
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|Max_VD_Entries
argument_list|)
operator|+
name|ss
operator|-
literal|1
operator|)
operator|/
name|ss
argument_list|)
expr_stmt|;
name|SET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|cr_length
argument_list|,
name|GET16
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|Configuration_Record_Length
argument_list|)
operator|*
operator|(
name|GET16
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|Max_Partitions
argument_list|)
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
name|SET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|pdd_length
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|ddf_pdd_record
argument_list|)
operator|+
name|ss
operator|-
literal|1
operator|)
operator|/
name|ss
argument_list|)
expr_stmt|;
name|SET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|bbmlog_length
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|SET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|Diagnostic_Space_Length
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|SET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|Vendor_Specific_Logs_Length
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|pos
operator|=
literal|1
expr_stmt|;
name|SET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|cd_section
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|cd_length
argument_list|)
expr_stmt|;
name|SET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|pdr_section
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|pdr_length
argument_list|)
expr_stmt|;
name|SET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|vdr_section
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|vdr_length
argument_list|)
expr_stmt|;
name|SET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|cr_section
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|cr_length
argument_list|)
expr_stmt|;
name|SET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|pdd_section
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|pdd_length
argument_list|)
expr_stmt|;
name|SET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|bbmlog_section
argument_list|,
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|bbmlog_length
argument_list|)
operator|!=
literal|0
condition|?
name|pos
else|:
literal|0xffffffff
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|bbmlog_length
argument_list|)
expr_stmt|;
name|SET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|Diagnostic_Space
argument_list|,
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|Diagnostic_Space_Length
argument_list|)
operator|!=
literal|0
condition|?
name|pos
else|:
literal|0xffffffff
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|Diagnostic_Space_Length
argument_list|)
expr_stmt|;
name|SET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|Vendor_Specific_Logs
argument_list|,
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|Vendor_Specific_Logs_Length
argument_list|)
operator|!=
literal|0
condition|?
name|pos
else|:
literal|0xffffffff
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|min
argument_list|(
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|Vendor_Specific_Logs_Length
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|SET64
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|Primary_Header_LBA
argument_list|,
name|anchorlba
operator|-
name|pos
argument_list|)
expr_stmt|;
name|SET64
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|Secondary_Header_LBA
argument_list|,
literal|0xffffffffffffffffULL
argument_list|)
expr_stmt|;
name|SET64
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|WorkSpace_LBA
argument_list|,
name|anchorlba
operator|+
literal|1
operator|-
literal|32
operator|*
literal|1024
operator|*
literal|1024
operator|/
name|ss
argument_list|)
expr_stmt|;
comment|/* Controller Data */
name|size
operator|=
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|cd_length
argument_list|)
operator|*
name|ss
expr_stmt|;
name|meta
operator|->
name|cdr
operator|=
name|malloc
argument_list|(
name|size
argument_list|,
name|M_MD_DDF
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|meta
operator|->
name|cdr
argument_list|,
literal|0xff
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|SET32
argument_list|(
name|meta
argument_list|,
name|cdr
operator|->
name|Signature
argument_list|,
name|DDF_CONTROLLER_DATA_SIGNATURE
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|meta
operator|->
name|cdr
operator|->
name|Controller_GUID
argument_list|,
literal|"FreeBSD GEOM RAID SERIAL"
argument_list|,
literal|24
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|meta
operator|->
name|cdr
operator|->
name|Product_ID
argument_list|,
literal|"FreeBSD GEOMRAID"
argument_list|,
literal|16
argument_list|)
expr_stmt|;
comment|/* Physical Drive Records. */
name|size
operator|=
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|pdr_length
argument_list|)
operator|*
name|ss
expr_stmt|;
name|meta
operator|->
name|pdr
operator|=
name|malloc
argument_list|(
name|size
argument_list|,
name|M_MD_DDF
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|meta
operator|->
name|pdr
argument_list|,
literal|0xff
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|SET32
argument_list|(
name|meta
argument_list|,
name|pdr
operator|->
name|Signature
argument_list|,
name|DDF_PDR_SIGNATURE
argument_list|)
expr_stmt|;
name|SET16
argument_list|(
name|meta
argument_list|,
name|pdr
operator|->
name|Populated_PDEs
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|SET16
argument_list|(
name|meta
argument_list|,
name|pdr
operator|->
name|Max_PDE_Supported
argument_list|,
name|GET16
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|Max_PD_Entries
argument_list|)
argument_list|)
expr_stmt|;
name|pde
operator|=
operator|&
name|meta
operator|->
name|pdr
operator|->
name|entry
index|[
literal|0
index|]
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
name|serial_buffer
argument_list|)
expr_stmt|;
name|error
operator|=
name|g_io_getattr
argument_list|(
literal|"GEOM::ident"
argument_list|,
name|disk
operator|->
name|d_consumer
argument_list|,
operator|&
name|len
argument_list|,
name|serial_buffer
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
operator|&&
operator|(
name|len
operator|=
name|strlen
argument_list|(
name|serial_buffer
argument_list|)
operator|)
operator|>=
literal|6
operator|&&
name|len
operator|<=
literal|20
condition|)
name|snprintf
argument_list|(
name|pde
operator|->
name|PD_GUID
argument_list|,
literal|25
argument_list|,
literal|"DISK%20s"
argument_list|,
name|serial_buffer
argument_list|)
expr_stmt|;
else|else
name|snprintf
argument_list|(
name|pde
operator|->
name|PD_GUID
argument_list|,
literal|25
argument_list|,
literal|"DISK%04d%02d%02d%08x%04x"
argument_list|,
name|ct
operator|.
name|year
argument_list|,
name|ct
operator|.
name|mon
argument_list|,
name|ct
operator|.
name|day
argument_list|,
name|arc4random
argument_list|()
argument_list|,
name|arc4random
argument_list|()
operator|&
literal|0xffff
argument_list|)
expr_stmt|;
name|SET32D
argument_list|(
name|meta
argument_list|,
name|pde
operator|->
name|PD_Reference
argument_list|,
name|arc4random
argument_list|()
argument_list|)
expr_stmt|;
name|SET16D
argument_list|(
name|meta
argument_list|,
name|pde
operator|->
name|PD_Type
argument_list|,
name|DDF_PDE_GUID_FORCE
argument_list|)
expr_stmt|;
name|SET16D
argument_list|(
name|meta
argument_list|,
name|pde
operator|->
name|PD_State
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|SET64D
argument_list|(
name|meta
argument_list|,
name|pde
operator|->
name|Configured_Size
argument_list|,
name|anchorlba
operator|+
literal|1
operator|-
literal|32
operator|*
literal|1024
operator|*
literal|1024
operator|/
name|ss
argument_list|)
expr_stmt|;
name|SET16D
argument_list|(
name|meta
argument_list|,
name|pde
operator|->
name|Block_Size
argument_list|,
name|ss
argument_list|)
expr_stmt|;
comment|/* Virtual Drive Records. */
name|size
operator|=
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|vdr_length
argument_list|)
operator|*
name|ss
expr_stmt|;
name|meta
operator|->
name|vdr
operator|=
name|malloc
argument_list|(
name|size
argument_list|,
name|M_MD_DDF
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|meta
operator|->
name|vdr
argument_list|,
literal|0xff
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|SET32
argument_list|(
name|meta
argument_list|,
name|vdr
operator|->
name|Signature
argument_list|,
name|DDF_VD_RECORD_SIGNATURE
argument_list|)
expr_stmt|;
name|SET32
argument_list|(
name|meta
argument_list|,
name|vdr
operator|->
name|Populated_VDEs
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|SET16
argument_list|(
name|meta
argument_list|,
name|vdr
operator|->
name|Max_VDE_Supported
argument_list|,
name|GET16
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|Max_VD_Entries
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Configuration Records. */
name|size
operator|=
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|cr_length
argument_list|)
operator|*
name|ss
expr_stmt|;
name|meta
operator|->
name|cr
operator|=
name|malloc
argument_list|(
name|size
argument_list|,
name|M_MD_DDF
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|meta
operator|->
name|cr
argument_list|,
literal|0xff
argument_list|,
name|size
argument_list|)
expr_stmt|;
comment|/* Physical Disk Data. */
name|size
operator|=
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|pdd_length
argument_list|)
operator|*
name|ss
expr_stmt|;
name|meta
operator|->
name|pdd
operator|=
name|malloc
argument_list|(
name|size
argument_list|,
name|M_MD_DDF
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|meta
operator|->
name|pdd
argument_list|,
literal|0xff
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|SET32
argument_list|(
name|meta
argument_list|,
name|pdd
operator|->
name|Signature
argument_list|,
name|DDF_PDD_SIGNATURE
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|meta
operator|->
name|pdd
operator|->
name|PD_GUID
argument_list|,
name|pde
operator|->
name|PD_GUID
argument_list|,
literal|24
argument_list|)
expr_stmt|;
name|SET32
argument_list|(
name|meta
argument_list|,
name|pdd
operator|->
name|PD_Reference
argument_list|,
name|GET32D
argument_list|(
name|meta
argument_list|,
name|pde
operator|->
name|PD_Reference
argument_list|)
argument_list|)
expr_stmt|;
name|SET8
argument_list|(
name|meta
argument_list|,
name|pdd
operator|->
name|Forced_Ref_Flag
argument_list|,
name|DDF_PDD_FORCED_REF
argument_list|)
expr_stmt|;
name|SET8
argument_list|(
name|meta
argument_list|,
name|pdd
operator|->
name|Forced_PD_GUID_Flag
argument_list|,
name|DDF_PDD_FORCED_GUID
argument_list|)
expr_stmt|;
comment|/* Bad Block Management Log. */
if|if
condition|(
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|bbmlog_length
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|size
operator|=
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|bbmlog_length
argument_list|)
operator|*
name|ss
expr_stmt|;
name|meta
operator|->
name|bbm
operator|=
name|malloc
argument_list|(
name|size
argument_list|,
name|M_MD_DDF
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|meta
operator|->
name|bbm
argument_list|,
literal|0xff
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|SET32
argument_list|(
name|meta
argument_list|,
name|bbm
operator|->
name|Signature
argument_list|,
name|DDF_BBML_SIGNATURE
argument_list|)
expr_stmt|;
name|SET32
argument_list|(
name|meta
argument_list|,
name|bbm
operator|->
name|Entry_Count
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|SET32
argument_list|(
name|meta
argument_list|,
name|bbm
operator|->
name|Spare_Block_Count
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ddf_meta_copy
parameter_list|(
name|struct
name|ddf_meta
modifier|*
name|dst
parameter_list|,
name|struct
name|ddf_meta
modifier|*
name|src
parameter_list|)
block|{
name|struct
name|ddf_header
modifier|*
name|hdr
decl_stmt|;
name|u_int
name|ss
decl_stmt|;
name|hdr
operator|=
name|src
operator|->
name|hdr
expr_stmt|;
name|dst
operator|->
name|bigendian
operator|=
name|src
operator|->
name|bigendian
expr_stmt|;
name|ss
operator|=
name|dst
operator|->
name|sectorsize
operator|=
name|src
operator|->
name|sectorsize
expr_stmt|;
name|dst
operator|->
name|hdr
operator|=
name|malloc
argument_list|(
name|ss
argument_list|,
name|M_MD_DDF
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|dst
operator|->
name|hdr
argument_list|,
name|src
operator|->
name|hdr
argument_list|,
name|ss
argument_list|)
expr_stmt|;
name|dst
operator|->
name|cdr
operator|=
name|malloc
argument_list|(
name|GET32
argument_list|(
name|src
argument_list|,
name|hdr
operator|->
name|cd_length
argument_list|)
operator|*
name|ss
argument_list|,
name|M_MD_DDF
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|dst
operator|->
name|cdr
argument_list|,
name|src
operator|->
name|cdr
argument_list|,
name|GET32
argument_list|(
name|src
argument_list|,
name|hdr
operator|->
name|cd_length
argument_list|)
operator|*
name|ss
argument_list|)
expr_stmt|;
name|dst
operator|->
name|pdr
operator|=
name|malloc
argument_list|(
name|GET32
argument_list|(
name|src
argument_list|,
name|hdr
operator|->
name|pdr_length
argument_list|)
operator|*
name|ss
argument_list|,
name|M_MD_DDF
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|dst
operator|->
name|pdr
argument_list|,
name|src
operator|->
name|pdr
argument_list|,
name|GET32
argument_list|(
name|src
argument_list|,
name|hdr
operator|->
name|pdr_length
argument_list|)
operator|*
name|ss
argument_list|)
expr_stmt|;
name|dst
operator|->
name|vdr
operator|=
name|malloc
argument_list|(
name|GET32
argument_list|(
name|src
argument_list|,
name|hdr
operator|->
name|vdr_length
argument_list|)
operator|*
name|ss
argument_list|,
name|M_MD_DDF
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|dst
operator|->
name|vdr
argument_list|,
name|src
operator|->
name|vdr
argument_list|,
name|GET32
argument_list|(
name|src
argument_list|,
name|hdr
operator|->
name|vdr_length
argument_list|)
operator|*
name|ss
argument_list|)
expr_stmt|;
name|dst
operator|->
name|cr
operator|=
name|malloc
argument_list|(
name|GET32
argument_list|(
name|src
argument_list|,
name|hdr
operator|->
name|cr_length
argument_list|)
operator|*
name|ss
argument_list|,
name|M_MD_DDF
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|dst
operator|->
name|cr
argument_list|,
name|src
operator|->
name|cr
argument_list|,
name|GET32
argument_list|(
name|src
argument_list|,
name|hdr
operator|->
name|cr_length
argument_list|)
operator|*
name|ss
argument_list|)
expr_stmt|;
name|dst
operator|->
name|pdd
operator|=
name|malloc
argument_list|(
name|GET32
argument_list|(
name|src
argument_list|,
name|hdr
operator|->
name|pdd_length
argument_list|)
operator|*
name|ss
argument_list|,
name|M_MD_DDF
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|dst
operator|->
name|pdd
argument_list|,
name|src
operator|->
name|pdd
argument_list|,
name|GET32
argument_list|(
name|src
argument_list|,
name|hdr
operator|->
name|pdd_length
argument_list|)
operator|*
name|ss
argument_list|)
expr_stmt|;
if|if
condition|(
name|src
operator|->
name|bbm
operator|!=
name|NULL
condition|)
block|{
name|dst
operator|->
name|bbm
operator|=
name|malloc
argument_list|(
name|GET32
argument_list|(
name|src
argument_list|,
name|hdr
operator|->
name|bbmlog_length
argument_list|)
operator|*
name|ss
argument_list|,
name|M_MD_DDF
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|dst
operator|->
name|bbm
argument_list|,
name|src
operator|->
name|bbm
argument_list|,
name|GET32
argument_list|(
name|src
argument_list|,
name|hdr
operator|->
name|bbmlog_length
argument_list|)
operator|*
name|ss
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ddf_meta_update
parameter_list|(
name|struct
name|ddf_meta
modifier|*
name|meta
parameter_list|,
name|struct
name|ddf_meta
modifier|*
name|src
parameter_list|)
block|{
name|struct
name|ddf_pd_entry
modifier|*
name|pde
decl_stmt|,
modifier|*
name|spde
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|GET16
argument_list|(
name|src
argument_list|,
name|pdr
operator|->
name|Populated_PDEs
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|spde
operator|=
operator|&
name|src
operator|->
name|pdr
operator|->
name|entry
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|isff
argument_list|(
name|spde
operator|->
name|PD_GUID
argument_list|,
literal|24
argument_list|)
condition|)
continue|continue;
name|j
operator|=
name|ddf_meta_find_pd
argument_list|(
name|meta
argument_list|,
name|NULL
argument_list|,
name|GET32
argument_list|(
name|src
argument_list|,
name|pdr
operator|->
name|entry
index|[
name|i
index|]
operator|.
name|PD_Reference
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|j
operator|<
literal|0
condition|)
block|{
name|j
operator|=
name|ddf_meta_find_pd
argument_list|(
name|meta
argument_list|,
name|NULL
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|pde
operator|=
operator|&
name|meta
operator|->
name|pdr
operator|->
name|entry
index|[
name|j
index|]
expr_stmt|;
name|memcpy
argument_list|(
name|pde
argument_list|,
name|spde
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|pde
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|pde
operator|=
operator|&
name|meta
operator|->
name|pdr
operator|->
name|entry
index|[
name|j
index|]
expr_stmt|;
name|SET16D
argument_list|(
name|meta
argument_list|,
name|pde
operator|->
name|PD_State
argument_list|,
name|GET16D
argument_list|(
name|meta
argument_list|,
name|pde
operator|->
name|PD_State
argument_list|)
operator||
name|GET16D
argument_list|(
name|src
argument_list|,
name|pde
operator|->
name|PD_State
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ddf_meta_free
parameter_list|(
name|struct
name|ddf_meta
modifier|*
name|meta
parameter_list|)
block|{
if|if
condition|(
name|meta
operator|->
name|hdr
operator|!=
name|NULL
condition|)
block|{
name|free
argument_list|(
name|meta
operator|->
name|hdr
argument_list|,
name|M_MD_DDF
argument_list|)
expr_stmt|;
name|meta
operator|->
name|hdr
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|meta
operator|->
name|cdr
operator|!=
name|NULL
condition|)
block|{
name|free
argument_list|(
name|meta
operator|->
name|cdr
argument_list|,
name|M_MD_DDF
argument_list|)
expr_stmt|;
name|meta
operator|->
name|cdr
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|meta
operator|->
name|pdr
operator|!=
name|NULL
condition|)
block|{
name|free
argument_list|(
name|meta
operator|->
name|pdr
argument_list|,
name|M_MD_DDF
argument_list|)
expr_stmt|;
name|meta
operator|->
name|pdr
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|meta
operator|->
name|vdr
operator|!=
name|NULL
condition|)
block|{
name|free
argument_list|(
name|meta
operator|->
name|vdr
argument_list|,
name|M_MD_DDF
argument_list|)
expr_stmt|;
name|meta
operator|->
name|vdr
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|meta
operator|->
name|cr
operator|!=
name|NULL
condition|)
block|{
name|free
argument_list|(
name|meta
operator|->
name|cr
argument_list|,
name|M_MD_DDF
argument_list|)
expr_stmt|;
name|meta
operator|->
name|cr
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|meta
operator|->
name|pdd
operator|!=
name|NULL
condition|)
block|{
name|free
argument_list|(
name|meta
operator|->
name|pdd
argument_list|,
name|M_MD_DDF
argument_list|)
expr_stmt|;
name|meta
operator|->
name|pdd
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|meta
operator|->
name|bbm
operator|!=
name|NULL
condition|)
block|{
name|free
argument_list|(
name|meta
operator|->
name|bbm
argument_list|,
name|M_MD_DDF
argument_list|)
expr_stmt|;
name|meta
operator|->
name|bbm
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ddf_vol_meta_create
parameter_list|(
name|struct
name|ddf_vol_meta
modifier|*
name|meta
parameter_list|,
name|struct
name|ddf_meta
modifier|*
name|sample
parameter_list|)
block|{
name|struct
name|timespec
name|ts
decl_stmt|;
name|struct
name|clocktime
name|ct
decl_stmt|;
name|struct
name|ddf_header
modifier|*
name|hdr
decl_stmt|;
name|u_int
name|ss
decl_stmt|,
name|size
decl_stmt|;
name|hdr
operator|=
name|sample
operator|->
name|hdr
expr_stmt|;
name|meta
operator|->
name|bigendian
operator|=
name|sample
operator|->
name|bigendian
expr_stmt|;
name|ss
operator|=
name|meta
operator|->
name|sectorsize
operator|=
name|sample
operator|->
name|sectorsize
expr_stmt|;
name|meta
operator|->
name|hdr
operator|=
name|malloc
argument_list|(
name|ss
argument_list|,
name|M_MD_DDF
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|meta
operator|->
name|hdr
argument_list|,
name|sample
operator|->
name|hdr
argument_list|,
name|ss
argument_list|)
expr_stmt|;
name|meta
operator|->
name|cdr
operator|=
name|malloc
argument_list|(
name|GET32
argument_list|(
name|sample
argument_list|,
name|hdr
operator|->
name|cd_length
argument_list|)
operator|*
name|ss
argument_list|,
name|M_MD_DDF
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|meta
operator|->
name|cdr
argument_list|,
name|sample
operator|->
name|cdr
argument_list|,
name|GET32
argument_list|(
name|sample
argument_list|,
name|hdr
operator|->
name|cd_length
argument_list|)
operator|*
name|ss
argument_list|)
expr_stmt|;
name|meta
operator|->
name|vde
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|ddf_vd_entry
argument_list|)
argument_list|,
name|M_MD_DDF
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|meta
operator|->
name|vde
argument_list|,
literal|0xff
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ddf_vd_entry
argument_list|)
argument_list|)
expr_stmt|;
name|getnanotime
argument_list|(
operator|&
name|ts
argument_list|)
expr_stmt|;
name|clock_ts_to_ct
argument_list|(
operator|&
name|ts
argument_list|,
operator|&
name|ct
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|meta
operator|->
name|vde
operator|->
name|VD_GUID
argument_list|,
literal|25
argument_list|,
literal|"FreeBSD%04d%02d%02d%08x%01x"
argument_list|,
name|ct
operator|.
name|year
argument_list|,
name|ct
operator|.
name|mon
argument_list|,
name|ct
operator|.
name|day
argument_list|,
name|arc4random
argument_list|()
argument_list|,
name|arc4random
argument_list|()
operator|&
literal|0xf
argument_list|)
expr_stmt|;
name|size
operator|=
name|GET16
argument_list|(
name|sample
argument_list|,
name|hdr
operator|->
name|Configuration_Record_Length
argument_list|)
operator|*
name|ss
expr_stmt|;
name|meta
operator|->
name|vdc
operator|=
name|malloc
argument_list|(
name|size
argument_list|,
name|M_MD_DDF
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|meta
operator|->
name|vdc
argument_list|,
literal|0xff
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|SET32
argument_list|(
name|meta
argument_list|,
name|vdc
operator|->
name|Signature
argument_list|,
name|DDF_VDCR_SIGNATURE
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|meta
operator|->
name|vdc
operator|->
name|VD_GUID
argument_list|,
name|meta
operator|->
name|vde
operator|->
name|VD_GUID
argument_list|,
literal|24
argument_list|)
expr_stmt|;
name|SET32
argument_list|(
name|meta
argument_list|,
name|vdc
operator|->
name|Sequence_Number
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ddf_vol_meta_update
parameter_list|(
name|struct
name|ddf_vol_meta
modifier|*
name|dst
parameter_list|,
name|struct
name|ddf_meta
modifier|*
name|src
parameter_list|,
name|uint8_t
modifier|*
name|GUID
parameter_list|,
name|int
name|started
parameter_list|)
block|{
name|struct
name|ddf_header
modifier|*
name|hdr
decl_stmt|;
name|struct
name|ddf_vd_entry
modifier|*
name|vde
decl_stmt|;
name|struct
name|ddf_vdc_record
modifier|*
name|vdc
decl_stmt|;
name|int
name|vnew
decl_stmt|,
name|bvnew
decl_stmt|,
name|bvd
decl_stmt|,
name|size
decl_stmt|;
name|u_int
name|ss
decl_stmt|;
name|hdr
operator|=
name|src
operator|->
name|hdr
expr_stmt|;
name|vde
operator|=
operator|&
name|src
operator|->
name|vdr
operator|->
name|entry
index|[
name|ddf_meta_find_vd
argument_list|(
name|src
argument_list|,
name|GUID
argument_list|)
index|]
expr_stmt|;
name|vdc
operator|=
name|ddf_meta_find_vdc
argument_list|(
name|src
argument_list|,
name|GUID
argument_list|)
expr_stmt|;
if|if
condition|(
name|GET8D
argument_list|(
name|src
argument_list|,
name|vdc
operator|->
name|Secondary_Element_Count
argument_list|)
operator|==
literal|1
condition|)
name|bvd
operator|=
literal|0
expr_stmt|;
else|else
name|bvd
operator|=
name|GET8D
argument_list|(
name|src
argument_list|,
name|vdc
operator|->
name|Secondary_Element_Seq
argument_list|)
expr_stmt|;
name|size
operator|=
name|GET16
argument_list|(
name|src
argument_list|,
name|hdr
operator|->
name|Configuration_Record_Length
argument_list|)
operator|*
name|src
operator|->
name|sectorsize
expr_stmt|;
if|if
condition|(
name|dst
operator|->
name|vdc
operator|==
name|NULL
operator|||
operator|(
operator|!
name|started
operator|&&
operator|(
call|(
name|int32_t
call|)
argument_list|(
name|GET32D
argument_list|(
name|src
argument_list|,
name|vdc
operator|->
name|Sequence_Number
argument_list|)
operator|-
name|GET32
argument_list|(
name|dst
argument_list|,
name|vdc
operator|->
name|Sequence_Number
argument_list|)
argument_list|)
operator|)
operator|>
literal|0
operator|)
condition|)
name|vnew
operator|=
literal|1
expr_stmt|;
else|else
name|vnew
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|dst
operator|->
name|bvdc
index|[
name|bvd
index|]
operator|==
name|NULL
operator|||
operator|(
operator|!
name|started
operator|&&
operator|(
call|(
name|int32_t
call|)
argument_list|(
name|GET32D
argument_list|(
name|src
argument_list|,
name|vdc
operator|->
name|Sequence_Number
argument_list|)
operator|-
name|GET32
argument_list|(
name|dst
argument_list|,
name|bvdc
index|[
name|bvd
index|]
operator|->
name|Sequence_Number
argument_list|)
argument_list|)
operator|)
operator|>
literal|0
operator|)
condition|)
name|bvnew
operator|=
literal|1
expr_stmt|;
else|else
name|bvnew
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|vnew
condition|)
block|{
name|dst
operator|->
name|bigendian
operator|=
name|src
operator|->
name|bigendian
expr_stmt|;
name|ss
operator|=
name|dst
operator|->
name|sectorsize
operator|=
name|src
operator|->
name|sectorsize
expr_stmt|;
if|if
condition|(
name|dst
operator|->
name|hdr
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|dst
operator|->
name|hdr
argument_list|,
name|M_MD_DDF
argument_list|)
expr_stmt|;
name|dst
operator|->
name|hdr
operator|=
name|malloc
argument_list|(
name|ss
argument_list|,
name|M_MD_DDF
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|dst
operator|->
name|hdr
argument_list|,
name|src
operator|->
name|hdr
argument_list|,
name|ss
argument_list|)
expr_stmt|;
if|if
condition|(
name|dst
operator|->
name|cdr
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|dst
operator|->
name|cdr
argument_list|,
name|M_MD_DDF
argument_list|)
expr_stmt|;
name|dst
operator|->
name|cdr
operator|=
name|malloc
argument_list|(
name|GET32
argument_list|(
name|src
argument_list|,
name|hdr
operator|->
name|cd_length
argument_list|)
operator|*
name|ss
argument_list|,
name|M_MD_DDF
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|dst
operator|->
name|cdr
argument_list|,
name|src
operator|->
name|cdr
argument_list|,
name|GET32
argument_list|(
name|src
argument_list|,
name|hdr
operator|->
name|cd_length
argument_list|)
operator|*
name|ss
argument_list|)
expr_stmt|;
if|if
condition|(
name|dst
operator|->
name|vde
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|dst
operator|->
name|vde
argument_list|,
name|M_MD_DDF
argument_list|)
expr_stmt|;
name|dst
operator|->
name|vde
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|ddf_vd_entry
argument_list|)
argument_list|,
name|M_MD_DDF
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|dst
operator|->
name|vde
argument_list|,
name|vde
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ddf_vd_entry
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dst
operator|->
name|vdc
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|dst
operator|->
name|vdc
argument_list|,
name|M_MD_DDF
argument_list|)
expr_stmt|;
name|dst
operator|->
name|vdc
operator|=
name|malloc
argument_list|(
name|size
argument_list|,
name|M_MD_DDF
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|dst
operator|->
name|vdc
argument_list|,
name|vdc
argument_list|,
name|size
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|bvnew
condition|)
block|{
if|if
condition|(
name|dst
operator|->
name|bvdc
index|[
name|bvd
index|]
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|dst
operator|->
name|bvdc
index|[
name|bvd
index|]
argument_list|,
name|M_MD_DDF
argument_list|)
expr_stmt|;
name|dst
operator|->
name|bvdc
index|[
name|bvd
index|]
operator|=
name|malloc
argument_list|(
name|size
argument_list|,
name|M_MD_DDF
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|dst
operator|->
name|bvdc
index|[
name|bvd
index|]
argument_list|,
name|vdc
argument_list|,
name|size
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ddf_vol_meta_free
parameter_list|(
name|struct
name|ddf_vol_meta
modifier|*
name|meta
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|meta
operator|->
name|hdr
operator|!=
name|NULL
condition|)
block|{
name|free
argument_list|(
name|meta
operator|->
name|hdr
argument_list|,
name|M_MD_DDF
argument_list|)
expr_stmt|;
name|meta
operator|->
name|hdr
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|meta
operator|->
name|cdr
operator|!=
name|NULL
condition|)
block|{
name|free
argument_list|(
name|meta
operator|->
name|cdr
argument_list|,
name|M_MD_DDF
argument_list|)
expr_stmt|;
name|meta
operator|->
name|cdr
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|meta
operator|->
name|vde
operator|!=
name|NULL
condition|)
block|{
name|free
argument_list|(
name|meta
operator|->
name|vde
argument_list|,
name|M_MD_DDF
argument_list|)
expr_stmt|;
name|meta
operator|->
name|vde
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|meta
operator|->
name|vdc
operator|!=
name|NULL
condition|)
block|{
name|free
argument_list|(
name|meta
operator|->
name|vdc
argument_list|,
name|M_MD_DDF
argument_list|)
expr_stmt|;
name|meta
operator|->
name|vdc
operator|=
name|NULL
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|DDF_MAX_DISKS_HARD
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|meta
operator|->
name|bvdc
index|[
name|i
index|]
operator|!=
name|NULL
condition|)
block|{
name|free
argument_list|(
name|meta
operator|->
name|bvdc
index|[
name|i
index|]
argument_list|,
name|M_MD_DDF
argument_list|)
expr_stmt|;
name|meta
operator|->
name|bvdc
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|ddf_meta_unused_range
parameter_list|(
name|struct
name|ddf_meta
modifier|*
name|meta
parameter_list|,
name|off_t
modifier|*
name|off
parameter_list|,
name|off_t
modifier|*
name|size
parameter_list|)
block|{
name|struct
name|ddf_vdc_record
modifier|*
name|vdc
decl_stmt|;
name|off_t
name|beg
index|[
literal|32
index|]
decl_stmt|,
name|end
index|[
literal|32
index|]
decl_stmt|,
name|beg1
decl_stmt|,
name|end1
decl_stmt|;
name|uint64_t
modifier|*
name|offp
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|n
decl_stmt|,
name|num
decl_stmt|,
name|pos
decl_stmt|;
name|uint32_t
name|ref
decl_stmt|;
operator|*
name|off
operator|=
literal|0
expr_stmt|;
operator|*
name|size
operator|=
literal|0
expr_stmt|;
name|ref
operator|=
name|GET32
argument_list|(
name|meta
argument_list|,
name|pdd
operator|->
name|PD_Reference
argument_list|)
expr_stmt|;
name|pos
operator|=
name|ddf_meta_find_pd
argument_list|(
name|meta
argument_list|,
name|NULL
argument_list|,
name|ref
argument_list|)
expr_stmt|;
name|beg
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|end
index|[
literal|0
index|]
operator|=
name|GET64
argument_list|(
name|meta
argument_list|,
name|pdr
operator|->
name|entry
index|[
name|pos
index|]
operator|.
name|Configured_Size
argument_list|)
expr_stmt|;
name|n
operator|=
literal|1
expr_stmt|;
name|num
operator|=
name|GETCRNUM
argument_list|(
name|meta
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num
condition|;
name|i
operator|++
control|)
block|{
name|vdc
operator|=
name|GETVDCPTR
argument_list|(
name|meta
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|GET32D
argument_list|(
name|meta
argument_list|,
name|vdc
operator|->
name|Signature
argument_list|)
operator|!=
name|DDF_VDCR_SIGNATURE
condition|)
continue|continue;
for|for
control|(
name|pos
operator|=
literal|0
init|;
name|pos
operator|<
name|GET16D
argument_list|(
name|meta
argument_list|,
name|vdc
operator|->
name|Primary_Element_Count
argument_list|)
condition|;
name|pos
operator|++
control|)
if|if
condition|(
name|GET32D
argument_list|(
name|meta
argument_list|,
name|vdc
operator|->
name|Physical_Disk_Sequence
index|[
name|pos
index|]
argument_list|)
operator|==
name|ref
condition|)
break|break;
if|if
condition|(
name|pos
operator|==
name|GET16D
argument_list|(
name|meta
argument_list|,
name|vdc
operator|->
name|Primary_Element_Count
argument_list|)
condition|)
continue|continue;
name|offp
operator|=
operator|(
name|uint64_t
operator|*
operator|)
operator|&
operator|(
name|vdc
operator|->
name|Physical_Disk_Sequence
index|[
name|GET16
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|Max_Primary_Element_Entries
argument_list|)
index|]
operator|)
expr_stmt|;
name|beg1
operator|=
name|GET64P
argument_list|(
name|meta
argument_list|,
name|offp
operator|+
name|pos
argument_list|)
expr_stmt|;
name|end1
operator|=
name|beg1
operator|+
name|GET64D
argument_list|(
name|meta
argument_list|,
name|vdc
operator|->
name|Block_Count
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|n
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|beg
index|[
name|j
index|]
operator|>=
name|end1
operator|||
name|end
index|[
name|j
index|]
operator|<=
name|beg1
condition|)
continue|continue;
if|if
condition|(
name|beg
index|[
name|j
index|]
operator|<
name|beg1
operator|&&
name|end
index|[
name|j
index|]
operator|>
name|end1
condition|)
block|{
name|beg
index|[
name|n
index|]
operator|=
name|end1
expr_stmt|;
name|end
index|[
name|n
index|]
operator|=
name|end
index|[
name|j
index|]
expr_stmt|;
name|end
index|[
name|j
index|]
operator|=
name|beg1
expr_stmt|;
name|n
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|beg
index|[
name|j
index|]
operator|<
name|beg1
condition|)
name|end
index|[
name|j
index|]
operator|=
name|beg1
expr_stmt|;
else|else
name|beg
index|[
name|j
index|]
operator|=
name|end1
expr_stmt|;
block|}
block|}
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|n
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|end
index|[
name|j
index|]
operator|-
name|beg
index|[
name|j
index|]
operator|>
operator|*
name|size
condition|)
block|{
operator|*
name|off
operator|=
name|beg
index|[
name|j
index|]
expr_stmt|;
operator|*
name|size
operator|=
name|end
index|[
name|j
index|]
operator|-
name|beg
index|[
name|j
index|]
expr_stmt|;
block|}
block|}
return|return
operator|(
operator|(
operator|*
name|size
operator|>
literal|0
operator|)
condition|?
literal|1
else|:
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ddf_meta_get_name
parameter_list|(
name|struct
name|ddf_meta
modifier|*
name|meta
parameter_list|,
name|int
name|num
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|b
decl_stmt|;
name|int
name|i
decl_stmt|;
name|b
operator|=
name|meta
operator|->
name|vdr
operator|->
name|entry
index|[
name|num
index|]
operator|.
name|VD_Name
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|15
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
if|if
condition|(
name|b
index|[
name|i
index|]
operator|!=
literal|0x20
condition|)
break|break;
name|memcpy
argument_list|(
name|buf
argument_list|,
name|b
argument_list|,
name|i
operator|+
literal|1
argument_list|)
expr_stmt|;
name|buf
index|[
name|i
operator|+
literal|1
index|]
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ddf_meta_put_name
parameter_list|(
name|struct
name|ddf_vol_meta
modifier|*
name|meta
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|int
name|len
decl_stmt|;
name|len
operator|=
name|min
argument_list|(
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|meta
operator|->
name|vde
operator|->
name|VD_Name
argument_list|,
literal|0x20
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|meta
operator|->
name|vde
operator|->
name|VD_Name
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|ddf_meta_read
parameter_list|(
name|struct
name|g_consumer
modifier|*
name|cp
parameter_list|,
name|struct
name|ddf_meta
modifier|*
name|meta
parameter_list|)
block|{
name|struct
name|g_provider
modifier|*
name|pp
decl_stmt|;
name|struct
name|ddf_header
modifier|*
name|ahdr
decl_stmt|,
modifier|*
name|hdr
decl_stmt|;
name|char
modifier|*
name|abuf
decl_stmt|,
modifier|*
name|buf
decl_stmt|;
name|off_t
name|plba
decl_stmt|,
name|slba
decl_stmt|,
name|lba
decl_stmt|;
name|int
name|error
decl_stmt|,
name|len
decl_stmt|,
name|i
decl_stmt|;
name|u_int
name|ss
decl_stmt|;
name|uint32_t
name|val
decl_stmt|;
name|ddf_meta_free
argument_list|(
name|meta
argument_list|)
expr_stmt|;
name|pp
operator|=
name|cp
operator|->
name|provider
expr_stmt|;
name|ss
operator|=
name|meta
operator|->
name|sectorsize
operator|=
name|pp
operator|->
name|sectorsize
expr_stmt|;
comment|/* Read anchor block. */
name|abuf
operator|=
name|g_read_data
argument_list|(
name|cp
argument_list|,
name|pp
operator|->
name|mediasize
operator|-
name|ss
argument_list|,
name|ss
argument_list|,
operator|&
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
name|abuf
operator|==
name|NULL
condition|)
block|{
name|G_RAID_DEBUG
argument_list|(
literal|1
argument_list|,
literal|"Cannot read metadata from %s (error=%d)."
argument_list|,
name|pp
operator|->
name|name
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|ahdr
operator|=
operator|(
expr|struct
name|ddf_header
operator|*
operator|)
name|abuf
expr_stmt|;
comment|/* Check if this is an DDF RAID struct */
if|if
condition|(
name|be32dec
argument_list|(
operator|&
name|ahdr
operator|->
name|Signature
argument_list|)
operator|==
name|DDF_HEADER_SIGNATURE
condition|)
name|meta
operator|->
name|bigendian
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|le32dec
argument_list|(
operator|&
name|ahdr
operator|->
name|Signature
argument_list|)
operator|==
name|DDF_HEADER_SIGNATURE
condition|)
name|meta
operator|->
name|bigendian
operator|=
literal|0
expr_stmt|;
else|else
block|{
name|G_RAID_DEBUG
argument_list|(
literal|1
argument_list|,
literal|"DDF signature check failed on %s"
argument_list|,
name|pp
operator|->
name|name
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|ahdr
operator|->
name|Header_Type
operator|!=
name|DDF_HEADER_ANCHOR
condition|)
block|{
name|G_RAID_DEBUG
argument_list|(
literal|1
argument_list|,
literal|"DDF header type check failed on %s"
argument_list|,
name|pp
operator|->
name|name
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|meta
operator|->
name|hdr
operator|=
name|ahdr
expr_stmt|;
name|plba
operator|=
name|GET64
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|Primary_Header_LBA
argument_list|)
expr_stmt|;
name|slba
operator|=
name|GET64
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|Secondary_Header_LBA
argument_list|)
expr_stmt|;
name|val
operator|=
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|CRC
argument_list|)
expr_stmt|;
name|SET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|CRC
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|meta
operator|->
name|hdr
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|crc32
argument_list|(
name|ahdr
argument_list|,
name|ss
argument_list|)
operator|!=
name|val
condition|)
block|{
name|G_RAID_DEBUG
argument_list|(
literal|1
argument_list|,
literal|"DDF CRC mismatch on %s"
argument_list|,
name|pp
operator|->
name|name
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
operator|(
name|plba
operator|+
literal|6
operator|)
operator|*
name|ss
operator|>=
name|pp
operator|->
name|mediasize
condition|)
block|{
name|G_RAID_DEBUG
argument_list|(
literal|1
argument_list|,
literal|"DDF primary header LBA is wrong on %s"
argument_list|,
name|pp
operator|->
name|name
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|slba
operator|!=
operator|-
literal|1
operator|&&
operator|(
name|slba
operator|+
literal|6
operator|)
operator|*
name|ss
operator|>=
name|pp
operator|->
name|mediasize
condition|)
block|{
name|G_RAID_DEBUG
argument_list|(
literal|1
argument_list|,
literal|"DDF secondary header LBA is wrong on %s"
argument_list|,
name|pp
operator|->
name|name
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|lba
operator|=
name|plba
expr_stmt|;
name|doread
label|:
name|error
operator|=
literal|0
expr_stmt|;
name|ddf_meta_free
argument_list|(
name|meta
argument_list|)
expr_stmt|;
comment|/* Read header block. */
name|buf
operator|=
name|g_read_data
argument_list|(
name|cp
argument_list|,
name|lba
operator|*
name|ss
argument_list|,
name|ss
argument_list|,
operator|&
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
block|{
name|readerror
label|:
name|G_RAID_DEBUG
argument_list|(
literal|1
argument_list|,
literal|"DDF %s metadata read error on %s (error=%d)."
argument_list|,
operator|(
name|lba
operator|==
name|plba
operator|)
condition|?
literal|"primary"
else|:
literal|"secondary"
argument_list|,
name|pp
operator|->
name|name
argument_list|,
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
name|lba
operator|==
name|plba
operator|&&
name|slba
operator|!=
operator|-
literal|1
condition|)
block|{
name|lba
operator|=
name|slba
expr_stmt|;
goto|goto
name|doread
goto|;
block|}
name|G_RAID_DEBUG
argument_list|(
literal|1
argument_list|,
literal|"DDF metadata read error on %s."
argument_list|,
name|pp
operator|->
name|name
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|meta
operator|->
name|hdr
operator|=
name|malloc
argument_list|(
name|ss
argument_list|,
name|M_MD_DDF
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|meta
operator|->
name|hdr
argument_list|,
name|buf
argument_list|,
name|ss
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|hdr
operator|=
name|meta
operator|->
name|hdr
expr_stmt|;
name|val
operator|=
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|CRC
argument_list|)
expr_stmt|;
name|SET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|CRC
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
if|if
condition|(
name|hdr
operator|->
name|Signature
operator|!=
name|ahdr
operator|->
name|Signature
operator|||
name|crc32
argument_list|(
name|meta
operator|->
name|hdr
argument_list|,
name|ss
argument_list|)
operator|!=
name|val
operator|||
name|memcmp
argument_list|(
name|hdr
operator|->
name|DDF_Header_GUID
argument_list|,
name|ahdr
operator|->
name|DDF_Header_GUID
argument_list|,
literal|24
argument_list|)
operator|||
name|GET64
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|Primary_Header_LBA
argument_list|)
operator|!=
name|plba
operator|||
name|GET64
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|Secondary_Header_LBA
argument_list|)
operator|!=
name|slba
condition|)
block|{
name|hdrerror
label|:
name|G_RAID_DEBUG
argument_list|(
literal|1
argument_list|,
literal|"DDF %s metadata check failed on %s"
argument_list|,
operator|(
name|lba
operator|==
name|plba
operator|)
condition|?
literal|"primary"
else|:
literal|"secondary"
argument_list|,
name|pp
operator|->
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|lba
operator|==
name|plba
operator|&&
name|slba
operator|!=
operator|-
literal|1
condition|)
block|{
name|lba
operator|=
name|slba
expr_stmt|;
goto|goto
name|doread
goto|;
block|}
name|G_RAID_DEBUG
argument_list|(
literal|1
argument_list|,
literal|"DDF metadata check failed on %s"
argument_list|,
name|pp
operator|->
name|name
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
operator|(
name|lba
operator|==
name|plba
operator|&&
name|hdr
operator|->
name|Header_Type
operator|!=
name|DDF_HEADER_PRIMARY
operator|)
operator|||
operator|(
name|lba
operator|==
name|slba
operator|&&
name|hdr
operator|->
name|Header_Type
operator|!=
name|DDF_HEADER_SECONDARY
operator|)
condition|)
goto|goto
name|hdrerror
goto|;
name|len
operator|=
literal|1
expr_stmt|;
name|len
operator|=
name|max
argument_list|(
name|len
argument_list|,
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|cd_section
argument_list|)
operator|+
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|cd_length
argument_list|)
argument_list|)
expr_stmt|;
name|len
operator|=
name|max
argument_list|(
name|len
argument_list|,
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|pdr_section
argument_list|)
operator|+
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|pdr_length
argument_list|)
argument_list|)
expr_stmt|;
name|len
operator|=
name|max
argument_list|(
name|len
argument_list|,
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|vdr_section
argument_list|)
operator|+
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|vdr_length
argument_list|)
argument_list|)
expr_stmt|;
name|len
operator|=
name|max
argument_list|(
name|len
argument_list|,
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|cr_section
argument_list|)
operator|+
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|cr_length
argument_list|)
argument_list|)
expr_stmt|;
name|len
operator|=
name|max
argument_list|(
name|len
argument_list|,
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|pdd_section
argument_list|)
operator|+
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|pdd_length
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|val
operator|=
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|bbmlog_section
argument_list|)
operator|)
operator|!=
literal|0xffffffff
condition|)
name|len
operator|=
name|max
argument_list|(
name|len
argument_list|,
name|val
operator|+
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|bbmlog_length
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|val
operator|=
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|Diagnostic_Space
argument_list|)
operator|)
operator|!=
literal|0xffffffff
condition|)
name|len
operator|=
name|max
argument_list|(
name|len
argument_list|,
name|val
operator|+
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|Diagnostic_Space_Length
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|val
operator|=
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|Vendor_Specific_Logs
argument_list|)
operator|)
operator|!=
literal|0xffffffff
condition|)
name|len
operator|=
name|max
argument_list|(
name|len
argument_list|,
name|val
operator|+
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|Vendor_Specific_Logs_Length
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|plba
operator|+
name|len
operator|)
operator|*
name|ss
operator|>=
name|pp
operator|->
name|mediasize
condition|)
goto|goto
name|hdrerror
goto|;
if|if
condition|(
name|slba
operator|!=
operator|-
literal|1
operator|&&
operator|(
name|slba
operator|+
name|len
operator|)
operator|*
name|ss
operator|>=
name|pp
operator|->
name|mediasize
condition|)
goto|goto
name|hdrerror
goto|;
comment|/* Workaround for Adaptec implementation. */
if|if
condition|(
name|GET16
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|Max_Primary_Element_Entries
argument_list|)
operator|==
literal|0xffff
condition|)
block|{
name|SET16
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|Max_Primary_Element_Entries
argument_list|,
name|min
argument_list|(
name|GET16
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|Max_PD_Entries
argument_list|)
argument_list|,
operator|(
name|GET16
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|Configuration_Record_Length
argument_list|)
operator|*
name|ss
operator|-
literal|512
operator|)
operator|/
literal|12
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* Read controller data. */
name|buf
operator|=
name|g_read_data
argument_list|(
name|cp
argument_list|,
operator|(
name|lba
operator|+
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|cd_section
argument_list|)
operator|)
operator|*
name|ss
argument_list|,
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|cd_length
argument_list|)
operator|*
name|ss
argument_list|,
operator|&
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
goto|goto
name|readerror
goto|;
name|meta
operator|->
name|cdr
operator|=
name|malloc
argument_list|(
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|cd_length
argument_list|)
operator|*
name|ss
argument_list|,
name|M_MD_DDF
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|meta
operator|->
name|cdr
argument_list|,
name|buf
argument_list|,
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|cd_length
argument_list|)
operator|*
name|ss
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|GET32
argument_list|(
name|meta
argument_list|,
name|cdr
operator|->
name|Signature
argument_list|)
operator|!=
name|DDF_CONTROLLER_DATA_SIGNATURE
condition|)
goto|goto
name|hdrerror
goto|;
comment|/* Read physical disk records. */
name|buf
operator|=
name|g_read_data
argument_list|(
name|cp
argument_list|,
operator|(
name|lba
operator|+
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|pdr_section
argument_list|)
operator|)
operator|*
name|ss
argument_list|,
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|pdr_length
argument_list|)
operator|*
name|ss
argument_list|,
operator|&
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
goto|goto
name|readerror
goto|;
name|meta
operator|->
name|pdr
operator|=
name|malloc
argument_list|(
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|pdr_length
argument_list|)
operator|*
name|ss
argument_list|,
name|M_MD_DDF
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|meta
operator|->
name|pdr
argument_list|,
name|buf
argument_list|,
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|pdr_length
argument_list|)
operator|*
name|ss
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|GET32
argument_list|(
name|meta
argument_list|,
name|pdr
operator|->
name|Signature
argument_list|)
operator|!=
name|DDF_PDR_SIGNATURE
condition|)
goto|goto
name|hdrerror
goto|;
comment|/* 	 * Workaround for reading metadata corrupted due to graid bug. 	 * XXX: Remove this before we have disks above 128PB. :) 	 */
if|if
condition|(
name|meta
operator|->
name|bigendian
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|GET16
argument_list|(
name|meta
argument_list|,
name|pdr
operator|->
name|Populated_PDEs
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|isff
argument_list|(
name|meta
operator|->
name|pdr
operator|->
name|entry
index|[
name|i
index|]
operator|.
name|PD_GUID
argument_list|,
literal|24
argument_list|)
condition|)
continue|continue;
if|if
condition|(
name|GET32
argument_list|(
name|meta
argument_list|,
name|pdr
operator|->
name|entry
index|[
name|i
index|]
operator|.
name|PD_Reference
argument_list|)
operator|==
literal|0xffffffff
condition|)
continue|continue;
if|if
condition|(
name|GET64
argument_list|(
name|meta
argument_list|,
name|pdr
operator|->
name|entry
index|[
name|i
index|]
operator|.
name|Configured_Size
argument_list|)
operator|>=
operator|(
literal|1ULL
operator|<<
literal|48
operator|)
condition|)
block|{
name|SET16
argument_list|(
name|meta
argument_list|,
name|pdr
operator|->
name|entry
index|[
name|i
index|]
operator|.
name|PD_State
argument_list|,
name|GET16
argument_list|(
name|meta
argument_list|,
name|pdr
operator|->
name|entry
index|[
name|i
index|]
operator|.
name|PD_State
argument_list|)
operator|&
operator|~
name|DDF_PDE_FAILED
argument_list|)
expr_stmt|;
name|SET64
argument_list|(
name|meta
argument_list|,
name|pdr
operator|->
name|entry
index|[
name|i
index|]
operator|.
name|Configured_Size
argument_list|,
name|GET64
argument_list|(
name|meta
argument_list|,
name|pdr
operator|->
name|entry
index|[
name|i
index|]
operator|.
name|Configured_Size
argument_list|)
operator|&
operator|(
operator|(
literal|1ULL
operator|<<
literal|48
operator|)
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/* Read virtual disk records. */
name|buf
operator|=
name|g_read_data
argument_list|(
name|cp
argument_list|,
operator|(
name|lba
operator|+
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|vdr_section
argument_list|)
operator|)
operator|*
name|ss
argument_list|,
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|vdr_length
argument_list|)
operator|*
name|ss
argument_list|,
operator|&
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
goto|goto
name|readerror
goto|;
name|meta
operator|->
name|vdr
operator|=
name|malloc
argument_list|(
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|vdr_length
argument_list|)
operator|*
name|ss
argument_list|,
name|M_MD_DDF
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|meta
operator|->
name|vdr
argument_list|,
name|buf
argument_list|,
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|vdr_length
argument_list|)
operator|*
name|ss
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|GET32
argument_list|(
name|meta
argument_list|,
name|vdr
operator|->
name|Signature
argument_list|)
operator|!=
name|DDF_VD_RECORD_SIGNATURE
condition|)
goto|goto
name|hdrerror
goto|;
comment|/* Read configuration records. */
name|buf
operator|=
name|g_read_data
argument_list|(
name|cp
argument_list|,
operator|(
name|lba
operator|+
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|cr_section
argument_list|)
operator|)
operator|*
name|ss
argument_list|,
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|cr_length
argument_list|)
operator|*
name|ss
argument_list|,
operator|&
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
goto|goto
name|readerror
goto|;
name|meta
operator|->
name|cr
operator|=
name|malloc
argument_list|(
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|cr_length
argument_list|)
operator|*
name|ss
argument_list|,
name|M_MD_DDF
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|meta
operator|->
name|cr
argument_list|,
name|buf
argument_list|,
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|cr_length
argument_list|)
operator|*
name|ss
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
comment|/* Read physical disk data. */
name|buf
operator|=
name|g_read_data
argument_list|(
name|cp
argument_list|,
operator|(
name|lba
operator|+
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|pdd_section
argument_list|)
operator|)
operator|*
name|ss
argument_list|,
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|pdd_length
argument_list|)
operator|*
name|ss
argument_list|,
operator|&
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
goto|goto
name|readerror
goto|;
name|meta
operator|->
name|pdd
operator|=
name|malloc
argument_list|(
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|pdd_length
argument_list|)
operator|*
name|ss
argument_list|,
name|M_MD_DDF
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|meta
operator|->
name|pdd
argument_list|,
name|buf
argument_list|,
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|pdd_length
argument_list|)
operator|*
name|ss
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|GET32
argument_list|(
name|meta
argument_list|,
name|pdd
operator|->
name|Signature
argument_list|)
operator|!=
name|DDF_PDD_SIGNATURE
condition|)
goto|goto
name|hdrerror
goto|;
name|i
operator|=
name|ddf_meta_find_pd
argument_list|(
name|meta
argument_list|,
name|NULL
argument_list|,
name|GET32
argument_list|(
name|meta
argument_list|,
name|pdd
operator|->
name|PD_Reference
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|<
literal|0
condition|)
goto|goto
name|hdrerror
goto|;
comment|/* Read BBM Log. */
if|if
condition|(
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|bbmlog_section
argument_list|)
operator|!=
literal|0xffffffff
operator|&&
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|bbmlog_length
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|buf
operator|=
name|g_read_data
argument_list|(
name|cp
argument_list|,
operator|(
name|lba
operator|+
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|bbmlog_section
argument_list|)
operator|)
operator|*
name|ss
argument_list|,
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|bbmlog_length
argument_list|)
operator|*
name|ss
argument_list|,
operator|&
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
goto|goto
name|readerror
goto|;
name|meta
operator|->
name|bbm
operator|=
name|malloc
argument_list|(
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|bbmlog_length
argument_list|)
operator|*
name|ss
argument_list|,
name|M_MD_DDF
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|meta
operator|->
name|bbm
argument_list|,
name|buf
argument_list|,
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|bbmlog_length
argument_list|)
operator|*
name|ss
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|GET32
argument_list|(
name|meta
argument_list|,
name|bbm
operator|->
name|Signature
argument_list|)
operator|!=
name|DDF_BBML_SIGNATURE
condition|)
goto|goto
name|hdrerror
goto|;
block|}
name|done
label|:
name|g_free
argument_list|(
name|abuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
name|ddf_meta_free
argument_list|(
name|meta
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ddf_meta_write
parameter_list|(
name|struct
name|g_consumer
modifier|*
name|cp
parameter_list|,
name|struct
name|ddf_meta
modifier|*
name|meta
parameter_list|)
block|{
name|struct
name|g_provider
modifier|*
name|pp
decl_stmt|;
name|struct
name|ddf_vdc_record
modifier|*
name|vdc
decl_stmt|;
name|off_t
name|alba
decl_stmt|,
name|plba
decl_stmt|,
name|slba
decl_stmt|,
name|lba
decl_stmt|;
name|u_int
name|ss
decl_stmt|,
name|size
decl_stmt|;
name|int
name|error
decl_stmt|,
name|i
decl_stmt|,
name|num
decl_stmt|;
name|pp
operator|=
name|cp
operator|->
name|provider
expr_stmt|;
name|ss
operator|=
name|pp
operator|->
name|sectorsize
expr_stmt|;
name|lba
operator|=
name|alba
operator|=
name|pp
operator|->
name|mediasize
operator|/
name|ss
operator|-
literal|1
expr_stmt|;
name|plba
operator|=
name|GET64
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|Primary_Header_LBA
argument_list|)
expr_stmt|;
name|slba
operator|=
name|GET64
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|Secondary_Header_LBA
argument_list|)
expr_stmt|;
name|next
label|:
name|SET8
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|Header_Type
argument_list|,
operator|(
name|lba
operator|==
name|alba
operator|)
condition|?
name|DDF_HEADER_ANCHOR
else|:
operator|(
name|lba
operator|==
name|plba
operator|)
condition|?
name|DDF_HEADER_PRIMARY
else|:
name|DDF_HEADER_SECONDARY
argument_list|)
expr_stmt|;
name|SET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|CRC
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|SET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|CRC
argument_list|,
name|crc32
argument_list|(
name|meta
operator|->
name|hdr
argument_list|,
name|ss
argument_list|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|g_write_data
argument_list|(
name|cp
argument_list|,
name|lba
operator|*
name|ss
argument_list|,
name|meta
operator|->
name|hdr
argument_list|,
name|ss
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|err
label|:
name|G_RAID_DEBUG
argument_list|(
literal|1
argument_list|,
literal|"Cannot write metadata to %s (error=%d)."
argument_list|,
name|pp
operator|->
name|name
argument_list|,
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
name|lba
operator|!=
name|alba
condition|)
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|lba
operator|==
name|alba
condition|)
block|{
name|lba
operator|=
name|plba
expr_stmt|;
goto|goto
name|next
goto|;
block|}
name|size
operator|=
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|cd_length
argument_list|)
operator|*
name|ss
expr_stmt|;
name|SET32
argument_list|(
name|meta
argument_list|,
name|cdr
operator|->
name|CRC
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|SET32
argument_list|(
name|meta
argument_list|,
name|cdr
operator|->
name|CRC
argument_list|,
name|crc32
argument_list|(
name|meta
operator|->
name|cdr
argument_list|,
name|size
argument_list|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|g_write_data
argument_list|(
name|cp
argument_list|,
operator|(
name|lba
operator|+
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|cd_section
argument_list|)
operator|)
operator|*
name|ss
argument_list|,
name|meta
operator|->
name|cdr
argument_list|,
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|err
goto|;
name|size
operator|=
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|pdr_length
argument_list|)
operator|*
name|ss
expr_stmt|;
name|SET32
argument_list|(
name|meta
argument_list|,
name|pdr
operator|->
name|CRC
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|SET32
argument_list|(
name|meta
argument_list|,
name|pdr
operator|->
name|CRC
argument_list|,
name|crc32
argument_list|(
name|meta
operator|->
name|pdr
argument_list|,
name|size
argument_list|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|g_write_data
argument_list|(
name|cp
argument_list|,
operator|(
name|lba
operator|+
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|pdr_section
argument_list|)
operator|)
operator|*
name|ss
argument_list|,
name|meta
operator|->
name|pdr
argument_list|,
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|err
goto|;
name|size
operator|=
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|vdr_length
argument_list|)
operator|*
name|ss
expr_stmt|;
name|SET32
argument_list|(
name|meta
argument_list|,
name|vdr
operator|->
name|CRC
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|SET32
argument_list|(
name|meta
argument_list|,
name|vdr
operator|->
name|CRC
argument_list|,
name|crc32
argument_list|(
name|meta
operator|->
name|vdr
argument_list|,
name|size
argument_list|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|g_write_data
argument_list|(
name|cp
argument_list|,
operator|(
name|lba
operator|+
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|vdr_section
argument_list|)
operator|)
operator|*
name|ss
argument_list|,
name|meta
operator|->
name|vdr
argument_list|,
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|err
goto|;
name|size
operator|=
name|GET16
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|Configuration_Record_Length
argument_list|)
operator|*
name|ss
expr_stmt|;
name|num
operator|=
name|GETCRNUM
argument_list|(
name|meta
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num
condition|;
name|i
operator|++
control|)
block|{
name|vdc
operator|=
name|GETVDCPTR
argument_list|(
name|meta
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|SET32D
argument_list|(
name|meta
argument_list|,
name|vdc
operator|->
name|CRC
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|SET32D
argument_list|(
name|meta
argument_list|,
name|vdc
operator|->
name|CRC
argument_list|,
name|crc32
argument_list|(
name|vdc
argument_list|,
name|size
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|error
operator|=
name|g_write_data
argument_list|(
name|cp
argument_list|,
operator|(
name|lba
operator|+
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|cr_section
argument_list|)
operator|)
operator|*
name|ss
argument_list|,
name|meta
operator|->
name|cr
argument_list|,
name|size
operator|*
name|num
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|err
goto|;
name|size
operator|=
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|pdd_length
argument_list|)
operator|*
name|ss
expr_stmt|;
name|SET32
argument_list|(
name|meta
argument_list|,
name|pdd
operator|->
name|CRC
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|SET32
argument_list|(
name|meta
argument_list|,
name|pdd
operator|->
name|CRC
argument_list|,
name|crc32
argument_list|(
name|meta
operator|->
name|pdd
argument_list|,
name|size
argument_list|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|g_write_data
argument_list|(
name|cp
argument_list|,
operator|(
name|lba
operator|+
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|pdd_section
argument_list|)
operator|)
operator|*
name|ss
argument_list|,
name|meta
operator|->
name|pdd
argument_list|,
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|bbmlog_length
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|size
operator|=
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|bbmlog_length
argument_list|)
operator|*
name|ss
expr_stmt|;
name|SET32
argument_list|(
name|meta
argument_list|,
name|bbm
operator|->
name|CRC
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|SET32
argument_list|(
name|meta
argument_list|,
name|bbm
operator|->
name|CRC
argument_list|,
name|crc32
argument_list|(
name|meta
operator|->
name|bbm
argument_list|,
name|size
argument_list|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|g_write_data
argument_list|(
name|cp
argument_list|,
operator|(
name|lba
operator|+
name|GET32
argument_list|(
name|meta
argument_list|,
name|hdr
operator|->
name|bbmlog_section
argument_list|)
operator|)
operator|*
name|ss
argument_list|,
name|meta
operator|->
name|bbm
argument_list|,
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|err
goto|;
block|}
name|done
label|:
if|if
condition|(
name|lba
operator|==
name|plba
operator|&&
name|slba
operator|!=
operator|-
literal|1
condition|)
block|{
name|lba
operator|=
name|slba
expr_stmt|;
goto|goto
name|next
goto|;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ddf_meta_erase
parameter_list|(
name|struct
name|g_consumer
modifier|*
name|cp
parameter_list|)
block|{
name|struct
name|g_provider
modifier|*
name|pp
decl_stmt|;
name|char
modifier|*
name|buf
decl_stmt|;
name|int
name|error
decl_stmt|;
name|pp
operator|=
name|cp
operator|->
name|provider
expr_stmt|;
name|buf
operator|=
name|malloc
argument_list|(
name|pp
operator|->
name|sectorsize
argument_list|,
name|M_MD_DDF
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|error
operator|=
name|g_write_data
argument_list|(
name|cp
argument_list|,
name|pp
operator|->
name|mediasize
operator|-
name|pp
operator|->
name|sectorsize
argument_list|,
name|buf
argument_list|,
name|pp
operator|->
name|sectorsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|G_RAID_DEBUG
argument_list|(
literal|1
argument_list|,
literal|"Cannot erase metadata on %s (error=%d)."
argument_list|,
name|pp
operator|->
name|name
argument_list|,
name|error
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|buf
argument_list|,
name|M_MD_DDF
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|g_raid_volume
modifier|*
name|g_raid_md_ddf_get_volume
parameter_list|(
name|struct
name|g_raid_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
modifier|*
name|GUID
parameter_list|)
block|{
name|struct
name|g_raid_volume
modifier|*
name|vol
decl_stmt|;
name|struct
name|g_raid_md_ddf_pervolume
modifier|*
name|pv
decl_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|vol
argument_list|,
argument|&sc->sc_volumes
argument_list|,
argument|v_next
argument_list|)
block|{
name|pv
operator|=
name|vol
operator|->
name|v_md_data
expr_stmt|;
if|if
condition|(
name|memcmp
argument_list|(
name|pv
operator|->
name|pv_meta
operator|.
name|vde
operator|->
name|VD_GUID
argument_list|,
name|GUID
argument_list|,
literal|24
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
return|return
operator|(
name|vol
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|g_raid_disk
modifier|*
name|g_raid_md_ddf_get_disk
parameter_list|(
name|struct
name|g_raid_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
modifier|*
name|GUID
parameter_list|,
name|uint32_t
name|id
parameter_list|)
block|{
name|struct
name|g_raid_disk
modifier|*
name|disk
decl_stmt|;
name|struct
name|g_raid_md_ddf_perdisk
modifier|*
name|pd
decl_stmt|;
name|struct
name|ddf_meta
modifier|*
name|meta
decl_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|disk
argument_list|,
argument|&sc->sc_disks
argument_list|,
argument|d_next
argument_list|)
block|{
name|pd
operator|=
operator|(
expr|struct
name|g_raid_md_ddf_perdisk
operator|*
operator|)
name|disk
operator|->
name|d_md_data
expr_stmt|;
name|meta
operator|=
operator|&
name|pd
operator|->
name|pd_meta
expr_stmt|;
if|if
condition|(
name|GUID
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|memcmp
argument_list|(
name|meta
operator|->
name|pdd
operator|->
name|PD_GUID
argument_list|,
name|GUID
argument_list|,
literal|24
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
else|else
block|{
if|if
condition|(
name|GET32
argument_list|(
name|meta
argument_list|,
name|pdd
operator|->
name|PD_Reference
argument_list|)
operator|==
name|id
condition|)
break|break;
block|}
block|}
return|return
operator|(
name|disk
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|g_raid_md_ddf_purge_volumes
parameter_list|(
name|struct
name|g_raid_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|g_raid_volume
modifier|*
name|vol
decl_stmt|,
modifier|*
name|tvol
decl_stmt|;
name|struct
name|g_raid_md_ddf_pervolume
modifier|*
name|pv
decl_stmt|;
name|int
name|i
decl_stmt|,
name|res
decl_stmt|;
name|res
operator|=
literal|0
expr_stmt|;
name|TAILQ_FOREACH_SAFE
argument_list|(
argument|vol
argument_list|,
argument|&sc->sc_volumes
argument_list|,
argument|v_next
argument_list|,
argument|tvol
argument_list|)
block|{
name|pv
operator|=
name|vol
operator|->
name|v_md_data
expr_stmt|;
if|if
condition|(
name|vol
operator|->
name|v_stopping
condition|)
continue|continue;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|vol
operator|->
name|v_disks_count
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|vol
operator|->
name|v_subdisks
index|[
name|i
index|]
operator|.
name|sd_state
operator|!=
name|G_RAID_SUBDISK_S_NONE
condition|)
break|break;
block|}
if|if
condition|(
name|i
operator|>=
name|vol
operator|->
name|v_disks_count
condition|)
block|{
name|g_raid_destroy_volume
argument_list|(
name|vol
argument_list|)
expr_stmt|;
name|res
operator|=
literal|1
expr_stmt|;
block|}
block|}
return|return
operator|(
name|res
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|g_raid_md_ddf_purge_disks
parameter_list|(
name|struct
name|g_raid_softc
modifier|*
name|sc
parameter_list|)
block|{
if|#
directive|if
literal|0
block|struct g_raid_disk	*disk, *tdisk; 	struct g_raid_volume	*vol; 	struct g_raid_md_ddf_perdisk *pd; 	int i, j, res;  	res = 0; 	TAILQ_FOREACH_SAFE(disk,&sc->sc_disks, d_next, tdisk) { 		if (disk->d_state == G_RAID_DISK_S_SPARE) 			continue; 		pd = (struct g_raid_md_ddf_perdisk *)disk->d_md_data;
comment|/* Scan for deleted volumes. */
block|for (i = 0; i< pd->pd_subdisks; ) { 			vol = g_raid_md_ddf_get_volume(sc, 			    pd->pd_meta[i]->volume_id); 			if (vol != NULL&& !vol->v_stopping) { 				i++; 				continue; 			} 			free(pd->pd_meta[i], M_MD_DDF); 			for (j = i; j< pd->pd_subdisks - 1; j++) 				pd->pd_meta[j] = pd->pd_meta[j + 1]; 			pd->pd_meta[DDF_MAX_SUBDISKS - 1] = NULL; 			pd->pd_subdisks--; 			pd->pd_updated = 1; 		}
comment|/* If there is no metadata left - erase and delete disk. */
block|if (pd->pd_subdisks == 0) { 			ddf_meta_erase(disk->d_consumer); 			g_raid_destroy_disk(disk); 			res = 1; 		} 	} 	return (res);
endif|#
directive|endif
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|g_raid_md_ddf_supported
parameter_list|(
name|int
name|level
parameter_list|,
name|int
name|qual
parameter_list|,
name|int
name|disks
parameter_list|,
name|int
name|force
parameter_list|)
block|{
if|if
condition|(
name|disks
operator|>
name|DDF_MAX_DISKS_HARD
condition|)
return|return
operator|(
literal|0
operator|)
return|;
switch|switch
condition|(
name|level
condition|)
block|{
case|case
name|G_RAID_VOLUME_RL_RAID0
case|:
if|if
condition|(
name|qual
operator|!=
name|G_RAID_VOLUME_RLQ_NONE
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|disks
operator|<
literal|1
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
operator|!
name|force
operator|&&
name|disks
operator|<
literal|2
condition|)
return|return
operator|(
literal|0
operator|)
return|;
break|break;
case|case
name|G_RAID_VOLUME_RL_RAID1
case|:
if|if
condition|(
name|disks
operator|<
literal|1
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|qual
operator|==
name|G_RAID_VOLUME_RLQ_R1SM
condition|)
block|{
if|if
condition|(
operator|!
name|force
operator|&&
name|disks
operator|!=
literal|2
condition|)
return|return
operator|(
literal|0
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|qual
operator|==
name|G_RAID_VOLUME_RLQ_R1MM
condition|)
block|{
if|if
condition|(
operator|!
name|force
operator|&&
name|disks
operator|!=
literal|3
condition|)
return|return
operator|(
literal|0
operator|)
return|;
block|}
else|else
return|return
operator|(
literal|0
operator|)
return|;
break|break;
case|case
name|G_RAID_VOLUME_RL_RAID3
case|:
if|if
condition|(
name|qual
operator|!=
name|G_RAID_VOLUME_RLQ_R3P0
operator|&&
name|qual
operator|!=
name|G_RAID_VOLUME_RLQ_R3PN
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|disks
operator|<
literal|3
condition|)
return|return
operator|(
literal|0
operator|)
return|;
break|break;
case|case
name|G_RAID_VOLUME_RL_RAID4
case|:
if|if
condition|(
name|qual
operator|!=
name|G_RAID_VOLUME_RLQ_R4P0
operator|&&
name|qual
operator|!=
name|G_RAID_VOLUME_RLQ_R4PN
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|disks
operator|<
literal|3
condition|)
return|return
operator|(
literal|0
operator|)
return|;
break|break;
case|case
name|G_RAID_VOLUME_RL_RAID5
case|:
if|if
condition|(
name|qual
operator|!=
name|G_RAID_VOLUME_RLQ_R5RA
operator|&&
name|qual
operator|!=
name|G_RAID_VOLUME_RLQ_R5RS
operator|&&
name|qual
operator|!=
name|G_RAID_VOLUME_RLQ_R5LA
operator|&&
name|qual
operator|!=
name|G_RAID_VOLUME_RLQ_R5LS
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|disks
operator|<
literal|3
condition|)
return|return
operator|(
literal|0
operator|)
return|;
break|break;
case|case
name|G_RAID_VOLUME_RL_RAID6
case|:
if|if
condition|(
name|qual
operator|!=
name|G_RAID_VOLUME_RLQ_R6RA
operator|&&
name|qual
operator|!=
name|G_RAID_VOLUME_RLQ_R6RS
operator|&&
name|qual
operator|!=
name|G_RAID_VOLUME_RLQ_R6LA
operator|&&
name|qual
operator|!=
name|G_RAID_VOLUME_RLQ_R6LS
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|disks
operator|<
literal|4
condition|)
return|return
operator|(
literal|0
operator|)
return|;
break|break;
case|case
name|G_RAID_VOLUME_RL_RAIDMDF
case|:
if|if
condition|(
name|qual
operator|!=
name|G_RAID_VOLUME_RLQ_RMDFRA
operator|&&
name|qual
operator|!=
name|G_RAID_VOLUME_RLQ_RMDFRS
operator|&&
name|qual
operator|!=
name|G_RAID_VOLUME_RLQ_RMDFLA
operator|&&
name|qual
operator|!=
name|G_RAID_VOLUME_RLQ_RMDFLS
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|disks
operator|<
literal|4
condition|)
return|return
operator|(
literal|0
operator|)
return|;
break|break;
case|case
name|G_RAID_VOLUME_RL_RAID1E
case|:
if|if
condition|(
name|qual
operator|!=
name|G_RAID_VOLUME_RLQ_R1EA
operator|&&
name|qual
operator|!=
name|G_RAID_VOLUME_RLQ_R1EO
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|disks
operator|<
literal|3
condition|)
return|return
operator|(
literal|0
operator|)
return|;
break|break;
case|case
name|G_RAID_VOLUME_RL_SINGLE
case|:
if|if
condition|(
name|qual
operator|!=
name|G_RAID_VOLUME_RLQ_NONE
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|disks
operator|!=
literal|1
condition|)
return|return
operator|(
literal|0
operator|)
return|;
break|break;
case|case
name|G_RAID_VOLUME_RL_CONCAT
case|:
if|if
condition|(
name|qual
operator|!=
name|G_RAID_VOLUME_RLQ_NONE
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|disks
operator|<
literal|2
condition|)
return|return
operator|(
literal|0
operator|)
return|;
break|break;
case|case
name|G_RAID_VOLUME_RL_RAID5E
case|:
if|if
condition|(
name|qual
operator|!=
name|G_RAID_VOLUME_RLQ_R5ERA
operator|&&
name|qual
operator|!=
name|G_RAID_VOLUME_RLQ_R5ERS
operator|&&
name|qual
operator|!=
name|G_RAID_VOLUME_RLQ_R5ELA
operator|&&
name|qual
operator|!=
name|G_RAID_VOLUME_RLQ_R5ELS
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|disks
operator|<
literal|4
condition|)
return|return
operator|(
literal|0
operator|)
return|;
break|break;
case|case
name|G_RAID_VOLUME_RL_RAID5EE
case|:
if|if
condition|(
name|qual
operator|!=
name|G_RAID_VOLUME_RLQ_R5EERA
operator|&&
name|qual
operator|!=
name|G_RAID_VOLUME_RLQ_R5EERS
operator|&&
name|qual
operator|!=
name|G_RAID_VOLUME_RLQ_R5EELA
operator|&&
name|qual
operator|!=
name|G_RAID_VOLUME_RLQ_R5EELS
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|disks
operator|<
literal|4
condition|)
return|return
operator|(
literal|0
operator|)
return|;
break|break;
case|case
name|G_RAID_VOLUME_RL_RAID5R
case|:
if|if
condition|(
name|qual
operator|!=
name|G_RAID_VOLUME_RLQ_R5RRA
operator|&&
name|qual
operator|!=
name|G_RAID_VOLUME_RLQ_R5RRS
operator|&&
name|qual
operator|!=
name|G_RAID_VOLUME_RLQ_R5RLA
operator|&&
name|qual
operator|!=
name|G_RAID_VOLUME_RLQ_R5RLS
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|disks
operator|<
literal|3
condition|)
return|return
operator|(
literal|0
operator|)
return|;
break|break;
default|default:
return|return
operator|(
literal|0
operator|)
return|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|g_raid_md_ddf_start_disk
parameter_list|(
name|struct
name|g_raid_disk
modifier|*
name|disk
parameter_list|,
name|struct
name|g_raid_volume
modifier|*
name|vol
parameter_list|)
block|{
name|struct
name|g_raid_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|g_raid_subdisk
modifier|*
name|sd
decl_stmt|;
name|struct
name|g_raid_md_ddf_perdisk
modifier|*
name|pd
decl_stmt|;
name|struct
name|g_raid_md_ddf_pervolume
modifier|*
name|pv
decl_stmt|;
name|struct
name|g_raid_md_ddf_object
modifier|*
name|mdi
decl_stmt|;
name|struct
name|ddf_vol_meta
modifier|*
name|vmeta
decl_stmt|;
name|struct
name|ddf_meta
modifier|*
name|pdmeta
decl_stmt|,
modifier|*
name|gmeta
decl_stmt|;
name|struct
name|ddf_vdc_record
modifier|*
name|vdc1
decl_stmt|;
name|struct
name|ddf_sa_record
modifier|*
name|sa
decl_stmt|;
name|off_t
name|size
decl_stmt|,
name|eoff
init|=
literal|0
decl_stmt|,
name|esize
init|=
literal|0
decl_stmt|;
name|uint64_t
modifier|*
name|val2
decl_stmt|;
name|int
name|disk_pos
decl_stmt|,
name|md_disk_bvd
init|=
operator|-
literal|1
decl_stmt|,
name|md_disk_pos
init|=
operator|-
literal|1
decl_stmt|,
name|md_pde_pos
decl_stmt|;
name|int
name|i
decl_stmt|,
name|resurrection
init|=
literal|0
decl_stmt|;
name|uint32_t
name|reference
decl_stmt|;
name|sc
operator|=
name|disk
operator|->
name|d_softc
expr_stmt|;
name|mdi
operator|=
operator|(
expr|struct
name|g_raid_md_ddf_object
operator|*
operator|)
name|sc
operator|->
name|sc_md
expr_stmt|;
name|pd
operator|=
operator|(
expr|struct
name|g_raid_md_ddf_perdisk
operator|*
operator|)
name|disk
operator|->
name|d_md_data
expr_stmt|;
name|pdmeta
operator|=
operator|&
name|pd
operator|->
name|pd_meta
expr_stmt|;
name|reference
operator|=
name|GET32
argument_list|(
operator|&
name|pd
operator|->
name|pd_meta
argument_list|,
name|pdd
operator|->
name|PD_Reference
argument_list|)
expr_stmt|;
name|pv
operator|=
name|vol
operator|->
name|v_md_data
expr_stmt|;
name|vmeta
operator|=
operator|&
name|pv
operator|->
name|pv_meta
expr_stmt|;
name|gmeta
operator|=
operator|&
name|mdi
operator|->
name|mdio_meta
expr_stmt|;
comment|/* Find disk position in metadata by it's reference. */
name|disk_pos
operator|=
name|ddf_meta_find_disk
argument_list|(
name|vmeta
argument_list|,
name|reference
argument_list|,
operator|&
name|md_disk_bvd
argument_list|,
operator|&
name|md_disk_pos
argument_list|)
expr_stmt|;
name|md_pde_pos
operator|=
name|ddf_meta_find_pd
argument_list|(
name|gmeta
argument_list|,
name|NULL
argument_list|,
name|reference
argument_list|)
expr_stmt|;
if|if
condition|(
name|disk_pos
operator|<
literal|0
condition|)
block|{
name|G_RAID_DEBUG1
argument_list|(
literal|1
argument_list|,
name|sc
argument_list|,
literal|"Disk %s is not a present part of the volume %s"
argument_list|,
name|g_raid_get_diskname
argument_list|(
name|disk
argument_list|)
argument_list|,
name|vol
operator|->
name|v_name
argument_list|)
expr_stmt|;
comment|/* Failed stale disk is useless for us. */
if|if
condition|(
operator|(
name|GET16
argument_list|(
name|gmeta
argument_list|,
name|pdr
operator|->
name|entry
index|[
name|md_pde_pos
index|]
operator|.
name|PD_State
argument_list|)
operator|&
name|DDF_PDE_PFA
operator|)
operator|!=
literal|0
condition|)
block|{
name|g_raid_change_disk_state
argument_list|(
name|disk
argument_list|,
name|G_RAID_DISK_S_STALE_FAILED
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
comment|/* If disk has some metadata for this volume - erase. */
if|if
condition|(
operator|(
name|vdc1
operator|=
name|ddf_meta_find_vdc
argument_list|(
name|pdmeta
argument_list|,
name|vmeta
operator|->
name|vdc
operator|->
name|VD_GUID
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
name|SET32D
argument_list|(
name|pdmeta
argument_list|,
name|vdc1
operator|->
name|Signature
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
comment|/* If we are in the start process, that's all for now. */
if|if
condition|(
operator|!
name|pv
operator|->
name|pv_started
condition|)
goto|goto
name|nofit
goto|;
comment|/* 		 * If we have already started - try to get use of the disk. 		 * Try to replace OFFLINE disks first, then FAILED. 		 */
if|if
condition|(
name|ddf_meta_count_vdc
argument_list|(
operator|&
name|pd
operator|->
name|pd_meta
argument_list|,
name|NULL
argument_list|)
operator|>=
name|GET16
argument_list|(
operator|&
name|pd
operator|->
name|pd_meta
argument_list|,
name|hdr
operator|->
name|Max_Partitions
argument_list|)
condition|)
block|{
name|G_RAID_DEBUG1
argument_list|(
literal|1
argument_list|,
name|sc
argument_list|,
literal|"No free partitions on disk %s"
argument_list|,
name|g_raid_get_diskname
argument_list|(
name|disk
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|nofit
goto|;
block|}
name|ddf_meta_unused_range
argument_list|(
operator|&
name|pd
operator|->
name|pd_meta
argument_list|,
operator|&
name|eoff
argument_list|,
operator|&
name|esize
argument_list|)
expr_stmt|;
if|if
condition|(
name|esize
operator|==
literal|0
condition|)
block|{
name|G_RAID_DEBUG1
argument_list|(
literal|1
argument_list|,
name|sc
argument_list|,
literal|"No free space on disk %s"
argument_list|,
name|g_raid_get_diskname
argument_list|(
name|disk
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|nofit
goto|;
block|}
name|eoff
operator|*=
name|pd
operator|->
name|pd_meta
operator|.
name|sectorsize
expr_stmt|;
name|esize
operator|*=
name|pd
operator|->
name|pd_meta
operator|.
name|sectorsize
expr_stmt|;
name|size
operator|=
name|INT64_MAX
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|vol
operator|->
name|v_disks_count
condition|;
name|i
operator|++
control|)
block|{
name|sd
operator|=
operator|&
name|vol
operator|->
name|v_subdisks
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|sd
operator|->
name|sd_state
operator|!=
name|G_RAID_SUBDISK_S_NONE
condition|)
name|size
operator|=
name|sd
operator|->
name|sd_size
expr_stmt|;
if|if
condition|(
name|sd
operator|->
name|sd_state
operator|<=
name|G_RAID_SUBDISK_S_FAILED
operator|&&
operator|(
name|disk_pos
operator|<
literal|0
operator|||
name|vol
operator|->
name|v_subdisks
index|[
name|i
index|]
operator|.
name|sd_state
operator|<
name|sd
operator|->
name|sd_state
operator|)
condition|)
name|disk_pos
operator|=
name|i
expr_stmt|;
block|}
if|if
condition|(
name|disk_pos
operator|>=
literal|0
operator|&&
name|vol
operator|->
name|v_raid_level
operator|!=
name|G_RAID_VOLUME_RL_CONCAT
operator|&&
name|esize
operator|<
name|size
condition|)
block|{
name|G_RAID_DEBUG1
argument_list|(
literal|1
argument_list|,
name|sc
argument_list|,
literal|"Disk %s free space "
literal|"is too small (%ju< %ju)"
argument_list|,
name|g_raid_get_diskname
argument_list|(
name|disk
argument_list|)
argument_list|,
name|esize
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|disk_pos
operator|=
operator|-
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|disk_pos
operator|>=
literal|0
condition|)
block|{
if|if
condition|(
name|vol
operator|->
name|v_raid_level
operator|!=
name|G_RAID_VOLUME_RL_CONCAT
condition|)
name|esize
operator|=
name|size
expr_stmt|;
name|md_disk_bvd
operator|=
name|disk_pos
operator|/
name|GET16
argument_list|(
name|vmeta
argument_list|,
name|vdc
operator|->
name|Primary_Element_Count
argument_list|)
expr_stmt|;
comment|// XXX
name|md_disk_pos
operator|=
name|disk_pos
operator|%
name|GET16
argument_list|(
name|vmeta
argument_list|,
name|vdc
operator|->
name|Primary_Element_Count
argument_list|)
expr_stmt|;
comment|// XXX
block|}
else|else
block|{
name|nofit
label|:
if|if
condition|(
name|disk
operator|->
name|d_state
operator|==
name|G_RAID_DISK_S_NONE
condition|)
name|g_raid_change_disk_state
argument_list|(
name|disk
argument_list|,
name|G_RAID_DISK_S_STALE
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
comment|/* 		 * If spare is committable, delete spare record. 		 * Othersize, mark it active and leave there. 		 */
name|sa
operator|=
name|ddf_meta_find_sa
argument_list|(
operator|&
name|pd
operator|->
name|pd_meta
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|sa
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
name|GET8D
argument_list|(
operator|&
name|pd
operator|->
name|pd_meta
argument_list|,
name|sa
operator|->
name|Spare_Type
argument_list|)
operator|&
name|DDF_SAR_TYPE_REVERTIBLE
operator|)
operator|==
literal|0
condition|)
block|{
name|SET32D
argument_list|(
operator|&
name|pd
operator|->
name|pd_meta
argument_list|,
name|sa
operator|->
name|Signature
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SET8D
argument_list|(
operator|&
name|pd
operator|->
name|pd_meta
argument_list|,
name|sa
operator|->
name|Spare_Type
argument_list|,
name|GET8D
argument_list|(
operator|&
name|pd
operator|->
name|pd_meta
argument_list|,
name|sa
operator|->
name|Spare_Type
argument_list|)
operator||
name|DDF_SAR_TYPE_ACTIVE
argument_list|)
expr_stmt|;
block|}
block|}
name|G_RAID_DEBUG1
argument_list|(
literal|1
argument_list|,
name|sc
argument_list|,
literal|"Disk %s takes pos %d in the volume %s"
argument_list|,
name|g_raid_get_diskname
argument_list|(
name|disk
argument_list|)
argument_list|,
name|disk_pos
argument_list|,
name|vol
operator|->
name|v_name
argument_list|)
expr_stmt|;
name|resurrection
operator|=
literal|1
expr_stmt|;
block|}
name|sd
operator|=
operator|&
name|vol
operator|->
name|v_subdisks
index|[
name|disk_pos
index|]
expr_stmt|;
if|if
condition|(
name|resurrection
operator|&&
name|sd
operator|->
name|sd_disk
operator|!=
name|NULL
condition|)
block|{
name|g_raid_change_disk_state
argument_list|(
name|sd
operator|->
name|sd_disk
argument_list|,
name|G_RAID_DISK_S_STALE_FAILED
argument_list|)
expr_stmt|;
name|TAILQ_REMOVE
argument_list|(
operator|&
name|sd
operator|->
name|sd_disk
operator|->
name|d_subdisks
argument_list|,
name|sd
argument_list|,
name|sd_next
argument_list|)
expr_stmt|;
block|}
name|vol
operator|->
name|v_subdisks
index|[
name|disk_pos
index|]
operator|.
name|sd_disk
operator|=
name|disk
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|disk
operator|->
name|d_subdisks
argument_list|,
name|sd
argument_list|,
name|sd_next
argument_list|)
expr_stmt|;
comment|/* Welcome the new disk. */
if|if
condition|(
name|resurrection
condition|)
name|g_raid_change_disk_state
argument_list|(
name|disk
argument_list|,
name|G_RAID_DISK_S_ACTIVE
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|GET16
argument_list|(
name|gmeta
argument_list|,
name|pdr
operator|->
name|entry
index|[
name|md_pde_pos
index|]
operator|.
name|PD_State
argument_list|)
operator|&
name|DDF_PDE_PFA
condition|)
name|g_raid_change_disk_state
argument_list|(
name|disk
argument_list|,
name|G_RAID_DISK_S_FAILED
argument_list|)
expr_stmt|;
else|else
name|g_raid_change_disk_state
argument_list|(
name|disk
argument_list|,
name|G_RAID_DISK_S_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|resurrection
condition|)
block|{
name|sd
operator|->
name|sd_offset
operator|=
name|eoff
expr_stmt|;
name|sd
operator|->
name|sd_size
operator|=
name|esize
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pdmeta
operator|->
name|cr
operator|!=
name|NULL
operator|&&
operator|(
name|vdc1
operator|=
name|ddf_meta_find_vdc
argument_list|(
name|pdmeta
argument_list|,
name|vmeta
operator|->
name|vdc
operator|->
name|VD_GUID
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|val2
operator|=
operator|(
name|uint64_t
operator|*
operator|)
operator|&
operator|(
name|vdc1
operator|->
name|Physical_Disk_Sequence
index|[
name|GET16
argument_list|(
name|vmeta
argument_list|,
name|hdr
operator|->
name|Max_Primary_Element_Entries
argument_list|)
index|]
operator|)
expr_stmt|;
name|sd
operator|->
name|sd_offset
operator|=
operator|(
name|off_t
operator|)
name|GET64P
argument_list|(
name|pdmeta
argument_list|,
name|val2
operator|+
name|md_disk_pos
argument_list|)
operator|*
literal|512
expr_stmt|;
name|sd
operator|->
name|sd_size
operator|=
operator|(
name|off_t
operator|)
name|GET64D
argument_list|(
name|pdmeta
argument_list|,
name|vdc1
operator|->
name|Block_Count
argument_list|)
operator|*
literal|512
expr_stmt|;
block|}
if|if
condition|(
name|resurrection
condition|)
block|{
comment|/* Stale disk, almost same as new. */
name|g_raid_change_subdisk_state
argument_list|(
name|sd
argument_list|,
name|G_RAID_SUBDISK_S_NEW
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|GET16
argument_list|(
name|gmeta
argument_list|,
name|pdr
operator|->
name|entry
index|[
name|md_pde_pos
index|]
operator|.
name|PD_State
argument_list|)
operator|&
name|DDF_PDE_PFA
condition|)
block|{
comment|/* Failed disk. */
name|g_raid_change_subdisk_state
argument_list|(
name|sd
argument_list|,
name|G_RAID_SUBDISK_S_FAILED
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|GET16
argument_list|(
name|gmeta
argument_list|,
name|pdr
operator|->
name|entry
index|[
name|md_pde_pos
index|]
operator|.
name|PD_State
argument_list|)
operator|&
operator|(
name|DDF_PDE_FAILED
operator||
name|DDF_PDE_REBUILD
operator|)
operator|)
operator|!=
literal|0
condition|)
block|{
comment|/* Rebuilding disk. */
name|g_raid_change_subdisk_state
argument_list|(
name|sd
argument_list|,
name|G_RAID_SUBDISK_S_REBUILD
argument_list|)
expr_stmt|;
name|sd
operator|->
name|sd_rebuild_pos
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|GET8
argument_list|(
name|vmeta
argument_list|,
name|vde
operator|->
name|VD_State
argument_list|)
operator|&
name|DDF_VDE_DIRTY
operator|)
operator|!=
literal|0
operator|||
operator|(
name|GET8
argument_list|(
name|vmeta
argument_list|,
name|vde
operator|->
name|Init_State
argument_list|)
operator|&
name|DDF_VDE_INIT_MASK
operator|)
operator|!=
name|DDF_VDE_INIT_FULL
condition|)
block|{
comment|/* Stale disk or dirty volume (unclean shutdown). */
name|g_raid_change_subdisk_state
argument_list|(
name|sd
argument_list|,
name|G_RAID_SUBDISK_S_STALE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Up to date disk. */
name|g_raid_change_subdisk_state
argument_list|(
name|sd
argument_list|,
name|G_RAID_SUBDISK_S_ACTIVE
argument_list|)
expr_stmt|;
block|}
name|g_raid_event_send
argument_list|(
name|sd
argument_list|,
name|G_RAID_SUBDISK_E_NEW
argument_list|,
name|G_RAID_EVENT_SUBDISK
argument_list|)
expr_stmt|;
return|return
operator|(
name|resurrection
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|g_raid_md_ddf_refill
parameter_list|(
name|struct
name|g_raid_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|g_raid_volume
modifier|*
name|vol
decl_stmt|;
name|struct
name|g_raid_subdisk
modifier|*
name|sd
decl_stmt|;
name|struct
name|g_raid_disk
modifier|*
name|disk
decl_stmt|;
name|struct
name|g_raid_md_object
modifier|*
name|md
decl_stmt|;
name|struct
name|g_raid_md_ddf_perdisk
modifier|*
name|pd
decl_stmt|;
name|struct
name|g_raid_md_ddf_pervolume
modifier|*
name|pv
decl_stmt|;
name|int
name|update
decl_stmt|,
name|updated
decl_stmt|,
name|i
decl_stmt|,
name|bad
decl_stmt|;
name|md
operator|=
name|sc
operator|->
name|sc_md
expr_stmt|;
name|restart
label|:
name|updated
operator|=
literal|0
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|vol
argument_list|,
argument|&sc->sc_volumes
argument_list|,
argument|v_next
argument_list|)
block|{
name|pv
operator|=
name|vol
operator|->
name|v_md_data
expr_stmt|;
if|if
condition|(
operator|!
name|pv
operator|->
name|pv_started
operator|||
name|vol
operator|->
name|v_stopping
condition|)
continue|continue;
comment|/* Search for subdisk that needs replacement. */
name|bad
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|vol
operator|->
name|v_disks_count
condition|;
name|i
operator|++
control|)
block|{
name|sd
operator|=
operator|&
name|vol
operator|->
name|v_subdisks
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|sd
operator|->
name|sd_state
operator|==
name|G_RAID_SUBDISK_S_NONE
operator|||
name|sd
operator|->
name|sd_state
operator|==
name|G_RAID_SUBDISK_S_FAILED
condition|)
name|bad
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|bad
condition|)
continue|continue;
name|G_RAID_DEBUG1
argument_list|(
literal|1
argument_list|,
name|sc
argument_list|,
literal|"Volume %s is not complete, "
literal|"trying to refill."
argument_list|,
name|vol
operator|->
name|v_name
argument_list|)
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|disk
argument_list|,
argument|&sc->sc_disks
argument_list|,
argument|d_next
argument_list|)
block|{
comment|/* Skip failed. */
if|if
condition|(
name|disk
operator|->
name|d_state
operator|<
name|G_RAID_DISK_S_SPARE
condition|)
continue|continue;
comment|/* Skip already used by this volume. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|vol
operator|->
name|v_disks_count
condition|;
name|i
operator|++
control|)
block|{
name|sd
operator|=
operator|&
name|vol
operator|->
name|v_subdisks
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|sd
operator|->
name|sd_disk
operator|==
name|disk
condition|)
break|break;
block|}
if|if
condition|(
name|i
operator|<
name|vol
operator|->
name|v_disks_count
condition|)
continue|continue;
comment|/* Try to use disk if it has empty extents. */
name|pd
operator|=
name|disk
operator|->
name|d_md_data
expr_stmt|;
if|if
condition|(
name|ddf_meta_count_vdc
argument_list|(
operator|&
name|pd
operator|->
name|pd_meta
argument_list|,
name|NULL
argument_list|)
operator|<
name|GET16
argument_list|(
operator|&
name|pd
operator|->
name|pd_meta
argument_list|,
name|hdr
operator|->
name|Max_Partitions
argument_list|)
condition|)
block|{
name|update
operator|=
name|g_raid_md_ddf_start_disk
argument_list|(
name|disk
argument_list|,
name|vol
argument_list|)
expr_stmt|;
block|}
else|else
name|update
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|update
condition|)
block|{
name|updated
operator|=
literal|1
expr_stmt|;
name|g_raid_md_write_ddf
argument_list|(
name|md
argument_list|,
name|vol
argument_list|,
name|NULL
argument_list|,
name|disk
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
if|if
condition|(
name|updated
condition|)
goto|goto
name|restart
goto|;
block|}
end_function

begin_function
specifier|static
name|void
name|g_raid_md_ddf_start
parameter_list|(
name|struct
name|g_raid_volume
modifier|*
name|vol
parameter_list|)
block|{
name|struct
name|g_raid_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|g_raid_subdisk
modifier|*
name|sd
decl_stmt|;
name|struct
name|g_raid_disk
modifier|*
name|disk
decl_stmt|;
name|struct
name|g_raid_md_object
modifier|*
name|md
decl_stmt|;
name|struct
name|g_raid_md_ddf_perdisk
modifier|*
name|pd
decl_stmt|;
name|struct
name|g_raid_md_ddf_pervolume
modifier|*
name|pv
decl_stmt|;
name|struct
name|g_raid_md_ddf_object
modifier|*
name|mdi
decl_stmt|;
name|struct
name|ddf_vol_meta
modifier|*
name|vmeta
decl_stmt|;
name|struct
name|ddf_vdc_record
modifier|*
name|vdc
decl_stmt|;
name|uint64_t
modifier|*
name|val2
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|bvd
decl_stmt|;
name|sc
operator|=
name|vol
operator|->
name|v_softc
expr_stmt|;
name|md
operator|=
name|sc
operator|->
name|sc_md
expr_stmt|;
name|mdi
operator|=
operator|(
expr|struct
name|g_raid_md_ddf_object
operator|*
operator|)
name|md
expr_stmt|;
name|pv
operator|=
name|vol
operator|->
name|v_md_data
expr_stmt|;
name|vmeta
operator|=
operator|&
name|pv
operator|->
name|pv_meta
expr_stmt|;
name|vdc
operator|=
name|vmeta
operator|->
name|vdc
expr_stmt|;
name|vol
operator|->
name|v_raid_level
operator|=
name|GET8
argument_list|(
name|vmeta
argument_list|,
name|vdc
operator|->
name|Primary_RAID_Level
argument_list|)
expr_stmt|;
name|vol
operator|->
name|v_raid_level_qualifier
operator|=
name|GET8
argument_list|(
name|vmeta
argument_list|,
name|vdc
operator|->
name|RLQ
argument_list|)
expr_stmt|;
if|if
condition|(
name|GET8
argument_list|(
name|vmeta
argument_list|,
name|vdc
operator|->
name|Secondary_Element_Count
argument_list|)
operator|>
literal|1
operator|&&
name|vol
operator|->
name|v_raid_level
operator|==
name|G_RAID_VOLUME_RL_RAID1
operator|&&
name|GET8
argument_list|(
name|vmeta
argument_list|,
name|vdc
operator|->
name|Secondary_RAID_Level
argument_list|)
operator|==
literal|0
condition|)
name|vol
operator|->
name|v_raid_level
operator|=
name|G_RAID_VOLUME_RL_RAID1E
expr_stmt|;
name|vol
operator|->
name|v_sectorsize
operator|=
name|GET16
argument_list|(
name|vmeta
argument_list|,
name|vdc
operator|->
name|Block_Size
argument_list|)
expr_stmt|;
if|if
condition|(
name|vol
operator|->
name|v_sectorsize
operator|==
literal|0xffff
condition|)
name|vol
operator|->
name|v_sectorsize
operator|=
name|vmeta
operator|->
name|sectorsize
expr_stmt|;
name|vol
operator|->
name|v_strip_size
operator|=
name|vol
operator|->
name|v_sectorsize
operator|<<
name|GET8
argument_list|(
name|vmeta
argument_list|,
name|vdc
operator|->
name|Stripe_Size
argument_list|)
expr_stmt|;
name|vol
operator|->
name|v_disks_count
operator|=
name|GET16
argument_list|(
name|vmeta
argument_list|,
name|vdc
operator|->
name|Primary_Element_Count
argument_list|)
operator|*
name|GET8
argument_list|(
name|vmeta
argument_list|,
name|vdc
operator|->
name|Secondary_Element_Count
argument_list|)
expr_stmt|;
name|vol
operator|->
name|v_mdf_pdisks
operator|=
name|GET8
argument_list|(
name|vmeta
argument_list|,
name|vdc
operator|->
name|MDF_Parity_Disks
argument_list|)
expr_stmt|;
name|vol
operator|->
name|v_mdf_polynomial
operator|=
name|GET16
argument_list|(
name|vmeta
argument_list|,
name|vdc
operator|->
name|MDF_Parity_Generator_Polynomial
argument_list|)
expr_stmt|;
name|vol
operator|->
name|v_mdf_method
operator|=
name|GET8
argument_list|(
name|vmeta
argument_list|,
name|vdc
operator|->
name|MDF_Constant_Generation_Method
argument_list|)
expr_stmt|;
if|if
condition|(
name|GET8
argument_list|(
name|vmeta
argument_list|,
name|vdc
operator|->
name|Rotate_Parity_count
argument_list|)
operator|>
literal|31
condition|)
name|vol
operator|->
name|v_rotate_parity
operator|=
literal|1
expr_stmt|;
else|else
name|vol
operator|->
name|v_rotate_parity
operator|=
literal|1
operator|<<
name|GET8
argument_list|(
name|vmeta
argument_list|,
name|vdc
operator|->
name|Rotate_Parity_count
argument_list|)
expr_stmt|;
name|vol
operator|->
name|v_mediasize
operator|=
name|GET64
argument_list|(
name|vmeta
argument_list|,
name|vdc
operator|->
name|VD_Size
argument_list|)
operator|*
name|vol
operator|->
name|v_sectorsize
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|j
operator|=
literal|0
operator|,
name|bvd
operator|=
literal|0
init|;
name|i
operator|<
name|vol
operator|->
name|v_disks_count
condition|;
name|i
operator|++
operator|,
name|j
operator|++
control|)
block|{
if|if
condition|(
name|j
operator|==
name|GET16
argument_list|(
name|vmeta
argument_list|,
name|vdc
operator|->
name|Primary_Element_Count
argument_list|)
condition|)
block|{
name|j
operator|=
literal|0
expr_stmt|;
name|bvd
operator|++
expr_stmt|;
block|}
name|sd
operator|=
operator|&
name|vol
operator|->
name|v_subdisks
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|vmeta
operator|->
name|bvdc
index|[
name|bvd
index|]
operator|==
name|NULL
condition|)
block|{
name|sd
operator|->
name|sd_offset
operator|=
literal|0
expr_stmt|;
name|sd
operator|->
name|sd_size
operator|=
name|GET64
argument_list|(
name|vmeta
argument_list|,
name|vdc
operator|->
name|Block_Count
argument_list|)
operator|*
name|vol
operator|->
name|v_sectorsize
expr_stmt|;
continue|continue;
block|}
name|val2
operator|=
operator|(
name|uint64_t
operator|*
operator|)
operator|&
operator|(
name|vmeta
operator|->
name|bvdc
index|[
name|bvd
index|]
operator|->
name|Physical_Disk_Sequence
index|[
name|GET16
argument_list|(
name|vmeta
argument_list|,
name|hdr
operator|->
name|Max_Primary_Element_Entries
argument_list|)
index|]
operator|)
expr_stmt|;
name|sd
operator|->
name|sd_offset
operator|=
name|GET64P
argument_list|(
name|vmeta
argument_list|,
name|val2
operator|+
name|j
argument_list|)
operator|*
name|vol
operator|->
name|v_sectorsize
expr_stmt|;
name|sd
operator|->
name|sd_size
operator|=
name|GET64
argument_list|(
name|vmeta
argument_list|,
name|bvdc
index|[
name|bvd
index|]
operator|->
name|Block_Count
argument_list|)
operator|*
name|vol
operator|->
name|v_sectorsize
expr_stmt|;
block|}
name|g_raid_start_volume
argument_list|(
name|vol
argument_list|)
expr_stmt|;
comment|/* Make all disks found till the moment take their places. */
name|TAILQ_FOREACH
argument_list|(
argument|disk
argument_list|,
argument|&sc->sc_disks
argument_list|,
argument|d_next
argument_list|)
block|{
name|pd
operator|=
operator|(
expr|struct
name|g_raid_md_ddf_perdisk
operator|*
operator|)
name|disk
operator|->
name|d_md_data
expr_stmt|;
if|if
condition|(
name|ddf_meta_find_vdc
argument_list|(
operator|&
name|pd
operator|->
name|pd_meta
argument_list|,
name|vmeta
operator|->
name|vdc
operator|->
name|VD_GUID
argument_list|)
operator|!=
name|NULL
condition|)
name|g_raid_md_ddf_start_disk
argument_list|(
name|disk
argument_list|,
name|vol
argument_list|)
expr_stmt|;
block|}
name|pv
operator|->
name|pv_started
operator|=
literal|1
expr_stmt|;
name|mdi
operator|->
name|mdio_starting
operator|--
expr_stmt|;
name|callout_stop
argument_list|(
operator|&
name|pv
operator|->
name|pv_start_co
argument_list|)
expr_stmt|;
name|G_RAID_DEBUG1
argument_list|(
literal|0
argument_list|,
name|sc
argument_list|,
literal|"Volume started."
argument_list|)
expr_stmt|;
name|g_raid_md_write_ddf
argument_list|(
name|md
argument_list|,
name|vol
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* Pickup any STALE/SPARE disks to refill array if needed. */
name|g_raid_md_ddf_refill
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|g_raid_event_send
argument_list|(
name|vol
argument_list|,
name|G_RAID_VOLUME_E_START
argument_list|,
name|G_RAID_EVENT_VOLUME
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|g_raid_ddf_go
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|g_raid_volume
modifier|*
name|vol
decl_stmt|;
name|struct
name|g_raid_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|g_raid_md_ddf_pervolume
modifier|*
name|pv
decl_stmt|;
name|vol
operator|=
name|arg
expr_stmt|;
name|pv
operator|=
name|vol
operator|->
name|v_md_data
expr_stmt|;
name|sc
operator|=
name|vol
operator|->
name|v_softc
expr_stmt|;
if|if
condition|(
operator|!
name|pv
operator|->
name|pv_started
condition|)
block|{
name|G_RAID_DEBUG1
argument_list|(
literal|0
argument_list|,
name|sc
argument_list|,
literal|"Force volume start due to timeout."
argument_list|)
expr_stmt|;
name|g_raid_event_send
argument_list|(
name|vol
argument_list|,
name|G_RAID_VOLUME_E_STARTMD
argument_list|,
name|G_RAID_EVENT_VOLUME
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|g_raid_md_ddf_new_disk
parameter_list|(
name|struct
name|g_raid_disk
modifier|*
name|disk
parameter_list|)
block|{
name|struct
name|g_raid_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|g_raid_md_object
modifier|*
name|md
decl_stmt|;
name|struct
name|g_raid_md_ddf_perdisk
modifier|*
name|pd
decl_stmt|;
name|struct
name|g_raid_md_ddf_pervolume
modifier|*
name|pv
decl_stmt|;
name|struct
name|g_raid_md_ddf_object
modifier|*
name|mdi
decl_stmt|;
name|struct
name|g_raid_volume
modifier|*
name|vol
decl_stmt|;
name|struct
name|ddf_meta
modifier|*
name|pdmeta
decl_stmt|;
name|struct
name|ddf_vol_meta
modifier|*
name|vmeta
decl_stmt|;
name|struct
name|ddf_vdc_record
modifier|*
name|vdc
decl_stmt|;
name|struct
name|ddf_vd_entry
modifier|*
name|vde
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|k
decl_stmt|,
name|num
decl_stmt|,
name|have
decl_stmt|,
name|need
decl_stmt|,
name|cnt
decl_stmt|,
name|spare
decl_stmt|;
name|uint32_t
name|val
decl_stmt|;
name|char
name|buf
index|[
literal|17
index|]
decl_stmt|;
name|sc
operator|=
name|disk
operator|->
name|d_softc
expr_stmt|;
name|md
operator|=
name|sc
operator|->
name|sc_md
expr_stmt|;
name|mdi
operator|=
operator|(
expr|struct
name|g_raid_md_ddf_object
operator|*
operator|)
name|md
expr_stmt|;
name|pd
operator|=
operator|(
expr|struct
name|g_raid_md_ddf_perdisk
operator|*
operator|)
name|disk
operator|->
name|d_md_data
expr_stmt|;
name|pdmeta
operator|=
operator|&
name|pd
operator|->
name|pd_meta
expr_stmt|;
name|spare
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|mdi
operator|->
name|mdio_meta
operator|.
name|hdr
operator|==
name|NULL
condition|)
name|ddf_meta_copy
argument_list|(
operator|&
name|mdi
operator|->
name|mdio_meta
argument_list|,
name|pdmeta
argument_list|)
expr_stmt|;
else|else
name|ddf_meta_update
argument_list|(
operator|&
name|mdi
operator|->
name|mdio_meta
argument_list|,
name|pdmeta
argument_list|)
expr_stmt|;
name|num
operator|=
name|GETCRNUM
argument_list|(
name|pdmeta
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|num
condition|;
name|j
operator|++
control|)
block|{
name|vdc
operator|=
name|GETVDCPTR
argument_list|(
name|pdmeta
argument_list|,
name|j
argument_list|)
expr_stmt|;
name|val
operator|=
name|GET32D
argument_list|(
name|pdmeta
argument_list|,
name|vdc
operator|->
name|Signature
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|==
name|DDF_SA_SIGNATURE
operator|&&
name|spare
operator|==
operator|-
literal|1
condition|)
name|spare
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|val
operator|!=
name|DDF_VDCR_SIGNATURE
condition|)
continue|continue;
name|spare
operator|=
literal|0
expr_stmt|;
name|k
operator|=
name|ddf_meta_find_vd
argument_list|(
name|pdmeta
argument_list|,
name|vdc
operator|->
name|VD_GUID
argument_list|)
expr_stmt|;
if|if
condition|(
name|k
operator|<
literal|0
condition|)
continue|continue;
name|vde
operator|=
operator|&
name|pdmeta
operator|->
name|vdr
operator|->
name|entry
index|[
name|k
index|]
expr_stmt|;
comment|/* Look for volume with matching ID. */
name|vol
operator|=
name|g_raid_md_ddf_get_volume
argument_list|(
name|sc
argument_list|,
name|vdc
operator|->
name|VD_GUID
argument_list|)
expr_stmt|;
if|if
condition|(
name|vol
operator|==
name|NULL
condition|)
block|{
name|ddf_meta_get_name
argument_list|(
name|pdmeta
argument_list|,
name|k
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|vol
operator|=
name|g_raid_create_volume
argument_list|(
name|sc
argument_list|,
name|buf
argument_list|,
name|GET16D
argument_list|(
name|pdmeta
argument_list|,
name|vde
operator|->
name|VD_Number
argument_list|)
argument_list|)
expr_stmt|;
name|pv
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|pv
argument_list|)
argument_list|,
name|M_MD_DDF
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|vol
operator|->
name|v_md_data
operator|=
name|pv
expr_stmt|;
name|callout_init
argument_list|(
operator|&
name|pv
operator|->
name|pv_start_co
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|callout_reset
argument_list|(
operator|&
name|pv
operator|->
name|pv_start_co
argument_list|,
name|g_raid_start_timeout
operator|*
name|hz
argument_list|,
name|g_raid_ddf_go
argument_list|,
name|vol
argument_list|)
expr_stmt|;
name|mdi
operator|->
name|mdio_starting
operator|++
expr_stmt|;
block|}
else|else
name|pv
operator|=
name|vol
operator|->
name|v_md_data
expr_stmt|;
comment|/* If we haven't started yet - check metadata freshness. */
name|vmeta
operator|=
operator|&
name|pv
operator|->
name|pv_meta
expr_stmt|;
name|ddf_vol_meta_update
argument_list|(
name|vmeta
argument_list|,
name|pdmeta
argument_list|,
name|vdc
operator|->
name|VD_GUID
argument_list|,
name|pv
operator|->
name|pv_started
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|spare
operator|==
literal|1
condition|)
block|{
name|g_raid_change_disk_state
argument_list|(
name|disk
argument_list|,
name|G_RAID_DISK_S_SPARE
argument_list|)
expr_stmt|;
name|g_raid_md_ddf_refill
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
name|TAILQ_FOREACH
argument_list|(
argument|vol
argument_list|,
argument|&sc->sc_volumes
argument_list|,
argument|v_next
argument_list|)
block|{
name|pv
operator|=
name|vol
operator|->
name|v_md_data
expr_stmt|;
name|vmeta
operator|=
operator|&
name|pv
operator|->
name|pv_meta
expr_stmt|;
if|if
condition|(
name|ddf_meta_find_vdc
argument_list|(
name|pdmeta
argument_list|,
name|vmeta
operator|->
name|vdc
operator|->
name|VD_GUID
argument_list|)
operator|==
name|NULL
condition|)
continue|continue;
if|if
condition|(
name|pv
operator|->
name|pv_started
condition|)
block|{
if|if
condition|(
name|g_raid_md_ddf_start_disk
argument_list|(
name|disk
argument_list|,
name|vol
argument_list|)
condition|)
name|g_raid_md_write_ddf
argument_list|(
name|md
argument_list|,
name|vol
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
continue|continue;
block|}
comment|/* If we collected all needed disks - start array. */
name|need
operator|=
literal|0
expr_stmt|;
name|have
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
name|GET8
argument_list|(
name|vmeta
argument_list|,
name|vdc
operator|->
name|Secondary_Element_Count
argument_list|)
condition|;
name|k
operator|++
control|)
block|{
if|if
condition|(
name|vmeta
operator|->
name|bvdc
index|[
name|k
index|]
operator|==
name|NULL
condition|)
block|{
name|need
operator|+=
name|GET16
argument_list|(
name|vmeta
argument_list|,
name|vdc
operator|->
name|Primary_Element_Count
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|cnt
operator|=
name|GET16
argument_list|(
name|vmeta
argument_list|,
name|bvdc
index|[
name|k
index|]
operator|->
name|Primary_Element_Count
argument_list|)
expr_stmt|;
name|need
operator|+=
name|cnt
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cnt
condition|;
name|i
operator|++
control|)
block|{
name|val
operator|=
name|GET32
argument_list|(
name|vmeta
argument_list|,
name|bvdc
index|[
name|k
index|]
operator|->
name|Physical_Disk_Sequence
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|g_raid_md_ddf_get_disk
argument_list|(
name|sc
argument_list|,
name|NULL
argument_list|,
name|val
argument_list|)
operator|!=
name|NULL
condition|)
name|have
operator|++
expr_stmt|;
block|}
block|}
name|G_RAID_DEBUG1
argument_list|(
literal|1
argument_list|,
name|sc
argument_list|,
literal|"Volume %s now has %d of %d disks"
argument_list|,
name|vol
operator|->
name|v_name
argument_list|,
name|have
argument_list|,
name|need
argument_list|)
expr_stmt|;
if|if
condition|(
name|have
operator|==
name|need
condition|)
name|g_raid_md_ddf_start
argument_list|(
name|vol
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|g_raid_md_create_req_ddf
parameter_list|(
name|struct
name|g_raid_md_object
modifier|*
name|md
parameter_list|,
name|struct
name|g_class
modifier|*
name|mp
parameter_list|,
name|struct
name|gctl_req
modifier|*
name|req
parameter_list|,
name|struct
name|g_geom
modifier|*
modifier|*
name|gp
parameter_list|)
block|{
name|struct
name|g_geom
modifier|*
name|geom
decl_stmt|;
name|struct
name|g_raid_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|g_raid_md_ddf_object
modifier|*
name|mdi
decl_stmt|,
modifier|*
name|mdi1
decl_stmt|;
name|char
name|name
index|[
literal|16
index|]
decl_stmt|;
specifier|const
name|char
modifier|*
name|fmtopt
decl_stmt|;
name|int
name|be
init|=
literal|1
decl_stmt|;
name|mdi
operator|=
operator|(
expr|struct
name|g_raid_md_ddf_object
operator|*
operator|)
name|md
expr_stmt|;
name|fmtopt
operator|=
name|gctl_get_asciiparam
argument_list|(
name|req
argument_list|,
literal|"fmtopt"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fmtopt
operator|==
name|NULL
operator|||
name|strcasecmp
argument_list|(
name|fmtopt
argument_list|,
literal|"BE"
argument_list|)
operator|==
literal|0
condition|)
name|be
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|fmtopt
argument_list|,
literal|"LE"
argument_list|)
operator|==
literal|0
condition|)
name|be
operator|=
literal|0
expr_stmt|;
else|else
block|{
name|gctl_error
argument_list|(
name|req
argument_list|,
literal|"Incorrect fmtopt argument."
argument_list|)
expr_stmt|;
return|return
operator|(
name|G_RAID_MD_TASTE_FAIL
operator|)
return|;
block|}
comment|/* Search for existing node. */
name|LIST_FOREACH
argument_list|(
argument|geom
argument_list|,
argument|&mp->geom
argument_list|,
argument|geom
argument_list|)
block|{
name|sc
operator|=
name|geom
operator|->
name|softc
expr_stmt|;
if|if
condition|(
name|sc
operator|==
name|NULL
condition|)
continue|continue;
if|if
condition|(
name|sc
operator|->
name|sc_stopping
operator|!=
literal|0
condition|)
continue|continue;
if|if
condition|(
name|sc
operator|->
name|sc_md
operator|->
name|mdo_class
operator|!=
name|md
operator|->
name|mdo_class
condition|)
continue|continue;
name|mdi1
operator|=
operator|(
expr|struct
name|g_raid_md_ddf_object
operator|*
operator|)
name|sc
operator|->
name|sc_md
expr_stmt|;
if|if
condition|(
name|mdi1
operator|->
name|mdio_bigendian
operator|!=
name|be
condition|)
continue|continue;
break|break;
block|}
if|if
condition|(
name|geom
operator|!=
name|NULL
condition|)
block|{
operator|*
name|gp
operator|=
name|geom
expr_stmt|;
return|return
operator|(
name|G_RAID_MD_TASTE_EXISTING
operator|)
return|;
block|}
comment|/* Create new one if not found. */
name|mdi
operator|->
name|mdio_bigendian
operator|=
name|be
expr_stmt|;
name|snprintf
argument_list|(
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|name
argument_list|)
argument_list|,
literal|"DDF%s"
argument_list|,
name|be
condition|?
literal|""
else|:
literal|"-LE"
argument_list|)
expr_stmt|;
name|sc
operator|=
name|g_raid_create_node
argument_list|(
name|mp
argument_list|,
name|name
argument_list|,
name|md
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|==
name|NULL
condition|)
return|return
operator|(
name|G_RAID_MD_TASTE_FAIL
operator|)
return|;
name|md
operator|->
name|mdo_softc
operator|=
name|sc
expr_stmt|;
operator|*
name|gp
operator|=
name|sc
operator|->
name|sc_geom
expr_stmt|;
return|return
operator|(
name|G_RAID_MD_TASTE_NEW
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|g_raid_md_taste_ddf
parameter_list|(
name|struct
name|g_raid_md_object
modifier|*
name|md
parameter_list|,
name|struct
name|g_class
modifier|*
name|mp
parameter_list|,
name|struct
name|g_consumer
modifier|*
name|cp
parameter_list|,
name|struct
name|g_geom
modifier|*
modifier|*
name|gp
parameter_list|)
block|{
name|struct
name|g_consumer
modifier|*
name|rcp
decl_stmt|;
name|struct
name|g_provider
modifier|*
name|pp
decl_stmt|;
name|struct
name|g_raid_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|g_raid_disk
modifier|*
name|disk
decl_stmt|;
name|struct
name|ddf_meta
name|meta
decl_stmt|;
name|struct
name|g_raid_md_ddf_perdisk
modifier|*
name|pd
decl_stmt|;
name|struct
name|g_raid_md_ddf_object
modifier|*
name|mdi
decl_stmt|;
name|struct
name|g_geom
modifier|*
name|geom
decl_stmt|;
name|int
name|error
decl_stmt|,
name|result
decl_stmt|,
name|be
decl_stmt|;
name|char
name|name
index|[
literal|16
index|]
decl_stmt|;
name|G_RAID_DEBUG
argument_list|(
literal|1
argument_list|,
literal|"Tasting DDF on %s"
argument_list|,
name|cp
operator|->
name|provider
operator|->
name|name
argument_list|)
expr_stmt|;
name|mdi
operator|=
operator|(
expr|struct
name|g_raid_md_ddf_object
operator|*
operator|)
name|md
expr_stmt|;
name|pp
operator|=
name|cp
operator|->
name|provider
expr_stmt|;
comment|/* Read metadata from device. */
name|g_topology_unlock
argument_list|()
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|meta
argument_list|,
sizeof|sizeof
argument_list|(
name|meta
argument_list|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|ddf_meta_read
argument_list|(
name|cp
argument_list|,
operator|&
name|meta
argument_list|)
expr_stmt|;
name|g_topology_lock
argument_list|()
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|G_RAID_MD_TASTE_FAIL
operator|)
return|;
name|be
operator|=
name|meta
operator|.
name|bigendian
expr_stmt|;
comment|/* Metadata valid. Print it. */
name|g_raid_md_ddf_print
argument_list|(
operator|&
name|meta
argument_list|)
expr_stmt|;
comment|/* Search for matching node. */
name|sc
operator|=
name|NULL
expr_stmt|;
name|LIST_FOREACH
argument_list|(
argument|geom
argument_list|,
argument|&mp->geom
argument_list|,
argument|geom
argument_list|)
block|{
name|sc
operator|=
name|geom
operator|->
name|softc
expr_stmt|;
if|if
condition|(
name|sc
operator|==
name|NULL
condition|)
continue|continue;
if|if
condition|(
name|sc
operator|->
name|sc_stopping
operator|!=
literal|0
condition|)
continue|continue;
if|if
condition|(
name|sc
operator|->
name|sc_md
operator|->
name|mdo_class
operator|!=
name|md
operator|->
name|mdo_class
condition|)
continue|continue;
name|mdi
operator|=
operator|(
expr|struct
name|g_raid_md_ddf_object
operator|*
operator|)
name|sc
operator|->
name|sc_md
expr_stmt|;
if|if
condition|(
name|mdi
operator|->
name|mdio_bigendian
operator|!=
name|be
condition|)
continue|continue;
break|break;
block|}
comment|/* Found matching node. */
if|if
condition|(
name|geom
operator|!=
name|NULL
condition|)
block|{
name|G_RAID_DEBUG
argument_list|(
literal|1
argument_list|,
literal|"Found matching array %s"
argument_list|,
name|sc
operator|->
name|sc_name
argument_list|)
expr_stmt|;
name|result
operator|=
name|G_RAID_MD_TASTE_EXISTING
expr_stmt|;
block|}
else|else
block|{
comment|/* Not found matching node -- create one. */
name|result
operator|=
name|G_RAID_MD_TASTE_NEW
expr_stmt|;
name|mdi
operator|->
name|mdio_bigendian
operator|=
name|be
expr_stmt|;
name|snprintf
argument_list|(
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|name
argument_list|)
argument_list|,
literal|"DDF%s"
argument_list|,
name|be
condition|?
literal|""
else|:
literal|"-LE"
argument_list|)
expr_stmt|;
name|sc
operator|=
name|g_raid_create_node
argument_list|(
name|mp
argument_list|,
name|name
argument_list|,
name|md
argument_list|)
expr_stmt|;
name|md
operator|->
name|mdo_softc
operator|=
name|sc
expr_stmt|;
name|geom
operator|=
name|sc
operator|->
name|sc_geom
expr_stmt|;
block|}
comment|/* There is no return after this point, so we close passed consumer. */
name|g_access
argument_list|(
name|cp
argument_list|,
operator|-
literal|1
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rcp
operator|=
name|g_new_consumer
argument_list|(
name|geom
argument_list|)
expr_stmt|;
name|g_attach
argument_list|(
name|rcp
argument_list|,
name|pp
argument_list|)
expr_stmt|;
if|if
condition|(
name|g_access
argument_list|(
name|rcp
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|!=
literal|0
condition|)
empty_stmt|;
comment|//goto fail1;
name|g_topology_unlock
argument_list|()
expr_stmt|;
name|sx_xlock
argument_list|(
operator|&
name|sc
operator|->
name|sc_lock
argument_list|)
expr_stmt|;
name|pd
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|pd
argument_list|)
argument_list|,
name|M_MD_DDF
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|pd
operator|->
name|pd_meta
operator|=
name|meta
expr_stmt|;
name|disk
operator|=
name|g_raid_create_disk
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|disk
operator|->
name|d_md_data
operator|=
operator|(
name|void
operator|*
operator|)
name|pd
expr_stmt|;
name|disk
operator|->
name|d_consumer
operator|=
name|rcp
expr_stmt|;
name|rcp
operator|->
name|private
operator|=
name|disk
expr_stmt|;
name|g_raid_get_disk_info
argument_list|(
name|disk
argument_list|)
expr_stmt|;
name|g_raid_md_ddf_new_disk
argument_list|(
name|disk
argument_list|)
expr_stmt|;
name|sx_xunlock
argument_list|(
operator|&
name|sc
operator|->
name|sc_lock
argument_list|)
expr_stmt|;
name|g_topology_lock
argument_list|()
expr_stmt|;
operator|*
name|gp
operator|=
name|geom
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|g_raid_md_event_ddf
parameter_list|(
name|struct
name|g_raid_md_object
modifier|*
name|md
parameter_list|,
name|struct
name|g_raid_disk
modifier|*
name|disk
parameter_list|,
name|u_int
name|event
parameter_list|)
block|{
name|struct
name|g_raid_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|md
operator|->
name|mdo_softc
expr_stmt|;
if|if
condition|(
name|disk
operator|==
name|NULL
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
switch|switch
condition|(
name|event
condition|)
block|{
case|case
name|G_RAID_DISK_E_DISCONNECTED
case|:
comment|/* Delete disk. */
name|g_raid_change_disk_state
argument_list|(
name|disk
argument_list|,
name|G_RAID_DISK_S_NONE
argument_list|)
expr_stmt|;
name|g_raid_destroy_disk
argument_list|(
name|disk
argument_list|)
expr_stmt|;
name|g_raid_md_ddf_purge_volumes
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Write updated metadata to all disks. */
name|g_raid_md_write_ddf
argument_list|(
name|md
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* Check if anything left. */
if|if
condition|(
name|g_raid_ndisks
argument_list|(
name|sc
argument_list|,
operator|-
literal|1
argument_list|)
operator|==
literal|0
condition|)
name|g_raid_destroy_node
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
name|g_raid_md_ddf_refill
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
return|return
operator|(
operator|-
literal|2
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|g_raid_md_volume_event_ddf
parameter_list|(
name|struct
name|g_raid_md_object
modifier|*
name|md
parameter_list|,
name|struct
name|g_raid_volume
modifier|*
name|vol
parameter_list|,
name|u_int
name|event
parameter_list|)
block|{
name|struct
name|g_raid_md_ddf_pervolume
modifier|*
name|pv
decl_stmt|;
name|pv
operator|=
operator|(
expr|struct
name|g_raid_md_ddf_pervolume
operator|*
operator|)
name|vol
operator|->
name|v_md_data
expr_stmt|;
switch|switch
condition|(
name|event
condition|)
block|{
case|case
name|G_RAID_VOLUME_E_STARTMD
case|:
if|if
condition|(
operator|!
name|pv
operator|->
name|pv_started
condition|)
name|g_raid_md_ddf_start
argument_list|(
name|vol
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
return|return
operator|(
operator|-
literal|2
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|g_raid_md_ctl_ddf
parameter_list|(
name|struct
name|g_raid_md_object
modifier|*
name|md
parameter_list|,
name|struct
name|gctl_req
modifier|*
name|req
parameter_list|)
block|{
name|struct
name|g_raid_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|g_raid_volume
modifier|*
name|vol
decl_stmt|,
modifier|*
name|vol1
decl_stmt|;
name|struct
name|g_raid_subdisk
modifier|*
name|sd
decl_stmt|;
name|struct
name|g_raid_disk
modifier|*
name|disk
decl_stmt|,
modifier|*
name|disks
index|[
name|DDF_MAX_DISKS_HARD
index|]
decl_stmt|;
name|struct
name|g_raid_md_ddf_perdisk
modifier|*
name|pd
decl_stmt|;
name|struct
name|g_raid_md_ddf_pervolume
modifier|*
name|pv
decl_stmt|;
name|struct
name|g_raid_md_ddf_object
modifier|*
name|mdi
decl_stmt|;
name|struct
name|ddf_sa_record
modifier|*
name|sa
decl_stmt|;
name|struct
name|g_consumer
modifier|*
name|cp
decl_stmt|;
name|struct
name|g_provider
modifier|*
name|pp
decl_stmt|;
name|char
name|arg
index|[
literal|16
index|]
decl_stmt|;
specifier|const
name|char
modifier|*
name|nodename
decl_stmt|,
modifier|*
name|verb
decl_stmt|,
modifier|*
name|volname
decl_stmt|,
modifier|*
name|levelname
decl_stmt|,
modifier|*
name|diskname
decl_stmt|;
name|char
modifier|*
name|tmp
decl_stmt|;
name|int
modifier|*
name|nargs
decl_stmt|,
modifier|*
name|force
decl_stmt|;
name|off_t
name|size
decl_stmt|,
name|sectorsize
decl_stmt|,
name|strip
decl_stmt|,
name|offs
index|[
name|DDF_MAX_DISKS_HARD
index|]
decl_stmt|,
name|esize
decl_stmt|;
name|intmax_t
modifier|*
name|sizearg
decl_stmt|,
modifier|*
name|striparg
decl_stmt|;
name|int
name|i
decl_stmt|,
name|numdisks
decl_stmt|,
name|len
decl_stmt|,
name|level
decl_stmt|,
name|qual
decl_stmt|;
name|int
name|error
decl_stmt|;
name|sc
operator|=
name|md
operator|->
name|mdo_softc
expr_stmt|;
name|mdi
operator|=
operator|(
expr|struct
name|g_raid_md_ddf_object
operator|*
operator|)
name|md
expr_stmt|;
name|verb
operator|=
name|gctl_get_param
argument_list|(
name|req
argument_list|,
literal|"verb"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|nargs
operator|=
name|gctl_get_paraml
argument_list|(
name|req
argument_list|,
literal|"nargs"
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|nargs
argument_list|)
argument_list|)
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|verb
argument_list|,
literal|"label"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|*
name|nargs
operator|<
literal|4
condition|)
block|{
name|gctl_error
argument_list|(
name|req
argument_list|,
literal|"Invalid number of arguments."
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|volname
operator|=
name|gctl_get_asciiparam
argument_list|(
name|req
argument_list|,
literal|"arg1"
argument_list|)
expr_stmt|;
if|if
condition|(
name|volname
operator|==
name|NULL
condition|)
block|{
name|gctl_error
argument_list|(
name|req
argument_list|,
literal|"No volume name."
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|2
operator|)
return|;
block|}
name|levelname
operator|=
name|gctl_get_asciiparam
argument_list|(
name|req
argument_list|,
literal|"arg2"
argument_list|)
expr_stmt|;
if|if
condition|(
name|levelname
operator|==
name|NULL
condition|)
block|{
name|gctl_error
argument_list|(
name|req
argument_list|,
literal|"No RAID level."
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|3
operator|)
return|;
block|}
if|if
condition|(
name|g_raid_volume_str2level
argument_list|(
name|levelname
argument_list|,
operator|&
name|level
argument_list|,
operator|&
name|qual
argument_list|)
condition|)
block|{
name|gctl_error
argument_list|(
name|req
argument_list|,
literal|"Unknown RAID level '%s'."
argument_list|,
name|levelname
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|4
operator|)
return|;
block|}
name|numdisks
operator|=
operator|*
name|nargs
operator|-
literal|3
expr_stmt|;
name|force
operator|=
name|gctl_get_paraml
argument_list|(
name|req
argument_list|,
literal|"force"
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|force
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|g_raid_md_ddf_supported
argument_list|(
name|level
argument_list|,
name|qual
argument_list|,
name|numdisks
argument_list|,
name|force
condition|?
operator|*
name|force
else|:
literal|0
argument_list|)
condition|)
block|{
name|gctl_error
argument_list|(
name|req
argument_list|,
literal|"Unsupported RAID level "
literal|"(0x%02x/0x%02x), or number of disks (%d)."
argument_list|,
name|level
argument_list|,
name|qual
argument_list|,
name|numdisks
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|5
operator|)
return|;
block|}
comment|/* Search for disks, connect them and probe. */
name|size
operator|=
name|INT64_MAX
expr_stmt|;
name|sectorsize
operator|=
literal|0
expr_stmt|;
name|bzero
argument_list|(
name|disks
argument_list|,
sizeof|sizeof
argument_list|(
name|disks
argument_list|)
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|offs
argument_list|,
sizeof|sizeof
argument_list|(
name|offs
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|numdisks
condition|;
name|i
operator|++
control|)
block|{
name|snprintf
argument_list|(
name|arg
argument_list|,
sizeof|sizeof
argument_list|(
name|arg
argument_list|)
argument_list|,
literal|"arg%d"
argument_list|,
name|i
operator|+
literal|3
argument_list|)
expr_stmt|;
name|diskname
operator|=
name|gctl_get_asciiparam
argument_list|(
name|req
argument_list|,
name|arg
argument_list|)
expr_stmt|;
if|if
condition|(
name|diskname
operator|==
name|NULL
condition|)
block|{
name|gctl_error
argument_list|(
name|req
argument_list|,
literal|"No disk name (%s)."
argument_list|,
name|arg
argument_list|)
expr_stmt|;
name|error
operator|=
operator|-
literal|6
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|diskname
argument_list|,
literal|"NONE"
argument_list|)
operator|==
literal|0
condition|)
continue|continue;
name|TAILQ_FOREACH
argument_list|(
argument|disk
argument_list|,
argument|&sc->sc_disks
argument_list|,
argument|d_next
argument_list|)
block|{
if|if
condition|(
name|disk
operator|->
name|d_consumer
operator|!=
name|NULL
operator|&&
name|disk
operator|->
name|d_consumer
operator|->
name|provider
operator|!=
name|NULL
operator|&&
name|strcmp
argument_list|(
name|disk
operator|->
name|d_consumer
operator|->
name|provider
operator|->
name|name
argument_list|,
name|diskname
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|disk
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|disk
operator|->
name|d_state
operator|!=
name|G_RAID_DISK_S_ACTIVE
condition|)
block|{
name|gctl_error
argument_list|(
name|req
argument_list|,
literal|"Disk '%s' is in a "
literal|"wrong state (%s)."
argument_list|,
name|diskname
argument_list|,
name|g_raid_disk_state2str
argument_list|(
name|disk
operator|->
name|d_state
argument_list|)
argument_list|)
expr_stmt|;
name|error
operator|=
operator|-
literal|7
expr_stmt|;
break|break;
block|}
name|pd
operator|=
name|disk
operator|->
name|d_md_data
expr_stmt|;
if|if
condition|(
name|ddf_meta_count_vdc
argument_list|(
operator|&
name|pd
operator|->
name|pd_meta
argument_list|,
name|NULL
argument_list|)
operator|>=
name|GET16
argument_list|(
operator|&
name|pd
operator|->
name|pd_meta
argument_list|,
name|hdr
operator|->
name|Max_Partitions
argument_list|)
condition|)
block|{
name|gctl_error
argument_list|(
name|req
argument_list|,
literal|"No free partitions "
literal|"on disk '%s'."
argument_list|,
name|diskname
argument_list|)
expr_stmt|;
name|error
operator|=
operator|-
literal|7
expr_stmt|;
break|break;
block|}
name|pp
operator|=
name|disk
operator|->
name|d_consumer
operator|->
name|provider
expr_stmt|;
name|disks
index|[
name|i
index|]
operator|=
name|disk
expr_stmt|;
name|ddf_meta_unused_range
argument_list|(
operator|&
name|pd
operator|->
name|pd_meta
argument_list|,
operator|&
name|offs
index|[
name|i
index|]
argument_list|,
operator|&
name|esize
argument_list|)
expr_stmt|;
name|offs
index|[
name|i
index|]
operator|*=
name|pp
operator|->
name|sectorsize
expr_stmt|;
name|size
operator|=
name|MIN
argument_list|(
name|size
argument_list|,
operator|(
name|off_t
operator|)
name|esize
operator|*
name|pp
operator|->
name|sectorsize
argument_list|)
expr_stmt|;
name|sectorsize
operator|=
name|MAX
argument_list|(
name|sectorsize
argument_list|,
name|pp
operator|->
name|sectorsize
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|g_topology_lock
argument_list|()
expr_stmt|;
name|cp
operator|=
name|g_raid_open_consumer
argument_list|(
name|sc
argument_list|,
name|diskname
argument_list|)
expr_stmt|;
if|if
condition|(
name|cp
operator|==
name|NULL
condition|)
block|{
name|gctl_error
argument_list|(
name|req
argument_list|,
literal|"Can't open disk '%s'."
argument_list|,
name|diskname
argument_list|)
expr_stmt|;
name|g_topology_unlock
argument_list|()
expr_stmt|;
name|error
operator|=
operator|-
literal|8
expr_stmt|;
break|break;
block|}
name|pp
operator|=
name|cp
operator|->
name|provider
expr_stmt|;
name|pd
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|pd
argument_list|)
argument_list|,
name|M_MD_DDF
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|disk
operator|=
name|g_raid_create_disk
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|disk
operator|->
name|d_md_data
operator|=
operator|(
name|void
operator|*
operator|)
name|pd
expr_stmt|;
name|disk
operator|->
name|d_consumer
operator|=
name|cp
expr_stmt|;
name|disks
index|[
name|i
index|]
operator|=
name|disk
expr_stmt|;
name|cp
operator|->
name|private
operator|=
name|disk
expr_stmt|;
name|ddf_meta_create
argument_list|(
name|disk
argument_list|,
operator|&
name|mdi
operator|->
name|mdio_meta
argument_list|)
expr_stmt|;
if|if
condition|(
name|mdi
operator|->
name|mdio_meta
operator|.
name|hdr
operator|==
name|NULL
condition|)
name|ddf_meta_copy
argument_list|(
operator|&
name|mdi
operator|->
name|mdio_meta
argument_list|,
operator|&
name|pd
operator|->
name|pd_meta
argument_list|)
expr_stmt|;
else|else
name|ddf_meta_update
argument_list|(
operator|&
name|mdi
operator|->
name|mdio_meta
argument_list|,
operator|&
name|pd
operator|->
name|pd_meta
argument_list|)
expr_stmt|;
name|g_topology_unlock
argument_list|()
expr_stmt|;
name|g_raid_get_disk_info
argument_list|(
name|disk
argument_list|)
expr_stmt|;
comment|/* Reserve some space for metadata. */
name|size
operator|=
name|MIN
argument_list|(
name|size
argument_list|,
name|GET64
argument_list|(
operator|&
name|pd
operator|->
name|pd_meta
argument_list|,
name|pdr
operator|->
name|entry
index|[
literal|0
index|]
operator|.
name|Configured_Size
argument_list|)
operator|*
name|pp
operator|->
name|sectorsize
argument_list|)
expr_stmt|;
name|sectorsize
operator|=
name|MAX
argument_list|(
name|sectorsize
argument_list|,
name|pp
operator|->
name|sectorsize
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|numdisks
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|disks
index|[
name|i
index|]
operator|!=
name|NULL
operator|&&
name|disks
index|[
name|i
index|]
operator|->
name|d_state
operator|==
name|G_RAID_DISK_S_NONE
condition|)
name|g_raid_destroy_disk
argument_list|(
name|disks
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
if|if
condition|(
name|sectorsize
operator|<=
literal|0
condition|)
block|{
name|gctl_error
argument_list|(
name|req
argument_list|,
literal|"Can't get sector size."
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|8
operator|)
return|;
block|}
comment|/* Handle size argument. */
name|len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|sizearg
argument_list|)
expr_stmt|;
name|sizearg
operator|=
name|gctl_get_param
argument_list|(
name|req
argument_list|,
literal|"size"
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|sizearg
operator|!=
name|NULL
operator|&&
name|len
operator|==
sizeof|sizeof
argument_list|(
operator|*
name|sizearg
argument_list|)
operator|&&
operator|*
name|sizearg
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|*
name|sizearg
operator|>
name|size
condition|)
block|{
name|gctl_error
argument_list|(
name|req
argument_list|,
literal|"Size too big %lld> %lld."
argument_list|,
operator|(
name|long
name|long
operator|)
operator|*
name|sizearg
argument_list|,
operator|(
name|long
name|long
operator|)
name|size
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|9
operator|)
return|;
block|}
name|size
operator|=
operator|*
name|sizearg
expr_stmt|;
block|}
comment|/* Handle strip argument. */
name|strip
operator|=
literal|131072
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|striparg
argument_list|)
expr_stmt|;
name|striparg
operator|=
name|gctl_get_param
argument_list|(
name|req
argument_list|,
literal|"strip"
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|striparg
operator|!=
name|NULL
operator|&&
name|len
operator|==
sizeof|sizeof
argument_list|(
operator|*
name|striparg
argument_list|)
operator|&&
operator|*
name|striparg
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|*
name|striparg
operator|<
name|sectorsize
condition|)
block|{
name|gctl_error
argument_list|(
name|req
argument_list|,
literal|"Strip size too small."
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|10
operator|)
return|;
block|}
if|if
condition|(
operator|*
name|striparg
operator|%
name|sectorsize
operator|!=
literal|0
condition|)
block|{
name|gctl_error
argument_list|(
name|req
argument_list|,
literal|"Incorrect strip size."
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|11
operator|)
return|;
block|}
name|strip
operator|=
operator|*
name|striparg
expr_stmt|;
block|}
comment|/* Round size down to strip or sector. */
if|if
condition|(
name|level
operator|==
name|G_RAID_VOLUME_RL_RAID1
operator|||
name|level
operator|==
name|G_RAID_VOLUME_RL_RAID3
operator|||
name|level
operator|==
name|G_RAID_VOLUME_RL_SINGLE
operator|||
name|level
operator|==
name|G_RAID_VOLUME_RL_CONCAT
condition|)
name|size
operator|-=
operator|(
name|size
operator|%
name|sectorsize
operator|)
expr_stmt|;
elseif|else
if|if
condition|(
name|level
operator|==
name|G_RAID_VOLUME_RL_RAID1E
operator|&&
operator|(
name|numdisks
operator|&
literal|1
operator|)
operator|!=
literal|0
condition|)
name|size
operator|-=
operator|(
name|size
operator|%
operator|(
literal|2
operator|*
name|strip
operator|)
operator|)
expr_stmt|;
else|else
name|size
operator|-=
operator|(
name|size
operator|%
name|strip
operator|)
expr_stmt|;
if|if
condition|(
name|size
operator|<=
literal|0
condition|)
block|{
name|gctl_error
argument_list|(
name|req
argument_list|,
literal|"Size too small."
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|13
operator|)
return|;
block|}
comment|/* We have all we need, create things: volume, ... */
name|pv
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|pv
argument_list|)
argument_list|,
name|M_MD_DDF
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|ddf_vol_meta_create
argument_list|(
operator|&
name|pv
operator|->
name|pv_meta
argument_list|,
operator|&
name|mdi
operator|->
name|mdio_meta
argument_list|)
expr_stmt|;
name|pv
operator|->
name|pv_started
operator|=
literal|1
expr_stmt|;
name|vol
operator|=
name|g_raid_create_volume
argument_list|(
name|sc
argument_list|,
name|volname
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|vol
operator|->
name|v_md_data
operator|=
name|pv
expr_stmt|;
name|vol
operator|->
name|v_raid_level
operator|=
name|level
expr_stmt|;
name|vol
operator|->
name|v_raid_level_qualifier
operator|=
name|qual
expr_stmt|;
name|vol
operator|->
name|v_strip_size
operator|=
name|strip
expr_stmt|;
name|vol
operator|->
name|v_disks_count
operator|=
name|numdisks
expr_stmt|;
if|if
condition|(
name|level
operator|==
name|G_RAID_VOLUME_RL_RAID0
operator|||
name|level
operator|==
name|G_RAID_VOLUME_RL_CONCAT
operator|||
name|level
operator|==
name|G_RAID_VOLUME_RL_SINGLE
condition|)
name|vol
operator|->
name|v_mediasize
operator|=
name|size
operator|*
name|numdisks
expr_stmt|;
elseif|else
if|if
condition|(
name|level
operator|==
name|G_RAID_VOLUME_RL_RAID1
condition|)
name|vol
operator|->
name|v_mediasize
operator|=
name|size
expr_stmt|;
elseif|else
if|if
condition|(
name|level
operator|==
name|G_RAID_VOLUME_RL_RAID3
operator|||
name|level
operator|==
name|G_RAID_VOLUME_RL_RAID4
operator|||
name|level
operator|==
name|G_RAID_VOLUME_RL_RAID5
condition|)
name|vol
operator|->
name|v_mediasize
operator|=
name|size
operator|*
operator|(
name|numdisks
operator|-
literal|1
operator|)
expr_stmt|;
elseif|else
if|if
condition|(
name|level
operator|==
name|G_RAID_VOLUME_RL_RAID5R
condition|)
block|{
name|vol
operator|->
name|v_mediasize
operator|=
name|size
operator|*
operator|(
name|numdisks
operator|-
literal|1
operator|)
expr_stmt|;
name|vol
operator|->
name|v_rotate_parity
operator|=
literal|1024
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|level
operator|==
name|G_RAID_VOLUME_RL_RAID6
operator|||
name|level
operator|==
name|G_RAID_VOLUME_RL_RAID5E
operator|||
name|level
operator|==
name|G_RAID_VOLUME_RL_RAID5EE
condition|)
name|vol
operator|->
name|v_mediasize
operator|=
name|size
operator|*
operator|(
name|numdisks
operator|-
literal|2
operator|)
expr_stmt|;
elseif|else
if|if
condition|(
name|level
operator|==
name|G_RAID_VOLUME_RL_RAIDMDF
condition|)
block|{
if|if
condition|(
name|numdisks
operator|<
literal|5
condition|)
name|vol
operator|->
name|v_mdf_pdisks
operator|=
literal|2
expr_stmt|;
else|else
name|vol
operator|->
name|v_mdf_pdisks
operator|=
literal|3
expr_stmt|;
name|vol
operator|->
name|v_mdf_polynomial
operator|=
literal|0x11d
expr_stmt|;
name|vol
operator|->
name|v_mdf_method
operator|=
literal|0x00
expr_stmt|;
name|vol
operator|->
name|v_mediasize
operator|=
name|size
operator|*
operator|(
name|numdisks
operator|-
name|vol
operator|->
name|v_mdf_pdisks
operator|)
expr_stmt|;
block|}
else|else
block|{
comment|/* RAID1E */
name|vol
operator|->
name|v_mediasize
operator|=
operator|(
operator|(
name|size
operator|*
name|numdisks
operator|)
operator|/
name|strip
operator|/
literal|2
operator|)
operator|*
name|strip
expr_stmt|;
block|}
name|vol
operator|->
name|v_sectorsize
operator|=
name|sectorsize
expr_stmt|;
name|g_raid_start_volume
argument_list|(
name|vol
argument_list|)
expr_stmt|;
comment|/* , and subdisks. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|numdisks
condition|;
name|i
operator|++
control|)
block|{
name|disk
operator|=
name|disks
index|[
name|i
index|]
expr_stmt|;
name|sd
operator|=
operator|&
name|vol
operator|->
name|v_subdisks
index|[
name|i
index|]
expr_stmt|;
name|sd
operator|->
name|sd_disk
operator|=
name|disk
expr_stmt|;
name|sd
operator|->
name|sd_offset
operator|=
name|offs
index|[
name|i
index|]
expr_stmt|;
name|sd
operator|->
name|sd_size
operator|=
name|size
expr_stmt|;
if|if
condition|(
name|disk
operator|==
name|NULL
condition|)
continue|continue;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|disk
operator|->
name|d_subdisks
argument_list|,
name|sd
argument_list|,
name|sd_next
argument_list|)
expr_stmt|;
name|g_raid_change_disk_state
argument_list|(
name|disk
argument_list|,
name|G_RAID_DISK_S_ACTIVE
argument_list|)
expr_stmt|;
name|g_raid_change_subdisk_state
argument_list|(
name|sd
argument_list|,
name|G_RAID_SUBDISK_S_ACTIVE
argument_list|)
expr_stmt|;
name|g_raid_event_send
argument_list|(
name|sd
argument_list|,
name|G_RAID_SUBDISK_E_NEW
argument_list|,
name|G_RAID_EVENT_SUBDISK
argument_list|)
expr_stmt|;
block|}
comment|/* Write metadata based on created entities. */
name|G_RAID_DEBUG1
argument_list|(
literal|0
argument_list|,
name|sc
argument_list|,
literal|"Array started."
argument_list|)
expr_stmt|;
name|g_raid_md_write_ddf
argument_list|(
name|md
argument_list|,
name|vol
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* Pickup any STALE/SPARE disks to refill array if needed. */
name|g_raid_md_ddf_refill
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|g_raid_event_send
argument_list|(
name|vol
argument_list|,
name|G_RAID_VOLUME_E_START
argument_list|,
name|G_RAID_EVENT_VOLUME
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|verb
argument_list|,
literal|"add"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|gctl_error
argument_list|(
name|req
argument_list|,
literal|"`add` command is not applicable, "
literal|"use `label` instead."
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|99
operator|)
return|;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|verb
argument_list|,
literal|"delete"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|nodename
operator|=
name|gctl_get_asciiparam
argument_list|(
name|req
argument_list|,
literal|"arg0"
argument_list|)
expr_stmt|;
if|if
condition|(
name|nodename
operator|!=
name|NULL
operator|&&
name|strcasecmp
argument_list|(
name|sc
operator|->
name|sc_name
argument_list|,
name|nodename
argument_list|)
operator|!=
literal|0
condition|)
name|nodename
operator|=
name|NULL
expr_stmt|;
comment|/* Full node destruction. */
if|if
condition|(
operator|*
name|nargs
operator|==
literal|1
operator|&&
name|nodename
operator|!=
name|NULL
condition|)
block|{
comment|/* Check if some volume is still open. */
name|force
operator|=
name|gctl_get_paraml
argument_list|(
name|req
argument_list|,
literal|"force"
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|force
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|force
operator|!=
name|NULL
operator|&&
operator|*
name|force
operator|==
literal|0
operator|&&
name|g_raid_nopens
argument_list|(
name|sc
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|gctl_error
argument_list|(
name|req
argument_list|,
literal|"Some volume is still open."
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|4
operator|)
return|;
block|}
name|TAILQ_FOREACH
argument_list|(
argument|disk
argument_list|,
argument|&sc->sc_disks
argument_list|,
argument|d_next
argument_list|)
block|{
if|if
condition|(
name|disk
operator|->
name|d_consumer
condition|)
name|ddf_meta_erase
argument_list|(
name|disk
operator|->
name|d_consumer
argument_list|)
expr_stmt|;
block|}
name|g_raid_destroy_node
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
comment|/* Destroy specified volume. If it was last - all node. */
if|if
condition|(
operator|*
name|nargs
operator|>
literal|2
condition|)
block|{
name|gctl_error
argument_list|(
name|req
argument_list|,
literal|"Invalid number of arguments."
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|volname
operator|=
name|gctl_get_asciiparam
argument_list|(
name|req
argument_list|,
name|nodename
operator|!=
name|NULL
condition|?
literal|"arg1"
else|:
literal|"arg0"
argument_list|)
expr_stmt|;
if|if
condition|(
name|volname
operator|==
name|NULL
condition|)
block|{
name|gctl_error
argument_list|(
name|req
argument_list|,
literal|"No volume name."
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|2
operator|)
return|;
block|}
comment|/* Search for volume. */
name|TAILQ_FOREACH
argument_list|(
argument|vol
argument_list|,
argument|&sc->sc_volumes
argument_list|,
argument|v_next
argument_list|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|vol
operator|->
name|v_name
argument_list|,
name|volname
argument_list|)
operator|==
literal|0
condition|)
break|break;
name|pp
operator|=
name|vol
operator|->
name|v_provider
expr_stmt|;
if|if
condition|(
name|pp
operator|==
name|NULL
condition|)
continue|continue;
if|if
condition|(
name|strcmp
argument_list|(
name|pp
operator|->
name|name
argument_list|,
name|volname
argument_list|)
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
name|strncmp
argument_list|(
name|pp
operator|->
name|name
argument_list|,
literal|"raid/"
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
operator|&&
name|strcmp
argument_list|(
name|pp
operator|->
name|name
operator|+
literal|5
argument_list|,
name|volname
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|vol
operator|==
name|NULL
condition|)
block|{
name|i
operator|=
name|strtol
argument_list|(
name|volname
argument_list|,
operator|&
name|tmp
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|verb
operator|!=
name|volname
operator|&&
name|tmp
index|[
literal|0
index|]
operator|==
literal|0
condition|)
block|{
name|TAILQ_FOREACH
argument_list|(
argument|vol
argument_list|,
argument|&sc->sc_volumes
argument_list|,
argument|v_next
argument_list|)
block|{
if|if
condition|(
name|vol
operator|->
name|v_global_id
operator|==
name|i
condition|)
break|break;
block|}
block|}
block|}
if|if
condition|(
name|vol
operator|==
name|NULL
condition|)
block|{
name|gctl_error
argument_list|(
name|req
argument_list|,
literal|"Volume '%s' not found."
argument_list|,
name|volname
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|3
operator|)
return|;
block|}
comment|/* Check if volume is still open. */
name|force
operator|=
name|gctl_get_paraml
argument_list|(
name|req
argument_list|,
literal|"force"
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|force
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|force
operator|!=
name|NULL
operator|&&
operator|*
name|force
operator|==
literal|0
operator|&&
name|vol
operator|->
name|v_provider_open
operator|!=
literal|0
condition|)
block|{
name|gctl_error
argument_list|(
name|req
argument_list|,
literal|"Volume is still open."
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|4
operator|)
return|;
block|}
comment|/* Destroy volume and potentially node. */
name|i
operator|=
literal|0
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|vol1
argument_list|,
argument|&sc->sc_volumes
argument_list|,
argument|v_next
argument_list|)
name|i
operator|++
expr_stmt|;
if|if
condition|(
name|i
operator|>=
literal|2
condition|)
block|{
name|g_raid_destroy_volume
argument_list|(
name|vol
argument_list|)
expr_stmt|;
name|g_raid_md_ddf_purge_disks
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|g_raid_md_write_ddf
argument_list|(
name|md
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TAILQ_FOREACH
argument_list|(
argument|disk
argument_list|,
argument|&sc->sc_disks
argument_list|,
argument|d_next
argument_list|)
block|{
if|if
condition|(
name|disk
operator|->
name|d_consumer
condition|)
name|ddf_meta_erase
argument_list|(
name|disk
operator|->
name|d_consumer
argument_list|)
expr_stmt|;
block|}
name|g_raid_destroy_node
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|verb
argument_list|,
literal|"remove"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|verb
argument_list|,
literal|"fail"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|*
name|nargs
operator|<
literal|2
condition|)
block|{
name|gctl_error
argument_list|(
name|req
argument_list|,
literal|"Invalid number of arguments."
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
operator|*
name|nargs
condition|;
name|i
operator|++
control|)
block|{
name|snprintf
argument_list|(
name|arg
argument_list|,
sizeof|sizeof
argument_list|(
name|arg
argument_list|)
argument_list|,
literal|"arg%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|diskname
operator|=
name|gctl_get_asciiparam
argument_list|(
name|req
argument_list|,
name|arg
argument_list|)
expr_stmt|;
if|if
condition|(
name|diskname
operator|==
name|NULL
condition|)
block|{
name|gctl_error
argument_list|(
name|req
argument_list|,
literal|"No disk name (%s)."
argument_list|,
name|arg
argument_list|)
expr_stmt|;
name|error
operator|=
operator|-
literal|2
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|strncmp
argument_list|(
name|diskname
argument_list|,
literal|"/dev/"
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
condition|)
name|diskname
operator|+=
literal|5
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|disk
argument_list|,
argument|&sc->sc_disks
argument_list|,
argument|d_next
argument_list|)
block|{
if|if
condition|(
name|disk
operator|->
name|d_consumer
operator|!=
name|NULL
operator|&&
name|disk
operator|->
name|d_consumer
operator|->
name|provider
operator|!=
name|NULL
operator|&&
name|strcmp
argument_list|(
name|disk
operator|->
name|d_consumer
operator|->
name|provider
operator|->
name|name
argument_list|,
name|diskname
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|disk
operator|==
name|NULL
condition|)
block|{
name|gctl_error
argument_list|(
name|req
argument_list|,
literal|"Disk '%s' not found."
argument_list|,
name|diskname
argument_list|)
expr_stmt|;
name|error
operator|=
operator|-
literal|3
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|verb
argument_list|,
literal|"fail"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|g_raid_md_fail_disk_ddf
argument_list|(
name|md
argument_list|,
name|NULL
argument_list|,
name|disk
argument_list|)
expr_stmt|;
continue|continue;
block|}
comment|/* Erase metadata on deleting disk and destroy it. */
name|ddf_meta_erase
argument_list|(
name|disk
operator|->
name|d_consumer
argument_list|)
expr_stmt|;
name|g_raid_destroy_disk
argument_list|(
name|disk
argument_list|)
expr_stmt|;
block|}
name|g_raid_md_ddf_purge_volumes
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Write updated metadata to remaining disks. */
name|g_raid_md_write_ddf
argument_list|(
name|md
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* Check if anything left. */
if|if
condition|(
name|g_raid_ndisks
argument_list|(
name|sc
argument_list|,
operator|-
literal|1
argument_list|)
operator|==
literal|0
condition|)
name|g_raid_destroy_node
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
name|g_raid_md_ddf_refill
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|verb
argument_list|,
literal|"insert"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|*
name|nargs
operator|<
literal|2
condition|)
block|{
name|gctl_error
argument_list|(
name|req
argument_list|,
literal|"Invalid number of arguments."
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
operator|*
name|nargs
condition|;
name|i
operator|++
control|)
block|{
comment|/* Get disk name. */
name|snprintf
argument_list|(
name|arg
argument_list|,
sizeof|sizeof
argument_list|(
name|arg
argument_list|)
argument_list|,
literal|"arg%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|diskname
operator|=
name|gctl_get_asciiparam
argument_list|(
name|req
argument_list|,
name|arg
argument_list|)
expr_stmt|;
if|if
condition|(
name|diskname
operator|==
name|NULL
condition|)
block|{
name|gctl_error
argument_list|(
name|req
argument_list|,
literal|"No disk name (%s)."
argument_list|,
name|arg
argument_list|)
expr_stmt|;
name|error
operator|=
operator|-
literal|3
expr_stmt|;
break|break;
block|}
comment|/* Try to find provider with specified name. */
name|g_topology_lock
argument_list|()
expr_stmt|;
name|cp
operator|=
name|g_raid_open_consumer
argument_list|(
name|sc
argument_list|,
name|diskname
argument_list|)
expr_stmt|;
if|if
condition|(
name|cp
operator|==
name|NULL
condition|)
block|{
name|gctl_error
argument_list|(
name|req
argument_list|,
literal|"Can't open disk '%s'."
argument_list|,
name|diskname
argument_list|)
expr_stmt|;
name|g_topology_unlock
argument_list|()
expr_stmt|;
name|error
operator|=
operator|-
literal|4
expr_stmt|;
break|break;
block|}
name|pp
operator|=
name|cp
operator|->
name|provider
expr_stmt|;
name|g_topology_unlock
argument_list|()
expr_stmt|;
name|pd
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|pd
argument_list|)
argument_list|,
name|M_MD_DDF
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|disk
operator|=
name|g_raid_create_disk
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|disk
operator|->
name|d_consumer
operator|=
name|cp
expr_stmt|;
name|disk
operator|->
name|d_md_data
operator|=
operator|(
name|void
operator|*
operator|)
name|pd
expr_stmt|;
name|cp
operator|->
name|private
operator|=
name|disk
expr_stmt|;
name|g_raid_get_disk_info
argument_list|(
name|disk
argument_list|)
expr_stmt|;
comment|/* Welcome the "new" disk. */
name|g_raid_change_disk_state
argument_list|(
name|disk
argument_list|,
name|G_RAID_DISK_S_SPARE
argument_list|)
expr_stmt|;
name|ddf_meta_create
argument_list|(
name|disk
argument_list|,
operator|&
name|mdi
operator|->
name|mdio_meta
argument_list|)
expr_stmt|;
name|sa
operator|=
name|ddf_meta_find_sa
argument_list|(
operator|&
name|pd
operator|->
name|pd_meta
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|sa
operator|!=
name|NULL
condition|)
block|{
name|SET32D
argument_list|(
operator|&
name|pd
operator|->
name|pd_meta
argument_list|,
name|sa
operator|->
name|Signature
argument_list|,
name|DDF_SA_SIGNATURE
argument_list|)
expr_stmt|;
name|SET8D
argument_list|(
operator|&
name|pd
operator|->
name|pd_meta
argument_list|,
name|sa
operator|->
name|Spare_Type
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|SET16D
argument_list|(
operator|&
name|pd
operator|->
name|pd_meta
argument_list|,
name|sa
operator|->
name|Populated_SAEs
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|SET16D
argument_list|(
operator|&
name|pd
operator|->
name|pd_meta
argument_list|,
name|sa
operator|->
name|MAX_SAE_Supported
argument_list|,
operator|(
name|GET16
argument_list|(
operator|&
name|pd
operator|->
name|pd_meta
argument_list|,
name|hdr
operator|->
name|Configuration_Record_Length
argument_list|)
operator|*
name|pd
operator|->
name|pd_meta
operator|.
name|sectorsize
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|ddf_sa_record
argument_list|)
operator|)
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|ddf_sa_entry
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mdi
operator|->
name|mdio_meta
operator|.
name|hdr
operator|==
name|NULL
condition|)
name|ddf_meta_copy
argument_list|(
operator|&
name|mdi
operator|->
name|mdio_meta
argument_list|,
operator|&
name|pd
operator|->
name|pd_meta
argument_list|)
expr_stmt|;
else|else
name|ddf_meta_update
argument_list|(
operator|&
name|mdi
operator|->
name|mdio_meta
argument_list|,
operator|&
name|pd
operator|->
name|pd_meta
argument_list|)
expr_stmt|;
name|g_raid_md_write_ddf
argument_list|(
name|md
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_raid_md_ddf_refill
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
return|return
operator|(
operator|-
literal|100
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|g_raid_md_write_ddf
parameter_list|(
name|struct
name|g_raid_md_object
modifier|*
name|md
parameter_list|,
name|struct
name|g_raid_volume
modifier|*
name|tvol
parameter_list|,
name|struct
name|g_raid_subdisk
modifier|*
name|tsd
parameter_list|,
name|struct
name|g_raid_disk
modifier|*
name|tdisk
parameter_list|)
block|{
name|struct
name|g_raid_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|g_raid_volume
modifier|*
name|vol
decl_stmt|;
name|struct
name|g_raid_subdisk
modifier|*
name|sd
decl_stmt|;
name|struct
name|g_raid_disk
modifier|*
name|disk
decl_stmt|;
name|struct
name|g_raid_md_ddf_perdisk
modifier|*
name|pd
decl_stmt|;
name|struct
name|g_raid_md_ddf_pervolume
modifier|*
name|pv
decl_stmt|;
name|struct
name|g_raid_md_ddf_object
modifier|*
name|mdi
decl_stmt|;
name|struct
name|ddf_meta
modifier|*
name|gmeta
decl_stmt|;
name|struct
name|ddf_vol_meta
modifier|*
name|vmeta
decl_stmt|;
name|struct
name|ddf_vdc_record
modifier|*
name|vdc
decl_stmt|;
name|struct
name|ddf_sa_record
modifier|*
name|sa
decl_stmt|;
name|uint64_t
modifier|*
name|val2
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|pos
decl_stmt|,
name|bvd
decl_stmt|,
name|size
decl_stmt|;
name|sc
operator|=
name|md
operator|->
name|mdo_softc
expr_stmt|;
name|mdi
operator|=
operator|(
expr|struct
name|g_raid_md_ddf_object
operator|*
operator|)
name|md
expr_stmt|;
name|gmeta
operator|=
operator|&
name|mdi
operator|->
name|mdio_meta
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_stopping
operator|==
name|G_RAID_DESTROY_HARD
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* 	 * Clear disk flags to let only really needed ones to be reset. 	 * Do it only if there are no volumes in starting state now, 	 * as they can update disk statuses yet and we may kill innocent. 	 */
if|if
condition|(
name|mdi
operator|->
name|mdio_starting
operator|==
literal|0
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|GET16
argument_list|(
name|gmeta
argument_list|,
name|pdr
operator|->
name|Populated_PDEs
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|isff
argument_list|(
name|gmeta
operator|->
name|pdr
operator|->
name|entry
index|[
name|i
index|]
operator|.
name|PD_GUID
argument_list|,
literal|24
argument_list|)
condition|)
continue|continue;
name|SET16
argument_list|(
name|gmeta
argument_list|,
name|pdr
operator|->
name|entry
index|[
name|i
index|]
operator|.
name|PD_Type
argument_list|,
name|GET16
argument_list|(
name|gmeta
argument_list|,
name|pdr
operator|->
name|entry
index|[
name|i
index|]
operator|.
name|PD_Type
argument_list|)
operator|&
operator|~
operator|(
name|DDF_PDE_PARTICIPATING
operator||
name|DDF_PDE_GLOBAL_SPARE
operator||
name|DDF_PDE_CONFIG_SPARE
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|GET16
argument_list|(
name|gmeta
argument_list|,
name|pdr
operator|->
name|entry
index|[
name|i
index|]
operator|.
name|PD_State
argument_list|)
operator|&
name|DDF_PDE_PFA
operator|)
operator|==
literal|0
condition|)
name|SET16
argument_list|(
name|gmeta
argument_list|,
name|pdr
operator|->
name|entry
index|[
name|i
index|]
operator|.
name|PD_State
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Generate/update new per-volume metadata. */
name|TAILQ_FOREACH
argument_list|(
argument|vol
argument_list|,
argument|&sc->sc_volumes
argument_list|,
argument|v_next
argument_list|)
block|{
name|pv
operator|=
operator|(
expr|struct
name|g_raid_md_ddf_pervolume
operator|*
operator|)
name|vol
operator|->
name|v_md_data
expr_stmt|;
if|if
condition|(
name|vol
operator|->
name|v_stopping
operator|||
operator|!
name|pv
operator|->
name|pv_started
condition|)
continue|continue;
name|vmeta
operator|=
operator|&
name|pv
operator|->
name|pv_meta
expr_stmt|;
name|SET32
argument_list|(
name|vmeta
argument_list|,
name|vdc
operator|->
name|Sequence_Number
argument_list|,
name|GET32
argument_list|(
name|vmeta
argument_list|,
name|vdc
operator|->
name|Sequence_Number
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|vol
operator|->
name|v_raid_level
operator|==
name|G_RAID_VOLUME_RL_RAID1E
operator|&&
name|vol
operator|->
name|v_disks_count
operator|%
literal|2
operator|==
literal|0
condition|)
name|SET16
argument_list|(
name|vmeta
argument_list|,
name|vdc
operator|->
name|Primary_Element_Count
argument_list|,
literal|2
argument_list|)
expr_stmt|;
else|else
name|SET16
argument_list|(
name|vmeta
argument_list|,
name|vdc
operator|->
name|Primary_Element_Count
argument_list|,
name|vol
operator|->
name|v_disks_count
argument_list|)
expr_stmt|;
name|SET8
argument_list|(
name|vmeta
argument_list|,
name|vdc
operator|->
name|Stripe_Size
argument_list|,
name|ffs
argument_list|(
name|vol
operator|->
name|v_strip_size
operator|/
name|vol
operator|->
name|v_sectorsize
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|vol
operator|->
name|v_raid_level
operator|==
name|G_RAID_VOLUME_RL_RAID1E
operator|&&
name|vol
operator|->
name|v_disks_count
operator|%
literal|2
operator|==
literal|0
condition|)
block|{
name|SET8
argument_list|(
name|vmeta
argument_list|,
name|vdc
operator|->
name|Primary_RAID_Level
argument_list|,
name|DDF_VDCR_RAID1
argument_list|)
expr_stmt|;
name|SET8
argument_list|(
name|vmeta
argument_list|,
name|vdc
operator|->
name|RLQ
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|SET8
argument_list|(
name|vmeta
argument_list|,
name|vdc
operator|->
name|Secondary_Element_Count
argument_list|,
name|vol
operator|->
name|v_disks_count
operator|/
literal|2
argument_list|)
expr_stmt|;
name|SET8
argument_list|(
name|vmeta
argument_list|,
name|vdc
operator|->
name|Secondary_RAID_Level
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SET8
argument_list|(
name|vmeta
argument_list|,
name|vdc
operator|->
name|Primary_RAID_Level
argument_list|,
name|vol
operator|->
name|v_raid_level
argument_list|)
expr_stmt|;
name|SET8
argument_list|(
name|vmeta
argument_list|,
name|vdc
operator|->
name|RLQ
argument_list|,
name|vol
operator|->
name|v_raid_level_qualifier
argument_list|)
expr_stmt|;
name|SET8
argument_list|(
name|vmeta
argument_list|,
name|vdc
operator|->
name|Secondary_Element_Count
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|SET8
argument_list|(
name|vmeta
argument_list|,
name|vdc
operator|->
name|Secondary_RAID_Level
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|SET8
argument_list|(
name|vmeta
argument_list|,
name|vdc
operator|->
name|Secondary_Element_Seq
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|SET64
argument_list|(
name|vmeta
argument_list|,
name|vdc
operator|->
name|Block_Count
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|SET64
argument_list|(
name|vmeta
argument_list|,
name|vdc
operator|->
name|VD_Size
argument_list|,
name|vol
operator|->
name|v_mediasize
operator|/
name|vol
operator|->
name|v_sectorsize
argument_list|)
expr_stmt|;
name|SET16
argument_list|(
name|vmeta
argument_list|,
name|vdc
operator|->
name|Block_Size
argument_list|,
name|vol
operator|->
name|v_sectorsize
argument_list|)
expr_stmt|;
name|SET8
argument_list|(
name|vmeta
argument_list|,
name|vdc
operator|->
name|Rotate_Parity_count
argument_list|,
name|fls
argument_list|(
name|vol
operator|->
name|v_rotate_parity
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|SET8
argument_list|(
name|vmeta
argument_list|,
name|vdc
operator|->
name|MDF_Parity_Disks
argument_list|,
name|vol
operator|->
name|v_mdf_pdisks
argument_list|)
expr_stmt|;
name|SET16
argument_list|(
name|vmeta
argument_list|,
name|vdc
operator|->
name|MDF_Parity_Generator_Polynomial
argument_list|,
name|vol
operator|->
name|v_mdf_polynomial
argument_list|)
expr_stmt|;
name|SET8
argument_list|(
name|vmeta
argument_list|,
name|vdc
operator|->
name|MDF_Constant_Generation_Method
argument_list|,
name|vol
operator|->
name|v_mdf_method
argument_list|)
expr_stmt|;
name|SET16
argument_list|(
name|vmeta
argument_list|,
name|vde
operator|->
name|VD_Number
argument_list|,
name|vol
operator|->
name|v_global_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|vol
operator|->
name|v_state
operator|<=
name|G_RAID_VOLUME_S_BROKEN
condition|)
name|SET8
argument_list|(
name|vmeta
argument_list|,
name|vde
operator|->
name|VD_State
argument_list|,
name|DDF_VDE_FAILED
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|vol
operator|->
name|v_state
operator|<=
name|G_RAID_VOLUME_S_DEGRADED
condition|)
name|SET8
argument_list|(
name|vmeta
argument_list|,
name|vde
operator|->
name|VD_State
argument_list|,
name|DDF_VDE_DEGRADED
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|vol
operator|->
name|v_state
operator|<=
name|G_RAID_VOLUME_S_SUBOPTIMAL
condition|)
name|SET8
argument_list|(
name|vmeta
argument_list|,
name|vde
operator|->
name|VD_State
argument_list|,
name|DDF_VDE_PARTIAL
argument_list|)
expr_stmt|;
else|else
name|SET8
argument_list|(
name|vmeta
argument_list|,
name|vde
operator|->
name|VD_State
argument_list|,
name|DDF_VDE_OPTIMAL
argument_list|)
expr_stmt|;
if|if
condition|(
name|vol
operator|->
name|v_dirty
operator|||
name|g_raid_nsubdisks
argument_list|(
name|vol
argument_list|,
name|G_RAID_SUBDISK_S_STALE
argument_list|)
operator|>
literal|0
operator|||
name|g_raid_nsubdisks
argument_list|(
name|vol
argument_list|,
name|G_RAID_SUBDISK_S_RESYNC
argument_list|)
operator|>
literal|0
condition|)
name|SET8
argument_list|(
name|vmeta
argument_list|,
name|vde
operator|->
name|VD_State
argument_list|,
name|GET8
argument_list|(
name|vmeta
argument_list|,
name|vde
operator|->
name|VD_State
argument_list|)
operator||
name|DDF_VDE_DIRTY
argument_list|)
expr_stmt|;
name|SET8
argument_list|(
name|vmeta
argument_list|,
name|vde
operator|->
name|Init_State
argument_list|,
name|DDF_VDE_INIT_FULL
argument_list|)
expr_stmt|;
comment|// XXX
name|ddf_meta_put_name
argument_list|(
name|vmeta
argument_list|,
name|vol
operator|->
name|v_name
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|vol
operator|->
name|v_disks_count
condition|;
name|i
operator|++
control|)
block|{
name|sd
operator|=
operator|&
name|vol
operator|->
name|v_subdisks
index|[
name|i
index|]
expr_stmt|;
name|bvd
operator|=
name|i
operator|/
name|GET16
argument_list|(
name|vmeta
argument_list|,
name|vdc
operator|->
name|Primary_Element_Count
argument_list|)
expr_stmt|;
name|pos
operator|=
name|i
operator|%
name|GET16
argument_list|(
name|vmeta
argument_list|,
name|vdc
operator|->
name|Primary_Element_Count
argument_list|)
expr_stmt|;
name|disk
operator|=
name|sd
operator|->
name|sd_disk
expr_stmt|;
if|if
condition|(
name|disk
operator|!=
name|NULL
condition|)
block|{
name|pd
operator|=
operator|(
expr|struct
name|g_raid_md_ddf_perdisk
operator|*
operator|)
name|disk
operator|->
name|d_md_data
expr_stmt|;
if|if
condition|(
name|vmeta
operator|->
name|bvdc
index|[
name|bvd
index|]
operator|==
name|NULL
condition|)
block|{
name|size
operator|=
name|GET16
argument_list|(
name|vmeta
argument_list|,
name|hdr
operator|->
name|Configuration_Record_Length
argument_list|)
operator|*
name|vmeta
operator|->
name|sectorsize
expr_stmt|;
name|vmeta
operator|->
name|bvdc
index|[
name|bvd
index|]
operator|=
name|malloc
argument_list|(
name|size
argument_list|,
name|M_MD_DDF
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|vmeta
operator|->
name|bvdc
index|[
name|bvd
index|]
argument_list|,
literal|0xff
argument_list|,
name|size
argument_list|)
expr_stmt|;
block|}
name|memcpy
argument_list|(
name|vmeta
operator|->
name|bvdc
index|[
name|bvd
index|]
argument_list|,
name|vmeta
operator|->
name|vdc
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ddf_vdc_record
argument_list|)
argument_list|)
expr_stmt|;
name|SET8
argument_list|(
name|vmeta
argument_list|,
name|bvdc
index|[
name|bvd
index|]
operator|->
name|Secondary_Element_Seq
argument_list|,
name|bvd
argument_list|)
expr_stmt|;
name|SET64
argument_list|(
name|vmeta
argument_list|,
name|bvdc
index|[
name|bvd
index|]
operator|->
name|Block_Count
argument_list|,
name|sd
operator|->
name|sd_size
operator|/
name|vol
operator|->
name|v_sectorsize
argument_list|)
expr_stmt|;
name|SET32
argument_list|(
name|vmeta
argument_list|,
name|bvdc
index|[
name|bvd
index|]
operator|->
name|Physical_Disk_Sequence
index|[
name|pos
index|]
argument_list|,
name|GET32
argument_list|(
operator|&
name|pd
operator|->
name|pd_meta
argument_list|,
name|pdd
operator|->
name|PD_Reference
argument_list|)
argument_list|)
expr_stmt|;
name|val2
operator|=
operator|(
name|uint64_t
operator|*
operator|)
operator|&
operator|(
name|vmeta
operator|->
name|bvdc
index|[
name|bvd
index|]
operator|->
name|Physical_Disk_Sequence
index|[
name|GET16
argument_list|(
name|vmeta
argument_list|,
name|hdr
operator|->
name|Max_Primary_Element_Entries
argument_list|)
index|]
operator|)
expr_stmt|;
name|SET64P
argument_list|(
name|vmeta
argument_list|,
name|val2
operator|+
name|pos
argument_list|,
name|sd
operator|->
name|sd_offset
operator|/
name|vol
operator|->
name|v_sectorsize
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|vmeta
operator|->
name|bvdc
index|[
name|bvd
index|]
operator|==
name|NULL
condition|)
continue|continue;
name|j
operator|=
name|ddf_meta_find_pd
argument_list|(
name|gmeta
argument_list|,
name|NULL
argument_list|,
name|GET32
argument_list|(
name|vmeta
argument_list|,
name|bvdc
index|[
name|bvd
index|]
operator|->
name|Physical_Disk_Sequence
index|[
name|pos
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|j
operator|<
literal|0
condition|)
continue|continue;
name|SET16
argument_list|(
name|gmeta
argument_list|,
name|pdr
operator|->
name|entry
index|[
name|j
index|]
operator|.
name|PD_Type
argument_list|,
name|GET16
argument_list|(
name|gmeta
argument_list|,
name|pdr
operator|->
name|entry
index|[
name|j
index|]
operator|.
name|PD_Type
argument_list|)
operator||
name|DDF_PDE_PARTICIPATING
argument_list|)
expr_stmt|;
if|if
condition|(
name|sd
operator|->
name|sd_state
operator|==
name|G_RAID_SUBDISK_S_NONE
condition|)
name|SET16
argument_list|(
name|gmeta
argument_list|,
name|pdr
operator|->
name|entry
index|[
name|j
index|]
operator|.
name|PD_State
argument_list|,
name|GET16
argument_list|(
name|gmeta
argument_list|,
name|pdr
operator|->
name|entry
index|[
name|j
index|]
operator|.
name|PD_State
argument_list|)
operator||
operator|(
name|DDF_PDE_FAILED
operator||
name|DDF_PDE_MISSING
operator|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|sd
operator|->
name|sd_state
operator|==
name|G_RAID_SUBDISK_S_FAILED
condition|)
name|SET16
argument_list|(
name|gmeta
argument_list|,
name|pdr
operator|->
name|entry
index|[
name|j
index|]
operator|.
name|PD_State
argument_list|,
name|GET16
argument_list|(
name|gmeta
argument_list|,
name|pdr
operator|->
name|entry
index|[
name|j
index|]
operator|.
name|PD_State
argument_list|)
operator||
operator|(
name|DDF_PDE_FAILED
operator||
name|DDF_PDE_PFA
operator|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|sd
operator|->
name|sd_state
operator|<=
name|G_RAID_SUBDISK_S_REBUILD
condition|)
name|SET16
argument_list|(
name|gmeta
argument_list|,
name|pdr
operator|->
name|entry
index|[
name|j
index|]
operator|.
name|PD_State
argument_list|,
name|GET16
argument_list|(
name|gmeta
argument_list|,
name|pdr
operator|->
name|entry
index|[
name|j
index|]
operator|.
name|PD_State
argument_list|)
operator||
name|DDF_PDE_REBUILD
argument_list|)
expr_stmt|;
else|else
name|SET16
argument_list|(
name|gmeta
argument_list|,
name|pdr
operator|->
name|entry
index|[
name|j
index|]
operator|.
name|PD_State
argument_list|,
name|GET16
argument_list|(
name|gmeta
argument_list|,
name|pdr
operator|->
name|entry
index|[
name|j
index|]
operator|.
name|PD_State
argument_list|)
operator||
name|DDF_PDE_ONLINE
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Mark spare and failed disks as such. */
name|TAILQ_FOREACH
argument_list|(
argument|disk
argument_list|,
argument|&sc->sc_disks
argument_list|,
argument|d_next
argument_list|)
block|{
name|pd
operator|=
operator|(
expr|struct
name|g_raid_md_ddf_perdisk
operator|*
operator|)
name|disk
operator|->
name|d_md_data
expr_stmt|;
name|i
operator|=
name|ddf_meta_find_pd
argument_list|(
name|gmeta
argument_list|,
name|NULL
argument_list|,
name|GET32
argument_list|(
operator|&
name|pd
operator|->
name|pd_meta
argument_list|,
name|pdd
operator|->
name|PD_Reference
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|<
literal|0
condition|)
continue|continue;
if|if
condition|(
name|disk
operator|->
name|d_state
operator|==
name|G_RAID_DISK_S_FAILED
condition|)
block|{
name|SET16
argument_list|(
name|gmeta
argument_list|,
name|pdr
operator|->
name|entry
index|[
name|i
index|]
operator|.
name|PD_State
argument_list|,
name|GET16
argument_list|(
name|gmeta
argument_list|,
name|pdr
operator|->
name|entry
index|[
name|i
index|]
operator|.
name|PD_State
argument_list|)
operator||
operator|(
name|DDF_PDE_FAILED
operator||
name|DDF_PDE_PFA
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|disk
operator|->
name|d_state
operator|!=
name|G_RAID_DISK_S_SPARE
condition|)
continue|continue;
name|sa
operator|=
name|ddf_meta_find_sa
argument_list|(
operator|&
name|pd
operator|->
name|pd_meta
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|sa
operator|==
name|NULL
operator|||
operator|(
name|GET8D
argument_list|(
operator|&
name|pd
operator|->
name|pd_meta
argument_list|,
name|sa
operator|->
name|Spare_Type
argument_list|)
operator|&
name|DDF_SAR_TYPE_DEDICATED
operator|)
operator|==
literal|0
condition|)
block|{
name|SET16
argument_list|(
name|gmeta
argument_list|,
name|pdr
operator|->
name|entry
index|[
name|i
index|]
operator|.
name|PD_Type
argument_list|,
name|GET16
argument_list|(
name|gmeta
argument_list|,
name|pdr
operator|->
name|entry
index|[
name|i
index|]
operator|.
name|PD_Type
argument_list|)
operator||
name|DDF_PDE_GLOBAL_SPARE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SET16
argument_list|(
name|gmeta
argument_list|,
name|pdr
operator|->
name|entry
index|[
name|i
index|]
operator|.
name|PD_Type
argument_list|,
name|GET16
argument_list|(
name|gmeta
argument_list|,
name|pdr
operator|->
name|entry
index|[
name|i
index|]
operator|.
name|PD_Type
argument_list|)
operator||
name|DDF_PDE_CONFIG_SPARE
argument_list|)
expr_stmt|;
block|}
name|SET16
argument_list|(
name|gmeta
argument_list|,
name|pdr
operator|->
name|entry
index|[
name|i
index|]
operator|.
name|PD_State
argument_list|,
name|GET16
argument_list|(
name|gmeta
argument_list|,
name|pdr
operator|->
name|entry
index|[
name|i
index|]
operator|.
name|PD_State
argument_list|)
operator||
name|DDF_PDE_ONLINE
argument_list|)
expr_stmt|;
block|}
comment|/* Remove disks without "participating" flag (unused). */
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|j
operator|=
operator|-
literal|1
init|;
name|i
operator|<
name|GET16
argument_list|(
name|gmeta
argument_list|,
name|pdr
operator|->
name|Populated_PDEs
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|isff
argument_list|(
name|gmeta
operator|->
name|pdr
operator|->
name|entry
index|[
name|i
index|]
operator|.
name|PD_GUID
argument_list|,
literal|24
argument_list|)
condition|)
continue|continue;
if|if
condition|(
operator|(
name|GET16
argument_list|(
name|gmeta
argument_list|,
name|pdr
operator|->
name|entry
index|[
name|i
index|]
operator|.
name|PD_Type
argument_list|)
operator|&
operator|(
name|DDF_PDE_PARTICIPATING
operator||
name|DDF_PDE_GLOBAL_SPARE
operator||
name|DDF_PDE_CONFIG_SPARE
operator|)
operator|)
operator|!=
literal|0
operator|||
name|g_raid_md_ddf_get_disk
argument_list|(
name|sc
argument_list|,
name|NULL
argument_list|,
name|GET32
argument_list|(
name|gmeta
argument_list|,
name|pdr
operator|->
name|entry
index|[
name|i
index|]
operator|.
name|PD_Reference
argument_list|)
argument_list|)
operator|!=
name|NULL
condition|)
name|j
operator|=
name|i
expr_stmt|;
else|else
name|memset
argument_list|(
operator|&
name|gmeta
operator|->
name|pdr
operator|->
name|entry
index|[
name|i
index|]
argument_list|,
literal|0xff
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ddf_pd_entry
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SET16
argument_list|(
name|gmeta
argument_list|,
name|pdr
operator|->
name|Populated_PDEs
argument_list|,
name|j
operator|+
literal|1
argument_list|)
expr_stmt|;
comment|/* Update per-disk metadata and write them. */
name|TAILQ_FOREACH
argument_list|(
argument|disk
argument_list|,
argument|&sc->sc_disks
argument_list|,
argument|d_next
argument_list|)
block|{
name|pd
operator|=
operator|(
expr|struct
name|g_raid_md_ddf_perdisk
operator|*
operator|)
name|disk
operator|->
name|d_md_data
expr_stmt|;
if|if
condition|(
name|disk
operator|->
name|d_state
operator|!=
name|G_RAID_DISK_S_ACTIVE
operator|&&
name|disk
operator|->
name|d_state
operator|!=
name|G_RAID_DISK_S_SPARE
condition|)
continue|continue;
comment|/* Update PDR. */
name|memcpy
argument_list|(
name|pd
operator|->
name|pd_meta
operator|.
name|pdr
argument_list|,
name|gmeta
operator|->
name|pdr
argument_list|,
name|GET32
argument_list|(
operator|&
name|pd
operator|->
name|pd_meta
argument_list|,
name|hdr
operator|->
name|pdr_length
argument_list|)
operator|*
name|pd
operator|->
name|pd_meta
operator|.
name|sectorsize
argument_list|)
expr_stmt|;
comment|/* Update VDR. */
name|SET16
argument_list|(
operator|&
name|pd
operator|->
name|pd_meta
argument_list|,
name|vdr
operator|->
name|Populated_VDEs
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|vol
argument_list|,
argument|&sc->sc_volumes
argument_list|,
argument|v_next
argument_list|)
block|{
if|if
condition|(
name|vol
operator|->
name|v_stopping
condition|)
continue|continue;
name|pv
operator|=
operator|(
expr|struct
name|g_raid_md_ddf_pervolume
operator|*
operator|)
name|vol
operator|->
name|v_md_data
expr_stmt|;
name|i
operator|=
name|ddf_meta_find_vd
argument_list|(
operator|&
name|pd
operator|->
name|pd_meta
argument_list|,
name|pv
operator|->
name|pv_meta
operator|.
name|vde
operator|->
name|VD_GUID
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|<
literal|0
condition|)
name|i
operator|=
name|ddf_meta_find_vd
argument_list|(
operator|&
name|pd
operator|->
name|pd_meta
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|>=
literal|0
condition|)
name|memcpy
argument_list|(
operator|&
name|pd
operator|->
name|pd_meta
operator|.
name|vdr
operator|->
name|entry
index|[
name|i
index|]
argument_list|,
name|pv
operator|->
name|pv_meta
operator|.
name|vde
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ddf_vd_entry
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* Update VDC. */
if|if
condition|(
name|mdi
operator|->
name|mdio_starting
operator|==
literal|0
condition|)
block|{
comment|/* Remove all VDCs to restore needed later. */
name|j
operator|=
name|GETCRNUM
argument_list|(
operator|&
name|pd
operator|->
name|pd_meta
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|j
condition|;
name|i
operator|++
control|)
block|{
name|vdc
operator|=
name|GETVDCPTR
argument_list|(
operator|&
name|pd
operator|->
name|pd_meta
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|GET32D
argument_list|(
operator|&
name|pd
operator|->
name|pd_meta
argument_list|,
name|vdc
operator|->
name|Signature
argument_list|)
operator|!=
name|DDF_VDCR_SIGNATURE
condition|)
continue|continue;
name|SET32D
argument_list|(
operator|&
name|pd
operator|->
name|pd_meta
argument_list|,
name|vdc
operator|->
name|Signature
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
block|}
block|}
name|TAILQ_FOREACH
argument_list|(
argument|sd
argument_list|,
argument|&disk->d_subdisks
argument_list|,
argument|sd_next
argument_list|)
block|{
name|vol
operator|=
name|sd
operator|->
name|sd_volume
expr_stmt|;
if|if
condition|(
name|vol
operator|->
name|v_stopping
condition|)
continue|continue;
name|pv
operator|=
operator|(
expr|struct
name|g_raid_md_ddf_pervolume
operator|*
operator|)
name|vol
operator|->
name|v_md_data
expr_stmt|;
name|vmeta
operator|=
operator|&
name|pv
operator|->
name|pv_meta
expr_stmt|;
name|vdc
operator|=
name|ddf_meta_find_vdc
argument_list|(
operator|&
name|pd
operator|->
name|pd_meta
argument_list|,
name|vmeta
operator|->
name|vde
operator|->
name|VD_GUID
argument_list|)
expr_stmt|;
if|if
condition|(
name|vdc
operator|==
name|NULL
condition|)
name|vdc
operator|=
name|ddf_meta_find_vdc
argument_list|(
operator|&
name|pd
operator|->
name|pd_meta
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|vdc
operator|!=
name|NULL
condition|)
block|{
name|bvd
operator|=
name|sd
operator|->
name|sd_pos
operator|/
name|GET16
argument_list|(
name|vmeta
argument_list|,
name|vdc
operator|->
name|Primary_Element_Count
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|vdc
argument_list|,
name|vmeta
operator|->
name|bvdc
index|[
name|bvd
index|]
argument_list|,
name|GET16
argument_list|(
operator|&
name|pd
operator|->
name|pd_meta
argument_list|,
name|hdr
operator|->
name|Configuration_Record_Length
argument_list|)
operator|*
name|pd
operator|->
name|pd_meta
operator|.
name|sectorsize
argument_list|)
expr_stmt|;
block|}
block|}
name|G_RAID_DEBUG
argument_list|(
literal|1
argument_list|,
literal|"Writing DDF metadata to %s"
argument_list|,
name|g_raid_get_diskname
argument_list|(
name|disk
argument_list|)
argument_list|)
expr_stmt|;
name|g_raid_md_ddf_print
argument_list|(
operator|&
name|pd
operator|->
name|pd_meta
argument_list|)
expr_stmt|;
name|ddf_meta_write
argument_list|(
name|disk
operator|->
name|d_consumer
argument_list|,
operator|&
name|pd
operator|->
name|pd_meta
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|g_raid_md_fail_disk_ddf
parameter_list|(
name|struct
name|g_raid_md_object
modifier|*
name|md
parameter_list|,
name|struct
name|g_raid_subdisk
modifier|*
name|tsd
parameter_list|,
name|struct
name|g_raid_disk
modifier|*
name|tdisk
parameter_list|)
block|{
name|struct
name|g_raid_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|g_raid_md_ddf_perdisk
modifier|*
name|pd
decl_stmt|;
name|struct
name|g_raid_subdisk
modifier|*
name|sd
decl_stmt|;
name|int
name|i
decl_stmt|;
name|sc
operator|=
name|md
operator|->
name|mdo_softc
expr_stmt|;
name|pd
operator|=
operator|(
expr|struct
name|g_raid_md_ddf_perdisk
operator|*
operator|)
name|tdisk
operator|->
name|d_md_data
expr_stmt|;
comment|/* We can't fail disk that is not a part of array now. */
if|if
condition|(
name|tdisk
operator|->
name|d_state
operator|!=
name|G_RAID_DISK_S_ACTIVE
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
comment|/* 	 * Mark disk as failed in metadata and try to write that metadata 	 * to the disk itself to prevent it's later resurrection as STALE. 	 */
name|G_RAID_DEBUG
argument_list|(
literal|1
argument_list|,
literal|"Writing DDF metadata to %s"
argument_list|,
name|g_raid_get_diskname
argument_list|(
name|tdisk
argument_list|)
argument_list|)
expr_stmt|;
name|i
operator|=
name|ddf_meta_find_pd
argument_list|(
operator|&
name|pd
operator|->
name|pd_meta
argument_list|,
name|NULL
argument_list|,
name|GET32
argument_list|(
operator|&
name|pd
operator|->
name|pd_meta
argument_list|,
name|pdd
operator|->
name|PD_Reference
argument_list|)
argument_list|)
expr_stmt|;
name|SET16
argument_list|(
operator|&
name|pd
operator|->
name|pd_meta
argument_list|,
name|pdr
operator|->
name|entry
index|[
name|i
index|]
operator|.
name|PD_State
argument_list|,
name|DDF_PDE_FAILED
operator||
name|DDF_PDE_PFA
argument_list|)
expr_stmt|;
if|if
condition|(
name|tdisk
operator|->
name|d_consumer
operator|!=
name|NULL
condition|)
name|ddf_meta_write
argument_list|(
name|tdisk
operator|->
name|d_consumer
argument_list|,
operator|&
name|pd
operator|->
name|pd_meta
argument_list|)
expr_stmt|;
comment|/* Change states. */
name|g_raid_change_disk_state
argument_list|(
name|tdisk
argument_list|,
name|G_RAID_DISK_S_FAILED
argument_list|)
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|sd
argument_list|,
argument|&tdisk->d_subdisks
argument_list|,
argument|sd_next
argument_list|)
block|{
name|g_raid_change_subdisk_state
argument_list|(
name|sd
argument_list|,
name|G_RAID_SUBDISK_S_FAILED
argument_list|)
expr_stmt|;
name|g_raid_event_send
argument_list|(
name|sd
argument_list|,
name|G_RAID_SUBDISK_E_FAILED
argument_list|,
name|G_RAID_EVENT_SUBDISK
argument_list|)
expr_stmt|;
block|}
comment|/* Write updated metadata to remaining disks. */
name|g_raid_md_write_ddf
argument_list|(
name|md
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|tdisk
argument_list|)
expr_stmt|;
name|g_raid_md_ddf_refill
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|g_raid_md_free_disk_ddf
parameter_list|(
name|struct
name|g_raid_md_object
modifier|*
name|md
parameter_list|,
name|struct
name|g_raid_disk
modifier|*
name|disk
parameter_list|)
block|{
name|struct
name|g_raid_md_ddf_perdisk
modifier|*
name|pd
decl_stmt|;
name|pd
operator|=
operator|(
expr|struct
name|g_raid_md_ddf_perdisk
operator|*
operator|)
name|disk
operator|->
name|d_md_data
expr_stmt|;
name|ddf_meta_free
argument_list|(
operator|&
name|pd
operator|->
name|pd_meta
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|pd
argument_list|,
name|M_MD_DDF
argument_list|)
expr_stmt|;
name|disk
operator|->
name|d_md_data
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|g_raid_md_free_volume_ddf
parameter_list|(
name|struct
name|g_raid_md_object
modifier|*
name|md
parameter_list|,
name|struct
name|g_raid_volume
modifier|*
name|vol
parameter_list|)
block|{
name|struct
name|g_raid_md_ddf_object
modifier|*
name|mdi
decl_stmt|;
name|struct
name|g_raid_md_ddf_pervolume
modifier|*
name|pv
decl_stmt|;
name|mdi
operator|=
operator|(
expr|struct
name|g_raid_md_ddf_object
operator|*
operator|)
name|md
expr_stmt|;
name|pv
operator|=
operator|(
expr|struct
name|g_raid_md_ddf_pervolume
operator|*
operator|)
name|vol
operator|->
name|v_md_data
expr_stmt|;
name|ddf_vol_meta_free
argument_list|(
operator|&
name|pv
operator|->
name|pv_meta
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pv
operator|->
name|pv_started
condition|)
block|{
name|pv
operator|->
name|pv_started
operator|=
literal|1
expr_stmt|;
name|mdi
operator|->
name|mdio_starting
operator|--
expr_stmt|;
name|callout_stop
argument_list|(
operator|&
name|pv
operator|->
name|pv_start_co
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|pv
argument_list|,
name|M_MD_DDF
argument_list|)
expr_stmt|;
name|vol
operator|->
name|v_md_data
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|g_raid_md_free_ddf
parameter_list|(
name|struct
name|g_raid_md_object
modifier|*
name|md
parameter_list|)
block|{
name|struct
name|g_raid_md_ddf_object
modifier|*
name|mdi
decl_stmt|;
name|mdi
operator|=
operator|(
expr|struct
name|g_raid_md_ddf_object
operator|*
operator|)
name|md
expr_stmt|;
if|if
condition|(
operator|!
name|mdi
operator|->
name|mdio_started
condition|)
block|{
name|mdi
operator|->
name|mdio_started
operator|=
literal|0
expr_stmt|;
name|callout_stop
argument_list|(
operator|&
name|mdi
operator|->
name|mdio_start_co
argument_list|)
expr_stmt|;
name|G_RAID_DEBUG1
argument_list|(
literal|1
argument_list|,
name|md
operator|->
name|mdo_softc
argument_list|,
literal|"root_mount_rel %p"
argument_list|,
name|mdi
operator|->
name|mdio_rootmount
argument_list|)
expr_stmt|;
name|root_mount_rel
argument_list|(
name|mdi
operator|->
name|mdio_rootmount
argument_list|)
expr_stmt|;
name|mdi
operator|->
name|mdio_rootmount
operator|=
name|NULL
expr_stmt|;
block|}
name|ddf_meta_free
argument_list|(
operator|&
name|mdi
operator|->
name|mdio_meta
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_expr_stmt
name|G_RAID_MD_DECLARE
argument_list|(
name|ddf
argument_list|,
literal|"DDF"
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


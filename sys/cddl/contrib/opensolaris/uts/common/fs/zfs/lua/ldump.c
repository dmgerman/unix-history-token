begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* ** $Id: ldump.c,v 2.17.1.1 2013/04/12 18:48:47 roberto Exp $ ** save precompiled Lua chunks ** See Copyright Notice in lua.h */
end_comment

begin_include
include|#
directive|include
file|<sys/zfs_context.h>
end_include

begin_define
define|#
directive|define
name|ldump_c
end_define

begin_define
define|#
directive|define
name|LUA_CORE
end_define

begin_include
include|#
directive|include
file|"lua.h"
end_include

begin_include
include|#
directive|include
file|"lobject.h"
end_include

begin_include
include|#
directive|include
file|"lstate.h"
end_include

begin_include
include|#
directive|include
file|"lundump.h"
end_include

begin_typedef
typedef|typedef
struct|struct
block|{
name|lua_State
modifier|*
name|L
decl_stmt|;
name|lua_Writer
name|writer
decl_stmt|;
name|void
modifier|*
name|data
decl_stmt|;
name|int
name|strip
decl_stmt|;
name|int
name|status
decl_stmt|;
block|}
name|DumpState
typedef|;
end_typedef

begin_define
define|#
directive|define
name|DumpMem
parameter_list|(
name|b
parameter_list|,
name|n
parameter_list|,
name|size
parameter_list|,
name|D
parameter_list|)
value|DumpBlock(b,(n)*(size),D)
end_define

begin_define
define|#
directive|define
name|DumpVar
parameter_list|(
name|x
parameter_list|,
name|D
parameter_list|)
value|DumpMem(&x,1,sizeof(x),D)
end_define

begin_function
specifier|static
name|void
name|DumpBlock
parameter_list|(
specifier|const
name|void
modifier|*
name|b
parameter_list|,
name|size_t
name|size
parameter_list|,
name|DumpState
modifier|*
name|D
parameter_list|)
block|{
if|if
condition|(
name|D
operator|->
name|status
operator|==
literal|0
condition|)
block|{
name|lua_unlock
argument_list|(
name|D
operator|->
name|L
argument_list|)
expr_stmt|;
name|D
operator|->
name|status
operator|=
call|(
modifier|*
name|D
operator|->
name|writer
call|)
argument_list|(
name|D
operator|->
name|L
argument_list|,
name|b
argument_list|,
name|size
argument_list|,
name|D
operator|->
name|data
argument_list|)
expr_stmt|;
name|lua_lock
argument_list|(
name|D
operator|->
name|L
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|DumpChar
parameter_list|(
name|int
name|y
parameter_list|,
name|DumpState
modifier|*
name|D
parameter_list|)
block|{
name|char
name|x
init|=
operator|(
name|char
operator|)
name|y
decl_stmt|;
name|DumpVar
argument_list|(
name|x
argument_list|,
name|D
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|DumpInt
parameter_list|(
name|int
name|x
parameter_list|,
name|DumpState
modifier|*
name|D
parameter_list|)
block|{
name|DumpVar
argument_list|(
name|x
argument_list|,
name|D
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|DumpNumber
parameter_list|(
name|lua_Number
name|x
parameter_list|,
name|DumpState
modifier|*
name|D
parameter_list|)
block|{
name|DumpVar
argument_list|(
name|x
argument_list|,
name|D
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|DumpVector
parameter_list|(
specifier|const
name|void
modifier|*
name|b
parameter_list|,
name|int
name|n
parameter_list|,
name|size_t
name|size
parameter_list|,
name|DumpState
modifier|*
name|D
parameter_list|)
block|{
name|DumpInt
argument_list|(
name|n
argument_list|,
name|D
argument_list|)
expr_stmt|;
name|DumpMem
argument_list|(
name|b
argument_list|,
name|n
argument_list|,
name|size
argument_list|,
name|D
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|DumpString
parameter_list|(
specifier|const
name|TString
modifier|*
name|s
parameter_list|,
name|DumpState
modifier|*
name|D
parameter_list|)
block|{
if|if
condition|(
name|s
operator|==
name|NULL
condition|)
block|{
name|size_t
name|size
init|=
literal|0
decl_stmt|;
name|DumpVar
argument_list|(
name|size
argument_list|,
name|D
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|size_t
name|size
init|=
name|s
operator|->
name|tsv
operator|.
name|len
operator|+
literal|1
decl_stmt|;
comment|/* include trailing '\0' */
name|DumpVar
argument_list|(
name|size
argument_list|,
name|D
argument_list|)
expr_stmt|;
name|DumpBlock
argument_list|(
name|getstr
argument_list|(
name|s
argument_list|)
argument_list|,
name|size
operator|*
sizeof|sizeof
argument_list|(
name|char
argument_list|)
argument_list|,
name|D
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_define
define|#
directive|define
name|DumpCode
parameter_list|(
name|f
parameter_list|,
name|D
parameter_list|)
value|DumpVector(f->code,f->sizecode,sizeof(Instruction),D)
end_define

begin_function_decl
specifier|static
name|void
name|DumpFunction
parameter_list|(
specifier|const
name|Proto
modifier|*
name|f
parameter_list|,
name|DumpState
modifier|*
name|D
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|void
name|DumpConstants
parameter_list|(
specifier|const
name|Proto
modifier|*
name|f
parameter_list|,
name|DumpState
modifier|*
name|D
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|n
init|=
name|f
operator|->
name|sizek
decl_stmt|;
name|DumpInt
argument_list|(
name|n
argument_list|,
name|D
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
specifier|const
name|TValue
modifier|*
name|o
init|=
operator|&
name|f
operator|->
name|k
index|[
name|i
index|]
decl_stmt|;
name|DumpChar
argument_list|(
name|ttypenv
argument_list|(
name|o
argument_list|)
argument_list|,
name|D
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ttypenv
argument_list|(
name|o
argument_list|)
condition|)
block|{
case|case
name|LUA_TNIL
case|:
break|break;
case|case
name|LUA_TBOOLEAN
case|:
name|DumpChar
argument_list|(
name|bvalue
argument_list|(
name|o
argument_list|)
argument_list|,
name|D
argument_list|)
expr_stmt|;
break|break;
case|case
name|LUA_TNUMBER
case|:
name|DumpNumber
argument_list|(
name|nvalue
argument_list|(
name|o
argument_list|)
argument_list|,
name|D
argument_list|)
expr_stmt|;
break|break;
case|case
name|LUA_TSTRING
case|:
name|DumpString
argument_list|(
name|rawtsvalue
argument_list|(
name|o
argument_list|)
argument_list|,
name|D
argument_list|)
expr_stmt|;
break|break;
default|default:
name|lua_assert
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
name|n
operator|=
name|f
operator|->
name|sizep
expr_stmt|;
name|DumpInt
argument_list|(
name|n
argument_list|,
name|D
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
name|DumpFunction
argument_list|(
name|f
operator|->
name|p
index|[
name|i
index|]
argument_list|,
name|D
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|DumpUpvalues
parameter_list|(
specifier|const
name|Proto
modifier|*
name|f
parameter_list|,
name|DumpState
modifier|*
name|D
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|n
init|=
name|f
operator|->
name|sizeupvalues
decl_stmt|;
name|DumpInt
argument_list|(
name|n
argument_list|,
name|D
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
name|DumpChar
argument_list|(
name|f
operator|->
name|upvalues
index|[
name|i
index|]
operator|.
name|instack
argument_list|,
name|D
argument_list|)
expr_stmt|;
name|DumpChar
argument_list|(
name|f
operator|->
name|upvalues
index|[
name|i
index|]
operator|.
name|idx
argument_list|,
name|D
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|DumpDebug
parameter_list|(
specifier|const
name|Proto
modifier|*
name|f
parameter_list|,
name|DumpState
modifier|*
name|D
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|n
decl_stmt|;
name|DumpString
argument_list|(
operator|(
name|D
operator|->
name|strip
operator|)
condition|?
name|NULL
else|:
name|f
operator|->
name|source
argument_list|,
name|D
argument_list|)
expr_stmt|;
name|n
operator|=
operator|(
name|D
operator|->
name|strip
operator|)
condition|?
literal|0
else|:
name|f
operator|->
name|sizelineinfo
expr_stmt|;
name|DumpVector
argument_list|(
name|f
operator|->
name|lineinfo
argument_list|,
name|n
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|,
name|D
argument_list|)
expr_stmt|;
name|n
operator|=
operator|(
name|D
operator|->
name|strip
operator|)
condition|?
literal|0
else|:
name|f
operator|->
name|sizelocvars
expr_stmt|;
name|DumpInt
argument_list|(
name|n
argument_list|,
name|D
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
name|DumpString
argument_list|(
name|f
operator|->
name|locvars
index|[
name|i
index|]
operator|.
name|varname
argument_list|,
name|D
argument_list|)
expr_stmt|;
name|DumpInt
argument_list|(
name|f
operator|->
name|locvars
index|[
name|i
index|]
operator|.
name|startpc
argument_list|,
name|D
argument_list|)
expr_stmt|;
name|DumpInt
argument_list|(
name|f
operator|->
name|locvars
index|[
name|i
index|]
operator|.
name|endpc
argument_list|,
name|D
argument_list|)
expr_stmt|;
block|}
name|n
operator|=
operator|(
name|D
operator|->
name|strip
operator|)
condition|?
literal|0
else|:
name|f
operator|->
name|sizeupvalues
expr_stmt|;
name|DumpInt
argument_list|(
name|n
argument_list|,
name|D
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
name|DumpString
argument_list|(
name|f
operator|->
name|upvalues
index|[
name|i
index|]
operator|.
name|name
argument_list|,
name|D
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|DumpFunction
parameter_list|(
specifier|const
name|Proto
modifier|*
name|f
parameter_list|,
name|DumpState
modifier|*
name|D
parameter_list|)
block|{
name|DumpInt
argument_list|(
name|f
operator|->
name|linedefined
argument_list|,
name|D
argument_list|)
expr_stmt|;
name|DumpInt
argument_list|(
name|f
operator|->
name|lastlinedefined
argument_list|,
name|D
argument_list|)
expr_stmt|;
name|DumpChar
argument_list|(
name|f
operator|->
name|numparams
argument_list|,
name|D
argument_list|)
expr_stmt|;
name|DumpChar
argument_list|(
name|f
operator|->
name|is_vararg
argument_list|,
name|D
argument_list|)
expr_stmt|;
name|DumpChar
argument_list|(
name|f
operator|->
name|maxstacksize
argument_list|,
name|D
argument_list|)
expr_stmt|;
name|DumpCode
argument_list|(
name|f
argument_list|,
name|D
argument_list|)
expr_stmt|;
name|DumpConstants
argument_list|(
name|f
argument_list|,
name|D
argument_list|)
expr_stmt|;
name|DumpUpvalues
argument_list|(
name|f
argument_list|,
name|D
argument_list|)
expr_stmt|;
name|DumpDebug
argument_list|(
name|f
argument_list|,
name|D
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|DumpHeader
parameter_list|(
name|DumpState
modifier|*
name|D
parameter_list|)
block|{
name|lu_byte
name|h
index|[
name|LUAC_HEADERSIZE
index|]
decl_stmt|;
name|luaU_header
argument_list|(
name|h
argument_list|)
expr_stmt|;
name|DumpBlock
argument_list|(
name|h
argument_list|,
name|LUAC_HEADERSIZE
argument_list|,
name|D
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ** dump Lua function as precompiled chunk */
end_comment

begin_function
name|int
name|luaU_dump
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
specifier|const
name|Proto
modifier|*
name|f
parameter_list|,
name|lua_Writer
name|w
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|int
name|strip
parameter_list|)
block|{
name|DumpState
name|D
decl_stmt|;
name|D
operator|.
name|L
operator|=
name|L
expr_stmt|;
name|D
operator|.
name|writer
operator|=
name|w
expr_stmt|;
name|D
operator|.
name|data
operator|=
name|data
expr_stmt|;
name|D
operator|.
name|strip
operator|=
name|strip
expr_stmt|;
name|D
operator|.
name|status
operator|=
literal|0
expr_stmt|;
name|DumpHeader
argument_list|(
operator|&
name|D
argument_list|)
expr_stmt|;
name|DumpFunction
argument_list|(
name|f
argument_list|,
operator|&
name|D
argument_list|)
expr_stmt|;
return|return
name|D
operator|.
name|status
return|;
block|}
end_function

end_unit


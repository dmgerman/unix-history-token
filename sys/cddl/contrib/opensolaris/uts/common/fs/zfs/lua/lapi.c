begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* ** $Id: lapi.c,v 2.171.1.1 2013/04/12 18:48:47 roberto Exp $ ** Lua API ** See Copyright Notice in lua.h */
end_comment

begin_include
include|#
directive|include
file|<sys/zfs_context.h>
end_include

begin_define
define|#
directive|define
name|lapi_c
end_define

begin_define
define|#
directive|define
name|LUA_CORE
end_define

begin_include
include|#
directive|include
file|"lua.h"
end_include

begin_include
include|#
directive|include
file|"lapi.h"
end_include

begin_include
include|#
directive|include
file|"ldebug.h"
end_include

begin_include
include|#
directive|include
file|"ldo.h"
end_include

begin_include
include|#
directive|include
file|"lfunc.h"
end_include

begin_include
include|#
directive|include
file|"lgc.h"
end_include

begin_include
include|#
directive|include
file|"lmem.h"
end_include

begin_include
include|#
directive|include
file|"lobject.h"
end_include

begin_include
include|#
directive|include
file|"lstate.h"
end_include

begin_include
include|#
directive|include
file|"lstring.h"
end_include

begin_include
include|#
directive|include
file|"ltable.h"
end_include

begin_include
include|#
directive|include
file|"ltm.h"
end_include

begin_include
include|#
directive|include
file|"lundump.h"
end_include

begin_include
include|#
directive|include
file|"lvm.h"
end_include

begin_decl_stmt
specifier|const
name|char
name|lua_ident
index|[]
init|=
literal|"$LuaVersion: "
name|LUA_COPYRIGHT
literal|" $"
literal|"$LuaAuthors: "
name|LUA_AUTHORS
literal|" $"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* value at a non-valid index */
end_comment

begin_define
define|#
directive|define
name|NONVALIDVALUE
value|cast(TValue *, luaO_nilobject)
end_define

begin_comment
comment|/* corresponding test */
end_comment

begin_define
define|#
directive|define
name|isvalid
parameter_list|(
name|o
parameter_list|)
value|((o) != luaO_nilobject)
end_define

begin_comment
comment|/* test for pseudo index */
end_comment

begin_define
define|#
directive|define
name|ispseudo
parameter_list|(
name|i
parameter_list|)
value|((i)<= LUA_REGISTRYINDEX)
end_define

begin_comment
comment|/* test for valid but not pseudo index */
end_comment

begin_define
define|#
directive|define
name|isstackindex
parameter_list|(
name|i
parameter_list|,
name|o
parameter_list|)
value|(isvalid(o)&& !ispseudo(i))
end_define

begin_define
define|#
directive|define
name|api_checkvalidindex
parameter_list|(
name|L
parameter_list|,
name|o
parameter_list|)
value|api_check(L, isvalid(o), "invalid index")
end_define

begin_define
define|#
directive|define
name|api_checkstackindex
parameter_list|(
name|L
parameter_list|,
name|i
parameter_list|,
name|o
parameter_list|)
define|\
value|api_check(L, isstackindex(i, o), "index not in the stack")
end_define

begin_function
specifier|static
name|TValue
modifier|*
name|index2addr
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|int
name|idx
parameter_list|)
block|{
name|CallInfo
modifier|*
name|ci
init|=
name|L
operator|->
name|ci
decl_stmt|;
if|if
condition|(
name|idx
operator|>
literal|0
condition|)
block|{
name|TValue
modifier|*
name|o
init|=
name|ci
operator|->
name|func
operator|+
name|idx
decl_stmt|;
name|api_check
argument_list|(
name|L
argument_list|,
name|idx
operator|<=
name|ci
operator|->
name|top
operator|-
operator|(
name|ci
operator|->
name|func
operator|+
literal|1
operator|)
argument_list|,
literal|"unacceptable index"
argument_list|)
expr_stmt|;
if|if
condition|(
name|o
operator|>=
name|L
operator|->
name|top
condition|)
return|return
name|NONVALIDVALUE
return|;
else|else
return|return
name|o
return|;
block|}
elseif|else
if|if
condition|(
operator|!
name|ispseudo
argument_list|(
name|idx
argument_list|)
condition|)
block|{
comment|/* negative index */
name|api_check
argument_list|(
name|L
argument_list|,
name|idx
operator|!=
literal|0
operator|&&
operator|-
name|idx
operator|<=
name|L
operator|->
name|top
operator|-
operator|(
name|ci
operator|->
name|func
operator|+
literal|1
operator|)
argument_list|,
literal|"invalid index"
argument_list|)
expr_stmt|;
return|return
name|L
operator|->
name|top
operator|+
name|idx
return|;
block|}
elseif|else
if|if
condition|(
name|idx
operator|==
name|LUA_REGISTRYINDEX
condition|)
return|return
operator|&
name|G
argument_list|(
name|L
argument_list|)
operator|->
name|l_registry
return|;
else|else
block|{
comment|/* upvalues */
name|idx
operator|=
name|LUA_REGISTRYINDEX
operator|-
name|idx
expr_stmt|;
name|api_check
argument_list|(
name|L
argument_list|,
name|idx
operator|<=
name|MAXUPVAL
operator|+
literal|1
argument_list|,
literal|"upvalue index too large"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ttislcf
argument_list|(
name|ci
operator|->
name|func
argument_list|)
condition|)
comment|/* light C function? */
return|return
name|NONVALIDVALUE
return|;
comment|/* it has no upvalues */
else|else
block|{
name|CClosure
modifier|*
name|func
init|=
name|clCvalue
argument_list|(
name|ci
operator|->
name|func
argument_list|)
decl_stmt|;
return|return
operator|(
name|idx
operator|<=
name|func
operator|->
name|nupvalues
operator|)
condition|?
operator|&
name|func
operator|->
name|upvalue
index|[
name|idx
operator|-
literal|1
index|]
else|:
name|NONVALIDVALUE
return|;
block|}
block|}
block|}
end_function

begin_comment
comment|/* ** to be called by 'lua_checkstack' in protected mode, to grow stack ** capturing memory errors */
end_comment

begin_function
specifier|static
name|void
name|growstack
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|void
modifier|*
name|ud
parameter_list|)
block|{
name|int
name|size
init|=
operator|*
operator|(
name|int
operator|*
operator|)
name|ud
decl_stmt|;
name|luaD_growstack
argument_list|(
name|L
argument_list|,
name|size
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|LUA_API
name|int
name|lua_checkstack
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|int
name|size
parameter_list|)
block|{
name|int
name|res
decl_stmt|;
name|CallInfo
modifier|*
name|ci
init|=
name|L
operator|->
name|ci
decl_stmt|;
name|lua_lock
argument_list|(
name|L
argument_list|)
expr_stmt|;
if|if
condition|(
name|L
operator|->
name|stack_last
operator|-
name|L
operator|->
name|top
operator|>
name|size
condition|)
comment|/* stack large enough? */
name|res
operator|=
literal|1
expr_stmt|;
comment|/* yes; check is OK */
else|else
block|{
comment|/* no; need to grow stack */
name|int
name|inuse
init|=
name|cast_int
argument_list|(
name|L
operator|->
name|top
operator|-
name|L
operator|->
name|stack
argument_list|)
operator|+
name|EXTRA_STACK
decl_stmt|;
if|if
condition|(
name|inuse
operator|>
name|LUAI_MAXSTACK
operator|-
name|size
condition|)
comment|/* can grow without overflow? */
name|res
operator|=
literal|0
expr_stmt|;
comment|/* no */
else|else
comment|/* try to grow stack */
name|res
operator|=
operator|(
name|luaD_rawrunprotected
argument_list|(
name|L
argument_list|,
operator|&
name|growstack
argument_list|,
operator|&
name|size
argument_list|)
operator|==
name|LUA_OK
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|res
operator|&&
name|ci
operator|->
name|top
operator|<
name|L
operator|->
name|top
operator|+
name|size
condition|)
name|ci
operator|->
name|top
operator|=
name|L
operator|->
name|top
operator|+
name|size
expr_stmt|;
comment|/* adjust frame top */
name|lua_unlock
argument_list|(
name|L
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_function
name|LUA_API
name|void
name|lua_xmove
parameter_list|(
name|lua_State
modifier|*
name|from
parameter_list|,
name|lua_State
modifier|*
name|to
parameter_list|,
name|int
name|n
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|from
operator|==
name|to
condition|)
return|return;
name|lua_lock
argument_list|(
name|to
argument_list|)
expr_stmt|;
name|api_checknelems
argument_list|(
name|from
argument_list|,
name|n
argument_list|)
expr_stmt|;
name|api_check
argument_list|(
name|from
argument_list|,
name|G
argument_list|(
name|from
argument_list|)
operator|==
name|G
argument_list|(
name|to
argument_list|)
argument_list|,
literal|"moving among independent states"
argument_list|)
expr_stmt|;
name|api_check
argument_list|(
name|from
argument_list|,
name|to
operator|->
name|ci
operator|->
name|top
operator|-
name|to
operator|->
name|top
operator|>=
name|n
argument_list|,
literal|"not enough elements to move"
argument_list|)
expr_stmt|;
name|from
operator|->
name|top
operator|-=
name|n
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
name|setobj2s
argument_list|(
name|to
argument_list|,
name|to
operator|->
name|top
operator|++
argument_list|,
name|from
operator|->
name|top
operator|+
name|i
argument_list|)
expr_stmt|;
block|}
name|lua_unlock
argument_list|(
name|to
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|LUA_API
name|lua_CFunction
name|lua_atpanic
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|lua_CFunction
name|panicf
parameter_list|)
block|{
name|lua_CFunction
name|old
decl_stmt|;
name|lua_lock
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|old
operator|=
name|G
argument_list|(
name|L
argument_list|)
operator|->
name|panic
expr_stmt|;
name|G
argument_list|(
name|L
argument_list|)
operator|->
name|panic
operator|=
name|panicf
expr_stmt|;
name|lua_unlock
argument_list|(
name|L
argument_list|)
expr_stmt|;
return|return
name|old
return|;
block|}
end_function

begin_function
name|LUA_API
specifier|const
name|lua_Number
modifier|*
name|lua_version
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|)
block|{
specifier|static
specifier|const
name|lua_Number
name|version
init|=
name|LUA_VERSION_NUM
decl_stmt|;
if|if
condition|(
name|L
operator|==
name|NULL
condition|)
return|return
operator|&
name|version
return|;
else|else
return|return
name|G
argument_list|(
name|L
argument_list|)
operator|->
name|version
return|;
block|}
end_function

begin_comment
comment|/* ** basic stack manipulation */
end_comment

begin_comment
comment|/* ** convert an acceptable stack index into an absolute index */
end_comment

begin_function
name|LUA_API
name|int
name|lua_absindex
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|int
name|idx
parameter_list|)
block|{
return|return
operator|(
name|idx
operator|>
literal|0
operator|||
name|ispseudo
argument_list|(
name|idx
argument_list|)
operator|)
condition|?
name|idx
else|:
name|cast_int
argument_list|(
name|L
operator|->
name|top
operator|-
name|L
operator|->
name|ci
operator|->
name|func
operator|+
name|idx
argument_list|)
return|;
block|}
end_function

begin_function
name|LUA_API
name|int
name|lua_gettop
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|)
block|{
return|return
name|cast_int
argument_list|(
name|L
operator|->
name|top
operator|-
operator|(
name|L
operator|->
name|ci
operator|->
name|func
operator|+
literal|1
operator|)
argument_list|)
return|;
block|}
end_function

begin_function
name|LUA_API
name|void
name|lua_settop
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|int
name|idx
parameter_list|)
block|{
name|StkId
name|func
init|=
name|L
operator|->
name|ci
operator|->
name|func
decl_stmt|;
name|lua_lock
argument_list|(
name|L
argument_list|)
expr_stmt|;
if|if
condition|(
name|idx
operator|>=
literal|0
condition|)
block|{
name|api_check
argument_list|(
name|L
argument_list|,
name|idx
operator|<=
name|L
operator|->
name|stack_last
operator|-
operator|(
name|func
operator|+
literal|1
operator|)
argument_list|,
literal|"new top too large"
argument_list|)
expr_stmt|;
while|while
condition|(
name|L
operator|->
name|top
operator|<
operator|(
name|func
operator|+
literal|1
operator|)
operator|+
name|idx
condition|)
name|setnilvalue
argument_list|(
name|L
operator|->
name|top
operator|++
argument_list|)
expr_stmt|;
name|L
operator|->
name|top
operator|=
operator|(
name|func
operator|+
literal|1
operator|)
operator|+
name|idx
expr_stmt|;
block|}
else|else
block|{
name|api_check
argument_list|(
name|L
argument_list|,
operator|-
operator|(
name|idx
operator|+
literal|1
operator|)
operator|<=
operator|(
name|L
operator|->
name|top
operator|-
operator|(
name|func
operator|+
literal|1
operator|)
operator|)
argument_list|,
literal|"invalid new top"
argument_list|)
expr_stmt|;
name|L
operator|->
name|top
operator|+=
name|idx
operator|+
literal|1
expr_stmt|;
comment|/* `subtract' index (index is negative) */
block|}
name|lua_unlock
argument_list|(
name|L
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|LUA_API
name|void
name|lua_remove
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|int
name|idx
parameter_list|)
block|{
name|StkId
name|p
decl_stmt|;
name|lua_lock
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|p
operator|=
name|index2addr
argument_list|(
name|L
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|api_checkstackindex
argument_list|(
name|L
argument_list|,
name|idx
argument_list|,
name|p
argument_list|)
expr_stmt|;
while|while
condition|(
operator|++
name|p
operator|<
name|L
operator|->
name|top
condition|)
name|setobjs2s
argument_list|(
name|L
argument_list|,
name|p
operator|-
literal|1
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|L
operator|->
name|top
operator|--
expr_stmt|;
name|lua_unlock
argument_list|(
name|L
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|LUA_API
name|void
name|lua_insert
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|int
name|idx
parameter_list|)
block|{
name|StkId
name|p
decl_stmt|;
name|StkId
name|q
decl_stmt|;
name|lua_lock
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|p
operator|=
name|index2addr
argument_list|(
name|L
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|api_checkstackindex
argument_list|(
name|L
argument_list|,
name|idx
argument_list|,
name|p
argument_list|)
expr_stmt|;
for|for
control|(
name|q
operator|=
name|L
operator|->
name|top
init|;
name|q
operator|>
name|p
condition|;
name|q
operator|--
control|)
comment|/* use L->top as a temporary */
name|setobjs2s
argument_list|(
name|L
argument_list|,
name|q
argument_list|,
name|q
operator|-
literal|1
argument_list|)
expr_stmt|;
name|setobjs2s
argument_list|(
name|L
argument_list|,
name|p
argument_list|,
name|L
operator|->
name|top
argument_list|)
expr_stmt|;
name|lua_unlock
argument_list|(
name|L
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|moveto
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|TValue
modifier|*
name|fr
parameter_list|,
name|int
name|idx
parameter_list|)
block|{
name|TValue
modifier|*
name|to
init|=
name|index2addr
argument_list|(
name|L
argument_list|,
name|idx
argument_list|)
decl_stmt|;
name|api_checkvalidindex
argument_list|(
name|L
argument_list|,
name|to
argument_list|)
expr_stmt|;
name|setobj
argument_list|(
name|L
argument_list|,
name|to
argument_list|,
name|fr
argument_list|)
expr_stmt|;
if|if
condition|(
name|idx
operator|<
name|LUA_REGISTRYINDEX
condition|)
comment|/* function upvalue? */
name|luaC_barrier
argument_list|(
name|L
argument_list|,
name|clCvalue
argument_list|(
name|L
operator|->
name|ci
operator|->
name|func
argument_list|)
argument_list|,
name|fr
argument_list|)
expr_stmt|;
comment|/* LUA_REGISTRYINDEX does not need gc barrier      (collector revisits it before finishing collection) */
block|}
end_function

begin_function
name|LUA_API
name|void
name|lua_replace
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|int
name|idx
parameter_list|)
block|{
name|lua_lock
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|api_checknelems
argument_list|(
name|L
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|moveto
argument_list|(
name|L
argument_list|,
name|L
operator|->
name|top
operator|-
literal|1
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|L
operator|->
name|top
operator|--
expr_stmt|;
name|lua_unlock
argument_list|(
name|L
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|LUA_API
name|void
name|lua_copy
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|int
name|fromidx
parameter_list|,
name|int
name|toidx
parameter_list|)
block|{
name|TValue
modifier|*
name|fr
decl_stmt|;
name|lua_lock
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|fr
operator|=
name|index2addr
argument_list|(
name|L
argument_list|,
name|fromidx
argument_list|)
expr_stmt|;
name|moveto
argument_list|(
name|L
argument_list|,
name|fr
argument_list|,
name|toidx
argument_list|)
expr_stmt|;
name|lua_unlock
argument_list|(
name|L
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|LUA_API
name|void
name|lua_pushvalue
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|int
name|idx
parameter_list|)
block|{
name|lua_lock
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|setobj2s
argument_list|(
name|L
argument_list|,
name|L
operator|->
name|top
argument_list|,
name|index2addr
argument_list|(
name|L
argument_list|,
name|idx
argument_list|)
argument_list|)
expr_stmt|;
name|api_incr_top
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|lua_unlock
argument_list|(
name|L
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ** access functions (stack -> C) */
end_comment

begin_function
name|LUA_API
name|int
name|lua_type
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|int
name|idx
parameter_list|)
block|{
name|StkId
name|o
init|=
name|index2addr
argument_list|(
name|L
argument_list|,
name|idx
argument_list|)
decl_stmt|;
return|return
operator|(
name|isvalid
argument_list|(
name|o
argument_list|)
condition|?
name|ttypenv
argument_list|(
name|o
argument_list|)
else|:
name|LUA_TNONE
operator|)
return|;
block|}
end_function

begin_function
name|LUA_API
specifier|const
name|char
modifier|*
name|lua_typename
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|int
name|t
parameter_list|)
block|{
name|UNUSED
argument_list|(
name|L
argument_list|)
expr_stmt|;
return|return
name|ttypename
argument_list|(
name|t
argument_list|)
return|;
block|}
end_function

begin_function
name|LUA_API
name|int
name|lua_iscfunction
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|int
name|idx
parameter_list|)
block|{
name|StkId
name|o
init|=
name|index2addr
argument_list|(
name|L
argument_list|,
name|idx
argument_list|)
decl_stmt|;
return|return
operator|(
name|ttislcf
argument_list|(
name|o
argument_list|)
operator|||
operator|(
name|ttisCclosure
argument_list|(
name|o
argument_list|)
operator|)
operator|)
return|;
block|}
end_function

begin_function
name|LUA_API
name|int
name|lua_isnumber
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|int
name|idx
parameter_list|)
block|{
name|TValue
name|n
decl_stmt|;
specifier|const
name|TValue
modifier|*
name|o
init|=
name|index2addr
argument_list|(
name|L
argument_list|,
name|idx
argument_list|)
decl_stmt|;
return|return
name|tonumber
argument_list|(
name|o
argument_list|,
operator|&
name|n
argument_list|)
return|;
block|}
end_function

begin_function
name|LUA_API
name|int
name|lua_isstring
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|int
name|idx
parameter_list|)
block|{
name|int
name|t
init|=
name|lua_type
argument_list|(
name|L
argument_list|,
name|idx
argument_list|)
decl_stmt|;
return|return
operator|(
name|t
operator|==
name|LUA_TSTRING
operator|||
name|t
operator|==
name|LUA_TNUMBER
operator|)
return|;
block|}
end_function

begin_function
name|LUA_API
name|int
name|lua_isuserdata
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|int
name|idx
parameter_list|)
block|{
specifier|const
name|TValue
modifier|*
name|o
init|=
name|index2addr
argument_list|(
name|L
argument_list|,
name|idx
argument_list|)
decl_stmt|;
return|return
operator|(
name|ttisuserdata
argument_list|(
name|o
argument_list|)
operator|||
name|ttislightuserdata
argument_list|(
name|o
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|LUA_API
name|int
name|lua_rawequal
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|int
name|index1
parameter_list|,
name|int
name|index2
parameter_list|)
block|{
name|StkId
name|o1
init|=
name|index2addr
argument_list|(
name|L
argument_list|,
name|index1
argument_list|)
decl_stmt|;
name|StkId
name|o2
init|=
name|index2addr
argument_list|(
name|L
argument_list|,
name|index2
argument_list|)
decl_stmt|;
return|return
operator|(
name|isvalid
argument_list|(
name|o1
argument_list|)
operator|&&
name|isvalid
argument_list|(
name|o2
argument_list|)
operator|)
condition|?
name|luaV_rawequalobj
argument_list|(
name|o1
argument_list|,
name|o2
argument_list|)
else|:
literal|0
return|;
block|}
end_function

begin_function
name|LUA_API
name|void
name|lua_arith
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|int
name|op
parameter_list|)
block|{
name|StkId
name|o1
decl_stmt|;
comment|/* 1st operand */
name|StkId
name|o2
decl_stmt|;
comment|/* 2nd operand */
name|lua_lock
argument_list|(
name|L
argument_list|)
expr_stmt|;
if|if
condition|(
name|op
operator|!=
name|LUA_OPUNM
condition|)
comment|/* all other operations expect two operands */
name|api_checknelems
argument_list|(
name|L
argument_list|,
literal|2
argument_list|)
expr_stmt|;
else|else
block|{
comment|/* for unary minus, add fake 2nd operand */
name|api_checknelems
argument_list|(
name|L
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|setobjs2s
argument_list|(
name|L
argument_list|,
name|L
operator|->
name|top
argument_list|,
name|L
operator|->
name|top
operator|-
literal|1
argument_list|)
expr_stmt|;
name|L
operator|->
name|top
operator|++
expr_stmt|;
block|}
name|o1
operator|=
name|L
operator|->
name|top
operator|-
literal|2
expr_stmt|;
name|o2
operator|=
name|L
operator|->
name|top
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|ttisnumber
argument_list|(
name|o1
argument_list|)
operator|&&
name|ttisnumber
argument_list|(
name|o2
argument_list|)
condition|)
block|{
name|setnvalue
argument_list|(
name|o1
argument_list|,
name|luaO_arith
argument_list|(
name|op
argument_list|,
name|nvalue
argument_list|(
name|o1
argument_list|)
argument_list|,
name|nvalue
argument_list|(
name|o2
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|luaV_arith
argument_list|(
name|L
argument_list|,
name|o1
argument_list|,
name|o1
argument_list|,
name|o2
argument_list|,
name|cast
argument_list|(
name|TMS
argument_list|,
name|op
operator|-
name|LUA_OPADD
operator|+
name|TM_ADD
argument_list|)
argument_list|)
expr_stmt|;
name|L
operator|->
name|top
operator|--
expr_stmt|;
name|lua_unlock
argument_list|(
name|L
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|LUA_API
name|int
name|lua_compare
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|int
name|index1
parameter_list|,
name|int
name|index2
parameter_list|,
name|int
name|op
parameter_list|)
block|{
name|StkId
name|o1
decl_stmt|,
name|o2
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
name|lua_lock
argument_list|(
name|L
argument_list|)
expr_stmt|;
comment|/* may call tag method */
name|o1
operator|=
name|index2addr
argument_list|(
name|L
argument_list|,
name|index1
argument_list|)
expr_stmt|;
name|o2
operator|=
name|index2addr
argument_list|(
name|L
argument_list|,
name|index2
argument_list|)
expr_stmt|;
if|if
condition|(
name|isvalid
argument_list|(
name|o1
argument_list|)
operator|&&
name|isvalid
argument_list|(
name|o2
argument_list|)
condition|)
block|{
switch|switch
condition|(
name|op
condition|)
block|{
case|case
name|LUA_OPEQ
case|:
name|i
operator|=
name|equalobj
argument_list|(
name|L
argument_list|,
name|o1
argument_list|,
name|o2
argument_list|)
expr_stmt|;
break|break;
case|case
name|LUA_OPLT
case|:
name|i
operator|=
name|luaV_lessthan
argument_list|(
name|L
argument_list|,
name|o1
argument_list|,
name|o2
argument_list|)
expr_stmt|;
break|break;
case|case
name|LUA_OPLE
case|:
name|i
operator|=
name|luaV_lessequal
argument_list|(
name|L
argument_list|,
name|o1
argument_list|,
name|o2
argument_list|)
expr_stmt|;
break|break;
default|default:
name|api_check
argument_list|(
name|L
argument_list|,
literal|0
argument_list|,
literal|"invalid option"
argument_list|)
expr_stmt|;
block|}
block|}
name|lua_unlock
argument_list|(
name|L
argument_list|)
expr_stmt|;
return|return
name|i
return|;
block|}
end_function

begin_function
name|LUA_API
name|lua_Number
name|lua_tonumberx
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|int
name|idx
parameter_list|,
name|int
modifier|*
name|isnum
parameter_list|)
block|{
name|TValue
name|n
decl_stmt|;
specifier|const
name|TValue
modifier|*
name|o
init|=
name|index2addr
argument_list|(
name|L
argument_list|,
name|idx
argument_list|)
decl_stmt|;
if|if
condition|(
name|tonumber
argument_list|(
name|o
argument_list|,
operator|&
name|n
argument_list|)
condition|)
block|{
if|if
condition|(
name|isnum
condition|)
operator|*
name|isnum
operator|=
literal|1
expr_stmt|;
return|return
name|nvalue
argument_list|(
name|o
argument_list|)
return|;
block|}
else|else
block|{
if|if
condition|(
name|isnum
condition|)
operator|*
name|isnum
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
end_function

begin_function
name|LUA_API
name|lua_Integer
name|lua_tointegerx
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|int
name|idx
parameter_list|,
name|int
modifier|*
name|isnum
parameter_list|)
block|{
name|TValue
name|n
decl_stmt|;
specifier|const
name|TValue
modifier|*
name|o
init|=
name|index2addr
argument_list|(
name|L
argument_list|,
name|idx
argument_list|)
decl_stmt|;
if|if
condition|(
name|tonumber
argument_list|(
name|o
argument_list|,
operator|&
name|n
argument_list|)
condition|)
block|{
name|lua_Integer
name|res
decl_stmt|;
name|lua_Number
name|num
init|=
name|nvalue
argument_list|(
name|o
argument_list|)
decl_stmt|;
name|lua_number2integer
argument_list|(
name|res
argument_list|,
name|num
argument_list|)
expr_stmt|;
if|if
condition|(
name|isnum
condition|)
operator|*
name|isnum
operator|=
literal|1
expr_stmt|;
return|return
name|res
return|;
block|}
else|else
block|{
if|if
condition|(
name|isnum
condition|)
operator|*
name|isnum
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
end_function

begin_function
name|LUA_API
name|lua_Unsigned
name|lua_tounsignedx
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|int
name|idx
parameter_list|,
name|int
modifier|*
name|isnum
parameter_list|)
block|{
name|TValue
name|n
decl_stmt|;
specifier|const
name|TValue
modifier|*
name|o
init|=
name|index2addr
argument_list|(
name|L
argument_list|,
name|idx
argument_list|)
decl_stmt|;
if|if
condition|(
name|tonumber
argument_list|(
name|o
argument_list|,
operator|&
name|n
argument_list|)
condition|)
block|{
name|lua_Unsigned
name|res
decl_stmt|;
name|lua_Number
name|num
init|=
name|nvalue
argument_list|(
name|o
argument_list|)
decl_stmt|;
name|lua_number2unsigned
argument_list|(
name|res
argument_list|,
name|num
argument_list|)
expr_stmt|;
if|if
condition|(
name|isnum
condition|)
operator|*
name|isnum
operator|=
literal|1
expr_stmt|;
return|return
name|res
return|;
block|}
else|else
block|{
if|if
condition|(
name|isnum
condition|)
operator|*
name|isnum
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
end_function

begin_function
name|LUA_API
name|int
name|lua_toboolean
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|int
name|idx
parameter_list|)
block|{
specifier|const
name|TValue
modifier|*
name|o
init|=
name|index2addr
argument_list|(
name|L
argument_list|,
name|idx
argument_list|)
decl_stmt|;
return|return
operator|!
name|l_isfalse
argument_list|(
name|o
argument_list|)
return|;
block|}
end_function

begin_function
name|LUA_API
specifier|const
name|char
modifier|*
name|lua_tolstring
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|int
name|idx
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
name|StkId
name|o
init|=
name|index2addr
argument_list|(
name|L
argument_list|,
name|idx
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|ttisstring
argument_list|(
name|o
argument_list|)
condition|)
block|{
name|lua_lock
argument_list|(
name|L
argument_list|)
expr_stmt|;
comment|/* `luaV_tostring' may create a new string */
if|if
condition|(
operator|!
name|luaV_tostring
argument_list|(
name|L
argument_list|,
name|o
argument_list|)
condition|)
block|{
comment|/* conversion failed? */
if|if
condition|(
name|len
operator|!=
name|NULL
condition|)
operator|*
name|len
operator|=
literal|0
expr_stmt|;
name|lua_unlock
argument_list|(
name|L
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|luaC_checkGC
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|o
operator|=
name|index2addr
argument_list|(
name|L
argument_list|,
name|idx
argument_list|)
expr_stmt|;
comment|/* previous call may reallocate the stack */
name|lua_unlock
argument_list|(
name|L
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|len
operator|!=
name|NULL
condition|)
operator|*
name|len
operator|=
name|tsvalue
argument_list|(
name|o
argument_list|)
operator|->
name|len
expr_stmt|;
return|return
name|svalue
argument_list|(
name|o
argument_list|)
return|;
block|}
end_function

begin_function
name|LUA_API
name|size_t
name|lua_rawlen
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|int
name|idx
parameter_list|)
block|{
name|StkId
name|o
init|=
name|index2addr
argument_list|(
name|L
argument_list|,
name|idx
argument_list|)
decl_stmt|;
switch|switch
condition|(
name|ttypenv
argument_list|(
name|o
argument_list|)
condition|)
block|{
case|case
name|LUA_TSTRING
case|:
return|return
name|tsvalue
argument_list|(
name|o
argument_list|)
operator|->
name|len
return|;
case|case
name|LUA_TUSERDATA
case|:
return|return
name|uvalue
argument_list|(
name|o
argument_list|)
operator|->
name|len
return|;
case|case
name|LUA_TTABLE
case|:
return|return
name|luaH_getn
argument_list|(
name|hvalue
argument_list|(
name|o
argument_list|)
argument_list|)
return|;
default|default:
return|return
literal|0
return|;
block|}
block|}
end_function

begin_function
name|LUA_API
name|lua_CFunction
name|lua_tocfunction
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|int
name|idx
parameter_list|)
block|{
name|StkId
name|o
init|=
name|index2addr
argument_list|(
name|L
argument_list|,
name|idx
argument_list|)
decl_stmt|;
if|if
condition|(
name|ttislcf
argument_list|(
name|o
argument_list|)
condition|)
return|return
name|fvalue
argument_list|(
name|o
argument_list|)
return|;
elseif|else
if|if
condition|(
name|ttisCclosure
argument_list|(
name|o
argument_list|)
condition|)
return|return
name|clCvalue
argument_list|(
name|o
argument_list|)
operator|->
name|f
return|;
else|else
return|return
name|NULL
return|;
comment|/* not a C function */
block|}
end_function

begin_function
name|LUA_API
name|void
modifier|*
name|lua_touserdata
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|int
name|idx
parameter_list|)
block|{
name|StkId
name|o
init|=
name|index2addr
argument_list|(
name|L
argument_list|,
name|idx
argument_list|)
decl_stmt|;
switch|switch
condition|(
name|ttypenv
argument_list|(
name|o
argument_list|)
condition|)
block|{
case|case
name|LUA_TUSERDATA
case|:
return|return
operator|(
name|rawuvalue
argument_list|(
name|o
argument_list|)
operator|+
literal|1
operator|)
return|;
case|case
name|LUA_TLIGHTUSERDATA
case|:
return|return
name|pvalue
argument_list|(
name|o
argument_list|)
return|;
default|default:
return|return
name|NULL
return|;
block|}
block|}
end_function

begin_function
name|LUA_API
name|lua_State
modifier|*
name|lua_tothread
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|int
name|idx
parameter_list|)
block|{
name|StkId
name|o
init|=
name|index2addr
argument_list|(
name|L
argument_list|,
name|idx
argument_list|)
decl_stmt|;
return|return
operator|(
operator|!
name|ttisthread
argument_list|(
name|o
argument_list|)
operator|)
condition|?
name|NULL
else|:
name|thvalue
argument_list|(
name|o
argument_list|)
return|;
block|}
end_function

begin_function
name|LUA_API
specifier|const
name|void
modifier|*
name|lua_topointer
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|int
name|idx
parameter_list|)
block|{
name|StkId
name|o
init|=
name|index2addr
argument_list|(
name|L
argument_list|,
name|idx
argument_list|)
decl_stmt|;
switch|switch
condition|(
name|ttype
argument_list|(
name|o
argument_list|)
condition|)
block|{
case|case
name|LUA_TTABLE
case|:
return|return
name|hvalue
argument_list|(
name|o
argument_list|)
return|;
case|case
name|LUA_TLCL
case|:
return|return
name|clLvalue
argument_list|(
name|o
argument_list|)
return|;
case|case
name|LUA_TCCL
case|:
return|return
name|clCvalue
argument_list|(
name|o
argument_list|)
return|;
case|case
name|LUA_TLCF
case|:
return|return
name|cast
argument_list|(
name|void
operator|*
argument_list|,
name|cast
argument_list|(
name|size_t
argument_list|,
name|fvalue
argument_list|(
name|o
argument_list|)
argument_list|)
argument_list|)
return|;
case|case
name|LUA_TTHREAD
case|:
return|return
name|thvalue
argument_list|(
name|o
argument_list|)
return|;
case|case
name|LUA_TUSERDATA
case|:
case|case
name|LUA_TLIGHTUSERDATA
case|:
return|return
name|lua_touserdata
argument_list|(
name|L
argument_list|,
name|idx
argument_list|)
return|;
default|default:
return|return
name|NULL
return|;
block|}
block|}
end_function

begin_comment
comment|/* ** push functions (C -> stack) */
end_comment

begin_function
name|LUA_API
name|void
name|lua_pushnil
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|)
block|{
name|lua_lock
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|setnilvalue
argument_list|(
name|L
operator|->
name|top
argument_list|)
expr_stmt|;
name|api_incr_top
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|lua_unlock
argument_list|(
name|L
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|LUA_API
name|void
name|lua_pushnumber
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|lua_Number
name|n
parameter_list|)
block|{
name|lua_lock
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|setnvalue
argument_list|(
name|L
operator|->
name|top
argument_list|,
name|n
argument_list|)
expr_stmt|;
name|luai_checknum
argument_list|(
name|L
argument_list|,
name|L
operator|->
name|top
argument_list|,
name|luaG_runerror
argument_list|(
name|L
argument_list|,
literal|"C API - attempt to push a signaling NaN"
argument_list|)
argument_list|)
expr_stmt|;
name|api_incr_top
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|lua_unlock
argument_list|(
name|L
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|LUA_API
name|void
name|lua_pushinteger
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|lua_Integer
name|n
parameter_list|)
block|{
name|lua_lock
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|setnvalue
argument_list|(
name|L
operator|->
name|top
argument_list|,
name|cast_num
argument_list|(
name|n
argument_list|)
argument_list|)
expr_stmt|;
name|api_incr_top
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|lua_unlock
argument_list|(
name|L
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|LUA_API
name|void
name|lua_pushunsigned
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|lua_Unsigned
name|u
parameter_list|)
block|{
name|lua_Number
name|n
decl_stmt|;
name|lua_lock
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|n
operator|=
name|lua_unsigned2number
argument_list|(
name|u
argument_list|)
expr_stmt|;
name|setnvalue
argument_list|(
name|L
operator|->
name|top
argument_list|,
name|n
argument_list|)
expr_stmt|;
name|api_incr_top
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|lua_unlock
argument_list|(
name|L
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|LUA_API
specifier|const
name|char
modifier|*
name|lua_pushlstring
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
specifier|const
name|char
modifier|*
name|s
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|TString
modifier|*
name|ts
decl_stmt|;
name|lua_lock
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|luaC_checkGC
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|ts
operator|=
name|luaS_newlstr
argument_list|(
name|L
argument_list|,
name|s
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|setsvalue2s
argument_list|(
name|L
argument_list|,
name|L
operator|->
name|top
argument_list|,
name|ts
argument_list|)
expr_stmt|;
name|api_incr_top
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|lua_unlock
argument_list|(
name|L
argument_list|)
expr_stmt|;
return|return
name|getstr
argument_list|(
name|ts
argument_list|)
return|;
block|}
end_function

begin_function
name|LUA_API
specifier|const
name|char
modifier|*
name|lua_pushstring
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
specifier|const
name|char
modifier|*
name|s
parameter_list|)
block|{
if|if
condition|(
name|s
operator|==
name|NULL
condition|)
block|{
name|lua_pushnil
argument_list|(
name|L
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
else|else
block|{
name|TString
modifier|*
name|ts
decl_stmt|;
name|lua_lock
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|luaC_checkGC
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|ts
operator|=
name|luaS_new
argument_list|(
name|L
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|setsvalue2s
argument_list|(
name|L
argument_list|,
name|L
operator|->
name|top
argument_list|,
name|ts
argument_list|)
expr_stmt|;
name|api_incr_top
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|lua_unlock
argument_list|(
name|L
argument_list|)
expr_stmt|;
return|return
name|getstr
argument_list|(
name|ts
argument_list|)
return|;
block|}
block|}
end_function

begin_function
name|LUA_API
specifier|const
name|char
modifier|*
name|lua_pushvfstring
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
name|va_list
name|argp
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|ret
decl_stmt|;
name|lua_lock
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|luaC_checkGC
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|ret
operator|=
name|luaO_pushvfstring
argument_list|(
name|L
argument_list|,
name|fmt
argument_list|,
name|argp
argument_list|)
expr_stmt|;
name|lua_unlock
argument_list|(
name|L
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|LUA_API
specifier|const
name|char
modifier|*
name|lua_pushfstring
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|ret
decl_stmt|;
name|va_list
name|argp
decl_stmt|;
name|lua_lock
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|luaC_checkGC
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|va_start
argument_list|(
name|argp
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|ret
operator|=
name|luaO_pushvfstring
argument_list|(
name|L
argument_list|,
name|fmt
argument_list|,
name|argp
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|argp
argument_list|)
expr_stmt|;
name|lua_unlock
argument_list|(
name|L
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|LUA_API
name|void
name|lua_pushcclosure
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|lua_CFunction
name|fn
parameter_list|,
name|int
name|n
parameter_list|)
block|{
name|lua_lock
argument_list|(
name|L
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
literal|0
condition|)
block|{
name|setfvalue
argument_list|(
name|L
operator|->
name|top
argument_list|,
name|fn
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|Closure
modifier|*
name|cl
decl_stmt|;
name|api_checknelems
argument_list|(
name|L
argument_list|,
name|n
argument_list|)
expr_stmt|;
name|api_check
argument_list|(
name|L
argument_list|,
name|n
operator|<=
name|MAXUPVAL
argument_list|,
literal|"upvalue index too large"
argument_list|)
expr_stmt|;
name|luaC_checkGC
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|cl
operator|=
name|luaF_newCclosure
argument_list|(
name|L
argument_list|,
name|n
argument_list|)
expr_stmt|;
name|cl
operator|->
name|c
operator|.
name|f
operator|=
name|fn
expr_stmt|;
name|L
operator|->
name|top
operator|-=
name|n
expr_stmt|;
while|while
condition|(
name|n
operator|--
condition|)
name|setobj2n
argument_list|(
name|L
argument_list|,
operator|&
name|cl
operator|->
name|c
operator|.
name|upvalue
index|[
name|n
index|]
argument_list|,
name|L
operator|->
name|top
operator|+
name|n
argument_list|)
expr_stmt|;
name|setclCvalue
argument_list|(
name|L
argument_list|,
name|L
operator|->
name|top
argument_list|,
name|cl
argument_list|)
expr_stmt|;
block|}
name|api_incr_top
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|lua_unlock
argument_list|(
name|L
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|LUA_API
name|void
name|lua_pushboolean
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|int
name|b
parameter_list|)
block|{
name|lua_lock
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|setbvalue
argument_list|(
name|L
operator|->
name|top
argument_list|,
operator|(
name|b
operator|!=
literal|0
operator|)
argument_list|)
expr_stmt|;
comment|/* ensure that true is 1 */
name|api_incr_top
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|lua_unlock
argument_list|(
name|L
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|LUA_API
name|void
name|lua_pushlightuserdata
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|void
modifier|*
name|p
parameter_list|)
block|{
name|lua_lock
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|setpvalue
argument_list|(
name|L
operator|->
name|top
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|api_incr_top
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|lua_unlock
argument_list|(
name|L
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|LUA_API
name|int
name|lua_pushthread
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|)
block|{
name|lua_lock
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|setthvalue
argument_list|(
name|L
argument_list|,
name|L
operator|->
name|top
argument_list|,
name|L
argument_list|)
expr_stmt|;
name|api_incr_top
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|lua_unlock
argument_list|(
name|L
argument_list|)
expr_stmt|;
return|return
operator|(
name|G
argument_list|(
name|L
argument_list|)
operator|->
name|mainthread
operator|==
name|L
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ** get functions (Lua -> stack) */
end_comment

begin_function
name|LUA_API
name|void
name|lua_getglobal
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
specifier|const
name|char
modifier|*
name|var
parameter_list|)
block|{
name|Table
modifier|*
name|reg
init|=
name|hvalue
argument_list|(
operator|&
name|G
argument_list|(
name|L
argument_list|)
operator|->
name|l_registry
argument_list|)
decl_stmt|;
specifier|const
name|TValue
modifier|*
name|gt
decl_stmt|;
comment|/* global table */
name|lua_lock
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|gt
operator|=
name|luaH_getint
argument_list|(
name|reg
argument_list|,
name|LUA_RIDX_GLOBALS
argument_list|)
expr_stmt|;
name|setsvalue2s
argument_list|(
name|L
argument_list|,
name|L
operator|->
name|top
operator|++
argument_list|,
name|luaS_new
argument_list|(
name|L
argument_list|,
name|var
argument_list|)
argument_list|)
expr_stmt|;
name|luaV_gettable
argument_list|(
name|L
argument_list|,
name|gt
argument_list|,
name|L
operator|->
name|top
operator|-
literal|1
argument_list|,
name|L
operator|->
name|top
operator|-
literal|1
argument_list|)
expr_stmt|;
name|lua_unlock
argument_list|(
name|L
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|LUA_API
name|void
name|lua_gettable
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|int
name|idx
parameter_list|)
block|{
name|StkId
name|t
decl_stmt|;
name|lua_lock
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|t
operator|=
name|index2addr
argument_list|(
name|L
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|luaV_gettable
argument_list|(
name|L
argument_list|,
name|t
argument_list|,
name|L
operator|->
name|top
operator|-
literal|1
argument_list|,
name|L
operator|->
name|top
operator|-
literal|1
argument_list|)
expr_stmt|;
name|lua_unlock
argument_list|(
name|L
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|LUA_API
name|void
name|lua_getfield
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|int
name|idx
parameter_list|,
specifier|const
name|char
modifier|*
name|k
parameter_list|)
block|{
name|StkId
name|t
decl_stmt|;
name|lua_lock
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|t
operator|=
name|index2addr
argument_list|(
name|L
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|setsvalue2s
argument_list|(
name|L
argument_list|,
name|L
operator|->
name|top
argument_list|,
name|luaS_new
argument_list|(
name|L
argument_list|,
name|k
argument_list|)
argument_list|)
expr_stmt|;
name|api_incr_top
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|luaV_gettable
argument_list|(
name|L
argument_list|,
name|t
argument_list|,
name|L
operator|->
name|top
operator|-
literal|1
argument_list|,
name|L
operator|->
name|top
operator|-
literal|1
argument_list|)
expr_stmt|;
name|lua_unlock
argument_list|(
name|L
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|LUA_API
name|void
name|lua_rawget
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|int
name|idx
parameter_list|)
block|{
name|StkId
name|t
decl_stmt|;
name|lua_lock
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|t
operator|=
name|index2addr
argument_list|(
name|L
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|api_check
argument_list|(
name|L
argument_list|,
name|ttistable
argument_list|(
name|t
argument_list|)
argument_list|,
literal|"table expected"
argument_list|)
expr_stmt|;
name|setobj2s
argument_list|(
name|L
argument_list|,
name|L
operator|->
name|top
operator|-
literal|1
argument_list|,
name|luaH_get
argument_list|(
name|hvalue
argument_list|(
name|t
argument_list|)
argument_list|,
name|L
operator|->
name|top
operator|-
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|lua_unlock
argument_list|(
name|L
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|LUA_API
name|void
name|lua_rawgeti
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|int
name|idx
parameter_list|,
name|int
name|n
parameter_list|)
block|{
name|StkId
name|t
decl_stmt|;
name|lua_lock
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|t
operator|=
name|index2addr
argument_list|(
name|L
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|api_check
argument_list|(
name|L
argument_list|,
name|ttistable
argument_list|(
name|t
argument_list|)
argument_list|,
literal|"table expected"
argument_list|)
expr_stmt|;
name|setobj2s
argument_list|(
name|L
argument_list|,
name|L
operator|->
name|top
argument_list|,
name|luaH_getint
argument_list|(
name|hvalue
argument_list|(
name|t
argument_list|)
argument_list|,
name|n
argument_list|)
argument_list|)
expr_stmt|;
name|api_incr_top
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|lua_unlock
argument_list|(
name|L
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|LUA_API
name|void
name|lua_rawgetp
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|int
name|idx
parameter_list|,
specifier|const
name|void
modifier|*
name|p
parameter_list|)
block|{
name|StkId
name|t
decl_stmt|;
name|TValue
name|k
decl_stmt|;
name|lua_lock
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|t
operator|=
name|index2addr
argument_list|(
name|L
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|api_check
argument_list|(
name|L
argument_list|,
name|ttistable
argument_list|(
name|t
argument_list|)
argument_list|,
literal|"table expected"
argument_list|)
expr_stmt|;
name|setpvalue
argument_list|(
operator|&
name|k
argument_list|,
name|cast
argument_list|(
name|void
operator|*
argument_list|,
name|p
argument_list|)
argument_list|)
expr_stmt|;
name|setobj2s
argument_list|(
name|L
argument_list|,
name|L
operator|->
name|top
argument_list|,
name|luaH_get
argument_list|(
name|hvalue
argument_list|(
name|t
argument_list|)
argument_list|,
operator|&
name|k
argument_list|)
argument_list|)
expr_stmt|;
name|api_incr_top
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|lua_unlock
argument_list|(
name|L
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|LUA_API
name|void
name|lua_createtable
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|int
name|narray
parameter_list|,
name|int
name|nrec
parameter_list|)
block|{
name|Table
modifier|*
name|t
decl_stmt|;
name|lua_lock
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|luaC_checkGC
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|t
operator|=
name|luaH_new
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|sethvalue
argument_list|(
name|L
argument_list|,
name|L
operator|->
name|top
argument_list|,
name|t
argument_list|)
expr_stmt|;
name|api_incr_top
argument_list|(
name|L
argument_list|)
expr_stmt|;
if|if
condition|(
name|narray
operator|>
literal|0
operator|||
name|nrec
operator|>
literal|0
condition|)
name|luaH_resize
argument_list|(
name|L
argument_list|,
name|t
argument_list|,
name|narray
argument_list|,
name|nrec
argument_list|)
expr_stmt|;
name|lua_unlock
argument_list|(
name|L
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|LUA_API
name|int
name|lua_getmetatable
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|int
name|objindex
parameter_list|)
block|{
specifier|const
name|TValue
modifier|*
name|obj
decl_stmt|;
name|Table
modifier|*
name|mt
init|=
name|NULL
decl_stmt|;
name|int
name|res
decl_stmt|;
name|lua_lock
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|obj
operator|=
name|index2addr
argument_list|(
name|L
argument_list|,
name|objindex
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ttypenv
argument_list|(
name|obj
argument_list|)
condition|)
block|{
case|case
name|LUA_TTABLE
case|:
name|mt
operator|=
name|hvalue
argument_list|(
name|obj
argument_list|)
operator|->
name|metatable
expr_stmt|;
break|break;
case|case
name|LUA_TUSERDATA
case|:
name|mt
operator|=
name|uvalue
argument_list|(
name|obj
argument_list|)
operator|->
name|metatable
expr_stmt|;
break|break;
default|default:
name|mt
operator|=
name|G
argument_list|(
name|L
argument_list|)
operator|->
name|mt
index|[
name|ttypenv
argument_list|(
name|obj
argument_list|)
index|]
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|mt
operator|==
name|NULL
condition|)
name|res
operator|=
literal|0
expr_stmt|;
else|else
block|{
name|sethvalue
argument_list|(
name|L
argument_list|,
name|L
operator|->
name|top
argument_list|,
name|mt
argument_list|)
expr_stmt|;
name|api_incr_top
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|res
operator|=
literal|1
expr_stmt|;
block|}
name|lua_unlock
argument_list|(
name|L
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_function
name|LUA_API
name|void
name|lua_getuservalue
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|int
name|idx
parameter_list|)
block|{
name|StkId
name|o
decl_stmt|;
name|lua_lock
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|o
operator|=
name|index2addr
argument_list|(
name|L
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|api_check
argument_list|(
name|L
argument_list|,
name|ttisuserdata
argument_list|(
name|o
argument_list|)
argument_list|,
literal|"userdata expected"
argument_list|)
expr_stmt|;
if|if
condition|(
name|uvalue
argument_list|(
name|o
argument_list|)
operator|->
name|env
condition|)
block|{
name|sethvalue
argument_list|(
name|L
argument_list|,
name|L
operator|->
name|top
argument_list|,
name|uvalue
argument_list|(
name|o
argument_list|)
operator|->
name|env
argument_list|)
expr_stmt|;
block|}
else|else
name|setnilvalue
argument_list|(
name|L
operator|->
name|top
argument_list|)
expr_stmt|;
name|api_incr_top
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|lua_unlock
argument_list|(
name|L
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ** set functions (stack -> Lua) */
end_comment

begin_function
name|LUA_API
name|void
name|lua_setglobal
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
specifier|const
name|char
modifier|*
name|var
parameter_list|)
block|{
name|Table
modifier|*
name|reg
init|=
name|hvalue
argument_list|(
operator|&
name|G
argument_list|(
name|L
argument_list|)
operator|->
name|l_registry
argument_list|)
decl_stmt|;
specifier|const
name|TValue
modifier|*
name|gt
decl_stmt|;
comment|/* global table */
name|lua_lock
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|api_checknelems
argument_list|(
name|L
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|gt
operator|=
name|luaH_getint
argument_list|(
name|reg
argument_list|,
name|LUA_RIDX_GLOBALS
argument_list|)
expr_stmt|;
name|setsvalue2s
argument_list|(
name|L
argument_list|,
name|L
operator|->
name|top
operator|++
argument_list|,
name|luaS_new
argument_list|(
name|L
argument_list|,
name|var
argument_list|)
argument_list|)
expr_stmt|;
name|luaV_settable
argument_list|(
name|L
argument_list|,
name|gt
argument_list|,
name|L
operator|->
name|top
operator|-
literal|1
argument_list|,
name|L
operator|->
name|top
operator|-
literal|2
argument_list|)
expr_stmt|;
name|L
operator|->
name|top
operator|-=
literal|2
expr_stmt|;
comment|/* pop value and key */
name|lua_unlock
argument_list|(
name|L
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|LUA_API
name|void
name|lua_settable
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|int
name|idx
parameter_list|)
block|{
name|StkId
name|t
decl_stmt|;
name|lua_lock
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|api_checknelems
argument_list|(
name|L
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|t
operator|=
name|index2addr
argument_list|(
name|L
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|luaV_settable
argument_list|(
name|L
argument_list|,
name|t
argument_list|,
name|L
operator|->
name|top
operator|-
literal|2
argument_list|,
name|L
operator|->
name|top
operator|-
literal|1
argument_list|)
expr_stmt|;
name|L
operator|->
name|top
operator|-=
literal|2
expr_stmt|;
comment|/* pop index and value */
name|lua_unlock
argument_list|(
name|L
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|LUA_API
name|void
name|lua_setfield
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|int
name|idx
parameter_list|,
specifier|const
name|char
modifier|*
name|k
parameter_list|)
block|{
name|StkId
name|t
decl_stmt|;
name|lua_lock
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|api_checknelems
argument_list|(
name|L
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|t
operator|=
name|index2addr
argument_list|(
name|L
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|setsvalue2s
argument_list|(
name|L
argument_list|,
name|L
operator|->
name|top
operator|++
argument_list|,
name|luaS_new
argument_list|(
name|L
argument_list|,
name|k
argument_list|)
argument_list|)
expr_stmt|;
name|luaV_settable
argument_list|(
name|L
argument_list|,
name|t
argument_list|,
name|L
operator|->
name|top
operator|-
literal|1
argument_list|,
name|L
operator|->
name|top
operator|-
literal|2
argument_list|)
expr_stmt|;
name|L
operator|->
name|top
operator|-=
literal|2
expr_stmt|;
comment|/* pop value and key */
name|lua_unlock
argument_list|(
name|L
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|LUA_API
name|void
name|lua_rawset
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|int
name|idx
parameter_list|)
block|{
name|StkId
name|t
decl_stmt|;
name|lua_lock
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|api_checknelems
argument_list|(
name|L
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|t
operator|=
name|index2addr
argument_list|(
name|L
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|api_check
argument_list|(
name|L
argument_list|,
name|ttistable
argument_list|(
name|t
argument_list|)
argument_list|,
literal|"table expected"
argument_list|)
expr_stmt|;
name|setobj2t
argument_list|(
name|L
argument_list|,
name|luaH_set
argument_list|(
name|L
argument_list|,
name|hvalue
argument_list|(
name|t
argument_list|)
argument_list|,
name|L
operator|->
name|top
operator|-
literal|2
argument_list|)
argument_list|,
name|L
operator|->
name|top
operator|-
literal|1
argument_list|)
expr_stmt|;
name|invalidateTMcache
argument_list|(
name|hvalue
argument_list|(
name|t
argument_list|)
argument_list|)
expr_stmt|;
name|luaC_barrierback
argument_list|(
name|L
argument_list|,
name|gcvalue
argument_list|(
name|t
argument_list|)
argument_list|,
name|L
operator|->
name|top
operator|-
literal|1
argument_list|)
expr_stmt|;
name|L
operator|->
name|top
operator|-=
literal|2
expr_stmt|;
name|lua_unlock
argument_list|(
name|L
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|LUA_API
name|void
name|lua_rawseti
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|int
name|idx
parameter_list|,
name|int
name|n
parameter_list|)
block|{
name|StkId
name|t
decl_stmt|;
name|lua_lock
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|api_checknelems
argument_list|(
name|L
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|t
operator|=
name|index2addr
argument_list|(
name|L
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|api_check
argument_list|(
name|L
argument_list|,
name|ttistable
argument_list|(
name|t
argument_list|)
argument_list|,
literal|"table expected"
argument_list|)
expr_stmt|;
name|luaH_setint
argument_list|(
name|L
argument_list|,
name|hvalue
argument_list|(
name|t
argument_list|)
argument_list|,
name|n
argument_list|,
name|L
operator|->
name|top
operator|-
literal|1
argument_list|)
expr_stmt|;
name|luaC_barrierback
argument_list|(
name|L
argument_list|,
name|gcvalue
argument_list|(
name|t
argument_list|)
argument_list|,
name|L
operator|->
name|top
operator|-
literal|1
argument_list|)
expr_stmt|;
name|L
operator|->
name|top
operator|--
expr_stmt|;
name|lua_unlock
argument_list|(
name|L
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|LUA_API
name|void
name|lua_rawsetp
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|int
name|idx
parameter_list|,
specifier|const
name|void
modifier|*
name|p
parameter_list|)
block|{
name|StkId
name|t
decl_stmt|;
name|TValue
name|k
decl_stmt|;
name|lua_lock
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|api_checknelems
argument_list|(
name|L
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|t
operator|=
name|index2addr
argument_list|(
name|L
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|api_check
argument_list|(
name|L
argument_list|,
name|ttistable
argument_list|(
name|t
argument_list|)
argument_list|,
literal|"table expected"
argument_list|)
expr_stmt|;
name|setpvalue
argument_list|(
operator|&
name|k
argument_list|,
name|cast
argument_list|(
name|void
operator|*
argument_list|,
name|p
argument_list|)
argument_list|)
expr_stmt|;
name|setobj2t
argument_list|(
name|L
argument_list|,
name|luaH_set
argument_list|(
name|L
argument_list|,
name|hvalue
argument_list|(
name|t
argument_list|)
argument_list|,
operator|&
name|k
argument_list|)
argument_list|,
name|L
operator|->
name|top
operator|-
literal|1
argument_list|)
expr_stmt|;
name|luaC_barrierback
argument_list|(
name|L
argument_list|,
name|gcvalue
argument_list|(
name|t
argument_list|)
argument_list|,
name|L
operator|->
name|top
operator|-
literal|1
argument_list|)
expr_stmt|;
name|L
operator|->
name|top
operator|--
expr_stmt|;
name|lua_unlock
argument_list|(
name|L
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|LUA_API
name|int
name|lua_setmetatable
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|int
name|objindex
parameter_list|)
block|{
name|TValue
modifier|*
name|obj
decl_stmt|;
name|Table
modifier|*
name|mt
decl_stmt|;
name|lua_lock
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|api_checknelems
argument_list|(
name|L
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|obj
operator|=
name|index2addr
argument_list|(
name|L
argument_list|,
name|objindex
argument_list|)
expr_stmt|;
if|if
condition|(
name|ttisnil
argument_list|(
name|L
operator|->
name|top
operator|-
literal|1
argument_list|)
condition|)
name|mt
operator|=
name|NULL
expr_stmt|;
else|else
block|{
name|api_check
argument_list|(
name|L
argument_list|,
name|ttistable
argument_list|(
name|L
operator|->
name|top
operator|-
literal|1
argument_list|)
argument_list|,
literal|"table expected"
argument_list|)
expr_stmt|;
name|mt
operator|=
name|hvalue
argument_list|(
name|L
operator|->
name|top
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|ttypenv
argument_list|(
name|obj
argument_list|)
condition|)
block|{
case|case
name|LUA_TTABLE
case|:
block|{
name|hvalue
argument_list|(
name|obj
argument_list|)
operator|->
name|metatable
operator|=
name|mt
expr_stmt|;
if|if
condition|(
name|mt
condition|)
block|{
name|luaC_objbarrierback
argument_list|(
name|L
argument_list|,
name|gcvalue
argument_list|(
name|obj
argument_list|)
argument_list|,
name|mt
argument_list|)
expr_stmt|;
name|luaC_checkfinalizer
argument_list|(
name|L
argument_list|,
name|gcvalue
argument_list|(
name|obj
argument_list|)
argument_list|,
name|mt
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
case|case
name|LUA_TUSERDATA
case|:
block|{
name|uvalue
argument_list|(
name|obj
argument_list|)
operator|->
name|metatable
operator|=
name|mt
expr_stmt|;
if|if
condition|(
name|mt
condition|)
block|{
name|luaC_objbarrier
argument_list|(
name|L
argument_list|,
name|rawuvalue
argument_list|(
name|obj
argument_list|)
argument_list|,
name|mt
argument_list|)
expr_stmt|;
name|luaC_checkfinalizer
argument_list|(
name|L
argument_list|,
name|gcvalue
argument_list|(
name|obj
argument_list|)
argument_list|,
name|mt
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
default|default:
block|{
name|G
argument_list|(
name|L
argument_list|)
operator|->
name|mt
index|[
name|ttypenv
argument_list|(
name|obj
argument_list|)
index|]
operator|=
name|mt
expr_stmt|;
break|break;
block|}
block|}
name|L
operator|->
name|top
operator|--
expr_stmt|;
name|lua_unlock
argument_list|(
name|L
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
name|LUA_API
name|void
name|lua_setuservalue
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|int
name|idx
parameter_list|)
block|{
name|StkId
name|o
decl_stmt|;
name|lua_lock
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|api_checknelems
argument_list|(
name|L
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|o
operator|=
name|index2addr
argument_list|(
name|L
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|api_check
argument_list|(
name|L
argument_list|,
name|ttisuserdata
argument_list|(
name|o
argument_list|)
argument_list|,
literal|"userdata expected"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ttisnil
argument_list|(
name|L
operator|->
name|top
operator|-
literal|1
argument_list|)
condition|)
name|uvalue
argument_list|(
name|o
argument_list|)
operator|->
name|env
operator|=
name|NULL
expr_stmt|;
else|else
block|{
name|api_check
argument_list|(
name|L
argument_list|,
name|ttistable
argument_list|(
name|L
operator|->
name|top
operator|-
literal|1
argument_list|)
argument_list|,
literal|"table expected"
argument_list|)
expr_stmt|;
name|uvalue
argument_list|(
name|o
argument_list|)
operator|->
name|env
operator|=
name|hvalue
argument_list|(
name|L
operator|->
name|top
operator|-
literal|1
argument_list|)
expr_stmt|;
name|luaC_objbarrier
argument_list|(
name|L
argument_list|,
name|gcvalue
argument_list|(
name|o
argument_list|)
argument_list|,
name|hvalue
argument_list|(
name|L
operator|->
name|top
operator|-
literal|1
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|L
operator|->
name|top
operator|--
expr_stmt|;
name|lua_unlock
argument_list|(
name|L
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ** `load' and `call' functions (run Lua code) */
end_comment

begin_define
define|#
directive|define
name|checkresults
parameter_list|(
name|L
parameter_list|,
name|na
parameter_list|,
name|nr
parameter_list|)
define|\
value|api_check(L, (nr) == LUA_MULTRET || (L->ci->top - L->top>= (nr) - (na)), \ 	"results from function overflow current stack size")
end_define

begin_function
name|LUA_API
name|int
name|lua_getctx
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|int
modifier|*
name|ctx
parameter_list|)
block|{
if|if
condition|(
name|L
operator|->
name|ci
operator|->
name|callstatus
operator|&
name|CIST_YIELDED
condition|)
block|{
if|if
condition|(
name|ctx
condition|)
operator|*
name|ctx
operator|=
name|L
operator|->
name|ci
operator|->
name|u
operator|.
name|c
operator|.
name|ctx
expr_stmt|;
return|return
name|L
operator|->
name|ci
operator|->
name|u
operator|.
name|c
operator|.
name|status
return|;
block|}
else|else
return|return
name|LUA_OK
return|;
block|}
end_function

begin_function
name|LUA_API
name|void
name|lua_callk
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|int
name|nargs
parameter_list|,
name|int
name|nresults
parameter_list|,
name|int
name|ctx
parameter_list|,
name|lua_CFunction
name|k
parameter_list|)
block|{
name|StkId
name|func
decl_stmt|;
name|lua_lock
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|api_check
argument_list|(
name|L
argument_list|,
name|k
operator|==
name|NULL
operator|||
operator|!
name|isLua
argument_list|(
name|L
operator|->
name|ci
argument_list|)
argument_list|,
literal|"cannot use continuations inside hooks"
argument_list|)
expr_stmt|;
name|api_checknelems
argument_list|(
name|L
argument_list|,
name|nargs
operator|+
literal|1
argument_list|)
expr_stmt|;
name|api_check
argument_list|(
name|L
argument_list|,
name|L
operator|->
name|status
operator|==
name|LUA_OK
argument_list|,
literal|"cannot do calls on non-normal thread"
argument_list|)
expr_stmt|;
name|checkresults
argument_list|(
name|L
argument_list|,
name|nargs
argument_list|,
name|nresults
argument_list|)
expr_stmt|;
name|func
operator|=
name|L
operator|->
name|top
operator|-
operator|(
name|nargs
operator|+
literal|1
operator|)
expr_stmt|;
if|if
condition|(
name|k
operator|!=
name|NULL
operator|&&
name|L
operator|->
name|nny
operator|==
literal|0
condition|)
block|{
comment|/* need to prepare continuation? */
name|L
operator|->
name|ci
operator|->
name|u
operator|.
name|c
operator|.
name|k
operator|=
name|k
expr_stmt|;
comment|/* save continuation */
name|L
operator|->
name|ci
operator|->
name|u
operator|.
name|c
operator|.
name|ctx
operator|=
name|ctx
expr_stmt|;
comment|/* save context */
name|luaD_call
argument_list|(
name|L
argument_list|,
name|func
argument_list|,
name|nresults
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* do the call */
block|}
else|else
comment|/* no continuation or no yieldable */
name|luaD_call
argument_list|(
name|L
argument_list|,
name|func
argument_list|,
name|nresults
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* just do the call */
name|adjustresults
argument_list|(
name|L
argument_list|,
name|nresults
argument_list|)
expr_stmt|;
name|lua_unlock
argument_list|(
name|L
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ** Execute a protected call. */
end_comment

begin_struct
struct|struct
name|CallS
block|{
comment|/* data to `f_call' */
name|StkId
name|func
decl_stmt|;
name|int
name|nresults
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
name|f_call
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|void
modifier|*
name|ud
parameter_list|)
block|{
name|struct
name|CallS
modifier|*
name|c
init|=
name|cast
argument_list|(
expr|struct
name|CallS
operator|*
argument_list|,
name|ud
argument_list|)
decl_stmt|;
name|luaD_call
argument_list|(
name|L
argument_list|,
name|c
operator|->
name|func
argument_list|,
name|c
operator|->
name|nresults
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|LUA_API
name|int
name|lua_pcallk
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|int
name|nargs
parameter_list|,
name|int
name|nresults
parameter_list|,
name|int
name|errfunc
parameter_list|,
name|int
name|ctx
parameter_list|,
name|lua_CFunction
name|k
parameter_list|)
block|{
name|struct
name|CallS
name|c
decl_stmt|;
name|int
name|status
decl_stmt|;
name|ptrdiff_t
name|func
decl_stmt|;
name|lua_lock
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|api_check
argument_list|(
name|L
argument_list|,
name|k
operator|==
name|NULL
operator|||
operator|!
name|isLua
argument_list|(
name|L
operator|->
name|ci
argument_list|)
argument_list|,
literal|"cannot use continuations inside hooks"
argument_list|)
expr_stmt|;
name|api_checknelems
argument_list|(
name|L
argument_list|,
name|nargs
operator|+
literal|1
argument_list|)
expr_stmt|;
name|api_check
argument_list|(
name|L
argument_list|,
name|L
operator|->
name|status
operator|==
name|LUA_OK
argument_list|,
literal|"cannot do calls on non-normal thread"
argument_list|)
expr_stmt|;
name|checkresults
argument_list|(
name|L
argument_list|,
name|nargs
argument_list|,
name|nresults
argument_list|)
expr_stmt|;
if|if
condition|(
name|errfunc
operator|==
literal|0
condition|)
name|func
operator|=
literal|0
expr_stmt|;
else|else
block|{
name|StkId
name|o
init|=
name|index2addr
argument_list|(
name|L
argument_list|,
name|errfunc
argument_list|)
decl_stmt|;
name|api_checkstackindex
argument_list|(
name|L
argument_list|,
name|errfunc
argument_list|,
name|o
argument_list|)
expr_stmt|;
name|func
operator|=
name|savestack
argument_list|(
name|L
argument_list|,
name|o
argument_list|)
expr_stmt|;
block|}
name|c
operator|.
name|func
operator|=
name|L
operator|->
name|top
operator|-
operator|(
name|nargs
operator|+
literal|1
operator|)
expr_stmt|;
comment|/* function to be called */
if|if
condition|(
name|k
operator|==
name|NULL
operator|||
name|L
operator|->
name|nny
operator|>
literal|0
condition|)
block|{
comment|/* no continuation or no yieldable? */
name|c
operator|.
name|nresults
operator|=
name|nresults
expr_stmt|;
comment|/* do a 'conventional' protected call */
name|status
operator|=
name|luaD_pcall
argument_list|(
name|L
argument_list|,
name|f_call
argument_list|,
operator|&
name|c
argument_list|,
name|savestack
argument_list|(
name|L
argument_list|,
name|c
operator|.
name|func
argument_list|)
argument_list|,
name|func
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* prepare continuation (call is already protected by 'resume') */
name|CallInfo
modifier|*
name|ci
init|=
name|L
operator|->
name|ci
decl_stmt|;
name|ci
operator|->
name|u
operator|.
name|c
operator|.
name|k
operator|=
name|k
expr_stmt|;
comment|/* save continuation */
name|ci
operator|->
name|u
operator|.
name|c
operator|.
name|ctx
operator|=
name|ctx
expr_stmt|;
comment|/* save context */
comment|/* save information for error recovery */
name|ci
operator|->
name|extra
operator|=
name|savestack
argument_list|(
name|L
argument_list|,
name|c
operator|.
name|func
argument_list|)
expr_stmt|;
name|ci
operator|->
name|u
operator|.
name|c
operator|.
name|old_allowhook
operator|=
name|L
operator|->
name|allowhook
expr_stmt|;
name|ci
operator|->
name|u
operator|.
name|c
operator|.
name|old_errfunc
operator|=
name|L
operator|->
name|errfunc
expr_stmt|;
name|L
operator|->
name|errfunc
operator|=
name|func
expr_stmt|;
comment|/* mark that function may do error recovery */
name|ci
operator|->
name|callstatus
operator||=
name|CIST_YPCALL
expr_stmt|;
name|luaD_call
argument_list|(
name|L
argument_list|,
name|c
operator|.
name|func
argument_list|,
name|nresults
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* do the call */
name|ci
operator|->
name|callstatus
operator|&=
operator|~
name|CIST_YPCALL
expr_stmt|;
name|L
operator|->
name|errfunc
operator|=
name|ci
operator|->
name|u
operator|.
name|c
operator|.
name|old_errfunc
expr_stmt|;
name|status
operator|=
name|LUA_OK
expr_stmt|;
comment|/* if it is here, there were no errors */
block|}
name|adjustresults
argument_list|(
name|L
argument_list|,
name|nresults
argument_list|)
expr_stmt|;
name|lua_unlock
argument_list|(
name|L
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
name|LUA_API
name|int
name|lua_load
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|lua_Reader
name|reader
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
specifier|const
name|char
modifier|*
name|chunkname
parameter_list|,
specifier|const
name|char
modifier|*
name|mode
parameter_list|)
block|{
name|ZIO
name|z
decl_stmt|;
name|int
name|status
decl_stmt|;
name|lua_lock
argument_list|(
name|L
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|chunkname
condition|)
name|chunkname
operator|=
literal|"?"
expr_stmt|;
name|luaZ_init
argument_list|(
name|L
argument_list|,
operator|&
name|z
argument_list|,
name|reader
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|status
operator|=
name|luaD_protectedparser
argument_list|(
name|L
argument_list|,
operator|&
name|z
argument_list|,
name|chunkname
argument_list|,
name|mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|LUA_OK
condition|)
block|{
comment|/* no errors? */
name|LClosure
modifier|*
name|f
init|=
name|clLvalue
argument_list|(
name|L
operator|->
name|top
operator|-
literal|1
argument_list|)
decl_stmt|;
comment|/* get newly created function */
if|if
condition|(
name|f
operator|->
name|nupvalues
operator|==
literal|1
condition|)
block|{
comment|/* does it have one upvalue? */
comment|/* get global table from registry */
name|Table
modifier|*
name|reg
init|=
name|hvalue
argument_list|(
operator|&
name|G
argument_list|(
name|L
argument_list|)
operator|->
name|l_registry
argument_list|)
decl_stmt|;
specifier|const
name|TValue
modifier|*
name|gt
init|=
name|luaH_getint
argument_list|(
name|reg
argument_list|,
name|LUA_RIDX_GLOBALS
argument_list|)
decl_stmt|;
comment|/* set global table as 1st upvalue of 'f' (may be LUA_ENV) */
name|setobj
argument_list|(
name|L
argument_list|,
name|f
operator|->
name|upvals
index|[
literal|0
index|]
operator|->
name|v
argument_list|,
name|gt
argument_list|)
expr_stmt|;
name|luaC_barrier
argument_list|(
name|L
argument_list|,
name|f
operator|->
name|upvals
index|[
literal|0
index|]
argument_list|,
name|gt
argument_list|)
expr_stmt|;
block|}
block|}
name|lua_unlock
argument_list|(
name|L
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
name|LUA_API
name|int
name|lua_dump
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|lua_Writer
name|writer
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|int
name|status
decl_stmt|;
name|TValue
modifier|*
name|o
decl_stmt|;
name|lua_lock
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|api_checknelems
argument_list|(
name|L
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|o
operator|=
name|L
operator|->
name|top
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|isLfunction
argument_list|(
name|o
argument_list|)
condition|)
name|status
operator|=
name|luaU_dump
argument_list|(
name|L
argument_list|,
name|getproto
argument_list|(
name|o
argument_list|)
argument_list|,
name|writer
argument_list|,
name|data
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
name|status
operator|=
literal|1
expr_stmt|;
name|lua_unlock
argument_list|(
name|L
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
name|LUA_API
name|int
name|lua_status
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|)
block|{
return|return
name|L
operator|->
name|status
return|;
block|}
end_function

begin_comment
comment|/* ** Garbage-collection function */
end_comment

begin_function
name|LUA_API
name|int
name|lua_gc
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|int
name|what
parameter_list|,
name|int
name|data
parameter_list|)
block|{
name|int
name|res
init|=
literal|0
decl_stmt|;
name|global_State
modifier|*
name|g
decl_stmt|;
name|lua_lock
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|g
operator|=
name|G
argument_list|(
name|L
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|what
condition|)
block|{
case|case
name|LUA_GCSTOP
case|:
block|{
name|g
operator|->
name|gcrunning
operator|=
literal|0
expr_stmt|;
break|break;
block|}
case|case
name|LUA_GCRESTART
case|:
block|{
name|luaE_setdebt
argument_list|(
name|g
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|g
operator|->
name|gcrunning
operator|=
literal|1
expr_stmt|;
break|break;
block|}
case|case
name|LUA_GCCOLLECT
case|:
block|{
name|luaC_fullgc
argument_list|(
name|L
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|LUA_GCCOUNT
case|:
block|{
comment|/* GC values are expressed in Kbytes: #bytes/2^10 */
name|res
operator|=
name|cast_int
argument_list|(
name|gettotalbytes
argument_list|(
name|g
argument_list|)
operator|>>
literal|10
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|LUA_GCCOUNTB
case|:
block|{
name|res
operator|=
name|cast_int
argument_list|(
name|gettotalbytes
argument_list|(
name|g
argument_list|)
operator|&
literal|0x3ff
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|LUA_GCSTEP
case|:
block|{
if|if
condition|(
name|g
operator|->
name|gckind
operator|==
name|KGC_GEN
condition|)
block|{
comment|/* generational mode? */
name|res
operator|=
operator|(
name|g
operator|->
name|GCestimate
operator|==
literal|0
operator|)
expr_stmt|;
comment|/* true if it will do major collection */
name|luaC_forcestep
argument_list|(
name|L
argument_list|)
expr_stmt|;
comment|/* do a single step */
block|}
else|else
block|{
name|lu_mem
name|debt
init|=
name|cast
argument_list|(
name|lu_mem
argument_list|,
name|data
argument_list|)
operator|*
literal|1024
operator|-
name|GCSTEPSIZE
decl_stmt|;
if|if
condition|(
name|g
operator|->
name|gcrunning
condition|)
name|debt
operator|+=
name|g
operator|->
name|GCdebt
expr_stmt|;
comment|/* include current debt */
name|luaE_setdebt
argument_list|(
name|g
argument_list|,
name|debt
argument_list|)
expr_stmt|;
name|luaC_forcestep
argument_list|(
name|L
argument_list|)
expr_stmt|;
if|if
condition|(
name|g
operator|->
name|gcstate
operator|==
name|GCSpause
condition|)
comment|/* end of cycle? */
name|res
operator|=
literal|1
expr_stmt|;
comment|/* signal it */
block|}
break|break;
block|}
case|case
name|LUA_GCSETPAUSE
case|:
block|{
name|res
operator|=
name|g
operator|->
name|gcpause
expr_stmt|;
name|g
operator|->
name|gcpause
operator|=
name|data
expr_stmt|;
break|break;
block|}
case|case
name|LUA_GCSETMAJORINC
case|:
block|{
name|res
operator|=
name|g
operator|->
name|gcmajorinc
expr_stmt|;
name|g
operator|->
name|gcmajorinc
operator|=
name|data
expr_stmt|;
break|break;
block|}
case|case
name|LUA_GCSETSTEPMUL
case|:
block|{
name|res
operator|=
name|g
operator|->
name|gcstepmul
expr_stmt|;
name|g
operator|->
name|gcstepmul
operator|=
name|data
expr_stmt|;
break|break;
block|}
case|case
name|LUA_GCISRUNNING
case|:
block|{
name|res
operator|=
name|g
operator|->
name|gcrunning
expr_stmt|;
break|break;
block|}
case|case
name|LUA_GCGEN
case|:
block|{
comment|/* change collector to generational mode */
name|luaC_changemode
argument_list|(
name|L
argument_list|,
name|KGC_GEN
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|LUA_GCINC
case|:
block|{
comment|/* change collector to incremental mode */
name|luaC_changemode
argument_list|(
name|L
argument_list|,
name|KGC_NORMAL
argument_list|)
expr_stmt|;
break|break;
block|}
default|default:
name|res
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* invalid option */
block|}
name|lua_unlock
argument_list|(
name|L
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_comment
comment|/* ** miscellaneous functions */
end_comment

begin_function
name|LUA_API
name|int
name|lua_error
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|)
block|{
name|lua_lock
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|api_checknelems
argument_list|(
name|L
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|luaG_errormsg
argument_list|(
name|L
argument_list|)
expr_stmt|;
comment|/* code unreachable; will unlock when control actually leaves the kernel */
return|return
literal|0
return|;
comment|/* to avoid warnings */
block|}
end_function

begin_function
name|LUA_API
name|int
name|lua_next
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|int
name|idx
parameter_list|)
block|{
name|StkId
name|t
decl_stmt|;
name|int
name|more
decl_stmt|;
name|lua_lock
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|t
operator|=
name|index2addr
argument_list|(
name|L
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|api_check
argument_list|(
name|L
argument_list|,
name|ttistable
argument_list|(
name|t
argument_list|)
argument_list|,
literal|"table expected"
argument_list|)
expr_stmt|;
name|more
operator|=
name|luaH_next
argument_list|(
name|L
argument_list|,
name|hvalue
argument_list|(
name|t
argument_list|)
argument_list|,
name|L
operator|->
name|top
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|more
condition|)
block|{
name|api_incr_top
argument_list|(
name|L
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* no more elements */
name|L
operator|->
name|top
operator|-=
literal|1
expr_stmt|;
comment|/* remove key */
name|lua_unlock
argument_list|(
name|L
argument_list|)
expr_stmt|;
return|return
name|more
return|;
block|}
end_function

begin_function
name|LUA_API
name|void
name|lua_concat
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|int
name|n
parameter_list|)
block|{
name|lua_lock
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|api_checknelems
argument_list|(
name|L
argument_list|,
name|n
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|>=
literal|2
condition|)
block|{
name|luaC_checkGC
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|luaV_concat
argument_list|(
name|L
argument_list|,
name|n
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|n
operator|==
literal|0
condition|)
block|{
comment|/* push empty string */
name|setsvalue2s
argument_list|(
name|L
argument_list|,
name|L
operator|->
name|top
argument_list|,
name|luaS_newlstr
argument_list|(
name|L
argument_list|,
literal|""
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|api_incr_top
argument_list|(
name|L
argument_list|)
expr_stmt|;
block|}
comment|/* else n == 1; nothing to do */
name|lua_unlock
argument_list|(
name|L
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|LUA_API
name|void
name|lua_len
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|int
name|idx
parameter_list|)
block|{
name|StkId
name|t
decl_stmt|;
name|lua_lock
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|t
operator|=
name|index2addr
argument_list|(
name|L
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|luaV_objlen
argument_list|(
name|L
argument_list|,
name|L
operator|->
name|top
argument_list|,
name|t
argument_list|)
expr_stmt|;
name|api_incr_top
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|lua_unlock
argument_list|(
name|L
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|LUA_API
name|lua_Alloc
name|lua_getallocf
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|void
modifier|*
modifier|*
name|ud
parameter_list|)
block|{
name|lua_Alloc
name|f
decl_stmt|;
name|lua_lock
argument_list|(
name|L
argument_list|)
expr_stmt|;
if|if
condition|(
name|ud
condition|)
operator|*
name|ud
operator|=
name|G
argument_list|(
name|L
argument_list|)
operator|->
name|ud
expr_stmt|;
name|f
operator|=
name|G
argument_list|(
name|L
argument_list|)
operator|->
name|frealloc
expr_stmt|;
name|lua_unlock
argument_list|(
name|L
argument_list|)
expr_stmt|;
return|return
name|f
return|;
block|}
end_function

begin_function
name|LUA_API
name|void
name|lua_setallocf
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|lua_Alloc
name|f
parameter_list|,
name|void
modifier|*
name|ud
parameter_list|)
block|{
name|lua_lock
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|G
argument_list|(
name|L
argument_list|)
operator|->
name|ud
operator|=
name|ud
expr_stmt|;
name|G
argument_list|(
name|L
argument_list|)
operator|->
name|frealloc
operator|=
name|f
expr_stmt|;
name|lua_unlock
argument_list|(
name|L
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|LUA_API
name|void
modifier|*
name|lua_newuserdata
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
name|Udata
modifier|*
name|u
decl_stmt|;
name|lua_lock
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|luaC_checkGC
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|u
operator|=
name|luaS_newudata
argument_list|(
name|L
argument_list|,
name|size
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|setuvalue
argument_list|(
name|L
argument_list|,
name|L
operator|->
name|top
argument_list|,
name|u
argument_list|)
expr_stmt|;
name|api_incr_top
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|lua_unlock
argument_list|(
name|L
argument_list|)
expr_stmt|;
return|return
name|u
operator|+
literal|1
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|aux_upvalue
parameter_list|(
name|StkId
name|fi
parameter_list|,
name|int
name|n
parameter_list|,
name|TValue
modifier|*
modifier|*
name|val
parameter_list|,
name|GCObject
modifier|*
modifier|*
name|owner
parameter_list|)
block|{
switch|switch
condition|(
name|ttype
argument_list|(
name|fi
argument_list|)
condition|)
block|{
case|case
name|LUA_TCCL
case|:
block|{
comment|/* C closure */
name|CClosure
modifier|*
name|f
init|=
name|clCvalue
argument_list|(
name|fi
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
operator|(
literal|1
operator|<=
name|n
operator|&&
name|n
operator|<=
name|f
operator|->
name|nupvalues
operator|)
condition|)
return|return
name|NULL
return|;
operator|*
name|val
operator|=
operator|&
name|f
operator|->
name|upvalue
index|[
name|n
operator|-
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|owner
condition|)
operator|*
name|owner
operator|=
name|obj2gco
argument_list|(
name|f
argument_list|)
expr_stmt|;
return|return
literal|""
return|;
block|}
case|case
name|LUA_TLCL
case|:
block|{
comment|/* Lua closure */
name|LClosure
modifier|*
name|f
init|=
name|clLvalue
argument_list|(
name|fi
argument_list|)
decl_stmt|;
name|TString
modifier|*
name|name
decl_stmt|;
name|Proto
modifier|*
name|p
init|=
name|f
operator|->
name|p
decl_stmt|;
if|if
condition|(
operator|!
operator|(
literal|1
operator|<=
name|n
operator|&&
name|n
operator|<=
name|p
operator|->
name|sizeupvalues
operator|)
condition|)
return|return
name|NULL
return|;
operator|*
name|val
operator|=
name|f
operator|->
name|upvals
index|[
name|n
operator|-
literal|1
index|]
operator|->
name|v
expr_stmt|;
if|if
condition|(
name|owner
condition|)
operator|*
name|owner
operator|=
name|obj2gco
argument_list|(
name|f
operator|->
name|upvals
index|[
name|n
operator|-
literal|1
index|]
argument_list|)
expr_stmt|;
name|name
operator|=
name|p
operator|->
name|upvalues
index|[
name|n
operator|-
literal|1
index|]
operator|.
name|name
expr_stmt|;
return|return
operator|(
name|name
operator|==
name|NULL
operator|)
condition|?
literal|""
else|:
name|getstr
argument_list|(
name|name
argument_list|)
return|;
block|}
default|default:
return|return
name|NULL
return|;
comment|/* not a closure */
block|}
block|}
end_function

begin_function
name|LUA_API
specifier|const
name|char
modifier|*
name|lua_getupvalue
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|int
name|funcindex
parameter_list|,
name|int
name|n
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|TValue
modifier|*
name|val
init|=
name|NULL
decl_stmt|;
comment|/* to avoid warnings */
name|lua_lock
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|name
operator|=
name|aux_upvalue
argument_list|(
name|index2addr
argument_list|(
name|L
argument_list|,
name|funcindex
argument_list|)
argument_list|,
name|n
argument_list|,
operator|&
name|val
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|name
condition|)
block|{
name|setobj2s
argument_list|(
name|L
argument_list|,
name|L
operator|->
name|top
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|api_incr_top
argument_list|(
name|L
argument_list|)
expr_stmt|;
block|}
name|lua_unlock
argument_list|(
name|L
argument_list|)
expr_stmt|;
return|return
name|name
return|;
block|}
end_function

begin_function
name|LUA_API
specifier|const
name|char
modifier|*
name|lua_setupvalue
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|int
name|funcindex
parameter_list|,
name|int
name|n
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|TValue
modifier|*
name|val
init|=
name|NULL
decl_stmt|;
comment|/* to avoid warnings */
name|GCObject
modifier|*
name|owner
init|=
name|NULL
decl_stmt|;
comment|/* to avoid warnings */
name|StkId
name|fi
decl_stmt|;
name|lua_lock
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|fi
operator|=
name|index2addr
argument_list|(
name|L
argument_list|,
name|funcindex
argument_list|)
expr_stmt|;
name|api_checknelems
argument_list|(
name|L
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|name
operator|=
name|aux_upvalue
argument_list|(
name|fi
argument_list|,
name|n
argument_list|,
operator|&
name|val
argument_list|,
operator|&
name|owner
argument_list|)
expr_stmt|;
if|if
condition|(
name|name
condition|)
block|{
name|L
operator|->
name|top
operator|--
expr_stmt|;
name|setobj
argument_list|(
name|L
argument_list|,
name|val
argument_list|,
name|L
operator|->
name|top
argument_list|)
expr_stmt|;
name|luaC_barrier
argument_list|(
name|L
argument_list|,
name|owner
argument_list|,
name|L
operator|->
name|top
argument_list|)
expr_stmt|;
block|}
name|lua_unlock
argument_list|(
name|L
argument_list|)
expr_stmt|;
return|return
name|name
return|;
block|}
end_function

begin_function
specifier|static
name|UpVal
modifier|*
modifier|*
name|getupvalref
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|int
name|fidx
parameter_list|,
name|int
name|n
parameter_list|,
name|LClosure
modifier|*
modifier|*
name|pf
parameter_list|)
block|{
name|LClosure
modifier|*
name|f
decl_stmt|;
name|StkId
name|fi
init|=
name|index2addr
argument_list|(
name|L
argument_list|,
name|fidx
argument_list|)
decl_stmt|;
name|api_check
argument_list|(
name|L
argument_list|,
name|ttisLclosure
argument_list|(
name|fi
argument_list|)
argument_list|,
literal|"Lua function expected"
argument_list|)
expr_stmt|;
name|f
operator|=
name|clLvalue
argument_list|(
name|fi
argument_list|)
expr_stmt|;
name|api_check
argument_list|(
name|L
argument_list|,
operator|(
literal|1
operator|<=
name|n
operator|&&
name|n
operator|<=
name|f
operator|->
name|p
operator|->
name|sizeupvalues
operator|)
argument_list|,
literal|"invalid upvalue index"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pf
condition|)
operator|*
name|pf
operator|=
name|f
expr_stmt|;
return|return
operator|&
name|f
operator|->
name|upvals
index|[
name|n
operator|-
literal|1
index|]
return|;
comment|/* get its upvalue pointer */
block|}
end_function

begin_function
name|LUA_API
name|void
modifier|*
name|lua_upvalueid
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|int
name|fidx
parameter_list|,
name|int
name|n
parameter_list|)
block|{
name|StkId
name|fi
init|=
name|index2addr
argument_list|(
name|L
argument_list|,
name|fidx
argument_list|)
decl_stmt|;
switch|switch
condition|(
name|ttype
argument_list|(
name|fi
argument_list|)
condition|)
block|{
case|case
name|LUA_TLCL
case|:
block|{
comment|/* lua closure */
return|return
operator|*
name|getupvalref
argument_list|(
name|L
argument_list|,
name|fidx
argument_list|,
name|n
argument_list|,
name|NULL
argument_list|)
return|;
block|}
case|case
name|LUA_TCCL
case|:
block|{
comment|/* C closure */
name|CClosure
modifier|*
name|f
init|=
name|clCvalue
argument_list|(
name|fi
argument_list|)
decl_stmt|;
name|api_check
argument_list|(
name|L
argument_list|,
literal|1
operator|<=
name|n
operator|&&
name|n
operator|<=
name|f
operator|->
name|nupvalues
argument_list|,
literal|"invalid upvalue index"
argument_list|)
expr_stmt|;
return|return
operator|&
name|f
operator|->
name|upvalue
index|[
name|n
operator|-
literal|1
index|]
return|;
block|}
default|default:
block|{
name|api_check
argument_list|(
name|L
argument_list|,
literal|0
argument_list|,
literal|"closure expected"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
block|}
end_function

begin_function
name|LUA_API
name|void
name|lua_upvaluejoin
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|int
name|fidx1
parameter_list|,
name|int
name|n1
parameter_list|,
name|int
name|fidx2
parameter_list|,
name|int
name|n2
parameter_list|)
block|{
name|LClosure
modifier|*
name|f1
decl_stmt|;
name|UpVal
modifier|*
modifier|*
name|up1
init|=
name|getupvalref
argument_list|(
name|L
argument_list|,
name|fidx1
argument_list|,
name|n1
argument_list|,
operator|&
name|f1
argument_list|)
decl_stmt|;
name|UpVal
modifier|*
modifier|*
name|up2
init|=
name|getupvalref
argument_list|(
name|L
argument_list|,
name|fidx2
argument_list|,
name|n2
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
operator|*
name|up1
operator|=
operator|*
name|up2
expr_stmt|;
name|luaC_objbarrier
argument_list|(
name|L
argument_list|,
name|f1
argument_list|,
operator|*
name|up2
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


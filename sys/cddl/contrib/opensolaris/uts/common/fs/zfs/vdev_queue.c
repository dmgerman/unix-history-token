begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * CDDL HEADER START  *  * The contents of this file are subject to the terms of the  * Common Development and Distribution License (the "License").  * You may not use this file except in compliance with the License.  *  * You can obtain a copy of the license at usr/src/OPENSOLARIS.LICENSE  * or http://www.opensolaris.org/os/licensing.  * See the License for the specific language governing permissions  * and limitations under the License.  *  * When distributing Covered Code, include this CDDL HEADER in each  * file and include the License file at usr/src/OPENSOLARIS.LICENSE.  * If applicable, add the following below this CDDL HEADER, with the  * fields enclosed by brackets "[]" replaced with your own identifying  * information: Portions Copyright [yyyy] [name of copyright owner]  *  * CDDL HEADER END  */
end_comment

begin_comment
comment|/*  * Copyright 2007 Sun Microsystems, Inc.  All rights reserved.  * Use is subject to license terms.  */
end_comment

begin_pragma
pragma|#
directive|pragma
name|ident
literal|"%Z%%M%	%I%	%E% SMI"
end_pragma

begin_include
include|#
directive|include
file|<sys/zfs_context.h>
end_include

begin_include
include|#
directive|include
file|<sys/spa.h>
end_include

begin_include
include|#
directive|include
file|<sys/vdev_impl.h>
end_include

begin_include
include|#
directive|include
file|<sys/zio.h>
end_include

begin_include
include|#
directive|include
file|<sys/avl.h>
end_include

begin_comment
comment|/*  * These tunables are for performance analysis.  */
end_comment

begin_comment
comment|/*  * zfs_vdev_max_pending is the maximum number of i/os concurrently  * pending to each device.  zfs_vdev_min_pending is the initial number  * of i/os pending to each device (before it starts ramping up to  * max_pending).  */
end_comment

begin_decl_stmt
name|int
name|zfs_vdev_max_pending
init|=
literal|35
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|zfs_vdev_min_pending
init|=
literal|4
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* deadline = pri + (lbolt>> time_shift) */
end_comment

begin_decl_stmt
name|int
name|zfs_vdev_time_shift
init|=
literal|6
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* exponential I/O issue ramp-up rate */
end_comment

begin_decl_stmt
name|int
name|zfs_vdev_ramp_rate
init|=
literal|2
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * i/os will be aggregated into a single large i/o up to  * zfs_vdev_aggregation_limit bytes long.  */
end_comment

begin_decl_stmt
name|int
name|zfs_vdev_aggregation_limit
init|=
name|SPA_MAXBLOCKSIZE
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Virtual device vector for disk I/O scheduling.  */
end_comment

begin_function
name|int
name|vdev_queue_deadline_compare
parameter_list|(
specifier|const
name|void
modifier|*
name|x1
parameter_list|,
specifier|const
name|void
modifier|*
name|x2
parameter_list|)
block|{
specifier|const
name|zio_t
modifier|*
name|z1
init|=
name|x1
decl_stmt|;
specifier|const
name|zio_t
modifier|*
name|z2
init|=
name|x2
decl_stmt|;
if|if
condition|(
name|z1
operator|->
name|io_deadline
operator|<
name|z2
operator|->
name|io_deadline
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|z1
operator|->
name|io_deadline
operator|>
name|z2
operator|->
name|io_deadline
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
name|z1
operator|->
name|io_offset
operator|<
name|z2
operator|->
name|io_offset
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|z1
operator|->
name|io_offset
operator|>
name|z2
operator|->
name|io_offset
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
name|z1
operator|<
name|z2
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|z1
operator|>
name|z2
condition|)
return|return
operator|(
literal|1
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|vdev_queue_offset_compare
parameter_list|(
specifier|const
name|void
modifier|*
name|x1
parameter_list|,
specifier|const
name|void
modifier|*
name|x2
parameter_list|)
block|{
specifier|const
name|zio_t
modifier|*
name|z1
init|=
name|x1
decl_stmt|;
specifier|const
name|zio_t
modifier|*
name|z2
init|=
name|x2
decl_stmt|;
if|if
condition|(
name|z1
operator|->
name|io_offset
operator|<
name|z2
operator|->
name|io_offset
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|z1
operator|->
name|io_offset
operator|>
name|z2
operator|->
name|io_offset
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
name|z1
operator|<
name|z2
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|z1
operator|>
name|z2
condition|)
return|return
operator|(
literal|1
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|void
name|vdev_queue_init
parameter_list|(
name|vdev_t
modifier|*
name|vd
parameter_list|)
block|{
name|vdev_queue_t
modifier|*
name|vq
init|=
operator|&
name|vd
operator|->
name|vdev_queue
decl_stmt|;
name|mutex_init
argument_list|(
operator|&
name|vq
operator|->
name|vq_lock
argument_list|,
name|NULL
argument_list|,
name|MUTEX_DEFAULT
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|avl_create
argument_list|(
operator|&
name|vq
operator|->
name|vq_deadline_tree
argument_list|,
name|vdev_queue_deadline_compare
argument_list|,
sizeof|sizeof
argument_list|(
name|zio_t
argument_list|)
argument_list|,
name|offsetof
argument_list|(
expr|struct
name|zio
argument_list|,
name|io_deadline_node
argument_list|)
argument_list|)
expr_stmt|;
name|avl_create
argument_list|(
operator|&
name|vq
operator|->
name|vq_read_tree
argument_list|,
name|vdev_queue_offset_compare
argument_list|,
sizeof|sizeof
argument_list|(
name|zio_t
argument_list|)
argument_list|,
name|offsetof
argument_list|(
expr|struct
name|zio
argument_list|,
name|io_offset_node
argument_list|)
argument_list|)
expr_stmt|;
name|avl_create
argument_list|(
operator|&
name|vq
operator|->
name|vq_write_tree
argument_list|,
name|vdev_queue_offset_compare
argument_list|,
sizeof|sizeof
argument_list|(
name|zio_t
argument_list|)
argument_list|,
name|offsetof
argument_list|(
expr|struct
name|zio
argument_list|,
name|io_offset_node
argument_list|)
argument_list|)
expr_stmt|;
name|avl_create
argument_list|(
operator|&
name|vq
operator|->
name|vq_pending_tree
argument_list|,
name|vdev_queue_offset_compare
argument_list|,
sizeof|sizeof
argument_list|(
name|zio_t
argument_list|)
argument_list|,
name|offsetof
argument_list|(
expr|struct
name|zio
argument_list|,
name|io_offset_node
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|vdev_queue_fini
parameter_list|(
name|vdev_t
modifier|*
name|vd
parameter_list|)
block|{
name|vdev_queue_t
modifier|*
name|vq
init|=
operator|&
name|vd
operator|->
name|vdev_queue
decl_stmt|;
name|avl_destroy
argument_list|(
operator|&
name|vq
operator|->
name|vq_deadline_tree
argument_list|)
expr_stmt|;
name|avl_destroy
argument_list|(
operator|&
name|vq
operator|->
name|vq_read_tree
argument_list|)
expr_stmt|;
name|avl_destroy
argument_list|(
operator|&
name|vq
operator|->
name|vq_write_tree
argument_list|)
expr_stmt|;
name|avl_destroy
argument_list|(
operator|&
name|vq
operator|->
name|vq_pending_tree
argument_list|)
expr_stmt|;
name|mutex_destroy
argument_list|(
operator|&
name|vq
operator|->
name|vq_lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vdev_queue_io_add
parameter_list|(
name|vdev_queue_t
modifier|*
name|vq
parameter_list|,
name|zio_t
modifier|*
name|zio
parameter_list|)
block|{
name|avl_add
argument_list|(
operator|&
name|vq
operator|->
name|vq_deadline_tree
argument_list|,
name|zio
argument_list|)
expr_stmt|;
name|avl_add
argument_list|(
name|zio
operator|->
name|io_vdev_tree
argument_list|,
name|zio
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vdev_queue_io_remove
parameter_list|(
name|vdev_queue_t
modifier|*
name|vq
parameter_list|,
name|zio_t
modifier|*
name|zio
parameter_list|)
block|{
name|avl_remove
argument_list|(
operator|&
name|vq
operator|->
name|vq_deadline_tree
argument_list|,
name|zio
argument_list|)
expr_stmt|;
name|avl_remove
argument_list|(
name|zio
operator|->
name|io_vdev_tree
argument_list|,
name|zio
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vdev_queue_agg_io_done
parameter_list|(
name|zio_t
modifier|*
name|aio
parameter_list|)
block|{
name|zio_t
modifier|*
name|dio
decl_stmt|;
name|uint64_t
name|offset
init|=
literal|0
decl_stmt|;
while|while
condition|(
operator|(
name|dio
operator|=
name|aio
operator|->
name|io_delegate_list
operator|)
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|aio
operator|->
name|io_type
operator|==
name|ZIO_TYPE_READ
condition|)
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|aio
operator|->
name|io_data
operator|+
name|offset
argument_list|,
name|dio
operator|->
name|io_data
argument_list|,
name|dio
operator|->
name|io_size
argument_list|)
expr_stmt|;
name|offset
operator|+=
name|dio
operator|->
name|io_size
expr_stmt|;
name|aio
operator|->
name|io_delegate_list
operator|=
name|dio
operator|->
name|io_delegate_next
expr_stmt|;
name|dio
operator|->
name|io_delegate_next
operator|=
name|NULL
expr_stmt|;
name|dio
operator|->
name|io_error
operator|=
name|aio
operator|->
name|io_error
expr_stmt|;
name|zio_next_stage
argument_list|(
name|dio
argument_list|)
expr_stmt|;
block|}
name|ASSERT3U
argument_list|(
name|offset
argument_list|,
operator|==
argument_list|,
name|aio
operator|->
name|io_size
argument_list|)
expr_stmt|;
name|zio_buf_free
argument_list|(
name|aio
operator|->
name|io_data
argument_list|,
name|aio
operator|->
name|io_size
argument_list|)
expr_stmt|;
block|}
end_function

begin_define
define|#
directive|define
name|IS_ADJACENT
parameter_list|(
name|io
parameter_list|,
name|nio
parameter_list|)
define|\
value|((io)->io_offset + (io)->io_size == (nio)->io_offset)
end_define

begin_typedef
typedef|typedef
name|void
name|zio_issue_func_t
parameter_list|(
name|zio_t
modifier|*
parameter_list|)
function_decl|;
end_typedef

begin_function
specifier|static
name|zio_t
modifier|*
name|vdev_queue_io_to_issue
parameter_list|(
name|vdev_queue_t
modifier|*
name|vq
parameter_list|,
name|uint64_t
name|pending_limit
parameter_list|,
name|zio_issue_func_t
modifier|*
modifier|*
name|funcp
parameter_list|)
block|{
name|zio_t
modifier|*
name|fio
decl_stmt|,
modifier|*
name|lio
decl_stmt|,
modifier|*
name|aio
decl_stmt|,
modifier|*
name|dio
decl_stmt|;
name|avl_tree_t
modifier|*
name|tree
decl_stmt|;
name|uint64_t
name|size
decl_stmt|;
name|ASSERT
argument_list|(
name|MUTEX_HELD
argument_list|(
operator|&
name|vq
operator|->
name|vq_lock
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|funcp
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|avl_numnodes
argument_list|(
operator|&
name|vq
operator|->
name|vq_pending_tree
argument_list|)
operator|>=
name|pending_limit
operator|||
name|avl_numnodes
argument_list|(
operator|&
name|vq
operator|->
name|vq_deadline_tree
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|fio
operator|=
name|lio
operator|=
name|avl_first
argument_list|(
operator|&
name|vq
operator|->
name|vq_deadline_tree
argument_list|)
expr_stmt|;
name|tree
operator|=
name|fio
operator|->
name|io_vdev_tree
expr_stmt|;
name|size
operator|=
name|fio
operator|->
name|io_size
expr_stmt|;
while|while
condition|(
operator|(
name|dio
operator|=
name|AVL_PREV
argument_list|(
name|tree
argument_list|,
name|fio
argument_list|)
operator|)
operator|!=
name|NULL
operator|&&
name|IS_ADJACENT
argument_list|(
name|dio
argument_list|,
name|fio
argument_list|)
operator|&&
name|size
operator|+
name|dio
operator|->
name|io_size
operator|<=
name|zfs_vdev_aggregation_limit
condition|)
block|{
name|dio
operator|->
name|io_delegate_next
operator|=
name|fio
expr_stmt|;
name|fio
operator|=
name|dio
expr_stmt|;
name|size
operator|+=
name|dio
operator|->
name|io_size
expr_stmt|;
block|}
while|while
condition|(
operator|(
name|dio
operator|=
name|AVL_NEXT
argument_list|(
name|tree
argument_list|,
name|lio
argument_list|)
operator|)
operator|!=
name|NULL
operator|&&
name|IS_ADJACENT
argument_list|(
name|lio
argument_list|,
name|dio
argument_list|)
operator|&&
name|size
operator|+
name|dio
operator|->
name|io_size
operator|<=
name|zfs_vdev_aggregation_limit
condition|)
block|{
name|lio
operator|->
name|io_delegate_next
operator|=
name|dio
expr_stmt|;
name|lio
operator|=
name|dio
expr_stmt|;
name|size
operator|+=
name|dio
operator|->
name|io_size
expr_stmt|;
block|}
if|if
condition|(
name|fio
operator|!=
name|lio
condition|)
block|{
name|char
modifier|*
name|buf
init|=
name|zio_buf_alloc
argument_list|(
name|size
argument_list|)
decl_stmt|;
name|uint64_t
name|offset
init|=
literal|0
decl_stmt|;
name|int
name|nagg
init|=
literal|0
decl_stmt|;
name|ASSERT
argument_list|(
name|size
operator|<=
name|zfs_vdev_aggregation_limit
argument_list|)
expr_stmt|;
name|aio
operator|=
name|zio_vdev_child_io
argument_list|(
name|fio
argument_list|,
name|NULL
argument_list|,
name|fio
operator|->
name|io_vd
argument_list|,
name|fio
operator|->
name|io_offset
argument_list|,
name|buf
argument_list|,
name|size
argument_list|,
name|fio
operator|->
name|io_type
argument_list|,
name|ZIO_PRIORITY_NOW
argument_list|,
name|ZIO_FLAG_DONT_QUEUE
operator||
name|ZIO_FLAG_DONT_CACHE
operator||
name|ZIO_FLAG_DONT_PROPAGATE
operator||
name|ZIO_FLAG_NOBOOKMARK
argument_list|,
name|vdev_queue_agg_io_done
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|aio
operator|->
name|io_delegate_list
operator|=
name|fio
expr_stmt|;
for|for
control|(
name|dio
operator|=
name|fio
init|;
name|dio
operator|!=
name|NULL
condition|;
name|dio
operator|=
name|dio
operator|->
name|io_delegate_next
control|)
block|{
name|ASSERT
argument_list|(
name|dio
operator|->
name|io_type
operator|==
name|aio
operator|->
name|io_type
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|dio
operator|->
name|io_vdev_tree
operator|==
name|tree
argument_list|)
expr_stmt|;
if|if
condition|(
name|dio
operator|->
name|io_type
operator|==
name|ZIO_TYPE_WRITE
condition|)
name|bcopy
argument_list|(
name|dio
operator|->
name|io_data
argument_list|,
name|buf
operator|+
name|offset
argument_list|,
name|dio
operator|->
name|io_size
argument_list|)
expr_stmt|;
name|offset
operator|+=
name|dio
operator|->
name|io_size
expr_stmt|;
name|vdev_queue_io_remove
argument_list|(
name|vq
argument_list|,
name|dio
argument_list|)
expr_stmt|;
name|zio_vdev_io_bypass
argument_list|(
name|dio
argument_list|)
expr_stmt|;
name|nagg
operator|++
expr_stmt|;
block|}
name|ASSERT
argument_list|(
name|offset
operator|==
name|size
argument_list|)
expr_stmt|;
name|dprintf
argument_list|(
literal|"%5s  T=%llu  off=%8llx  agg=%3d  "
literal|"old=%5llx  new=%5llx\n"
argument_list|,
name|zio_type_name
index|[
name|fio
operator|->
name|io_type
index|]
argument_list|,
name|fio
operator|->
name|io_deadline
argument_list|,
name|fio
operator|->
name|io_offset
argument_list|,
name|nagg
argument_list|,
name|fio
operator|->
name|io_size
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|avl_add
argument_list|(
operator|&
name|vq
operator|->
name|vq_pending_tree
argument_list|,
name|aio
argument_list|)
expr_stmt|;
operator|*
name|funcp
operator|=
name|zio_nowait
expr_stmt|;
return|return
operator|(
name|aio
operator|)
return|;
block|}
name|ASSERT
argument_list|(
name|fio
operator|->
name|io_vdev_tree
operator|==
name|tree
argument_list|)
expr_stmt|;
name|vdev_queue_io_remove
argument_list|(
name|vq
argument_list|,
name|fio
argument_list|)
expr_stmt|;
name|avl_add
argument_list|(
operator|&
name|vq
operator|->
name|vq_pending_tree
argument_list|,
name|fio
argument_list|)
expr_stmt|;
operator|*
name|funcp
operator|=
name|zio_next_stage
expr_stmt|;
return|return
operator|(
name|fio
operator|)
return|;
block|}
end_function

begin_function
name|zio_t
modifier|*
name|vdev_queue_io
parameter_list|(
name|zio_t
modifier|*
name|zio
parameter_list|)
block|{
name|vdev_queue_t
modifier|*
name|vq
init|=
operator|&
name|zio
operator|->
name|io_vd
operator|->
name|vdev_queue
decl_stmt|;
name|zio_t
modifier|*
name|nio
decl_stmt|;
name|zio_issue_func_t
modifier|*
name|func
decl_stmt|;
name|ASSERT
argument_list|(
name|zio
operator|->
name|io_type
operator|==
name|ZIO_TYPE_READ
operator|||
name|zio
operator|->
name|io_type
operator|==
name|ZIO_TYPE_WRITE
argument_list|)
expr_stmt|;
if|if
condition|(
name|zio
operator|->
name|io_flags
operator|&
name|ZIO_FLAG_DONT_QUEUE
condition|)
return|return
operator|(
name|zio
operator|)
return|;
name|zio
operator|->
name|io_flags
operator||=
name|ZIO_FLAG_DONT_CACHE
operator||
name|ZIO_FLAG_DONT_QUEUE
expr_stmt|;
if|if
condition|(
name|zio
operator|->
name|io_type
operator|==
name|ZIO_TYPE_READ
condition|)
name|zio
operator|->
name|io_vdev_tree
operator|=
operator|&
name|vq
operator|->
name|vq_read_tree
expr_stmt|;
else|else
name|zio
operator|->
name|io_vdev_tree
operator|=
operator|&
name|vq
operator|->
name|vq_write_tree
expr_stmt|;
name|mutex_enter
argument_list|(
operator|&
name|vq
operator|->
name|vq_lock
argument_list|)
expr_stmt|;
name|zio
operator|->
name|io_deadline
operator|=
operator|(
name|zio
operator|->
name|io_timestamp
operator|>>
name|zfs_vdev_time_shift
operator|)
operator|+
name|zio
operator|->
name|io_priority
expr_stmt|;
name|vdev_queue_io_add
argument_list|(
name|vq
argument_list|,
name|zio
argument_list|)
expr_stmt|;
name|nio
operator|=
name|vdev_queue_io_to_issue
argument_list|(
name|vq
argument_list|,
name|zfs_vdev_min_pending
argument_list|,
operator|&
name|func
argument_list|)
expr_stmt|;
name|mutex_exit
argument_list|(
operator|&
name|vq
operator|->
name|vq_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|nio
operator|==
name|NULL
operator|||
name|func
operator|!=
name|zio_nowait
condition|)
return|return
operator|(
name|nio
operator|)
return|;
name|func
argument_list|(
name|nio
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_function
name|void
name|vdev_queue_io_done
parameter_list|(
name|zio_t
modifier|*
name|zio
parameter_list|)
block|{
name|vdev_queue_t
modifier|*
name|vq
init|=
operator|&
name|zio
operator|->
name|io_vd
operator|->
name|vdev_queue
decl_stmt|;
name|zio_t
modifier|*
name|nio
decl_stmt|;
name|zio_issue_func_t
modifier|*
name|func
decl_stmt|;
name|int
name|i
decl_stmt|;
name|mutex_enter
argument_list|(
operator|&
name|vq
operator|->
name|vq_lock
argument_list|)
expr_stmt|;
name|avl_remove
argument_list|(
operator|&
name|vq
operator|->
name|vq_pending_tree
argument_list|,
name|zio
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|zfs_vdev_ramp_rate
condition|;
name|i
operator|++
control|)
block|{
name|nio
operator|=
name|vdev_queue_io_to_issue
argument_list|(
name|vq
argument_list|,
name|zfs_vdev_max_pending
argument_list|,
operator|&
name|func
argument_list|)
expr_stmt|;
if|if
condition|(
name|nio
operator|==
name|NULL
condition|)
break|break;
name|mutex_exit
argument_list|(
operator|&
name|vq
operator|->
name|vq_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|func
operator|==
name|zio_next_stage
condition|)
name|zio_vdev_io_reissue
argument_list|(
name|nio
argument_list|)
expr_stmt|;
name|func
argument_list|(
name|nio
argument_list|)
expr_stmt|;
name|mutex_enter
argument_list|(
operator|&
name|vq
operator|->
name|vq_lock
argument_list|)
expr_stmt|;
block|}
name|mutex_exit
argument_list|(
operator|&
name|vq
operator|->
name|vq_lock
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


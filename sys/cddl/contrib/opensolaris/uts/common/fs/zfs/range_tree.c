begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * CDDL HEADER START  *  * The contents of this file are subject to the terms of the  * Common Development and Distribution License (the "License").  * You may not use this file except in compliance with the License.  *  * You can obtain a copy of the license at usr/src/OPENSOLARIS.LICENSE  * or http://www.opensolaris.org/os/licensing.  * See the License for the specific language governing permissions  * and limitations under the License.  *  * When distributing Covered Code, include this CDDL HEADER in each  * file and include the License file at usr/src/OPENSOLARIS.LICENSE.  * If applicable, add the following below this CDDL HEADER, with the  * fields enclosed by brackets "[]" replaced with your own identifying  * information: Portions Copyright [yyyy] [name of copyright owner]  *  * CDDL HEADER END  */
end_comment

begin_comment
comment|/*  * Copyright 2009 Sun Microsystems, Inc.  All rights reserved.  * Use is subject to license terms.  */
end_comment

begin_comment
comment|/*  * Copyright (c) 2013, 2014 by Delphix. All rights reserved.  */
end_comment

begin_include
include|#
directive|include
file|<sys/zfs_context.h>
end_include

begin_include
include|#
directive|include
file|<sys/spa.h>
end_include

begin_include
include|#
directive|include
file|<sys/dmu.h>
end_include

begin_include
include|#
directive|include
file|<sys/dnode.h>
end_include

begin_include
include|#
directive|include
file|<sys/zio.h>
end_include

begin_include
include|#
directive|include
file|<sys/range_tree.h>
end_include

begin_decl_stmt
name|kmem_cache_t
modifier|*
name|range_seg_cache
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|range_tree_init
parameter_list|(
name|void
parameter_list|)
block|{
name|ASSERT
argument_list|(
name|range_seg_cache
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|range_seg_cache
operator|=
name|kmem_cache_create
argument_list|(
literal|"range_seg_cache"
argument_list|,
sizeof|sizeof
argument_list|(
name|range_seg_t
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|range_tree_fini
parameter_list|(
name|void
parameter_list|)
block|{
name|kmem_cache_destroy
argument_list|(
name|range_seg_cache
argument_list|)
expr_stmt|;
name|range_seg_cache
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
name|void
name|range_tree_stat_verify
parameter_list|(
name|range_tree_t
modifier|*
name|rt
parameter_list|)
block|{
name|range_seg_t
modifier|*
name|rs
decl_stmt|;
name|uint64_t
name|hist
index|[
name|RANGE_TREE_HISTOGRAM_SIZE
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|rs
operator|=
name|avl_first
argument_list|(
operator|&
name|rt
operator|->
name|rt_root
argument_list|)
init|;
name|rs
operator|!=
name|NULL
condition|;
name|rs
operator|=
name|AVL_NEXT
argument_list|(
operator|&
name|rt
operator|->
name|rt_root
argument_list|,
name|rs
argument_list|)
control|)
block|{
name|uint64_t
name|size
init|=
name|rs
operator|->
name|rs_end
operator|-
name|rs
operator|->
name|rs_start
decl_stmt|;
name|int
name|idx
init|=
name|highbit64
argument_list|(
name|size
argument_list|)
operator|-
literal|1
decl_stmt|;
name|hist
index|[
name|idx
index|]
operator|++
expr_stmt|;
name|ASSERT3U
argument_list|(
name|hist
index|[
name|idx
index|]
argument_list|,
operator|!=
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RANGE_TREE_HISTOGRAM_SIZE
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|hist
index|[
name|i
index|]
operator|!=
name|rt
operator|->
name|rt_histogram
index|[
name|i
index|]
condition|)
block|{
name|zfs_dbgmsg
argument_list|(
literal|"i=%d, hist=%p, hist=%llu, rt_hist=%llu"
argument_list|,
name|i
argument_list|,
name|hist
argument_list|,
name|hist
index|[
name|i
index|]
argument_list|,
name|rt
operator|->
name|rt_histogram
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|VERIFY3U
argument_list|(
name|hist
index|[
name|i
index|]
argument_list|,
operator|==
argument_list|,
name|rt
operator|->
name|rt_histogram
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|range_tree_stat_incr
parameter_list|(
name|range_tree_t
modifier|*
name|rt
parameter_list|,
name|range_seg_t
modifier|*
name|rs
parameter_list|)
block|{
name|uint64_t
name|size
init|=
name|rs
operator|->
name|rs_end
operator|-
name|rs
operator|->
name|rs_start
decl_stmt|;
name|int
name|idx
init|=
name|highbit64
argument_list|(
name|size
argument_list|)
operator|-
literal|1
decl_stmt|;
name|ASSERT
argument_list|(
name|size
operator|!=
literal|0
argument_list|)
expr_stmt|;
name|ASSERT3U
argument_list|(
name|idx
argument_list|,
operator|<
argument_list|,
sizeof|sizeof
argument_list|(
name|rt
operator|->
name|rt_histogram
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
operator|*
name|rt
operator|->
name|rt_histogram
argument_list|)
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|MUTEX_HELD
argument_list|(
name|rt
operator|->
name|rt_lock
argument_list|)
argument_list|)
expr_stmt|;
name|rt
operator|->
name|rt_histogram
index|[
name|idx
index|]
operator|++
expr_stmt|;
name|ASSERT3U
argument_list|(
name|rt
operator|->
name|rt_histogram
index|[
name|idx
index|]
argument_list|,
operator|!=
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|range_tree_stat_decr
parameter_list|(
name|range_tree_t
modifier|*
name|rt
parameter_list|,
name|range_seg_t
modifier|*
name|rs
parameter_list|)
block|{
name|uint64_t
name|size
init|=
name|rs
operator|->
name|rs_end
operator|-
name|rs
operator|->
name|rs_start
decl_stmt|;
name|int
name|idx
init|=
name|highbit64
argument_list|(
name|size
argument_list|)
operator|-
literal|1
decl_stmt|;
name|ASSERT
argument_list|(
name|size
operator|!=
literal|0
argument_list|)
expr_stmt|;
name|ASSERT3U
argument_list|(
name|idx
argument_list|,
operator|<
argument_list|,
sizeof|sizeof
argument_list|(
name|rt
operator|->
name|rt_histogram
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
operator|*
name|rt
operator|->
name|rt_histogram
argument_list|)
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|MUTEX_HELD
argument_list|(
name|rt
operator|->
name|rt_lock
argument_list|)
argument_list|)
expr_stmt|;
name|ASSERT3U
argument_list|(
name|rt
operator|->
name|rt_histogram
index|[
name|idx
index|]
argument_list|,
operator|!=
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rt
operator|->
name|rt_histogram
index|[
name|idx
index|]
operator|--
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * NOTE: caller is responsible for all locking.  */
end_comment

begin_function
specifier|static
name|int
name|range_tree_seg_compare
parameter_list|(
specifier|const
name|void
modifier|*
name|x1
parameter_list|,
specifier|const
name|void
modifier|*
name|x2
parameter_list|)
block|{
specifier|const
name|range_seg_t
modifier|*
name|r1
init|=
name|x1
decl_stmt|;
specifier|const
name|range_seg_t
modifier|*
name|r2
init|=
name|x2
decl_stmt|;
if|if
condition|(
name|r1
operator|->
name|rs_start
operator|<
name|r2
operator|->
name|rs_start
condition|)
block|{
if|if
condition|(
name|r1
operator|->
name|rs_end
operator|>
name|r2
operator|->
name|rs_start
condition|)
return|return
operator|(
literal|0
operator|)
return|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|r1
operator|->
name|rs_start
operator|>
name|r2
operator|->
name|rs_start
condition|)
block|{
if|if
condition|(
name|r1
operator|->
name|rs_start
operator|<
name|r2
operator|->
name|rs_end
condition|)
return|return
operator|(
literal|0
operator|)
return|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|range_tree_t
modifier|*
name|range_tree_create
parameter_list|(
name|range_tree_ops_t
modifier|*
name|ops
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|,
name|kmutex_t
modifier|*
name|lp
parameter_list|)
block|{
name|range_tree_t
modifier|*
name|rt
decl_stmt|;
name|rt
operator|=
name|kmem_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|range_tree_t
argument_list|)
argument_list|,
name|KM_SLEEP
argument_list|)
expr_stmt|;
name|avl_create
argument_list|(
operator|&
name|rt
operator|->
name|rt_root
argument_list|,
name|range_tree_seg_compare
argument_list|,
sizeof|sizeof
argument_list|(
name|range_seg_t
argument_list|)
argument_list|,
name|offsetof
argument_list|(
name|range_seg_t
argument_list|,
name|rs_node
argument_list|)
argument_list|)
expr_stmt|;
name|rt
operator|->
name|rt_lock
operator|=
name|lp
expr_stmt|;
name|rt
operator|->
name|rt_ops
operator|=
name|ops
expr_stmt|;
name|rt
operator|->
name|rt_arg
operator|=
name|arg
expr_stmt|;
if|if
condition|(
name|rt
operator|->
name|rt_ops
operator|!=
name|NULL
condition|)
name|rt
operator|->
name|rt_ops
operator|->
name|rtop_create
argument_list|(
name|rt
argument_list|,
name|rt
operator|->
name|rt_arg
argument_list|)
expr_stmt|;
return|return
operator|(
name|rt
operator|)
return|;
block|}
end_function

begin_function
name|void
name|range_tree_destroy
parameter_list|(
name|range_tree_t
modifier|*
name|rt
parameter_list|)
block|{
name|VERIFY0
argument_list|(
name|rt
operator|->
name|rt_space
argument_list|)
expr_stmt|;
if|if
condition|(
name|rt
operator|->
name|rt_ops
operator|!=
name|NULL
condition|)
name|rt
operator|->
name|rt_ops
operator|->
name|rtop_destroy
argument_list|(
name|rt
argument_list|,
name|rt
operator|->
name|rt_arg
argument_list|)
expr_stmt|;
name|avl_destroy
argument_list|(
operator|&
name|rt
operator|->
name|rt_root
argument_list|)
expr_stmt|;
name|kmem_free
argument_list|(
name|rt
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|rt
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|range_tree_add
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|uint64_t
name|start
parameter_list|,
name|uint64_t
name|size
parameter_list|)
block|{
name|range_tree_t
modifier|*
name|rt
init|=
name|arg
decl_stmt|;
name|avl_index_t
name|where
decl_stmt|;
name|range_seg_t
name|rsearch
decl_stmt|,
modifier|*
name|rs_before
decl_stmt|,
modifier|*
name|rs_after
decl_stmt|,
modifier|*
name|rs
decl_stmt|;
name|uint64_t
name|end
init|=
name|start
operator|+
name|size
decl_stmt|;
name|boolean_t
name|merge_before
decl_stmt|,
name|merge_after
decl_stmt|;
name|ASSERT
argument_list|(
name|MUTEX_HELD
argument_list|(
name|rt
operator|->
name|rt_lock
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY
argument_list|(
name|size
operator|!=
literal|0
argument_list|)
expr_stmt|;
name|rsearch
operator|.
name|rs_start
operator|=
name|start
expr_stmt|;
name|rsearch
operator|.
name|rs_end
operator|=
name|end
expr_stmt|;
name|rs
operator|=
name|avl_find
argument_list|(
operator|&
name|rt
operator|->
name|rt_root
argument_list|,
operator|&
name|rsearch
argument_list|,
operator|&
name|where
argument_list|)
expr_stmt|;
if|if
condition|(
name|rs
operator|!=
name|NULL
operator|&&
name|rs
operator|->
name|rs_start
operator|<=
name|start
operator|&&
name|rs
operator|->
name|rs_end
operator|>=
name|end
condition|)
block|{
name|zfs_panic_recover
argument_list|(
literal|"zfs: allocating allocated segment"
literal|"(offset=%llu size=%llu)\n"
argument_list|,
operator|(
name|longlong_t
operator|)
name|start
argument_list|,
operator|(
name|longlong_t
operator|)
name|size
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Make sure we don't overlap with either of our neighbors */
name|VERIFY
argument_list|(
name|rs
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|rs_before
operator|=
name|avl_nearest
argument_list|(
operator|&
name|rt
operator|->
name|rt_root
argument_list|,
name|where
argument_list|,
name|AVL_BEFORE
argument_list|)
expr_stmt|;
name|rs_after
operator|=
name|avl_nearest
argument_list|(
operator|&
name|rt
operator|->
name|rt_root
argument_list|,
name|where
argument_list|,
name|AVL_AFTER
argument_list|)
expr_stmt|;
name|merge_before
operator|=
operator|(
name|rs_before
operator|!=
name|NULL
operator|&&
name|rs_before
operator|->
name|rs_end
operator|==
name|start
operator|)
expr_stmt|;
name|merge_after
operator|=
operator|(
name|rs_after
operator|!=
name|NULL
operator|&&
name|rs_after
operator|->
name|rs_start
operator|==
name|end
operator|)
expr_stmt|;
if|if
condition|(
name|merge_before
operator|&&
name|merge_after
condition|)
block|{
name|avl_remove
argument_list|(
operator|&
name|rt
operator|->
name|rt_root
argument_list|,
name|rs_before
argument_list|)
expr_stmt|;
if|if
condition|(
name|rt
operator|->
name|rt_ops
operator|!=
name|NULL
condition|)
block|{
name|rt
operator|->
name|rt_ops
operator|->
name|rtop_remove
argument_list|(
name|rt
argument_list|,
name|rs_before
argument_list|,
name|rt
operator|->
name|rt_arg
argument_list|)
expr_stmt|;
name|rt
operator|->
name|rt_ops
operator|->
name|rtop_remove
argument_list|(
name|rt
argument_list|,
name|rs_after
argument_list|,
name|rt
operator|->
name|rt_arg
argument_list|)
expr_stmt|;
block|}
name|range_tree_stat_decr
argument_list|(
name|rt
argument_list|,
name|rs_before
argument_list|)
expr_stmt|;
name|range_tree_stat_decr
argument_list|(
name|rt
argument_list|,
name|rs_after
argument_list|)
expr_stmt|;
name|rs_after
operator|->
name|rs_start
operator|=
name|rs_before
operator|->
name|rs_start
expr_stmt|;
name|kmem_cache_free
argument_list|(
name|range_seg_cache
argument_list|,
name|rs_before
argument_list|)
expr_stmt|;
name|rs
operator|=
name|rs_after
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|merge_before
condition|)
block|{
if|if
condition|(
name|rt
operator|->
name|rt_ops
operator|!=
name|NULL
condition|)
name|rt
operator|->
name|rt_ops
operator|->
name|rtop_remove
argument_list|(
name|rt
argument_list|,
name|rs_before
argument_list|,
name|rt
operator|->
name|rt_arg
argument_list|)
expr_stmt|;
name|range_tree_stat_decr
argument_list|(
name|rt
argument_list|,
name|rs_before
argument_list|)
expr_stmt|;
name|rs_before
operator|->
name|rs_end
operator|=
name|end
expr_stmt|;
name|rs
operator|=
name|rs_before
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|merge_after
condition|)
block|{
if|if
condition|(
name|rt
operator|->
name|rt_ops
operator|!=
name|NULL
condition|)
name|rt
operator|->
name|rt_ops
operator|->
name|rtop_remove
argument_list|(
name|rt
argument_list|,
name|rs_after
argument_list|,
name|rt
operator|->
name|rt_arg
argument_list|)
expr_stmt|;
name|range_tree_stat_decr
argument_list|(
name|rt
argument_list|,
name|rs_after
argument_list|)
expr_stmt|;
name|rs_after
operator|->
name|rs_start
operator|=
name|start
expr_stmt|;
name|rs
operator|=
name|rs_after
expr_stmt|;
block|}
else|else
block|{
name|rs
operator|=
name|kmem_cache_alloc
argument_list|(
name|range_seg_cache
argument_list|,
name|KM_SLEEP
argument_list|)
expr_stmt|;
name|rs
operator|->
name|rs_start
operator|=
name|start
expr_stmt|;
name|rs
operator|->
name|rs_end
operator|=
name|end
expr_stmt|;
name|avl_insert
argument_list|(
operator|&
name|rt
operator|->
name|rt_root
argument_list|,
name|rs
argument_list|,
name|where
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rt
operator|->
name|rt_ops
operator|!=
name|NULL
condition|)
name|rt
operator|->
name|rt_ops
operator|->
name|rtop_add
argument_list|(
name|rt
argument_list|,
name|rs
argument_list|,
name|rt
operator|->
name|rt_arg
argument_list|)
expr_stmt|;
name|range_tree_stat_incr
argument_list|(
name|rt
argument_list|,
name|rs
argument_list|)
expr_stmt|;
name|rt
operator|->
name|rt_space
operator|+=
name|size
expr_stmt|;
block|}
end_function

begin_function
name|void
name|range_tree_remove
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|uint64_t
name|start
parameter_list|,
name|uint64_t
name|size
parameter_list|)
block|{
name|range_tree_t
modifier|*
name|rt
init|=
name|arg
decl_stmt|;
name|avl_index_t
name|where
decl_stmt|;
name|range_seg_t
name|rsearch
decl_stmt|,
modifier|*
name|rs
decl_stmt|,
modifier|*
name|newseg
decl_stmt|;
name|uint64_t
name|end
init|=
name|start
operator|+
name|size
decl_stmt|;
name|boolean_t
name|left_over
decl_stmt|,
name|right_over
decl_stmt|;
name|ASSERT
argument_list|(
name|MUTEX_HELD
argument_list|(
name|rt
operator|->
name|rt_lock
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY3U
argument_list|(
name|size
argument_list|,
operator|!=
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|VERIFY3U
argument_list|(
name|size
argument_list|,
operator|<=
argument_list|,
name|rt
operator|->
name|rt_space
argument_list|)
expr_stmt|;
name|rsearch
operator|.
name|rs_start
operator|=
name|start
expr_stmt|;
name|rsearch
operator|.
name|rs_end
operator|=
name|end
expr_stmt|;
name|rs
operator|=
name|avl_find
argument_list|(
operator|&
name|rt
operator|->
name|rt_root
argument_list|,
operator|&
name|rsearch
argument_list|,
operator|&
name|where
argument_list|)
expr_stmt|;
comment|/* Make sure we completely overlap with someone */
if|if
condition|(
name|rs
operator|==
name|NULL
condition|)
block|{
name|zfs_panic_recover
argument_list|(
literal|"zfs: freeing free segment "
literal|"(offset=%llu size=%llu)"
argument_list|,
operator|(
name|longlong_t
operator|)
name|start
argument_list|,
operator|(
name|longlong_t
operator|)
name|size
argument_list|)
expr_stmt|;
return|return;
block|}
name|VERIFY3U
argument_list|(
name|rs
operator|->
name|rs_start
argument_list|,
operator|<=
argument_list|,
name|start
argument_list|)
expr_stmt|;
name|VERIFY3U
argument_list|(
name|rs
operator|->
name|rs_end
argument_list|,
operator|>=
argument_list|,
name|end
argument_list|)
expr_stmt|;
name|left_over
operator|=
operator|(
name|rs
operator|->
name|rs_start
operator|!=
name|start
operator|)
expr_stmt|;
name|right_over
operator|=
operator|(
name|rs
operator|->
name|rs_end
operator|!=
name|end
operator|)
expr_stmt|;
name|range_tree_stat_decr
argument_list|(
name|rt
argument_list|,
name|rs
argument_list|)
expr_stmt|;
if|if
condition|(
name|rt
operator|->
name|rt_ops
operator|!=
name|NULL
condition|)
name|rt
operator|->
name|rt_ops
operator|->
name|rtop_remove
argument_list|(
name|rt
argument_list|,
name|rs
argument_list|,
name|rt
operator|->
name|rt_arg
argument_list|)
expr_stmt|;
if|if
condition|(
name|left_over
operator|&&
name|right_over
condition|)
block|{
name|newseg
operator|=
name|kmem_cache_alloc
argument_list|(
name|range_seg_cache
argument_list|,
name|KM_SLEEP
argument_list|)
expr_stmt|;
name|newseg
operator|->
name|rs_start
operator|=
name|end
expr_stmt|;
name|newseg
operator|->
name|rs_end
operator|=
name|rs
operator|->
name|rs_end
expr_stmt|;
name|range_tree_stat_incr
argument_list|(
name|rt
argument_list|,
name|newseg
argument_list|)
expr_stmt|;
name|rs
operator|->
name|rs_end
operator|=
name|start
expr_stmt|;
name|avl_insert_here
argument_list|(
operator|&
name|rt
operator|->
name|rt_root
argument_list|,
name|newseg
argument_list|,
name|rs
argument_list|,
name|AVL_AFTER
argument_list|)
expr_stmt|;
if|if
condition|(
name|rt
operator|->
name|rt_ops
operator|!=
name|NULL
condition|)
name|rt
operator|->
name|rt_ops
operator|->
name|rtop_add
argument_list|(
name|rt
argument_list|,
name|newseg
argument_list|,
name|rt
operator|->
name|rt_arg
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|left_over
condition|)
block|{
name|rs
operator|->
name|rs_end
operator|=
name|start
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|right_over
condition|)
block|{
name|rs
operator|->
name|rs_start
operator|=
name|end
expr_stmt|;
block|}
else|else
block|{
name|avl_remove
argument_list|(
operator|&
name|rt
operator|->
name|rt_root
argument_list|,
name|rs
argument_list|)
expr_stmt|;
name|kmem_cache_free
argument_list|(
name|range_seg_cache
argument_list|,
name|rs
argument_list|)
expr_stmt|;
name|rs
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|rs
operator|!=
name|NULL
condition|)
block|{
name|range_tree_stat_incr
argument_list|(
name|rt
argument_list|,
name|rs
argument_list|)
expr_stmt|;
if|if
condition|(
name|rt
operator|->
name|rt_ops
operator|!=
name|NULL
condition|)
name|rt
operator|->
name|rt_ops
operator|->
name|rtop_add
argument_list|(
name|rt
argument_list|,
name|rs
argument_list|,
name|rt
operator|->
name|rt_arg
argument_list|)
expr_stmt|;
block|}
name|rt
operator|->
name|rt_space
operator|-=
name|size
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|range_seg_t
modifier|*
name|range_tree_find_impl
parameter_list|(
name|range_tree_t
modifier|*
name|rt
parameter_list|,
name|uint64_t
name|start
parameter_list|,
name|uint64_t
name|size
parameter_list|)
block|{
name|avl_index_t
name|where
decl_stmt|;
name|range_seg_t
name|rsearch
decl_stmt|;
name|uint64_t
name|end
init|=
name|start
operator|+
name|size
decl_stmt|;
name|ASSERT
argument_list|(
name|MUTEX_HELD
argument_list|(
name|rt
operator|->
name|rt_lock
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY
argument_list|(
name|size
operator|!=
literal|0
argument_list|)
expr_stmt|;
name|rsearch
operator|.
name|rs_start
operator|=
name|start
expr_stmt|;
name|rsearch
operator|.
name|rs_end
operator|=
name|end
expr_stmt|;
return|return
operator|(
name|avl_find
argument_list|(
operator|&
name|rt
operator|->
name|rt_root
argument_list|,
operator|&
name|rsearch
argument_list|,
operator|&
name|where
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|range_seg_t
modifier|*
name|range_tree_find
parameter_list|(
name|range_tree_t
modifier|*
name|rt
parameter_list|,
name|uint64_t
name|start
parameter_list|,
name|uint64_t
name|size
parameter_list|)
block|{
name|range_seg_t
modifier|*
name|rs
init|=
name|range_tree_find_impl
argument_list|(
name|rt
argument_list|,
name|start
argument_list|,
name|size
argument_list|)
decl_stmt|;
if|if
condition|(
name|rs
operator|!=
name|NULL
operator|&&
name|rs
operator|->
name|rs_start
operator|<=
name|start
operator|&&
name|rs
operator|->
name|rs_end
operator|>=
name|start
operator|+
name|size
condition|)
return|return
operator|(
name|rs
operator|)
return|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_function
name|void
name|range_tree_verify
parameter_list|(
name|range_tree_t
modifier|*
name|rt
parameter_list|,
name|uint64_t
name|off
parameter_list|,
name|uint64_t
name|size
parameter_list|)
block|{
name|range_seg_t
modifier|*
name|rs
decl_stmt|;
name|mutex_enter
argument_list|(
name|rt
operator|->
name|rt_lock
argument_list|)
expr_stmt|;
name|rs
operator|=
name|range_tree_find
argument_list|(
name|rt
argument_list|,
name|off
argument_list|,
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|rs
operator|!=
name|NULL
condition|)
name|panic
argument_list|(
literal|"freeing free block; rs=%p"
argument_list|,
operator|(
name|void
operator|*
operator|)
name|rs
argument_list|)
expr_stmt|;
name|mutex_exit
argument_list|(
name|rt
operator|->
name|rt_lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|boolean_t
name|range_tree_contains
parameter_list|(
name|range_tree_t
modifier|*
name|rt
parameter_list|,
name|uint64_t
name|start
parameter_list|,
name|uint64_t
name|size
parameter_list|)
block|{
return|return
operator|(
name|range_tree_find
argument_list|(
name|rt
argument_list|,
name|start
argument_list|,
name|size
argument_list|)
operator|!=
name|NULL
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Ensure that this range is not in the tree, regardless of whether  * it is currently in the tree.  */
end_comment

begin_function
name|void
name|range_tree_clear
parameter_list|(
name|range_tree_t
modifier|*
name|rt
parameter_list|,
name|uint64_t
name|start
parameter_list|,
name|uint64_t
name|size
parameter_list|)
block|{
name|range_seg_t
modifier|*
name|rs
decl_stmt|;
while|while
condition|(
operator|(
name|rs
operator|=
name|range_tree_find_impl
argument_list|(
name|rt
argument_list|,
name|start
argument_list|,
name|size
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|uint64_t
name|free_start
init|=
name|MAX
argument_list|(
name|rs
operator|->
name|rs_start
argument_list|,
name|start
argument_list|)
decl_stmt|;
name|uint64_t
name|free_end
init|=
name|MIN
argument_list|(
name|rs
operator|->
name|rs_end
argument_list|,
name|start
operator|+
name|size
argument_list|)
decl_stmt|;
name|range_tree_remove
argument_list|(
name|rt
argument_list|,
name|free_start
argument_list|,
name|free_end
operator|-
name|free_start
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|range_tree_swap
parameter_list|(
name|range_tree_t
modifier|*
modifier|*
name|rtsrc
parameter_list|,
name|range_tree_t
modifier|*
modifier|*
name|rtdst
parameter_list|)
block|{
name|range_tree_t
modifier|*
name|rt
decl_stmt|;
name|ASSERT
argument_list|(
name|MUTEX_HELD
argument_list|(
operator|(
operator|*
name|rtsrc
operator|)
operator|->
name|rt_lock
argument_list|)
argument_list|)
expr_stmt|;
name|ASSERT0
argument_list|(
name|range_tree_space
argument_list|(
operator|*
name|rtdst
argument_list|)
argument_list|)
expr_stmt|;
name|ASSERT0
argument_list|(
name|avl_numnodes
argument_list|(
operator|&
operator|(
operator|*
name|rtdst
operator|)
operator|->
name|rt_root
argument_list|)
argument_list|)
expr_stmt|;
name|rt
operator|=
operator|*
name|rtsrc
expr_stmt|;
operator|*
name|rtsrc
operator|=
operator|*
name|rtdst
expr_stmt|;
operator|*
name|rtdst
operator|=
name|rt
expr_stmt|;
block|}
end_function

begin_function
name|void
name|range_tree_vacate
parameter_list|(
name|range_tree_t
modifier|*
name|rt
parameter_list|,
name|range_tree_func_t
modifier|*
name|func
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|range_seg_t
modifier|*
name|rs
decl_stmt|;
name|void
modifier|*
name|cookie
init|=
name|NULL
decl_stmt|;
name|ASSERT
argument_list|(
name|MUTEX_HELD
argument_list|(
name|rt
operator|->
name|rt_lock
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rt
operator|->
name|rt_ops
operator|!=
name|NULL
condition|)
name|rt
operator|->
name|rt_ops
operator|->
name|rtop_vacate
argument_list|(
name|rt
argument_list|,
name|rt
operator|->
name|rt_arg
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|rs
operator|=
name|avl_destroy_nodes
argument_list|(
operator|&
name|rt
operator|->
name|rt_root
argument_list|,
operator|&
name|cookie
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|func
operator|!=
name|NULL
condition|)
name|func
argument_list|(
name|arg
argument_list|,
name|rs
operator|->
name|rs_start
argument_list|,
name|rs
operator|->
name|rs_end
operator|-
name|rs
operator|->
name|rs_start
argument_list|)
expr_stmt|;
name|kmem_cache_free
argument_list|(
name|range_seg_cache
argument_list|,
name|rs
argument_list|)
expr_stmt|;
block|}
name|bzero
argument_list|(
name|rt
operator|->
name|rt_histogram
argument_list|,
sizeof|sizeof
argument_list|(
name|rt
operator|->
name|rt_histogram
argument_list|)
argument_list|)
expr_stmt|;
name|rt
operator|->
name|rt_space
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
name|void
name|range_tree_walk
parameter_list|(
name|range_tree_t
modifier|*
name|rt
parameter_list|,
name|range_tree_func_t
modifier|*
name|func
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|range_seg_t
modifier|*
name|rs
decl_stmt|;
name|ASSERT
argument_list|(
name|MUTEX_HELD
argument_list|(
name|rt
operator|->
name|rt_lock
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|rs
operator|=
name|avl_first
argument_list|(
operator|&
name|rt
operator|->
name|rt_root
argument_list|)
init|;
name|rs
condition|;
name|rs
operator|=
name|AVL_NEXT
argument_list|(
operator|&
name|rt
operator|->
name|rt_root
argument_list|,
name|rs
argument_list|)
control|)
name|func
argument_list|(
name|arg
argument_list|,
name|rs
operator|->
name|rs_start
argument_list|,
name|rs
operator|->
name|rs_end
operator|-
name|rs
operator|->
name|rs_start
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|uint64_t
name|range_tree_space
parameter_list|(
name|range_tree_t
modifier|*
name|rt
parameter_list|)
block|{
return|return
operator|(
name|rt
operator|->
name|rt_space
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * CDDL HEADER START  *  * The contents of this file are subject to the terms of the  * Common Development and Distribution License (the "License").  * You may not use this file except in compliance with the License.  *  * You can obtain a copy of the license at usr/src/OPENSOLARIS.LICENSE  * or http://www.opensolaris.org/os/licensing.  * See the License for the specific language governing permissions  * and limitations under the License.  *  * When distributing Covered Code, include this CDDL HEADER in each  * file and include the License file at usr/src/OPENSOLARIS.LICENSE.  * If applicable, add the following below this CDDL HEADER, with the  * fields enclosed by brackets "[]" replaced with your own identifying  * information: Portions Copyright [yyyy] [name of copyright owner]  *  * CDDL HEADER END  */
end_comment

begin_comment
comment|/*  * Copyright (c) 2005, 2010, Oracle and/or its affiliates. All rights reserved.  * Copyright (c) 2012 by Delphix. All rights reserved.  */
end_comment

begin_include
include|#
directive|include
file|<sys/zfs_context.h>
end_include

begin_include
include|#
directive|include
file|<sys/refcount.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|ZFS_DEBUG
end_ifdef

begin_ifdef
ifdef|#
directive|ifdef
name|_KERNEL
end_ifdef

begin_decl_stmt
name|int
name|reference_tracking_enable
init|=
name|FALSE
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* runs out of memory too easily */
end_comment

begin_expr_stmt
name|SYSCTL_DECL
argument_list|(
name|_vfs_zfs
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"vfs.zfs.reference_tracking_enable"
argument_list|,
operator|&
name|reference_tracking_enable
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_vfs_zfs
argument_list|,
name|OID_AUTO
argument_list|,
name|reference_tracking_enable
argument_list|,
name|CTLFLAG_RDTUN
argument_list|,
operator|&
name|reference_tracking_enable
argument_list|,
literal|0
argument_list|,
literal|"Track reference holders to refcount_t objects, used mostly by ZFS"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_else
else|#
directive|else
end_else

begin_decl_stmt
name|int
name|reference_tracking_enable
init|=
name|TRUE
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
name|int
name|reference_history
init|=
literal|3
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* tunable */
end_comment

begin_decl_stmt
specifier|static
name|kmem_cache_t
modifier|*
name|reference_cache
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|kmem_cache_t
modifier|*
name|reference_history_cache
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|refcount_sysinit
parameter_list|(
name|void
parameter_list|)
block|{
name|reference_cache
operator|=
name|kmem_cache_create
argument_list|(
literal|"reference_cache"
argument_list|,
sizeof|sizeof
argument_list|(
name|reference_t
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|reference_history_cache
operator|=
name|kmem_cache_create
argument_list|(
literal|"reference_history_cache"
argument_list|,
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|refcount_fini
parameter_list|(
name|void
parameter_list|)
block|{
name|kmem_cache_destroy
argument_list|(
name|reference_cache
argument_list|)
expr_stmt|;
name|kmem_cache_destroy
argument_list|(
name|reference_history_cache
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|refcount_create
parameter_list|(
name|refcount_t
modifier|*
name|rc
parameter_list|)
block|{
name|mutex_init
argument_list|(
operator|&
name|rc
operator|->
name|rc_mtx
argument_list|,
name|NULL
argument_list|,
name|MUTEX_DEFAULT
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|list_create
argument_list|(
operator|&
name|rc
operator|->
name|rc_list
argument_list|,
sizeof|sizeof
argument_list|(
name|reference_t
argument_list|)
argument_list|,
name|offsetof
argument_list|(
name|reference_t
argument_list|,
name|ref_link
argument_list|)
argument_list|)
expr_stmt|;
name|list_create
argument_list|(
operator|&
name|rc
operator|->
name|rc_removed
argument_list|,
sizeof|sizeof
argument_list|(
name|reference_t
argument_list|)
argument_list|,
name|offsetof
argument_list|(
name|reference_t
argument_list|,
name|ref_link
argument_list|)
argument_list|)
expr_stmt|;
name|rc
operator|->
name|rc_count
operator|=
literal|0
expr_stmt|;
name|rc
operator|->
name|rc_removed_count
operator|=
literal|0
expr_stmt|;
name|rc
operator|->
name|rc_tracked
operator|=
name|reference_tracking_enable
expr_stmt|;
block|}
end_function

begin_function
name|void
name|refcount_create_untracked
parameter_list|(
name|refcount_t
modifier|*
name|rc
parameter_list|)
block|{
name|refcount_create
argument_list|(
name|rc
argument_list|)
expr_stmt|;
name|rc
operator|->
name|rc_tracked
operator|=
name|B_FALSE
expr_stmt|;
block|}
end_function

begin_function
name|void
name|refcount_destroy_many
parameter_list|(
name|refcount_t
modifier|*
name|rc
parameter_list|,
name|uint64_t
name|number
parameter_list|)
block|{
name|reference_t
modifier|*
name|ref
decl_stmt|;
name|ASSERT
argument_list|(
name|rc
operator|->
name|rc_count
operator|==
name|number
argument_list|)
expr_stmt|;
while|while
condition|(
name|ref
operator|=
name|list_head
argument_list|(
operator|&
name|rc
operator|->
name|rc_list
argument_list|)
condition|)
block|{
name|list_remove
argument_list|(
operator|&
name|rc
operator|->
name|rc_list
argument_list|,
name|ref
argument_list|)
expr_stmt|;
name|kmem_cache_free
argument_list|(
name|reference_cache
argument_list|,
name|ref
argument_list|)
expr_stmt|;
block|}
name|list_destroy
argument_list|(
operator|&
name|rc
operator|->
name|rc_list
argument_list|)
expr_stmt|;
while|while
condition|(
name|ref
operator|=
name|list_head
argument_list|(
operator|&
name|rc
operator|->
name|rc_removed
argument_list|)
condition|)
block|{
name|list_remove
argument_list|(
operator|&
name|rc
operator|->
name|rc_removed
argument_list|,
name|ref
argument_list|)
expr_stmt|;
name|kmem_cache_free
argument_list|(
name|reference_history_cache
argument_list|,
name|ref
operator|->
name|ref_removed
argument_list|)
expr_stmt|;
name|kmem_cache_free
argument_list|(
name|reference_cache
argument_list|,
name|ref
argument_list|)
expr_stmt|;
block|}
name|list_destroy
argument_list|(
operator|&
name|rc
operator|->
name|rc_removed
argument_list|)
expr_stmt|;
name|mutex_destroy
argument_list|(
operator|&
name|rc
operator|->
name|rc_mtx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|refcount_destroy
parameter_list|(
name|refcount_t
modifier|*
name|rc
parameter_list|)
block|{
name|refcount_destroy_many
argument_list|(
name|rc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|refcount_is_zero
parameter_list|(
name|refcount_t
modifier|*
name|rc
parameter_list|)
block|{
return|return
operator|(
name|rc
operator|->
name|rc_count
operator|==
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int64_t
name|refcount_count
parameter_list|(
name|refcount_t
modifier|*
name|rc
parameter_list|)
block|{
return|return
operator|(
name|rc
operator|->
name|rc_count
operator|)
return|;
block|}
end_function

begin_function
name|int64_t
name|refcount_add_many
parameter_list|(
name|refcount_t
modifier|*
name|rc
parameter_list|,
name|uint64_t
name|number
parameter_list|,
name|void
modifier|*
name|holder
parameter_list|)
block|{
name|reference_t
modifier|*
name|ref
init|=
name|NULL
decl_stmt|;
name|int64_t
name|count
decl_stmt|;
if|if
condition|(
name|rc
operator|->
name|rc_tracked
condition|)
block|{
name|ref
operator|=
name|kmem_cache_alloc
argument_list|(
name|reference_cache
argument_list|,
name|KM_SLEEP
argument_list|)
expr_stmt|;
name|ref
operator|->
name|ref_holder
operator|=
name|holder
expr_stmt|;
name|ref
operator|->
name|ref_number
operator|=
name|number
expr_stmt|;
block|}
name|mutex_enter
argument_list|(
operator|&
name|rc
operator|->
name|rc_mtx
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|rc
operator|->
name|rc_count
operator|>=
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|->
name|rc_tracked
condition|)
name|list_insert_head
argument_list|(
operator|&
name|rc
operator|->
name|rc_list
argument_list|,
name|ref
argument_list|)
expr_stmt|;
name|rc
operator|->
name|rc_count
operator|+=
name|number
expr_stmt|;
name|count
operator|=
name|rc
operator|->
name|rc_count
expr_stmt|;
name|mutex_exit
argument_list|(
operator|&
name|rc
operator|->
name|rc_mtx
argument_list|)
expr_stmt|;
return|return
operator|(
name|count
operator|)
return|;
block|}
end_function

begin_function
name|int64_t
name|refcount_add
parameter_list|(
name|refcount_t
modifier|*
name|rc
parameter_list|,
name|void
modifier|*
name|holder
parameter_list|)
block|{
return|return
operator|(
name|refcount_add_many
argument_list|(
name|rc
argument_list|,
literal|1
argument_list|,
name|holder
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|int64_t
name|refcount_remove_many
parameter_list|(
name|refcount_t
modifier|*
name|rc
parameter_list|,
name|uint64_t
name|number
parameter_list|,
name|void
modifier|*
name|holder
parameter_list|)
block|{
name|reference_t
modifier|*
name|ref
decl_stmt|;
name|int64_t
name|count
decl_stmt|;
name|mutex_enter
argument_list|(
operator|&
name|rc
operator|->
name|rc_mtx
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|rc
operator|->
name|rc_count
operator|>=
name|number
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rc
operator|->
name|rc_tracked
condition|)
block|{
name|rc
operator|->
name|rc_count
operator|-=
name|number
expr_stmt|;
name|count
operator|=
name|rc
operator|->
name|rc_count
expr_stmt|;
name|mutex_exit
argument_list|(
operator|&
name|rc
operator|->
name|rc_mtx
argument_list|)
expr_stmt|;
return|return
operator|(
name|count
operator|)
return|;
block|}
for|for
control|(
name|ref
operator|=
name|list_head
argument_list|(
operator|&
name|rc
operator|->
name|rc_list
argument_list|)
init|;
name|ref
condition|;
name|ref
operator|=
name|list_next
argument_list|(
operator|&
name|rc
operator|->
name|rc_list
argument_list|,
name|ref
argument_list|)
control|)
block|{
if|if
condition|(
name|ref
operator|->
name|ref_holder
operator|==
name|holder
operator|&&
name|ref
operator|->
name|ref_number
operator|==
name|number
condition|)
block|{
name|list_remove
argument_list|(
operator|&
name|rc
operator|->
name|rc_list
argument_list|,
name|ref
argument_list|)
expr_stmt|;
if|if
condition|(
name|reference_history
operator|>
literal|0
condition|)
block|{
name|ref
operator|->
name|ref_removed
operator|=
name|kmem_cache_alloc
argument_list|(
name|reference_history_cache
argument_list|,
name|KM_SLEEP
argument_list|)
expr_stmt|;
name|list_insert_head
argument_list|(
operator|&
name|rc
operator|->
name|rc_removed
argument_list|,
name|ref
argument_list|)
expr_stmt|;
name|rc
operator|->
name|rc_removed_count
operator|++
expr_stmt|;
if|if
condition|(
name|rc
operator|->
name|rc_removed_count
operator|>
name|reference_history
condition|)
block|{
name|ref
operator|=
name|list_tail
argument_list|(
operator|&
name|rc
operator|->
name|rc_removed
argument_list|)
expr_stmt|;
name|list_remove
argument_list|(
operator|&
name|rc
operator|->
name|rc_removed
argument_list|,
name|ref
argument_list|)
expr_stmt|;
name|kmem_cache_free
argument_list|(
name|reference_history_cache
argument_list|,
name|ref
operator|->
name|ref_removed
argument_list|)
expr_stmt|;
name|kmem_cache_free
argument_list|(
name|reference_cache
argument_list|,
name|ref
argument_list|)
expr_stmt|;
name|rc
operator|->
name|rc_removed_count
operator|--
expr_stmt|;
block|}
block|}
else|else
block|{
name|kmem_cache_free
argument_list|(
name|reference_cache
argument_list|,
name|ref
argument_list|)
expr_stmt|;
block|}
name|rc
operator|->
name|rc_count
operator|-=
name|number
expr_stmt|;
name|count
operator|=
name|rc
operator|->
name|rc_count
expr_stmt|;
name|mutex_exit
argument_list|(
operator|&
name|rc
operator|->
name|rc_mtx
argument_list|)
expr_stmt|;
return|return
operator|(
name|count
operator|)
return|;
block|}
block|}
name|panic
argument_list|(
literal|"No such hold %p on refcount %llx"
argument_list|,
name|holder
argument_list|,
operator|(
name|u_longlong_t
operator|)
operator|(
name|uintptr_t
operator|)
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_function

begin_function
name|int64_t
name|refcount_remove
parameter_list|(
name|refcount_t
modifier|*
name|rc
parameter_list|,
name|void
modifier|*
name|holder
parameter_list|)
block|{
return|return
operator|(
name|refcount_remove_many
argument_list|(
name|rc
argument_list|,
literal|1
argument_list|,
name|holder
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|void
name|refcount_transfer
parameter_list|(
name|refcount_t
modifier|*
name|dst
parameter_list|,
name|refcount_t
modifier|*
name|src
parameter_list|)
block|{
name|int64_t
name|count
decl_stmt|,
name|removed_count
decl_stmt|;
name|list_t
name|list
decl_stmt|,
name|removed
decl_stmt|;
name|list_create
argument_list|(
operator|&
name|list
argument_list|,
sizeof|sizeof
argument_list|(
name|reference_t
argument_list|)
argument_list|,
name|offsetof
argument_list|(
name|reference_t
argument_list|,
name|ref_link
argument_list|)
argument_list|)
expr_stmt|;
name|list_create
argument_list|(
operator|&
name|removed
argument_list|,
sizeof|sizeof
argument_list|(
name|reference_t
argument_list|)
argument_list|,
name|offsetof
argument_list|(
name|reference_t
argument_list|,
name|ref_link
argument_list|)
argument_list|)
expr_stmt|;
name|mutex_enter
argument_list|(
operator|&
name|src
operator|->
name|rc_mtx
argument_list|)
expr_stmt|;
name|count
operator|=
name|src
operator|->
name|rc_count
expr_stmt|;
name|removed_count
operator|=
name|src
operator|->
name|rc_removed_count
expr_stmt|;
name|src
operator|->
name|rc_count
operator|=
literal|0
expr_stmt|;
name|src
operator|->
name|rc_removed_count
operator|=
literal|0
expr_stmt|;
name|list_move_tail
argument_list|(
operator|&
name|list
argument_list|,
operator|&
name|src
operator|->
name|rc_list
argument_list|)
expr_stmt|;
name|list_move_tail
argument_list|(
operator|&
name|removed
argument_list|,
operator|&
name|src
operator|->
name|rc_removed
argument_list|)
expr_stmt|;
name|mutex_exit
argument_list|(
operator|&
name|src
operator|->
name|rc_mtx
argument_list|)
expr_stmt|;
name|mutex_enter
argument_list|(
operator|&
name|dst
operator|->
name|rc_mtx
argument_list|)
expr_stmt|;
name|dst
operator|->
name|rc_count
operator|+=
name|count
expr_stmt|;
name|dst
operator|->
name|rc_removed_count
operator|+=
name|removed_count
expr_stmt|;
name|list_move_tail
argument_list|(
operator|&
name|dst
operator|->
name|rc_list
argument_list|,
operator|&
name|list
argument_list|)
expr_stmt|;
name|list_move_tail
argument_list|(
operator|&
name|dst
operator|->
name|rc_removed
argument_list|,
operator|&
name|removed
argument_list|)
expr_stmt|;
name|mutex_exit
argument_list|(
operator|&
name|dst
operator|->
name|rc_mtx
argument_list|)
expr_stmt|;
name|list_destroy
argument_list|(
operator|&
name|list
argument_list|)
expr_stmt|;
name|list_destroy
argument_list|(
operator|&
name|removed
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* ZFS_DEBUG */
end_comment

end_unit


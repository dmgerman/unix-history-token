begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * CDDL HEADER START  *  * The contents of this file are subject to the terms of the  * Common Development and Distribution License (the "License").  * You may not use this file except in compliance with the License.  *  * You can obtain a copy of the license at usr/src/OPENSOLARIS.LICENSE  * or http://www.opensolaris.org/os/licensing.  * See the License for the specific language governing permissions  * and limitations under the License.  *  * When distributing Covered Code, include this CDDL HEADER in each  * file and include the License file at usr/src/OPENSOLARIS.LICENSE.  * If applicable, add the following below this CDDL HEADER, with the  * fields enclosed by brackets "[]" replaced with your own identifying  * information: Portions Copyright [yyyy] [name of copyright owner]  *  * CDDL HEADER END  */
end_comment

begin_comment
comment|/*  * Copyright (c) 2005, 2010, Oracle and/or its affiliates. All rights reserved.  * Copyright (c) 2012 by Delphix. All rights reserved.  */
end_comment

begin_include
include|#
directive|include
file|<sys/bplist.h>
end_include

begin_include
include|#
directive|include
file|<sys/zfs_context.h>
end_include

begin_function
name|void
name|bplist_create
parameter_list|(
name|bplist_t
modifier|*
name|bpl
parameter_list|)
block|{
name|mutex_init
argument_list|(
operator|&
name|bpl
operator|->
name|bpl_lock
argument_list|,
name|NULL
argument_list|,
name|MUTEX_DEFAULT
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|list_create
argument_list|(
operator|&
name|bpl
operator|->
name|bpl_list
argument_list|,
sizeof|sizeof
argument_list|(
name|bplist_entry_t
argument_list|)
argument_list|,
name|offsetof
argument_list|(
name|bplist_entry_t
argument_list|,
name|bpe_node
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|bplist_destroy
parameter_list|(
name|bplist_t
modifier|*
name|bpl
parameter_list|)
block|{
name|list_destroy
argument_list|(
operator|&
name|bpl
operator|->
name|bpl_list
argument_list|)
expr_stmt|;
name|mutex_destroy
argument_list|(
operator|&
name|bpl
operator|->
name|bpl_lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|bplist_append
parameter_list|(
name|bplist_t
modifier|*
name|bpl
parameter_list|,
specifier|const
name|blkptr_t
modifier|*
name|bp
parameter_list|)
block|{
name|bplist_entry_t
modifier|*
name|bpe
init|=
name|kmem_alloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|bpe
argument_list|)
argument_list|,
name|KM_SLEEP
argument_list|)
decl_stmt|;
name|mutex_enter
argument_list|(
operator|&
name|bpl
operator|->
name|bpl_lock
argument_list|)
expr_stmt|;
name|bpe
operator|->
name|bpe_blk
operator|=
operator|*
name|bp
expr_stmt|;
name|list_insert_tail
argument_list|(
operator|&
name|bpl
operator|->
name|bpl_list
argument_list|,
name|bpe
argument_list|)
expr_stmt|;
name|mutex_exit
argument_list|(
operator|&
name|bpl
operator|->
name|bpl_lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * To aid debugging, we keep the most recently removed entry.  This way if  * we are in the callback, we can easily locate the entry.  */
end_comment

begin_decl_stmt
specifier|static
name|bplist_entry_t
modifier|*
name|bplist_iterate_last_removed
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|bplist_iterate
parameter_list|(
name|bplist_t
modifier|*
name|bpl
parameter_list|,
name|bplist_itor_t
modifier|*
name|func
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|,
name|dmu_tx_t
modifier|*
name|tx
parameter_list|)
block|{
name|bplist_entry_t
modifier|*
name|bpe
decl_stmt|;
name|mutex_enter
argument_list|(
operator|&
name|bpl
operator|->
name|bpl_lock
argument_list|)
expr_stmt|;
while|while
condition|(
name|bpe
operator|=
name|list_head
argument_list|(
operator|&
name|bpl
operator|->
name|bpl_list
argument_list|)
condition|)
block|{
name|bplist_iterate_last_removed
operator|=
name|bpe
expr_stmt|;
name|list_remove
argument_list|(
operator|&
name|bpl
operator|->
name|bpl_list
argument_list|,
name|bpe
argument_list|)
expr_stmt|;
name|mutex_exit
argument_list|(
operator|&
name|bpl
operator|->
name|bpl_lock
argument_list|)
expr_stmt|;
name|func
argument_list|(
name|arg
argument_list|,
operator|&
name|bpe
operator|->
name|bpe_blk
argument_list|,
name|tx
argument_list|)
expr_stmt|;
name|kmem_free
argument_list|(
name|bpe
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|bpe
argument_list|)
argument_list|)
expr_stmt|;
name|mutex_enter
argument_list|(
operator|&
name|bpl
operator|->
name|bpl_lock
argument_list|)
expr_stmt|;
block|}
name|mutex_exit
argument_list|(
operator|&
name|bpl
operator|->
name|bpl_lock
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


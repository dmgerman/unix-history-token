begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * CDDL HEADER START  *  * The contents of this file are subject to the terms of the  * Common Development and Distribution License (the "License").  * You may not use this file except in compliance with the License.  *  * You can obtain a copy of the license at usr/src/OPENSOLARIS.LICENSE  * or http://www.opensolaris.org/os/licensing.  * See the License for the specific language governing permissions  * and limitations under the License.  *  * When distributing Covered Code, include this CDDL HEADER in each  * file and include the License file at usr/src/OPENSOLARIS.LICENSE.  * If applicable, add the following below this CDDL HEADER, with the  * fields enclosed by brackets "[]" replaced with your own identifying  * information: Portions Copyright [yyyy] [name of copyright owner]  *  * CDDL HEADER END  */
end_comment

begin_comment
comment|/*  * Copyright (c) 2010, Oracle and/or its affiliates. All rights reserved.  */
end_comment

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/vnode.h>
end_include

begin_include
include|#
directive|include
file|<sys/sa.h>
end_include

begin_include
include|#
directive|include
file|<sys/zfs_acl.h>
end_include

begin_include
include|#
directive|include
file|<sys/zfs_sa.h>
end_include

begin_comment
comment|/*  * ZPL attribute registration table.  * Order of attributes doesn't matter  * a unique value will be assigned for each  * attribute that is file system specific  *  * This is just the set of ZPL attributes that this  * version of ZFS deals with natively.  The file system  * could have other attributes stored in files, but they will be  * ignored.  The SA framework will preserve them, just that  * this version of ZFS won't change or delete them.  */
end_comment

begin_decl_stmt
name|sa_attr_reg_t
name|zfs_attr_table
index|[
name|ZPL_END
operator|+
literal|1
index|]
init|=
block|{
block|{
literal|"ZPL_ATIME"
block|,
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
operator|*
literal|2
block|,
name|SA_UINT64_ARRAY
block|,
literal|0
block|}
block|,
block|{
literal|"ZPL_MTIME"
block|,
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
operator|*
literal|2
block|,
name|SA_UINT64_ARRAY
block|,
literal|1
block|}
block|,
block|{
literal|"ZPL_CTIME"
block|,
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
operator|*
literal|2
block|,
name|SA_UINT64_ARRAY
block|,
literal|2
block|}
block|,
block|{
literal|"ZPL_CRTIME"
block|,
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
operator|*
literal|2
block|,
name|SA_UINT64_ARRAY
block|,
literal|3
block|}
block|,
block|{
literal|"ZPL_GEN"
block|,
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
block|,
name|SA_UINT64_ARRAY
block|,
literal|4
block|}
block|,
block|{
literal|"ZPL_MODE"
block|,
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
block|,
name|SA_UINT64_ARRAY
block|,
literal|5
block|}
block|,
block|{
literal|"ZPL_SIZE"
block|,
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
block|,
name|SA_UINT64_ARRAY
block|,
literal|6
block|}
block|,
block|{
literal|"ZPL_PARENT"
block|,
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
block|,
name|SA_UINT64_ARRAY
block|,
literal|7
block|}
block|,
block|{
literal|"ZPL_LINKS"
block|,
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
block|,
name|SA_UINT64_ARRAY
block|,
literal|8
block|}
block|,
block|{
literal|"ZPL_XATTR"
block|,
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
block|,
name|SA_UINT64_ARRAY
block|,
literal|9
block|}
block|,
block|{
literal|"ZPL_RDEV"
block|,
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
block|,
name|SA_UINT64_ARRAY
block|,
literal|10
block|}
block|,
block|{
literal|"ZPL_FLAGS"
block|,
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
block|,
name|SA_UINT64_ARRAY
block|,
literal|11
block|}
block|,
block|{
literal|"ZPL_UID"
block|,
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
block|,
name|SA_UINT64_ARRAY
block|,
literal|12
block|}
block|,
block|{
literal|"ZPL_GID"
block|,
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
block|,
name|SA_UINT64_ARRAY
block|,
literal|13
block|}
block|,
block|{
literal|"ZPL_PAD"
block|,
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
operator|*
literal|4
block|,
name|SA_UINT64_ARRAY
block|,
literal|14
block|}
block|,
block|{
literal|"ZPL_ZNODE_ACL"
block|,
literal|88
block|,
name|SA_UINT8_ARRAY
block|,
literal|15
block|}
block|,
block|{
literal|"ZPL_DACL_COUNT"
block|,
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
block|,
name|SA_UINT64_ARRAY
block|,
literal|0
block|}
block|,
block|{
literal|"ZPL_SYMLINK"
block|,
literal|0
block|,
name|SA_UINT8_ARRAY
block|,
literal|0
block|}
block|,
block|{
literal|"ZPL_SCANSTAMP"
block|,
literal|32
block|,
name|SA_UINT8_ARRAY
block|,
literal|0
block|}
block|,
block|{
literal|"ZPL_DACL_ACES"
block|,
literal|0
block|,
name|SA_ACL
block|,
literal|0
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|_KERNEL
end_ifdef

begin_function
name|int
name|zfs_sa_readlink
parameter_list|(
name|znode_t
modifier|*
name|zp
parameter_list|,
name|uio_t
modifier|*
name|uio
parameter_list|)
block|{
name|dmu_buf_t
modifier|*
name|db
init|=
name|sa_get_db
argument_list|(
name|zp
operator|->
name|z_sa_hdl
argument_list|)
decl_stmt|;
name|size_t
name|bufsz
decl_stmt|;
name|int
name|error
decl_stmt|;
name|bufsz
operator|=
name|zp
operator|->
name|z_size
expr_stmt|;
if|if
condition|(
name|bufsz
operator|+
name|ZFS_OLD_ZNODE_PHYS_SIZE
operator|<=
name|db
operator|->
name|db_size
condition|)
block|{
name|error
operator|=
name|uiomove
argument_list|(
operator|(
name|caddr_t
operator|)
name|db
operator|->
name|db_data
operator|+
name|ZFS_OLD_ZNODE_PHYS_SIZE
argument_list|,
name|MIN
argument_list|(
operator|(
name|size_t
operator|)
name|bufsz
argument_list|,
name|uio
operator|->
name|uio_resid
argument_list|)
argument_list|,
name|UIO_READ
argument_list|,
name|uio
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|dmu_buf_t
modifier|*
name|dbp
decl_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|dmu_buf_hold
argument_list|(
name|zp
operator|->
name|z_zfsvfs
operator|->
name|z_os
argument_list|,
name|zp
operator|->
name|z_id
argument_list|,
literal|0
argument_list|,
name|FTAG
argument_list|,
operator|&
name|dbp
argument_list|,
name|DMU_READ_NO_PREFETCH
argument_list|)
operator|)
operator|==
literal|0
condition|)
block|{
name|error
operator|=
name|uiomove
argument_list|(
name|dbp
operator|->
name|db_data
argument_list|,
name|MIN
argument_list|(
operator|(
name|size_t
operator|)
name|bufsz
argument_list|,
name|uio
operator|->
name|uio_resid
argument_list|)
argument_list|,
name|UIO_READ
argument_list|,
name|uio
argument_list|)
expr_stmt|;
name|dmu_buf_rele
argument_list|(
name|dbp
argument_list|,
name|FTAG
argument_list|)
expr_stmt|;
block|}
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
name|void
name|zfs_sa_symlink
parameter_list|(
name|znode_t
modifier|*
name|zp
parameter_list|,
name|char
modifier|*
name|link
parameter_list|,
name|int
name|len
parameter_list|,
name|dmu_tx_t
modifier|*
name|tx
parameter_list|)
block|{
name|dmu_buf_t
modifier|*
name|db
init|=
name|sa_get_db
argument_list|(
name|zp
operator|->
name|z_sa_hdl
argument_list|)
decl_stmt|;
if|if
condition|(
name|ZFS_OLD_ZNODE_PHYS_SIZE
operator|+
name|len
operator|<=
name|dmu_bonus_max
argument_list|()
condition|)
block|{
name|VERIFY
argument_list|(
name|dmu_set_bonus
argument_list|(
name|db
argument_list|,
name|len
operator|+
name|ZFS_OLD_ZNODE_PHYS_SIZE
argument_list|,
name|tx
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
condition|)
block|{
name|bcopy
argument_list|(
name|link
argument_list|,
operator|(
name|caddr_t
operator|)
name|db
operator|->
name|db_data
operator|+
name|ZFS_OLD_ZNODE_PHYS_SIZE
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|dmu_buf_t
modifier|*
name|dbp
decl_stmt|;
name|zfs_grow_blocksize
argument_list|(
name|zp
argument_list|,
name|len
argument_list|,
name|tx
argument_list|)
expr_stmt|;
name|VERIFY
argument_list|(
literal|0
operator|==
name|dmu_buf_hold
argument_list|(
name|zp
operator|->
name|z_zfsvfs
operator|->
name|z_os
argument_list|,
name|zp
operator|->
name|z_id
argument_list|,
literal|0
argument_list|,
name|FTAG
argument_list|,
operator|&
name|dbp
argument_list|,
name|DMU_READ_NO_PREFETCH
argument_list|)
argument_list|)
expr_stmt|;
name|dmu_buf_will_dirty
argument_list|(
name|dbp
argument_list|,
name|tx
argument_list|)
expr_stmt|;
name|ASSERT3U
argument_list|(
name|len
argument_list|,
operator|<=
argument_list|,
name|dbp
operator|->
name|db_size
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|link
argument_list|,
name|dbp
operator|->
name|db_data
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|dmu_buf_rele
argument_list|(
name|dbp
argument_list|,
name|FTAG
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|zfs_sa_get_scanstamp
parameter_list|(
name|znode_t
modifier|*
name|zp
parameter_list|,
name|xvattr_t
modifier|*
name|xvap
parameter_list|)
block|{
name|zfsvfs_t
modifier|*
name|zfsvfs
init|=
name|zp
operator|->
name|z_zfsvfs
decl_stmt|;
name|xoptattr_t
modifier|*
name|xoap
decl_stmt|;
name|ASSERT
argument_list|(
name|MUTEX_HELD
argument_list|(
operator|&
name|zp
operator|->
name|z_lock
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY
argument_list|(
operator|(
name|xoap
operator|=
name|xva_getxoptattr
argument_list|(
name|xvap
argument_list|)
operator|)
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|zp
operator|->
name|z_is_sa
condition|)
block|{
if|if
condition|(
name|sa_lookup
argument_list|(
name|zp
operator|->
name|z_sa_hdl
argument_list|,
name|SA_ZPL_SCANSTAMP
argument_list|(
name|zfsvfs
argument_list|)
argument_list|,
operator|&
name|xoap
operator|->
name|xoa_av_scanstamp
argument_list|,
sizeof|sizeof
argument_list|(
name|xoap
operator|->
name|xoa_av_scanstamp
argument_list|)
argument_list|)
operator|!=
literal|0
condition|)
return|return;
block|}
else|else
block|{
name|dmu_object_info_t
name|doi
decl_stmt|;
name|dmu_buf_t
modifier|*
name|db
init|=
name|sa_get_db
argument_list|(
name|zp
operator|->
name|z_sa_hdl
argument_list|)
decl_stmt|;
name|int
name|len
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|zp
operator|->
name|z_pflags
operator|&
name|ZFS_BONUS_SCANSTAMP
operator|)
condition|)
return|return;
name|sa_object_info
argument_list|(
name|zp
operator|->
name|z_sa_hdl
argument_list|,
operator|&
name|doi
argument_list|)
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
name|xoap
operator|->
name|xoa_av_scanstamp
argument_list|)
operator|+
name|ZFS_OLD_ZNODE_PHYS_SIZE
expr_stmt|;
if|if
condition|(
name|len
operator|<=
name|doi
operator|.
name|doi_bonus_size
condition|)
block|{
operator|(
name|void
operator|)
name|memcpy
argument_list|(
name|xoap
operator|->
name|xoa_av_scanstamp
argument_list|,
operator|(
name|caddr_t
operator|)
name|db
operator|->
name|db_data
operator|+
name|ZFS_OLD_ZNODE_PHYS_SIZE
argument_list|,
sizeof|sizeof
argument_list|(
name|xoap
operator|->
name|xoa_av_scanstamp
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
name|XVA_SET_RTN
argument_list|(
name|xvap
argument_list|,
name|XAT_AV_SCANSTAMP
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|zfs_sa_set_scanstamp
parameter_list|(
name|znode_t
modifier|*
name|zp
parameter_list|,
name|xvattr_t
modifier|*
name|xvap
parameter_list|,
name|dmu_tx_t
modifier|*
name|tx
parameter_list|)
block|{
name|zfsvfs_t
modifier|*
name|zfsvfs
init|=
name|zp
operator|->
name|z_zfsvfs
decl_stmt|;
name|xoptattr_t
modifier|*
name|xoap
decl_stmt|;
name|ASSERT
argument_list|(
name|MUTEX_HELD
argument_list|(
operator|&
name|zp
operator|->
name|z_lock
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY
argument_list|(
operator|(
name|xoap
operator|=
name|xva_getxoptattr
argument_list|(
name|xvap
argument_list|)
operator|)
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|zp
operator|->
name|z_is_sa
condition|)
name|VERIFY
argument_list|(
literal|0
operator|==
name|sa_update
argument_list|(
name|zp
operator|->
name|z_sa_hdl
argument_list|,
name|SA_ZPL_SCANSTAMP
argument_list|(
name|zfsvfs
argument_list|)
argument_list|,
operator|&
name|xoap
operator|->
name|xoa_av_scanstamp
argument_list|,
sizeof|sizeof
argument_list|(
name|xoap
operator|->
name|xoa_av_scanstamp
argument_list|)
argument_list|,
name|tx
argument_list|)
argument_list|)
expr_stmt|;
else|else
block|{
name|dmu_object_info_t
name|doi
decl_stmt|;
name|dmu_buf_t
modifier|*
name|db
init|=
name|sa_get_db
argument_list|(
name|zp
operator|->
name|z_sa_hdl
argument_list|)
decl_stmt|;
name|int
name|len
decl_stmt|;
name|sa_object_info
argument_list|(
name|zp
operator|->
name|z_sa_hdl
argument_list|,
operator|&
name|doi
argument_list|)
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
name|xoap
operator|->
name|xoa_av_scanstamp
argument_list|)
operator|+
name|ZFS_OLD_ZNODE_PHYS_SIZE
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|doi
operator|.
name|doi_bonus_size
condition|)
name|VERIFY
argument_list|(
name|dmu_set_bonus
argument_list|(
name|db
argument_list|,
name|len
argument_list|,
name|tx
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|memcpy
argument_list|(
operator|(
name|caddr_t
operator|)
name|db
operator|->
name|db_data
operator|+
name|ZFS_OLD_ZNODE_PHYS_SIZE
argument_list|,
name|xoap
operator|->
name|xoa_av_scanstamp
argument_list|,
sizeof|sizeof
argument_list|(
name|xoap
operator|->
name|xoa_av_scanstamp
argument_list|)
argument_list|)
expr_stmt|;
name|zp
operator|->
name|z_pflags
operator||=
name|ZFS_BONUS_SCANSTAMP
expr_stmt|;
name|VERIFY
argument_list|(
literal|0
operator|==
name|sa_update
argument_list|(
name|zp
operator|->
name|z_sa_hdl
argument_list|,
name|SA_ZPL_FLAGS
argument_list|(
name|zfsvfs
argument_list|)
argument_list|,
operator|&
name|zp
operator|->
name|z_pflags
argument_list|,
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
argument_list|,
name|tx
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * I'm not convinced we should do any of this upgrade.  * since the SA code can read both old/new znode formats  * with probably little to no performance difference.  *  * All new files will be created with the new format.  */
end_comment

begin_function
name|void
name|zfs_sa_upgrade
parameter_list|(
name|sa_handle_t
modifier|*
name|hdl
parameter_list|,
name|dmu_tx_t
modifier|*
name|tx
parameter_list|)
block|{
name|dmu_buf_t
modifier|*
name|db
init|=
name|sa_get_db
argument_list|(
name|hdl
argument_list|)
decl_stmt|;
name|znode_t
modifier|*
name|zp
init|=
name|sa_get_userdata
argument_list|(
name|hdl
argument_list|)
decl_stmt|;
name|zfsvfs_t
modifier|*
name|zfsvfs
init|=
name|zp
operator|->
name|z_zfsvfs
decl_stmt|;
name|sa_bulk_attr_t
name|bulk
index|[
literal|20
index|]
decl_stmt|;
name|int
name|count
init|=
literal|0
decl_stmt|;
name|sa_bulk_attr_t
name|sa_attrs
index|[
literal|20
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
name|zfs_acl_locator_cb_t
name|locate
init|=
block|{
literal|0
block|}
decl_stmt|;
name|uint64_t
name|uid
decl_stmt|,
name|gid
decl_stmt|,
name|mode
decl_stmt|,
name|rdev
decl_stmt|,
name|xattr
decl_stmt|,
name|parent
decl_stmt|;
name|uint64_t
name|crtime
index|[
literal|2
index|]
decl_stmt|,
name|mtime
index|[
literal|2
index|]
decl_stmt|,
name|ctime
index|[
literal|2
index|]
decl_stmt|;
name|zfs_acl_phys_t
name|znode_acl
decl_stmt|;
name|char
name|scanstamp
index|[
name|AV_SCANSTAMP_SZ
index|]
decl_stmt|;
name|boolean_t
name|drop_lock
init|=
name|B_FALSE
decl_stmt|;
comment|/* 	 * No upgrade if ACL isn't cached 	 * since we won't know which locks are held 	 * and ready the ACL would require special "locked" 	 * interfaces that would be messy 	 */
if|if
condition|(
name|zp
operator|->
name|z_acl_cached
operator|==
name|NULL
operator|||
name|ZTOV
argument_list|(
name|zp
argument_list|)
operator|->
name|v_type
operator|==
name|VLNK
condition|)
return|return;
comment|/* 	 * If the z_lock is held and we aren't the owner 	 * the just return since we don't want to deadlock 	 * trying to update the status of z_is_sa.  This 	 * file can then be upgraded at a later time. 	 * 	 * Otherwise, we know we are doing the 	 * sa_update() that caused us to enter this function. 	 */
if|if
condition|(
name|mutex_owner
argument_list|(
operator|&
name|zp
operator|->
name|z_lock
argument_list|)
operator|!=
name|curthread
condition|)
block|{
if|if
condition|(
name|mutex_tryenter
argument_list|(
operator|&
name|zp
operator|->
name|z_lock
argument_list|)
operator|==
literal|0
condition|)
return|return;
else|else
name|drop_lock
operator|=
name|B_TRUE
expr_stmt|;
block|}
comment|/* First do a bulk query of the attributes that aren't cached */
name|SA_ADD_BULK_ATTR
argument_list|(
name|bulk
argument_list|,
name|count
argument_list|,
name|SA_ZPL_MTIME
argument_list|(
name|zfsvfs
argument_list|)
argument_list|,
name|NULL
argument_list|,
operator|&
name|mtime
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|SA_ADD_BULK_ATTR
argument_list|(
name|bulk
argument_list|,
name|count
argument_list|,
name|SA_ZPL_CTIME
argument_list|(
name|zfsvfs
argument_list|)
argument_list|,
name|NULL
argument_list|,
operator|&
name|ctime
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|SA_ADD_BULK_ATTR
argument_list|(
name|bulk
argument_list|,
name|count
argument_list|,
name|SA_ZPL_CRTIME
argument_list|(
name|zfsvfs
argument_list|)
argument_list|,
name|NULL
argument_list|,
operator|&
name|crtime
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|SA_ADD_BULK_ATTR
argument_list|(
name|bulk
argument_list|,
name|count
argument_list|,
name|SA_ZPL_MODE
argument_list|(
name|zfsvfs
argument_list|)
argument_list|,
name|NULL
argument_list|,
operator|&
name|mode
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|SA_ADD_BULK_ATTR
argument_list|(
name|bulk
argument_list|,
name|count
argument_list|,
name|SA_ZPL_PARENT
argument_list|(
name|zfsvfs
argument_list|)
argument_list|,
name|NULL
argument_list|,
operator|&
name|parent
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|SA_ADD_BULK_ATTR
argument_list|(
name|bulk
argument_list|,
name|count
argument_list|,
name|SA_ZPL_XATTR
argument_list|(
name|zfsvfs
argument_list|)
argument_list|,
name|NULL
argument_list|,
operator|&
name|xattr
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|SA_ADD_BULK_ATTR
argument_list|(
name|bulk
argument_list|,
name|count
argument_list|,
name|SA_ZPL_RDEV
argument_list|(
name|zfsvfs
argument_list|)
argument_list|,
name|NULL
argument_list|,
operator|&
name|rdev
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|SA_ADD_BULK_ATTR
argument_list|(
name|bulk
argument_list|,
name|count
argument_list|,
name|SA_ZPL_UID
argument_list|(
name|zfsvfs
argument_list|)
argument_list|,
name|NULL
argument_list|,
operator|&
name|uid
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|SA_ADD_BULK_ATTR
argument_list|(
name|bulk
argument_list|,
name|count
argument_list|,
name|SA_ZPL_GID
argument_list|(
name|zfsvfs
argument_list|)
argument_list|,
name|NULL
argument_list|,
operator|&
name|gid
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|SA_ADD_BULK_ATTR
argument_list|(
name|bulk
argument_list|,
name|count
argument_list|,
name|SA_ZPL_ZNODE_ACL
argument_list|(
name|zfsvfs
argument_list|)
argument_list|,
name|NULL
argument_list|,
operator|&
name|znode_acl
argument_list|,
literal|88
argument_list|)
expr_stmt|;
if|if
condition|(
name|sa_bulk_lookup_locked
argument_list|(
name|hdl
argument_list|,
name|bulk
argument_list|,
name|count
argument_list|)
operator|!=
literal|0
condition|)
goto|goto
name|done
goto|;
comment|/* 	 * While the order here doesn't matter its best to try and organize 	 * it is such a way to pick up an already existing layout number 	 */
name|count
operator|=
literal|0
expr_stmt|;
name|SA_ADD_BULK_ATTR
argument_list|(
name|sa_attrs
argument_list|,
name|count
argument_list|,
name|SA_ZPL_MODE
argument_list|(
name|zfsvfs
argument_list|)
argument_list|,
name|NULL
argument_list|,
operator|&
name|mode
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|SA_ADD_BULK_ATTR
argument_list|(
name|sa_attrs
argument_list|,
name|count
argument_list|,
name|SA_ZPL_SIZE
argument_list|(
name|zfsvfs
argument_list|)
argument_list|,
name|NULL
argument_list|,
operator|&
name|zp
operator|->
name|z_size
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|SA_ADD_BULK_ATTR
argument_list|(
name|sa_attrs
argument_list|,
name|count
argument_list|,
name|SA_ZPL_GEN
argument_list|(
name|zfsvfs
argument_list|)
argument_list|,
name|NULL
argument_list|,
operator|&
name|zp
operator|->
name|z_gen
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|SA_ADD_BULK_ATTR
argument_list|(
name|sa_attrs
argument_list|,
name|count
argument_list|,
name|SA_ZPL_UID
argument_list|(
name|zfsvfs
argument_list|)
argument_list|,
name|NULL
argument_list|,
operator|&
name|uid
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|SA_ADD_BULK_ATTR
argument_list|(
name|sa_attrs
argument_list|,
name|count
argument_list|,
name|SA_ZPL_GID
argument_list|(
name|zfsvfs
argument_list|)
argument_list|,
name|NULL
argument_list|,
operator|&
name|gid
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|SA_ADD_BULK_ATTR
argument_list|(
name|sa_attrs
argument_list|,
name|count
argument_list|,
name|SA_ZPL_PARENT
argument_list|(
name|zfsvfs
argument_list|)
argument_list|,
name|NULL
argument_list|,
operator|&
name|parent
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|SA_ADD_BULK_ATTR
argument_list|(
name|sa_attrs
argument_list|,
name|count
argument_list|,
name|SA_ZPL_FLAGS
argument_list|(
name|zfsvfs
argument_list|)
argument_list|,
name|NULL
argument_list|,
operator|&
name|zp
operator|->
name|z_pflags
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|SA_ADD_BULK_ATTR
argument_list|(
name|sa_attrs
argument_list|,
name|count
argument_list|,
name|SA_ZPL_ATIME
argument_list|(
name|zfsvfs
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|zp
operator|->
name|z_atime
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|SA_ADD_BULK_ATTR
argument_list|(
name|sa_attrs
argument_list|,
name|count
argument_list|,
name|SA_ZPL_MTIME
argument_list|(
name|zfsvfs
argument_list|)
argument_list|,
name|NULL
argument_list|,
operator|&
name|mtime
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|SA_ADD_BULK_ATTR
argument_list|(
name|sa_attrs
argument_list|,
name|count
argument_list|,
name|SA_ZPL_CTIME
argument_list|(
name|zfsvfs
argument_list|)
argument_list|,
name|NULL
argument_list|,
operator|&
name|ctime
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|SA_ADD_BULK_ATTR
argument_list|(
name|sa_attrs
argument_list|,
name|count
argument_list|,
name|SA_ZPL_CRTIME
argument_list|(
name|zfsvfs
argument_list|)
argument_list|,
name|NULL
argument_list|,
operator|&
name|crtime
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|SA_ADD_BULK_ATTR
argument_list|(
name|sa_attrs
argument_list|,
name|count
argument_list|,
name|SA_ZPL_LINKS
argument_list|(
name|zfsvfs
argument_list|)
argument_list|,
name|NULL
argument_list|,
operator|&
name|zp
operator|->
name|z_links
argument_list|,
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|zp
operator|->
name|z_vnode
operator|->
name|v_type
operator|==
name|VBLK
operator|||
name|zp
operator|->
name|z_vnode
operator|->
name|v_type
operator|==
name|VCHR
condition|)
name|SA_ADD_BULK_ATTR
argument_list|(
name|sa_attrs
argument_list|,
name|count
argument_list|,
name|SA_ZPL_RDEV
argument_list|(
name|zfsvfs
argument_list|)
argument_list|,
name|NULL
argument_list|,
operator|&
name|rdev
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|SA_ADD_BULK_ATTR
argument_list|(
name|sa_attrs
argument_list|,
name|count
argument_list|,
name|SA_ZPL_DACL_COUNT
argument_list|(
name|zfsvfs
argument_list|)
argument_list|,
name|NULL
argument_list|,
operator|&
name|zp
operator|->
name|z_acl_cached
operator|->
name|z_acl_count
argument_list|,
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|zp
operator|->
name|z_acl_cached
operator|->
name|z_version
operator|<
name|ZFS_ACL_VERSION_FUID
condition|)
name|zfs_acl_xform
argument_list|(
name|zp
argument_list|,
name|zp
operator|->
name|z_acl_cached
argument_list|,
name|CRED
argument_list|()
argument_list|)
expr_stmt|;
name|locate
operator|.
name|cb_aclp
operator|=
name|zp
operator|->
name|z_acl_cached
expr_stmt|;
name|SA_ADD_BULK_ATTR
argument_list|(
name|sa_attrs
argument_list|,
name|count
argument_list|,
name|SA_ZPL_DACL_ACES
argument_list|(
name|zfsvfs
argument_list|)
argument_list|,
name|zfs_acl_data_locator
argument_list|,
operator|&
name|locate
argument_list|,
name|zp
operator|->
name|z_acl_cached
operator|->
name|z_acl_bytes
argument_list|)
expr_stmt|;
if|if
condition|(
name|xattr
condition|)
name|SA_ADD_BULK_ATTR
argument_list|(
name|sa_attrs
argument_list|,
name|count
argument_list|,
name|SA_ZPL_XATTR
argument_list|(
name|zfsvfs
argument_list|)
argument_list|,
name|NULL
argument_list|,
operator|&
name|xattr
argument_list|,
literal|8
argument_list|)
expr_stmt|;
comment|/* if scanstamp then add scanstamp */
if|if
condition|(
name|zp
operator|->
name|z_pflags
operator|&
name|ZFS_BONUS_SCANSTAMP
condition|)
block|{
name|bcopy
argument_list|(
operator|(
name|caddr_t
operator|)
name|db
operator|->
name|db_data
operator|+
name|ZFS_OLD_ZNODE_PHYS_SIZE
argument_list|,
name|scanstamp
argument_list|,
name|AV_SCANSTAMP_SZ
argument_list|)
expr_stmt|;
name|SA_ADD_BULK_ATTR
argument_list|(
name|sa_attrs
argument_list|,
name|count
argument_list|,
name|SA_ZPL_SCANSTAMP
argument_list|(
name|zfsvfs
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|scanstamp
argument_list|,
name|AV_SCANSTAMP_SZ
argument_list|)
expr_stmt|;
name|zp
operator|->
name|z_pflags
operator|&=
operator|~
name|ZFS_BONUS_SCANSTAMP
expr_stmt|;
block|}
name|VERIFY
argument_list|(
name|dmu_set_bonustype
argument_list|(
name|db
argument_list|,
name|DMU_OT_SA
argument_list|,
name|tx
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|VERIFY
argument_list|(
name|sa_replace_all_by_template_locked
argument_list|(
name|hdl
argument_list|,
name|sa_attrs
argument_list|,
name|count
argument_list|,
name|tx
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|znode_acl
operator|.
name|z_acl_extern_obj
condition|)
name|VERIFY
argument_list|(
literal|0
operator|==
name|dmu_object_free
argument_list|(
name|zfsvfs
operator|->
name|z_os
argument_list|,
name|znode_acl
operator|.
name|z_acl_extern_obj
argument_list|,
name|tx
argument_list|)
argument_list|)
expr_stmt|;
name|zp
operator|->
name|z_is_sa
operator|=
name|B_TRUE
expr_stmt|;
name|done
label|:
if|if
condition|(
name|drop_lock
condition|)
name|mutex_exit
argument_list|(
operator|&
name|zp
operator|->
name|z_lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|zfs_sa_upgrade_txholds
parameter_list|(
name|dmu_tx_t
modifier|*
name|tx
parameter_list|,
name|znode_t
modifier|*
name|zp
parameter_list|)
block|{
if|if
condition|(
operator|!
name|zp
operator|->
name|z_zfsvfs
operator|->
name|z_use_sa
operator|||
name|zp
operator|->
name|z_is_sa
condition|)
return|return;
name|dmu_tx_hold_sa
argument_list|(
name|tx
argument_list|,
name|zp
operator|->
name|z_sa_hdl
argument_list|,
name|B_TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|zfs_external_acl
argument_list|(
name|zp
argument_list|)
condition|)
block|{
name|dmu_tx_hold_free
argument_list|(
name|tx
argument_list|,
name|zfs_external_acl
argument_list|(
name|zp
argument_list|)
argument_list|,
literal|0
argument_list|,
name|DMU_OBJECT_END
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * CDDL HEADER START  *  * The contents of this file are subject to the terms of the  * Common Development and Distribution License (the "License").  * You may not use this file except in compliance with the License.  *  * You can obtain a copy of the license at usr/src/OPENSOLARIS.LICENSE  * or http://www.opensolaris.org/os/licensing.  * See the License for the specific language governing permissions  * and limitations under the License.  *  * When distributing Covered Code, include this CDDL HEADER in each  * file and include the License file at usr/src/OPENSOLARIS.LICENSE.  * If applicable, add the following below this CDDL HEADER, with the  * fields enclosed by brackets "[]" replaced with your own identifying  * information: Portions Copyright [yyyy] [name of copyright owner]  *  * CDDL HEADER END  */
end_comment

begin_comment
comment|/*  * Copyright (c) 2009, 2010, Oracle and/or its affiliates. All rights reserved.  */
end_comment

begin_include
include|#
directive|include
file|<sys/zfs_context.h>
end_include

begin_include
include|#
directive|include
file|<sys/spa.h>
end_include

begin_include
include|#
directive|include
file|<sys/zio.h>
end_include

begin_include
include|#
directive|include
file|<sys/ddt.h>
end_include

begin_include
include|#
directive|include
file|<sys/zap.h>
end_include

begin_include
include|#
directive|include
file|<sys/dmu_tx.h>
end_include

begin_decl_stmt
name|int
name|ddt_zap_leaf_blockshift
init|=
literal|12
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|ddt_zap_indirect_blockshift
init|=
literal|12
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|ddt_zap_create
parameter_list|(
name|objset_t
modifier|*
name|os
parameter_list|,
name|uint64_t
modifier|*
name|objectp
parameter_list|,
name|dmu_tx_t
modifier|*
name|tx
parameter_list|,
name|boolean_t
name|prehash
parameter_list|)
block|{
name|zap_flags_t
name|flags
init|=
name|ZAP_FLAG_HASH64
operator||
name|ZAP_FLAG_UINT64_KEY
decl_stmt|;
if|if
condition|(
name|prehash
condition|)
name|flags
operator||=
name|ZAP_FLAG_PRE_HASHED_KEY
expr_stmt|;
operator|*
name|objectp
operator|=
name|zap_create_flags
argument_list|(
name|os
argument_list|,
literal|0
argument_list|,
name|flags
argument_list|,
name|DMU_OT_DDT_ZAP
argument_list|,
name|ddt_zap_leaf_blockshift
argument_list|,
name|ddt_zap_indirect_blockshift
argument_list|,
name|DMU_OT_NONE
argument_list|,
literal|0
argument_list|,
name|tx
argument_list|)
expr_stmt|;
return|return
operator|(
operator|*
name|objectp
operator|==
literal|0
condition|?
name|ENOTSUP
else|:
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ddt_zap_destroy
parameter_list|(
name|objset_t
modifier|*
name|os
parameter_list|,
name|uint64_t
name|object
parameter_list|,
name|dmu_tx_t
modifier|*
name|tx
parameter_list|)
block|{
return|return
operator|(
name|zap_destroy
argument_list|(
name|os
argument_list|,
name|object
argument_list|,
name|tx
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ddt_zap_lookup
parameter_list|(
name|objset_t
modifier|*
name|os
parameter_list|,
name|uint64_t
name|object
parameter_list|,
name|ddt_entry_t
modifier|*
name|dde
parameter_list|)
block|{
name|uchar_t
name|cbuf
index|[
sizeof|sizeof
argument_list|(
name|dde
operator|->
name|dde_phys
argument_list|)
operator|+
literal|1
index|]
decl_stmt|;
name|uint64_t
name|one
decl_stmt|,
name|csize
decl_stmt|;
name|int
name|error
decl_stmt|;
name|error
operator|=
name|zap_length_uint64
argument_list|(
name|os
argument_list|,
name|object
argument_list|,
operator|(
name|uint64_t
operator|*
operator|)
operator|&
name|dde
operator|->
name|dde_key
argument_list|,
name|DDT_KEY_WORDS
argument_list|,
operator|&
name|one
argument_list|,
operator|&
name|csize
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|ASSERT
argument_list|(
name|one
operator|==
literal|1
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|csize
operator|<=
sizeof|sizeof
argument_list|(
name|cbuf
argument_list|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|zap_lookup_uint64
argument_list|(
name|os
argument_list|,
name|object
argument_list|,
operator|(
name|uint64_t
operator|*
operator|)
operator|&
name|dde
operator|->
name|dde_key
argument_list|,
name|DDT_KEY_WORDS
argument_list|,
literal|1
argument_list|,
name|csize
argument_list|,
name|cbuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|ddt_decompress
argument_list|(
name|cbuf
argument_list|,
name|dde
operator|->
name|dde_phys
argument_list|,
name|csize
argument_list|,
sizeof|sizeof
argument_list|(
name|dde
operator|->
name|dde_phys
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ddt_zap_prefetch
parameter_list|(
name|objset_t
modifier|*
name|os
parameter_list|,
name|uint64_t
name|object
parameter_list|,
name|ddt_entry_t
modifier|*
name|dde
parameter_list|)
block|{
operator|(
name|void
operator|)
name|zap_prefetch_uint64
argument_list|(
name|os
argument_list|,
name|object
argument_list|,
operator|(
name|uint64_t
operator|*
operator|)
operator|&
name|dde
operator|->
name|dde_key
argument_list|,
name|DDT_KEY_WORDS
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|ddt_zap_update
parameter_list|(
name|objset_t
modifier|*
name|os
parameter_list|,
name|uint64_t
name|object
parameter_list|,
name|ddt_entry_t
modifier|*
name|dde
parameter_list|,
name|dmu_tx_t
modifier|*
name|tx
parameter_list|)
block|{
name|uchar_t
name|cbuf
index|[
sizeof|sizeof
argument_list|(
name|dde
operator|->
name|dde_phys
argument_list|)
operator|+
literal|1
index|]
decl_stmt|;
name|uint64_t
name|csize
decl_stmt|;
name|csize
operator|=
name|ddt_compress
argument_list|(
name|dde
operator|->
name|dde_phys
argument_list|,
name|cbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|dde
operator|->
name|dde_phys
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|cbuf
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|zap_update_uint64
argument_list|(
name|os
argument_list|,
name|object
argument_list|,
operator|(
name|uint64_t
operator|*
operator|)
operator|&
name|dde
operator|->
name|dde_key
argument_list|,
name|DDT_KEY_WORDS
argument_list|,
literal|1
argument_list|,
name|csize
argument_list|,
name|cbuf
argument_list|,
name|tx
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ddt_zap_remove
parameter_list|(
name|objset_t
modifier|*
name|os
parameter_list|,
name|uint64_t
name|object
parameter_list|,
name|ddt_entry_t
modifier|*
name|dde
parameter_list|,
name|dmu_tx_t
modifier|*
name|tx
parameter_list|)
block|{
return|return
operator|(
name|zap_remove_uint64
argument_list|(
name|os
argument_list|,
name|object
argument_list|,
operator|(
name|uint64_t
operator|*
operator|)
operator|&
name|dde
operator|->
name|dde_key
argument_list|,
name|DDT_KEY_WORDS
argument_list|,
name|tx
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ddt_zap_walk
parameter_list|(
name|objset_t
modifier|*
name|os
parameter_list|,
name|uint64_t
name|object
parameter_list|,
name|ddt_entry_t
modifier|*
name|dde
parameter_list|,
name|uint64_t
modifier|*
name|walk
parameter_list|)
block|{
name|zap_cursor_t
name|zc
decl_stmt|;
name|zap_attribute_t
name|za
decl_stmt|;
name|int
name|error
decl_stmt|;
name|zap_cursor_init_serialized
argument_list|(
operator|&
name|zc
argument_list|,
name|os
argument_list|,
name|object
argument_list|,
operator|*
name|walk
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|zap_cursor_retrieve
argument_list|(
operator|&
name|zc
argument_list|,
operator|&
name|za
argument_list|)
operator|)
operator|==
literal|0
condition|)
block|{
name|uchar_t
name|cbuf
index|[
sizeof|sizeof
argument_list|(
name|dde
operator|->
name|dde_phys
argument_list|)
operator|+
literal|1
index|]
decl_stmt|;
name|uint64_t
name|csize
init|=
name|za
operator|.
name|za_num_integers
decl_stmt|;
name|ASSERT
argument_list|(
name|za
operator|.
name|za_integer_length
operator|==
literal|1
argument_list|)
expr_stmt|;
name|error
operator|=
name|zap_lookup_uint64
argument_list|(
name|os
argument_list|,
name|object
argument_list|,
operator|(
name|uint64_t
operator|*
operator|)
name|za
operator|.
name|za_name
argument_list|,
name|DDT_KEY_WORDS
argument_list|,
literal|1
argument_list|,
name|csize
argument_list|,
name|cbuf
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|error
operator|==
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
block|{
name|ddt_decompress
argument_list|(
name|cbuf
argument_list|,
name|dde
operator|->
name|dde_phys
argument_list|,
name|csize
argument_list|,
sizeof|sizeof
argument_list|(
name|dde
operator|->
name|dde_phys
argument_list|)
argument_list|)
expr_stmt|;
name|dde
operator|->
name|dde_key
operator|=
operator|*
operator|(
name|ddt_key_t
operator|*
operator|)
name|za
operator|.
name|za_name
expr_stmt|;
block|}
name|zap_cursor_advance
argument_list|(
operator|&
name|zc
argument_list|)
expr_stmt|;
operator|*
name|walk
operator|=
name|zap_cursor_serialize
argument_list|(
operator|&
name|zc
argument_list|)
expr_stmt|;
block|}
name|zap_cursor_fini
argument_list|(
operator|&
name|zc
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint64_t
name|ddt_zap_count
parameter_list|(
name|objset_t
modifier|*
name|os
parameter_list|,
name|uint64_t
name|object
parameter_list|)
block|{
name|uint64_t
name|count
init|=
literal|0
decl_stmt|;
name|VERIFY
argument_list|(
name|zap_count
argument_list|(
name|os
argument_list|,
name|object
argument_list|,
operator|&
name|count
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|count
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|const
name|ddt_ops_t
name|ddt_zap_ops
init|=
block|{
literal|"zap"
block|,
name|ddt_zap_create
block|,
name|ddt_zap_destroy
block|,
name|ddt_zap_lookup
block|,
name|ddt_zap_prefetch
block|,
name|ddt_zap_update
block|,
name|ddt_zap_remove
block|,
name|ddt_zap_walk
block|,
name|ddt_zap_count
block|, }
decl_stmt|;
end_decl_stmt

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * CDDL HEADER START  *  * The contents of this file are subject to the terms of the  * Common Development and Distribution License (the "License").  * You may not use this file except in compliance with the License.  *  * You can obtain a copy of the license at usr/src/OPENSOLARIS.LICENSE  * or http://www.opensolaris.org/os/licensing.  * See the License for the specific language governing permissions  * and limitations under the License.  *  * When distributing Covered Code, include this CDDL HEADER in each  * file and include the License file at usr/src/OPENSOLARIS.LICENSE.  * If applicable, add the following below this CDDL HEADER, with the  * fields enclosed by brackets "[]" replaced with your own identifying  * information: Portions Copyright [yyyy] [name of copyright owner]  *  * CDDL HEADER END  */
end_comment

begin_comment
comment|/*  * Copyright (c) 2010, Oracle and/or its affiliates. All rights reserved.  * Copyright (c) 2012 by Delphix. All rights reserved.  */
end_comment

begin_include
include|#
directive|include
file|<sys/dsl_dataset.h>
end_include

begin_include
include|#
directive|include
file|<sys/dmu.h>
end_include

begin_include
include|#
directive|include
file|<sys/refcount.h>
end_include

begin_include
include|#
directive|include
file|<sys/zap.h>
end_include

begin_include
include|#
directive|include
file|<sys/zfs_context.h>
end_include

begin_include
include|#
directive|include
file|<sys/dsl_pool.h>
end_include

begin_comment
comment|/*  * Deadlist concurrency:  *  * Deadlists can only be modified from the syncing thread.  *  * Except for dsl_deadlist_insert(), it can only be modified with the  * dp_config_rwlock held with RW_WRITER.  *  * The accessors (dsl_deadlist_space() and dsl_deadlist_space_range()) can  * be called concurrently, from open context, with the dl_config_rwlock held  * with RW_READER.  *  * Therefore, we only need to provide locking between dsl_deadlist_insert() and  * the accessors, protecting:  *     dl_phys->dl_used,comp,uncomp  *     and protecting the dl_tree from being loaded.  * The locking is provided by dl_lock.  Note that locking on the bpobj_t  * provides its own locking, and dl_oldfmt is immutable.  */
end_comment

begin_function
specifier|static
name|int
name|dsl_deadlist_compare
parameter_list|(
specifier|const
name|void
modifier|*
name|arg1
parameter_list|,
specifier|const
name|void
modifier|*
name|arg2
parameter_list|)
block|{
specifier|const
name|dsl_deadlist_entry_t
modifier|*
name|dle1
init|=
name|arg1
decl_stmt|;
specifier|const
name|dsl_deadlist_entry_t
modifier|*
name|dle2
init|=
name|arg2
decl_stmt|;
if|if
condition|(
name|dle1
operator|->
name|dle_mintxg
operator|<
name|dle2
operator|->
name|dle_mintxg
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
elseif|else
if|if
condition|(
name|dle1
operator|->
name|dle_mintxg
operator|>
name|dle2
operator|->
name|dle_mintxg
condition|)
return|return
operator|(
operator|+
literal|1
operator|)
return|;
else|else
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|dsl_deadlist_load_tree
parameter_list|(
name|dsl_deadlist_t
modifier|*
name|dl
parameter_list|)
block|{
name|zap_cursor_t
name|zc
decl_stmt|;
name|zap_attribute_t
name|za
decl_stmt|;
name|ASSERT
argument_list|(
operator|!
name|dl
operator|->
name|dl_oldfmt
argument_list|)
expr_stmt|;
if|if
condition|(
name|dl
operator|->
name|dl_havetree
condition|)
return|return;
name|avl_create
argument_list|(
operator|&
name|dl
operator|->
name|dl_tree
argument_list|,
name|dsl_deadlist_compare
argument_list|,
sizeof|sizeof
argument_list|(
name|dsl_deadlist_entry_t
argument_list|)
argument_list|,
name|offsetof
argument_list|(
name|dsl_deadlist_entry_t
argument_list|,
name|dle_node
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|zap_cursor_init
argument_list|(
operator|&
name|zc
argument_list|,
name|dl
operator|->
name|dl_os
argument_list|,
name|dl
operator|->
name|dl_object
argument_list|)
init|;
name|zap_cursor_retrieve
argument_list|(
operator|&
name|zc
argument_list|,
operator|&
name|za
argument_list|)
operator|==
literal|0
condition|;
name|zap_cursor_advance
argument_list|(
operator|&
name|zc
argument_list|)
control|)
block|{
name|dsl_deadlist_entry_t
modifier|*
name|dle
init|=
name|kmem_alloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|dle
argument_list|)
argument_list|,
name|KM_SLEEP
argument_list|)
decl_stmt|;
name|dle
operator|->
name|dle_mintxg
operator|=
name|strtonum
argument_list|(
name|za
operator|.
name|za_name
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|VERIFY3U
argument_list|(
literal|0
argument_list|,
operator|==
argument_list|,
name|bpobj_open
argument_list|(
operator|&
name|dle
operator|->
name|dle_bpobj
argument_list|,
name|dl
operator|->
name|dl_os
argument_list|,
name|za
operator|.
name|za_first_integer
argument_list|)
argument_list|)
expr_stmt|;
name|avl_add
argument_list|(
operator|&
name|dl
operator|->
name|dl_tree
argument_list|,
name|dle
argument_list|)
expr_stmt|;
block|}
name|zap_cursor_fini
argument_list|(
operator|&
name|zc
argument_list|)
expr_stmt|;
name|dl
operator|->
name|dl_havetree
operator|=
name|B_TRUE
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dsl_deadlist_open
parameter_list|(
name|dsl_deadlist_t
modifier|*
name|dl
parameter_list|,
name|objset_t
modifier|*
name|os
parameter_list|,
name|uint64_t
name|object
parameter_list|)
block|{
name|dmu_object_info_t
name|doi
decl_stmt|;
name|mutex_init
argument_list|(
operator|&
name|dl
operator|->
name|dl_lock
argument_list|,
name|NULL
argument_list|,
name|MUTEX_DEFAULT
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|dl
operator|->
name|dl_os
operator|=
name|os
expr_stmt|;
name|dl
operator|->
name|dl_object
operator|=
name|object
expr_stmt|;
name|VERIFY3U
argument_list|(
literal|0
argument_list|,
operator|==
argument_list|,
name|dmu_bonus_hold
argument_list|(
name|os
argument_list|,
name|object
argument_list|,
name|dl
argument_list|,
operator|&
name|dl
operator|->
name|dl_dbuf
argument_list|)
argument_list|)
expr_stmt|;
name|dmu_object_info_from_db
argument_list|(
name|dl
operator|->
name|dl_dbuf
argument_list|,
operator|&
name|doi
argument_list|)
expr_stmt|;
if|if
condition|(
name|doi
operator|.
name|doi_type
operator|==
name|DMU_OT_BPOBJ
condition|)
block|{
name|dmu_buf_rele
argument_list|(
name|dl
operator|->
name|dl_dbuf
argument_list|,
name|dl
argument_list|)
expr_stmt|;
name|dl
operator|->
name|dl_dbuf
operator|=
name|NULL
expr_stmt|;
name|dl
operator|->
name|dl_oldfmt
operator|=
name|B_TRUE
expr_stmt|;
name|VERIFY3U
argument_list|(
literal|0
argument_list|,
operator|==
argument_list|,
name|bpobj_open
argument_list|(
operator|&
name|dl
operator|->
name|dl_bpobj
argument_list|,
name|os
argument_list|,
name|object
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|dl
operator|->
name|dl_oldfmt
operator|=
name|B_FALSE
expr_stmt|;
name|dl
operator|->
name|dl_phys
operator|=
name|dl
operator|->
name|dl_dbuf
operator|->
name|db_data
expr_stmt|;
name|dl
operator|->
name|dl_havetree
operator|=
name|B_FALSE
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dsl_deadlist_close
parameter_list|(
name|dsl_deadlist_t
modifier|*
name|dl
parameter_list|)
block|{
name|void
modifier|*
name|cookie
init|=
name|NULL
decl_stmt|;
name|dsl_deadlist_entry_t
modifier|*
name|dle
decl_stmt|;
if|if
condition|(
name|dl
operator|->
name|dl_oldfmt
condition|)
block|{
name|dl
operator|->
name|dl_oldfmt
operator|=
name|B_FALSE
expr_stmt|;
name|bpobj_close
argument_list|(
operator|&
name|dl
operator|->
name|dl_bpobj
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|dl
operator|->
name|dl_havetree
condition|)
block|{
while|while
condition|(
operator|(
name|dle
operator|=
name|avl_destroy_nodes
argument_list|(
operator|&
name|dl
operator|->
name|dl_tree
argument_list|,
operator|&
name|cookie
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|bpobj_close
argument_list|(
operator|&
name|dle
operator|->
name|dle_bpobj
argument_list|)
expr_stmt|;
name|kmem_free
argument_list|(
name|dle
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|dle
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|avl_destroy
argument_list|(
operator|&
name|dl
operator|->
name|dl_tree
argument_list|)
expr_stmt|;
block|}
name|dmu_buf_rele
argument_list|(
name|dl
operator|->
name|dl_dbuf
argument_list|,
name|dl
argument_list|)
expr_stmt|;
name|mutex_destroy
argument_list|(
operator|&
name|dl
operator|->
name|dl_lock
argument_list|)
expr_stmt|;
name|dl
operator|->
name|dl_dbuf
operator|=
name|NULL
expr_stmt|;
name|dl
operator|->
name|dl_phys
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
name|uint64_t
name|dsl_deadlist_alloc
parameter_list|(
name|objset_t
modifier|*
name|os
parameter_list|,
name|dmu_tx_t
modifier|*
name|tx
parameter_list|)
block|{
if|if
condition|(
name|spa_version
argument_list|(
name|dmu_objset_spa
argument_list|(
name|os
argument_list|)
argument_list|)
operator|<
name|SPA_VERSION_DEADLISTS
condition|)
return|return
operator|(
name|bpobj_alloc
argument_list|(
name|os
argument_list|,
name|SPA_MAXBLOCKSIZE
argument_list|,
name|tx
argument_list|)
operator|)
return|;
return|return
operator|(
name|zap_create
argument_list|(
name|os
argument_list|,
name|DMU_OT_DEADLIST
argument_list|,
name|DMU_OT_DEADLIST_HDR
argument_list|,
sizeof|sizeof
argument_list|(
name|dsl_deadlist_phys_t
argument_list|)
argument_list|,
name|tx
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dsl_deadlist_free
parameter_list|(
name|objset_t
modifier|*
name|os
parameter_list|,
name|uint64_t
name|dlobj
parameter_list|,
name|dmu_tx_t
modifier|*
name|tx
parameter_list|)
block|{
name|dmu_object_info_t
name|doi
decl_stmt|;
name|zap_cursor_t
name|zc
decl_stmt|;
name|zap_attribute_t
name|za
decl_stmt|;
name|VERIFY3U
argument_list|(
literal|0
argument_list|,
operator|==
argument_list|,
name|dmu_object_info
argument_list|(
name|os
argument_list|,
name|dlobj
argument_list|,
operator|&
name|doi
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|doi
operator|.
name|doi_type
operator|==
name|DMU_OT_BPOBJ
condition|)
block|{
name|bpobj_free
argument_list|(
name|os
argument_list|,
name|dlobj
argument_list|,
name|tx
argument_list|)
expr_stmt|;
return|return;
block|}
for|for
control|(
name|zap_cursor_init
argument_list|(
operator|&
name|zc
argument_list|,
name|os
argument_list|,
name|dlobj
argument_list|)
init|;
name|zap_cursor_retrieve
argument_list|(
operator|&
name|zc
argument_list|,
operator|&
name|za
argument_list|)
operator|==
literal|0
condition|;
name|zap_cursor_advance
argument_list|(
operator|&
name|zc
argument_list|)
control|)
block|{
name|uint64_t
name|obj
init|=
name|za
operator|.
name|za_first_integer
decl_stmt|;
if|if
condition|(
name|obj
operator|==
name|dmu_objset_pool
argument_list|(
name|os
argument_list|)
operator|->
name|dp_empty_bpobj
condition|)
name|bpobj_decr_empty
argument_list|(
name|os
argument_list|,
name|tx
argument_list|)
expr_stmt|;
else|else
name|bpobj_free
argument_list|(
name|os
argument_list|,
name|obj
argument_list|,
name|tx
argument_list|)
expr_stmt|;
block|}
name|zap_cursor_fini
argument_list|(
operator|&
name|zc
argument_list|)
expr_stmt|;
name|VERIFY3U
argument_list|(
literal|0
argument_list|,
operator|==
argument_list|,
name|dmu_object_free
argument_list|(
name|os
argument_list|,
name|dlobj
argument_list|,
name|tx
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dle_enqueue
parameter_list|(
name|dsl_deadlist_t
modifier|*
name|dl
parameter_list|,
name|dsl_deadlist_entry_t
modifier|*
name|dle
parameter_list|,
specifier|const
name|blkptr_t
modifier|*
name|bp
parameter_list|,
name|dmu_tx_t
modifier|*
name|tx
parameter_list|)
block|{
if|if
condition|(
name|dle
operator|->
name|dle_bpobj
operator|.
name|bpo_object
operator|==
name|dmu_objset_pool
argument_list|(
name|dl
operator|->
name|dl_os
argument_list|)
operator|->
name|dp_empty_bpobj
condition|)
block|{
name|uint64_t
name|obj
init|=
name|bpobj_alloc
argument_list|(
name|dl
operator|->
name|dl_os
argument_list|,
name|SPA_MAXBLOCKSIZE
argument_list|,
name|tx
argument_list|)
decl_stmt|;
name|bpobj_close
argument_list|(
operator|&
name|dle
operator|->
name|dle_bpobj
argument_list|)
expr_stmt|;
name|bpobj_decr_empty
argument_list|(
name|dl
operator|->
name|dl_os
argument_list|,
name|tx
argument_list|)
expr_stmt|;
name|VERIFY3U
argument_list|(
literal|0
argument_list|,
operator|==
argument_list|,
name|bpobj_open
argument_list|(
operator|&
name|dle
operator|->
name|dle_bpobj
argument_list|,
name|dl
operator|->
name|dl_os
argument_list|,
name|obj
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY3U
argument_list|(
literal|0
argument_list|,
operator|==
argument_list|,
name|zap_update_int_key
argument_list|(
name|dl
operator|->
name|dl_os
argument_list|,
name|dl
operator|->
name|dl_object
argument_list|,
name|dle
operator|->
name|dle_mintxg
argument_list|,
name|obj
argument_list|,
name|tx
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|bpobj_enqueue
argument_list|(
operator|&
name|dle
operator|->
name|dle_bpobj
argument_list|,
name|bp
argument_list|,
name|tx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dle_enqueue_subobj
parameter_list|(
name|dsl_deadlist_t
modifier|*
name|dl
parameter_list|,
name|dsl_deadlist_entry_t
modifier|*
name|dle
parameter_list|,
name|uint64_t
name|obj
parameter_list|,
name|dmu_tx_t
modifier|*
name|tx
parameter_list|)
block|{
if|if
condition|(
name|dle
operator|->
name|dle_bpobj
operator|.
name|bpo_object
operator|!=
name|dmu_objset_pool
argument_list|(
name|dl
operator|->
name|dl_os
argument_list|)
operator|->
name|dp_empty_bpobj
condition|)
block|{
name|bpobj_enqueue_subobj
argument_list|(
operator|&
name|dle
operator|->
name|dle_bpobj
argument_list|,
name|obj
argument_list|,
name|tx
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|bpobj_close
argument_list|(
operator|&
name|dle
operator|->
name|dle_bpobj
argument_list|)
expr_stmt|;
name|bpobj_decr_empty
argument_list|(
name|dl
operator|->
name|dl_os
argument_list|,
name|tx
argument_list|)
expr_stmt|;
name|VERIFY3U
argument_list|(
literal|0
argument_list|,
operator|==
argument_list|,
name|bpobj_open
argument_list|(
operator|&
name|dle
operator|->
name|dle_bpobj
argument_list|,
name|dl
operator|->
name|dl_os
argument_list|,
name|obj
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY3U
argument_list|(
literal|0
argument_list|,
operator|==
argument_list|,
name|zap_update_int_key
argument_list|(
name|dl
operator|->
name|dl_os
argument_list|,
name|dl
operator|->
name|dl_object
argument_list|,
name|dle
operator|->
name|dle_mintxg
argument_list|,
name|obj
argument_list|,
name|tx
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|dsl_deadlist_insert
parameter_list|(
name|dsl_deadlist_t
modifier|*
name|dl
parameter_list|,
specifier|const
name|blkptr_t
modifier|*
name|bp
parameter_list|,
name|dmu_tx_t
modifier|*
name|tx
parameter_list|)
block|{
name|dsl_deadlist_entry_t
name|dle_tofind
decl_stmt|;
name|dsl_deadlist_entry_t
modifier|*
name|dle
decl_stmt|;
name|avl_index_t
name|where
decl_stmt|;
if|if
condition|(
name|dl
operator|->
name|dl_oldfmt
condition|)
block|{
name|bpobj_enqueue
argument_list|(
operator|&
name|dl
operator|->
name|dl_bpobj
argument_list|,
name|bp
argument_list|,
name|tx
argument_list|)
expr_stmt|;
return|return;
block|}
name|dsl_deadlist_load_tree
argument_list|(
name|dl
argument_list|)
expr_stmt|;
name|dmu_buf_will_dirty
argument_list|(
name|dl
operator|->
name|dl_dbuf
argument_list|,
name|tx
argument_list|)
expr_stmt|;
name|mutex_enter
argument_list|(
operator|&
name|dl
operator|->
name|dl_lock
argument_list|)
expr_stmt|;
name|dl
operator|->
name|dl_phys
operator|->
name|dl_used
operator|+=
name|bp_get_dsize_sync
argument_list|(
name|dmu_objset_spa
argument_list|(
name|dl
operator|->
name|dl_os
argument_list|)
argument_list|,
name|bp
argument_list|)
expr_stmt|;
name|dl
operator|->
name|dl_phys
operator|->
name|dl_comp
operator|+=
name|BP_GET_PSIZE
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|dl
operator|->
name|dl_phys
operator|->
name|dl_uncomp
operator|+=
name|BP_GET_UCSIZE
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|mutex_exit
argument_list|(
operator|&
name|dl
operator|->
name|dl_lock
argument_list|)
expr_stmt|;
name|dle_tofind
operator|.
name|dle_mintxg
operator|=
name|bp
operator|->
name|blk_birth
expr_stmt|;
name|dle
operator|=
name|avl_find
argument_list|(
operator|&
name|dl
operator|->
name|dl_tree
argument_list|,
operator|&
name|dle_tofind
argument_list|,
operator|&
name|where
argument_list|)
expr_stmt|;
if|if
condition|(
name|dle
operator|==
name|NULL
condition|)
name|dle
operator|=
name|avl_nearest
argument_list|(
operator|&
name|dl
operator|->
name|dl_tree
argument_list|,
name|where
argument_list|,
name|AVL_BEFORE
argument_list|)
expr_stmt|;
else|else
name|dle
operator|=
name|AVL_PREV
argument_list|(
operator|&
name|dl
operator|->
name|dl_tree
argument_list|,
name|dle
argument_list|)
expr_stmt|;
name|dle_enqueue
argument_list|(
name|dl
argument_list|,
name|dle
argument_list|,
name|bp
argument_list|,
name|tx
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Insert new key in deadlist, which must be> all current entries.  * mintxg is not inclusive.  */
end_comment

begin_function
name|void
name|dsl_deadlist_add_key
parameter_list|(
name|dsl_deadlist_t
modifier|*
name|dl
parameter_list|,
name|uint64_t
name|mintxg
parameter_list|,
name|dmu_tx_t
modifier|*
name|tx
parameter_list|)
block|{
name|uint64_t
name|obj
decl_stmt|;
name|dsl_deadlist_entry_t
modifier|*
name|dle
decl_stmt|;
if|if
condition|(
name|dl
operator|->
name|dl_oldfmt
condition|)
return|return;
name|dsl_deadlist_load_tree
argument_list|(
name|dl
argument_list|)
expr_stmt|;
name|dle
operator|=
name|kmem_alloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|dle
argument_list|)
argument_list|,
name|KM_SLEEP
argument_list|)
expr_stmt|;
name|dle
operator|->
name|dle_mintxg
operator|=
name|mintxg
expr_stmt|;
name|obj
operator|=
name|bpobj_alloc_empty
argument_list|(
name|dl
operator|->
name|dl_os
argument_list|,
name|SPA_MAXBLOCKSIZE
argument_list|,
name|tx
argument_list|)
expr_stmt|;
name|VERIFY3U
argument_list|(
literal|0
argument_list|,
operator|==
argument_list|,
name|bpobj_open
argument_list|(
operator|&
name|dle
operator|->
name|dle_bpobj
argument_list|,
name|dl
operator|->
name|dl_os
argument_list|,
name|obj
argument_list|)
argument_list|)
expr_stmt|;
name|avl_add
argument_list|(
operator|&
name|dl
operator|->
name|dl_tree
argument_list|,
name|dle
argument_list|)
expr_stmt|;
name|VERIFY3U
argument_list|(
literal|0
argument_list|,
operator|==
argument_list|,
name|zap_add_int_key
argument_list|(
name|dl
operator|->
name|dl_os
argument_list|,
name|dl
operator|->
name|dl_object
argument_list|,
name|mintxg
argument_list|,
name|obj
argument_list|,
name|tx
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Remove this key, merging its entries into the previous key.  */
end_comment

begin_function
name|void
name|dsl_deadlist_remove_key
parameter_list|(
name|dsl_deadlist_t
modifier|*
name|dl
parameter_list|,
name|uint64_t
name|mintxg
parameter_list|,
name|dmu_tx_t
modifier|*
name|tx
parameter_list|)
block|{
name|dsl_deadlist_entry_t
name|dle_tofind
decl_stmt|;
name|dsl_deadlist_entry_t
modifier|*
name|dle
decl_stmt|,
modifier|*
name|dle_prev
decl_stmt|;
if|if
condition|(
name|dl
operator|->
name|dl_oldfmt
condition|)
return|return;
name|dsl_deadlist_load_tree
argument_list|(
name|dl
argument_list|)
expr_stmt|;
name|dle_tofind
operator|.
name|dle_mintxg
operator|=
name|mintxg
expr_stmt|;
name|dle
operator|=
name|avl_find
argument_list|(
operator|&
name|dl
operator|->
name|dl_tree
argument_list|,
operator|&
name|dle_tofind
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|dle_prev
operator|=
name|AVL_PREV
argument_list|(
operator|&
name|dl
operator|->
name|dl_tree
argument_list|,
name|dle
argument_list|)
expr_stmt|;
name|dle_enqueue_subobj
argument_list|(
name|dl
argument_list|,
name|dle_prev
argument_list|,
name|dle
operator|->
name|dle_bpobj
operator|.
name|bpo_object
argument_list|,
name|tx
argument_list|)
expr_stmt|;
name|avl_remove
argument_list|(
operator|&
name|dl
operator|->
name|dl_tree
argument_list|,
name|dle
argument_list|)
expr_stmt|;
name|bpobj_close
argument_list|(
operator|&
name|dle
operator|->
name|dle_bpobj
argument_list|)
expr_stmt|;
name|kmem_free
argument_list|(
name|dle
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|dle
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY3U
argument_list|(
literal|0
argument_list|,
operator|==
argument_list|,
name|zap_remove_int
argument_list|(
name|dl
operator|->
name|dl_os
argument_list|,
name|dl
operator|->
name|dl_object
argument_list|,
name|mintxg
argument_list|,
name|tx
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Walk ds's snapshots to regenerate generate ZAP& AVL.  */
end_comment

begin_function
specifier|static
name|void
name|dsl_deadlist_regenerate
parameter_list|(
name|objset_t
modifier|*
name|os
parameter_list|,
name|uint64_t
name|dlobj
parameter_list|,
name|uint64_t
name|mrs_obj
parameter_list|,
name|dmu_tx_t
modifier|*
name|tx
parameter_list|)
block|{
name|dsl_deadlist_t
name|dl
decl_stmt|;
name|dsl_pool_t
modifier|*
name|dp
init|=
name|dmu_objset_pool
argument_list|(
name|os
argument_list|)
decl_stmt|;
name|dsl_deadlist_open
argument_list|(
operator|&
name|dl
argument_list|,
name|os
argument_list|,
name|dlobj
argument_list|)
expr_stmt|;
if|if
condition|(
name|dl
operator|.
name|dl_oldfmt
condition|)
block|{
name|dsl_deadlist_close
argument_list|(
operator|&
name|dl
argument_list|)
expr_stmt|;
return|return;
block|}
while|while
condition|(
name|mrs_obj
operator|!=
literal|0
condition|)
block|{
name|dsl_dataset_t
modifier|*
name|ds
decl_stmt|;
name|VERIFY3U
argument_list|(
literal|0
argument_list|,
operator|==
argument_list|,
name|dsl_dataset_hold_obj
argument_list|(
name|dp
argument_list|,
name|mrs_obj
argument_list|,
name|FTAG
argument_list|,
operator|&
name|ds
argument_list|)
argument_list|)
expr_stmt|;
name|dsl_deadlist_add_key
argument_list|(
operator|&
name|dl
argument_list|,
name|ds
operator|->
name|ds_phys
operator|->
name|ds_prev_snap_txg
argument_list|,
name|tx
argument_list|)
expr_stmt|;
name|mrs_obj
operator|=
name|ds
operator|->
name|ds_phys
operator|->
name|ds_prev_snap_obj
expr_stmt|;
name|dsl_dataset_rele
argument_list|(
name|ds
argument_list|,
name|FTAG
argument_list|)
expr_stmt|;
block|}
name|dsl_deadlist_close
argument_list|(
operator|&
name|dl
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|uint64_t
name|dsl_deadlist_clone
parameter_list|(
name|dsl_deadlist_t
modifier|*
name|dl
parameter_list|,
name|uint64_t
name|maxtxg
parameter_list|,
name|uint64_t
name|mrs_obj
parameter_list|,
name|dmu_tx_t
modifier|*
name|tx
parameter_list|)
block|{
name|dsl_deadlist_entry_t
modifier|*
name|dle
decl_stmt|;
name|uint64_t
name|newobj
decl_stmt|;
name|newobj
operator|=
name|dsl_deadlist_alloc
argument_list|(
name|dl
operator|->
name|dl_os
argument_list|,
name|tx
argument_list|)
expr_stmt|;
if|if
condition|(
name|dl
operator|->
name|dl_oldfmt
condition|)
block|{
name|dsl_deadlist_regenerate
argument_list|(
name|dl
operator|->
name|dl_os
argument_list|,
name|newobj
argument_list|,
name|mrs_obj
argument_list|,
name|tx
argument_list|)
expr_stmt|;
return|return
operator|(
name|newobj
operator|)
return|;
block|}
name|dsl_deadlist_load_tree
argument_list|(
name|dl
argument_list|)
expr_stmt|;
for|for
control|(
name|dle
operator|=
name|avl_first
argument_list|(
operator|&
name|dl
operator|->
name|dl_tree
argument_list|)
init|;
name|dle
condition|;
name|dle
operator|=
name|AVL_NEXT
argument_list|(
operator|&
name|dl
operator|->
name|dl_tree
argument_list|,
name|dle
argument_list|)
control|)
block|{
name|uint64_t
name|obj
decl_stmt|;
if|if
condition|(
name|dle
operator|->
name|dle_mintxg
operator|>=
name|maxtxg
condition|)
break|break;
name|obj
operator|=
name|bpobj_alloc_empty
argument_list|(
name|dl
operator|->
name|dl_os
argument_list|,
name|SPA_MAXBLOCKSIZE
argument_list|,
name|tx
argument_list|)
expr_stmt|;
name|VERIFY3U
argument_list|(
literal|0
argument_list|,
operator|==
argument_list|,
name|zap_add_int_key
argument_list|(
name|dl
operator|->
name|dl_os
argument_list|,
name|newobj
argument_list|,
name|dle
operator|->
name|dle_mintxg
argument_list|,
name|obj
argument_list|,
name|tx
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|newobj
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dsl_deadlist_space
parameter_list|(
name|dsl_deadlist_t
modifier|*
name|dl
parameter_list|,
name|uint64_t
modifier|*
name|usedp
parameter_list|,
name|uint64_t
modifier|*
name|compp
parameter_list|,
name|uint64_t
modifier|*
name|uncompp
parameter_list|)
block|{
if|if
condition|(
name|dl
operator|->
name|dl_oldfmt
condition|)
block|{
name|VERIFY3U
argument_list|(
literal|0
argument_list|,
operator|==
argument_list|,
name|bpobj_space
argument_list|(
operator|&
name|dl
operator|->
name|dl_bpobj
argument_list|,
name|usedp
argument_list|,
name|compp
argument_list|,
name|uncompp
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|mutex_enter
argument_list|(
operator|&
name|dl
operator|->
name|dl_lock
argument_list|)
expr_stmt|;
operator|*
name|usedp
operator|=
name|dl
operator|->
name|dl_phys
operator|->
name|dl_used
expr_stmt|;
operator|*
name|compp
operator|=
name|dl
operator|->
name|dl_phys
operator|->
name|dl_comp
expr_stmt|;
operator|*
name|uncompp
operator|=
name|dl
operator|->
name|dl_phys
operator|->
name|dl_uncomp
expr_stmt|;
name|mutex_exit
argument_list|(
operator|&
name|dl
operator|->
name|dl_lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * return space used in the range (mintxg, maxtxg].  * Includes maxtxg, does not include mintxg.  * mintxg and maxtxg must both be keys in the deadlist (unless maxtxg is  * larger than any bp in the deadlist (eg. UINT64_MAX)).  */
end_comment

begin_function
name|void
name|dsl_deadlist_space_range
parameter_list|(
name|dsl_deadlist_t
modifier|*
name|dl
parameter_list|,
name|uint64_t
name|mintxg
parameter_list|,
name|uint64_t
name|maxtxg
parameter_list|,
name|uint64_t
modifier|*
name|usedp
parameter_list|,
name|uint64_t
modifier|*
name|compp
parameter_list|,
name|uint64_t
modifier|*
name|uncompp
parameter_list|)
block|{
name|dsl_deadlist_entry_t
modifier|*
name|dle
decl_stmt|;
name|dsl_deadlist_entry_t
name|dle_tofind
decl_stmt|;
name|avl_index_t
name|where
decl_stmt|;
if|if
condition|(
name|dl
operator|->
name|dl_oldfmt
condition|)
block|{
name|VERIFY3U
argument_list|(
literal|0
argument_list|,
operator|==
argument_list|,
name|bpobj_space_range
argument_list|(
operator|&
name|dl
operator|->
name|dl_bpobj
argument_list|,
name|mintxg
argument_list|,
name|maxtxg
argument_list|,
name|usedp
argument_list|,
name|compp
argument_list|,
name|uncompp
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
operator|*
name|usedp
operator|=
operator|*
name|compp
operator|=
operator|*
name|uncompp
operator|=
literal|0
expr_stmt|;
name|mutex_enter
argument_list|(
operator|&
name|dl
operator|->
name|dl_lock
argument_list|)
expr_stmt|;
name|dsl_deadlist_load_tree
argument_list|(
name|dl
argument_list|)
expr_stmt|;
name|dle_tofind
operator|.
name|dle_mintxg
operator|=
name|mintxg
expr_stmt|;
name|dle
operator|=
name|avl_find
argument_list|(
operator|&
name|dl
operator|->
name|dl_tree
argument_list|,
operator|&
name|dle_tofind
argument_list|,
operator|&
name|where
argument_list|)
expr_stmt|;
comment|/* 	 * If we don't find this mintxg, there shouldn't be anything 	 * after it either. 	 */
name|ASSERT
argument_list|(
name|dle
operator|!=
name|NULL
operator|||
name|avl_nearest
argument_list|(
operator|&
name|dl
operator|->
name|dl_tree
argument_list|,
name|where
argument_list|,
name|AVL_AFTER
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
for|for
control|(
init|;
name|dle
operator|&&
name|dle
operator|->
name|dle_mintxg
operator|<
name|maxtxg
condition|;
name|dle
operator|=
name|AVL_NEXT
argument_list|(
operator|&
name|dl
operator|->
name|dl_tree
argument_list|,
name|dle
argument_list|)
control|)
block|{
name|uint64_t
name|used
decl_stmt|,
name|comp
decl_stmt|,
name|uncomp
decl_stmt|;
name|VERIFY3U
argument_list|(
literal|0
argument_list|,
operator|==
argument_list|,
name|bpobj_space
argument_list|(
operator|&
name|dle
operator|->
name|dle_bpobj
argument_list|,
operator|&
name|used
argument_list|,
operator|&
name|comp
argument_list|,
operator|&
name|uncomp
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|usedp
operator|+=
name|used
expr_stmt|;
operator|*
name|compp
operator|+=
name|comp
expr_stmt|;
operator|*
name|uncompp
operator|+=
name|uncomp
expr_stmt|;
block|}
name|mutex_exit
argument_list|(
operator|&
name|dl
operator|->
name|dl_lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dsl_deadlist_insert_bpobj
parameter_list|(
name|dsl_deadlist_t
modifier|*
name|dl
parameter_list|,
name|uint64_t
name|obj
parameter_list|,
name|uint64_t
name|birth
parameter_list|,
name|dmu_tx_t
modifier|*
name|tx
parameter_list|)
block|{
name|dsl_deadlist_entry_t
name|dle_tofind
decl_stmt|;
name|dsl_deadlist_entry_t
modifier|*
name|dle
decl_stmt|;
name|avl_index_t
name|where
decl_stmt|;
name|uint64_t
name|used
decl_stmt|,
name|comp
decl_stmt|,
name|uncomp
decl_stmt|;
name|bpobj_t
name|bpo
decl_stmt|;
name|VERIFY3U
argument_list|(
literal|0
argument_list|,
operator|==
argument_list|,
name|bpobj_open
argument_list|(
operator|&
name|bpo
argument_list|,
name|dl
operator|->
name|dl_os
argument_list|,
name|obj
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY3U
argument_list|(
literal|0
argument_list|,
operator|==
argument_list|,
name|bpobj_space
argument_list|(
operator|&
name|bpo
argument_list|,
operator|&
name|used
argument_list|,
operator|&
name|comp
argument_list|,
operator|&
name|uncomp
argument_list|)
argument_list|)
expr_stmt|;
name|bpobj_close
argument_list|(
operator|&
name|bpo
argument_list|)
expr_stmt|;
name|dsl_deadlist_load_tree
argument_list|(
name|dl
argument_list|)
expr_stmt|;
name|dmu_buf_will_dirty
argument_list|(
name|dl
operator|->
name|dl_dbuf
argument_list|,
name|tx
argument_list|)
expr_stmt|;
name|mutex_enter
argument_list|(
operator|&
name|dl
operator|->
name|dl_lock
argument_list|)
expr_stmt|;
name|dl
operator|->
name|dl_phys
operator|->
name|dl_used
operator|+=
name|used
expr_stmt|;
name|dl
operator|->
name|dl_phys
operator|->
name|dl_comp
operator|+=
name|comp
expr_stmt|;
name|dl
operator|->
name|dl_phys
operator|->
name|dl_uncomp
operator|+=
name|uncomp
expr_stmt|;
name|mutex_exit
argument_list|(
operator|&
name|dl
operator|->
name|dl_lock
argument_list|)
expr_stmt|;
name|dle_tofind
operator|.
name|dle_mintxg
operator|=
name|birth
expr_stmt|;
name|dle
operator|=
name|avl_find
argument_list|(
operator|&
name|dl
operator|->
name|dl_tree
argument_list|,
operator|&
name|dle_tofind
argument_list|,
operator|&
name|where
argument_list|)
expr_stmt|;
if|if
condition|(
name|dle
operator|==
name|NULL
condition|)
name|dle
operator|=
name|avl_nearest
argument_list|(
operator|&
name|dl
operator|->
name|dl_tree
argument_list|,
name|where
argument_list|,
name|AVL_BEFORE
argument_list|)
expr_stmt|;
name|dle_enqueue_subobj
argument_list|(
name|dl
argument_list|,
name|dle
argument_list|,
name|obj
argument_list|,
name|tx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|dsl_deadlist_insert_cb
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
specifier|const
name|blkptr_t
modifier|*
name|bp
parameter_list|,
name|dmu_tx_t
modifier|*
name|tx
parameter_list|)
block|{
name|dsl_deadlist_t
modifier|*
name|dl
init|=
name|arg
decl_stmt|;
name|dsl_deadlist_insert
argument_list|(
name|dl
argument_list|,
name|bp
argument_list|,
name|tx
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Merge the deadlist pointed to by 'obj' into dl.  obj will be left as  * an empty deadlist.  */
end_comment

begin_function
name|void
name|dsl_deadlist_merge
parameter_list|(
name|dsl_deadlist_t
modifier|*
name|dl
parameter_list|,
name|uint64_t
name|obj
parameter_list|,
name|dmu_tx_t
modifier|*
name|tx
parameter_list|)
block|{
name|zap_cursor_t
name|zc
decl_stmt|;
name|zap_attribute_t
name|za
decl_stmt|;
name|dmu_buf_t
modifier|*
name|bonus
decl_stmt|;
name|dsl_deadlist_phys_t
modifier|*
name|dlp
decl_stmt|;
name|dmu_object_info_t
name|doi
decl_stmt|;
name|VERIFY3U
argument_list|(
literal|0
argument_list|,
operator|==
argument_list|,
name|dmu_object_info
argument_list|(
name|dl
operator|->
name|dl_os
argument_list|,
name|obj
argument_list|,
operator|&
name|doi
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|doi
operator|.
name|doi_type
operator|==
name|DMU_OT_BPOBJ
condition|)
block|{
name|bpobj_t
name|bpo
decl_stmt|;
name|VERIFY3U
argument_list|(
literal|0
argument_list|,
operator|==
argument_list|,
name|bpobj_open
argument_list|(
operator|&
name|bpo
argument_list|,
name|dl
operator|->
name|dl_os
argument_list|,
name|obj
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY3U
argument_list|(
literal|0
argument_list|,
operator|==
argument_list|,
name|bpobj_iterate
argument_list|(
operator|&
name|bpo
argument_list|,
name|dsl_deadlist_insert_cb
argument_list|,
name|dl
argument_list|,
name|tx
argument_list|)
argument_list|)
expr_stmt|;
name|bpobj_close
argument_list|(
operator|&
name|bpo
argument_list|)
expr_stmt|;
return|return;
block|}
for|for
control|(
name|zap_cursor_init
argument_list|(
operator|&
name|zc
argument_list|,
name|dl
operator|->
name|dl_os
argument_list|,
name|obj
argument_list|)
init|;
name|zap_cursor_retrieve
argument_list|(
operator|&
name|zc
argument_list|,
operator|&
name|za
argument_list|)
operator|==
literal|0
condition|;
name|zap_cursor_advance
argument_list|(
operator|&
name|zc
argument_list|)
control|)
block|{
name|uint64_t
name|mintxg
init|=
name|strtonum
argument_list|(
name|za
operator|.
name|za_name
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
name|dsl_deadlist_insert_bpobj
argument_list|(
name|dl
argument_list|,
name|za
operator|.
name|za_first_integer
argument_list|,
name|mintxg
argument_list|,
name|tx
argument_list|)
expr_stmt|;
name|VERIFY3U
argument_list|(
literal|0
argument_list|,
operator|==
argument_list|,
name|zap_remove_int
argument_list|(
name|dl
operator|->
name|dl_os
argument_list|,
name|obj
argument_list|,
name|mintxg
argument_list|,
name|tx
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|zap_cursor_fini
argument_list|(
operator|&
name|zc
argument_list|)
expr_stmt|;
name|VERIFY3U
argument_list|(
literal|0
argument_list|,
operator|==
argument_list|,
name|dmu_bonus_hold
argument_list|(
name|dl
operator|->
name|dl_os
argument_list|,
name|obj
argument_list|,
name|FTAG
argument_list|,
operator|&
name|bonus
argument_list|)
argument_list|)
expr_stmt|;
name|dlp
operator|=
name|bonus
operator|->
name|db_data
expr_stmt|;
name|dmu_buf_will_dirty
argument_list|(
name|bonus
argument_list|,
name|tx
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|dlp
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|dlp
argument_list|)
argument_list|)
expr_stmt|;
name|dmu_buf_rele
argument_list|(
name|bonus
argument_list|,
name|FTAG
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Remove entries on dl that are>= mintxg, and put them on the bpobj.  */
end_comment

begin_function
name|void
name|dsl_deadlist_move_bpobj
parameter_list|(
name|dsl_deadlist_t
modifier|*
name|dl
parameter_list|,
name|bpobj_t
modifier|*
name|bpo
parameter_list|,
name|uint64_t
name|mintxg
parameter_list|,
name|dmu_tx_t
modifier|*
name|tx
parameter_list|)
block|{
name|dsl_deadlist_entry_t
name|dle_tofind
decl_stmt|;
name|dsl_deadlist_entry_t
modifier|*
name|dle
decl_stmt|;
name|avl_index_t
name|where
decl_stmt|;
name|ASSERT
argument_list|(
operator|!
name|dl
operator|->
name|dl_oldfmt
argument_list|)
expr_stmt|;
name|dmu_buf_will_dirty
argument_list|(
name|dl
operator|->
name|dl_dbuf
argument_list|,
name|tx
argument_list|)
expr_stmt|;
name|dsl_deadlist_load_tree
argument_list|(
name|dl
argument_list|)
expr_stmt|;
name|dle_tofind
operator|.
name|dle_mintxg
operator|=
name|mintxg
expr_stmt|;
name|dle
operator|=
name|avl_find
argument_list|(
operator|&
name|dl
operator|->
name|dl_tree
argument_list|,
operator|&
name|dle_tofind
argument_list|,
operator|&
name|where
argument_list|)
expr_stmt|;
if|if
condition|(
name|dle
operator|==
name|NULL
condition|)
name|dle
operator|=
name|avl_nearest
argument_list|(
operator|&
name|dl
operator|->
name|dl_tree
argument_list|,
name|where
argument_list|,
name|AVL_AFTER
argument_list|)
expr_stmt|;
while|while
condition|(
name|dle
condition|)
block|{
name|uint64_t
name|used
decl_stmt|,
name|comp
decl_stmt|,
name|uncomp
decl_stmt|;
name|dsl_deadlist_entry_t
modifier|*
name|dle_next
decl_stmt|;
name|bpobj_enqueue_subobj
argument_list|(
name|bpo
argument_list|,
name|dle
operator|->
name|dle_bpobj
operator|.
name|bpo_object
argument_list|,
name|tx
argument_list|)
expr_stmt|;
name|VERIFY3U
argument_list|(
literal|0
argument_list|,
operator|==
argument_list|,
name|bpobj_space
argument_list|(
operator|&
name|dle
operator|->
name|dle_bpobj
argument_list|,
operator|&
name|used
argument_list|,
operator|&
name|comp
argument_list|,
operator|&
name|uncomp
argument_list|)
argument_list|)
expr_stmt|;
name|mutex_enter
argument_list|(
operator|&
name|dl
operator|->
name|dl_lock
argument_list|)
expr_stmt|;
name|ASSERT3U
argument_list|(
name|dl
operator|->
name|dl_phys
operator|->
name|dl_used
argument_list|,
operator|>=
argument_list|,
name|used
argument_list|)
expr_stmt|;
name|ASSERT3U
argument_list|(
name|dl
operator|->
name|dl_phys
operator|->
name|dl_comp
argument_list|,
operator|>=
argument_list|,
name|comp
argument_list|)
expr_stmt|;
name|ASSERT3U
argument_list|(
name|dl
operator|->
name|dl_phys
operator|->
name|dl_uncomp
argument_list|,
operator|>=
argument_list|,
name|uncomp
argument_list|)
expr_stmt|;
name|dl
operator|->
name|dl_phys
operator|->
name|dl_used
operator|-=
name|used
expr_stmt|;
name|dl
operator|->
name|dl_phys
operator|->
name|dl_comp
operator|-=
name|comp
expr_stmt|;
name|dl
operator|->
name|dl_phys
operator|->
name|dl_uncomp
operator|-=
name|uncomp
expr_stmt|;
name|mutex_exit
argument_list|(
operator|&
name|dl
operator|->
name|dl_lock
argument_list|)
expr_stmt|;
name|VERIFY3U
argument_list|(
literal|0
argument_list|,
operator|==
argument_list|,
name|zap_remove_int
argument_list|(
name|dl
operator|->
name|dl_os
argument_list|,
name|dl
operator|->
name|dl_object
argument_list|,
name|dle
operator|->
name|dle_mintxg
argument_list|,
name|tx
argument_list|)
argument_list|)
expr_stmt|;
name|dle_next
operator|=
name|AVL_NEXT
argument_list|(
operator|&
name|dl
operator|->
name|dl_tree
argument_list|,
name|dle
argument_list|)
expr_stmt|;
name|avl_remove
argument_list|(
operator|&
name|dl
operator|->
name|dl_tree
argument_list|,
name|dle
argument_list|)
expr_stmt|;
name|bpobj_close
argument_list|(
operator|&
name|dle
operator|->
name|dle_bpobj
argument_list|)
expr_stmt|;
name|kmem_free
argument_list|(
name|dle
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|dle
argument_list|)
argument_list|)
expr_stmt|;
name|dle
operator|=
name|dle_next
expr_stmt|;
block|}
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* ** $Id: lbitlib.c,v 1.18.1.2 2013/07/09 18:01:41 roberto Exp $ ** Standard library for bitwise operations ** See Copyright Notice in lua.h */
end_comment

begin_define
define|#
directive|define
name|lbitlib_c
end_define

begin_define
define|#
directive|define
name|LUA_LIB
end_define

begin_include
include|#
directive|include
file|"lua.h"
end_include

begin_include
include|#
directive|include
file|"lauxlib.h"
end_include

begin_include
include|#
directive|include
file|"lualib.h"
end_include

begin_comment
comment|/* number of bits to consider in a number */
end_comment

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|LUA_NBITS
argument_list|)
end_if

begin_define
define|#
directive|define
name|LUA_NBITS
value|32
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|ALLONES
value|(~(((~(lua_Unsigned)0)<< (LUA_NBITS - 1))<< 1))
end_define

begin_comment
comment|/* macro to trim extra bits */
end_comment

begin_define
define|#
directive|define
name|trim
parameter_list|(
name|x
parameter_list|)
value|((x)& ALLONES)
end_define

begin_comment
comment|/* builds a number with 'n' ones (1<= n<= LUA_NBITS) */
end_comment

begin_define
define|#
directive|define
name|mask
parameter_list|(
name|n
parameter_list|)
value|(~((ALLONES<< 1)<< ((n) - 1)))
end_define

begin_typedef
typedef|typedef
name|lua_Unsigned
name|b_uint
typedef|;
end_typedef

begin_function
specifier|static
name|b_uint
name|andaux
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|n
init|=
name|lua_gettop
argument_list|(
name|L
argument_list|)
decl_stmt|;
name|b_uint
name|r
init|=
operator|~
operator|(
name|b_uint
operator|)
literal|0
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
name|n
condition|;
name|i
operator|++
control|)
name|r
operator|&=
name|luaL_checkunsigned
argument_list|(
name|L
argument_list|,
name|i
argument_list|)
expr_stmt|;
return|return
name|trim
argument_list|(
name|r
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|b_and
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|)
block|{
name|b_uint
name|r
init|=
name|andaux
argument_list|(
name|L
argument_list|)
decl_stmt|;
name|lua_pushunsigned
argument_list|(
name|L
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|b_test
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|)
block|{
name|b_uint
name|r
init|=
name|andaux
argument_list|(
name|L
argument_list|)
decl_stmt|;
name|lua_pushboolean
argument_list|(
name|L
argument_list|,
name|r
operator|!=
literal|0
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|b_or
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|n
init|=
name|lua_gettop
argument_list|(
name|L
argument_list|)
decl_stmt|;
name|b_uint
name|r
init|=
literal|0
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
name|n
condition|;
name|i
operator|++
control|)
name|r
operator||=
name|luaL_checkunsigned
argument_list|(
name|L
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|lua_pushunsigned
argument_list|(
name|L
argument_list|,
name|trim
argument_list|(
name|r
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|b_xor
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|n
init|=
name|lua_gettop
argument_list|(
name|L
argument_list|)
decl_stmt|;
name|b_uint
name|r
init|=
literal|0
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
name|n
condition|;
name|i
operator|++
control|)
name|r
operator|^=
name|luaL_checkunsigned
argument_list|(
name|L
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|lua_pushunsigned
argument_list|(
name|L
argument_list|,
name|trim
argument_list|(
name|r
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|b_not
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|)
block|{
name|b_uint
name|r
init|=
operator|~
name|luaL_checkunsigned
argument_list|(
name|L
argument_list|,
literal|1
argument_list|)
decl_stmt|;
name|lua_pushunsigned
argument_list|(
name|L
argument_list|,
name|trim
argument_list|(
name|r
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|b_shift
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|b_uint
name|r
parameter_list|,
name|int
name|i
parameter_list|)
block|{
if|if
condition|(
name|i
operator|<
literal|0
condition|)
block|{
comment|/* shift right? */
name|i
operator|=
operator|-
name|i
expr_stmt|;
name|r
operator|=
name|trim
argument_list|(
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|>=
name|LUA_NBITS
condition|)
name|r
operator|=
literal|0
expr_stmt|;
else|else
name|r
operator|>>=
name|i
expr_stmt|;
block|}
else|else
block|{
comment|/* shift left */
if|if
condition|(
name|i
operator|>=
name|LUA_NBITS
condition|)
name|r
operator|=
literal|0
expr_stmt|;
else|else
name|r
operator|<<=
name|i
expr_stmt|;
name|r
operator|=
name|trim
argument_list|(
name|r
argument_list|)
expr_stmt|;
block|}
name|lua_pushunsigned
argument_list|(
name|L
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|b_lshift
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|)
block|{
return|return
name|b_shift
argument_list|(
name|L
argument_list|,
name|luaL_checkunsigned
argument_list|(
name|L
argument_list|,
literal|1
argument_list|)
argument_list|,
name|luaL_checkint
argument_list|(
name|L
argument_list|,
literal|2
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|b_rshift
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|)
block|{
return|return
name|b_shift
argument_list|(
name|L
argument_list|,
name|luaL_checkunsigned
argument_list|(
name|L
argument_list|,
literal|1
argument_list|)
argument_list|,
operator|-
name|luaL_checkint
argument_list|(
name|L
argument_list|,
literal|2
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|b_arshift
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|)
block|{
name|b_uint
name|r
init|=
name|luaL_checkunsigned
argument_list|(
name|L
argument_list|,
literal|1
argument_list|)
decl_stmt|;
name|int
name|i
init|=
name|luaL_checkint
argument_list|(
name|L
argument_list|,
literal|2
argument_list|)
decl_stmt|;
if|if
condition|(
name|i
operator|<
literal|0
operator|||
operator|!
operator|(
name|r
operator|&
operator|(
operator|(
name|b_uint
operator|)
literal|1
operator|<<
operator|(
name|LUA_NBITS
operator|-
literal|1
operator|)
operator|)
operator|)
condition|)
return|return
name|b_shift
argument_list|(
name|L
argument_list|,
name|r
argument_list|,
operator|-
name|i
argument_list|)
return|;
else|else
block|{
comment|/* arithmetic shift for 'negative' number */
if|if
condition|(
name|i
operator|>=
name|LUA_NBITS
condition|)
name|r
operator|=
name|ALLONES
expr_stmt|;
else|else
name|r
operator|=
name|trim
argument_list|(
operator|(
name|r
operator|>>
name|i
operator|)
operator||
operator|~
operator|(
operator|~
operator|(
name|b_uint
operator|)
literal|0
operator|>>
name|i
operator|)
argument_list|)
expr_stmt|;
comment|/* add signal bit */
name|lua_pushunsigned
argument_list|(
name|L
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|b_rot
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|int
name|i
parameter_list|)
block|{
name|b_uint
name|r
init|=
name|luaL_checkunsigned
argument_list|(
name|L
argument_list|,
literal|1
argument_list|)
decl_stmt|;
name|i
operator|&=
operator|(
name|LUA_NBITS
operator|-
literal|1
operator|)
expr_stmt|;
comment|/* i = i % NBITS */
name|r
operator|=
name|trim
argument_list|(
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|!=
literal|0
condition|)
comment|/* avoid undefined shift of LUA_NBITS when i == 0 */
name|r
operator|=
operator|(
name|r
operator|<<
name|i
operator|)
operator||
operator|(
name|r
operator|>>
operator|(
name|LUA_NBITS
operator|-
name|i
operator|)
operator|)
expr_stmt|;
name|lua_pushunsigned
argument_list|(
name|L
argument_list|,
name|trim
argument_list|(
name|r
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|b_lrot
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|)
block|{
return|return
name|b_rot
argument_list|(
name|L
argument_list|,
name|luaL_checkint
argument_list|(
name|L
argument_list|,
literal|2
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|b_rrot
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|)
block|{
return|return
name|b_rot
argument_list|(
name|L
argument_list|,
operator|-
name|luaL_checkint
argument_list|(
name|L
argument_list|,
literal|2
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* ** get field and width arguments for field-manipulation functions, ** checking whether they are valid. ** ('luaL_error' called without 'return' to avoid later warnings about ** 'width' being used uninitialized.) */
end_comment

begin_function
specifier|static
name|int
name|fieldargs
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
name|int
name|farg
parameter_list|,
name|int
modifier|*
name|width
parameter_list|)
block|{
name|int
name|f
init|=
name|luaL_checkint
argument_list|(
name|L
argument_list|,
name|farg
argument_list|)
decl_stmt|;
name|int
name|w
init|=
name|luaL_optint
argument_list|(
name|L
argument_list|,
name|farg
operator|+
literal|1
argument_list|,
literal|1
argument_list|)
decl_stmt|;
name|luaL_argcheck
argument_list|(
name|L
argument_list|,
literal|0
operator|<=
name|f
argument_list|,
name|farg
argument_list|,
literal|"field cannot be negative"
argument_list|)
expr_stmt|;
name|luaL_argcheck
argument_list|(
name|L
argument_list|,
literal|0
operator|<
name|w
argument_list|,
name|farg
operator|+
literal|1
argument_list|,
literal|"width must be positive"
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|+
name|w
operator|>
name|LUA_NBITS
condition|)
name|luaL_error
argument_list|(
name|L
argument_list|,
literal|"trying to access non-existent bits"
argument_list|)
expr_stmt|;
operator|*
name|width
operator|=
name|w
expr_stmt|;
return|return
name|f
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|b_extract
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|)
block|{
name|int
name|w
decl_stmt|;
name|b_uint
name|r
init|=
name|luaL_checkunsigned
argument_list|(
name|L
argument_list|,
literal|1
argument_list|)
decl_stmt|;
name|int
name|f
init|=
name|fieldargs
argument_list|(
name|L
argument_list|,
literal|2
argument_list|,
operator|&
name|w
argument_list|)
decl_stmt|;
name|r
operator|=
operator|(
name|r
operator|>>
name|f
operator|)
operator|&
name|mask
argument_list|(
name|w
argument_list|)
expr_stmt|;
name|lua_pushunsigned
argument_list|(
name|L
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|b_replace
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|)
block|{
name|int
name|w
decl_stmt|;
name|b_uint
name|r
init|=
name|luaL_checkunsigned
argument_list|(
name|L
argument_list|,
literal|1
argument_list|)
decl_stmt|;
name|b_uint
name|v
init|=
name|luaL_checkunsigned
argument_list|(
name|L
argument_list|,
literal|2
argument_list|)
decl_stmt|;
name|int
name|f
init|=
name|fieldargs
argument_list|(
name|L
argument_list|,
literal|3
argument_list|,
operator|&
name|w
argument_list|)
decl_stmt|;
name|int
name|m
init|=
name|mask
argument_list|(
name|w
argument_list|)
decl_stmt|;
name|v
operator|&=
name|m
expr_stmt|;
comment|/* erase bits outside given width */
name|r
operator|=
operator|(
name|r
operator|&
operator|~
operator|(
name|m
operator|<<
name|f
operator|)
operator|)
operator||
operator|(
name|v
operator|<<
name|f
operator|)
expr_stmt|;
name|lua_pushunsigned
argument_list|(
name|L
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|luaL_Reg
name|bitlib
index|[]
init|=
block|{
block|{
literal|"arshift"
block|,
name|b_arshift
block|}
block|,
block|{
literal|"band"
block|,
name|b_and
block|}
block|,
block|{
literal|"bnot"
block|,
name|b_not
block|}
block|,
block|{
literal|"bor"
block|,
name|b_or
block|}
block|,
block|{
literal|"bxor"
block|,
name|b_xor
block|}
block|,
block|{
literal|"btest"
block|,
name|b_test
block|}
block|,
block|{
literal|"extract"
block|,
name|b_extract
block|}
block|,
block|{
literal|"lrotate"
block|,
name|b_lrot
block|}
block|,
block|{
literal|"lshift"
block|,
name|b_lshift
block|}
block|,
block|{
literal|"replace"
block|,
name|b_replace
block|}
block|,
block|{
literal|"rrotate"
block|,
name|b_rrot
block|}
block|,
block|{
literal|"rshift"
block|,
name|b_rshift
block|}
block|,
block|{
name|NULL
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|LUAMOD_API
name|int
name|luaopen_bit32
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|)
block|{
name|luaL_newlib
argument_list|(
name|L
argument_list|,
name|bitlib
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

end_unit


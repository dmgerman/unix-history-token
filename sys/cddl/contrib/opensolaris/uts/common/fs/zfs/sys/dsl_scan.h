begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * CDDL HEADER START  *  * The contents of this file are subject to the terms of the  * Common Development and Distribution License (the "License").  * You may not use this file except in compliance with the License.  *  * You can obtain a copy of the license at usr/src/OPENSOLARIS.LICENSE  * or http://www.opensolaris.org/os/licensing.  * See the License for the specific language governing permissions  * and limitations under the License.  *  * When distributing Covered Code, include this CDDL HEADER in each  * file and include the License file at usr/src/OPENSOLARIS.LICENSE.  * If applicable, add the following below this CDDL HEADER, with the  * fields enclosed by brackets "[]" replaced with your own identifying  * information: Portions Copyright [yyyy] [name of copyright owner]  *  * CDDL HEADER END  */
end_comment

begin_comment
comment|/*  * Copyright (c) 2010, Oracle and/or its affiliates. All rights reserved.  * Copyright (c) 2013 by Delphix. All rights reserved.  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|_SYS_DSL_SCAN_H
end_ifndef

begin_define
define|#
directive|define
name|_SYS_DSL_SCAN_H
end_define

begin_include
include|#
directive|include
file|<sys/zfs_context.h>
end_include

begin_include
include|#
directive|include
file|<sys/zio.h>
end_include

begin_include
include|#
directive|include
file|<sys/ddt.h>
end_include

begin_include
include|#
directive|include
file|<sys/bplist.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|__cplusplus
end_ifdef

begin_extern
extern|extern
literal|"C"
block|{
endif|#
directive|endif
struct_decl|struct
name|objset
struct_decl|;
struct_decl|struct
name|dsl_dir
struct_decl|;
struct_decl|struct
name|dsl_dataset
struct_decl|;
struct_decl|struct
name|dsl_pool
struct_decl|;
struct_decl|struct
name|dmu_tx
struct_decl|;
comment|/*  * All members of this structure must be uint64_t, for byteswap  * purposes.  */
typedef|typedef
struct|struct
name|dsl_scan_phys
block|{
name|uint64_t
name|scn_func
decl_stmt|;
comment|/* pool_scan_func_t */
name|uint64_t
name|scn_state
decl_stmt|;
comment|/* dsl_scan_state_t */
name|uint64_t
name|scn_queue_obj
decl_stmt|;
name|uint64_t
name|scn_min_txg
decl_stmt|;
name|uint64_t
name|scn_max_txg
decl_stmt|;
name|uint64_t
name|scn_cur_min_txg
decl_stmt|;
name|uint64_t
name|scn_cur_max_txg
decl_stmt|;
name|uint64_t
name|scn_start_time
decl_stmt|;
name|uint64_t
name|scn_end_time
decl_stmt|;
name|uint64_t
name|scn_to_examine
decl_stmt|;
comment|/* total bytes to be scanned */
name|uint64_t
name|scn_examined
decl_stmt|;
comment|/* bytes scanned so far */
name|uint64_t
name|scn_to_process
decl_stmt|;
name|uint64_t
name|scn_processed
decl_stmt|;
name|uint64_t
name|scn_errors
decl_stmt|;
comment|/* scan I/O error count */
name|uint64_t
name|scn_ddt_class_max
decl_stmt|;
name|ddt_bookmark_t
name|scn_ddt_bookmark
decl_stmt|;
name|zbookmark_t
name|scn_bookmark
decl_stmt|;
name|uint64_t
name|scn_flags
decl_stmt|;
comment|/* dsl_scan_flags_t */
block|}
name|dsl_scan_phys_t
typedef|;
define|#
directive|define
name|SCAN_PHYS_NUMINTS
value|(sizeof (dsl_scan_phys_t) / sizeof (uint64_t))
typedef|typedef
enum|enum
name|dsl_scan_flags
block|{
name|DSF_VISIT_DS_AGAIN
init|=
literal|1
operator|<<
literal|0
block|, }
name|dsl_scan_flags_t
typedef|;
comment|/*  * Every pool will have one dsl_scan_t and this structure will contain  * in-memory information about the scan and a pointer to the on-disk  * representation (i.e. dsl_scan_phys_t). Most of the state of the scan  * is contained on-disk to allow the scan to resume in the event of a reboot  * or panic. This structure maintains information about the behavior of a  * running scan, some caching information, and how it should traverse the pool.  *  * The following members of this structure direct the behavior of the scan:  *  * scn_pausing -	a scan that cannot be completed in a single txg or  *			has exceeded its allotted time will need to pause.  *			When this flag is set the scanner will stop traversing  *			the pool and write out the current state to disk.  *  * scn_restart_txg -	directs the scanner to either restart or start a  *			a scan at the specified txg value.  *  * scn_done_txg -	when a scan completes its traversal it will set  *			the completion txg to the next txg. This is necessary  *			to ensure that any blocks that were freed during  *			the scan but have not yet been processed (i.e deferred  *			frees) are accounted for.  *  * This structure also maintains information about deferred frees which are  * a special kind of traversal. Deferred free can exist in either a bptree or  * a bpobj structure. The scn_is_bptree flag will indicate the type of  * deferred free that is in progress. If the deferred free is part of an  * asynchronous destroy then the scn_async_destroying flag will be set.  */
typedef|typedef
struct|struct
name|dsl_scan
block|{
name|struct
name|dsl_pool
modifier|*
name|scn_dp
decl_stmt|;
name|boolean_t
name|scn_pausing
decl_stmt|;
name|uint64_t
name|scn_restart_txg
decl_stmt|;
name|uint64_t
name|scn_done_txg
decl_stmt|;
name|uint64_t
name|scn_sync_start_time
decl_stmt|;
name|zio_t
modifier|*
name|scn_zio_root
decl_stmt|;
comment|/* for freeing blocks */
name|boolean_t
name|scn_is_bptree
decl_stmt|;
name|boolean_t
name|scn_async_destroying
decl_stmt|;
name|boolean_t
name|scn_async_stalled
decl_stmt|;
comment|/* for debugging / information */
name|uint64_t
name|scn_visited_this_txg
decl_stmt|;
name|dsl_scan_phys_t
name|scn_phys
decl_stmt|;
block|}
name|dsl_scan_t
typedef|;
name|int
name|dsl_scan_init
parameter_list|(
name|struct
name|dsl_pool
modifier|*
name|dp
parameter_list|,
name|uint64_t
name|txg
parameter_list|)
function_decl|;
name|void
name|dsl_scan_fini
parameter_list|(
name|struct
name|dsl_pool
modifier|*
name|dp
parameter_list|)
function_decl|;
name|void
name|dsl_scan_sync
parameter_list|(
name|struct
name|dsl_pool
modifier|*
parameter_list|,
name|dmu_tx_t
modifier|*
parameter_list|)
function_decl|;
name|int
name|dsl_scan_cancel
parameter_list|(
name|struct
name|dsl_pool
modifier|*
parameter_list|)
function_decl|;
name|int
name|dsl_scan
parameter_list|(
name|struct
name|dsl_pool
modifier|*
parameter_list|,
name|pool_scan_func_t
parameter_list|)
function_decl|;
name|void
name|dsl_resilver_restart
parameter_list|(
name|struct
name|dsl_pool
modifier|*
parameter_list|,
name|uint64_t
name|txg
parameter_list|)
function_decl|;
name|boolean_t
name|dsl_scan_resilvering
parameter_list|(
name|struct
name|dsl_pool
modifier|*
name|dp
parameter_list|)
function_decl|;
name|boolean_t
name|dsl_dataset_unstable
parameter_list|(
name|struct
name|dsl_dataset
modifier|*
name|ds
parameter_list|)
function_decl|;
name|void
name|dsl_scan_ddt_entry
parameter_list|(
name|dsl_scan_t
modifier|*
name|scn
parameter_list|,
name|enum
name|zio_checksum
name|checksum
parameter_list|,
name|ddt_entry_t
modifier|*
name|dde
parameter_list|,
name|dmu_tx_t
modifier|*
name|tx
parameter_list|)
function_decl|;
name|void
name|dsl_scan_ds_destroyed
parameter_list|(
name|struct
name|dsl_dataset
modifier|*
name|ds
parameter_list|,
name|struct
name|dmu_tx
modifier|*
name|tx
parameter_list|)
function_decl|;
name|void
name|dsl_scan_ds_snapshotted
parameter_list|(
name|struct
name|dsl_dataset
modifier|*
name|ds
parameter_list|,
name|struct
name|dmu_tx
modifier|*
name|tx
parameter_list|)
function_decl|;
name|void
name|dsl_scan_ds_clone_swapped
parameter_list|(
name|struct
name|dsl_dataset
modifier|*
name|ds1
parameter_list|,
name|struct
name|dsl_dataset
modifier|*
name|ds2
parameter_list|,
name|struct
name|dmu_tx
modifier|*
name|tx
parameter_list|)
function_decl|;
name|boolean_t
name|dsl_scan_active
parameter_list|(
name|dsl_scan_t
modifier|*
name|scn
parameter_list|)
function_decl|;
ifdef|#
directive|ifdef
name|__cplusplus
block|}
end_extern

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* _SYS_DSL_SCAN_H */
end_comment

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* ** $Id: ltm.c,v 2.14.1.1 2013/04/12 18:48:47 roberto Exp $ ** Tag methods ** See Copyright Notice in lua.h */
end_comment

begin_include
include|#
directive|include
file|<sys/zfs_context.h>
end_include

begin_define
define|#
directive|define
name|ltm_c
end_define

begin_define
define|#
directive|define
name|LUA_CORE
end_define

begin_include
include|#
directive|include
file|"lua.h"
end_include

begin_include
include|#
directive|include
file|"lobject.h"
end_include

begin_include
include|#
directive|include
file|"lstate.h"
end_include

begin_include
include|#
directive|include
file|"lstring.h"
end_include

begin_include
include|#
directive|include
file|"ltable.h"
end_include

begin_include
include|#
directive|include
file|"ltm.h"
end_include

begin_decl_stmt
specifier|static
specifier|const
name|char
name|udatatypename
index|[]
init|=
literal|"userdata"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|LUAI_DDEF
specifier|const
name|char
modifier|*
specifier|const
name|luaT_typenames_
index|[
name|LUA_TOTALTAGS
index|]
init|=
block|{
literal|"no value"
block|,
literal|"nil"
block|,
literal|"boolean"
block|,
name|udatatypename
block|,
literal|"number"
block|,
literal|"string"
block|,
literal|"table"
block|,
literal|"function"
block|,
name|udatatypename
block|,
literal|"thread"
block|,
literal|"proto"
block|,
literal|"upval"
comment|/* these last two cases are used for tests only */
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|luaT_init
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|)
block|{
specifier|static
specifier|const
name|char
modifier|*
specifier|const
name|luaT_eventname
index|[]
init|=
block|{
comment|/* ORDER TM */
literal|"__index"
block|,
literal|"__newindex"
block|,
literal|"__gc"
block|,
literal|"__mode"
block|,
literal|"__len"
block|,
literal|"__eq"
block|,
literal|"__add"
block|,
literal|"__sub"
block|,
literal|"__mul"
block|,
literal|"__div"
block|,
literal|"__mod"
block|,
literal|"__pow"
block|,
literal|"__unm"
block|,
literal|"__lt"
block|,
literal|"__le"
block|,
literal|"__concat"
block|,
literal|"__call"
block|}
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|TM_N
condition|;
name|i
operator|++
control|)
block|{
name|G
argument_list|(
name|L
argument_list|)
operator|->
name|tmname
index|[
name|i
index|]
operator|=
name|luaS_new
argument_list|(
name|L
argument_list|,
name|luaT_eventname
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|luaS_fix
argument_list|(
name|G
argument_list|(
name|L
argument_list|)
operator|->
name|tmname
index|[
name|i
index|]
argument_list|)
expr_stmt|;
comment|/* never collect these names */
block|}
block|}
end_function

begin_comment
comment|/* ** function to be used with macro "fasttm": optimized for absence of ** tag methods */
end_comment

begin_function
specifier|const
name|TValue
modifier|*
name|luaT_gettm
parameter_list|(
name|Table
modifier|*
name|events
parameter_list|,
name|TMS
name|event
parameter_list|,
name|TString
modifier|*
name|ename
parameter_list|)
block|{
specifier|const
name|TValue
modifier|*
name|tm
init|=
name|luaH_getstr
argument_list|(
name|events
argument_list|,
name|ename
argument_list|)
decl_stmt|;
name|lua_assert
argument_list|(
name|event
operator|<=
name|TM_EQ
argument_list|)
expr_stmt|;
if|if
condition|(
name|ttisnil
argument_list|(
name|tm
argument_list|)
condition|)
block|{
comment|/* no tag method? */
name|events
operator|->
name|flags
operator||=
name|cast_byte
argument_list|(
literal|1u
operator|<<
name|event
argument_list|)
expr_stmt|;
comment|/* cache this fact */
return|return
name|NULL
return|;
block|}
else|else
return|return
name|tm
return|;
block|}
end_function

begin_function
specifier|const
name|TValue
modifier|*
name|luaT_gettmbyobj
parameter_list|(
name|lua_State
modifier|*
name|L
parameter_list|,
specifier|const
name|TValue
modifier|*
name|o
parameter_list|,
name|TMS
name|event
parameter_list|)
block|{
name|Table
modifier|*
name|mt
decl_stmt|;
switch|switch
condition|(
name|ttypenv
argument_list|(
name|o
argument_list|)
condition|)
block|{
case|case
name|LUA_TTABLE
case|:
name|mt
operator|=
name|hvalue
argument_list|(
name|o
argument_list|)
operator|->
name|metatable
expr_stmt|;
break|break;
case|case
name|LUA_TUSERDATA
case|:
name|mt
operator|=
name|uvalue
argument_list|(
name|o
argument_list|)
operator|->
name|metatable
expr_stmt|;
break|break;
default|default:
name|mt
operator|=
name|G
argument_list|(
name|L
argument_list|)
operator|->
name|mt
index|[
name|ttypenv
argument_list|(
name|o
argument_list|)
index|]
expr_stmt|;
block|}
return|return
operator|(
name|mt
condition|?
name|luaH_getstr
argument_list|(
name|mt
argument_list|,
name|G
argument_list|(
name|L
argument_list|)
operator|->
name|tmname
index|[
name|event
index|]
argument_list|)
else|:
name|luaO_nilobject
operator|)
return|;
block|}
end_function

end_unit


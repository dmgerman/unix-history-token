begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * CDDL HEADER START  *  * The contents of this file are subject to the terms of the  * Common Development and Distribution License (the "License").  * You may not use this file except in compliance with the License.  *  * You can obtain a copy of the license at usr/src/OPENSOLARIS.LICENSE  * or http://www.opensolaris.org/os/licensing.  * See the License for the specific language governing permissions  * and limitations under the License.  *  * When distributing Covered Code, include this CDDL HEADER in each  * file and include the License file at usr/src/OPENSOLARIS.LICENSE.  * If applicable, add the following below this CDDL HEADER, with the  * fields enclosed by brackets "[]" replaced with your own identifying  * information: Portions Copyright [yyyy] [name of copyright owner]  *  * CDDL HEADER END  */
end_comment

begin_comment
comment|/*  * Copyright 2013 Martin Matuska<mm@FreeBSD.org>. All rights reserved.  * Portions Copyright 2005, 2010, Oracle and/or its affiliates.  * All rights reserved.  * Use is subject to license terms.  */
end_comment

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/cred.h>
end_include

begin_include
include|#
directive|include
file|<sys/dmu.h>
end_include

begin_include
include|#
directive|include
file|<sys/zio.h>
end_include

begin_include
include|#
directive|include
file|<sys/nvpair.h>
end_include

begin_include
include|#
directive|include
file|<sys/dsl_deleg.h>
end_include

begin_include
include|#
directive|include
file|<sys/zfs_ioctl.h>
end_include

begin_include
include|#
directive|include
file|"zfs_namecheck.h"
end_include

begin_include
include|#
directive|include
file|"zfs_ioctl_compat.h"
end_include

begin_decl_stmt
specifier|static
name|int
name|zfs_version_ioctl
init|=
name|ZFS_IOCVER_CURRENT
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|SYSCTL_DECL
argument_list|(
name|_vfs_zfs_version
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_vfs_zfs_version
argument_list|,
name|OID_AUTO
argument_list|,
name|ioctl
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|zfs_version_ioctl
argument_list|,
literal|0
argument_list|,
literal|"ZFS_IOCTL_VERSION"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*  * FreeBSD zfs_cmd compatibility with older binaries  * appropriately remap/extend the zfs_cmd_t structure  */
end_comment

begin_function
name|void
name|zfs_cmd_compat_get
parameter_list|(
name|zfs_cmd_t
modifier|*
name|zc
parameter_list|,
name|caddr_t
name|addr
parameter_list|,
specifier|const
name|int
name|cflag
parameter_list|)
block|{
name|zfs_cmd_v15_t
modifier|*
name|zc_c
decl_stmt|;
name|zfs_cmd_v28_t
modifier|*
name|zc28_c
decl_stmt|;
name|zfs_cmd_deadman_t
modifier|*
name|zcdm_c
decl_stmt|;
switch|switch
condition|(
name|cflag
condition|)
block|{
case|case
name|ZFS_CMD_COMPAT_DEADMAN
case|:
name|zcdm_c
operator|=
operator|(
name|void
operator|*
operator|)
name|addr
expr_stmt|;
comment|/* zc */
name|strlcpy
argument_list|(
name|zc
operator|->
name|zc_name
argument_list|,
name|zcdm_c
operator|->
name|zc_name
argument_list|,
name|MAXPATHLEN
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|zc
operator|->
name|zc_value
argument_list|,
name|zcdm_c
operator|->
name|zc_value
argument_list|,
name|MAXPATHLEN
operator|*
literal|2
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|zc
operator|->
name|zc_string
argument_list|,
name|zcdm_c
operator|->
name|zc_string
argument_list|,
name|MAXPATHLEN
argument_list|)
expr_stmt|;
name|zc
operator|->
name|zc_guid
operator|=
name|zcdm_c
operator|->
name|zc_guid
expr_stmt|;
name|zc
operator|->
name|zc_nvlist_conf
operator|=
name|zcdm_c
operator|->
name|zc_nvlist_conf
expr_stmt|;
name|zc
operator|->
name|zc_nvlist_conf_size
operator|=
name|zcdm_c
operator|->
name|zc_nvlist_conf_size
expr_stmt|;
name|zc
operator|->
name|zc_nvlist_src
operator|=
name|zcdm_c
operator|->
name|zc_nvlist_src
expr_stmt|;
name|zc
operator|->
name|zc_nvlist_src_size
operator|=
name|zcdm_c
operator|->
name|zc_nvlist_src_size
expr_stmt|;
name|zc
operator|->
name|zc_nvlist_dst
operator|=
name|zcdm_c
operator|->
name|zc_nvlist_dst
expr_stmt|;
name|zc
operator|->
name|zc_nvlist_dst_size
operator|=
name|zcdm_c
operator|->
name|zc_nvlist_dst_size
expr_stmt|;
name|zc
operator|->
name|zc_cookie
operator|=
name|zcdm_c
operator|->
name|zc_cookie
expr_stmt|;
name|zc
operator|->
name|zc_objset_type
operator|=
name|zcdm_c
operator|->
name|zc_objset_type
expr_stmt|;
name|zc
operator|->
name|zc_perm_action
operator|=
name|zcdm_c
operator|->
name|zc_perm_action
expr_stmt|;
name|zc
operator|->
name|zc_history
operator|=
name|zcdm_c
operator|->
name|zc_history
expr_stmt|;
name|zc
operator|->
name|zc_history_len
operator|=
name|zcdm_c
operator|->
name|zc_history_len
expr_stmt|;
name|zc
operator|->
name|zc_history_offset
operator|=
name|zcdm_c
operator|->
name|zc_history_offset
expr_stmt|;
name|zc
operator|->
name|zc_obj
operator|=
name|zcdm_c
operator|->
name|zc_obj
expr_stmt|;
name|zc
operator|->
name|zc_iflags
operator|=
name|zcdm_c
operator|->
name|zc_iflags
expr_stmt|;
name|zc
operator|->
name|zc_share
operator|=
name|zcdm_c
operator|->
name|zc_share
expr_stmt|;
name|zc
operator|->
name|zc_jailid
operator|=
name|zcdm_c
operator|->
name|zc_jailid
expr_stmt|;
name|zc
operator|->
name|zc_objset_stats
operator|=
name|zcdm_c
operator|->
name|zc_objset_stats
expr_stmt|;
name|zc
operator|->
name|zc_begin_record
operator|=
name|zcdm_c
operator|->
name|zc_begin_record
expr_stmt|;
name|zc
operator|->
name|zc_defer_destroy
operator|=
name|zcdm_c
operator|->
name|zc_defer_destroy
expr_stmt|;
name|zc
operator|->
name|zc_temphold
operator|=
name|zcdm_c
operator|->
name|zc_temphold
expr_stmt|;
name|zc
operator|->
name|zc_action_handle
operator|=
name|zcdm_c
operator|->
name|zc_action_handle
expr_stmt|;
name|zc
operator|->
name|zc_cleanup_fd
operator|=
name|zcdm_c
operator|->
name|zc_cleanup_fd
expr_stmt|;
name|zc
operator|->
name|zc_simple
operator|=
name|zcdm_c
operator|->
name|zc_simple
expr_stmt|;
name|bcopy
argument_list|(
name|zcdm_c
operator|->
name|zc_pad
argument_list|,
name|zc
operator|->
name|zc_pad
argument_list|,
sizeof|sizeof
argument_list|(
name|zc
operator|->
name|zc_pad
argument_list|)
argument_list|)
expr_stmt|;
name|zc
operator|->
name|zc_sendobj
operator|=
name|zcdm_c
operator|->
name|zc_sendobj
expr_stmt|;
name|zc
operator|->
name|zc_fromobj
operator|=
name|zcdm_c
operator|->
name|zc_fromobj
expr_stmt|;
name|zc
operator|->
name|zc_createtxg
operator|=
name|zcdm_c
operator|->
name|zc_createtxg
expr_stmt|;
name|zc
operator|->
name|zc_stat
operator|=
name|zcdm_c
operator|->
name|zc_stat
expr_stmt|;
comment|/* zc_inject_record doesn't change in libzfs_core */
name|zcdm_c
operator|->
name|zc_inject_record
operator|=
name|zc
operator|->
name|zc_inject_record
expr_stmt|;
comment|/* we always assume zc_nvlist_dst_filled is true */
name|zc
operator|->
name|zc_nvlist_dst_filled
operator|=
name|B_TRUE
expr_stmt|;
break|break;
case|case
name|ZFS_CMD_COMPAT_V28
case|:
name|zc28_c
operator|=
operator|(
name|void
operator|*
operator|)
name|addr
expr_stmt|;
comment|/* zc */
name|strlcpy
argument_list|(
name|zc
operator|->
name|zc_name
argument_list|,
name|zc28_c
operator|->
name|zc_name
argument_list|,
name|MAXPATHLEN
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|zc
operator|->
name|zc_value
argument_list|,
name|zc28_c
operator|->
name|zc_value
argument_list|,
name|MAXPATHLEN
operator|*
literal|2
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|zc
operator|->
name|zc_string
argument_list|,
name|zc28_c
operator|->
name|zc_string
argument_list|,
name|MAXPATHLEN
argument_list|)
expr_stmt|;
name|zc
operator|->
name|zc_guid
operator|=
name|zc28_c
operator|->
name|zc_guid
expr_stmt|;
name|zc
operator|->
name|zc_nvlist_conf
operator|=
name|zc28_c
operator|->
name|zc_nvlist_conf
expr_stmt|;
name|zc
operator|->
name|zc_nvlist_conf_size
operator|=
name|zc28_c
operator|->
name|zc_nvlist_conf_size
expr_stmt|;
name|zc
operator|->
name|zc_nvlist_src
operator|=
name|zc28_c
operator|->
name|zc_nvlist_src
expr_stmt|;
name|zc
operator|->
name|zc_nvlist_src_size
operator|=
name|zc28_c
operator|->
name|zc_nvlist_src_size
expr_stmt|;
name|zc
operator|->
name|zc_nvlist_dst
operator|=
name|zc28_c
operator|->
name|zc_nvlist_dst
expr_stmt|;
name|zc
operator|->
name|zc_nvlist_dst_size
operator|=
name|zc28_c
operator|->
name|zc_nvlist_dst_size
expr_stmt|;
name|zc
operator|->
name|zc_cookie
operator|=
name|zc28_c
operator|->
name|zc_cookie
expr_stmt|;
name|zc
operator|->
name|zc_objset_type
operator|=
name|zc28_c
operator|->
name|zc_objset_type
expr_stmt|;
name|zc
operator|->
name|zc_perm_action
operator|=
name|zc28_c
operator|->
name|zc_perm_action
expr_stmt|;
name|zc
operator|->
name|zc_history
operator|=
name|zc28_c
operator|->
name|zc_history
expr_stmt|;
name|zc
operator|->
name|zc_history_len
operator|=
name|zc28_c
operator|->
name|zc_history_len
expr_stmt|;
name|zc
operator|->
name|zc_history_offset
operator|=
name|zc28_c
operator|->
name|zc_history_offset
expr_stmt|;
name|zc
operator|->
name|zc_obj
operator|=
name|zc28_c
operator|->
name|zc_obj
expr_stmt|;
name|zc
operator|->
name|zc_iflags
operator|=
name|zc28_c
operator|->
name|zc_iflags
expr_stmt|;
name|zc
operator|->
name|zc_share
operator|=
name|zc28_c
operator|->
name|zc_share
expr_stmt|;
name|zc
operator|->
name|zc_jailid
operator|=
name|zc28_c
operator|->
name|zc_jailid
expr_stmt|;
name|zc
operator|->
name|zc_objset_stats
operator|=
name|zc28_c
operator|->
name|zc_objset_stats
expr_stmt|;
name|zc
operator|->
name|zc_begin_record
operator|=
name|zc28_c
operator|->
name|zc_begin_record
expr_stmt|;
name|zc
operator|->
name|zc_defer_destroy
operator|=
name|zc28_c
operator|->
name|zc_defer_destroy
expr_stmt|;
name|zc
operator|->
name|zc_temphold
operator|=
name|zc28_c
operator|->
name|zc_temphold
expr_stmt|;
name|zc
operator|->
name|zc_action_handle
operator|=
name|zc28_c
operator|->
name|zc_action_handle
expr_stmt|;
name|zc
operator|->
name|zc_cleanup_fd
operator|=
name|zc28_c
operator|->
name|zc_cleanup_fd
expr_stmt|;
name|zc
operator|->
name|zc_simple
operator|=
name|zc28_c
operator|->
name|zc_simple
expr_stmt|;
name|bcopy
argument_list|(
name|zc28_c
operator|->
name|zc_pad
argument_list|,
name|zc
operator|->
name|zc_pad
argument_list|,
sizeof|sizeof
argument_list|(
name|zc
operator|->
name|zc_pad
argument_list|)
argument_list|)
expr_stmt|;
name|zc
operator|->
name|zc_sendobj
operator|=
name|zc28_c
operator|->
name|zc_sendobj
expr_stmt|;
name|zc
operator|->
name|zc_fromobj
operator|=
name|zc28_c
operator|->
name|zc_fromobj
expr_stmt|;
name|zc
operator|->
name|zc_createtxg
operator|=
name|zc28_c
operator|->
name|zc_createtxg
expr_stmt|;
name|zc
operator|->
name|zc_stat
operator|=
name|zc28_c
operator|->
name|zc_stat
expr_stmt|;
comment|/* zc->zc_inject_record */
name|zc
operator|->
name|zc_inject_record
operator|.
name|zi_objset
operator|=
name|zc28_c
operator|->
name|zc_inject_record
operator|.
name|zi_objset
expr_stmt|;
name|zc
operator|->
name|zc_inject_record
operator|.
name|zi_object
operator|=
name|zc28_c
operator|->
name|zc_inject_record
operator|.
name|zi_object
expr_stmt|;
name|zc
operator|->
name|zc_inject_record
operator|.
name|zi_start
operator|=
name|zc28_c
operator|->
name|zc_inject_record
operator|.
name|zi_start
expr_stmt|;
name|zc
operator|->
name|zc_inject_record
operator|.
name|zi_end
operator|=
name|zc28_c
operator|->
name|zc_inject_record
operator|.
name|zi_end
expr_stmt|;
name|zc
operator|->
name|zc_inject_record
operator|.
name|zi_guid
operator|=
name|zc28_c
operator|->
name|zc_inject_record
operator|.
name|zi_guid
expr_stmt|;
name|zc
operator|->
name|zc_inject_record
operator|.
name|zi_level
operator|=
name|zc28_c
operator|->
name|zc_inject_record
operator|.
name|zi_level
expr_stmt|;
name|zc
operator|->
name|zc_inject_record
operator|.
name|zi_error
operator|=
name|zc28_c
operator|->
name|zc_inject_record
operator|.
name|zi_error
expr_stmt|;
name|zc
operator|->
name|zc_inject_record
operator|.
name|zi_type
operator|=
name|zc28_c
operator|->
name|zc_inject_record
operator|.
name|zi_type
expr_stmt|;
name|zc
operator|->
name|zc_inject_record
operator|.
name|zi_freq
operator|=
name|zc28_c
operator|->
name|zc_inject_record
operator|.
name|zi_freq
expr_stmt|;
name|zc
operator|->
name|zc_inject_record
operator|.
name|zi_failfast
operator|=
name|zc28_c
operator|->
name|zc_inject_record
operator|.
name|zi_failfast
expr_stmt|;
name|strlcpy
argument_list|(
name|zc
operator|->
name|zc_inject_record
operator|.
name|zi_func
argument_list|,
name|zc28_c
operator|->
name|zc_inject_record
operator|.
name|zi_func
argument_list|,
name|MAXNAMELEN
argument_list|)
expr_stmt|;
name|zc
operator|->
name|zc_inject_record
operator|.
name|zi_iotype
operator|=
name|zc28_c
operator|->
name|zc_inject_record
operator|.
name|zi_iotype
expr_stmt|;
name|zc
operator|->
name|zc_inject_record
operator|.
name|zi_duration
operator|=
name|zc28_c
operator|->
name|zc_inject_record
operator|.
name|zi_duration
expr_stmt|;
name|zc
operator|->
name|zc_inject_record
operator|.
name|zi_timer
operator|=
name|zc28_c
operator|->
name|zc_inject_record
operator|.
name|zi_timer
expr_stmt|;
name|zc
operator|->
name|zc_inject_record
operator|.
name|zi_cmd
operator|=
name|ZINJECT_UNINITIALIZED
expr_stmt|;
name|zc
operator|->
name|zc_inject_record
operator|.
name|zi_pad
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|ZFS_CMD_COMPAT_V15
case|:
name|zc_c
operator|=
operator|(
name|void
operator|*
operator|)
name|addr
expr_stmt|;
comment|/* zc */
name|strlcpy
argument_list|(
name|zc
operator|->
name|zc_name
argument_list|,
name|zc_c
operator|->
name|zc_name
argument_list|,
name|MAXPATHLEN
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|zc
operator|->
name|zc_value
argument_list|,
name|zc_c
operator|->
name|zc_value
argument_list|,
name|MAXPATHLEN
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|zc
operator|->
name|zc_string
argument_list|,
name|zc_c
operator|->
name|zc_string
argument_list|,
name|MAXPATHLEN
argument_list|)
expr_stmt|;
name|zc
operator|->
name|zc_guid
operator|=
name|zc_c
operator|->
name|zc_guid
expr_stmt|;
name|zc
operator|->
name|zc_nvlist_conf
operator|=
name|zc_c
operator|->
name|zc_nvlist_conf
expr_stmt|;
name|zc
operator|->
name|zc_nvlist_conf_size
operator|=
name|zc_c
operator|->
name|zc_nvlist_conf_size
expr_stmt|;
name|zc
operator|->
name|zc_nvlist_src
operator|=
name|zc_c
operator|->
name|zc_nvlist_src
expr_stmt|;
name|zc
operator|->
name|zc_nvlist_src_size
operator|=
name|zc_c
operator|->
name|zc_nvlist_src_size
expr_stmt|;
name|zc
operator|->
name|zc_nvlist_dst
operator|=
name|zc_c
operator|->
name|zc_nvlist_dst
expr_stmt|;
name|zc
operator|->
name|zc_nvlist_dst_size
operator|=
name|zc_c
operator|->
name|zc_nvlist_dst_size
expr_stmt|;
name|zc
operator|->
name|zc_cookie
operator|=
name|zc_c
operator|->
name|zc_cookie
expr_stmt|;
name|zc
operator|->
name|zc_objset_type
operator|=
name|zc_c
operator|->
name|zc_objset_type
expr_stmt|;
name|zc
operator|->
name|zc_perm_action
operator|=
name|zc_c
operator|->
name|zc_perm_action
expr_stmt|;
name|zc
operator|->
name|zc_history
operator|=
name|zc_c
operator|->
name|zc_history
expr_stmt|;
name|zc
operator|->
name|zc_history_len
operator|=
name|zc_c
operator|->
name|zc_history_len
expr_stmt|;
name|zc
operator|->
name|zc_history_offset
operator|=
name|zc_c
operator|->
name|zc_history_offset
expr_stmt|;
name|zc
operator|->
name|zc_obj
operator|=
name|zc_c
operator|->
name|zc_obj
expr_stmt|;
name|zc
operator|->
name|zc_share
operator|=
name|zc_c
operator|->
name|zc_share
expr_stmt|;
name|zc
operator|->
name|zc_jailid
operator|=
name|zc_c
operator|->
name|zc_jailid
expr_stmt|;
name|zc
operator|->
name|zc_objset_stats
operator|=
name|zc_c
operator|->
name|zc_objset_stats
expr_stmt|;
name|zc
operator|->
name|zc_begin_record
operator|=
name|zc_c
operator|->
name|zc_begin_record
expr_stmt|;
comment|/* zc->zc_inject_record */
name|zc
operator|->
name|zc_inject_record
operator|.
name|zi_objset
operator|=
name|zc_c
operator|->
name|zc_inject_record
operator|.
name|zi_objset
expr_stmt|;
name|zc
operator|->
name|zc_inject_record
operator|.
name|zi_object
operator|=
name|zc_c
operator|->
name|zc_inject_record
operator|.
name|zi_object
expr_stmt|;
name|zc
operator|->
name|zc_inject_record
operator|.
name|zi_start
operator|=
name|zc_c
operator|->
name|zc_inject_record
operator|.
name|zi_start
expr_stmt|;
name|zc
operator|->
name|zc_inject_record
operator|.
name|zi_end
operator|=
name|zc_c
operator|->
name|zc_inject_record
operator|.
name|zi_end
expr_stmt|;
name|zc
operator|->
name|zc_inject_record
operator|.
name|zi_guid
operator|=
name|zc_c
operator|->
name|zc_inject_record
operator|.
name|zi_guid
expr_stmt|;
name|zc
operator|->
name|zc_inject_record
operator|.
name|zi_level
operator|=
name|zc_c
operator|->
name|zc_inject_record
operator|.
name|zi_level
expr_stmt|;
name|zc
operator|->
name|zc_inject_record
operator|.
name|zi_error
operator|=
name|zc_c
operator|->
name|zc_inject_record
operator|.
name|zi_error
expr_stmt|;
name|zc
operator|->
name|zc_inject_record
operator|.
name|zi_type
operator|=
name|zc_c
operator|->
name|zc_inject_record
operator|.
name|zi_type
expr_stmt|;
name|zc
operator|->
name|zc_inject_record
operator|.
name|zi_freq
operator|=
name|zc_c
operator|->
name|zc_inject_record
operator|.
name|zi_freq
expr_stmt|;
name|zc
operator|->
name|zc_inject_record
operator|.
name|zi_failfast
operator|=
name|zc_c
operator|->
name|zc_inject_record
operator|.
name|zi_failfast
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
name|void
name|zfs_cmd_compat_put
parameter_list|(
name|zfs_cmd_t
modifier|*
name|zc
parameter_list|,
name|caddr_t
name|addr
parameter_list|,
specifier|const
name|int
name|request
parameter_list|,
specifier|const
name|int
name|cflag
parameter_list|)
block|{
name|zfs_cmd_v15_t
modifier|*
name|zc_c
decl_stmt|;
name|zfs_cmd_v28_t
modifier|*
name|zc28_c
decl_stmt|;
name|zfs_cmd_deadman_t
modifier|*
name|zcdm_c
decl_stmt|;
switch|switch
condition|(
name|cflag
condition|)
block|{
case|case
name|ZFS_CMD_COMPAT_DEADMAN
case|:
name|zcdm_c
operator|=
operator|(
name|void
operator|*
operator|)
name|addr
expr_stmt|;
name|strlcpy
argument_list|(
name|zcdm_c
operator|->
name|zc_name
argument_list|,
name|zc
operator|->
name|zc_name
argument_list|,
name|MAXPATHLEN
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|zcdm_c
operator|->
name|zc_value
argument_list|,
name|zc
operator|->
name|zc_value
argument_list|,
name|MAXPATHLEN
operator|*
literal|2
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|zcdm_c
operator|->
name|zc_string
argument_list|,
name|zc
operator|->
name|zc_string
argument_list|,
name|MAXPATHLEN
argument_list|)
expr_stmt|;
name|zcdm_c
operator|->
name|zc_guid
operator|=
name|zc
operator|->
name|zc_guid
expr_stmt|;
name|zcdm_c
operator|->
name|zc_nvlist_conf
operator|=
name|zc
operator|->
name|zc_nvlist_conf
expr_stmt|;
name|zcdm_c
operator|->
name|zc_nvlist_conf_size
operator|=
name|zc
operator|->
name|zc_nvlist_conf_size
expr_stmt|;
name|zcdm_c
operator|->
name|zc_nvlist_src
operator|=
name|zc
operator|->
name|zc_nvlist_src
expr_stmt|;
name|zcdm_c
operator|->
name|zc_nvlist_src_size
operator|=
name|zc
operator|->
name|zc_nvlist_src_size
expr_stmt|;
name|zcdm_c
operator|->
name|zc_nvlist_dst
operator|=
name|zc
operator|->
name|zc_nvlist_dst
expr_stmt|;
name|zcdm_c
operator|->
name|zc_nvlist_dst_size
operator|=
name|zc
operator|->
name|zc_nvlist_dst_size
expr_stmt|;
name|zcdm_c
operator|->
name|zc_cookie
operator|=
name|zc
operator|->
name|zc_cookie
expr_stmt|;
name|zcdm_c
operator|->
name|zc_objset_type
operator|=
name|zc
operator|->
name|zc_objset_type
expr_stmt|;
name|zcdm_c
operator|->
name|zc_perm_action
operator|=
name|zc
operator|->
name|zc_perm_action
expr_stmt|;
name|zcdm_c
operator|->
name|zc_history
operator|=
name|zc
operator|->
name|zc_history
expr_stmt|;
name|zcdm_c
operator|->
name|zc_history_len
operator|=
name|zc
operator|->
name|zc_history_len
expr_stmt|;
name|zcdm_c
operator|->
name|zc_history_offset
operator|=
name|zc
operator|->
name|zc_history_offset
expr_stmt|;
name|zcdm_c
operator|->
name|zc_obj
operator|=
name|zc
operator|->
name|zc_obj
expr_stmt|;
name|zcdm_c
operator|->
name|zc_iflags
operator|=
name|zc
operator|->
name|zc_iflags
expr_stmt|;
name|zcdm_c
operator|->
name|zc_share
operator|=
name|zc
operator|->
name|zc_share
expr_stmt|;
name|zcdm_c
operator|->
name|zc_jailid
operator|=
name|zc
operator|->
name|zc_jailid
expr_stmt|;
name|zcdm_c
operator|->
name|zc_objset_stats
operator|=
name|zc
operator|->
name|zc_objset_stats
expr_stmt|;
name|zcdm_c
operator|->
name|zc_begin_record
operator|=
name|zc
operator|->
name|zc_begin_record
expr_stmt|;
name|zcdm_c
operator|->
name|zc_defer_destroy
operator|=
name|zc
operator|->
name|zc_defer_destroy
expr_stmt|;
name|zcdm_c
operator|->
name|zc_temphold
operator|=
name|zc
operator|->
name|zc_temphold
expr_stmt|;
name|zcdm_c
operator|->
name|zc_action_handle
operator|=
name|zc
operator|->
name|zc_action_handle
expr_stmt|;
name|zcdm_c
operator|->
name|zc_cleanup_fd
operator|=
name|zc
operator|->
name|zc_cleanup_fd
expr_stmt|;
name|zcdm_c
operator|->
name|zc_simple
operator|=
name|zc
operator|->
name|zc_simple
expr_stmt|;
name|bcopy
argument_list|(
name|zc
operator|->
name|zc_pad
argument_list|,
name|zcdm_c
operator|->
name|zc_pad
argument_list|,
sizeof|sizeof
argument_list|(
name|zcdm_c
operator|->
name|zc_pad
argument_list|)
argument_list|)
expr_stmt|;
name|zcdm_c
operator|->
name|zc_sendobj
operator|=
name|zc
operator|->
name|zc_sendobj
expr_stmt|;
name|zcdm_c
operator|->
name|zc_fromobj
operator|=
name|zc
operator|->
name|zc_fromobj
expr_stmt|;
name|zcdm_c
operator|->
name|zc_createtxg
operator|=
name|zc
operator|->
name|zc_createtxg
expr_stmt|;
name|zcdm_c
operator|->
name|zc_stat
operator|=
name|zc
operator|->
name|zc_stat
expr_stmt|;
comment|/* zc_inject_record doesn't change in libzfs_core */
name|zc
operator|->
name|zc_inject_record
operator|=
name|zcdm_c
operator|->
name|zc_inject_record
expr_stmt|;
ifndef|#
directive|ifndef
name|_KERNEL
if|if
condition|(
name|request
operator|==
name|ZFS_IOC_RECV
condition|)
name|strlcpy
argument_list|(
name|zcdm_c
operator|->
name|zc_top_ds
argument_list|,
name|zc
operator|->
name|zc_value
operator|+
name|strlen
argument_list|(
name|zc
operator|->
name|zc_value
argument_list|)
operator|+
literal|1
argument_list|,
operator|(
name|MAXPATHLEN
operator|*
literal|2
operator|)
operator|-
name|strlen
argument_list|(
name|zc
operator|->
name|zc_value
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
name|ZFS_CMD_COMPAT_V28
case|:
name|zc28_c
operator|=
operator|(
name|void
operator|*
operator|)
name|addr
expr_stmt|;
name|strlcpy
argument_list|(
name|zc28_c
operator|->
name|zc_name
argument_list|,
name|zc
operator|->
name|zc_name
argument_list|,
name|MAXPATHLEN
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|zc28_c
operator|->
name|zc_value
argument_list|,
name|zc
operator|->
name|zc_value
argument_list|,
name|MAXPATHLEN
operator|*
literal|2
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|zc28_c
operator|->
name|zc_string
argument_list|,
name|zc
operator|->
name|zc_string
argument_list|,
name|MAXPATHLEN
argument_list|)
expr_stmt|;
name|zc28_c
operator|->
name|zc_guid
operator|=
name|zc
operator|->
name|zc_guid
expr_stmt|;
name|zc28_c
operator|->
name|zc_nvlist_conf
operator|=
name|zc
operator|->
name|zc_nvlist_conf
expr_stmt|;
name|zc28_c
operator|->
name|zc_nvlist_conf_size
operator|=
name|zc
operator|->
name|zc_nvlist_conf_size
expr_stmt|;
name|zc28_c
operator|->
name|zc_nvlist_src
operator|=
name|zc
operator|->
name|zc_nvlist_src
expr_stmt|;
name|zc28_c
operator|->
name|zc_nvlist_src_size
operator|=
name|zc
operator|->
name|zc_nvlist_src_size
expr_stmt|;
name|zc28_c
operator|->
name|zc_nvlist_dst
operator|=
name|zc
operator|->
name|zc_nvlist_dst
expr_stmt|;
name|zc28_c
operator|->
name|zc_nvlist_dst_size
operator|=
name|zc
operator|->
name|zc_nvlist_dst_size
expr_stmt|;
name|zc28_c
operator|->
name|zc_cookie
operator|=
name|zc
operator|->
name|zc_cookie
expr_stmt|;
name|zc28_c
operator|->
name|zc_objset_type
operator|=
name|zc
operator|->
name|zc_objset_type
expr_stmt|;
name|zc28_c
operator|->
name|zc_perm_action
operator|=
name|zc
operator|->
name|zc_perm_action
expr_stmt|;
name|zc28_c
operator|->
name|zc_history
operator|=
name|zc
operator|->
name|zc_history
expr_stmt|;
name|zc28_c
operator|->
name|zc_history_len
operator|=
name|zc
operator|->
name|zc_history_len
expr_stmt|;
name|zc28_c
operator|->
name|zc_history_offset
operator|=
name|zc
operator|->
name|zc_history_offset
expr_stmt|;
name|zc28_c
operator|->
name|zc_obj
operator|=
name|zc
operator|->
name|zc_obj
expr_stmt|;
name|zc28_c
operator|->
name|zc_iflags
operator|=
name|zc
operator|->
name|zc_iflags
expr_stmt|;
name|zc28_c
operator|->
name|zc_share
operator|=
name|zc
operator|->
name|zc_share
expr_stmt|;
name|zc28_c
operator|->
name|zc_jailid
operator|=
name|zc
operator|->
name|zc_jailid
expr_stmt|;
name|zc28_c
operator|->
name|zc_objset_stats
operator|=
name|zc
operator|->
name|zc_objset_stats
expr_stmt|;
name|zc28_c
operator|->
name|zc_begin_record
operator|=
name|zc
operator|->
name|zc_begin_record
expr_stmt|;
name|zc28_c
operator|->
name|zc_defer_destroy
operator|=
name|zc
operator|->
name|zc_defer_destroy
expr_stmt|;
name|zc28_c
operator|->
name|zc_temphold
operator|=
name|zc
operator|->
name|zc_temphold
expr_stmt|;
name|zc28_c
operator|->
name|zc_action_handle
operator|=
name|zc
operator|->
name|zc_action_handle
expr_stmt|;
name|zc28_c
operator|->
name|zc_cleanup_fd
operator|=
name|zc
operator|->
name|zc_cleanup_fd
expr_stmt|;
name|zc28_c
operator|->
name|zc_simple
operator|=
name|zc
operator|->
name|zc_simple
expr_stmt|;
name|bcopy
argument_list|(
name|zc
operator|->
name|zc_pad
argument_list|,
name|zc28_c
operator|->
name|zc_pad
argument_list|,
sizeof|sizeof
argument_list|(
name|zc28_c
operator|->
name|zc_pad
argument_list|)
argument_list|)
expr_stmt|;
name|zc28_c
operator|->
name|zc_sendobj
operator|=
name|zc
operator|->
name|zc_sendobj
expr_stmt|;
name|zc28_c
operator|->
name|zc_fromobj
operator|=
name|zc
operator|->
name|zc_fromobj
expr_stmt|;
name|zc28_c
operator|->
name|zc_createtxg
operator|=
name|zc
operator|->
name|zc_createtxg
expr_stmt|;
name|zc28_c
operator|->
name|zc_stat
operator|=
name|zc
operator|->
name|zc_stat
expr_stmt|;
ifndef|#
directive|ifndef
name|_KERNEL
if|if
condition|(
name|request
operator|==
name|ZFS_IOC_RECV
condition|)
name|strlcpy
argument_list|(
name|zc28_c
operator|->
name|zc_top_ds
argument_list|,
name|zc
operator|->
name|zc_value
operator|+
name|strlen
argument_list|(
name|zc
operator|->
name|zc_value
argument_list|)
operator|+
literal|1
argument_list|,
name|MAXPATHLEN
operator|*
literal|2
operator|-
name|strlen
argument_list|(
name|zc
operator|->
name|zc_value
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* zc_inject_record */
name|zc28_c
operator|->
name|zc_inject_record
operator|.
name|zi_objset
operator|=
name|zc
operator|->
name|zc_inject_record
operator|.
name|zi_objset
expr_stmt|;
name|zc28_c
operator|->
name|zc_inject_record
operator|.
name|zi_object
operator|=
name|zc
operator|->
name|zc_inject_record
operator|.
name|zi_object
expr_stmt|;
name|zc28_c
operator|->
name|zc_inject_record
operator|.
name|zi_start
operator|=
name|zc
operator|->
name|zc_inject_record
operator|.
name|zi_start
expr_stmt|;
name|zc28_c
operator|->
name|zc_inject_record
operator|.
name|zi_end
operator|=
name|zc
operator|->
name|zc_inject_record
operator|.
name|zi_end
expr_stmt|;
name|zc28_c
operator|->
name|zc_inject_record
operator|.
name|zi_guid
operator|=
name|zc
operator|->
name|zc_inject_record
operator|.
name|zi_guid
expr_stmt|;
name|zc28_c
operator|->
name|zc_inject_record
operator|.
name|zi_level
operator|=
name|zc
operator|->
name|zc_inject_record
operator|.
name|zi_level
expr_stmt|;
name|zc28_c
operator|->
name|zc_inject_record
operator|.
name|zi_error
operator|=
name|zc
operator|->
name|zc_inject_record
operator|.
name|zi_error
expr_stmt|;
name|zc28_c
operator|->
name|zc_inject_record
operator|.
name|zi_type
operator|=
name|zc
operator|->
name|zc_inject_record
operator|.
name|zi_type
expr_stmt|;
name|zc28_c
operator|->
name|zc_inject_record
operator|.
name|zi_freq
operator|=
name|zc
operator|->
name|zc_inject_record
operator|.
name|zi_freq
expr_stmt|;
name|zc28_c
operator|->
name|zc_inject_record
operator|.
name|zi_failfast
operator|=
name|zc
operator|->
name|zc_inject_record
operator|.
name|zi_failfast
expr_stmt|;
name|strlcpy
argument_list|(
name|zc28_c
operator|->
name|zc_inject_record
operator|.
name|zi_func
argument_list|,
name|zc
operator|->
name|zc_inject_record
operator|.
name|zi_func
argument_list|,
name|MAXNAMELEN
argument_list|)
expr_stmt|;
name|zc28_c
operator|->
name|zc_inject_record
operator|.
name|zi_iotype
operator|=
name|zc
operator|->
name|zc_inject_record
operator|.
name|zi_iotype
expr_stmt|;
name|zc28_c
operator|->
name|zc_inject_record
operator|.
name|zi_duration
operator|=
name|zc
operator|->
name|zc_inject_record
operator|.
name|zi_duration
expr_stmt|;
name|zc28_c
operator|->
name|zc_inject_record
operator|.
name|zi_timer
operator|=
name|zc
operator|->
name|zc_inject_record
operator|.
name|zi_timer
expr_stmt|;
break|break;
case|case
name|ZFS_CMD_COMPAT_V15
case|:
name|zc_c
operator|=
operator|(
name|void
operator|*
operator|)
name|addr
expr_stmt|;
comment|/* zc */
name|strlcpy
argument_list|(
name|zc_c
operator|->
name|zc_name
argument_list|,
name|zc
operator|->
name|zc_name
argument_list|,
name|MAXPATHLEN
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|zc_c
operator|->
name|zc_value
argument_list|,
name|zc
operator|->
name|zc_value
argument_list|,
name|MAXPATHLEN
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|zc_c
operator|->
name|zc_string
argument_list|,
name|zc
operator|->
name|zc_string
argument_list|,
name|MAXPATHLEN
argument_list|)
expr_stmt|;
name|zc_c
operator|->
name|zc_guid
operator|=
name|zc
operator|->
name|zc_guid
expr_stmt|;
name|zc_c
operator|->
name|zc_nvlist_conf
operator|=
name|zc
operator|->
name|zc_nvlist_conf
expr_stmt|;
name|zc_c
operator|->
name|zc_nvlist_conf_size
operator|=
name|zc
operator|->
name|zc_nvlist_conf_size
expr_stmt|;
name|zc_c
operator|->
name|zc_nvlist_src
operator|=
name|zc
operator|->
name|zc_nvlist_src
expr_stmt|;
name|zc_c
operator|->
name|zc_nvlist_src_size
operator|=
name|zc
operator|->
name|zc_nvlist_src_size
expr_stmt|;
name|zc_c
operator|->
name|zc_nvlist_dst
operator|=
name|zc
operator|->
name|zc_nvlist_dst
expr_stmt|;
name|zc_c
operator|->
name|zc_nvlist_dst_size
operator|=
name|zc
operator|->
name|zc_nvlist_dst_size
expr_stmt|;
name|zc_c
operator|->
name|zc_cookie
operator|=
name|zc
operator|->
name|zc_cookie
expr_stmt|;
name|zc_c
operator|->
name|zc_objset_type
operator|=
name|zc
operator|->
name|zc_objset_type
expr_stmt|;
name|zc_c
operator|->
name|zc_perm_action
operator|=
name|zc
operator|->
name|zc_perm_action
expr_stmt|;
name|zc_c
operator|->
name|zc_history
operator|=
name|zc
operator|->
name|zc_history
expr_stmt|;
name|zc_c
operator|->
name|zc_history_len
operator|=
name|zc
operator|->
name|zc_history_len
expr_stmt|;
name|zc_c
operator|->
name|zc_history_offset
operator|=
name|zc
operator|->
name|zc_history_offset
expr_stmt|;
name|zc_c
operator|->
name|zc_obj
operator|=
name|zc
operator|->
name|zc_obj
expr_stmt|;
name|zc_c
operator|->
name|zc_share
operator|=
name|zc
operator|->
name|zc_share
expr_stmt|;
name|zc_c
operator|->
name|zc_jailid
operator|=
name|zc
operator|->
name|zc_jailid
expr_stmt|;
name|zc_c
operator|->
name|zc_objset_stats
operator|=
name|zc
operator|->
name|zc_objset_stats
expr_stmt|;
name|zc_c
operator|->
name|zc_begin_record
operator|=
name|zc
operator|->
name|zc_begin_record
expr_stmt|;
comment|/* zc_inject_record */
name|zc_c
operator|->
name|zc_inject_record
operator|.
name|zi_objset
operator|=
name|zc
operator|->
name|zc_inject_record
operator|.
name|zi_objset
expr_stmt|;
name|zc_c
operator|->
name|zc_inject_record
operator|.
name|zi_object
operator|=
name|zc
operator|->
name|zc_inject_record
operator|.
name|zi_object
expr_stmt|;
name|zc_c
operator|->
name|zc_inject_record
operator|.
name|zi_start
operator|=
name|zc
operator|->
name|zc_inject_record
operator|.
name|zi_start
expr_stmt|;
name|zc_c
operator|->
name|zc_inject_record
operator|.
name|zi_end
operator|=
name|zc
operator|->
name|zc_inject_record
operator|.
name|zi_end
expr_stmt|;
name|zc_c
operator|->
name|zc_inject_record
operator|.
name|zi_guid
operator|=
name|zc
operator|->
name|zc_inject_record
operator|.
name|zi_guid
expr_stmt|;
name|zc_c
operator|->
name|zc_inject_record
operator|.
name|zi_level
operator|=
name|zc
operator|->
name|zc_inject_record
operator|.
name|zi_level
expr_stmt|;
name|zc_c
operator|->
name|zc_inject_record
operator|.
name|zi_error
operator|=
name|zc
operator|->
name|zc_inject_record
operator|.
name|zi_error
expr_stmt|;
name|zc_c
operator|->
name|zc_inject_record
operator|.
name|zi_type
operator|=
name|zc
operator|->
name|zc_inject_record
operator|.
name|zi_type
expr_stmt|;
name|zc_c
operator|->
name|zc_inject_record
operator|.
name|zi_freq
operator|=
name|zc
operator|->
name|zc_inject_record
operator|.
name|zi_freq
expr_stmt|;
name|zc_c
operator|->
name|zc_inject_record
operator|.
name|zi_failfast
operator|=
name|zc
operator|->
name|zc_inject_record
operator|.
name|zi_failfast
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|zfs_ioctl_compat_get_nvlist
parameter_list|(
name|uint64_t
name|nvl
parameter_list|,
name|size_t
name|size
parameter_list|,
name|int
name|iflag
parameter_list|,
name|nvlist_t
modifier|*
modifier|*
name|nvp
parameter_list|)
block|{
name|char
modifier|*
name|packed
decl_stmt|;
name|int
name|error
decl_stmt|;
name|nvlist_t
modifier|*
name|list
init|=
name|NULL
decl_stmt|;
comment|/* 	 * Read in and unpack the user-supplied nvlist. 	 */
if|if
condition|(
name|size
operator|==
literal|0
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
ifdef|#
directive|ifdef
name|_KERNEL
name|packed
operator|=
name|kmem_alloc
argument_list|(
name|size
argument_list|,
name|KM_SLEEP
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|ddi_copyin
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|nvl
argument_list|,
name|packed
argument_list|,
name|size
argument_list|,
name|iflag
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|kmem_free
argument_list|(
name|packed
argument_list|,
name|size
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
else|#
directive|else
name|packed
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|nvl
expr_stmt|;
endif|#
directive|endif
name|error
operator|=
name|nvlist_unpack
argument_list|(
name|packed
argument_list|,
name|size
argument_list|,
operator|&
name|list
argument_list|,
literal|0
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|_KERNEL
name|kmem_free
argument_list|(
name|packed
argument_list|,
name|size
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
operator|*
name|nvp
operator|=
name|list
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|zfs_ioctl_compat_put_nvlist
parameter_list|(
name|zfs_cmd_t
modifier|*
name|zc
parameter_list|,
name|nvlist_t
modifier|*
name|nvl
parameter_list|)
block|{
name|char
modifier|*
name|packed
init|=
name|NULL
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|size_t
name|size
decl_stmt|;
name|VERIFY
argument_list|(
name|nvlist_size
argument_list|(
name|nvl
argument_list|,
operator|&
name|size
argument_list|,
name|NV_ENCODE_NATIVE
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|_KERNEL
name|packed
operator|=
name|kmem_alloc
argument_list|(
name|size
argument_list|,
name|KM_SLEEP
argument_list|)
expr_stmt|;
name|VERIFY
argument_list|(
name|nvlist_pack
argument_list|(
name|nvl
argument_list|,
operator|&
name|packed
argument_list|,
operator|&
name|size
argument_list|,
name|NV_ENCODE_NATIVE
argument_list|,
name|KM_SLEEP
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ddi_copyout
argument_list|(
name|packed
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|zc
operator|->
name|zc_nvlist_dst
argument_list|,
name|size
argument_list|,
name|zc
operator|->
name|zc_iflags
argument_list|)
operator|!=
literal|0
condition|)
name|error
operator|=
name|EFAULT
expr_stmt|;
name|kmem_free
argument_list|(
name|packed
argument_list|,
name|size
argument_list|)
expr_stmt|;
else|#
directive|else
name|packed
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|zc
operator|->
name|zc_nvlist_dst
expr_stmt|;
name|VERIFY
argument_list|(
name|nvlist_pack
argument_list|(
name|nvl
argument_list|,
operator|&
name|packed
argument_list|,
operator|&
name|size
argument_list|,
name|NV_ENCODE_NATIVE
argument_list|,
literal|0
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|zc
operator|->
name|zc_nvlist_dst_size
operator|=
name|size
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|zfs_ioctl_compat_fix_stats_nvlist
parameter_list|(
name|nvlist_t
modifier|*
name|nvl
parameter_list|)
block|{
name|nvlist_t
modifier|*
modifier|*
name|child
decl_stmt|;
name|nvlist_t
modifier|*
name|nvroot
init|=
name|NULL
decl_stmt|;
name|vdev_stat_t
modifier|*
name|vs
decl_stmt|;
name|uint_t
name|c
decl_stmt|,
name|children
decl_stmt|,
name|nelem
decl_stmt|;
if|if
condition|(
name|nvlist_lookup_nvlist_array
argument_list|(
name|nvl
argument_list|,
name|ZPOOL_CONFIG_CHILDREN
argument_list|,
operator|&
name|child
argument_list|,
operator|&
name|children
argument_list|)
operator|==
literal|0
condition|)
block|{
for|for
control|(
name|c
operator|=
literal|0
init|;
name|c
operator|<
name|children
condition|;
name|c
operator|++
control|)
block|{
name|zfs_ioctl_compat_fix_stats_nvlist
argument_list|(
name|child
index|[
name|c
index|]
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|nvlist_lookup_nvlist
argument_list|(
name|nvl
argument_list|,
name|ZPOOL_CONFIG_VDEV_TREE
argument_list|,
operator|&
name|nvroot
argument_list|)
operator|==
literal|0
condition|)
name|zfs_ioctl_compat_fix_stats_nvlist
argument_list|(
name|nvroot
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|_KERNEL
if|if
condition|(
operator|(
name|nvlist_lookup_uint64_array
argument_list|(
argument|nvl
argument_list|,
argument|ZPOOL_CONFIG_VDEV_STATS
argument_list|,
else|#
directive|else
argument|if ((nvlist_lookup_uint64_array(nvl,
literal|"stats"
argument|,
endif|#
directive|endif
argument|(uint64_t **)&vs,&nelem) ==
literal|0
argument|)) { 		nvlist_add_uint64_array(nvl,
ifdef|#
directive|ifdef
name|_KERNEL
literal|"stats"
argument|,
else|#
directive|else
argument|ZPOOL_CONFIG_VDEV_STATS,
endif|#
directive|endif
argument|(uint64_t *)vs, nelem);
ifdef|#
directive|ifdef
name|_KERNEL
argument|nvlist_remove(nvl, ZPOOL_CONFIG_VDEV_STATS,
else|#
directive|else
argument|nvlist_remove(nvl,
literal|"stats"
argument|,
endif|#
directive|endif
argument|DATA_TYPE_UINT64_ARRAY); 	} }  static int zfs_ioctl_compat_fix_stats(zfs_cmd_t *zc, const int nc) { 	nvlist_t *nv, *nvp = NULL; 	nvpair_t *elem; 	int error;  	if ((error = zfs_ioctl_compat_get_nvlist(zc->zc_nvlist_dst, 	    zc->zc_nvlist_dst_size, zc->zc_iflags,&nv)) !=
literal|0
argument|) 		return (error);  	if (nc ==
literal|5
argument|) {
comment|/* ZFS_IOC_POOL_STATS */
argument|elem = NULL; 		while ((elem = nvlist_next_nvpair(nv, elem)) != NULL) { 			if (nvpair_value_nvlist(elem,&nvp) ==
literal|0
argument|) 				zfs_ioctl_compat_fix_stats_nvlist(nvp); 		} 		elem = NULL; 	} else 		zfs_ioctl_compat_fix_stats_nvlist(nv);  	error = zfs_ioctl_compat_put_nvlist(zc, nv);  	nvlist_free(nv);  	return (error); }  static int zfs_ioctl_compat_pool_get_props(zfs_cmd_t *zc) { 	nvlist_t *nv, *nva = NULL; 	int error;  	if ((error = zfs_ioctl_compat_get_nvlist(zc->zc_nvlist_dst, 	    zc->zc_nvlist_dst_size, zc->zc_iflags,&nv)) !=
literal|0
argument|) 		return (error);
ifdef|#
directive|ifdef
name|_KERNEL
argument|if (nvlist_lookup_nvlist(nv,
literal|"allocated"
argument|,&nva) ==
literal|0
argument|) { 		nvlist_add_nvlist(nv,
literal|"used"
argument|, nva); 		nvlist_remove(nv,
literal|"allocated"
argument|, DATA_TYPE_NVLIST); 	}  	if (nvlist_lookup_nvlist(nv,
literal|"free"
argument|,&nva) ==
literal|0
argument|) { 		nvlist_add_nvlist(nv,
literal|"available"
argument|, nva); 		nvlist_remove(nv,
literal|"free"
argument|, DATA_TYPE_NVLIST); 	}
else|#
directive|else
argument|if (nvlist_lookup_nvlist(nv,
literal|"used"
argument|,&nva) ==
literal|0
argument|) { 		nvlist_add_nvlist(nv,
literal|"allocated"
argument|, nva); 		nvlist_remove(nv,
literal|"used"
argument|, DATA_TYPE_NVLIST); 	}  	if (nvlist_lookup_nvlist(nv,
literal|"available"
argument|,&nva) ==
literal|0
argument|) { 		nvlist_add_nvlist(nv,
literal|"free"
argument|, nva); 		nvlist_remove(nv,
literal|"available"
argument|, DATA_TYPE_NVLIST); 	}
endif|#
directive|endif
argument|error = zfs_ioctl_compat_put_nvlist(zc, nv);  	nvlist_free(nv);  	return (error); }
ifndef|#
directive|ifndef
name|_KERNEL
argument|int zcmd_ioctl_compat(int fd, int request, zfs_cmd_t *zc, const int cflag) { 	int nc, ret; 	void *zc_c; 	unsigned long ncmd; 	zfs_iocparm_t zp;  	switch (cflag) { 	case ZFS_CMD_COMPAT_NONE: 		ncmd = _IOWR(
literal|'Z'
argument|, request, struct zfs_iocparm); 		zp.zfs_cmd = (uint64_t)zc; 		zp.zfs_cmd_size = sizeof(zfs_cmd_t); 		zp.zfs_ioctl_version = ZFS_IOCVER_CURRENT; 		return (ioctl(fd, ncmd,&zp)); 	case ZFS_CMD_COMPAT_LZC: 		ncmd = _IOWR(
literal|'Z'
argument|, request, struct zfs_cmd); 		return (ioctl(fd, ncmd, zc)); 	case ZFS_CMD_COMPAT_DEADMAN: 		zc_c = malloc(sizeof(zfs_cmd_deadman_t)); 		ncmd = _IOWR(
literal|'Z'
argument|, request, struct zfs_cmd_deadman); 		break; 	case ZFS_CMD_COMPAT_V28: 		zc_c = malloc(sizeof(zfs_cmd_v28_t)); 		ncmd = _IOWR(
literal|'Z'
argument|, request, struct zfs_cmd_v28); 		break; 	case ZFS_CMD_COMPAT_V15: 		nc = zfs_ioctl_v28_to_v15[request]; 		zc_c = malloc(sizeof(zfs_cmd_v15_t)); 		ncmd = _IOWR(
literal|'Z'
argument|, nc, struct zfs_cmd_v15); 		break; 	default: 		return (EINVAL); 	}  	if (ZFS_IOCREQ(ncmd) == ZFS_IOC_COMPAT_FAIL) 		return (ENOTSUP);  	zfs_cmd_compat_put(zc, (caddr_t)zc_c, request, cflag);  	ret = ioctl(fd, ncmd, zc_c); 	if (cflag == ZFS_CMD_COMPAT_V15&& 	    nc == ZFS_IOC_POOL_IMPORT) 		ret = ioctl(fd, _IOWR(
literal|'Z'
argument|, ZFS_IOC_POOL_CONFIGS, 		    struct zfs_cmd_v15), zc_c); 	zfs_cmd_compat_get(zc, (caddr_t)zc_c, cflag); 	free(zc_c);  	if (cflag == ZFS_CMD_COMPAT_V15) { 		switch (nc) { 		case ZFS_IOC_POOL_IMPORT: 		case ZFS_IOC_POOL_CONFIGS: 		case ZFS_IOC_POOL_STATS: 		case ZFS_IOC_POOL_TRYIMPORT: 			zfs_ioctl_compat_fix_stats(zc, nc); 			break; 		case
literal|41
argument|:
comment|/* ZFS_IOC_POOL_GET_PROPS (v15) */
argument|zfs_ioctl_compat_pool_get_props(zc); 			break; 		} 	}  	return (ret); }
else|#
directive|else
comment|/* _KERNEL */
argument|int zfs_ioctl_compat_pre(zfs_cmd_t *zc, int *vec, const int cflag) { 	int error =
literal|0
argument|;
comment|/* are we creating a clone? */
argument|if (*vec == ZFS_IOC_CREATE&& zc->zc_value[
literal|0
argument|] !=
literal|'\0'
argument|) 		*vec = ZFS_IOC_CLONE;  	if (cflag == ZFS_CMD_COMPAT_V15) { 		switch (*vec) {  		case
literal|7
argument|:
comment|/* ZFS_IOC_POOL_SCRUB (v15) */
argument|zc->zc_cookie = POOL_SCAN_SCRUB; 			break; 		} 	}  	return (error); }  void zfs_ioctl_compat_post(zfs_cmd_t *zc, int vec, const int cflag) { 	if (cflag == ZFS_CMD_COMPAT_V15) { 		switch (vec) { 		case ZFS_IOC_POOL_CONFIGS: 		case ZFS_IOC_POOL_STATS: 		case ZFS_IOC_POOL_TRYIMPORT: 			zfs_ioctl_compat_fix_stats(zc, vec); 			break; 		case
literal|41
argument|:
comment|/* ZFS_IOC_POOL_GET_PROPS (v15) */
argument|zfs_ioctl_compat_pool_get_props(zc); 			break; 		} 	} }  nvlist_t * zfs_ioctl_compat_innvl(zfs_cmd_t *zc, nvlist_t * innvl, const int vec,     const int cflag) { 	nvlist_t *nvl, *tmpnvl, *hnvl; 	nvpair_t *elem; 	char *poolname, *snapname; 	int err;  	if (cflag == ZFS_CMD_COMPAT_NONE || cflag == ZFS_CMD_COMPAT_LZC) 		goto out;  	switch (vec) { 	case ZFS_IOC_CREATE: 		nvl = fnvlist_alloc(); 		fnvlist_add_int32(nvl,
literal|"type"
argument|, zc->zc_objset_type); 		if (innvl != NULL) { 			fnvlist_add_nvlist(nvl,
literal|"props"
argument|, innvl); 			nvlist_free(innvl); 		} 		return (nvl); 	break; 	case ZFS_IOC_CLONE: 		nvl = fnvlist_alloc(); 		fnvlist_add_string(nvl,
literal|"origin"
argument|, zc->zc_value); 		if (innvl != NULL) { 			fnvlist_add_nvlist(nvl,
literal|"props"
argument|, innvl); 			nvlist_free(innvl); 		} 		return (nvl); 	break; 	case ZFS_IOC_SNAPSHOT: 		if (innvl == NULL) 			goto out; 		nvl = fnvlist_alloc(); 		fnvlist_add_nvlist(nvl,
literal|"props"
argument|, innvl); 		tmpnvl = fnvlist_alloc(); 		snapname = kmem_asprintf(
literal|"%s@%s"
argument|, zc->zc_name, zc->zc_value); 		fnvlist_add_boolean(tmpnvl, snapname); 		kmem_free(snapname, strlen(snapname +
literal|1
argument|));
comment|/* check if we are doing a recursive snapshot */
argument|if (zc->zc_cookie) 			dmu_get_recursive_snaps_nvl(zc->zc_name, zc->zc_value, 			    tmpnvl); 		fnvlist_add_nvlist(nvl,
literal|"snaps"
argument|, tmpnvl); 		fnvlist_free(tmpnvl); 		nvlist_free(innvl);
comment|/* strip dataset part from zc->zc_name */
argument|zc->zc_name[strcspn(zc->zc_name,
literal|"/@"
argument|)] =
literal|'\0'
argument|; 		return (nvl); 	break; 	case ZFS_IOC_SPACE_SNAPS: 		nvl = fnvlist_alloc(); 		fnvlist_add_string(nvl,
literal|"firstsnap"
argument|, zc->zc_value); 		if (innvl != NULL) 			nvlist_free(innvl); 		return (nvl); 	break; 	case ZFS_IOC_DESTROY_SNAPS: 		if (innvl == NULL&& cflag == ZFS_CMD_COMPAT_DEADMAN) 			goto out; 		nvl = fnvlist_alloc(); 		if (innvl != NULL) { 			fnvlist_add_nvlist(nvl,
literal|"snaps"
argument|, innvl); 		} else {
comment|/* 			 * We are probably called by even older binaries, 			 * allocate and populate nvlist with recursive 			 * snapshots 			 */
argument|if (snapshot_namecheck(zc->zc_value, NULL, 			    NULL) ==
literal|0
argument|) { 				tmpnvl = fnvlist_alloc(); 				if (dmu_get_recursive_snaps_nvl(zc->zc_name, 				    zc->zc_value, tmpnvl) ==
literal|0
argument|) 					fnvlist_add_nvlist(nvl,
literal|"snaps"
argument|, 					    tmpnvl); 				nvlist_free(tmpnvl); 			} 		} 		if (innvl != NULL) 			nvlist_free(innvl);
comment|/* strip dataset part from zc->zc_name */
argument|zc->zc_name[strcspn(zc->zc_name,
literal|"/@"
argument|)] =
literal|'\0'
argument|; 		return (nvl); 	break; 	case ZFS_IOC_HOLD: 		nvl = fnvlist_alloc(); 		tmpnvl = fnvlist_alloc(); 		if (zc->zc_cleanup_fd != -
literal|1
argument|) 			fnvlist_add_int32(nvl,
literal|"cleanup_fd"
argument|, 			    (int32_t)zc->zc_cleanup_fd); 		if (zc->zc_cookie) { 			hnvl = fnvlist_alloc(); 			if (dmu_get_recursive_snaps_nvl(zc->zc_name, 			    zc->zc_value, hnvl) ==
literal|0
argument|) { 				elem = NULL; 				while ((elem = nvlist_next_nvpair(hnvl, 				    elem)) != NULL) { 					nvlist_add_string(tmpnvl, 					    nvpair_name(elem), zc->zc_string); 				} 			} 			nvlist_free(hnvl); 		} else { 			snapname = kmem_asprintf(
literal|"%s@%s"
argument|, zc->zc_name, 			    zc->zc_value); 			nvlist_add_string(tmpnvl, snapname, zc->zc_string); 			kmem_free(snapname, strlen(snapname +
literal|1
argument|)); 		} 		fnvlist_add_nvlist(nvl,
literal|"holds"
argument|, tmpnvl); 		nvlist_free(tmpnvl); 		if (innvl != NULL) 			nvlist_free(innvl);
comment|/* strip dataset part from zc->zc_name */
argument|zc->zc_name[strcspn(zc->zc_name,
literal|"/@"
argument|)] =
literal|'\0'
argument|; 		return (nvl); 	break; 	case ZFS_IOC_RELEASE: 		nvl = fnvlist_alloc(); 		tmpnvl = fnvlist_alloc(); 		if (zc->zc_cookie) { 			hnvl = fnvlist_alloc(); 			if (dmu_get_recursive_snaps_nvl(zc->zc_name, 			    zc->zc_value, hnvl) ==
literal|0
argument|) { 				elem = NULL; 				while ((elem = nvlist_next_nvpair(hnvl, 				    elem)) != NULL) { 					fnvlist_add_boolean(tmpnvl, 					    zc->zc_string); 					fnvlist_add_nvlist(nvl, 					    nvpair_name(elem), tmpnvl); 				} 			} 			nvlist_free(hnvl); 		} else { 			snapname = kmem_asprintf(
literal|"%s@%s"
argument|, zc->zc_name, 			    zc->zc_value); 			fnvlist_add_boolean(tmpnvl, zc->zc_string); 			fnvlist_add_nvlist(nvl, snapname, tmpnvl); 			kmem_free(snapname, strlen(snapname +
literal|1
argument|)); 		} 		nvlist_free(tmpnvl); 		if (innvl != NULL) 			nvlist_free(innvl);
comment|/* strip dataset part from zc->zc_name */
argument|zc->zc_name[strcspn(zc->zc_name,
literal|"/@"
argument|)] =
literal|'\0'
argument|; 		return (nvl); 	break; 	} out: 	return (innvl); }  nvlist_t * zfs_ioctl_compat_outnvl(zfs_cmd_t *zc, nvlist_t * outnvl, const int vec,     const int cflag) { 	nvlist_t *tmpnvl;  	if (cflag == ZFS_CMD_COMPAT_NONE || cflag == ZFS_CMD_COMPAT_LZC) 		return (outnvl);  	switch (vec) { 	case ZFS_IOC_SPACE_SNAPS: 		(void) nvlist_lookup_uint64(outnvl,
literal|"used"
argument|,&zc->zc_cookie); 		(void) nvlist_lookup_uint64(outnvl,
literal|"compressed"
argument|,&zc->zc_objset_type); 		(void) nvlist_lookup_uint64(outnvl,
literal|"uncompressed"
argument|,&zc->zc_perm_action); 		nvlist_free(outnvl);
comment|/* return empty outnvl */
argument|tmpnvl = fnvlist_alloc(); 		return (tmpnvl); 	break; 	case ZFS_IOC_CREATE: 	case ZFS_IOC_CLONE: 	case ZFS_IOC_HOLD: 	case ZFS_IOC_RELEASE: 		nvlist_free(outnvl);
comment|/* return empty outnvl */
argument|tmpnvl = fnvlist_alloc(); 		return (tmpnvl); 	break; 	}  	return (outnvl); }
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* KERNEL */
end_comment

end_unit


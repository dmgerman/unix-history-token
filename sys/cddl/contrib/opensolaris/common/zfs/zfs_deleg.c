begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * CDDL HEADER START  *  * The contents of this file are subject to the terms of the  * Common Development and Distribution License (the "License").  * You may not use this file except in compliance with the License.  *  * You can obtain a copy of the license at usr/src/OPENSOLARIS.LICENSE  * or http://www.opensolaris.org/os/licensing.  * See the License for the specific language governing permissions  * and limitations under the License.  *  * When distributing Covered Code, include this CDDL HEADER in each  * file and include the License file at usr/src/OPENSOLARIS.LICENSE.  * If applicable, add the following below this CDDL HEADER, with the  * fields enclosed by brackets "[]" replaced with your own identifying  * information: Portions Copyright [yyyy] [name of copyright owner]  *  * CDDL HEADER END  */
end_comment

begin_comment
comment|/*  * Copyright (c) 2007, 2010, Oracle and/or its affiliates. All rights reserved.  * Copyright 2010 Nexenta Systems, Inc. All rights reserved.  * Copyright (c) 2013 by Delphix. All rights reserved.  */
end_comment

begin_include
include|#
directive|include
file|<sys/zfs_context.h>
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|_KERNEL
argument_list|)
end_if

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/sunddi.h>
end_include

begin_include
include|#
directive|include
file|<sys/ctype.h>
end_include

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<strings.h>
end_include

begin_include
include|#
directive|include
file|<libnvpair.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<sys/dsl_deleg.h>
end_include

begin_include
include|#
directive|include
file|"zfs_prop.h"
end_include

begin_include
include|#
directive|include
file|"zfs_deleg.h"
end_include

begin_include
include|#
directive|include
file|"zfs_namecheck.h"
end_include

begin_decl_stmt
name|zfs_deleg_perm_tab_t
name|zfs_deleg_perm_tab
index|[]
init|=
block|{
block|{
name|ZFS_DELEG_PERM_ALLOW
block|}
block|,
block|{
name|ZFS_DELEG_PERM_BOOKMARK
block|}
block|,
block|{
name|ZFS_DELEG_PERM_CLONE
block|}
block|,
block|{
name|ZFS_DELEG_PERM_CREATE
block|}
block|,
block|{
name|ZFS_DELEG_PERM_DESTROY
block|}
block|,
block|{
name|ZFS_DELEG_PERM_DIFF
block|}
block|,
block|{
name|ZFS_DELEG_PERM_MOUNT
block|}
block|,
block|{
name|ZFS_DELEG_PERM_PROMOTE
block|}
block|,
block|{
name|ZFS_DELEG_PERM_RECEIVE
block|}
block|,
block|{
name|ZFS_DELEG_PERM_RENAME
block|}
block|,
block|{
name|ZFS_DELEG_PERM_ROLLBACK
block|}
block|,
block|{
name|ZFS_DELEG_PERM_SNAPSHOT
block|}
block|,
block|{
name|ZFS_DELEG_PERM_SHARE
block|}
block|,
block|{
name|ZFS_DELEG_PERM_SEND
block|}
block|,
block|{
name|ZFS_DELEG_PERM_USERPROP
block|}
block|,
block|{
name|ZFS_DELEG_PERM_USERQUOTA
block|}
block|,
block|{
name|ZFS_DELEG_PERM_GROUPQUOTA
block|}
block|,
block|{
name|ZFS_DELEG_PERM_USERUSED
block|}
block|,
block|{
name|ZFS_DELEG_PERM_GROUPUSED
block|}
block|,
block|{
name|ZFS_DELEG_PERM_HOLD
block|}
block|,
block|{
name|ZFS_DELEG_PERM_RELEASE
block|}
block|,
block|{
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|zfs_valid_permission_name
parameter_list|(
specifier|const
name|char
modifier|*
name|perm
parameter_list|)
block|{
if|if
condition|(
name|zfs_deleg_canonicalize_perm
argument_list|(
name|perm
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
return|return
operator|(
name|permset_namecheck
argument_list|(
name|perm
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|zfs_deleg_canonicalize_perm
parameter_list|(
specifier|const
name|char
modifier|*
name|perm
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|zfs_prop_t
name|prop
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|zfs_deleg_perm_tab
index|[
name|i
index|]
operator|.
name|z_perm
operator|!=
name|NULL
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|perm
argument_list|,
name|zfs_deleg_perm_tab
index|[
name|i
index|]
operator|.
name|z_perm
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|perm
operator|)
return|;
block|}
name|prop
operator|=
name|zfs_name_to_prop
argument_list|(
name|perm
argument_list|)
expr_stmt|;
if|if
condition|(
name|prop
operator|!=
name|ZPROP_INVAL
operator|&&
name|zfs_prop_delegatable
argument_list|(
name|prop
argument_list|)
condition|)
return|return
operator|(
name|zfs_prop_to_name
argument_list|(
name|prop
argument_list|)
operator|)
return|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|zfs_validate_who
parameter_list|(
name|char
modifier|*
name|who
parameter_list|)
block|{
name|char
modifier|*
name|p
decl_stmt|;
if|if
condition|(
name|who
index|[
literal|2
index|]
operator|!=
name|ZFS_DELEG_FIELD_SEP_CHR
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
switch|switch
condition|(
name|who
index|[
literal|0
index|]
condition|)
block|{
case|case
name|ZFS_DELEG_USER
case|:
case|case
name|ZFS_DELEG_GROUP
case|:
case|case
name|ZFS_DELEG_USER_SETS
case|:
case|case
name|ZFS_DELEG_GROUP_SETS
case|:
if|if
condition|(
name|who
index|[
literal|1
index|]
operator|!=
name|ZFS_DELEG_LOCAL
operator|&&
name|who
index|[
literal|1
index|]
operator|!=
name|ZFS_DELEG_DESCENDENT
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
for|for
control|(
name|p
operator|=
operator|&
name|who
index|[
literal|3
index|]
init|;
operator|*
name|p
condition|;
name|p
operator|++
control|)
if|if
condition|(
operator|!
name|isdigit
argument_list|(
operator|*
name|p
argument_list|)
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
break|break;
case|case
name|ZFS_DELEG_NAMED_SET
case|:
case|case
name|ZFS_DELEG_NAMED_SET_SETS
case|:
if|if
condition|(
name|who
index|[
literal|1
index|]
operator|!=
name|ZFS_DELEG_NA
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
return|return
operator|(
name|permset_namecheck
argument_list|(
operator|&
name|who
index|[
literal|3
index|]
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|)
return|;
case|case
name|ZFS_DELEG_CREATE
case|:
case|case
name|ZFS_DELEG_CREATE_SETS
case|:
if|if
condition|(
name|who
index|[
literal|1
index|]
operator|!=
name|ZFS_DELEG_NA
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|who
index|[
literal|3
index|]
operator|!=
literal|'\0'
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
break|break;
case|case
name|ZFS_DELEG_EVERYONE
case|:
case|case
name|ZFS_DELEG_EVERYONE_SETS
case|:
if|if
condition|(
name|who
index|[
literal|1
index|]
operator|!=
name|ZFS_DELEG_LOCAL
operator|&&
name|who
index|[
literal|1
index|]
operator|!=
name|ZFS_DELEG_DESCENDENT
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|who
index|[
literal|3
index|]
operator|!=
literal|'\0'
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
break|break;
default|default:
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|zfs_deleg_verify_nvlist
parameter_list|(
name|nvlist_t
modifier|*
name|nvp
parameter_list|)
block|{
name|nvpair_t
modifier|*
name|who
decl_stmt|,
modifier|*
name|perm_name
decl_stmt|;
name|nvlist_t
modifier|*
name|perms
decl_stmt|;
name|int
name|error
decl_stmt|;
if|if
condition|(
name|nvp
operator|==
name|NULL
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|who
operator|=
name|nvlist_next_nvpair
argument_list|(
name|nvp
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|who
operator|==
name|NULL
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
do|do
block|{
if|if
condition|(
name|zfs_validate_who
argument_list|(
name|nvpair_name
argument_list|(
name|who
argument_list|)
argument_list|)
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|error
operator|=
name|nvlist_lookup_nvlist
argument_list|(
name|nvp
argument_list|,
name|nvpair_name
argument_list|(
name|who
argument_list|)
argument_list|,
operator|&
name|perms
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|&&
name|error
operator|!=
name|ENOENT
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|error
operator|==
name|ENOENT
condition|)
continue|continue;
name|perm_name
operator|=
name|nvlist_next_nvpair
argument_list|(
name|perms
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|perm_name
operator|==
name|NULL
condition|)
block|{
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
do|do
block|{
name|error
operator|=
name|zfs_valid_permission_name
argument_list|(
name|nvpair_name
argument_list|(
name|perm_name
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
do|while
condition|(
name|perm_name
operator|=
name|nvlist_next_nvpair
argument_list|(
name|perms
argument_list|,
name|perm_name
argument_list|)
condition|)
do|;
block|}
do|while
condition|(
name|who
operator|=
name|nvlist_next_nvpair
argument_list|(
name|nvp
argument_list|,
name|who
argument_list|)
condition|)
do|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Construct the base attribute name.  The base attribute names  * are the "key" to locate the jump objects which contain the actual  * permissions.  The base attribute names are encoded based on  * type of entry and whether it is a local or descendent permission.  *  * Arguments:  * attr - attribute name return string, attribute is assumed to be  *        ZFS_MAX_DELEG_NAME long.  * type - type of entry to construct  * inheritchr - inheritance type (local,descendent, or NA for create and  *                               permission set definitions  * data - is either a permission set name or a 64 bit uid/gid.  */
end_comment

begin_function
name|void
name|zfs_deleg_whokey
parameter_list|(
name|char
modifier|*
name|attr
parameter_list|,
name|zfs_deleg_who_type_t
name|type
parameter_list|,
name|char
name|inheritchr
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|int
name|len
init|=
name|ZFS_MAX_DELEG_NAME
decl_stmt|;
name|uint64_t
modifier|*
name|id
init|=
name|data
decl_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|ZFS_DELEG_USER
case|:
case|case
name|ZFS_DELEG_GROUP
case|:
case|case
name|ZFS_DELEG_USER_SETS
case|:
case|case
name|ZFS_DELEG_GROUP_SETS
case|:
operator|(
name|void
operator|)
name|snprintf
argument_list|(
name|attr
argument_list|,
name|len
argument_list|,
literal|"%c%c%c%lld"
argument_list|,
name|type
argument_list|,
name|inheritchr
argument_list|,
name|ZFS_DELEG_FIELD_SEP_CHR
argument_list|,
operator|(
name|longlong_t
operator|)
operator|*
name|id
argument_list|)
expr_stmt|;
break|break;
case|case
name|ZFS_DELEG_NAMED_SET_SETS
case|:
case|case
name|ZFS_DELEG_NAMED_SET
case|:
operator|(
name|void
operator|)
name|snprintf
argument_list|(
name|attr
argument_list|,
name|len
argument_list|,
literal|"%c-%c%s"
argument_list|,
name|type
argument_list|,
name|ZFS_DELEG_FIELD_SEP_CHR
argument_list|,
operator|(
name|char
operator|*
operator|)
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|ZFS_DELEG_CREATE
case|:
case|case
name|ZFS_DELEG_CREATE_SETS
case|:
operator|(
name|void
operator|)
name|snprintf
argument_list|(
name|attr
argument_list|,
name|len
argument_list|,
literal|"%c-%c"
argument_list|,
name|type
argument_list|,
name|ZFS_DELEG_FIELD_SEP_CHR
argument_list|)
expr_stmt|;
break|break;
case|case
name|ZFS_DELEG_EVERYONE
case|:
case|case
name|ZFS_DELEG_EVERYONE_SETS
case|:
operator|(
name|void
operator|)
name|snprintf
argument_list|(
name|attr
argument_list|,
name|len
argument_list|,
literal|"%c%c%c"
argument_list|,
name|type
argument_list|,
name|inheritchr
argument_list|,
name|ZFS_DELEG_FIELD_SEP_CHR
argument_list|)
expr_stmt|;
break|break;
default|default:
name|ASSERT
argument_list|(
operator|!
literal|"bad zfs_deleg_who_type_t"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

end_unit


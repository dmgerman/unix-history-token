begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1993 Atsushi Murai (amurai@spec.co.jp)  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. All advertising materials mentioning features or use of this software  *    must display the following acknowledgement:  * 4. Neither the name of the University nor the names of its contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY Atsushi Murai(amurai@spec.co.jp)``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  *	$Id: isofs_rrip.c,v 1.3 1993/10/25 19:43:04 rgrimes Exp $  */
end_comment

begin_include
include|#
directive|include
file|"param.h"
end_include

begin_include
include|#
directive|include
file|"systm.h"
end_include

begin_include
include|#
directive|include
file|"namei.h"
end_include

begin_include
include|#
directive|include
file|"buf.h"
end_include

begin_include
include|#
directive|include
file|"file.h"
end_include

begin_include
include|#
directive|include
file|"vnode.h"
end_include

begin_include
include|#
directive|include
file|"mount.h"
end_include

begin_include
include|#
directive|include
file|"kernel.h"
end_include

begin_include
include|#
directive|include
file|"sys/time.h"
end_include

begin_include
include|#
directive|include
file|"iso.h"
end_include

begin_include
include|#
directive|include
file|"isofs_node.h"
end_include

begin_include
include|#
directive|include
file|"isofs_rrip.h"
end_include

begin_include
include|#
directive|include
file|"iso_rrip.h"
end_include

begin_comment
comment|/*  * POSIX file attribute  */
end_comment

begin_function
specifier|static
name|int
name|isofs_rrip_attr
parameter_list|(
name|p
parameter_list|,
name|ana
parameter_list|)
name|ISO_RRIP_ATTR
modifier|*
name|p
decl_stmt|;
name|ISO_RRIP_ANALYZE
modifier|*
name|ana
decl_stmt|;
block|{
name|ana
operator|->
name|inode
operator|.
name|iso_mode
operator|=
name|isonum_731
argument_list|(
name|p
operator|->
name|mode_l
argument_list|)
expr_stmt|;
name|ana
operator|->
name|inode
operator|.
name|iso_uid
operator|=
operator|(
name|uid_t
operator|)
name|isonum_731
argument_list|(
name|p
operator|->
name|uid_l
argument_list|)
expr_stmt|;
name|ana
operator|->
name|inode
operator|.
name|iso_gid
operator|=
operator|(
name|gid_t
operator|)
name|isonum_731
argument_list|(
name|p
operator|->
name|gid_l
argument_list|)
expr_stmt|;
comment|/*	ana->inode.iso_links = isonum_731(p->links_l); */
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|isofs_rrip_defattr
parameter_list|(
name|isodir
parameter_list|,
name|ana
parameter_list|)
name|struct
name|iso_directory_record
modifier|*
name|isodir
decl_stmt|;
name|ISO_RRIP_ANALYZE
modifier|*
name|ana
decl_stmt|;
block|{
name|ana
operator|->
name|inode
operator|.
name|iso_mode
operator|=
operator|(
name|VREAD
operator||
name|VEXEC
operator||
operator|(
name|VREAD
operator||
name|VEXEC
operator|)
operator|>>
literal|3
operator||
operator|(
name|VREAD
operator||
name|VEXEC
operator|)
operator|>>
literal|6
operator|)
expr_stmt|;
name|ana
operator|->
name|inode
operator|.
name|iso_uid
operator|=
operator|(
name|uid_t
operator|)
literal|0
expr_stmt|;
name|ana
operator|->
name|inode
operator|.
name|iso_gid
operator|=
operator|(
name|gid_t
operator|)
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * POSIX device modes  */
end_comment

begin_function
specifier|static
name|int
name|isofs_rrip_device
parameter_list|(
name|p
parameter_list|,
name|ana
parameter_list|)
name|ISO_RRIP_DEVICE
modifier|*
name|p
decl_stmt|;
name|ISO_RRIP_ANALYZE
modifier|*
name|ana
decl_stmt|;
block|{
name|char
name|buf
index|[
literal|3
index|]
decl_stmt|;
name|buf
index|[
literal|0
index|]
operator|=
name|p
operator|->
name|h
operator|.
name|type
index|[
literal|0
index|]
expr_stmt|;
name|buf
index|[
literal|1
index|]
operator|=
name|p
operator|->
name|h
operator|.
name|type
index|[
literal|1
index|]
expr_stmt|;
name|buf
index|[
literal|2
index|]
operator|=
literal|0x00
expr_stmt|;
name|printf
argument_list|(
literal|"isofs:%s[%d] high=0x%08x, low=0x%08x\n"
argument_list|,
name|buf
argument_list|,
name|isonum_711
argument_list|(
name|p
operator|->
name|h
operator|.
name|length
argument_list|)
argument_list|,
name|isonum_731
argument_list|(
name|p
operator|->
name|dev_t_high_l
argument_list|)
argument_list|,
name|isonum_731
argument_list|(
name|p
operator|->
name|dev_t_low_l
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Symbolic Links  */
end_comment

begin_function
specifier|static
name|int
name|isofs_rrip_slink
parameter_list|(
name|p
parameter_list|,
name|ana
parameter_list|)
name|ISO_RRIP_SLINK
modifier|*
name|p
decl_stmt|;
name|ISO_RRIP_ANALYZE
modifier|*
name|ana
decl_stmt|;
block|{
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Alternate name  */
end_comment

begin_function
specifier|static
name|int
name|isofs_rrip_altname
parameter_list|(
name|p
parameter_list|,
name|ana
parameter_list|)
name|ISO_RRIP_ALTNAME
modifier|*
name|p
decl_stmt|;
name|ISO_RRIP_ANALYZE
modifier|*
name|ana
decl_stmt|;
block|{
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Child Link  */
end_comment

begin_function
specifier|static
name|int
name|isofs_rrip_clink
parameter_list|(
name|p
parameter_list|,
name|ana
parameter_list|)
name|ISO_RRIP_CLINK
modifier|*
name|p
decl_stmt|;
name|ISO_RRIP_ANALYZE
modifier|*
name|ana
decl_stmt|;
block|{
name|char
name|buf
index|[
literal|3
index|]
decl_stmt|;
name|buf
index|[
literal|0
index|]
operator|=
name|p
operator|->
name|h
operator|.
name|type
index|[
literal|0
index|]
expr_stmt|;
name|buf
index|[
literal|1
index|]
operator|=
name|p
operator|->
name|h
operator|.
name|type
index|[
literal|1
index|]
expr_stmt|;
name|buf
index|[
literal|2
index|]
operator|=
literal|0x00
expr_stmt|;
name|printf
argument_list|(
literal|"isofs:%s[%d] loc=%d\n"
argument_list|,
name|buf
argument_list|,
name|isonum_711
argument_list|(
name|p
operator|->
name|h
operator|.
name|length
argument_list|)
argument_list|,
name|isonum_733
argument_list|(
name|p
operator|->
name|dir_loc
argument_list|)
argument_list|)
expr_stmt|;
name|ana
operator|->
name|inode
operator|.
name|iso_cln
operator|=
name|isonum_733
argument_list|(
name|p
operator|->
name|dir_loc
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Parent Link  */
end_comment

begin_function
specifier|static
name|int
name|isofs_rrip_plink
parameter_list|(
name|p
parameter_list|,
name|ana
parameter_list|)
name|ISO_RRIP_PLINK
modifier|*
name|p
decl_stmt|;
name|ISO_RRIP_ANALYZE
modifier|*
name|ana
decl_stmt|;
block|{
name|char
name|buf
index|[
literal|3
index|]
decl_stmt|;
name|buf
index|[
literal|0
index|]
operator|=
name|p
operator|->
name|h
operator|.
name|type
index|[
literal|0
index|]
expr_stmt|;
name|buf
index|[
literal|1
index|]
operator|=
name|p
operator|->
name|h
operator|.
name|type
index|[
literal|1
index|]
expr_stmt|;
name|buf
index|[
literal|2
index|]
operator|=
literal|0x00
expr_stmt|;
name|printf
argument_list|(
literal|"isofs:%s[%d] loc=%d\n"
argument_list|,
name|buf
argument_list|,
name|isonum_711
argument_list|(
name|p
operator|->
name|h
operator|.
name|length
argument_list|)
argument_list|,
name|isonum_733
argument_list|(
name|p
operator|->
name|dir_loc
argument_list|)
argument_list|)
expr_stmt|;
name|ana
operator|->
name|inode
operator|.
name|iso_pln
operator|=
name|isonum_733
argument_list|(
name|p
operator|->
name|dir_loc
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Relocated directory  */
end_comment

begin_function
specifier|static
name|int
name|isofs_rrip_reldir
parameter_list|(
name|p
parameter_list|,
name|ana
parameter_list|)
name|ISO_RRIP_RELDIR
modifier|*
name|p
decl_stmt|;
name|ISO_RRIP_ANALYZE
modifier|*
name|ana
decl_stmt|;
block|{
name|char
name|buf
index|[
literal|3
index|]
decl_stmt|;
name|buf
index|[
literal|0
index|]
operator|=
name|p
operator|->
name|h
operator|.
name|type
index|[
literal|0
index|]
expr_stmt|;
name|buf
index|[
literal|1
index|]
operator|=
name|p
operator|->
name|h
operator|.
name|type
index|[
literal|1
index|]
expr_stmt|;
name|buf
index|[
literal|2
index|]
operator|=
literal|0x00
expr_stmt|;
name|printf
argument_list|(
literal|"isofs:%s[%d]\n"
argument_list|,
name|buf
argument_list|,
name|isonum_711
argument_list|(
name|p
operator|->
name|h
operator|.
name|length
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Time stamp   */
end_comment

begin_function
specifier|static
name|void
name|isofs_rrip_tstamp_conv7
parameter_list|(
name|pi
parameter_list|,
name|pu
parameter_list|)
name|char
modifier|*
name|pi
decl_stmt|;
name|struct
name|timeval
modifier|*
name|pu
decl_stmt|;
block|{
name|int
name|i
decl_stmt|;
name|int
name|crtime
decl_stmt|,
name|days
decl_stmt|;
name|int
name|year
decl_stmt|,
name|month
decl_stmt|,
name|day
decl_stmt|,
name|hour
decl_stmt|,
name|minute
decl_stmt|,
name|second
decl_stmt|,
name|tz
decl_stmt|;
name|year
operator|=
name|pi
index|[
literal|0
index|]
operator|-
literal|70
expr_stmt|;
name|month
operator|=
name|pi
index|[
literal|1
index|]
expr_stmt|;
name|day
operator|=
name|pi
index|[
literal|2
index|]
expr_stmt|;
name|hour
operator|=
name|pi
index|[
literal|3
index|]
expr_stmt|;
name|minute
operator|=
name|pi
index|[
literal|4
index|]
expr_stmt|;
name|second
operator|=
name|pi
index|[
literal|5
index|]
expr_stmt|;
name|tz
operator|=
name|pi
index|[
literal|6
index|]
expr_stmt|;
if|if
condition|(
name|year
operator|<
literal|0
condition|)
block|{
name|crtime
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|int
name|monlen
index|[
literal|12
index|]
init|=
block|{
literal|31
block|,
literal|28
block|,
literal|31
block|,
literal|30
block|,
literal|31
block|,
literal|30
block|,
literal|31
block|,
literal|31
block|,
literal|30
block|,
literal|31
block|,
literal|30
block|,
literal|31
block|}
decl_stmt|;
name|days
operator|=
name|year
operator|*
literal|365
expr_stmt|;
if|if
condition|(
name|year
operator|>
literal|2
condition|)
name|days
operator|+=
operator|(
name|year
operator|+
literal|2
operator|)
operator|/
literal|4
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|month
condition|;
name|i
operator|++
control|)
name|days
operator|+=
name|monlen
index|[
name|i
operator|-
literal|1
index|]
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|year
operator|+
literal|2
operator|)
operator|%
literal|4
operator|)
operator|==
literal|0
operator|&&
name|month
operator|>
literal|2
condition|)
name|days
operator|++
expr_stmt|;
name|days
operator|+=
name|day
operator|-
literal|1
expr_stmt|;
name|crtime
operator|=
operator|(
operator|(
operator|(
operator|(
name|days
operator|*
literal|24
operator|)
operator|+
name|hour
operator|)
operator|*
literal|60
operator|+
name|minute
operator|)
operator|*
literal|60
operator|)
operator|+
name|second
expr_stmt|;
comment|/* sign extend */
if|if
condition|(
name|tz
operator|&
literal|0x80
condition|)
name|tz
operator||=
operator|(
operator|-
literal|1
operator|<<
literal|8
operator|)
expr_stmt|;
comment|/* timezone offset is unreliable on some disks */
if|if
condition|(
operator|-
literal|48
operator|<=
name|tz
operator|&&
name|tz
operator|<=
literal|52
condition|)
name|crtime
operator|+=
name|tz
operator|*
literal|15
operator|*
literal|60
expr_stmt|;
block|}
name|pu
operator|->
name|tv_sec
operator|=
name|crtime
expr_stmt|;
name|pu
operator|->
name|tv_usec
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|unsigned
name|isofs_chars2ui
parameter_list|(
name|begin
parameter_list|,
name|end
parameter_list|)
name|unsigned
name|char
modifier|*
name|begin
decl_stmt|;
name|unsigned
name|char
modifier|*
name|end
decl_stmt|;
block|{
name|unsigned
name|rc
init|=
literal|0
decl_stmt|;
name|int
name|len
decl_stmt|;
name|int
name|wlen
decl_stmt|;
specifier|static
name|int
name|pow
index|[]
init|=
block|{
literal|1
block|,
literal|10
block|,
literal|100
block|,
literal|1000
block|}
decl_stmt|;
name|len
operator|=
name|end
operator|-
name|begin
expr_stmt|;
name|wlen
operator|=
name|len
expr_stmt|;
for|for
control|(
init|;
name|len
operator|>=
literal|0
condition|;
name|len
operator|--
control|)
block|{
name|rc
operator|+=
operator|(
operator|*
operator|(
name|begin
operator|+
name|len
operator|)
operator|*
name|pow
index|[
name|wlen
operator|-
name|len
index|]
operator|)
expr_stmt|;
block|}
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|isofs_rrip_tstamp_conv17
parameter_list|(
name|pi
parameter_list|,
name|pu
parameter_list|)
name|unsigned
name|char
modifier|*
name|pi
decl_stmt|;
name|struct
name|timeval
modifier|*
name|pu
decl_stmt|;
block|{
name|unsigned
name|char
name|buf
index|[
literal|7
index|]
decl_stmt|;
comment|/* year:"0001"-"9999" -> -1900  */
name|buf
index|[
literal|0
index|]
operator|=
call|(
name|unsigned
name|char
call|)
argument_list|(
name|isofs_chars2ui
argument_list|(
operator|&
name|pi
index|[
literal|0
index|]
argument_list|,
operator|&
name|pi
index|[
literal|3
index|]
argument_list|)
operator|-
literal|1900
argument_list|)
expr_stmt|;
comment|/* month: " 1"-"12"      -> 1 - 12 */
name|buf
index|[
literal|1
index|]
operator|=
operator|(
name|unsigned
name|char
operator|)
name|isofs_chars2ui
argument_list|(
operator|&
name|pi
index|[
literal|4
index|]
argument_list|,
operator|&
name|pi
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
comment|/* day:   " 1"-"31"      -> 1 - 31 */
name|buf
index|[
literal|2
index|]
operator|=
name|isofs_chars2ui
argument_list|(
operator|&
name|pi
index|[
literal|6
index|]
argument_list|,
operator|&
name|pi
index|[
literal|7
index|]
argument_list|)
expr_stmt|;
comment|/* hour:  " 0"-"23"      -> 0 - 23 */
name|buf
index|[
literal|3
index|]
operator|=
name|isofs_chars2ui
argument_list|(
operator|&
name|pi
index|[
literal|8
index|]
argument_list|,
operator|&
name|pi
index|[
literal|9
index|]
argument_list|)
expr_stmt|;
comment|/* minute:" 0"-"59"      -> 0 - 59 */
name|buf
index|[
literal|4
index|]
operator|=
name|isofs_chars2ui
argument_list|(
operator|&
name|pi
index|[
literal|10
index|]
argument_list|,
operator|&
name|pi
index|[
literal|11
index|]
argument_list|)
expr_stmt|;
comment|/* second:" 0"-"59"      -> 0 - 59 */
name|buf
index|[
literal|5
index|]
operator|=
name|isofs_chars2ui
argument_list|(
operator|&
name|pi
index|[
literal|12
index|]
argument_list|,
operator|&
name|pi
index|[
literal|13
index|]
argument_list|)
expr_stmt|;
comment|/* difference of GMT */
name|buf
index|[
literal|6
index|]
operator|=
name|pi
index|[
literal|16
index|]
expr_stmt|;
name|isofs_rrip_tstamp_conv7
argument_list|(
name|buf
argument_list|,
name|pu
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|isofs_rrip_tstamp
parameter_list|(
name|p
parameter_list|,
name|ana
parameter_list|)
name|ISO_RRIP_TSTAMP
modifier|*
name|p
decl_stmt|;
name|ISO_RRIP_ANALYZE
modifier|*
name|ana
decl_stmt|;
block|{
name|unsigned
name|char
modifier|*
name|ptime
decl_stmt|;
name|ptime
operator|=
name|p
operator|->
name|time
expr_stmt|;
comment|/* Check a format of time stamp (7bytes/17bytes) */
if|if
condition|(
operator|!
operator|(
operator|*
name|p
operator|->
name|flags
operator|&
name|ISO_SUSP_TSTAMP_FORM17
operator|)
condition|)
block|{
name|isofs_rrip_tstamp_conv7
argument_list|(
name|ptime
argument_list|,
operator|&
name|ana
operator|->
name|inode
operator|.
name|iso_ctime
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|p
operator|->
name|flags
operator|&
name|ISO_SUSP_TSTAMP_MODIFY
condition|)
name|isofs_rrip_tstamp_conv7
argument_list|(
name|ptime
operator|+
literal|7
argument_list|,
operator|&
name|ana
operator|->
name|inode
operator|.
name|iso_mtime
argument_list|)
expr_stmt|;
else|else
name|ana
operator|->
name|inode
operator|.
name|iso_mtime
operator|=
name|ana
operator|->
name|inode
operator|.
name|iso_ctime
expr_stmt|;
if|if
condition|(
operator|*
name|p
operator|->
name|flags
operator|&
name|ISO_SUSP_TSTAMP_ACCESS
condition|)
name|isofs_rrip_tstamp_conv7
argument_list|(
name|ptime
operator|+
literal|14
argument_list|,
operator|&
name|ana
operator|->
name|inode
operator|.
name|iso_atime
argument_list|)
expr_stmt|;
else|else
name|ana
operator|->
name|inode
operator|.
name|iso_atime
operator|=
name|ana
operator|->
name|inode
operator|.
name|iso_ctime
expr_stmt|;
block|}
else|else
block|{
name|isofs_rrip_tstamp_conv17
argument_list|(
name|ptime
argument_list|,
operator|&
name|ana
operator|->
name|inode
operator|.
name|iso_ctime
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|p
operator|->
name|flags
operator|&
name|ISO_SUSP_TSTAMP_MODIFY
condition|)
name|isofs_rrip_tstamp_conv17
argument_list|(
name|ptime
operator|+
literal|17
argument_list|,
operator|&
name|ana
operator|->
name|inode
operator|.
name|iso_mtime
argument_list|)
expr_stmt|;
else|else
name|ana
operator|->
name|inode
operator|.
name|iso_mtime
operator|=
name|ana
operator|->
name|inode
operator|.
name|iso_ctime
expr_stmt|;
if|if
condition|(
operator|*
name|p
operator|->
name|flags
operator|&
name|ISO_SUSP_TSTAMP_ACCESS
condition|)
name|isofs_rrip_tstamp_conv17
argument_list|(
name|ptime
operator|+
literal|34
argument_list|,
operator|&
name|ana
operator|->
name|inode
operator|.
name|iso_atime
argument_list|)
expr_stmt|;
else|else
name|ana
operator|->
name|inode
operator|.
name|iso_atime
operator|=
name|ana
operator|->
name|inode
operator|.
name|iso_ctime
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|isofs_rrip_deftstamp
parameter_list|(
name|isodir
parameter_list|,
name|ana
parameter_list|)
name|struct
name|iso_directory_record
modifier|*
name|isodir
decl_stmt|;
name|ISO_RRIP_ANALYZE
modifier|*
name|ana
decl_stmt|;
block|{
name|isofs_rrip_tstamp_conv7
argument_list|(
name|isodir
operator|->
name|date
argument_list|,
operator|&
name|ana
operator|->
name|inode
operator|.
name|iso_ctime
argument_list|)
expr_stmt|;
name|ana
operator|->
name|inode
operator|.
name|iso_atime
operator|=
name|ana
operator|->
name|inode
operator|.
name|iso_ctime
expr_stmt|;
name|ana
operator|->
name|inode
operator|.
name|iso_mtime
operator|=
name|ana
operator|->
name|inode
operator|.
name|iso_ctime
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Flag indicating  *   Nothing to do....  */
end_comment

begin_function
specifier|static
name|int
name|isofs_rrip_idflag
parameter_list|(
name|p
parameter_list|,
name|ana
parameter_list|)
name|ISO_RRIP_IDFLAG
modifier|*
name|p
decl_stmt|;
name|ISO_RRIP_ANALYZE
modifier|*
name|ana
decl_stmt|;
block|{
name|char
name|buf
index|[
literal|3
index|]
decl_stmt|;
name|buf
index|[
literal|0
index|]
operator|=
name|p
operator|->
name|h
operator|.
name|type
index|[
literal|0
index|]
expr_stmt|;
name|buf
index|[
literal|1
index|]
operator|=
name|p
operator|->
name|h
operator|.
name|type
index|[
literal|1
index|]
expr_stmt|;
name|buf
index|[
literal|2
index|]
operator|=
literal|0x00
expr_stmt|;
name|printf
argument_list|(
literal|"isofs:%s[%d] idflag=0x%x\n"
argument_list|,
name|buf
argument_list|,
name|isonum_711
argument_list|(
name|p
operator|->
name|h
operator|.
name|length
argument_list|)
argument_list|,
name|p
operator|->
name|flags
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Extension reference  *   Nothing to do....  */
end_comment

begin_function
specifier|static
name|int
name|isofs_rrip_exflag
parameter_list|(
name|p
parameter_list|,
name|ana
parameter_list|)
name|ISO_RRIP_EXFLAG
modifier|*
name|p
decl_stmt|;
name|ISO_RRIP_ANALYZE
modifier|*
name|ana
decl_stmt|;
block|{
name|char
name|buf
index|[
literal|3
index|]
decl_stmt|;
name|buf
index|[
literal|0
index|]
operator|=
name|p
operator|->
name|h
operator|.
name|type
index|[
literal|0
index|]
expr_stmt|;
name|buf
index|[
literal|1
index|]
operator|=
name|p
operator|->
name|h
operator|.
name|type
index|[
literal|1
index|]
expr_stmt|;
name|buf
index|[
literal|2
index|]
operator|=
literal|0x00
expr_stmt|;
name|printf
argument_list|(
literal|"isofs:%s[%d] exflag=0x%x"
argument_list|,
name|buf
argument_list|,
name|isonum_711
argument_list|(
name|p
operator|->
name|h
operator|.
name|length
argument_list|)
argument_list|,
name|p
operator|->
name|flags
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Unknown ...  *   Nothing to do....  */
end_comment

begin_function
specifier|static
name|int
name|isofs_rrip_unknown
parameter_list|(
name|p
parameter_list|,
name|ana
parameter_list|)
name|ISO_RRIP_EXFLAG
modifier|*
name|p
decl_stmt|;
name|ISO_RRIP_ANALYZE
modifier|*
name|ana
decl_stmt|;
block|{
return|return
literal|0
return|;
block|}
end_function

begin_typedef
typedef|typedef
struct|struct
block|{
name|char
name|type
index|[
literal|2
index|]
decl_stmt|;
name|int
function_decl|(
modifier|*
name|func
function_decl|)
parameter_list|()
function_decl|;
name|int
function_decl|(
modifier|*
name|func2
function_decl|)
parameter_list|()
function_decl|;
name|int
name|result
decl_stmt|;
block|}
name|RRIP_TABLE
typedef|;
end_typedef

begin_decl_stmt
specifier|static
name|RRIP_TABLE
name|rrip_table
index|[]
init|=
block|{
block|{
literal|'P'
block|,
literal|'X'
block|,
name|isofs_rrip_attr
block|,
name|isofs_rrip_defattr
block|,
name|ISO_SUSP_ATTR
block|}
block|,
block|{
literal|'T'
block|,
literal|'F'
block|,
name|isofs_rrip_tstamp
block|,
name|isofs_rrip_deftstamp
block|,
name|ISO_SUSP_TSTAMP
block|}
block|,
block|{
literal|'N'
block|,
literal|'M'
block|,
name|isofs_rrip_altname
block|,
literal|0
block|,
name|ISO_SUSP_ALTNAME
block|}
block|,
block|{
literal|'C'
block|,
literal|'L'
block|,
name|isofs_rrip_clink
block|,
literal|0
block|,
name|ISO_SUSP_CLINK
block|}
block|,
block|{
literal|'P'
block|,
literal|'L'
block|,
name|isofs_rrip_plink
block|,
literal|0
block|,
name|ISO_SUSP_PLINK
block|}
block|,
block|{
literal|'S'
block|,
literal|'L'
block|,
name|isofs_rrip_slink
block|,
literal|0
block|,
name|ISO_SUSP_SLINK
block|}
block|,
block|{
literal|'R'
block|,
literal|'E'
block|,
name|isofs_rrip_reldir
block|,
literal|0
block|,
name|ISO_SUSP_RELDIR
block|}
block|,
block|{
literal|'P'
block|,
literal|'N'
block|,
name|isofs_rrip_device
block|,
literal|0
block|,
name|ISO_SUSP_DEVICE
block|}
block|,
block|{
literal|'R'
block|,
literal|'R'
block|,
name|isofs_rrip_idflag
block|,
literal|0
block|,
name|ISO_SUSP_IDFLAG
block|}
block|,
block|{
literal|'E'
block|,
literal|'R'
block|,
name|isofs_rrip_exflag
block|,
literal|0
block|,
name|ISO_SUSP_EXFLAG
block|}
block|,
block|{
literal|'S'
block|,
literal|'P'
block|,
name|isofs_rrip_unknown
block|,
literal|0
block|,
name|ISO_SUSP_UNKNOWN
block|}
block|,
block|{
literal|'C'
block|,
literal|'E'
block|,
name|isofs_rrip_unknown
block|,
literal|0
block|,
name|ISO_SUSP_UNKNOWN
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|isofs_rrip_analyze
parameter_list|(
name|isodir
parameter_list|,
name|analyze
parameter_list|)
name|struct
name|iso_directory_record
modifier|*
name|isodir
decl_stmt|;
name|ISO_RRIP_ANALYZE
modifier|*
name|analyze
decl_stmt|;
block|{
specifier|register
name|RRIP_TABLE
modifier|*
name|ptable
decl_stmt|;
specifier|register
name|ISO_SUSP_HEADER
modifier|*
name|phead
decl_stmt|;
specifier|register
name|ISO_SUSP_HEADER
modifier|*
name|pend
decl_stmt|;
name|int
name|found
decl_stmt|;
name|int
name|i
decl_stmt|;
name|char
modifier|*
name|pwhead
decl_stmt|;
name|int
name|result
decl_stmt|;
comment|/*          * Note: If name length is odd, 	 *       it will be padding 1 byte  after the name 	 */
name|pwhead
operator|=
name|isodir
operator|->
name|name
operator|+
name|isonum_711
argument_list|(
name|isodir
operator|->
name|name_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|isonum_711
argument_list|(
name|isodir
operator|->
name|name_len
argument_list|)
operator|&
literal|0x0001
operator|)
condition|)
name|pwhead
operator|++
expr_stmt|;
name|phead
operator|=
operator|(
name|ISO_SUSP_HEADER
operator|*
operator|)
name|pwhead
expr_stmt|;
name|pend
operator|=
operator|(
name|ISO_SUSP_HEADER
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|isodir
operator|+
name|isonum_711
argument_list|(
name|isodir
operator|->
name|length
argument_list|)
operator|)
expr_stmt|;
name|result
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|pend
operator|==
name|phead
condition|)
block|{
goto|goto
name|setdefault
goto|;
block|}
comment|/* 	 * Note: "pend" should be more than one SUSP header 	 */
while|while
condition|(
name|pend
operator|>=
name|phead
operator|+
literal|1
condition|)
block|{
name|found
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|ptable
operator|=
operator|&
name|rrip_table
index|[
literal|0
index|]
init|;
name|ptable
operator|<
operator|&
name|rrip_table
index|[
sizeof|sizeof
argument_list|(
name|rrip_table
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|RRIP_TABLE
argument_list|)
index|]
condition|;
name|ptable
operator|++
control|)
block|{
if|if
condition|(
name|bcmp
argument_list|(
name|phead
operator|->
name|type
argument_list|,
name|ptable
operator|->
name|type
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|found
operator|=
literal|1
expr_stmt|;
name|ptable
operator|->
name|func
argument_list|(
name|phead
argument_list|,
name|analyze
argument_list|)
expr_stmt|;
name|result
operator||=
name|ptable
operator|->
name|result
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|found
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"isofs: name '"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|isonum_711
argument_list|(
name|isodir
operator|->
name|name_len
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"%c"
argument_list|,
operator|*
operator|(
name|isodir
operator|->
name|name
operator|+
name|i
operator|)
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"'"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" - type %c%c [%08x/%08x]...not found\n"
argument_list|,
name|phead
operator|->
name|type
index|[
literal|0
index|]
argument_list|,
name|phead
operator|->
name|type
index|[
literal|1
index|]
argument_list|,
name|phead
argument_list|,
name|pend
argument_list|)
expr_stmt|;
name|isofs_hexdump
argument_list|(
name|phead
argument_list|,
call|(
name|int
call|)
argument_list|(
operator|(
name|char
operator|*
operator|)
name|pend
operator|-
operator|(
name|char
operator|*
operator|)
name|phead
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* 		 * move to next SUSP 		 */
name|phead
operator|=
operator|(
name|ISO_SUSP_HEADER
operator|*
operator|)
operator|(
operator|(
name|unsigned
operator|)
name|isonum_711
argument_list|(
name|phead
operator|->
name|length
argument_list|)
operator|+
operator|(
name|char
operator|*
operator|)
name|phead
operator|)
expr_stmt|;
block|}
name|setdefault
label|:
comment|/* 	 * If we don't find the Basic SUSP stuffs, just set default value          *   ( attribute/time stamp ) 	 */
for|for
control|(
name|ptable
operator|=
operator|&
name|rrip_table
index|[
literal|0
index|]
init|;
name|ptable
operator|<
operator|&
name|rrip_table
index|[
literal|2
index|]
condition|;
name|ptable
operator|++
control|)
block|{
if|if
condition|(
name|ptable
operator|->
name|func2
operator|!=
literal|0
operator|&&
operator|!
operator|(
name|ptable
operator|->
name|result
operator|&
name|result
operator|)
condition|)
block|{
name|ptable
operator|->
name|func2
argument_list|(
name|isodir
argument_list|,
name|analyze
argument_list|)
expr_stmt|;
block|}
block|}
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_comment
comment|/*   * Get Alternate Name from 'AL' record   * If either no AL record nor 0 lenght,   *    it will be return the translated ISO9660 name,  */
end_comment

begin_function
name|int
name|isofs_rrip_getname
parameter_list|(
name|isodir
parameter_list|,
name|outbuf
parameter_list|,
name|outlen
parameter_list|)
name|struct
name|iso_directory_record
modifier|*
name|isodir
decl_stmt|;
name|char
modifier|*
name|outbuf
decl_stmt|;
name|int
modifier|*
name|outlen
decl_stmt|;
block|{
name|ISO_SUSP_HEADER
modifier|*
name|phead
decl_stmt|,
modifier|*
name|pend
decl_stmt|;
name|ISO_RRIP_ALTNAME
modifier|*
name|p
decl_stmt|;
name|char
modifier|*
name|pwhead
decl_stmt|;
name|int
name|found
decl_stmt|;
comment|/*          * Note: If name length is odd, 	 *       it will be padding 1 byte  after the name 	 */
name|pwhead
operator|=
name|isodir
operator|->
name|name
operator|+
name|isonum_711
argument_list|(
name|isodir
operator|->
name|name_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|isonum_711
argument_list|(
name|isodir
operator|->
name|name_len
argument_list|)
operator|&
literal|0x0001
operator|)
condition|)
name|pwhead
operator|++
expr_stmt|;
name|phead
operator|=
operator|(
name|ISO_SUSP_HEADER
operator|*
operator|)
name|pwhead
expr_stmt|;
name|pend
operator|=
operator|(
name|ISO_SUSP_HEADER
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|isodir
operator|+
name|isonum_711
argument_list|(
name|isodir
operator|->
name|length
argument_list|)
operator|)
expr_stmt|;
name|found
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|pend
operator|!=
name|phead
condition|)
block|{
while|while
condition|(
name|pend
operator|>=
name|phead
operator|+
literal|1
condition|)
block|{
if|if
condition|(
name|bcmp
argument_list|(
name|phead
operator|->
name|type
argument_list|,
literal|"NM"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|found
operator|=
literal|1
expr_stmt|;
break|break;
block|}
name|phead
operator|=
operator|(
name|ISO_SUSP_HEADER
operator|*
operator|)
operator|(
operator|(
name|unsigned
operator|)
name|isonum_711
argument_list|(
name|phead
operator|->
name|length
argument_list|)
operator|+
operator|(
name|char
operator|*
operator|)
name|phead
operator|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|found
operator|==
literal|1
condition|)
block|{
name|p
operator|=
operator|(
name|ISO_RRIP_ALTNAME
operator|*
operator|)
name|phead
expr_stmt|;
operator|*
name|outlen
operator|=
name|isonum_711
argument_list|(
name|p
operator|->
name|h
operator|.
name|length
argument_list|)
operator|-
sizeof|sizeof
argument_list|(
name|ISO_RRIP_ALTNAME
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
operator|&
name|p
operator|->
name|flags
operator|+
literal|1
operator|)
argument_list|,
name|outbuf
argument_list|,
operator|*
name|outlen
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|isofntrans
argument_list|(
name|isodir
operator|->
name|name
argument_list|,
name|isonum_711
argument_list|(
name|isodir
operator|->
name|name_len
argument_list|)
argument_list|,
name|outbuf
argument_list|,
name|outlen
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|outlen
operator|==
literal|1
condition|)
block|{
switch|switch
condition|(
name|outbuf
index|[
literal|0
index|]
condition|)
block|{
case|case
literal|0
case|:
name|outbuf
index|[
literal|0
index|]
operator|=
literal|'.'
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|outbuf
index|[
literal|0
index|]
operator|=
literal|'.'
expr_stmt|;
name|outbuf
index|[
literal|1
index|]
operator|=
literal|'.'
expr_stmt|;
operator|*
name|outlen
operator|=
literal|2
expr_stmt|;
block|}
block|}
block|}
return|return
operator|(
name|found
operator|)
return|;
block|}
end_function

begin_comment
comment|/*   * Get Symbolic Name from 'SL' record   *  * Note: isodir should contains SL record!  */
end_comment

begin_function
name|int
name|isofs_rrip_getsymname
parameter_list|(
name|vp
parameter_list|,
name|isodir
parameter_list|,
name|outbuf
parameter_list|,
name|outlen
parameter_list|)
name|struct
name|vnode
modifier|*
name|vp
decl_stmt|;
name|struct
name|iso_directory_record
modifier|*
name|isodir
decl_stmt|;
name|char
modifier|*
name|outbuf
decl_stmt|;
name|int
modifier|*
name|outlen
decl_stmt|;
block|{
specifier|register
name|ISO_RRIP_SLINK_COMPONENT
modifier|*
name|pcomp
decl_stmt|;
specifier|register
name|ISO_SUSP_HEADER
modifier|*
name|phead
decl_stmt|,
modifier|*
name|pend
decl_stmt|;
specifier|register
name|ISO_RRIP_SLINK_COMPONENT
modifier|*
name|pcompe
decl_stmt|;
name|ISO_RRIP_SLINK
modifier|*
name|p
decl_stmt|;
name|char
modifier|*
name|pwhead
decl_stmt|;
name|int
name|found
decl_stmt|;
name|int
name|slash
decl_stmt|;
name|int
name|wlen
decl_stmt|;
comment|/*          * Note: If name length is odd, 	 *       it will be padding 1 byte  after the name 	 */
name|pwhead
operator|=
name|isodir
operator|->
name|name
operator|+
name|isonum_711
argument_list|(
name|isodir
operator|->
name|name_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|isonum_711
argument_list|(
name|isodir
operator|->
name|name_len
argument_list|)
operator|&
literal|0x0001
operator|)
condition|)
name|pwhead
operator|++
expr_stmt|;
name|phead
operator|=
operator|(
name|ISO_SUSP_HEADER
operator|*
operator|)
name|pwhead
expr_stmt|;
name|pend
operator|=
operator|(
name|ISO_SUSP_HEADER
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|isodir
operator|+
name|isonum_711
argument_list|(
name|isodir
operator|->
name|length
argument_list|)
operator|)
expr_stmt|;
name|found
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|pend
operator|!=
name|phead
condition|)
block|{
while|while
condition|(
name|pend
operator|>=
name|phead
operator|+
literal|1
condition|)
block|{
if|if
condition|(
name|bcmp
argument_list|(
name|phead
operator|->
name|type
argument_list|,
literal|"SL"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|found
operator|=
literal|1
expr_stmt|;
break|break;
block|}
name|phead
operator|=
operator|(
name|ISO_SUSP_HEADER
operator|*
operator|)
operator|(
operator|(
name|unsigned
operator|)
name|isonum_711
argument_list|(
name|phead
operator|->
name|length
argument_list|)
operator|+
operator|(
name|char
operator|*
operator|)
name|phead
operator|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|found
operator|==
literal|0
condition|)
block|{
operator|*
name|outlen
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|found
operator|)
return|;
block|}
name|p
operator|=
operator|(
name|ISO_RRIP_SLINK
operator|*
operator|)
name|phead
expr_stmt|;
name|pcomp
operator|=
operator|(
name|ISO_RRIP_SLINK_COMPONENT
operator|*
operator|)
name|p
operator|->
name|component
expr_stmt|;
name|pcompe
operator|=
operator|(
name|ISO_RRIP_SLINK_COMPONENT
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|p
operator|+
name|isonum_711
argument_list|(
name|p
operator|->
name|h
operator|.
name|length
argument_list|)
operator|)
expr_stmt|;
comment|/*          * Gathering a Symbolic name from each component with path          */
operator|*
name|outlen
operator|=
literal|0
expr_stmt|;
name|slash
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|pcomp
operator|<
name|pcompe
condition|)
block|{
comment|/* Inserting Current */
if|if
condition|(
name|pcomp
operator|->
name|cflag
index|[
literal|0
index|]
operator|&
name|ISO_SUSP_CFLAG_CURRENT
condition|)
block|{
name|bcopy
argument_list|(
literal|"./"
argument_list|,
name|outbuf
operator|+
operator|*
name|outlen
argument_list|,
literal|2
argument_list|)
expr_stmt|;
operator|*
name|outlen
operator|+=
literal|2
expr_stmt|;
name|slash
operator|=
literal|0
expr_stmt|;
block|}
comment|/* Inserting Parent */
if|if
condition|(
name|pcomp
operator|->
name|cflag
index|[
literal|0
index|]
operator|&
name|ISO_SUSP_CFLAG_PARENT
condition|)
block|{
name|bcopy
argument_list|(
literal|"../"
argument_list|,
name|outbuf
operator|+
operator|*
name|outlen
argument_list|,
literal|3
argument_list|)
expr_stmt|;
operator|*
name|outlen
operator|+=
literal|3
expr_stmt|;
name|slash
operator|=
literal|0
expr_stmt|;
block|}
comment|/* Inserting slash for ROOT */
if|if
condition|(
name|pcomp
operator|->
name|cflag
index|[
literal|0
index|]
operator|&
name|ISO_SUSP_CFLAG_ROOT
condition|)
block|{
name|bcopy
argument_list|(
literal|"/"
argument_list|,
name|outbuf
operator|+
operator|*
name|outlen
argument_list|,
literal|1
argument_list|)
expr_stmt|;
operator|*
name|outlen
operator|+=
literal|1
expr_stmt|;
name|slash
operator|=
literal|0
expr_stmt|;
block|}
comment|/* Inserting a mount point i.e. "/cdrom" */
if|if
condition|(
name|pcomp
operator|->
name|cflag
index|[
literal|0
index|]
operator|&
name|ISO_SUSP_CFLAG_VOLROOT
condition|)
block|{
name|wlen
operator|=
name|strlen
argument_list|(
name|vp
operator|->
name|v_mount
operator|->
name|mnt_stat
operator|.
name|f_mntonname
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|vp
operator|->
name|v_mount
operator|->
name|mnt_stat
operator|.
name|f_mntonname
argument_list|,
name|outbuf
operator|+
operator|*
name|outlen
argument_list|,
name|wlen
argument_list|)
expr_stmt|;
operator|*
name|outlen
operator|+=
name|wlen
expr_stmt|;
name|slash
operator|=
literal|1
expr_stmt|;
block|}
comment|/* Inserting hostname i.e. "tama:" */
if|if
condition|(
name|pcomp
operator|->
name|cflag
index|[
literal|0
index|]
operator|&
name|ISO_SUSP_CFLAG_HOST
condition|)
block|{
name|bcopy
argument_list|(
name|hostname
argument_list|,
name|outbuf
operator|+
operator|*
name|outlen
argument_list|,
name|hostnamelen
argument_list|)
expr_stmt|;
operator|*
operator|(
name|outbuf
operator|+
name|hostnamelen
operator|)
operator|=
literal|':'
expr_stmt|;
operator|*
name|outlen
operator|+=
operator|(
name|hostnamelen
operator|+
literal|1
operator|)
expr_stmt|;
name|slash
operator|=
literal|0
expr_stmt|;
comment|/* Uuum Should we insert a slash ? */
block|}
comment|/* Inserting slash for next component */
if|if
condition|(
name|slash
operator|==
literal|1
condition|)
block|{
name|outbuf
index|[
operator|*
name|outlen
index|]
operator|=
literal|'/'
expr_stmt|;
operator|*
name|outlen
operator|+=
literal|1
expr_stmt|;
name|slash
operator|=
literal|0
expr_stmt|;
block|}
comment|/* Inserting component */
name|wlen
operator|=
name|isonum_711
argument_list|(
name|pcomp
operator|->
name|clen
argument_list|)
expr_stmt|;
if|if
condition|(
name|wlen
operator|!=
literal|0
condition|)
block|{
name|bcopy
argument_list|(
name|pcomp
operator|->
name|name
argument_list|,
name|outbuf
operator|+
operator|*
name|outlen
argument_list|,
name|wlen
argument_list|)
expr_stmt|;
operator|*
name|outlen
operator|+=
name|wlen
expr_stmt|;
name|slash
operator|=
literal|1
expr_stmt|;
block|}
comment|/*                  * Move to next component... 		 */
name|pcomp
operator|=
operator|(
name|ISO_RRIP_SLINK_COMPONENT
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|pcomp
operator|+
sizeof|sizeof
argument_list|(
name|ISO_RRIP_SLINK_COMPONENT
argument_list|)
operator|-
literal|1
operator|+
name|isonum_711
argument_list|(
name|pcomp
operator|->
name|clen
argument_list|)
operator|)
expr_stmt|;
block|}
return|return
operator|(
name|found
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Hexdump routine for debug*/
end_comment

begin_function
name|int
name|isofs_hexdump
parameter_list|(
name|p
parameter_list|,
name|size
parameter_list|)
name|unsigned
name|char
modifier|*
name|p
decl_stmt|;
name|int
name|size
decl_stmt|;
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|k
decl_stmt|;
name|unsigned
name|char
modifier|*
name|wp
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|size
condition|;
name|i
operator|+=
literal|16
control|)
block|{
name|printf
argument_list|(
literal|"isofs: "
argument_list|)
expr_stmt|;
name|wp
operator|=
name|p
expr_stmt|;
name|k
operator|=
operator|(
operator|(
name|size
operator|-
name|i
operator|)
operator|>
literal|16
condition|?
literal|16
else|:
name|size
operator|-
name|i
operator|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|k
condition|;
name|j
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"%02x "
argument_list|,
operator|*
name|p
argument_list|)
expr_stmt|;
name|p
operator|++
expr_stmt|;
block|}
name|printf
argument_list|(
literal|" : "
argument_list|)
expr_stmt|;
name|p
operator|=
name|wp
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|k
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
operator|(
operator|*
name|p
operator|>
literal|0x20
operator|)
operator|&&
operator|(
operator|*
name|p
operator|<
literal|0x7f
operator|)
condition|)
name|printf
argument_list|(
literal|"%c"
argument_list|,
operator|*
name|p
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
name|p
operator|++
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


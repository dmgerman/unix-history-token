begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* chacha-merged.c version 20080118 D. J. Bernstein Public domain. */
end_comment

begin_comment
comment|/* $OpenBSD: chacha.c,v 1.1 2013/11/21 00:45:44 djm Exp $ */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<crypto/chacha20/chacha.h>
end_include

begin_typedef
typedef|typedef
name|uint8_t
name|u8
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|uint32_t
name|u32
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|struct
name|chacha_ctx
name|chacha_ctx
typedef|;
end_typedef

begin_define
define|#
directive|define
name|U8C
parameter_list|(
name|v
parameter_list|)
value|(v##U)
end_define

begin_define
define|#
directive|define
name|U32C
parameter_list|(
name|v
parameter_list|)
value|(v##U)
end_define

begin_define
define|#
directive|define
name|U8V
parameter_list|(
name|v
parameter_list|)
value|((u8)(v)& U8C(0xFF))
end_define

begin_define
define|#
directive|define
name|U32V
parameter_list|(
name|v
parameter_list|)
value|((u32)(v)& U32C(0xFFFFFFFF))
end_define

begin_define
define|#
directive|define
name|ROTL32
parameter_list|(
name|v
parameter_list|,
name|n
parameter_list|)
define|\
value|(U32V((v)<< (n)) | ((v)>> (32 - (n))))
end_define

begin_define
define|#
directive|define
name|U8TO32_LITTLE
parameter_list|(
name|p
parameter_list|)
define|\
value|(((u32)((p)[0])      ) | \    ((u32)((p)[1])<<  8) | \    ((u32)((p)[2])<< 16) | \    ((u32)((p)[3])<< 24))
end_define

begin_define
define|#
directive|define
name|U32TO8_LITTLE
parameter_list|(
name|p
parameter_list|,
name|v
parameter_list|)
define|\
value|do { \     (p)[0] = U8V((v)      ); \     (p)[1] = U8V((v)>>  8); \     (p)[2] = U8V((v)>> 16); \     (p)[3] = U8V((v)>> 24); \   } while (0)
end_define

begin_define
define|#
directive|define
name|ROTATE
parameter_list|(
name|v
parameter_list|,
name|c
parameter_list|)
value|(ROTL32(v,c))
end_define

begin_define
define|#
directive|define
name|XOR
parameter_list|(
name|v
parameter_list|,
name|w
parameter_list|)
value|((v) ^ (w))
end_define

begin_define
define|#
directive|define
name|PLUS
parameter_list|(
name|v
parameter_list|,
name|w
parameter_list|)
value|(U32V((v) + (w)))
end_define

begin_define
define|#
directive|define
name|PLUSONE
parameter_list|(
name|v
parameter_list|)
value|(PLUS((v),1))
end_define

begin_define
define|#
directive|define
name|QUARTERROUND
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|,
name|c
parameter_list|,
name|d
parameter_list|)
define|\
value|a = PLUS(a,b); d = ROTATE(XOR(d,a),16); \   c = PLUS(c,d); b = ROTATE(XOR(b,c),12); \   a = PLUS(a,b); d = ROTATE(XOR(d,a), 8); \   c = PLUS(c,d); b = ROTATE(XOR(b,c), 7);
end_define

begin_decl_stmt
specifier|static
specifier|const
name|char
name|sigma
index|[
literal|16
index|]
init|=
literal|"expand 32-byte k"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
name|tau
index|[
literal|16
index|]
init|=
literal|"expand 16-byte k"
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|chacha_keysetup
parameter_list|(
name|chacha_ctx
modifier|*
name|x
parameter_list|,
specifier|const
name|u8
modifier|*
name|k
parameter_list|,
name|u32
name|kbits
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|constants
decl_stmt|;
name|x
operator|->
name|input
index|[
literal|4
index|]
operator|=
name|U8TO32_LITTLE
argument_list|(
name|k
operator|+
literal|0
argument_list|)
expr_stmt|;
name|x
operator|->
name|input
index|[
literal|5
index|]
operator|=
name|U8TO32_LITTLE
argument_list|(
name|k
operator|+
literal|4
argument_list|)
expr_stmt|;
name|x
operator|->
name|input
index|[
literal|6
index|]
operator|=
name|U8TO32_LITTLE
argument_list|(
name|k
operator|+
literal|8
argument_list|)
expr_stmt|;
name|x
operator|->
name|input
index|[
literal|7
index|]
operator|=
name|U8TO32_LITTLE
argument_list|(
name|k
operator|+
literal|12
argument_list|)
expr_stmt|;
if|if
condition|(
name|kbits
operator|==
literal|256
condition|)
block|{
comment|/* recommended */
name|k
operator|+=
literal|16
expr_stmt|;
name|constants
operator|=
name|sigma
expr_stmt|;
block|}
else|else
block|{
comment|/* kbits == 128 */
name|constants
operator|=
name|tau
expr_stmt|;
block|}
name|x
operator|->
name|input
index|[
literal|8
index|]
operator|=
name|U8TO32_LITTLE
argument_list|(
name|k
operator|+
literal|0
argument_list|)
expr_stmt|;
name|x
operator|->
name|input
index|[
literal|9
index|]
operator|=
name|U8TO32_LITTLE
argument_list|(
name|k
operator|+
literal|4
argument_list|)
expr_stmt|;
name|x
operator|->
name|input
index|[
literal|10
index|]
operator|=
name|U8TO32_LITTLE
argument_list|(
name|k
operator|+
literal|8
argument_list|)
expr_stmt|;
name|x
operator|->
name|input
index|[
literal|11
index|]
operator|=
name|U8TO32_LITTLE
argument_list|(
name|k
operator|+
literal|12
argument_list|)
expr_stmt|;
name|x
operator|->
name|input
index|[
literal|0
index|]
operator|=
name|U8TO32_LITTLE
argument_list|(
name|constants
operator|+
literal|0
argument_list|)
expr_stmt|;
name|x
operator|->
name|input
index|[
literal|1
index|]
operator|=
name|U8TO32_LITTLE
argument_list|(
name|constants
operator|+
literal|4
argument_list|)
expr_stmt|;
name|x
operator|->
name|input
index|[
literal|2
index|]
operator|=
name|U8TO32_LITTLE
argument_list|(
name|constants
operator|+
literal|8
argument_list|)
expr_stmt|;
name|x
operator|->
name|input
index|[
literal|3
index|]
operator|=
name|U8TO32_LITTLE
argument_list|(
name|constants
operator|+
literal|12
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|chacha_ivsetup
parameter_list|(
name|chacha_ctx
modifier|*
name|x
parameter_list|,
specifier|const
name|u8
modifier|*
name|iv
parameter_list|,
specifier|const
name|u8
modifier|*
name|counter
parameter_list|)
block|{
name|x
operator|->
name|input
index|[
literal|12
index|]
operator|=
name|counter
operator|==
name|NULL
condition|?
literal|0
else|:
name|U8TO32_LITTLE
argument_list|(
name|counter
operator|+
literal|0
argument_list|)
expr_stmt|;
name|x
operator|->
name|input
index|[
literal|13
index|]
operator|=
name|counter
operator|==
name|NULL
condition|?
literal|0
else|:
name|U8TO32_LITTLE
argument_list|(
name|counter
operator|+
literal|4
argument_list|)
expr_stmt|;
name|x
operator|->
name|input
index|[
literal|14
index|]
operator|=
name|U8TO32_LITTLE
argument_list|(
name|iv
operator|+
literal|0
argument_list|)
expr_stmt|;
name|x
operator|->
name|input
index|[
literal|15
index|]
operator|=
name|U8TO32_LITTLE
argument_list|(
name|iv
operator|+
literal|4
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|chacha_encrypt_bytes
parameter_list|(
name|chacha_ctx
modifier|*
name|x
parameter_list|,
specifier|const
name|u8
modifier|*
name|m
parameter_list|,
name|u8
modifier|*
name|c
parameter_list|,
name|u32
name|bytes
parameter_list|)
block|{
name|u32
name|x0
decl_stmt|,
name|x1
decl_stmt|,
name|x2
decl_stmt|,
name|x3
decl_stmt|,
name|x4
decl_stmt|,
name|x5
decl_stmt|,
name|x6
decl_stmt|,
name|x7
decl_stmt|,
name|x8
decl_stmt|,
name|x9
decl_stmt|,
name|x10
decl_stmt|,
name|x11
decl_stmt|,
name|x12
decl_stmt|,
name|x13
decl_stmt|,
name|x14
decl_stmt|,
name|x15
decl_stmt|;
name|u32
name|j0
decl_stmt|,
name|j1
decl_stmt|,
name|j2
decl_stmt|,
name|j3
decl_stmt|,
name|j4
decl_stmt|,
name|j5
decl_stmt|,
name|j6
decl_stmt|,
name|j7
decl_stmt|,
name|j8
decl_stmt|,
name|j9
decl_stmt|,
name|j10
decl_stmt|,
name|j11
decl_stmt|,
name|j12
decl_stmt|,
name|j13
decl_stmt|,
name|j14
decl_stmt|,
name|j15
decl_stmt|;
name|u8
modifier|*
name|ctarget
init|=
name|NULL
decl_stmt|;
name|u8
name|tmp
index|[
literal|64
index|]
decl_stmt|;
name|u_int
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|bytes
condition|)
return|return;
name|j0
operator|=
name|x
operator|->
name|input
index|[
literal|0
index|]
expr_stmt|;
name|j1
operator|=
name|x
operator|->
name|input
index|[
literal|1
index|]
expr_stmt|;
name|j2
operator|=
name|x
operator|->
name|input
index|[
literal|2
index|]
expr_stmt|;
name|j3
operator|=
name|x
operator|->
name|input
index|[
literal|3
index|]
expr_stmt|;
name|j4
operator|=
name|x
operator|->
name|input
index|[
literal|4
index|]
expr_stmt|;
name|j5
operator|=
name|x
operator|->
name|input
index|[
literal|5
index|]
expr_stmt|;
name|j6
operator|=
name|x
operator|->
name|input
index|[
literal|6
index|]
expr_stmt|;
name|j7
operator|=
name|x
operator|->
name|input
index|[
literal|7
index|]
expr_stmt|;
name|j8
operator|=
name|x
operator|->
name|input
index|[
literal|8
index|]
expr_stmt|;
name|j9
operator|=
name|x
operator|->
name|input
index|[
literal|9
index|]
expr_stmt|;
name|j10
operator|=
name|x
operator|->
name|input
index|[
literal|10
index|]
expr_stmt|;
name|j11
operator|=
name|x
operator|->
name|input
index|[
literal|11
index|]
expr_stmt|;
name|j12
operator|=
name|x
operator|->
name|input
index|[
literal|12
index|]
expr_stmt|;
name|j13
operator|=
name|x
operator|->
name|input
index|[
literal|13
index|]
expr_stmt|;
name|j14
operator|=
name|x
operator|->
name|input
index|[
literal|14
index|]
expr_stmt|;
name|j15
operator|=
name|x
operator|->
name|input
index|[
literal|15
index|]
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|bytes
operator|<
literal|64
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|bytes
condition|;
operator|++
name|i
control|)
name|tmp
index|[
name|i
index|]
operator|=
name|m
index|[
name|i
index|]
expr_stmt|;
name|m
operator|=
name|tmp
expr_stmt|;
name|ctarget
operator|=
name|c
expr_stmt|;
name|c
operator|=
name|tmp
expr_stmt|;
block|}
name|x0
operator|=
name|j0
expr_stmt|;
name|x1
operator|=
name|j1
expr_stmt|;
name|x2
operator|=
name|j2
expr_stmt|;
name|x3
operator|=
name|j3
expr_stmt|;
name|x4
operator|=
name|j4
expr_stmt|;
name|x5
operator|=
name|j5
expr_stmt|;
name|x6
operator|=
name|j6
expr_stmt|;
name|x7
operator|=
name|j7
expr_stmt|;
name|x8
operator|=
name|j8
expr_stmt|;
name|x9
operator|=
name|j9
expr_stmt|;
name|x10
operator|=
name|j10
expr_stmt|;
name|x11
operator|=
name|j11
expr_stmt|;
name|x12
operator|=
name|j12
expr_stmt|;
name|x13
operator|=
name|j13
expr_stmt|;
name|x14
operator|=
name|j14
expr_stmt|;
name|x15
operator|=
name|j15
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|20
init|;
name|i
operator|>
literal|0
condition|;
name|i
operator|-=
literal|2
control|)
block|{
name|QUARTERROUND
argument_list|(
argument|x0
argument_list|,
argument|x4
argument_list|,
argument|x8
argument_list|,
argument|x12
argument_list|)
name|QUARTERROUND
argument_list|(
argument|x1
argument_list|,
argument|x5
argument_list|,
argument|x9
argument_list|,
argument|x13
argument_list|)
name|QUARTERROUND
argument_list|(
argument|x2
argument_list|,
argument|x6
argument_list|,
argument|x10
argument_list|,
argument|x14
argument_list|)
name|QUARTERROUND
argument_list|(
argument|x3
argument_list|,
argument|x7
argument_list|,
argument|x11
argument_list|,
argument|x15
argument_list|)
name|QUARTERROUND
argument_list|(
argument|x0
argument_list|,
argument|x5
argument_list|,
argument|x10
argument_list|,
argument|x15
argument_list|)
name|QUARTERROUND
argument_list|(
argument|x1
argument_list|,
argument|x6
argument_list|,
argument|x11
argument_list|,
argument|x12
argument_list|)
name|QUARTERROUND
argument_list|(
argument|x2
argument_list|,
argument|x7
argument_list|,
argument|x8
argument_list|,
argument|x13
argument_list|)
name|QUARTERROUND
argument_list|(
argument|x3
argument_list|,
argument|x4
argument_list|,
argument|x9
argument_list|,
argument|x14
argument_list|)
block|}
name|x0
operator|=
name|PLUS
argument_list|(
name|x0
argument_list|,
name|j0
argument_list|)
expr_stmt|;
name|x1
operator|=
name|PLUS
argument_list|(
name|x1
argument_list|,
name|j1
argument_list|)
expr_stmt|;
name|x2
operator|=
name|PLUS
argument_list|(
name|x2
argument_list|,
name|j2
argument_list|)
expr_stmt|;
name|x3
operator|=
name|PLUS
argument_list|(
name|x3
argument_list|,
name|j3
argument_list|)
expr_stmt|;
name|x4
operator|=
name|PLUS
argument_list|(
name|x4
argument_list|,
name|j4
argument_list|)
expr_stmt|;
name|x5
operator|=
name|PLUS
argument_list|(
name|x5
argument_list|,
name|j5
argument_list|)
expr_stmt|;
name|x6
operator|=
name|PLUS
argument_list|(
name|x6
argument_list|,
name|j6
argument_list|)
expr_stmt|;
name|x7
operator|=
name|PLUS
argument_list|(
name|x7
argument_list|,
name|j7
argument_list|)
expr_stmt|;
name|x8
operator|=
name|PLUS
argument_list|(
name|x8
argument_list|,
name|j8
argument_list|)
expr_stmt|;
name|x9
operator|=
name|PLUS
argument_list|(
name|x9
argument_list|,
name|j9
argument_list|)
expr_stmt|;
name|x10
operator|=
name|PLUS
argument_list|(
name|x10
argument_list|,
name|j10
argument_list|)
expr_stmt|;
name|x11
operator|=
name|PLUS
argument_list|(
name|x11
argument_list|,
name|j11
argument_list|)
expr_stmt|;
name|x12
operator|=
name|PLUS
argument_list|(
name|x12
argument_list|,
name|j12
argument_list|)
expr_stmt|;
name|x13
operator|=
name|PLUS
argument_list|(
name|x13
argument_list|,
name|j13
argument_list|)
expr_stmt|;
name|x14
operator|=
name|PLUS
argument_list|(
name|x14
argument_list|,
name|j14
argument_list|)
expr_stmt|;
name|x15
operator|=
name|PLUS
argument_list|(
name|x15
argument_list|,
name|j15
argument_list|)
expr_stmt|;
name|x0
operator|=
name|XOR
argument_list|(
name|x0
argument_list|,
name|U8TO32_LITTLE
argument_list|(
name|m
operator|+
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|x1
operator|=
name|XOR
argument_list|(
name|x1
argument_list|,
name|U8TO32_LITTLE
argument_list|(
name|m
operator|+
literal|4
argument_list|)
argument_list|)
expr_stmt|;
name|x2
operator|=
name|XOR
argument_list|(
name|x2
argument_list|,
name|U8TO32_LITTLE
argument_list|(
name|m
operator|+
literal|8
argument_list|)
argument_list|)
expr_stmt|;
name|x3
operator|=
name|XOR
argument_list|(
name|x3
argument_list|,
name|U8TO32_LITTLE
argument_list|(
name|m
operator|+
literal|12
argument_list|)
argument_list|)
expr_stmt|;
name|x4
operator|=
name|XOR
argument_list|(
name|x4
argument_list|,
name|U8TO32_LITTLE
argument_list|(
name|m
operator|+
literal|16
argument_list|)
argument_list|)
expr_stmt|;
name|x5
operator|=
name|XOR
argument_list|(
name|x5
argument_list|,
name|U8TO32_LITTLE
argument_list|(
name|m
operator|+
literal|20
argument_list|)
argument_list|)
expr_stmt|;
name|x6
operator|=
name|XOR
argument_list|(
name|x6
argument_list|,
name|U8TO32_LITTLE
argument_list|(
name|m
operator|+
literal|24
argument_list|)
argument_list|)
expr_stmt|;
name|x7
operator|=
name|XOR
argument_list|(
name|x7
argument_list|,
name|U8TO32_LITTLE
argument_list|(
name|m
operator|+
literal|28
argument_list|)
argument_list|)
expr_stmt|;
name|x8
operator|=
name|XOR
argument_list|(
name|x8
argument_list|,
name|U8TO32_LITTLE
argument_list|(
name|m
operator|+
literal|32
argument_list|)
argument_list|)
expr_stmt|;
name|x9
operator|=
name|XOR
argument_list|(
name|x9
argument_list|,
name|U8TO32_LITTLE
argument_list|(
name|m
operator|+
literal|36
argument_list|)
argument_list|)
expr_stmt|;
name|x10
operator|=
name|XOR
argument_list|(
name|x10
argument_list|,
name|U8TO32_LITTLE
argument_list|(
name|m
operator|+
literal|40
argument_list|)
argument_list|)
expr_stmt|;
name|x11
operator|=
name|XOR
argument_list|(
name|x11
argument_list|,
name|U8TO32_LITTLE
argument_list|(
name|m
operator|+
literal|44
argument_list|)
argument_list|)
expr_stmt|;
name|x12
operator|=
name|XOR
argument_list|(
name|x12
argument_list|,
name|U8TO32_LITTLE
argument_list|(
name|m
operator|+
literal|48
argument_list|)
argument_list|)
expr_stmt|;
name|x13
operator|=
name|XOR
argument_list|(
name|x13
argument_list|,
name|U8TO32_LITTLE
argument_list|(
name|m
operator|+
literal|52
argument_list|)
argument_list|)
expr_stmt|;
name|x14
operator|=
name|XOR
argument_list|(
name|x14
argument_list|,
name|U8TO32_LITTLE
argument_list|(
name|m
operator|+
literal|56
argument_list|)
argument_list|)
expr_stmt|;
name|x15
operator|=
name|XOR
argument_list|(
name|x15
argument_list|,
name|U8TO32_LITTLE
argument_list|(
name|m
operator|+
literal|60
argument_list|)
argument_list|)
expr_stmt|;
name|j12
operator|=
name|PLUSONE
argument_list|(
name|j12
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|j12
condition|)
block|{
name|j13
operator|=
name|PLUSONE
argument_list|(
name|j13
argument_list|)
expr_stmt|;
comment|/* stopping at 2^70 bytes per nonce is user's responsibility */
block|}
name|U32TO8_LITTLE
argument_list|(
name|c
operator|+
literal|0
argument_list|,
name|x0
argument_list|)
expr_stmt|;
name|U32TO8_LITTLE
argument_list|(
name|c
operator|+
literal|4
argument_list|,
name|x1
argument_list|)
expr_stmt|;
name|U32TO8_LITTLE
argument_list|(
name|c
operator|+
literal|8
argument_list|,
name|x2
argument_list|)
expr_stmt|;
name|U32TO8_LITTLE
argument_list|(
name|c
operator|+
literal|12
argument_list|,
name|x3
argument_list|)
expr_stmt|;
name|U32TO8_LITTLE
argument_list|(
name|c
operator|+
literal|16
argument_list|,
name|x4
argument_list|)
expr_stmt|;
name|U32TO8_LITTLE
argument_list|(
name|c
operator|+
literal|20
argument_list|,
name|x5
argument_list|)
expr_stmt|;
name|U32TO8_LITTLE
argument_list|(
name|c
operator|+
literal|24
argument_list|,
name|x6
argument_list|)
expr_stmt|;
name|U32TO8_LITTLE
argument_list|(
name|c
operator|+
literal|28
argument_list|,
name|x7
argument_list|)
expr_stmt|;
name|U32TO8_LITTLE
argument_list|(
name|c
operator|+
literal|32
argument_list|,
name|x8
argument_list|)
expr_stmt|;
name|U32TO8_LITTLE
argument_list|(
name|c
operator|+
literal|36
argument_list|,
name|x9
argument_list|)
expr_stmt|;
name|U32TO8_LITTLE
argument_list|(
name|c
operator|+
literal|40
argument_list|,
name|x10
argument_list|)
expr_stmt|;
name|U32TO8_LITTLE
argument_list|(
name|c
operator|+
literal|44
argument_list|,
name|x11
argument_list|)
expr_stmt|;
name|U32TO8_LITTLE
argument_list|(
name|c
operator|+
literal|48
argument_list|,
name|x12
argument_list|)
expr_stmt|;
name|U32TO8_LITTLE
argument_list|(
name|c
operator|+
literal|52
argument_list|,
name|x13
argument_list|)
expr_stmt|;
name|U32TO8_LITTLE
argument_list|(
name|c
operator|+
literal|56
argument_list|,
name|x14
argument_list|)
expr_stmt|;
name|U32TO8_LITTLE
argument_list|(
name|c
operator|+
literal|60
argument_list|,
name|x15
argument_list|)
expr_stmt|;
if|if
condition|(
name|bytes
operator|<=
literal|64
condition|)
block|{
if|if
condition|(
name|bytes
operator|<
literal|64
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|bytes
condition|;
operator|++
name|i
control|)
name|ctarget
index|[
name|i
index|]
operator|=
name|c
index|[
name|i
index|]
expr_stmt|;
block|}
name|x
operator|->
name|input
index|[
literal|12
index|]
operator|=
name|j12
expr_stmt|;
name|x
operator|->
name|input
index|[
literal|13
index|]
operator|=
name|j13
expr_stmt|;
return|return;
block|}
name|bytes
operator|-=
literal|64
expr_stmt|;
name|c
operator|+=
literal|64
expr_stmt|;
name|m
operator|+=
literal|64
expr_stmt|;
block|}
block|}
end_function

end_unit


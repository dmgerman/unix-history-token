begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2014 The FreeBSD Foundation  * All rights reserved.  *  * This software was developed by John-Mark Gurney under  * the sponsorship of the FreeBSD Foundation and  * Rubicon Communications, LLC (Netgate).  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1.  Redistributions of source code must retain the above copyright  *     notice, this list of conditions and the following disclaimer.  * 2.  Redistributions in binary form must reproduce the above copyright  *     notice, this list of conditions and the following disclaimer in the  *     documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  *  *	$FreeBSD$  *  */
end_comment

begin_comment
comment|/*  * Figure 5, 8 and 12 are copied from the Intel white paper:  * IntelÂ® Carry-Less Multiplication Instruction and its Usage for  * Computing the GCM Mode  *  * and as such are:  * Copyright Â© 2010 Intel Corporation.  * All rights reserved.  *   * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *   * Redistributions of source code must retain the above copyright  *     notice, this list of conditions and the following disclaimer.  *   * Redistributions in binary form must reproduce the above copyright  *     notice, this list of conditions and the following disclaimer in the  *     documentation and/or other materials provided with the distribution.  *   * Neither the name of Intel Corporation nor the  *     names of its contributors may be used to endorse or promote products  *     derived from this software without specific prior written permission.  *   * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS  * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR  * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT  * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|_KERNEL
end_ifdef

begin_include
include|#
directive|include
file|<crypto/aesni/aesni.h>
end_include

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<stdint.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<wmmintrin.h>
end_include

begin_include
include|#
directive|include
file|<emmintrin.h>
end_include

begin_include
include|#
directive|include
file|<smmintrin.h>
end_include

begin_function
specifier|static
specifier|inline
name|int
name|m128icmp
parameter_list|(
name|__m128i
name|a
parameter_list|,
name|__m128i
name|b
parameter_list|)
block|{
name|__m128i
name|cmp
decl_stmt|;
name|cmp
operator|=
name|_mm_cmpeq_epi32
argument_list|(
name|a
argument_list|,
name|b
argument_list|)
expr_stmt|;
return|return
name|_mm_movemask_epi8
argument_list|(
name|cmp
argument_list|)
operator|==
literal|0xffff
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|__i386__
end_ifdef

begin_function
specifier|static
specifier|inline
name|__m128i
name|_mm_insert_epi64
parameter_list|(
name|__m128i
name|a
parameter_list|,
name|int64_t
name|b
parameter_list|,
specifier|const
name|int
name|ndx
parameter_list|)
block|{
if|if
condition|(
operator|!
name|ndx
condition|)
block|{
name|a
operator|=
name|_mm_insert_epi32
argument_list|(
name|a
argument_list|,
name|b
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|a
operator|=
name|_mm_insert_epi32
argument_list|(
name|a
argument_list|,
name|b
operator|>>
literal|32
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|a
operator|=
name|_mm_insert_epi32
argument_list|(
name|a
argument_list|,
name|b
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|a
operator|=
name|_mm_insert_epi32
argument_list|(
name|a
argument_list|,
name|b
operator|>>
literal|32
argument_list|,
literal|3
argument_list|)
expr_stmt|;
block|}
return|return
name|a
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* some code from carry-less-multiplication-instruction-in-gcm-mode-paper.pdf */
end_comment

begin_comment
comment|/* Figure 5. Code Sample - Performing Ghash Using Algorithms 1 and 5 (C) */
end_comment

begin_function
specifier|static
name|void
name|gfmul
parameter_list|(
name|__m128i
name|a
parameter_list|,
name|__m128i
name|b
parameter_list|,
name|__m128i
modifier|*
name|res
parameter_list|)
block|{
name|__m128i
name|tmp2
decl_stmt|,
name|tmp3
decl_stmt|,
name|tmp4
decl_stmt|,
name|tmp5
decl_stmt|,
name|tmp6
decl_stmt|,
name|tmp7
decl_stmt|,
name|tmp8
decl_stmt|,
name|tmp9
decl_stmt|;
name|tmp3
operator|=
name|_mm_clmulepi64_si128
argument_list|(
name|a
argument_list|,
name|b
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|tmp4
operator|=
name|_mm_clmulepi64_si128
argument_list|(
name|a
argument_list|,
name|b
argument_list|,
literal|0x10
argument_list|)
expr_stmt|;
name|tmp5
operator|=
name|_mm_clmulepi64_si128
argument_list|(
name|a
argument_list|,
name|b
argument_list|,
literal|0x01
argument_list|)
expr_stmt|;
name|tmp6
operator|=
name|_mm_clmulepi64_si128
argument_list|(
name|a
argument_list|,
name|b
argument_list|,
literal|0x11
argument_list|)
expr_stmt|;
name|tmp4
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp4
argument_list|,
name|tmp5
argument_list|)
expr_stmt|;
name|tmp5
operator|=
name|_mm_slli_si128
argument_list|(
name|tmp4
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|tmp4
operator|=
name|_mm_srli_si128
argument_list|(
name|tmp4
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|tmp3
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp3
argument_list|,
name|tmp5
argument_list|)
expr_stmt|;
name|tmp6
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp6
argument_list|,
name|tmp4
argument_list|)
expr_stmt|;
name|tmp7
operator|=
name|_mm_srli_epi32
argument_list|(
name|tmp3
argument_list|,
literal|31
argument_list|)
expr_stmt|;
name|tmp8
operator|=
name|_mm_srli_epi32
argument_list|(
name|tmp6
argument_list|,
literal|31
argument_list|)
expr_stmt|;
name|tmp3
operator|=
name|_mm_slli_epi32
argument_list|(
name|tmp3
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|tmp6
operator|=
name|_mm_slli_epi32
argument_list|(
name|tmp6
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|tmp9
operator|=
name|_mm_srli_si128
argument_list|(
name|tmp7
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|tmp8
operator|=
name|_mm_slli_si128
argument_list|(
name|tmp8
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|tmp7
operator|=
name|_mm_slli_si128
argument_list|(
name|tmp7
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|tmp3
operator|=
name|_mm_or_si128
argument_list|(
name|tmp3
argument_list|,
name|tmp7
argument_list|)
expr_stmt|;
name|tmp6
operator|=
name|_mm_or_si128
argument_list|(
name|tmp6
argument_list|,
name|tmp8
argument_list|)
expr_stmt|;
name|tmp6
operator|=
name|_mm_or_si128
argument_list|(
name|tmp6
argument_list|,
name|tmp9
argument_list|)
expr_stmt|;
name|tmp7
operator|=
name|_mm_slli_epi32
argument_list|(
name|tmp3
argument_list|,
literal|31
argument_list|)
expr_stmt|;
name|tmp8
operator|=
name|_mm_slli_epi32
argument_list|(
name|tmp3
argument_list|,
literal|30
argument_list|)
expr_stmt|;
name|tmp9
operator|=
name|_mm_slli_epi32
argument_list|(
name|tmp3
argument_list|,
literal|25
argument_list|)
expr_stmt|;
name|tmp7
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp7
argument_list|,
name|tmp8
argument_list|)
expr_stmt|;
name|tmp7
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp7
argument_list|,
name|tmp9
argument_list|)
expr_stmt|;
name|tmp8
operator|=
name|_mm_srli_si128
argument_list|(
name|tmp7
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|tmp7
operator|=
name|_mm_slli_si128
argument_list|(
name|tmp7
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|tmp3
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp3
argument_list|,
name|tmp7
argument_list|)
expr_stmt|;
name|tmp2
operator|=
name|_mm_srli_epi32
argument_list|(
name|tmp3
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|tmp4
operator|=
name|_mm_srli_epi32
argument_list|(
name|tmp3
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|tmp5
operator|=
name|_mm_srli_epi32
argument_list|(
name|tmp3
argument_list|,
literal|7
argument_list|)
expr_stmt|;
name|tmp2
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp2
argument_list|,
name|tmp4
argument_list|)
expr_stmt|;
name|tmp2
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp2
argument_list|,
name|tmp5
argument_list|)
expr_stmt|;
name|tmp2
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp2
argument_list|,
name|tmp8
argument_list|)
expr_stmt|;
name|tmp3
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp3
argument_list|,
name|tmp2
argument_list|)
expr_stmt|;
name|tmp6
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp6
argument_list|,
name|tmp3
argument_list|)
expr_stmt|;
operator|*
name|res
operator|=
name|tmp6
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Figure 8. Code Sample - Performing Ghash Using an Aggregated Reduction  * Method */
end_comment

begin_function
specifier|static
name|void
name|reduce4
parameter_list|(
name|__m128i
name|H1
parameter_list|,
name|__m128i
name|H2
parameter_list|,
name|__m128i
name|H3
parameter_list|,
name|__m128i
name|H4
parameter_list|,
name|__m128i
name|X1
parameter_list|,
name|__m128i
name|X2
parameter_list|,
name|__m128i
name|X3
parameter_list|,
name|__m128i
name|X4
parameter_list|,
name|__m128i
modifier|*
name|res
parameter_list|)
block|{
comment|/*algorithm by Krzysztof Jankowski, Pierre Laurent - Intel*/
name|__m128i
name|H1_X1_lo
decl_stmt|,
name|H1_X1_hi
decl_stmt|,
name|H2_X2_lo
decl_stmt|,
name|H2_X2_hi
decl_stmt|,
name|H3_X3_lo
decl_stmt|,
name|H3_X3_hi
decl_stmt|,
name|H4_X4_lo
decl_stmt|,
name|H4_X4_hi
decl_stmt|,
name|lo
decl_stmt|,
name|hi
decl_stmt|;
name|__m128i
name|tmp0
decl_stmt|,
name|tmp1
decl_stmt|,
name|tmp2
decl_stmt|,
name|tmp3
decl_stmt|;
name|__m128i
name|tmp4
decl_stmt|,
name|tmp5
decl_stmt|,
name|tmp6
decl_stmt|,
name|tmp7
decl_stmt|;
name|__m128i
name|tmp8
decl_stmt|,
name|tmp9
decl_stmt|;
name|H1_X1_lo
operator|=
name|_mm_clmulepi64_si128
argument_list|(
name|H1
argument_list|,
name|X1
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|H2_X2_lo
operator|=
name|_mm_clmulepi64_si128
argument_list|(
name|H2
argument_list|,
name|X2
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|H3_X3_lo
operator|=
name|_mm_clmulepi64_si128
argument_list|(
name|H3
argument_list|,
name|X3
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|H4_X4_lo
operator|=
name|_mm_clmulepi64_si128
argument_list|(
name|H4
argument_list|,
name|X4
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|lo
operator|=
name|_mm_xor_si128
argument_list|(
name|H1_X1_lo
argument_list|,
name|H2_X2_lo
argument_list|)
expr_stmt|;
name|lo
operator|=
name|_mm_xor_si128
argument_list|(
name|lo
argument_list|,
name|H3_X3_lo
argument_list|)
expr_stmt|;
name|lo
operator|=
name|_mm_xor_si128
argument_list|(
name|lo
argument_list|,
name|H4_X4_lo
argument_list|)
expr_stmt|;
name|H1_X1_hi
operator|=
name|_mm_clmulepi64_si128
argument_list|(
name|H1
argument_list|,
name|X1
argument_list|,
literal|0x11
argument_list|)
expr_stmt|;
name|H2_X2_hi
operator|=
name|_mm_clmulepi64_si128
argument_list|(
name|H2
argument_list|,
name|X2
argument_list|,
literal|0x11
argument_list|)
expr_stmt|;
name|H3_X3_hi
operator|=
name|_mm_clmulepi64_si128
argument_list|(
name|H3
argument_list|,
name|X3
argument_list|,
literal|0x11
argument_list|)
expr_stmt|;
name|H4_X4_hi
operator|=
name|_mm_clmulepi64_si128
argument_list|(
name|H4
argument_list|,
name|X4
argument_list|,
literal|0x11
argument_list|)
expr_stmt|;
name|hi
operator|=
name|_mm_xor_si128
argument_list|(
name|H1_X1_hi
argument_list|,
name|H2_X2_hi
argument_list|)
expr_stmt|;
name|hi
operator|=
name|_mm_xor_si128
argument_list|(
name|hi
argument_list|,
name|H3_X3_hi
argument_list|)
expr_stmt|;
name|hi
operator|=
name|_mm_xor_si128
argument_list|(
name|hi
argument_list|,
name|H4_X4_hi
argument_list|)
expr_stmt|;
name|tmp0
operator|=
name|_mm_shuffle_epi32
argument_list|(
name|H1
argument_list|,
literal|78
argument_list|)
expr_stmt|;
name|tmp4
operator|=
name|_mm_shuffle_epi32
argument_list|(
name|X1
argument_list|,
literal|78
argument_list|)
expr_stmt|;
name|tmp0
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp0
argument_list|,
name|H1
argument_list|)
expr_stmt|;
name|tmp4
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp4
argument_list|,
name|X1
argument_list|)
expr_stmt|;
name|tmp1
operator|=
name|_mm_shuffle_epi32
argument_list|(
name|H2
argument_list|,
literal|78
argument_list|)
expr_stmt|;
name|tmp5
operator|=
name|_mm_shuffle_epi32
argument_list|(
name|X2
argument_list|,
literal|78
argument_list|)
expr_stmt|;
name|tmp1
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp1
argument_list|,
name|H2
argument_list|)
expr_stmt|;
name|tmp5
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp5
argument_list|,
name|X2
argument_list|)
expr_stmt|;
name|tmp2
operator|=
name|_mm_shuffle_epi32
argument_list|(
name|H3
argument_list|,
literal|78
argument_list|)
expr_stmt|;
name|tmp6
operator|=
name|_mm_shuffle_epi32
argument_list|(
name|X3
argument_list|,
literal|78
argument_list|)
expr_stmt|;
name|tmp2
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp2
argument_list|,
name|H3
argument_list|)
expr_stmt|;
name|tmp6
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp6
argument_list|,
name|X3
argument_list|)
expr_stmt|;
name|tmp3
operator|=
name|_mm_shuffle_epi32
argument_list|(
name|H4
argument_list|,
literal|78
argument_list|)
expr_stmt|;
name|tmp7
operator|=
name|_mm_shuffle_epi32
argument_list|(
name|X4
argument_list|,
literal|78
argument_list|)
expr_stmt|;
name|tmp3
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp3
argument_list|,
name|H4
argument_list|)
expr_stmt|;
name|tmp7
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp7
argument_list|,
name|X4
argument_list|)
expr_stmt|;
name|tmp0
operator|=
name|_mm_clmulepi64_si128
argument_list|(
name|tmp0
argument_list|,
name|tmp4
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|tmp1
operator|=
name|_mm_clmulepi64_si128
argument_list|(
name|tmp1
argument_list|,
name|tmp5
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|tmp2
operator|=
name|_mm_clmulepi64_si128
argument_list|(
name|tmp2
argument_list|,
name|tmp6
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|tmp3
operator|=
name|_mm_clmulepi64_si128
argument_list|(
name|tmp3
argument_list|,
name|tmp7
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|tmp0
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp0
argument_list|,
name|lo
argument_list|)
expr_stmt|;
name|tmp0
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp0
argument_list|,
name|hi
argument_list|)
expr_stmt|;
name|tmp0
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp1
argument_list|,
name|tmp0
argument_list|)
expr_stmt|;
name|tmp0
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp2
argument_list|,
name|tmp0
argument_list|)
expr_stmt|;
name|tmp0
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp3
argument_list|,
name|tmp0
argument_list|)
expr_stmt|;
name|tmp4
operator|=
name|_mm_slli_si128
argument_list|(
name|tmp0
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|tmp0
operator|=
name|_mm_srli_si128
argument_list|(
name|tmp0
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|lo
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp4
argument_list|,
name|lo
argument_list|)
expr_stmt|;
name|hi
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp0
argument_list|,
name|hi
argument_list|)
expr_stmt|;
name|tmp3
operator|=
name|lo
expr_stmt|;
name|tmp6
operator|=
name|hi
expr_stmt|;
name|tmp7
operator|=
name|_mm_srli_epi32
argument_list|(
name|tmp3
argument_list|,
literal|31
argument_list|)
expr_stmt|;
name|tmp8
operator|=
name|_mm_srli_epi32
argument_list|(
name|tmp6
argument_list|,
literal|31
argument_list|)
expr_stmt|;
name|tmp3
operator|=
name|_mm_slli_epi32
argument_list|(
name|tmp3
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|tmp6
operator|=
name|_mm_slli_epi32
argument_list|(
name|tmp6
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|tmp9
operator|=
name|_mm_srli_si128
argument_list|(
name|tmp7
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|tmp8
operator|=
name|_mm_slli_si128
argument_list|(
name|tmp8
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|tmp7
operator|=
name|_mm_slli_si128
argument_list|(
name|tmp7
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|tmp3
operator|=
name|_mm_or_si128
argument_list|(
name|tmp3
argument_list|,
name|tmp7
argument_list|)
expr_stmt|;
name|tmp6
operator|=
name|_mm_or_si128
argument_list|(
name|tmp6
argument_list|,
name|tmp8
argument_list|)
expr_stmt|;
name|tmp6
operator|=
name|_mm_or_si128
argument_list|(
name|tmp6
argument_list|,
name|tmp9
argument_list|)
expr_stmt|;
name|tmp7
operator|=
name|_mm_slli_epi32
argument_list|(
name|tmp3
argument_list|,
literal|31
argument_list|)
expr_stmt|;
name|tmp8
operator|=
name|_mm_slli_epi32
argument_list|(
name|tmp3
argument_list|,
literal|30
argument_list|)
expr_stmt|;
name|tmp9
operator|=
name|_mm_slli_epi32
argument_list|(
name|tmp3
argument_list|,
literal|25
argument_list|)
expr_stmt|;
name|tmp7
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp7
argument_list|,
name|tmp8
argument_list|)
expr_stmt|;
name|tmp7
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp7
argument_list|,
name|tmp9
argument_list|)
expr_stmt|;
name|tmp8
operator|=
name|_mm_srli_si128
argument_list|(
name|tmp7
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|tmp7
operator|=
name|_mm_slli_si128
argument_list|(
name|tmp7
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|tmp3
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp3
argument_list|,
name|tmp7
argument_list|)
expr_stmt|;
name|tmp2
operator|=
name|_mm_srli_epi32
argument_list|(
name|tmp3
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|tmp4
operator|=
name|_mm_srli_epi32
argument_list|(
name|tmp3
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|tmp5
operator|=
name|_mm_srli_epi32
argument_list|(
name|tmp3
argument_list|,
literal|7
argument_list|)
expr_stmt|;
name|tmp2
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp2
argument_list|,
name|tmp4
argument_list|)
expr_stmt|;
name|tmp2
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp2
argument_list|,
name|tmp5
argument_list|)
expr_stmt|;
name|tmp2
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp2
argument_list|,
name|tmp8
argument_list|)
expr_stmt|;
name|tmp3
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp3
argument_list|,
name|tmp2
argument_list|)
expr_stmt|;
name|tmp6
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp6
argument_list|,
name|tmp3
argument_list|)
expr_stmt|;
operator|*
name|res
operator|=
name|tmp6
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Figure 12. AES-GCM: Processing Four Blocks in Parallel with Aggregated  * Every Four Blocks  */
end_comment

begin_comment
comment|/*  * per NIST SP-800-38D, 5.2.1.1, len(p)<= 2^39-256 (in bits), or  * 2^32-256*8*16 bytes.  */
end_comment

begin_function
name|void
name|AES_GCM_encrypt
parameter_list|(
specifier|const
name|unsigned
name|char
modifier|*
name|in
parameter_list|,
name|unsigned
name|char
modifier|*
name|out
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|addt
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|ivec
parameter_list|,
name|unsigned
name|char
modifier|*
name|tag
parameter_list|,
name|uint32_t
name|nbytes
parameter_list|,
name|uint32_t
name|abytes
parameter_list|,
name|int
name|ibytes
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|key
parameter_list|,
name|int
name|nr
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|k
decl_stmt|;
name|__m128i
name|tmp1
decl_stmt|,
name|tmp2
decl_stmt|,
name|tmp3
decl_stmt|,
name|tmp4
decl_stmt|;
name|__m128i
name|tmp5
decl_stmt|,
name|tmp6
decl_stmt|,
name|tmp7
decl_stmt|,
name|tmp8
decl_stmt|;
name|__m128i
name|H
decl_stmt|,
name|H2
decl_stmt|,
name|H3
decl_stmt|,
name|H4
decl_stmt|,
name|Y
decl_stmt|,
name|T
decl_stmt|;
name|__m128i
modifier|*
name|KEY
init|=
operator|(
name|__m128i
operator|*
operator|)
name|key
decl_stmt|;
name|__m128i
name|ctr1
decl_stmt|,
name|ctr2
decl_stmt|,
name|ctr3
decl_stmt|,
name|ctr4
decl_stmt|;
name|__m128i
name|ctr5
decl_stmt|,
name|ctr6
decl_stmt|,
name|ctr7
decl_stmt|,
name|ctr8
decl_stmt|;
name|__m128i
name|last_block
init|=
name|_mm_setzero_si128
argument_list|()
decl_stmt|;
name|__m128i
name|ONE
init|=
name|_mm_set_epi32
argument_list|(
literal|0
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|__m128i
name|EIGHT
init|=
name|_mm_set_epi32
argument_list|(
literal|0
argument_list|,
literal|8
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|__m128i
name|BSWAP_EPI64
init|=
name|_mm_set_epi8
argument_list|(
literal|8
argument_list|,
literal|9
argument_list|,
literal|10
argument_list|,
literal|11
argument_list|,
literal|12
argument_list|,
literal|13
argument_list|,
literal|14
argument_list|,
literal|15
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
literal|3
argument_list|,
literal|4
argument_list|,
literal|5
argument_list|,
literal|6
argument_list|,
literal|7
argument_list|)
decl_stmt|;
name|__m128i
name|BSWAP_MASK
init|=
name|_mm_set_epi8
argument_list|(
literal|0
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
literal|3
argument_list|,
literal|4
argument_list|,
literal|5
argument_list|,
literal|6
argument_list|,
literal|7
argument_list|,
literal|8
argument_list|,
literal|9
argument_list|,
literal|10
argument_list|,
literal|11
argument_list|,
literal|12
argument_list|,
literal|13
argument_list|,
literal|14
argument_list|,
literal|15
argument_list|)
decl_stmt|;
name|__m128i
name|X
init|=
name|_mm_setzero_si128
argument_list|()
decl_stmt|;
if|if
condition|(
name|ibytes
operator|==
literal|96
operator|/
literal|8
condition|)
block|{
name|Y
operator|=
name|_mm_loadu_si128
argument_list|(
operator|(
name|__m128i
operator|*
operator|)
name|ivec
argument_list|)
expr_stmt|;
name|Y
operator|=
name|_mm_insert_epi32
argument_list|(
name|Y
argument_list|,
literal|0x1000000
argument_list|,
literal|3
argument_list|)
expr_stmt|;
comment|/*(Compute E[ZERO, KS] and E[Y0, KS] together*/
name|tmp1
operator|=
name|_mm_xor_si128
argument_list|(
name|X
argument_list|,
name|KEY
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|tmp2
operator|=
name|_mm_xor_si128
argument_list|(
name|Y
argument_list|,
name|KEY
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|1
init|;
name|j
operator|<
name|nr
operator|-
literal|1
condition|;
name|j
operator|+=
literal|2
control|)
block|{
name|tmp1
operator|=
name|_mm_aesenc_si128
argument_list|(
name|tmp1
argument_list|,
name|KEY
index|[
name|j
index|]
argument_list|)
expr_stmt|;
name|tmp2
operator|=
name|_mm_aesenc_si128
argument_list|(
name|tmp2
argument_list|,
name|KEY
index|[
name|j
index|]
argument_list|)
expr_stmt|;
name|tmp1
operator|=
name|_mm_aesenc_si128
argument_list|(
name|tmp1
argument_list|,
name|KEY
index|[
name|j
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
name|tmp2
operator|=
name|_mm_aesenc_si128
argument_list|(
name|tmp2
argument_list|,
name|KEY
index|[
name|j
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
name|tmp1
operator|=
name|_mm_aesenc_si128
argument_list|(
name|tmp1
argument_list|,
name|KEY
index|[
name|nr
operator|-
literal|1
index|]
argument_list|)
expr_stmt|;
name|tmp2
operator|=
name|_mm_aesenc_si128
argument_list|(
name|tmp2
argument_list|,
name|KEY
index|[
name|nr
operator|-
literal|1
index|]
argument_list|)
expr_stmt|;
name|H
operator|=
name|_mm_aesenclast_si128
argument_list|(
name|tmp1
argument_list|,
name|KEY
index|[
name|nr
index|]
argument_list|)
expr_stmt|;
name|T
operator|=
name|_mm_aesenclast_si128
argument_list|(
name|tmp2
argument_list|,
name|KEY
index|[
name|nr
index|]
argument_list|)
expr_stmt|;
name|H
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|H
argument_list|,
name|BSWAP_MASK
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tmp1
operator|=
name|_mm_xor_si128
argument_list|(
name|X
argument_list|,
name|KEY
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|1
init|;
name|j
operator|<
name|nr
condition|;
name|j
operator|++
control|)
name|tmp1
operator|=
name|_mm_aesenc_si128
argument_list|(
name|tmp1
argument_list|,
name|KEY
index|[
name|j
index|]
argument_list|)
expr_stmt|;
name|H
operator|=
name|_mm_aesenclast_si128
argument_list|(
name|tmp1
argument_list|,
name|KEY
index|[
name|nr
index|]
argument_list|)
expr_stmt|;
name|H
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|H
argument_list|,
name|BSWAP_MASK
argument_list|)
expr_stmt|;
name|Y
operator|=
name|_mm_setzero_si128
argument_list|()
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ibytes
operator|/
literal|16
condition|;
name|i
operator|++
control|)
block|{
name|tmp1
operator|=
name|_mm_loadu_si128
argument_list|(
operator|&
operator|(
operator|(
name|__m128i
operator|*
operator|)
name|ivec
operator|)
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|tmp1
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|tmp1
argument_list|,
name|BSWAP_MASK
argument_list|)
expr_stmt|;
name|Y
operator|=
name|_mm_xor_si128
argument_list|(
name|Y
argument_list|,
name|tmp1
argument_list|)
expr_stmt|;
name|gfmul
argument_list|(
name|Y
argument_list|,
name|H
argument_list|,
operator|&
name|Y
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ibytes
operator|%
literal|16
condition|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|ibytes
operator|%
literal|16
condition|;
name|j
operator|++
control|)
operator|(
operator|(
name|unsigned
name|char
operator|*
operator|)
operator|&
name|last_block
operator|)
index|[
name|j
index|]
operator|=
name|ivec
index|[
name|i
operator|*
literal|16
operator|+
name|j
index|]
expr_stmt|;
name|tmp1
operator|=
name|last_block
expr_stmt|;
name|tmp1
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|tmp1
argument_list|,
name|BSWAP_MASK
argument_list|)
expr_stmt|;
name|Y
operator|=
name|_mm_xor_si128
argument_list|(
name|Y
argument_list|,
name|tmp1
argument_list|)
expr_stmt|;
name|gfmul
argument_list|(
name|Y
argument_list|,
name|H
argument_list|,
operator|&
name|Y
argument_list|)
expr_stmt|;
block|}
name|tmp1
operator|=
name|_mm_insert_epi64
argument_list|(
name|tmp1
argument_list|,
operator|(
name|uint64_t
operator|)
name|ibytes
operator|*
literal|8
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|tmp1
operator|=
name|_mm_insert_epi64
argument_list|(
name|tmp1
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|Y
operator|=
name|_mm_xor_si128
argument_list|(
name|Y
argument_list|,
name|tmp1
argument_list|)
expr_stmt|;
name|gfmul
argument_list|(
name|Y
argument_list|,
name|H
argument_list|,
operator|&
name|Y
argument_list|)
expr_stmt|;
name|Y
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|Y
argument_list|,
name|BSWAP_MASK
argument_list|)
expr_stmt|;
comment|/*Compute E(K, Y0)*/
name|tmp1
operator|=
name|_mm_xor_si128
argument_list|(
name|Y
argument_list|,
name|KEY
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|1
init|;
name|j
operator|<
name|nr
condition|;
name|j
operator|++
control|)
name|tmp1
operator|=
name|_mm_aesenc_si128
argument_list|(
name|tmp1
argument_list|,
name|KEY
index|[
name|j
index|]
argument_list|)
expr_stmt|;
name|T
operator|=
name|_mm_aesenclast_si128
argument_list|(
name|tmp1
argument_list|,
name|KEY
index|[
name|nr
index|]
argument_list|)
expr_stmt|;
block|}
name|gfmul
argument_list|(
name|H
argument_list|,
name|H
argument_list|,
operator|&
name|H2
argument_list|)
expr_stmt|;
name|gfmul
argument_list|(
name|H
argument_list|,
name|H2
argument_list|,
operator|&
name|H3
argument_list|)
expr_stmt|;
name|gfmul
argument_list|(
name|H
argument_list|,
name|H3
argument_list|,
operator|&
name|H4
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|abytes
operator|/
literal|16
operator|/
literal|4
condition|;
name|i
operator|++
control|)
block|{
name|tmp1
operator|=
name|_mm_loadu_si128
argument_list|(
operator|&
operator|(
operator|(
name|__m128i
operator|*
operator|)
name|addt
operator|)
index|[
name|i
operator|*
literal|4
index|]
argument_list|)
expr_stmt|;
name|tmp2
operator|=
name|_mm_loadu_si128
argument_list|(
operator|&
operator|(
operator|(
name|__m128i
operator|*
operator|)
name|addt
operator|)
index|[
name|i
operator|*
literal|4
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
name|tmp3
operator|=
name|_mm_loadu_si128
argument_list|(
operator|&
operator|(
operator|(
name|__m128i
operator|*
operator|)
name|addt
operator|)
index|[
name|i
operator|*
literal|4
operator|+
literal|2
index|]
argument_list|)
expr_stmt|;
name|tmp4
operator|=
name|_mm_loadu_si128
argument_list|(
operator|&
operator|(
operator|(
name|__m128i
operator|*
operator|)
name|addt
operator|)
index|[
name|i
operator|*
literal|4
operator|+
literal|3
index|]
argument_list|)
expr_stmt|;
name|tmp1
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|tmp1
argument_list|,
name|BSWAP_MASK
argument_list|)
expr_stmt|;
name|tmp2
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|tmp2
argument_list|,
name|BSWAP_MASK
argument_list|)
expr_stmt|;
name|tmp3
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|tmp3
argument_list|,
name|BSWAP_MASK
argument_list|)
expr_stmt|;
name|tmp4
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|tmp4
argument_list|,
name|BSWAP_MASK
argument_list|)
expr_stmt|;
name|tmp1
operator|=
name|_mm_xor_si128
argument_list|(
name|X
argument_list|,
name|tmp1
argument_list|)
expr_stmt|;
name|reduce4
argument_list|(
name|H
argument_list|,
name|H2
argument_list|,
name|H3
argument_list|,
name|H4
argument_list|,
name|tmp4
argument_list|,
name|tmp3
argument_list|,
name|tmp2
argument_list|,
name|tmp1
argument_list|,
operator|&
name|X
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
name|i
operator|*
literal|4
init|;
name|i
operator|<
name|abytes
operator|/
literal|16
condition|;
name|i
operator|++
control|)
block|{
name|tmp1
operator|=
name|_mm_loadu_si128
argument_list|(
operator|&
operator|(
operator|(
name|__m128i
operator|*
operator|)
name|addt
operator|)
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|tmp1
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|tmp1
argument_list|,
name|BSWAP_MASK
argument_list|)
expr_stmt|;
name|X
operator|=
name|_mm_xor_si128
argument_list|(
name|X
argument_list|,
name|tmp1
argument_list|)
expr_stmt|;
name|gfmul
argument_list|(
name|X
argument_list|,
name|H
argument_list|,
operator|&
name|X
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|abytes
operator|%
literal|16
condition|)
block|{
name|last_block
operator|=
name|_mm_setzero_si128
argument_list|()
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|abytes
operator|%
literal|16
condition|;
name|j
operator|++
control|)
operator|(
operator|(
name|unsigned
name|char
operator|*
operator|)
operator|&
name|last_block
operator|)
index|[
name|j
index|]
operator|=
name|addt
index|[
name|i
operator|*
literal|16
operator|+
name|j
index|]
expr_stmt|;
name|tmp1
operator|=
name|last_block
expr_stmt|;
name|tmp1
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|tmp1
argument_list|,
name|BSWAP_MASK
argument_list|)
expr_stmt|;
name|X
operator|=
name|_mm_xor_si128
argument_list|(
name|X
argument_list|,
name|tmp1
argument_list|)
expr_stmt|;
name|gfmul
argument_list|(
name|X
argument_list|,
name|H
argument_list|,
operator|&
name|X
argument_list|)
expr_stmt|;
block|}
name|ctr1
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|Y
argument_list|,
name|BSWAP_EPI64
argument_list|)
expr_stmt|;
name|ctr1
operator|=
name|_mm_add_epi64
argument_list|(
name|ctr1
argument_list|,
name|ONE
argument_list|)
expr_stmt|;
name|ctr2
operator|=
name|_mm_add_epi64
argument_list|(
name|ctr1
argument_list|,
name|ONE
argument_list|)
expr_stmt|;
name|ctr3
operator|=
name|_mm_add_epi64
argument_list|(
name|ctr2
argument_list|,
name|ONE
argument_list|)
expr_stmt|;
name|ctr4
operator|=
name|_mm_add_epi64
argument_list|(
name|ctr3
argument_list|,
name|ONE
argument_list|)
expr_stmt|;
name|ctr5
operator|=
name|_mm_add_epi64
argument_list|(
name|ctr4
argument_list|,
name|ONE
argument_list|)
expr_stmt|;
name|ctr6
operator|=
name|_mm_add_epi64
argument_list|(
name|ctr5
argument_list|,
name|ONE
argument_list|)
expr_stmt|;
name|ctr7
operator|=
name|_mm_add_epi64
argument_list|(
name|ctr6
argument_list|,
name|ONE
argument_list|)
expr_stmt|;
name|ctr8
operator|=
name|_mm_add_epi64
argument_list|(
name|ctr7
argument_list|,
name|ONE
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nbytes
operator|/
literal|16
operator|/
literal|8
condition|;
name|i
operator|++
control|)
block|{
name|tmp1
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|ctr1
argument_list|,
name|BSWAP_EPI64
argument_list|)
expr_stmt|;
name|tmp2
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|ctr2
argument_list|,
name|BSWAP_EPI64
argument_list|)
expr_stmt|;
name|tmp3
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|ctr3
argument_list|,
name|BSWAP_EPI64
argument_list|)
expr_stmt|;
name|tmp4
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|ctr4
argument_list|,
name|BSWAP_EPI64
argument_list|)
expr_stmt|;
name|tmp5
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|ctr5
argument_list|,
name|BSWAP_EPI64
argument_list|)
expr_stmt|;
name|tmp6
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|ctr6
argument_list|,
name|BSWAP_EPI64
argument_list|)
expr_stmt|;
name|tmp7
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|ctr7
argument_list|,
name|BSWAP_EPI64
argument_list|)
expr_stmt|;
name|tmp8
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|ctr8
argument_list|,
name|BSWAP_EPI64
argument_list|)
expr_stmt|;
name|ctr1
operator|=
name|_mm_add_epi64
argument_list|(
name|ctr1
argument_list|,
name|EIGHT
argument_list|)
expr_stmt|;
name|ctr2
operator|=
name|_mm_add_epi64
argument_list|(
name|ctr2
argument_list|,
name|EIGHT
argument_list|)
expr_stmt|;
name|ctr3
operator|=
name|_mm_add_epi64
argument_list|(
name|ctr3
argument_list|,
name|EIGHT
argument_list|)
expr_stmt|;
name|ctr4
operator|=
name|_mm_add_epi64
argument_list|(
name|ctr4
argument_list|,
name|EIGHT
argument_list|)
expr_stmt|;
name|ctr5
operator|=
name|_mm_add_epi64
argument_list|(
name|ctr5
argument_list|,
name|EIGHT
argument_list|)
expr_stmt|;
name|ctr6
operator|=
name|_mm_add_epi64
argument_list|(
name|ctr6
argument_list|,
name|EIGHT
argument_list|)
expr_stmt|;
name|ctr7
operator|=
name|_mm_add_epi64
argument_list|(
name|ctr7
argument_list|,
name|EIGHT
argument_list|)
expr_stmt|;
name|ctr8
operator|=
name|_mm_add_epi64
argument_list|(
name|ctr8
argument_list|,
name|EIGHT
argument_list|)
expr_stmt|;
name|tmp1
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp1
argument_list|,
name|KEY
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|tmp2
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp2
argument_list|,
name|KEY
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|tmp3
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp3
argument_list|,
name|KEY
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|tmp4
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp4
argument_list|,
name|KEY
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|tmp5
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp5
argument_list|,
name|KEY
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|tmp6
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp6
argument_list|,
name|KEY
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|tmp7
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp7
argument_list|,
name|KEY
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|tmp8
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp8
argument_list|,
name|KEY
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|1
init|;
name|j
operator|<
name|nr
condition|;
name|j
operator|++
control|)
block|{
name|tmp1
operator|=
name|_mm_aesenc_si128
argument_list|(
name|tmp1
argument_list|,
name|KEY
index|[
name|j
index|]
argument_list|)
expr_stmt|;
name|tmp2
operator|=
name|_mm_aesenc_si128
argument_list|(
name|tmp2
argument_list|,
name|KEY
index|[
name|j
index|]
argument_list|)
expr_stmt|;
name|tmp3
operator|=
name|_mm_aesenc_si128
argument_list|(
name|tmp3
argument_list|,
name|KEY
index|[
name|j
index|]
argument_list|)
expr_stmt|;
name|tmp4
operator|=
name|_mm_aesenc_si128
argument_list|(
name|tmp4
argument_list|,
name|KEY
index|[
name|j
index|]
argument_list|)
expr_stmt|;
name|tmp5
operator|=
name|_mm_aesenc_si128
argument_list|(
name|tmp5
argument_list|,
name|KEY
index|[
name|j
index|]
argument_list|)
expr_stmt|;
name|tmp6
operator|=
name|_mm_aesenc_si128
argument_list|(
name|tmp6
argument_list|,
name|KEY
index|[
name|j
index|]
argument_list|)
expr_stmt|;
name|tmp7
operator|=
name|_mm_aesenc_si128
argument_list|(
name|tmp7
argument_list|,
name|KEY
index|[
name|j
index|]
argument_list|)
expr_stmt|;
name|tmp8
operator|=
name|_mm_aesenc_si128
argument_list|(
name|tmp8
argument_list|,
name|KEY
index|[
name|j
index|]
argument_list|)
expr_stmt|;
block|}
name|tmp1
operator|=
name|_mm_aesenclast_si128
argument_list|(
name|tmp1
argument_list|,
name|KEY
index|[
name|nr
index|]
argument_list|)
expr_stmt|;
name|tmp2
operator|=
name|_mm_aesenclast_si128
argument_list|(
name|tmp2
argument_list|,
name|KEY
index|[
name|nr
index|]
argument_list|)
expr_stmt|;
name|tmp3
operator|=
name|_mm_aesenclast_si128
argument_list|(
name|tmp3
argument_list|,
name|KEY
index|[
name|nr
index|]
argument_list|)
expr_stmt|;
name|tmp4
operator|=
name|_mm_aesenclast_si128
argument_list|(
name|tmp4
argument_list|,
name|KEY
index|[
name|nr
index|]
argument_list|)
expr_stmt|;
name|tmp5
operator|=
name|_mm_aesenclast_si128
argument_list|(
name|tmp5
argument_list|,
name|KEY
index|[
name|nr
index|]
argument_list|)
expr_stmt|;
name|tmp6
operator|=
name|_mm_aesenclast_si128
argument_list|(
name|tmp6
argument_list|,
name|KEY
index|[
name|nr
index|]
argument_list|)
expr_stmt|;
name|tmp7
operator|=
name|_mm_aesenclast_si128
argument_list|(
name|tmp7
argument_list|,
name|KEY
index|[
name|nr
index|]
argument_list|)
expr_stmt|;
name|tmp8
operator|=
name|_mm_aesenclast_si128
argument_list|(
name|tmp8
argument_list|,
name|KEY
index|[
name|nr
index|]
argument_list|)
expr_stmt|;
name|tmp1
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp1
argument_list|,
name|_mm_loadu_si128
argument_list|(
operator|&
operator|(
operator|(
name|__m128i
operator|*
operator|)
name|in
operator|)
index|[
name|i
operator|*
literal|8
operator|+
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|tmp2
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp2
argument_list|,
name|_mm_loadu_si128
argument_list|(
operator|&
operator|(
operator|(
name|__m128i
operator|*
operator|)
name|in
operator|)
index|[
name|i
operator|*
literal|8
operator|+
literal|1
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|tmp3
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp3
argument_list|,
name|_mm_loadu_si128
argument_list|(
operator|&
operator|(
operator|(
name|__m128i
operator|*
operator|)
name|in
operator|)
index|[
name|i
operator|*
literal|8
operator|+
literal|2
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|tmp4
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp4
argument_list|,
name|_mm_loadu_si128
argument_list|(
operator|&
operator|(
operator|(
name|__m128i
operator|*
operator|)
name|in
operator|)
index|[
name|i
operator|*
literal|8
operator|+
literal|3
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|tmp5
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp5
argument_list|,
name|_mm_loadu_si128
argument_list|(
operator|&
operator|(
operator|(
name|__m128i
operator|*
operator|)
name|in
operator|)
index|[
name|i
operator|*
literal|8
operator|+
literal|4
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|tmp6
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp6
argument_list|,
name|_mm_loadu_si128
argument_list|(
operator|&
operator|(
operator|(
name|__m128i
operator|*
operator|)
name|in
operator|)
index|[
name|i
operator|*
literal|8
operator|+
literal|5
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|tmp7
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp7
argument_list|,
name|_mm_loadu_si128
argument_list|(
operator|&
operator|(
operator|(
name|__m128i
operator|*
operator|)
name|in
operator|)
index|[
name|i
operator|*
literal|8
operator|+
literal|6
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|tmp8
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp8
argument_list|,
name|_mm_loadu_si128
argument_list|(
operator|&
operator|(
operator|(
name|__m128i
operator|*
operator|)
name|in
operator|)
index|[
name|i
operator|*
literal|8
operator|+
literal|7
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|_mm_storeu_si128
argument_list|(
operator|&
operator|(
operator|(
name|__m128i
operator|*
operator|)
name|out
operator|)
index|[
name|i
operator|*
literal|8
operator|+
literal|0
index|]
argument_list|,
name|tmp1
argument_list|)
expr_stmt|;
name|_mm_storeu_si128
argument_list|(
operator|&
operator|(
operator|(
name|__m128i
operator|*
operator|)
name|out
operator|)
index|[
name|i
operator|*
literal|8
operator|+
literal|1
index|]
argument_list|,
name|tmp2
argument_list|)
expr_stmt|;
name|_mm_storeu_si128
argument_list|(
operator|&
operator|(
operator|(
name|__m128i
operator|*
operator|)
name|out
operator|)
index|[
name|i
operator|*
literal|8
operator|+
literal|2
index|]
argument_list|,
name|tmp3
argument_list|)
expr_stmt|;
name|_mm_storeu_si128
argument_list|(
operator|&
operator|(
operator|(
name|__m128i
operator|*
operator|)
name|out
operator|)
index|[
name|i
operator|*
literal|8
operator|+
literal|3
index|]
argument_list|,
name|tmp4
argument_list|)
expr_stmt|;
name|_mm_storeu_si128
argument_list|(
operator|&
operator|(
operator|(
name|__m128i
operator|*
operator|)
name|out
operator|)
index|[
name|i
operator|*
literal|8
operator|+
literal|4
index|]
argument_list|,
name|tmp5
argument_list|)
expr_stmt|;
name|_mm_storeu_si128
argument_list|(
operator|&
operator|(
operator|(
name|__m128i
operator|*
operator|)
name|out
operator|)
index|[
name|i
operator|*
literal|8
operator|+
literal|5
index|]
argument_list|,
name|tmp6
argument_list|)
expr_stmt|;
name|_mm_storeu_si128
argument_list|(
operator|&
operator|(
operator|(
name|__m128i
operator|*
operator|)
name|out
operator|)
index|[
name|i
operator|*
literal|8
operator|+
literal|6
index|]
argument_list|,
name|tmp7
argument_list|)
expr_stmt|;
name|_mm_storeu_si128
argument_list|(
operator|&
operator|(
operator|(
name|__m128i
operator|*
operator|)
name|out
operator|)
index|[
name|i
operator|*
literal|8
operator|+
literal|7
index|]
argument_list|,
name|tmp8
argument_list|)
expr_stmt|;
name|tmp1
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|tmp1
argument_list|,
name|BSWAP_MASK
argument_list|)
expr_stmt|;
name|tmp2
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|tmp2
argument_list|,
name|BSWAP_MASK
argument_list|)
expr_stmt|;
name|tmp3
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|tmp3
argument_list|,
name|BSWAP_MASK
argument_list|)
expr_stmt|;
name|tmp4
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|tmp4
argument_list|,
name|BSWAP_MASK
argument_list|)
expr_stmt|;
name|tmp5
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|tmp5
argument_list|,
name|BSWAP_MASK
argument_list|)
expr_stmt|;
name|tmp6
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|tmp6
argument_list|,
name|BSWAP_MASK
argument_list|)
expr_stmt|;
name|tmp7
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|tmp7
argument_list|,
name|BSWAP_MASK
argument_list|)
expr_stmt|;
name|tmp8
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|tmp8
argument_list|,
name|BSWAP_MASK
argument_list|)
expr_stmt|;
name|tmp1
operator|=
name|_mm_xor_si128
argument_list|(
name|X
argument_list|,
name|tmp1
argument_list|)
expr_stmt|;
name|reduce4
argument_list|(
name|H
argument_list|,
name|H2
argument_list|,
name|H3
argument_list|,
name|H4
argument_list|,
name|tmp4
argument_list|,
name|tmp3
argument_list|,
name|tmp2
argument_list|,
name|tmp1
argument_list|,
operator|&
name|X
argument_list|)
expr_stmt|;
name|tmp5
operator|=
name|_mm_xor_si128
argument_list|(
name|X
argument_list|,
name|tmp5
argument_list|)
expr_stmt|;
name|reduce4
argument_list|(
name|H
argument_list|,
name|H2
argument_list|,
name|H3
argument_list|,
name|H4
argument_list|,
name|tmp8
argument_list|,
name|tmp7
argument_list|,
name|tmp6
argument_list|,
name|tmp5
argument_list|,
operator|&
name|X
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|k
operator|=
name|i
operator|*
literal|8
init|;
name|k
operator|<
name|nbytes
operator|/
literal|16
condition|;
name|k
operator|++
control|)
block|{
name|tmp1
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|ctr1
argument_list|,
name|BSWAP_EPI64
argument_list|)
expr_stmt|;
name|ctr1
operator|=
name|_mm_add_epi64
argument_list|(
name|ctr1
argument_list|,
name|ONE
argument_list|)
expr_stmt|;
name|tmp1
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp1
argument_list|,
name|KEY
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|1
init|;
name|j
operator|<
name|nr
operator|-
literal|1
condition|;
name|j
operator|+=
literal|2
control|)
block|{
name|tmp1
operator|=
name|_mm_aesenc_si128
argument_list|(
name|tmp1
argument_list|,
name|KEY
index|[
name|j
index|]
argument_list|)
expr_stmt|;
name|tmp1
operator|=
name|_mm_aesenc_si128
argument_list|(
name|tmp1
argument_list|,
name|KEY
index|[
name|j
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
name|tmp1
operator|=
name|_mm_aesenc_si128
argument_list|(
name|tmp1
argument_list|,
name|KEY
index|[
name|nr
operator|-
literal|1
index|]
argument_list|)
expr_stmt|;
name|tmp1
operator|=
name|_mm_aesenclast_si128
argument_list|(
name|tmp1
argument_list|,
name|KEY
index|[
name|nr
index|]
argument_list|)
expr_stmt|;
name|tmp1
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp1
argument_list|,
name|_mm_loadu_si128
argument_list|(
operator|&
operator|(
operator|(
name|__m128i
operator|*
operator|)
name|in
operator|)
index|[
name|k
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|_mm_storeu_si128
argument_list|(
operator|&
operator|(
operator|(
name|__m128i
operator|*
operator|)
name|out
operator|)
index|[
name|k
index|]
argument_list|,
name|tmp1
argument_list|)
expr_stmt|;
name|tmp1
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|tmp1
argument_list|,
name|BSWAP_MASK
argument_list|)
expr_stmt|;
name|X
operator|=
name|_mm_xor_si128
argument_list|(
name|X
argument_list|,
name|tmp1
argument_list|)
expr_stmt|;
name|gfmul
argument_list|(
name|X
argument_list|,
name|H
argument_list|,
operator|&
name|X
argument_list|)
expr_stmt|;
block|}
comment|//If remains one incomplete block
if|if
condition|(
name|nbytes
operator|%
literal|16
condition|)
block|{
name|tmp1
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|ctr1
argument_list|,
name|BSWAP_EPI64
argument_list|)
expr_stmt|;
name|tmp1
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp1
argument_list|,
name|KEY
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|1
init|;
name|j
operator|<
name|nr
operator|-
literal|1
condition|;
name|j
operator|+=
literal|2
control|)
block|{
name|tmp1
operator|=
name|_mm_aesenc_si128
argument_list|(
name|tmp1
argument_list|,
name|KEY
index|[
name|j
index|]
argument_list|)
expr_stmt|;
name|tmp1
operator|=
name|_mm_aesenc_si128
argument_list|(
name|tmp1
argument_list|,
name|KEY
index|[
name|j
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
name|tmp1
operator|=
name|_mm_aesenc_si128
argument_list|(
name|tmp1
argument_list|,
name|KEY
index|[
name|nr
operator|-
literal|1
index|]
argument_list|)
expr_stmt|;
name|tmp1
operator|=
name|_mm_aesenclast_si128
argument_list|(
name|tmp1
argument_list|,
name|KEY
index|[
name|nr
index|]
argument_list|)
expr_stmt|;
name|tmp1
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp1
argument_list|,
name|_mm_loadu_si128
argument_list|(
operator|&
operator|(
operator|(
name|__m128i
operator|*
operator|)
name|in
operator|)
index|[
name|k
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|last_block
operator|=
name|tmp1
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|nbytes
operator|%
literal|16
condition|;
name|j
operator|++
control|)
name|out
index|[
name|k
operator|*
literal|16
operator|+
name|j
index|]
operator|=
operator|(
operator|(
name|unsigned
name|char
operator|*
operator|)
operator|&
name|last_block
operator|)
index|[
name|j
index|]
expr_stmt|;
for|for
control|(
operator|(
name|void
operator|)
name|j
init|;
name|j
operator|<
literal|16
condition|;
name|j
operator|++
control|)
operator|(
operator|(
name|unsigned
name|char
operator|*
operator|)
operator|&
name|last_block
operator|)
index|[
name|j
index|]
operator|=
literal|0
expr_stmt|;
name|tmp1
operator|=
name|last_block
expr_stmt|;
name|tmp1
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|tmp1
argument_list|,
name|BSWAP_MASK
argument_list|)
expr_stmt|;
name|X
operator|=
name|_mm_xor_si128
argument_list|(
name|X
argument_list|,
name|tmp1
argument_list|)
expr_stmt|;
name|gfmul
argument_list|(
name|X
argument_list|,
name|H
argument_list|,
operator|&
name|X
argument_list|)
expr_stmt|;
block|}
name|tmp1
operator|=
name|_mm_insert_epi64
argument_list|(
name|tmp1
argument_list|,
operator|(
name|uint64_t
operator|)
name|nbytes
operator|*
literal|8
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|tmp1
operator|=
name|_mm_insert_epi64
argument_list|(
name|tmp1
argument_list|,
operator|(
name|uint64_t
operator|)
name|abytes
operator|*
literal|8
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|X
operator|=
name|_mm_xor_si128
argument_list|(
name|X
argument_list|,
name|tmp1
argument_list|)
expr_stmt|;
name|gfmul
argument_list|(
name|X
argument_list|,
name|H
argument_list|,
operator|&
name|X
argument_list|)
expr_stmt|;
name|X
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|X
argument_list|,
name|BSWAP_MASK
argument_list|)
expr_stmt|;
name|T
operator|=
name|_mm_xor_si128
argument_list|(
name|X
argument_list|,
name|T
argument_list|)
expr_stmt|;
name|_mm_storeu_si128
argument_list|(
operator|(
name|__m128i
operator|*
operator|)
name|tag
argument_list|,
name|T
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* My modification of _encrypt to be _decrypt */
end_comment

begin_function
name|int
name|AES_GCM_decrypt
parameter_list|(
specifier|const
name|unsigned
name|char
modifier|*
name|in
parameter_list|,
name|unsigned
name|char
modifier|*
name|out
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|addt
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|ivec
parameter_list|,
name|unsigned
name|char
modifier|*
name|tag
parameter_list|,
name|uint32_t
name|nbytes
parameter_list|,
name|uint32_t
name|abytes
parameter_list|,
name|int
name|ibytes
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|key
parameter_list|,
name|int
name|nr
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|k
decl_stmt|;
name|__m128i
name|tmp1
decl_stmt|,
name|tmp2
decl_stmt|,
name|tmp3
decl_stmt|,
name|tmp4
decl_stmt|;
name|__m128i
name|tmp5
decl_stmt|,
name|tmp6
decl_stmt|,
name|tmp7
decl_stmt|,
name|tmp8
decl_stmt|;
name|__m128i
name|H
decl_stmt|,
name|H2
decl_stmt|,
name|H3
decl_stmt|,
name|H4
decl_stmt|,
name|Y
decl_stmt|,
name|T
decl_stmt|;
name|__m128i
modifier|*
name|KEY
init|=
operator|(
name|__m128i
operator|*
operator|)
name|key
decl_stmt|;
name|__m128i
name|ctr1
decl_stmt|,
name|ctr2
decl_stmt|,
name|ctr3
decl_stmt|,
name|ctr4
decl_stmt|;
name|__m128i
name|ctr5
decl_stmt|,
name|ctr6
decl_stmt|,
name|ctr7
decl_stmt|,
name|ctr8
decl_stmt|;
name|__m128i
name|last_block
init|=
name|_mm_setzero_si128
argument_list|()
decl_stmt|;
name|__m128i
name|ONE
init|=
name|_mm_set_epi32
argument_list|(
literal|0
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|__m128i
name|EIGHT
init|=
name|_mm_set_epi32
argument_list|(
literal|0
argument_list|,
literal|8
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|__m128i
name|BSWAP_EPI64
init|=
name|_mm_set_epi8
argument_list|(
literal|8
argument_list|,
literal|9
argument_list|,
literal|10
argument_list|,
literal|11
argument_list|,
literal|12
argument_list|,
literal|13
argument_list|,
literal|14
argument_list|,
literal|15
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
literal|3
argument_list|,
literal|4
argument_list|,
literal|5
argument_list|,
literal|6
argument_list|,
literal|7
argument_list|)
decl_stmt|;
name|__m128i
name|BSWAP_MASK
init|=
name|_mm_set_epi8
argument_list|(
literal|0
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
literal|3
argument_list|,
literal|4
argument_list|,
literal|5
argument_list|,
literal|6
argument_list|,
literal|7
argument_list|,
literal|8
argument_list|,
literal|9
argument_list|,
literal|10
argument_list|,
literal|11
argument_list|,
literal|12
argument_list|,
literal|13
argument_list|,
literal|14
argument_list|,
literal|15
argument_list|)
decl_stmt|;
name|__m128i
name|X
init|=
name|_mm_setzero_si128
argument_list|()
decl_stmt|;
if|if
condition|(
name|ibytes
operator|==
literal|96
operator|/
literal|8
condition|)
block|{
name|Y
operator|=
name|_mm_loadu_si128
argument_list|(
operator|(
name|__m128i
operator|*
operator|)
name|ivec
argument_list|)
expr_stmt|;
name|Y
operator|=
name|_mm_insert_epi32
argument_list|(
name|Y
argument_list|,
literal|0x1000000
argument_list|,
literal|3
argument_list|)
expr_stmt|;
comment|/*(Compute E[ZERO, KS] and E[Y0, KS] together*/
name|tmp1
operator|=
name|_mm_xor_si128
argument_list|(
name|X
argument_list|,
name|KEY
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|tmp2
operator|=
name|_mm_xor_si128
argument_list|(
name|Y
argument_list|,
name|KEY
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|1
init|;
name|j
operator|<
name|nr
operator|-
literal|1
condition|;
name|j
operator|+=
literal|2
control|)
block|{
name|tmp1
operator|=
name|_mm_aesenc_si128
argument_list|(
name|tmp1
argument_list|,
name|KEY
index|[
name|j
index|]
argument_list|)
expr_stmt|;
name|tmp2
operator|=
name|_mm_aesenc_si128
argument_list|(
name|tmp2
argument_list|,
name|KEY
index|[
name|j
index|]
argument_list|)
expr_stmt|;
name|tmp1
operator|=
name|_mm_aesenc_si128
argument_list|(
name|tmp1
argument_list|,
name|KEY
index|[
name|j
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
name|tmp2
operator|=
name|_mm_aesenc_si128
argument_list|(
name|tmp2
argument_list|,
name|KEY
index|[
name|j
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
name|tmp1
operator|=
name|_mm_aesenc_si128
argument_list|(
name|tmp1
argument_list|,
name|KEY
index|[
name|nr
operator|-
literal|1
index|]
argument_list|)
expr_stmt|;
name|tmp2
operator|=
name|_mm_aesenc_si128
argument_list|(
name|tmp2
argument_list|,
name|KEY
index|[
name|nr
operator|-
literal|1
index|]
argument_list|)
expr_stmt|;
name|H
operator|=
name|_mm_aesenclast_si128
argument_list|(
name|tmp1
argument_list|,
name|KEY
index|[
name|nr
index|]
argument_list|)
expr_stmt|;
name|T
operator|=
name|_mm_aesenclast_si128
argument_list|(
name|tmp2
argument_list|,
name|KEY
index|[
name|nr
index|]
argument_list|)
expr_stmt|;
name|H
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|H
argument_list|,
name|BSWAP_MASK
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tmp1
operator|=
name|_mm_xor_si128
argument_list|(
name|X
argument_list|,
name|KEY
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|1
init|;
name|j
operator|<
name|nr
condition|;
name|j
operator|++
control|)
name|tmp1
operator|=
name|_mm_aesenc_si128
argument_list|(
name|tmp1
argument_list|,
name|KEY
index|[
name|j
index|]
argument_list|)
expr_stmt|;
name|H
operator|=
name|_mm_aesenclast_si128
argument_list|(
name|tmp1
argument_list|,
name|KEY
index|[
name|nr
index|]
argument_list|)
expr_stmt|;
name|H
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|H
argument_list|,
name|BSWAP_MASK
argument_list|)
expr_stmt|;
name|Y
operator|=
name|_mm_setzero_si128
argument_list|()
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ibytes
operator|/
literal|16
condition|;
name|i
operator|++
control|)
block|{
name|tmp1
operator|=
name|_mm_loadu_si128
argument_list|(
operator|&
operator|(
operator|(
name|__m128i
operator|*
operator|)
name|ivec
operator|)
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|tmp1
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|tmp1
argument_list|,
name|BSWAP_MASK
argument_list|)
expr_stmt|;
name|Y
operator|=
name|_mm_xor_si128
argument_list|(
name|Y
argument_list|,
name|tmp1
argument_list|)
expr_stmt|;
name|gfmul
argument_list|(
name|Y
argument_list|,
name|H
argument_list|,
operator|&
name|Y
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ibytes
operator|%
literal|16
condition|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|ibytes
operator|%
literal|16
condition|;
name|j
operator|++
control|)
operator|(
operator|(
name|unsigned
name|char
operator|*
operator|)
operator|&
name|last_block
operator|)
index|[
name|j
index|]
operator|=
name|ivec
index|[
name|i
operator|*
literal|16
operator|+
name|j
index|]
expr_stmt|;
name|tmp1
operator|=
name|last_block
expr_stmt|;
name|tmp1
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|tmp1
argument_list|,
name|BSWAP_MASK
argument_list|)
expr_stmt|;
name|Y
operator|=
name|_mm_xor_si128
argument_list|(
name|Y
argument_list|,
name|tmp1
argument_list|)
expr_stmt|;
name|gfmul
argument_list|(
name|Y
argument_list|,
name|H
argument_list|,
operator|&
name|Y
argument_list|)
expr_stmt|;
block|}
name|tmp1
operator|=
name|_mm_insert_epi64
argument_list|(
name|tmp1
argument_list|,
operator|(
name|uint64_t
operator|)
name|ibytes
operator|*
literal|8
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|tmp1
operator|=
name|_mm_insert_epi64
argument_list|(
name|tmp1
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|Y
operator|=
name|_mm_xor_si128
argument_list|(
name|Y
argument_list|,
name|tmp1
argument_list|)
expr_stmt|;
name|gfmul
argument_list|(
name|Y
argument_list|,
name|H
argument_list|,
operator|&
name|Y
argument_list|)
expr_stmt|;
name|Y
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|Y
argument_list|,
name|BSWAP_MASK
argument_list|)
expr_stmt|;
comment|/*Compute E(K, Y0)*/
name|tmp1
operator|=
name|_mm_xor_si128
argument_list|(
name|Y
argument_list|,
name|KEY
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|1
init|;
name|j
operator|<
name|nr
condition|;
name|j
operator|++
control|)
name|tmp1
operator|=
name|_mm_aesenc_si128
argument_list|(
name|tmp1
argument_list|,
name|KEY
index|[
name|j
index|]
argument_list|)
expr_stmt|;
name|T
operator|=
name|_mm_aesenclast_si128
argument_list|(
name|tmp1
argument_list|,
name|KEY
index|[
name|nr
index|]
argument_list|)
expr_stmt|;
block|}
name|gfmul
argument_list|(
name|H
argument_list|,
name|H
argument_list|,
operator|&
name|H2
argument_list|)
expr_stmt|;
name|gfmul
argument_list|(
name|H
argument_list|,
name|H2
argument_list|,
operator|&
name|H3
argument_list|)
expr_stmt|;
name|gfmul
argument_list|(
name|H
argument_list|,
name|H3
argument_list|,
operator|&
name|H4
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|abytes
operator|/
literal|16
operator|/
literal|4
condition|;
name|i
operator|++
control|)
block|{
name|tmp1
operator|=
name|_mm_loadu_si128
argument_list|(
operator|&
operator|(
operator|(
name|__m128i
operator|*
operator|)
name|addt
operator|)
index|[
name|i
operator|*
literal|4
index|]
argument_list|)
expr_stmt|;
name|tmp2
operator|=
name|_mm_loadu_si128
argument_list|(
operator|&
operator|(
operator|(
name|__m128i
operator|*
operator|)
name|addt
operator|)
index|[
name|i
operator|*
literal|4
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
name|tmp3
operator|=
name|_mm_loadu_si128
argument_list|(
operator|&
operator|(
operator|(
name|__m128i
operator|*
operator|)
name|addt
operator|)
index|[
name|i
operator|*
literal|4
operator|+
literal|2
index|]
argument_list|)
expr_stmt|;
name|tmp4
operator|=
name|_mm_loadu_si128
argument_list|(
operator|&
operator|(
operator|(
name|__m128i
operator|*
operator|)
name|addt
operator|)
index|[
name|i
operator|*
literal|4
operator|+
literal|3
index|]
argument_list|)
expr_stmt|;
name|tmp1
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|tmp1
argument_list|,
name|BSWAP_MASK
argument_list|)
expr_stmt|;
name|tmp2
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|tmp2
argument_list|,
name|BSWAP_MASK
argument_list|)
expr_stmt|;
name|tmp3
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|tmp3
argument_list|,
name|BSWAP_MASK
argument_list|)
expr_stmt|;
name|tmp4
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|tmp4
argument_list|,
name|BSWAP_MASK
argument_list|)
expr_stmt|;
name|tmp1
operator|=
name|_mm_xor_si128
argument_list|(
name|X
argument_list|,
name|tmp1
argument_list|)
expr_stmt|;
name|reduce4
argument_list|(
name|H
argument_list|,
name|H2
argument_list|,
name|H3
argument_list|,
name|H4
argument_list|,
name|tmp4
argument_list|,
name|tmp3
argument_list|,
name|tmp2
argument_list|,
name|tmp1
argument_list|,
operator|&
name|X
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
name|i
operator|*
literal|4
init|;
name|i
operator|<
name|abytes
operator|/
literal|16
condition|;
name|i
operator|++
control|)
block|{
name|tmp1
operator|=
name|_mm_loadu_si128
argument_list|(
operator|&
operator|(
operator|(
name|__m128i
operator|*
operator|)
name|addt
operator|)
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|tmp1
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|tmp1
argument_list|,
name|BSWAP_MASK
argument_list|)
expr_stmt|;
name|X
operator|=
name|_mm_xor_si128
argument_list|(
name|X
argument_list|,
name|tmp1
argument_list|)
expr_stmt|;
name|gfmul
argument_list|(
name|X
argument_list|,
name|H
argument_list|,
operator|&
name|X
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|abytes
operator|%
literal|16
condition|)
block|{
name|last_block
operator|=
name|_mm_setzero_si128
argument_list|()
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|abytes
operator|%
literal|16
condition|;
name|j
operator|++
control|)
operator|(
operator|(
name|unsigned
name|char
operator|*
operator|)
operator|&
name|last_block
operator|)
index|[
name|j
index|]
operator|=
name|addt
index|[
name|i
operator|*
literal|16
operator|+
name|j
index|]
expr_stmt|;
name|tmp1
operator|=
name|last_block
expr_stmt|;
name|tmp1
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|tmp1
argument_list|,
name|BSWAP_MASK
argument_list|)
expr_stmt|;
name|X
operator|=
name|_mm_xor_si128
argument_list|(
name|X
argument_list|,
name|tmp1
argument_list|)
expr_stmt|;
name|gfmul
argument_list|(
name|X
argument_list|,
name|H
argument_list|,
operator|&
name|X
argument_list|)
expr_stmt|;
block|}
comment|/* This is where we validate the cipher text before decrypt */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nbytes
operator|/
literal|16
operator|/
literal|4
condition|;
name|i
operator|++
control|)
block|{
name|tmp1
operator|=
name|_mm_loadu_si128
argument_list|(
operator|&
operator|(
operator|(
name|__m128i
operator|*
operator|)
name|in
operator|)
index|[
name|i
operator|*
literal|4
index|]
argument_list|)
expr_stmt|;
name|tmp2
operator|=
name|_mm_loadu_si128
argument_list|(
operator|&
operator|(
operator|(
name|__m128i
operator|*
operator|)
name|in
operator|)
index|[
name|i
operator|*
literal|4
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
name|tmp3
operator|=
name|_mm_loadu_si128
argument_list|(
operator|&
operator|(
operator|(
name|__m128i
operator|*
operator|)
name|in
operator|)
index|[
name|i
operator|*
literal|4
operator|+
literal|2
index|]
argument_list|)
expr_stmt|;
name|tmp4
operator|=
name|_mm_loadu_si128
argument_list|(
operator|&
operator|(
operator|(
name|__m128i
operator|*
operator|)
name|in
operator|)
index|[
name|i
operator|*
literal|4
operator|+
literal|3
index|]
argument_list|)
expr_stmt|;
name|tmp1
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|tmp1
argument_list|,
name|BSWAP_MASK
argument_list|)
expr_stmt|;
name|tmp2
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|tmp2
argument_list|,
name|BSWAP_MASK
argument_list|)
expr_stmt|;
name|tmp3
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|tmp3
argument_list|,
name|BSWAP_MASK
argument_list|)
expr_stmt|;
name|tmp4
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|tmp4
argument_list|,
name|BSWAP_MASK
argument_list|)
expr_stmt|;
name|tmp1
operator|=
name|_mm_xor_si128
argument_list|(
name|X
argument_list|,
name|tmp1
argument_list|)
expr_stmt|;
name|reduce4
argument_list|(
name|H
argument_list|,
name|H2
argument_list|,
name|H3
argument_list|,
name|H4
argument_list|,
name|tmp4
argument_list|,
name|tmp3
argument_list|,
name|tmp2
argument_list|,
name|tmp1
argument_list|,
operator|&
name|X
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
name|i
operator|*
literal|4
init|;
name|i
operator|<
name|nbytes
operator|/
literal|16
condition|;
name|i
operator|++
control|)
block|{
name|tmp1
operator|=
name|_mm_loadu_si128
argument_list|(
operator|&
operator|(
operator|(
name|__m128i
operator|*
operator|)
name|in
operator|)
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|tmp1
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|tmp1
argument_list|,
name|BSWAP_MASK
argument_list|)
expr_stmt|;
name|X
operator|=
name|_mm_xor_si128
argument_list|(
name|X
argument_list|,
name|tmp1
argument_list|)
expr_stmt|;
name|gfmul
argument_list|(
name|X
argument_list|,
name|H
argument_list|,
operator|&
name|X
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|nbytes
operator|%
literal|16
condition|)
block|{
name|last_block
operator|=
name|_mm_setzero_si128
argument_list|()
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|nbytes
operator|%
literal|16
condition|;
name|j
operator|++
control|)
operator|(
operator|(
name|unsigned
name|char
operator|*
operator|)
operator|&
name|last_block
operator|)
index|[
name|j
index|]
operator|=
name|in
index|[
name|i
operator|*
literal|16
operator|+
name|j
index|]
expr_stmt|;
name|tmp1
operator|=
name|last_block
expr_stmt|;
name|tmp1
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|tmp1
argument_list|,
name|BSWAP_MASK
argument_list|)
expr_stmt|;
name|X
operator|=
name|_mm_xor_si128
argument_list|(
name|X
argument_list|,
name|tmp1
argument_list|)
expr_stmt|;
name|gfmul
argument_list|(
name|X
argument_list|,
name|H
argument_list|,
operator|&
name|X
argument_list|)
expr_stmt|;
block|}
name|tmp1
operator|=
name|_mm_insert_epi64
argument_list|(
name|tmp1
argument_list|,
operator|(
name|uint64_t
operator|)
name|nbytes
operator|*
literal|8
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|tmp1
operator|=
name|_mm_insert_epi64
argument_list|(
name|tmp1
argument_list|,
operator|(
name|uint64_t
operator|)
name|abytes
operator|*
literal|8
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|X
operator|=
name|_mm_xor_si128
argument_list|(
name|X
argument_list|,
name|tmp1
argument_list|)
expr_stmt|;
name|gfmul
argument_list|(
name|X
argument_list|,
name|H
argument_list|,
operator|&
name|X
argument_list|)
expr_stmt|;
name|X
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|X
argument_list|,
name|BSWAP_MASK
argument_list|)
expr_stmt|;
name|T
operator|=
name|_mm_xor_si128
argument_list|(
name|X
argument_list|,
name|T
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|m128icmp
argument_list|(
name|T
argument_list|,
name|_mm_loadu_si128
argument_list|(
operator|(
name|__m128i
operator|*
operator|)
name|tag
argument_list|)
argument_list|)
condition|)
return|return
literal|0
return|;
comment|//in case the authentication failed
name|ctr1
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|Y
argument_list|,
name|BSWAP_EPI64
argument_list|)
expr_stmt|;
name|ctr1
operator|=
name|_mm_add_epi64
argument_list|(
name|ctr1
argument_list|,
name|ONE
argument_list|)
expr_stmt|;
name|ctr2
operator|=
name|_mm_add_epi64
argument_list|(
name|ctr1
argument_list|,
name|ONE
argument_list|)
expr_stmt|;
name|ctr3
operator|=
name|_mm_add_epi64
argument_list|(
name|ctr2
argument_list|,
name|ONE
argument_list|)
expr_stmt|;
name|ctr4
operator|=
name|_mm_add_epi64
argument_list|(
name|ctr3
argument_list|,
name|ONE
argument_list|)
expr_stmt|;
name|ctr5
operator|=
name|_mm_add_epi64
argument_list|(
name|ctr4
argument_list|,
name|ONE
argument_list|)
expr_stmt|;
name|ctr6
operator|=
name|_mm_add_epi64
argument_list|(
name|ctr5
argument_list|,
name|ONE
argument_list|)
expr_stmt|;
name|ctr7
operator|=
name|_mm_add_epi64
argument_list|(
name|ctr6
argument_list|,
name|ONE
argument_list|)
expr_stmt|;
name|ctr8
operator|=
name|_mm_add_epi64
argument_list|(
name|ctr7
argument_list|,
name|ONE
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nbytes
operator|/
literal|16
operator|/
literal|8
condition|;
name|i
operator|++
control|)
block|{
name|tmp1
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|ctr1
argument_list|,
name|BSWAP_EPI64
argument_list|)
expr_stmt|;
name|tmp2
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|ctr2
argument_list|,
name|BSWAP_EPI64
argument_list|)
expr_stmt|;
name|tmp3
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|ctr3
argument_list|,
name|BSWAP_EPI64
argument_list|)
expr_stmt|;
name|tmp4
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|ctr4
argument_list|,
name|BSWAP_EPI64
argument_list|)
expr_stmt|;
name|tmp5
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|ctr5
argument_list|,
name|BSWAP_EPI64
argument_list|)
expr_stmt|;
name|tmp6
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|ctr6
argument_list|,
name|BSWAP_EPI64
argument_list|)
expr_stmt|;
name|tmp7
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|ctr7
argument_list|,
name|BSWAP_EPI64
argument_list|)
expr_stmt|;
name|tmp8
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|ctr8
argument_list|,
name|BSWAP_EPI64
argument_list|)
expr_stmt|;
name|ctr1
operator|=
name|_mm_add_epi64
argument_list|(
name|ctr1
argument_list|,
name|EIGHT
argument_list|)
expr_stmt|;
name|ctr2
operator|=
name|_mm_add_epi64
argument_list|(
name|ctr2
argument_list|,
name|EIGHT
argument_list|)
expr_stmt|;
name|ctr3
operator|=
name|_mm_add_epi64
argument_list|(
name|ctr3
argument_list|,
name|EIGHT
argument_list|)
expr_stmt|;
name|ctr4
operator|=
name|_mm_add_epi64
argument_list|(
name|ctr4
argument_list|,
name|EIGHT
argument_list|)
expr_stmt|;
name|ctr5
operator|=
name|_mm_add_epi64
argument_list|(
name|ctr5
argument_list|,
name|EIGHT
argument_list|)
expr_stmt|;
name|ctr6
operator|=
name|_mm_add_epi64
argument_list|(
name|ctr6
argument_list|,
name|EIGHT
argument_list|)
expr_stmt|;
name|ctr7
operator|=
name|_mm_add_epi64
argument_list|(
name|ctr7
argument_list|,
name|EIGHT
argument_list|)
expr_stmt|;
name|ctr8
operator|=
name|_mm_add_epi64
argument_list|(
name|ctr8
argument_list|,
name|EIGHT
argument_list|)
expr_stmt|;
name|tmp1
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp1
argument_list|,
name|KEY
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|tmp2
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp2
argument_list|,
name|KEY
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|tmp3
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp3
argument_list|,
name|KEY
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|tmp4
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp4
argument_list|,
name|KEY
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|tmp5
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp5
argument_list|,
name|KEY
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|tmp6
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp6
argument_list|,
name|KEY
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|tmp7
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp7
argument_list|,
name|KEY
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|tmp8
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp8
argument_list|,
name|KEY
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|1
init|;
name|j
operator|<
name|nr
condition|;
name|j
operator|++
control|)
block|{
name|tmp1
operator|=
name|_mm_aesenc_si128
argument_list|(
name|tmp1
argument_list|,
name|KEY
index|[
name|j
index|]
argument_list|)
expr_stmt|;
name|tmp2
operator|=
name|_mm_aesenc_si128
argument_list|(
name|tmp2
argument_list|,
name|KEY
index|[
name|j
index|]
argument_list|)
expr_stmt|;
name|tmp3
operator|=
name|_mm_aesenc_si128
argument_list|(
name|tmp3
argument_list|,
name|KEY
index|[
name|j
index|]
argument_list|)
expr_stmt|;
name|tmp4
operator|=
name|_mm_aesenc_si128
argument_list|(
name|tmp4
argument_list|,
name|KEY
index|[
name|j
index|]
argument_list|)
expr_stmt|;
name|tmp5
operator|=
name|_mm_aesenc_si128
argument_list|(
name|tmp5
argument_list|,
name|KEY
index|[
name|j
index|]
argument_list|)
expr_stmt|;
name|tmp6
operator|=
name|_mm_aesenc_si128
argument_list|(
name|tmp6
argument_list|,
name|KEY
index|[
name|j
index|]
argument_list|)
expr_stmt|;
name|tmp7
operator|=
name|_mm_aesenc_si128
argument_list|(
name|tmp7
argument_list|,
name|KEY
index|[
name|j
index|]
argument_list|)
expr_stmt|;
name|tmp8
operator|=
name|_mm_aesenc_si128
argument_list|(
name|tmp8
argument_list|,
name|KEY
index|[
name|j
index|]
argument_list|)
expr_stmt|;
block|}
name|tmp1
operator|=
name|_mm_aesenclast_si128
argument_list|(
name|tmp1
argument_list|,
name|KEY
index|[
name|nr
index|]
argument_list|)
expr_stmt|;
name|tmp2
operator|=
name|_mm_aesenclast_si128
argument_list|(
name|tmp2
argument_list|,
name|KEY
index|[
name|nr
index|]
argument_list|)
expr_stmt|;
name|tmp3
operator|=
name|_mm_aesenclast_si128
argument_list|(
name|tmp3
argument_list|,
name|KEY
index|[
name|nr
index|]
argument_list|)
expr_stmt|;
name|tmp4
operator|=
name|_mm_aesenclast_si128
argument_list|(
name|tmp4
argument_list|,
name|KEY
index|[
name|nr
index|]
argument_list|)
expr_stmt|;
name|tmp5
operator|=
name|_mm_aesenclast_si128
argument_list|(
name|tmp5
argument_list|,
name|KEY
index|[
name|nr
index|]
argument_list|)
expr_stmt|;
name|tmp6
operator|=
name|_mm_aesenclast_si128
argument_list|(
name|tmp6
argument_list|,
name|KEY
index|[
name|nr
index|]
argument_list|)
expr_stmt|;
name|tmp7
operator|=
name|_mm_aesenclast_si128
argument_list|(
name|tmp7
argument_list|,
name|KEY
index|[
name|nr
index|]
argument_list|)
expr_stmt|;
name|tmp8
operator|=
name|_mm_aesenclast_si128
argument_list|(
name|tmp8
argument_list|,
name|KEY
index|[
name|nr
index|]
argument_list|)
expr_stmt|;
name|tmp1
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp1
argument_list|,
name|_mm_loadu_si128
argument_list|(
operator|&
operator|(
operator|(
name|__m128i
operator|*
operator|)
name|in
operator|)
index|[
name|i
operator|*
literal|8
operator|+
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|tmp2
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp2
argument_list|,
name|_mm_loadu_si128
argument_list|(
operator|&
operator|(
operator|(
name|__m128i
operator|*
operator|)
name|in
operator|)
index|[
name|i
operator|*
literal|8
operator|+
literal|1
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|tmp3
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp3
argument_list|,
name|_mm_loadu_si128
argument_list|(
operator|&
operator|(
operator|(
name|__m128i
operator|*
operator|)
name|in
operator|)
index|[
name|i
operator|*
literal|8
operator|+
literal|2
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|tmp4
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp4
argument_list|,
name|_mm_loadu_si128
argument_list|(
operator|&
operator|(
operator|(
name|__m128i
operator|*
operator|)
name|in
operator|)
index|[
name|i
operator|*
literal|8
operator|+
literal|3
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|tmp5
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp5
argument_list|,
name|_mm_loadu_si128
argument_list|(
operator|&
operator|(
operator|(
name|__m128i
operator|*
operator|)
name|in
operator|)
index|[
name|i
operator|*
literal|8
operator|+
literal|4
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|tmp6
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp6
argument_list|,
name|_mm_loadu_si128
argument_list|(
operator|&
operator|(
operator|(
name|__m128i
operator|*
operator|)
name|in
operator|)
index|[
name|i
operator|*
literal|8
operator|+
literal|5
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|tmp7
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp7
argument_list|,
name|_mm_loadu_si128
argument_list|(
operator|&
operator|(
operator|(
name|__m128i
operator|*
operator|)
name|in
operator|)
index|[
name|i
operator|*
literal|8
operator|+
literal|6
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|tmp8
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp8
argument_list|,
name|_mm_loadu_si128
argument_list|(
operator|&
operator|(
operator|(
name|__m128i
operator|*
operator|)
name|in
operator|)
index|[
name|i
operator|*
literal|8
operator|+
literal|7
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|_mm_storeu_si128
argument_list|(
operator|&
operator|(
operator|(
name|__m128i
operator|*
operator|)
name|out
operator|)
index|[
name|i
operator|*
literal|8
operator|+
literal|0
index|]
argument_list|,
name|tmp1
argument_list|)
expr_stmt|;
name|_mm_storeu_si128
argument_list|(
operator|&
operator|(
operator|(
name|__m128i
operator|*
operator|)
name|out
operator|)
index|[
name|i
operator|*
literal|8
operator|+
literal|1
index|]
argument_list|,
name|tmp2
argument_list|)
expr_stmt|;
name|_mm_storeu_si128
argument_list|(
operator|&
operator|(
operator|(
name|__m128i
operator|*
operator|)
name|out
operator|)
index|[
name|i
operator|*
literal|8
operator|+
literal|2
index|]
argument_list|,
name|tmp3
argument_list|)
expr_stmt|;
name|_mm_storeu_si128
argument_list|(
operator|&
operator|(
operator|(
name|__m128i
operator|*
operator|)
name|out
operator|)
index|[
name|i
operator|*
literal|8
operator|+
literal|3
index|]
argument_list|,
name|tmp4
argument_list|)
expr_stmt|;
name|_mm_storeu_si128
argument_list|(
operator|&
operator|(
operator|(
name|__m128i
operator|*
operator|)
name|out
operator|)
index|[
name|i
operator|*
literal|8
operator|+
literal|4
index|]
argument_list|,
name|tmp5
argument_list|)
expr_stmt|;
name|_mm_storeu_si128
argument_list|(
operator|&
operator|(
operator|(
name|__m128i
operator|*
operator|)
name|out
operator|)
index|[
name|i
operator|*
literal|8
operator|+
literal|5
index|]
argument_list|,
name|tmp6
argument_list|)
expr_stmt|;
name|_mm_storeu_si128
argument_list|(
operator|&
operator|(
operator|(
name|__m128i
operator|*
operator|)
name|out
operator|)
index|[
name|i
operator|*
literal|8
operator|+
literal|6
index|]
argument_list|,
name|tmp7
argument_list|)
expr_stmt|;
name|_mm_storeu_si128
argument_list|(
operator|&
operator|(
operator|(
name|__m128i
operator|*
operator|)
name|out
operator|)
index|[
name|i
operator|*
literal|8
operator|+
literal|7
index|]
argument_list|,
name|tmp8
argument_list|)
expr_stmt|;
name|tmp1
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|tmp1
argument_list|,
name|BSWAP_MASK
argument_list|)
expr_stmt|;
name|tmp2
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|tmp2
argument_list|,
name|BSWAP_MASK
argument_list|)
expr_stmt|;
name|tmp3
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|tmp3
argument_list|,
name|BSWAP_MASK
argument_list|)
expr_stmt|;
name|tmp4
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|tmp4
argument_list|,
name|BSWAP_MASK
argument_list|)
expr_stmt|;
name|tmp5
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|tmp5
argument_list|,
name|BSWAP_MASK
argument_list|)
expr_stmt|;
name|tmp6
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|tmp6
argument_list|,
name|BSWAP_MASK
argument_list|)
expr_stmt|;
name|tmp7
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|tmp7
argument_list|,
name|BSWAP_MASK
argument_list|)
expr_stmt|;
name|tmp8
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|tmp8
argument_list|,
name|BSWAP_MASK
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|k
operator|=
name|i
operator|*
literal|8
init|;
name|k
operator|<
name|nbytes
operator|/
literal|16
condition|;
name|k
operator|++
control|)
block|{
name|tmp1
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|ctr1
argument_list|,
name|BSWAP_EPI64
argument_list|)
expr_stmt|;
name|ctr1
operator|=
name|_mm_add_epi64
argument_list|(
name|ctr1
argument_list|,
name|ONE
argument_list|)
expr_stmt|;
name|tmp1
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp1
argument_list|,
name|KEY
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|1
init|;
name|j
operator|<
name|nr
operator|-
literal|1
condition|;
name|j
operator|+=
literal|2
control|)
block|{
name|tmp1
operator|=
name|_mm_aesenc_si128
argument_list|(
name|tmp1
argument_list|,
name|KEY
index|[
name|j
index|]
argument_list|)
expr_stmt|;
name|tmp1
operator|=
name|_mm_aesenc_si128
argument_list|(
name|tmp1
argument_list|,
name|KEY
index|[
name|j
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
name|tmp1
operator|=
name|_mm_aesenc_si128
argument_list|(
name|tmp1
argument_list|,
name|KEY
index|[
name|nr
operator|-
literal|1
index|]
argument_list|)
expr_stmt|;
name|tmp1
operator|=
name|_mm_aesenclast_si128
argument_list|(
name|tmp1
argument_list|,
name|KEY
index|[
name|nr
index|]
argument_list|)
expr_stmt|;
name|tmp1
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp1
argument_list|,
name|_mm_loadu_si128
argument_list|(
operator|&
operator|(
operator|(
name|__m128i
operator|*
operator|)
name|in
operator|)
index|[
name|k
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|_mm_storeu_si128
argument_list|(
operator|&
operator|(
operator|(
name|__m128i
operator|*
operator|)
name|out
operator|)
index|[
name|k
index|]
argument_list|,
name|tmp1
argument_list|)
expr_stmt|;
block|}
comment|//If remains one incomplete block
if|if
condition|(
name|nbytes
operator|%
literal|16
condition|)
block|{
name|tmp1
operator|=
name|_mm_shuffle_epi8
argument_list|(
name|ctr1
argument_list|,
name|BSWAP_EPI64
argument_list|)
expr_stmt|;
name|tmp1
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp1
argument_list|,
name|KEY
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|1
init|;
name|j
operator|<
name|nr
operator|-
literal|1
condition|;
name|j
operator|+=
literal|2
control|)
block|{
name|tmp1
operator|=
name|_mm_aesenc_si128
argument_list|(
name|tmp1
argument_list|,
name|KEY
index|[
name|j
index|]
argument_list|)
expr_stmt|;
name|tmp1
operator|=
name|_mm_aesenc_si128
argument_list|(
name|tmp1
argument_list|,
name|KEY
index|[
name|j
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
name|tmp1
operator|=
name|_mm_aesenc_si128
argument_list|(
name|tmp1
argument_list|,
name|KEY
index|[
name|nr
operator|-
literal|1
index|]
argument_list|)
expr_stmt|;
name|tmp1
operator|=
name|_mm_aesenclast_si128
argument_list|(
name|tmp1
argument_list|,
name|KEY
index|[
name|nr
index|]
argument_list|)
expr_stmt|;
name|tmp1
operator|=
name|_mm_xor_si128
argument_list|(
name|tmp1
argument_list|,
name|_mm_loadu_si128
argument_list|(
operator|&
operator|(
operator|(
name|__m128i
operator|*
operator|)
name|in
operator|)
index|[
name|k
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|last_block
operator|=
name|tmp1
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|nbytes
operator|%
literal|16
condition|;
name|j
operator|++
control|)
name|out
index|[
name|k
operator|*
literal|16
operator|+
name|j
index|]
operator|=
operator|(
operator|(
name|unsigned
name|char
operator|*
operator|)
operator|&
name|last_block
operator|)
index|[
name|j
index|]
expr_stmt|;
block|}
return|return
literal|1
return|;
comment|//when sucessfull returns 1
block|}
end_function

end_unit


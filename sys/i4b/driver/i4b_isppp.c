begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  *   Copyright (c) 1997 Joerg Wunsch. All rights reserved.  *  *   Copyright (c) 1997, 2000 Hellmuth Michaelis. All rights reserved.  *  *   Redistribution and use in source and binary forms, with or without  *   modification, are permitted provided that the following conditions  *   are met:  *  *   1. Redistributions of source code must retain the above copyright  *      notice, this list of conditions and the following disclaimer.  *   2. Redistributions in binary form must reproduce the above copyright  *      notice, this list of conditions and the following disclaimer in the  *      documentation and/or other materials provided with the distribution.  *     *   THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  *   ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  *   IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  *   ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  *   FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  *   DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  *   OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  *   HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  *   LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  *   OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  *   SUCH DAMAGE.  *  *---------------------------------------------------------------------------  *  *	i4b_isppp.c - isdn4bsd kernel SyncPPP driver  *	--------------------------------------------  *  * 	Uses Serge Vakulenko's sppp backend (originally contributed with  *	the "cx" driver for Cronyx's HDLC-in-hardware device).  This driver  *	is only the glue between sppp and i4b.  *  *	$Id: i4b_isppp.c,v 1.44 2000/08/31 07:07:26 hm Exp $  *  * $FreeBSD$  *  *	last edit-date: [Thu Aug 31 09:02:27 2000]  *  *---------------------------------------------------------------------------*/
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|__NetBSD__
end_ifndef

begin_define
define|#
directive|define
name|USE_ISPPP
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"i4bisppp.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|USE_ISPPP
end_ifndef

begin_ifndef
ifndef|#
directive|ifndef
name|__NetBSD__
end_ifndef

begin_if
if|#
directive|if
name|NI4BISPPP
operator|==
literal|0
end_if

begin_error
error|#
directive|error
literal|"You need to define `device sppp<N>' with options ISPPP"
end_error

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/errno.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioccom.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_types.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_systm.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip.h>
end_include

begin_include
include|#
directive|include
file|<net/slcompress.h>
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__FreeBSD__
argument_list|)
operator|||
name|defined
argument_list|(
name|__OpenBSD__
argument_list|)
end_if

begin_ifndef
ifndef|#
directive|ifndef
name|USE_ISPPP
end_ifndef

begin_include
include|#
directive|include
file|<net/if_sppp.h>
end_include

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<machine/i4b_isppp.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* USE_ISPPP */
end_comment

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<net/if_sppp.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__FreeBSD_version
argument_list|)
operator|&&
name|__FreeBSD_version
operator|>=
literal|400008
end_if

begin_include
include|#
directive|include
file|"bpf.h"
end_include

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|"bpfilter.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|NBPFILTER
operator|>
literal|0
operator|||
name|NBPF
operator|>
literal|0
end_if

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<net/bpf.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|__FreeBSD__
end_ifdef

begin_include
include|#
directive|include
file|<machine/i4b_ioctl.h>
end_include

begin_include
include|#
directive|include
file|<machine/i4b_debug.h>
end_include

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<i4b/i4b_ioctl.h>
end_include

begin_include
include|#
directive|include
file|<i4b/i4b_cause.h>
end_include

begin_include
include|#
directive|include
file|<i4b/i4b_debug.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<i4b/include/i4b_global.h>
end_include

begin_include
include|#
directive|include
file|<i4b/include/i4b_l3l4.h>
end_include

begin_include
include|#
directive|include
file|<i4b/layer4/i4b_l4.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|__FreeBSD__
end_ifdef

begin_define
define|#
directive|define
name|ISPPP_FMT
value|"isp%d: "
end_define

begin_define
define|#
directive|define
name|ISPPP_ARG
parameter_list|(
name|sc
parameter_list|)
value|((sc)->sc_if.if_unit)
end_define

begin_define
define|#
directive|define
name|PDEVSTATIC
value|static
end_define

begin_define
define|#
directive|define
name|IFP2UNIT
parameter_list|(
name|ifp
parameter_list|)
value|(ifp)->if_unit
end_define

begin_if
if|#
directive|if
name|__FreeBSD_version
operator|>=
literal|300001
end_if

begin_define
define|#
directive|define
name|CALLOUT_INIT
parameter_list|(
name|chan
parameter_list|)
value|callout_handle_init(chan)
end_define

begin_define
define|#
directive|define
name|TIMEOUT
parameter_list|(
name|fun
parameter_list|,
name|arg
parameter_list|,
name|chan
parameter_list|,
name|tick
parameter_list|)
value|chan = timeout(fun, arg, tick)
end_define

begin_define
define|#
directive|define
name|UNTIMEOUT
parameter_list|(
name|fun
parameter_list|,
name|arg
parameter_list|,
name|chan
parameter_list|)
value|untimeout(fun, arg, chan)
end_define

begin_define
define|#
directive|define
name|IOCTL_CMD_T
value|u_long
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|CALLOUT_INIT
parameter_list|(
name|chan
parameter_list|)
value|do {} while(0)
end_define

begin_define
define|#
directive|define
name|TIMEOUT
parameter_list|(
name|fun
parameter_list|,
name|arg
parameter_list|,
name|chan
parameter_list|,
name|tick
parameter_list|)
value|timeout(fun, arg, tick)
end_define

begin_define
define|#
directive|define
name|UNTIMEOUT
parameter_list|(
name|fun
parameter_list|,
name|arg
parameter_list|,
name|chan
parameter_list|)
value|untimeout(fun, arg)
end_define

begin_define
define|#
directive|define
name|IOCTL_CMD_T
value|int
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_elif
elif|#
directive|elif
name|defined
name|__NetBSD__
operator|||
name|defined
name|__OpenBSD__
end_elif

begin_define
define|#
directive|define
name|ISPPP_FMT
value|"%s: "
end_define

begin_define
define|#
directive|define
name|ISPPP_ARG
parameter_list|(
name|sc
parameter_list|)
value|((sc)->sc_if.if_xname)
end_define

begin_define
define|#
directive|define
name|PDEVSTATIC
end_define

begin_comment
comment|/* not static */
end_comment

begin_define
define|#
directive|define
name|IOCTL_CMD_T
value|u_long
end_define

begin_define
define|#
directive|define
name|IFP2UNIT
parameter_list|(
name|ifp
parameter_list|)
value|((struct i4bisppp_softc *)ifp->if_softc)->sc_unit
end_define

begin_else
else|#
directive|else
end_else

begin_error
error|#
directive|error
literal|"What system are you using?"
end_error

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|__FreeBSD__
end_ifdef

begin_function_decl
name|PDEVSTATIC
name|void
name|i4bispppattach
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_expr_stmt
name|PSEUDO_SET
argument_list|(
name|i4bispppattach
argument_list|,
name|i4b_isppp
argument_list|)
expr_stmt|;
end_expr_stmt

begin_else
else|#
directive|else
end_else

begin_function_decl
name|PDEVSTATIC
name|void
name|i4bispppattach
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|I4BISPPPACCT
value|1
end_define

begin_comment
comment|/* enable accounting messages */
end_comment

begin_define
define|#
directive|define
name|I4BISPPPACCTINTVL
value|2
end_define

begin_comment
comment|/* accounting msg interval in secs */
end_comment

begin_define
define|#
directive|define
name|I4BISPPPDISCDEBUG
value|1
end_define

begin_define
define|#
directive|define
name|PPP_HDRLEN
value|4
end_define

begin_comment
comment|/* 4 octetts PPP header length	*/
end_comment

begin_struct
struct|struct
name|i4bisppp_softc
block|{
comment|/* 	 * struct sppp starts with a struct ifnet, but we gotta allocate 	 * more space for it.  NB: do not relocate this union, it must 	 * be first in isppp_softc.  The tls and tlf hooks below want to 	 * convert a ``struct sppp *'' into a ``struct isppp_softc *''. 	 */
union|union
block|{
name|struct
name|ifnet
name|scu_if
decl_stmt|;
name|struct
name|sppp
name|scu_sp
decl_stmt|;
block|}
name|sc_if_un
union|;
define|#
directive|define
name|sc_if
value|sc_if_un.scu_if
name|int
name|sc_state
decl_stmt|;
comment|/* state of the interface	*/
ifndef|#
directive|ifndef
name|__FreeBSD__
name|int
name|sc_unit
decl_stmt|;
comment|/* unit number for Net/OpenBSD	*/
endif|#
directive|endif
name|call_desc_t
modifier|*
name|sc_cdp
decl_stmt|;
comment|/* ptr to call descriptor	*/
ifdef|#
directive|ifdef
name|I4BISPPPACCT
name|int
name|sc_iinb
decl_stmt|;
comment|/* isdn driver # of inbytes	*/
name|int
name|sc_ioutb
decl_stmt|;
comment|/* isdn driver # of outbytes	*/
name|int
name|sc_inb
decl_stmt|;
comment|/* # of bytes rx'd		*/
name|int
name|sc_outb
decl_stmt|;
comment|/* # of bytes tx'd	 	*/
name|int
name|sc_linb
decl_stmt|;
comment|/* last # of bytes rx'd		*/
name|int
name|sc_loutb
decl_stmt|;
comment|/* last # of bytes tx'd 	*/
name|int
name|sc_fn
decl_stmt|;
comment|/* flag, first null acct	*/
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|__FreeBSD_version
argument_list|)
operator|&&
name|__FreeBSD_version
operator|>=
literal|300001
name|struct
name|callout_handle
name|sc_ch
decl_stmt|;
endif|#
directive|endif
block|}
name|i4bisppp_softc
index|[
name|NI4BISPPP
index|]
struct|;
end_struct

begin_function_decl
specifier|static
name|void
name|i4bisppp_init_linktab
parameter_list|(
name|int
name|unit
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|i4bisppp_ioctl
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|IOCTL_CMD_T
name|cmd
parameter_list|,
name|caddr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_if
if|#
directive|if
literal|0
end_if

begin_endif
unit|static void	i4bisppp_send(struct ifnet *ifp);
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|void
name|i4bisppp_start
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
function_decl|;
end_function_decl

begin_if
if|#
directive|if
literal|0
end_if

begin_comment
comment|/* never used ??? */
end_comment

begin_endif
unit|static void	i4bisppp_timeout(void *cookie);
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|void
name|i4bisppp_tls
parameter_list|(
name|struct
name|sppp
modifier|*
name|sp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|i4bisppp_tlf
parameter_list|(
name|struct
name|sppp
modifier|*
name|sp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|i4bisppp_state_changed
parameter_list|(
name|struct
name|sppp
modifier|*
name|sp
parameter_list|,
name|int
name|new_state
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|i4bisppp_negotiation_complete
parameter_list|(
name|struct
name|sppp
modifier|*
name|sp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|i4bisppp_watchdog
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|time_t
name|i4bisppp_idletime
parameter_list|(
name|int
name|unit
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* initialized by L4 */
end_comment

begin_decl_stmt
specifier|static
name|drvr_link_t
name|i4bisppp_drvr_linktab
index|[
name|NI4BISPPP
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isdn_link_t
modifier|*
name|isdn_linktab
index|[
name|NI4BISPPP
index|]
decl_stmt|;
end_decl_stmt

begin_enum
enum|enum
name|i4bisppp_states
block|{
name|ST_IDLE
block|,
comment|/* initialized, ready, idle	*/
name|ST_DIALING
block|,
comment|/* dialling out to remote	*/
name|ST_CONNECTED
block|,
comment|/* connected to remote		*/
block|}
enum|;
end_enum

begin_comment
comment|/*===========================================================================*  *			DEVICE DRIVER ROUTINES  *===========================================================================*/
end_comment

begin_comment
comment|/*---------------------------------------------------------------------------*  *	interface attach routine at kernel boot time  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|PDEVSTATIC
name|void
ifdef|#
directive|ifdef
name|__FreeBSD__
name|i4bispppattach
parameter_list|(
name|void
modifier|*
name|dummy
parameter_list|)
else|#
directive|else
function|i4bispppattach
parameter_list|()
endif|#
directive|endif
block|{
name|struct
name|i4bisppp_softc
modifier|*
name|sc
init|=
name|i4bisppp_softc
decl_stmt|;
name|int
name|i
decl_stmt|;
ifndef|#
directive|ifndef
name|HACK_NO_PSEUDO_ATTACH_MSG
ifdef|#
directive|ifdef
name|SPPP_VJ
name|printf
argument_list|(
literal|"i4bisppp: %d ISDN SyncPPP device(s) attached (VJ header compression)\n"
argument_list|,
name|NI4BISPPP
argument_list|)
expr_stmt|;
else|#
directive|else
name|printf
argument_list|(
literal|"i4bisppp: %d ISDN SyncPPP device(s) attached\n"
argument_list|,
name|NI4BISPPP
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|#
directive|endif
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NI4BISPPP
condition|;
name|sc
operator|++
operator|,
name|i
operator|++
control|)
block|{
name|i4bisppp_init_linktab
argument_list|(
name|i
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_if
operator|.
name|if_softc
operator|=
name|sc
expr_stmt|;
ifdef|#
directive|ifdef
name|__FreeBSD__
name|sc
operator|->
name|sc_if
operator|.
name|if_name
operator|=
literal|"isp"
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|__FreeBSD_version
argument_list|)
operator|&&
name|__FreeBSD_version
operator|<
literal|300001
name|sc
operator|->
name|sc_if
operator|.
name|if_next
operator|=
name|NULL
expr_stmt|;
endif|#
directive|endif
name|sc
operator|->
name|sc_if
operator|.
name|if_unit
operator|=
name|i
expr_stmt|;
else|#
directive|else
name|sprintf
argument_list|(
name|sc
operator|->
name|sc_if
operator|.
name|if_xname
argument_list|,
literal|"isp%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_unit
operator|=
name|i
expr_stmt|;
endif|#
directive|endif
name|sc
operator|->
name|sc_if
operator|.
name|if_mtu
operator|=
name|PP_MTU
expr_stmt|;
ifdef|#
directive|ifdef
name|__NetBSD__
name|sc
operator|->
name|sc_if
operator|.
name|if_flags
operator|=
name|IFF_SIMPLEX
operator||
name|IFF_POINTOPOINT
operator||
name|IFF_MULTICAST
expr_stmt|;
else|#
directive|else
name|sc
operator|->
name|sc_if
operator|.
name|if_flags
operator|=
name|IFF_SIMPLEX
operator||
name|IFF_POINTOPOINT
expr_stmt|;
endif|#
directive|endif
name|sc
operator|->
name|sc_if
operator|.
name|if_type
operator|=
name|IFT_ISDNBASIC
expr_stmt|;
name|sc
operator|->
name|sc_state
operator|=
name|ST_IDLE
expr_stmt|;
name|sc
operator|->
name|sc_if
operator|.
name|if_ioctl
operator|=
name|i4bisppp_ioctl
expr_stmt|;
comment|/* actually initialized by sppp_attach() */
comment|/* sc->sc_if.if_output = sppp_output; */
name|sc
operator|->
name|sc_if
operator|.
name|if_start
operator|=
name|i4bisppp_start
expr_stmt|;
name|sc
operator|->
name|sc_if
operator|.
name|if_hdrlen
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_if
operator|.
name|if_addrlen
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_if
operator|.
name|if_snd
operator|.
name|ifq_maxlen
operator|=
name|IFQ_MAXLEN
expr_stmt|;
name|sc
operator|->
name|sc_if
operator|.
name|if_ipackets
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_if
operator|.
name|if_ierrors
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_if
operator|.
name|if_opackets
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_if
operator|.
name|if_oerrors
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_if
operator|.
name|if_collisions
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_if
operator|.
name|if_ibytes
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_if
operator|.
name|if_obytes
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_if
operator|.
name|if_imcasts
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_if
operator|.
name|if_omcasts
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_if
operator|.
name|if_iqdrops
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_if
operator|.
name|if_noproto
operator|=
literal|0
expr_stmt|;
if|#
directive|if
name|I4BISPPPACCT
name|sc
operator|->
name|sc_if
operator|.
name|if_timer
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_if
operator|.
name|if_watchdog
operator|=
name|i4bisppp_watchdog
expr_stmt|;
name|sc
operator|->
name|sc_iinb
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_ioutb
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_inb
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_outb
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_linb
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_loutb
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_fn
operator|=
literal|1
expr_stmt|;
endif|#
directive|endif
name|sc
operator|->
name|sc_if_un
operator|.
name|scu_sp
operator|.
name|pp_tls
operator|=
name|i4bisppp_tls
expr_stmt|;
name|sc
operator|->
name|sc_if_un
operator|.
name|scu_sp
operator|.
name|pp_tlf
operator|=
name|i4bisppp_tlf
expr_stmt|;
name|sc
operator|->
name|sc_if_un
operator|.
name|scu_sp
operator|.
name|pp_con
operator|=
name|i4bisppp_negotiation_complete
expr_stmt|;
name|sc
operator|->
name|sc_if_un
operator|.
name|scu_sp
operator|.
name|pp_chg
operator|=
name|i4bisppp_state_changed
expr_stmt|;
ifndef|#
directive|ifndef
name|USE_ISPPP
name|sppp_attach
argument_list|(
operator|&
name|sc
operator|->
name|sc_if
argument_list|)
expr_stmt|;
else|#
directive|else
name|isppp_attach
argument_list|(
operator|&
name|sc
operator|->
name|sc_if
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|__FreeBSD_version
argument_list|)
operator|&&
operator|(
operator|(
name|__FreeBSD_version
operator|>=
literal|500009
operator|)
operator|||
operator|(
literal|410000
operator|<=
name|__FreeBSD_version
operator|&&
name|__FreeBSD_version
operator|<
literal|500000
operator|)
operator|)
comment|/* do not call bpfattach in ether_ifattach */
name|ether_ifattach
argument_list|(
operator|&
name|sc
operator|->
name|sc_if
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|#
directive|else
name|if_attach
argument_list|(
operator|&
name|sc
operator|->
name|sc_if
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|#
directive|if
name|NBPFILTER
operator|>
literal|0
operator|||
name|NBPF
operator|>
literal|0
ifdef|#
directive|ifdef
name|__FreeBSD__
name|bpfattach
argument_list|(
operator|&
name|sc
operator|->
name|sc_if
argument_list|,
name|DLT_PPP
argument_list|,
name|PPP_HDRLEN
argument_list|)
expr_stmt|;
name|CALLOUT_INIT
argument_list|(
operator|&
name|sc
operator|->
name|sc_ch
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* __FreeBSD__ */
ifdef|#
directive|ifdef
name|__NetBSD__
name|bpfattach
argument_list|(
operator|&
name|sc
operator|->
name|sc_if
operator|.
name|if_bpf
argument_list|,
operator|&
name|sc
operator|->
name|sc_if
argument_list|,
name|DLT_PPP
argument_list|,
sizeof|sizeof
argument_list|(
name|u_int
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|#
directive|endif
block|}
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	process ioctl  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|int
name|i4bisppp_ioctl
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|IOCTL_CMD_T
name|cmd
parameter_list|,
name|caddr_t
name|data
parameter_list|)
block|{
name|struct
name|i4bisppp_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
if|#
directive|if
literal|0
block|struct sppp *sp = (struct sppp *)sc; 	struct ifaddr *ifa = (struct ifaddr *) data; 	struct ifreq *ifr = (struct ifreq *) data;
endif|#
directive|endif
name|int
name|error
decl_stmt|;
ifndef|#
directive|ifndef
name|USE_ISPPP
name|error
operator|=
name|sppp_ioctl
argument_list|(
operator|&
name|sc
operator|->
name|sc_if
argument_list|,
name|cmd
argument_list|,
name|data
argument_list|)
expr_stmt|;
else|#
directive|else
name|error
operator|=
name|isppp_ioctl
argument_list|(
operator|&
name|sc
operator|->
name|sc_if
argument_list|,
name|cmd
argument_list|,
name|data
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|SIOCSIFFLAGS
case|:
if|#
directive|if
literal|0
comment|/* never used ??? */
block|x = splimp(); 		if ((ifp->if_flags& IFF_UP) == 0) 			UNTIMEOUT(i4bisppp_timeout, (void *)sp, sc->sc_ch); 		splx(x);
endif|#
directive|endif
break|break;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	start output to ISDN B-channel  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|i4bisppp_start
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|struct
name|i4bisppp_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
comment|/* int s; */
name|int
name|unit
init|=
name|IFP2UNIT
argument_list|(
name|ifp
argument_list|)
decl_stmt|;
ifndef|#
directive|ifndef
name|USE_ISPPP
if|if
condition|(
name|sppp_isempty
argument_list|(
name|ifp
argument_list|)
condition|)
else|#
directive|else
if|if
condition|(
name|isppp_isempty
argument_list|(
name|ifp
argument_list|)
condition|)
endif|#
directive|endif
return|return;
if|if
condition|(
name|sc
operator|->
name|sc_state
operator|!=
name|ST_CONNECTED
condition|)
return|return;
comment|/* 	 * s = splimp(); 	 * ifp->if_flags |= IFF_OACTIVE; // - need to clear this somewhere 	 * splx(s); 	 */
ifndef|#
directive|ifndef
name|USE_ISPPP
while|while
condition|(
operator|(
name|m
operator|=
name|sppp_dequeue
argument_list|(
operator|&
name|sc
operator|->
name|sc_if
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
else|#
directive|else
while|while
condition|(
operator|(
name|m
operator|=
name|isppp_dequeue
argument_list|(
operator|&
name|sc
operator|->
name|sc_if
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
endif|#
directive|endif
block|{
if|#
directive|if
name|NBPFILTER
operator|>
literal|0
operator|||
name|NBPF
operator|>
literal|0
ifdef|#
directive|ifdef
name|__FreeBSD__
if|if
condition|(
name|ifp
operator|->
name|if_bpf
condition|)
name|bpf_mtap
argument_list|(
name|ifp
argument_list|,
name|m
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* __FreeBSD__ */
ifdef|#
directive|ifdef
name|__NetBSD__
if|if
condition|(
name|ifp
operator|->
name|if_bpf
condition|)
name|bpf_mtap
argument_list|(
name|ifp
operator|->
name|if_bpf
argument_list|,
name|m
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|#
directive|endif
comment|/* NBPFILTER> 0 || NBPF> 0 */
name|microtime
argument_list|(
operator|&
name|ifp
operator|->
name|if_lastchange
argument_list|)
expr_stmt|;
name|IF_LOCK
argument_list|(
name|isdn_linktab
index|[
name|unit
index|]
operator|->
name|tx_queue
argument_list|)
expr_stmt|;
if|if
condition|(
name|_IF_QFULL
argument_list|(
name|isdn_linktab
index|[
name|unit
index|]
operator|->
name|tx_queue
argument_list|)
condition|)
block|{
name|NDBGL4
argument_list|(
name|L4_ISPDBG
argument_list|,
literal|"isp%d, tx queue full!"
argument_list|,
name|unit
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|#
directive|if
literal|0
block|sc->sc_if.if_obytes += m->m_pkthdr.len;
endif|#
directive|endif
name|sc
operator|->
name|sc_outb
operator|+=
name|m
operator|->
name|m_pkthdr
operator|.
name|len
expr_stmt|;
name|sc
operator|->
name|sc_if
operator|.
name|if_opackets
operator|++
expr_stmt|;
name|_IF_ENQUEUE
argument_list|(
name|isdn_linktab
index|[
name|unit
index|]
operator|->
name|tx_queue
argument_list|,
name|m
argument_list|)
expr_stmt|;
block|}
name|IF_UNLOCK
argument_list|(
name|isdn_linktab
index|[
name|unit
index|]
operator|->
name|tx_queue
argument_list|)
expr_stmt|;
block|}
name|isdn_linktab
index|[
name|unit
index|]
operator|->
name|bch_tx_start
argument_list|(
name|isdn_linktab
index|[
name|unit
index|]
operator|->
name|unit
argument_list|,
name|isdn_linktab
index|[
name|unit
index|]
operator|->
name|channel
argument_list|)
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|I4BISPPPACCT
end_ifdef

begin_comment
comment|/*---------------------------------------------------------------------------*  *	watchdog routine  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|i4bisppp_watchdog
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|struct
name|i4bisppp_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|int
name|unit
init|=
name|IFP2UNIT
argument_list|(
name|ifp
argument_list|)
decl_stmt|;
name|bchan_statistics_t
name|bs
decl_stmt|;
operator|(
operator|*
name|isdn_linktab
index|[
name|unit
index|]
operator|->
name|bch_stat
operator|)
operator|(
name|isdn_linktab
index|[
name|unit
index|]
operator|->
name|unit
operator|,
name|isdn_linktab
index|[
name|unit
index|]
operator|->
name|channel
operator|,
operator|&
name|bs
operator|)
expr_stmt|;
name|sc
operator|->
name|sc_ioutb
operator|+=
name|bs
operator|.
name|outbytes
expr_stmt|;
name|sc
operator|->
name|sc_iinb
operator|+=
name|bs
operator|.
name|inbytes
expr_stmt|;
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_iinb
operator|!=
name|sc
operator|->
name|sc_linb
operator|)
operator|||
operator|(
name|sc
operator|->
name|sc_ioutb
operator|!=
name|sc
operator|->
name|sc_loutb
operator|)
operator|||
name|sc
operator|->
name|sc_fn
condition|)
block|{
name|int
name|ri
init|=
operator|(
name|sc
operator|->
name|sc_iinb
operator|-
name|sc
operator|->
name|sc_linb
operator|)
operator|/
name|I4BISPPPACCTINTVL
decl_stmt|;
name|int
name|ro
init|=
operator|(
name|sc
operator|->
name|sc_ioutb
operator|-
name|sc
operator|->
name|sc_loutb
operator|)
operator|/
name|I4BISPPPACCTINTVL
decl_stmt|;
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_iinb
operator|==
name|sc
operator|->
name|sc_linb
operator|)
operator|&&
operator|(
name|sc
operator|->
name|sc_ioutb
operator|==
name|sc
operator|->
name|sc_loutb
operator|)
condition|)
name|sc
operator|->
name|sc_fn
operator|=
literal|0
expr_stmt|;
else|else
name|sc
operator|->
name|sc_fn
operator|=
literal|1
expr_stmt|;
name|sc
operator|->
name|sc_linb
operator|=
name|sc
operator|->
name|sc_iinb
expr_stmt|;
name|sc
operator|->
name|sc_loutb
operator|=
name|sc
operator|->
name|sc_ioutb
expr_stmt|;
name|i4b_l4_accounting
argument_list|(
name|BDRV_ISPPP
argument_list|,
name|unit
argument_list|,
name|ACCT_DURING
argument_list|,
name|sc
operator|->
name|sc_ioutb
argument_list|,
name|sc
operator|->
name|sc_iinb
argument_list|,
name|ro
argument_list|,
name|ri
argument_list|,
name|sc
operator|->
name|sc_outb
argument_list|,
name|sc
operator|->
name|sc_inb
argument_list|)
expr_stmt|;
block|}
name|sc
operator|->
name|sc_if
operator|.
name|if_timer
operator|=
name|I4BISPPPACCTINTVL
expr_stmt|;
if|#
directive|if
literal|0
comment|/* old stuff, keep it around */
block|printf(ISPPP_FMT "transmit timeout\n", ISPPP_ARG(sc)); 	i4bisppp_start(ifp);
endif|#
directive|endif
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* I4BISPPPACCT */
end_comment

begin_comment
comment|/*  *===========================================================================*  *			SyncPPP layer interface routines  *===========================================================================*  */
end_comment

begin_if
if|#
directive|if
literal|0
end_if

begin_comment
comment|/* never used ??? */
end_comment

begin_comment
comment|/*---------------------------------------------------------------------------*  *	just an alias for i4bisppp_tls, but of type timeout_t  *---------------------------------------------------------------------------*/
end_comment

begin_endif
unit|static void i4bisppp_timeout(void *cookie) { 	i4bisppp_tls((struct sppp *)cookie); }
endif|#
directive|endif
end_endif

begin_comment
comment|/*---------------------------------------------------------------------------*  *	PPP this-layer-started action  *---------------------------------------------------------------------------*  */
end_comment

begin_function
specifier|static
name|void
name|i4bisppp_tls
parameter_list|(
name|struct
name|sppp
modifier|*
name|sp
parameter_list|)
block|{
name|struct
name|i4bisppp_softc
modifier|*
name|sc
init|=
operator|(
expr|struct
name|i4bisppp_softc
operator|*
operator|)
name|sp
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
operator|(
expr|struct
name|ifnet
operator|*
operator|)
name|sp
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_state
operator|==
name|ST_CONNECTED
condition|)
return|return;
name|i4b_l4_dialout
argument_list|(
name|BDRV_ISPPP
argument_list|,
name|IFP2UNIT
argument_list|(
name|ifp
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	PPP this-layer-finished action  *---------------------------------------------------------------------------*  */
end_comment

begin_function
specifier|static
name|void
name|i4bisppp_tlf
parameter_list|(
name|struct
name|sppp
modifier|*
name|sp
parameter_list|)
block|{
name|struct
name|i4bisppp_softc
modifier|*
name|sc
init|=
operator|(
expr|struct
name|i4bisppp_softc
operator|*
operator|)
name|sp
decl_stmt|;
comment|/*	call_desc_t *cd = sc->sc_cdp;	*/
name|struct
name|ifnet
modifier|*
name|ifp
init|=
operator|(
expr|struct
name|ifnet
operator|*
operator|)
name|sp
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_state
operator|!=
name|ST_CONNECTED
condition|)
return|return;
if|#
directive|if
literal|0
comment|/* never used ??? */
block|UNTIMEOUT(i4bisppp_timeout, (void *)sp, sc->sc_ch);
endif|#
directive|endif
name|i4b_l4_drvrdisc
argument_list|(
name|BDRV_ISPPP
argument_list|,
name|IFP2UNIT
argument_list|(
name|ifp
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	PPP interface phase change  *---------------------------------------------------------------------------*  */
end_comment

begin_function
specifier|static
name|void
name|i4bisppp_state_changed
parameter_list|(
name|struct
name|sppp
modifier|*
name|sp
parameter_list|,
name|int
name|new_state
parameter_list|)
block|{
name|struct
name|i4bisppp_softc
modifier|*
name|sc
init|=
operator|(
expr|struct
name|i4bisppp_softc
operator|*
operator|)
name|sp
decl_stmt|;
name|i4b_l4_ifstate_changed
argument_list|(
name|sc
operator|->
name|sc_cdp
argument_list|,
name|new_state
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	PPP control protocol negotiation complete (run ip-up script now)  *---------------------------------------------------------------------------*  */
end_comment

begin_function
specifier|static
name|void
name|i4bisppp_negotiation_complete
parameter_list|(
name|struct
name|sppp
modifier|*
name|sp
parameter_list|)
block|{
name|struct
name|i4bisppp_softc
modifier|*
name|sc
init|=
operator|(
expr|struct
name|i4bisppp_softc
operator|*
operator|)
name|sp
decl_stmt|;
name|i4b_l4_negcomplete
argument_list|(
name|sc
operator|->
name|sc_cdp
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*===========================================================================*  *			ISDN INTERFACE ROUTINES  *===========================================================================*/
end_comment

begin_comment
comment|/*---------------------------------------------------------------------------*  *	this routine is called from L4 handler at connect time  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|i4bisppp_connect
parameter_list|(
name|int
name|unit
parameter_list|,
name|void
modifier|*
name|cdp
parameter_list|)
block|{
name|struct
name|i4bisppp_softc
modifier|*
name|sc
init|=
operator|&
name|i4bisppp_softc
index|[
name|unit
index|]
decl_stmt|;
name|struct
name|sppp
modifier|*
name|sp
init|=
operator|&
name|sc
operator|->
name|sc_if_un
operator|.
name|scu_sp
decl_stmt|;
name|int
name|s
init|=
name|splimp
argument_list|()
decl_stmt|;
name|sc
operator|->
name|sc_cdp
operator|=
operator|(
name|call_desc_t
operator|*
operator|)
name|cdp
expr_stmt|;
name|sc
operator|->
name|sc_state
operator|=
name|ST_CONNECTED
expr_stmt|;
if|#
directive|if
name|I4BISPPPACCT
name|sc
operator|->
name|sc_iinb
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_ioutb
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_inb
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_outb
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_linb
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_loutb
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_if
operator|.
name|if_timer
operator|=
name|I4BISPPPACCTINTVL
expr_stmt|;
endif|#
directive|endif
if|#
directive|if
literal|0
comment|/* never used ??? */
block|UNTIMEOUT(i4bisppp_timeout, (void *)sp, sc->sc_ch);
endif|#
directive|endif
name|sp
operator|->
name|pp_up
argument_list|(
name|sp
argument_list|)
expr_stmt|;
comment|/* tell PPP we are ready */
ifndef|#
directive|ifndef
name|__NetBSD__
name|sp
operator|->
name|pp_last_sent
operator|=
name|sp
operator|->
name|pp_last_recv
operator|=
name|SECOND
expr_stmt|;
endif|#
directive|endif
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	this routine is called from L4 handler at disconnect time  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|i4bisppp_disconnect
parameter_list|(
name|int
name|unit
parameter_list|,
name|void
modifier|*
name|cdp
parameter_list|)
block|{
name|call_desc_t
modifier|*
name|cd
init|=
operator|(
name|call_desc_t
operator|*
operator|)
name|cdp
decl_stmt|;
name|struct
name|i4bisppp_softc
modifier|*
name|sc
init|=
operator|&
name|i4bisppp_softc
index|[
name|unit
index|]
decl_stmt|;
name|struct
name|sppp
modifier|*
name|sp
init|=
operator|&
name|sc
operator|->
name|sc_if_un
operator|.
name|scu_sp
decl_stmt|;
name|int
name|s
init|=
name|splimp
argument_list|()
decl_stmt|;
comment|/* new stuff to check that the active channel is being closed */
if|if
condition|(
name|cd
operator|!=
name|sc
operator|->
name|sc_cdp
condition|)
block|{
name|NDBGL4
argument_list|(
name|L4_ISPDBG
argument_list|,
literal|"isp%d, channel%d not active!"
argument_list|,
name|unit
argument_list|,
name|cd
operator|->
name|channelid
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return;
block|}
if|#
directive|if
name|I4BISPPPACCT
name|sc
operator|->
name|sc_if
operator|.
name|if_timer
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
name|i4b_l4_accounting
argument_list|(
name|BDRV_ISPPP
argument_list|,
name|unit
argument_list|,
name|ACCT_FINAL
argument_list|,
name|sc
operator|->
name|sc_ioutb
argument_list|,
name|sc
operator|->
name|sc_iinb
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|sc
operator|->
name|sc_outb
argument_list|,
name|sc
operator|->
name|sc_inb
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_state
operator|==
name|ST_CONNECTED
condition|)
block|{
if|#
directive|if
literal|0
comment|/* never used ??? */
block|UNTIMEOUT(i4bisppp_timeout, (void *)sp, sc->sc_ch);
endif|#
directive|endif
name|sc
operator|->
name|sc_cdp
operator|=
operator|(
name|call_desc_t
operator|*
operator|)
literal|0
expr_stmt|;
comment|/* do thhis here because pp_down calls i4bisppp_tlf */
name|sc
operator|->
name|sc_state
operator|=
name|ST_IDLE
expr_stmt|;
name|sp
operator|->
name|pp_down
argument_list|(
name|sp
argument_list|)
expr_stmt|;
comment|/* tell PPP we have hung up */
block|}
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	this routine is used to give a feedback from userland demon  *	in case of dial problems  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|i4bisppp_dialresponse
parameter_list|(
name|int
name|unit
parameter_list|,
name|int
name|status
parameter_list|,
name|cause_t
name|cause
parameter_list|)
block|{
name|struct
name|i4bisppp_softc
modifier|*
name|sc
init|=
operator|&
name|i4bisppp_softc
index|[
name|unit
index|]
decl_stmt|;
name|NDBGL4
argument_list|(
name|L4_ISPDBG
argument_list|,
literal|"isp%d: status=%d, cause=%d"
argument_list|,
name|unit
argument_list|,
name|status
argument_list|,
name|cause
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|DSTAT_NONE
condition|)
block|{
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|NDBGL4
argument_list|(
name|L4_ISPDBG
argument_list|,
literal|"isp%d: clearing queues"
argument_list|,
name|unit
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|USE_ISPPP
if|if
condition|(
operator|!
operator|(
name|sppp_isempty
argument_list|(
operator|&
name|sc
operator|->
name|sc_if
argument_list|)
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|!
operator|(
name|isppp_isempty
argument_list|(
operator|&
name|sc
operator|->
name|sc_if
argument_list|)
operator|)
condition|)
endif|#
directive|endif
block|{
ifndef|#
directive|ifndef
name|USE_ISPPP
while|while
condition|(
operator|(
name|m
operator|=
name|sppp_dequeue
argument_list|(
operator|&
name|sc
operator|->
name|sc_if
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
else|#
directive|else
while|while
condition|(
operator|(
name|m
operator|=
name|isppp_dequeue
argument_list|(
operator|&
name|sc
operator|->
name|sc_if
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
endif|#
directive|endif
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	interface up/down  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|i4bisppp_updown
parameter_list|(
name|int
name|unit
parameter_list|,
name|int
name|updown
parameter_list|)
block|{
comment|/* could probably do something useful here */
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	this routine is called from the HSCX interrupt handler  *	when a new frame (mbuf) has been received and was put on  *	the rx queue.  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|i4bisppp_rx_data_rdy
parameter_list|(
name|int
name|unit
parameter_list|)
block|{
name|struct
name|i4bisppp_softc
modifier|*
name|sc
init|=
operator|&
name|i4bisppp_softc
index|[
name|unit
index|]
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|int
name|s
decl_stmt|;
if|if
condition|(
operator|(
name|m
operator|=
operator|*
name|isdn_linktab
index|[
name|unit
index|]
operator|->
name|rx_mbuf
operator|)
operator|==
name|NULL
condition|)
return|return;
name|m
operator|->
name|m_pkthdr
operator|.
name|rcvif
operator|=
operator|&
name|sc
operator|->
name|sc_if
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|m
operator|->
name|m_len
expr_stmt|;
name|microtime
argument_list|(
operator|&
name|sc
operator|->
name|sc_if
operator|.
name|if_lastchange
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_if
operator|.
name|if_ipackets
operator|++
expr_stmt|;
if|#
directive|if
literal|0
block|sc->sc_if.if_ibytes += m->m_pkthdr.len;
endif|#
directive|endif
if|#
directive|if
name|I4BISPPPACCT
name|sc
operator|->
name|sc_inb
operator|+=
name|m
operator|->
name|m_pkthdr
operator|.
name|len
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|I4BISPPPDEBUG
name|printf
argument_list|(
literal|"i4bisppp_rx_data_ready: received packet!\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|#
directive|if
name|NBPFILTER
operator|>
literal|0
operator|||
name|NBPF
operator|>
literal|0
ifdef|#
directive|ifdef
name|__FreeBSD__
if|if
condition|(
name|sc
operator|->
name|sc_if
operator|.
name|if_bpf
condition|)
name|bpf_mtap
argument_list|(
operator|&
name|sc
operator|->
name|sc_if
argument_list|,
name|m
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* __FreeBSD__ */
ifdef|#
directive|ifdef
name|__NetBSD__
if|if
condition|(
name|sc
operator|->
name|sc_if
operator|.
name|if_bpf
condition|)
name|bpf_mtap
argument_list|(
name|sc
operator|->
name|sc_if
operator|.
name|if_bpf
argument_list|,
name|m
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|#
directive|endif
comment|/* NBPFILTER> 0  || NBPF> 0 */
name|s
operator|=
name|splimp
argument_list|()
expr_stmt|;
ifndef|#
directive|ifndef
name|USE_ISPPP
name|sppp_input
argument_list|(
operator|&
name|sc
operator|->
name|sc_if
argument_list|,
name|m
argument_list|)
expr_stmt|;
else|#
directive|else
name|isppp_input
argument_list|(
operator|&
name|sc
operator|->
name|sc_if
argument_list|,
name|m
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	this routine is called from the HSCX interrupt handler  *	when the last frame has been sent out and there is no  *	further frame (mbuf) in the tx queue.  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|i4bisppp_tx_queue_empty
parameter_list|(
name|int
name|unit
parameter_list|)
block|{
name|i4bisppp_start
argument_list|(
operator|&
name|i4bisppp_softc
index|[
name|unit
index|]
operator|.
name|sc_if
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	THIS should be used instead of last_active_time to implement  *	an activity timeout mechanism.  *  *	Sending back the time difference unneccessarily complicates the  *	idletime checks in i4b_l4.c. Return the largest time instead.  *	That way the code in i4b_l4.c needs only minimal changes.  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|time_t
name|i4bisppp_idletime
parameter_list|(
name|int
name|unit
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|__NetBSD__
return|return
operator|(
name|i4bisppp_softc
index|[
name|unit
index|]
operator|.
name|sc_cdp
operator|->
name|last_active_time
operator|)
return|;
else|#
directive|else
name|struct
name|sppp
modifier|*
name|sp
decl_stmt|;
name|sp
operator|=
operator|(
expr|struct
name|sppp
operator|*
operator|)
operator|&
name|i4bisppp_softc
index|[
name|unit
index|]
expr_stmt|;
return|return
operator|(
operator|(
name|sp
operator|->
name|pp_last_recv
operator|<
name|sp
operator|->
name|pp_last_sent
operator|)
condition|?
name|sp
operator|->
name|pp_last_sent
else|:
name|sp
operator|->
name|pp_last_recv
operator|)
return|;
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	this routine is called from the HSCX interrupt handler  *	each time a packet is received or transmitted. It should  *	be used to implement an activity timeout mechanism.  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|i4bisppp_activity
parameter_list|(
name|int
name|unit
parameter_list|,
name|int
name|rxtx
parameter_list|)
block|{
name|i4bisppp_softc
index|[
name|unit
index|]
operator|.
name|sc_cdp
operator|->
name|last_active_time
operator|=
name|SECOND
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	return this drivers linktab address  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|drvr_link_t
modifier|*
name|i4bisppp_ret_linktab
parameter_list|(
name|int
name|unit
parameter_list|)
block|{
return|return
operator|(
operator|&
name|i4bisppp_drvr_linktab
index|[
name|unit
index|]
operator|)
return|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	setup the isdn_linktab for this driver  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|i4bisppp_set_linktab
parameter_list|(
name|int
name|unit
parameter_list|,
name|isdn_link_t
modifier|*
name|ilt
parameter_list|)
block|{
name|isdn_linktab
index|[
name|unit
index|]
operator|=
name|ilt
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	initialize this drivers linktab  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|i4bisppp_init_linktab
parameter_list|(
name|int
name|unit
parameter_list|)
block|{
name|i4bisppp_drvr_linktab
index|[
name|unit
index|]
operator|.
name|unit
operator|=
name|unit
expr_stmt|;
name|i4bisppp_drvr_linktab
index|[
name|unit
index|]
operator|.
name|bch_rx_data_ready
operator|=
name|i4bisppp_rx_data_rdy
expr_stmt|;
name|i4bisppp_drvr_linktab
index|[
name|unit
index|]
operator|.
name|bch_tx_queue_empty
operator|=
name|i4bisppp_tx_queue_empty
expr_stmt|;
name|i4bisppp_drvr_linktab
index|[
name|unit
index|]
operator|.
name|bch_activity
operator|=
name|i4bisppp_activity
expr_stmt|;
name|i4bisppp_drvr_linktab
index|[
name|unit
index|]
operator|.
name|line_connected
operator|=
name|i4bisppp_connect
expr_stmt|;
name|i4bisppp_drvr_linktab
index|[
name|unit
index|]
operator|.
name|line_disconnected
operator|=
name|i4bisppp_disconnect
expr_stmt|;
name|i4bisppp_drvr_linktab
index|[
name|unit
index|]
operator|.
name|dial_response
operator|=
name|i4bisppp_dialresponse
expr_stmt|;
name|i4bisppp_drvr_linktab
index|[
name|unit
index|]
operator|.
name|updown_ind
operator|=
name|i4bisppp_updown
expr_stmt|;
block|}
end_function

begin_comment
comment|/*===========================================================================*/
end_comment

end_unit


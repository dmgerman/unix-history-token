begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  *   Copyright (c) 1998, 1999 Bert Driehuis. All rights reserved.  *  *   Copyright (c) 1997, 1998 Hellmuth Michaelis. All rights reserved.  *  *   Redistribution and use in source and binary forms, with or without  *   modification, are permitted provided that the following conditions  *   are met:  *  *   1. Redistributions of source code must retain the above copyright  *      notice, this list of conditions and the following disclaimer.  *   2. Redistributions in binary form must reproduce the above copyright  *      notice, this list of conditions and the following disclaimer in the  *      documentation and/or other materials provided with the distribution.  *  *   THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  *   ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  *   IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  *   ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  *   FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  *   DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  *   OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  *   HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  *   LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  *   OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  *   SUCH DAMAGE.  *  *---------------------------------------------------------------------------  *  *	i4b_bsdi_ibc.c - isdn4bsd kernel BSD/OS point to point driver  *	-------------------------------------------------------------  *  *	$Id: i4b_bsdi_ibc.c,v 1.3 2000/08/21 07:21:07 hm Exp $  *  * $FreeBSD$  *  *	last edit-date: [Tue Dec 14 21:55:24 1999]  *  *---------------------------------------------------------------------------*/
end_comment

begin_include
include|#
directive|include
file|"ibc.h"
end_include

begin_if
if|#
directive|if
name|NIBC
operator|>
literal|0
end_if

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/errno.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioccom.h>
end_include

begin_include
include|#
directive|include
file|<sys/ttycom.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/protosw.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_types.h>
end_include

begin_include
include|#
directive|include
file|<net/if_p2p.h>
end_include

begin_include
include|#
directive|include
file|<net/netisr.h>
end_include

begin_include
include|#
directive|include
file|<net/route.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_systm.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_var.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip.h>
end_include

begin_include
include|#
directive|include
file|<i4b/i4b_ioctl.h>
end_include

begin_include
include|#
directive|include
file|<i4b/i4b_cause.h>
end_include

begin_include
include|#
directive|include
file|<i4b/include/i4b_global.h>
end_include

begin_include
include|#
directive|include
file|<i4b/include/i4b_mbuf.h>
end_include

begin_include
include|#
directive|include
file|<i4b/include/i4b_l3l4.h>
end_include

begin_include
include|#
directive|include
file|<i4b/layer4/i4b_l4.h>
end_include

begin_define
define|#
directive|define
name|IFP2UNIT
parameter_list|(
name|ifp
parameter_list|)
value|(ifp)->if_unit
end_define

begin_define
define|#
directive|define
name|IOCTL_CMD_T
value|u_long
end_define

begin_function_decl
name|void
name|ibcattach
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_define
define|#
directive|define
name|IBCACCT
value|1
end_define

begin_comment
comment|/* enable accounting messages */
end_comment

begin_define
define|#
directive|define
name|IBCACCTINTVL
value|2
end_define

begin_comment
comment|/* accounting msg interval in secs */
end_comment

begin_define
define|#
directive|define
name|PPP_HDRLEN
value|4
end_define

begin_comment
comment|/* 4 octets PPP header length	*/
end_comment

begin_struct
struct|struct
name|ibc_softc
block|{
name|struct
name|p2pcom
name|sc_p2pcom
decl_stmt|;
name|int
name|sc_state
decl_stmt|;
comment|/* state of the interface	*/
name|call_desc_t
modifier|*
name|sc_cdp
decl_stmt|;
comment|/* ptr to call descriptor	*/
ifdef|#
directive|ifdef
name|IBCACCT
name|int
name|sc_iinb
decl_stmt|;
comment|/* isdn driver # of inbytes	*/
name|int
name|sc_ioutb
decl_stmt|;
comment|/* isdn driver # of outbytes	*/
name|int
name|sc_inb
decl_stmt|;
comment|/* # of bytes rx'd		*/
name|int
name|sc_outb
decl_stmt|;
comment|/* # of bytes tx'd	 	*/
name|int
name|sc_linb
decl_stmt|;
comment|/* last # of bytes rx'd		*/
name|int
name|sc_loutb
decl_stmt|;
comment|/* last # of bytes tx'd 	*/
name|int
name|sc_fn
decl_stmt|;
comment|/* flag, first null acct	*/
endif|#
directive|endif
block|}
name|ibc_softc
index|[
name|NIBC
index|]
struct|;
end_struct

begin_function_decl
specifier|static
name|void
name|ibc_init_linktab
parameter_list|(
name|int
name|unit
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ibc_start
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ibc_watchdog
parameter_list|(
name|int
name|unit
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ibc_mdmctl
parameter_list|(
name|struct
name|p2pcom
modifier|*
name|pp
parameter_list|,
name|int
name|flag
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ibc_getmdm
parameter_list|(
name|struct
name|p2pcom
modifier|*
name|pp
parameter_list|,
name|caddr_t
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* initialized by L4 */
end_comment

begin_decl_stmt
specifier|static
name|drvr_link_t
name|ibc_drvr_linktab
index|[
name|NIBC
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isdn_link_t
modifier|*
name|isdn_ibc_lt
index|[
name|NIBC
index|]
decl_stmt|;
end_decl_stmt

begin_enum
enum|enum
name|ibc_states
block|{
name|ST_IDLE
block|,
comment|/* initialized, ready, idle	*/
name|ST_DIALING
block|,
comment|/* dialling out to remote	*/
name|ST_CONNECTED
block|,
comment|/* connected to remote		*/
block|}
enum|;
end_enum

begin_decl_stmt
name|int
name|ibcdebug
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Use bpatch to set this for debug printf's */
end_comment

begin_define
define|#
directive|define
name|DBG
parameter_list|(
name|x
parameter_list|)
value|if (ibcdebug) printf x
end_define

begin_comment
comment|/*===========================================================================*  *			DEVICE DRIVER ROUTINES  *===========================================================================*/
end_comment

begin_comment
comment|/*---------------------------------------------------------------------------*  *	interface attach routine at kernel boot time  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|ibcattach
parameter_list|(
name|void
modifier|*
name|dummy
parameter_list|)
block|{
name|struct
name|ibc_softc
modifier|*
name|sc
init|=
name|ibc_softc
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|int
name|i
decl_stmt|;
ifndef|#
directive|ifndef
name|HACK_NO_PSEUDO_ATTACH_MSG
name|printf
argument_list|(
literal|"ibc: %d ISDN ibc device(s) attached\n"
argument_list|,
name|NIBC
argument_list|)
expr_stmt|;
endif|#
directive|endif
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NIBC
condition|;
name|sc
operator|++
operator|,
name|i
operator|++
control|)
block|{
name|ibc_init_linktab
argument_list|(
name|i
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_p2pcom
operator|.
name|p2p_mdmctl
operator|=
name|ibc_mdmctl
expr_stmt|;
name|sc
operator|->
name|sc_p2pcom
operator|.
name|p2p_getmdm
operator|=
name|ibc_getmdm
expr_stmt|;
name|sc
operator|->
name|sc_state
operator|=
name|ST_IDLE
expr_stmt|;
name|ifp
operator|=
operator|&
name|sc
operator|->
name|sc_p2pcom
operator|.
name|p2p_if
expr_stmt|;
name|ifp
operator|->
name|if_name
operator|=
literal|"ibc"
expr_stmt|;
name|ifp
operator|->
name|if_next
operator|=
name|NULL
expr_stmt|;
name|ifp
operator|->
name|if_unit
operator|=
name|i
expr_stmt|;
name|ifp
operator|->
name|if_mtu
operator|=
literal|1500
comment|/*XXX*/
expr_stmt|;
name|ifp
operator|->
name|if_baudrate
operator|=
literal|64000
expr_stmt|;
name|ifp
operator|->
name|if_flags
operator|=
name|IFF_SIMPLEX
operator||
name|IFF_POINTOPOINT
expr_stmt|;
name|ifp
operator|->
name|if_type
operator|=
name|IFT_ISDNBASIC
expr_stmt|;
name|ifp
operator|->
name|if_start
operator|=
name|ibc_start
expr_stmt|;
name|ifp
operator|->
name|if_output
operator|=
literal|0
expr_stmt|;
name|ifp
operator|->
name|if_ioctl
operator|=
name|p2p_ioctl
expr_stmt|;
name|ifp
operator|->
name|if_hdrlen
operator|=
literal|0
expr_stmt|;
name|ifp
operator|->
name|if_addrlen
operator|=
literal|0
expr_stmt|;
name|ifp
operator|->
name|if_snd
operator|.
name|ifq_maxlen
operator|=
name|IFQ_MAXLEN
expr_stmt|;
name|ifp
operator|->
name|if_ipackets
operator|=
literal|0
expr_stmt|;
name|ifp
operator|->
name|if_ierrors
operator|=
literal|0
expr_stmt|;
name|ifp
operator|->
name|if_opackets
operator|=
literal|0
expr_stmt|;
name|ifp
operator|->
name|if_oerrors
operator|=
literal|0
expr_stmt|;
name|ifp
operator|->
name|if_collisions
operator|=
literal|0
expr_stmt|;
name|ifp
operator|->
name|if_ibytes
operator|=
literal|0
expr_stmt|;
name|ifp
operator|->
name|if_obytes
operator|=
literal|0
expr_stmt|;
name|ifp
operator|->
name|if_imcasts
operator|=
literal|0
expr_stmt|;
name|ifp
operator|->
name|if_omcasts
operator|=
literal|0
expr_stmt|;
name|ifp
operator|->
name|if_iqdrops
operator|=
literal|0
expr_stmt|;
name|ifp
operator|->
name|if_noproto
operator|=
literal|0
expr_stmt|;
if|#
directive|if
name|IBCACCT
name|ifp
operator|->
name|if_timer
operator|=
literal|0
expr_stmt|;
name|ifp
operator|->
name|if_watchdog
operator|=
name|ibc_watchdog
expr_stmt|;
name|sc
operator|->
name|sc_iinb
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_ioutb
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_inb
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_outb
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_linb
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_loutb
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_fn
operator|=
literal|1
expr_stmt|;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|__FreeBSD_version
argument_list|)
operator|&&
operator|(
operator|(
name|__FreeBSD_version
operator|>=
literal|500009
operator|)
operator|||
operator|(
literal|410000
operator|<=
name|__FreeBSD_version
operator|&&
name|__FreeBSD_version
operator|<
literal|500000
operator|)
operator|)
name|ether_ifattach
argument_list|(
name|ifp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|#
directive|else
name|if_attach
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|p2p_attach
argument_list|(
operator|&
name|sc
operator|->
name|sc_p2pcom
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|struct
name|mbuf
modifier|*
name|p2p_dequeue
parameter_list|(
name|struct
name|p2pcom
modifier|*
name|pp
parameter_list|)
block|{
name|struct
name|ifqueue
modifier|*
name|ifq
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|ifq
operator|=
operator|&
name|pp
operator|->
name|p2p_isnd
expr_stmt|;
name|m
operator|=
name|ifq
operator|->
name|ifq_head
expr_stmt|;
if|if
condition|(
name|m
operator|==
literal|0
condition|)
block|{
name|ifq
operator|=
operator|&
name|pp
operator|->
name|p2p_if
operator|.
name|if_snd
expr_stmt|;
name|m
operator|=
name|ifq
operator|->
name|ifq_head
expr_stmt|;
block|}
if|if
condition|(
name|m
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|IF_DEQUEUE
argument_list|(
name|ifq
argument_list|,
name|m
argument_list|)
expr_stmt|;
return|return
name|m
return|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	start output to ISDN B-channel  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|int
name|ibc_start
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|int
name|unit
init|=
name|IFP2UNIT
argument_list|(
name|ifp
argument_list|)
decl_stmt|;
name|struct
name|ibc_softc
modifier|*
name|sc
init|=
operator|(
expr|struct
name|ibc_softc
operator|*
operator|)
operator|&
name|ibc_softc
index|[
name|unit
index|]
decl_stmt|;
name|struct
name|p2pcom
modifier|*
name|pp
init|=
operator|&
name|sc
operator|->
name|sc_p2pcom
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|int
name|s
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_state
operator|!=
name|ST_CONNECTED
condition|)
block|{
name|DBG
argument_list|(
operator|(
literal|"ibc%d: ibc_start called with sc_state=%d\n"
operator|,
name|unit
operator|,
name|sc
operator|->
name|sc_state
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|s
operator|=
name|SPLI4B
argument_list|()
expr_stmt|;
if|if
condition|(
name|IF_QFULL
argument_list|(
name|isdn_ibc_lt
index|[
name|unit
index|]
operator|->
name|tx_queue
argument_list|)
condition|)
block|{
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|m
operator|=
name|p2p_dequeue
argument_list|(
name|pp
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
block|{
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
do|do
block|{
name|microtime
argument_list|(
operator|&
name|ifp
operator|->
name|if_lastchange
argument_list|)
expr_stmt|;
name|IF_ENQUEUE
argument_list|(
name|isdn_ibc_lt
index|[
name|unit
index|]
operator|->
name|tx_queue
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_obytes
operator|+=
name|m
operator|->
name|m_pkthdr
operator|.
name|len
expr_stmt|;
name|sc
operator|->
name|sc_outb
operator|+=
name|m
operator|->
name|m_pkthdr
operator|.
name|len
expr_stmt|;
name|ifp
operator|->
name|if_opackets
operator|++
expr_stmt|;
block|}
do|while
condition|(
operator|!
name|IF_QFULL
argument_list|(
name|isdn_ibc_lt
index|[
name|unit
index|]
operator|->
name|tx_queue
argument_list|)
operator|&&
operator|(
name|m
operator|=
name|p2p_dequeue
argument_list|(
name|pp
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
do|;
name|isdn_ibc_lt
index|[
name|unit
index|]
operator|->
name|bch_tx_start
argument_list|(
name|isdn_ibc_lt
index|[
name|unit
index|]
operator|->
name|unit
argument_list|,
name|isdn_ibc_lt
index|[
name|unit
index|]
operator|->
name|channel
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|IBCACCT
end_ifdef

begin_comment
comment|/*---------------------------------------------------------------------------*  *	watchdog routine  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|int
name|ibc_watchdog
parameter_list|(
name|int
name|unit
parameter_list|)
block|{
name|struct
name|ibc_softc
modifier|*
name|sc
init|=
operator|&
name|ibc_softc
index|[
name|unit
index|]
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
operator|&
name|sc
operator|->
name|sc_p2pcom
operator|.
name|p2p_if
decl_stmt|;
name|bchan_statistics_t
name|bs
decl_stmt|;
operator|(
operator|*
name|isdn_ibc_lt
index|[
name|unit
index|]
operator|->
name|bch_stat
operator|)
operator|(
name|isdn_ibc_lt
index|[
name|unit
index|]
operator|->
name|unit
operator|,
name|isdn_ibc_lt
index|[
name|unit
index|]
operator|->
name|channel
operator|,
operator|&
name|bs
operator|)
expr_stmt|;
name|sc
operator|->
name|sc_ioutb
operator|+=
name|bs
operator|.
name|outbytes
expr_stmt|;
name|sc
operator|->
name|sc_iinb
operator|+=
name|bs
operator|.
name|inbytes
expr_stmt|;
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_iinb
operator|!=
name|sc
operator|->
name|sc_linb
operator|)
operator|||
operator|(
name|sc
operator|->
name|sc_ioutb
operator|!=
name|sc
operator|->
name|sc_loutb
operator|)
operator|||
name|sc
operator|->
name|sc_fn
condition|)
block|{
name|int
name|ri
init|=
operator|(
name|sc
operator|->
name|sc_iinb
operator|-
name|sc
operator|->
name|sc_linb
operator|)
operator|/
name|IBCACCTINTVL
decl_stmt|;
name|int
name|ro
init|=
operator|(
name|sc
operator|->
name|sc_ioutb
operator|-
name|sc
operator|->
name|sc_loutb
operator|)
operator|/
name|IBCACCTINTVL
decl_stmt|;
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_iinb
operator|==
name|sc
operator|->
name|sc_linb
operator|)
operator|&&
operator|(
name|sc
operator|->
name|sc_ioutb
operator|==
name|sc
operator|->
name|sc_loutb
operator|)
condition|)
name|sc
operator|->
name|sc_fn
operator|=
literal|0
expr_stmt|;
else|else
name|sc
operator|->
name|sc_fn
operator|=
literal|1
expr_stmt|;
name|sc
operator|->
name|sc_linb
operator|=
name|sc
operator|->
name|sc_iinb
expr_stmt|;
name|sc
operator|->
name|sc_loutb
operator|=
name|sc
operator|->
name|sc_ioutb
expr_stmt|;
name|i4b_l4_accounting
argument_list|(
name|BDRV_IBC
argument_list|,
name|unit
argument_list|,
name|ACCT_DURING
argument_list|,
name|sc
operator|->
name|sc_ioutb
argument_list|,
name|sc
operator|->
name|sc_iinb
argument_list|,
name|ro
argument_list|,
name|ri
argument_list|,
name|sc
operator|->
name|sc_outb
argument_list|,
name|sc
operator|->
name|sc_inb
argument_list|)
expr_stmt|;
block|}
name|ifp
operator|->
name|if_timer
operator|=
name|IBCACCTINTVL
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* IBCACCT */
end_comment

begin_comment
comment|/*  *===========================================================================*  *			P2P layer interface routines  *===========================================================================*  */
end_comment

begin_if
if|#
directive|if
literal|0
end_if

begin_comment
comment|/*---------------------------------------------------------------------------*  *	PPP interface phase change  *---------------------------------------------------------------------------*  */
end_comment

begin_comment
unit|static void ibc_state_changed(struct sppp *sp, int new_state) { 	struct ibc_softc *sc = (struct ibc_softc *)sp;  	i4b_l4_ifstate_changed(sc->sc_cdp, new_state); }
comment|/*---------------------------------------------------------------------------*  *	PPP control protocol negotiation complete (run ip-up script now)  *---------------------------------------------------------------------------*  */
end_comment

begin_endif
unit|static void ibc_negotiation_complete(struct sppp *sp) { 	struct ibc_softc *sc = (struct ibc_softc *)sp;  	i4b_l4_negcomplete(sc->sc_cdp); }
endif|#
directive|endif
end_endif

begin_comment
comment|/*===========================================================================*  *			ISDN INTERFACE ROUTINES  *===========================================================================*/
end_comment

begin_comment
comment|/*---------------------------------------------------------------------------*  *	this routine is called from L4 handler at connect time  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|ibc_connect
parameter_list|(
name|int
name|unit
parameter_list|,
name|void
modifier|*
name|cdp
parameter_list|)
block|{
name|struct
name|ibc_softc
modifier|*
name|sc
init|=
operator|&
name|ibc_softc
index|[
name|unit
index|]
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
operator|&
name|sc
operator|->
name|sc_p2pcom
operator|.
name|p2p_if
decl_stmt|;
name|int
name|s
decl_stmt|;
name|DBG
argument_list|(
operator|(
literal|"ibc%d: ibc_connect\n"
operator|,
name|unit
operator|)
argument_list|)
expr_stmt|;
name|s
operator|=
name|splimp
argument_list|()
expr_stmt|;
name|sc
operator|->
name|sc_cdp
operator|=
operator|(
name|call_desc_t
operator|*
operator|)
name|cdp
expr_stmt|;
name|sc
operator|->
name|sc_state
operator|=
name|ST_CONNECTED
expr_stmt|;
if|#
directive|if
name|IBCACCT
name|sc
operator|->
name|sc_iinb
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_ioutb
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_inb
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_outb
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_linb
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_loutb
operator|=
literal|0
expr_stmt|;
name|ifp
operator|->
name|if_timer
operator|=
name|IBCACCTINTVL
expr_stmt|;
endif|#
directive|endif
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_p2pcom
operator|.
name|p2p_modem
condition|)
call|(
modifier|*
name|sc
operator|->
name|sc_p2pcom
operator|.
name|p2p_modem
call|)
argument_list|(
operator|&
name|sc
operator|->
name|sc_p2pcom
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* This is a lie... PPP is just starting to negociate :-) */
name|i4b_l4_negcomplete
argument_list|(
name|sc
operator|->
name|sc_cdp
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	this routine is called from L4 handler at disconnect time  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|ibc_disconnect
parameter_list|(
name|int
name|unit
parameter_list|,
name|void
modifier|*
name|cdp
parameter_list|)
block|{
name|call_desc_t
modifier|*
name|cd
init|=
operator|(
name|call_desc_t
operator|*
operator|)
name|cdp
decl_stmt|;
name|struct
name|ibc_softc
modifier|*
name|sc
init|=
operator|&
name|ibc_softc
index|[
name|unit
index|]
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
operator|&
name|sc
operator|->
name|sc_p2pcom
operator|.
name|p2p_if
decl_stmt|;
name|int
name|s
decl_stmt|;
name|DBG
argument_list|(
operator|(
literal|"ibc%d: ibc_disconnect\n"
operator|,
name|unit
operator|)
argument_list|)
expr_stmt|;
name|s
operator|=
name|splimp
argument_list|()
expr_stmt|;
comment|/* new stuff to check that the active channel is being closed */
if|if
condition|(
name|cd
operator|!=
name|sc
operator|->
name|sc_cdp
condition|)
block|{
name|DBG
argument_list|(
operator|(
literal|"ibc_disconnect: ibc%d channel%d not active\n"
operator|,
name|cd
operator|->
name|driver_unit
operator|,
name|cd
operator|->
name|channelid
operator|)
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return;
block|}
if|#
directive|if
name|IBCACCT
name|ifp
operator|->
name|if_timer
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
name|i4b_l4_accounting
argument_list|(
name|BDRV_IBC
argument_list|,
name|unit
argument_list|,
name|ACCT_FINAL
argument_list|,
name|sc
operator|->
name|sc_ioutb
argument_list|,
name|sc
operator|->
name|sc_iinb
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|sc
operator|->
name|sc_outb
argument_list|,
name|sc
operator|->
name|sc_inb
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_state
operator|==
name|ST_CONNECTED
condition|)
block|{
name|sc
operator|->
name|sc_cdp
operator|=
operator|(
name|call_desc_t
operator|*
operator|)
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_state
operator|=
name|ST_IDLE
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_p2pcom
operator|.
name|p2p_modem
condition|)
call|(
modifier|*
name|sc
operator|->
name|sc_p2pcom
operator|.
name|p2p_modem
call|)
argument_list|(
operator|&
name|sc
operator|->
name|sc_p2pcom
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	this routine is used to give a feedback from userland demon  *	in case of dial problems  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|ibc_dialresponse
parameter_list|(
name|int
name|unit
parameter_list|,
name|int
name|status
parameter_list|)
block|{
name|DBG
argument_list|(
operator|(
literal|"ibc%d: ibc_dialresponse %d\n"
operator|,
name|unit
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
comment|/*	struct ibc_softc *sc =&ibc_softc[unit];	*/
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	interface up/down  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|ibc_updown
parameter_list|(
name|int
name|unit
parameter_list|,
name|int
name|updown
parameter_list|)
block|{
name|DBG
argument_list|(
operator|(
literal|"ibc%d: ibc_updown %d\n"
operator|,
name|unit
operator|,
name|updown
operator|)
argument_list|)
expr_stmt|;
comment|/* could probably do something useful here */
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	this routine is called from the HSCX interrupt handler  *	when a new frame (mbuf) has been received and was put on  *	the rx queue.  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|ibc_rx_data_rdy
parameter_list|(
name|int
name|unit
parameter_list|)
block|{
name|struct
name|ibc_softc
modifier|*
name|sc
init|=
operator|&
name|ibc_softc
index|[
name|unit
index|]
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
operator|&
name|sc
operator|->
name|sc_p2pcom
operator|.
name|p2p_if
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|,
modifier|*
name|m0
decl_stmt|;
name|char
modifier|*
name|buf
decl_stmt|;
name|int
name|s
decl_stmt|;
if|if
condition|(
operator|(
name|m
operator|=
operator|*
name|isdn_ibc_lt
index|[
name|unit
index|]
operator|->
name|rx_mbuf
operator|)
operator|==
name|NULL
condition|)
return|return;
name|microtime
argument_list|(
operator|&
name|ifp
operator|->
name|if_lastchange
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_ipackets
operator|++
expr_stmt|;
comment|/* Walk the mbuf chain */
name|s
operator|=
name|splimp
argument_list|()
expr_stmt|;
for|for
control|(
name|m0
operator|=
name|m
init|;
name|m
operator|!=
literal|0
condition|;
name|m
operator|=
name|m
operator|->
name|m_next
control|)
block|{
if|if
condition|(
name|m
operator|->
name|m_len
operator|==
literal|0
condition|)
continue|continue;
name|ifp
operator|->
name|if_ibytes
operator|+=
name|m
operator|->
name|m_len
expr_stmt|;
if|#
directive|if
name|IBCACCT
name|sc
operator|->
name|sc_inb
operator|+=
name|m
operator|->
name|m_len
expr_stmt|;
endif|#
directive|endif
name|buf
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
name|caddr_t
argument_list|)
expr_stmt|;
if|if
condition|(
call|(
modifier|*
name|sc
operator|->
name|sc_p2pcom
operator|.
name|p2p_hdrinput
call|)
argument_list|(
operator|&
name|sc
operator|->
name|sc_p2pcom
argument_list|,
name|buf
argument_list|,
name|m
operator|->
name|m_len
argument_list|)
operator|>=
literal|0
condition|)
call|(
modifier|*
name|sc
operator|->
name|sc_p2pcom
operator|.
name|p2p_input
call|)
argument_list|(
operator|&
name|sc
operator|->
name|sc_p2pcom
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|m0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	this routine is called from the HSCX interrupt handler  *	when the last frame has been sent out and there is no  *	further frame (mbuf) in the tx queue.  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|ibc_tx_queue_empty
parameter_list|(
name|int
name|unit
parameter_list|)
block|{
name|ibc_start
argument_list|(
operator|&
name|ibc_softc
index|[
name|unit
index|]
operator|.
name|sc_p2pcom
operator|.
name|p2p_if
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	this routine is called from the HSCX interrupt handler  *	each time a packet is received or transmitted. It should  *	be used to implement an activity timeout mechanism.  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|ibc_activity
parameter_list|(
name|int
name|unit
parameter_list|,
name|int
name|rxtx
parameter_list|)
block|{
name|ibc_softc
index|[
name|unit
index|]
operator|.
name|sc_cdp
operator|->
name|last_active_time
operator|=
name|SECOND
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	return this drivers linktab address  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|drvr_link_t
modifier|*
name|ibc_ret_linktab
parameter_list|(
name|int
name|unit
parameter_list|)
block|{
return|return
operator|(
operator|&
name|ibc_drvr_linktab
index|[
name|unit
index|]
operator|)
return|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	setup the isdn_ibc_lt for this driver  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|ibc_set_linktab
parameter_list|(
name|int
name|unit
parameter_list|,
name|isdn_link_t
modifier|*
name|ilt
parameter_list|)
block|{
name|isdn_ibc_lt
index|[
name|unit
index|]
operator|=
name|ilt
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	initialize this drivers linktab  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|ibc_init_linktab
parameter_list|(
name|int
name|unit
parameter_list|)
block|{
name|ibc_drvr_linktab
index|[
name|unit
index|]
operator|.
name|unit
operator|=
name|unit
expr_stmt|;
name|ibc_drvr_linktab
index|[
name|unit
index|]
operator|.
name|bch_rx_data_ready
operator|=
name|ibc_rx_data_rdy
expr_stmt|;
name|ibc_drvr_linktab
index|[
name|unit
index|]
operator|.
name|bch_tx_queue_empty
operator|=
name|ibc_tx_queue_empty
expr_stmt|;
name|ibc_drvr_linktab
index|[
name|unit
index|]
operator|.
name|bch_activity
operator|=
name|ibc_activity
expr_stmt|;
name|ibc_drvr_linktab
index|[
name|unit
index|]
operator|.
name|line_connected
operator|=
name|ibc_connect
expr_stmt|;
name|ibc_drvr_linktab
index|[
name|unit
index|]
operator|.
name|line_disconnected
operator|=
name|ibc_disconnect
expr_stmt|;
name|ibc_drvr_linktab
index|[
name|unit
index|]
operator|.
name|dial_response
operator|=
name|ibc_dialresponse
expr_stmt|;
name|ibc_drvr_linktab
index|[
name|unit
index|]
operator|.
name|updown_ind
operator|=
name|ibc_updown
expr_stmt|;
block|}
end_function

begin_comment
comment|/*===========================================================================*/
end_comment

begin_function
specifier|static
name|int
name|ibc_mdmctl
parameter_list|(
name|pp
parameter_list|,
name|flag
parameter_list|)
name|struct
name|p2pcom
modifier|*
name|pp
decl_stmt|;
name|int
name|flag
decl_stmt|;
block|{
specifier|register
name|struct
name|ifnet
modifier|*
name|ifp
init|=
operator|&
name|pp
operator|->
name|p2p_if
decl_stmt|;
name|struct
name|ibc_softc
modifier|*
name|sc
init|=
operator|(
expr|struct
name|ibc_softc
operator|*
operator|)
operator|&
name|ibc_softc
index|[
name|ifp
operator|->
name|if_unit
index|]
decl_stmt|;
name|DBG
argument_list|(
operator|(
literal|"ibc%d: ibc_mdmctl called flags=%d\n"
operator|,
name|IFP2UNIT
argument_list|(
name|ifp
argument_list|)
operator|,
name|flag
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|flag
operator|==
literal|1
operator|&&
name|sc
operator|->
name|sc_state
operator|==
name|ST_IDLE
condition|)
block|{
name|sc
operator|->
name|sc_state
operator|=
name|ST_DIALING
expr_stmt|;
name|i4b_l4_dialout
argument_list|(
name|BDRV_IBC
argument_list|,
name|IFP2UNIT
argument_list|(
name|ifp
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|flag
operator|==
literal|0
operator|&&
name|sc
operator|->
name|sc_state
operator|!=
name|ST_IDLE
condition|)
block|{
name|sc
operator|->
name|sc_state
operator|=
name|ST_IDLE
expr_stmt|;
name|i4b_l4_drvrdisc
argument_list|(
name|BDRV_IBC
argument_list|,
name|IFP2UNIT
argument_list|(
name|ifp
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ibc_getmdm
parameter_list|(
name|pp
parameter_list|,
name|arg
parameter_list|)
name|struct
name|p2pcom
modifier|*
name|pp
decl_stmt|;
name|caddr_t
name|arg
decl_stmt|;
block|{
specifier|register
name|struct
name|ifnet
modifier|*
name|ifp
init|=
operator|&
name|pp
operator|->
name|p2p_if
decl_stmt|;
name|struct
name|ibc_softc
modifier|*
name|sc
init|=
operator|(
expr|struct
name|ibc_softc
operator|*
operator|)
operator|&
name|ibc_softc
index|[
name|ifp
operator|->
name|if_unit
index|]
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_state
operator|==
name|ST_CONNECTED
condition|)
operator|*
operator|(
name|int
operator|*
operator|)
name|arg
operator|=
name|TIOCM_CAR
expr_stmt|;
else|else
operator|*
operator|(
name|int
operator|*
operator|)
name|arg
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
name|DBG
argument_list|(
operator|(
literal|"ibc%d: ibc_getmdm called ret=%d\n"
operator|,
name|IFP2UNIT
argument_list|(
name|ifp
argument_list|)
operator|,
operator|*
operator|(
name|int
operator|*
operator|)
name|arg
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1997, 2002 Hellmuth Michaelis. All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  *---------------------------------------------------------------------------  *  *	i4b_q931.c - Q931 received messages handling  *	--------------------------------------------  *      last edit-date: [Sun Aug 11 19:18:08 2002]  *  *---------------------------------------------------------------------------*/
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<machine/i4b_debug.h>
end_include

begin_include
include|#
directive|include
file|<machine/i4b_ioctl.h>
end_include

begin_include
include|#
directive|include
file|<machine/i4b_cause.h>
end_include

begin_include
include|#
directive|include
file|<i4b/include/i4b_isdnq931.h>
end_include

begin_include
include|#
directive|include
file|<i4b/include/i4b_l3l4.h>
end_include

begin_include
include|#
directive|include
file|<i4b/include/i4b_global.h>
end_include

begin_include
include|#
directive|include
file|<i4b/layer3/i4b_l3.h>
end_include

begin_include
include|#
directive|include
file|<i4b/layer3/i4b_l3fsm.h>
end_include

begin_include
include|#
directive|include
file|<i4b/layer3/i4b_q931.h>
end_include

begin_include
include|#
directive|include
file|<i4b/layer4/i4b_l4.h>
end_include

begin_decl_stmt
name|unsigned
name|int
name|i4b_l3_debug
init|=
name|L3_DEBUG_DEFAULT
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|ctrl_desc_t
name|ctrl_desc
index|[
name|MAX_CONTROLLERS
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* controller description array */
end_comment

begin_decl_stmt
name|int
name|utoc_tab
index|[
name|MAX_CONTROLLERS
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* unit to controller conversion */
end_comment

begin_comment
comment|/* protocol independent causes -> Q.931 causes */
end_comment

begin_decl_stmt
name|unsigned
name|char
name|cause_tab_q931
index|[
name|CAUSE_I4B_MAX
index|]
init|=
block|{
name|CAUSE_Q850_NCCLR
block|,
comment|/* CAUSE_I4B_NORMAL -> normal call clearing */
name|CAUSE_Q850_USRBSY
block|,
comment|/* CAUSE_I4B_BUSY -> user busy */
name|CAUSE_Q850_NOCAVAIL
block|,
comment|/* CAUSE_I4B_NOCHAN -> no circuit/channel available*/
name|CAUSE_Q850_INCDEST
block|,
comment|/* CAUSE_I4B_INCOMP -> incompatible destination */
name|CAUSE_Q850_CALLREJ
block|,
comment|/* CAUSE_I4B_REJECT -> call rejected */
name|CAUSE_Q850_DSTOOORDR
block|,
comment|/* CAUSE_I4B_OOO -> destination out of order */
name|CAUSE_Q850_TMPFAIL
block|,
comment|/* CAUSE_I4B_TMPFAIL -> temporary failure */
name|CAUSE_Q850_USRBSY
block|,
comment|/* CAUSE_I4B_L1ERROR -> L1 error / persistent deact XXX */
name|CAUSE_Q850_USRBSY
block|,
comment|/* CAUSE_I4B_LLDIAL -> no dialout on leased line XXX */
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*---------------------------------------------------------------------------*  *	setup cr ref flag according to direction  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|unsigned
name|char
name|setup_cr
parameter_list|(
name|call_desc_t
modifier|*
name|cd
parameter_list|,
name|unsigned
name|char
name|cr
parameter_list|)
block|{
if|if
condition|(
name|cd
operator|->
name|crflag
operator|==
name|CRF_ORIG
condition|)
return|return
operator|(
name|cr
operator|&
literal|0x7f
operator|)
return|;
comment|/* clear cr ref flag */
elseif|else
if|if
condition|(
name|cd
operator|->
name|crflag
operator|==
name|CRF_DEST
condition|)
return|return
operator|(
name|cr
operator||
literal|0x80
operator|)
return|;
comment|/* set cr ref flag */
else|else
name|panic
argument_list|(
literal|"setup_cr: invalid crflag!\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	decode and process a Q.931 message  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|i4b_decode_q931
parameter_list|(
name|int
name|unit
parameter_list|,
name|int
name|msg_len
parameter_list|,
name|u_char
modifier|*
name|msg_ptr
parameter_list|)
block|{
name|call_desc_t
modifier|*
name|cd
decl_stmt|;
name|int
name|codeset
init|=
name|CODESET_0
decl_stmt|;
name|int
name|old_codeset
init|=
name|CODESET_0
decl_stmt|;
name|int
name|shift_flag
init|=
name|UNSHIFTED
decl_stmt|;
name|int
name|crlen
init|=
literal|0
decl_stmt|;
name|int
name|crval
init|=
literal|0
decl_stmt|;
name|int
name|crflag
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|offset
decl_stmt|;
name|int
name|s
decl_stmt|;
comment|/* check protocol discriminator */
if|if
condition|(
operator|*
name|msg_ptr
operator|!=
name|PD_Q931
condition|)
block|{
specifier|static
name|int
name|protoflag
init|=
operator|-
literal|1
decl_stmt|;
comment|/* print only once .. */
if|if
condition|(
operator|*
name|msg_ptr
operator|!=
name|protoflag
condition|)
block|{
name|NDBGL3
argument_list|(
name|L3_P_ERR
argument_list|,
literal|"unknown protocol discriminator 0x%x!"
argument_list|,
operator|*
name|msg_ptr
argument_list|)
expr_stmt|;
name|protoflag
operator|=
operator|*
name|msg_ptr
expr_stmt|;
block|}
return|return;
block|}
name|msg_ptr
operator|++
expr_stmt|;
name|msg_len
operator|--
expr_stmt|;
name|s
operator|=
name|SPLI4B
argument_list|()
expr_stmt|;
comment|/* this has to be protected ! */
comment|/* extract call reference */
name|crlen
operator|=
operator|*
name|msg_ptr
operator|&
name|CRLENGTH_MASK
expr_stmt|;
name|msg_ptr
operator|++
expr_stmt|;
name|msg_len
operator|--
expr_stmt|;
if|if
condition|(
name|crlen
operator|!=
literal|0
condition|)
block|{
name|crval
operator|+=
operator|*
name|msg_ptr
operator|&
literal|0x7f
expr_stmt|;
name|crflag
operator|=
operator|(
operator|*
name|msg_ptr
operator|>>
literal|7
operator|)
operator|&
literal|0x01
expr_stmt|;
name|msg_ptr
operator|++
expr_stmt|;
name|msg_len
operator|--
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|crlen
condition|;
name|i
operator|++
control|)
block|{
name|crval
operator|+=
operator|*
name|msg_ptr
expr_stmt|;
name|msg_ptr
operator|++
expr_stmt|;
name|msg_len
operator|--
expr_stmt|;
block|}
block|}
else|else
block|{
name|crval
operator|=
literal|0
expr_stmt|;
name|crflag
operator|=
literal|0
expr_stmt|;
block|}
name|NDBGL3
argument_list|(
name|L3_P_MSG
argument_list|,
literal|"Call Ref, len %d, val %d, flag %d"
argument_list|,
name|crlen
argument_list|,
name|crval
argument_list|,
name|crflag
argument_list|)
expr_stmt|;
comment|/* find or allocate calldescriptor */
if|if
condition|(
operator|(
name|cd
operator|=
name|cd_by_unitcr
argument_list|(
name|unit
argument_list|,
name|crval
argument_list|,
name|crflag
operator|==
name|CRF_DEST
condition|?
name|CRF_ORIG
else|:
name|CRF_DEST
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
operator|*
name|msg_ptr
operator|==
name|SETUP
condition|)
block|{
comment|/* get and init new calldescriptor */
name|cd
operator|=
name|reserve_cd
argument_list|()
expr_stmt|;
comment|/* cdid filled in */
name|cd
operator|->
name|controller
operator|=
name|utoc_tab
index|[
name|unit
index|]
expr_stmt|;
name|cd
operator|->
name|cr
operator|=
name|crval
expr_stmt|;
name|cd
operator|->
name|crflag
operator|=
name|CRF_DEST
expr_stmt|;
comment|/* we are the dest side */
name|cd
operator|->
name|ilt
operator|=
name|NULL
expr_stmt|;
comment|/* reset link tab ptrs */
name|cd
operator|->
name|dlt
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
comment|/*XXX*/
if|if
condition|(
name|crval
operator|!=
literal|0
condition|)
comment|/* ignore global call references */
block|{
name|NDBGL3
argument_list|(
name|L3_P_ERR
argument_list|,
literal|"cannot find calldescriptor for cr = 0x%x, crflag = 0x%x, msg = 0x%x, frame = "
argument_list|,
name|crval
argument_list|,
name|crflag
argument_list|,
operator|*
name|msg_ptr
argument_list|)
expr_stmt|;
name|i4b_print_frame
argument_list|(
name|msg_len
argument_list|,
name|msg_ptr
argument_list|)
expr_stmt|;
block|}
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
comment|/* decode and handle message type */
name|i4b_decode_q931_message
argument_list|(
name|unit
argument_list|,
name|cd
argument_list|,
operator|*
name|msg_ptr
argument_list|)
expr_stmt|;
name|msg_ptr
operator|++
expr_stmt|;
name|msg_len
operator|--
expr_stmt|;
comment|/* process information elements */
while|while
condition|(
name|msg_len
operator|>
literal|0
condition|)
block|{
comment|/* check for shift codeset IE */
if|if
condition|(
operator|(
operator|*
name|msg_ptr
operator|&
literal|0x80
operator|)
operator|&&
operator|(
operator|(
operator|*
name|msg_ptr
operator|&
literal|0xf0
operator|)
operator|==
name|SOIE_SHIFT
operator|)
condition|)
block|{
if|if
condition|(
operator|!
operator|(
operator|*
name|msg_ptr
operator|&
name|SHIFT_LOCK
operator|)
condition|)
name|shift_flag
operator|=
name|SHIFTED
expr_stmt|;
name|old_codeset
operator|=
name|codeset
expr_stmt|;
name|codeset
operator|=
operator|*
name|msg_ptr
operator|&
name|CODESET_MASK
expr_stmt|;
if|if
condition|(
operator|(
name|shift_flag
operator|!=
name|SHIFTED
operator|)
operator|&&
operator|(
name|codeset
operator|<=
name|old_codeset
operator|)
condition|)
block|{
name|NDBGL3
argument_list|(
name|L3_P_ERR
argument_list|,
literal|"Q.931 lockingshift proc violation, shift %d -> %d"
argument_list|,
name|old_codeset
argument_list|,
name|codeset
argument_list|)
expr_stmt|;
name|codeset
operator|=
name|old_codeset
expr_stmt|;
block|}
name|msg_len
operator|--
expr_stmt|;
name|msg_ptr
operator|++
expr_stmt|;
block|}
comment|/* process one IE for selected codeset */
switch|switch
condition|(
name|codeset
condition|)
block|{
case|case
name|CODESET_0
case|:
name|offset
operator|=
name|i4b_decode_q931_cs0_ie
argument_list|(
name|unit
argument_list|,
name|cd
argument_list|,
name|msg_len
argument_list|,
name|msg_ptr
argument_list|)
expr_stmt|;
name|msg_len
operator|-=
name|offset
expr_stmt|;
name|msg_ptr
operator|+=
name|offset
expr_stmt|;
break|break;
default|default:
name|NDBGL3
argument_list|(
name|L3_P_ERR
argument_list|,
literal|"unknown codeset %d, "
argument_list|,
name|codeset
argument_list|)
expr_stmt|;
name|i4b_print_frame
argument_list|(
name|msg_len
argument_list|,
name|msg_ptr
argument_list|)
expr_stmt|;
name|msg_len
operator|=
literal|0
expr_stmt|;
break|break;
block|}
comment|/* check for non-locking shifts */
if|if
condition|(
name|shift_flag
operator|==
name|SHIFTED
condition|)
block|{
name|shift_flag
operator|=
name|UNSHIFTED
expr_stmt|;
name|codeset
operator|=
name|old_codeset
expr_stmt|;
block|}
block|}
name|next_l3state
argument_list|(
name|cd
argument_list|,
name|cd
operator|->
name|event
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	decode and process one Q.931 codeset 0 information element  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|int
name|i4b_decode_q931_cs0_ie
parameter_list|(
name|int
name|unit
parameter_list|,
name|call_desc_t
modifier|*
name|cd
parameter_list|,
name|int
name|msg_len
parameter_list|,
name|u_char
modifier|*
name|msg_ptr
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|;
switch|switch
condition|(
operator|*
name|msg_ptr
condition|)
block|{
comment|/*********/
comment|/* Q.931 */
comment|/*********/
comment|/* single byte IE's */
case|case
name|IEI_SENDCOMPL
case|:
name|NDBGL3
argument_list|(
name|L3_P_MSG
argument_list|,
literal|"IEI_SENDCOMPL"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
break|break;
comment|/* multi byte IE's */
case|case
name|IEI_SEGMMSG
case|:
comment|/* segmented message */
name|NDBGL3
argument_list|(
name|L3_P_MSG
argument_list|,
literal|"IEI_SEGMENTED_MESSAGE"
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEI_BEARERCAP
case|:
comment|/* bearer capability */
switch|switch
condition|(
name|msg_ptr
index|[
literal|2
index|]
condition|)
block|{
case|case
literal|0x80
case|:
comment|/* speech */
case|case
literal|0x89
case|:
comment|/* restricted digital info */
case|case
literal|0x90
case|:
comment|/* 3.1KHz audio */
comment|/* XXX */
name|cd
operator|->
name|bprot
operator|=
name|BPROT_NONE
expr_stmt|;
name|NDBGL3
argument_list|(
name|L3_P_MSG
argument_list|,
literal|"IEI_BEARERCAP - Telephony"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x88
case|:
comment|/* unrestricted digital info */
comment|/* XXX */
name|cd
operator|->
name|bprot
operator|=
name|BPROT_RHDLC
expr_stmt|;
name|NDBGL3
argument_list|(
name|L3_P_MSG
argument_list|,
literal|"IEI_BEARERCAP - Raw HDLC"
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|/* XXX */
name|cd
operator|->
name|bprot
operator|=
name|BPROT_NONE
expr_stmt|;
name|NDBGL3
argument_list|(
name|L3_P_ERR
argument_list|,
literal|"IEI_BEARERCAP - Unsupported B-Protocol 0x%x"
argument_list|,
name|msg_ptr
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|IEI_CAUSE
case|:
comment|/* cause */
if|if
condition|(
name|msg_ptr
index|[
literal|2
index|]
operator|&
literal|0x80
condition|)
block|{
name|cd
operator|->
name|cause_in
operator|=
name|msg_ptr
index|[
literal|3
index|]
operator|&
literal|0x7f
expr_stmt|;
name|NDBGL3
argument_list|(
name|L3_P_MSG
argument_list|,
literal|"IEI_CAUSE = %d"
argument_list|,
name|msg_ptr
index|[
literal|3
index|]
operator|&
literal|0x7f
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|cd
operator|->
name|cause_in
operator|=
name|msg_ptr
index|[
literal|4
index|]
operator|&
literal|0x7f
expr_stmt|;
name|NDBGL3
argument_list|(
name|L3_P_MSG
argument_list|,
literal|"IEI_CAUSE = %d"
argument_list|,
name|msg_ptr
index|[
literal|4
index|]
operator|&
literal|0x7f
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|IEI_CALLID
case|:
comment|/* call identity */
name|NDBGL3
argument_list|(
name|L3_P_MSG
argument_list|,
literal|"IEI_CALL_IDENTITY"
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEI_CALLSTATE
case|:
comment|/* call state		*/
name|cd
operator|->
name|call_state
operator|=
name|msg_ptr
index|[
literal|2
index|]
operator|&
literal|0x3f
expr_stmt|;
name|NDBGL3
argument_list|(
name|L3_P_MSG
argument_list|,
literal|"IEI_CALLSTATE = %d"
argument_list|,
name|cd
operator|->
name|call_state
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEI_CHANNELID
case|:
comment|/* channel id */
if|if
condition|(
operator|(
name|msg_ptr
index|[
literal|2
index|]
operator|&
literal|0xf4
operator|)
operator|!=
literal|0x80
condition|)
block|{
name|cd
operator|->
name|channelid
operator|=
name|CHAN_NO
expr_stmt|;
name|NDBGL3
argument_list|(
name|L3_P_ERR
argument_list|,
literal|"IEI_CHANNELID, unsupported value 0x%x"
argument_list|,
name|msg_ptr
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
block|}
else|else
block|{
switch|switch
condition|(
name|msg_ptr
index|[
literal|2
index|]
operator|&
literal|0x03
condition|)
block|{
case|case
name|IE_CHAN_ID_NO
case|:
name|cd
operator|->
name|channelid
operator|=
name|CHAN_NO
expr_stmt|;
break|break;
case|case
name|IE_CHAN_ID_B1
case|:
name|cd
operator|->
name|channelid
operator|=
name|CHAN_B1
expr_stmt|;
break|break;
case|case
name|IE_CHAN_ID_B2
case|:
name|cd
operator|->
name|channelid
operator|=
name|CHAN_B2
expr_stmt|;
break|break;
case|case
name|IE_CHAN_ID_ANY
case|:
name|cd
operator|->
name|channelid
operator|=
name|CHAN_ANY
expr_stmt|;
break|break;
block|}
name|cd
operator|->
name|channelexcl
operator|=
operator|(
name|msg_ptr
index|[
literal|2
index|]
operator|&
literal|0x08
operator|)
operator|>>
literal|3
expr_stmt|;
name|NDBGL3
argument_list|(
name|L3_P_MSG
argument_list|,
literal|"IEI_CHANNELID - channel %d, exclusive = %d"
argument_list|,
name|cd
operator|->
name|channelid
argument_list|,
name|cd
operator|->
name|channelexcl
argument_list|)
expr_stmt|;
comment|/* if this is a setup message, reserve channel */
if|if
condition|(
name|cd
operator|->
name|event
operator|==
name|EV_SETUP
condition|)
block|{
if|if
condition|(
operator|(
name|cd
operator|->
name|channelid
operator|==
name|CHAN_B1
operator|)
operator|||
operator|(
name|cd
operator|->
name|channelid
operator|==
name|CHAN_B2
operator|)
condition|)
block|{
if|if
condition|(
name|ctrl_desc
index|[
name|cd
operator|->
name|controller
index|]
operator|.
name|bch_state
index|[
name|cd
operator|->
name|channelid
index|]
operator|==
name|BCH_ST_FREE
condition|)
name|ctrl_desc
index|[
name|cd
operator|->
name|controller
index|]
operator|.
name|bch_state
index|[
name|cd
operator|->
name|channelid
index|]
operator|=
name|BCH_ST_RSVD
expr_stmt|;
else|else
name|NDBGL3
argument_list|(
name|L3_P_ERR
argument_list|,
literal|"IE ChannelID, Channel NOT free!!"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cd
operator|->
name|channelid
operator|==
name|CHAN_NO
condition|)
block|{
name|NDBGL3
argument_list|(
name|L3_P_MSG
argument_list|,
literal|"IE ChannelID, SETUP with channel = No channel (CW)"
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* cd->channelid == CHAN_ANY */
block|{
name|NDBGL3
argument_list|(
name|L3_P_ERR
argument_list|,
literal|"ERROR: IE ChannelID, SETUP with channel = Any channel!"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
break|break;
case|case
name|IEI_PROGRESSI
case|:
comment|/* progress indicator	*/
name|NDBGL3
argument_list|(
name|L3_P_MSG
argument_list|,
literal|"IEI_PROGRESSINDICATOR"
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEI_NETSPCFAC
case|:
comment|/* network specific fac */
name|NDBGL3
argument_list|(
name|L3_P_MSG
argument_list|,
literal|"IEI_NETSPCFAC"
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEI_NOTIFIND
case|:
comment|/* notification indicator */
name|NDBGL3
argument_list|(
name|L3_P_MSG
argument_list|,
literal|"IEI_NOTIFICATION_INDICATOR"
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEI_DISPLAY
case|:
comment|/* display		*/
name|memcpy
argument_list|(
name|cd
operator|->
name|display
argument_list|,
operator|&
name|msg_ptr
index|[
literal|2
index|]
argument_list|,
name|min
argument_list|(
name|DISPLAY_MAX
argument_list|,
name|msg_ptr
index|[
literal|1
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|cd
operator|->
name|display
index|[
name|min
argument_list|(
name|DISPLAY_MAX
argument_list|,
name|msg_ptr
index|[
literal|1
index|]
argument_list|)
index|]
operator|=
literal|'\0'
expr_stmt|;
name|NDBGL3
argument_list|(
name|L3_P_MSG
argument_list|,
literal|"IEI_DISPLAY = %s"
argument_list|,
name|cd
operator|->
name|display
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEI_DATETIME
case|:
comment|/* date/time		*/
name|i
operator|=
literal|2
expr_stmt|;
name|j
operator|=
name|msg_ptr
index|[
literal|1
index|]
expr_stmt|;
name|p
operator|=
operator|&
operator|(
name|cd
operator|->
name|datetime
index|[
literal|0
index|]
operator|)
expr_stmt|;
operator|*
name|p
operator|=
literal|'\0'
expr_stmt|;
for|for
control|(
name|j
operator|=
name|msg_ptr
index|[
literal|1
index|]
init|;
name|j
operator|>
literal|0
condition|;
name|j
operator|--
operator|,
name|i
operator|++
control|)
name|sprintf
argument_list|(
name|p
operator|+
name|strlen
argument_list|(
name|p
argument_list|)
argument_list|,
literal|"%02d"
argument_list|,
name|msg_ptr
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|NDBGL3
argument_list|(
name|L3_P_MSG
argument_list|,
literal|"IEI_DATETIME = %s"
argument_list|,
name|cd
operator|->
name|datetime
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEI_KEYPAD
case|:
comment|/* keypad facility */
name|NDBGL3
argument_list|(
name|L3_P_MSG
argument_list|,
literal|"IEI_KEYPAD_FACILITY"
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEI_SIGNAL
case|:
comment|/* signal type */
name|NDBGL3
argument_list|(
name|L3_P_MSG
argument_list|,
literal|"IEI_SIGNAL = %d"
argument_list|,
name|msg_ptr
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEI_INFRATE
case|:
comment|/* information rate */
name|NDBGL3
argument_list|(
name|L3_P_MSG
argument_list|,
literal|"IEI_INFORMATION_RATE"
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEI_ETETDEL
case|:
comment|/* end to end transit delay */
name|NDBGL3
argument_list|(
name|L3_P_MSG
argument_list|,
literal|"IEI_END_TO_END_TRANSIT_DELAY"
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEI_CUG
case|:
comment|/* closed user group */
name|NDBGL3
argument_list|(
name|L3_P_MSG
argument_list|,
literal|"IEI_CLOSED_USER_GROUP"
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEI_CALLINGPN
case|:
comment|/* calling party no */
if|if
condition|(
name|msg_ptr
index|[
literal|2
index|]
operator|&
literal|0x80
condition|)
comment|/* no presentation/screening indicator ? */
block|{
name|memcpy
argument_list|(
name|cd
operator|->
name|src_telno
argument_list|,
operator|&
name|msg_ptr
index|[
literal|3
index|]
argument_list|,
name|min
argument_list|(
name|TELNO_MAX
argument_list|,
name|msg_ptr
index|[
literal|1
index|]
operator|-
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|cd
operator|->
name|src_telno
index|[
name|min
argument_list|(
name|TELNO_MAX
argument_list|,
name|msg_ptr
index|[
literal|1
index|]
operator|-
literal|1
argument_list|)
index|]
operator|=
literal|'\0'
expr_stmt|;
name|cd
operator|->
name|scr_ind
operator|=
name|SCR_NONE
expr_stmt|;
name|cd
operator|->
name|prs_ind
operator|=
name|PRS_NONE
expr_stmt|;
block|}
else|else
block|{
name|memcpy
argument_list|(
name|cd
operator|->
name|src_telno
argument_list|,
operator|&
name|msg_ptr
index|[
literal|4
index|]
argument_list|,
name|min
argument_list|(
name|TELNO_MAX
argument_list|,
name|msg_ptr
index|[
literal|1
index|]
operator|-
literal|2
argument_list|)
argument_list|)
expr_stmt|;
name|cd
operator|->
name|src_telno
index|[
name|min
argument_list|(
name|TELNO_MAX
argument_list|,
name|msg_ptr
index|[
literal|1
index|]
operator|-
literal|2
argument_list|)
index|]
operator|=
literal|'\0'
expr_stmt|;
name|cd
operator|->
name|scr_ind
operator|=
operator|(
name|msg_ptr
index|[
literal|3
index|]
operator|&
literal|0x03
operator|)
operator|+
name|SCR_USR_NOSC
expr_stmt|;
name|cd
operator|->
name|prs_ind
operator|=
operator|(
operator|(
name|msg_ptr
index|[
literal|3
index|]
operator|>>
literal|5
operator|)
operator|&
literal|0x03
operator|)
operator|+
name|PRS_ALLOWED
expr_stmt|;
block|}
comment|/* type of number (source) */
switch|switch
condition|(
operator|(
name|msg_ptr
index|[
literal|2
index|]
operator|&
literal|0x70
operator|)
operator|>>
literal|4
condition|)
block|{
case|case
literal|1
case|:
name|cd
operator|->
name|src_ton
operator|=
name|TON_INTERNAT
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|cd
operator|->
name|src_ton
operator|=
name|TON_NATIONAL
expr_stmt|;
break|break;
default|default:
name|cd
operator|->
name|src_ton
operator|=
name|TON_OTHER
expr_stmt|;
break|break;
block|}
name|NDBGL3
argument_list|(
name|L3_P_MSG
argument_list|,
literal|"IEI_CALLINGPN = %s"
argument_list|,
name|cd
operator|->
name|src_telno
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEI_CALLINGPS
case|:
comment|/* calling party subaddress */
name|memcpy
argument_list|(
name|cd
operator|->
name|src_subaddr
argument_list|,
operator|&
name|msg_ptr
index|[
literal|3
index|]
argument_list|,
name|min
argument_list|(
name|SUBADDR_MAX
argument_list|,
name|msg_ptr
index|[
literal|1
index|]
operator|-
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|cd
operator|->
name|src_subaddr
index|[
name|min
argument_list|(
name|SUBADDR_MAX
argument_list|,
name|msg_ptr
index|[
literal|1
index|]
operator|-
literal|1
argument_list|)
index|]
operator|=
literal|'\0'
expr_stmt|;
name|NDBGL3
argument_list|(
name|L3_P_MSG
argument_list|,
literal|"IEI_CALLINGPS = %s"
argument_list|,
name|cd
operator|->
name|src_subaddr
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEI_CALLEDPN
case|:
comment|/* called party number */
name|memcpy
argument_list|(
name|cd
operator|->
name|dst_telno
argument_list|,
operator|&
name|msg_ptr
index|[
literal|3
index|]
argument_list|,
name|min
argument_list|(
name|TELNO_MAX
argument_list|,
name|msg_ptr
index|[
literal|1
index|]
operator|-
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|cd
operator|->
name|dst_telno
index|[
name|min
argument_list|(
name|TELNO_MAX
argument_list|,
name|msg_ptr
index|[
literal|1
index|]
operator|-
literal|1
argument_list|)
index|]
operator|=
literal|'\0'
expr_stmt|;
comment|/* type of number (destination) */
switch|switch
condition|(
operator|(
name|msg_ptr
index|[
literal|2
index|]
operator|&
literal|0x70
operator|)
operator|>>
literal|4
condition|)
block|{
case|case
literal|1
case|:
name|cd
operator|->
name|dst_ton
operator|=
name|TON_INTERNAT
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|cd
operator|->
name|dst_ton
operator|=
name|TON_NATIONAL
expr_stmt|;
break|break;
default|default:
name|cd
operator|->
name|dst_ton
operator|=
name|TON_OTHER
expr_stmt|;
break|break;
block|}
name|NDBGL3
argument_list|(
name|L3_P_MSG
argument_list|,
literal|"IEI_CALLED = %s"
argument_list|,
name|cd
operator|->
name|dst_telno
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEI_CALLEDPS
case|:
comment|/* called party subaddress */
name|memcpy
argument_list|(
name|cd
operator|->
name|dst_subaddr
argument_list|,
operator|&
name|msg_ptr
index|[
literal|3
index|]
argument_list|,
name|min
argument_list|(
name|SUBADDR_MAX
argument_list|,
name|msg_ptr
index|[
literal|1
index|]
operator|-
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|cd
operator|->
name|dst_subaddr
index|[
name|min
argument_list|(
name|SUBADDR_MAX
argument_list|,
name|msg_ptr
index|[
literal|1
index|]
operator|-
literal|1
argument_list|)
index|]
operator|=
literal|'\0'
expr_stmt|;
name|NDBGL3
argument_list|(
name|L3_P_MSG
argument_list|,
literal|"IEI_CALLEDPS = %s"
argument_list|,
name|cd
operator|->
name|dst_subaddr
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEI_REDIRNO
case|:
comment|/* redirecting number */
name|NDBGL3
argument_list|(
name|L3_P_MSG
argument_list|,
literal|"IEI_REDIRECTING_NUMBER"
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEI_TRNSEL
case|:
comment|/* transit network selection */
name|NDBGL3
argument_list|(
name|L3_P_MSG
argument_list|,
literal|"IEI_TRANSIT_NETWORK_SELECTION"
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEI_RESTARTI
case|:
comment|/* restart indicator */
name|NDBGL3
argument_list|(
name|L3_P_MSG
argument_list|,
literal|"IEI_RESTART_INDICATOR"
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEI_LLCOMPAT
case|:
comment|/* low layer compat */
name|NDBGL3
argument_list|(
name|L3_P_MSG
argument_list|,
literal|"IEI_LLCOMPAT"
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEI_HLCOMPAT
case|:
comment|/* high layer compat	*/
name|NDBGL3
argument_list|(
name|L3_P_MSG
argument_list|,
literal|"IEI_HLCOMPAT"
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEI_USERUSER
case|:
comment|/* user-user */
name|NDBGL3
argument_list|(
name|L3_P_MSG
argument_list|,
literal|"IEI_USER_USER"
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEI_ESCAPE
case|:
comment|/* escape for extension */
name|NDBGL3
argument_list|(
name|L3_P_MSG
argument_list|,
literal|"IEI_ESCAPE"
argument_list|)
expr_stmt|;
break|break;
comment|/*********/
comment|/* Q.932 */
comment|/*********/
case|case
name|IEI_FACILITY
case|:
comment|/* facility		*/
name|NDBGL3
argument_list|(
name|L3_P_MSG
argument_list|,
literal|"IEI_FACILITY"
argument_list|)
expr_stmt|;
if|if
condition|(
name|i4b_aoc
argument_list|(
name|msg_ptr
argument_list|,
name|cd
argument_list|)
operator|>
operator|-
literal|1
condition|)
name|i4b_l4_charging_ind
argument_list|(
name|cd
argument_list|)
expr_stmt|;
break|break;
comment|/*********/
comment|/* Q.95x */
comment|/*********/
case|case
name|IEI_CONCTDNO
case|:
comment|/* connected number	*/
name|NDBGL3
argument_list|(
name|L3_P_MSG
argument_list|,
literal|"IEI_CONCTDNO"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|NDBGL3
argument_list|(
name|L3_P_ERR
argument_list|,
literal|"Unknown IE %d - "
argument_list|,
operator|*
name|msg_ptr
argument_list|)
expr_stmt|;
name|i4b_print_frame
argument_list|(
name|msg_ptr
index|[
literal|1
index|]
operator|+
literal|2
argument_list|,
name|msg_ptr
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|msg_ptr
index|[
literal|1
index|]
operator|+
literal|2
operator|)
return|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	decode and process one Q.931 codeset 0 information element  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|i4b_decode_q931_message
parameter_list|(
name|int
name|unit
parameter_list|,
name|call_desc_t
modifier|*
name|cd
parameter_list|,
name|u_char
name|message_type
parameter_list|)
block|{
name|char
modifier|*
name|m
init|=
name|NULL
decl_stmt|;
name|cd
operator|->
name|event
operator|=
name|EV_ILL
expr_stmt|;
switch|switch
condition|(
name|message_type
condition|)
block|{
comment|/* call establishment */
case|case
name|ALERT
case|:
name|cd
operator|->
name|event
operator|=
name|EV_ALERT
expr_stmt|;
name|m
operator|=
literal|"ALERT"
expr_stmt|;
break|break;
case|case
name|CALL_PROCEEDING
case|:
name|cd
operator|->
name|event
operator|=
name|EV_CALLPRC
expr_stmt|;
name|m
operator|=
literal|"CALL_PROCEEDING"
expr_stmt|;
break|break;
case|case
name|PROGRESS
case|:
name|cd
operator|->
name|event
operator|=
name|EV_PROGIND
expr_stmt|;
name|m
operator|=
literal|"PROGRESS"
expr_stmt|;
break|break;
case|case
name|SETUP
case|:
name|m
operator|=
literal|"SETUP"
expr_stmt|;
name|cd
operator|->
name|bprot
operator|=
name|BPROT_NONE
expr_stmt|;
name|cd
operator|->
name|cause_in
operator|=
literal|0
expr_stmt|;
name|cd
operator|->
name|cause_out
operator|=
literal|0
expr_stmt|;
name|cd
operator|->
name|dst_telno
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|cd
operator|->
name|src_telno
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|cd
operator|->
name|channelid
operator|=
name|CHAN_NO
expr_stmt|;
name|cd
operator|->
name|channelexcl
operator|=
literal|0
expr_stmt|;
name|cd
operator|->
name|display
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|cd
operator|->
name|datetime
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|cd
operator|->
name|event
operator|=
name|EV_SETUP
expr_stmt|;
break|break;
case|case
name|CONNECT
case|:
name|m
operator|=
literal|"CONNECT"
expr_stmt|;
name|cd
operator|->
name|datetime
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|cd
operator|->
name|event
operator|=
name|EV_CONNECT
expr_stmt|;
break|break;
case|case
name|SETUP_ACKNOWLEDGE
case|:
name|m
operator|=
literal|"SETUP_ACKNOWLEDGE"
expr_stmt|;
name|cd
operator|->
name|event
operator|=
name|EV_SETUPAK
expr_stmt|;
break|break;
case|case
name|CONNECT_ACKNOWLEDGE
case|:
name|m
operator|=
literal|"CONNECT_ACKNOWLEDGE"
expr_stmt|;
name|cd
operator|->
name|event
operator|=
name|EV_CONACK
expr_stmt|;
break|break;
comment|/* call information */
case|case
name|USER_INFORMATION
case|:
name|m
operator|=
literal|"USER_INFORMATION"
expr_stmt|;
break|break;
case|case
name|SUSPEND_REJECT
case|:
name|m
operator|=
literal|"SUSPEND_REJECT"
expr_stmt|;
break|break;
case|case
name|RESUME_REJECT
case|:
name|m
operator|=
literal|"RESUME_REJECT"
expr_stmt|;
break|break;
case|case
name|HOLD
case|:
name|m
operator|=
literal|"HOLD"
expr_stmt|;
break|break;
case|case
name|SUSPEND
case|:
name|m
operator|=
literal|"SUSPEND"
expr_stmt|;
break|break;
case|case
name|RESUME
case|:
name|m
operator|=
literal|"RESUME"
expr_stmt|;
break|break;
case|case
name|HOLD_ACKNOWLEDGE
case|:
name|m
operator|=
literal|"HOLD_ACKNOWLEDGE"
expr_stmt|;
break|break;
case|case
name|SUSPEND_ACKNOWLEDGE
case|:
name|m
operator|=
literal|"SUSPEND_ACKNOWLEDGE"
expr_stmt|;
break|break;
case|case
name|RESUME_ACKNOWLEDGE
case|:
name|m
operator|=
literal|"RESUME_ACKNOWLEDGE"
expr_stmt|;
break|break;
case|case
name|HOLD_REJECT
case|:
name|m
operator|=
literal|"HOLD_REJECT"
expr_stmt|;
break|break;
case|case
name|RETRIEVE
case|:
name|m
operator|=
literal|"RETRIEVE"
expr_stmt|;
break|break;
case|case
name|RETRIEVE_ACKNOWLEDGE
case|:
name|m
operator|=
literal|"RETRIEVE_ACKNOWLEDGE"
expr_stmt|;
break|break;
case|case
name|RETRIEVE_REJECT
case|:
name|m
operator|=
literal|"RETRIEVE_REJECT"
expr_stmt|;
break|break;
comment|/* call clearing */
case|case
name|DISCONNECT
case|:
name|m
operator|=
literal|"DISCONNECT"
expr_stmt|;
name|cd
operator|->
name|event
operator|=
name|EV_DISCONN
expr_stmt|;
break|break;
case|case
name|RESTART
case|:
name|m
operator|=
literal|"RESTART"
expr_stmt|;
break|break;
case|case
name|RELEASE
case|:
name|m
operator|=
literal|"RELEASE"
expr_stmt|;
name|cd
operator|->
name|event
operator|=
name|EV_RELEASE
expr_stmt|;
break|break;
case|case
name|RESTART_ACKNOWLEDGE
case|:
name|m
operator|=
literal|"RESTART_ACKNOWLEDGE"
expr_stmt|;
break|break;
case|case
name|RELEASE_COMPLETE
case|:
name|m
operator|=
literal|"RELEASE_COMPLETE"
expr_stmt|;
name|cd
operator|->
name|event
operator|=
name|EV_RELCOMP
expr_stmt|;
break|break;
comment|/* misc messages */
case|case
name|SEGMENT
case|:
name|m
operator|=
literal|"SEGMENT"
expr_stmt|;
break|break;
case|case
name|FACILITY
case|:
name|m
operator|=
literal|"FACILITY"
expr_stmt|;
name|cd
operator|->
name|event
operator|=
name|EV_FACILITY
expr_stmt|;
break|break;
case|case
name|REGISTER
case|:
name|m
operator|=
literal|"REGISTER"
expr_stmt|;
break|break;
case|case
name|NOTIFY
case|:
name|m
operator|=
literal|"NOTIFY"
expr_stmt|;
break|break;
case|case
name|STATUS_ENQUIRY
case|:
name|m
operator|=
literal|"STATUS_ENQUIRY"
expr_stmt|;
name|cd
operator|->
name|event
operator|=
name|EV_STATENQ
expr_stmt|;
break|break;
case|case
name|CONGESTION_CONTROL
case|:
name|m
operator|=
literal|"CONGESTION_CONTROL"
expr_stmt|;
break|break;
case|case
name|INFORMATION
case|:
name|m
operator|=
literal|"INFORMATION"
expr_stmt|;
name|cd
operator|->
name|event
operator|=
name|EV_INFO
expr_stmt|;
break|break;
case|case
name|STATUS
case|:
name|m
operator|=
literal|"STATUS"
expr_stmt|;
name|cd
operator|->
name|event
operator|=
name|EV_STATUS
expr_stmt|;
break|break;
default|default:
name|NDBGL3
argument_list|(
name|L3_P_ERR
argument_list|,
literal|"unit %d, cr = 0x%02x, msg = 0x%02x"
argument_list|,
name|unit
argument_list|,
name|cd
operator|->
name|cr
argument_list|,
name|message_type
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|m
condition|)
block|{
name|NDBGL3
argument_list|(
name|L3_PRIM
argument_list|,
literal|"%s: unit %d, cr = 0x%02x\n"
argument_list|,
name|m
argument_list|,
name|unit
argument_list|,
name|cd
operator|->
name|cr
argument_list|)
expr_stmt|;
block|}
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2000 Hans Petter Selasky. All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  *---------------------------------------------------------------------------  *  *	i4b_ihfc_l1.c - hfc layer 1 handler  *	-----------------------------------  *  *	The idea of this file is to separate hfcs/sp/pci data/signal  *	handling and the I4B data/signal handling.  *  *	Everything which has got anything to do with I4B has been put here!  *  *      last edit-date: [Wed Jul 19 09:41:03 2000]  *  *      $Id: i4b_ihfc_l1if.c,v 1.10 2000/09/19 13:50:36 hm Exp $  *  * $FreeBSD$  *  *---------------------------------------------------------------------------*/
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<machine/i4b_debug.h>
end_include

begin_include
include|#
directive|include
file|<machine/i4b_ioctl.h>
end_include

begin_include
include|#
directive|include
file|<machine/i4b_trace.h>
end_include

begin_include
include|#
directive|include
file|<i4b/include/i4b_mbuf.h>
end_include

begin_include
include|#
directive|include
file|<i4b/include/i4b_global.h>
end_include

begin_include
include|#
directive|include
file|<i4b/layer1/i4b_l1.h>
end_include

begin_include
include|#
directive|include
file|<i4b/layer1/ihfc/i4b_ihfc.h>
end_include

begin_include
include|#
directive|include
file|<i4b/layer1/ihfc/i4b_ihfc_ext.h>
end_include

begin_comment
comment|/*---------------------------------------------------------------------------*  *	Local prototypes  *  *	NOTE: The prototypes for get/putmbuf and B_linkinit   *		have been put in i4b_hfc_ext.h for global hfc use.  *  *	NOTE: channel != chan  *---------------------------------------------------------------------------*/
end_comment

begin_function_decl
specifier|static
name|isdn_link_t
modifier|*
name|ihfc_B_ret_linktab
parameter_list|(
name|int
name|unit
parameter_list|,
name|int
name|channel
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ihfc_B_set_linktab
parameter_list|(
name|int
name|unit
parameter_list|,
name|int
name|channel
parameter_list|,
name|drvr_link_t
modifier|*
name|B_linktab
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ihfc_B_start
parameter_list|(
name|int
name|unit
parameter_list|,
name|int
name|chan
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ihfc_B_stat
parameter_list|(
name|int
name|unit
parameter_list|,
name|int
name|chan
parameter_list|,
name|bchan_statistics_t
modifier|*
name|bsp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|ihfc_B_setup
parameter_list|(
name|int
name|unit
parameter_list|,
name|int
name|chan
parameter_list|,
name|int
name|bprot
parameter_list|,
name|int
name|activate
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ihfc_mph_command_req
parameter_list|(
name|int
name|unit
parameter_list|,
name|int
name|command
parameter_list|,
name|void
modifier|*
name|parm
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ihfc_ph_activate_req
parameter_list|(
name|int
name|unit
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ihfc_ph_data_req
parameter_list|(
name|int
name|unit
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|int
name|freeflag
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ihfc_T3_expired
parameter_list|(
name|ihfc_sc_t
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*---------------------------------------------------------------------------*  *	Our I4B L1 mulitplexer link  *---------------------------------------------------------------------------*/
end_comment

begin_decl_stmt
name|struct
name|i4b_l1mux_func
name|ihfc_l1mux_func
init|=
block|{
name|ihfc_B_ret_linktab
block|,
name|ihfc_B_set_linktab
block|,
name|ihfc_mph_command_req
block|,
name|ihfc_ph_data_req
block|,
name|ihfc_ph_activate_req
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*---------------------------------------------------------------------------*  *	L2 -> L1: PH-DATA-REQUEST (D-Channel)  *  *	NOTE: We may get called here from ihfc_hdlc_Dread or isac_hdlc_Dread  *	via the upper layers.  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|int
name|ihfc_ph_data_req
parameter_list|(
name|int
name|unit
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|int
name|freeflag
parameter_list|)
block|{
name|ihfc_sc_t
modifier|*
name|sc
init|=
operator|&
name|ihfc_softc
index|[
name|unit
index|]
decl_stmt|;
name|u_char
name|chan
init|=
literal|0
decl_stmt|;
name|HFC_VAR
expr_stmt|;
if|if
condition|(
operator|!
name|m
condition|)
return|return
literal|0
return|;
name|HFC_BEG
expr_stmt|;
if|if
condition|(
name|S_PHSTATE
operator|!=
literal|3
condition|)
block|{
name|NDBGL1
argument_list|(
name|L1_PRIM
argument_list|,
literal|"L1 was not running: "
literal|"ihfc_ph_activate_req(unit = %d)!"
argument_list|,
name|unit
argument_list|)
expr_stmt|;
name|ihfc_ph_activate_req
argument_list|(
name|unit
argument_list|)
expr_stmt|;
block|}
comment|/* "Allow" I-frames (-hp) */
if|if
condition|(
name|freeflag
operator|==
name|MBUF_DONTFREE
condition|)
name|m
operator|=
name|m_copypacket
argument_list|(
name|m
argument_list|,
name|M_DONTWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|_IF_QFULL
argument_list|(
operator|&
name|S_IFQUEUE
argument_list|)
operator|&&
name|m
condition|)
block|{
name|IF_ENQUEUE
argument_list|(
operator|&
name|S_IFQUEUE
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|ihfc_B_start
argument_list|(
name|unit
argument_list|,
name|chan
argument_list|)
expr_stmt|;
comment|/* (recycling) */
block|}
else|else
block|{
name|NDBGL1
argument_list|(
name|L1_ERROR
argument_list|,
literal|"No frame out (unit = %d)"
argument_list|,
name|unit
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
condition|)
name|i4b_Dfreembuf
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|HFC_END
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|S_INTR_ACTIVE
condition|)
name|S_INT_S1
operator||=
literal|0x04
expr_stmt|;
name|HFC_END
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	L2 -> L1: PH-ACTIVATE-REQUEST (B-channel and D-channel)  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|int
name|ihfc_ph_activate_req
parameter_list|(
name|int
name|unit
parameter_list|)
block|{
name|ihfc_sc_t
modifier|*
name|sc
init|=
operator|&
name|ihfc_softc
index|[
name|unit
index|]
decl_stmt|;
name|HFC_VAR
expr_stmt|;
name|HFC_BEG
expr_stmt|;
if|if
condition|(
operator|(
operator|!
name|S_STM_T3
operator|)
operator|&&
operator|(
name|S_PHSTATE
operator|!=
literal|3
operator|)
condition|)
block|{
name|HFC_FSM
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|S_STM_T3
operator|=
literal|1
expr_stmt|;
name|S_STM_T3CALLOUT
operator|=
name|timeout
argument_list|(
operator|(
name|TIMEOUT_FUNC_T
operator|)
name|ihfc_T3_expired
argument_list|,
operator|(
name|ihfc_sc_t
operator|*
operator|)
name|sc
argument_list|,
name|IHFC_ACTIVATION_TIMEOUT
argument_list|)
expr_stmt|;
block|}
name|HFC_END
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	T3 timeout - persistant deactivation  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|ihfc_T3_expired
parameter_list|(
name|ihfc_sc_t
modifier|*
name|sc
parameter_list|)
block|{
name|u_char
name|chan
init|=
literal|0
decl_stmt|;
name|HFC_VAR
expr_stmt|;
name|HFC_BEG
expr_stmt|;
name|S_STM_T3
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|S_PHSTATE
operator|!=
literal|3
condition|)
comment|/* line was not activated */
block|{
name|i4b_Dcleanifq
argument_list|(
operator|&
name|S_IFQUEUE
argument_list|)
expr_stmt|;
name|i4b_l1_ph_deactivate_ind
argument_list|(
name|S_I4BUNIT
argument_list|)
expr_stmt|;
name|i4b_l1_mph_status_ind
argument_list|(
name|S_I4BUNIT
argument_list|,
name|STI_PDEACT
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|HFC_FSM
argument_list|(
name|sc
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* L1 deactivate */
block|}
name|HFC_END
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	Command from the upper layers (B-channel and D-channel)  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|int
name|ihfc_mph_command_req
parameter_list|(
name|int
name|unit
parameter_list|,
name|int
name|command
parameter_list|,
name|void
modifier|*
name|parm
parameter_list|)
block|{
name|ihfc_sc_t
modifier|*
name|sc
init|=
operator|&
name|ihfc_softc
index|[
name|unit
index|]
decl_stmt|;
switch|switch
condition|(
name|command
condition|)
block|{
case|case
name|CMR_DOPEN
case|:
comment|/* daemon running */
name|NDBGL1
argument_list|(
name|L1_PRIM
argument_list|,
literal|"unit %d, command = CMR_DOPEN"
argument_list|,
name|unit
argument_list|)
expr_stmt|;
name|S_ENABLED
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CMR_DCLOSE
case|:
comment|/* daemon not running */
name|NDBGL1
argument_list|(
name|L1_PRIM
argument_list|,
literal|"unit %d, command = CMR_DCLOSE"
argument_list|,
name|unit
argument_list|)
expr_stmt|;
name|S_ENABLED
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|CMR_SETTRACE
case|:
comment|/* set new trace mask */
name|NDBGL1
argument_list|(
name|L1_PRIM
argument_list|,
literal|"unit %d, command = CMR_SETTRACE, parm = %d"
argument_list|,
name|unit
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|parm
argument_list|)
expr_stmt|;
name|S_TRACE
operator|=
operator|(
name|unsigned
name|int
operator|)
name|parm
expr_stmt|;
break|break;
case|case
name|CMR_GCST
case|:
comment|/* get chip statistic */
name|NDBGL1
argument_list|(
name|L1_PRIM
argument_list|,
literal|"unit %d, command = CMR_GCST, parm = %d"
argument_list|,
name|unit
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|parm
argument_list|)
expr_stmt|;
define|#
directive|define
name|CST
value|((struct chipstat *)parm)
name|CST
operator|->
name|driver_type
operator|=
name|L1DRVR_IHFC
expr_stmt|;
comment|/* XXX CST->xxxx_stat = xxx; */
undef|#
directive|undef
name|CST
break|break;
default|default:
name|NDBGL1
argument_list|(
name|L1_ERROR
argument_list|,
literal|"ERROR, unknown command = %d, unit = %d, parm = %d"
argument_list|,
name|command
argument_list|,
name|unit
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|parm
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	Data source switch for Read channels - 1, 3 and 5 (B and D-Channel)  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|ihfc_putmbuf
parameter_list|(
name|ihfc_sc_t
modifier|*
name|sc
parameter_list|,
name|u_char
name|chan
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|)
block|{
name|i4b_trace_hdr_t
name|hdr
decl_stmt|;
if|if
condition|(
name|chan
operator|<
literal|2
condition|)
block|{
if|if
condition|(
name|S_TRACE
operator|&
name|TRACE_D_RX
condition|)
block|{
name|hdr
operator|.
name|count
operator|=
operator|++
name|S_DTRACECOUNT
expr_stmt|;
name|hdr
operator|.
name|dir
operator|=
name|FROM_NT
expr_stmt|;
name|hdr
operator|.
name|type
operator|=
name|TRC_CH_D
expr_stmt|;
name|hdr
operator|.
name|unit
operator|=
name|S_I4BUNIT
expr_stmt|;
name|MICROTIME
argument_list|(
name|hdr
operator|.
name|time
argument_list|)
expr_stmt|;
name|i4b_l1_trace_ind
argument_list|(
operator|&
name|hdr
argument_list|,
name|m
operator|->
name|m_len
argument_list|,
name|m
operator|->
name|m_data
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|S_ENABLED
condition|)
block|{
name|i4b_Dfreembuf
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return;
block|}
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|m
operator|->
name|m_len
expr_stmt|;
name|i4b_l1_ph_data_ind
argument_list|(
name|S_I4BUNIT
argument_list|,
name|m
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|S_TRACE
operator|&
name|TRACE_B_RX
condition|)
block|{
name|hdr
operator|.
name|count
operator|=
operator|++
name|S_BTRACECOUNT
expr_stmt|;
name|hdr
operator|.
name|dir
operator|=
name|FROM_NT
expr_stmt|;
name|hdr
operator|.
name|type
operator|=
operator|(
name|chan
operator|<
literal|4
operator|)
condition|?
name|TRC_CH_B1
else|:
name|TRC_CH_B2
expr_stmt|;
name|hdr
operator|.
name|unit
operator|=
name|S_I4BUNIT
expr_stmt|;
name|MICROTIME
argument_list|(
name|hdr
operator|.
name|time
argument_list|)
expr_stmt|;
name|i4b_l1_trace_ind
argument_list|(
operator|&
name|hdr
argument_list|,
name|m
operator|->
name|m_len
argument_list|,
name|m
operator|->
name|m_data
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|S_ENABLED
condition|)
block|{
name|i4b_Bfreembuf
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|S_PROT
operator|==
name|BPROT_NONE
condition|)
block|{
if|if
condition|(
operator|!
name|i4b_l1_bchan_tel_silence
argument_list|(
name|m
operator|->
name|m_data
argument_list|,
name|m
operator|->
name|m_len
argument_list|)
condition|)
block|{
name|S_BDRVLINK
operator|->
name|bch_activity
argument_list|(
name|S_BDRVLINK
operator|->
name|unit
argument_list|,
name|ACT_RX
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|_IF_QFULL
argument_list|(
operator|&
name|S_IFQUEUE
argument_list|)
condition|)
block|{
name|S_BYTES
operator|+=
name|m
operator|->
name|m_len
expr_stmt|;
name|IF_ENQUEUE
argument_list|(
operator|&
name|S_IFQUEUE
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|S_BDRVLINK
operator|->
name|bch_rx_data_ready
argument_list|(
name|S_BDRVLINK
operator|->
name|unit
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
if|if
condition|(
name|S_PROT
operator|==
name|BPROT_RHDLC
condition|)
block|{
name|S_MBUFDUMMY
operator|=
name|m
expr_stmt|;
name|S_BYTES
operator|+=
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|m
operator|->
name|m_len
expr_stmt|;
name|S_BDRVLINK
operator|->
name|bch_rx_data_ready
argument_list|(
name|S_BDRVLINK
operator|->
name|unit
argument_list|)
expr_stmt|;
name|S_MBUFDUMMY
operator|=
name|NULL
expr_stmt|;
return|return;
block|}
name|NDBGL1
argument_list|(
name|L1_ERROR
argument_list|,
literal|"Unknown protocol: %d"
argument_list|,
name|S_PROT
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	Data destinator switch for write channels - 0, 2 and 4  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|struct
name|mbuf
modifier|*
name|ihfc_getmbuf
parameter_list|(
name|ihfc_sc_t
modifier|*
name|sc
parameter_list|,
name|u_char
name|chan
parameter_list|)
block|{
specifier|register
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|i4b_trace_hdr_t
name|hdr
decl_stmt|;
if|if
condition|(
name|chan
operator|<
literal|2
condition|)
block|{
name|IF_DEQUEUE
argument_list|(
operator|&
name|S_IFQUEUE
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|S_TRACE
operator|&
name|TRACE_D_TX
operator|)
operator|&&
name|m
condition|)
block|{
name|hdr
operator|.
name|count
operator|=
operator|++
name|S_DTRACECOUNT
expr_stmt|;
name|hdr
operator|.
name|dir
operator|=
name|FROM_TE
expr_stmt|;
name|hdr
operator|.
name|type
operator|=
name|TRC_CH_D
expr_stmt|;
name|hdr
operator|.
name|unit
operator|=
name|S_I4BUNIT
expr_stmt|;
name|MICROTIME
argument_list|(
name|hdr
operator|.
name|time
argument_list|)
expr_stmt|;
name|i4b_l1_trace_ind
argument_list|(
operator|&
name|hdr
argument_list|,
name|m
operator|->
name|m_len
argument_list|,
name|m
operator|->
name|m_data
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|IF_DEQUEUE
argument_list|(
operator|&
name|S_IFQUEUE
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|m
condition|)
block|{
name|S_BDRVLINK
operator|->
name|bch_tx_queue_empty
argument_list|(
name|S_BDRVLINK
operator|->
name|unit
argument_list|)
expr_stmt|;
name|IF_DEQUEUE
argument_list|(
operator|&
name|S_IFQUEUE
argument_list|,
name|m
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|m
condition|)
block|{
if|if
condition|(
operator|!
name|i4b_l1_bchan_tel_silence
argument_list|(
name|m
operator|->
name|m_data
argument_list|,
name|m
operator|->
name|m_len
argument_list|)
condition|)
block|{
name|S_BDRVLINK
operator|->
name|bch_activity
argument_list|(
name|S_BDRVLINK
operator|->
name|unit
argument_list|,
name|ACT_TX
argument_list|)
expr_stmt|;
block|}
name|S_BYTES
operator|+=
name|m
operator|->
name|m_len
expr_stmt|;
if|if
condition|(
name|S_TRACE
operator|&
name|TRACE_B_TX
condition|)
block|{
name|hdr
operator|.
name|count
operator|=
operator|++
name|S_BTRACECOUNT
expr_stmt|;
name|hdr
operator|.
name|dir
operator|=
name|FROM_TE
expr_stmt|;
name|hdr
operator|.
name|type
operator|=
operator|(
name|chan
operator|<
literal|4
operator|)
condition|?
name|TRC_CH_B1
else|:
name|TRC_CH_B2
expr_stmt|;
name|hdr
operator|.
name|unit
operator|=
name|S_I4BUNIT
expr_stmt|;
name|MICROTIME
argument_list|(
name|hdr
operator|.
name|time
argument_list|)
expr_stmt|;
name|i4b_l1_trace_ind
argument_list|(
operator|&
name|hdr
argument_list|,
name|m
operator|->
name|m_len
argument_list|,
name|m
operator|->
name|m_data
argument_list|)
expr_stmt|;
block|}
block|}
block|}
return|return
operator|(
name|m
operator|)
return|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	Initialize rx/tx data structures (B-channel)  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|ihfc_B_setup
parameter_list|(
name|int
name|unit
parameter_list|,
name|int
name|chan
parameter_list|,
name|int
name|bprot
parameter_list|,
name|int
name|activate
parameter_list|)
block|{
name|ihfc_sc_t
modifier|*
name|sc
init|=
operator|&
name|ihfc_softc
index|[
name|unit
index|]
decl_stmt|;
name|HFC_VAR
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|u_int
operator|)
name|chan
operator|>
literal|5
operator|)
operator|||
operator|(
operator|(
name|u_int
operator|)
name|chan
operator|<
literal|2
operator|)
condition|)
return|return;
name|HFC_BEG
expr_stmt|;
name|HFC_INIT
argument_list|(
name|sc
argument_list|,
name|chan
argument_list|,
name|bprot
argument_list|,
name|activate
argument_list|)
expr_stmt|;
name|HFC_END
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	Start transmission (B-channel or D-channel tx)  *	NOTE: if "chan" variable is corrupted, it will not cause any harm,  *	but data may be lost and there may be software sync. errors.  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|ihfc_B_start
parameter_list|(
name|int
name|unit
parameter_list|,
name|int
name|chan
parameter_list|)
block|{
name|ihfc_sc_t
modifier|*
name|sc
init|=
operator|&
name|ihfc_softc
index|[
name|unit
index|]
decl_stmt|;
name|HFC_VAR
expr_stmt|;
if|if
condition|(
operator|(
name|u_int
operator|)
name|chan
operator|>
literal|5
condition|)
return|return;
name|HFC_BEG
expr_stmt|;
if|if
condition|(
name|S_FILTER
operator|&&
operator|!
name|S_MBUF
operator|&&
operator|!
name|S_INTR_ACTIVE
condition|)
block|{
name|S_INTR_ACTIVE
operator||=
literal|2
expr_stmt|;
comment|/* never know what *                                          * they put in the *                                          * L2 code         */
name|S_FILTER
argument_list|(
name|sc
argument_list|,
name|chan
argument_list|)
expr_stmt|;
comment|/* quick tx */
name|S_INTR_ACTIVE
operator|&=
operator|~
literal|2
expr_stmt|;
block|}
name|HFC_END
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	Fill statistics struct (B-channel)  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|ihfc_B_stat
parameter_list|(
name|int
name|unit
parameter_list|,
name|int
name|chan
parameter_list|,
name|bchan_statistics_t
modifier|*
name|bsp
parameter_list|)
block|{
name|ihfc_sc_t
modifier|*
name|sc
init|=
operator|&
name|ihfc_softc
index|[
name|unit
index|]
decl_stmt|;
name|HFC_VAR
expr_stmt|;
if|if
condition|(
operator|(
name|u_int
operator|)
name|chan
operator|>
literal|5
condition|)
return|return;
name|chan
operator|&=
operator|~
literal|1
expr_stmt|;
name|HFC_BEG
expr_stmt|;
name|bsp
operator|->
name|inbytes
operator|=
name|S_BYTES
expr_stmt|;
name|S_BYTES
operator|=
literal|0
expr_stmt|;
name|chan
operator|++
expr_stmt|;
name|bsp
operator|->
name|outbytes
operator|=
name|S_BYTES
expr_stmt|;
name|S_BYTES
operator|=
literal|0
expr_stmt|;
name|HFC_END
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	Return the address of IHFC linktab to I4B (B-channel)  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|isdn_link_t
modifier|*
name|ihfc_B_ret_linktab
parameter_list|(
name|int
name|unit
parameter_list|,
name|int
name|channel
parameter_list|)
block|{
name|ihfc_sc_t
modifier|*
name|sc
init|=
operator|&
name|ihfc_softc
index|[
name|unit
index|]
decl_stmt|;
if|if
condition|(
name|channel
operator|<
literal|2
condition|)
return|return
operator|(
operator|&
name|sc
operator|->
name|sc_blinktab
index|[
name|channel
index|]
operator|)
return|;
else|else
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	Set the I4B driver linktab for IHFC use (B-channel)  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|ihfc_B_set_linktab
parameter_list|(
name|int
name|unit
parameter_list|,
name|int
name|channel
parameter_list|,
name|drvr_link_t
modifier|*
name|B_linktab
parameter_list|)
block|{
name|ihfc_sc_t
modifier|*
name|sc
init|=
operator|&
name|ihfc_softc
index|[
name|unit
index|]
decl_stmt|;
if|if
condition|(
name|channel
operator|<
literal|2
condition|)
name|sc
operator|->
name|sc_bdrvlinktab
index|[
name|channel
index|]
operator|=
name|B_linktab
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	Initialize linktab for I4B use (B-channel)  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|ihfc_B_linkinit
parameter_list|(
name|ihfc_sc_t
modifier|*
name|sc
parameter_list|)
block|{
name|u_char
name|chan
decl_stmt|;
comment|/* make sure the hardware driver is known to layer 4 */
name|ctrl_types
index|[
name|CTRL_PASSIVE
index|]
operator|.
name|set_linktab
operator|=
name|i4b_l1_set_linktab
expr_stmt|;
name|ctrl_types
index|[
name|CTRL_PASSIVE
index|]
operator|.
name|get_linktab
operator|=
name|i4b_l1_ret_linktab
expr_stmt|;
for|for
control|(
name|chan
operator|=
literal|2
init|;
name|chan
operator|<
literal|6
condition|;
name|chan
operator|++
control|)
block|{
name|S_BLINK
operator|.
name|unit
operator|=
name|S_UNIT
expr_stmt|;
name|S_BLINK
operator|.
name|channel
operator|=
name|chan
expr_stmt|;
comment|/* point to tx-chan */
name|S_BLINK
operator|.
name|bch_config
operator|=
name|ihfc_B_setup
expr_stmt|;
name|S_BLINK
operator|.
name|bch_tx_start
operator|=
name|ihfc_B_start
expr_stmt|;
name|S_BLINK
operator|.
name|bch_stat
operator|=
name|ihfc_B_stat
expr_stmt|;
comment|/* This is a transmit channel (even) */
name|S_BLINK
operator|.
name|tx_queue
operator|=
operator|&
name|S_IFQUEUE
expr_stmt|;
name|chan
operator|++
expr_stmt|;
comment|/* This is a receive channel (odd) */
name|S_BLINK
operator|.
name|rx_queue
operator|=
operator|&
name|S_IFQUEUE
expr_stmt|;
name|S_BLINK
operator|.
name|rx_mbuf
operator|=
operator|&
name|S_MBUFDUMMY
expr_stmt|;
block|}
block|}
end_function

end_unit


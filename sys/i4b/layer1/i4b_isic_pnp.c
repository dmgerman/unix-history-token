begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  *   Copyright (c) 1998 Eivind Eklund. All rights reserved.  *  *   Copyright (c) 1998 German Tischler. All rights reserved.  *  *   Copyright (c) 1998, 1999 Hellmuth Michaelis. All rights reserved.   *  *   Redistribution and use in source and binary forms, with or without  *   modification, are permitted provided that the following conditions  *   are met:  *  *   1. Redistributions of source code must retain the above copyright  *      notice, this list of conditions and the following disclaimer.  *   2. Redistributions in binary form must reproduce the above copyright  *      notice, this list of conditions and the following disclaimer in the  *      documentation and/or other materials provided with the distribution.  *   3. Neither the name of the author nor the names of any co-contributors  *      may be used to endorse or promote products derived from this software  *      without specific prior written permission.  *   4. Altered versions must be plainly marked as such, and must not be  *      misrepresented as being the original software and/or documentation.  *     *   THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  *   ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  *   IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  *   ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  *   FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  *   DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  *   OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  *   HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  *   LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  *   OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  *   SUCH DAMAGE.  *  *---------------------------------------------------------------------------  *  *	i4b_isic_pnp.c - i4b pnp support  *	--------------------------------  *  * $FreeBSD$  *  *      last edit-date: [Mon Jul  5 15:57:01 1999]  *  *---------------------------------------------------------------------------*/
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|__FreeBSD__
end_ifdef

begin_include
include|#
directive|include
file|"pnp.h"
end_include

begin_include
include|#
directive|include
file|"isic.h"
end_include

begin_include
include|#
directive|include
file|"opt_i4b.h"
end_include

begin_if
if|#
directive|if
name|NPNP
operator|>
literal|0
end_if

begin_warning
warning|#
directive|warning
literal|"Fix i4b pnp!"
end_warning

begin_undef
undef|#
directive|undef
name|NPNP
end_undef

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
operator|(
name|NISIC
operator|>
literal|0
operator|)
operator|&&
operator|(
name|NPNP
operator|>
literal|0
operator|)
end_if

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__FreeBSD__
argument_list|)
operator|&&
name|__FreeBSD__
operator|<
literal|3
end_if

begin_include
include|#
directive|include
file|"ioconf.h"
end_include

begin_function_decl
specifier|extern
name|void
name|isicintr
parameter_list|(
name|int
name|unit
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* XXX this gives a compiler warning */
end_comment

begin_comment
comment|/* on one 2.2.7 machine but no       */
end_comment

begin_comment
comment|/* warning on another one !? (-hm)   */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
operator|(
name|defined
argument_list|(
name|__FreeBSD_version
argument_list|)
operator|&&
name|__FreeBSD_version
operator|>=
literal|300006
operator|)
end_if

begin_function_decl
specifier|extern
name|void
name|isicintr
parameter_list|(
name|int
name|unit
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<machine/clock.h>
end_include

begin_include
include|#
directive|include
file|<i386/isa/isa_device.h>
end_include

begin_comment
comment|/* #include<i386/isa/pnp.h> */
end_comment

begin_include
include|#
directive|include
file|<i4b/include/i4b_global.h>
end_include

begin_include
include|#
directive|include
file|<machine/i4b_ioctl.h>
end_include

begin_include
include|#
directive|include
file|<i4b/layer1/i4b_l1.h>
end_include

begin_define
define|#
directive|define
name|VID_TEL163PNP
value|0x10212750
end_define

begin_comment
comment|/* Teles 16.3 PnP	*/
end_comment

begin_define
define|#
directive|define
name|VID_CREATIXPP
value|0x0000980e
end_define

begin_comment
comment|/* Creatix S0/16 P+P	*/
end_comment

begin_define
define|#
directive|define
name|VID_DYNALINK
value|0x88167506
end_define

begin_comment
comment|/* Dynalink		*/
end_comment

begin_define
define|#
directive|define
name|VID_SEDLBAUER
value|0x0100274c
end_define

begin_comment
comment|/* Sedlbauer WinSpeed	*/
end_comment

begin_define
define|#
directive|define
name|VID_NICCYGO
value|0x5001814c
end_define

begin_comment
comment|/* Neuhaus Niccy GO@	*/
end_comment

begin_define
define|#
directive|define
name|VID_ELSAQS1P
value|0x33019315
end_define

begin_comment
comment|/* ELSA Quickstep1000pro*/
end_comment

begin_define
define|#
directive|define
name|VID_ITK0025
value|0x25008b26
end_define

begin_comment
comment|/* ITK Ix1 Micro V3	*/
end_comment

begin_define
define|#
directive|define
name|VID_AVMPNP
value|0x0009cd06
end_define

begin_comment
comment|/* AVM Fritz! PnP	*/
end_comment

begin_define
define|#
directive|define
name|VID_SIESURF2
value|0x2000254d
end_define

begin_comment
comment|/* Siemens I-Surf 2.0 PnP*/
end_comment

begin_define
define|#
directive|define
name|VID_ASUSCOM_IPAC
value|0x90167506
end_define

begin_comment
comment|/* Asuscom (with IPAC)	*/
end_comment

begin_struct
specifier|static
struct|struct
name|i4b_pnp_ids
block|{
name|u_long
name|vend_id
decl_stmt|;
name|char
modifier|*
name|id_str
decl_stmt|;
block|}
name|i4b_pnp_ids
index|[]
init|=
block|{
block|{
name|VID_TEL163PNP
block|,
literal|"Teles 16.3 PnP"
block|}
block|,
block|{
name|VID_CREATIXPP
block|,
literal|"Creatix S0/16 P+P"
block|}
block|,
block|{
name|VID_DYNALINK
block|,
literal|"Dynalink IS64PH"
block|}
block|,
block|{
name|VID_SEDLBAUER
block|,
literal|"Sedlbauer WinSpeed"
block|}
block|,
block|{
name|VID_NICCYGO
block|,
literal|"Dr.Neuhaus Niccy Go@"
block|}
block|,
block|{
name|VID_ELSAQS1P
block|,
literal|"ELSA QuickStep 1000pro"
block|}
block|,
block|{
name|VID_ITK0025
block|,
literal|"ITK ix1 Micro V3.0"
block|}
block|,
block|{
name|VID_AVMPNP
block|,
literal|"AVM Fritz!Card PnP"
block|}
block|,
block|{
name|VID_SIESURF2
block|,
literal|"Siemens I-Surf 2.0 PnP"
block|}
block|,
block|{
name|VID_ASUSCOM_IPAC
block|,
literal|"Asuscom ISDNLink 128 PnP"
block|}
block|,
block|{
literal|0
block|}
block|}
struct|;
end_struct

begin_decl_stmt
specifier|extern
name|struct
name|isa_driver
name|isicdriver
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|int
name|isic_pnpprobe
parameter_list|(
name|struct
name|isa_device
modifier|*
name|dev
parameter_list|,
name|unsigned
name|int
name|iobase2
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|char
modifier|*
name|i4b_pnp_probe
parameter_list|(
name|u_long
name|csn
parameter_list|,
name|u_long
name|vend_id
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|i4b_pnp_attach
parameter_list|(
name|u_long
name|csn
parameter_list|,
name|u_long
name|vend_id
parameter_list|,
name|char
modifier|*
name|name
parameter_list|,
name|struct
name|isa_device
modifier|*
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|u_long
name|ni4b_pnp
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|pnp_device
name|i4b_pnp
init|=
block|{
literal|"i4b_pnp"
block|,
name|i4b_pnp_probe
block|,
name|i4b_pnp_attach
block|,
operator|&
name|ni4b_pnp
block|,
operator|&
name|net_imask
block|}
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DATA_SET
argument_list|(
name|pnpdevice_set
argument_list|,
name|i4b_pnp
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*---------------------------------------------------------------------------*  *	PnP probe routine  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|char
modifier|*
name|i4b_pnp_probe
parameter_list|(
name|u_long
name|csn
parameter_list|,
name|u_long
name|vend_id
parameter_list|)
block|{
name|struct
name|i4b_pnp_ids
modifier|*
name|ids
decl_stmt|;
name|char
modifier|*
name|string
init|=
name|NULL
decl_stmt|;
comment|/* search table of knowd id's */
for|for
control|(
name|ids
operator|=
name|i4b_pnp_ids
init|;
name|ids
operator|->
name|vend_id
operator|!=
literal|0
condition|;
name|ids
operator|++
control|)
block|{
if|if
condition|(
name|vend_id
operator|==
name|ids
operator|->
name|vend_id
condition|)
block|{
name|string
operator|=
name|ids
operator|->
name|id_str
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|string
condition|)
block|{
name|struct
name|pnp_cinfo
name|spci
decl_stmt|;
name|read_pnp_parms
argument_list|(
operator|&
name|spci
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|spci
operator|.
name|enable
operator|==
literal|0
operator|)
operator|||
operator|(
name|spci
operator|.
name|flags
operator|&
literal|0x01
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"CSN %d (%s) is disabled.\n"
argument_list|,
operator|(
name|int
operator|)
name|csn
argument_list|,
name|string
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
block|}
return|return
operator|(
name|string
operator|)
return|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	PnP attach routine  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|i4b_pnp_attach
parameter_list|(
name|u_long
name|csn
parameter_list|,
name|u_long
name|vend_id
parameter_list|,
name|char
modifier|*
name|name
parameter_list|,
name|struct
name|isa_device
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|pnp_cinfo
name|spci
decl_stmt|;
if|#
directive|if
operator|!
operator|(
operator|(
name|defined
argument_list|(
name|__FreeBSD_version
argument_list|)
operator|&&
name|__FreeBSD_version
operator|>=
literal|400004
operator|)
operator|)
name|struct
name|isa_device
modifier|*
name|isa_devp
decl_stmt|;
endif|#
directive|endif
if|if
condition|(
name|dev
operator|->
name|id_unit
operator|!=
name|next_isic_unit
condition|)
block|{
name|printf
argument_list|(
literal|"i4b_pnp_attach: Error: new unit (%d) != next_isic_unit (%d)!\n"
argument_list|,
name|dev
operator|->
name|id_unit
argument_list|,
name|next_isic_unit
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|dev
operator|->
name|id_unit
operator|>=
name|ISIC_MAXUNIT
condition|)
block|{
name|printf
argument_list|(
literal|"isic%d: Error, unit %d>= ISIC_MAXUNIT for %s\n"
argument_list|,
name|dev
operator|->
name|id_unit
argument_list|,
name|dev
operator|->
name|id_unit
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|read_pnp_parms
argument_list|(
operator|&
name|spci
argument_list|,
literal|0
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"isic%d: read_pnp_parms error for %s\n"
argument_list|,
name|dev
operator|->
name|id_unit
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|bootverbose
condition|)
block|{
name|printf
argument_list|(
literal|"isic%d: vendorid = 0x%08x port0 = 0x%04x, port1 = 0x%04x, irq = %d\n"
argument_list|,
name|dev
operator|->
name|id_unit
argument_list|,
name|spci
operator|.
name|vendor_id
argument_list|,
name|spci
operator|.
name|port
index|[
literal|0
index|]
argument_list|,
name|spci
operator|.
name|port
index|[
literal|1
index|]
argument_list|,
name|spci
operator|.
name|irq
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
name|dev
operator|->
name|id_iobase
operator|=
name|spci
operator|.
name|port
index|[
literal|0
index|]
expr_stmt|;
name|dev
operator|->
name|id_irq
operator|=
operator|(
literal|1
operator|<<
name|spci
operator|.
name|irq
index|[
literal|0
index|]
operator|)
expr_stmt|;
name|dev
operator|->
name|id_intr
operator|=
operator|(
name|inthand2_t
operator|*
operator|)
name|isicintr
expr_stmt|;
name|dev
operator|->
name|id_drq
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* XXX add dev->id_alive init here ! ?? */
switch|switch
condition|(
name|spci
operator|.
name|vendor_id
condition|)
block|{
case|case
name|VID_TEL163PNP
case|:
name|dev
operator|->
name|id_flags
operator|=
name|FLAG_TELES_S0_163_PnP
expr_stmt|;
break|break;
case|case
name|VID_CREATIXPP
case|:
name|dev
operator|->
name|id_flags
operator|=
name|FLAG_CREATIX_S0_PnP
expr_stmt|;
break|break;
case|case
name|VID_DYNALINK
case|:
name|dev
operator|->
name|id_flags
operator|=
name|FLAG_DYNALINK
expr_stmt|;
break|break;
case|case
name|VID_SEDLBAUER
case|:
name|dev
operator|->
name|id_flags
operator|=
name|FLAG_SWS
expr_stmt|;
break|break;
case|case
name|VID_NICCYGO
case|:
name|dev
operator|->
name|id_flags
operator|=
name|FLAG_DRN_NGO
expr_stmt|;
break|break;
case|case
name|VID_ELSAQS1P
case|:
name|dev
operator|->
name|id_flags
operator|=
name|FLAG_ELSA_QS1P_ISA
expr_stmt|;
break|break;
case|case
name|VID_ITK0025
case|:
name|dev
operator|->
name|id_flags
operator|=
name|FLAG_ITK_IX1
expr_stmt|;
break|break;
case|case
name|VID_AVMPNP
case|:
name|dev
operator|->
name|id_flags
operator|=
name|FLAG_AVM_PNP
expr_stmt|;
break|break;
case|case
name|VID_SIESURF2
case|:
name|dev
operator|->
name|id_flags
operator|=
name|FLAG_SIEMENS_ISURF2
expr_stmt|;
break|break;
case|case
name|VID_ASUSCOM_IPAC
case|:
name|dev
operator|->
name|id_flags
operator|=
name|FLAG_ASUSCOM_IPAC
expr_stmt|;
break|break;
block|}
name|write_pnp_parms
argument_list|(
operator|&
name|spci
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|enable_pnp_card
argument_list|()
expr_stmt|;
if|if
condition|(
name|dev
operator|->
name|id_driver
operator|==
name|NULL
condition|)
block|{
name|dev
operator|->
name|id_driver
operator|=
operator|&
name|isicdriver
expr_stmt|;
if|#
directive|if
operator|(
name|defined
argument_list|(
name|__FreeBSD_version
argument_list|)
operator|&&
name|__FreeBSD_version
operator|>=
literal|400004
operator|)
name|dev
operator|->
name|id_id
operator|=
name|isa_compat_nextid
argument_list|()
expr_stmt|;
else|#
directive|else
name|isa_devp
operator|=
name|find_isadev
argument_list|(
name|isa_devtab_net
argument_list|,
operator|&
name|isicdriver
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|isa_devp
operator|!=
name|NULL
condition|)
block|{
name|dev
operator|->
name|id_id
operator|=
name|isa_devp
operator|->
name|id_id
expr_stmt|;
block|}
endif|#
directive|endif
block|}
if|if
condition|(
operator|(
name|dev
operator|->
name|id_alive
operator|=
name|isic_pnpprobe
argument_list|(
name|dev
argument_list|,
name|spci
operator|.
name|port
index|[
literal|1
index|]
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
comment|/* XXX dev->id_alive is the size of the port area used ! */
name|isic_realattach
argument_list|(
name|dev
argument_list|,
name|spci
operator|.
name|port
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"isic%d: probe failed!\n"
argument_list|,
name|dev
operator|->
name|id_unit
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	isic - pnp device driver probe routine  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|int
name|isic_pnpprobe
parameter_list|(
name|struct
name|isa_device
modifier|*
name|dev
parameter_list|,
name|unsigned
name|int
name|iobase2
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|dev
operator|->
name|id_flags
condition|)
block|{
ifdef|#
directive|ifdef
name|TEL_S0_16_3_P
case|case
name|FLAG_TELES_S0_163_PnP
case|:
name|ret
operator|=
name|isic_probe_s0163P
argument_list|(
name|dev
argument_list|,
name|iobase2
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|CRTX_S0_P
case|case
name|FLAG_CREATIX_S0_PnP
case|:
name|ret
operator|=
name|isic_probe_Cs0P
argument_list|(
name|dev
argument_list|,
name|iobase2
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|DRN_NGO
case|case
name|FLAG_DRN_NGO
case|:
name|ret
operator|=
name|isic_probe_drnngo
argument_list|(
name|dev
argument_list|,
name|iobase2
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|SEDLBAUER
case|case
name|FLAG_SWS
case|:
name|ret
operator|=
literal|8
expr_stmt|;
comment|/* pnp only, nothing to probe */
break|break;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|DYNALINK
case|case
name|FLAG_DYNALINK
case|:
name|ret
operator|=
name|isic_probe_Dyn
argument_list|(
name|dev
argument_list|,
name|iobase2
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|ELSA_QS1ISA
case|case
name|FLAG_ELSA_QS1P_ISA
case|:
name|ret
operator|=
name|isic_probe_Eqs1pi
argument_list|(
name|dev
argument_list|,
name|iobase2
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|ITKIX1
case|case
name|FLAG_ITK_IX1
case|:
name|ret
operator|=
name|isic_probe_itkix1
argument_list|(
name|dev
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|AVM_PNP
case|case
name|FLAG_AVM_PNP
case|:
name|ret
operator|=
name|isic_probe_avm_pnp
argument_list|(
name|dev
argument_list|,
name|iobase2
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|SIEMENS_ISURF2
case|case
name|FLAG_SIEMENS_ISURF2
case|:
name|ret
operator|=
name|isic_probe_siemens_isurf
argument_list|(
name|dev
argument_list|,
name|iobase2
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|ASUSCOM_IPAC
case|case
name|FLAG_ASUSCOM_IPAC
case|:
name|ret
operator|=
name|isic_probe_asi
argument_list|(
name|dev
argument_list|,
name|iobase2
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
break|break;
block|}
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* (NISIC> 0)&& (NPNP> 0) */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* __FreeBSD__ */
end_comment

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  *   Copyright (c) 1997, 1998 Martin Husemann. All rights reserved.  *  *   Redistribution and use in source and binary forms, with or without  *   modification, are permitted provided that the following conditions  *   are met:  *  *   1. Redistributions of source code must retain the above copyright  *      notice, this list of conditions and the following disclaimer.  *   2. Redistributions in binary form must reproduce the above copyright  *      notice, this list of conditions and the following disclaimer in the  *      documentation and/or other materials provided with the distribution.  *   3. Neither the name of the author nor the names of any co-contributors  *      may be used to endorse or promote products derived from this software  *      without specific prior written permission.  *   4. Altered versions must be plainly marked as such, and must not be  *      misrepresented as being the original software and/or documentation.  *     *   THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  *   ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  *   IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  *   ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  *   FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  *   DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  *   OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  *   HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  *   LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  *   OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  *   SUCH DAMAGE.  *  *---------------------------------------------------------------------------  *  *	isa_isic.c - ISA bus frontend for i4b_isic driver  *	--------------------------------------------------  *  * $FreeBSD$   *  *      last edit-date: [Mon Dec 14 10:53:16 1998]  *  *	-mh	original implementation  *      -hm     NetBSD patches from Martin  *  *---------------------------------------------------------------------------*/
end_comment

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/errno.h>
end_include

begin_include
include|#
directive|include
file|<sys/syslog.h>
end_include

begin_include
include|#
directive|include
file|<sys/device.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<machine/cpu.h>
end_include

begin_include
include|#
directive|include
file|<machine/intr.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<dev/isa/isavar.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|__FreeBSD__
end_ifdef

begin_include
include|#
directive|include
file|<machine/i4b_ioctl.h>
end_include

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<i4b/i4b_ioctl.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<i4b/layer1/i4b_l1.h>
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__OpenBSD__
argument_list|)
end_if

begin_define
define|#
directive|define
name|__BROKEN_INDIRECT_CONFIG
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* local functions */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|__BROKEN_INDIRECT_CONFIG
end_ifdef

begin_decl_stmt
specifier|static
name|int
name|isa_isic_probe
name|__P
argument_list|(
operator|(
expr|struct
name|device
operator|*
operator|,
name|void
operator|*
operator|,
name|void
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_else
else|#
directive|else
end_else

begin_decl_stmt
specifier|static
name|int
name|isa_isic_probe
name|__P
argument_list|(
operator|(
expr|struct
name|device
operator|*
operator|,
expr|struct
name|cfdata
operator|*
operator|,
name|void
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|static
name|void
name|isa_isic_attach
name|__P
argument_list|(
operator|(
expr|struct
name|device
operator|*
operator|,
expr|struct
name|device
operator|*
operator|,
name|void
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|setup_io_map
name|__P
argument_list|(
operator|(
name|int
name|flags
operator|,
name|bus_space_tag_t
name|iot
operator|,
name|bus_space_tag_t
name|memt
operator|,
name|bus_size_t
name|iobase
operator|,
name|bus_size_t
name|maddr
operator|,
name|int
operator|*
name|num_mappings
operator|,
expr|struct
name|isic_io_map
operator|*
name|maps
operator|,
name|int
operator|*
name|iosize
operator|,
name|int
operator|*
name|msize
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|args_unmap
name|__P
argument_list|(
operator|(
name|int
operator|*
name|num_mappings
operator|,
expr|struct
name|isic_io_map
operator|*
name|maps
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|cfattach
name|isa_isic_ca
init|=
block|{
sizeof|sizeof
argument_list|(
expr|struct
name|isic_softc
argument_list|)
block|,
name|isa_isic_probe
block|,
name|isa_isic_attach
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Probe card  */
end_comment

begin_function
specifier|static
name|int
ifdef|#
directive|ifdef
name|__BROKEN_INDIRECT_CONFIG
name|isa_isic_probe
parameter_list|(
name|parent
parameter_list|,
name|match
parameter_list|,
name|aux
parameter_list|)
else|#
directive|else
function|isa_isic_probe
parameter_list|(
name|parent
parameter_list|,
name|cf
parameter_list|,
name|aux
parameter_list|)
endif|#
directive|endif
name|struct
name|device
modifier|*
name|parent
decl_stmt|;
ifdef|#
directive|ifdef
name|__BROKEN_INDIRECT_CONFIG
name|void
modifier|*
name|match
decl_stmt|;
else|#
directive|else
name|struct
name|cfdata
modifier|*
name|cf
decl_stmt|;
endif|#
directive|endif
name|void
modifier|*
name|aux
decl_stmt|;
block|{
ifdef|#
directive|ifdef
name|__BROKEN_INDIRECT_CONFIG
name|struct
name|cfdata
modifier|*
name|cf
init|=
operator|(
operator|(
expr|struct
name|device
operator|*
operator|)
name|match
operator|)
operator|->
name|dv_cfdata
decl_stmt|;
endif|#
directive|endif
name|struct
name|isa_attach_args
modifier|*
name|ia
init|=
name|aux
decl_stmt|;
name|bus_space_tag_t
name|memt
init|=
name|ia
operator|->
name|ia_memt
decl_stmt|,
name|iot
init|=
name|ia
operator|->
name|ia_iot
decl_stmt|;
name|int
name|flags
init|=
name|cf
operator|->
name|cf_flags
decl_stmt|;
name|struct
name|isic_attach_args
name|args
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
comment|/* check irq */
if|if
condition|(
name|ia
operator|->
name|ia_irq
operator|==
name|IRQUNK
condition|)
block|{
name|printf
argument_list|(
literal|"isic%d: config error: no IRQ specified\n"
argument_list|,
name|cf
operator|->
name|cf_unit
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* setup MI attach args */
name|bzero
argument_list|(
operator|&
name|args
argument_list|,
sizeof|sizeof
argument_list|(
name|args
argument_list|)
argument_list|)
expr_stmt|;
name|args
operator|.
name|ia_flags
operator|=
name|flags
expr_stmt|;
comment|/* if card type specified setup io map for that card */
switch|switch
condition|(
name|flags
condition|)
block|{
case|case
name|FLAG_TELES_S0_8
case|:
case|case
name|FLAG_TELES_S0_16
case|:
case|case
name|FLAG_TELES_S0_163
case|:
case|case
name|FLAG_AVM_A1
case|:
case|case
name|FLAG_USR_ISDN_TA_INT
case|:
case|case
name|FLAG_ITK_IX1
case|:
if|if
condition|(
name|setup_io_map
argument_list|(
name|flags
argument_list|,
name|iot
argument_list|,
name|memt
argument_list|,
name|ia
operator|->
name|ia_iobase
argument_list|,
name|ia
operator|->
name|ia_maddr
argument_list|,
operator|&
name|args
operator|.
name|ia_num_mappings
argument_list|,
operator|&
name|args
operator|.
name|ia_maps
index|[
literal|0
index|]
argument_list|,
operator|&
operator|(
name|ia
operator|->
name|ia_iosize
operator|)
argument_list|,
operator|&
name|ia
operator|->
name|ia_msize
argument_list|)
condition|)
block|{
name|ret
operator|=
literal|0
expr_stmt|;
goto|goto
name|done
goto|;
block|}
break|break;
default|default:
comment|/* no io map now, will figure card type later */
break|break;
block|}
comment|/* probe card */
switch|switch
condition|(
name|flags
condition|)
block|{
ifdef|#
directive|ifdef
name|DYNALINK
case|case
name|FLAG_DYNALINK
case|:
name|ret
operator|=
name|isic_probe_Dyn
argument_list|(
operator|&
name|args
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|TEL_S0_8
case|case
name|FLAG_TELES_S0_8
case|:
name|ret
operator|=
name|isic_probe_s08
argument_list|(
operator|&
name|args
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|TEL_S0_16
case|case
name|FLAG_TELES_S0_16
case|:
name|ret
operator|=
name|isic_probe_s016
argument_list|(
operator|&
name|args
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|TEL_S0_16_3
case|case
name|FLAG_TELES_S0_163
case|:
name|ret
operator|=
name|isic_probe_s0163
argument_list|(
operator|&
name|args
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|AVM_A1
case|case
name|FLAG_AVM_A1
case|:
name|ret
operator|=
name|isic_probe_avma1
argument_list|(
operator|&
name|args
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|USR_STI
case|case
name|FLAG_USR_ISDN_TA_INT
case|:
name|ret
operator|=
name|isic_probe_usrtai
argument_list|(
operator|&
name|args
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|ITKIX1
case|case
name|FLAG_ITK_IX1
case|:
name|ret
operator|=
name|isic_probe_itkix1
argument_list|(
operator|&
name|args
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
comment|/* No card type given, try to figure ... */
if|if
condition|(
name|ia
operator|->
name|ia_iobase
operator|==
name|IOBASEUNK
condition|)
block|{
name|ret
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|TEL_S0_8
comment|/* only Teles S0/8 will work without IO */
name|args
operator|.
name|ia_flags
operator|=
name|FLAG_TELES_S0_8
expr_stmt|;
if|if
condition|(
name|setup_io_map
argument_list|(
name|args
operator|.
name|ia_flags
argument_list|,
name|iot
argument_list|,
name|memt
argument_list|,
name|ia
operator|->
name|ia_iobase
argument_list|,
name|ia
operator|->
name|ia_maddr
argument_list|,
operator|&
name|args
operator|.
name|ia_num_mappings
argument_list|,
operator|&
name|args
operator|.
name|ia_maps
index|[
literal|0
index|]
argument_list|,
operator|&
operator|(
name|ia
operator|->
name|ia_iosize
operator|)
argument_list|,
operator|&
operator|(
name|ia
operator|->
name|ia_msize
operator|)
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ret
operator|=
name|isic_probe_s08
argument_list|(
operator|&
name|args
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* TEL_S0_8 */
block|}
elseif|else
if|if
condition|(
name|ia
operator|->
name|ia_maddr
operator|==
name|MADDRUNK
condition|)
block|{
name|ret
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|TEL_S0_16_3
comment|/* no shared memory, only a 16.3 based card, 				   AVM A1, the usr sportster or an ITK would work */
name|args
operator|.
name|ia_flags
operator|=
name|FLAG_TELES_S0_163
expr_stmt|;
if|if
condition|(
name|setup_io_map
argument_list|(
name|args
operator|.
name|ia_flags
argument_list|,
name|iot
argument_list|,
name|memt
argument_list|,
name|ia
operator|->
name|ia_iobase
argument_list|,
name|ia
operator|->
name|ia_maddr
argument_list|,
operator|&
name|args
operator|.
name|ia_num_mappings
argument_list|,
operator|&
name|args
operator|.
name|ia_maps
index|[
literal|0
index|]
argument_list|,
operator|&
operator|(
name|ia
operator|->
name|ia_iosize
operator|)
argument_list|,
operator|&
operator|(
name|ia
operator|->
name|ia_msize
operator|)
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ret
operator|=
name|isic_probe_s0163
argument_list|(
operator|&
name|args
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
break|break;
block|}
endif|#
directive|endif
comment|/* TEL_S0_16_3 */
ifdef|#
directive|ifdef
name|AVM_A1
name|args_unmap
argument_list|(
operator|&
name|args
operator|.
name|ia_num_mappings
argument_list|,
operator|&
name|args
operator|.
name|ia_maps
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|args
operator|.
name|ia_flags
operator|=
name|FLAG_AVM_A1
expr_stmt|;
if|if
condition|(
name|setup_io_map
argument_list|(
name|args
operator|.
name|ia_flags
argument_list|,
name|iot
argument_list|,
name|memt
argument_list|,
name|ia
operator|->
name|ia_iobase
argument_list|,
name|ia
operator|->
name|ia_maddr
argument_list|,
operator|&
name|args
operator|.
name|ia_num_mappings
argument_list|,
operator|&
name|args
operator|.
name|ia_maps
index|[
literal|0
index|]
argument_list|,
operator|&
operator|(
name|ia
operator|->
name|ia_iosize
operator|)
argument_list|,
operator|&
operator|(
name|ia
operator|->
name|ia_msize
operator|)
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ret
operator|=
name|isic_probe_avma1
argument_list|(
operator|&
name|args
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
break|break;
block|}
endif|#
directive|endif
comment|/* AVM_A1 */
ifdef|#
directive|ifdef
name|USR_STI
name|args_unmap
argument_list|(
operator|&
name|args
operator|.
name|ia_num_mappings
argument_list|,
operator|&
name|args
operator|.
name|ia_maps
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|args
operator|.
name|ia_flags
operator|=
name|FLAG_USR_ISDN_TA_INT
expr_stmt|;
if|if
condition|(
name|setup_io_map
argument_list|(
name|args
operator|.
name|ia_flags
argument_list|,
name|iot
argument_list|,
name|memt
argument_list|,
name|ia
operator|->
name|ia_iobase
argument_list|,
name|ia
operator|->
name|ia_maddr
argument_list|,
operator|&
name|args
operator|.
name|ia_num_mappings
argument_list|,
operator|&
name|args
operator|.
name|ia_maps
index|[
literal|0
index|]
argument_list|,
operator|&
operator|(
name|ia
operator|->
name|ia_iosize
operator|)
argument_list|,
operator|&
operator|(
name|ia
operator|->
name|ia_msize
operator|)
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ret
operator|=
name|isic_probe_usrtai
argument_list|(
operator|&
name|args
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
break|break;
block|}
endif|#
directive|endif
comment|/* USR_STI */
ifdef|#
directive|ifdef
name|ITKIX1
name|args_unmap
argument_list|(
operator|&
name|args
operator|.
name|ia_num_mappings
argument_list|,
operator|&
name|args
operator|.
name|ia_maps
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|args
operator|.
name|ia_flags
operator|=
name|FLAG_ITK_IX1
expr_stmt|;
if|if
condition|(
name|setup_io_map
argument_list|(
name|args
operator|.
name|ia_flags
argument_list|,
name|iot
argument_list|,
name|memt
argument_list|,
name|ia
operator|->
name|ia_iobase
argument_list|,
name|ia
operator|->
name|ia_maddr
argument_list|,
operator|&
name|args
operator|.
name|ia_num_mappings
argument_list|,
operator|&
name|args
operator|.
name|ia_maps
index|[
literal|0
index|]
argument_list|,
operator|&
operator|(
name|ia
operator|->
name|ia_iosize
operator|)
argument_list|,
operator|&
operator|(
name|ia
operator|->
name|ia_msize
operator|)
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ret
operator|=
name|isic_probe_itkix1
argument_list|(
operator|&
name|args
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
break|break;
block|}
endif|#
directive|endif
comment|/* ITKIX1 */
block|}
else|else
block|{
ifdef|#
directive|ifdef
name|TEL_S0_16_3
comment|/* could be anything */
name|args
operator|.
name|ia_flags
operator|=
name|FLAG_TELES_S0_163
expr_stmt|;
if|if
condition|(
name|setup_io_map
argument_list|(
name|args
operator|.
name|ia_flags
argument_list|,
name|iot
argument_list|,
name|memt
argument_list|,
name|ia
operator|->
name|ia_iobase
argument_list|,
name|ia
operator|->
name|ia_maddr
argument_list|,
operator|&
name|args
operator|.
name|ia_num_mappings
argument_list|,
operator|&
name|args
operator|.
name|ia_maps
index|[
literal|0
index|]
argument_list|,
operator|&
operator|(
name|ia
operator|->
name|ia_iosize
operator|)
argument_list|,
operator|&
operator|(
name|ia
operator|->
name|ia_msize
operator|)
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ret
operator|=
name|isic_probe_s0163
argument_list|(
operator|&
name|args
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
break|break;
block|}
endif|#
directive|endif
comment|/* TEL_S0_16_3 */
ifdef|#
directive|ifdef
name|TEL_S0_16
name|args_unmap
argument_list|(
operator|&
name|args
operator|.
name|ia_num_mappings
argument_list|,
operator|&
name|args
operator|.
name|ia_maps
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|args
operator|.
name|ia_flags
operator|=
name|FLAG_TELES_S0_16
expr_stmt|;
if|if
condition|(
name|setup_io_map
argument_list|(
name|args
operator|.
name|ia_flags
argument_list|,
name|iot
argument_list|,
name|memt
argument_list|,
name|ia
operator|->
name|ia_iobase
argument_list|,
name|ia
operator|->
name|ia_maddr
argument_list|,
operator|&
name|args
operator|.
name|ia_num_mappings
argument_list|,
operator|&
name|args
operator|.
name|ia_maps
index|[
literal|0
index|]
argument_list|,
operator|&
operator|(
name|ia
operator|->
name|ia_iosize
operator|)
argument_list|,
operator|&
operator|(
name|ia
operator|->
name|ia_msize
operator|)
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ret
operator|=
name|isic_probe_s016
argument_list|(
operator|&
name|args
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
break|break;
block|}
endif|#
directive|endif
comment|/* TEL_S0_16 */
ifdef|#
directive|ifdef
name|AVM_A1
name|args_unmap
argument_list|(
operator|&
name|args
operator|.
name|ia_num_mappings
argument_list|,
operator|&
name|args
operator|.
name|ia_maps
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|args
operator|.
name|ia_flags
operator|=
name|FLAG_AVM_A1
expr_stmt|;
if|if
condition|(
name|setup_io_map
argument_list|(
name|args
operator|.
name|ia_flags
argument_list|,
name|iot
argument_list|,
name|memt
argument_list|,
name|ia
operator|->
name|ia_iobase
argument_list|,
name|ia
operator|->
name|ia_maddr
argument_list|,
operator|&
name|args
operator|.
name|ia_num_mappings
argument_list|,
operator|&
name|args
operator|.
name|ia_maps
index|[
literal|0
index|]
argument_list|,
operator|&
operator|(
name|ia
operator|->
name|ia_iosize
operator|)
argument_list|,
operator|&
operator|(
name|ia
operator|->
name|ia_msize
operator|)
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ret
operator|=
name|isic_probe_avma1
argument_list|(
operator|&
name|args
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
break|break;
block|}
endif|#
directive|endif
comment|/* AVM_A1 */
ifdef|#
directive|ifdef
name|TEL_S0_8
name|args_unmap
argument_list|(
operator|&
name|args
operator|.
name|ia_num_mappings
argument_list|,
operator|&
name|args
operator|.
name|ia_maps
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|args
operator|.
name|ia_flags
operator|=
name|FLAG_TELES_S0_8
expr_stmt|;
if|if
condition|(
name|setup_io_map
argument_list|(
name|args
operator|.
name|ia_flags
argument_list|,
name|iot
argument_list|,
name|memt
argument_list|,
name|ia
operator|->
name|ia_iobase
argument_list|,
name|ia
operator|->
name|ia_maddr
argument_list|,
operator|&
name|args
operator|.
name|ia_num_mappings
argument_list|,
operator|&
name|args
operator|.
name|ia_maps
index|[
literal|0
index|]
argument_list|,
operator|&
operator|(
name|ia
operator|->
name|ia_iosize
operator|)
argument_list|,
operator|&
operator|(
name|ia
operator|->
name|ia_msize
operator|)
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ret
operator|=
name|isic_probe_s08
argument_list|(
operator|&
name|args
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* TEL_S0_8 */
block|}
break|break;
block|}
name|done
label|:
comment|/* unmap resources */
name|args_unmap
argument_list|(
operator|&
name|args
operator|.
name|ia_num_mappings
argument_list|,
operator|&
name|args
operator|.
name|ia_maps
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*  * Attach the card  */
end_comment

begin_function
specifier|static
name|void
name|isa_isic_attach
parameter_list|(
name|parent
parameter_list|,
name|self
parameter_list|,
name|aux
parameter_list|)
name|struct
name|device
modifier|*
name|parent
decl_stmt|,
decl|*
name|self
decl_stmt|;
end_function

begin_decl_stmt
name|void
modifier|*
name|aux
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|isic_softc
modifier|*
name|sc
init|=
operator|(
name|void
operator|*
operator|)
name|self
decl_stmt|;
name|struct
name|isa_attach_args
modifier|*
name|ia
init|=
name|aux
decl_stmt|;
name|int
name|flags
init|=
name|sc
operator|->
name|sc_dev
operator|.
name|dv_cfdata
operator|->
name|cf_flags
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|struct
name|isic_attach_args
name|args
decl_stmt|;
comment|/* Setup parameters */
name|sc
operator|->
name|sc_unit
operator|=
name|sc
operator|->
name|sc_dev
operator|.
name|dv_unit
expr_stmt|;
name|sc
operator|->
name|sc_irq
operator|=
name|ia
operator|->
name|ia_irq
expr_stmt|;
name|sc
operator|->
name|sc_maddr
operator|=
name|ia
operator|->
name|ia_maddr
expr_stmt|;
name|sc
operator|->
name|sc_num_mappings
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_maps
operator|=
name|NULL
expr_stmt|;
switch|switch
condition|(
name|flags
condition|)
block|{
case|case
name|FLAG_TELES_S0_8
case|:
case|case
name|FLAG_TELES_S0_16
case|:
case|case
name|FLAG_TELES_S0_163
case|:
case|case
name|FLAG_AVM_A1
case|:
case|case
name|FLAG_USR_ISDN_TA_INT
case|:
name|setup_io_map
argument_list|(
name|flags
argument_list|,
name|ia
operator|->
name|ia_iot
argument_list|,
name|ia
operator|->
name|ia_memt
argument_list|,
name|ia
operator|->
name|ia_iobase
argument_list|,
name|ia
operator|->
name|ia_maddr
argument_list|,
operator|&
operator|(
name|sc
operator|->
name|sc_num_mappings
operator|)
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|MALLOC_MAPS
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|setup_io_map
argument_list|(
name|flags
argument_list|,
name|ia
operator|->
name|ia_iot
argument_list|,
name|ia
operator|->
name|ia_memt
argument_list|,
name|ia
operator|->
name|ia_iobase
argument_list|,
name|ia
operator|->
name|ia_maddr
argument_list|,
operator|&
operator|(
name|sc
operator|->
name|sc_num_mappings
operator|)
argument_list|,
operator|&
operator|(
name|sc
operator|->
name|sc_maps
index|[
literal|0
index|]
operator|)
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|/* No card type given, try to figure ... */
comment|/* setup MI attach args */
name|bzero
argument_list|(
operator|&
name|args
argument_list|,
sizeof|sizeof
argument_list|(
name|args
argument_list|)
argument_list|)
expr_stmt|;
name|args
operator|.
name|ia_flags
operator|=
name|flags
expr_stmt|;
comment|/* Probe cards */
if|if
condition|(
name|ia
operator|->
name|ia_iobase
operator|==
name|IOBASEUNK
condition|)
block|{
name|ret
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|TEL_S0_8
comment|/* only Teles S0/8 will work without IO */
name|args
operator|.
name|ia_flags
operator|=
name|FLAG_TELES_S0_8
expr_stmt|;
name|setup_io_map
argument_list|(
name|args
operator|.
name|ia_flags
argument_list|,
name|ia
operator|->
name|ia_iot
argument_list|,
name|ia
operator|->
name|ia_memt
argument_list|,
name|ia
operator|->
name|ia_iobase
argument_list|,
name|ia
operator|->
name|ia_maddr
argument_list|,
operator|&
name|args
operator|.
name|ia_num_mappings
argument_list|,
operator|&
name|args
operator|.
name|ia_maps
index|[
literal|0
index|]
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ret
operator|=
name|isic_probe_s08
argument_list|(
operator|&
name|args
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|found
goto|;
name|args_unmap
argument_list|(
operator|&
name|args
operator|.
name|ia_num_mappings
argument_list|,
operator|&
name|args
operator|.
name|ia_maps
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* TEL_S0_8 */
block|}
elseif|else
if|if
condition|(
name|ia
operator|->
name|ia_maddr
operator|==
name|MADDRUNK
condition|)
block|{
comment|/* no shared memory, only a 16.3 based card, 				   AVM A1, the usr sportster or an ITK would work */
name|ret
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|TEL_S0_16_3
name|args
operator|.
name|ia_flags
operator|=
name|FLAG_TELES_S0_163
expr_stmt|;
name|setup_io_map
argument_list|(
name|args
operator|.
name|ia_flags
argument_list|,
name|ia
operator|->
name|ia_iot
argument_list|,
name|ia
operator|->
name|ia_memt
argument_list|,
name|ia
operator|->
name|ia_iobase
argument_list|,
name|ia
operator|->
name|ia_maddr
argument_list|,
operator|&
name|args
operator|.
name|ia_num_mappings
argument_list|,
operator|&
name|args
operator|.
name|ia_maps
index|[
literal|0
index|]
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ret
operator|=
name|isic_probe_s0163
argument_list|(
operator|&
name|args
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|found
goto|;
name|args_unmap
argument_list|(
operator|&
name|args
operator|.
name|ia_num_mappings
argument_list|,
operator|&
name|args
operator|.
name|ia_maps
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* TEL_S0_16_3 */
ifdef|#
directive|ifdef
name|AVM_A1
name|args
operator|.
name|ia_flags
operator|=
name|FLAG_AVM_A1
expr_stmt|;
name|setup_io_map
argument_list|(
name|args
operator|.
name|ia_flags
argument_list|,
name|ia
operator|->
name|ia_iot
argument_list|,
name|ia
operator|->
name|ia_memt
argument_list|,
name|ia
operator|->
name|ia_iobase
argument_list|,
name|ia
operator|->
name|ia_maddr
argument_list|,
operator|&
name|args
operator|.
name|ia_num_mappings
argument_list|,
operator|&
name|args
operator|.
name|ia_maps
index|[
literal|0
index|]
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ret
operator|=
name|isic_probe_avma1
argument_list|(
operator|&
name|args
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|found
goto|;
name|args_unmap
argument_list|(
operator|&
name|args
operator|.
name|ia_num_mappings
argument_list|,
operator|&
name|args
operator|.
name|ia_maps
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* AVM_A1 */
ifdef|#
directive|ifdef
name|USR_STI
name|args
operator|.
name|ia_flags
operator|=
name|FLAG_USR_ISDN_TA_INT
expr_stmt|;
name|setup_io_map
argument_list|(
name|args
operator|.
name|ia_flags
argument_list|,
name|ia
operator|->
name|ia_iot
argument_list|,
name|ia
operator|->
name|ia_memt
argument_list|,
name|ia
operator|->
name|ia_iobase
argument_list|,
name|ia
operator|->
name|ia_maddr
argument_list|,
operator|&
name|args
operator|.
name|ia_num_mappings
argument_list|,
operator|&
name|args
operator|.
name|ia_maps
index|[
literal|0
index|]
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ret
operator|=
name|isic_probe_usrtai
argument_list|(
operator|&
name|args
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|found
goto|;
name|args_unmap
argument_list|(
operator|&
name|args
operator|.
name|ia_num_mappings
argument_list|,
operator|&
name|args
operator|.
name|ia_maps
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* USR_STI */
ifdef|#
directive|ifdef
name|ITKIX1
name|args
operator|.
name|ia_flags
operator|=
name|FLAG_ITK_IX1
expr_stmt|;
name|setup_io_map
argument_list|(
name|args
operator|.
name|ia_flags
argument_list|,
name|ia
operator|->
name|ia_iot
argument_list|,
name|ia
operator|->
name|ia_memt
argument_list|,
name|ia
operator|->
name|ia_iobase
argument_list|,
name|ia
operator|->
name|ia_maddr
argument_list|,
operator|&
name|args
operator|.
name|ia_num_mappings
argument_list|,
operator|&
name|args
operator|.
name|ia_maps
index|[
literal|0
index|]
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ret
operator|=
name|isic_probe_itkix1
argument_list|(
operator|&
name|args
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|found
goto|;
name|args_unmap
argument_list|(
operator|&
name|args
operator|.
name|ia_num_mappings
argument_list|,
operator|&
name|args
operator|.
name|ia_maps
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* ITKIX1 */
block|}
else|else
block|{
comment|/* could be anything */
name|ret
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|TEL_S0_16_3
name|args
operator|.
name|ia_flags
operator|=
name|FLAG_TELES_S0_163
expr_stmt|;
name|setup_io_map
argument_list|(
name|args
operator|.
name|ia_flags
argument_list|,
name|ia
operator|->
name|ia_iot
argument_list|,
name|ia
operator|->
name|ia_memt
argument_list|,
name|ia
operator|->
name|ia_iobase
argument_list|,
name|ia
operator|->
name|ia_maddr
argument_list|,
operator|&
name|args
operator|.
name|ia_num_mappings
argument_list|,
operator|&
name|args
operator|.
name|ia_maps
index|[
literal|0
index|]
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ret
operator|=
name|isic_probe_s0163
argument_list|(
operator|&
name|args
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|found
goto|;
name|args_unmap
argument_list|(
operator|&
name|args
operator|.
name|ia_num_mappings
argument_list|,
operator|&
name|args
operator|.
name|ia_maps
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* TEL_S0_16_3 */
ifdef|#
directive|ifdef
name|TEL_S0_16
name|args
operator|.
name|ia_flags
operator|=
name|FLAG_TELES_S0_16
expr_stmt|;
name|setup_io_map
argument_list|(
name|args
operator|.
name|ia_flags
argument_list|,
name|ia
operator|->
name|ia_iot
argument_list|,
name|ia
operator|->
name|ia_memt
argument_list|,
name|ia
operator|->
name|ia_iobase
argument_list|,
name|ia
operator|->
name|ia_maddr
argument_list|,
operator|&
name|args
operator|.
name|ia_num_mappings
argument_list|,
operator|&
name|args
operator|.
name|ia_maps
index|[
literal|0
index|]
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ret
operator|=
name|isic_probe_s016
argument_list|(
operator|&
name|args
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|found
goto|;
name|args_unmap
argument_list|(
operator|&
name|args
operator|.
name|ia_num_mappings
argument_list|,
operator|&
name|args
operator|.
name|ia_maps
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* TEL_S0_16 */
ifdef|#
directive|ifdef
name|AVM_A1
name|args
operator|.
name|ia_flags
operator|=
name|FLAG_AVM_A1
expr_stmt|;
name|setup_io_map
argument_list|(
name|args
operator|.
name|ia_flags
argument_list|,
name|ia
operator|->
name|ia_iot
argument_list|,
name|ia
operator|->
name|ia_memt
argument_list|,
name|ia
operator|->
name|ia_iobase
argument_list|,
name|ia
operator|->
name|ia_maddr
argument_list|,
operator|&
name|args
operator|.
name|ia_num_mappings
argument_list|,
operator|&
name|args
operator|.
name|ia_maps
index|[
literal|0
index|]
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ret
operator|=
name|isic_probe_avma1
argument_list|(
operator|&
name|args
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|found
goto|;
name|args_unmap
argument_list|(
operator|&
name|args
operator|.
name|ia_num_mappings
argument_list|,
operator|&
name|args
operator|.
name|ia_maps
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* AVM_A1 */
ifdef|#
directive|ifdef
name|TEL_S0_8
name|args
operator|.
name|ia_flags
operator|=
name|FLAG_TELES_S0_8
expr_stmt|;
name|setup_io_map
argument_list|(
name|args
operator|.
name|ia_flags
argument_list|,
name|ia
operator|->
name|ia_iot
argument_list|,
name|ia
operator|->
name|ia_memt
argument_list|,
name|ia
operator|->
name|ia_iobase
argument_list|,
name|ia
operator|->
name|ia_maddr
argument_list|,
operator|&
name|args
operator|.
name|ia_num_mappings
argument_list|,
operator|&
name|args
operator|.
name|ia_maps
index|[
literal|0
index|]
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ret
operator|=
name|isic_probe_s08
argument_list|(
operator|&
name|args
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|found
goto|;
name|args_unmap
argument_list|(
operator|&
name|args
operator|.
name|ia_num_mappings
argument_list|,
operator|&
name|args
operator|.
name|ia_maps
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* TEL_S0_8 */
block|}
break|break;
name|found
label|:
name|flags
operator|=
name|args
operator|.
name|ia_flags
expr_stmt|;
name|sc
operator|->
name|sc_num_mappings
operator|=
name|args
operator|.
name|ia_num_mappings
expr_stmt|;
name|args_unmap
argument_list|(
operator|&
name|args
operator|.
name|ia_num_mappings
argument_list|,
operator|&
name|args
operator|.
name|ia_maps
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|MALLOC_MAPS
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|setup_io_map
argument_list|(
name|flags
argument_list|,
name|ia
operator|->
name|ia_iot
argument_list|,
name|ia
operator|->
name|ia_memt
argument_list|,
name|ia
operator|->
name|ia_iobase
argument_list|,
name|ia
operator|->
name|ia_maddr
argument_list|,
operator|&
operator|(
name|sc
operator|->
name|sc_num_mappings
operator|)
argument_list|,
operator|&
operator|(
name|sc
operator|->
name|sc_maps
index|[
literal|0
index|]
operator|)
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|": could not determine card type - not configured!\n"
argument_list|)
expr_stmt|;
return|return;
block|}
break|break;
block|}
if|#
directive|if
name|defined
argument_list|(
name|__OpenBSD__
argument_list|)
name|isa_intr_establish
argument_list|(
name|ia
operator|->
name|ia_ic
argument_list|,
name|ia
operator|->
name|ia_irq
argument_list|,
name|IST_EDGE
argument_list|,
name|IPL_NET
argument_list|,
name|isicintr
argument_list|,
name|sc
argument_list|,
name|sc
operator|->
name|sc_dev
operator|.
name|dv_xname
argument_list|)
expr_stmt|;
comment|/* MI initialization of card */
name|isicattach
argument_list|(
name|flags
argument_list|,
name|sc
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* MI initialization of card */
name|isicattach
argument_list|(
name|flags
argument_list|,
name|sc
argument_list|)
expr_stmt|;
comment|/* 	 * Try to get a level-triggered interrupt first. If that doesn't 	 * work (like on NetBSD/Atari, try to establish an edge triggered 	 * interrupt. 	 */
if|if
condition|(
name|isa_intr_establish
argument_list|(
name|ia
operator|->
name|ia_ic
argument_list|,
name|ia
operator|->
name|ia_irq
argument_list|,
name|IST_LEVEL
argument_list|,
name|IPL_NET
argument_list|,
name|isicintr
argument_list|,
name|sc
argument_list|)
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|isa_intr_establish
argument_list|(
name|ia
operator|->
name|ia_ic
argument_list|,
name|ia
operator|->
name|ia_irq
argument_list|,
name|IST_EDGE
argument_list|,
name|IPL_NET
argument_list|,
name|isicintr
argument_list|,
name|sc
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|args_unmap
argument_list|(
operator|&
operator|(
name|sc
operator|->
name|sc_num_mappings
operator|)
argument_list|,
operator|&
operator|(
name|sc
operator|->
name|sc_maps
index|[
literal|0
index|]
operator|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|sc
operator|)
operator|->
name|sc_maps
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* 			 * XXX: This is a hack that probably needs to be 			 * solved by setting an interrupt type in the sc 			 * structure. I don't feel familiar enough with the 			 * code to do this currently. Feel free to contact 			 * me about it (leo@netbsd.org). 			 */
name|isicintr
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
block|}
end_block

begin_comment
comment|/*  * Setup card specific io mapping. Return 0 on success,  * any other value on config error.  * Be prepared to get NULL as maps array.  * Make sure to keep *num_mappings in sync with the real  * mappings already setup when returning!  */
end_comment

begin_function
specifier|static
name|int
name|setup_io_map
parameter_list|(
name|flags
parameter_list|,
name|iot
parameter_list|,
name|memt
parameter_list|,
name|iobase
parameter_list|,
name|maddr
parameter_list|,
name|num_mappings
parameter_list|,
name|maps
parameter_list|,
name|iosize
parameter_list|,
name|msize
parameter_list|)
name|int
name|flags
decl_stmt|,
decl|*
name|num_mappings
decl_stmt|,
modifier|*
name|iosize
decl_stmt|,
modifier|*
name|msize
decl_stmt|;
end_function

begin_decl_stmt
name|bus_size_t
name|iobase
decl_stmt|,
name|maddr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|bus_space_tag_t
name|iot
decl_stmt|,
name|memt
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|isic_io_map
modifier|*
name|maps
decl_stmt|;
end_decl_stmt

begin_block
block|{
comment|/* nothing mapped yet */
operator|*
name|num_mappings
operator|=
literal|0
expr_stmt|;
comment|/* which resources do we need? */
switch|switch
condition|(
name|flags
condition|)
block|{
case|case
name|FLAG_TELES_S0_8
case|:
if|if
condition|(
name|maddr
operator|==
name|MADDRUNK
condition|)
block|{
name|printf
argument_list|(
literal|"isic: config error: no shared memory specified for Teles S0/8!\n"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
if|if
condition|(
name|iosize
condition|)
operator|*
name|iosize
operator|=
literal|0
expr_stmt|;
comment|/* no i/o ports */
if|if
condition|(
name|msize
condition|)
operator|*
name|msize
operator|=
literal|0x1000
expr_stmt|;
comment|/* shared memory size */
comment|/* this card uses a single memory mapping */
if|if
condition|(
name|maps
operator|==
name|NULL
condition|)
block|{
operator|*
name|num_mappings
operator|=
literal|1
expr_stmt|;
return|return
literal|0
return|;
block|}
operator|*
name|num_mappings
operator|=
literal|0
expr_stmt|;
name|maps
index|[
literal|0
index|]
operator|.
name|t
operator|=
name|memt
expr_stmt|;
name|maps
index|[
literal|0
index|]
operator|.
name|offset
operator|=
literal|0
expr_stmt|;
name|maps
index|[
literal|0
index|]
operator|.
name|size
operator|=
literal|0x1000
expr_stmt|;
if|if
condition|(
name|bus_space_map
argument_list|(
name|maps
index|[
literal|0
index|]
operator|.
name|t
argument_list|,
name|maddr
argument_list|,
name|maps
index|[
literal|0
index|]
operator|.
name|size
argument_list|,
literal|0
argument_list|,
operator|&
name|maps
index|[
literal|0
index|]
operator|.
name|h
argument_list|)
condition|)
block|{
return|return
literal|1
return|;
block|}
operator|(
operator|*
name|num_mappings
operator|)
operator|++
expr_stmt|;
break|break;
case|case
name|FLAG_TELES_S0_16
case|:
if|if
condition|(
name|iobase
operator|==
name|IOBASEUNK
condition|)
block|{
name|printf
argument_list|(
literal|"isic: config error: no i/o address specified for Teles S0/16!\n"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
if|if
condition|(
name|maddr
operator|==
name|MADDRUNK
condition|)
block|{
name|printf
argument_list|(
literal|"isic: config error: no shared memory specified for Teles S0/16!\n"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
if|if
condition|(
name|iosize
condition|)
operator|*
name|iosize
operator|=
literal|8
expr_stmt|;
comment|/* i/o ports */
if|if
condition|(
name|msize
condition|)
operator|*
name|msize
operator|=
literal|0x1000
expr_stmt|;
comment|/* shared memory size */
comment|/* one io and one memory mapping */
if|if
condition|(
name|maps
operator|==
name|NULL
condition|)
block|{
operator|*
name|num_mappings
operator|=
literal|2
expr_stmt|;
return|return
literal|0
return|;
block|}
operator|*
name|num_mappings
operator|=
literal|0
expr_stmt|;
name|maps
index|[
literal|0
index|]
operator|.
name|t
operator|=
name|iot
expr_stmt|;
name|maps
index|[
literal|0
index|]
operator|.
name|offset
operator|=
literal|0
expr_stmt|;
name|maps
index|[
literal|0
index|]
operator|.
name|size
operator|=
literal|8
expr_stmt|;
if|if
condition|(
name|bus_space_map
argument_list|(
name|maps
index|[
literal|0
index|]
operator|.
name|t
argument_list|,
name|iobase
argument_list|,
name|maps
index|[
literal|0
index|]
operator|.
name|size
argument_list|,
literal|0
argument_list|,
operator|&
name|maps
index|[
literal|0
index|]
operator|.
name|h
argument_list|)
condition|)
block|{
return|return
literal|1
return|;
block|}
operator|(
operator|*
name|num_mappings
operator|)
operator|++
expr_stmt|;
name|maps
index|[
literal|1
index|]
operator|.
name|t
operator|=
name|memt
expr_stmt|;
name|maps
index|[
literal|1
index|]
operator|.
name|offset
operator|=
literal|0
expr_stmt|;
name|maps
index|[
literal|1
index|]
operator|.
name|size
operator|=
literal|0x1000
expr_stmt|;
if|if
condition|(
name|bus_space_map
argument_list|(
name|maps
index|[
literal|1
index|]
operator|.
name|t
argument_list|,
name|maddr
argument_list|,
name|maps
index|[
literal|1
index|]
operator|.
name|size
argument_list|,
literal|0
argument_list|,
operator|&
name|maps
index|[
literal|1
index|]
operator|.
name|h
argument_list|)
condition|)
block|{
return|return
literal|1
return|;
block|}
operator|(
operator|*
name|num_mappings
operator|)
operator|++
expr_stmt|;
break|break;
case|case
name|FLAG_TELES_S0_163
case|:
if|if
condition|(
name|iobase
operator|==
name|IOBASEUNK
condition|)
block|{
name|printf
argument_list|(
literal|"isic: config error: no i/o address specified for Teles S0/16!\n"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
if|if
condition|(
name|iosize
condition|)
operator|*
name|iosize
operator|=
literal|8
expr_stmt|;
comment|/* only some i/o ports shown */
if|if
condition|(
name|msize
condition|)
operator|*
name|msize
operator|=
literal|0
expr_stmt|;
comment|/* no shared memory */
comment|/* Four io mappings: config, isac, 2 * hscx */
if|if
condition|(
name|maps
operator|==
name|NULL
condition|)
block|{
operator|*
name|num_mappings
operator|=
literal|4
expr_stmt|;
return|return
literal|0
return|;
block|}
operator|*
name|num_mappings
operator|=
literal|0
expr_stmt|;
name|maps
index|[
literal|0
index|]
operator|.
name|t
operator|=
name|iot
expr_stmt|;
name|maps
index|[
literal|0
index|]
operator|.
name|offset
operator|=
literal|0
expr_stmt|;
name|maps
index|[
literal|0
index|]
operator|.
name|size
operator|=
literal|8
expr_stmt|;
if|if
condition|(
name|bus_space_map
argument_list|(
name|maps
index|[
literal|0
index|]
operator|.
name|t
argument_list|,
name|iobase
argument_list|,
name|maps
index|[
literal|0
index|]
operator|.
name|size
argument_list|,
literal|0
argument_list|,
operator|&
name|maps
index|[
literal|0
index|]
operator|.
name|h
argument_list|)
condition|)
block|{
return|return
literal|1
return|;
block|}
operator|(
operator|*
name|num_mappings
operator|)
operator|++
expr_stmt|;
name|maps
index|[
literal|1
index|]
operator|.
name|t
operator|=
name|iot
expr_stmt|;
name|maps
index|[
literal|1
index|]
operator|.
name|offset
operator|=
literal|0
expr_stmt|;
name|maps
index|[
literal|1
index|]
operator|.
name|size
operator|=
literal|0x40
expr_stmt|;
comment|/* XXX - ??? */
if|if
condition|(
operator|(
name|iobase
operator|-
literal|0xd80
operator|+
literal|0x980
operator|)
operator|<
literal|0
operator|||
operator|(
name|iobase
operator|-
literal|0xd80
operator|+
literal|0x980
operator|)
operator|>
literal|0x0ffff
condition|)
return|return
literal|1
return|;
if|if
condition|(
name|bus_space_map
argument_list|(
name|maps
index|[
literal|1
index|]
operator|.
name|t
argument_list|,
name|iobase
operator|-
literal|0xd80
operator|+
literal|0x980
argument_list|,
name|maps
index|[
literal|1
index|]
operator|.
name|size
argument_list|,
literal|0
argument_list|,
operator|&
name|maps
index|[
literal|1
index|]
operator|.
name|h
argument_list|)
condition|)
block|{
return|return
literal|1
return|;
block|}
operator|(
operator|*
name|num_mappings
operator|)
operator|++
expr_stmt|;
name|maps
index|[
literal|2
index|]
operator|.
name|t
operator|=
name|iot
expr_stmt|;
name|maps
index|[
literal|2
index|]
operator|.
name|offset
operator|=
literal|0
expr_stmt|;
name|maps
index|[
literal|2
index|]
operator|.
name|size
operator|=
literal|0x40
expr_stmt|;
comment|/* XXX - ??? */
if|if
condition|(
operator|(
name|iobase
operator|-
literal|0xd80
operator|+
literal|0x180
operator|)
operator|<
literal|0
operator|||
operator|(
name|iobase
operator|-
literal|0xd80
operator|+
literal|0x180
operator|)
operator|>
literal|0x0ffff
condition|)
return|return
literal|1
return|;
if|if
condition|(
name|bus_space_map
argument_list|(
name|maps
index|[
literal|2
index|]
operator|.
name|t
argument_list|,
name|iobase
operator|-
literal|0xd80
operator|+
literal|0x180
argument_list|,
name|maps
index|[
literal|2
index|]
operator|.
name|size
argument_list|,
literal|0
argument_list|,
operator|&
name|maps
index|[
literal|2
index|]
operator|.
name|h
argument_list|)
condition|)
block|{
return|return
literal|1
return|;
block|}
operator|(
operator|*
name|num_mappings
operator|)
operator|++
expr_stmt|;
name|maps
index|[
literal|3
index|]
operator|.
name|t
operator|=
name|iot
expr_stmt|;
name|maps
index|[
literal|3
index|]
operator|.
name|offset
operator|=
literal|0
expr_stmt|;
name|maps
index|[
literal|3
index|]
operator|.
name|size
operator|=
literal|0x40
expr_stmt|;
comment|/* XXX - ??? */
if|if
condition|(
operator|(
name|iobase
operator|-
literal|0xd80
operator|+
literal|0x580
operator|)
operator|<
literal|0
operator|||
operator|(
name|iobase
operator|-
literal|0xd80
operator|+
literal|0x580
operator|)
operator|>
literal|0x0ffff
condition|)
return|return
literal|1
return|;
if|if
condition|(
name|bus_space_map
argument_list|(
name|maps
index|[
literal|3
index|]
operator|.
name|t
argument_list|,
name|iobase
operator|-
literal|0xd80
operator|+
literal|0x580
argument_list|,
name|maps
index|[
literal|3
index|]
operator|.
name|size
argument_list|,
literal|0
argument_list|,
operator|&
name|maps
index|[
literal|3
index|]
operator|.
name|h
argument_list|)
condition|)
block|{
return|return
literal|1
return|;
block|}
operator|(
operator|*
name|num_mappings
operator|)
operator|++
expr_stmt|;
break|break;
case|case
name|FLAG_AVM_A1
case|:
if|if
condition|(
name|iobase
operator|==
name|IOBASEUNK
condition|)
block|{
name|printf
argument_list|(
literal|"isic: config error: no i/o address specified for AVM A1/Fritz! card!\n"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
if|if
condition|(
name|iosize
condition|)
operator|*
name|iosize
operator|=
literal|8
expr_stmt|;
comment|/* only some i/o ports shown */
if|if
condition|(
name|msize
condition|)
operator|*
name|msize
operator|=
literal|0
expr_stmt|;
comment|/* no shared memory */
comment|/* Seven io mappings: config, isac, 2 * hscx, 			   isac-fifo, 2 * hscx-fifo */
if|if
condition|(
name|maps
operator|==
name|NULL
condition|)
block|{
operator|*
name|num_mappings
operator|=
literal|7
expr_stmt|;
return|return
literal|0
return|;
block|}
operator|*
name|num_mappings
operator|=
literal|0
expr_stmt|;
name|maps
index|[
literal|0
index|]
operator|.
name|t
operator|=
name|iot
expr_stmt|;
comment|/* config */
name|maps
index|[
literal|0
index|]
operator|.
name|offset
operator|=
literal|0
expr_stmt|;
name|maps
index|[
literal|0
index|]
operator|.
name|size
operator|=
literal|8
expr_stmt|;
if|if
condition|(
operator|(
name|iobase
operator|+
literal|0x1800
operator|)
operator|<
literal|0
operator|||
operator|(
name|iobase
operator|+
literal|0x1800
operator|)
operator|>
literal|0x0ffff
condition|)
return|return
literal|1
return|;
if|if
condition|(
name|bus_space_map
argument_list|(
name|maps
index|[
literal|0
index|]
operator|.
name|t
argument_list|,
name|iobase
operator|+
literal|0x1800
argument_list|,
name|maps
index|[
literal|0
index|]
operator|.
name|size
argument_list|,
literal|0
argument_list|,
operator|&
name|maps
index|[
literal|0
index|]
operator|.
name|h
argument_list|)
condition|)
return|return
literal|1
return|;
operator|(
operator|*
name|num_mappings
operator|)
operator|++
expr_stmt|;
name|maps
index|[
literal|1
index|]
operator|.
name|t
operator|=
name|iot
expr_stmt|;
comment|/* isac */
name|maps
index|[
literal|1
index|]
operator|.
name|offset
operator|=
literal|0
expr_stmt|;
name|maps
index|[
literal|1
index|]
operator|.
name|size
operator|=
literal|0x80
expr_stmt|;
comment|/* XXX - ??? */
if|if
condition|(
operator|(
name|iobase
operator|+
literal|0x1400
operator|-
literal|0x20
operator|)
operator|<
literal|0
operator|||
operator|(
name|iobase
operator|+
literal|0x1400
operator|-
literal|0x20
operator|)
operator|>
literal|0x0ffff
condition|)
return|return
literal|1
return|;
if|if
condition|(
name|bus_space_map
argument_list|(
name|maps
index|[
literal|1
index|]
operator|.
name|t
argument_list|,
name|iobase
operator|+
literal|0x1400
operator|-
literal|0x20
argument_list|,
name|maps
index|[
literal|1
index|]
operator|.
name|size
argument_list|,
literal|0
argument_list|,
operator|&
name|maps
index|[
literal|1
index|]
operator|.
name|h
argument_list|)
condition|)
return|return
literal|1
return|;
operator|(
operator|*
name|num_mappings
operator|)
operator|++
expr_stmt|;
name|maps
index|[
literal|2
index|]
operator|.
name|t
operator|=
name|iot
expr_stmt|;
comment|/* hscx 0 */
name|maps
index|[
literal|2
index|]
operator|.
name|offset
operator|=
literal|0
expr_stmt|;
name|maps
index|[
literal|2
index|]
operator|.
name|size
operator|=
literal|0x40
expr_stmt|;
comment|/* XXX - ??? */
if|if
condition|(
operator|(
name|iobase
operator|+
literal|0x400
operator|-
literal|0x20
operator|)
operator|<
literal|0
operator|||
operator|(
name|iobase
operator|+
literal|0x400
operator|-
literal|0x20
operator|)
operator|>
literal|0x0ffff
condition|)
return|return
literal|1
return|;
if|if
condition|(
name|bus_space_map
argument_list|(
name|maps
index|[
literal|2
index|]
operator|.
name|t
argument_list|,
name|iobase
operator|+
literal|0x400
operator|-
literal|0x20
argument_list|,
name|maps
index|[
literal|2
index|]
operator|.
name|size
argument_list|,
literal|0
argument_list|,
operator|&
name|maps
index|[
literal|2
index|]
operator|.
name|h
argument_list|)
condition|)
return|return
literal|1
return|;
operator|(
operator|*
name|num_mappings
operator|)
operator|++
expr_stmt|;
name|maps
index|[
literal|3
index|]
operator|.
name|t
operator|=
name|iot
expr_stmt|;
comment|/* hscx 1 */
name|maps
index|[
literal|3
index|]
operator|.
name|offset
operator|=
literal|0
expr_stmt|;
name|maps
index|[
literal|3
index|]
operator|.
name|size
operator|=
literal|0x40
expr_stmt|;
comment|/* XXX - ??? */
if|if
condition|(
operator|(
name|iobase
operator|+
literal|0xc00
operator|-
literal|0x20
operator|)
operator|<
literal|0
operator|||
operator|(
name|iobase
operator|+
literal|0xc00
operator|-
literal|0x20
operator|)
operator|>
literal|0x0ffff
condition|)
return|return
literal|1
return|;
if|if
condition|(
name|bus_space_map
argument_list|(
name|maps
index|[
literal|3
index|]
operator|.
name|t
argument_list|,
name|iobase
operator|+
literal|0xc00
operator|-
literal|0x20
argument_list|,
name|maps
index|[
literal|3
index|]
operator|.
name|size
argument_list|,
literal|0
argument_list|,
operator|&
name|maps
index|[
literal|3
index|]
operator|.
name|h
argument_list|)
condition|)
return|return
literal|1
return|;
operator|(
operator|*
name|num_mappings
operator|)
operator|++
expr_stmt|;
name|maps
index|[
literal|4
index|]
operator|.
name|t
operator|=
name|iot
expr_stmt|;
comment|/* isac-fifo */
name|maps
index|[
literal|4
index|]
operator|.
name|offset
operator|=
literal|0
expr_stmt|;
name|maps
index|[
literal|4
index|]
operator|.
name|size
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|iobase
operator|+
literal|0x1400
operator|-
literal|0x20
operator|-
literal|0x3e0
operator|)
operator|<
literal|0
operator|||
operator|(
name|iobase
operator|+
literal|0x1400
operator|-
literal|0x20
operator|-
literal|0x3e0
operator|)
operator|>
literal|0x0ffff
condition|)
return|return
literal|1
return|;
if|if
condition|(
name|bus_space_map
argument_list|(
name|maps
index|[
literal|4
index|]
operator|.
name|t
argument_list|,
name|iobase
operator|+
literal|0x1400
operator|-
literal|0x20
operator|-
literal|0x3e0
argument_list|,
name|maps
index|[
literal|4
index|]
operator|.
name|size
argument_list|,
literal|0
argument_list|,
operator|&
name|maps
index|[
literal|4
index|]
operator|.
name|h
argument_list|)
condition|)
return|return
literal|1
return|;
operator|(
operator|*
name|num_mappings
operator|)
operator|++
expr_stmt|;
name|maps
index|[
literal|5
index|]
operator|.
name|t
operator|=
name|iot
expr_stmt|;
comment|/* hscx 0 fifo */
name|maps
index|[
literal|5
index|]
operator|.
name|offset
operator|=
literal|0
expr_stmt|;
name|maps
index|[
literal|5
index|]
operator|.
name|size
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|iobase
operator|+
literal|0x400
operator|-
literal|0x20
operator|-
literal|0x3e0
operator|)
operator|<
literal|0
operator|||
operator|(
name|iobase
operator|+
literal|0x400
operator|-
literal|0x20
operator|-
literal|0x3e0
operator|)
operator|>
literal|0x0ffff
condition|)
return|return
literal|1
return|;
if|if
condition|(
name|bus_space_map
argument_list|(
name|maps
index|[
literal|5
index|]
operator|.
name|t
argument_list|,
name|iobase
operator|+
literal|0x400
operator|-
literal|0x20
operator|-
literal|0x3e0
argument_list|,
name|maps
index|[
literal|5
index|]
operator|.
name|size
argument_list|,
literal|0
argument_list|,
operator|&
name|maps
index|[
literal|5
index|]
operator|.
name|h
argument_list|)
condition|)
return|return
literal|1
return|;
operator|(
operator|*
name|num_mappings
operator|)
operator|++
expr_stmt|;
name|maps
index|[
literal|6
index|]
operator|.
name|t
operator|=
name|iot
expr_stmt|;
comment|/* hscx 1 fifo */
name|maps
index|[
literal|6
index|]
operator|.
name|offset
operator|=
literal|0
expr_stmt|;
name|maps
index|[
literal|6
index|]
operator|.
name|size
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|iobase
operator|+
literal|0xc00
operator|-
literal|0x20
operator|-
literal|0x3e0
operator|)
operator|<
literal|0
operator|||
operator|(
name|iobase
operator|+
literal|0xc00
operator|-
literal|0x20
operator|-
literal|0x3e0
operator|)
operator|>
literal|0x0ffff
condition|)
return|return
literal|1
return|;
if|if
condition|(
name|bus_space_map
argument_list|(
name|maps
index|[
literal|6
index|]
operator|.
name|t
argument_list|,
name|iobase
operator|+
literal|0xc00
operator|-
literal|0x20
operator|-
literal|0x3e0
argument_list|,
name|maps
index|[
literal|6
index|]
operator|.
name|size
argument_list|,
literal|0
argument_list|,
operator|&
name|maps
index|[
literal|6
index|]
operator|.
name|h
argument_list|)
condition|)
return|return
literal|1
return|;
operator|(
operator|*
name|num_mappings
operator|)
operator|++
expr_stmt|;
break|break;
case|case
name|FLAG_USR_ISDN_TA_INT
case|:
if|if
condition|(
name|iobase
operator|==
name|IOBASEUNK
condition|)
block|{
name|printf
argument_list|(
literal|"isic: config error: no I/O base specified for USR Sportster TA intern!\n"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
if|if
condition|(
name|iosize
condition|)
operator|*
name|iosize
operator|=
literal|8
expr_stmt|;
comment|/* scattered ports, only some shown */
if|if
condition|(
name|msize
condition|)
operator|*
name|msize
operator|=
literal|0
expr_stmt|;
comment|/* no shared memory */
comment|/* 49 io mappings: 1 config and 48x8 registers */
if|if
condition|(
name|maps
operator|==
name|NULL
condition|)
block|{
operator|*
name|num_mappings
operator|=
literal|49
expr_stmt|;
return|return
literal|0
return|;
block|}
operator|*
name|num_mappings
operator|=
literal|0
expr_stmt|;
block|{
name|int
name|i
decl_stmt|,
name|num
decl_stmt|;
name|bus_size_t
name|base
decl_stmt|;
comment|/* config at offset 0x8000 */
name|base
operator|=
name|iobase
operator|+
literal|0x8000
expr_stmt|;
name|maps
index|[
literal|0
index|]
operator|.
name|size
operator|=
literal|1
expr_stmt|;
name|maps
index|[
literal|0
index|]
operator|.
name|t
operator|=
name|iot
expr_stmt|;
name|maps
index|[
literal|0
index|]
operator|.
name|offset
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|base
operator|<
literal|0
operator|||
name|base
operator|>
literal|0x0ffff
condition|)
return|return
literal|1
return|;
if|if
condition|(
name|bus_space_map
argument_list|(
name|iot
argument_list|,
name|base
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
operator|&
name|maps
index|[
literal|0
index|]
operator|.
name|h
argument_list|)
condition|)
block|{
return|return
literal|1
return|;
block|}
operator|*
name|num_mappings
operator|=
name|num
operator|=
literal|1
expr_stmt|;
comment|/* HSCX A at offset 0 */
name|base
operator|=
name|iobase
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
block|{
name|maps
index|[
name|num
index|]
operator|.
name|size
operator|=
literal|8
expr_stmt|;
name|maps
index|[
name|num
index|]
operator|.
name|offset
operator|=
literal|0
expr_stmt|;
name|maps
index|[
name|num
index|]
operator|.
name|t
operator|=
name|iot
expr_stmt|;
if|if
condition|(
name|base
operator|+
name|i
operator|*
literal|1024
operator|<
literal|0
operator|||
name|base
operator|+
name|i
operator|*
literal|1024
operator|+
literal|8
operator|>
literal|0x0ffff
condition|)
return|return
literal|1
return|;
if|if
condition|(
name|bus_space_map
argument_list|(
name|iot
argument_list|,
name|base
operator|+
name|i
operator|*
literal|1024
argument_list|,
literal|8
argument_list|,
literal|0
argument_list|,
operator|&
name|maps
index|[
name|num
index|]
operator|.
name|h
argument_list|)
condition|)
block|{
return|return
literal|1
return|;
block|}
operator|*
name|num_mappings
operator|=
operator|++
name|num
expr_stmt|;
block|}
comment|/* HSCX B at offset 0x4000 */
name|base
operator|=
name|iobase
operator|+
literal|0x4000
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
block|{
name|maps
index|[
name|num
index|]
operator|.
name|size
operator|=
literal|8
expr_stmt|;
name|maps
index|[
name|num
index|]
operator|.
name|offset
operator|=
literal|0
expr_stmt|;
name|maps
index|[
name|num
index|]
operator|.
name|t
operator|=
name|iot
expr_stmt|;
if|if
condition|(
name|base
operator|+
name|i
operator|*
literal|1024
operator|<
literal|0
operator|||
name|base
operator|+
name|i
operator|*
literal|1024
operator|+
literal|8
operator|>
literal|0x0ffff
condition|)
return|return
literal|1
return|;
if|if
condition|(
name|bus_space_map
argument_list|(
name|iot
argument_list|,
name|base
operator|+
name|i
operator|*
literal|1024
argument_list|,
literal|8
argument_list|,
literal|0
argument_list|,
operator|&
name|maps
index|[
name|num
index|]
operator|.
name|h
argument_list|)
condition|)
block|{
return|return
literal|1
return|;
block|}
operator|*
name|num_mappings
operator|=
operator|++
name|num
expr_stmt|;
block|}
comment|/* ISAC at offset 0xc000 */
name|base
operator|=
name|iobase
operator|+
literal|0xc000
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
block|{
name|maps
index|[
name|num
index|]
operator|.
name|size
operator|=
literal|8
expr_stmt|;
name|maps
index|[
name|num
index|]
operator|.
name|offset
operator|=
literal|0
expr_stmt|;
name|maps
index|[
name|num
index|]
operator|.
name|t
operator|=
name|iot
expr_stmt|;
if|if
condition|(
name|base
operator|+
name|i
operator|*
literal|1024
operator|<
literal|0
operator|||
name|base
operator|+
name|i
operator|*
literal|1024
operator|+
literal|8
operator|>
literal|0x0ffff
condition|)
return|return
literal|1
return|;
if|if
condition|(
name|bus_space_map
argument_list|(
name|iot
argument_list|,
name|base
operator|+
name|i
operator|*
literal|1024
argument_list|,
literal|8
argument_list|,
literal|0
argument_list|,
operator|&
name|maps
index|[
name|num
index|]
operator|.
name|h
argument_list|)
condition|)
block|{
return|return
literal|1
return|;
block|}
operator|*
name|num_mappings
operator|=
operator|++
name|num
expr_stmt|;
block|}
block|}
break|break;
case|case
name|FLAG_ITK_IX1
case|:
if|if
condition|(
name|iobase
operator|==
name|IOBASEUNK
condition|)
block|{
name|printf
argument_list|(
literal|"isic: config error: no I/O base specified for ITK ix1 micro!\n"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
if|if
condition|(
name|iosize
condition|)
operator|*
name|iosize
operator|=
literal|4
expr_stmt|;
if|if
condition|(
name|msize
condition|)
operator|*
name|msize
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|maps
operator|==
name|NULL
condition|)
block|{
operator|*
name|num_mappings
operator|=
literal|1
expr_stmt|;
return|return
literal|0
return|;
block|}
operator|*
name|num_mappings
operator|=
literal|0
expr_stmt|;
name|maps
index|[
literal|0
index|]
operator|.
name|size
operator|=
literal|4
expr_stmt|;
name|maps
index|[
literal|0
index|]
operator|.
name|t
operator|=
name|iot
expr_stmt|;
name|maps
index|[
literal|0
index|]
operator|.
name|offset
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|bus_space_map
argument_list|(
name|iot
argument_list|,
name|iobase
argument_list|,
literal|4
argument_list|,
literal|0
argument_list|,
operator|&
name|maps
index|[
literal|0
index|]
operator|.
name|h
argument_list|)
condition|)
block|{
return|return
literal|1
return|;
block|}
operator|*
name|num_mappings
operator|=
literal|1
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"isic: config error: flags do not specify any known card!\n"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
break|break;
block|}
return|return
literal|0
return|;
block|}
end_block

begin_function
specifier|static
name|void
name|args_unmap
parameter_list|(
name|num_mappings
parameter_list|,
name|maps
parameter_list|)
name|int
modifier|*
name|num_mappings
decl_stmt|;
name|struct
name|isic_io_map
modifier|*
name|maps
decl_stmt|;
block|{
name|int
name|i
decl_stmt|,
name|n
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|n
operator|=
operator|*
name|num_mappings
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|maps
index|[
name|i
index|]
operator|.
name|size
condition|)
name|bus_space_unmap
argument_list|(
name|maps
index|[
name|i
index|]
operator|.
name|t
argument_list|,
name|maps
index|[
name|i
index|]
operator|.
name|h
argument_list|,
name|maps
index|[
name|i
index|]
operator|.
name|size
argument_list|)
expr_stmt|;
operator|*
name|num_mappings
operator|=
literal|0
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1997, 2002 Hellmuth Michaelis. All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  *---------------------------------------------------------------------------  *  *	i4b_util.c - layer 2 utility routines  *	-------------------------------------  *  * $FreeBSD$  *  *      last edit-date: [Sat Mar  9 17:55:03 2002]  *  *---------------------------------------------------------------------------*/
end_comment

begin_include
include|#
directive|include
file|"i4bq921.h"
end_include

begin_if
if|#
directive|if
name|NI4BQ921
operator|>
literal|0
end_if

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<machine/i4b_debug.h>
end_include

begin_include
include|#
directive|include
file|<i4b/include/i4b_global.h>
end_include

begin_include
include|#
directive|include
file|<i4b/include/i4b_l1l2.h>
end_include

begin_include
include|#
directive|include
file|<i4b/include/i4b_mbuf.h>
end_include

begin_include
include|#
directive|include
file|<i4b/layer2/i4b_l2.h>
end_include

begin_comment
comment|/*---------------------------------------------------------------------------*  *	routine ESTABLISH DATA LINK (Q.921 03/93 page 83)  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|i4b_establish_data_link
parameter_list|(
name|l2_softc_t
modifier|*
name|l2sc
parameter_list|)
block|{
name|i4b_l1_activate
argument_list|(
name|l2sc
argument_list|)
expr_stmt|;
name|i4b_clear_exception_conditions
argument_list|(
name|l2sc
argument_list|)
expr_stmt|;
name|l2sc
operator|->
name|RC
operator|=
literal|0
expr_stmt|;
name|i4b_tx_sabme
argument_list|(
name|l2sc
argument_list|,
name|P1
argument_list|)
expr_stmt|;
name|i4b_T200_restart
argument_list|(
name|l2sc
argument_list|)
expr_stmt|;
name|i4b_T203_stop
argument_list|(
name|l2sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	routine CLEAR EXCEPTION CONDITIONS (Q.921 03/93 page 83)  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|i4b_clear_exception_conditions
parameter_list|(
name|l2_softc_t
modifier|*
name|l2sc
parameter_list|)
block|{
name|CRIT_VAR
expr_stmt|;
name|CRIT_BEG
expr_stmt|;
comment|/*XXX -------------------------------------------------------------- */
comment|/*XXX is this really appropriate here or should it moved elsewhere ? */
name|i4b_Dcleanifq
argument_list|(
operator|&
name|l2sc
operator|->
name|i_queue
argument_list|)
expr_stmt|;
if|if
condition|(
name|l2sc
operator|->
name|ua_num
operator|!=
name|UA_EMPTY
condition|)
block|{
name|i4b_Dfreembuf
argument_list|(
name|l2sc
operator|->
name|ua_frame
argument_list|)
expr_stmt|;
name|l2sc
operator|->
name|ua_num
operator|=
name|UA_EMPTY
expr_stmt|;
block|}
comment|/*XXX -------------------------------------------------------------- */
name|l2sc
operator|->
name|peer_busy
operator|=
literal|0
expr_stmt|;
name|l2sc
operator|->
name|rej_excpt
operator|=
literal|0
expr_stmt|;
name|l2sc
operator|->
name|own_busy
operator|=
literal|0
expr_stmt|;
name|l2sc
operator|->
name|ack_pend
operator|=
literal|0
expr_stmt|;
name|CRIT_END
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	routine TRANSMIT ENQUIRE (Q.921 03/93 page 83)  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|i4b_transmit_enquire
parameter_list|(
name|l2_softc_t
modifier|*
name|l2sc
parameter_list|)
block|{
if|if
condition|(
name|l2sc
operator|->
name|own_busy
condition|)
name|i4b_tx_rnr_command
argument_list|(
name|l2sc
argument_list|,
name|P1
argument_list|)
expr_stmt|;
else|else
name|i4b_tx_rr_command
argument_list|(
name|l2sc
argument_list|,
name|P1
argument_list|)
expr_stmt|;
name|l2sc
operator|->
name|ack_pend
operator|=
literal|0
expr_stmt|;
name|i4b_T200_start
argument_list|(
name|l2sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	routine NR ERROR RECOVERY (Q.921 03/93 page 83)  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|i4b_nr_error_recovery
parameter_list|(
name|l2_softc_t
modifier|*
name|l2sc
parameter_list|)
block|{
name|i4b_mdl_error_ind
argument_list|(
name|l2sc
argument_list|,
literal|"i4b_nr_error_recovery"
argument_list|,
name|MDL_ERR_J
argument_list|)
expr_stmt|;
name|i4b_establish_data_link
argument_list|(
name|l2sc
argument_list|)
expr_stmt|;
name|l2sc
operator|->
name|l3initiated
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	routine ENQUIRY RESPONSE (Q.921 03/93 page 84)  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|i4b_enquiry_response
parameter_list|(
name|l2_softc_t
modifier|*
name|l2sc
parameter_list|)
block|{
if|if
condition|(
name|l2sc
operator|->
name|own_busy
condition|)
name|i4b_tx_rnr_response
argument_list|(
name|l2sc
argument_list|,
name|F1
argument_list|)
expr_stmt|;
else|else
name|i4b_tx_rr_response
argument_list|(
name|l2sc
argument_list|,
name|F1
argument_list|)
expr_stmt|;
name|l2sc
operator|->
name|ack_pend
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	routine INVOKE RETRANSMISSION (Q.921 03/93 page 84)  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|i4b_invoke_retransmission
parameter_list|(
name|l2_softc_t
modifier|*
name|l2sc
parameter_list|,
name|int
name|nr
parameter_list|)
block|{
name|CRIT_VAR
expr_stmt|;
name|CRIT_BEG
expr_stmt|;
name|NDBGL2
argument_list|(
name|L2_ERROR
argument_list|,
literal|"nr = %d"
argument_list|,
name|nr
argument_list|)
expr_stmt|;
while|while
condition|(
name|l2sc
operator|->
name|vs
operator|!=
name|nr
condition|)
block|{
name|NDBGL2
argument_list|(
name|L2_ERROR
argument_list|,
literal|"nr(%d) != vs(%d)"
argument_list|,
name|nr
argument_list|,
name|l2sc
operator|->
name|vs
argument_list|)
expr_stmt|;
name|M128DEC
argument_list|(
name|l2sc
operator|->
name|vs
argument_list|)
expr_stmt|;
comment|/* XXXXXXXXXXXXXXXXX */
if|if
condition|(
operator|(
name|l2sc
operator|->
name|ua_num
operator|!=
name|UA_EMPTY
operator|)
operator|&&
operator|(
name|l2sc
operator|->
name|vs
operator|==
name|l2sc
operator|->
name|ua_num
operator|)
condition|)
block|{
if|if
condition|(
name|_IF_QFULL
argument_list|(
operator|&
name|l2sc
operator|->
name|i_queue
argument_list|)
condition|)
block|{
name|NDBGL2
argument_list|(
name|L2_ERROR
argument_list|,
literal|"ERROR, I-queue full!"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|IF_ENQUEUE
argument_list|(
operator|&
name|l2sc
operator|->
name|i_queue
argument_list|,
name|l2sc
operator|->
name|ua_frame
argument_list|)
expr_stmt|;
name|l2sc
operator|->
name|ua_num
operator|=
name|UA_EMPTY
expr_stmt|;
block|}
block|}
else|else
block|{
name|NDBGL2
argument_list|(
name|L2_ERROR
argument_list|,
literal|"ERROR, l2sc->vs = %d, l2sc->ua_num = %d "
argument_list|,
name|l2sc
operator|->
name|vs
argument_list|,
name|l2sc
operator|->
name|ua_num
argument_list|)
expr_stmt|;
block|}
comment|/* XXXXXXXXXXXXXXXXX */
name|i4b_i_frame_queued_up
argument_list|(
name|l2sc
argument_list|)
expr_stmt|;
block|}
name|CRIT_END
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	routine ACKNOWLEDGE PENDING (Q.921 03/93 p 70)  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|i4b_acknowledge_pending
parameter_list|(
name|l2_softc_t
modifier|*
name|l2sc
parameter_list|)
block|{
if|if
condition|(
name|l2sc
operator|->
name|ack_pend
condition|)
block|{
name|l2sc
operator|->
name|ack_pend
operator|=
literal|0
expr_stmt|;
name|i4b_tx_rr_response
argument_list|(
name|l2sc
argument_list|,
name|F0
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	i4b_print_frame - just print the hex contents of a frame  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|i4b_print_frame
parameter_list|(
name|int
name|len
parameter_list|,
name|u_char
modifier|*
name|buf
parameter_list|)
block|{
if|#
directive|if
name|DO_I4B_DEBUG
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|i4b_l2_debug
operator|&
name|L2_ERROR
operator|)
condition|)
comment|/* XXXXXXXXXXXXXXXXXXXXX */
return|return;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|" 0x%x"
argument_list|,
name|buf
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	i4b_print_l2var - print some l2softc vars  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|i4b_print_l2var
parameter_list|(
name|l2_softc_t
modifier|*
name|l2sc
parameter_list|)
block|{
name|NDBGL2
argument_list|(
name|L2_ERROR
argument_list|,
literal|"unit%d V(R)=%d, V(S)=%d, V(A)=%d,ACKP=%d,PBSY=%d,OBSY=%d"
argument_list|,
name|l2sc
operator|->
name|unit
argument_list|,
name|l2sc
operator|->
name|vr
argument_list|,
name|l2sc
operator|->
name|vs
argument_list|,
name|l2sc
operator|->
name|va
argument_list|,
name|l2sc
operator|->
name|ack_pend
argument_list|,
name|l2sc
operator|->
name|peer_busy
argument_list|,
name|l2sc
operator|->
name|own_busy
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	got s or i frame, check if valid ack for last sent frame  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|i4b_rxd_ack
parameter_list|(
name|l2_softc_t
modifier|*
name|l2sc
parameter_list|,
name|int
name|nr
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|NOTDEF
name|NDBGL2
argument_list|(
name|L2_ERROR
argument_list|,
literal|"N(R)=%d, UA=%d, V(R)=%d, V(S)=%d, V(A)=%d"
argument_list|,
name|nr
argument_list|,
name|l2sc
operator|->
name|ua_num
argument_list|,
name|l2sc
operator|->
name|vr
argument_list|,
name|l2sc
operator|->
name|vs
argument_list|,
name|l2sc
operator|->
name|va
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|l2sc
operator|->
name|ua_num
operator|!=
name|UA_EMPTY
condition|)
block|{
name|CRIT_VAR
expr_stmt|;
name|CRIT_BEG
expr_stmt|;
name|M128DEC
argument_list|(
name|nr
argument_list|)
expr_stmt|;
if|if
condition|(
name|l2sc
operator|->
name|ua_num
operator|!=
name|nr
condition|)
name|NDBGL2
argument_list|(
name|L2_ERROR
argument_list|,
literal|"((N(R)-1)=%d) != (UA=%d) !!!"
argument_list|,
name|nr
argument_list|,
name|l2sc
operator|->
name|ua_num
argument_list|)
expr_stmt|;
name|i4b_Dfreembuf
argument_list|(
name|l2sc
operator|->
name|ua_frame
argument_list|)
expr_stmt|;
name|l2sc
operator|->
name|ua_num
operator|=
name|UA_EMPTY
expr_stmt|;
name|CRIT_END
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	if not already active, activate layer 1  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|i4b_l1_activate
parameter_list|(
name|l2_softc_t
modifier|*
name|l2sc
parameter_list|)
block|{
if|if
condition|(
name|l2sc
operator|->
name|ph_active
operator|==
name|PH_INACTIVE
condition|)
block|{
name|l2sc
operator|->
name|ph_active
operator|=
name|PH_ACTIVEPEND
expr_stmt|;
name|PH_Act_Req
argument_list|(
name|l2sc
operator|->
name|unit
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_comment
comment|/*---------------------------------------------------------------------------*  *	check for v(a)<= n(r)<= v(s)  *	nr = receive sequence frame counter, va = acknowledge sequence frame  *	counter and vs = transmit sequence frame counter  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|int
name|i4b_l2_nr_ok
parameter_list|(
name|int
name|nr
parameter_list|,
name|int
name|va
parameter_list|,
name|int
name|vs
parameter_list|)
block|{
if|if
condition|(
operator|(
name|va
operator|>
name|nr
operator|)
operator|&&
operator|(
operator|(
name|nr
operator|!=
literal|0
operator|)
operator|||
operator|(
name|va
operator|!=
literal|127
operator|)
operator|)
condition|)
block|{
name|NDBGL2
argument_list|(
name|L2_ERROR
argument_list|,
literal|"ERROR, va = %d, nr = %d, vs = %d [1]"
argument_list|,
name|va
argument_list|,
name|nr
argument_list|,
name|vs
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
comment|/* fail */
block|}
if|if
condition|(
operator|(
name|nr
operator|>
name|vs
operator|)
operator|&&
operator|(
operator|(
name|vs
operator|!=
literal|0
operator|)
operator|||
operator|(
name|nr
operator|!=
literal|127
operator|)
operator|)
condition|)
block|{
name|NDBGL2
argument_list|(
name|L2_ERROR
argument_list|,
literal|"ERROR, va = %d, nr = %d, vs = %d [2]"
argument_list|,
name|va
argument_list|,
name|nr
argument_list|,
name|vs
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
comment|/* fail */
block|}
return|return
literal|1
return|;
comment|/* good */
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* NI4BQ921> 0 */
end_comment

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  *   Copyright (c) 1994, 1998 Hellmuth Michaelis. All rights reserved.  *  *   Redistribution and use in source and binary forms, with or without  *   modification, are permitted provided that the following conditions  *   are met:  *  *   1. Redistributions of source code must retain the above copyright  *      notice, this list of conditions and the following disclaimer.  *   2. Redistributions in binary form must reproduce the above copyright  *      notice, this list of conditions and the following disclaimer in the  *      documentation and/or other materials provided with the distribution.  *  *   THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  *   ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  *   IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  *   ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  *   FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  *   DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  *   OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  *   HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  *   LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  *   OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  *   SUCH DAMAGE.  *  *---------------------------------------------------------------------------  *  *	i4b_tina_dd.c - i4b Stollman Tina-dd control device driver  *	----------------------------------------------------------  *  * $FreeBSD$  *  *	last edit-date: [Sat Dec  5 18:41:38 1998]  *  *---------------------------------------------------------------------------*/
end_comment

begin_include
include|#
directive|include
file|"tina.h"
end_include

begin_if
if|#
directive|if
name|NTINA
operator|>
literal|0
end_if

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__FreeBSD__
argument_list|)
operator|&&
name|__FreeBSD__
operator|>=
literal|3
end_if

begin_include
include|#
directive|include
file|<sys/ioccom.h>
end_include

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/fcntl.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|__FreeBSD__
end_ifdef

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/i4b_debug.h>
end_include

begin_include
include|#
directive|include
file|<machine/i4b_ioctl.h>
end_include

begin_include
include|#
directive|include
file|<i386/isa/isa_device.h>
end_include

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/device.h>
end_include

begin_include
include|#
directive|include
file|<i4b/i4b_debug.h>
end_include

begin_include
include|#
directive|include
file|<i4b/i4b_ioctl.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<i4b/include/i4b_mbuf.h>
end_include

begin_include
include|#
directive|include
file|<i4b/tina-dd/i4b_tina_ioctl.h>
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|COMPAT_OLDISA
end_ifndef

begin_error
error|#
directive|error
literal|"The tina device requires the old isa compatibility shims"
end_error

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|static
name|int
name|openflag
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_function_decl
name|int
name|tinaprobe
parameter_list|(
name|struct
name|isa_device
modifier|*
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|tinaattach
parameter_list|(
name|struct
name|isa_device
modifier|*
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|tinaintr
parameter_list|(
name|int
name|unit
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
name|struct
name|isa_driver
name|tinadriver
init|=
block|{
name|INTR_TYPE_NET
block|,
name|tinaprobe
block|,
name|tinaattach
block|,
literal|"tina"
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|COMPAT_ISA_DRIVER
argument_list|(
name|tina
argument_list|,
name|tinadriver
argument_list|)
expr_stmt|;
end_expr_stmt

begin_struct
specifier|static
struct|struct
name|tina_softc
block|{
name|int
name|sc_unit
decl_stmt|;
name|int
name|sc_iobase
decl_stmt|;
block|}
name|tina_sc
index|[
name|NTINA
index|]
struct|;
end_struct

begin_decl_stmt
specifier|static
name|d_open_t
name|tinaopen
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|d_close_t
name|tinaclose
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|d_ioctl_t
name|tinaioctl
decl_stmt|;
end_decl_stmt

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__FreeBSD__
argument_list|)
operator|&&
name|__FreeBSD__
operator|>=
literal|3
end_if

begin_decl_stmt
specifier|static
name|d_poll_t
name|tinapoll
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|POLLFIELD
value|tinapoll
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|POLLFIELD
value|noselect
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|CDEV_MAJOR
value|54
end_define

begin_decl_stmt
specifier|static
name|struct
name|cdevsw
name|tina_cdevsw
init|=
block|{
comment|/* open */
name|tinaopen
block|,
comment|/* close */
name|tinaclose
block|,
comment|/* read */
name|noread
block|,
comment|/* write */
name|nowrite
block|,
comment|/* ioctl */
name|tinaioctl
block|,
comment|/* poll */
name|POLLFIELD
block|,
comment|/* mmap */
name|nommap
block|,
comment|/* strategy */
name|nostrategy
block|,
comment|/* name */
literal|"tina"
block|,
comment|/* maj */
name|CDEV_MAJOR
block|,
comment|/* dump */
name|nodump
block|,
comment|/* psize */
name|nopsize
block|,
comment|/* flags */
literal|0
block|,
comment|/* bmaj */
operator|-
literal|1
block|}
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|setupaddr
parameter_list|(
name|unsigned
name|short
name|iobase
parameter_list|,
name|unsigned
name|int
name|addr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|readblock
parameter_list|(
name|unsigned
name|short
name|iobase
parameter_list|,
name|unsigned
name|int
name|addr
parameter_list|,
name|unsigned
name|char
modifier|*
name|dst
parameter_list|,
name|unsigned
name|int
name|len
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|writeblock
parameter_list|(
name|unsigned
name|short
name|iobase
parameter_list|,
name|unsigned
name|char
modifier|*
name|src
parameter_list|,
name|unsigned
name|long
name|addr
parameter_list|,
name|int
name|len
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*---------------------------------------------------------------------------*  *	tina - device driver probe routine  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|int
name|tinaprobe
parameter_list|(
name|struct
name|isa_device
modifier|*
name|dev
parameter_list|)
block|{
name|u_char
name|byte
decl_stmt|;
define|#
directive|define
name|SETLOW
value|0x55
define|#
directive|define
name|SETMID
value|0xaa
define|#
directive|define
name|SETHIGH
value|0x06
name|outb
argument_list|(
operator|(
name|dev
operator|->
name|id_iobase
operator|+
name|ADDR_CNTL
operator|)
argument_list|,
name|SETLOW
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|byte
operator|=
name|inb
argument_list|(
name|dev
operator|->
name|id_iobase
operator|+
name|ADDR_CNTL
argument_list|)
operator|)
operator|!=
name|SETLOW
condition|)
block|{
name|printf
argument_list|(
literal|"tina%d: probe low failed, 0x%x != 0x%x\n"
argument_list|,
name|dev
operator|->
name|id_unit
argument_list|,
name|byte
argument_list|,
name|SETLOW
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|outb
argument_list|(
operator|(
name|dev
operator|->
name|id_iobase
operator|+
name|ADDR_CNTM
operator|)
argument_list|,
name|SETMID
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|byte
operator|=
name|inb
argument_list|(
name|dev
operator|->
name|id_iobase
operator|+
name|ADDR_CNTM
argument_list|)
operator|)
operator|!=
name|SETMID
condition|)
block|{
name|printf
argument_list|(
literal|"tina%d: probe mid failed, 0x%x != 0x%x\n"
argument_list|,
name|dev
operator|->
name|id_unit
argument_list|,
name|byte
argument_list|,
name|SETMID
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|outb
argument_list|(
operator|(
name|dev
operator|->
name|id_iobase
operator|+
name|ADDR_CNTH
operator|)
argument_list|,
name|SETHIGH
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|byte
operator|=
name|inb
argument_list|(
name|dev
operator|->
name|id_iobase
operator|+
name|ADDR_CNTH
argument_list|)
operator|)
operator|&
literal|0x0f
operator|)
operator|!=
name|SETHIGH
condition|)
block|{
name|printf
argument_list|(
literal|"tina%d: probe high failed, 0x%x != 0x%x\n"
argument_list|,
name|dev
operator|->
name|id_unit
argument_list|,
name|byte
argument_list|,
name|SETHIGH
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|printf
argument_list|(
literal|"tina%d: status register = 0x%x\n"
argument_list|,
name|dev
operator|->
name|id_unit
argument_list|,
name|inb
argument_list|(
name|dev
operator|->
name|id_iobase
operator|+
name|CTRL_STAT
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
comment|/* board found */
block|}
end_function

begin_undef
undef|#
directive|undef
name|SETLOW
end_undef

begin_undef
undef|#
directive|undef
name|SETMID
end_undef

begin_undef
undef|#
directive|undef
name|SETHIGH
end_undef

begin_comment
comment|/*---------------------------------------------------------------------------*  *	tina - device driver attach routine  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|int
name|tinaattach
parameter_list|(
name|struct
name|isa_device
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|tina_softc
modifier|*
name|sc
init|=
operator|&
name|tina_sc
index|[
name|dev
operator|->
name|id_unit
index|]
decl_stmt|;
name|sc
operator|->
name|sc_unit
operator|=
name|dev
operator|->
name|id_unit
expr_stmt|;
name|sc
operator|->
name|sc_iobase
operator|=
name|dev
operator|->
name|id_iobase
expr_stmt|;
name|printf
argument_list|(
literal|"tina%d: attaching Tina-dd\n"
argument_list|,
name|dev
operator|->
name|id_unit
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	tina - device driver interrupt routine  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|tinaintr
parameter_list|(
name|int
name|unit
parameter_list|)
block|{ }
end_function

begin_if
if|#
directive|if
name|BSD
operator|>
literal|199306
operator|&&
name|defined
argument_list|(
name|__FreeBSD__
argument_list|)
end_if

begin_comment
comment|/*---------------------------------------------------------------------------*  *	initialization at kernel load time  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|tinainit
parameter_list|(
name|void
modifier|*
name|unused
parameter_list|)
block|{
name|cdevsw_add
argument_list|(
operator|&
name|tina_cdevsw
argument_list|)
expr_stmt|;
block|}
end_function

begin_expr_stmt
name|SYSINIT
argument_list|(
name|tinadev
argument_list|,
name|SI_SUB_DRIVERS
argument_list|,
name|SI_ORDER_MIDDLE
operator|+
name|CDEV_MAJOR
argument_list|,
operator|&
name|tinainit
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
end_expr_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* BSD> 199306&& defined(__FreeBSD__) */
end_comment

begin_comment
comment|/*---------------------------------------------------------------------------*  *	tinaopen - device driver open routine  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|int
name|tinaopen
parameter_list|(
name|dev_t
name|dev
parameter_list|,
name|int
name|flag
parameter_list|,
name|int
name|fmt
parameter_list|,
name|struct
name|proc
modifier|*
name|p
parameter_list|)
block|{
if|if
condition|(
name|minor
argument_list|(
name|dev
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
name|openflag
condition|)
return|return
operator|(
name|EBUSY
operator|)
return|;
name|openflag
operator|=
literal|1
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	tinaclose - device driver close routine  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|int
name|tinaclose
parameter_list|(
name|dev_t
name|dev
parameter_list|,
name|int
name|flag
parameter_list|,
name|int
name|fmt
parameter_list|,
name|struct
name|proc
modifier|*
name|p
parameter_list|)
block|{
name|openflag
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	tinaioctl - device driver ioctl routine  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|int
name|tinaioctl
parameter_list|(
name|dev_t
name|dev
parameter_list|,
name|u_long
name|cmd
parameter_list|,
name|caddr_t
name|data
parameter_list|,
name|int
name|flag
parameter_list|,
name|struct
name|proc
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|tina_softc
modifier|*
name|sc
init|=
operator|&
name|tina_sc
index|[
name|minor
argument_list|(
name|dev
argument_list|)
index|]
decl_stmt|;
name|u_short
name|iobase
init|=
name|sc
operator|->
name|sc_iobase
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|int
name|s
decl_stmt|;
if|if
condition|(
name|minor
argument_list|(
name|dev
argument_list|)
condition|)
return|return
operator|(
name|ENODEV
operator|)
return|;
name|s
operator|=
name|splimp
argument_list|()
expr_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
comment|/* hardware layer - control& status register */
case|case
name|ISDN_GETCSR
case|:
comment|/* return control register */
operator|*
operator|(
name|unsigned
name|char
operator|*
operator|)
name|data
operator|=
name|inb
argument_list|(
name|iobase
operator|+
name|CTRL_STAT
argument_list|)
expr_stmt|;
break|break;
case|case
name|ISDN_SETCSR
case|:
comment|/* set status register */
name|outb
argument_list|(
operator|(
name|iobase
operator|+
name|CTRL_STAT
operator|)
argument_list|,
operator|*
operator|(
name|unsigned
name|char
operator|*
operator|)
name|data
argument_list|)
expr_stmt|;
break|break;
comment|/* hardware layer - dual ported memory */
case|case
name|ISDN_GETBLK
case|:
comment|/* get block from dual port mem */
name|readblock
argument_list|(
name|iobase
argument_list|,
operator|(
operator|*
operator|(
expr|struct
name|record
operator|*
operator|)
name|data
operator|)
operator|.
name|addr
argument_list|,
operator|(
operator|*
operator|(
expr|struct
name|record
operator|*
operator|)
name|data
operator|)
operator|.
name|data
argument_list|,
operator|(
operator|*
operator|(
expr|struct
name|record
operator|*
operator|)
name|data
operator|)
operator|.
name|length
argument_list|)
expr_stmt|;
break|break;
case|case
name|ISDN_SETBLK
case|:
comment|/* write block to dual port mem */
name|writeblock
argument_list|(
name|iobase
argument_list|,
operator|(
operator|*
operator|(
expr|struct
name|record
operator|*
operator|)
name|data
operator|)
operator|.
name|data
argument_list|,
operator|(
operator|*
operator|(
expr|struct
name|record
operator|*
operator|)
name|data
operator|)
operator|.
name|addr
argument_list|,
operator|(
operator|*
operator|(
expr|struct
name|record
operator|*
operator|)
name|data
operator|)
operator|.
name|length
argument_list|)
expr_stmt|;
break|break;
default|default:
name|error
operator|=
name|ENOTTY
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	tinapoll - device driver poll routine  *---------------------------------------------------------------------------*/
end_comment

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__FreeBSD__
argument_list|)
operator|&&
name|__FreeBSD__
operator|>=
literal|3
end_if

begin_function
specifier|static
name|int
name|tinapoll
parameter_list|(
name|dev_t
name|dev
parameter_list|,
name|int
name|events
parameter_list|,
name|struct
name|proc
modifier|*
name|p
parameter_list|)
block|{
return|return
operator|(
name|ENODEV
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*===========================================================================*  *	tina dual ported memory access  *===========================================================================*/
end_comment

begin_comment
comment|/*---------------------------------------------------------------------------*  *	setup address for accessing tina-dd ram  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|setupaddr
parameter_list|(
name|unsigned
name|short
name|iobase
parameter_list|,
name|unsigned
name|int
name|addr
parameter_list|)
block|{
name|outb
argument_list|(
operator|(
name|iobase
operator|+
name|ADDR_CNTL
operator|)
argument_list|,
operator|(
name|unsigned
name|char
operator|)
name|addr
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|outb
argument_list|(
operator|(
name|iobase
operator|+
name|ADDR_CNTM
operator|)
argument_list|,
call|(
name|unsigned
name|char
call|)
argument_list|(
operator|(
name|addr
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
argument_list|)
expr_stmt|;
name|outb
argument_list|(
operator|(
name|iobase
operator|+
name|ADDR_CNTH
operator|)
argument_list|,
call|(
name|unsigned
name|char
call|)
argument_list|(
operator|(
name|addr
operator|>>
literal|16
operator|)
operator|&
literal|0xff
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	read block from tina-dd dual ported ram  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|readblock
parameter_list|(
name|unsigned
name|short
name|iobase
parameter_list|,
name|unsigned
name|int
name|addr
parameter_list|,
name|unsigned
name|char
modifier|*
name|dst
parameter_list|,
name|unsigned
name|int
name|len
parameter_list|)
block|{
name|setupaddr
argument_list|(
name|iobase
argument_list|,
name|addr
argument_list|)
expr_stmt|;
comment|/* setup start address */
while|while
condition|(
name|len
operator|--
condition|)
comment|/* tina-dd mem -> pc mem */
operator|*
name|dst
operator|++
operator|=
name|inb
argument_list|(
name|iobase
operator|+
name|DATA_LOW_INC
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	write block to tina-dd dual ported ram  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|writeblock
parameter_list|(
name|unsigned
name|short
name|iobase
parameter_list|,
name|unsigned
name|char
modifier|*
name|src
parameter_list|,
name|unsigned
name|long
name|addr
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|setupaddr
argument_list|(
name|iobase
argument_list|,
name|addr
argument_list|)
expr_stmt|;
comment|/* setup start address */
while|while
condition|(
name|len
operator|--
condition|)
comment|/* pc mem -> tina-dd mem */
name|outb
argument_list|(
operator|(
name|iobase
operator|+
name|DATA_LOW_INC
operator|)
argument_list|,
operator|*
name|src
operator|++
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* NTINA> 0 */
end_comment

end_unit


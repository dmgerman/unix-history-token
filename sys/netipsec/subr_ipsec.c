begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2016 Andrey V. Elsukov<ae@FreeBSD.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|"opt_inet.h"
end_include

begin_include
include|#
directive|include
file|"opt_inet6.h"
end_include

begin_include
include|#
directive|include
file|"opt_ipsec.h"
end_include

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/priv.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockopt.h>
end_include

begin_include
include|#
directive|include
file|<sys/syslog.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_pcb.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip6.h>
end_include

begin_include
include|#
directive|include
file|<netipsec/ipsec_support.h>
end_include

begin_include
include|#
directive|include
file|<netipsec/ipsec.h>
end_include

begin_include
include|#
directive|include
file|<netipsec/ipsec6.h>
end_include

begin_include
include|#
directive|include
file|<netipsec/key.h>
end_include

begin_include
include|#
directive|include
file|<netipsec/key_debug.h>
end_include

begin_include
include|#
directive|include
file|<machine/atomic.h>
end_include

begin_comment
comment|/*  * This file is build in the kernel only when 'options IPSEC' or  * 'options IPSEC_SUPPORT' is enabled.  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|INET
end_ifdef

begin_function
name|void
name|ipsec4_setsockaddrs
parameter_list|(
specifier|const
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|union
name|sockaddr_union
modifier|*
name|src
parameter_list|,
name|union
name|sockaddr_union
modifier|*
name|dst
parameter_list|)
block|{
specifier|static
specifier|const
name|struct
name|sockaddr_in
name|template
init|=
block|{
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
block|,
name|AF_INET
block|,
literal|0
block|,
block|{
literal|0
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
name|src
operator|->
name|sin
operator|=
name|template
expr_stmt|;
name|dst
operator|->
name|sin
operator|=
name|template
expr_stmt|;
if|if
condition|(
name|m
operator|->
name|m_len
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|ip
argument_list|)
condition|)
block|{
name|m_copydata
argument_list|(
name|m
argument_list|,
name|offsetof
argument_list|(
expr|struct
name|ip
argument_list|,
name|ip_src
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|src
operator|->
name|sin
operator|.
name|sin_addr
argument_list|)
expr_stmt|;
name|m_copydata
argument_list|(
name|m
argument_list|,
name|offsetof
argument_list|(
expr|struct
name|ip
argument_list|,
name|ip_dst
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|dst
operator|->
name|sin
operator|.
name|sin_addr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
specifier|const
name|struct
name|ip
modifier|*
name|ip
init|=
name|mtod
argument_list|(
name|m
argument_list|,
specifier|const
expr|struct
name|ip
operator|*
argument_list|)
decl_stmt|;
name|src
operator|->
name|sin
operator|.
name|sin_addr
operator|=
name|ip
operator|->
name|ip_src
expr_stmt|;
name|dst
operator|->
name|sin
operator|.
name|sin_addr
operator|=
name|ip
operator|->
name|ip_dst
expr_stmt|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|INET6
end_ifdef

begin_function
name|void
name|ipsec6_setsockaddrs
parameter_list|(
specifier|const
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|union
name|sockaddr_union
modifier|*
name|src
parameter_list|,
name|union
name|sockaddr_union
modifier|*
name|dst
parameter_list|)
block|{
name|struct
name|ip6_hdr
name|ip6buf
decl_stmt|;
specifier|const
name|struct
name|ip6_hdr
modifier|*
name|ip6
decl_stmt|;
if|if
condition|(
name|m
operator|->
name|m_len
operator|>=
sizeof|sizeof
argument_list|(
operator|*
name|ip6
argument_list|)
condition|)
name|ip6
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
specifier|const
expr|struct
name|ip6_hdr
operator|*
argument_list|)
expr_stmt|;
else|else
block|{
name|m_copydata
argument_list|(
name|m
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ip6buf
argument_list|)
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|ip6buf
argument_list|)
expr_stmt|;
name|ip6
operator|=
operator|&
name|ip6buf
expr_stmt|;
block|}
name|bzero
argument_list|(
operator|&
name|src
operator|->
name|sin6
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in6
argument_list|)
argument_list|)
expr_stmt|;
name|src
operator|->
name|sin6
operator|.
name|sin6_family
operator|=
name|AF_INET6
expr_stmt|;
name|src
operator|->
name|sin6
operator|.
name|sin6_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in6
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|&
name|ip6
operator|->
name|ip6_src
argument_list|,
operator|&
name|src
operator|->
name|sin6
operator|.
name|sin6_addr
argument_list|,
sizeof|sizeof
argument_list|(
name|ip6
operator|->
name|ip6_src
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|IN6_IS_SCOPE_LINKLOCAL
argument_list|(
operator|&
name|ip6
operator|->
name|ip6_src
argument_list|)
condition|)
block|{
name|src
operator|->
name|sin6
operator|.
name|sin6_addr
operator|.
name|s6_addr16
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|src
operator|->
name|sin6
operator|.
name|sin6_scope_id
operator|=
name|ntohs
argument_list|(
name|ip6
operator|->
name|ip6_src
operator|.
name|s6_addr16
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
name|bzero
argument_list|(
operator|&
name|dst
operator|->
name|sin6
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in6
argument_list|)
argument_list|)
expr_stmt|;
name|dst
operator|->
name|sin6
operator|.
name|sin6_family
operator|=
name|AF_INET6
expr_stmt|;
name|dst
operator|->
name|sin6
operator|.
name|sin6_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in6
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|&
name|ip6
operator|->
name|ip6_dst
argument_list|,
operator|&
name|dst
operator|->
name|sin6
operator|.
name|sin6_addr
argument_list|,
sizeof|sizeof
argument_list|(
name|ip6
operator|->
name|ip6_dst
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|IN6_IS_SCOPE_LINKLOCAL
argument_list|(
operator|&
name|ip6
operator|->
name|ip6_dst
argument_list|)
condition|)
block|{
name|dst
operator|->
name|sin6
operator|.
name|sin6_addr
operator|.
name|s6_addr16
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|dst
operator|->
name|sin6
operator|.
name|sin6_scope_id
operator|=
name|ntohs
argument_list|(
name|ip6
operator|->
name|ip6_dst
operator|.
name|s6_addr16
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|IPSEC_SUPPORT
end_ifdef

begin_comment
comment|/*  * IPSEC_SUPPORT - loading of ipsec.ko and tcpmd5.ko is supported.  * IPSEC + IPSEC_SUPPORT - loading tcpmd5.ko is supported.  * IPSEC + TCP_SIGNATURE - all is build in the kernel, do not build  *   IPSEC_SUPPORT.  */
end_comment

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|IPSEC
argument_list|)
operator|||
operator|!
name|defined
argument_list|(
name|TCP_SIGNATURE
argument_list|)
end_if

begin_define
define|#
directive|define
name|IPSEC_MODULE_INCR
value|2
end_define

begin_function
specifier|static
name|int
name|ipsec_kmod_enter
parameter_list|(
specifier|volatile
name|u_int
modifier|*
name|cntr
parameter_list|)
block|{
name|u_int
name|old
decl_stmt|,
name|new
decl_stmt|;
do|do
block|{
name|old
operator|=
operator|*
name|cntr
expr_stmt|;
if|if
condition|(
operator|(
name|old
operator|&
name|IPSEC_MODULE_ENABLED
operator|)
operator|==
literal|0
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|new
operator|=
name|old
operator|+
name|IPSEC_MODULE_INCR
expr_stmt|;
block|}
do|while
condition|(
name|atomic_cmpset_acq_int
argument_list|(
name|cntr
argument_list|,
name|old
argument_list|,
name|new
argument_list|)
operator|==
literal|0
condition|)
do|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ipsec_kmod_exit
parameter_list|(
specifier|volatile
name|u_int
modifier|*
name|cntr
parameter_list|)
block|{
name|u_int
name|old
decl_stmt|,
name|new
decl_stmt|;
do|do
block|{
name|old
operator|=
operator|*
name|cntr
expr_stmt|;
name|new
operator|=
name|old
operator|-
name|IPSEC_MODULE_INCR
expr_stmt|;
block|}
do|while
condition|(
name|atomic_cmpset_rel_int
argument_list|(
name|cntr
argument_list|,
name|old
argument_list|,
name|new
argument_list|)
operator|==
literal|0
condition|)
do|;
block|}
end_function

begin_function
specifier|static
name|void
name|ipsec_kmod_drain
parameter_list|(
specifier|volatile
name|u_int
modifier|*
name|cntr
parameter_list|)
block|{
name|u_int
name|old
decl_stmt|,
name|new
decl_stmt|;
do|do
block|{
name|old
operator|=
operator|*
name|cntr
expr_stmt|;
name|new
operator|=
name|old
operator|&
operator|~
name|IPSEC_MODULE_ENABLED
expr_stmt|;
block|}
do|while
condition|(
name|atomic_cmpset_acq_int
argument_list|(
name|cntr
argument_list|,
name|old
argument_list|,
name|new
argument_list|)
operator|==
literal|0
condition|)
do|;
while|while
condition|(
name|atomic_cmpset_int
argument_list|(
name|cntr
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
operator|==
literal|0
condition|)
name|pause
argument_list|(
literal|"ipsecd"
argument_list|,
name|hz
operator|/
literal|2
argument_list|)
expr_stmt|;
block|}
end_function

begin_define
define|#
directive|define
name|METHOD_DECL
parameter_list|(
modifier|...
parameter_list|)
value|__VA_ARGS__
end_define

begin_define
define|#
directive|define
name|METHOD_ARGS
parameter_list|(
modifier|...
parameter_list|)
value|__VA_ARGS__
end_define

begin_define
define|#
directive|define
name|IPSEC_KMOD_METHOD
parameter_list|(
name|type
parameter_list|,
name|name
parameter_list|,
name|sc
parameter_list|,
name|method
parameter_list|,
name|decl
parameter_list|,
name|args
parameter_list|)
define|\
value|type name (decl)							\ {									\ 	type ret = (type)ipsec_kmod_enter(&sc->enabled);		\ 	if (ret == 0) {							\ 		ret = (*sc->methods->method)(args);			\ 		ipsec_kmod_exit(&sc->enabled);				\ 	}								\ 	return (ret);							\ }
end_define

begin_function
specifier|static
name|int
name|ipsec_support_modevent
parameter_list|(
name|module_t
name|mod
parameter_list|,
name|int
name|type
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|MOD_LOAD
case|:
return|return
operator|(
literal|0
operator|)
return|;
case|case
name|MOD_UNLOAD
case|:
return|return
operator|(
name|EBUSY
operator|)
return|;
default|default:
return|return
operator|(
name|EOPNOTSUPP
operator|)
return|;
block|}
block|}
end_function

begin_decl_stmt
specifier|static
name|moduledata_t
name|ipsec_support_mod
init|=
block|{
literal|"ipsec_support"
block|,
name|ipsec_support_modevent
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DECLARE_MODULE
argument_list|(
name|ipsec_support
argument_list|,
name|ipsec_support_mod
argument_list|,
name|SI_SUB_PROTO_DOMAIN
argument_list|,
name|SI_ORDER_ANY
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_VERSION
argument_list|(
name|ipsec_support
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* !IPSEC || !TCP_SIGNATURE */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|TCP_SIGNATURE
end_ifndef

begin_comment
comment|/* Declare TCP-MD5 support as kernel module. */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|tcpmd5_support
name|tcpmd5_ipsec
init|=
block|{
operator|.
name|enabled
operator|=
literal|0
block|,
operator|.
name|methods
operator|=
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|tcpmd5_support
modifier|*
specifier|const
name|tcp_ipsec_support
init|=
operator|&
name|tcpmd5_ipsec
decl_stmt|;
end_decl_stmt

begin_macro
name|IPSEC_KMOD_METHOD
argument_list|(
argument|int
argument_list|,
argument|tcpmd5_kmod_input
argument_list|,
argument|sc
argument_list|,
argument|input
argument_list|,
argument|METHOD_DECL(struct tcpmd5_support * const sc, struct mbuf *m, 	struct tcphdr *th, u_char *buf)
argument_list|,
argument|METHOD_ARGS(m, th, buf)
argument_list|)
end_macro

begin_macro
name|IPSEC_KMOD_METHOD
argument_list|(
argument|int
argument_list|,
argument|tcpmd5_kmod_output
argument_list|,
argument|sc
argument_list|,
argument|output
argument_list|,
argument|METHOD_DECL(struct tcpmd5_support * const sc, struct mbuf *m, 	struct tcphdr *th, u_char *buf)
argument_list|,
argument|METHOD_ARGS(m, th, buf)
argument_list|)
end_macro

begin_macro
name|IPSEC_KMOD_METHOD
argument_list|(
argument|int
argument_list|,
argument|tcpmd5_kmod_pcbctl
argument_list|,
argument|sc
argument_list|,
argument|pcbctl
argument_list|,
argument|METHOD_DECL(struct tcpmd5_support * const sc, struct inpcb *inp, 	struct sockopt *sopt)
argument_list|,
argument|METHOD_ARGS(inp, sopt)
argument_list|)
end_macro

begin_function
name|void
name|tcpmd5_support_enable
parameter_list|(
specifier|const
name|struct
name|tcpmd5_methods
modifier|*
specifier|const
name|methods
parameter_list|)
block|{
name|KASSERT
argument_list|(
name|tcp_ipsec_support
operator|->
name|enabled
operator|==
literal|0
argument_list|,
operator|(
literal|"TCP-MD5 already enabled"
operator|)
argument_list|)
expr_stmt|;
name|tcp_ipsec_support
operator|->
name|methods
operator|=
name|methods
expr_stmt|;
name|tcp_ipsec_support
operator|->
name|enabled
operator||=
name|IPSEC_MODULE_ENABLED
expr_stmt|;
block|}
end_function

begin_function
name|void
name|tcpmd5_support_disable
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
name|tcp_ipsec_support
operator|->
name|enabled
operator|&
name|IPSEC_MODULE_ENABLED
condition|)
block|{
name|ipsec_kmod_drain
argument_list|(
operator|&
name|tcp_ipsec_support
operator|->
name|enabled
argument_list|)
expr_stmt|;
name|tcp_ipsec_support
operator|->
name|methods
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* !TCP_SIGNATURE */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|IPSEC
end_ifndef

begin_comment
comment|/*  * IPsec support is build as kernel module.  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|INET
end_ifdef

begin_decl_stmt
specifier|static
name|struct
name|ipsec_support
name|ipv4_ipsec
init|=
block|{
operator|.
name|enabled
operator|=
literal|0
block|,
operator|.
name|methods
operator|=
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|ipsec_support
modifier|*
specifier|const
name|ipv4_ipsec_support
init|=
operator|&
name|ipv4_ipsec
decl_stmt|;
end_decl_stmt

begin_macro
name|IPSEC_KMOD_METHOD
argument_list|(
argument|int
argument_list|,
argument|ipsec_kmod_udp_input
argument_list|,
argument|sc
argument_list|,
argument|udp_input
argument_list|,
argument|METHOD_DECL(struct ipsec_support * const sc, struct mbuf *m, 	int off, int af)
argument_list|,
argument|METHOD_ARGS(m, off, af)
argument_list|)
end_macro

begin_macro
name|IPSEC_KMOD_METHOD
argument_list|(
argument|int
argument_list|,
argument|ipsec_kmod_udp_pcbctl
argument_list|,
argument|sc
argument_list|,
argument|udp_pcbctl
argument_list|,
argument|METHOD_DECL(struct ipsec_support * const sc, struct inpcb *inp, 	struct sockopt *sopt)
argument_list|,
argument|METHOD_ARGS(inp, sopt)
argument_list|)
end_macro

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|INET6
end_ifdef

begin_decl_stmt
specifier|static
name|struct
name|ipsec_support
name|ipv6_ipsec
init|=
block|{
operator|.
name|enabled
operator|=
literal|0
block|,
operator|.
name|methods
operator|=
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|ipsec_support
modifier|*
specifier|const
name|ipv6_ipsec_support
init|=
operator|&
name|ipv6_ipsec
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_macro
name|IPSEC_KMOD_METHOD
argument_list|(
argument|int
argument_list|,
argument|ipsec_kmod_input
argument_list|,
argument|sc
argument_list|,
argument|input
argument_list|,
argument|METHOD_DECL(struct ipsec_support * const sc, struct mbuf *m, 	int offset, int proto)
argument_list|,
argument|METHOD_ARGS(m, offset, proto)
argument_list|)
end_macro

begin_macro
name|IPSEC_KMOD_METHOD
argument_list|(
argument|int
argument_list|,
argument|ipsec_kmod_check_policy
argument_list|,
argument|sc
argument_list|,
argument|check_policy
argument_list|,
argument|METHOD_DECL(struct ipsec_support * const sc, struct mbuf *m, 	struct inpcb *inp)
argument_list|,
argument|METHOD_ARGS(m, inp)
argument_list|)
end_macro

begin_macro
name|IPSEC_KMOD_METHOD
argument_list|(
argument|int
argument_list|,
argument|ipsec_kmod_forward
argument_list|,
argument|sc
argument_list|,
argument|forward
argument_list|,
argument|METHOD_DECL(struct ipsec_support * const sc, struct mbuf *m)
argument_list|,
argument|(m)
argument_list|)
end_macro

begin_macro
name|IPSEC_KMOD_METHOD
argument_list|(
argument|int
argument_list|,
argument|ipsec_kmod_output
argument_list|,
argument|sc
argument_list|,
argument|output
argument_list|,
argument|METHOD_DECL(struct ipsec_support * const sc, struct mbuf *m, 	struct inpcb *inp)
argument_list|,
argument|METHOD_ARGS(m, inp)
argument_list|)
end_macro

begin_macro
name|IPSEC_KMOD_METHOD
argument_list|(
argument|int
argument_list|,
argument|ipsec_kmod_pcbctl
argument_list|,
argument|sc
argument_list|,
argument|pcbctl
argument_list|,
argument|METHOD_DECL(struct ipsec_support * const sc, struct inpcb *inp, 	struct sockopt *sopt)
argument_list|,
argument|METHOD_ARGS(inp, sopt)
argument_list|)
end_macro

begin_macro
name|IPSEC_KMOD_METHOD
argument_list|(
argument|size_t
argument_list|,
argument|ipsec_kmod_hdrsize
argument_list|,
argument|sc
argument_list|,
argument|hdrsize
argument_list|,
argument|METHOD_DECL(struct ipsec_support * const sc, struct inpcb *inp)
argument_list|,
argument|(inp)
argument_list|)
end_macro

begin_expr_stmt
specifier|static
name|IPSEC_KMOD_METHOD
argument_list|(
argument|int
argument_list|,
argument|ipsec_kmod_caps
argument_list|,
argument|sc
argument_list|,
argument|capability
argument_list|,
argument|METHOD_DECL(struct ipsec_support * const sc, struct mbuf *m, 	u_int cap)
argument_list|,
argument|METHOD_ARGS(m, cap)
argument_list|)
name|int
name|ipsec_kmod_capability
argument_list|(
argument|struct ipsec_support * const sc
argument_list|,
argument|struct mbuf *m
argument_list|,
argument|u_int cap
argument_list|)
block|{
comment|/* 	 * Since PF_KEY is build in the kernel, we can directly 	 * call key_havesp() without additional synchronizations. 	 */
if|if
condition|(
name|cap
operator|==
name|IPSEC_CAP_OPERABLE
condition|)
return|return
operator|(
name|key_havesp
argument_list|(
name|IPSEC_DIR_INBOUND
argument_list|)
operator|!=
literal|0
operator|||
name|key_havesp
argument_list|(
name|IPSEC_DIR_OUTBOUND
argument_list|)
operator|!=
literal|0
operator|)
return|;
end_expr_stmt

begin_return
return|return
operator|(
name|ipsec_kmod_caps
argument_list|(
name|sc
argument_list|,
name|m
argument_list|,
name|cap
argument_list|)
operator|)
return|;
end_return

begin_macro
unit|}  void
name|ipsec_support_enable
argument_list|(
argument|struct ipsec_support * const sc
argument_list|,
argument|const struct ipsec_methods * const methods
argument_list|)
end_macro

begin_block
block|{
name|KASSERT
argument_list|(
name|sc
operator|->
name|enabled
operator|==
literal|0
argument_list|,
operator|(
literal|"IPsec already enabled"
operator|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|methods
operator|=
name|methods
expr_stmt|;
name|sc
operator|->
name|enabled
operator||=
name|IPSEC_MODULE_ENABLED
expr_stmt|;
block|}
end_block

begin_function
name|void
name|ipsec_support_disable
parameter_list|(
name|struct
name|ipsec_support
modifier|*
specifier|const
name|sc
parameter_list|)
block|{
if|if
condition|(
name|sc
operator|->
name|enabled
operator|&
name|IPSEC_MODULE_ENABLED
condition|)
block|{
name|ipsec_kmod_drain
argument_list|(
operator|&
name|sc
operator|->
name|enabled
argument_list|)
expr_stmt|;
name|sc
operator|->
name|methods
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* !IPSEC */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* IPSEC_SUPPORT */
end_comment

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) Dirk Husemann, Computer Science Department IV,  * 		 University of Erlangen-Nuremberg, Germany, 1990, 1991, 1992  * Copyright (c) 1992, 1993  *	The Regents of the University of California.  All rights reserved.  *  * This code is derived from software contributed to Berkeley by  * Dirk Husemann and the Computer Science Department (IV) of  * the University of Erlangen-Nuremberg, Germany.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. All advertising materials mentioning features or use of this software  *    must display the following acknowledgement:  *	This product includes software developed by the University of  *	California, Berkeley and its contributors.  * 4. Neither the name of the University nor the names of its contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  *	@(#)llc_subr.c	8.1 (Berkeley) 6/10/93  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/domain.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/protosw.h>
end_include

begin_include
include|#
directive|include
file|<sys/socketvar.h>
end_include

begin_include
include|#
directive|include
file|<sys/errno.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_dl.h>
end_include

begin_include
include|#
directive|include
file|<net/if_llc.h>
end_include

begin_include
include|#
directive|include
file|<net/route.h>
end_include

begin_include
include|#
directive|include
file|<netccitt/dll.h>
end_include

begin_include
include|#
directive|include
file|<netccitt/llc_var.h>
end_include

begin_comment
comment|/*  * Frame names for diagnostic messages  */
end_comment

begin_decl_stmt
name|char
modifier|*
name|frame_names
index|[]
init|=
block|{
literal|"INFO"
block|,
literal|"RR"
block|,
literal|"RNR"
block|,
literal|"REJ"
block|,
literal|"DM"
block|,
literal|"SABME"
block|,
literal|"DISC"
block|,
literal|"UA"
block|,
literal|"FRMR"
block|,
literal|"UI"
block|,
literal|"XID"
block|,
literal|"TEST"
block|,
literal|"ILLEGAL"
block|,
literal|"TIMER"
block|,
literal|"N2xT1"
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Trace level  */
end_comment

begin_decl_stmt
name|int
name|llc_tracelevel
init|=
name|LLCTR_URGENT
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Values for accessing various bitfields  */
end_comment

begin_decl_stmt
name|struct
name|bitslice
name|llc_bitslice
index|[]
init|=
block|{
comment|/*	  mask, shift value */
block|{
literal|0x1
block|,
literal|0x0
block|}
block|,
block|{
literal|0xfe
block|,
literal|0x1
block|}
block|,
block|{
literal|0x3
block|,
literal|0x0
block|}
block|,
block|{
literal|0xc
block|,
literal|0x2
block|}
block|,
block|{
literal|0x10
block|,
literal|0x4
block|}
block|,
block|{
literal|0xe0
block|,
literal|0x5
block|}
block|,
block|{
literal|0x1f
block|,
literal|0x0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * We keep the link control blocks on a doubly linked list -  * primarily for checking in llc_time()  */
end_comment

begin_decl_stmt
name|struct
name|llccb_q
name|llccb_q
init|=
block|{
operator|&
name|llccb_q
block|,
operator|&
name|llccb_q
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Flag for signalling wether route tree for AF_LINK has been  * initialized yet.  */
end_comment

begin_decl_stmt
name|int
name|af_link_rts_init_done
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Functions dealing with struct sockaddr_dl */
end_comment

begin_comment
comment|/* Compare sdl_a w/ sdl_b */
end_comment

begin_macro
name|sdl_cmp
argument_list|(
argument|struct sockaddr_dl *sdl_a
argument_list|,
argument|struct sockaddr_dl *sdl_b
argument_list|)
end_macro

begin_block
block|{
if|if
condition|(
name|LLADDRLEN
argument_list|(
name|sdl_a
argument_list|)
operator|!=
name|LLADDRLEN
argument_list|(
name|sdl_b
argument_list|)
condition|)
return|return
operator|(
literal|1
operator|)
return|;
return|return
operator|(
name|bcmp
argument_list|(
operator|(
name|caddr_t
operator|)
name|sdl_a
operator|->
name|sdl_data
argument_list|,
operator|(
name|caddr_t
operator|)
name|sdl_b
operator|->
name|sdl_data
argument_list|,
name|LLADDRLEN
argument_list|(
name|sdl_a
argument_list|)
argument_list|)
operator|)
return|;
block|}
end_block

begin_comment
comment|/* Copy sdl_f to sdl_t */
end_comment

begin_macro
name|sdl_copy
argument_list|(
argument|struct sockaddr_dl *sdl_f
argument_list|,
argument|struct sockaddr_dl *sdl_t
argument_list|)
end_macro

begin_block
block|{
name|bcopy
argument_list|(
operator|(
name|caddr_t
operator|)
name|sdl_f
argument_list|,
operator|(
name|caddr_t
operator|)
name|sdl_t
argument_list|,
name|sdl_f
operator|->
name|sdl_len
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* Swap sdl_a w/ sdl_b */
end_comment

begin_macro
name|sdl_swapaddr
argument_list|(
argument|struct sockaddr_dl *sdl_a
argument_list|,
argument|struct sockaddr_dl *sdl_b
argument_list|)
end_macro

begin_block
block|{
name|struct
name|sockaddr_dl
name|sdl_tmp
decl_stmt|;
name|sdl_copy
argument_list|(
name|sdl_a
argument_list|,
operator|&
name|sdl_tmp
argument_list|)
expr_stmt|;
name|sdl_copy
argument_list|(
name|sdl_b
argument_list|,
name|sdl_a
argument_list|)
expr_stmt|;
name|sdl_copy
argument_list|(
operator|&
name|sdl_tmp
argument_list|,
name|sdl_b
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* Fetch the sdl of the associated if */
end_comment

begin_function
name|struct
name|sockaddr_dl
modifier|*
name|sdl_getaddrif
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
specifier|register
name|struct
name|ifaddr
modifier|*
name|ifa
decl_stmt|;
for|for
control|(
name|ifa
operator|=
name|ifp
operator|->
name|if_addrlist
init|;
name|ifa
condition|;
name|ifa
operator|=
name|ifa
operator|->
name|ifa_next
control|)
if|if
condition|(
name|ifa
operator|->
name|ifa_addr
operator|->
name|sa_family
operator|==
name|AF_LINK
condition|)
return|return
operator|(
operator|(
expr|struct
name|sockaddr_dl
operator|*
operator|)
operator|(
name|ifa
operator|->
name|ifa_addr
operator|)
operator|)
return|;
return|return
operator|(
operator|(
expr|struct
name|sockaddr_dl
operator|*
operator|)
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Check addr of interface with the one given */
end_comment

begin_macro
name|sdl_checkaddrif
argument_list|(
argument|struct ifnet *ifp
argument_list|,
argument|struct sockaddr_dl *sdl_c
argument_list|)
end_macro

begin_block
block|{
specifier|register
name|struct
name|ifaddr
modifier|*
name|ifa
decl_stmt|;
for|for
control|(
name|ifa
operator|=
name|ifp
operator|->
name|if_addrlist
init|;
name|ifa
condition|;
name|ifa
operator|=
name|ifa
operator|->
name|ifa_next
control|)
if|if
condition|(
operator|(
name|ifa
operator|->
name|ifa_addr
operator|->
name|sa_family
operator|==
name|AF_LINK
operator|)
operator|&&
operator|!
name|sdl_cmp
argument_list|(
operator|(
expr|struct
name|sockaddr_dl
operator|*
operator|)
operator|(
name|ifa
operator|->
name|ifa_addr
operator|)
argument_list|,
name|sdl_c
argument_list|)
condition|)
return|return
operator|(
literal|1
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_comment
comment|/* Build an sdl from MAC addr, DLSAP addr, and interface */
end_comment

begin_macro
name|sdl_setaddrif
argument_list|(
argument|struct ifnet *ifp
argument_list|,
argument|u_char *mac_addr
argument_list|,
argument|u_char dlsap_addr
argument_list|,
argument|u_char mac_len
argument_list|,
argument|struct sockaddr_dl *sdl_to
argument_list|)
end_macro

begin_block
block|{
specifier|register
name|struct
name|sockaddr_dl
modifier|*
name|sdl_tmp
decl_stmt|;
if|if
condition|(
operator|(
name|sdl_tmp
operator|=
name|sdl_getaddrif
argument_list|(
name|ifp
argument_list|)
operator|)
condition|)
block|{
name|sdl_copy
argument_list|(
name|sdl_tmp
argument_list|,
name|sdl_to
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|(
name|caddr_t
operator|)
name|mac_addr
argument_list|,
operator|(
name|caddr_t
operator|)
name|LLADDR
argument_list|(
name|sdl_to
argument_list|)
argument_list|,
name|mac_len
argument_list|)
expr_stmt|;
operator|*
operator|(
name|LLADDR
argument_list|(
name|sdl_to
argument_list|)
operator|+
name|mac_len
operator|)
operator|=
name|dlsap_addr
expr_stmt|;
name|sdl_to
operator|->
name|sdl_alen
operator|=
name|mac_len
operator|+
literal|1
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
else|else
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_comment
comment|/* Fill out the sdl header aggregate */
end_comment

begin_macro
name|sdl_sethdrif
argument_list|(
argument|struct ifnet *ifp
argument_list|,
argument|u_char *mac_src
argument_list|,
argument|u_char dlsap_src
argument_list|,
argument|u_char *mac_dst
argument_list|,
argument|u_char dlsap_dst
argument_list|,
argument|u_char mac_len
argument_list|,
argument|struct sdl_hdr *sdlhdr_to
argument_list|)
end_macro

begin_block
block|{
if|if
condition|(
operator|!
name|sdl_setaddrif
argument_list|(
name|ifp
argument_list|,
name|mac_src
argument_list|,
name|dlsap_src
argument_list|,
name|mac_len
argument_list|,
operator|&
name|sdlhdr_to
operator|->
name|sdlhdr_src
argument_list|)
operator|||
operator|!
name|sdl_setaddrif
argument_list|(
name|ifp
argument_list|,
name|mac_dst
argument_list|,
name|dlsap_dst
argument_list|,
name|mac_len
argument_list|,
operator|&
name|sdlhdr_to
operator|->
name|sdlhdr_dst
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
else|else
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_block

begin_decl_stmt
specifier|static
name|struct
name|sockaddr_dl
name|sap_saddr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|sockaddr_dl
name|sap_sgate
init|=
block|{
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_dl
argument_list|)
block|,
comment|/* _len */
name|AF_LINK
comment|/* _af */
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Set sapinfo for SAP address, llcconfig, af, and interface  */
end_comment

begin_function
name|struct
name|npaidbentry
modifier|*
name|llc_setsapinfo
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|u_char
name|af
parameter_list|,
name|u_char
name|sap
parameter_list|,
name|struct
name|dllconfig
modifier|*
name|llconf
parameter_list|)
block|{
name|struct
name|protosw
modifier|*
name|pp
decl_stmt|;
name|struct
name|sockaddr_dl
modifier|*
name|ifdl_addr
decl_stmt|;
name|struct
name|rtentry
modifier|*
name|sirt
init|=
operator|(
expr|struct
name|rtentry
operator|*
operator|)
literal|0
decl_stmt|;
name|struct
name|npaidbentry
modifier|*
name|sapinfo
decl_stmt|;
name|u_char
name|saploc
decl_stmt|;
name|int
name|size
init|=
sizeof|sizeof
argument_list|(
expr|struct
name|npaidbentry
argument_list|)
decl_stmt|;
name|USES_AF_LINK_RTS
expr_stmt|;
comment|/* 	 * We rely/assume that only STREAM protocols will make use of 	 * connection oriented LLC2. If this will one day not be the 	 * case this will obviously fail. 	 */
name|pp
operator|=
name|pffindtype
argument_list|(
name|af
argument_list|,
name|SOCK_STREAM
argument_list|)
expr_stmt|;
if|if
condition|(
name|pp
operator|==
literal|0
operator|||
name|pp
operator|->
name|pr_input
operator|==
literal|0
operator|||
name|pp
operator|->
name|pr_ctlinput
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"network	level protosw error"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* 	 * We need a way to jot down the LLC2 configuration for 	 * a certain LSAP address. To do this we enter 	 * a "route" for the SAP. 	 */
name|ifdl_addr
operator|=
name|sdl_getaddrif
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|sdl_copy
argument_list|(
name|ifdl_addr
argument_list|,
operator|&
name|sap_saddr
argument_list|)
expr_stmt|;
name|sdl_copy
argument_list|(
name|ifdl_addr
argument_list|,
operator|&
name|sap_sgate
argument_list|)
expr_stmt|;
name|saploc
operator|=
name|LLSAPLOC
argument_list|(
operator|&
name|sap_saddr
argument_list|,
name|ifp
argument_list|)
expr_stmt|;
name|sap_saddr
operator|.
name|sdl_data
index|[
name|saploc
index|]
operator|=
name|sap
expr_stmt|;
name|sap_saddr
operator|.
name|sdl_alen
operator|++
expr_stmt|;
comment|/* now enter it */
name|rtrequest
argument_list|(
name|RTM_ADD
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|sap_saddr
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|sap_sgate
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|sirt
argument_list|)
expr_stmt|;
if|if
condition|(
name|sirt
operator|==
literal|0
condition|)
return|return
literal|0
return|;
comment|/* Plug in config information in rt->rt_llinfo */
name|sirt
operator|->
name|rt_llinfo
operator|=
name|malloc
argument_list|(
name|size
argument_list|,
name|M_PCB
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|sapinfo
operator|=
operator|(
expr|struct
name|npaidbentry
operator|*
operator|)
name|sirt
operator|->
name|rt_llinfo
expr_stmt|;
if|if
condition|(
name|sapinfo
condition|)
block|{
name|bzero
argument_list|(
operator|(
name|caddr_t
operator|)
name|sapinfo
argument_list|,
name|size
argument_list|)
expr_stmt|;
comment|/* 		 * For the time being we support LLC CLASS II here 		 * only 		 */
name|sapinfo
operator|->
name|si_class
operator|=
name|LLC_CLASS_II
expr_stmt|;
name|sapinfo
operator|->
name|si_window
operator|=
name|llconf
operator|->
name|dllcfg_window
expr_stmt|;
name|sapinfo
operator|->
name|si_trace
operator|=
name|llconf
operator|->
name|dllcfg_trace
expr_stmt|;
if|if
condition|(
name|sapinfo
operator|->
name|si_trace
condition|)
name|llc_tracelevel
operator|--
expr_stmt|;
else|else
name|llc_tracelevel
operator|++
expr_stmt|;
name|sapinfo
operator|->
name|si_input
operator|=
name|pp
operator|->
name|pr_input
expr_stmt|;
name|sapinfo
operator|->
name|si_ctlinput
operator|=
operator|(
name|caddr_t
argument_list|(
operator|*
argument_list|)
argument_list|()
operator|)
name|pp
operator|->
name|pr_ctlinput
expr_stmt|;
return|return
operator|(
name|sapinfo
operator|)
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Get sapinfo for SAP address and interface  */
end_comment

begin_function
name|struct
name|npaidbentry
modifier|*
name|llc_getsapinfo
parameter_list|(
name|u_char
name|sap
parameter_list|,
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|struct
name|sockaddr_dl
modifier|*
name|ifdl_addr
decl_stmt|;
name|struct
name|sockaddr_dl
name|si_addr
decl_stmt|;
name|struct
name|rtentry
modifier|*
name|sirt
decl_stmt|;
name|u_char
name|saploc
decl_stmt|;
name|USES_AF_LINK_RTS
expr_stmt|;
name|ifdl_addr
operator|=
name|sdl_getaddrif
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|sdl_copy
argument_list|(
name|ifdl_addr
argument_list|,
operator|&
name|si_addr
argument_list|)
expr_stmt|;
name|saploc
operator|=
name|LLSAPLOC
argument_list|(
operator|&
name|si_addr
argument_list|,
name|ifp
argument_list|)
expr_stmt|;
name|si_addr
operator|.
name|sdl_data
index|[
name|saploc
index|]
operator|=
name|sap
expr_stmt|;
name|si_addr
operator|.
name|sdl_alen
operator|++
expr_stmt|;
if|if
condition|(
operator|(
name|sirt
operator|=
name|rtalloc1
argument_list|(
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|si_addr
argument_list|,
literal|0
argument_list|,
literal|0UL
argument_list|)
operator|)
condition|)
name|sirt
operator|->
name|rt_refcnt
operator|--
expr_stmt|;
else|else
return|return
operator|(
literal|0
operator|)
return|;
return|return
operator|(
operator|(
expr|struct
name|npaidbentry
operator|*
operator|)
name|sirt
operator|->
name|rt_llinfo
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * llc_seq2slot() --- We only allocate enough memory to hold the window. This  * introduces the necessity to keep track of two ``pointers''  *  *        o llcl_freeslot     the next free slot to be used  *                            this one advances modulo llcl_window  *        o llcl_projvs       the V(S) associated with the next frame  *                            to be set via llcl_freeslot  *                            this one advances modulo LLC_MAX_SEQUENCE  *  * A new frame is inserted at llcl_output_buffers[llcl_freeslot], after  * which both llcl_freeslot and llcl_projvs are incremented.  *  * The slot sl(sn) for any given sequence number sn is given by  *  *        sl(sn) = (llcl_freeslot + llcl_window - 1 - (llcl_projvs +  *                  LLC_MAX_SEQUENCE- sn) % LLC_MAX_SEQUENCE) %  *                  llcl_window  *  * i.e. we first calculate the number of frames we need to ``go back''  * from the current one (really the next one, but that doesn't matter as  * llcl_projvs is likewise of by plus one) and subtract that from the  * pointer to the most recently taken frame (llcl_freeslot - 1).  */
end_comment

begin_function
name|short
name|llc_seq2slot
parameter_list|(
name|struct
name|llc_linkcb
modifier|*
name|linkp
parameter_list|,
name|short
name|seqn
parameter_list|)
block|{
specifier|register
name|sn
operator|=
literal|0
expr_stmt|;
name|sn
operator|=
operator|(
name|linkp
operator|->
name|llcl_freeslot
operator|+
name|linkp
operator|->
name|llcl_window
operator|-
operator|(
name|linkp
operator|->
name|llcl_projvs
operator|+
name|LLC_MAX_SEQUENCE
operator|-
name|seqn
operator|)
operator|%
name|LLC_MAX_SEQUENCE
operator|)
operator|%
name|linkp
operator|->
name|llcl_window
expr_stmt|;
return|return
name|sn
return|;
block|}
end_function

begin_comment
comment|/*  * LLC2 link state handler  *  * There is in most cases one function per LLC2 state. The LLC2 standard  * ISO 8802-2 allows in some cases for ambiguities, i.e. we have the choice  * to do one thing or the other. Right now I have just chosen one but have also  * indicated the spot by "multiple possibilities". One could make the behavior  * in those cases configurable, allowing the superuser to enter a profile word  * (32/64 bits, whatever is needed) that would suit her needs [I quite like  * that idea, perhaps I'll get around to it].  *  * [Preceeding each state handler function is the description as taken from  * ISO 8802-2, section 7.9.2.1]  */
end_comment

begin_comment
comment|/*  * ADM --- The connection component is in the asynchronous disconnected mode.  *         It can accept an SABME PDU from a remote LLC SSAP or, at the request  *         of the service access point user, can initiate an SABME PDU  *         transmission to a remote LLC DSAP, to establish a data link  *         connection. It also responds to a DISC command PDU and to any  *         command PDU with the P bit set to ``1''.  */
end_comment

begin_function
name|int
name|llc_state_ADM
parameter_list|(
name|struct
name|llc_linkcb
modifier|*
name|linkp
parameter_list|,
name|struct
name|llc
modifier|*
name|frame
parameter_list|,
name|int
name|frame_kind
parameter_list|,
name|int
name|cmdrsp
parameter_list|,
name|int
name|pollfinal
parameter_list|)
block|{
name|int
name|action
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|frame_kind
operator|+
name|cmdrsp
condition|)
block|{
case|case
name|NL_CONNECT_REQUEST
case|:
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_SABME
argument_list|,
name|LLC_CMD
argument_list|,
name|pollfinal
argument_list|)
expr_stmt|;
name|LLC_SETFLAG
argument_list|(
name|linkp
argument_list|,
name|P
argument_list|,
name|pollfinal
argument_list|)
expr_stmt|;
name|LLC_SETFLAG
argument_list|(
name|linkp
argument_list|,
name|S
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|linkp
operator|->
name|llcl_retry
operator|=
literal|0
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|SETUP
argument_list|)
expr_stmt|;
break|break;
case|case
name|LLCFT_SABME
operator|+
name|LLC_CMD
case|:
comment|/* 		 * ISO 8802-2, table 7-1, ADM state says to set 		 * the P flag, yet this will cause an SABME [P] to be 		 * answered with an UA only, not an UA [F], all 		 * other `disconnected' states set the F flag, so ... 		 */
name|LLC_SETFLAG
argument_list|(
name|linkp
argument_list|,
name|F
argument_list|,
name|pollfinal
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|CONN
argument_list|)
expr_stmt|;
name|action
operator|=
name|LLC_CONNECT_INDICATION
expr_stmt|;
break|break;
case|case
name|LLCFT_DISC
operator|+
name|LLC_CMD
case|:
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_DM
argument_list|,
name|LLC_RSP
argument_list|,
name|pollfinal
argument_list|)
expr_stmt|;
break|break;
default|default:
if|if
condition|(
name|cmdrsp
operator|==
name|LLC_CMD
operator|&&
name|pollfinal
operator|==
literal|1
condition|)
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_DM
argument_list|,
name|LLC_RSP
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* remain in ADM state */
block|}
return|return
name|action
return|;
block|}
end_function

begin_comment
comment|/*  * CONN --- The local connection component has received an SABME PDU from a  *          remote LLC SSAP, and it is waiting for the local user to accept or  *          refuse the connection.  */
end_comment

begin_function
name|int
name|llc_state_CONN
parameter_list|(
name|struct
name|llc_linkcb
modifier|*
name|linkp
parameter_list|,
name|struct
name|llc
modifier|*
name|frame
parameter_list|,
name|int
name|frame_kind
parameter_list|,
name|int
name|cmdrsp
parameter_list|,
name|int
name|pollfinal
parameter_list|)
block|{
name|int
name|action
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|frame_kind
operator|+
name|cmdrsp
condition|)
block|{
case|case
name|NL_CONNECT_RESPONSE
case|:
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_UA
argument_list|,
name|LLC_RSP
argument_list|,
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|F
argument_list|)
argument_list|)
expr_stmt|;
name|LLC_RESETCOUNTER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_SETFLAG
argument_list|(
name|linkp
argument_list|,
name|P
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LLC_SETFLAG
argument_list|(
name|linkp
argument_list|,
name|REMOTE_BUSY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|NORMAL
argument_list|)
expr_stmt|;
break|break;
case|case
name|NL_DISCONNECT_REQUEST
case|:
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_DM
argument_list|,
name|LLC_RSP
argument_list|,
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|F
argument_list|)
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|ADM
argument_list|)
expr_stmt|;
break|break;
case|case
name|LLCFT_SABME
operator|+
name|LLC_CMD
case|:
name|LLC_SETFLAG
argument_list|(
name|linkp
argument_list|,
name|F
argument_list|,
name|pollfinal
argument_list|)
expr_stmt|;
break|break;
case|case
name|LLCFT_DM
operator|+
name|LLC_RSP
case|:
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|ADM
argument_list|)
expr_stmt|;
name|action
operator|=
name|LLC_DISCONNECT_INDICATION
expr_stmt|;
break|break;
comment|/* all other frames effect nothing here */
block|}
return|return
name|action
return|;
block|}
end_function

begin_comment
comment|/*  * RESET_WAIT --- The local connection component is waiting for the local user  *                 to indicate a RESET_REQUEST or a DISCONNECT_REQUEST.  */
end_comment

begin_function
name|int
name|llc_state_RESET_WAIT
parameter_list|(
name|struct
name|llc_linkcb
modifier|*
name|linkp
parameter_list|,
name|struct
name|llc
modifier|*
name|frame
parameter_list|,
name|int
name|frame_kind
parameter_list|,
name|int
name|cmdrsp
parameter_list|,
name|int
name|pollfinal
parameter_list|)
block|{
name|int
name|action
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|frame_kind
operator|+
name|cmdrsp
condition|)
block|{
case|case
name|NL_RESET_REQUEST
case|:
if|if
condition|(
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|S
argument_list|)
operator|==
literal|0
condition|)
block|{
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_SABME
argument_list|,
name|LLC_CMD
argument_list|,
name|pollfinal
argument_list|)
expr_stmt|;
name|LLC_SETFLAG
argument_list|(
name|linkp
argument_list|,
name|P
argument_list|,
name|pollfinal
argument_list|)
expr_stmt|;
name|LLC_START_ACK_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|linkp
operator|->
name|llcl_retry
operator|=
literal|0
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|RESET
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_UA
argument_list|,
name|LLC_RSP
argument_list|,
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|F
argument_list|)
argument_list|)
expr_stmt|;
name|LLC_RESETCOUNTER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_SETFLAG
argument_list|(
name|linkp
argument_list|,
name|P
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LLC_SETFLAG
argument_list|(
name|linkp
argument_list|,
name|REMOTE_BUSY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|NORMAL
argument_list|)
expr_stmt|;
name|action
operator|=
name|LLC_RESET_CONFIRM
expr_stmt|;
block|}
break|break;
case|case
name|NL_DISCONNECT_REQUEST
case|:
if|if
condition|(
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|S
argument_list|)
operator|==
literal|0
condition|)
block|{
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_DISC
argument_list|,
name|LLC_CMD
argument_list|,
name|pollfinal
argument_list|)
expr_stmt|;
name|LLC_SETFLAG
argument_list|(
name|linkp
argument_list|,
name|P
argument_list|,
name|pollfinal
argument_list|)
expr_stmt|;
name|LLC_START_ACK_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|linkp
operator|->
name|llcl_retry
operator|=
literal|0
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|D_CONN
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_DM
argument_list|,
name|LLC_RSP
argument_list|,
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|F
argument_list|)
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|ADM
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|LLCFT_DM
operator|+
name|LLC_RSP
case|:
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|ADM
argument_list|)
expr_stmt|;
name|action
operator|=
name|LLC_DISCONNECT_INDICATION
expr_stmt|;
break|break;
case|case
name|LLCFT_SABME
operator|+
name|LLC_CMD
case|:
name|LLC_SETFLAG
argument_list|(
name|linkp
argument_list|,
name|S
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LLC_SETFLAG
argument_list|(
name|linkp
argument_list|,
name|F
argument_list|,
name|pollfinal
argument_list|)
expr_stmt|;
break|break;
case|case
name|LLCFT_DISC
operator|+
name|LLC_CMD
case|:
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_DM
argument_list|,
name|LLC_RSP
argument_list|,
name|pollfinal
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|ADM
argument_list|)
expr_stmt|;
name|action
operator|=
name|LLC_DISCONNECT_INDICATION
expr_stmt|;
break|break;
block|}
return|return
name|action
return|;
block|}
end_function

begin_comment
comment|/*  * RESET_CHECK --- The local connection component is waiting for the local user  *                 to accept or refuse a remote reset request.  */
end_comment

begin_function
name|int
name|llc_state_RESET_CHECK
parameter_list|(
name|struct
name|llc_linkcb
modifier|*
name|linkp
parameter_list|,
name|struct
name|llc
modifier|*
name|frame
parameter_list|,
name|int
name|frame_kind
parameter_list|,
name|int
name|cmdrsp
parameter_list|,
name|int
name|pollfinal
parameter_list|)
block|{
name|int
name|action
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|frame_kind
operator|+
name|cmdrsp
condition|)
block|{
case|case
name|NL_RESET_RESPONSE
case|:
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_UA
argument_list|,
name|LLC_RSP
argument_list|,
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|F
argument_list|)
argument_list|)
expr_stmt|;
name|LLC_RESETCOUNTER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_SETFLAG
argument_list|(
name|linkp
argument_list|,
name|P
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LLC_SETFLAG
argument_list|(
name|linkp
argument_list|,
name|REMOTE_BUSY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|NORMAL
argument_list|)
expr_stmt|;
break|break;
case|case
name|NL_DISCONNECT_REQUEST
case|:
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_DM
argument_list|,
name|LLC_RSP
argument_list|,
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|F
argument_list|)
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|ADM
argument_list|)
expr_stmt|;
break|break;
case|case
name|LLCFT_DM
operator|+
name|LLC_RSP
case|:
name|action
operator|=
name|LLC_DISCONNECT_INDICATION
expr_stmt|;
break|break;
case|case
name|LLCFT_SABME
operator|+
name|LLC_CMD
case|:
name|LLC_SETFLAG
argument_list|(
name|linkp
argument_list|,
name|F
argument_list|,
name|pollfinal
argument_list|)
expr_stmt|;
break|break;
case|case
name|LLCFT_DISC
operator|+
name|LLC_CMD
case|:
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_DM
argument_list|,
name|LLC_RSP
argument_list|,
name|pollfinal
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|ADM
argument_list|)
expr_stmt|;
name|action
operator|=
name|LLC_DISCONNECT_INDICATION
expr_stmt|;
break|break;
block|}
return|return
name|action
return|;
block|}
end_function

begin_comment
comment|/*  * SETUP --- The connection component has transmitted an SABME command PDU to a  *           remote LLC DSAP and is waiting for a reply.  */
end_comment

begin_function
name|int
name|llc_state_SETUP
parameter_list|(
name|struct
name|llc_linkcb
modifier|*
name|linkp
parameter_list|,
name|struct
name|llc
modifier|*
name|frame
parameter_list|,
name|int
name|frame_kind
parameter_list|,
name|int
name|cmdrsp
parameter_list|,
name|int
name|pollfinal
parameter_list|)
block|{
name|int
name|action
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|frame_kind
operator|+
name|cmdrsp
condition|)
block|{
case|case
name|LLCFT_SABME
operator|+
name|LLC_CMD
case|:
name|LLC_RESETCOUNTER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_UA
argument_list|,
name|LLC_RSP
argument_list|,
name|pollfinal
argument_list|)
expr_stmt|;
name|LLC_SETFLAG
argument_list|(
name|linkp
argument_list|,
name|S
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|LLCFT_UA
operator|+
name|LLC_RSP
case|:
if|if
condition|(
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|P
argument_list|)
operator|==
name|pollfinal
condition|)
block|{
name|LLC_STOP_ACK_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_RESETCOUNTER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_UPDATE_P_FLAG
argument_list|(
name|linkp
argument_list|,
name|cmdrsp
argument_list|,
name|pollfinal
argument_list|)
expr_stmt|;
name|LLC_SETFLAG
argument_list|(
name|linkp
argument_list|,
name|REMOTE_BUSY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|NORMAL
argument_list|)
expr_stmt|;
name|action
operator|=
name|LLC_CONNECT_CONFIRM
expr_stmt|;
block|}
break|break;
case|case
name|LLC_ACK_TIMER_EXPIRED
case|:
if|if
condition|(
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|S
argument_list|)
operator|==
literal|1
condition|)
block|{
name|LLC_SETFLAG
argument_list|(
name|linkp
argument_list|,
name|P
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LLC_SETFLAG
argument_list|(
name|linkp
argument_list|,
name|REMOTE_BUSY
argument_list|,
literal|0
argument_list|)
operator|,
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|NORMAL
argument_list|)
expr_stmt|;
name|action
operator|=
name|LLC_CONNECT_CONFIRM
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|linkp
operator|->
name|llcl_retry
operator|<
name|llc_n2
condition|)
block|{
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_SABME
argument_list|,
name|LLC_CMD
argument_list|,
name|pollfinal
argument_list|)
expr_stmt|;
name|LLC_SETFLAG
argument_list|(
name|linkp
argument_list|,
name|P
argument_list|,
name|pollfinal
argument_list|)
expr_stmt|;
name|LLC_START_ACK_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|linkp
operator|->
name|llcl_retry
operator|++
expr_stmt|;
block|}
else|else
block|{
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|ADM
argument_list|)
expr_stmt|;
name|action
operator|=
name|LLC_DISCONNECT_INDICATION
expr_stmt|;
block|}
break|break;
case|case
name|LLCFT_DISC
operator|+
name|LLC_CMD
case|:
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_DM
argument_list|,
name|LLC_RSP
argument_list|,
name|pollfinal
argument_list|)
expr_stmt|;
name|LLC_STOP_ACK_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|ADM
argument_list|)
expr_stmt|;
name|action
operator|=
name|LLC_DISCONNECT_INDICATION
expr_stmt|;
break|break;
case|case
name|LLCFT_DM
operator|+
name|LLC_RSP
case|:
name|LLC_STOP_ACK_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|ADM
argument_list|)
expr_stmt|;
name|action
operator|=
name|LLC_DISCONNECT_INDICATION
expr_stmt|;
break|break;
block|}
return|return
name|action
return|;
block|}
end_function

begin_comment
comment|/*  * RESET --- As a result of a service access point user request or the receipt  *           of a FRMR response PDU, the local connection component has sent an  *           SABME command PDU to the remote LLC DSAP to reset the data link  *           connection and is waiting for a reply.  */
end_comment

begin_function
name|int
name|llc_state_RESET
parameter_list|(
name|struct
name|llc_linkcb
modifier|*
name|linkp
parameter_list|,
name|struct
name|llc
modifier|*
name|frame
parameter_list|,
name|int
name|frame_kind
parameter_list|,
name|int
name|cmdrsp
parameter_list|,
name|int
name|pollfinal
parameter_list|)
block|{
name|int
name|action
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|frame_kind
operator|+
name|cmdrsp
condition|)
block|{
case|case
name|LLCFT_SABME
operator|+
name|LLC_CMD
case|:
name|LLC_RESETCOUNTER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_SETFLAG
argument_list|(
name|linkp
argument_list|,
name|S
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_UA
argument_list|,
name|LLC_RSP
argument_list|,
name|pollfinal
argument_list|)
expr_stmt|;
break|break;
case|case
name|LLCFT_UA
operator|+
name|LLC_RSP
case|:
if|if
condition|(
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|P
argument_list|)
operator|==
name|pollfinal
condition|)
block|{
name|LLC_STOP_ACK_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_RESETCOUNTER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_UPDATE_P_FLAG
argument_list|(
name|linkp
argument_list|,
name|cmdrsp
argument_list|,
name|pollfinal
argument_list|)
expr_stmt|;
name|LLC_SETFLAG
argument_list|(
name|linkp
argument_list|,
name|REMOTE_BUSY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|NORMAL
argument_list|)
expr_stmt|;
name|action
operator|=
name|LLC_RESET_CONFIRM
expr_stmt|;
block|}
break|break;
case|case
name|LLC_ACK_TIMER_EXPIRED
case|:
if|if
condition|(
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|S
argument_list|)
operator|==
literal|1
condition|)
block|{
name|LLC_SETFLAG
argument_list|(
name|linkp
argument_list|,
name|P
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LLC_SETFLAG
argument_list|(
name|linkp
argument_list|,
name|REMOTE_BUSY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|NORMAL
argument_list|)
expr_stmt|;
name|action
operator|=
name|LLC_RESET_CONFIRM
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|linkp
operator|->
name|llcl_retry
operator|<
name|llc_n2
condition|)
block|{
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_SABME
argument_list|,
name|LLC_CMD
argument_list|,
name|pollfinal
argument_list|)
expr_stmt|;
name|LLC_SETFLAG
argument_list|(
name|linkp
argument_list|,
name|P
argument_list|,
name|pollfinal
argument_list|)
expr_stmt|;
name|LLC_START_ACK_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|linkp
operator|->
name|llcl_retry
operator|++
expr_stmt|;
block|}
else|else
block|{
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|ADM
argument_list|)
expr_stmt|;
name|action
operator|=
name|LLC_DISCONNECT_INDICATION
expr_stmt|;
block|}
break|break;
case|case
name|LLCFT_DISC
operator|+
name|LLC_CMD
case|:
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_DM
argument_list|,
name|LLC_RSP
argument_list|,
name|pollfinal
argument_list|)
expr_stmt|;
name|LLC_STOP_ACK_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|ADM
argument_list|)
expr_stmt|;
name|action
operator|=
name|LLC_DISCONNECT_INDICATION
expr_stmt|;
break|break;
case|case
name|LLCFT_DM
operator|+
name|LLC_RSP
case|:
name|LLC_STOP_ACK_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|ADM
argument_list|)
expr_stmt|;
name|action
operator|=
name|LLC_DISCONNECT_INDICATION
expr_stmt|;
break|break;
block|}
return|return
name|action
return|;
block|}
end_function

begin_comment
comment|/*  * D_CONN --- At the request of the service access point user, the local LLC  *            has sent a DISC command PDU to the remote LLC DSAP and is waiting  *            for a reply.  */
end_comment

begin_function
name|int
name|llc_state_D_CONN
parameter_list|(
name|struct
name|llc_linkcb
modifier|*
name|linkp
parameter_list|,
name|struct
name|llc
modifier|*
name|frame
parameter_list|,
name|int
name|frame_kind
parameter_list|,
name|int
name|cmdrsp
parameter_list|,
name|int
name|pollfinal
parameter_list|)
block|{
name|int
name|action
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|frame_kind
operator|+
name|cmdrsp
condition|)
block|{
case|case
name|LLCFT_SABME
operator|+
name|LLC_CMD
case|:
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_DM
argument_list|,
name|LLC_RSP
argument_list|,
name|pollfinal
argument_list|)
expr_stmt|;
name|LLC_STOP_ACK_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|ADM
argument_list|)
expr_stmt|;
break|break;
case|case
name|LLCFT_UA
operator|+
name|LLC_RSP
case|:
if|if
condition|(
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|P
argument_list|)
operator|==
name|pollfinal
condition|)
block|{
name|LLC_STOP_ACK_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|ADM
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|LLCFT_DISC
operator|+
name|LLC_CMD
case|:
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_UA
argument_list|,
name|LLC_RSP
argument_list|,
name|pollfinal
argument_list|)
expr_stmt|;
break|break;
case|case
name|LLCFT_DM
operator|+
name|LLC_RSP
case|:
name|LLC_STOP_ACK_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|ADM
argument_list|)
expr_stmt|;
break|break;
case|case
name|LLC_ACK_TIMER_EXPIRED
case|:
if|if
condition|(
name|linkp
operator|->
name|llcl_retry
operator|<
name|llc_n2
condition|)
block|{
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_DISC
argument_list|,
name|LLC_CMD
argument_list|,
name|pollfinal
argument_list|)
expr_stmt|;
name|LLC_SETFLAG
argument_list|(
name|linkp
argument_list|,
name|P
argument_list|,
name|pollfinal
argument_list|)
expr_stmt|;
name|LLC_START_ACK_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|linkp
operator|->
name|llcl_retry
operator|++
expr_stmt|;
block|}
else|else
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|ADM
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
name|action
return|;
block|}
end_function

begin_comment
comment|/*  * ERROR --- The local connection component has detected an error in a received  *           PDU and has sent a FRMR response PDU. It is waiting for a reply from  *           the remote connection component.  */
end_comment

begin_function
name|int
name|llc_state_ERROR
parameter_list|(
name|struct
name|llc_linkcb
modifier|*
name|linkp
parameter_list|,
name|struct
name|llc
modifier|*
name|frame
parameter_list|,
name|int
name|frame_kind
parameter_list|,
name|int
name|cmdrsp
parameter_list|,
name|int
name|pollfinal
parameter_list|)
block|{
name|int
name|action
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|frame_kind
operator|+
name|cmdrsp
condition|)
block|{
case|case
name|LLCFT_SABME
operator|+
name|LLC_CMD
case|:
name|LLC_STOP_ACK_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|RESET_CHECK
argument_list|)
expr_stmt|;
name|action
operator|=
name|LLC_RESET_INDICATION_REMOTE
expr_stmt|;
break|break;
case|case
name|LLCFT_DISC
operator|+
name|LLC_CMD
case|:
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_UA
argument_list|,
name|LLC_RSP
argument_list|,
name|pollfinal
argument_list|)
expr_stmt|;
name|LLC_STOP_ACK_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|ADM
argument_list|)
expr_stmt|;
name|action
operator|=
name|LLC_DISCONNECT_INDICATION
expr_stmt|;
break|break;
case|case
name|LLCFT_DM
operator|+
name|LLC_RSP
case|:
name|LLC_STOP_ACK_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|ADM
argument_list|)
expr_stmt|;
name|action
operator|=
name|LLC_DISCONNECT_INDICATION
expr_stmt|;
break|break;
case|case
name|LLCFT_FRMR
operator|+
name|LLC_RSP
case|:
name|LLC_STOP_ACK_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_SETFLAG
argument_list|(
name|linkp
argument_list|,
name|S
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|RESET_WAIT
argument_list|)
expr_stmt|;
name|action
operator|=
name|LLC_FRMR_RECEIVED
expr_stmt|;
break|break;
case|case
name|LLC_ACK_TIMER_EXPIRED
case|:
if|if
condition|(
name|linkp
operator|->
name|llcl_retry
operator|<
name|llc_n2
condition|)
block|{
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_FRMR
argument_list|,
name|LLC_RSP
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LLC_START_ACK_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|linkp
operator|->
name|llcl_retry
operator|++
expr_stmt|;
block|}
else|else
block|{
name|LLC_SETFLAG
argument_list|(
name|linkp
argument_list|,
name|S
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|RESET_WAIT
argument_list|)
expr_stmt|;
name|action
operator|=
name|LLC_RESET_INDICATION_LOCAL
expr_stmt|;
block|}
break|break;
default|default:
if|if
condition|(
name|cmdrsp
operator|==
name|LLC_CMD
condition|)
block|{
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_FRMR
argument_list|,
name|LLC_RSP
argument_list|,
name|pollfinal
argument_list|)
expr_stmt|;
name|LLC_START_ACK_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
return|return
name|action
return|;
block|}
end_function

begin_comment
comment|/*  * NORMAL, BUSY, REJECT, AWAIT, AWAIT_BUSY, and AWAIT_REJECT all share  * a common core state handler.  */
end_comment

begin_function
name|int
name|llc_state_NBRAcore
parameter_list|(
name|struct
name|llc_linkcb
modifier|*
name|linkp
parameter_list|,
name|struct
name|llc
modifier|*
name|frame
parameter_list|,
name|int
name|frame_kind
parameter_list|,
name|int
name|cmdrsp
parameter_list|,
name|int
name|pollfinal
parameter_list|)
block|{
name|int
name|action
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|frame_kind
operator|+
name|cmdrsp
condition|)
block|{
case|case
name|NL_DISCONNECT_REQUEST
case|:
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_DISC
argument_list|,
name|LLC_CMD
argument_list|,
name|pollfinal
argument_list|)
expr_stmt|;
name|LLC_SETFLAG
argument_list|(
name|linkp
argument_list|,
name|P
argument_list|,
name|pollfinal
argument_list|)
expr_stmt|;
name|LLC_STOP_ALL_TIMERS
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_START_ACK_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|linkp
operator|->
name|llcl_retry
operator|=
literal|0
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|D_CONN
argument_list|)
expr_stmt|;
break|break;
case|case
name|NL_RESET_REQUEST
case|:
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_SABME
argument_list|,
name|LLC_CMD
argument_list|,
name|pollfinal
argument_list|)
expr_stmt|;
name|LLC_SETFLAG
argument_list|(
name|linkp
argument_list|,
name|P
argument_list|,
name|pollfinal
argument_list|)
expr_stmt|;
name|LLC_STOP_ALL_TIMERS
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_START_ACK_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|linkp
operator|->
name|llcl_retry
operator|=
literal|0
expr_stmt|;
name|LLC_SETFLAG
argument_list|(
name|linkp
argument_list|,
name|S
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|RESET
argument_list|)
expr_stmt|;
break|break;
case|case
name|LLCFT_SABME
operator|+
name|LLC_CMD
case|:
name|LLC_SETFLAG
argument_list|(
name|linkp
argument_list|,
name|F
argument_list|,
name|pollfinal
argument_list|)
expr_stmt|;
name|LLC_STOP_ALL_TIMERS
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|RESET_CHECK
argument_list|)
expr_stmt|;
name|action
operator|=
name|LLC_RESET_INDICATION_REMOTE
expr_stmt|;
break|break;
case|case
name|LLCFT_DISC
operator|+
name|LLC_CMD
case|:
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_UA
argument_list|,
name|LLC_RSP
argument_list|,
name|pollfinal
argument_list|)
expr_stmt|;
name|LLC_STOP_ALL_TIMERS
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|ADM
argument_list|)
expr_stmt|;
name|action
operator|=
name|LLC_DISCONNECT_INDICATION
expr_stmt|;
break|break;
case|case
name|LLCFT_FRMR
operator|+
name|LLC_RSP
case|:
name|LLC_STOP_ALL_TIMERS
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_SETFLAG
argument_list|(
name|linkp
argument_list|,
name|S
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|RESET_WAIT
argument_list|)
expr_stmt|;
name|action
operator|=
name|LLC_FRMR_RECEIVED
expr_stmt|;
break|break;
case|case
name|LLCFT_DM
operator|+
name|LLC_RSP
case|:
name|LLC_STOP_ALL_TIMERS
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|ADM
argument_list|)
expr_stmt|;
name|action
operator|=
name|LLC_DISCONNECT_INDICATION
expr_stmt|;
break|break;
case|case
name|LLC_INVALID_NR
operator|+
name|LLC_CMD
case|:
case|case
name|LLC_INVALID_NS
operator|+
name|LLC_CMD
case|:
name|LLC_SETFRMR
argument_list|(
name|linkp
argument_list|,
name|frame
argument_list|,
name|cmdrsp
argument_list|,
operator|(
name|frame_kind
operator|==
name|LLC_INVALID_NR
condition|?
name|LLC_FRMR_Z
else|:
operator|(
name|LLC_FRMR_V
operator||
name|LLC_FRMR_W
operator|)
operator|)
argument_list|)
expr_stmt|;
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_FRMR
argument_list|,
name|LLC_RSP
argument_list|,
name|pollfinal
argument_list|)
expr_stmt|;
name|LLC_STOP_ALL_TIMERS
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_START_ACK_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|linkp
operator|->
name|llcl_retry
operator|=
literal|0
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
name|action
operator|=
name|LLC_FRMR_SENT
expr_stmt|;
break|break;
case|case
name|LLC_INVALID_NR
operator|+
name|LLC_RSP
case|:
case|case
name|LLC_INVALID_NS
operator|+
name|LLC_RSP
case|:
case|case
name|LLCFT_UA
operator|+
name|LLC_RSP
case|:
case|case
name|LLC_BAD_PDU
case|:
block|{
name|char
name|frmrcause
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|frame_kind
condition|)
block|{
case|case
name|LLC_INVALID_NR
case|:
name|frmrcause
operator|=
name|LLC_FRMR_Z
expr_stmt|;
break|break;
case|case
name|LLC_INVALID_NS
case|:
name|frmrcause
operator|=
name|LLC_FRMR_V
operator||
name|LLC_FRMR_W
expr_stmt|;
break|break;
default|default:
name|frmrcause
operator|=
name|LLC_FRMR_W
expr_stmt|;
block|}
name|LLC_SETFRMR
argument_list|(
name|linkp
argument_list|,
name|frame
argument_list|,
name|cmdrsp
argument_list|,
name|frmrcause
argument_list|)
expr_stmt|;
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_FRMR
argument_list|,
name|LLC_RSP
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LLC_STOP_ALL_TIMERS
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_START_ACK_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|linkp
operator|->
name|llcl_retry
operator|=
literal|0
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
name|action
operator|=
name|LLC_FRMR_SENT
expr_stmt|;
break|break;
block|}
default|default:
if|if
condition|(
name|cmdrsp
operator|==
name|LLC_RSP
operator|&&
name|pollfinal
operator|==
literal|1
operator|&&
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|P
argument_list|)
operator|==
literal|0
condition|)
block|{
name|LLC_SETFRMR
argument_list|(
name|linkp
argument_list|,
name|frame
argument_list|,
name|cmdrsp
argument_list|,
name|LLC_FRMR_W
argument_list|)
expr_stmt|;
name|LLC_STOP_ALL_TIMERS
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_START_ACK_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|linkp
operator|->
name|llcl_retry
operator|=
literal|0
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
name|action
operator|=
name|LLC_FRMR_SENT
expr_stmt|;
block|}
break|break;
case|case
name|LLC_P_TIMER_EXPIRED
case|:
case|case
name|LLC_ACK_TIMER_EXPIRED
case|:
case|case
name|LLC_REJ_TIMER_EXPIRED
case|:
case|case
name|LLC_BUSY_TIMER_EXPIRED
case|:
if|if
condition|(
name|linkp
operator|->
name|llcl_retry
operator|>=
name|llc_n2
condition|)
block|{
name|LLC_STOP_ALL_TIMERS
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_SETFLAG
argument_list|(
name|linkp
argument_list|,
name|S
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|RESET_WAIT
argument_list|)
expr_stmt|;
name|action
operator|=
name|LLC_RESET_INDICATION_LOCAL
expr_stmt|;
block|}
break|break;
block|}
return|return
name|action
return|;
block|}
end_function

begin_comment
comment|/*  * NORMAL --- A data link connection exists between the local LLC service access  *            point and the remote LLC service access point. Sending and  *            reception of information and supervisory PDUs can be performed.  */
end_comment

begin_function
name|int
name|llc_state_NORMAL
parameter_list|(
name|struct
name|llc_linkcb
modifier|*
name|linkp
parameter_list|,
name|struct
name|llc
modifier|*
name|frame
parameter_list|,
name|int
name|frame_kind
parameter_list|,
name|int
name|cmdrsp
parameter_list|,
name|int
name|pollfinal
parameter_list|)
block|{
name|int
name|action
init|=
name|LLC_PASSITON
decl_stmt|;
switch|switch
condition|(
name|frame_kind
operator|+
name|cmdrsp
condition|)
block|{
case|case
name|NL_DATA_REQUEST
case|:
if|if
condition|(
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|REMOTE_BUSY
argument_list|)
operator|==
literal|0
condition|)
block|{
ifdef|#
directive|ifdef
name|not_now
if|if
condition|(
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|P
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* multiple possibilities */
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_INFO
argument_list|,
name|LLC_CMD
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LLC_START_P_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
if|if
condition|(
name|LLC_TIMERXPIRED
argument_list|(
name|linkp
argument_list|,
name|ACK
argument_list|)
operator|!=
name|LLC_TIMER_RUNNING
condition|)
name|LLC_START_ACK_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
endif|#
directive|endif
comment|/* multiple possibilities */
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_INFO
argument_list|,
name|LLC_CMD
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|LLC_TIMERXPIRED
argument_list|(
name|linkp
argument_list|,
name|ACK
argument_list|)
operator|!=
name|LLC_TIMER_RUNNING
condition|)
name|LLC_START_ACK_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|not_now
block|}
endif|#
directive|endif
name|action
operator|=
literal|0
expr_stmt|;
block|}
break|break;
case|case
name|LLC_LOCAL_BUSY_DETECTED
case|:
if|if
condition|(
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|P
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* multiple possibilities --- action-wise */
comment|/* multiple possibilities --- CMD/RSP-wise */
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_RNR
argument_list|,
name|LLC_CMD
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LLC_START_P_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_SETFLAG
argument_list|(
name|linkp
argument_list|,
name|DATA
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|BUSY
argument_list|)
expr_stmt|;
name|action
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
comment|/* multiple possibilities --- CMD/RSP-wise */
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_RNR
argument_list|,
name|LLC_CMD
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LLC_SETFLAG
argument_list|(
name|linkp
argument_list|,
name|DATA
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|BUSY
argument_list|)
expr_stmt|;
name|action
operator|=
literal|0
expr_stmt|;
block|}
break|break;
case|case
name|LLC_INVALID_NS
operator|+
name|LLC_CMD
case|:
case|case
name|LLC_INVALID_NS
operator|+
name|LLC_RSP
case|:
block|{
specifier|register
name|int
name|p
init|=
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|P
argument_list|)
decl_stmt|;
specifier|register
name|int
name|nr
init|=
name|LLCGBITS
argument_list|(
name|frame
operator|->
name|llc_control_ext
argument_list|,
name|s_nr
argument_list|)
decl_stmt|;
if|if
condition|(
name|cmdrsp
operator|==
name|LLC_CMD
operator|&&
name|pollfinal
operator|==
literal|1
condition|)
block|{
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_REJ
argument_list|,
name|LLC_RSP
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|LLC_START_REJ_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|REJECT
argument_list|)
expr_stmt|;
name|action
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pollfinal
operator|==
literal|0
operator|&&
name|p
operator|==
literal|1
condition|)
block|{
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_REJ
argument_list|,
name|LLC_CMD
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|LLC_START_REJ_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|REJECT
argument_list|)
expr_stmt|;
name|action
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|pollfinal
operator|==
literal|0
operator|&&
name|p
operator|==
literal|0
operator|)
operator|||
operator|(
name|pollfinal
operator|==
literal|1
operator|&&
name|p
operator|==
literal|1
operator|&&
name|cmdrsp
operator|==
name|LLC_RSP
operator|)
condition|)
block|{
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_REJ
argument_list|,
name|LLC_CMD
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|LLC_START_P_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_START_REJ_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmdrsp
operator|==
name|LLC_RSP
operator|&&
name|pollfinal
operator|==
literal|1
condition|)
block|{
name|LLC_CLEAR_REMOTE_BUSY
argument_list|(
name|linkp
argument_list|,
name|action
argument_list|)
expr_stmt|;
block|}
else|else
name|action
operator|=
literal|0
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|REJECT
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
case|case
name|LLCFT_INFO
operator|+
name|LLC_CMD
case|:
case|case
name|LLCFT_INFO
operator|+
name|LLC_RSP
case|:
block|{
specifier|register
name|int
name|p
init|=
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|P
argument_list|)
decl_stmt|;
specifier|register
name|int
name|nr
init|=
name|LLCGBITS
argument_list|(
name|frame
operator|->
name|llc_control_ext
argument_list|,
name|s_nr
argument_list|)
decl_stmt|;
if|if
condition|(
name|cmdrsp
operator|==
name|LLC_CMD
operator|&&
name|pollfinal
operator|==
literal|1
condition|)
block|{
name|LLC_INC
argument_list|(
name|linkp
operator|->
name|llcl_vr
argument_list|)
expr_stmt|;
name|LLC_SENDACKNOWLEDGE
argument_list|(
name|linkp
argument_list|,
name|LLC_RSP
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|action
operator|=
name|LLC_DATA_INDICATION
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pollfinal
operator|==
literal|0
operator|&&
name|p
operator|==
literal|1
condition|)
block|{
name|LLC_INC
argument_list|(
name|linkp
operator|->
name|llcl_vr
argument_list|)
expr_stmt|;
name|LLC_SENDACKNOWLEDGE
argument_list|(
name|linkp
argument_list|,
name|LLC_CMD
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|action
operator|=
name|LLC_DATA_INDICATION
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|pollfinal
operator|==
literal|0
operator|&&
name|p
operator|==
literal|0
operator|&&
name|cmdrsp
operator|==
name|LLC_CMD
operator|)
operator|||
operator|(
name|pollfinal
operator|==
name|p
operator|&&
name|cmdrsp
operator|==
name|LLC_RSP
operator|)
condition|)
block|{
name|LLC_INC
argument_list|(
name|linkp
operator|->
name|llcl_vr
argument_list|)
expr_stmt|;
name|LLC_UPDATE_P_FLAG
argument_list|(
name|linkp
argument_list|,
name|cmdrsp
argument_list|,
name|pollfinal
argument_list|)
expr_stmt|;
name|LLC_SENDACKNOWLEDGE
argument_list|(
name|linkp
argument_list|,
name|LLC_CMD
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmdrsp
operator|==
name|LLC_RSP
operator|&&
name|pollfinal
operator|==
literal|1
condition|)
name|LLC_CLEAR_REMOTE_BUSY
argument_list|(
name|linkp
argument_list|,
name|action
argument_list|)
expr_stmt|;
name|action
operator|=
name|LLC_DATA_INDICATION
expr_stmt|;
block|}
break|break;
block|}
case|case
name|LLCFT_RR
operator|+
name|LLC_CMD
case|:
case|case
name|LLCFT_RR
operator|+
name|LLC_RSP
case|:
block|{
specifier|register
name|int
name|p
init|=
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|P
argument_list|)
decl_stmt|;
specifier|register
name|int
name|nr
init|=
name|LLCGBITS
argument_list|(
name|frame
operator|->
name|llc_control_ext
argument_list|,
name|s_nr
argument_list|)
decl_stmt|;
if|if
condition|(
name|cmdrsp
operator|==
name|LLC_CMD
operator|&&
name|pollfinal
operator|==
literal|1
condition|)
block|{
name|LLC_SENDACKNOWLEDGE
argument_list|(
name|linkp
argument_list|,
name|LLC_RSP
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|LLC_CLEAR_REMOTE_BUSY
argument_list|(
name|linkp
argument_list|,
name|action
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|pollfinal
operator|==
literal|0
operator|)
operator|||
operator|(
name|cmdrsp
operator|==
name|LLC_RSP
operator|&&
name|pollfinal
operator|==
literal|1
operator|&&
name|p
operator|==
literal|1
operator|)
condition|)
block|{
name|LLC_UPDATE_P_FLAG
argument_list|(
name|linkp
argument_list|,
name|cmdrsp
argument_list|,
name|pollfinal
argument_list|)
expr_stmt|;
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|LLC_CLEAR_REMOTE_BUSY
argument_list|(
name|linkp
argument_list|,
name|action
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
case|case
name|LLCFT_RNR
operator|+
name|LLC_CMD
case|:
case|case
name|LLCFT_RNR
operator|+
name|LLC_RSP
case|:
block|{
specifier|register
name|int
name|p
init|=
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|P
argument_list|)
decl_stmt|;
specifier|register
name|int
name|nr
init|=
name|LLCGBITS
argument_list|(
name|frame
operator|->
name|llc_control_ext
argument_list|,
name|s_nr
argument_list|)
decl_stmt|;
if|if
condition|(
name|cmdrsp
operator|==
name|LLC_CMD
operator|&&
name|pollfinal
operator|==
literal|1
condition|)
block|{
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_RR
argument_list|,
name|LLC_RSP
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|LLC_SET_REMOTE_BUSY
argument_list|(
name|linkp
argument_list|,
name|action
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|pollfinal
operator|==
literal|0
operator|)
operator|||
operator|(
name|cmdrsp
operator|==
name|LLC_RSP
operator|&&
name|pollfinal
operator|==
literal|1
operator|&&
name|p
operator|==
literal|1
operator|)
condition|)
block|{
name|LLC_UPDATE_P_FLAG
argument_list|(
name|linkp
argument_list|,
name|cmdrsp
argument_list|,
name|pollfinal
argument_list|)
expr_stmt|;
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|LLC_SET_REMOTE_BUSY
argument_list|(
name|linkp
argument_list|,
name|action
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
case|case
name|LLCFT_REJ
operator|+
name|LLC_CMD
case|:
case|case
name|LLCFT_REJ
operator|+
name|LLC_RSP
case|:
block|{
specifier|register
name|int
name|p
init|=
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|P
argument_list|)
decl_stmt|;
specifier|register
name|int
name|nr
init|=
name|LLCGBITS
argument_list|(
name|frame
operator|->
name|llc_control_ext
argument_list|,
name|s_nr
argument_list|)
decl_stmt|;
if|if
condition|(
name|cmdrsp
operator|==
name|LLC_CMD
operator|&&
name|pollfinal
operator|==
literal|1
condition|)
block|{
name|linkp
operator|->
name|llcl_vs
operator|=
name|nr
expr_stmt|;
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|llc_resend
argument_list|(
name|linkp
argument_list|,
name|LLC_RSP
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LLC_CLEAR_REMOTE_BUSY
argument_list|(
name|linkp
argument_list|,
name|action
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pollfinal
operator|==
literal|0
operator|&&
name|p
operator|==
literal|1
condition|)
block|{
name|linkp
operator|->
name|llcl_vs
operator|=
name|nr
expr_stmt|;
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|llc_resend
argument_list|(
name|linkp
argument_list|,
name|LLC_CMD
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LLC_CLEAR_REMOTE_BUSY
argument_list|(
name|linkp
argument_list|,
name|action
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|pollfinal
operator|==
literal|0
operator|&&
name|p
operator|==
literal|0
operator|&&
name|cmdrsp
operator|==
name|LLC_CMD
operator|)
operator|||
operator|(
name|pollfinal
operator|==
name|p
operator|&&
name|cmdrsp
operator|==
name|LLC_RSP
operator|)
condition|)
block|{
name|linkp
operator|->
name|llcl_vs
operator|=
name|nr
expr_stmt|;
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|LLC_START_P_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|llc_resend
argument_list|(
name|linkp
argument_list|,
name|LLC_CMD
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LLC_CLEAR_REMOTE_BUSY
argument_list|(
name|linkp
argument_list|,
name|action
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
case|case
name|NL_INITIATE_PF_CYCLE
case|:
if|if
condition|(
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|P
argument_list|)
operator|==
literal|0
condition|)
block|{
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_RR
argument_list|,
name|LLC_CMD
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LLC_START_P_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|action
operator|=
literal|0
expr_stmt|;
block|}
break|break;
case|case
name|LLC_P_TIMER_EXPIRED
case|:
if|if
condition|(
name|linkp
operator|->
name|llcl_retry
operator|<
name|llc_n2
condition|)
block|{
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_RR
argument_list|,
name|LLC_CMD
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LLC_START_P_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|linkp
operator|->
name|llcl_retry
operator|++
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|AWAIT
argument_list|)
expr_stmt|;
name|action
operator|=
literal|0
expr_stmt|;
block|}
break|break;
case|case
name|LLC_ACK_TIMER_EXPIRED
case|:
case|case
name|LLC_BUSY_TIMER_EXPIRED
case|:
if|if
condition|(
operator|(
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|P
argument_list|)
operator|==
literal|0
operator|)
operator|&&
operator|(
name|linkp
operator|->
name|llcl_retry
operator|<
name|llc_n2
operator|)
condition|)
block|{
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_RR
argument_list|,
name|LLC_CMD
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LLC_START_P_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|linkp
operator|->
name|llcl_retry
operator|++
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|AWAIT
argument_list|)
expr_stmt|;
name|action
operator|=
literal|0
expr_stmt|;
block|}
break|break;
block|}
if|if
condition|(
name|action
operator|==
name|LLC_PASSITON
condition|)
name|action
operator|=
name|llc_state_NBRAcore
argument_list|(
name|linkp
argument_list|,
name|frame
argument_list|,
name|frame_kind
argument_list|,
name|cmdrsp
argument_list|,
name|pollfinal
argument_list|)
expr_stmt|;
return|return
name|action
return|;
block|}
end_function

begin_comment
comment|/*  * BUSY --- A data link connection exists between the local LLC service access  *          point and the remote LLC service access point. I PDUs may be sent.  *          Local conditions make it likely that the information feld of  *          received I PDUs will be ignored. Supervisory PDUs may be both sent  *          and received.  */
end_comment

begin_function
name|int
name|llc_state_BUSY
parameter_list|(
name|struct
name|llc_linkcb
modifier|*
name|linkp
parameter_list|,
name|struct
name|llc
modifier|*
name|frame
parameter_list|,
name|int
name|frame_kind
parameter_list|,
name|int
name|cmdrsp
parameter_list|,
name|int
name|pollfinal
parameter_list|)
block|{
name|int
name|action
init|=
name|LLC_PASSITON
decl_stmt|;
switch|switch
condition|(
name|frame_kind
operator|+
name|cmdrsp
condition|)
block|{
case|case
name|NL_DATA_REQUEST
case|:
if|if
condition|(
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|REMOTE_BUSY
argument_list|)
operator|==
literal|0
condition|)
if|if
condition|(
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|P
argument_list|)
operator|==
literal|0
condition|)
block|{
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_INFO
argument_list|,
name|LLC_CMD
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LLC_START_P_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
if|if
condition|(
name|LLC_TIMERXPIRED
argument_list|(
name|linkp
argument_list|,
name|ACK
argument_list|)
operator|!=
name|LLC_TIMER_RUNNING
condition|)
name|LLC_START_ACK_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|action
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_INFO
argument_list|,
name|LLC_CMD
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|LLC_TIMERXPIRED
argument_list|(
name|linkp
argument_list|,
name|ACK
argument_list|)
operator|!=
name|LLC_TIMER_RUNNING
condition|)
name|LLC_START_ACK_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|action
operator|=
literal|0
expr_stmt|;
block|}
break|break;
case|case
name|LLC_LOCAL_BUSY_CLEARED
case|:
block|{
specifier|register
name|int
name|p
init|=
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|P
argument_list|)
decl_stmt|;
specifier|register
name|int
name|df
init|=
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|DATA
argument_list|)
decl_stmt|;
switch|switch
condition|(
name|df
condition|)
block|{
case|case
literal|1
case|:
if|if
condition|(
name|p
operator|==
literal|0
condition|)
block|{
comment|/* multiple possibilities */
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_REJ
argument_list|,
name|LLC_CMD
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LLC_START_REJ_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_START_P_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|REJECT
argument_list|)
expr_stmt|;
name|action
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_REJ
argument_list|,
name|LLC_CMD
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LLC_START_REJ_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|REJECT
argument_list|)
expr_stmt|;
name|action
operator|=
literal|0
expr_stmt|;
block|}
break|break;
case|case
literal|0
case|:
if|if
condition|(
name|p
operator|==
literal|0
condition|)
block|{
comment|/* multiple possibilities */
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_RR
argument_list|,
name|LLC_CMD
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LLC_START_P_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|NORMAL
argument_list|)
expr_stmt|;
name|action
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_RR
argument_list|,
name|LLC_CMD
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|NORMAL
argument_list|)
expr_stmt|;
name|action
operator|=
literal|0
expr_stmt|;
block|}
break|break;
case|case
literal|2
case|:
if|if
condition|(
name|p
operator|==
literal|0
condition|)
block|{
comment|/* multiple possibilities */
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_RR
argument_list|,
name|LLC_CMD
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LLC_START_P_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|REJECT
argument_list|)
expr_stmt|;
name|action
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_RR
argument_list|,
name|LLC_CMD
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|REJECT
argument_list|)
expr_stmt|;
name|action
operator|=
literal|0
expr_stmt|;
block|}
break|break;
block|}
break|break;
block|}
case|case
name|LLC_INVALID_NS
operator|+
name|LLC_CMD
case|:
case|case
name|LLC_INVALID_NS
operator|+
name|LLC_RSP
case|:
block|{
specifier|register
name|int
name|p
init|=
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|P
argument_list|)
decl_stmt|;
specifier|register
name|int
name|nr
init|=
name|LLCGBITS
argument_list|(
name|frame
operator|->
name|llc_control_ext
argument_list|,
name|s_nr
argument_list|)
decl_stmt|;
if|if
condition|(
name|cmdrsp
operator|==
name|LLC_CMD
operator|&&
name|pollfinal
operator|==
literal|1
condition|)
block|{
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_RNR
argument_list|,
name|LLC_RSP
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
if|if
condition|(
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|DATA
argument_list|)
operator|==
literal|0
condition|)
name|LLC_SETFLAG
argument_list|(
name|linkp
argument_list|,
name|DATA
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|action
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|cmdrsp
operator|==
name|LLC_CMD
operator|&&
name|pollfinal
operator|==
literal|0
operator|&&
name|p
operator|==
literal|0
operator|)
operator|||
operator|(
name|cmdrsp
operator|==
name|LLC_RSP
operator|&&
name|pollfinal
operator|==
name|p
operator|)
condition|)
block|{
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_RNR
argument_list|,
name|LLC_CMD
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LLC_UPDATE_P_FLAG
argument_list|(
name|linkp
argument_list|,
name|cmdrsp
argument_list|,
name|pollfinal
argument_list|)
expr_stmt|;
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
if|if
condition|(
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|DATA
argument_list|)
operator|==
literal|0
condition|)
name|LLC_SETFLAG
argument_list|(
name|linkp
argument_list|,
name|DATA
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmdrsp
operator|==
name|LLC_RSP
operator|&&
name|pollfinal
operator|==
literal|1
condition|)
block|{
name|LLC_CLEAR_REMOTE_BUSY
argument_list|(
name|linkp
argument_list|,
name|action
argument_list|)
expr_stmt|;
block|}
else|else
name|action
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pollfinal
operator|==
literal|0
operator|&&
name|p
operator|==
literal|1
condition|)
block|{
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_RNR
argument_list|,
name|LLC_RSP
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
if|if
condition|(
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|DATA
argument_list|)
operator|==
literal|0
condition|)
name|LLC_SETFLAG
argument_list|(
name|linkp
argument_list|,
name|DATA
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|action
operator|=
literal|0
expr_stmt|;
block|}
break|break;
block|}
case|case
name|LLCFT_INFO
operator|+
name|LLC_CMD
case|:
case|case
name|LLCFT_INFO
operator|+
name|LLC_RSP
case|:
block|{
specifier|register
name|int
name|p
init|=
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|P
argument_list|)
decl_stmt|;
specifier|register
name|int
name|nr
init|=
name|LLCGBITS
argument_list|(
name|frame
operator|->
name|llc_control_ext
argument_list|,
name|s_nr
argument_list|)
decl_stmt|;
if|if
condition|(
name|cmdrsp
operator|==
name|LLC_CMD
operator|&&
name|pollfinal
operator|==
literal|1
condition|)
block|{
name|LLC_INC
argument_list|(
name|linkp
operator|->
name|llcl_vr
argument_list|)
expr_stmt|;
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_RNR
argument_list|,
name|LLC_RSP
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
if|if
condition|(
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|DATA
argument_list|)
operator|==
literal|2
condition|)
name|LLC_STOP_REJ_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_SETFLAG
argument_list|(
name|linkp
argument_list|,
name|DATA
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|action
operator|=
name|LLC_DATA_INDICATION
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|cmdrsp
operator|==
name|LLC_CMD
operator|&&
name|pollfinal
operator|==
literal|0
operator|&&
name|p
operator|==
literal|0
operator|)
operator|||
operator|(
name|cmdrsp
operator|==
name|LLC_RSP
operator|&&
name|pollfinal
operator|==
name|p
operator|)
condition|)
block|{
name|LLC_INC
argument_list|(
name|linkp
operator|->
name|llcl_vr
argument_list|)
expr_stmt|;
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_RNR
argument_list|,
name|LLC_CMD
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LLC_START_P_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
if|if
condition|(
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|DATA
argument_list|)
operator|==
literal|2
condition|)
name|LLC_STOP_REJ_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmdrsp
operator|==
name|LLC_RSP
operator|&&
name|pollfinal
operator|==
literal|1
condition|)
name|LLC_CLEAR_REMOTE_BUSY
argument_list|(
name|linkp
argument_list|,
name|action
argument_list|)
expr_stmt|;
name|action
operator|=
name|LLC_DATA_INDICATION
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pollfinal
operator|==
literal|0
operator|&&
name|p
operator|==
literal|1
condition|)
block|{
name|LLC_INC
argument_list|(
name|linkp
operator|->
name|llcl_vr
argument_list|)
expr_stmt|;
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_RNR
argument_list|,
name|LLC_CMD
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
if|if
condition|(
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|DATA
argument_list|)
operator|==
literal|2
condition|)
name|LLC_STOP_REJ_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_SETFLAG
argument_list|(
name|linkp
argument_list|,
name|DATA
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|action
operator|=
name|LLC_DATA_INDICATION
expr_stmt|;
block|}
break|break;
block|}
case|case
name|LLCFT_RR
operator|+
name|LLC_CMD
case|:
case|case
name|LLCFT_RR
operator|+
name|LLC_RSP
case|:
case|case
name|LLCFT_RNR
operator|+
name|LLC_CMD
case|:
case|case
name|LLCFT_RNR
operator|+
name|LLC_RSP
case|:
block|{
specifier|register
name|int
name|p
init|=
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|P
argument_list|)
decl_stmt|;
specifier|register
name|int
name|nr
init|=
name|LLCGBITS
argument_list|(
name|frame
operator|->
name|llc_control_ext
argument_list|,
name|s_nr
argument_list|)
decl_stmt|;
if|if
condition|(
name|cmdrsp
operator|==
name|LLC_CMD
operator|&&
name|pollfinal
operator|==
literal|1
condition|)
block|{
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_RNR
argument_list|,
name|LLC_RSP
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
if|if
condition|(
name|frame_kind
operator|==
name|LLCFT_RR
condition|)
block|{
name|LLC_CLEAR_REMOTE_BUSY
argument_list|(
name|linkp
argument_list|,
name|action
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|LLC_SET_REMOTE_BUSY
argument_list|(
name|linkp
argument_list|,
name|action
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|pollfinal
operator|=
literal|0
operator|||
operator|(
name|cmdrsp
operator|==
name|LLC_RSP
operator|&&
name|pollfinal
operator|==
literal|1
operator|)
condition|)
block|{
name|LLC_UPDATE_P_FLAG
argument_list|(
name|linkp
argument_list|,
name|cmdrsp
argument_list|,
name|pollfinal
argument_list|)
expr_stmt|;
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
if|if
condition|(
name|frame_kind
operator|==
name|LLCFT_RR
condition|)
block|{
name|LLC_CLEAR_REMOTE_BUSY
argument_list|(
name|linkp
argument_list|,
name|action
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|LLC_SET_REMOTE_BUSY
argument_list|(
name|linkp
argument_list|,
name|action
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
block|}
case|case
name|LLCFT_REJ
operator|+
name|LLC_CMD
case|:
case|case
name|LLCFT_REJ
operator|+
name|LLC_RSP
case|:
block|{
specifier|register
name|int
name|p
init|=
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|P
argument_list|)
decl_stmt|;
specifier|register
name|int
name|nr
init|=
name|LLCGBITS
argument_list|(
name|frame
operator|->
name|llc_control_ext
argument_list|,
name|s_nr
argument_list|)
decl_stmt|;
if|if
condition|(
name|cmdrsp
operator|==
name|LLC_CMD
operator|&&
name|pollfinal
operator|==
literal|1
condition|)
block|{
name|linkp
operator|->
name|llcl_vs
operator|=
name|nr
expr_stmt|;
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_RNR
argument_list|,
name|LLC_RSP
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|llc_resend
argument_list|(
name|linkp
argument_list|,
name|LLC_CMD
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LLC_CLEAR_REMOTE_BUSY
argument_list|(
name|linkp
argument_list|,
name|action
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|cmdrsp
operator|==
name|LLC_CMD
operator|&&
name|pollfinal
operator|==
literal|0
operator|&&
name|p
operator|==
literal|0
operator|)
operator|||
operator|(
name|cmdrsp
operator|==
name|LLC_RSP
operator|&&
name|pollfinal
operator|==
name|p
operator|)
condition|)
block|{
name|linkp
operator|->
name|llcl_vs
operator|=
name|nr
expr_stmt|;
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|LLC_UPDATE_P_FLAG
argument_list|(
name|linkp
argument_list|,
name|cmdrsp
argument_list|,
name|pollfinal
argument_list|)
expr_stmt|;
name|llc_resend
argument_list|(
name|linkp
argument_list|,
name|LLC_CMD
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LLC_CLEAR_REMOTE_BUSY
argument_list|(
name|linkp
argument_list|,
name|action
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pollfinal
operator|==
literal|0
operator|&&
name|p
operator|==
literal|1
condition|)
block|{
name|linkp
operator|->
name|llcl_vs
operator|=
name|nr
expr_stmt|;
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|llc_resend
argument_list|(
name|linkp
argument_list|,
name|LLC_CMD
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LLC_CLEAR_REMOTE_BUSY
argument_list|(
name|linkp
argument_list|,
name|action
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
case|case
name|NL_INITIATE_PF_CYCLE
case|:
if|if
condition|(
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|P
argument_list|)
operator|==
literal|0
condition|)
block|{
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_RNR
argument_list|,
name|LLC_CMD
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LLC_START_P_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|action
operator|=
literal|0
expr_stmt|;
block|}
break|break;
case|case
name|LLC_P_TIMER_EXPIRED
case|:
comment|/* multiple possibilities */
if|if
condition|(
name|linkp
operator|->
name|llcl_retry
operator|<
name|llc_n2
condition|)
block|{
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_RNR
argument_list|,
name|LLC_CMD
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LLC_START_P_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|linkp
operator|->
name|llcl_retry
operator|++
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|AWAIT_BUSY
argument_list|)
expr_stmt|;
name|action
operator|=
literal|0
expr_stmt|;
block|}
break|break;
case|case
name|LLC_ACK_TIMER_EXPIRED
case|:
case|case
name|LLC_BUSY_TIMER_EXPIRED
case|:
if|if
condition|(
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|P
argument_list|)
operator|==
literal|0
operator|&&
name|linkp
operator|->
name|llcl_retry
operator|<
name|llc_n2
condition|)
block|{
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_RNR
argument_list|,
name|LLC_CMD
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LLC_START_P_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|linkp
operator|->
name|llcl_retry
operator|++
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|AWAIT_BUSY
argument_list|)
expr_stmt|;
name|action
operator|=
literal|0
expr_stmt|;
block|}
break|break;
case|case
name|LLC_REJ_TIMER_EXPIRED
case|:
if|if
condition|(
name|linkp
operator|->
name|llcl_retry
operator|<
name|llc_n2
condition|)
if|if
condition|(
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|P
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* multiple possibilities */
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_RNR
argument_list|,
name|LLC_CMD
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LLC_START_P_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|linkp
operator|->
name|llcl_retry
operator|++
expr_stmt|;
name|LLC_SETFLAG
argument_list|(
name|linkp
argument_list|,
name|DATA
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|AWAIT_BUSY
argument_list|)
expr_stmt|;
name|action
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|LLC_SETFLAG
argument_list|(
name|linkp
argument_list|,
name|DATA
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|BUSY
argument_list|)
expr_stmt|;
name|action
operator|=
literal|0
expr_stmt|;
block|}
break|break;
block|}
if|if
condition|(
name|action
operator|==
name|LLC_PASSITON
condition|)
name|action
operator|=
name|llc_state_NBRAcore
argument_list|(
name|linkp
argument_list|,
name|frame
argument_list|,
name|frame_kind
argument_list|,
name|cmdrsp
argument_list|,
name|pollfinal
argument_list|)
expr_stmt|;
return|return
name|action
return|;
block|}
end_function

begin_comment
comment|/*  * REJECT --- A data link connection exists between the local LLC service  *            access point and the remote LLC service access point. The local  *            connection component has requested that the remote connection  *            component resend a specific I PDU that the local connection  *            componnent has detected as being out of sequence. Both I PDUs and  *            supervisory PDUs may be sent and received.  */
end_comment

begin_function
name|int
name|llc_state_REJECT
parameter_list|(
name|struct
name|llc_linkcb
modifier|*
name|linkp
parameter_list|,
name|struct
name|llc
modifier|*
name|frame
parameter_list|,
name|int
name|frame_kind
parameter_list|,
name|int
name|cmdrsp
parameter_list|,
name|int
name|pollfinal
parameter_list|)
block|{
name|int
name|action
init|=
name|LLC_PASSITON
decl_stmt|;
switch|switch
condition|(
name|frame_kind
operator|+
name|cmdrsp
condition|)
block|{
case|case
name|NL_DATA_REQUEST
case|:
if|if
condition|(
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|P
argument_list|)
operator|==
literal|0
condition|)
block|{
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_INFO
argument_list|,
name|LLC_CMD
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LLC_START_P_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
if|if
condition|(
name|LLC_TIMERXPIRED
argument_list|(
name|linkp
argument_list|,
name|ACK
argument_list|)
operator|!=
name|LLC_TIMER_RUNNING
condition|)
name|LLC_START_ACK_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|REJECT
argument_list|)
expr_stmt|;
name|action
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_INFO
argument_list|,
name|LLC_CMD
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|LLC_TIMERXPIRED
argument_list|(
name|linkp
argument_list|,
name|ACK
argument_list|)
operator|!=
name|LLC_TIMER_RUNNING
condition|)
name|LLC_START_ACK_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|REJECT
argument_list|)
expr_stmt|;
name|action
operator|=
literal|0
expr_stmt|;
block|}
break|break;
case|case
name|NL_LOCAL_BUSY_DETECTED
case|:
if|if
condition|(
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|P
argument_list|)
operator|==
literal|0
condition|)
block|{
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_RNR
argument_list|,
name|LLC_CMD
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LLC_START_P_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_SETFLAG
argument_list|(
name|linkp
argument_list|,
name|DATA
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|BUSY
argument_list|)
expr_stmt|;
name|action
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_RNR
argument_list|,
name|LLC_CMD
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LLC_SETFLAG
argument_list|(
name|linkp
argument_list|,
name|DATA
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|BUSY
argument_list|)
expr_stmt|;
name|action
operator|=
literal|0
expr_stmt|;
block|}
break|break;
case|case
name|LLC_INVALID_NS
operator|+
name|LLC_CMD
case|:
case|case
name|LLC_INVALID_NS
operator|+
name|LLC_RSP
case|:
block|{
specifier|register
name|int
name|p
init|=
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|P
argument_list|)
decl_stmt|;
specifier|register
name|int
name|nr
init|=
name|LLCGBITS
argument_list|(
name|frame
operator|->
name|llc_control_ext
argument_list|,
name|s_nr
argument_list|)
decl_stmt|;
if|if
condition|(
name|cmdrsp
operator|==
name|LLC_CMD
operator|&&
name|pollfinal
operator|==
literal|1
condition|)
block|{
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_RR
argument_list|,
name|LLC_RSP
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|action
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pollfinal
operator|==
literal|0
operator|||
operator|(
name|cmdrsp
operator|==
name|LLC_RSP
operator|&&
name|pollfinal
operator|==
literal|1
operator|&&
name|p
operator|==
literal|1
operator|)
condition|)
block|{
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|LLC_UPDATE_P_FLAG
argument_list|(
name|linkp
argument_list|,
name|cmdrsp
argument_list|,
name|pollfinal
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmdrsp
operator|==
name|LLC_RSP
operator|&&
name|pollfinal
operator|==
literal|1
condition|)
block|{
name|LLC_CLEAR_REMOTE_BUSY
argument_list|(
name|linkp
argument_list|,
name|action
argument_list|)
expr_stmt|;
block|}
else|else
name|action
operator|=
literal|0
expr_stmt|;
block|}
break|break;
block|}
case|case
name|LLCFT_INFO
operator|+
name|LLC_CMD
case|:
case|case
name|LLCFT_INFO
operator|+
name|LLC_RSP
case|:
block|{
specifier|register
name|int
name|p
init|=
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|P
argument_list|)
decl_stmt|;
specifier|register
name|int
name|nr
init|=
name|LLCGBITS
argument_list|(
name|frame
operator|->
name|llc_control_ext
argument_list|,
name|s_nr
argument_list|)
decl_stmt|;
if|if
condition|(
name|cmdrsp
operator|==
name|LLC_CMD
operator|&&
name|pollfinal
operator|==
literal|1
condition|)
block|{
name|LLC_INC
argument_list|(
name|linkp
operator|->
name|llcl_vr
argument_list|)
expr_stmt|;
name|LLC_SENDACKNOWLEDGE
argument_list|(
name|linkp
argument_list|,
name|LLC_RSP
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|LLC_STOP_REJ_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|NORMAL
argument_list|)
expr_stmt|;
name|action
operator|=
name|LLC_DATA_INDICATION
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|cmdrsp
operator|=
name|LLC_RSP
operator|&&
name|pollfinal
operator|==
name|p
operator|)
operator|||
operator|(
name|cmdrsp
operator|==
name|LLC_CMD
operator|&&
name|pollfinal
operator|==
literal|0
operator|&&
name|p
operator|==
literal|0
operator|)
condition|)
block|{
name|LLC_INC
argument_list|(
name|linkp
operator|->
name|llcl_vr
argument_list|)
expr_stmt|;
name|LLC_SENDACKNOWLEDGE
argument_list|(
name|linkp
argument_list|,
name|LLC_CMD
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LLC_START_P_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmdrsp
operator|==
name|LLC_RSP
operator|&&
name|pollfinal
operator|==
literal|1
condition|)
name|LLC_CLEAR_REMOTE_BUSY
argument_list|(
name|linkp
argument_list|,
name|action
argument_list|)
expr_stmt|;
name|LLC_STOP_REJ_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|NORMAL
argument_list|)
expr_stmt|;
name|action
operator|=
name|LLC_DATA_INDICATION
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pollfinal
operator|==
literal|0
operator|&&
name|p
operator|==
literal|1
condition|)
block|{
name|LLC_INC
argument_list|(
name|linkp
operator|->
name|llcl_vr
argument_list|)
expr_stmt|;
name|LLC_SENDACKNOWLEDGE
argument_list|(
name|linkp
argument_list|,
name|LLC_CMD
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LLC_STOP_REJ_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|NORMAL
argument_list|)
expr_stmt|;
name|action
operator|=
name|LLC_DATA_INDICATION
expr_stmt|;
block|}
break|break;
block|}
case|case
name|LLCFT_RR
operator|+
name|LLC_CMD
case|:
case|case
name|LLCFT_RR
operator|+
name|LLC_RSP
case|:
block|{
specifier|register
name|int
name|p
init|=
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|P
argument_list|)
decl_stmt|;
specifier|register
name|int
name|nr
init|=
name|LLCGBITS
argument_list|(
name|frame
operator|->
name|llc_control_ext
argument_list|,
name|s_nr
argument_list|)
decl_stmt|;
if|if
condition|(
name|cmdrsp
operator|==
name|LLC_CMD
operator|&&
name|pollfinal
operator|==
literal|1
condition|)
block|{
name|LLC_SENDACKNOWLEDGE
argument_list|(
name|linkp
argument_list|,
name|LLC_RSP
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|LLC_CLEAR_REMOTE_BUSY
argument_list|(
name|linkp
argument_list|,
name|action
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pollfinal
operator|==
literal|0
operator|||
operator|(
name|cmdrsp
operator|==
name|LLC_RSP
operator|&&
name|pollfinal
operator|==
literal|1
operator|&&
name|p
operator|==
literal|1
operator|)
condition|)
block|{
name|LLC_UPDATE_P_FLAG
argument_list|(
name|linkp
argument_list|,
name|cmdrsp
argument_list|,
name|pollfinal
argument_list|)
expr_stmt|;
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|LLC_CLEAR_REMOTE_BUSY
argument_list|(
name|linkp
argument_list|,
name|action
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
case|case
name|LLCFT_RNR
operator|+
name|LLC_CMD
case|:
case|case
name|LLCFT_RNR
operator|+
name|LLC_RSP
case|:
block|{
specifier|register
name|int
name|p
init|=
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|P
argument_list|)
decl_stmt|;
specifier|register
name|int
name|nr
init|=
name|LLCGBITS
argument_list|(
name|frame
operator|->
name|llc_control_ext
argument_list|,
name|s_nr
argument_list|)
decl_stmt|;
if|if
condition|(
name|cmdrsp
operator|==
name|LLC_CMD
operator|&&
name|pollfinal
operator|==
literal|1
condition|)
block|{
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_RR
argument_list|,
name|LLC_RSP
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|LLC_SET_REMOTE_BUSY
argument_list|(
name|linkp
argument_list|,
name|action
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pollfinal
operator|==
literal|0
operator|||
operator|(
name|cmdrsp
operator|==
name|LLC_RSP
operator|&&
name|pollfinal
operator|==
literal|1
operator|&&
name|p
operator|==
literal|1
operator|)
condition|)
block|{
name|LLC_UPDATE_P_FLAG
argument_list|(
name|linkp
argument_list|,
name|cmdrsp
argument_list|,
name|pollfinal
argument_list|)
expr_stmt|;
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|action
operator|=
literal|0
expr_stmt|;
block|}
break|break;
block|}
case|case
name|LLCFT_REJ
operator|+
name|LLC_CMD
case|:
case|case
name|LLCFT_REJ
operator|+
name|LLC_RSP
case|:
block|{
specifier|register
name|int
name|p
init|=
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|P
argument_list|)
decl_stmt|;
specifier|register
name|int
name|nr
init|=
name|LLCGBITS
argument_list|(
name|frame
operator|->
name|llc_control_ext
argument_list|,
name|s_nr
argument_list|)
decl_stmt|;
if|if
condition|(
name|cmdrsp
operator|==
name|LLC_CMD
operator|&&
name|pollfinal
operator|==
literal|1
condition|)
block|{
name|linkp
operator|->
name|llcl_vs
operator|=
name|nr
expr_stmt|;
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|llc_resend
argument_list|(
name|linkp
argument_list|,
name|LLC_RSP
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LLC_CLEAR_REMOTE_BUSY
argument_list|(
name|linkp
argument_list|,
name|action
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|cmdrsp
operator|==
name|LLC_CMD
operator|&&
name|pollfinal
operator|==
literal|0
operator|&&
name|p
operator|==
literal|0
operator|)
operator|||
operator|(
name|cmdrsp
operator|==
name|LLC_RSP
operator|&&
name|pollfinal
operator|==
name|p
operator|)
condition|)
block|{
name|linkp
operator|->
name|llcl_vs
operator|=
name|nr
expr_stmt|;
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|LLC_UPDATE_P_FLAG
argument_list|(
name|linkp
argument_list|,
name|cmdrsp
argument_list|,
name|pollfinal
argument_list|)
expr_stmt|;
name|llc_resend
argument_list|(
name|linkp
argument_list|,
name|LLC_CMD
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LLC_CLEAR_REMOTE_BUSY
argument_list|(
name|linkp
argument_list|,
name|action
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pollfinal
operator|==
literal|0
operator|&&
name|p
operator|==
literal|1
condition|)
block|{
name|linkp
operator|->
name|llcl_vs
operator|=
name|nr
expr_stmt|;
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|llc_resend
argument_list|(
name|linkp
argument_list|,
name|LLC_CMD
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LLC_CLEAR_REMOTE_BUSY
argument_list|(
name|linkp
argument_list|,
name|action
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
case|case
name|NL_INITIATE_PF_CYCLE
case|:
if|if
condition|(
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|P
argument_list|)
operator|==
literal|0
condition|)
block|{
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_RR
argument_list|,
name|LLC_CMD
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LLC_START_P_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|action
operator|=
literal|0
expr_stmt|;
block|}
break|break;
case|case
name|LLC_REJ_TIMER_EXPIRED
case|:
if|if
condition|(
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|P
argument_list|)
operator|==
literal|0
operator|&&
name|linkp
operator|->
name|llcl_retry
operator|<
name|llc_n2
condition|)
block|{
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_REJ
argument_list|,
name|LLC_CMD
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LLC_START_P_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_START_REJ_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|linkp
operator|->
name|llcl_retry
operator|++
expr_stmt|;
name|action
operator|=
literal|0
expr_stmt|;
block|}
case|case
name|LLC_P_TIMER_EXPIRED
case|:
if|if
condition|(
name|linkp
operator|->
name|llcl_retry
operator|<
name|llc_n2
condition|)
block|{
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_RR
argument_list|,
name|LLC_CMD
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LLC_START_P_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_START_REJ_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|linkp
operator|->
name|llcl_retry
operator|++
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|AWAIT_REJECT
argument_list|)
expr_stmt|;
name|action
operator|=
literal|0
expr_stmt|;
block|}
break|break;
case|case
name|LLC_ACK_TIMER_EXPIRED
case|:
case|case
name|LLC_BUSY_TIMER_EXPIRED
case|:
if|if
condition|(
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|P
argument_list|)
operator|==
literal|0
operator|&&
name|linkp
operator|->
name|llcl_retry
operator|<
name|llc_n2
condition|)
block|{
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_RR
argument_list|,
name|LLC_CMD
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LLC_START_P_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_START_REJ_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|linkp
operator|->
name|llcl_retry
operator|++
expr_stmt|;
comment|/* 			 * I cannot locate the description of RESET_V(S) 			 * in ISO 8802-2, table 7-1, state REJECT, last event, 			 * and  assume they meant to set V(S) to 0 ... 			 */
name|linkp
operator|->
name|llcl_vs
operator|=
literal|0
expr_stmt|;
comment|/* XXX */
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|AWAIT_REJECT
argument_list|)
expr_stmt|;
name|action
operator|=
literal|0
expr_stmt|;
block|}
break|break;
block|}
if|if
condition|(
name|action
operator|==
name|LLC_PASSITON
condition|)
name|action
operator|=
name|llc_state_NBRAcore
argument_list|(
name|linkp
argument_list|,
name|frame
argument_list|,
name|frame_kind
argument_list|,
name|cmdrsp
argument_list|,
name|pollfinal
argument_list|)
expr_stmt|;
return|return
name|action
return|;
block|}
end_function

begin_comment
comment|/*  * AWAIT --- A data link connection exists between the local LLC service access  *           point and the remote LLC service access point. The local LLC is  *           performing a timer recovery operation and has sent a command PDU  *           with the P bit set to ``1'', and is awaiting an acknowledgement  *           from the remote LLC. I PDUs may be received but not sent.  *           Supervisory PDUs may be both sent and received.  */
end_comment

begin_function
name|int
name|llc_state_AWAIT
parameter_list|(
name|struct
name|llc_linkcb
modifier|*
name|linkp
parameter_list|,
name|struct
name|llc
modifier|*
name|frame
parameter_list|,
name|int
name|frame_kind
parameter_list|,
name|int
name|cmdrsp
parameter_list|,
name|int
name|pollfinal
parameter_list|)
block|{
name|int
name|action
init|=
name|LLC_PASSITON
decl_stmt|;
switch|switch
condition|(
name|frame_kind
operator|+
name|cmdrsp
condition|)
block|{
case|case
name|LLC_LOCAL_BUSY_DETECTED
case|:
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_RNR
argument_list|,
name|LLC_CMD
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LLC_SETFLAG
argument_list|(
name|linkp
argument_list|,
name|DATA
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|AWAIT_BUSY
argument_list|)
expr_stmt|;
name|action
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|LLC_INVALID_NS
operator|+
name|LLC_CMD
case|:
case|case
name|LLC_INVALID_NS
operator|+
name|LLC_RSP
case|:
block|{
specifier|register
name|int
name|p
init|=
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|P
argument_list|)
decl_stmt|;
specifier|register
name|int
name|nr
init|=
name|LLCGBITS
argument_list|(
name|frame
operator|->
name|llc_control_ext
argument_list|,
name|s_nr
argument_list|)
decl_stmt|;
if|if
condition|(
name|cmdrsp
operator|==
name|LLC_CMD
operator|&&
name|pollfinal
operator|==
literal|1
condition|)
block|{
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_REJ
argument_list|,
name|LLC_RSP
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|LLC_START_REJ_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|AWAIT_REJECT
argument_list|)
expr_stmt|;
name|action
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cmdrsp
operator|==
name|LLC_RSP
operator|&&
name|pollfinal
operator|==
literal|1
condition|)
block|{
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_REJ
argument_list|,
name|LLC_CMD
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|linkp
operator|->
name|llcl_vs
operator|=
name|nr
expr_stmt|;
name|LLC_STOP_P_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|llc_resend
argument_list|(
name|linkp
argument_list|,
name|LLC_CMD
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LLC_START_REJ_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_CLEAR_REMOTE_BUSY
argument_list|(
name|linkp
argument_list|,
name|action
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|REJECT
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pollfinal
operator|==
literal|0
condition|)
block|{
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_REJ
argument_list|,
name|LLC_CMD
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|LLC_START_REJ_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|AWAIT_REJECT
argument_list|)
expr_stmt|;
name|action
operator|=
literal|0
expr_stmt|;
block|}
break|break;
block|}
case|case
name|LLCFT_INFO
operator|+
name|LLC_RSP
case|:
case|case
name|LLCFT_INFO
operator|+
name|LLC_CMD
case|:
block|{
specifier|register
name|int
name|p
init|=
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|P
argument_list|)
decl_stmt|;
specifier|register
name|int
name|nr
init|=
name|LLCGBITS
argument_list|(
name|frame
operator|->
name|llc_control_ext
argument_list|,
name|s_nr
argument_list|)
decl_stmt|;
name|LLC_INC
argument_list|(
name|linkp
operator|->
name|llcl_vr
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmdrsp
operator|==
name|LLC_CMD
operator|&&
name|pollfinal
operator|==
literal|1
condition|)
block|{
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_RR
argument_list|,
name|LLC_RSP
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|action
operator|=
name|LLC_DATA_INDICATION
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cmdrsp
operator|==
name|LLC_RSP
operator|&&
name|pollfinal
operator|==
literal|1
condition|)
block|{
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|linkp
operator|->
name|llcl_vs
operator|=
name|nr
expr_stmt|;
name|llc_resend
argument_list|(
name|linkp
argument_list|,
name|LLC_CMD
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LLC_START_P_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_CLEAR_REMOTE_BUSY
argument_list|(
name|linkp
argument_list|,
name|action
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|NORMAL
argument_list|)
expr_stmt|;
name|action
operator|=
name|LLC_DATA_INDICATION
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pollfinal
operator|==
literal|0
condition|)
block|{
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_RR
argument_list|,
name|LLC_CMD
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|action
operator|=
name|LLC_DATA_INDICATION
expr_stmt|;
block|}
break|break;
block|}
case|case
name|LLCFT_RR
operator|+
name|LLC_CMD
case|:
case|case
name|LLCFT_RR
operator|+
name|LLC_RSP
case|:
case|case
name|LLCFT_REJ
operator|+
name|LLC_CMD
case|:
case|case
name|LLCFT_REJ
operator|+
name|LLC_RSP
case|:
block|{
specifier|register
name|int
name|p
init|=
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|P
argument_list|)
decl_stmt|;
specifier|register
name|int
name|nr
init|=
name|LLCGBITS
argument_list|(
name|frame
operator|->
name|llc_control_ext
argument_list|,
name|s_nr
argument_list|)
decl_stmt|;
if|if
condition|(
name|cmdrsp
operator|==
name|LLC_CMD
operator|&&
name|pollfinal
operator|==
literal|1
condition|)
block|{
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_RR
argument_list|,
name|LLC_RSP
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|LLC_CLEAR_REMOTE_BUSY
argument_list|(
name|linkp
argument_list|,
name|action
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cmdrsp
operator|==
name|LLC_RSP
operator|&&
name|pollfinal
operator|==
literal|1
condition|)
block|{
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|linkp
operator|->
name|llcl_vs
operator|=
name|nr
expr_stmt|;
name|LLC_STOP_P_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|llc_resend
argument_list|(
name|linkp
argument_list|,
name|LLC_CMD
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LLC_CLEAR_REMOTE_BUSY
argument_list|(
name|linkp
argument_list|,
name|action
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|NORMAL
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pollfinal
operator|==
literal|0
condition|)
block|{
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|LLC_CLEAR_REMOTE_BUSY
argument_list|(
name|linkp
argument_list|,
name|action
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
case|case
name|LLCFT_RNR
operator|+
name|LLC_CMD
case|:
case|case
name|LLCFT_RNR
operator|+
name|LLC_RSP
case|:
block|{
specifier|register
name|int
name|p
init|=
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|P
argument_list|)
decl_stmt|;
specifier|register
name|int
name|nr
init|=
name|LLCGBITS
argument_list|(
name|frame
operator|->
name|llc_control_ext
argument_list|,
name|s_nr
argument_list|)
decl_stmt|;
if|if
condition|(
name|pollfinal
operator|==
literal|1
operator|&&
name|cmdrsp
operator|==
name|LLC_CMD
condition|)
block|{
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_RR
argument_list|,
name|LLC_RSP
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|LLC_SET_REMOTE_BUSY
argument_list|(
name|linkp
argument_list|,
name|action
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pollfinal
operator|==
literal|1
operator|&&
name|cmdrsp
operator|==
name|LLC_RSP
condition|)
block|{
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|linkp
operator|->
name|llcl_vs
operator|=
name|nr
expr_stmt|;
name|LLC_STOP_P_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_SET_REMOTE_BUSY
argument_list|(
name|linkp
argument_list|,
name|action
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|NORMAL
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pollfinal
operator|==
literal|0
condition|)
block|{
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|LLC_SET_REMOTE_BUSY
argument_list|(
name|linkp
argument_list|,
name|action
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
case|case
name|LLC_P_TIMER_EXPIRED
case|:
if|if
condition|(
name|linkp
operator|->
name|llcl_retry
operator|<
name|llc_n2
condition|)
block|{
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_RR
argument_list|,
name|LLC_CMD
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LLC_START_P_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|linkp
operator|->
name|llcl_retry
operator|++
expr_stmt|;
name|action
operator|=
literal|0
expr_stmt|;
block|}
break|break;
block|}
if|if
condition|(
name|action
operator|==
name|LLC_PASSITON
condition|)
name|action
operator|=
name|llc_state_NBRAcore
argument_list|(
name|linkp
argument_list|,
name|frame
argument_list|,
name|frame_kind
argument_list|,
name|cmdrsp
argument_list|,
name|pollfinal
argument_list|)
expr_stmt|;
return|return
name|action
return|;
block|}
end_function

begin_comment
comment|/*  * AWAIT_BUSY --- A data link connection exists between the local LLC service  *                access point and the remote LLC service access point. The  *                local LLC is performing a timer recovery operation and has  *                sent a command PDU with the P bit set to ``1'', and is  *                awaiting an acknowledgement from the remote LLC. I PDUs may  *                not be sent. Local conditions make it likely that the  *                information feld of receoved I PDUs will be ignored.  *                Supervisory PDUs may be both sent and received.  */
end_comment

begin_function
name|int
name|llc_state_AWAIT_BUSY
parameter_list|(
name|struct
name|llc_linkcb
modifier|*
name|linkp
parameter_list|,
name|struct
name|llc
modifier|*
name|frame
parameter_list|,
name|int
name|frame_kind
parameter_list|,
name|int
name|cmdrsp
parameter_list|,
name|int
name|pollfinal
parameter_list|)
block|{
name|int
name|action
init|=
name|LLC_PASSITON
decl_stmt|;
switch|switch
condition|(
name|frame_kind
operator|+
name|cmdrsp
condition|)
block|{
case|case
name|LLC_LOCAL_BUSY_CLEARED
case|:
switch|switch
condition|(
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|DATA
argument_list|)
condition|)
block|{
case|case
literal|1
case|:
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_REJ
argument_list|,
name|LLC_CMD
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LLC_START_REJ_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|AWAIT_REJECT
argument_list|)
expr_stmt|;
name|action
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|0
case|:
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_RR
argument_list|,
name|LLC_CMD
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|AWAIT
argument_list|)
expr_stmt|;
name|action
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_RR
argument_list|,
name|LLC_CMD
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|AWAIT_REJECT
argument_list|)
expr_stmt|;
name|action
operator|=
literal|0
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|LLC_INVALID_NS
operator|+
name|LLC_CMD
case|:
case|case
name|LLC_INVALID_NS
operator|+
name|LLC_RSP
case|:
block|{
specifier|register
name|int
name|p
init|=
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|P
argument_list|)
decl_stmt|;
specifier|register
name|int
name|nr
init|=
name|LLCGBITS
argument_list|(
name|frame
operator|->
name|llc_control_ext
argument_list|,
name|s_nr
argument_list|)
decl_stmt|;
if|if
condition|(
name|cmdrsp
operator|==
name|LLC_CMD
operator|&&
name|pollfinal
operator|==
literal|1
condition|)
block|{
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_RNR
argument_list|,
name|LLC_RSP
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|LLC_SETFLAG
argument_list|(
name|linkp
argument_list|,
name|DATA
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|action
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cmdrsp
operator|==
name|LLC_RSP
operator|&&
name|pollfinal
operator|==
literal|1
condition|)
block|{
comment|/* optionally */
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_RNR
argument_list|,
name|LLC_CMD
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|linkp
operator|->
name|llcl_vs
operator|=
name|nr
expr_stmt|;
name|LLC_STOP_P_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_SETFLAG
argument_list|(
name|linkp
argument_list|,
name|DATA
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LLC_CLEAR_REMOTE_BUSY
argument_list|(
name|linkp
argument_list|,
name|action
argument_list|)
expr_stmt|;
name|llc_resend
argument_list|(
name|linkp
argument_list|,
name|LLC_CMD
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|BUSY
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pollfinal
operator|==
literal|0
condition|)
block|{
comment|/* optionally */
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_RNR
argument_list|,
name|LLC_CMD
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|LLC_SETFLAG
argument_list|(
name|linkp
argument_list|,
name|DATA
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|action
operator|=
literal|0
expr_stmt|;
block|}
block|}
case|case
name|LLCFT_INFO
operator|+
name|LLC_CMD
case|:
case|case
name|LLCFT_INFO
operator|+
name|LLC_RSP
case|:
block|{
specifier|register
name|int
name|p
init|=
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|P
argument_list|)
decl_stmt|;
specifier|register
name|int
name|nr
init|=
name|LLCGBITS
argument_list|(
name|frame
operator|->
name|llc_control_ext
argument_list|,
name|s_nr
argument_list|)
decl_stmt|;
if|if
condition|(
name|cmdrsp
operator|==
name|LLC_CMD
operator|&&
name|pollfinal
operator|==
literal|1
condition|)
block|{
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_RNR
argument_list|,
name|LLC_RSP
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LLC_INC
argument_list|(
name|linkp
operator|->
name|llcl_vr
argument_list|)
expr_stmt|;
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|LLC_SETFLAG
argument_list|(
name|linkp
argument_list|,
name|DATA
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|action
operator|=
name|LLC_DATA_INDICATION
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cmdrsp
operator|==
name|LLC_RSP
operator|&&
name|pollfinal
operator|==
literal|1
condition|)
block|{
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_RNR
argument_list|,
name|LLC_CMD
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LLC_INC
argument_list|(
name|linkp
operator|->
name|llcl_vr
argument_list|)
expr_stmt|;
name|LLC_START_P_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|linkp
operator|->
name|llcl_vs
operator|=
name|nr
expr_stmt|;
name|LLC_SETFLAG
argument_list|(
name|linkp
argument_list|,
name|DATA
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LLC_CLEAR_REMOTE_BUSY
argument_list|(
name|linkp
argument_list|,
name|action
argument_list|)
expr_stmt|;
name|llc_resend
argument_list|(
name|linkp
argument_list|,
name|LLC_CMD
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|BUSY
argument_list|)
expr_stmt|;
name|action
operator|=
name|LLC_DATA_INDICATION
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pollfinal
operator|==
literal|0
condition|)
block|{
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_RNR
argument_list|,
name|LLC_CMD
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LLC_INC
argument_list|(
name|linkp
operator|->
name|llcl_vr
argument_list|)
expr_stmt|;
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|LLC_SETFLAG
argument_list|(
name|linkp
argument_list|,
name|DATA
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|action
operator|=
name|LLC_DATA_INDICATION
expr_stmt|;
block|}
break|break;
block|}
case|case
name|LLCFT_RR
operator|+
name|LLC_CMD
case|:
case|case
name|LLCFT_REJ
operator|+
name|LLC_CMD
case|:
case|case
name|LLCFT_RR
operator|+
name|LLC_RSP
case|:
case|case
name|LLCFT_REJ
operator|+
name|LLC_RSP
case|:
block|{
specifier|register
name|int
name|p
init|=
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|P
argument_list|)
decl_stmt|;
specifier|register
name|int
name|nr
init|=
name|LLCGBITS
argument_list|(
name|frame
operator|->
name|llc_control_ext
argument_list|,
name|s_nr
argument_list|)
decl_stmt|;
if|if
condition|(
name|cmdrsp
operator|==
name|LLC_CMD
operator|&&
name|pollfinal
operator|==
literal|1
condition|)
block|{
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_RNR
argument_list|,
name|LLC_RSP
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|LLC_CLEAR_REMOTE_BUSY
argument_list|(
name|linkp
argument_list|,
name|action
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cmdrsp
operator|==
name|LLC_RSP
operator|&&
name|pollfinal
operator|==
literal|1
condition|)
block|{
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|linkp
operator|->
name|llcl_vs
operator|=
name|nr
expr_stmt|;
name|LLC_STOP_P_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|llc_resend
argument_list|(
name|linkp
argument_list|,
name|LLC_CMD
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LLC_CLEAR_REMOTE_BUSY
argument_list|(
name|linkp
argument_list|,
name|action
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|BUSY
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pollfinal
operator|==
literal|0
condition|)
block|{
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|linkp
operator|->
name|llcl_vs
operator|=
name|nr
expr_stmt|;
name|LLC_STOP_P_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|llc_resend
argument_list|(
name|linkp
argument_list|,
name|LLC_CMD
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LLC_CLEAR_REMOTE_BUSY
argument_list|(
name|linkp
argument_list|,
name|action
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
case|case
name|LLCFT_RNR
operator|+
name|LLC_CMD
case|:
case|case
name|LLCFT_RNR
operator|+
name|LLC_RSP
case|:
block|{
specifier|register
name|int
name|p
init|=
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|P
argument_list|)
decl_stmt|;
specifier|register
name|int
name|nr
init|=
name|LLCGBITS
argument_list|(
name|frame
operator|->
name|llc_control_ext
argument_list|,
name|s_nr
argument_list|)
decl_stmt|;
if|if
condition|(
name|cmdrsp
operator|==
name|LLC_CMD
operator|&&
name|pollfinal
operator|==
literal|1
condition|)
block|{
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_RNR
argument_list|,
name|LLC_RSP
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|LLC_SET_REMOTE_BUSY
argument_list|(
name|linkp
argument_list|,
name|action
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cmdrsp
operator|==
name|LLC_RSP
operator|&&
name|pollfinal
operator|==
literal|1
condition|)
block|{
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|linkp
operator|->
name|llcl_vs
operator|=
name|nr
expr_stmt|;
name|LLC_STOP_P_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_SET_REMOTE_BUSY
argument_list|(
name|linkp
argument_list|,
name|action
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|BUSY
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pollfinal
operator|==
literal|0
condition|)
block|{
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|LLC_SET_REMOTE_BUSY
argument_list|(
name|linkp
argument_list|,
name|action
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
case|case
name|LLC_P_TIMER_EXPIRED
case|:
if|if
condition|(
name|linkp
operator|->
name|llcl_retry
operator|<
name|llc_n2
condition|)
block|{
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_RNR
argument_list|,
name|LLC_CMD
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LLC_START_P_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|linkp
operator|->
name|llcl_retry
operator|++
expr_stmt|;
name|action
operator|=
literal|0
expr_stmt|;
block|}
break|break;
block|}
if|if
condition|(
name|action
operator|==
name|LLC_PASSITON
condition|)
name|action
operator|=
name|llc_state_NBRAcore
argument_list|(
name|linkp
argument_list|,
name|frame
argument_list|,
name|frame_kind
argument_list|,
name|cmdrsp
argument_list|,
name|pollfinal
argument_list|)
expr_stmt|;
return|return
name|action
return|;
block|}
end_function

begin_comment
comment|/*  * AWAIT_REJECT --- A data link connection exists between the local LLC service  *                  access point and the remote LLC service access point. The  *                  local connection component has requested that the remote  *                  connection component re-transmit a specific I PDU that the  *                  local connection component has detected as being out of  *                  sequence. Before the local LLC entered this state it was  *                  performing a timer recovery operation and had sent a  *                  command PDU with the P bit set to ``1'', and is still  *                  awaiting an acknowledgment from the remote LLC. I PDUs may  *                  be received but not transmitted. Supervisory PDUs may be  *                  both transmitted and received.  */
end_comment

begin_function
name|int
name|llc_state_AWAIT_REJECT
parameter_list|(
name|struct
name|llc_linkcb
modifier|*
name|linkp
parameter_list|,
name|struct
name|llc
modifier|*
name|frame
parameter_list|,
name|int
name|frame_kind
parameter_list|,
name|int
name|cmdrsp
parameter_list|,
name|int
name|pollfinal
parameter_list|)
block|{
name|int
name|action
init|=
name|LLC_PASSITON
decl_stmt|;
switch|switch
condition|(
name|frame_kind
operator|+
name|cmdrsp
condition|)
block|{
case|case
name|LLC_LOCAL_BUSY_DETECTED
case|:
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_RNR
argument_list|,
name|LLC_CMD
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LLC_SETFLAG
argument_list|(
name|linkp
argument_list|,
name|DATA
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|AWAIT_BUSY
argument_list|)
expr_stmt|;
name|action
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|LLC_INVALID_NS
operator|+
name|LLC_CMD
case|:
case|case
name|LLC_INVALID_NS
operator|+
name|LLC_RSP
case|:
block|{
specifier|register
name|int
name|nr
init|=
name|LLCGBITS
argument_list|(
name|frame
operator|->
name|llc_control_ext
argument_list|,
name|s_nr
argument_list|)
decl_stmt|;
if|if
condition|(
name|cmdrsp
operator|==
name|LLC_CMD
operator|&&
name|pollfinal
operator|==
literal|1
condition|)
block|{
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_RR
argument_list|,
name|LLC_RSP
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|action
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cmdrsp
operator|==
name|LLC_RSP
operator|&&
name|pollfinal
operator|==
literal|1
condition|)
block|{
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|linkp
operator|->
name|llcl_vs
operator|=
name|nr
expr_stmt|;
name|llc_resend
argument_list|(
name|linkp
argument_list|,
name|LLC_CMD
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LLC_START_P_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_CLEAR_REMOTE_BUSY
argument_list|(
name|linkp
argument_list|,
name|action
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|REJECT
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pollfinal
operator|==
literal|0
condition|)
block|{
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|action
operator|=
literal|0
expr_stmt|;
block|}
break|break;
block|}
case|case
name|LLCFT_INFO
operator|+
name|LLC_CMD
case|:
case|case
name|LLCFT_INFO
operator|+
name|LLC_RSP
case|:
block|{
specifier|register
name|int
name|nr
init|=
name|LLCGBITS
argument_list|(
name|frame
operator|->
name|llc_control_ext
argument_list|,
name|s_nr
argument_list|)
decl_stmt|;
if|if
condition|(
name|cmdrsp
operator|==
name|LLC_CMD
operator|&&
name|pollfinal
operator|==
literal|1
condition|)
block|{
name|LLC_INC
argument_list|(
name|linkp
operator|->
name|llcl_vr
argument_list|)
expr_stmt|;
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_RR
argument_list|,
name|LLC_RSP
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LLC_STOP_REJ_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|AWAIT
argument_list|)
expr_stmt|;
name|action
operator|=
name|LLC_DATA_INDICATION
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cmdrsp
operator|==
name|LLC_RSP
operator|&&
name|pollfinal
operator|==
literal|1
condition|)
block|{
name|LLC_INC
argument_list|(
name|linkp
operator|->
name|llcl_vr
argument_list|)
expr_stmt|;
name|LLC_STOP_P_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_STOP_REJ_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|linkp
operator|->
name|llcl_vs
operator|=
name|nr
expr_stmt|;
name|llc_resend
argument_list|(
name|linkp
argument_list|,
name|LLC_CMD
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LLC_CLEAR_REMOTE_BUSY
argument_list|(
name|linkp
argument_list|,
name|action
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|NORMAL
argument_list|)
expr_stmt|;
name|action
operator|=
name|LLC_DATA_INDICATION
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pollfinal
operator|==
literal|0
condition|)
block|{
name|LLC_INC
argument_list|(
name|linkp
operator|->
name|llcl_vr
argument_list|)
expr_stmt|;
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_RR
argument_list|,
name|LLC_CMD
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LLC_STOP_REJ_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|AWAIT
argument_list|)
expr_stmt|;
name|action
operator|=
name|LLC_DATA_INDICATION
expr_stmt|;
block|}
break|break;
block|}
case|case
name|LLCFT_RR
operator|+
name|LLC_CMD
case|:
case|case
name|LLCFT_REJ
operator|+
name|LLC_CMD
case|:
case|case
name|LLCFT_RR
operator|+
name|LLC_RSP
case|:
case|case
name|LLCFT_REJ
operator|+
name|LLC_RSP
case|:
block|{
specifier|register
name|int
name|nr
init|=
name|LLCGBITS
argument_list|(
name|frame
operator|->
name|llc_control_ext
argument_list|,
name|s_nr
argument_list|)
decl_stmt|;
if|if
condition|(
name|cmdrsp
operator|==
name|LLC_CMD
operator|&&
name|pollfinal
operator|==
literal|1
condition|)
block|{
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_RR
argument_list|,
name|LLC_RSP
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|LLC_CLEAR_REMOTE_BUSY
argument_list|(
name|linkp
argument_list|,
name|action
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cmdrsp
operator|==
name|LLC_RSP
operator|&&
name|pollfinal
operator|==
literal|1
condition|)
block|{
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|linkp
operator|->
name|llcl_vs
operator|=
name|nr
expr_stmt|;
name|llc_resend
argument_list|(
name|linkp
argument_list|,
name|LLC_CMD
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LLC_START_P_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_CLEAR_REMOTE_BUSY
argument_list|(
name|linkp
argument_list|,
name|action
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|REJECT
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pollfinal
operator|==
literal|0
condition|)
block|{
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|LLC_CLEAR_REMOTE_BUSY
argument_list|(
name|linkp
argument_list|,
name|action
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
case|case
name|LLCFT_RNR
operator|+
name|LLC_CMD
case|:
case|case
name|LLCFT_RNR
operator|+
name|LLC_RSP
case|:
block|{
specifier|register
name|int
name|nr
init|=
name|LLCGBITS
argument_list|(
name|frame
operator|->
name|llc_control_ext
argument_list|,
name|s_nr
argument_list|)
decl_stmt|;
if|if
condition|(
name|cmdrsp
operator|==
name|LLC_CMD
operator|&&
name|pollfinal
operator|==
literal|1
condition|)
block|{
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_RR
argument_list|,
name|LLC_RSP
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|LLC_SET_REMOTE_BUSY
argument_list|(
name|linkp
argument_list|,
name|action
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cmdrsp
operator|==
name|LLC_RSP
operator|&&
name|pollfinal
operator|==
literal|1
condition|)
block|{
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|linkp
operator|->
name|llcl_vs
operator|=
name|nr
expr_stmt|;
name|LLC_STOP_P_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|LLC_SET_REMOTE_BUSY
argument_list|(
name|linkp
argument_list|,
name|action
argument_list|)
expr_stmt|;
name|LLC_NEWSTATE
argument_list|(
name|linkp
argument_list|,
name|REJECT
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pollfinal
operator|==
literal|0
condition|)
block|{
name|LLC_UPDATE_NR_RECEIVED
argument_list|(
name|linkp
argument_list|,
name|nr
argument_list|)
expr_stmt|;
name|LLC_SET_REMOTE_BUSY
argument_list|(
name|linkp
argument_list|,
name|action
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
case|case
name|LLC_P_TIMER_EXPIRED
case|:
if|if
condition|(
name|linkp
operator|->
name|llcl_retry
operator|<
name|llc_n2
condition|)
block|{
name|llc_send
argument_list|(
name|linkp
argument_list|,
name|LLCFT_REJ
argument_list|,
name|LLC_CMD
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LLC_START_P_TIMER
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
name|linkp
operator|->
name|llcl_retry
operator|++
expr_stmt|;
name|action
operator|=
literal|0
expr_stmt|;
block|}
break|break;
block|}
if|if
condition|(
name|action
operator|==
name|LLC_PASSITON
condition|)
name|action
operator|=
name|llc_state_NBRAcore
argument_list|(
name|linkp
argument_list|,
name|frame
argument_list|,
name|frame_kind
argument_list|,
name|cmdrsp
argument_list|,
name|pollfinal
argument_list|)
expr_stmt|;
return|return
name|action
return|;
block|}
end_function

begin_comment
comment|/*  * llc_statehandler() --- Wrapper for llc_state_*() functions.  *                         Deals with action codes and checks for  *                         ``stuck'' links.  */
end_comment

begin_function
name|int
name|llc_statehandler
parameter_list|(
name|struct
name|llc_linkcb
modifier|*
name|linkp
parameter_list|,
name|struct
name|llc
modifier|*
name|frame
parameter_list|,
name|int
name|frame_kind
parameter_list|,
name|int
name|cmdrsp
parameter_list|,
name|int
name|pollfinal
parameter_list|)
block|{
specifier|register
name|int
name|action
init|=
literal|0
decl_stmt|;
comment|/* 	 * To check for ``zombie'' links each time llc_statehandler() gets called 	 * the AGE timer of linkp is reset. If it expires llc_timer() will 	 * take care of the link --- i.e. kill it 8=) 	 */
name|LLC_STARTTIMER
argument_list|(
name|linkp
argument_list|,
name|AGE
argument_list|)
expr_stmt|;
comment|/* 	 * Now call the current statehandler function. 	 */
name|action
operator|=
call|(
modifier|*
name|linkp
operator|->
name|llcl_statehandler
call|)
argument_list|(
name|linkp
argument_list|,
name|frame
argument_list|,
name|frame_kind
argument_list|,
name|cmdrsp
argument_list|,
name|pollfinal
argument_list|)
expr_stmt|;
name|once_more_and_again
label|:
switch|switch
condition|(
name|action
condition|)
block|{
case|case
name|LLC_CONNECT_INDICATION
case|:
block|{
name|int
name|naction
decl_stmt|;
name|LLC_TRACE
argument_list|(
name|linkp
argument_list|,
name|LLCTR_INTERESTING
argument_list|,
literal|"CONNECT INDICATION"
argument_list|)
expr_stmt|;
name|linkp
operator|->
name|llcl_nlnext
operator|=
call|(
modifier|*
name|linkp
operator|->
name|llcl_sapinfo
operator|->
name|si_ctlinput
call|)
argument_list|(
name|PRC_CONNECT_INDICATION
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|linkp
operator|->
name|llcl_addr
argument_list|,
operator|(
name|caddr_t
operator|)
name|linkp
argument_list|)
expr_stmt|;
if|if
condition|(
name|linkp
operator|->
name|llcl_nlnext
operator|==
literal|0
condition|)
name|naction
operator|=
name|NL_DISCONNECT_REQUEST
expr_stmt|;
else|else
name|naction
operator|=
name|NL_CONNECT_RESPONSE
expr_stmt|;
name|action
operator|=
call|(
modifier|*
name|linkp
operator|->
name|llcl_statehandler
call|)
argument_list|(
name|linkp
argument_list|,
name|frame
argument_list|,
name|naction
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
goto|goto
name|once_more_and_again
goto|;
block|}
case|case
name|LLC_CONNECT_CONFIRM
case|:
comment|/* llc_resend(linkp, LLC_CMD, 0); */
name|llc_start
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
break|break;
case|case
name|LLC_DISCONNECT_INDICATION
case|:
name|LLC_TRACE
argument_list|(
name|linkp
argument_list|,
name|LLCTR_INTERESTING
argument_list|,
literal|"DISCONNECT INDICATION"
argument_list|)
expr_stmt|;
call|(
modifier|*
name|linkp
operator|->
name|llcl_sapinfo
operator|->
name|si_ctlinput
call|)
argument_list|(
name|PRC_DISCONNECT_INDICATION
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|linkp
operator|->
name|llcl_addr
argument_list|,
name|linkp
operator|->
name|llcl_nlnext
argument_list|)
expr_stmt|;
break|break;
comment|/* internally visible only */
case|case
name|LLC_RESET_CONFIRM
case|:
case|case
name|LLC_RESET_INDICATION_LOCAL
case|:
comment|/* 		 * not much we can do here, the state machine either makes it or 		 * brakes it ... 		 */
break|break;
case|case
name|LLC_RESET_INDICATION_REMOTE
case|:
name|LLC_TRACE
argument_list|(
name|linkp
argument_list|,
name|LLCTR_SHOULDKNOW
argument_list|,
literal|"RESET INDICATION (REMOTE)"
argument_list|)
expr_stmt|;
name|action
operator|=
call|(
modifier|*
name|linkp
operator|->
name|llcl_statehandler
call|)
argument_list|(
name|linkp
argument_list|,
name|frame
argument_list|,
name|NL_RESET_RESPONSE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
goto|goto
name|once_more_and_again
goto|;
case|case
name|LLC_FRMR_SENT
case|:
name|LLC_TRACE
argument_list|(
name|linkp
argument_list|,
name|LLCTR_URGENT
argument_list|,
literal|"FRMR SENT"
argument_list|)
expr_stmt|;
break|break;
case|case
name|LLC_FRMR_RECEIVED
case|:
name|LLC_TRACE
argument_list|(
name|linkp
argument_list|,
name|LLCTR_URGEN
argument_list|,
literal|"FRMR RECEIVED"
argument_list|)
expr_stmt|;
name|action
operator|=
call|(
modifier|*
name|linkp
operator|->
name|llcl_statehandler
call|)
argument_list|(
name|linkp
argument_list|,
name|frame
argument_list|,
name|NL_RESET_REQUEST
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
goto|goto
name|once_more_and_again
goto|;
case|case
name|LLC_REMOTE_BUSY
case|:
name|LLC_TRACE
argument_list|(
name|linkp
argument_list|,
name|LLCTR_SHOULDKNOW
argument_list|,
literal|"REMOTE BUSY"
argument_list|)
expr_stmt|;
break|break;
case|case
name|LLC_REMOTE_NOT_BUSY
case|:
name|LLC_TRACE
argument_list|(
name|linkp
argument_list|,
name|LLCTR_SHOULDKNOW
argument_list|,
literal|"REMOTE BUSY CLEARED"
argument_list|)
expr_stmt|;
comment|/* 		 * try to get queued frames out 		 */
name|llc_start
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/*          * Only LLC_DATA_INDICATION is for the time being 	 * passed up to the network layer entity. 	 * The remaining action codes are for the time 	 * being visible internally only.          * However, this can/may be changed if necessary. 	 */
return|return
name|action
return|;
block|}
end_function

begin_comment
comment|/*  * Core LLC2 routines  */
end_comment

begin_comment
comment|/*  * The INIT call. This routine is called once after the system is booted.  */
end_comment

begin_macro
name|llc_init
argument_list|()
end_macro

begin_block
block|{
name|llcintrq
operator|.
name|ifq_maxlen
operator|=
name|IFQ_MAXLEN
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * In case of a link reset we need to shuffle the frames queued inside the  * LLC2 window.  */
end_comment

begin_function
name|void
name|llc_resetwindow
parameter_list|(
name|struct
name|llc_linkcb
modifier|*
name|linkp
parameter_list|)
block|{
specifier|register
name|struct
name|mbuf
modifier|*
name|mptr
init|=
operator|(
expr|struct
name|mbuf
operator|*
operator|)
literal|0
decl_stmt|;
specifier|register
name|struct
name|mbuf
modifier|*
name|anchor
init|=
operator|(
expr|struct
name|mbuf
operator|*
operator|)
literal|0
decl_stmt|;
specifier|register
name|short
name|i
decl_stmt|;
comment|/* Pick up all queued frames and collect them in a linked mbuf list */
if|if
condition|(
name|linkp
operator|->
name|llcl_slotsfree
operator|!=
name|linkp
operator|->
name|llcl_window
condition|)
block|{
name|i
operator|=
name|llc_seq2slot
argument_list|(
name|linkp
argument_list|,
name|linkp
operator|->
name|llcl_nr_received
argument_list|)
expr_stmt|;
name|anchor
operator|=
name|mptr
operator|=
name|linkp
operator|->
name|llcl_output_buffers
index|[
name|i
index|]
expr_stmt|;
for|for
control|(
init|;
name|i
operator|!=
name|linkp
operator|->
name|llcl_freeslot
condition|;
name|i
operator|=
name|llc_seq2slot
argument_list|(
name|linkp
argument_list|,
name|i
operator|+
literal|1
argument_list|)
control|)
block|{
if|if
condition|(
name|linkp
operator|->
name|llcl_output_buffers
index|[
name|i
index|]
condition|)
block|{
name|mptr
operator|->
name|m_nextpkt
operator|=
name|linkp
operator|->
name|llcl_output_buffers
index|[
name|i
index|]
expr_stmt|;
name|mptr
operator|=
name|mptr
operator|->
name|m_nextpkt
expr_stmt|;
block|}
else|else
name|panic
argument_list|(
literal|"LLC2 window broken"
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* clean closure */
if|if
condition|(
name|mptr
condition|)
name|mptr
operator|->
name|m_nextpkt
operator|=
operator|(
expr|struct
name|mbuf
operator|*
operator|)
literal|0
expr_stmt|;
comment|/* Now --- plug 'em in again */
if|if
condition|(
name|anchor
operator|!=
operator|(
expr|struct
name|mbuf
operator|*
operator|)
literal|0
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|mptr
operator|=
name|anchor
init|;
name|mptr
operator|!=
operator|(
expr|struct
name|mbuf
operator|*
operator|)
literal|0
condition|;
name|i
operator|++
control|)
block|{
name|linkp
operator|->
name|llcl_output_buffers
index|[
name|i
index|]
operator|=
name|mptr
expr_stmt|;
name|mptr
operator|=
name|mptr
operator|->
name|m_nextpkt
expr_stmt|;
name|linkp
operator|->
name|llcl_output_buffers
index|[
name|i
index|]
operator|->
name|m_nextpkt
operator|=
operator|(
expr|struct
name|mbuf
operator|*
operator|)
literal|0
expr_stmt|;
block|}
name|linkp
operator|->
name|llcl_freeslot
operator|=
name|i
expr_stmt|;
block|}
else|else
name|linkp
operator|->
name|llcl_freeslot
operator|=
literal|0
expr_stmt|;
comment|/* We're resetting the link, the next frame to be acknowledged is 0 */
name|linkp
operator|->
name|llcl_nr_received
operator|=
literal|0
expr_stmt|;
comment|/* set distance between LLC2 sequence number and the top of window to 0 */
name|linkp
operator|->
name|llcl_projvs
operator|=
name|linkp
operator|->
name|llcl_freeslot
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*  * llc_newlink() --- We allocate enough memory to contain a link control block  *                   and initialize it properly. We don't intiate the actual setup  *                   of the LLC2 link here.  */
end_comment

begin_function
name|struct
name|llc_linkcb
modifier|*
name|llc_newlink
parameter_list|(
name|struct
name|sockaddr_dl
modifier|*
name|dst
parameter_list|,
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|rtentry
modifier|*
name|nlrt
parameter_list|,
name|caddr_t
name|nlnext
parameter_list|,
name|struct
name|rtentry
modifier|*
name|llrt
parameter_list|)
block|{
name|struct
name|llc_linkcb
modifier|*
name|nlinkp
decl_stmt|;
name|u_char
name|sap
init|=
name|LLSAPADDR
argument_list|(
name|dst
argument_list|)
decl_stmt|;
name|short
name|llcwindow
decl_stmt|;
comment|/* allocate memory for link control block */
name|MALLOC
argument_list|(
name|nlinkp
argument_list|,
expr|struct
name|llc_linkcb
operator|*
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|llc_linkcb
argument_list|)
argument_list|,
name|M_PCB
argument_list|,
name|M_DONTWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|nlinkp
operator|==
literal|0
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|bzero
argument_list|(
operator|(
name|caddr_t
operator|)
name|nlinkp
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|llc_linkcb
argument_list|)
argument_list|)
expr_stmt|;
comment|/* copy link address */
name|sdl_copy
argument_list|(
name|dst
argument_list|,
operator|&
name|nlinkp
operator|->
name|llcl_addr
argument_list|)
expr_stmt|;
comment|/* hold on to the network layer route entry */
name|nlinkp
operator|->
name|llcl_nlrt
operator|=
name|nlrt
expr_stmt|;
comment|/* likewise the network layer control block */
name|nlinkp
operator|->
name|llcl_nlnext
operator|=
name|nlnext
expr_stmt|;
comment|/* jot down the link layer route entry */
name|nlinkp
operator|->
name|llcl_llrt
operator|=
name|llrt
expr_stmt|;
comment|/* reset writeq */
name|nlinkp
operator|->
name|llcl_writeqh
operator|=
name|nlinkp
operator|->
name|llcl_writeqt
operator|=
name|NULL
expr_stmt|;
comment|/* setup initial state handler function */
name|nlinkp
operator|->
name|llcl_statehandler
operator|=
name|llc_state_ADM
expr_stmt|;
comment|/* hold on to interface pointer */
name|nlinkp
operator|->
name|llcl_if
operator|=
name|ifp
expr_stmt|;
comment|/* get service access point information */
name|nlinkp
operator|->
name|llcl_sapinfo
operator|=
name|llc_getsapinfo
argument_list|(
name|sap
argument_list|,
name|ifp
argument_list|)
expr_stmt|;
comment|/* get window size from SAP info block */
if|if
condition|(
operator|(
name|llcwindow
operator|=
name|nlinkp
operator|->
name|llcl_sapinfo
operator|->
name|si_window
operator|)
operator|==
literal|0
condition|)
name|llcwindow
operator|=
name|LLC_MAX_WINDOW
expr_stmt|;
comment|/* allocate memory for window buffer */
name|MALLOC
argument_list|(
name|nlinkp
operator|->
name|llcl_output_buffers
argument_list|,
expr|struct
name|mbuf
operator|*
operator|*
argument_list|,
name|llcwindow
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|mbuf
operator|*
argument_list|)
argument_list|,
name|M_PCB
argument_list|,
name|M_DONTWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|nlinkp
operator|->
name|llcl_output_buffers
operator|==
literal|0
condition|)
block|{
name|FREE
argument_list|(
name|nlinkp
argument_list|,
name|M_PCB
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|bzero
argument_list|(
operator|(
name|caddr_t
operator|)
name|nlinkp
operator|->
name|llcl_output_buffers
argument_list|,
name|llcwindow
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|mbuf
operator|*
argument_list|)
argument_list|)
expr_stmt|;
comment|/* set window size& slotsfree */
name|nlinkp
operator|->
name|llcl_slotsfree
operator|=
name|nlinkp
operator|->
name|llcl_window
operator|=
name|llcwindow
expr_stmt|;
comment|/* enter into linked listed of link control blocks */
name|insque
argument_list|(
name|nlinkp
argument_list|,
operator|&
name|llccb_q
argument_list|)
expr_stmt|;
return|return
operator|(
name|nlinkp
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * llc_dellink() --- farewell to link control block  */
end_comment

begin_macro
name|llc_dellink
argument_list|(
argument|struct llc_linkcb *linkp
argument_list|)
end_macro

begin_block
block|{
specifier|register
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
specifier|register
name|struct
name|mbuf
modifier|*
name|n
decl_stmt|;
specifier|register
name|struct
name|npaidbentry
modifier|*
name|sapinfo
init|=
name|linkp
operator|->
name|llcl_sapinfo
decl_stmt|;
specifier|register
name|i
expr_stmt|;
comment|/* notify upper layer of imminent death */
if|if
condition|(
name|linkp
operator|->
name|llcl_nlnext
operator|&&
name|sapinfo
operator|->
name|si_ctlinput
condition|)
call|(
modifier|*
name|sapinfo
operator|->
name|si_ctlinput
call|)
argument_list|(
name|PRC_DISCONNECT_INDICATION
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|linkp
operator|->
name|llcl_addr
argument_list|,
name|linkp
operator|->
name|llcl_nlnext
argument_list|)
expr_stmt|;
comment|/* pull the plug */
if|if
condition|(
name|linkp
operator|->
name|llcl_llrt
condition|)
operator|(
operator|(
expr|struct
name|npaidbentry
operator|*
operator|)
operator|(
name|linkp
operator|->
name|llcl_llrt
operator|->
name|rt_llinfo
operator|)
operator|)
operator|->
name|np_link
operator|=
operator|(
expr|struct
name|llc_linkcb
operator|*
operator|)
literal|0
expr_stmt|;
comment|/* leave link control block queue */
name|remque
argument_list|(
name|linkp
argument_list|)
expr_stmt|;
comment|/* drop queued packets */
for|for
control|(
name|m
operator|=
name|linkp
operator|->
name|llcl_writeqh
init|;
name|m
condition|;
control|)
block|{
name|n
operator|=
name|m
operator|->
name|m_act
expr_stmt|;
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|m
operator|=
name|n
expr_stmt|;
block|}
comment|/* drop packets in the window */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|linkp
operator|->
name|llcl_window
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|linkp
operator|->
name|llcl_output_buffers
index|[
name|i
index|]
condition|)
name|m_freem
argument_list|(
name|linkp
operator|->
name|llcl_output_buffers
index|[
name|i
index|]
argument_list|)
expr_stmt|;
comment|/* return the window space */
name|FREE
argument_list|(
operator|(
name|caddr_t
operator|)
name|linkp
operator|->
name|llcl_output_buffers
argument_list|,
name|M_PCB
argument_list|)
expr_stmt|;
comment|/* return the control block space --- now it's gone ... */
name|FREE
argument_list|(
operator|(
name|caddr_t
operator|)
name|linkp
argument_list|,
name|M_PCB
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|llc_decode
argument_list|(
argument|struct llc* frame
argument_list|,
argument|struct llc_linkcb * linkp
argument_list|)
end_macro

begin_block
block|{
specifier|register
name|int
name|ft
init|=
name|LLC_BAD_PDU
decl_stmt|;
if|if
condition|(
operator|(
name|frame
operator|->
name|llc_control
operator|&
literal|01
operator|)
operator|==
literal|0
condition|)
block|{
name|ft
operator|=
name|LLCFT_INFO
expr_stmt|;
comment|/* S or U frame ? */
block|}
else|else
switch|switch
condition|(
name|frame
operator|->
name|llc_control
condition|)
block|{
comment|/* U frames */
case|case
name|LLC_UI
case|:
case|case
name|LLC_UI_P
case|:
name|ft
operator|=
name|LLC_UI
expr_stmt|;
break|break;
case|case
name|LLC_DM
case|:
case|case
name|LLC_DM_P
case|:
name|ft
operator|=
name|LLCFT_DM
expr_stmt|;
break|break;
case|case
name|LLC_DISC
case|:
case|case
name|LLC_DISC_P
case|:
name|ft
operator|=
name|LLCFT_DISC
expr_stmt|;
break|break;
case|case
name|LLC_UA
case|:
case|case
name|LLC_UA_P
case|:
name|ft
operator|=
name|LLCFT_UA
expr_stmt|;
break|break;
case|case
name|LLC_SABME
case|:
case|case
name|LLC_SABME_P
case|:
name|ft
operator|=
name|LLCFT_SABME
expr_stmt|;
break|break;
case|case
name|LLC_FRMR
case|:
case|case
name|LLC_FRMR_P
case|:
name|ft
operator|=
name|LLCFT_FRMR
expr_stmt|;
break|break;
case|case
name|LLC_XID
case|:
case|case
name|LLC_XID_P
case|:
name|ft
operator|=
name|LLCFT_XID
expr_stmt|;
break|break;
case|case
name|LLC_TEST
case|:
case|case
name|LLC_TEST_P
case|:
name|ft
operator|=
name|LLCFT_TEST
expr_stmt|;
break|break;
comment|/* S frames */
case|case
name|LLC_RR
case|:
name|ft
operator|=
name|LLCFT_RR
expr_stmt|;
break|break;
case|case
name|LLC_RNR
case|:
name|ft
operator|=
name|LLCFT_RNR
expr_stmt|;
break|break;
case|case
name|LLC_REJ
case|:
name|ft
operator|=
name|LLCFT_REJ
expr_stmt|;
break|break;
block|}
comment|/* switch */
if|if
condition|(
name|linkp
condition|)
block|{
switch|switch
condition|(
name|ft
condition|)
block|{
case|case
name|LLCFT_INFO
case|:
if|if
condition|(
name|LLCGBITS
argument_list|(
name|frame
operator|->
name|llc_control
argument_list|,
name|i_ns
argument_list|)
operator|!=
name|linkp
operator|->
name|llcl_vr
condition|)
block|{
name|ft
operator|=
name|LLC_INVALID_NS
expr_stmt|;
break|break;
block|}
comment|/* fall thru --- yeeeeeee */
case|case
name|LLCFT_RR
case|:
case|case
name|LLCFT_RNR
case|:
case|case
name|LLCFT_REJ
case|:
comment|/* splash! */
if|if
condition|(
name|LLC_NR_VALID
argument_list|(
name|linkp
argument_list|,
name|LLCGBITS
argument_list|(
name|frame
operator|->
name|llc_control_ext
argument_list|,
name|s_nr
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
name|ft
operator|=
name|LLC_INVALID_NR
expr_stmt|;
break|break;
block|}
block|}
return|return
name|ft
return|;
block|}
end_block

begin_comment
comment|/*  * llc_anytimersup() --- Checks if at least one timer is still up and running.  */
end_comment

begin_function
name|int
name|llc_anytimersup
parameter_list|(
name|struct
name|llc_linkcb
modifier|*
name|linkp
parameter_list|)
block|{
specifier|register
name|int
name|i
decl_stmt|;
name|FOR_ALL_LLC_TIMERS
argument_list|(
argument|i
argument_list|)
if|if
condition|(
name|linkp
operator|->
name|llcl_timers
index|[
name|i
index|]
operator|>
literal|0
condition|)
break|break;
if|if
condition|(
name|i
operator|==
name|LLC_AGE_SHIFT
condition|)
return|return
literal|0
return|;
else|else
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/*  * llc_link_dump() - dump link info  */
end_comment

begin_define
define|#
directive|define
name|SAL
parameter_list|(
name|s
parameter_list|)
value|((struct sockaddr_dl *)&(s)->llcl_addr)
end_define

begin_define
define|#
directive|define
name|CHECK
parameter_list|(
name|l
parameter_list|,
name|s
parameter_list|)
value|if (LLC_STATEEQ(l, s)) return #s
end_define

begin_decl_stmt
name|char
modifier|*
name|timer_names
index|[]
init|=
block|{
literal|"ACK"
block|,
literal|"P"
block|,
literal|"BUSY"
block|,
literal|"REJ"
block|,
literal|"AGE"
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|char
modifier|*
name|llc_getstatename
parameter_list|(
name|struct
name|llc_linkcb
modifier|*
name|linkp
parameter_list|)
block|{
name|CHECK
argument_list|(
name|linkp
argument_list|,
name|ADM
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|linkp
argument_list|,
name|CONN
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|linkp
argument_list|,
name|RESET_WAIT
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|linkp
argument_list|,
name|RESET_CHECK
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|linkp
argument_list|,
name|SETUP
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|linkp
argument_list|,
name|RESET
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|linkp
argument_list|,
name|D_CONN
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|linkp
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|linkp
argument_list|,
name|NORMAL
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|linkp
argument_list|,
name|BUSY
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|linkp
argument_list|,
name|REJECT
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|linkp
argument_list|,
name|AWAIT
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|linkp
argument_list|,
name|AWAIT_BUSY
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|linkp
argument_list|,
name|AWAIT_REJECT
argument_list|)
expr_stmt|;
return|return
literal|"UNKNOWN - eh?"
return|;
block|}
end_function

begin_function
name|void
name|llc_link_dump
parameter_list|(
name|struct
name|llc_linkcb
modifier|*
name|linkp
parameter_list|,
specifier|const
name|char
modifier|*
name|message
parameter_list|)
block|{
specifier|register
name|int
name|i
decl_stmt|;
specifier|register
name|char
modifier|*
name|state
decl_stmt|;
comment|/* print interface */
name|printf
argument_list|(
literal|"if %s%d\n"
argument_list|,
name|linkp
operator|->
name|llcl_if
operator|->
name|if_name
argument_list|,
name|linkp
operator|->
name|llcl_if
operator|->
name|if_unit
argument_list|)
expr_stmt|;
comment|/* print message */
name|printf
argument_list|(
literal|">> %s<<\n"
argument_list|,
name|message
argument_list|)
expr_stmt|;
comment|/* print MAC and LSAP */
name|printf
argument_list|(
literal|"llc addr "
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|SAL
argument_list|(
name|linkp
argument_list|)
operator|->
name|sdl_alen
operator|)
operator|-
literal|2
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"%x:"
argument_list|,
operator|(
name|char
operator|)
operator|*
operator|(
name|LLADDR
argument_list|(
name|SAL
argument_list|(
name|linkp
argument_list|)
argument_list|)
operator|+
name|i
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%x,"
argument_list|,
operator|(
name|char
operator|)
operator|*
operator|(
name|LLADDR
argument_list|(
name|SAL
argument_list|(
name|linkp
argument_list|)
argument_list|)
operator|+
name|i
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%x\n"
argument_list|,
operator|(
name|char
operator|)
operator|*
operator|(
name|LLADDR
argument_list|(
name|SAL
argument_list|(
name|linkp
argument_list|)
argument_list|)
operator|+
name|i
operator|+
literal|1
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
comment|/* print state we're in and timers */
name|printf
argument_list|(
literal|"state %s, "
argument_list|,
name|llc_getstatename
argument_list|(
name|linkp
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|LLC_ACK_SHIFT
init|;
name|i
operator|<
name|LLC_AGE_SHIFT
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"%s-%c %d/"
argument_list|,
name|timer_names
index|[
name|i
index|]
argument_list|,
operator|(
name|linkp
operator|->
name|llcl_timerflags
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
condition|?
literal|'R'
else|:
literal|'S'
operator|)
argument_list|,
name|linkp
operator|->
name|llcl_timers
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s-%c %d\n"
argument_list|,
name|timer_names
index|[
name|i
index|]
argument_list|,
operator|(
name|linkp
operator|->
name|llcl_timerflags
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
condition|?
literal|'R'
else|:
literal|'S'
operator|)
argument_list|,
name|linkp
operator|->
name|llcl_timers
index|[
name|i
index|]
argument_list|)
expr_stmt|;
comment|/* print flag values */
name|printf
argument_list|(
literal|"flags P %d/F %d/S %d/DATA %d/REMOTE_BUSY %d\n"
argument_list|,
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|P
argument_list|)
argument_list|,
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|F
argument_list|)
argument_list|,
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|S
argument_list|)
argument_list|,
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|DATA
argument_list|)
argument_list|,
name|LLC_GETFLAG
argument_list|(
name|linkp
argument_list|,
name|REMOTE_BUSY
argument_list|)
argument_list|)
expr_stmt|;
comment|/* print send and receive state variables, ack, and window */
name|printf
argument_list|(
literal|"V(R) %d/V(S) %d/N(R) received %d/window %d/freeslot %d\n"
argument_list|,
name|linkp
operator|->
name|llcl_vs
argument_list|,
name|linkp
operator|->
name|llcl_vr
argument_list|,
name|linkp
operator|->
name|llcl_nr_received
argument_list|,
name|linkp
operator|->
name|llcl_window
argument_list|,
name|linkp
operator|->
name|llcl_freeslot
argument_list|)
expr_stmt|;
comment|/* further expansions can follow here */
block|}
end_function

begin_function
name|void
name|llc_trace
parameter_list|(
name|struct
name|llc_linkcb
modifier|*
name|linkp
parameter_list|,
name|int
name|level
parameter_list|,
specifier|const
name|char
modifier|*
name|message
parameter_list|)
block|{
if|if
condition|(
name|linkp
operator|->
name|llcl_sapinfo
operator|->
name|si_trace
operator|&&
name|level
operator|>
name|llc_tracelevel
condition|)
name|llc_link_dump
argument_list|(
name|linkp
argument_list|,
name|message
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

end_unit


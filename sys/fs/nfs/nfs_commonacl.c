begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2009 Rick Macklem, University of Guelph  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_ifndef
ifndef|#
directive|ifndef
name|APPLEKEXT
end_ifndef

begin_include
include|#
directive|include
file|<fs/nfs/nfsport.h>
end_include

begin_decl_stmt
specifier|extern
name|int
name|nfsrv_useacl
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|int
name|nfsrv_acemasktoperm
parameter_list|(
name|u_int32_t
name|acetype
parameter_list|,
name|u_int32_t
name|mask
parameter_list|,
name|int
name|owner
parameter_list|,
name|enum
name|vtype
name|type
parameter_list|,
name|acl_perm_t
modifier|*
name|permp
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * Handle xdr for an ace.  */
end_comment

begin_function
name|APPLESTATIC
name|int
name|nfsrv_dissectace
parameter_list|(
name|struct
name|nfsrv_descript
modifier|*
name|nd
parameter_list|,
name|struct
name|acl_entry
modifier|*
name|acep
parameter_list|,
name|int
modifier|*
name|aceerrp
parameter_list|,
name|int
modifier|*
name|acesizep
parameter_list|,
name|NFSPROC_T
modifier|*
name|p
parameter_list|)
block|{
name|u_int32_t
modifier|*
name|tl
decl_stmt|;
name|int
name|len
decl_stmt|,
name|gotid
init|=
literal|0
decl_stmt|,
name|owner
init|=
literal|0
decl_stmt|,
name|error
init|=
literal|0
decl_stmt|,
name|aceerr
init|=
literal|0
decl_stmt|;
name|u_char
modifier|*
name|name
decl_stmt|,
name|namestr
index|[
name|NFSV4_SMALLSTR
operator|+
literal|1
index|]
decl_stmt|;
name|u_int32_t
name|flag
decl_stmt|,
name|mask
decl_stmt|,
name|acetype
decl_stmt|;
name|gid_t
name|gid
decl_stmt|;
name|uid_t
name|uid
decl_stmt|;
operator|*
name|aceerrp
operator|=
literal|0
expr_stmt|;
name|acep
operator|->
name|ae_flags
operator|=
literal|0
expr_stmt|;
name|NFSM_DISSECT
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
literal|4
operator|*
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|acetype
operator|=
name|fxdr_unsigned
argument_list|(
name|u_int32_t
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
expr_stmt|;
name|flag
operator|=
name|fxdr_unsigned
argument_list|(
name|u_int32_t
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
expr_stmt|;
name|mask
operator|=
name|fxdr_unsigned
argument_list|(
name|u_int32_t
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
expr_stmt|;
name|len
operator|=
name|fxdr_unsigned
argument_list|(
name|int
argument_list|,
operator|*
name|tl
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
condition|)
block|{
return|return
operator|(
name|NFSERR_BADXDR
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|len
operator|==
literal|0
condition|)
block|{
comment|/* Netapp filers return a 0 length who for nil users */
name|acep
operator|->
name|ae_tag
operator|=
name|ACL_UNDEFINED_TAG
expr_stmt|;
name|acep
operator|->
name|ae_id
operator|=
name|ACL_UNDEFINED_ID
expr_stmt|;
name|acep
operator|->
name|ae_perm
operator|=
operator|(
name|acl_perm_t
operator|)
literal|0
expr_stmt|;
name|acep
operator|->
name|ae_entry_type
operator|=
name|ACL_ENTRY_TYPE_DENY
expr_stmt|;
if|if
condition|(
name|acesizep
condition|)
operator|*
name|acesizep
operator|=
literal|4
operator|*
name|NFSX_UNSIGNED
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|len
operator|>
name|NFSV4_SMALLSTR
condition|)
name|name
operator|=
name|malloc
argument_list|(
name|len
operator|+
literal|1
argument_list|,
name|M_NFSSTRING
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
else|else
name|name
operator|=
name|namestr
expr_stmt|;
name|error
operator|=
name|nfsrv_mtostr
argument_list|(
name|nd
argument_list|,
name|name
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
if|if
condition|(
name|len
operator|>
name|NFSV4_SMALLSTR
condition|)
name|free
argument_list|(
name|name
argument_list|,
name|M_NFSSTRING
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
if|if
condition|(
name|len
operator|==
literal|6
condition|)
block|{
if|if
condition|(
operator|!
name|NFSBCMP
argument_list|(
name|name
argument_list|,
literal|"OWNER@"
argument_list|,
literal|6
argument_list|)
condition|)
block|{
name|acep
operator|->
name|ae_tag
operator|=
name|ACL_USER_OBJ
expr_stmt|;
name|acep
operator|->
name|ae_id
operator|=
name|ACL_UNDEFINED_ID
expr_stmt|;
name|owner
operator|=
literal|1
expr_stmt|;
name|gotid
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|NFSBCMP
argument_list|(
name|name
argument_list|,
literal|"GROUP@"
argument_list|,
literal|6
argument_list|)
condition|)
block|{
name|acep
operator|->
name|ae_tag
operator|=
name|ACL_GROUP_OBJ
expr_stmt|;
name|acep
operator|->
name|ae_id
operator|=
name|ACL_UNDEFINED_ID
expr_stmt|;
name|gotid
operator|=
literal|1
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|len
operator|==
literal|9
operator|&&
operator|!
name|NFSBCMP
argument_list|(
name|name
argument_list|,
literal|"EVERYONE@"
argument_list|,
literal|9
argument_list|)
condition|)
block|{
name|acep
operator|->
name|ae_tag
operator|=
name|ACL_EVERYONE
expr_stmt|;
name|acep
operator|->
name|ae_id
operator|=
name|ACL_UNDEFINED_ID
expr_stmt|;
name|gotid
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|gotid
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|flag
operator|&
name|NFSV4ACE_IDENTIFIERGROUP
condition|)
block|{
name|acep
operator|->
name|ae_tag
operator|=
name|ACL_GROUP
expr_stmt|;
name|aceerr
operator|=
name|nfsv4_strtogid
argument_list|(
name|name
argument_list|,
name|len
argument_list|,
operator|&
name|gid
argument_list|,
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|aceerr
operator|==
literal|0
condition|)
name|acep
operator|->
name|ae_id
operator|=
operator|(
name|uid_t
operator|)
name|gid
expr_stmt|;
block|}
else|else
block|{
name|acep
operator|->
name|ae_tag
operator|=
name|ACL_USER
expr_stmt|;
name|aceerr
operator|=
name|nfsv4_strtouid
argument_list|(
name|name
argument_list|,
name|len
argument_list|,
operator|&
name|uid
argument_list|,
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|aceerr
operator|==
literal|0
condition|)
name|acep
operator|->
name|ae_id
operator|=
name|uid
expr_stmt|;
block|}
block|}
if|if
condition|(
name|len
operator|>
name|NFSV4_SMALLSTR
condition|)
name|free
argument_list|(
name|name
argument_list|,
name|M_NFSSTRING
argument_list|)
expr_stmt|;
if|if
condition|(
name|aceerr
operator|==
literal|0
condition|)
block|{
comment|/* 		 * Handle the flags. 		 */
name|flag
operator|&=
operator|~
name|NFSV4ACE_IDENTIFIERGROUP
expr_stmt|;
if|if
condition|(
name|flag
operator|&
name|NFSV4ACE_FILEINHERIT
condition|)
block|{
name|flag
operator|&=
operator|~
name|NFSV4ACE_FILEINHERIT
expr_stmt|;
name|acep
operator|->
name|ae_flags
operator||=
name|ACL_ENTRY_FILE_INHERIT
expr_stmt|;
block|}
if|if
condition|(
name|flag
operator|&
name|NFSV4ACE_DIRECTORYINHERIT
condition|)
block|{
name|flag
operator|&=
operator|~
name|NFSV4ACE_DIRECTORYINHERIT
expr_stmt|;
name|acep
operator|->
name|ae_flags
operator||=
name|ACL_ENTRY_DIRECTORY_INHERIT
expr_stmt|;
block|}
if|if
condition|(
name|flag
operator|&
name|NFSV4ACE_NOPROPAGATEINHERIT
condition|)
block|{
name|flag
operator|&=
operator|~
name|NFSV4ACE_NOPROPAGATEINHERIT
expr_stmt|;
name|acep
operator|->
name|ae_flags
operator||=
name|ACL_ENTRY_NO_PROPAGATE_INHERIT
expr_stmt|;
block|}
if|if
condition|(
name|flag
operator|&
name|NFSV4ACE_INHERITONLY
condition|)
block|{
name|flag
operator|&=
operator|~
name|NFSV4ACE_INHERITONLY
expr_stmt|;
name|acep
operator|->
name|ae_flags
operator||=
name|ACL_ENTRY_INHERIT_ONLY
expr_stmt|;
block|}
if|if
condition|(
name|flag
operator|&
name|NFSV4ACE_SUCCESSFULACCESS
condition|)
block|{
name|flag
operator|&=
operator|~
name|NFSV4ACE_SUCCESSFULACCESS
expr_stmt|;
name|acep
operator|->
name|ae_flags
operator||=
name|ACL_ENTRY_SUCCESSFUL_ACCESS
expr_stmt|;
block|}
if|if
condition|(
name|flag
operator|&
name|NFSV4ACE_FAILEDACCESS
condition|)
block|{
name|flag
operator|&=
operator|~
name|NFSV4ACE_FAILEDACCESS
expr_stmt|;
name|acep
operator|->
name|ae_flags
operator||=
name|ACL_ENTRY_FAILED_ACCESS
expr_stmt|;
block|}
comment|/* 		 * Set ae_entry_type. 		 */
if|if
condition|(
name|acetype
operator|==
name|NFSV4ACE_ALLOWEDTYPE
condition|)
name|acep
operator|->
name|ae_entry_type
operator|=
name|ACL_ENTRY_TYPE_ALLOW
expr_stmt|;
elseif|else
if|if
condition|(
name|acetype
operator|==
name|NFSV4ACE_DENIEDTYPE
condition|)
name|acep
operator|->
name|ae_entry_type
operator|=
name|ACL_ENTRY_TYPE_DENY
expr_stmt|;
elseif|else
if|if
condition|(
name|acetype
operator|==
name|NFSV4ACE_AUDITTYPE
condition|)
name|acep
operator|->
name|ae_entry_type
operator|=
name|ACL_ENTRY_TYPE_AUDIT
expr_stmt|;
elseif|else
if|if
condition|(
name|acetype
operator|==
name|NFSV4ACE_ALARMTYPE
condition|)
name|acep
operator|->
name|ae_entry_type
operator|=
name|ACL_ENTRY_TYPE_ALARM
expr_stmt|;
else|else
name|aceerr
operator|=
name|NFSERR_ATTRNOTSUPP
expr_stmt|;
block|}
comment|/* 	 * Now, check for unsupported flag bits. 	 */
if|if
condition|(
name|aceerr
operator|==
literal|0
operator|&&
name|flag
operator|!=
literal|0
condition|)
name|aceerr
operator|=
name|NFSERR_ATTRNOTSUPP
expr_stmt|;
comment|/* 	 * And turn the mask into perm bits. 	 */
if|if
condition|(
name|aceerr
operator|==
literal|0
condition|)
name|aceerr
operator|=
name|nfsrv_acemasktoperm
argument_list|(
name|acetype
argument_list|,
name|mask
argument_list|,
name|owner
argument_list|,
name|VREG
argument_list|,
operator|&
name|acep
operator|->
name|ae_perm
argument_list|)
expr_stmt|;
operator|*
name|aceerrp
operator|=
name|aceerr
expr_stmt|;
if|if
condition|(
name|acesizep
condition|)
operator|*
name|acesizep
operator|=
name|NFSM_RNDUP
argument_list|(
name|len
argument_list|)
operator|+
operator|(
literal|4
operator|*
name|NFSX_UNSIGNED
operator|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|nfsmout
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Turn an NFSv4 ace mask into R/W/X flag bits.  */
end_comment

begin_function
specifier|static
name|int
name|nfsrv_acemasktoperm
parameter_list|(
name|u_int32_t
name|acetype
parameter_list|,
name|u_int32_t
name|mask
parameter_list|,
name|int
name|owner
parameter_list|,
name|enum
name|vtype
name|type
parameter_list|,
name|acl_perm_t
modifier|*
name|permp
parameter_list|)
block|{
name|acl_perm_t
name|perm
init|=
literal|0x0
decl_stmt|;
if|if
condition|(
name|mask
operator|&
name|NFSV4ACE_READDATA
condition|)
block|{
name|mask
operator|&=
operator|~
name|NFSV4ACE_READDATA
expr_stmt|;
name|perm
operator||=
name|ACL_READ_DATA
expr_stmt|;
block|}
if|if
condition|(
name|mask
operator|&
name|NFSV4ACE_LISTDIRECTORY
condition|)
block|{
name|mask
operator|&=
operator|~
name|NFSV4ACE_LISTDIRECTORY
expr_stmt|;
name|perm
operator||=
name|ACL_LIST_DIRECTORY
expr_stmt|;
block|}
if|if
condition|(
name|mask
operator|&
name|NFSV4ACE_WRITEDATA
condition|)
block|{
name|mask
operator|&=
operator|~
name|NFSV4ACE_WRITEDATA
expr_stmt|;
name|perm
operator||=
name|ACL_WRITE_DATA
expr_stmt|;
block|}
if|if
condition|(
name|mask
operator|&
name|NFSV4ACE_ADDFILE
condition|)
block|{
name|mask
operator|&=
operator|~
name|NFSV4ACE_ADDFILE
expr_stmt|;
name|perm
operator||=
name|ACL_ADD_FILE
expr_stmt|;
block|}
if|if
condition|(
name|mask
operator|&
name|NFSV4ACE_APPENDDATA
condition|)
block|{
name|mask
operator|&=
operator|~
name|NFSV4ACE_APPENDDATA
expr_stmt|;
name|perm
operator||=
name|ACL_APPEND_DATA
expr_stmt|;
block|}
if|if
condition|(
name|mask
operator|&
name|NFSV4ACE_ADDSUBDIRECTORY
condition|)
block|{
name|mask
operator|&=
operator|~
name|NFSV4ACE_ADDSUBDIRECTORY
expr_stmt|;
name|perm
operator||=
name|ACL_ADD_SUBDIRECTORY
expr_stmt|;
block|}
if|if
condition|(
name|mask
operator|&
name|NFSV4ACE_READNAMEDATTR
condition|)
block|{
name|mask
operator|&=
operator|~
name|NFSV4ACE_READNAMEDATTR
expr_stmt|;
name|perm
operator||=
name|ACL_READ_NAMED_ATTRS
expr_stmt|;
block|}
if|if
condition|(
name|mask
operator|&
name|NFSV4ACE_WRITENAMEDATTR
condition|)
block|{
name|mask
operator|&=
operator|~
name|NFSV4ACE_WRITENAMEDATTR
expr_stmt|;
name|perm
operator||=
name|ACL_WRITE_NAMED_ATTRS
expr_stmt|;
block|}
if|if
condition|(
name|mask
operator|&
name|NFSV4ACE_EXECUTE
condition|)
block|{
name|mask
operator|&=
operator|~
name|NFSV4ACE_EXECUTE
expr_stmt|;
name|perm
operator||=
name|ACL_EXECUTE
expr_stmt|;
block|}
if|if
condition|(
name|mask
operator|&
name|NFSV4ACE_SEARCH
condition|)
block|{
name|mask
operator|&=
operator|~
name|NFSV4ACE_SEARCH
expr_stmt|;
name|perm
operator||=
name|ACL_EXECUTE
expr_stmt|;
block|}
if|if
condition|(
name|mask
operator|&
name|NFSV4ACE_DELETECHILD
condition|)
block|{
name|mask
operator|&=
operator|~
name|NFSV4ACE_DELETECHILD
expr_stmt|;
name|perm
operator||=
name|ACL_DELETE_CHILD
expr_stmt|;
block|}
if|if
condition|(
name|mask
operator|&
name|NFSV4ACE_READATTRIBUTES
condition|)
block|{
name|mask
operator|&=
operator|~
name|NFSV4ACE_READATTRIBUTES
expr_stmt|;
name|perm
operator||=
name|ACL_READ_ATTRIBUTES
expr_stmt|;
block|}
if|if
condition|(
name|mask
operator|&
name|NFSV4ACE_WRITEATTRIBUTES
condition|)
block|{
name|mask
operator|&=
operator|~
name|NFSV4ACE_WRITEATTRIBUTES
expr_stmt|;
name|perm
operator||=
name|ACL_WRITE_ATTRIBUTES
expr_stmt|;
block|}
if|if
condition|(
name|mask
operator|&
name|NFSV4ACE_DELETE
condition|)
block|{
name|mask
operator|&=
operator|~
name|NFSV4ACE_DELETE
expr_stmt|;
name|perm
operator||=
name|ACL_DELETE
expr_stmt|;
block|}
if|if
condition|(
name|mask
operator|&
name|NFSV4ACE_READACL
condition|)
block|{
name|mask
operator|&=
operator|~
name|NFSV4ACE_READACL
expr_stmt|;
name|perm
operator||=
name|ACL_READ_ACL
expr_stmt|;
block|}
if|if
condition|(
name|mask
operator|&
name|NFSV4ACE_WRITEACL
condition|)
block|{
name|mask
operator|&=
operator|~
name|NFSV4ACE_WRITEACL
expr_stmt|;
name|perm
operator||=
name|ACL_WRITE_ACL
expr_stmt|;
block|}
if|if
condition|(
name|mask
operator|&
name|NFSV4ACE_WRITEOWNER
condition|)
block|{
name|mask
operator|&=
operator|~
name|NFSV4ACE_WRITEOWNER
expr_stmt|;
name|perm
operator||=
name|ACL_WRITE_OWNER
expr_stmt|;
block|}
if|if
condition|(
name|mask
operator|&
name|NFSV4ACE_SYNCHRONIZE
condition|)
block|{
name|mask
operator|&=
operator|~
name|NFSV4ACE_SYNCHRONIZE
expr_stmt|;
name|perm
operator||=
name|ACL_SYNCHRONIZE
expr_stmt|;
block|}
if|if
condition|(
name|mask
operator|!=
literal|0
condition|)
return|return
operator|(
name|NFSERR_ATTRNOTSUPP
operator|)
return|;
operator|*
name|permp
operator|=
name|perm
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* local functions */
end_comment

begin_function_decl
specifier|static
name|int
name|nfsrv_buildace
parameter_list|(
name|struct
name|nfsrv_descript
modifier|*
parameter_list|,
name|u_char
modifier|*
parameter_list|,
name|int
parameter_list|,
name|enum
name|vtype
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|,
name|struct
name|acl_entry
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * This function builds an NFS ace.  */
end_comment

begin_function
specifier|static
name|int
name|nfsrv_buildace
parameter_list|(
name|struct
name|nfsrv_descript
modifier|*
name|nd
parameter_list|,
name|u_char
modifier|*
name|name
parameter_list|,
name|int
name|namelen
parameter_list|,
name|enum
name|vtype
name|type
parameter_list|,
name|int
name|group
parameter_list|,
name|int
name|owner
parameter_list|,
name|struct
name|acl_entry
modifier|*
name|ace
parameter_list|)
block|{
name|u_int32_t
modifier|*
name|tl
decl_stmt|,
name|aceflag
init|=
literal|0x0
decl_stmt|,
name|acemask
init|=
literal|0x0
decl_stmt|,
name|acetype
decl_stmt|;
name|int
name|full_len
decl_stmt|;
name|full_len
operator|=
name|NFSM_RNDUP
argument_list|(
name|namelen
argument_list|)
expr_stmt|;
name|NFSM_BUILD
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
literal|4
operator|*
name|NFSX_UNSIGNED
operator|+
name|full_len
argument_list|)
expr_stmt|;
comment|/* 	 * Fill in the ace type. 	 */
if|if
condition|(
name|ace
operator|->
name|ae_entry_type
operator|&
name|ACL_ENTRY_TYPE_ALLOW
condition|)
name|acetype
operator|=
name|NFSV4ACE_ALLOWEDTYPE
expr_stmt|;
elseif|else
if|if
condition|(
name|ace
operator|->
name|ae_entry_type
operator|&
name|ACL_ENTRY_TYPE_DENY
condition|)
name|acetype
operator|=
name|NFSV4ACE_DENIEDTYPE
expr_stmt|;
elseif|else
if|if
condition|(
name|ace
operator|->
name|ae_entry_type
operator|&
name|ACL_ENTRY_TYPE_AUDIT
condition|)
name|acetype
operator|=
name|NFSV4ACE_AUDITTYPE
expr_stmt|;
else|else
name|acetype
operator|=
name|NFSV4ACE_ALARMTYPE
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
name|txdr_unsigned
argument_list|(
name|acetype
argument_list|)
expr_stmt|;
comment|/* 	 * Set the flag bits from the ACL. 	 */
if|if
condition|(
name|ace
operator|->
name|ae_flags
operator|&
name|ACL_ENTRY_FILE_INHERIT
condition|)
name|aceflag
operator||=
name|NFSV4ACE_FILEINHERIT
expr_stmt|;
if|if
condition|(
name|ace
operator|->
name|ae_flags
operator|&
name|ACL_ENTRY_DIRECTORY_INHERIT
condition|)
name|aceflag
operator||=
name|NFSV4ACE_DIRECTORYINHERIT
expr_stmt|;
if|if
condition|(
name|ace
operator|->
name|ae_flags
operator|&
name|ACL_ENTRY_NO_PROPAGATE_INHERIT
condition|)
name|aceflag
operator||=
name|NFSV4ACE_NOPROPAGATEINHERIT
expr_stmt|;
if|if
condition|(
name|ace
operator|->
name|ae_flags
operator|&
name|ACL_ENTRY_INHERIT_ONLY
condition|)
name|aceflag
operator||=
name|NFSV4ACE_INHERITONLY
expr_stmt|;
if|if
condition|(
name|ace
operator|->
name|ae_flags
operator|&
name|ACL_ENTRY_SUCCESSFUL_ACCESS
condition|)
name|aceflag
operator||=
name|NFSV4ACE_SUCCESSFULACCESS
expr_stmt|;
if|if
condition|(
name|ace
operator|->
name|ae_flags
operator|&
name|ACL_ENTRY_FAILED_ACCESS
condition|)
name|aceflag
operator||=
name|NFSV4ACE_FAILEDACCESS
expr_stmt|;
if|if
condition|(
name|group
condition|)
name|aceflag
operator||=
name|NFSV4ACE_IDENTIFIERGROUP
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
name|txdr_unsigned
argument_list|(
name|aceflag
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|VDIR
condition|)
block|{
if|if
condition|(
name|ace
operator|->
name|ae_perm
operator|&
name|ACL_LIST_DIRECTORY
condition|)
name|acemask
operator||=
name|NFSV4ACE_LISTDIRECTORY
expr_stmt|;
if|if
condition|(
name|ace
operator|->
name|ae_perm
operator|&
name|ACL_ADD_FILE
condition|)
name|acemask
operator||=
name|NFSV4ACE_ADDFILE
expr_stmt|;
if|if
condition|(
name|ace
operator|->
name|ae_perm
operator|&
name|ACL_ADD_SUBDIRECTORY
condition|)
name|acemask
operator||=
name|NFSV4ACE_ADDSUBDIRECTORY
expr_stmt|;
if|if
condition|(
name|ace
operator|->
name|ae_perm
operator|&
name|ACL_READ_NAMED_ATTRS
condition|)
name|acemask
operator||=
name|NFSV4ACE_READNAMEDATTR
expr_stmt|;
if|if
condition|(
name|ace
operator|->
name|ae_perm
operator|&
name|ACL_WRITE_NAMED_ATTRS
condition|)
name|acemask
operator||=
name|NFSV4ACE_WRITENAMEDATTR
expr_stmt|;
if|if
condition|(
name|ace
operator|->
name|ae_perm
operator|&
name|ACL_EXECUTE
condition|)
name|acemask
operator||=
name|NFSV4ACE_SEARCH
expr_stmt|;
if|if
condition|(
name|ace
operator|->
name|ae_perm
operator|&
name|ACL_DELETE_CHILD
condition|)
name|acemask
operator||=
name|NFSV4ACE_DELETECHILD
expr_stmt|;
if|if
condition|(
name|ace
operator|->
name|ae_perm
operator|&
name|ACL_READ_ATTRIBUTES
condition|)
name|acemask
operator||=
name|NFSV4ACE_READATTRIBUTES
expr_stmt|;
if|if
condition|(
name|ace
operator|->
name|ae_perm
operator|&
name|ACL_WRITE_ATTRIBUTES
condition|)
name|acemask
operator||=
name|NFSV4ACE_WRITEATTRIBUTES
expr_stmt|;
if|if
condition|(
name|ace
operator|->
name|ae_perm
operator|&
name|ACL_DELETE
condition|)
name|acemask
operator||=
name|NFSV4ACE_DELETE
expr_stmt|;
if|if
condition|(
name|ace
operator|->
name|ae_perm
operator|&
name|ACL_READ_ACL
condition|)
name|acemask
operator||=
name|NFSV4ACE_READACL
expr_stmt|;
if|if
condition|(
name|ace
operator|->
name|ae_perm
operator|&
name|ACL_WRITE_ACL
condition|)
name|acemask
operator||=
name|NFSV4ACE_WRITEACL
expr_stmt|;
if|if
condition|(
name|ace
operator|->
name|ae_perm
operator|&
name|ACL_WRITE_OWNER
condition|)
name|acemask
operator||=
name|NFSV4ACE_WRITEOWNER
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|ace
operator|->
name|ae_perm
operator|&
name|ACL_READ_DATA
condition|)
name|acemask
operator||=
name|NFSV4ACE_READDATA
expr_stmt|;
if|if
condition|(
name|ace
operator|->
name|ae_perm
operator|&
name|ACL_WRITE_DATA
condition|)
name|acemask
operator||=
name|NFSV4ACE_WRITEDATA
expr_stmt|;
if|if
condition|(
name|ace
operator|->
name|ae_perm
operator|&
name|ACL_APPEND_DATA
condition|)
name|acemask
operator||=
name|NFSV4ACE_APPENDDATA
expr_stmt|;
if|if
condition|(
name|ace
operator|->
name|ae_perm
operator|&
name|ACL_READ_NAMED_ATTRS
condition|)
name|acemask
operator||=
name|NFSV4ACE_READNAMEDATTR
expr_stmt|;
if|if
condition|(
name|ace
operator|->
name|ae_perm
operator|&
name|ACL_WRITE_NAMED_ATTRS
condition|)
name|acemask
operator||=
name|NFSV4ACE_WRITENAMEDATTR
expr_stmt|;
if|if
condition|(
name|ace
operator|->
name|ae_perm
operator|&
name|ACL_EXECUTE
condition|)
name|acemask
operator||=
name|NFSV4ACE_EXECUTE
expr_stmt|;
if|if
condition|(
name|ace
operator|->
name|ae_perm
operator|&
name|ACL_READ_ATTRIBUTES
condition|)
name|acemask
operator||=
name|NFSV4ACE_READATTRIBUTES
expr_stmt|;
if|if
condition|(
name|ace
operator|->
name|ae_perm
operator|&
name|ACL_WRITE_ATTRIBUTES
condition|)
name|acemask
operator||=
name|NFSV4ACE_WRITEATTRIBUTES
expr_stmt|;
if|if
condition|(
name|ace
operator|->
name|ae_perm
operator|&
name|ACL_DELETE
condition|)
name|acemask
operator||=
name|NFSV4ACE_DELETE
expr_stmt|;
if|if
condition|(
name|ace
operator|->
name|ae_perm
operator|&
name|ACL_READ_ACL
condition|)
name|acemask
operator||=
name|NFSV4ACE_READACL
expr_stmt|;
if|if
condition|(
name|ace
operator|->
name|ae_perm
operator|&
name|ACL_WRITE_ACL
condition|)
name|acemask
operator||=
name|NFSV4ACE_WRITEACL
expr_stmt|;
if|if
condition|(
name|ace
operator|->
name|ae_perm
operator|&
name|ACL_WRITE_OWNER
condition|)
name|acemask
operator||=
name|NFSV4ACE_WRITEOWNER
expr_stmt|;
if|if
condition|(
name|ace
operator|->
name|ae_perm
operator|&
name|ACL_SYNCHRONIZE
condition|)
name|acemask
operator||=
name|NFSV4ACE_SYNCHRONIZE
expr_stmt|;
block|}
operator|*
name|tl
operator|++
operator|=
name|txdr_unsigned
argument_list|(
name|acemask
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
name|txdr_unsigned
argument_list|(
name|namelen
argument_list|)
expr_stmt|;
if|if
condition|(
name|full_len
operator|-
name|namelen
condition|)
operator|*
operator|(
name|tl
operator|+
operator|(
name|namelen
operator|/
name|NFSX_UNSIGNED
operator|)
operator|)
operator|=
literal|0x0
expr_stmt|;
name|NFSBCOPY
argument_list|(
name|name
argument_list|,
operator|(
name|caddr_t
operator|)
name|tl
argument_list|,
name|namelen
argument_list|)
expr_stmt|;
return|return
operator|(
name|full_len
operator|+
literal|4
operator|*
name|NFSX_UNSIGNED
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Build an NFSv4 ACL.  */
end_comment

begin_function
name|APPLESTATIC
name|int
name|nfsrv_buildacl
parameter_list|(
name|struct
name|nfsrv_descript
modifier|*
name|nd
parameter_list|,
name|NFSACL_T
modifier|*
name|aclp
parameter_list|,
name|enum
name|vtype
name|type
parameter_list|,
name|NFSPROC_T
modifier|*
name|p
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|entrycnt
init|=
literal|0
decl_stmt|,
name|retlen
decl_stmt|;
name|u_int32_t
modifier|*
name|entrycntp
decl_stmt|;
name|int
name|isowner
decl_stmt|,
name|isgroup
decl_stmt|,
name|namelen
decl_stmt|,
name|malloced
decl_stmt|;
name|u_char
modifier|*
name|name
decl_stmt|,
name|namestr
index|[
name|NFSV4_SMALLSTR
index|]
decl_stmt|;
name|NFSM_BUILD
argument_list|(
name|entrycntp
argument_list|,
name|u_int32_t
operator|*
argument_list|,
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|retlen
operator|=
name|NFSX_UNSIGNED
expr_stmt|;
comment|/* 	 * Loop through the acl entries, building each one. 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|aclp
operator|->
name|acl_cnt
condition|;
name|i
operator|++
control|)
block|{
name|isowner
operator|=
name|isgroup
operator|=
name|malloced
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|aclp
operator|->
name|acl_entry
index|[
name|i
index|]
operator|.
name|ae_tag
condition|)
block|{
case|case
name|ACL_USER_OBJ
case|:
name|isowner
operator|=
literal|1
expr_stmt|;
name|name
operator|=
literal|"OWNER@"
expr_stmt|;
name|namelen
operator|=
literal|6
expr_stmt|;
break|break;
case|case
name|ACL_GROUP_OBJ
case|:
name|isgroup
operator|=
literal|1
expr_stmt|;
name|name
operator|=
literal|"GROUP@"
expr_stmt|;
name|namelen
operator|=
literal|6
expr_stmt|;
break|break;
case|case
name|ACL_EVERYONE
case|:
name|name
operator|=
literal|"EVERYONE@"
expr_stmt|;
name|namelen
operator|=
literal|9
expr_stmt|;
break|break;
case|case
name|ACL_USER
case|:
name|name
operator|=
name|namestr
expr_stmt|;
name|nfsv4_uidtostr
argument_list|(
name|aclp
operator|->
name|acl_entry
index|[
name|i
index|]
operator|.
name|ae_id
argument_list|,
operator|&
name|name
argument_list|,
operator|&
name|namelen
argument_list|,
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|name
operator|!=
name|namestr
condition|)
name|malloced
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|ACL_GROUP
case|:
name|isgroup
operator|=
literal|1
expr_stmt|;
name|name
operator|=
name|namestr
expr_stmt|;
name|nfsv4_gidtostr
argument_list|(
operator|(
name|gid_t
operator|)
name|aclp
operator|->
name|acl_entry
index|[
name|i
index|]
operator|.
name|ae_id
argument_list|,
operator|&
name|name
argument_list|,
operator|&
name|namelen
argument_list|,
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|name
operator|!=
name|namestr
condition|)
name|malloced
operator|=
literal|1
expr_stmt|;
break|break;
default|default:
continue|continue;
block|}
empty_stmt|;
name|retlen
operator|+=
name|nfsrv_buildace
argument_list|(
name|nd
argument_list|,
name|name
argument_list|,
name|namelen
argument_list|,
name|type
argument_list|,
name|isgroup
argument_list|,
name|isowner
argument_list|,
operator|&
name|aclp
operator|->
name|acl_entry
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|entrycnt
operator|++
expr_stmt|;
if|if
condition|(
name|malloced
condition|)
name|free
argument_list|(
name|name
argument_list|,
name|M_NFSSTRING
argument_list|)
expr_stmt|;
block|}
operator|*
name|entrycntp
operator|=
name|txdr_unsigned
argument_list|(
name|entrycnt
argument_list|)
expr_stmt|;
return|return
operator|(
name|retlen
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Set an NFSv4 acl.  */
end_comment

begin_function
name|APPLESTATIC
name|int
name|nfsrv_setacl
parameter_list|(
name|vnode_t
name|vp
parameter_list|,
name|NFSACL_T
modifier|*
name|aclp
parameter_list|,
name|struct
name|ucred
modifier|*
name|cred
parameter_list|,
name|NFSPROC_T
modifier|*
name|p
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
if|if
condition|(
name|nfsrv_useacl
operator|==
literal|0
operator|||
operator|!
name|NFSHASNFS4ACL
argument_list|(
name|vnode_mount
argument_list|(
name|vp
argument_list|)
argument_list|)
condition|)
return|return
operator|(
name|NFSERR_ATTRNOTSUPP
operator|)
return|;
comment|/* 	 * With NFSv4 ACLs, chmod(2) may need to add additional entries. 	 * Make sure it has enough room for that - splitting every entry 	 * into two and appending "canonical six" entries at the end. 	 * Cribbed out of kern/vfs_acl.c - Rick M. 	 */
if|if
condition|(
name|aclp
operator|->
name|acl_cnt
operator|>
operator|(
name|ACL_MAX_ENTRIES
operator|-
literal|6
operator|)
operator|/
literal|2
condition|)
return|return
operator|(
name|NFSERR_ATTRNOTSUPP
operator|)
return|;
name|error
operator|=
name|VOP_ACLCHECK
argument_list|(
name|vp
argument_list|,
name|ACL_TYPE_NFS4
argument_list|,
name|aclp
argument_list|,
name|cred
argument_list|,
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
name|error
operator|=
name|VOP_SETACL
argument_list|(
name|vp
argument_list|,
name|ACL_TYPE_NFS4
argument_list|,
name|aclp
argument_list|,
name|cred
argument_list|,
name|p
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Compare two NFSv4 acls.  * Return 0 if they are the same, 1 if not the same.  */
end_comment

begin_function
name|APPLESTATIC
name|int
name|nfsrv_compareacl
parameter_list|(
name|NFSACL_T
modifier|*
name|aclp1
parameter_list|,
name|NFSACL_T
modifier|*
name|aclp2
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|struct
name|acl_entry
modifier|*
name|acep1
decl_stmt|,
modifier|*
name|acep2
decl_stmt|;
if|if
condition|(
name|aclp1
operator|->
name|acl_cnt
operator|!=
name|aclp2
operator|->
name|acl_cnt
condition|)
return|return
operator|(
literal|1
operator|)
return|;
name|acep1
operator|=
name|aclp1
operator|->
name|acl_entry
expr_stmt|;
name|acep2
operator|=
name|aclp2
operator|->
name|acl_entry
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|aclp1
operator|->
name|acl_cnt
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|acep1
operator|->
name|ae_tag
operator|!=
name|acep2
operator|->
name|ae_tag
condition|)
return|return
operator|(
literal|1
operator|)
return|;
switch|switch
condition|(
name|acep1
operator|->
name|ae_tag
condition|)
block|{
case|case
name|ACL_GROUP
case|:
case|case
name|ACL_USER
case|:
if|if
condition|(
name|acep1
operator|->
name|ae_id
operator|!=
name|acep2
operator|->
name|ae_id
condition|)
return|return
operator|(
literal|1
operator|)
return|;
comment|/* fall through */
case|case
name|ACL_USER_OBJ
case|:
case|case
name|ACL_GROUP_OBJ
case|:
case|case
name|ACL_OTHER
case|:
if|if
condition|(
name|acep1
operator|->
name|ae_perm
operator|!=
name|acep2
operator|->
name|ae_perm
condition|)
return|return
operator|(
literal|1
operator|)
return|;
block|}
empty_stmt|;
name|acep1
operator|++
expr_stmt|;
name|acep2
operator|++
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2010-2012 Semihalf.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/mount.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<sys/buf.h>
end_include

begin_include
include|#
directive|include
file|<sys/namei.h>
end_include

begin_include
include|#
directive|include
file|<sys/vnode.h>
end_include

begin_include
include|#
directive|include
file|<sys/bio.h>
end_include

begin_include
include|#
directive|include
file|<fs/nandfs/nandfs_mount.h>
end_include

begin_include
include|#
directive|include
file|<fs/nandfs/nandfs.h>
end_include

begin_include
include|#
directive|include
file|<fs/nandfs/nandfs_subr.h>
end_include

begin_define
define|#
directive|define
name|NANDFS_CLEANER_KILL
value|1
end_define

begin_function_decl
specifier|static
name|void
name|nandfs_cleaner
parameter_list|(
name|struct
name|nandfs_device
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nandfs_cleaner_clean_segments
parameter_list|(
name|struct
name|nandfs_device
modifier|*
parameter_list|,
name|struct
name|nandfs_vinfo
modifier|*
parameter_list|,
name|uint32_t
parameter_list|,
name|struct
name|nandfs_period
modifier|*
parameter_list|,
name|uint32_t
parameter_list|,
name|struct
name|nandfs_bdesc
modifier|*
parameter_list|,
name|uint32_t
parameter_list|,
name|uint64_t
modifier|*
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nandfs_process_bdesc
parameter_list|(
name|struct
name|nandfs_device
modifier|*
name|nffsdev
parameter_list|,
name|struct
name|nandfs_bdesc
modifier|*
name|bd
parameter_list|,
name|uint64_t
name|nmembs
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|void
name|nandfs_wakeup_wait_cleaner
parameter_list|(
name|struct
name|nandfs_device
modifier|*
name|fsdev
parameter_list|,
name|int
name|reason
parameter_list|)
block|{
name|mtx_lock
argument_list|(
operator|&
name|fsdev
operator|->
name|nd_clean_mtx
argument_list|)
expr_stmt|;
if|if
condition|(
name|reason
operator|==
name|NANDFS_CLEANER_KILL
condition|)
name|fsdev
operator|->
name|nd_cleaner_exit
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|fsdev
operator|->
name|nd_cleaning
operator|==
literal|0
condition|)
block|{
name|fsdev
operator|->
name|nd_cleaning
operator|=
literal|1
expr_stmt|;
name|wakeup
argument_list|(
operator|&
name|fsdev
operator|->
name|nd_cleaning
argument_list|)
expr_stmt|;
block|}
name|cv_wait
argument_list|(
operator|&
name|fsdev
operator|->
name|nd_clean_cv
argument_list|,
operator|&
name|fsdev
operator|->
name|nd_clean_mtx
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|fsdev
operator|->
name|nd_clean_mtx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|nandfs_start_cleaner
parameter_list|(
name|struct
name|nandfs_device
modifier|*
name|fsdev
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
name|MPASS
argument_list|(
name|fsdev
operator|->
name|nd_cleaner
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|fsdev
operator|->
name|nd_cleaner_exit
operator|=
literal|0
expr_stmt|;
name|error
operator|=
name|kthread_add
argument_list|(
operator|(
name|void
argument_list|(
operator|*
argument_list|)
argument_list|(
name|void
operator|*
argument_list|)
operator|)
name|nandfs_cleaner
argument_list|,
name|fsdev
argument_list|,
name|NULL
argument_list|,
operator|&
name|fsdev
operator|->
name|nd_cleaner
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|"nandfs_cleaner"
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
name|printf
argument_list|(
literal|"nandfs: could not start cleaner: %d\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
name|int
name|nandfs_stop_cleaner
parameter_list|(
name|struct
name|nandfs_device
modifier|*
name|fsdev
parameter_list|)
block|{
name|MPASS
argument_list|(
name|fsdev
operator|->
name|nd_cleaner
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|nandfs_wakeup_wait_cleaner
argument_list|(
name|fsdev
argument_list|,
name|NANDFS_CLEANER_KILL
argument_list|)
expr_stmt|;
name|fsdev
operator|->
name|nd_cleaner
operator|=
name|NULL
expr_stmt|;
name|DPRINTF
argument_list|(
name|CLEAN
argument_list|,
operator|(
literal|"cleaner stopped\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nandfs_cleaner_finished
parameter_list|(
name|struct
name|nandfs_device
modifier|*
name|fsdev
parameter_list|)
block|{
name|int
name|exit
decl_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|fsdev
operator|->
name|nd_clean_mtx
argument_list|)
expr_stmt|;
name|fsdev
operator|->
name|nd_cleaning
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|fsdev
operator|->
name|nd_cleaner_exit
condition|)
block|{
name|DPRINTF
argument_list|(
name|CLEAN
argument_list|,
operator|(
literal|"%s: sleep\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
name|msleep
argument_list|(
operator|&
name|fsdev
operator|->
name|nd_cleaning
argument_list|,
operator|&
name|fsdev
operator|->
name|nd_clean_mtx
argument_list|,
name|PRIBIO
argument_list|,
literal|"-"
argument_list|,
name|hz
operator|*
name|nandfs_cleaner_interval
argument_list|)
expr_stmt|;
block|}
name|exit
operator|=
name|fsdev
operator|->
name|nd_cleaner_exit
expr_stmt|;
name|cv_broadcast
argument_list|(
operator|&
name|fsdev
operator|->
name|nd_clean_cv
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|fsdev
operator|->
name|nd_clean_mtx
argument_list|)
expr_stmt|;
if|if
condition|(
name|exit
condition|)
block|{
name|DPRINTF
argument_list|(
name|CLEAN
argument_list|,
operator|(
literal|"%s: no longer active\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_suinfo
parameter_list|(
name|struct
name|nandfs_suinfo
modifier|*
name|suinfo
parameter_list|,
name|int
name|nsegs
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nsegs
condition|;
name|i
operator|++
control|)
block|{
name|DPRINTF
argument_list|(
name|CLEAN
argument_list|,
operator|(
literal|"%jx  %jd  %c%c%c  %10u\n"
operator|,
name|suinfo
index|[
name|i
index|]
operator|.
name|nsi_num
operator|,
name|suinfo
index|[
name|i
index|]
operator|.
name|nsi_lastmod
operator|,
operator|(
name|suinfo
index|[
name|i
index|]
operator|.
name|nsi_flags
operator|&
operator|(
name|NANDFS_SEGMENT_USAGE_ACTIVE
operator|)
condition|?
literal|'a'
else|:
literal|'-'
operator|)
operator|,
operator|(
name|suinfo
index|[
name|i
index|]
operator|.
name|nsi_flags
operator|&
operator|(
name|NANDFS_SEGMENT_USAGE_DIRTY
operator|)
condition|?
literal|'d'
else|:
literal|'-'
operator|)
operator|,
operator|(
name|suinfo
index|[
name|i
index|]
operator|.
name|nsi_flags
operator|&
operator|(
name|NANDFS_SEGMENT_USAGE_ERROR
operator|)
condition|?
literal|'e'
else|:
literal|'-'
operator|)
operator|,
name|suinfo
index|[
name|i
index|]
operator|.
name|nsi_blocks
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|nandfs_cleaner_vblock_is_alive
parameter_list|(
name|struct
name|nandfs_device
modifier|*
name|fsdev
parameter_list|,
name|struct
name|nandfs_vinfo
modifier|*
name|vinfo
parameter_list|,
name|struct
name|nandfs_cpinfo
modifier|*
name|cp
parameter_list|,
name|uint32_t
name|ncps
parameter_list|)
block|{
name|int64_t
name|idx
decl_stmt|,
name|min
decl_stmt|,
name|max
decl_stmt|;
if|if
condition|(
name|vinfo
operator|->
name|nvi_end
operator|>=
name|fsdev
operator|->
name|nd_last_cno
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
name|ncps
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|vinfo
operator|->
name|nvi_end
operator|<
name|cp
index|[
literal|0
index|]
operator|.
name|nci_cno
operator|||
name|vinfo
operator|->
name|nvi_start
operator|>
name|cp
index|[
name|ncps
operator|-
literal|1
index|]
operator|.
name|nci_cno
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|idx
operator|=
name|min
operator|=
literal|0
expr_stmt|;
name|max
operator|=
name|ncps
operator|-
literal|1
expr_stmt|;
while|while
condition|(
name|min
operator|<=
name|max
condition|)
block|{
name|idx
operator|=
operator|(
name|min
operator|+
name|max
operator|)
operator|/
literal|2
expr_stmt|;
if|if
condition|(
name|vinfo
operator|->
name|nvi_start
operator|==
name|cp
index|[
name|idx
index|]
operator|.
name|nci_cno
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
name|vinfo
operator|->
name|nvi_start
operator|<
name|cp
index|[
name|idx
index|]
operator|.
name|nci_cno
condition|)
name|max
operator|=
name|idx
operator|-
literal|1
expr_stmt|;
else|else
name|min
operator|=
name|idx
operator|+
literal|1
expr_stmt|;
block|}
return|return
operator|(
name|vinfo
operator|->
name|nvi_end
operator|>=
name|cp
index|[
name|idx
index|]
operator|.
name|nci_cno
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|nandfs_cleaner_vinfo_mark_alive
parameter_list|(
name|struct
name|nandfs_device
modifier|*
name|fsdev
parameter_list|,
name|struct
name|nandfs_vinfo
modifier|*
name|vinfo
parameter_list|,
name|uint32_t
name|nmembs
parameter_list|,
name|struct
name|nandfs_cpinfo
modifier|*
name|cp
parameter_list|,
name|uint32_t
name|ncps
parameter_list|)
block|{
name|uint32_t
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nmembs
condition|;
name|i
operator|++
control|)
name|vinfo
index|[
name|i
index|]
operator|.
name|nvi_alive
operator|=
name|nandfs_cleaner_vblock_is_alive
argument_list|(
name|fsdev
argument_list|,
operator|&
name|vinfo
index|[
name|i
index|]
argument_list|,
name|cp
argument_list|,
name|ncps
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|nandfs_cleaner_bdesc_is_alive
parameter_list|(
name|struct
name|nandfs_device
modifier|*
name|fsdev
parameter_list|,
name|struct
name|nandfs_bdesc
modifier|*
name|bdesc
parameter_list|)
block|{
name|int
name|alive
decl_stmt|;
name|alive
operator|=
name|bdesc
operator|->
name|bd_oblocknr
operator|==
name|bdesc
operator|->
name|bd_blocknr
expr_stmt|;
if|if
condition|(
operator|!
name|alive
condition|)
name|MPASS
argument_list|(
name|abs
argument_list|(
name|bdesc
operator|->
name|bd_oblocknr
operator|-
name|bdesc
operator|->
name|bd_blocknr
argument_list|)
operator|>
literal|2
argument_list|)
expr_stmt|;
return|return
operator|(
name|alive
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|nandfs_cleaner_bdesc_mark_alive
parameter_list|(
name|struct
name|nandfs_device
modifier|*
name|fsdev
parameter_list|,
name|struct
name|nandfs_bdesc
modifier|*
name|bdesc
parameter_list|,
name|uint32_t
name|nmembs
parameter_list|)
block|{
name|uint32_t
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nmembs
condition|;
name|i
operator|++
control|)
name|bdesc
index|[
name|i
index|]
operator|.
name|bd_alive
operator|=
name|nandfs_cleaner_bdesc_is_alive
argument_list|(
name|fsdev
argument_list|,
operator|&
name|bdesc
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|nandfs_cleaner_iterate_psegment
parameter_list|(
name|struct
name|nandfs_device
modifier|*
name|fsdev
parameter_list|,
name|struct
name|nandfs_segment_summary
modifier|*
name|segsum
parameter_list|,
name|union
name|nandfs_binfo
modifier|*
name|binfo
parameter_list|,
name|nandfs_daddr_t
name|blk
parameter_list|,
name|struct
name|nandfs_vinfo
modifier|*
modifier|*
name|vipp
parameter_list|,
name|struct
name|nandfs_bdesc
modifier|*
modifier|*
name|bdpp
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|DPRINTF
argument_list|(
name|CLEAN
argument_list|,
operator|(
literal|"%s nbinfos %x\n"
operator|,
name|__func__
operator|,
name|segsum
operator|->
name|ss_nbinfos
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|segsum
operator|->
name|ss_nbinfos
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|binfo
index|[
name|i
index|]
operator|.
name|bi_v
operator|.
name|bi_ino
operator|==
name|NANDFS_DAT_INO
condition|)
block|{
operator|(
operator|*
name|bdpp
operator|)
operator|->
name|bd_oblocknr
operator|=
name|blk
operator|+
name|segsum
operator|->
name|ss_nblocks
operator|-
name|segsum
operator|->
name|ss_nbinfos
operator|+
name|i
expr_stmt|;
comment|/* 			 * XXX Hack 			 */
if|if
condition|(
name|segsum
operator|->
name|ss_flags
operator|&
name|NANDFS_SS_SR
condition|)
operator|(
operator|*
name|bdpp
operator|)
operator|->
name|bd_oblocknr
operator|--
expr_stmt|;
operator|(
operator|*
name|bdpp
operator|)
operator|->
name|bd_level
operator|=
name|binfo
index|[
name|i
index|]
operator|.
name|bi_dat
operator|.
name|bi_level
expr_stmt|;
operator|(
operator|*
name|bdpp
operator|)
operator|->
name|bd_offset
operator|=
name|binfo
index|[
name|i
index|]
operator|.
name|bi_dat
operator|.
name|bi_blkoff
expr_stmt|;
operator|(
operator|*
name|bdpp
operator|)
operator|++
expr_stmt|;
block|}
else|else
block|{
operator|(
operator|*
name|vipp
operator|)
operator|->
name|nvi_ino
operator|=
name|binfo
index|[
name|i
index|]
operator|.
name|bi_v
operator|.
name|bi_ino
expr_stmt|;
operator|(
operator|*
name|vipp
operator|)
operator|->
name|nvi_vblocknr
operator|=
name|binfo
index|[
name|i
index|]
operator|.
name|bi_v
operator|.
name|bi_vblocknr
expr_stmt|;
operator|(
operator|*
name|vipp
operator|)
operator|++
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|nandfs_cleaner_iterate_segment
parameter_list|(
name|struct
name|nandfs_device
modifier|*
name|fsdev
parameter_list|,
name|uint64_t
name|segno
parameter_list|,
name|struct
name|nandfs_vinfo
modifier|*
modifier|*
name|vipp
parameter_list|,
name|struct
name|nandfs_bdesc
modifier|*
modifier|*
name|bdpp
parameter_list|,
name|int
modifier|*
name|select
parameter_list|)
block|{
name|struct
name|nandfs_segment_summary
modifier|*
name|segsum
decl_stmt|;
name|union
name|nandfs_binfo
modifier|*
name|binfo
decl_stmt|;
name|struct
name|buf
modifier|*
name|bp
decl_stmt|;
name|uint32_t
name|nblocks
decl_stmt|;
name|nandfs_daddr_t
name|curr
decl_stmt|,
name|start
decl_stmt|,
name|end
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|nandfs_get_segment_range
argument_list|(
name|fsdev
argument_list|,
name|segno
argument_list|,
operator|&
name|start
argument_list|,
operator|&
name|end
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
name|CLEAN
argument_list|,
operator|(
literal|"%s: segno %jx start %jx end %jx\n"
operator|,
name|__func__
operator|,
name|segno
operator|,
name|start
operator|,
name|end
operator|)
argument_list|)
expr_stmt|;
operator|*
name|select
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|curr
operator|=
name|start
init|;
name|curr
operator|<
name|end
condition|;
name|curr
operator|+=
name|nblocks
control|)
block|{
name|error
operator|=
name|nandfs_dev_bread
argument_list|(
name|fsdev
argument_list|,
name|curr
argument_list|,
name|NOCRED
argument_list|,
literal|0
argument_list|,
operator|&
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|brelse
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|nandfs_error
argument_list|(
literal|"%s: couldn't load segment summary of %jx: %d\n"
argument_list|,
name|__func__
argument_list|,
name|segno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|segsum
operator|=
operator|(
expr|struct
name|nandfs_segment_summary
operator|*
operator|)
name|bp
operator|->
name|b_data
expr_stmt|;
name|binfo
operator|=
operator|(
expr|union
name|nandfs_binfo
operator|*
operator|)
operator|(
name|bp
operator|->
name|b_data
operator|+
name|segsum
operator|->
name|ss_bytes
operator|)
expr_stmt|;
if|if
condition|(
operator|!
name|nandfs_segsum_valid
argument_list|(
name|segsum
argument_list|)
condition|)
block|{
name|brelse
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|nandfs_error
argument_list|(
literal|"nandfs: invalid summary of segment %jx\n"
argument_list|,
name|segno
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|DPRINTF
argument_list|(
name|CLEAN
argument_list|,
operator|(
literal|"%s: %jx magic %x bytes %x nblocks %x nbinfos "
literal|"%x\n"
operator|,
name|__func__
operator|,
name|segno
operator|,
name|segsum
operator|->
name|ss_magic
operator|,
name|segsum
operator|->
name|ss_bytes
operator|,
name|segsum
operator|->
name|ss_nblocks
operator|,
name|segsum
operator|->
name|ss_nbinfos
operator|)
argument_list|)
expr_stmt|;
name|nandfs_cleaner_iterate_psegment
argument_list|(
name|fsdev
argument_list|,
name|segsum
argument_list|,
name|binfo
argument_list|,
name|curr
argument_list|,
name|vipp
argument_list|,
name|bdpp
argument_list|)
expr_stmt|;
name|nblocks
operator|=
name|segsum
operator|->
name|ss_nblocks
expr_stmt|;
name|brelse
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|error
operator|==
literal|0
condition|)
operator|*
name|select
operator|=
literal|1
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nandfs_cleaner_choose_segment
parameter_list|(
name|struct
name|nandfs_device
modifier|*
name|fsdev
parameter_list|,
name|uint64_t
modifier|*
modifier|*
name|segpp
parameter_list|,
name|uint64_t
name|nsegs
parameter_list|,
name|uint64_t
modifier|*
name|rseg
parameter_list|)
block|{
name|struct
name|nandfs_suinfo
modifier|*
name|suinfo
decl_stmt|;
name|uint64_t
name|i
decl_stmt|,
name|ssegs
decl_stmt|;
name|int
name|error
decl_stmt|;
name|suinfo
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|suinfo
argument_list|)
operator|*
name|nsegs
argument_list|,
name|M_NANDFSTEMP
argument_list|,
name|M_ZERO
operator||
name|M_WAITOK
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|rseg
operator|>=
name|fsdev
operator|->
name|nd_fsdata
operator|.
name|f_nsegments
condition|)
operator|*
name|rseg
operator|=
literal|0
expr_stmt|;
name|retry
label|:
name|error
operator|=
name|nandfs_get_segment_info_filter
argument_list|(
name|fsdev
argument_list|,
name|suinfo
argument_list|,
name|nsegs
argument_list|,
operator|*
name|rseg
argument_list|,
operator|&
name|ssegs
argument_list|,
name|NANDFS_SEGMENT_USAGE_DIRTY
argument_list|,
name|NANDFS_SEGMENT_USAGE_ACTIVE
operator||
name|NANDFS_SEGMENT_USAGE_ERROR
operator||
name|NANDFS_SEGMENT_USAGE_GC
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|nandfs_error
argument_list|(
literal|"%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|ssegs
operator|==
literal|0
operator|&&
operator|*
name|rseg
operator|!=
literal|0
condition|)
block|{
operator|*
name|rseg
operator|=
literal|0
expr_stmt|;
goto|goto
name|retry
goto|;
block|}
name|print_suinfo
argument_list|(
name|suinfo
argument_list|,
name|ssegs
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ssegs
condition|;
name|i
operator|++
control|)
block|{
operator|(
operator|*
operator|*
name|segpp
operator|)
operator|=
name|suinfo
index|[
name|i
index|]
operator|.
name|nsi_num
expr_stmt|;
operator|(
operator|*
name|segpp
operator|)
operator|++
expr_stmt|;
block|}
operator|*
name|rseg
operator|=
name|suinfo
index|[
name|i
operator|-
literal|1
index|]
operator|.
name|nsi_num
operator|+
literal|1
expr_stmt|;
name|out
label|:
name|free
argument_list|(
name|suinfo
argument_list|,
name|M_NANDFSTEMP
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nandfs_cleaner_body
parameter_list|(
name|struct
name|nandfs_device
modifier|*
name|fsdev
parameter_list|,
name|uint64_t
modifier|*
name|rseg
parameter_list|)
block|{
name|struct
name|nandfs_vinfo
modifier|*
name|vinfo
decl_stmt|,
modifier|*
name|vip
decl_stmt|,
modifier|*
name|vipi
decl_stmt|;
name|struct
name|nandfs_bdesc
modifier|*
name|bdesc
decl_stmt|,
modifier|*
name|bdp
decl_stmt|,
modifier|*
name|bdpi
decl_stmt|;
name|struct
name|nandfs_cpstat
name|cpstat
decl_stmt|;
name|struct
name|nandfs_cpinfo
modifier|*
name|cpinfo
init|=
name|NULL
decl_stmt|;
name|uint64_t
modifier|*
name|segnums
decl_stmt|,
modifier|*
name|segp
decl_stmt|;
name|int
name|select
decl_stmt|,
name|selected
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|int
name|nsegs
decl_stmt|;
name|int
name|i
decl_stmt|;
name|nsegs
operator|=
name|nandfs_cleaner_segments
expr_stmt|;
name|vip
operator|=
name|vinfo
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|vinfo
argument_list|)
operator|*
name|fsdev
operator|->
name|nd_fsdata
operator|.
name|f_blocks_per_segment
operator|*
name|nsegs
argument_list|,
name|M_NANDFSTEMP
argument_list|,
name|M_ZERO
operator||
name|M_WAITOK
argument_list|)
expr_stmt|;
name|bdp
operator|=
name|bdesc
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|bdesc
argument_list|)
operator|*
name|fsdev
operator|->
name|nd_fsdata
operator|.
name|f_blocks_per_segment
operator|*
name|nsegs
argument_list|,
name|M_NANDFSTEMP
argument_list|,
name|M_ZERO
operator||
name|M_WAITOK
argument_list|)
expr_stmt|;
name|segp
operator|=
name|segnums
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|segnums
argument_list|)
operator|*
name|nsegs
argument_list|,
name|M_NANDFSTEMP
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|error
operator|=
name|nandfs_cleaner_choose_segment
argument_list|(
name|fsdev
argument_list|,
operator|&
name|segp
argument_list|,
name|nsegs
argument_list|,
name|rseg
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|nandfs_error
argument_list|(
literal|"%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|segnums
operator|==
name|segp
condition|)
goto|goto
name|out
goto|;
name|selected
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|segp
operator|-
name|segnums
condition|;
name|i
operator|++
control|)
block|{
name|error
operator|=
name|nandfs_cleaner_iterate_segment
argument_list|(
name|fsdev
argument_list|,
name|segnums
index|[
name|i
index|]
argument_list|,
operator|&
name|vip
argument_list|,
operator|&
name|bdp
argument_list|,
operator|&
name|select
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
comment|/* 			 * XXX deselect (see below)? 			 */
goto|goto
name|out
goto|;
block|}
if|if
condition|(
operator|!
name|select
condition|)
name|segnums
index|[
name|i
index|]
operator|=
name|NANDFS_NOSEGMENT
expr_stmt|;
else|else
block|{
name|error
operator|=
name|nandfs_markgc_segment
argument_list|(
name|fsdev
argument_list|,
name|segnums
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|nandfs_error
argument_list|(
literal|"%s:%d\n"
argument_list|,
name|__FILE__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|selected
operator|++
expr_stmt|;
block|}
block|}
if|if
condition|(
name|selected
operator|==
literal|0
condition|)
block|{
name|MPASS
argument_list|(
name|vinfo
operator|==
name|vip
argument_list|)
expr_stmt|;
name|MPASS
argument_list|(
name|bdesc
operator|==
name|bdp
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|error
operator|=
name|nandfs_get_cpstat
argument_list|(
name|fsdev
operator|->
name|nd_cp_node
argument_list|,
operator|&
name|cpstat
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|nandfs_error
argument_list|(
literal|"%s:%d\n"
argument_list|,
name|__FILE__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|cpstat
operator|.
name|ncp_nss
operator|!=
literal|0
condition|)
block|{
name|cpinfo
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|nandfs_cpinfo
argument_list|)
operator|*
name|cpstat
operator|.
name|ncp_nss
argument_list|,
name|M_NANDFSTEMP
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|error
operator|=
name|nandfs_get_cpinfo
argument_list|(
name|fsdev
operator|->
name|nd_cp_node
argument_list|,
literal|1
argument_list|,
name|NANDFS_SNAPSHOT
argument_list|,
name|cpinfo
argument_list|,
name|cpstat
operator|.
name|ncp_nss
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|nandfs_error
argument_list|(
literal|"%s:%d\n"
argument_list|,
name|__FILE__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
goto|goto
name|out_locked
goto|;
block|}
block|}
name|NANDFS_WRITELOCK
argument_list|(
name|fsdev
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
name|CLEAN
argument_list|,
operator|(
literal|"%s: got lock\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|nandfs_get_dat_vinfo
argument_list|(
name|fsdev
argument_list|,
name|vinfo
argument_list|,
name|vip
operator|-
name|vinfo
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|nandfs_error
argument_list|(
literal|"%s:%d\n"
argument_list|,
name|__FILE__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
goto|goto
name|out_locked
goto|;
block|}
name|nandfs_cleaner_vinfo_mark_alive
argument_list|(
name|fsdev
argument_list|,
name|vinfo
argument_list|,
name|vip
operator|-
name|vinfo
argument_list|,
name|cpinfo
argument_list|,
name|cpstat
operator|.
name|ncp_nss
argument_list|)
expr_stmt|;
name|error
operator|=
name|nandfs_get_dat_bdescs
argument_list|(
name|fsdev
argument_list|,
name|bdesc
argument_list|,
name|bdp
operator|-
name|bdesc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|nandfs_error
argument_list|(
literal|"%s:%d\n"
argument_list|,
name|__FILE__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
goto|goto
name|out_locked
goto|;
block|}
name|nandfs_cleaner_bdesc_mark_alive
argument_list|(
name|fsdev
argument_list|,
name|bdesc
argument_list|,
name|bdp
operator|-
name|bdesc
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
name|CLEAN
argument_list|,
operator|(
literal|"got:\n"
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|vipi
operator|=
name|vinfo
init|;
name|vipi
operator|<
name|vip
condition|;
name|vipi
operator|++
control|)
block|{
name|DPRINTF
argument_list|(
name|CLEAN
argument_list|,
operator|(
literal|"v ino %jx vblocknr %jx start %jx end %jx "
literal|"alive %d\n"
operator|,
name|vipi
operator|->
name|nvi_ino
operator|,
name|vipi
operator|->
name|nvi_vblocknr
operator|,
name|vipi
operator|->
name|nvi_start
operator|,
name|vipi
operator|->
name|nvi_end
operator|,
name|vipi
operator|->
name|nvi_alive
operator|)
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|bdpi
operator|=
name|bdesc
init|;
name|bdpi
operator|<
name|bdp
condition|;
name|bdpi
operator|++
control|)
block|{
name|DPRINTF
argument_list|(
name|CLEAN
argument_list|,
operator|(
literal|"b oblocknr %jx blocknr %jx offset %jx "
literal|"alive %d\n"
operator|,
name|bdpi
operator|->
name|bd_oblocknr
operator|,
name|bdpi
operator|->
name|bd_blocknr
operator|,
name|bdpi
operator|->
name|bd_offset
operator|,
name|bdpi
operator|->
name|bd_alive
operator|)
argument_list|)
expr_stmt|;
block|}
name|DPRINTF
argument_list|(
name|CLEAN
argument_list|,
operator|(
literal|"end list\n"
operator|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|nandfs_cleaner_clean_segments
argument_list|(
name|fsdev
argument_list|,
name|vinfo
argument_list|,
name|vip
operator|-
name|vinfo
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|bdesc
argument_list|,
name|bdp
operator|-
name|bdesc
argument_list|,
name|segnums
argument_list|,
name|segp
operator|-
name|segnums
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
name|nandfs_error
argument_list|(
literal|"%s:%d\n"
argument_list|,
name|__FILE__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|out_locked
label|:
name|NANDFS_WRITEUNLOCK
argument_list|(
name|fsdev
argument_list|)
expr_stmt|;
name|out
label|:
name|free
argument_list|(
name|cpinfo
argument_list|,
name|M_NANDFSTEMP
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|segnums
argument_list|,
name|M_NANDFSTEMP
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|bdesc
argument_list|,
name|M_NANDFSTEMP
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|vinfo
argument_list|,
name|M_NANDFSTEMP
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|nandfs_cleaner
parameter_list|(
name|struct
name|nandfs_device
modifier|*
name|fsdev
parameter_list|)
block|{
name|uint64_t
name|checked_seg
init|=
literal|0
decl_stmt|;
name|int
name|error
decl_stmt|;
while|while
condition|(
operator|!
name|nandfs_cleaner_finished
argument_list|(
name|fsdev
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|nandfs_cleaner_enable
operator|||
name|rebooting
condition|)
continue|continue;
name|DPRINTF
argument_list|(
name|CLEAN
argument_list|,
operator|(
literal|"%s: run started\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
name|fsdev
operator|->
name|nd_cleaning
operator|=
literal|1
expr_stmt|;
name|error
operator|=
name|nandfs_cleaner_body
argument_list|(
name|fsdev
argument_list|,
operator|&
name|checked_seg
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
name|CLEAN
argument_list|,
operator|(
literal|"%s: run finished error %d\n"
operator|,
name|__func__
operator|,
name|error
operator|)
argument_list|)
expr_stmt|;
block|}
name|DPRINTF
argument_list|(
name|CLEAN
argument_list|,
operator|(
literal|"%s: exiting\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
name|kthread_exit
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|nandfs_cleaner_clean_segments
parameter_list|(
name|struct
name|nandfs_device
modifier|*
name|nffsdev
parameter_list|,
name|struct
name|nandfs_vinfo
modifier|*
name|vinfo
parameter_list|,
name|uint32_t
name|nvinfo
parameter_list|,
name|struct
name|nandfs_period
modifier|*
name|pd
parameter_list|,
name|uint32_t
name|npd
parameter_list|,
name|struct
name|nandfs_bdesc
modifier|*
name|bdesc
parameter_list|,
name|uint32_t
name|nbdesc
parameter_list|,
name|uint64_t
modifier|*
name|segments
parameter_list|,
name|uint32_t
name|nsegs
parameter_list|)
block|{
name|struct
name|nandfs_node
modifier|*
name|gc
decl_stmt|;
name|struct
name|buf
modifier|*
name|bp
decl_stmt|;
name|uint32_t
name|i
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|gc
operator|=
name|nffsdev
operator|->
name|nd_gc_node
expr_stmt|;
name|DPRINTF
argument_list|(
name|CLEAN
argument_list|,
operator|(
literal|"%s: enter\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
name|VOP_LOCK
argument_list|(
name|NTOV
argument_list|(
name|gc
argument_list|)
argument_list|,
name|LK_EXCLUSIVE
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nvinfo
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|vinfo
index|[
name|i
index|]
operator|.
name|nvi_alive
condition|)
continue|continue;
name|DPRINTF
argument_list|(
name|CLEAN
argument_list|,
operator|(
literal|"%s: read vblknr:%#jx blk:%#jx\n"
operator|,
name|__func__
operator|,
operator|(
name|uintmax_t
operator|)
name|vinfo
index|[
name|i
index|]
operator|.
name|nvi_vblocknr
operator|,
operator|(
name|uintmax_t
operator|)
name|vinfo
index|[
name|i
index|]
operator|.
name|nvi_blocknr
operator|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|nandfs_bread
argument_list|(
name|nffsdev
operator|->
name|nd_gc_node
argument_list|,
name|vinfo
index|[
name|i
index|]
operator|.
name|nvi_blocknr
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
operator|&
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|nandfs_error
argument_list|(
literal|"%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|VOP_UNLOCK
argument_list|(
name|NTOV
argument_list|(
name|gc
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|nandfs_vblk_set
argument_list|(
name|bp
argument_list|,
name|vinfo
index|[
name|i
index|]
operator|.
name|nvi_vblocknr
argument_list|)
expr_stmt|;
name|nandfs_buf_set
argument_list|(
name|bp
argument_list|,
name|NANDFS_VBLK_ASSIGNED
argument_list|)
expr_stmt|;
name|nandfs_dirty_buf
argument_list|(
name|bp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|VOP_UNLOCK
argument_list|(
name|NTOV
argument_list|(
name|gc
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Delete checkpoints */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|npd
condition|;
name|i
operator|++
control|)
block|{
name|DPRINTF
argument_list|(
name|CLEAN
argument_list|,
operator|(
literal|"delete checkpoint: %jx\n"
operator|,
operator|(
name|uintmax_t
operator|)
name|pd
index|[
name|i
index|]
operator|.
name|p_start
operator|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|nandfs_delete_cp
argument_list|(
name|nffsdev
operator|->
name|nd_cp_node
argument_list|,
name|pd
index|[
name|i
index|]
operator|.
name|p_start
argument_list|,
name|pd
index|[
name|i
index|]
operator|.
name|p_end
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|nandfs_error
argument_list|(
literal|"%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
comment|/* Update vblocks */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nvinfo
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|vinfo
index|[
name|i
index|]
operator|.
name|nvi_alive
condition|)
continue|continue;
name|DPRINTF
argument_list|(
name|CLEAN
argument_list|,
operator|(
literal|"freeing vblknr: %jx\n"
operator|,
name|vinfo
index|[
name|i
index|]
operator|.
name|nvi_vblocknr
operator|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|nandfs_vblock_free
argument_list|(
name|nffsdev
argument_list|,
name|vinfo
index|[
name|i
index|]
operator|.
name|nvi_vblocknr
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|nandfs_error
argument_list|(
literal|"%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
name|error
operator|=
name|nandfs_process_bdesc
argument_list|(
name|nffsdev
argument_list|,
name|bdesc
argument_list|,
name|nbdesc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|nandfs_error
argument_list|(
literal|"%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* Add segments to clean */
if|if
condition|(
name|nffsdev
operator|->
name|nd_free_count
condition|)
block|{
name|nffsdev
operator|->
name|nd_free_base
operator|=
name|realloc
argument_list|(
name|nffsdev
operator|->
name|nd_free_base
argument_list|,
operator|(
name|nffsdev
operator|->
name|nd_free_count
operator|+
name|nsegs
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
argument_list|,
name|M_NANDFSTEMP
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|nffsdev
operator|->
name|nd_free_base
index|[
name|nffsdev
operator|->
name|nd_free_count
index|]
argument_list|,
name|segments
argument_list|,
name|nsegs
operator|*
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
argument_list|)
expr_stmt|;
name|nffsdev
operator|->
name|nd_free_count
operator|+=
name|nsegs
expr_stmt|;
block|}
else|else
block|{
name|nffsdev
operator|->
name|nd_free_base
operator|=
name|malloc
argument_list|(
name|nsegs
operator|*
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
argument_list|,
name|M_NANDFSTEMP
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|nffsdev
operator|->
name|nd_free_base
argument_list|,
name|segments
argument_list|,
name|nsegs
operator|*
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
argument_list|)
expr_stmt|;
name|nffsdev
operator|->
name|nd_free_count
operator|=
name|nsegs
expr_stmt|;
block|}
name|out
label|:
name|DPRINTF
argument_list|(
name|CLEAN
argument_list|,
operator|(
literal|"%s: exit error %d\n"
operator|,
name|__func__
operator|,
name|error
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nandfs_process_bdesc
parameter_list|(
name|struct
name|nandfs_device
modifier|*
name|nffsdev
parameter_list|,
name|struct
name|nandfs_bdesc
modifier|*
name|bd
parameter_list|,
name|uint64_t
name|nmembs
parameter_list|)
block|{
name|struct
name|nandfs_node
modifier|*
name|dat_node
decl_stmt|;
name|struct
name|buf
modifier|*
name|bp
decl_stmt|;
name|uint64_t
name|i
decl_stmt|;
name|int
name|error
decl_stmt|;
name|dat_node
operator|=
name|nffsdev
operator|->
name|nd_dat_node
expr_stmt|;
name|VOP_LOCK
argument_list|(
name|NTOV
argument_list|(
name|dat_node
argument_list|)
argument_list|,
name|LK_EXCLUSIVE
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nmembs
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|bd
index|[
name|i
index|]
operator|.
name|bd_alive
condition|)
continue|continue;
name|DPRINTF
argument_list|(
name|CLEAN
argument_list|,
operator|(
literal|"%s: idx %jx offset %jx\n"
operator|,
name|__func__
operator|,
name|i
operator|,
name|bd
index|[
name|i
index|]
operator|.
name|bd_offset
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bd
index|[
name|i
index|]
operator|.
name|bd_level
condition|)
block|{
name|error
operator|=
name|nandfs_bread_meta
argument_list|(
name|dat_node
argument_list|,
name|bd
index|[
name|i
index|]
operator|.
name|bd_offset
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
operator|&
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|nandfs_error
argument_list|(
literal|"%s: cannot read dat node "
literal|"level:%d\n"
argument_list|,
name|__func__
argument_list|,
name|bd
index|[
name|i
index|]
operator|.
name|bd_level
argument_list|)
expr_stmt|;
name|brelse
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|VOP_UNLOCK
argument_list|(
name|NTOV
argument_list|(
name|dat_node
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|nandfs_dirty_buf_meta
argument_list|(
name|bp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|nandfs_bmap_dirty_blocks
argument_list|(
name|VTON
argument_list|(
name|bp
operator|->
name|b_vp
argument_list|)
argument_list|,
name|bp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|error
operator|=
name|nandfs_bread
argument_list|(
name|dat_node
argument_list|,
name|bd
index|[
name|i
index|]
operator|.
name|bd_offset
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
operator|&
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|nandfs_error
argument_list|(
literal|"%s: cannot read dat node\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|brelse
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|VOP_UNLOCK
argument_list|(
name|NTOV
argument_list|(
name|dat_node
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|nandfs_dirty_buf
argument_list|(
name|bp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|DPRINTF
argument_list|(
name|CLEAN
argument_list|,
operator|(
literal|"%s: bp: %p\n"
operator|,
name|__func__
operator|,
name|bp
operator|)
argument_list|)
expr_stmt|;
block|}
name|VOP_UNLOCK
argument_list|(
name|NTOV
argument_list|(
name|dat_node
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


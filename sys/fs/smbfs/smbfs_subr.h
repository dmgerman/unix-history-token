begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2000-2001, Boris Popov  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. All advertising materials mentioning features or use of this software  *    must display the following acknowledgement:  *    This product includes software developed by Boris Popov.  * 4. Neither the name of the author nor the names of any co-contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|_FS_SMBFS_SMBFS_SUBR_H_
end_ifndef

begin_define
define|#
directive|define
name|_FS_SMBFS_SMBFS_SUBR_H_
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|MALLOC_DECLARE
end_ifdef

begin_expr_stmt
name|MALLOC_DECLARE
argument_list|(
name|M_SMBFSDATA
argument_list|)
expr_stmt|;
end_expr_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|SMBFSERR
parameter_list|(
name|format
parameter_list|,
name|args
modifier|...
parameter_list|)
value|printf("%s: "format, __func__ ,## args)
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|SMB_VNODE_DEBUG
end_ifdef

begin_define
define|#
directive|define
name|SMBVDEBUG
parameter_list|(
name|format
parameter_list|,
name|args
modifier|...
parameter_list|)
value|printf("%s: "format, __func__ ,## args)
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|SMBVDEBUG
parameter_list|(
name|format
parameter_list|,
name|args
modifier|...
parameter_list|)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * Possible lock commands  */
end_comment

begin_define
define|#
directive|define
name|SMB_LOCK_EXCL
value|0
end_define

begin_define
define|#
directive|define
name|SMB_LOCK_SHARED
value|1
end_define

begin_define
define|#
directive|define
name|SMB_LOCK_RELEASE
value|2
end_define

begin_struct_decl
struct_decl|struct
name|smbmount
struct_decl|;
end_struct_decl

begin_struct_decl
struct_decl|struct
name|proc
struct_decl|;
end_struct_decl

begin_struct_decl
struct_decl|struct
name|timespec
struct_decl|;
end_struct_decl

begin_struct_decl
struct_decl|struct
name|ucred
struct_decl|;
end_struct_decl

begin_struct_decl
struct_decl|struct
name|vattr
struct_decl|;
end_struct_decl

begin_struct_decl
struct_decl|struct
name|vnode
struct_decl|;
end_struct_decl

begin_struct_decl
struct_decl|struct
name|statfs
struct_decl|;
end_struct_decl

begin_struct
struct|struct
name|smbfattr
block|{
name|int
name|fa_attr
decl_stmt|;
name|int64_t
name|fa_size
decl_stmt|;
name|struct
name|timespec
name|fa_atime
decl_stmt|;
name|struct
name|timespec
name|fa_ctime
decl_stmt|;
name|struct
name|timespec
name|fa_mtime
decl_stmt|;
name|long
name|fa_ino
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/*  * Context to perform findfirst/findnext/findclose operations  */
end_comment

begin_define
define|#
directive|define
name|SMBFS_RDD_FINDFIRST
value|0x01
end_define

begin_define
define|#
directive|define
name|SMBFS_RDD_EOF
value|0x02
end_define

begin_define
define|#
directive|define
name|SMBFS_RDD_FINDSINGLE
value|0x04
end_define

begin_define
define|#
directive|define
name|SMBFS_RDD_USESEARCH
value|0x08
end_define

begin_define
define|#
directive|define
name|SMBFS_RDD_NOCLOSE
value|0x10
end_define

begin_define
define|#
directive|define
name|SMBFS_RDD_GOTRNAME
value|0x1000
end_define

begin_comment
comment|/*  * Search context supplied by server  */
end_comment

begin_define
define|#
directive|define
name|SMB_SKEYLEN
value|21
end_define

begin_comment
comment|/* search context */
end_comment

begin_define
define|#
directive|define
name|SMB_DENTRYLEN
value|(SMB_SKEYLEN + 22)
end_define

begin_comment
comment|/* entire entry */
end_comment

begin_struct
struct|struct
name|smbfs_fctx
block|{
comment|/* 	 * Setable values 	 */
name|int
name|f_flags
decl_stmt|;
comment|/* SMBFS_RDD_ */
comment|/* 	 * Return values 	 */
name|struct
name|smbfattr
name|f_attr
decl_stmt|;
comment|/* current attributes */
name|char
modifier|*
name|f_name
decl_stmt|;
comment|/* current file name */
name|int
name|f_nmlen
decl_stmt|;
comment|/* name len */
comment|/* 	 * Internal variables 	 */
name|int
name|f_limit
decl_stmt|;
comment|/* maximum number of entries */
name|int
name|f_attrmask
decl_stmt|;
comment|/* SMB_FA_ */
name|int
name|f_wclen
decl_stmt|;
specifier|const
name|char
modifier|*
name|f_wildcard
decl_stmt|;
name|struct
name|smbnode
modifier|*
name|f_dnp
decl_stmt|;
name|struct
name|smb_cred
modifier|*
name|f_scred
decl_stmt|;
name|struct
name|smb_share
modifier|*
name|f_ssp
decl_stmt|;
union|union
block|{
name|struct
name|smb_rq
modifier|*
name|uf_rq
decl_stmt|;
name|struct
name|smb_t2rq
modifier|*
name|uf_t2
decl_stmt|;
block|}
name|f_urq
union|;
name|int
name|f_left
decl_stmt|;
comment|/* entries left */
name|int
name|f_ecnt
decl_stmt|;
comment|/* entries left in the current reponse */
name|int
name|f_eofs
decl_stmt|;
comment|/* entry offset in the parameter block */
name|u_char
name|f_skey
index|[
name|SMB_SKEYLEN
index|]
decl_stmt|;
comment|/* server side search context */
name|u_char
name|f_fname
index|[
literal|8
operator|+
literal|1
operator|+
literal|3
operator|+
literal|1
index|]
decl_stmt|;
comment|/* common case for 8.3 filenames */
name|u_int16_t
name|f_Sid
decl_stmt|;
name|u_int16_t
name|f_infolevel
decl_stmt|;
name|int
name|f_rnamelen
decl_stmt|;
name|char
modifier|*
name|f_rname
decl_stmt|;
comment|/* resume name/key */
name|int
name|f_rnameofs
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|f_rq
value|f_urq.uf_rq
end_define

begin_define
define|#
directive|define
name|f_t2
value|f_urq.uf_t2
end_define

begin_comment
comment|/*  * smb level  */
end_comment

begin_function_decl
name|int
name|smbfs_smb_lock
parameter_list|(
name|struct
name|smbnode
modifier|*
name|np
parameter_list|,
name|int
name|op
parameter_list|,
name|caddr_t
name|id
parameter_list|,
name|off_t
name|start
parameter_list|,
name|off_t
name|end
parameter_list|,
name|struct
name|smb_cred
modifier|*
name|scred
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|smbfs_smb_statfs2
parameter_list|(
name|struct
name|smb_share
modifier|*
name|ssp
parameter_list|,
name|struct
name|statfs
modifier|*
name|sbp
parameter_list|,
name|struct
name|smb_cred
modifier|*
name|scred
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|smbfs_smb_statfs
parameter_list|(
name|struct
name|smb_share
modifier|*
name|ssp
parameter_list|,
name|struct
name|statfs
modifier|*
name|sbp
parameter_list|,
name|struct
name|smb_cred
modifier|*
name|scred
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|smbfs_smb_setfsize
parameter_list|(
name|struct
name|smbnode
modifier|*
name|np
parameter_list|,
name|int
name|newsize
parameter_list|,
name|struct
name|smb_cred
modifier|*
name|scred
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|smbfs_smb_query_info
parameter_list|(
name|struct
name|smbnode
modifier|*
name|np
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|int
name|len
parameter_list|,
name|struct
name|smbfattr
modifier|*
name|fap
parameter_list|,
name|struct
name|smb_cred
modifier|*
name|scred
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|smbfs_smb_setpattr
parameter_list|(
name|struct
name|smbnode
modifier|*
name|np
parameter_list|,
name|u_int16_t
name|attr
parameter_list|,
name|struct
name|timespec
modifier|*
name|mtime
parameter_list|,
name|struct
name|smb_cred
modifier|*
name|scred
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|smbfs_smb_setptime2
parameter_list|(
name|struct
name|smbnode
modifier|*
name|np
parameter_list|,
name|struct
name|timespec
modifier|*
name|mtime
parameter_list|,
name|struct
name|timespec
modifier|*
name|atime
parameter_list|,
name|int
name|attr
parameter_list|,
name|struct
name|smb_cred
modifier|*
name|scred
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|smbfs_smb_setpattrNT
parameter_list|(
name|struct
name|smbnode
modifier|*
name|np
parameter_list|,
name|u_int16_t
name|attr
parameter_list|,
name|struct
name|timespec
modifier|*
name|mtime
parameter_list|,
name|struct
name|timespec
modifier|*
name|atime
parameter_list|,
name|struct
name|smb_cred
modifier|*
name|scred
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|smbfs_smb_setftime
parameter_list|(
name|struct
name|smbnode
modifier|*
name|np
parameter_list|,
name|struct
name|timespec
modifier|*
name|mtime
parameter_list|,
name|struct
name|timespec
modifier|*
name|atime
parameter_list|,
name|struct
name|smb_cred
modifier|*
name|scred
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|smbfs_smb_setfattrNT
parameter_list|(
name|struct
name|smbnode
modifier|*
name|np
parameter_list|,
name|u_int16_t
name|attr
parameter_list|,
name|struct
name|timespec
modifier|*
name|mtime
parameter_list|,
name|struct
name|timespec
modifier|*
name|atime
parameter_list|,
name|struct
name|smb_cred
modifier|*
name|scred
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|smbfs_smb_open
parameter_list|(
name|struct
name|smbnode
modifier|*
name|np
parameter_list|,
name|int
name|accmode
parameter_list|,
name|struct
name|smb_cred
modifier|*
name|scred
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|smbfs_smb_close
parameter_list|(
name|struct
name|smb_share
modifier|*
name|ssp
parameter_list|,
name|u_int16_t
name|fid
parameter_list|,
name|struct
name|timespec
modifier|*
name|mtime
parameter_list|,
name|struct
name|smb_cred
modifier|*
name|scred
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|smbfs_smb_create
parameter_list|(
name|struct
name|smbnode
modifier|*
name|dnp
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|int
name|len
parameter_list|,
name|struct
name|smb_cred
modifier|*
name|scred
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|smbfs_smb_delete
parameter_list|(
name|struct
name|smbnode
modifier|*
name|np
parameter_list|,
name|struct
name|smb_cred
modifier|*
name|scred
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|smbfs_smb_flush
parameter_list|(
name|struct
name|smbnode
modifier|*
name|np
parameter_list|,
name|struct
name|smb_cred
modifier|*
name|scred
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|smbfs_smb_rename
parameter_list|(
name|struct
name|smbnode
modifier|*
name|src
parameter_list|,
name|struct
name|smbnode
modifier|*
name|tdnp
parameter_list|,
specifier|const
name|char
modifier|*
name|tname
parameter_list|,
name|int
name|tnmlen
parameter_list|,
name|struct
name|smb_cred
modifier|*
name|scred
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|smbfs_smb_move
parameter_list|(
name|struct
name|smbnode
modifier|*
name|src
parameter_list|,
name|struct
name|smbnode
modifier|*
name|tdnp
parameter_list|,
specifier|const
name|char
modifier|*
name|tname
parameter_list|,
name|int
name|tnmlen
parameter_list|,
name|u_int16_t
name|flags
parameter_list|,
name|struct
name|smb_cred
modifier|*
name|scred
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|smbfs_smb_mkdir
parameter_list|(
name|struct
name|smbnode
modifier|*
name|dnp
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|int
name|len
parameter_list|,
name|struct
name|smb_cred
modifier|*
name|scred
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|smbfs_smb_rmdir
parameter_list|(
name|struct
name|smbnode
modifier|*
name|np
parameter_list|,
name|struct
name|smb_cred
modifier|*
name|scred
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|smbfs_findopen
parameter_list|(
name|struct
name|smbnode
modifier|*
name|dnp
parameter_list|,
specifier|const
name|char
modifier|*
name|wildcard
parameter_list|,
name|int
name|wclen
parameter_list|,
name|int
name|attr
parameter_list|,
name|struct
name|smb_cred
modifier|*
name|scred
parameter_list|,
name|struct
name|smbfs_fctx
modifier|*
modifier|*
name|ctxpp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|smbfs_findnext
parameter_list|(
name|struct
name|smbfs_fctx
modifier|*
name|ctx
parameter_list|,
name|int
name|limit
parameter_list|,
name|struct
name|smb_cred
modifier|*
name|scred
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|smbfs_findclose
parameter_list|(
name|struct
name|smbfs_fctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|smb_cred
modifier|*
name|scred
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|smbfs_fullpath
parameter_list|(
name|struct
name|mbchain
modifier|*
name|mbp
parameter_list|,
name|struct
name|smb_vc
modifier|*
name|vcp
parameter_list|,
name|struct
name|smbnode
modifier|*
name|dnp
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|int
name|nmlen
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|smbfs_smb_lookup
parameter_list|(
name|struct
name|smbnode
modifier|*
name|dnp
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|int
name|nmlen
parameter_list|,
name|struct
name|smbfattr
modifier|*
name|fap
parameter_list|,
name|struct
name|smb_cred
modifier|*
name|scred
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|smbfs_fname_tolocal
parameter_list|(
name|struct
name|smb_vc
modifier|*
name|vcp
parameter_list|,
name|char
modifier|*
name|name
parameter_list|,
name|int
modifier|*
name|nmlen
parameter_list|,
name|int
name|caseopt
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|smb_time_local2server
parameter_list|(
name|struct
name|timespec
modifier|*
name|tsp
parameter_list|,
name|int
name|tzoff
parameter_list|,
name|u_long
modifier|*
name|seconds
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|smb_time_server2local
parameter_list|(
name|u_long
name|seconds
parameter_list|,
name|int
name|tzoff
parameter_list|,
name|struct
name|timespec
modifier|*
name|tsp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|smb_time_NT2local
parameter_list|(
name|int64_t
name|nsec
parameter_list|,
name|int
name|tzoff
parameter_list|,
name|struct
name|timespec
modifier|*
name|tsp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|smb_time_local2NT
parameter_list|(
name|struct
name|timespec
modifier|*
name|tsp
parameter_list|,
name|int
name|tzoff
parameter_list|,
name|int64_t
modifier|*
name|nsec
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|smb_time_unix2dos
parameter_list|(
name|struct
name|timespec
modifier|*
name|tsp
parameter_list|,
name|int
name|tzoff
parameter_list|,
name|u_int16_t
modifier|*
name|ddp
parameter_list|,
name|u_int16_t
modifier|*
name|dtp
parameter_list|,
name|u_int8_t
modifier|*
name|dhp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|smb_dos2unixtime
parameter_list|(
name|u_int
name|dd
parameter_list|,
name|u_int
name|dt
parameter_list|,
name|u_int
name|dh
parameter_list|,
name|int
name|tzoff
parameter_list|,
name|struct
name|timespec
modifier|*
name|tsp
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* !_FS_SMBFS_SMBFS_SUBR_H_ */
end_comment

end_unit


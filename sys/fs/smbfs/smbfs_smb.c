begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2000-2001 Boris Popov  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. All advertising materials mentioning features or use of this software  *    must display the following acknowledgement:  *    This product includes software developed by Boris Popov.  * 4. Neither the name of the author nor the names of any co-contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/vnode.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/mount.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|USE_MD5_HASH
end_ifdef

begin_include
include|#
directive|include
file|<sys/md5.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<netsmb/smb.h>
end_include

begin_include
include|#
directive|include
file|<netsmb/smb_subr.h>
end_include

begin_include
include|#
directive|include
file|<netsmb/smb_rq.h>
end_include

begin_include
include|#
directive|include
file|<netsmb/smb_conn.h>
end_include

begin_include
include|#
directive|include
file|<fs/smbfs/smbfs.h>
end_include

begin_include
include|#
directive|include
file|<fs/smbfs/smbfs_node.h>
end_include

begin_include
include|#
directive|include
file|<fs/smbfs/smbfs_subr.h>
end_include

begin_comment
comment|/*  * Lack of inode numbers leads us to the problem of generating them.  * Partially this problem can be solved by having a dir/file cache  * with inode numbers generated from the incremented by one counter.  * However this way will require too much kernel memory, gives all  * sorts of locking and consistency problems, not to mentinon counter overflows.  * So, I'm decided to use a hash function to generate pseudo random (and unique)  * inode numbers.  */
end_comment

begin_function
specifier|static
name|long
name|smbfs_getino
parameter_list|(
name|struct
name|smbnode
modifier|*
name|dnp
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|int
name|nmlen
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|USE_MD5_HASH
name|MD5_CTX
name|md5
decl_stmt|;
name|u_int32_t
name|state
index|[
literal|4
index|]
decl_stmt|;
name|long
name|ino
decl_stmt|;
name|int
name|i
decl_stmt|;
name|MD5Init
argument_list|(
operator|&
name|md5
argument_list|)
expr_stmt|;
name|MD5Update
argument_list|(
operator|&
name|md5
argument_list|,
name|name
argument_list|,
name|nmlen
argument_list|)
expr_stmt|;
name|MD5Final
argument_list|(
operator|(
name|u_char
operator|*
operator|)
name|state
argument_list|,
operator|&
name|md5
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|ino
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
name|ino
operator|+=
name|state
index|[
name|i
index|]
expr_stmt|;
return|return
name|dnp
operator|->
name|n_ino
operator|+
name|ino
return|;
endif|#
directive|endif
name|u_int32_t
name|ino
decl_stmt|;
name|ino
operator|=
name|dnp
operator|->
name|n_ino
operator|+
name|smbfs_hash
argument_list|(
name|name
argument_list|,
name|nmlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|ino
operator|<=
literal|2
condition|)
name|ino
operator|+=
literal|3
expr_stmt|;
return|return
name|ino
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|smbfs_smb_lockandx
parameter_list|(
name|struct
name|smbnode
modifier|*
name|np
parameter_list|,
name|int
name|op
parameter_list|,
name|u_int32_t
name|pid
parameter_list|,
name|off_t
name|start
parameter_list|,
name|off_t
name|end
parameter_list|,
name|struct
name|smb_cred
modifier|*
name|scred
parameter_list|)
block|{
name|struct
name|smb_share
modifier|*
name|ssp
init|=
name|np
operator|->
name|n_mount
operator|->
name|sm_share
decl_stmt|;
name|struct
name|smb_rq
name|rq
decl_stmt|,
modifier|*
name|rqp
init|=
operator|&
name|rq
decl_stmt|;
name|struct
name|mbchain
modifier|*
name|mbp
decl_stmt|;
name|u_char
name|ltype
init|=
literal|0
decl_stmt|;
name|int
name|error
decl_stmt|;
if|if
condition|(
name|op
operator|==
name|SMB_LOCK_SHARED
condition|)
name|ltype
operator||=
name|SMB_LOCKING_ANDX_SHARED_LOCK
expr_stmt|;
name|error
operator|=
name|smb_rq_init
argument_list|(
name|rqp
argument_list|,
name|SSTOCP
argument_list|(
name|ssp
argument_list|)
argument_list|,
name|SMB_COM_LOCKING_ANDX
argument_list|,
name|scred
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
name|smb_rq_getrequest
argument_list|(
name|rqp
argument_list|,
operator|&
name|mbp
argument_list|)
expr_stmt|;
name|smb_rq_wstart
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|mb_put_uint8
argument_list|(
name|mbp
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
comment|/* secondary command */
name|mb_put_uint8
argument_list|(
name|mbp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* MBZ */
name|mb_put_uint16le
argument_list|(
name|mbp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mb_put_mem
argument_list|(
name|mbp
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|np
operator|->
name|n_fid
argument_list|,
literal|2
argument_list|,
name|MB_MSYSTEM
argument_list|)
expr_stmt|;
name|mb_put_uint8
argument_list|(
name|mbp
argument_list|,
name|ltype
argument_list|)
expr_stmt|;
comment|/* locktype */
name|mb_put_uint8
argument_list|(
name|mbp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* oplocklevel - 0 seems is NO_OPLOCK */
name|mb_put_uint32le
argument_list|(
name|mbp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* timeout - break immediately */
name|mb_put_uint16le
argument_list|(
name|mbp
argument_list|,
name|op
operator|==
name|SMB_LOCK_RELEASE
condition|?
literal|1
else|:
literal|0
argument_list|)
expr_stmt|;
name|mb_put_uint16le
argument_list|(
name|mbp
argument_list|,
name|op
operator|==
name|SMB_LOCK_RELEASE
condition|?
literal|0
else|:
literal|1
argument_list|)
expr_stmt|;
name|smb_rq_wend
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|smb_rq_bstart
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|mb_put_uint16le
argument_list|(
name|mbp
argument_list|,
name|pid
argument_list|)
expr_stmt|;
name|mb_put_uint32le
argument_list|(
name|mbp
argument_list|,
name|start
argument_list|)
expr_stmt|;
name|mb_put_uint32le
argument_list|(
name|mbp
argument_list|,
name|end
operator|-
name|start
argument_list|)
expr_stmt|;
name|smb_rq_bend
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|error
operator|=
name|smb_rq_simple
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|smb_rq_done
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_function
name|int
name|smbfs_smb_lock
parameter_list|(
name|struct
name|smbnode
modifier|*
name|np
parameter_list|,
name|int
name|op
parameter_list|,
name|caddr_t
name|id
parameter_list|,
name|off_t
name|start
parameter_list|,
name|off_t
name|end
parameter_list|,
name|struct
name|smb_cred
modifier|*
name|scred
parameter_list|)
block|{
name|struct
name|smb_share
modifier|*
name|ssp
init|=
name|np
operator|->
name|n_mount
operator|->
name|sm_share
decl_stmt|;
if|if
condition|(
name|SMB_DIALECT
argument_list|(
name|SSTOVC
argument_list|(
name|ssp
argument_list|)
argument_list|)
operator|<
name|SMB_DIALECT_LANMAN1_0
condition|)
comment|/* 		 * TODO: use LOCK_BYTE_RANGE here. 		 */
return|return
name|EINVAL
return|;
else|else
return|return
name|smbfs_smb_lockandx
argument_list|(
name|np
argument_list|,
name|op
argument_list|,
operator|(
name|u_int32_t
operator|)
name|id
argument_list|,
name|start
argument_list|,
name|end
argument_list|,
name|scred
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|smbfs_smb_qpathinfo
parameter_list|(
name|struct
name|smbnode
modifier|*
name|np
parameter_list|,
name|struct
name|smbfattr
modifier|*
name|fap
parameter_list|,
name|struct
name|smb_cred
modifier|*
name|scred
parameter_list|,
name|short
name|infolevel
parameter_list|)
block|{
name|struct
name|smb_share
modifier|*
name|ssp
init|=
name|np
operator|->
name|n_mount
operator|->
name|sm_share
decl_stmt|;
name|struct
name|smb_vc
modifier|*
name|vcp
init|=
name|SSTOVC
argument_list|(
name|ssp
argument_list|)
decl_stmt|;
name|struct
name|smb_t2rq
modifier|*
name|t2p
decl_stmt|;
name|int
name|error
decl_stmt|,
name|svtz
decl_stmt|,
name|timesok
init|=
literal|1
decl_stmt|;
name|struct
name|mbchain
modifier|*
name|mbp
decl_stmt|;
name|struct
name|mdchain
modifier|*
name|mdp
decl_stmt|;
name|u_int16_t
name|date
decl_stmt|,
name|time
decl_stmt|,
name|wattr
decl_stmt|;
name|int64_t
name|lint
decl_stmt|;
name|u_int32_t
name|size
decl_stmt|,
name|dattr
decl_stmt|;
name|error
operator|=
name|smb_t2_alloc
argument_list|(
name|SSTOCP
argument_list|(
name|ssp
argument_list|)
argument_list|,
name|SMB_TRANS2_QUERY_PATH_INFORMATION
argument_list|,
name|scred
argument_list|,
operator|&
name|t2p
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
name|mbp
operator|=
operator|&
name|t2p
operator|->
name|t2_tparam
expr_stmt|;
name|mb_init
argument_list|(
name|mbp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|infolevel
condition|)
block|{
if|if
condition|(
name|SMB_DIALECT
argument_list|(
name|vcp
argument_list|)
operator|<
name|SMB_DIALECT_NTLM0_12
condition|)
name|infolevel
operator|=
name|SMB_QUERY_FILE_STANDARD
expr_stmt|;
else|else
name|infolevel
operator|=
name|SMB_QUERY_FILE_BASIC_INFO
expr_stmt|;
block|}
name|mb_put_uint16le
argument_list|(
name|mbp
argument_list|,
name|infolevel
argument_list|)
expr_stmt|;
name|mb_put_uint32le
argument_list|(
name|mbp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* mb_put_uint8(mbp, SMB_DT_ASCII); specs are wrong */
name|error
operator|=
name|smbfs_fullpath
argument_list|(
name|mbp
argument_list|,
name|vcp
argument_list|,
name|np
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|smb_t2_done
argument_list|(
name|t2p
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
name|t2p
operator|->
name|t2_maxpcount
operator|=
literal|2
expr_stmt|;
name|t2p
operator|->
name|t2_maxdcount
operator|=
name|vcp
operator|->
name|vc_txmax
expr_stmt|;
name|error
operator|=
name|smb_t2_request
argument_list|(
name|t2p
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|smb_t2_done
argument_list|(
name|t2p
argument_list|)
expr_stmt|;
if|if
condition|(
name|infolevel
operator|==
name|SMB_QUERY_FILE_STANDARD
operator|||
name|error
operator|!=
name|EINVAL
condition|)
return|return
name|error
return|;
return|return
name|smbfs_smb_qpathinfo
argument_list|(
name|np
argument_list|,
name|fap
argument_list|,
name|scred
argument_list|,
name|SMB_QUERY_FILE_STANDARD
argument_list|)
return|;
block|}
name|mdp
operator|=
operator|&
name|t2p
operator|->
name|t2_rdata
expr_stmt|;
name|svtz
operator|=
name|vcp
operator|->
name|vc_sopt
operator|.
name|sv_tz
expr_stmt|;
switch|switch
condition|(
name|infolevel
condition|)
block|{
case|case
name|SMB_QUERY_FILE_STANDARD
case|:
name|timesok
operator|=
literal|0
expr_stmt|;
name|md_get_uint16le
argument_list|(
name|mdp
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|md_get_uint16le
argument_list|(
name|mdp
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* creation time */
name|md_get_uint16le
argument_list|(
name|mdp
argument_list|,
operator|&
name|date
argument_list|)
expr_stmt|;
name|md_get_uint16le
argument_list|(
name|mdp
argument_list|,
operator|&
name|time
argument_list|)
expr_stmt|;
comment|/* access time */
if|if
condition|(
name|date
operator|||
name|time
condition|)
block|{
name|timesok
operator|++
expr_stmt|;
name|smb_dos2unixtime
argument_list|(
name|date
argument_list|,
name|time
argument_list|,
literal|0
argument_list|,
name|svtz
argument_list|,
operator|&
name|fap
operator|->
name|fa_atime
argument_list|)
expr_stmt|;
block|}
name|md_get_uint16le
argument_list|(
name|mdp
argument_list|,
operator|&
name|date
argument_list|)
expr_stmt|;
name|md_get_uint16le
argument_list|(
name|mdp
argument_list|,
operator|&
name|time
argument_list|)
expr_stmt|;
comment|/* modify time */
if|if
condition|(
name|date
operator|||
name|time
condition|)
block|{
name|timesok
operator|++
expr_stmt|;
name|smb_dos2unixtime
argument_list|(
name|date
argument_list|,
name|time
argument_list|,
literal|0
argument_list|,
name|svtz
argument_list|,
operator|&
name|fap
operator|->
name|fa_mtime
argument_list|)
expr_stmt|;
block|}
name|md_get_uint32le
argument_list|(
name|mdp
argument_list|,
operator|&
name|size
argument_list|)
expr_stmt|;
name|fap
operator|->
name|fa_size
operator|=
name|size
expr_stmt|;
name|md_get_uint32
argument_list|(
name|mdp
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* allocation size */
name|md_get_uint16le
argument_list|(
name|mdp
argument_list|,
operator|&
name|wattr
argument_list|)
expr_stmt|;
name|fap
operator|->
name|fa_attr
operator|=
name|wattr
expr_stmt|;
break|break;
case|case
name|SMB_QUERY_FILE_BASIC_INFO
case|:
name|timesok
operator|=
literal|0
expr_stmt|;
name|md_get_int64
argument_list|(
name|mdp
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* creation time */
name|md_get_int64le
argument_list|(
name|mdp
argument_list|,
operator|&
name|lint
argument_list|)
expr_stmt|;
if|if
condition|(
name|lint
condition|)
block|{
name|timesok
operator|++
expr_stmt|;
name|smb_time_NT2local
argument_list|(
name|lint
argument_list|,
name|svtz
argument_list|,
operator|&
name|fap
operator|->
name|fa_atime
argument_list|)
expr_stmt|;
block|}
name|md_get_int64le
argument_list|(
name|mdp
argument_list|,
operator|&
name|lint
argument_list|)
expr_stmt|;
if|if
condition|(
name|lint
condition|)
block|{
name|timesok
operator|++
expr_stmt|;
name|smb_time_NT2local
argument_list|(
name|lint
argument_list|,
name|svtz
argument_list|,
operator|&
name|fap
operator|->
name|fa_mtime
argument_list|)
expr_stmt|;
block|}
name|md_get_int64le
argument_list|(
name|mdp
argument_list|,
operator|&
name|lint
argument_list|)
expr_stmt|;
if|if
condition|(
name|lint
condition|)
block|{
name|timesok
operator|++
expr_stmt|;
name|smb_time_NT2local
argument_list|(
name|lint
argument_list|,
name|svtz
argument_list|,
operator|&
name|fap
operator|->
name|fa_ctime
argument_list|)
expr_stmt|;
block|}
name|md_get_uint32le
argument_list|(
name|mdp
argument_list|,
operator|&
name|dattr
argument_list|)
expr_stmt|;
name|fap
operator|->
name|fa_attr
operator|=
name|dattr
expr_stmt|;
name|md_get_uint32
argument_list|(
name|mdp
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* XXX could use ALL_INFO to get size */
break|break;
default|default:
name|SMBERROR
argument_list|(
literal|"unexpected info level %d\n"
argument_list|,
name|infolevel
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
block|}
name|smb_t2_done
argument_list|(
name|t2p
argument_list|)
expr_stmt|;
comment|/* 	 * if all times are zero (observed with FAT on NT4SP6) 	 * then fall back to older info level 	 */
if|if
condition|(
operator|!
name|timesok
condition|)
block|{
if|if
condition|(
name|infolevel
operator|!=
name|SMB_QUERY_FILE_STANDARD
condition|)
return|return
name|smbfs_smb_qpathinfo
argument_list|(
name|np
argument_list|,
name|fap
argument_list|,
name|scred
argument_list|,
name|SMB_QUERY_FILE_STANDARD
argument_list|)
return|;
name|error
operator|=
name|EINVAL
expr_stmt|;
block|}
return|return
name|error
return|;
block|}
end_function

begin_function
name|int
name|smbfs_smb_statfs2
parameter_list|(
name|struct
name|smb_share
modifier|*
name|ssp
parameter_list|,
name|struct
name|statfs
modifier|*
name|sbp
parameter_list|,
name|struct
name|smb_cred
modifier|*
name|scred
parameter_list|)
block|{
name|struct
name|smb_t2rq
modifier|*
name|t2p
decl_stmt|;
name|struct
name|mbchain
modifier|*
name|mbp
decl_stmt|;
name|struct
name|mdchain
modifier|*
name|mdp
decl_stmt|;
name|u_int16_t
name|bsize
decl_stmt|;
name|u_int32_t
name|units
decl_stmt|,
name|bpu
decl_stmt|,
name|funits
decl_stmt|;
name|int
name|error
decl_stmt|;
name|error
operator|=
name|smb_t2_alloc
argument_list|(
name|SSTOCP
argument_list|(
name|ssp
argument_list|)
argument_list|,
name|SMB_TRANS2_QUERY_FS_INFORMATION
argument_list|,
name|scred
argument_list|,
operator|&
name|t2p
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
name|mbp
operator|=
operator|&
name|t2p
operator|->
name|t2_tparam
expr_stmt|;
name|mb_init
argument_list|(
name|mbp
argument_list|)
expr_stmt|;
name|mb_put_uint16le
argument_list|(
name|mbp
argument_list|,
name|SMB_INFO_ALLOCATION
argument_list|)
expr_stmt|;
name|t2p
operator|->
name|t2_maxpcount
operator|=
literal|4
expr_stmt|;
name|t2p
operator|->
name|t2_maxdcount
operator|=
literal|4
operator|*
literal|4
operator|+
literal|2
expr_stmt|;
name|error
operator|=
name|smb_t2_request
argument_list|(
name|t2p
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|smb_t2_done
argument_list|(
name|t2p
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
name|mdp
operator|=
operator|&
name|t2p
operator|->
name|t2_rdata
expr_stmt|;
name|md_get_uint32
argument_list|(
name|mdp
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* fs id */
name|md_get_uint32le
argument_list|(
name|mdp
argument_list|,
operator|&
name|bpu
argument_list|)
expr_stmt|;
name|md_get_uint32le
argument_list|(
name|mdp
argument_list|,
operator|&
name|units
argument_list|)
expr_stmt|;
name|md_get_uint32le
argument_list|(
name|mdp
argument_list|,
operator|&
name|funits
argument_list|)
expr_stmt|;
name|md_get_uint16le
argument_list|(
name|mdp
argument_list|,
operator|&
name|bsize
argument_list|)
expr_stmt|;
name|sbp
operator|->
name|f_bsize
operator|=
name|bpu
operator|*
name|bsize
expr_stmt|;
comment|/* fundamental filesystem block size */
name|sbp
operator|->
name|f_blocks
operator|=
name|units
expr_stmt|;
comment|/* total data blocks in filesystem */
name|sbp
operator|->
name|f_bfree
operator|=
name|funits
expr_stmt|;
comment|/* free blocks in fs */
name|sbp
operator|->
name|f_bavail
operator|=
name|funits
expr_stmt|;
comment|/* free blocks avail to non-superuser */
name|sbp
operator|->
name|f_files
operator|=
literal|0xffff
expr_stmt|;
comment|/* total file nodes in filesystem */
name|sbp
operator|->
name|f_ffree
operator|=
literal|0xffff
expr_stmt|;
comment|/* free file nodes in fs */
name|smb_t2_done
argument_list|(
name|t2p
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|smbfs_smb_statfs
parameter_list|(
name|struct
name|smb_share
modifier|*
name|ssp
parameter_list|,
name|struct
name|statfs
modifier|*
name|sbp
parameter_list|,
name|struct
name|smb_cred
modifier|*
name|scred
parameter_list|)
block|{
name|struct
name|smb_rq
name|rq
decl_stmt|,
modifier|*
name|rqp
init|=
operator|&
name|rq
decl_stmt|;
name|struct
name|mdchain
modifier|*
name|mdp
decl_stmt|;
name|u_int16_t
name|units
decl_stmt|,
name|bpu
decl_stmt|,
name|bsize
decl_stmt|,
name|funits
decl_stmt|;
name|int
name|error
decl_stmt|;
name|error
operator|=
name|smb_rq_init
argument_list|(
name|rqp
argument_list|,
name|SSTOCP
argument_list|(
name|ssp
argument_list|)
argument_list|,
name|SMB_COM_QUERY_INFORMATION_DISK
argument_list|,
name|scred
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
name|smb_rq_wstart
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|smb_rq_wend
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|smb_rq_bstart
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|smb_rq_bend
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|error
operator|=
name|smb_rq_simple
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|smb_rq_done
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
name|smb_rq_getreply
argument_list|(
name|rqp
argument_list|,
operator|&
name|mdp
argument_list|)
expr_stmt|;
name|md_get_uint16le
argument_list|(
name|mdp
argument_list|,
operator|&
name|units
argument_list|)
expr_stmt|;
name|md_get_uint16le
argument_list|(
name|mdp
argument_list|,
operator|&
name|bpu
argument_list|)
expr_stmt|;
name|md_get_uint16le
argument_list|(
name|mdp
argument_list|,
operator|&
name|bsize
argument_list|)
expr_stmt|;
name|md_get_uint16le
argument_list|(
name|mdp
argument_list|,
operator|&
name|funits
argument_list|)
expr_stmt|;
name|sbp
operator|->
name|f_bsize
operator|=
name|bpu
operator|*
name|bsize
expr_stmt|;
comment|/* fundamental filesystem block size */
name|sbp
operator|->
name|f_blocks
operator|=
name|units
expr_stmt|;
comment|/* total data blocks in filesystem */
name|sbp
operator|->
name|f_bfree
operator|=
name|funits
expr_stmt|;
comment|/* free blocks in fs */
name|sbp
operator|->
name|f_bavail
operator|=
name|funits
expr_stmt|;
comment|/* free blocks avail to non-superuser */
name|sbp
operator|->
name|f_files
operator|=
literal|0xffff
expr_stmt|;
comment|/* total file nodes in filesystem */
name|sbp
operator|->
name|f_ffree
operator|=
literal|0xffff
expr_stmt|;
comment|/* free file nodes in fs */
name|smb_rq_done
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|smbfs_smb_seteof
parameter_list|(
name|struct
name|smbnode
modifier|*
name|np
parameter_list|,
name|int64_t
name|newsize
parameter_list|,
name|struct
name|smb_cred
modifier|*
name|scred
parameter_list|)
block|{
name|struct
name|smb_t2rq
modifier|*
name|t2p
decl_stmt|;
name|struct
name|smb_share
modifier|*
name|ssp
init|=
name|np
operator|->
name|n_mount
operator|->
name|sm_share
decl_stmt|;
name|struct
name|mbchain
modifier|*
name|mbp
decl_stmt|;
name|int
name|error
decl_stmt|;
name|error
operator|=
name|smb_t2_alloc
argument_list|(
name|SSTOCP
argument_list|(
name|ssp
argument_list|)
argument_list|,
name|SMB_TRANS2_SET_FILE_INFORMATION
argument_list|,
name|scred
argument_list|,
operator|&
name|t2p
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
name|mbp
operator|=
operator|&
name|t2p
operator|->
name|t2_tparam
expr_stmt|;
name|mb_init
argument_list|(
name|mbp
argument_list|)
expr_stmt|;
name|mb_put_mem
argument_list|(
name|mbp
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|np
operator|->
name|n_fid
argument_list|,
literal|2
argument_list|,
name|MB_MSYSTEM
argument_list|)
expr_stmt|;
name|mb_put_uint16le
argument_list|(
name|mbp
argument_list|,
name|SMB_SET_FILE_END_OF_FILE_INFO
argument_list|)
expr_stmt|;
name|mb_put_uint32le
argument_list|(
name|mbp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mbp
operator|=
operator|&
name|t2p
operator|->
name|t2_tdata
expr_stmt|;
name|mb_init
argument_list|(
name|mbp
argument_list|)
expr_stmt|;
name|mb_put_int64le
argument_list|(
name|mbp
argument_list|,
name|newsize
argument_list|)
expr_stmt|;
name|mb_put_uint32le
argument_list|(
name|mbp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* padding */
name|mb_put_uint16le
argument_list|(
name|mbp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|t2p
operator|->
name|t2_maxpcount
operator|=
literal|2
expr_stmt|;
name|t2p
operator|->
name|t2_maxdcount
operator|=
literal|0
expr_stmt|;
name|error
operator|=
name|smb_t2_request
argument_list|(
name|t2p
argument_list|)
expr_stmt|;
name|smb_t2_done
argument_list|(
name|t2p
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|smb_smb_flush
parameter_list|(
name|struct
name|smbnode
modifier|*
name|np
parameter_list|,
name|struct
name|smb_cred
modifier|*
name|scred
parameter_list|)
block|{
name|struct
name|smb_share
modifier|*
name|ssp
init|=
name|np
operator|->
name|n_mount
operator|->
name|sm_share
decl_stmt|;
name|struct
name|smb_rq
name|rq
decl_stmt|,
modifier|*
name|rqp
init|=
operator|&
name|rq
decl_stmt|;
name|struct
name|mbchain
modifier|*
name|mbp
decl_stmt|;
name|int
name|error
decl_stmt|;
if|if
condition|(
operator|(
name|np
operator|->
name|n_flag
operator|&
name|NOPEN
operator|)
operator|==
literal|0
operator|||
operator|!
name|SMBTOV
argument_list|(
name|np
argument_list|)
operator|||
name|SMBTOV
argument_list|(
name|np
argument_list|)
operator|->
name|v_type
operator|!=
name|VREG
condition|)
return|return
literal|0
return|;
comment|/* not a regular open file */
name|error
operator|=
name|smb_rq_init
argument_list|(
name|rqp
argument_list|,
name|SSTOCP
argument_list|(
name|ssp
argument_list|)
argument_list|,
name|SMB_COM_FLUSH
argument_list|,
name|scred
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|smb_rq_getrequest
argument_list|(
name|rqp
argument_list|,
operator|&
name|mbp
argument_list|)
expr_stmt|;
name|smb_rq_wstart
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|mb_put_mem
argument_list|(
name|mbp
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|np
operator|->
name|n_fid
argument_list|,
literal|2
argument_list|,
name|MB_MSYSTEM
argument_list|)
expr_stmt|;
name|smb_rq_wend
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|smb_rq_bstart
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|smb_rq_bend
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|error
operator|=
name|smb_rq_simple
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|smb_rq_done
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
name|np
operator|->
name|n_flag
operator|&=
operator|~
name|NFLUSHWIRE
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
name|int
name|smbfs_smb_flush
parameter_list|(
name|struct
name|smbnode
modifier|*
name|np
parameter_list|,
name|struct
name|smb_cred
modifier|*
name|scred
parameter_list|)
block|{
if|if
condition|(
name|np
operator|->
name|n_flag
operator|&
name|NFLUSHWIRE
condition|)
return|return
operator|(
name|smb_smb_flush
argument_list|(
name|np
argument_list|,
name|scred
argument_list|)
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|smbfs_smb_setfsize
parameter_list|(
name|struct
name|smbnode
modifier|*
name|np
parameter_list|,
name|int
name|newsize
parameter_list|,
name|struct
name|smb_cred
modifier|*
name|scred
parameter_list|)
block|{
name|struct
name|smb_share
modifier|*
name|ssp
init|=
name|np
operator|->
name|n_mount
operator|->
name|sm_share
decl_stmt|;
name|struct
name|smb_rq
name|rq
decl_stmt|,
modifier|*
name|rqp
init|=
operator|&
name|rq
decl_stmt|;
name|struct
name|mbchain
modifier|*
name|mbp
decl_stmt|;
name|int
name|error
decl_stmt|;
if|if
condition|(
operator|!
name|smbfs_smb_seteof
argument_list|(
name|np
argument_list|,
operator|(
name|int64_t
operator|)
name|newsize
argument_list|,
name|scred
argument_list|)
condition|)
block|{
name|np
operator|->
name|n_flag
operator||=
name|NFLUSHWIRE
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|error
operator|=
name|smb_rq_init
argument_list|(
name|rqp
argument_list|,
name|SSTOCP
argument_list|(
name|ssp
argument_list|)
argument_list|,
name|SMB_COM_WRITE
argument_list|,
name|scred
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
name|smb_rq_getrequest
argument_list|(
name|rqp
argument_list|,
operator|&
name|mbp
argument_list|)
expr_stmt|;
name|smb_rq_wstart
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|mb_put_mem
argument_list|(
name|mbp
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|np
operator|->
name|n_fid
argument_list|,
literal|2
argument_list|,
name|MB_MSYSTEM
argument_list|)
expr_stmt|;
name|mb_put_uint16le
argument_list|(
name|mbp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mb_put_uint32le
argument_list|(
name|mbp
argument_list|,
name|newsize
argument_list|)
expr_stmt|;
name|mb_put_uint16le
argument_list|(
name|mbp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|smb_rq_wend
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|smb_rq_bstart
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|mb_put_uint8
argument_list|(
name|mbp
argument_list|,
name|SMB_DT_DATA
argument_list|)
expr_stmt|;
name|mb_put_uint16le
argument_list|(
name|mbp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|smb_rq_bend
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|error
operator|=
name|smb_rq_simple
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|smb_rq_done
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_function
name|int
name|smbfs_smb_query_info
parameter_list|(
name|struct
name|smbnode
modifier|*
name|np
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|int
name|len
parameter_list|,
name|struct
name|smbfattr
modifier|*
name|fap
parameter_list|,
name|struct
name|smb_cred
modifier|*
name|scred
parameter_list|)
block|{
name|struct
name|smb_rq
name|rq
decl_stmt|,
modifier|*
name|rqp
init|=
operator|&
name|rq
decl_stmt|;
name|struct
name|smb_share
modifier|*
name|ssp
init|=
name|np
operator|->
name|n_mount
operator|->
name|sm_share
decl_stmt|;
name|struct
name|mbchain
modifier|*
name|mbp
decl_stmt|;
name|struct
name|mdchain
modifier|*
name|mdp
decl_stmt|;
name|u_int8_t
name|wc
decl_stmt|;
name|int
name|error
decl_stmt|;
name|u_int16_t
name|wattr
decl_stmt|;
name|u_int32_t
name|lint
decl_stmt|;
name|error
operator|=
name|smb_rq_init
argument_list|(
name|rqp
argument_list|,
name|SSTOCP
argument_list|(
name|ssp
argument_list|)
argument_list|,
name|SMB_COM_QUERY_INFORMATION
argument_list|,
name|scred
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
name|smb_rq_getrequest
argument_list|(
name|rqp
argument_list|,
operator|&
name|mbp
argument_list|)
expr_stmt|;
name|smb_rq_wstart
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|smb_rq_wend
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|smb_rq_bstart
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|mb_put_uint8
argument_list|(
name|mbp
argument_list|,
name|SMB_DT_ASCII
argument_list|)
expr_stmt|;
do|do
block|{
name|error
operator|=
name|smbfs_fullpath
argument_list|(
name|mbp
argument_list|,
name|SSTOVC
argument_list|(
name|ssp
argument_list|)
argument_list|,
name|np
argument_list|,
name|name
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
break|break;
name|smb_rq_bend
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|error
operator|=
name|smb_rq_simple
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
break|break;
name|smb_rq_getreply
argument_list|(
name|rqp
argument_list|,
operator|&
name|mdp
argument_list|)
expr_stmt|;
if|if
condition|(
name|md_get_uint8
argument_list|(
name|mdp
argument_list|,
operator|&
name|wc
argument_list|)
operator|!=
literal|0
operator|||
name|wc
operator|!=
literal|10
condition|)
block|{
name|error
operator|=
name|EBADRPC
expr_stmt|;
break|break;
block|}
name|md_get_uint16le
argument_list|(
name|mdp
argument_list|,
operator|&
name|wattr
argument_list|)
expr_stmt|;
name|fap
operator|->
name|fa_attr
operator|=
name|wattr
expr_stmt|;
comment|/* 		 * Be careful using the time returned here, as 		 * with FAT on NT4SP6, at least, the time returned is low 		 * 32 bits of 100s of nanoseconds (since 1601) so it rolls 		 * over about every seven minutes! 		 */
name|md_get_uint32le
argument_list|(
name|mdp
argument_list|,
operator|&
name|lint
argument_list|)
expr_stmt|;
comment|/* specs: secs since 1970 */
if|if
condition|(
name|lint
condition|)
comment|/* avoid bogus zero returns */
name|smb_time_server2local
argument_list|(
name|lint
argument_list|,
name|SSTOVC
argument_list|(
name|ssp
argument_list|)
operator|->
name|vc_sopt
operator|.
name|sv_tz
argument_list|,
operator|&
name|fap
operator|->
name|fa_mtime
argument_list|)
expr_stmt|;
name|md_get_uint32le
argument_list|(
name|mdp
argument_list|,
operator|&
name|lint
argument_list|)
expr_stmt|;
name|fap
operator|->
name|fa_size
operator|=
name|lint
expr_stmt|;
block|}
do|while
condition|(
literal|0
condition|)
do|;
name|smb_rq_done
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_comment
comment|/*  * Set DOS file attributes. mtime should be NULL for dialects above lm10  */
end_comment

begin_function
name|int
name|smbfs_smb_setpattr
parameter_list|(
name|struct
name|smbnode
modifier|*
name|np
parameter_list|,
name|u_int16_t
name|attr
parameter_list|,
name|struct
name|timespec
modifier|*
name|mtime
parameter_list|,
name|struct
name|smb_cred
modifier|*
name|scred
parameter_list|)
block|{
name|struct
name|smb_rq
name|rq
decl_stmt|,
modifier|*
name|rqp
init|=
operator|&
name|rq
decl_stmt|;
name|struct
name|smb_share
modifier|*
name|ssp
init|=
name|np
operator|->
name|n_mount
operator|->
name|sm_share
decl_stmt|;
name|struct
name|mbchain
modifier|*
name|mbp
decl_stmt|;
name|u_long
name|time
decl_stmt|;
name|int
name|error
decl_stmt|,
name|svtz
decl_stmt|;
name|error
operator|=
name|smb_rq_init
argument_list|(
name|rqp
argument_list|,
name|SSTOCP
argument_list|(
name|ssp
argument_list|)
argument_list|,
name|SMB_COM_SET_INFORMATION
argument_list|,
name|scred
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
name|svtz
operator|=
name|SSTOVC
argument_list|(
name|ssp
argument_list|)
operator|->
name|vc_sopt
operator|.
name|sv_tz
expr_stmt|;
name|smb_rq_getrequest
argument_list|(
name|rqp
argument_list|,
operator|&
name|mbp
argument_list|)
expr_stmt|;
name|smb_rq_wstart
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|mb_put_uint16le
argument_list|(
name|mbp
argument_list|,
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|mtime
condition|)
block|{
name|smb_time_local2server
argument_list|(
name|mtime
argument_list|,
name|svtz
argument_list|,
operator|&
name|time
argument_list|)
expr_stmt|;
block|}
else|else
name|time
operator|=
literal|0
expr_stmt|;
name|mb_put_uint32le
argument_list|(
name|mbp
argument_list|,
name|time
argument_list|)
expr_stmt|;
comment|/* mtime */
name|mb_put_mem
argument_list|(
name|mbp
argument_list|,
name|NULL
argument_list|,
literal|5
operator|*
literal|2
argument_list|,
name|MB_MZERO
argument_list|)
expr_stmt|;
name|smb_rq_wend
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|smb_rq_bstart
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|mb_put_uint8
argument_list|(
name|mbp
argument_list|,
name|SMB_DT_ASCII
argument_list|)
expr_stmt|;
do|do
block|{
name|error
operator|=
name|smbfs_fullpath
argument_list|(
name|mbp
argument_list|,
name|SSTOVC
argument_list|(
name|ssp
argument_list|)
argument_list|,
name|np
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
break|break;
name|mb_put_uint8
argument_list|(
name|mbp
argument_list|,
name|SMB_DT_ASCII
argument_list|)
expr_stmt|;
name|mb_put_uint8
argument_list|(
name|mbp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|smb_rq_bend
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|error
operator|=
name|smb_rq_simple
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|SMBERROR
argument_list|(
literal|"%d\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
break|break;
block|}
do|while
condition|(
literal|0
condition|)
do|;
name|smb_rq_done
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_comment
comment|/*  * Note, win95 doesn't support this call.  */
end_comment

begin_function
name|int
name|smbfs_smb_setptime2
parameter_list|(
name|struct
name|smbnode
modifier|*
name|np
parameter_list|,
name|struct
name|timespec
modifier|*
name|mtime
parameter_list|,
name|struct
name|timespec
modifier|*
name|atime
parameter_list|,
name|int
name|attr
parameter_list|,
name|struct
name|smb_cred
modifier|*
name|scred
parameter_list|)
block|{
name|struct
name|smb_t2rq
modifier|*
name|t2p
decl_stmt|;
name|struct
name|smb_share
modifier|*
name|ssp
init|=
name|np
operator|->
name|n_mount
operator|->
name|sm_share
decl_stmt|;
name|struct
name|smb_vc
modifier|*
name|vcp
init|=
name|SSTOVC
argument_list|(
name|ssp
argument_list|)
decl_stmt|;
name|struct
name|mbchain
modifier|*
name|mbp
decl_stmt|;
name|u_int16_t
name|date
decl_stmt|,
name|time
decl_stmt|;
name|int
name|error
decl_stmt|,
name|tzoff
decl_stmt|;
name|error
operator|=
name|smb_t2_alloc
argument_list|(
name|SSTOCP
argument_list|(
name|ssp
argument_list|)
argument_list|,
name|SMB_TRANS2_SET_PATH_INFORMATION
argument_list|,
name|scred
argument_list|,
operator|&
name|t2p
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
name|mbp
operator|=
operator|&
name|t2p
operator|->
name|t2_tparam
expr_stmt|;
name|mb_init
argument_list|(
name|mbp
argument_list|)
expr_stmt|;
name|mb_put_uint16le
argument_list|(
name|mbp
argument_list|,
name|SMB_INFO_STANDARD
argument_list|)
expr_stmt|;
name|mb_put_uint32le
argument_list|(
name|mbp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* MBZ */
comment|/* mb_put_uint8(mbp, SMB_DT_ASCII); specs incorrect */
name|error
operator|=
name|smbfs_fullpath
argument_list|(
name|mbp
argument_list|,
name|vcp
argument_list|,
name|np
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|smb_t2_done
argument_list|(
name|t2p
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
name|tzoff
operator|=
name|vcp
operator|->
name|vc_sopt
operator|.
name|sv_tz
expr_stmt|;
name|mbp
operator|=
operator|&
name|t2p
operator|->
name|t2_tdata
expr_stmt|;
name|mb_init
argument_list|(
name|mbp
argument_list|)
expr_stmt|;
name|mb_put_uint32le
argument_list|(
name|mbp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* creation time */
if|if
condition|(
name|atime
condition|)
name|smb_time_unix2dos
argument_list|(
name|atime
argument_list|,
name|tzoff
argument_list|,
operator|&
name|date
argument_list|,
operator|&
name|time
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
else|else
name|time
operator|=
name|date
operator|=
literal|0
expr_stmt|;
name|mb_put_uint16le
argument_list|(
name|mbp
argument_list|,
name|date
argument_list|)
expr_stmt|;
name|mb_put_uint16le
argument_list|(
name|mbp
argument_list|,
name|time
argument_list|)
expr_stmt|;
if|if
condition|(
name|mtime
condition|)
name|smb_time_unix2dos
argument_list|(
name|mtime
argument_list|,
name|tzoff
argument_list|,
operator|&
name|date
argument_list|,
operator|&
name|time
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
else|else
name|time
operator|=
name|date
operator|=
literal|0
expr_stmt|;
name|mb_put_uint16le
argument_list|(
name|mbp
argument_list|,
name|date
argument_list|)
expr_stmt|;
name|mb_put_uint16le
argument_list|(
name|mbp
argument_list|,
name|time
argument_list|)
expr_stmt|;
name|mb_put_uint32le
argument_list|(
name|mbp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* file size */
name|mb_put_uint32le
argument_list|(
name|mbp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* allocation unit size */
name|mb_put_uint16le
argument_list|(
name|mbp
argument_list|,
name|attr
argument_list|)
expr_stmt|;
comment|/* DOS attr */
name|mb_put_uint32le
argument_list|(
name|mbp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* EA size */
name|t2p
operator|->
name|t2_maxpcount
operator|=
literal|5
operator|*
literal|2
expr_stmt|;
name|t2p
operator|->
name|t2_maxdcount
operator|=
name|vcp
operator|->
name|vc_txmax
expr_stmt|;
name|error
operator|=
name|smb_t2_request
argument_list|(
name|t2p
argument_list|)
expr_stmt|;
name|smb_t2_done
argument_list|(
name|t2p
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_comment
comment|/*  * NT level. Specially for win9x  */
end_comment

begin_function
name|int
name|smbfs_smb_setpattrNT
parameter_list|(
name|struct
name|smbnode
modifier|*
name|np
parameter_list|,
name|u_short
name|attr
parameter_list|,
name|struct
name|timespec
modifier|*
name|mtime
parameter_list|,
name|struct
name|timespec
modifier|*
name|atime
parameter_list|,
name|struct
name|smb_cred
modifier|*
name|scred
parameter_list|)
block|{
name|struct
name|smb_t2rq
modifier|*
name|t2p
decl_stmt|;
name|struct
name|smb_share
modifier|*
name|ssp
init|=
name|np
operator|->
name|n_mount
operator|->
name|sm_share
decl_stmt|;
name|struct
name|smb_vc
modifier|*
name|vcp
init|=
name|SSTOVC
argument_list|(
name|ssp
argument_list|)
decl_stmt|;
name|struct
name|mbchain
modifier|*
name|mbp
decl_stmt|;
name|int64_t
name|tm
decl_stmt|;
name|int
name|error
decl_stmt|,
name|tzoff
decl_stmt|;
name|error
operator|=
name|smb_t2_alloc
argument_list|(
name|SSTOCP
argument_list|(
name|ssp
argument_list|)
argument_list|,
name|SMB_TRANS2_SET_PATH_INFORMATION
argument_list|,
name|scred
argument_list|,
operator|&
name|t2p
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
name|mbp
operator|=
operator|&
name|t2p
operator|->
name|t2_tparam
expr_stmt|;
name|mb_init
argument_list|(
name|mbp
argument_list|)
expr_stmt|;
name|mb_put_uint16le
argument_list|(
name|mbp
argument_list|,
name|SMB_SET_FILE_BASIC_INFO
argument_list|)
expr_stmt|;
name|mb_put_uint32le
argument_list|(
name|mbp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* MBZ */
comment|/* mb_put_uint8(mbp, SMB_DT_ASCII); specs incorrect */
name|error
operator|=
name|smbfs_fullpath
argument_list|(
name|mbp
argument_list|,
name|vcp
argument_list|,
name|np
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|smb_t2_done
argument_list|(
name|t2p
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
name|tzoff
operator|=
name|vcp
operator|->
name|vc_sopt
operator|.
name|sv_tz
expr_stmt|;
name|mbp
operator|=
operator|&
name|t2p
operator|->
name|t2_tdata
expr_stmt|;
name|mb_init
argument_list|(
name|mbp
argument_list|)
expr_stmt|;
name|mb_put_int64le
argument_list|(
name|mbp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* creation time */
if|if
condition|(
name|atime
condition|)
block|{
name|smb_time_local2NT
argument_list|(
name|atime
argument_list|,
name|tzoff
argument_list|,
operator|&
name|tm
argument_list|)
expr_stmt|;
block|}
else|else
name|tm
operator|=
literal|0
expr_stmt|;
name|mb_put_int64le
argument_list|(
name|mbp
argument_list|,
name|tm
argument_list|)
expr_stmt|;
if|if
condition|(
name|mtime
condition|)
block|{
name|smb_time_local2NT
argument_list|(
name|mtime
argument_list|,
name|tzoff
argument_list|,
operator|&
name|tm
argument_list|)
expr_stmt|;
block|}
else|else
name|tm
operator|=
literal|0
expr_stmt|;
name|mb_put_int64le
argument_list|(
name|mbp
argument_list|,
name|tm
argument_list|)
expr_stmt|;
name|mb_put_int64le
argument_list|(
name|mbp
argument_list|,
name|tm
argument_list|)
expr_stmt|;
comment|/* change time */
name|mb_put_uint32le
argument_list|(
name|mbp
argument_list|,
name|attr
argument_list|)
expr_stmt|;
comment|/* attr */
name|t2p
operator|->
name|t2_maxpcount
operator|=
literal|24
expr_stmt|;
name|t2p
operator|->
name|t2_maxdcount
operator|=
literal|56
expr_stmt|;
name|error
operator|=
name|smb_t2_request
argument_list|(
name|t2p
argument_list|)
expr_stmt|;
name|smb_t2_done
argument_list|(
name|t2p
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_comment
comment|/*  * Set file atime and mtime. Doesn't supported by core dialect.  */
end_comment

begin_function
name|int
name|smbfs_smb_setftime
parameter_list|(
name|struct
name|smbnode
modifier|*
name|np
parameter_list|,
name|struct
name|timespec
modifier|*
name|mtime
parameter_list|,
name|struct
name|timespec
modifier|*
name|atime
parameter_list|,
name|struct
name|smb_cred
modifier|*
name|scred
parameter_list|)
block|{
name|struct
name|smb_rq
name|rq
decl_stmt|,
modifier|*
name|rqp
init|=
operator|&
name|rq
decl_stmt|;
name|struct
name|smb_share
modifier|*
name|ssp
init|=
name|np
operator|->
name|n_mount
operator|->
name|sm_share
decl_stmt|;
name|struct
name|mbchain
modifier|*
name|mbp
decl_stmt|;
name|u_int16_t
name|date
decl_stmt|,
name|time
decl_stmt|;
name|int
name|error
decl_stmt|,
name|tzoff
decl_stmt|;
name|error
operator|=
name|smb_rq_init
argument_list|(
name|rqp
argument_list|,
name|SSTOCP
argument_list|(
name|ssp
argument_list|)
argument_list|,
name|SMB_COM_SET_INFORMATION2
argument_list|,
name|scred
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
name|tzoff
operator|=
name|SSTOVC
argument_list|(
name|ssp
argument_list|)
operator|->
name|vc_sopt
operator|.
name|sv_tz
expr_stmt|;
name|smb_rq_getrequest
argument_list|(
name|rqp
argument_list|,
operator|&
name|mbp
argument_list|)
expr_stmt|;
name|smb_rq_wstart
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|mb_put_mem
argument_list|(
name|mbp
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|np
operator|->
name|n_fid
argument_list|,
literal|2
argument_list|,
name|MB_MSYSTEM
argument_list|)
expr_stmt|;
name|mb_put_uint32le
argument_list|(
name|mbp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* creation time */
if|if
condition|(
name|atime
condition|)
name|smb_time_unix2dos
argument_list|(
name|atime
argument_list|,
name|tzoff
argument_list|,
operator|&
name|date
argument_list|,
operator|&
name|time
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
else|else
name|time
operator|=
name|date
operator|=
literal|0
expr_stmt|;
name|mb_put_uint16le
argument_list|(
name|mbp
argument_list|,
name|date
argument_list|)
expr_stmt|;
name|mb_put_uint16le
argument_list|(
name|mbp
argument_list|,
name|time
argument_list|)
expr_stmt|;
if|if
condition|(
name|mtime
condition|)
name|smb_time_unix2dos
argument_list|(
name|mtime
argument_list|,
name|tzoff
argument_list|,
operator|&
name|date
argument_list|,
operator|&
name|time
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
else|else
name|time
operator|=
name|date
operator|=
literal|0
expr_stmt|;
name|mb_put_uint16le
argument_list|(
name|mbp
argument_list|,
name|date
argument_list|)
expr_stmt|;
name|mb_put_uint16le
argument_list|(
name|mbp
argument_list|,
name|time
argument_list|)
expr_stmt|;
name|smb_rq_wend
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|smb_rq_bstart
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|smb_rq_bend
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|error
operator|=
name|smb_rq_simple
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|SMBSDEBUG
argument_list|(
literal|"%d\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|smb_rq_done
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_comment
comment|/*  * Set DOS file attributes.  * Looks like this call can be used only if CAP_NT_SMBS bit is on.  */
end_comment

begin_function
name|int
name|smbfs_smb_setfattrNT
parameter_list|(
name|struct
name|smbnode
modifier|*
name|np
parameter_list|,
name|u_int16_t
name|attr
parameter_list|,
name|struct
name|timespec
modifier|*
name|mtime
parameter_list|,
name|struct
name|timespec
modifier|*
name|atime
parameter_list|,
name|struct
name|smb_cred
modifier|*
name|scred
parameter_list|)
block|{
name|struct
name|smb_t2rq
modifier|*
name|t2p
decl_stmt|;
name|struct
name|smb_share
modifier|*
name|ssp
init|=
name|np
operator|->
name|n_mount
operator|->
name|sm_share
decl_stmt|;
name|struct
name|mbchain
modifier|*
name|mbp
decl_stmt|;
name|int64_t
name|tm
decl_stmt|;
name|int
name|error
decl_stmt|,
name|svtz
decl_stmt|;
name|error
operator|=
name|smb_t2_alloc
argument_list|(
name|SSTOCP
argument_list|(
name|ssp
argument_list|)
argument_list|,
name|SMB_TRANS2_SET_FILE_INFORMATION
argument_list|,
name|scred
argument_list|,
operator|&
name|t2p
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
name|svtz
operator|=
name|SSTOVC
argument_list|(
name|ssp
argument_list|)
operator|->
name|vc_sopt
operator|.
name|sv_tz
expr_stmt|;
name|mbp
operator|=
operator|&
name|t2p
operator|->
name|t2_tparam
expr_stmt|;
name|mb_init
argument_list|(
name|mbp
argument_list|)
expr_stmt|;
name|mb_put_mem
argument_list|(
name|mbp
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|np
operator|->
name|n_fid
argument_list|,
literal|2
argument_list|,
name|MB_MSYSTEM
argument_list|)
expr_stmt|;
name|mb_put_uint16le
argument_list|(
name|mbp
argument_list|,
name|SMB_SET_FILE_BASIC_INFO
argument_list|)
expr_stmt|;
name|mb_put_uint32le
argument_list|(
name|mbp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mbp
operator|=
operator|&
name|t2p
operator|->
name|t2_tdata
expr_stmt|;
name|mb_init
argument_list|(
name|mbp
argument_list|)
expr_stmt|;
name|mb_put_int64le
argument_list|(
name|mbp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* creation time */
if|if
condition|(
name|atime
condition|)
block|{
name|smb_time_local2NT
argument_list|(
name|atime
argument_list|,
name|svtz
argument_list|,
operator|&
name|tm
argument_list|)
expr_stmt|;
block|}
else|else
name|tm
operator|=
literal|0
expr_stmt|;
name|mb_put_int64le
argument_list|(
name|mbp
argument_list|,
name|tm
argument_list|)
expr_stmt|;
if|if
condition|(
name|mtime
condition|)
block|{
name|smb_time_local2NT
argument_list|(
name|mtime
argument_list|,
name|svtz
argument_list|,
operator|&
name|tm
argument_list|)
expr_stmt|;
block|}
else|else
name|tm
operator|=
literal|0
expr_stmt|;
name|mb_put_int64le
argument_list|(
name|mbp
argument_list|,
name|tm
argument_list|)
expr_stmt|;
name|mb_put_int64le
argument_list|(
name|mbp
argument_list|,
name|tm
argument_list|)
expr_stmt|;
comment|/* change time */
name|mb_put_uint16le
argument_list|(
name|mbp
argument_list|,
name|attr
argument_list|)
expr_stmt|;
name|mb_put_uint32le
argument_list|(
name|mbp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* padding */
name|mb_put_uint16le
argument_list|(
name|mbp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|t2p
operator|->
name|t2_maxpcount
operator|=
literal|2
expr_stmt|;
name|t2p
operator|->
name|t2_maxdcount
operator|=
literal|0
expr_stmt|;
name|error
operator|=
name|smb_t2_request
argument_list|(
name|t2p
argument_list|)
expr_stmt|;
name|smb_t2_done
argument_list|(
name|t2p
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_function
name|int
name|smbfs_smb_open
parameter_list|(
name|struct
name|smbnode
modifier|*
name|np
parameter_list|,
name|int
name|accmode
parameter_list|,
name|struct
name|smb_cred
modifier|*
name|scred
parameter_list|)
block|{
name|struct
name|smb_rq
name|rq
decl_stmt|,
modifier|*
name|rqp
init|=
operator|&
name|rq
decl_stmt|;
name|struct
name|smb_share
modifier|*
name|ssp
init|=
name|np
operator|->
name|n_mount
operator|->
name|sm_share
decl_stmt|;
name|struct
name|mbchain
modifier|*
name|mbp
decl_stmt|;
name|struct
name|mdchain
modifier|*
name|mdp
decl_stmt|;
name|u_int8_t
name|wc
decl_stmt|;
name|u_int16_t
name|fid
decl_stmt|,
name|wattr
decl_stmt|,
name|grantedmode
decl_stmt|;
name|int
name|error
decl_stmt|;
name|error
operator|=
name|smb_rq_init
argument_list|(
name|rqp
argument_list|,
name|SSTOCP
argument_list|(
name|ssp
argument_list|)
argument_list|,
name|SMB_COM_OPEN
argument_list|,
name|scred
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
name|smb_rq_getrequest
argument_list|(
name|rqp
argument_list|,
operator|&
name|mbp
argument_list|)
expr_stmt|;
name|smb_rq_wstart
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|mb_put_uint16le
argument_list|(
name|mbp
argument_list|,
name|accmode
argument_list|)
expr_stmt|;
name|mb_put_uint16le
argument_list|(
name|mbp
argument_list|,
name|SMB_FA_SYSTEM
operator||
name|SMB_FA_HIDDEN
argument_list|)
expr_stmt|;
name|smb_rq_wend
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|smb_rq_bstart
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|mb_put_uint8
argument_list|(
name|mbp
argument_list|,
name|SMB_DT_ASCII
argument_list|)
expr_stmt|;
do|do
block|{
name|error
operator|=
name|smbfs_fullpath
argument_list|(
name|mbp
argument_list|,
name|SSTOVC
argument_list|(
name|ssp
argument_list|)
argument_list|,
name|np
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
break|break;
name|smb_rq_bend
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|error
operator|=
name|smb_rq_simple
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
break|break;
name|smb_rq_getreply
argument_list|(
name|rqp
argument_list|,
operator|&
name|mdp
argument_list|)
expr_stmt|;
if|if
condition|(
name|md_get_uint8
argument_list|(
name|mdp
argument_list|,
operator|&
name|wc
argument_list|)
operator|!=
literal|0
operator|||
name|wc
operator|!=
literal|7
condition|)
block|{
name|error
operator|=
name|EBADRPC
expr_stmt|;
break|break;
block|}
name|md_get_uint16
argument_list|(
name|mdp
argument_list|,
operator|&
name|fid
argument_list|)
expr_stmt|;
name|md_get_uint16le
argument_list|(
name|mdp
argument_list|,
operator|&
name|wattr
argument_list|)
expr_stmt|;
name|md_get_uint32
argument_list|(
name|mdp
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* mtime */
name|md_get_uint32
argument_list|(
name|mdp
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* fsize */
name|md_get_uint16le
argument_list|(
name|mdp
argument_list|,
operator|&
name|grantedmode
argument_list|)
expr_stmt|;
comment|/* 		 * TODO: refresh attributes from this reply 		 */
block|}
do|while
condition|(
literal|0
condition|)
do|;
name|smb_rq_done
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
name|np
operator|->
name|n_fid
operator|=
name|fid
expr_stmt|;
name|np
operator|->
name|n_rwstate
operator|=
name|grantedmode
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|smbfs_smb_close
parameter_list|(
name|struct
name|smb_share
modifier|*
name|ssp
parameter_list|,
name|u_int16_t
name|fid
parameter_list|,
name|struct
name|timespec
modifier|*
name|mtime
parameter_list|,
name|struct
name|smb_cred
modifier|*
name|scred
parameter_list|)
block|{
name|struct
name|smb_rq
name|rq
decl_stmt|,
modifier|*
name|rqp
init|=
operator|&
name|rq
decl_stmt|;
name|struct
name|mbchain
modifier|*
name|mbp
decl_stmt|;
name|u_long
name|time
decl_stmt|;
name|int
name|error
decl_stmt|;
name|error
operator|=
name|smb_rq_init
argument_list|(
name|rqp
argument_list|,
name|SSTOCP
argument_list|(
name|ssp
argument_list|)
argument_list|,
name|SMB_COM_CLOSE
argument_list|,
name|scred
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
name|smb_rq_getrequest
argument_list|(
name|rqp
argument_list|,
operator|&
name|mbp
argument_list|)
expr_stmt|;
name|smb_rq_wstart
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|mb_put_mem
argument_list|(
name|mbp
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|fid
argument_list|,
sizeof|sizeof
argument_list|(
name|fid
argument_list|)
argument_list|,
name|MB_MSYSTEM
argument_list|)
expr_stmt|;
if|if
condition|(
name|mtime
condition|)
block|{
name|smb_time_local2server
argument_list|(
name|mtime
argument_list|,
name|SSTOVC
argument_list|(
name|ssp
argument_list|)
operator|->
name|vc_sopt
operator|.
name|sv_tz
argument_list|,
operator|&
name|time
argument_list|)
expr_stmt|;
block|}
else|else
name|time
operator|=
literal|0
expr_stmt|;
name|mb_put_uint32le
argument_list|(
name|mbp
argument_list|,
name|time
argument_list|)
expr_stmt|;
name|smb_rq_wend
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|smb_rq_bstart
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|smb_rq_bend
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|error
operator|=
name|smb_rq_simple
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|smb_rq_done
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_function
name|int
name|smbfs_smb_create
parameter_list|(
name|struct
name|smbnode
modifier|*
name|dnp
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|int
name|nmlen
parameter_list|,
name|struct
name|smb_cred
modifier|*
name|scred
parameter_list|)
block|{
name|struct
name|smb_rq
name|rq
decl_stmt|,
modifier|*
name|rqp
init|=
operator|&
name|rq
decl_stmt|;
name|struct
name|smb_share
modifier|*
name|ssp
init|=
name|dnp
operator|->
name|n_mount
operator|->
name|sm_share
decl_stmt|;
name|struct
name|mbchain
modifier|*
name|mbp
decl_stmt|;
name|struct
name|mdchain
modifier|*
name|mdp
decl_stmt|;
name|struct
name|timespec
name|ctime
decl_stmt|;
name|u_int8_t
name|wc
decl_stmt|;
name|u_int16_t
name|fid
decl_stmt|;
name|u_long
name|tm
decl_stmt|;
name|int
name|error
decl_stmt|;
name|error
operator|=
name|smb_rq_init
argument_list|(
name|rqp
argument_list|,
name|SSTOCP
argument_list|(
name|ssp
argument_list|)
argument_list|,
name|SMB_COM_CREATE
argument_list|,
name|scred
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
name|smb_rq_getrequest
argument_list|(
name|rqp
argument_list|,
operator|&
name|mbp
argument_list|)
expr_stmt|;
name|smb_rq_wstart
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|mb_put_uint16le
argument_list|(
name|mbp
argument_list|,
name|SMB_FA_ARCHIVE
argument_list|)
expr_stmt|;
comment|/* attributes  */
name|nanotime
argument_list|(
operator|&
name|ctime
argument_list|)
expr_stmt|;
name|smb_time_local2server
argument_list|(
operator|&
name|ctime
argument_list|,
name|SSTOVC
argument_list|(
name|ssp
argument_list|)
operator|->
name|vc_sopt
operator|.
name|sv_tz
argument_list|,
operator|&
name|tm
argument_list|)
expr_stmt|;
name|mb_put_uint32le
argument_list|(
name|mbp
argument_list|,
name|tm
argument_list|)
expr_stmt|;
name|smb_rq_wend
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|smb_rq_bstart
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|mb_put_uint8
argument_list|(
name|mbp
argument_list|,
name|SMB_DT_ASCII
argument_list|)
expr_stmt|;
name|error
operator|=
name|smbfs_fullpath
argument_list|(
name|mbp
argument_list|,
name|SSTOVC
argument_list|(
name|ssp
argument_list|)
argument_list|,
name|dnp
argument_list|,
name|name
argument_list|,
name|nmlen
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
block|{
name|smb_rq_bend
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|error
operator|=
name|smb_rq_simple
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
block|{
name|smb_rq_getreply
argument_list|(
name|rqp
argument_list|,
operator|&
name|mdp
argument_list|)
expr_stmt|;
name|md_get_uint8
argument_list|(
name|mdp
argument_list|,
operator|&
name|wc
argument_list|)
expr_stmt|;
if|if
condition|(
name|wc
operator|==
literal|1
condition|)
name|md_get_uint16
argument_list|(
name|mdp
argument_list|,
operator|&
name|fid
argument_list|)
expr_stmt|;
else|else
name|error
operator|=
name|EBADRPC
expr_stmt|;
block|}
block|}
name|smb_rq_done
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
name|smbfs_smb_close
argument_list|(
name|ssp
argument_list|,
name|fid
argument_list|,
operator|&
name|ctime
argument_list|,
name|scred
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_function
name|int
name|smbfs_smb_delete
parameter_list|(
name|struct
name|smbnode
modifier|*
name|np
parameter_list|,
name|struct
name|smb_cred
modifier|*
name|scred
parameter_list|)
block|{
name|struct
name|smb_rq
name|rq
decl_stmt|,
modifier|*
name|rqp
init|=
operator|&
name|rq
decl_stmt|;
name|struct
name|smb_share
modifier|*
name|ssp
init|=
name|np
operator|->
name|n_mount
operator|->
name|sm_share
decl_stmt|;
name|struct
name|mbchain
modifier|*
name|mbp
decl_stmt|;
name|int
name|error
decl_stmt|;
name|error
operator|=
name|smb_rq_init
argument_list|(
name|rqp
argument_list|,
name|SSTOCP
argument_list|(
name|ssp
argument_list|)
argument_list|,
name|SMB_COM_DELETE
argument_list|,
name|scred
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
name|smb_rq_getrequest
argument_list|(
name|rqp
argument_list|,
operator|&
name|mbp
argument_list|)
expr_stmt|;
name|smb_rq_wstart
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|mb_put_uint16le
argument_list|(
name|mbp
argument_list|,
name|SMB_FA_SYSTEM
operator||
name|SMB_FA_HIDDEN
argument_list|)
expr_stmt|;
name|smb_rq_wend
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|smb_rq_bstart
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|mb_put_uint8
argument_list|(
name|mbp
argument_list|,
name|SMB_DT_ASCII
argument_list|)
expr_stmt|;
name|error
operator|=
name|smbfs_fullpath
argument_list|(
name|mbp
argument_list|,
name|SSTOVC
argument_list|(
name|ssp
argument_list|)
argument_list|,
name|np
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
block|{
name|smb_rq_bend
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|error
operator|=
name|smb_rq_simple
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
block|}
name|smb_rq_done
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_function
name|int
name|smbfs_smb_rename
parameter_list|(
name|struct
name|smbnode
modifier|*
name|src
parameter_list|,
name|struct
name|smbnode
modifier|*
name|tdnp
parameter_list|,
specifier|const
name|char
modifier|*
name|tname
parameter_list|,
name|int
name|tnmlen
parameter_list|,
name|struct
name|smb_cred
modifier|*
name|scred
parameter_list|)
block|{
name|struct
name|smb_rq
name|rq
decl_stmt|,
modifier|*
name|rqp
init|=
operator|&
name|rq
decl_stmt|;
name|struct
name|smb_share
modifier|*
name|ssp
init|=
name|src
operator|->
name|n_mount
operator|->
name|sm_share
decl_stmt|;
name|struct
name|mbchain
modifier|*
name|mbp
decl_stmt|;
name|int
name|error
decl_stmt|;
name|error
operator|=
name|smb_rq_init
argument_list|(
name|rqp
argument_list|,
name|SSTOCP
argument_list|(
name|ssp
argument_list|)
argument_list|,
name|SMB_COM_RENAME
argument_list|,
name|scred
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
name|smb_rq_getrequest
argument_list|(
name|rqp
argument_list|,
operator|&
name|mbp
argument_list|)
expr_stmt|;
name|smb_rq_wstart
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|mb_put_uint16le
argument_list|(
name|mbp
argument_list|,
name|SMB_FA_SYSTEM
operator||
name|SMB_FA_HIDDEN
argument_list|)
expr_stmt|;
name|smb_rq_wend
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|smb_rq_bstart
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|mb_put_uint8
argument_list|(
name|mbp
argument_list|,
name|SMB_DT_ASCII
argument_list|)
expr_stmt|;
do|do
block|{
name|error
operator|=
name|smbfs_fullpath
argument_list|(
name|mbp
argument_list|,
name|SSTOVC
argument_list|(
name|ssp
argument_list|)
argument_list|,
name|src
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
break|break;
name|mb_put_uint8
argument_list|(
name|mbp
argument_list|,
name|SMB_DT_ASCII
argument_list|)
expr_stmt|;
name|error
operator|=
name|smbfs_fullpath
argument_list|(
name|mbp
argument_list|,
name|SSTOVC
argument_list|(
name|ssp
argument_list|)
argument_list|,
name|tdnp
argument_list|,
name|tname
argument_list|,
name|tnmlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
break|break;
name|smb_rq_bend
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|error
operator|=
name|smb_rq_simple
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
literal|0
condition|)
do|;
name|smb_rq_done
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_function
name|int
name|smbfs_smb_move
parameter_list|(
name|struct
name|smbnode
modifier|*
name|src
parameter_list|,
name|struct
name|smbnode
modifier|*
name|tdnp
parameter_list|,
specifier|const
name|char
modifier|*
name|tname
parameter_list|,
name|int
name|tnmlen
parameter_list|,
name|u_int16_t
name|flags
parameter_list|,
name|struct
name|smb_cred
modifier|*
name|scred
parameter_list|)
block|{
name|struct
name|smb_rq
name|rq
decl_stmt|,
modifier|*
name|rqp
init|=
operator|&
name|rq
decl_stmt|;
name|struct
name|smb_share
modifier|*
name|ssp
init|=
name|src
operator|->
name|n_mount
operator|->
name|sm_share
decl_stmt|;
name|struct
name|mbchain
modifier|*
name|mbp
decl_stmt|;
name|int
name|error
decl_stmt|;
name|error
operator|=
name|smb_rq_init
argument_list|(
name|rqp
argument_list|,
name|SSTOCP
argument_list|(
name|ssp
argument_list|)
argument_list|,
name|SMB_COM_MOVE
argument_list|,
name|scred
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
name|smb_rq_getrequest
argument_list|(
name|rqp
argument_list|,
operator|&
name|mbp
argument_list|)
expr_stmt|;
name|smb_rq_wstart
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|mb_put_uint16le
argument_list|(
name|mbp
argument_list|,
name|SMB_TID_UNKNOWN
argument_list|)
expr_stmt|;
name|mb_put_uint16le
argument_list|(
name|mbp
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
comment|/* delete target file */
name|mb_put_uint16le
argument_list|(
name|mbp
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|smb_rq_wend
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|smb_rq_bstart
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|mb_put_uint8
argument_list|(
name|mbp
argument_list|,
name|SMB_DT_ASCII
argument_list|)
expr_stmt|;
do|do
block|{
name|error
operator|=
name|smbfs_fullpath
argument_list|(
name|mbp
argument_list|,
name|SSTOVC
argument_list|(
name|ssp
argument_list|)
argument_list|,
name|src
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
break|break;
name|mb_put_uint8
argument_list|(
name|mbp
argument_list|,
name|SMB_DT_ASCII
argument_list|)
expr_stmt|;
name|error
operator|=
name|smbfs_fullpath
argument_list|(
name|mbp
argument_list|,
name|SSTOVC
argument_list|(
name|ssp
argument_list|)
argument_list|,
name|tdnp
argument_list|,
name|tname
argument_list|,
name|tnmlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
break|break;
name|smb_rq_bend
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|error
operator|=
name|smb_rq_simple
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
literal|0
condition|)
do|;
name|smb_rq_done
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_function
name|int
name|smbfs_smb_mkdir
parameter_list|(
name|struct
name|smbnode
modifier|*
name|dnp
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|int
name|len
parameter_list|,
name|struct
name|smb_cred
modifier|*
name|scred
parameter_list|)
block|{
name|struct
name|smb_rq
name|rq
decl_stmt|,
modifier|*
name|rqp
init|=
operator|&
name|rq
decl_stmt|;
name|struct
name|smb_share
modifier|*
name|ssp
init|=
name|dnp
operator|->
name|n_mount
operator|->
name|sm_share
decl_stmt|;
name|struct
name|mbchain
modifier|*
name|mbp
decl_stmt|;
name|int
name|error
decl_stmt|;
name|error
operator|=
name|smb_rq_init
argument_list|(
name|rqp
argument_list|,
name|SSTOCP
argument_list|(
name|ssp
argument_list|)
argument_list|,
name|SMB_COM_CREATE_DIRECTORY
argument_list|,
name|scred
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
name|smb_rq_getrequest
argument_list|(
name|rqp
argument_list|,
operator|&
name|mbp
argument_list|)
expr_stmt|;
name|smb_rq_wstart
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|smb_rq_wend
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|smb_rq_bstart
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|mb_put_uint8
argument_list|(
name|mbp
argument_list|,
name|SMB_DT_ASCII
argument_list|)
expr_stmt|;
name|error
operator|=
name|smbfs_fullpath
argument_list|(
name|mbp
argument_list|,
name|SSTOVC
argument_list|(
name|ssp
argument_list|)
argument_list|,
name|dnp
argument_list|,
name|name
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
block|{
name|smb_rq_bend
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|error
operator|=
name|smb_rq_simple
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
block|}
name|smb_rq_done
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_function
name|int
name|smbfs_smb_rmdir
parameter_list|(
name|struct
name|smbnode
modifier|*
name|np
parameter_list|,
name|struct
name|smb_cred
modifier|*
name|scred
parameter_list|)
block|{
name|struct
name|smb_rq
name|rq
decl_stmt|,
modifier|*
name|rqp
init|=
operator|&
name|rq
decl_stmt|;
name|struct
name|smb_share
modifier|*
name|ssp
init|=
name|np
operator|->
name|n_mount
operator|->
name|sm_share
decl_stmt|;
name|struct
name|mbchain
modifier|*
name|mbp
decl_stmt|;
name|int
name|error
decl_stmt|;
name|error
operator|=
name|smb_rq_init
argument_list|(
name|rqp
argument_list|,
name|SSTOCP
argument_list|(
name|ssp
argument_list|)
argument_list|,
name|SMB_COM_DELETE_DIRECTORY
argument_list|,
name|scred
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
name|smb_rq_getrequest
argument_list|(
name|rqp
argument_list|,
operator|&
name|mbp
argument_list|)
expr_stmt|;
name|smb_rq_wstart
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|smb_rq_wend
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|smb_rq_bstart
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|mb_put_uint8
argument_list|(
name|mbp
argument_list|,
name|SMB_DT_ASCII
argument_list|)
expr_stmt|;
name|error
operator|=
name|smbfs_fullpath
argument_list|(
name|mbp
argument_list|,
name|SSTOVC
argument_list|(
name|ssp
argument_list|)
argument_list|,
name|np
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
block|{
name|smb_rq_bend
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|error
operator|=
name|smb_rq_simple
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
block|}
name|smb_rq_done
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|smbfs_smb_search
parameter_list|(
name|struct
name|smbfs_fctx
modifier|*
name|ctx
parameter_list|)
block|{
name|struct
name|smb_vc
modifier|*
name|vcp
init|=
name|SSTOVC
argument_list|(
name|ctx
operator|->
name|f_ssp
argument_list|)
decl_stmt|;
name|struct
name|smb_rq
modifier|*
name|rqp
decl_stmt|;
name|struct
name|mbchain
modifier|*
name|mbp
decl_stmt|;
name|struct
name|mdchain
modifier|*
name|mdp
decl_stmt|;
name|u_int8_t
name|wc
decl_stmt|,
name|bt
decl_stmt|;
name|u_int16_t
name|ec
decl_stmt|,
name|dlen
decl_stmt|,
name|bc
decl_stmt|;
name|int
name|maxent
decl_stmt|,
name|error
decl_stmt|,
name|iseof
init|=
literal|0
decl_stmt|;
name|maxent
operator|=
name|min
argument_list|(
name|ctx
operator|->
name|f_left
argument_list|,
operator|(
name|vcp
operator|->
name|vc_txmax
operator|-
name|SMB_HDRLEN
operator|-
literal|3
operator|)
operator|/
name|SMB_DENTRYLEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|f_rq
condition|)
block|{
name|smb_rq_done
argument_list|(
name|ctx
operator|->
name|f_rq
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|f_rq
operator|=
name|NULL
expr_stmt|;
block|}
name|error
operator|=
name|smb_rq_alloc
argument_list|(
name|SSTOCP
argument_list|(
name|ctx
operator|->
name|f_ssp
argument_list|)
argument_list|,
name|SMB_COM_SEARCH
argument_list|,
name|ctx
operator|->
name|f_scred
argument_list|,
operator|&
name|rqp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
name|ctx
operator|->
name|f_rq
operator|=
name|rqp
expr_stmt|;
name|smb_rq_getrequest
argument_list|(
name|rqp
argument_list|,
operator|&
name|mbp
argument_list|)
expr_stmt|;
name|smb_rq_wstart
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|mb_put_uint16le
argument_list|(
name|mbp
argument_list|,
name|maxent
argument_list|)
expr_stmt|;
comment|/* max entries to return */
name|mb_put_uint16le
argument_list|(
name|mbp
argument_list|,
name|ctx
operator|->
name|f_attrmask
argument_list|)
expr_stmt|;
name|smb_rq_wend
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|smb_rq_bstart
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|mb_put_uint8
argument_list|(
name|mbp
argument_list|,
name|SMB_DT_ASCII
argument_list|)
expr_stmt|;
comment|/* buffer format */
if|if
condition|(
name|ctx
operator|->
name|f_flags
operator|&
name|SMBFS_RDD_FINDFIRST
condition|)
block|{
name|error
operator|=
name|smbfs_fullpath
argument_list|(
name|mbp
argument_list|,
name|vcp
argument_list|,
name|ctx
operator|->
name|f_dnp
argument_list|,
name|ctx
operator|->
name|f_wildcard
argument_list|,
name|ctx
operator|->
name|f_wclen
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
name|mb_put_uint8
argument_list|(
name|mbp
argument_list|,
name|SMB_DT_VARIABLE
argument_list|)
expr_stmt|;
name|mb_put_uint16le
argument_list|(
name|mbp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* context length */
name|ctx
operator|->
name|f_flags
operator|&=
operator|~
name|SMBFS_RDD_FINDFIRST
expr_stmt|;
block|}
else|else
block|{
name|mb_put_uint8
argument_list|(
name|mbp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* file name length */
name|mb_put_uint8
argument_list|(
name|mbp
argument_list|,
name|SMB_DT_VARIABLE
argument_list|)
expr_stmt|;
name|mb_put_uint16le
argument_list|(
name|mbp
argument_list|,
name|SMB_SKEYLEN
argument_list|)
expr_stmt|;
name|mb_put_mem
argument_list|(
name|mbp
argument_list|,
name|ctx
operator|->
name|f_skey
argument_list|,
name|SMB_SKEYLEN
argument_list|,
name|MB_MSYSTEM
argument_list|)
expr_stmt|;
block|}
name|smb_rq_bend
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|error
operator|=
name|smb_rq_simple
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
if|if
condition|(
name|rqp
operator|->
name|sr_errclass
operator|==
name|ERRDOS
operator|&&
name|rqp
operator|->
name|sr_serror
operator|==
name|ERRnofiles
condition|)
block|{
name|error
operator|=
literal|0
expr_stmt|;
name|iseof
operator|=
literal|1
expr_stmt|;
name|ctx
operator|->
name|f_flags
operator||=
name|SMBFS_RDD_EOF
expr_stmt|;
block|}
else|else
return|return
name|error
return|;
block|}
name|smb_rq_getreply
argument_list|(
name|rqp
argument_list|,
operator|&
name|mdp
argument_list|)
expr_stmt|;
name|md_get_uint8
argument_list|(
name|mdp
argument_list|,
operator|&
name|wc
argument_list|)
expr_stmt|;
if|if
condition|(
name|wc
operator|!=
literal|1
condition|)
return|return
name|iseof
condition|?
name|ENOENT
else|:
name|EBADRPC
return|;
name|md_get_uint16le
argument_list|(
name|mdp
argument_list|,
operator|&
name|ec
argument_list|)
expr_stmt|;
if|if
condition|(
name|ec
operator|==
literal|0
condition|)
return|return
name|ENOENT
return|;
name|ctx
operator|->
name|f_ecnt
operator|=
name|ec
expr_stmt|;
name|md_get_uint16le
argument_list|(
name|mdp
argument_list|,
operator|&
name|bc
argument_list|)
expr_stmt|;
if|if
condition|(
name|bc
operator|<
literal|3
condition|)
return|return
name|EBADRPC
return|;
name|bc
operator|-=
literal|3
expr_stmt|;
name|md_get_uint8
argument_list|(
name|mdp
argument_list|,
operator|&
name|bt
argument_list|)
expr_stmt|;
if|if
condition|(
name|bt
operator|!=
name|SMB_DT_VARIABLE
condition|)
return|return
name|EBADRPC
return|;
name|md_get_uint16le
argument_list|(
name|mdp
argument_list|,
operator|&
name|dlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|dlen
operator|!=
name|bc
operator|||
name|dlen
operator|%
name|SMB_DENTRYLEN
operator|!=
literal|0
condition|)
return|return
name|EBADRPC
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|smbfs_findopenLM1
parameter_list|(
name|struct
name|smbfs_fctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|smbnode
modifier|*
name|dnp
parameter_list|,
specifier|const
name|char
modifier|*
name|wildcard
parameter_list|,
name|int
name|wclen
parameter_list|,
name|int
name|attr
parameter_list|,
name|struct
name|smb_cred
modifier|*
name|scred
parameter_list|)
block|{
name|ctx
operator|->
name|f_attrmask
operator|=
name|attr
expr_stmt|;
if|if
condition|(
name|wildcard
condition|)
block|{
if|if
condition|(
name|wclen
operator|==
literal|1
operator|&&
name|wildcard
index|[
literal|0
index|]
operator|==
literal|'*'
condition|)
block|{
name|ctx
operator|->
name|f_wildcard
operator|=
literal|"*.*"
expr_stmt|;
name|ctx
operator|->
name|f_wclen
operator|=
literal|3
expr_stmt|;
block|}
else|else
block|{
name|ctx
operator|->
name|f_wildcard
operator|=
name|wildcard
expr_stmt|;
name|ctx
operator|->
name|f_wclen
operator|=
name|wclen
expr_stmt|;
block|}
block|}
else|else
block|{
name|ctx
operator|->
name|f_wildcard
operator|=
name|NULL
expr_stmt|;
name|ctx
operator|->
name|f_wclen
operator|=
literal|0
expr_stmt|;
block|}
name|ctx
operator|->
name|f_name
operator|=
name|ctx
operator|->
name|f_fname
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|smbfs_findnextLM1
parameter_list|(
name|struct
name|smbfs_fctx
modifier|*
name|ctx
parameter_list|,
name|int
name|limit
parameter_list|)
block|{
name|struct
name|mdchain
modifier|*
name|mbp
decl_stmt|;
name|struct
name|smb_rq
modifier|*
name|rqp
decl_stmt|;
name|char
modifier|*
name|cp
decl_stmt|;
name|u_int8_t
name|battr
decl_stmt|;
name|u_int16_t
name|date
decl_stmt|,
name|time
decl_stmt|;
name|u_int32_t
name|size
decl_stmt|;
name|int
name|error
decl_stmt|;
if|if
condition|(
name|ctx
operator|->
name|f_ecnt
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|ctx
operator|->
name|f_flags
operator|&
name|SMBFS_RDD_EOF
condition|)
return|return
name|ENOENT
return|;
name|ctx
operator|->
name|f_left
operator|=
name|ctx
operator|->
name|f_limit
operator|=
name|limit
expr_stmt|;
name|error
operator|=
name|smbfs_smb_search
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
block|}
name|rqp
operator|=
name|ctx
operator|->
name|f_rq
expr_stmt|;
name|smb_rq_getreply
argument_list|(
name|rqp
argument_list|,
operator|&
name|mbp
argument_list|)
expr_stmt|;
name|md_get_mem
argument_list|(
name|mbp
argument_list|,
name|ctx
operator|->
name|f_skey
argument_list|,
name|SMB_SKEYLEN
argument_list|,
name|MB_MSYSTEM
argument_list|)
expr_stmt|;
name|md_get_uint8
argument_list|(
name|mbp
argument_list|,
operator|&
name|battr
argument_list|)
expr_stmt|;
name|md_get_uint16le
argument_list|(
name|mbp
argument_list|,
operator|&
name|time
argument_list|)
expr_stmt|;
name|md_get_uint16le
argument_list|(
name|mbp
argument_list|,
operator|&
name|date
argument_list|)
expr_stmt|;
name|md_get_uint32le
argument_list|(
name|mbp
argument_list|,
operator|&
name|size
argument_list|)
expr_stmt|;
name|cp
operator|=
name|ctx
operator|->
name|f_name
expr_stmt|;
name|md_get_mem
argument_list|(
name|mbp
argument_list|,
name|cp
argument_list|,
sizeof|sizeof
argument_list|(
name|ctx
operator|->
name|f_fname
argument_list|)
argument_list|,
name|MB_MSYSTEM
argument_list|)
expr_stmt|;
name|cp
index|[
sizeof|sizeof
argument_list|(
name|ctx
operator|->
name|f_fname
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|cp
operator|+=
name|strlen
argument_list|(
name|cp
argument_list|)
operator|-
literal|1
expr_stmt|;
while|while
condition|(
operator|*
name|cp
operator|==
literal|' '
operator|&&
name|cp
operator|>=
name|ctx
operator|->
name|f_name
condition|)
operator|*
name|cp
operator|--
operator|=
literal|0
expr_stmt|;
name|ctx
operator|->
name|f_attr
operator|.
name|fa_attr
operator|=
name|battr
expr_stmt|;
name|smb_dos2unixtime
argument_list|(
name|date
argument_list|,
name|time
argument_list|,
literal|0
argument_list|,
name|rqp
operator|->
name|sr_vc
operator|->
name|vc_sopt
operator|.
name|sv_tz
argument_list|,
operator|&
name|ctx
operator|->
name|f_attr
operator|.
name|fa_mtime
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|f_attr
operator|.
name|fa_size
operator|=
name|size
expr_stmt|;
name|ctx
operator|->
name|f_nmlen
operator|=
name|strlen
argument_list|(
name|ctx
operator|->
name|f_name
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|f_ecnt
operator|--
expr_stmt|;
name|ctx
operator|->
name|f_left
operator|--
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|smbfs_findcloseLM1
parameter_list|(
name|struct
name|smbfs_fctx
modifier|*
name|ctx
parameter_list|)
block|{
if|if
condition|(
name|ctx
operator|->
name|f_rq
condition|)
name|smb_rq_done
argument_list|(
name|ctx
operator|->
name|f_rq
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * TRANS2_FIND_FIRST2/NEXT2, used for NT LM12 dialect  */
end_comment

begin_function
specifier|static
name|int
name|smbfs_smb_trans2find2
parameter_list|(
name|struct
name|smbfs_fctx
modifier|*
name|ctx
parameter_list|)
block|{
name|struct
name|smb_t2rq
modifier|*
name|t2p
decl_stmt|;
name|struct
name|smb_vc
modifier|*
name|vcp
init|=
name|SSTOVC
argument_list|(
name|ctx
operator|->
name|f_ssp
argument_list|)
decl_stmt|;
name|struct
name|mbchain
modifier|*
name|mbp
decl_stmt|;
name|struct
name|mdchain
modifier|*
name|mdp
decl_stmt|;
name|u_int16_t
name|tw
decl_stmt|,
name|flags
decl_stmt|;
name|int
name|error
decl_stmt|;
if|if
condition|(
name|ctx
operator|->
name|f_t2
condition|)
block|{
name|smb_t2_done
argument_list|(
name|ctx
operator|->
name|f_t2
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|f_t2
operator|=
name|NULL
expr_stmt|;
block|}
name|ctx
operator|->
name|f_flags
operator|&=
operator|~
name|SMBFS_RDD_GOTRNAME
expr_stmt|;
name|flags
operator|=
literal|8
operator||
literal|2
expr_stmt|;
comment|/*<resume> |<close if EOS> */
if|if
condition|(
name|ctx
operator|->
name|f_flags
operator|&
name|SMBFS_RDD_FINDSINGLE
condition|)
block|{
name|flags
operator||=
literal|1
expr_stmt|;
comment|/* close search after this request */
name|ctx
operator|->
name|f_flags
operator||=
name|SMBFS_RDD_NOCLOSE
expr_stmt|;
block|}
if|if
condition|(
name|ctx
operator|->
name|f_flags
operator|&
name|SMBFS_RDD_FINDFIRST
condition|)
block|{
name|error
operator|=
name|smb_t2_alloc
argument_list|(
name|SSTOCP
argument_list|(
name|ctx
operator|->
name|f_ssp
argument_list|)
argument_list|,
name|SMB_TRANS2_FIND_FIRST2
argument_list|,
name|ctx
operator|->
name|f_scred
argument_list|,
operator|&
name|t2p
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
name|ctx
operator|->
name|f_t2
operator|=
name|t2p
expr_stmt|;
name|mbp
operator|=
operator|&
name|t2p
operator|->
name|t2_tparam
expr_stmt|;
name|mb_init
argument_list|(
name|mbp
argument_list|)
expr_stmt|;
name|mb_put_uint16le
argument_list|(
name|mbp
argument_list|,
name|ctx
operator|->
name|f_attrmask
argument_list|)
expr_stmt|;
name|mb_put_uint16le
argument_list|(
name|mbp
argument_list|,
name|ctx
operator|->
name|f_limit
argument_list|)
expr_stmt|;
name|mb_put_uint16le
argument_list|(
name|mbp
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|mb_put_uint16le
argument_list|(
name|mbp
argument_list|,
name|ctx
operator|->
name|f_infolevel
argument_list|)
expr_stmt|;
name|mb_put_uint32le
argument_list|(
name|mbp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|error
operator|=
name|smbfs_fullpath
argument_list|(
name|mbp
argument_list|,
name|vcp
argument_list|,
name|ctx
operator|->
name|f_dnp
argument_list|,
name|ctx
operator|->
name|f_wildcard
argument_list|,
name|ctx
operator|->
name|f_wclen
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
block|}
else|else
block|{
name|error
operator|=
name|smb_t2_alloc
argument_list|(
name|SSTOCP
argument_list|(
name|ctx
operator|->
name|f_ssp
argument_list|)
argument_list|,
name|SMB_TRANS2_FIND_NEXT2
argument_list|,
name|ctx
operator|->
name|f_scred
argument_list|,
operator|&
name|t2p
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
name|ctx
operator|->
name|f_t2
operator|=
name|t2p
expr_stmt|;
name|mbp
operator|=
operator|&
name|t2p
operator|->
name|t2_tparam
expr_stmt|;
name|mb_init
argument_list|(
name|mbp
argument_list|)
expr_stmt|;
name|mb_put_mem
argument_list|(
name|mbp
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|ctx
operator|->
name|f_Sid
argument_list|,
literal|2
argument_list|,
name|MB_MSYSTEM
argument_list|)
expr_stmt|;
name|mb_put_uint16le
argument_list|(
name|mbp
argument_list|,
name|ctx
operator|->
name|f_limit
argument_list|)
expr_stmt|;
name|mb_put_uint16le
argument_list|(
name|mbp
argument_list|,
name|ctx
operator|->
name|f_infolevel
argument_list|)
expr_stmt|;
name|mb_put_uint32le
argument_list|(
name|mbp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* resume key */
name|mb_put_uint16le
argument_list|(
name|mbp
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|f_rname
condition|)
name|mb_put_mem
argument_list|(
name|mbp
argument_list|,
name|ctx
operator|->
name|f_rname
argument_list|,
name|strlen
argument_list|(
name|ctx
operator|->
name|f_rname
argument_list|)
operator|+
literal|1
argument_list|,
name|MB_MSYSTEM
argument_list|)
expr_stmt|;
else|else
name|mb_put_uint8
argument_list|(
name|mbp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* resume file name */
if|#
directive|if
literal|0
block|struct timeval tv; 	tv.tv_sec = 0; 	tv.tv_usec = 200 * 1000;
comment|/* 200ms */
block|if (vcp->vc_flags& SMBC_WIN95) {
comment|/* 			 * some implementations suggests to sleep here 			 * for 200ms, due to the bug in the Win95. 			 * I've didn't notice any problem, but put code 			 * for it. 			 */
block|tsleep(&flags, PVFS, "fix95", tvtohz(&tv)); 		}
endif|#
directive|endif
block|}
name|t2p
operator|->
name|t2_maxpcount
operator|=
literal|5
operator|*
literal|2
expr_stmt|;
name|t2p
operator|->
name|t2_maxdcount
operator|=
name|vcp
operator|->
name|vc_txmax
expr_stmt|;
name|error
operator|=
name|smb_t2_request
argument_list|(
name|t2p
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
name|mdp
operator|=
operator|&
name|t2p
operator|->
name|t2_rparam
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|f_flags
operator|&
name|SMBFS_RDD_FINDFIRST
condition|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|md_get_uint16
argument_list|(
name|mdp
argument_list|,
operator|&
name|ctx
operator|->
name|f_Sid
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|error
return|;
name|ctx
operator|->
name|f_flags
operator|&=
operator|~
name|SMBFS_RDD_FINDFIRST
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|error
operator|=
name|md_get_uint16le
argument_list|(
name|mdp
argument_list|,
operator|&
name|tw
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|error
return|;
name|ctx
operator|->
name|f_ecnt
operator|=
name|tw
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|md_get_uint16le
argument_list|(
name|mdp
argument_list|,
operator|&
name|tw
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|error
return|;
if|if
condition|(
name|tw
condition|)
name|ctx
operator|->
name|f_flags
operator||=
name|SMBFS_RDD_EOF
operator||
name|SMBFS_RDD_NOCLOSE
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|md_get_uint16le
argument_list|(
name|mdp
argument_list|,
operator|&
name|tw
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|error
return|;
if|if
condition|(
operator|(
name|error
operator|=
name|md_get_uint16le
argument_list|(
name|mdp
argument_list|,
operator|&
name|tw
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|error
return|;
if|if
condition|(
name|ctx
operator|->
name|f_ecnt
operator|==
literal|0
condition|)
return|return
name|ENOENT
return|;
name|ctx
operator|->
name|f_rnameofs
operator|=
name|tw
expr_stmt|;
name|mdp
operator|=
operator|&
name|t2p
operator|->
name|t2_rdata
expr_stmt|;
if|if
condition|(
name|mdp
operator|->
name|md_top
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"bug: ecnt = %d, but data is NULL (please report)\n"
argument_list|,
name|ctx
operator|->
name|f_ecnt
argument_list|)
expr_stmt|;
return|return
name|ENOENT
return|;
block|}
if|if
condition|(
name|mdp
operator|->
name|md_top
operator|->
name|m_len
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"bug: ecnt = %d, but m_len = 0 and m_next = %p (please report)\n"
argument_list|,
name|ctx
operator|->
name|f_ecnt
argument_list|,
name|mbp
operator|->
name|mb_top
operator|->
name|m_next
argument_list|)
expr_stmt|;
return|return
name|ENOENT
return|;
block|}
name|ctx
operator|->
name|f_eofs
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|smbfs_smb_findclose2
parameter_list|(
name|struct
name|smbfs_fctx
modifier|*
name|ctx
parameter_list|)
block|{
name|struct
name|smb_rq
name|rq
decl_stmt|,
modifier|*
name|rqp
init|=
operator|&
name|rq
decl_stmt|;
name|struct
name|mbchain
modifier|*
name|mbp
decl_stmt|;
name|int
name|error
decl_stmt|;
name|error
operator|=
name|smb_rq_init
argument_list|(
name|rqp
argument_list|,
name|SSTOCP
argument_list|(
name|ctx
operator|->
name|f_ssp
argument_list|)
argument_list|,
name|SMB_COM_FIND_CLOSE2
argument_list|,
name|ctx
operator|->
name|f_scred
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
name|smb_rq_getrequest
argument_list|(
name|rqp
argument_list|,
operator|&
name|mbp
argument_list|)
expr_stmt|;
name|smb_rq_wstart
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|mb_put_mem
argument_list|(
name|mbp
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|ctx
operator|->
name|f_Sid
argument_list|,
literal|2
argument_list|,
name|MB_MSYSTEM
argument_list|)
expr_stmt|;
name|smb_rq_wend
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|smb_rq_bstart
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|smb_rq_bend
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|error
operator|=
name|smb_rq_simple
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
name|smb_rq_done
argument_list|(
name|rqp
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|smbfs_findopenLM2
parameter_list|(
name|struct
name|smbfs_fctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|smbnode
modifier|*
name|dnp
parameter_list|,
specifier|const
name|char
modifier|*
name|wildcard
parameter_list|,
name|int
name|wclen
parameter_list|,
name|int
name|attr
parameter_list|,
name|struct
name|smb_cred
modifier|*
name|scred
parameter_list|)
block|{
name|ctx
operator|->
name|f_name
operator|=
name|malloc
argument_list|(
name|SMB_MAXFNAMELEN
argument_list|,
name|M_SMBFSDATA
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|f_name
operator|==
name|NULL
condition|)
return|return
name|ENOMEM
return|;
name|ctx
operator|->
name|f_infolevel
operator|=
name|SMB_DIALECT
argument_list|(
name|SSTOVC
argument_list|(
name|ctx
operator|->
name|f_ssp
argument_list|)
argument_list|)
operator|<
name|SMB_DIALECT_NTLM0_12
condition|?
name|SMB_INFO_STANDARD
else|:
name|SMB_FIND_FILE_DIRECTORY_INFO
expr_stmt|;
name|ctx
operator|->
name|f_attrmask
operator|=
name|attr
expr_stmt|;
name|ctx
operator|->
name|f_wildcard
operator|=
name|wildcard
expr_stmt|;
name|ctx
operator|->
name|f_wclen
operator|=
name|wclen
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|smbfs_findnextLM2
parameter_list|(
name|struct
name|smbfs_fctx
modifier|*
name|ctx
parameter_list|,
name|int
name|limit
parameter_list|)
block|{
name|struct
name|mdchain
modifier|*
name|mbp
decl_stmt|;
name|struct
name|smb_t2rq
modifier|*
name|t2p
decl_stmt|;
name|char
modifier|*
name|cp
decl_stmt|;
name|u_int8_t
name|tb
decl_stmt|;
name|u_int16_t
name|date
decl_stmt|,
name|time
decl_stmt|,
name|wattr
decl_stmt|;
name|u_int32_t
name|size
decl_stmt|,
name|next
decl_stmt|,
name|dattr
decl_stmt|;
name|int64_t
name|lint
decl_stmt|;
name|int
name|error
decl_stmt|,
name|svtz
decl_stmt|,
name|cnt
decl_stmt|,
name|fxsz
decl_stmt|,
name|nmlen
decl_stmt|,
name|recsz
decl_stmt|;
if|if
condition|(
name|ctx
operator|->
name|f_ecnt
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|ctx
operator|->
name|f_flags
operator|&
name|SMBFS_RDD_EOF
condition|)
return|return
name|ENOENT
return|;
name|ctx
operator|->
name|f_left
operator|=
name|ctx
operator|->
name|f_limit
operator|=
name|limit
expr_stmt|;
name|error
operator|=
name|smbfs_smb_trans2find2
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
block|}
name|t2p
operator|=
name|ctx
operator|->
name|f_t2
expr_stmt|;
name|mbp
operator|=
operator|&
name|t2p
operator|->
name|t2_rdata
expr_stmt|;
name|svtz
operator|=
name|SSTOVC
argument_list|(
name|ctx
operator|->
name|f_ssp
argument_list|)
operator|->
name|vc_sopt
operator|.
name|sv_tz
expr_stmt|;
switch|switch
condition|(
name|ctx
operator|->
name|f_infolevel
condition|)
block|{
case|case
name|SMB_INFO_STANDARD
case|:
name|next
operator|=
literal|0
expr_stmt|;
name|fxsz
operator|=
literal|0
expr_stmt|;
name|md_get_uint16le
argument_list|(
name|mbp
argument_list|,
operator|&
name|date
argument_list|)
expr_stmt|;
name|md_get_uint16le
argument_list|(
name|mbp
argument_list|,
operator|&
name|time
argument_list|)
expr_stmt|;
comment|/* creation time */
name|md_get_uint16le
argument_list|(
name|mbp
argument_list|,
operator|&
name|date
argument_list|)
expr_stmt|;
name|md_get_uint16le
argument_list|(
name|mbp
argument_list|,
operator|&
name|time
argument_list|)
expr_stmt|;
comment|/* access time */
name|smb_dos2unixtime
argument_list|(
name|date
argument_list|,
name|time
argument_list|,
literal|0
argument_list|,
name|svtz
argument_list|,
operator|&
name|ctx
operator|->
name|f_attr
operator|.
name|fa_atime
argument_list|)
expr_stmt|;
name|md_get_uint16le
argument_list|(
name|mbp
argument_list|,
operator|&
name|date
argument_list|)
expr_stmt|;
name|md_get_uint16le
argument_list|(
name|mbp
argument_list|,
operator|&
name|time
argument_list|)
expr_stmt|;
comment|/* access time */
name|smb_dos2unixtime
argument_list|(
name|date
argument_list|,
name|time
argument_list|,
literal|0
argument_list|,
name|svtz
argument_list|,
operator|&
name|ctx
operator|->
name|f_attr
operator|.
name|fa_mtime
argument_list|)
expr_stmt|;
name|md_get_uint32le
argument_list|(
name|mbp
argument_list|,
operator|&
name|size
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|f_attr
operator|.
name|fa_size
operator|=
name|size
expr_stmt|;
name|md_get_uint32
argument_list|(
name|mbp
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* allocation size */
name|md_get_uint16le
argument_list|(
name|mbp
argument_list|,
operator|&
name|wattr
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|f_attr
operator|.
name|fa_attr
operator|=
name|wattr
expr_stmt|;
name|md_get_uint8
argument_list|(
name|mbp
argument_list|,
operator|&
name|tb
argument_list|)
expr_stmt|;
name|size
operator|=
name|nmlen
operator|=
name|tb
expr_stmt|;
name|fxsz
operator|=
literal|23
expr_stmt|;
name|recsz
operator|=
name|next
operator|=
literal|24
operator|+
name|nmlen
expr_stmt|;
comment|/* docs misses zero byte at end */
break|break;
case|case
name|SMB_FIND_FILE_DIRECTORY_INFO
case|:
name|md_get_uint32le
argument_list|(
name|mbp
argument_list|,
operator|&
name|next
argument_list|)
expr_stmt|;
name|md_get_uint32
argument_list|(
name|mbp
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* file index */
name|md_get_int64
argument_list|(
name|mbp
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* creation time */
name|md_get_int64le
argument_list|(
name|mbp
argument_list|,
operator|&
name|lint
argument_list|)
expr_stmt|;
name|smb_time_NT2local
argument_list|(
name|lint
argument_list|,
name|svtz
argument_list|,
operator|&
name|ctx
operator|->
name|f_attr
operator|.
name|fa_atime
argument_list|)
expr_stmt|;
name|md_get_int64le
argument_list|(
name|mbp
argument_list|,
operator|&
name|lint
argument_list|)
expr_stmt|;
name|smb_time_NT2local
argument_list|(
name|lint
argument_list|,
name|svtz
argument_list|,
operator|&
name|ctx
operator|->
name|f_attr
operator|.
name|fa_mtime
argument_list|)
expr_stmt|;
name|md_get_int64le
argument_list|(
name|mbp
argument_list|,
operator|&
name|lint
argument_list|)
expr_stmt|;
name|smb_time_NT2local
argument_list|(
name|lint
argument_list|,
name|svtz
argument_list|,
operator|&
name|ctx
operator|->
name|f_attr
operator|.
name|fa_ctime
argument_list|)
expr_stmt|;
name|md_get_int64le
argument_list|(
name|mbp
argument_list|,
operator|&
name|lint
argument_list|)
expr_stmt|;
comment|/* file size */
name|ctx
operator|->
name|f_attr
operator|.
name|fa_size
operator|=
name|lint
expr_stmt|;
name|md_get_int64
argument_list|(
name|mbp
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* real size (should use) */
name|md_get_uint32le
argument_list|(
name|mbp
argument_list|,
operator|&
name|dattr
argument_list|)
expr_stmt|;
comment|/* EA */
name|ctx
operator|->
name|f_attr
operator|.
name|fa_attr
operator|=
name|dattr
expr_stmt|;
name|md_get_uint32le
argument_list|(
name|mbp
argument_list|,
operator|&
name|size
argument_list|)
expr_stmt|;
comment|/* name len */
name|fxsz
operator|=
literal|64
expr_stmt|;
name|recsz
operator|=
name|next
condition|?
name|next
else|:
name|fxsz
operator|+
name|size
expr_stmt|;
break|break;
default|default:
name|SMBERROR
argument_list|(
literal|"unexpected info level %d\n"
argument_list|,
name|ctx
operator|->
name|f_infolevel
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
name|nmlen
operator|=
name|min
argument_list|(
name|size
argument_list|,
name|SMB_MAXFNAMELEN
argument_list|)
expr_stmt|;
name|cp
operator|=
name|ctx
operator|->
name|f_name
expr_stmt|;
name|error
operator|=
name|md_get_mem
argument_list|(
name|mbp
argument_list|,
name|cp
argument_list|,
name|nmlen
argument_list|,
name|MB_MSYSTEM
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
if|if
condition|(
name|next
condition|)
block|{
name|cnt
operator|=
name|next
operator|-
name|nmlen
operator|-
name|fxsz
expr_stmt|;
if|if
condition|(
name|cnt
operator|>
literal|0
condition|)
name|md_get_mem
argument_list|(
name|mbp
argument_list|,
name|NULL
argument_list|,
name|cnt
argument_list|,
name|MB_MSYSTEM
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|cnt
operator|<
literal|0
condition|)
block|{
name|SMBERROR
argument_list|(
literal|"out of sync\n"
argument_list|)
expr_stmt|;
return|return
name|EBADRPC
return|;
block|}
block|}
if|if
condition|(
name|nmlen
operator|&&
name|cp
index|[
name|nmlen
operator|-
literal|1
index|]
operator|==
literal|0
condition|)
name|nmlen
operator|--
expr_stmt|;
if|if
condition|(
name|nmlen
operator|==
literal|0
condition|)
return|return
name|EBADRPC
return|;
name|next
operator|=
name|ctx
operator|->
name|f_eofs
operator|+
name|recsz
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|f_rnameofs
operator|&&
operator|(
name|ctx
operator|->
name|f_flags
operator|&
name|SMBFS_RDD_GOTRNAME
operator|)
operator|==
literal|0
operator|&&
operator|(
name|ctx
operator|->
name|f_rnameofs
operator|>=
name|ctx
operator|->
name|f_eofs
operator|&&
name|ctx
operator|->
name|f_rnameofs
operator|<
name|next
operator|)
condition|)
block|{
comment|/* 		 * Server needs a resume filename. 		 */
if|if
condition|(
name|ctx
operator|->
name|f_rnamelen
operator|<=
name|nmlen
condition|)
block|{
if|if
condition|(
name|ctx
operator|->
name|f_rname
condition|)
name|free
argument_list|(
name|ctx
operator|->
name|f_rname
argument_list|,
name|M_SMBFSDATA
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|f_rname
operator|=
name|malloc
argument_list|(
name|nmlen
operator|+
literal|1
argument_list|,
name|M_SMBFSDATA
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|f_rnamelen
operator|=
name|nmlen
expr_stmt|;
block|}
name|bcopy
argument_list|(
name|ctx
operator|->
name|f_name
argument_list|,
name|ctx
operator|->
name|f_rname
argument_list|,
name|nmlen
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|f_rname
index|[
name|nmlen
index|]
operator|=
literal|0
expr_stmt|;
name|ctx
operator|->
name|f_flags
operator||=
name|SMBFS_RDD_GOTRNAME
expr_stmt|;
block|}
name|ctx
operator|->
name|f_nmlen
operator|=
name|nmlen
expr_stmt|;
name|ctx
operator|->
name|f_eofs
operator|=
name|next
expr_stmt|;
name|ctx
operator|->
name|f_ecnt
operator|--
expr_stmt|;
name|ctx
operator|->
name|f_left
operator|--
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|smbfs_findcloseLM2
parameter_list|(
name|struct
name|smbfs_fctx
modifier|*
name|ctx
parameter_list|)
block|{
if|if
condition|(
name|ctx
operator|->
name|f_name
condition|)
name|free
argument_list|(
name|ctx
operator|->
name|f_name
argument_list|,
name|M_SMBFSDATA
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|f_t2
condition|)
name|smb_t2_done
argument_list|(
name|ctx
operator|->
name|f_t2
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ctx
operator|->
name|f_flags
operator|&
name|SMBFS_RDD_NOCLOSE
operator|)
operator|==
literal|0
condition|)
name|smbfs_smb_findclose2
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|smbfs_findopen
parameter_list|(
name|struct
name|smbnode
modifier|*
name|dnp
parameter_list|,
specifier|const
name|char
modifier|*
name|wildcard
parameter_list|,
name|int
name|wclen
parameter_list|,
name|int
name|attr
parameter_list|,
name|struct
name|smb_cred
modifier|*
name|scred
parameter_list|,
name|struct
name|smbfs_fctx
modifier|*
modifier|*
name|ctxpp
parameter_list|)
block|{
name|struct
name|smbfs_fctx
modifier|*
name|ctx
decl_stmt|;
name|int
name|error
decl_stmt|;
name|ctx
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|ctx
argument_list|)
argument_list|,
name|M_SMBFSDATA
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|==
name|NULL
condition|)
return|return
name|ENOMEM
return|;
name|bzero
argument_list|(
name|ctx
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ctx
argument_list|)
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|f_ssp
operator|=
name|dnp
operator|->
name|n_mount
operator|->
name|sm_share
expr_stmt|;
name|ctx
operator|->
name|f_dnp
operator|=
name|dnp
expr_stmt|;
name|ctx
operator|->
name|f_flags
operator|=
name|SMBFS_RDD_FINDFIRST
expr_stmt|;
name|ctx
operator|->
name|f_scred
operator|=
name|scred
expr_stmt|;
if|if
condition|(
name|SMB_DIALECT
argument_list|(
name|SSTOVC
argument_list|(
name|ctx
operator|->
name|f_ssp
argument_list|)
argument_list|)
operator|<
name|SMB_DIALECT_LANMAN2_0
operator|||
operator|(
name|dnp
operator|->
name|n_mount
operator|->
name|sm_args
operator|.
name|flags
operator|&
name|SMBFS_MOUNT_NO_LONG
operator|)
condition|)
block|{
name|ctx
operator|->
name|f_flags
operator||=
name|SMBFS_RDD_USESEARCH
expr_stmt|;
name|error
operator|=
name|smbfs_findopenLM1
argument_list|(
name|ctx
argument_list|,
name|dnp
argument_list|,
name|wildcard
argument_list|,
name|wclen
argument_list|,
name|attr
argument_list|,
name|scred
argument_list|)
expr_stmt|;
block|}
else|else
name|error
operator|=
name|smbfs_findopenLM2
argument_list|(
name|ctx
argument_list|,
name|dnp
argument_list|,
name|wildcard
argument_list|,
name|wclen
argument_list|,
name|attr
argument_list|,
name|scred
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
name|smbfs_findclose
argument_list|(
name|ctx
argument_list|,
name|scred
argument_list|)
expr_stmt|;
else|else
operator|*
name|ctxpp
operator|=
name|ctx
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_function
name|int
name|smbfs_findnext
parameter_list|(
name|struct
name|smbfs_fctx
modifier|*
name|ctx
parameter_list|,
name|int
name|limit
parameter_list|,
name|struct
name|smb_cred
modifier|*
name|scred
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
if|if
condition|(
name|limit
operator|==
literal|0
condition|)
name|limit
operator|=
literal|1000000
expr_stmt|;
elseif|else
if|if
condition|(
name|limit
operator|>
literal|1
condition|)
name|limit
operator|*=
literal|4
expr_stmt|;
comment|/* imperical */
name|ctx
operator|->
name|f_scred
operator|=
name|scred
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|ctx
operator|->
name|f_flags
operator|&
name|SMBFS_RDD_USESEARCH
condition|)
block|{
name|error
operator|=
name|smbfs_findnextLM1
argument_list|(
name|ctx
argument_list|,
name|limit
argument_list|)
expr_stmt|;
block|}
else|else
name|error
operator|=
name|smbfs_findnextLM2
argument_list|(
name|ctx
argument_list|,
name|limit
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
if|if
condition|(
operator|(
name|ctx
operator|->
name|f_nmlen
operator|==
literal|1
operator|&&
name|ctx
operator|->
name|f_name
index|[
literal|0
index|]
operator|==
literal|'.'
operator|)
operator|||
operator|(
name|ctx
operator|->
name|f_nmlen
operator|==
literal|2
operator|&&
name|ctx
operator|->
name|f_name
index|[
literal|0
index|]
operator|==
literal|'.'
operator|&&
name|ctx
operator|->
name|f_name
index|[
literal|1
index|]
operator|==
literal|'.'
operator|)
condition|)
continue|continue;
break|break;
block|}
name|smbfs_fname_tolocal
argument_list|(
name|SSTOVC
argument_list|(
name|ctx
operator|->
name|f_ssp
argument_list|)
argument_list|,
name|ctx
operator|->
name|f_name
argument_list|,
name|ctx
operator|->
name|f_nmlen
argument_list|,
name|ctx
operator|->
name|f_dnp
operator|->
name|n_mount
operator|->
name|sm_caseopt
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|f_attr
operator|.
name|fa_ino
operator|=
name|smbfs_getino
argument_list|(
name|ctx
operator|->
name|f_dnp
argument_list|,
name|ctx
operator|->
name|f_name
argument_list|,
name|ctx
operator|->
name|f_nmlen
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|smbfs_findclose
parameter_list|(
name|struct
name|smbfs_fctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|smb_cred
modifier|*
name|scred
parameter_list|)
block|{
name|ctx
operator|->
name|f_scred
operator|=
name|scred
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|f_flags
operator|&
name|SMBFS_RDD_USESEARCH
condition|)
block|{
name|smbfs_findcloseLM1
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
block|}
else|else
name|smbfs_findcloseLM2
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|f_rname
condition|)
name|free
argument_list|(
name|ctx
operator|->
name|f_rname
argument_list|,
name|M_SMBFSDATA
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|ctx
argument_list|,
name|M_SMBFSDATA
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|smbfs_smb_lookup
parameter_list|(
name|struct
name|smbnode
modifier|*
name|dnp
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|int
name|nmlen
parameter_list|,
name|struct
name|smbfattr
modifier|*
name|fap
parameter_list|,
name|struct
name|smb_cred
modifier|*
name|scred
parameter_list|)
block|{
name|struct
name|smbfs_fctx
modifier|*
name|ctx
decl_stmt|;
name|int
name|error
decl_stmt|;
if|if
condition|(
name|dnp
operator|==
name|NULL
operator|||
operator|(
name|dnp
operator|->
name|n_ino
operator|==
literal|2
operator|&&
name|name
operator|==
name|NULL
operator|)
condition|)
block|{
name|bzero
argument_list|(
name|fap
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|fap
argument_list|)
argument_list|)
expr_stmt|;
name|fap
operator|->
name|fa_attr
operator|=
name|SMB_FA_DIR
expr_stmt|;
name|fap
operator|->
name|fa_ino
operator|=
literal|2
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|nmlen
operator|==
literal|1
operator|&&
name|name
index|[
literal|0
index|]
operator|==
literal|'.'
condition|)
block|{
name|error
operator|=
name|smbfs_smb_lookup
argument_list|(
name|dnp
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|fap
argument_list|,
name|scred
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
elseif|else
if|if
condition|(
name|nmlen
operator|==
literal|2
operator|&&
name|name
index|[
literal|0
index|]
operator|==
literal|'.'
operator|&&
name|name
index|[
literal|1
index|]
operator|==
literal|'.'
condition|)
block|{
name|error
operator|=
name|smbfs_smb_lookup
argument_list|(
name|VTOSMB
argument_list|(
name|dnp
operator|->
name|n_parent
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|fap
argument_list|,
name|scred
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s: knows NOTHING about '..'\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
name|error
operator|=
name|smbfs_findopen
argument_list|(
name|dnp
argument_list|,
name|name
argument_list|,
name|nmlen
argument_list|,
name|SMB_FA_SYSTEM
operator||
name|SMB_FA_HIDDEN
operator||
name|SMB_FA_DIR
argument_list|,
name|scred
argument_list|,
operator|&
name|ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
name|ctx
operator|->
name|f_flags
operator||=
name|SMBFS_RDD_FINDSINGLE
expr_stmt|;
name|error
operator|=
name|smbfs_findnext
argument_list|(
name|ctx
argument_list|,
literal|1
argument_list|,
name|scred
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
block|{
operator|*
name|fap
operator|=
name|ctx
operator|->
name|f_attr
expr_stmt|;
if|if
condition|(
name|name
operator|==
name|NULL
condition|)
name|fap
operator|->
name|fa_ino
operator|=
name|dnp
operator|->
name|n_ino
expr_stmt|;
block|}
name|smbfs_findclose
argument_list|(
name|ctx
argument_list|,
name|scred
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2001, 2002 Scott Long<scottl@freebsd.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_comment
comment|/* ecma167-udf.h */
end_comment

begin_comment
comment|/* Structure/definitions/constants a la ECMA 167 rev. 3 */
end_comment

begin_comment
comment|/* Tag identifiers */
end_comment

begin_enum
enum|enum
block|{
name|TAGID_PRI_VOL
init|=
literal|1
block|,
name|TAGID_ANCHOR
init|=
literal|2
block|,
name|TAGID_VOL
init|=
literal|3
block|,
name|TAGID_IMP_VOL
init|=
literal|4
block|,
name|TAGID_PARTITION
init|=
literal|5
block|,
name|TAGID_LOGVOL
init|=
literal|6
block|,
name|TAGID_UNALLOC_SPACE
init|=
literal|7
block|,
name|TAGID_TERM
init|=
literal|8
block|,
name|TAGID_LOGVOL_INTEGRITY
init|=
literal|9
block|,
name|TAGID_FSD
init|=
literal|256
block|,
name|TAGID_FID
init|=
literal|257
block|,
name|TAGID_FENTRY
init|=
literal|261
block|}
enum|;
end_enum

begin_comment
comment|/* Descriptor tag [3/7.2] */
end_comment

begin_struct
struct|struct
name|desc_tag
block|{
name|uint16_t
name|id
decl_stmt|;
name|uint16_t
name|descriptor_ver
decl_stmt|;
name|uint8_t
name|cksum
decl_stmt|;
name|uint8_t
name|reserved
decl_stmt|;
name|uint16_t
name|serial_num
decl_stmt|;
name|uint16_t
name|desc_crc
decl_stmt|;
name|uint16_t
name|desc_crc_len
decl_stmt|;
name|uint32_t
name|tag_loc
decl_stmt|;
block|}
name|__packed
struct|;
end_struct

begin_comment
comment|/* Recorded Address [4/7.1] */
end_comment

begin_struct
struct|struct
name|lb_addr
block|{
name|uint32_t
name|lb_num
decl_stmt|;
name|uint16_t
name|part_num
decl_stmt|;
block|}
name|__packed
struct|;
end_struct

begin_comment
comment|/* Extent Descriptor [3/7.1] */
end_comment

begin_struct
struct|struct
name|extent_ad
block|{
name|uint32_t
name|len
decl_stmt|;
name|uint32_t
name|loc
decl_stmt|;
block|}
name|__packed
struct|;
end_struct

begin_comment
comment|/* Short Allocation Descriptor [4/14.14.1] */
end_comment

begin_struct
struct|struct
name|short_ad
block|{
name|uint32_t
name|len
decl_stmt|;
name|uint32_t
name|pos
decl_stmt|;
block|}
name|__packed
struct|;
end_struct

begin_comment
comment|/* Long Allocation Descriptor [4/14.14.2] */
end_comment

begin_struct
struct|struct
name|long_ad
block|{
name|uint32_t
name|len
decl_stmt|;
name|struct
name|lb_addr
name|loc
decl_stmt|;
name|uint16_t
name|ad_flags
decl_stmt|;
name|uint32_t
name|ad_id
decl_stmt|;
block|}
name|__packed
struct|;
end_struct

begin_comment
comment|/* Extended Allocation Descriptor [4/14.14.3] */
end_comment

begin_struct
struct|struct
name|ext_ad
block|{
name|uint32_t
name|ex_len
decl_stmt|;
name|uint32_t
name|rec_len
decl_stmt|;
name|uint32_t
name|inf_len
decl_stmt|;
name|struct
name|lb_addr
name|ex_loc
decl_stmt|;
name|uint8_t
name|reserved
index|[
literal|2
index|]
decl_stmt|;
block|}
name|__packed
struct|;
end_struct

begin_union
union|union
name|icb
block|{
name|struct
name|short_ad
name|s_ad
decl_stmt|;
name|struct
name|long_ad
name|l_ad
decl_stmt|;
name|struct
name|ext_ad
name|e_ad
decl_stmt|;
block|}
union|;
end_union

begin_comment
comment|/* Character set spec [1/7.2.1] */
end_comment

begin_struct
struct|struct
name|charspec
block|{
name|uint8_t
name|type
decl_stmt|;
name|uint8_t
name|inf
index|[
literal|63
index|]
decl_stmt|;
block|}
name|__packed
struct|;
end_struct

begin_comment
comment|/* Timestamp [1/7.3] */
end_comment

begin_struct
struct|struct
name|timestamp
block|{
name|uint16_t
name|type_tz
decl_stmt|;
name|uint16_t
name|year
decl_stmt|;
name|uint8_t
name|month
decl_stmt|;
name|uint8_t
name|day
decl_stmt|;
name|uint8_t
name|hour
decl_stmt|;
name|uint8_t
name|minute
decl_stmt|;
name|uint8_t
name|second
decl_stmt|;
name|uint8_t
name|centisec
decl_stmt|;
name|uint8_t
name|hund_usec
decl_stmt|;
name|uint8_t
name|usec
decl_stmt|;
block|}
name|__packed
struct|;
end_struct

begin_comment
comment|/* Entity Identifier [1/7.4] */
end_comment

begin_define
define|#
directive|define
name|UDF_REGID_ID_SIZE
value|23
end_define

begin_struct
struct|struct
name|regid
block|{
name|uint8_t
name|flags
decl_stmt|;
name|uint8_t
name|id
index|[
name|UDF_REGID_ID_SIZE
index|]
decl_stmt|;
name|uint8_t
name|id_suffix
index|[
literal|8
index|]
decl_stmt|;
block|}
name|__packed
struct|;
end_struct

begin_comment
comment|/* ICB Tag [4/14.6] */
end_comment

begin_struct
struct|struct
name|icb_tag
block|{
name|uint32_t
name|prev_num_dirs
decl_stmt|;
name|uint16_t
name|strat_type
decl_stmt|;
name|uint8_t
name|strat_param
index|[
literal|2
index|]
decl_stmt|;
name|uint16_t
name|max_num_entries
decl_stmt|;
name|uint8_t
name|reserved
decl_stmt|;
name|uint8_t
name|file_type
decl_stmt|;
name|struct
name|lb_addr
name|parent_icb
decl_stmt|;
name|uint16_t
name|flags
decl_stmt|;
block|}
name|__packed
struct|;
end_struct

begin_define
define|#
directive|define
name|UDF_ICB_TAG_FLAGS_SETUID
value|0x40
end_define

begin_define
define|#
directive|define
name|UDF_ICB_TAG_FLAGS_SETGID
value|0x80
end_define

begin_define
define|#
directive|define
name|UDF_ICB_TAG_FLAGS_STICKY
value|0x100
end_define

begin_comment
comment|/* Anchor Volume Descriptor Pointer [3/10.2] */
end_comment

begin_struct
struct|struct
name|anchor_vdp
block|{
name|struct
name|desc_tag
name|tag
decl_stmt|;
name|struct
name|extent_ad
name|main_vds_ex
decl_stmt|;
name|struct
name|extent_ad
name|reserve_vds_ex
decl_stmt|;
block|}
name|__packed
struct|;
end_struct

begin_comment
comment|/* Volume Descriptor Pointer [3/10.3] */
end_comment

begin_struct
struct|struct
name|vol_desc_ptr
block|{
name|struct
name|desc_tag
name|tag
decl_stmt|;
name|uint32_t
name|vds_number
decl_stmt|;
name|struct
name|extent_ad
name|next_vds_ex
decl_stmt|;
block|}
name|__packed
struct|;
end_struct

begin_comment
comment|/* Primary Volume Descriptor [3/10.1] */
end_comment

begin_struct
struct|struct
name|pri_vol_desc
block|{
name|struct
name|desc_tag
name|tag
decl_stmt|;
name|uint32_t
name|seq_num
decl_stmt|;
name|uint32_t
name|pdv_num
decl_stmt|;
name|char
name|vol_id
index|[
literal|32
index|]
decl_stmt|;
name|uint16_t
name|vds_num
decl_stmt|;
name|uint16_t
name|max_vol_seq
decl_stmt|;
name|uint16_t
name|ichg_lvl
decl_stmt|;
name|uint16_t
name|max_ichg_lvl
decl_stmt|;
name|uint32_t
name|charset_list
decl_stmt|;
name|uint32_t
name|max_charset_list
decl_stmt|;
name|char
name|volset_id
index|[
literal|128
index|]
decl_stmt|;
name|struct
name|charspec
name|desc_charset
decl_stmt|;
name|struct
name|charspec
name|explanatory_charset
decl_stmt|;
name|struct
name|extent_ad
name|vol_abstract
decl_stmt|;
name|struct
name|extent_ad
name|vol_copyright
decl_stmt|;
name|struct
name|regid
name|app_id
decl_stmt|;
name|struct
name|timestamp
name|time
decl_stmt|;
name|struct
name|regid
name|imp_id
decl_stmt|;
name|uint8_t
name|imp_use
index|[
literal|64
index|]
decl_stmt|;
name|uint32_t
name|prev_vds_lov
decl_stmt|;
name|uint16_t
name|flags
decl_stmt|;
name|uint8_t
name|reserved
index|[
literal|22
index|]
decl_stmt|;
block|}
name|__packed
struct|;
end_struct

begin_comment
comment|/* Logical Volume Descriptor [3/10.6] */
end_comment

begin_struct
struct|struct
name|logvol_desc
block|{
name|struct
name|desc_tag
name|tag
decl_stmt|;
name|uint32_t
name|seq_num
decl_stmt|;
name|struct
name|charspec
name|desc_charset
decl_stmt|;
name|char
name|logvol_id
index|[
literal|128
index|]
decl_stmt|;
name|uint32_t
name|lb_size
decl_stmt|;
name|struct
name|regid
name|domain_id
decl_stmt|;
union|union
block|{
name|struct
name|long_ad
name|fsd_loc
decl_stmt|;
name|uint8_t
name|logvol_content_use
index|[
literal|16
index|]
decl_stmt|;
block|}
name|_lvd_use
union|;
name|uint32_t
name|mt_l
decl_stmt|;
comment|/* Partition map length */
name|uint32_t
name|n_pm
decl_stmt|;
comment|/* Number of partition maps */
name|struct
name|regid
name|imp_id
decl_stmt|;
name|uint8_t
name|imp_use
index|[
literal|128
index|]
decl_stmt|;
name|struct
name|extent_ad
name|integrity_seq_id
decl_stmt|;
name|uint8_t
name|maps
index|[
literal|1
index|]
decl_stmt|;
block|}
name|__packed
struct|;
end_struct

begin_comment
comment|/* Type 1 Partition Map [3/10.7.2] */
end_comment

begin_struct
struct|struct
name|part_map_1
block|{
name|uint8_t
name|type
decl_stmt|;
name|uint8_t
name|len
decl_stmt|;
name|uint16_t
name|vol_seq_num
decl_stmt|;
name|uint16_t
name|part_num
decl_stmt|;
block|}
name|__packed
struct|;
end_struct

begin_define
define|#
directive|define
name|UDF_PMAP_TYPE1_SIZE
value|6
end_define

begin_comment
comment|/* Type 2 Partition Map [3/10.7.3] */
end_comment

begin_struct
struct|struct
name|part_map_2
block|{
name|uint8_t
name|type
decl_stmt|;
name|uint8_t
name|len
decl_stmt|;
name|uint8_t
name|part_id
index|[
literal|62
index|]
decl_stmt|;
block|}
name|__packed
struct|;
end_struct

begin_define
define|#
directive|define
name|UDF_PMAP_TYPE2_SIZE
value|64
end_define

begin_comment
comment|/* Virtual Partition Map [UDF 2.01/2.2.8] */
end_comment

begin_struct
struct|struct
name|part_map_virt
block|{
name|uint8_t
name|type
decl_stmt|;
name|uint8_t
name|len
decl_stmt|;
name|uint8_t
name|reserved
index|[
literal|2
index|]
decl_stmt|;
name|struct
name|regid
name|id
decl_stmt|;
name|uint16_t
name|vol_seq_num
decl_stmt|;
name|uint16_t
name|part_num
decl_stmt|;
name|uint8_t
name|reserved1
index|[
literal|24
index|]
decl_stmt|;
block|}
name|__packed
struct|;
end_struct

begin_comment
comment|/* Sparable Partition Map [UDF 2.01/2.2.9] */
end_comment

begin_struct
struct|struct
name|part_map_spare
block|{
name|uint8_t
name|type
decl_stmt|;
name|uint8_t
name|len
decl_stmt|;
name|uint8_t
name|reserved
index|[
literal|2
index|]
decl_stmt|;
name|struct
name|regid
name|id
decl_stmt|;
name|uint16_t
name|vol_seq_num
decl_stmt|;
name|uint16_t
name|part_num
decl_stmt|;
name|uint16_t
name|packet_len
decl_stmt|;
name|uint8_t
name|n_st
decl_stmt|;
comment|/* Number of Sparing Tables */
name|uint8_t
name|reserved1
decl_stmt|;
name|uint32_t
name|st_size
decl_stmt|;
name|uint32_t
name|st_loc
index|[
literal|1
index|]
decl_stmt|;
block|}
name|__packed
struct|;
end_struct

begin_union
union|union
name|udf_pmap
block|{
name|struct
name|part_map_1
name|pm1
decl_stmt|;
name|struct
name|part_map_2
name|pm2
decl_stmt|;
name|struct
name|part_map_virt
name|pmv
decl_stmt|;
name|struct
name|part_map_spare
name|pms
decl_stmt|;
block|}
union|;
end_union

begin_comment
comment|/* Sparing Map Entry [UDF 2.01/2.2.11] */
end_comment

begin_struct
struct|struct
name|spare_map_entry
block|{
name|uint32_t
name|org
decl_stmt|;
name|uint32_t
name|map
decl_stmt|;
block|}
name|__packed
struct|;
end_struct

begin_comment
comment|/* Sparing Table [UDF 2.01/2.2.11] */
end_comment

begin_struct
struct|struct
name|udf_sparing_table
block|{
name|struct
name|desc_tag
name|tag
decl_stmt|;
name|struct
name|regid
name|id
decl_stmt|;
name|uint16_t
name|rt_l
decl_stmt|;
comment|/* Relocation Table len */
name|uint8_t
name|reserved
index|[
literal|2
index|]
decl_stmt|;
name|uint32_t
name|seq_num
decl_stmt|;
name|struct
name|spare_map_entry
name|entries
index|[
literal|1
index|]
decl_stmt|;
block|}
name|__packed
struct|;
end_struct

begin_comment
comment|/* Partition Descriptor [3/10.5] */
end_comment

begin_struct
struct|struct
name|part_desc
block|{
name|struct
name|desc_tag
name|tag
decl_stmt|;
name|uint32_t
name|seq_num
decl_stmt|;
name|uint16_t
name|flags
decl_stmt|;
name|uint16_t
name|part_num
decl_stmt|;
name|struct
name|regid
name|contents
decl_stmt|;
name|uint8_t
name|contents_use
index|[
literal|128
index|]
decl_stmt|;
name|uint32_t
name|access_type
decl_stmt|;
name|uint32_t
name|start_loc
decl_stmt|;
name|uint32_t
name|part_len
decl_stmt|;
name|struct
name|regid
name|imp_id
decl_stmt|;
name|uint8_t
name|imp_use
index|[
literal|128
index|]
decl_stmt|;
name|uint8_t
name|reserved
index|[
literal|156
index|]
decl_stmt|;
block|}
name|__packed
struct|;
end_struct

begin_comment
comment|/* File Set Descriptor [4/14.1] */
end_comment

begin_struct
struct|struct
name|fileset_desc
block|{
name|struct
name|desc_tag
name|tag
decl_stmt|;
name|struct
name|timestamp
name|time
decl_stmt|;
name|uint16_t
name|ichg_lvl
decl_stmt|;
name|uint16_t
name|max_ichg_lvl
decl_stmt|;
name|uint32_t
name|charset_list
decl_stmt|;
name|uint32_t
name|max_charset_list
decl_stmt|;
name|uint32_t
name|fileset_num
decl_stmt|;
name|uint32_t
name|fileset_desc_num
decl_stmt|;
name|struct
name|charspec
name|logvol_id_charset
decl_stmt|;
name|char
name|logvol_id
index|[
literal|128
index|]
decl_stmt|;
name|struct
name|charspec
name|fileset_charset
decl_stmt|;
name|char
name|fileset_id
index|[
literal|32
index|]
decl_stmt|;
name|char
name|copyright_file_id
index|[
literal|32
index|]
decl_stmt|;
name|char
name|abstract_file_id
index|[
literal|32
index|]
decl_stmt|;
name|struct
name|long_ad
name|rootdir_icb
decl_stmt|;
name|struct
name|regid
name|domain_id
decl_stmt|;
name|struct
name|long_ad
name|next_ex
decl_stmt|;
name|struct
name|long_ad
name|streamdir_icb
decl_stmt|;
name|uint8_t
name|reserved
index|[
literal|32
index|]
decl_stmt|;
block|}
name|__packed
struct|;
end_struct

begin_comment
comment|/* File Identifier Descriptor [4/14.4] */
end_comment

begin_struct
struct|struct
name|fileid_desc
block|{
name|struct
name|desc_tag
name|tag
decl_stmt|;
name|uint16_t
name|file_num
decl_stmt|;
name|uint8_t
name|file_char
decl_stmt|;
name|uint8_t
name|l_fi
decl_stmt|;
comment|/* Length of file identifier area */
name|struct
name|long_ad
name|icb
decl_stmt|;
name|uint16_t
name|l_iu
decl_stmt|;
comment|/* Length of implementation use area */
name|uint8_t
name|data
index|[
literal|1
index|]
decl_stmt|;
block|}
name|__packed
struct|;
end_struct

begin_define
define|#
directive|define
name|UDF_FID_SIZE
value|38
end_define

begin_define
define|#
directive|define
name|UDF_FILE_CHAR_VIS
value|(1<< 0)
end_define

begin_comment
comment|/* Visible */
end_comment

begin_define
define|#
directive|define
name|UDF_FILE_CHAR_DIR
value|(1<< 1)
end_define

begin_comment
comment|/* Directory */
end_comment

begin_define
define|#
directive|define
name|UDF_FILE_CHAR_DEL
value|(1<< 2)
end_define

begin_comment
comment|/* Deleted */
end_comment

begin_define
define|#
directive|define
name|UDF_FILE_CHAR_PAR
value|(1<< 3)
end_define

begin_comment
comment|/* Parent Directory */
end_comment

begin_define
define|#
directive|define
name|UDF_FILE_CHAR_META
value|(1<< 4)
end_define

begin_comment
comment|/* Stream metadata */
end_comment

begin_comment
comment|/* File Entry [4/14.9] */
end_comment

begin_struct
struct|struct
name|file_entry
block|{
name|struct
name|desc_tag
name|tag
decl_stmt|;
name|struct
name|icb_tag
name|icbtag
decl_stmt|;
name|uint32_t
name|uid
decl_stmt|;
name|uint32_t
name|gid
decl_stmt|;
name|uint32_t
name|perm
decl_stmt|;
name|uint16_t
name|link_cnt
decl_stmt|;
name|uint8_t
name|rec_format
decl_stmt|;
name|uint8_t
name|rec_disp_attr
decl_stmt|;
name|uint32_t
name|rec_len
decl_stmt|;
name|uint64_t
name|inf_len
decl_stmt|;
name|uint64_t
name|logblks_rec
decl_stmt|;
name|struct
name|timestamp
name|atime
decl_stmt|;
name|struct
name|timestamp
name|mtime
decl_stmt|;
name|struct
name|timestamp
name|attrtime
decl_stmt|;
name|uint32_t
name|ckpoint
decl_stmt|;
name|struct
name|long_ad
name|ex_attr_icb
decl_stmt|;
name|struct
name|regid
name|imp_id
decl_stmt|;
name|uint64_t
name|unique_id
decl_stmt|;
name|uint32_t
name|l_ea
decl_stmt|;
comment|/* Length of extended attribute area */
name|uint32_t
name|l_ad
decl_stmt|;
comment|/* Length of allocation descriptors */
name|uint8_t
name|data
index|[
literal|1
index|]
decl_stmt|;
block|}
name|__packed
struct|;
end_struct

begin_define
define|#
directive|define
name|UDF_FENTRY_SIZE
value|176
end_define

begin_define
define|#
directive|define
name|UDF_FENTRY_PERM_USER_MASK
value|0x07
end_define

begin_define
define|#
directive|define
name|UDF_FENTRY_PERM_GRP_MASK
value|0xE0
end_define

begin_define
define|#
directive|define
name|UDF_FENTRY_PERM_OWNER_MASK
value|0x1C00
end_define

begin_union
union|union
name|dscrptr
block|{
name|struct
name|desc_tag
name|tag
decl_stmt|;
name|struct
name|anchor_vdp
name|avdp
decl_stmt|;
name|struct
name|vol_desc_ptr
name|vdp
decl_stmt|;
name|struct
name|pri_vol_desc
name|pvd
decl_stmt|;
name|struct
name|logvol_desc
name|lvd
decl_stmt|;
name|struct
name|part_desc
name|pd
decl_stmt|;
name|struct
name|fileset_desc
name|fsd
decl_stmt|;
name|struct
name|fileid_desc
name|fid
decl_stmt|;
name|struct
name|file_entry
name|fe
decl_stmt|;
block|}
union|;
end_union

begin_comment
comment|/* Useful defines */
end_comment

begin_define
define|#
directive|define
name|GETICB
parameter_list|(
name|ad_type
parameter_list|,
name|fentry
parameter_list|,
name|offset
parameter_list|)
define|\
value|(struct ad_type *)&fentry->data[offset]
end_define

begin_define
define|#
directive|define
name|GETICBLEN
parameter_list|(
name|ad_type
parameter_list|,
name|icb
parameter_list|)
value|le32toh(((struct ad_type *)(icb))->len)
end_define

end_unit


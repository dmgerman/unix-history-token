begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2010, 2012 Zheng Liu<lz@freebsd.org>  * Copyright (c) 2012, Vyacheslav Matyushin  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/namei.h>
end_include

begin_include
include|#
directive|include
file|<sys/bio.h>
end_include

begin_include
include|#
directive|include
file|<sys/buf.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|<sys/mount.h>
end_include

begin_include
include|#
directive|include
file|<sys/vnode.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/dirent.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<ufs/ufs/dir.h>
end_include

begin_include
include|#
directive|include
file|<fs/ext2fs/inode.h>
end_include

begin_include
include|#
directive|include
file|<fs/ext2fs/ext2_mount.h>
end_include

begin_include
include|#
directive|include
file|<fs/ext2fs/ext2fs.h>
end_include

begin_include
include|#
directive|include
file|<fs/ext2fs/fs.h>
end_include

begin_include
include|#
directive|include
file|<fs/ext2fs/ext2_extern.h>
end_include

begin_include
include|#
directive|include
file|<fs/ext2fs/ext2_dinode.h>
end_include

begin_include
include|#
directive|include
file|<fs/ext2fs/ext2_dir.h>
end_include

begin_include
include|#
directive|include
file|<fs/ext2fs/htree.h>
end_include

begin_function_decl
specifier|static
name|void
name|ext2_append_entry
parameter_list|(
name|char
modifier|*
name|block
parameter_list|,
name|uint32_t
name|blksize
parameter_list|,
name|struct
name|ext2fs_direct_2
modifier|*
name|last_entry
parameter_list|,
name|struct
name|ext2fs_direct_2
modifier|*
name|new_entry
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ext2_htree_append_block
parameter_list|(
name|struct
name|vnode
modifier|*
name|vp
parameter_list|,
name|char
modifier|*
name|data
parameter_list|,
name|struct
name|componentname
modifier|*
name|cnp
parameter_list|,
name|uint32_t
name|blksize
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ext2_htree_check_next
parameter_list|(
name|struct
name|inode
modifier|*
name|ip
parameter_list|,
name|uint32_t
name|hash
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|struct
name|ext2fs_htree_lookup_info
modifier|*
name|info
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ext2_htree_cmp_sort_entry
parameter_list|(
specifier|const
name|void
modifier|*
name|e1
parameter_list|,
specifier|const
name|void
modifier|*
name|e2
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ext2_htree_find_leaf
parameter_list|(
name|struct
name|inode
modifier|*
name|ip
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|int
name|namelen
parameter_list|,
name|uint32_t
modifier|*
name|hash
parameter_list|,
name|uint8_t
modifier|*
name|hash_version
parameter_list|,
name|struct
name|ext2fs_htree_lookup_info
modifier|*
name|info
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|ext2_htree_get_block
parameter_list|(
name|struct
name|ext2fs_htree_entry
modifier|*
name|ep
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
name|ext2_htree_get_count
parameter_list|(
name|struct
name|ext2fs_htree_entry
modifier|*
name|ep
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|ext2_htree_get_hash
parameter_list|(
name|struct
name|ext2fs_htree_entry
modifier|*
name|ep
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
name|ext2_htree_get_limit
parameter_list|(
name|struct
name|ext2fs_htree_entry
modifier|*
name|ep
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ext2_htree_insert_entry_to_level
parameter_list|(
name|struct
name|ext2fs_htree_lookup_level
modifier|*
name|level
parameter_list|,
name|uint32_t
name|hash
parameter_list|,
name|uint32_t
name|blk
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ext2_htree_insert_entry
parameter_list|(
name|struct
name|ext2fs_htree_lookup_info
modifier|*
name|info
parameter_list|,
name|uint32_t
name|hash
parameter_list|,
name|uint32_t
name|blk
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|ext2_htree_node_limit
parameter_list|(
name|struct
name|inode
modifier|*
name|ip
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ext2_htree_set_block
parameter_list|(
name|struct
name|ext2fs_htree_entry
modifier|*
name|ep
parameter_list|,
name|uint32_t
name|blk
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ext2_htree_set_count
parameter_list|(
name|struct
name|ext2fs_htree_entry
modifier|*
name|ep
parameter_list|,
name|uint16_t
name|cnt
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ext2_htree_set_hash
parameter_list|(
name|struct
name|ext2fs_htree_entry
modifier|*
name|ep
parameter_list|,
name|uint32_t
name|hash
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ext2_htree_set_limit
parameter_list|(
name|struct
name|ext2fs_htree_entry
modifier|*
name|ep
parameter_list|,
name|uint16_t
name|limit
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ext2_htree_split_dirblock
parameter_list|(
name|char
modifier|*
name|block1
parameter_list|,
name|char
modifier|*
name|block2
parameter_list|,
name|uint32_t
name|blksize
parameter_list|,
name|uint32_t
modifier|*
name|hash_seed
parameter_list|,
name|uint8_t
name|hash_version
parameter_list|,
name|uint32_t
modifier|*
name|split_hash
parameter_list|,
name|struct
name|ext2fs_direct_2
modifier|*
name|entry
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ext2_htree_release
parameter_list|(
name|struct
name|ext2fs_htree_lookup_info
modifier|*
name|info
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|ext2_htree_root_limit
parameter_list|(
name|struct
name|inode
modifier|*
name|ip
parameter_list|,
name|int
name|len
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ext2_htree_writebuf
parameter_list|(
name|struct
name|ext2fs_htree_lookup_info
modifier|*
name|info
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|int
name|ext2_htree_has_idx
parameter_list|(
name|struct
name|inode
modifier|*
name|ip
parameter_list|)
block|{
if|if
condition|(
name|EXT2_HAS_COMPAT_FEATURE
argument_list|(
name|ip
operator|->
name|i_e2fs
argument_list|,
name|EXT2F_COMPAT_DIRHASHINDEX
argument_list|)
operator|&&
name|ip
operator|->
name|i_flag
operator|&
name|IN_E4INDEX
condition|)
return|return
operator|(
literal|1
operator|)
return|;
else|else
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ext2_htree_check_next
parameter_list|(
name|struct
name|inode
modifier|*
name|ip
parameter_list|,
name|uint32_t
name|hash
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|struct
name|ext2fs_htree_lookup_info
modifier|*
name|info
parameter_list|)
block|{
name|struct
name|vnode
modifier|*
name|vp
init|=
name|ITOV
argument_list|(
name|ip
argument_list|)
decl_stmt|;
name|struct
name|ext2fs_htree_lookup_level
modifier|*
name|level
decl_stmt|;
name|struct
name|buf
modifier|*
name|bp
decl_stmt|;
name|uint32_t
name|next_hash
decl_stmt|;
name|int
name|idx
init|=
name|info
operator|->
name|h_levels_num
operator|-
literal|1
decl_stmt|;
name|int
name|levels
init|=
literal|0
decl_stmt|;
do|do
block|{
name|level
operator|=
operator|&
name|info
operator|->
name|h_levels
index|[
name|idx
index|]
expr_stmt|;
name|level
operator|->
name|h_entry
operator|++
expr_stmt|;
if|if
condition|(
name|level
operator|->
name|h_entry
operator|<
name|level
operator|->
name|h_entries
operator|+
name|ext2_htree_get_count
argument_list|(
name|level
operator|->
name|h_entries
argument_list|)
condition|)
break|break;
if|if
condition|(
name|idx
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|idx
operator|--
expr_stmt|;
name|levels
operator|++
expr_stmt|;
block|}
do|while
condition|(
literal|1
condition|)
do|;
name|next_hash
operator|=
name|ext2_htree_get_hash
argument_list|(
name|level
operator|->
name|h_entry
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|hash
operator|&
literal|1
operator|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hash
operator|!=
operator|(
name|next_hash
operator|&
operator|~
literal|1
operator|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
block|}
while|while
condition|(
name|levels
operator|>
literal|0
condition|)
block|{
name|levels
operator|--
expr_stmt|;
if|if
condition|(
name|ext2_blkatoff
argument_list|(
name|vp
argument_list|,
name|ext2_htree_get_block
argument_list|(
name|level
operator|->
name|h_entry
argument_list|)
operator|*
name|ip
operator|->
name|i_e2fs
operator|->
name|e2fs_bsize
argument_list|,
name|NULL
argument_list|,
operator|&
name|bp
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|level
operator|=
operator|&
name|info
operator|->
name|h_levels
index|[
name|idx
operator|+
literal|1
index|]
expr_stmt|;
name|brelse
argument_list|(
name|level
operator|->
name|h_bp
argument_list|)
expr_stmt|;
name|level
operator|->
name|h_bp
operator|=
name|bp
expr_stmt|;
name|level
operator|->
name|h_entry
operator|=
name|level
operator|->
name|h_entries
operator|=
operator|(
operator|(
expr|struct
name|ext2fs_htree_node
operator|*
operator|)
name|bp
operator|->
name|b_data
operator|)
operator|->
name|h_entries
expr_stmt|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|ext2_htree_get_block
parameter_list|(
name|struct
name|ext2fs_htree_entry
modifier|*
name|ep
parameter_list|)
block|{
return|return
operator|(
name|ep
operator|->
name|h_blk
operator|&
literal|0x00FFFFFF
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ext2_htree_set_block
parameter_list|(
name|struct
name|ext2fs_htree_entry
modifier|*
name|ep
parameter_list|,
name|uint32_t
name|blk
parameter_list|)
block|{
name|ep
operator|->
name|h_blk
operator|=
name|blk
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|uint16_t
name|ext2_htree_get_count
parameter_list|(
name|struct
name|ext2fs_htree_entry
modifier|*
name|ep
parameter_list|)
block|{
return|return
operator|(
operator|(
operator|(
expr|struct
name|ext2fs_htree_count
operator|*
operator|)
operator|(
name|ep
operator|)
operator|)
operator|->
name|h_entries_num
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ext2_htree_set_count
parameter_list|(
name|struct
name|ext2fs_htree_entry
modifier|*
name|ep
parameter_list|,
name|uint16_t
name|cnt
parameter_list|)
block|{
operator|(
operator|(
expr|struct
name|ext2fs_htree_count
operator|*
operator|)
operator|(
name|ep
operator|)
operator|)
operator|->
name|h_entries_num
operator|=
name|cnt
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|ext2_htree_get_hash
parameter_list|(
name|struct
name|ext2fs_htree_entry
modifier|*
name|ep
parameter_list|)
block|{
return|return
operator|(
name|ep
operator|->
name|h_hash
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint16_t
name|ext2_htree_get_limit
parameter_list|(
name|struct
name|ext2fs_htree_entry
modifier|*
name|ep
parameter_list|)
block|{
return|return
operator|(
operator|(
operator|(
expr|struct
name|ext2fs_htree_count
operator|*
operator|)
operator|(
name|ep
operator|)
operator|)
operator|->
name|h_entries_max
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ext2_htree_set_hash
parameter_list|(
name|struct
name|ext2fs_htree_entry
modifier|*
name|ep
parameter_list|,
name|uint32_t
name|hash
parameter_list|)
block|{
name|ep
operator|->
name|h_hash
operator|=
name|hash
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ext2_htree_set_limit
parameter_list|(
name|struct
name|ext2fs_htree_entry
modifier|*
name|ep
parameter_list|,
name|uint16_t
name|limit
parameter_list|)
block|{
operator|(
operator|(
expr|struct
name|ext2fs_htree_count
operator|*
operator|)
operator|(
name|ep
operator|)
operator|)
operator|->
name|h_entries_max
operator|=
name|limit
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ext2_htree_release
parameter_list|(
name|struct
name|ext2fs_htree_lookup_info
modifier|*
name|info
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|info
operator|->
name|h_levels_num
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|buf
modifier|*
name|bp
init|=
name|info
operator|->
name|h_levels
index|[
name|i
index|]
operator|.
name|h_bp
decl_stmt|;
if|if
condition|(
name|bp
operator|!=
name|NULL
condition|)
name|brelse
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|ext2_htree_root_limit
parameter_list|(
name|struct
name|inode
modifier|*
name|ip
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|uint32_t
name|space
decl_stmt|;
name|space
operator|=
name|ip
operator|->
name|i_e2fs
operator|->
name|e2fs_bsize
operator|-
name|EXT2_DIR_REC_LEN
argument_list|(
literal|1
argument_list|)
operator|-
name|EXT2_DIR_REC_LEN
argument_list|(
literal|2
argument_list|)
operator|-
name|len
expr_stmt|;
return|return
operator|(
name|space
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|ext2fs_htree_entry
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|ext2_htree_node_limit
parameter_list|(
name|struct
name|inode
modifier|*
name|ip
parameter_list|)
block|{
name|struct
name|m_ext2fs
modifier|*
name|fs
decl_stmt|;
name|uint32_t
name|space
decl_stmt|;
name|fs
operator|=
name|ip
operator|->
name|i_e2fs
expr_stmt|;
name|space
operator|=
name|fs
operator|->
name|e2fs_bsize
operator|-
name|EXT2_DIR_REC_LEN
argument_list|(
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|space
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|ext2fs_htree_entry
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ext2_htree_find_leaf
parameter_list|(
name|struct
name|inode
modifier|*
name|ip
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|int
name|namelen
parameter_list|,
name|uint32_t
modifier|*
name|hash
parameter_list|,
name|uint8_t
modifier|*
name|hash_ver
parameter_list|,
name|struct
name|ext2fs_htree_lookup_info
modifier|*
name|info
parameter_list|)
block|{
name|struct
name|vnode
modifier|*
name|vp
decl_stmt|;
name|struct
name|ext2fs
modifier|*
name|fs
decl_stmt|;
name|struct
name|m_ext2fs
modifier|*
name|m_fs
decl_stmt|;
name|struct
name|buf
modifier|*
name|bp
init|=
name|NULL
decl_stmt|;
name|struct
name|ext2fs_htree_root
modifier|*
name|rootp
decl_stmt|;
name|struct
name|ext2fs_htree_entry
modifier|*
name|entp
decl_stmt|,
modifier|*
name|start
decl_stmt|,
modifier|*
name|end
decl_stmt|,
modifier|*
name|middle
decl_stmt|,
modifier|*
name|found
decl_stmt|;
name|struct
name|ext2fs_htree_lookup_level
modifier|*
name|level_info
decl_stmt|;
name|uint32_t
name|hash_major
init|=
literal|0
decl_stmt|,
name|hash_minor
init|=
literal|0
decl_stmt|;
name|uint32_t
name|levels
decl_stmt|,
name|cnt
decl_stmt|;
name|uint8_t
name|hash_version
decl_stmt|;
if|if
condition|(
name|name
operator|==
name|NULL
operator|||
name|info
operator|==
name|NULL
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|vp
operator|=
name|ITOV
argument_list|(
name|ip
argument_list|)
expr_stmt|;
name|fs
operator|=
name|ip
operator|->
name|i_e2fs
operator|->
name|e2fs
expr_stmt|;
name|m_fs
operator|=
name|ip
operator|->
name|i_e2fs
expr_stmt|;
if|if
condition|(
name|ext2_blkatoff
argument_list|(
name|vp
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
operator|&
name|bp
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|info
operator|->
name|h_levels_num
operator|=
literal|1
expr_stmt|;
name|info
operator|->
name|h_levels
index|[
literal|0
index|]
operator|.
name|h_bp
operator|=
name|bp
expr_stmt|;
name|rootp
operator|=
operator|(
expr|struct
name|ext2fs_htree_root
operator|*
operator|)
name|bp
operator|->
name|b_data
expr_stmt|;
if|if
condition|(
name|rootp
operator|->
name|h_info
operator|.
name|h_hash_version
operator|!=
name|EXT2_HTREE_LEGACY
operator|&&
name|rootp
operator|->
name|h_info
operator|.
name|h_hash_version
operator|!=
name|EXT2_HTREE_HALF_MD4
operator|&&
name|rootp
operator|->
name|h_info
operator|.
name|h_hash_version
operator|!=
name|EXT2_HTREE_TEA
condition|)
goto|goto
name|error
goto|;
name|hash_version
operator|=
name|rootp
operator|->
name|h_info
operator|.
name|h_hash_version
expr_stmt|;
if|if
condition|(
name|hash_version
operator|<=
name|EXT2_HTREE_TEA
condition|)
name|hash_version
operator|+=
name|m_fs
operator|->
name|e2fs_uhash
expr_stmt|;
operator|*
name|hash_ver
operator|=
name|hash_version
expr_stmt|;
name|ext2_htree_hash
argument_list|(
name|name
argument_list|,
name|namelen
argument_list|,
name|fs
operator|->
name|e3fs_hash_seed
argument_list|,
name|hash_version
argument_list|,
operator|&
name|hash_major
argument_list|,
operator|&
name|hash_minor
argument_list|)
expr_stmt|;
operator|*
name|hash
operator|=
name|hash_major
expr_stmt|;
if|if
condition|(
operator|(
name|levels
operator|=
name|rootp
operator|->
name|h_info
operator|.
name|h_ind_levels
operator|)
operator|>
literal|1
condition|)
goto|goto
name|error
goto|;
name|entp
operator|=
operator|(
expr|struct
name|ext2fs_htree_entry
operator|*
operator|)
operator|(
operator|(
operator|(
name|char
operator|*
operator|)
operator|&
name|rootp
operator|->
name|h_info
operator|)
operator|+
name|rootp
operator|->
name|h_info
operator|.
name|h_info_len
operator|)
expr_stmt|;
if|if
condition|(
name|ext2_htree_get_limit
argument_list|(
name|entp
argument_list|)
operator|!=
name|ext2_htree_root_limit
argument_list|(
name|ip
argument_list|,
name|rootp
operator|->
name|h_info
operator|.
name|h_info_len
argument_list|)
condition|)
goto|goto
name|error
goto|;
while|while
condition|(
literal|1
condition|)
block|{
name|cnt
operator|=
name|ext2_htree_get_count
argument_list|(
name|entp
argument_list|)
expr_stmt|;
if|if
condition|(
name|cnt
operator|==
literal|0
operator|||
name|cnt
operator|>
name|ext2_htree_get_limit
argument_list|(
name|entp
argument_list|)
condition|)
goto|goto
name|error
goto|;
name|start
operator|=
name|entp
operator|+
literal|1
expr_stmt|;
name|end
operator|=
name|entp
operator|+
name|cnt
operator|-
literal|1
expr_stmt|;
while|while
condition|(
name|start
operator|<=
name|end
condition|)
block|{
name|middle
operator|=
name|start
operator|+
operator|(
name|end
operator|-
name|start
operator|)
operator|/
literal|2
expr_stmt|;
if|if
condition|(
name|ext2_htree_get_hash
argument_list|(
name|middle
argument_list|)
operator|>
name|hash_major
condition|)
name|end
operator|=
name|middle
operator|-
literal|1
expr_stmt|;
else|else
name|start
operator|=
name|middle
operator|+
literal|1
expr_stmt|;
block|}
name|found
operator|=
name|start
operator|-
literal|1
expr_stmt|;
name|level_info
operator|=
operator|&
operator|(
name|info
operator|->
name|h_levels
index|[
name|info
operator|->
name|h_levels_num
operator|-
literal|1
index|]
operator|)
expr_stmt|;
name|level_info
operator|->
name|h_bp
operator|=
name|bp
expr_stmt|;
name|level_info
operator|->
name|h_entries
operator|=
name|entp
expr_stmt|;
name|level_info
operator|->
name|h_entry
operator|=
name|found
expr_stmt|;
if|if
condition|(
name|levels
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|levels
operator|--
expr_stmt|;
if|if
condition|(
name|ext2_blkatoff
argument_list|(
name|vp
argument_list|,
name|ext2_htree_get_block
argument_list|(
name|found
argument_list|)
operator|*
name|m_fs
operator|->
name|e2fs_bsize
argument_list|,
name|NULL
argument_list|,
operator|&
name|bp
argument_list|)
operator|!=
literal|0
condition|)
goto|goto
name|error
goto|;
name|entp
operator|=
operator|(
operator|(
expr|struct
name|ext2fs_htree_node
operator|*
operator|)
name|bp
operator|->
name|b_data
operator|)
operator|->
name|h_entries
expr_stmt|;
name|info
operator|->
name|h_levels_num
operator|++
expr_stmt|;
name|info
operator|->
name|h_levels
index|[
name|info
operator|->
name|h_levels_num
operator|-
literal|1
index|]
operator|.
name|h_bp
operator|=
name|bp
expr_stmt|;
block|}
name|error
label|:
name|ext2_htree_release
argument_list|(
name|info
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Try to lookup a directory entry in HTree index  */
end_comment

begin_function
name|int
name|ext2_htree_lookup
parameter_list|(
name|struct
name|inode
modifier|*
name|ip
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|int
name|namelen
parameter_list|,
name|struct
name|buf
modifier|*
modifier|*
name|bpp
parameter_list|,
name|int
modifier|*
name|entryoffp
parameter_list|,
name|doff_t
modifier|*
name|offp
parameter_list|,
name|doff_t
modifier|*
name|prevoffp
parameter_list|,
name|doff_t
modifier|*
name|endusefulp
parameter_list|,
name|struct
name|ext2fs_searchslot
modifier|*
name|ss
parameter_list|)
block|{
name|struct
name|vnode
modifier|*
name|vp
decl_stmt|;
name|struct
name|ext2fs_htree_lookup_info
name|info
decl_stmt|;
name|struct
name|ext2fs_htree_entry
modifier|*
name|leaf_node
decl_stmt|;
name|struct
name|m_ext2fs
modifier|*
name|m_fs
decl_stmt|;
name|struct
name|buf
modifier|*
name|bp
decl_stmt|;
name|uint32_t
name|blk
decl_stmt|;
name|uint32_t
name|dirhash
decl_stmt|;
name|uint32_t
name|bsize
decl_stmt|;
name|uint8_t
name|hash_version
decl_stmt|;
name|int
name|search_next
decl_stmt|;
name|int
name|found
init|=
literal|0
decl_stmt|;
name|m_fs
operator|=
name|ip
operator|->
name|i_e2fs
expr_stmt|;
name|bsize
operator|=
name|m_fs
operator|->
name|e2fs_bsize
expr_stmt|;
name|vp
operator|=
name|ITOV
argument_list|(
name|ip
argument_list|)
expr_stmt|;
comment|/* TODO: print error msg because we don't lookup '.' and '..' */
name|memset
argument_list|(
operator|&
name|info
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|info
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ext2_htree_find_leaf
argument_list|(
name|ip
argument_list|,
name|name
argument_list|,
name|namelen
argument_list|,
operator|&
name|dirhash
argument_list|,
operator|&
name|hash_version
argument_list|,
operator|&
name|info
argument_list|)
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
do|do
block|{
name|leaf_node
operator|=
name|info
operator|.
name|h_levels
index|[
name|info
operator|.
name|h_levels_num
operator|-
literal|1
index|]
operator|.
name|h_entry
expr_stmt|;
name|blk
operator|=
name|ext2_htree_get_block
argument_list|(
name|leaf_node
argument_list|)
expr_stmt|;
if|if
condition|(
name|ext2_blkatoff
argument_list|(
name|vp
argument_list|,
name|blk
operator|*
name|bsize
argument_list|,
name|NULL
argument_list|,
operator|&
name|bp
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|ext2_htree_release
argument_list|(
operator|&
name|info
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
operator|*
name|offp
operator|=
name|blk
operator|*
name|bsize
expr_stmt|;
operator|*
name|entryoffp
operator|=
literal|0
expr_stmt|;
operator|*
name|prevoffp
operator|=
name|blk
operator|*
name|bsize
expr_stmt|;
operator|*
name|endusefulp
operator|=
name|blk
operator|*
name|bsize
expr_stmt|;
if|if
condition|(
name|ss
operator|->
name|slotstatus
operator|==
name|NONE
condition|)
block|{
name|ss
operator|->
name|slotoffset
operator|=
operator|-
literal|1
expr_stmt|;
name|ss
operator|->
name|slotfreespace
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|ext2_search_dirblock
argument_list|(
name|ip
argument_list|,
name|bp
operator|->
name|b_data
argument_list|,
operator|&
name|found
argument_list|,
name|name
argument_list|,
name|namelen
argument_list|,
name|entryoffp
argument_list|,
name|offp
argument_list|,
name|prevoffp
argument_list|,
name|endusefulp
argument_list|,
name|ss
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|brelse
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|ext2_htree_release
argument_list|(
operator|&
name|info
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|found
condition|)
block|{
operator|*
name|bpp
operator|=
name|bp
expr_stmt|;
name|ext2_htree_release
argument_list|(
operator|&
name|info
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|brelse
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|search_next
operator|=
name|ext2_htree_check_next
argument_list|(
name|ip
argument_list|,
name|dirhash
argument_list|,
name|name
argument_list|,
operator|&
name|info
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|search_next
condition|)
do|;
name|ext2_htree_release
argument_list|(
operator|&
name|info
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOENT
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ext2_htree_append_block
parameter_list|(
name|struct
name|vnode
modifier|*
name|vp
parameter_list|,
name|char
modifier|*
name|data
parameter_list|,
name|struct
name|componentname
modifier|*
name|cnp
parameter_list|,
name|uint32_t
name|blksize
parameter_list|)
block|{
name|struct
name|iovec
name|aiov
decl_stmt|;
name|struct
name|uio
name|auio
decl_stmt|;
name|struct
name|inode
modifier|*
name|dp
init|=
name|VTOI
argument_list|(
name|vp
argument_list|)
decl_stmt|;
name|uint64_t
name|cursize
decl_stmt|,
name|newsize
decl_stmt|;
name|int
name|error
decl_stmt|;
name|cursize
operator|=
name|roundup
argument_list|(
name|dp
operator|->
name|i_size
argument_list|,
name|blksize
argument_list|)
expr_stmt|;
name|newsize
operator|=
name|roundup
argument_list|(
name|dp
operator|->
name|i_size
argument_list|,
name|blksize
argument_list|)
operator|+
name|blksize
expr_stmt|;
name|auio
operator|.
name|uio_offset
operator|=
name|cursize
expr_stmt|;
name|auio
operator|.
name|uio_resid
operator|=
name|blksize
expr_stmt|;
name|aiov
operator|.
name|iov_len
operator|=
name|blksize
expr_stmt|;
name|aiov
operator|.
name|iov_base
operator|=
name|data
expr_stmt|;
name|auio
operator|.
name|uio_iov
operator|=
operator|&
name|aiov
expr_stmt|;
name|auio
operator|.
name|uio_iovcnt
operator|=
literal|1
expr_stmt|;
name|auio
operator|.
name|uio_rw
operator|=
name|UIO_WRITE
expr_stmt|;
name|auio
operator|.
name|uio_segflg
operator|=
name|UIO_SYSSPACE
expr_stmt|;
name|error
operator|=
name|VOP_WRITE
argument_list|(
name|vp
argument_list|,
operator|&
name|auio
argument_list|,
name|IO_SYNC
argument_list|,
name|cnp
operator|->
name|cn_cred
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
name|dp
operator|->
name|i_size
operator|=
name|newsize
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ext2_htree_writebuf
parameter_list|(
name|struct
name|ext2fs_htree_lookup_info
modifier|*
name|info
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|error
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|info
operator|->
name|h_levels_num
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|buf
modifier|*
name|bp
init|=
name|info
operator|->
name|h_levels
index|[
name|i
index|]
operator|.
name|h_bp
decl_stmt|;
name|error
operator|=
name|bwrite
argument_list|(
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ext2_htree_insert_entry_to_level
parameter_list|(
name|struct
name|ext2fs_htree_lookup_level
modifier|*
name|level
parameter_list|,
name|uint32_t
name|hash
parameter_list|,
name|uint32_t
name|blk
parameter_list|)
block|{
name|struct
name|ext2fs_htree_entry
modifier|*
name|target
decl_stmt|;
name|int
name|entries_num
decl_stmt|;
name|target
operator|=
name|level
operator|->
name|h_entry
operator|+
literal|1
expr_stmt|;
name|entries_num
operator|=
name|ext2_htree_get_count
argument_list|(
name|level
operator|->
name|h_entries
argument_list|)
expr_stmt|;
name|memmove
argument_list|(
name|target
operator|+
literal|1
argument_list|,
name|target
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|(
name|level
operator|->
name|h_entries
operator|+
name|entries_num
operator|)
operator|-
operator|(
name|char
operator|*
operator|)
name|target
argument_list|)
expr_stmt|;
name|ext2_htree_set_block
argument_list|(
name|target
argument_list|,
name|blk
argument_list|)
expr_stmt|;
name|ext2_htree_set_hash
argument_list|(
name|target
argument_list|,
name|hash
argument_list|)
expr_stmt|;
name|ext2_htree_set_count
argument_list|(
name|level
operator|->
name|h_entries
argument_list|,
name|entries_num
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Insert an index entry to the index node.  */
end_comment

begin_function
specifier|static
name|void
name|ext2_htree_insert_entry
parameter_list|(
name|struct
name|ext2fs_htree_lookup_info
modifier|*
name|info
parameter_list|,
name|uint32_t
name|hash
parameter_list|,
name|uint32_t
name|blk
parameter_list|)
block|{
name|struct
name|ext2fs_htree_lookup_level
modifier|*
name|level
decl_stmt|;
name|level
operator|=
operator|&
name|info
operator|->
name|h_levels
index|[
name|info
operator|->
name|h_levels_num
operator|-
literal|1
index|]
expr_stmt|;
name|ext2_htree_insert_entry_to_level
argument_list|(
name|level
argument_list|,
name|hash
argument_list|,
name|blk
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Compare two entry sort descriptors by name hash value.  * This is used together with qsort.  */
end_comment

begin_function
specifier|static
name|int
name|ext2_htree_cmp_sort_entry
parameter_list|(
specifier|const
name|void
modifier|*
name|e1
parameter_list|,
specifier|const
name|void
modifier|*
name|e2
parameter_list|)
block|{
specifier|const
name|struct
name|ext2fs_htree_sort_entry
modifier|*
name|entry1
decl_stmt|,
modifier|*
name|entry2
decl_stmt|;
name|entry1
operator|=
operator|(
specifier|const
expr|struct
name|ext2fs_htree_sort_entry
operator|*
operator|)
name|e1
expr_stmt|;
name|entry2
operator|=
operator|(
specifier|const
expr|struct
name|ext2fs_htree_sort_entry
operator|*
operator|)
name|e2
expr_stmt|;
if|if
condition|(
name|entry1
operator|->
name|h_hash
operator|<
name|entry2
operator|->
name|h_hash
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|entry2
operator|->
name|h_hash
operator|>
name|entry2
operator|->
name|h_hash
condition|)
return|return
operator|(
literal|1
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Append an entry to the end of the directory block.  */
end_comment

begin_function
specifier|static
name|void
name|ext2_append_entry
parameter_list|(
name|char
modifier|*
name|block
parameter_list|,
name|uint32_t
name|blksize
parameter_list|,
name|struct
name|ext2fs_direct_2
modifier|*
name|last_entry
parameter_list|,
name|struct
name|ext2fs_direct_2
modifier|*
name|new_entry
parameter_list|)
block|{
name|uint16_t
name|entry_len
decl_stmt|;
name|entry_len
operator|=
name|EXT2_DIR_REC_LEN
argument_list|(
name|last_entry
operator|->
name|e2d_namlen
argument_list|)
expr_stmt|;
name|last_entry
operator|->
name|e2d_reclen
operator|=
name|entry_len
expr_stmt|;
name|last_entry
operator|=
operator|(
expr|struct
name|ext2fs_direct_2
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|last_entry
operator|+
name|entry_len
operator|)
expr_stmt|;
name|new_entry
operator|->
name|e2d_reclen
operator|=
name|block
operator|+
name|blksize
operator|-
operator|(
name|char
operator|*
operator|)
name|last_entry
expr_stmt|;
name|memcpy
argument_list|(
name|last_entry
argument_list|,
name|new_entry
argument_list|,
name|EXT2_DIR_REC_LEN
argument_list|(
name|new_entry
operator|->
name|e2d_namlen
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Move half of entries from the old directory block to the new one.  */
end_comment

begin_function
specifier|static
name|int
name|ext2_htree_split_dirblock
parameter_list|(
name|char
modifier|*
name|block1
parameter_list|,
name|char
modifier|*
name|block2
parameter_list|,
name|uint32_t
name|blksize
parameter_list|,
name|uint32_t
modifier|*
name|hash_seed
parameter_list|,
name|uint8_t
name|hash_version
parameter_list|,
name|uint32_t
modifier|*
name|split_hash
parameter_list|,
name|struct
name|ext2fs_direct_2
modifier|*
name|entry
parameter_list|)
block|{
name|int
name|entry_cnt
init|=
literal|0
decl_stmt|;
name|int
name|size
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|,
name|k
decl_stmt|;
name|uint32_t
name|offset
decl_stmt|;
name|uint16_t
name|entry_len
init|=
literal|0
decl_stmt|;
name|uint32_t
name|entry_hash
decl_stmt|;
name|struct
name|ext2fs_direct_2
modifier|*
name|ep
decl_stmt|,
modifier|*
name|last
decl_stmt|;
name|char
modifier|*
name|dest
decl_stmt|;
name|struct
name|ext2fs_htree_sort_entry
modifier|*
name|sort_info
decl_stmt|;
name|ep
operator|=
operator|(
expr|struct
name|ext2fs_direct_2
operator|*
operator|)
name|block1
expr_stmt|;
name|dest
operator|=
name|block2
expr_stmt|;
name|sort_info
operator|=
operator|(
expr|struct
name|ext2fs_htree_sort_entry
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|block2
operator|+
name|blksize
operator|)
expr_stmt|;
comment|/* 	 * Calculate name hash value for the entry which is to be added. 	 */
name|ext2_htree_hash
argument_list|(
name|entry
operator|->
name|e2d_name
argument_list|,
name|entry
operator|->
name|e2d_namlen
argument_list|,
name|hash_seed
argument_list|,
name|hash_version
argument_list|,
operator|&
name|entry_hash
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* 	 * Fill in directory entry sort descriptors. 	 */
while|while
condition|(
operator|(
name|char
operator|*
operator|)
name|ep
operator|<
name|block1
operator|+
name|blksize
condition|)
block|{
if|if
condition|(
name|ep
operator|->
name|e2d_ino
operator|&&
name|ep
operator|->
name|e2d_namlen
condition|)
block|{
name|entry_cnt
operator|++
expr_stmt|;
name|sort_info
operator|--
expr_stmt|;
name|sort_info
operator|->
name|h_size
operator|=
name|ep
operator|->
name|e2d_reclen
expr_stmt|;
name|sort_info
operator|->
name|h_offset
operator|=
operator|(
name|char
operator|*
operator|)
name|ep
operator|-
name|block1
expr_stmt|;
name|ext2_htree_hash
argument_list|(
name|ep
operator|->
name|e2d_name
argument_list|,
name|ep
operator|->
name|e2d_namlen
argument_list|,
name|hash_seed
argument_list|,
name|hash_version
argument_list|,
operator|&
name|sort_info
operator|->
name|h_hash
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
name|ep
operator|=
operator|(
expr|struct
name|ext2fs_direct_2
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|ep
operator|+
name|ep
operator|->
name|e2d_reclen
operator|)
expr_stmt|;
block|}
comment|/* 	 * Sort directory entry descriptors by name hash value. 	 */
name|qsort
argument_list|(
name|sort_info
argument_list|,
name|entry_cnt
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ext2fs_htree_sort_entry
argument_list|)
argument_list|,
name|ext2_htree_cmp_sort_entry
argument_list|)
expr_stmt|;
comment|/* 	 * Count the number of entries to move to directory block 2. 	 */
for|for
control|(
name|i
operator|=
name|entry_cnt
operator|-
literal|1
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
block|{
if|if
condition|(
name|sort_info
index|[
name|i
index|]
operator|.
name|h_size
operator|+
name|size
operator|>
name|blksize
operator|/
literal|2
condition|)
break|break;
name|size
operator|+=
name|sort_info
index|[
name|i
index|]
operator|.
name|h_size
expr_stmt|;
block|}
operator|*
name|split_hash
operator|=
name|sort_info
index|[
name|i
operator|+
literal|1
index|]
operator|.
name|h_hash
expr_stmt|;
comment|/* 	 * Set collision bit. 	 */
if|if
condition|(
operator|*
name|split_hash
operator|==
name|sort_info
index|[
name|i
index|]
operator|.
name|h_hash
condition|)
operator|*
name|split_hash
operator|+=
literal|1
expr_stmt|;
comment|/* 	 * Move half of directory entries from block 1 to block 2. 	 */
for|for
control|(
name|k
operator|=
name|i
operator|+
literal|1
init|;
name|k
operator|<
name|entry_cnt
condition|;
name|k
operator|++
control|)
block|{
name|ep
operator|=
operator|(
expr|struct
name|ext2fs_direct_2
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|block1
operator|+
name|sort_info
index|[
name|k
index|]
operator|.
name|h_offset
operator|)
expr_stmt|;
name|entry_len
operator|=
name|EXT2_DIR_REC_LEN
argument_list|(
name|ep
operator|->
name|e2d_namlen
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|dest
argument_list|,
name|ep
argument_list|,
name|entry_len
argument_list|)
expr_stmt|;
operator|(
operator|(
expr|struct
name|ext2fs_direct_2
operator|*
operator|)
name|dest
operator|)
operator|->
name|e2d_reclen
operator|=
name|entry_len
expr_stmt|;
comment|/* Mark directory entry as unused. */
name|ep
operator|->
name|e2d_ino
operator|=
literal|0
expr_stmt|;
name|dest
operator|+=
name|entry_len
expr_stmt|;
block|}
name|dest
operator|-=
name|entry_len
expr_stmt|;
comment|/* Shrink directory entries in block 1. */
name|last
operator|=
operator|(
expr|struct
name|ext2fs_direct_2
operator|*
operator|)
name|block1
expr_stmt|;
name|entry_len
operator|=
name|EXT2_DIR_REC_LEN
argument_list|(
name|last
operator|->
name|e2d_namlen
argument_list|)
expr_stmt|;
for|for
control|(
name|offset
operator|=
name|last
operator|->
name|e2d_reclen
init|;
name|offset
operator|<
name|blksize
condition|;
control|)
block|{
name|ep
operator|=
operator|(
expr|struct
name|ext2fs_direct_2
operator|*
operator|)
operator|(
name|block1
operator|+
name|offset
operator|)
expr_stmt|;
name|offset
operator|+=
name|ep
operator|->
name|e2d_reclen
expr_stmt|;
if|if
condition|(
name|last
operator|->
name|e2d_ino
condition|)
block|{
comment|/* Trim the existing slot */
name|last
operator|->
name|e2d_reclen
operator|=
name|entry_len
expr_stmt|;
name|last
operator|=
operator|(
expr|struct
name|ext2fs_direct_2
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|last
operator|+
name|entry_len
operator|)
expr_stmt|;
block|}
name|entry_len
operator|=
name|EXT2_DIR_REC_LEN
argument_list|(
name|ep
operator|->
name|e2d_namlen
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|(
name|void
operator|*
operator|)
name|last
argument_list|,
operator|(
name|void
operator|*
operator|)
name|ep
argument_list|,
name|entry_len
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|entry_hash
operator|>=
operator|*
name|split_hash
condition|)
block|{
comment|/* Add entry to block 2. */
name|ext2_append_entry
argument_list|(
name|block2
argument_list|,
name|blksize
argument_list|,
operator|(
expr|struct
name|ext2fs_direct_2
operator|*
operator|)
name|dest
argument_list|,
name|entry
argument_list|)
expr_stmt|;
comment|/* Adjust length field of last entry of block 1. */
name|last
operator|->
name|e2d_reclen
operator|=
name|block1
operator|+
name|blksize
operator|-
operator|(
name|char
operator|*
operator|)
name|last
expr_stmt|;
block|}
else|else
block|{
comment|/* Add entry to block 1. */
name|ext2_append_entry
argument_list|(
name|block1
argument_list|,
name|blksize
argument_list|,
name|last
argument_list|,
name|entry
argument_list|)
expr_stmt|;
comment|/* Adjust length field of last entry of block 2. */
operator|(
operator|(
expr|struct
name|ext2fs_direct_2
operator|*
operator|)
name|dest
operator|)
operator|->
name|e2d_reclen
operator|=
name|block2
operator|+
name|blksize
operator|-
name|dest
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Create an HTree index for a directory  */
end_comment

begin_function
name|int
name|ext2_htree_create_index
parameter_list|(
name|struct
name|vnode
modifier|*
name|vp
parameter_list|,
name|struct
name|componentname
modifier|*
name|cnp
parameter_list|,
name|struct
name|ext2fs_direct_2
modifier|*
name|new_entry
parameter_list|)
block|{
name|struct
name|buf
modifier|*
name|bp
init|=
name|NULL
decl_stmt|;
name|struct
name|inode
modifier|*
name|dp
decl_stmt|;
name|struct
name|ext2fs
modifier|*
name|fs
decl_stmt|;
name|struct
name|m_ext2fs
modifier|*
name|m_fs
decl_stmt|;
name|struct
name|ext2fs_direct_2
modifier|*
name|ep
decl_stmt|,
modifier|*
name|dotdot
decl_stmt|;
name|struct
name|ext2fs_htree_root
modifier|*
name|root
decl_stmt|;
name|struct
name|ext2fs_htree_lookup_info
name|info
decl_stmt|;
name|uint32_t
name|blksize
decl_stmt|,
name|dirlen
decl_stmt|,
name|split_hash
decl_stmt|;
name|uint8_t
name|hash_version
decl_stmt|;
name|char
modifier|*
name|buf1
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|buf2
init|=
name|NULL
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|dp
operator|=
name|VTOI
argument_list|(
name|vp
argument_list|)
expr_stmt|;
name|fs
operator|=
name|dp
operator|->
name|i_e2fs
operator|->
name|e2fs
expr_stmt|;
name|m_fs
operator|=
name|dp
operator|->
name|i_e2fs
expr_stmt|;
name|blksize
operator|=
name|m_fs
operator|->
name|e2fs_bsize
expr_stmt|;
name|buf1
operator|=
name|malloc
argument_list|(
name|blksize
argument_list|,
name|M_TEMP
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|buf2
operator|=
name|malloc
argument_list|(
name|blksize
argument_list|,
name|M_TEMP
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|ext2_blkatoff
argument_list|(
name|vp
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
operator|&
name|bp
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|out
goto|;
name|root
operator|=
operator|(
expr|struct
name|ext2fs_htree_root
operator|*
operator|)
name|bp
operator|->
name|b_data
expr_stmt|;
name|dotdot
operator|=
operator|(
expr|struct
name|ext2fs_direct_2
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
operator|&
operator|(
name|root
operator|->
name|h_dotdot
operator|)
operator|)
expr_stmt|;
name|ep
operator|=
operator|(
expr|struct
name|ext2fs_direct_2
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|dotdot
operator|+
name|dotdot
operator|->
name|e2d_reclen
operator|)
expr_stmt|;
name|dirlen
operator|=
operator|(
name|char
operator|*
operator|)
name|root
operator|+
name|blksize
operator|-
operator|(
name|char
operator|*
operator|)
name|ep
expr_stmt|;
name|memcpy
argument_list|(
name|buf1
argument_list|,
name|ep
argument_list|,
name|dirlen
argument_list|)
expr_stmt|;
name|ep
operator|=
operator|(
expr|struct
name|ext2fs_direct_2
operator|*
operator|)
name|buf1
expr_stmt|;
while|while
condition|(
operator|(
name|char
operator|*
operator|)
name|ep
operator|<
name|buf1
operator|+
name|dirlen
condition|)
name|ep
operator|=
operator|(
expr|struct
name|ext2fs_direct_2
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|ep
operator|+
name|ep
operator|->
name|e2d_reclen
operator|)
expr_stmt|;
name|ep
operator|->
name|e2d_reclen
operator|=
name|buf1
operator|+
name|blksize
operator|-
operator|(
name|char
operator|*
operator|)
name|ep
expr_stmt|;
name|dp
operator|->
name|i_flag
operator||=
name|IN_E4INDEX
expr_stmt|;
comment|/* 	 * Initialize index root. 	 */
name|dotdot
operator|->
name|e2d_reclen
operator|=
name|blksize
operator|-
name|EXT2_DIR_REC_LEN
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|root
operator|->
name|h_info
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|root
operator|->
name|h_info
argument_list|)
argument_list|)
expr_stmt|;
name|root
operator|->
name|h_info
operator|.
name|h_hash_version
operator|=
name|fs
operator|->
name|e3fs_def_hash_version
expr_stmt|;
name|root
operator|->
name|h_info
operator|.
name|h_info_len
operator|=
sizeof|sizeof
argument_list|(
name|root
operator|->
name|h_info
argument_list|)
expr_stmt|;
name|ext2_htree_set_block
argument_list|(
name|root
operator|->
name|h_entries
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ext2_htree_set_count
argument_list|(
name|root
operator|->
name|h_entries
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ext2_htree_set_limit
argument_list|(
name|root
operator|->
name|h_entries
argument_list|,
name|ext2_htree_root_limit
argument_list|(
name|dp
argument_list|,
sizeof|sizeof
argument_list|(
name|root
operator|->
name|h_info
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|info
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|info
argument_list|)
argument_list|)
expr_stmt|;
name|info
operator|.
name|h_levels_num
operator|=
literal|1
expr_stmt|;
name|info
operator|.
name|h_levels
index|[
literal|0
index|]
operator|.
name|h_entries
operator|=
name|root
operator|->
name|h_entries
expr_stmt|;
name|info
operator|.
name|h_levels
index|[
literal|0
index|]
operator|.
name|h_entry
operator|=
name|root
operator|->
name|h_entries
expr_stmt|;
name|hash_version
operator|=
name|root
operator|->
name|h_info
operator|.
name|h_hash_version
expr_stmt|;
if|if
condition|(
name|hash_version
operator|<=
name|EXT2_HTREE_TEA
condition|)
name|hash_version
operator|+=
name|m_fs
operator|->
name|e2fs_uhash
expr_stmt|;
name|ext2_htree_split_dirblock
argument_list|(
name|buf1
argument_list|,
name|buf2
argument_list|,
name|blksize
argument_list|,
name|fs
operator|->
name|e3fs_hash_seed
argument_list|,
name|hash_version
argument_list|,
operator|&
name|split_hash
argument_list|,
name|new_entry
argument_list|)
expr_stmt|;
name|ext2_htree_insert_entry
argument_list|(
operator|&
name|info
argument_list|,
name|split_hash
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* 	 * Write directory block 0. 	 */
if|if
condition|(
name|DOINGASYNC
argument_list|(
name|vp
argument_list|)
condition|)
block|{
name|bdwrite
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|error
operator|=
name|bwrite
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
name|dp
operator|->
name|i_flag
operator||=
name|IN_CHANGE
operator||
name|IN_UPDATE
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|out
goto|;
comment|/* 	 * Write directory block 1. 	 */
name|error
operator|=
name|ext2_htree_append_block
argument_list|(
name|vp
argument_list|,
name|buf1
argument_list|,
name|cnp
argument_list|,
name|blksize
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|out1
goto|;
comment|/* 	 * Write directory block 2. 	 */
name|error
operator|=
name|ext2_htree_append_block
argument_list|(
name|vp
argument_list|,
name|buf2
argument_list|,
name|cnp
argument_list|,
name|blksize
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|buf1
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|buf2
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
name|out
label|:
if|if
condition|(
name|bp
operator|!=
name|NULL
condition|)
name|brelse
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|out1
label|:
name|free
argument_list|(
name|buf1
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|buf2
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Add an entry to the directory using htree index.  */
end_comment

begin_function
name|int
name|ext2_htree_add_entry
parameter_list|(
name|struct
name|vnode
modifier|*
name|dvp
parameter_list|,
name|struct
name|ext2fs_direct_2
modifier|*
name|entry
parameter_list|,
name|struct
name|componentname
modifier|*
name|cnp
parameter_list|)
block|{
name|struct
name|ext2fs_htree_entry
modifier|*
name|entries
decl_stmt|,
modifier|*
name|leaf_node
decl_stmt|;
name|struct
name|ext2fs_htree_lookup_info
name|info
decl_stmt|;
name|struct
name|buf
modifier|*
name|bp
init|=
name|NULL
decl_stmt|;
name|struct
name|ext2fs
modifier|*
name|fs
decl_stmt|;
name|struct
name|m_ext2fs
modifier|*
name|m_fs
decl_stmt|;
name|struct
name|inode
modifier|*
name|ip
decl_stmt|;
name|uint16_t
name|ent_num
decl_stmt|;
name|uint32_t
name|dirhash
decl_stmt|,
name|split_hash
decl_stmt|;
name|uint32_t
name|blksize
decl_stmt|,
name|blknum
decl_stmt|;
name|uint64_t
name|cursize
decl_stmt|,
name|dirsize
decl_stmt|;
name|uint8_t
name|hash_version
decl_stmt|;
name|char
modifier|*
name|newdirblock
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|newidxblock
init|=
name|NULL
decl_stmt|;
name|struct
name|ext2fs_htree_node
modifier|*
name|dst_node
decl_stmt|;
name|struct
name|ext2fs_htree_entry
modifier|*
name|dst_entries
decl_stmt|;
name|struct
name|ext2fs_htree_entry
modifier|*
name|root_entires
decl_stmt|;
name|struct
name|buf
modifier|*
name|dst_bp
init|=
name|NULL
decl_stmt|;
name|int
name|error
decl_stmt|,
name|write_bp
init|=
literal|0
decl_stmt|,
name|write_dst_bp
init|=
literal|0
decl_stmt|,
name|write_info
init|=
literal|0
decl_stmt|;
name|ip
operator|=
name|VTOI
argument_list|(
name|dvp
argument_list|)
expr_stmt|;
name|m_fs
operator|=
name|ip
operator|->
name|i_e2fs
expr_stmt|;
name|fs
operator|=
name|m_fs
operator|->
name|e2fs
expr_stmt|;
name|blksize
operator|=
name|m_fs
operator|->
name|e2fs_bsize
expr_stmt|;
if|if
condition|(
name|ip
operator|->
name|i_count
operator|!=
literal|0
condition|)
return|return
name|ext2_add_entry
argument_list|(
name|dvp
argument_list|,
name|entry
argument_list|)
return|;
comment|/* Target directory block is full, split it */
name|memset
argument_list|(
operator|&
name|info
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|info
argument_list|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|ext2_htree_find_leaf
argument_list|(
name|ip
argument_list|,
name|entry
operator|->
name|e2d_name
argument_list|,
name|entry
operator|->
name|e2d_namlen
argument_list|,
operator|&
name|dirhash
argument_list|,
operator|&
name|hash_version
argument_list|,
operator|&
name|info
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|entries
operator|=
name|info
operator|.
name|h_levels
index|[
name|info
operator|.
name|h_levels_num
operator|-
literal|1
index|]
operator|.
name|h_entries
expr_stmt|;
name|ent_num
operator|=
name|ext2_htree_get_count
argument_list|(
name|entries
argument_list|)
expr_stmt|;
if|if
condition|(
name|ent_num
operator|==
name|ext2_htree_get_limit
argument_list|(
name|entries
argument_list|)
condition|)
block|{
comment|/* Split the index node. */
name|root_entires
operator|=
name|info
operator|.
name|h_levels
index|[
literal|0
index|]
operator|.
name|h_entries
expr_stmt|;
name|newidxblock
operator|=
name|malloc
argument_list|(
name|blksize
argument_list|,
name|M_TEMP
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|dst_node
operator|=
operator|(
expr|struct
name|ext2fs_htree_node
operator|*
operator|)
name|newidxblock
expr_stmt|;
name|dst_entries
operator|=
name|dst_node
operator|->
name|h_entries
expr_stmt|;
name|memset
argument_list|(
operator|&
name|dst_node
operator|->
name|h_fake_dirent
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|dst_node
operator|->
name|h_fake_dirent
argument_list|)
argument_list|)
expr_stmt|;
name|dst_node
operator|->
name|h_fake_dirent
operator|.
name|e2d_reclen
operator|=
name|blksize
expr_stmt|;
name|cursize
operator|=
name|roundup
argument_list|(
name|ip
operator|->
name|i_size
argument_list|,
name|blksize
argument_list|)
expr_stmt|;
name|dirsize
operator|=
name|roundup
argument_list|(
name|ip
operator|->
name|i_size
argument_list|,
name|blksize
argument_list|)
operator|+
name|blksize
expr_stmt|;
name|blknum
operator|=
name|dirsize
operator|/
name|blksize
operator|-
literal|1
expr_stmt|;
name|error
operator|=
name|ext2_htree_append_block
argument_list|(
name|dvp
argument_list|,
name|newidxblock
argument_list|,
name|cnp
argument_list|,
name|blksize
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|finish
goto|;
name|error
operator|=
name|ext2_blkatoff
argument_list|(
name|dvp
argument_list|,
name|cursize
argument_list|,
name|NULL
argument_list|,
operator|&
name|dst_bp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|finish
goto|;
name|dst_node
operator|=
operator|(
expr|struct
name|ext2fs_htree_node
operator|*
operator|)
name|dst_bp
operator|->
name|b_data
expr_stmt|;
name|dst_entries
operator|=
name|dst_node
operator|->
name|h_entries
expr_stmt|;
if|if
condition|(
name|info
operator|.
name|h_levels_num
operator|==
literal|2
condition|)
block|{
name|uint16_t
name|src_ent_num
decl_stmt|,
name|dst_ent_num
decl_stmt|;
if|if
condition|(
name|ext2_htree_get_count
argument_list|(
name|root_entires
argument_list|)
operator|==
name|ext2_htree_get_limit
argument_list|(
name|root_entires
argument_list|)
condition|)
block|{
comment|/* Directory index is full */
name|error
operator|=
name|EIO
expr_stmt|;
goto|goto
name|finish
goto|;
block|}
name|src_ent_num
operator|=
name|ent_num
operator|/
literal|2
expr_stmt|;
name|dst_ent_num
operator|=
name|ent_num
operator|-
name|src_ent_num
expr_stmt|;
name|split_hash
operator|=
name|ext2_htree_get_hash
argument_list|(
name|entries
operator|+
name|src_ent_num
argument_list|)
expr_stmt|;
comment|/* Move half of index entries to the new index node */
name|memcpy
argument_list|(
name|dst_entries
argument_list|,
name|entries
operator|+
name|src_ent_num
argument_list|,
name|dst_ent_num
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|ext2fs_htree_entry
argument_list|)
argument_list|)
expr_stmt|;
name|ext2_htree_set_count
argument_list|(
name|entries
argument_list|,
name|src_ent_num
argument_list|)
expr_stmt|;
name|ext2_htree_set_count
argument_list|(
name|dst_entries
argument_list|,
name|dst_ent_num
argument_list|)
expr_stmt|;
name|ext2_htree_set_limit
argument_list|(
name|dst_entries
argument_list|,
name|ext2_htree_node_limit
argument_list|(
name|ip
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|info
operator|.
name|h_levels
index|[
literal|1
index|]
operator|.
name|h_entry
operator|>=
name|entries
operator|+
name|src_ent_num
condition|)
block|{
name|struct
name|buf
modifier|*
name|tmp
init|=
name|info
operator|.
name|h_levels
index|[
literal|1
index|]
operator|.
name|h_bp
decl_stmt|;
name|info
operator|.
name|h_levels
index|[
literal|1
index|]
operator|.
name|h_bp
operator|=
name|dst_bp
expr_stmt|;
name|dst_bp
operator|=
name|tmp
expr_stmt|;
name|info
operator|.
name|h_levels
index|[
literal|1
index|]
operator|.
name|h_entry
operator|=
name|info
operator|.
name|h_levels
index|[
literal|1
index|]
operator|.
name|h_entry
operator|-
operator|(
name|entries
operator|+
name|src_ent_num
operator|)
operator|+
name|dst_entries
expr_stmt|;
name|info
operator|.
name|h_levels
index|[
literal|1
index|]
operator|.
name|h_entries
operator|=
name|dst_entries
expr_stmt|;
block|}
name|ext2_htree_insert_entry_to_level
argument_list|(
operator|&
name|info
operator|.
name|h_levels
index|[
literal|0
index|]
argument_list|,
name|split_hash
argument_list|,
name|blknum
argument_list|)
expr_stmt|;
comment|/* Write new index node to disk */
name|error
operator|=
name|bwrite
argument_list|(
name|dst_bp
argument_list|)
expr_stmt|;
name|ip
operator|->
name|i_flag
operator||=
name|IN_CHANGE
operator||
name|IN_UPDATE
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|finish
goto|;
name|write_dst_bp
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
comment|/* Create second level for htree index */
name|struct
name|ext2fs_htree_root
modifier|*
name|idx_root
decl_stmt|;
name|memcpy
argument_list|(
name|dst_entries
argument_list|,
name|entries
argument_list|,
name|ent_num
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|ext2fs_htree_entry
argument_list|)
argument_list|)
expr_stmt|;
name|ext2_htree_set_limit
argument_list|(
name|dst_entries
argument_list|,
name|ext2_htree_node_limit
argument_list|(
name|ip
argument_list|)
argument_list|)
expr_stmt|;
name|idx_root
operator|=
operator|(
expr|struct
name|ext2fs_htree_root
operator|*
operator|)
name|info
operator|.
name|h_levels
index|[
literal|0
index|]
operator|.
name|h_bp
operator|->
name|b_data
expr_stmt|;
name|idx_root
operator|->
name|h_info
operator|.
name|h_ind_levels
operator|=
literal|1
expr_stmt|;
name|ext2_htree_set_count
argument_list|(
name|entries
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ext2_htree_set_block
argument_list|(
name|entries
argument_list|,
name|blknum
argument_list|)
expr_stmt|;
name|info
operator|.
name|h_levels_num
operator|=
literal|2
expr_stmt|;
name|info
operator|.
name|h_levels
index|[
literal|1
index|]
operator|.
name|h_entries
operator|=
name|dst_entries
expr_stmt|;
name|info
operator|.
name|h_levels
index|[
literal|1
index|]
operator|.
name|h_entry
operator|=
name|info
operator|.
name|h_levels
index|[
literal|0
index|]
operator|.
name|h_entry
operator|-
name|info
operator|.
name|h_levels
index|[
literal|0
index|]
operator|.
name|h_entries
operator|+
name|dst_entries
expr_stmt|;
name|info
operator|.
name|h_levels
index|[
literal|1
index|]
operator|.
name|h_bp
operator|=
name|dst_bp
expr_stmt|;
block|}
block|}
name|leaf_node
operator|=
name|info
operator|.
name|h_levels
index|[
name|info
operator|.
name|h_levels_num
operator|-
literal|1
index|]
operator|.
name|h_entry
expr_stmt|;
name|blknum
operator|=
name|ext2_htree_get_block
argument_list|(
name|leaf_node
argument_list|)
expr_stmt|;
name|error
operator|=
name|ext2_blkatoff
argument_list|(
name|dvp
argument_list|,
name|blknum
operator|*
name|blksize
argument_list|,
name|NULL
argument_list|,
operator|&
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|finish
goto|;
comment|/* Split target directory block */
name|newdirblock
operator|=
name|malloc
argument_list|(
name|blksize
argument_list|,
name|M_TEMP
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|ext2_htree_split_dirblock
argument_list|(
operator|(
name|char
operator|*
operator|)
name|bp
operator|->
name|b_data
argument_list|,
name|newdirblock
argument_list|,
name|blksize
argument_list|,
name|fs
operator|->
name|e3fs_hash_seed
argument_list|,
name|hash_version
argument_list|,
operator|&
name|split_hash
argument_list|,
name|entry
argument_list|)
expr_stmt|;
name|cursize
operator|=
name|roundup
argument_list|(
name|ip
operator|->
name|i_size
argument_list|,
name|blksize
argument_list|)
expr_stmt|;
name|dirsize
operator|=
name|roundup
argument_list|(
name|ip
operator|->
name|i_size
argument_list|,
name|blksize
argument_list|)
operator|+
name|blksize
expr_stmt|;
name|blknum
operator|=
name|dirsize
operator|/
name|blksize
operator|-
literal|1
expr_stmt|;
comment|/* Add index entry for the new directory block */
name|ext2_htree_insert_entry
argument_list|(
operator|&
name|info
argument_list|,
name|split_hash
argument_list|,
name|blknum
argument_list|)
expr_stmt|;
comment|/* Write the new directory block to the end of the directory */
name|error
operator|=
name|ext2_htree_append_block
argument_list|(
name|dvp
argument_list|,
name|newdirblock
argument_list|,
name|cnp
argument_list|,
name|blksize
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|finish
goto|;
comment|/* Write the target directory block */
name|error
operator|=
name|bwrite
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|ip
operator|->
name|i_flag
operator||=
name|IN_CHANGE
operator||
name|IN_UPDATE
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|finish
goto|;
name|write_bp
operator|=
literal|1
expr_stmt|;
comment|/* Write the index block */
name|error
operator|=
name|ext2_htree_writebuf
argument_list|(
operator|&
name|info
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
name|write_info
operator|=
literal|1
expr_stmt|;
name|finish
label|:
if|if
condition|(
name|dst_bp
operator|!=
name|NULL
operator|&&
operator|!
name|write_dst_bp
condition|)
name|brelse
argument_list|(
name|dst_bp
argument_list|)
expr_stmt|;
if|if
condition|(
name|bp
operator|!=
name|NULL
operator|&&
operator|!
name|write_bp
condition|)
name|brelse
argument_list|(
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
name|newdirblock
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|newdirblock
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
if|if
condition|(
name|newidxblock
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|newidxblock
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|write_info
condition|)
name|ext2_htree_release
argument_list|(
operator|&
name|info
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

end_unit


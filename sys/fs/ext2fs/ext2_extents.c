begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2010 Zheng Liu<lz@freebsd.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/vnode.h>
end_include

begin_include
include|#
directive|include
file|<sys/bio.h>
end_include

begin_include
include|#
directive|include
file|<sys/buf.h>
end_include

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<fs/ext2fs/ext2_mount.h>
end_include

begin_include
include|#
directive|include
file|<fs/ext2fs/fs.h>
end_include

begin_include
include|#
directive|include
file|<fs/ext2fs/inode.h>
end_include

begin_include
include|#
directive|include
file|<fs/ext2fs/ext2fs.h>
end_include

begin_include
include|#
directive|include
file|<fs/ext2fs/ext2_extents.h>
end_include

begin_include
include|#
directive|include
file|<fs/ext2fs/ext2_extern.h>
end_include

begin_expr_stmt
specifier|static
name|MALLOC_DEFINE
argument_list|(
name|M_EXT2EXTENTS
argument_list|,
literal|"ext2_extents"
argument_list|,
literal|"EXT2 extents"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|EXT2FS_DEBUG
end_ifdef

begin_function
specifier|static
name|void
name|ext4_ext_print_extent
parameter_list|(
name|struct
name|ext4_extent
modifier|*
name|ep
parameter_list|)
block|{
name|printf
argument_list|(
literal|"    ext %p => (blk %u len %u start %lu)\n"
argument_list|,
name|ep
argument_list|,
name|ep
operator|->
name|e_blk
argument_list|,
name|ep
operator|->
name|e_len
argument_list|,
operator|(
name|uint64_t
operator|)
name|ep
operator|->
name|e_start_hi
operator|<<
literal|32
operator||
name|ep
operator|->
name|e_start_lo
argument_list|)
expr_stmt|;
block|}
end_function

begin_function_decl
specifier|static
name|void
name|ext4_ext_print_header
parameter_list|(
name|struct
name|inode
modifier|*
name|ip
parameter_list|,
name|struct
name|ext4_extent_header
modifier|*
name|ehp
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|void
name|ext4_ext_print_index
parameter_list|(
name|struct
name|inode
modifier|*
name|ip
parameter_list|,
name|struct
name|ext4_extent_index
modifier|*
name|ex
parameter_list|,
name|int
name|do_walk
parameter_list|)
block|{
name|struct
name|m_ext2fs
modifier|*
name|fs
decl_stmt|;
name|struct
name|buf
modifier|*
name|bp
decl_stmt|;
name|int
name|error
decl_stmt|;
name|fs
operator|=
name|ip
operator|->
name|i_e2fs
expr_stmt|;
name|printf
argument_list|(
literal|"    index %p => (blk %u pblk %lu)\n"
argument_list|,
name|ex
argument_list|,
name|ex
operator|->
name|ei_blk
argument_list|,
operator|(
name|uint64_t
operator|)
name|ex
operator|->
name|ei_leaf_hi
operator|<<
literal|32
operator||
name|ex
operator|->
name|ei_leaf_lo
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|do_walk
condition|)
return|return;
if|if
condition|(
operator|(
name|error
operator|=
name|bread
argument_list|(
name|ip
operator|->
name|i_devvp
argument_list|,
name|fsbtodb
argument_list|(
name|fs
argument_list|,
operator|(
operator|(
name|uint64_t
operator|)
name|ex
operator|->
name|ei_leaf_hi
operator|<<
literal|32
operator||
name|ex
operator|->
name|ei_leaf_lo
operator|)
argument_list|)
argument_list|,
operator|(
name|int
operator|)
name|fs
operator|->
name|e2fs_bsize
argument_list|,
name|NOCRED
argument_list|,
operator|&
name|bp
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|brelse
argument_list|(
name|bp
argument_list|)
expr_stmt|;
return|return;
block|}
name|ext4_ext_print_header
argument_list|(
name|ip
argument_list|,
operator|(
expr|struct
name|ext4_extent_header
operator|*
operator|)
name|bp
operator|->
name|b_data
argument_list|)
expr_stmt|;
name|brelse
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ext4_ext_print_header
parameter_list|(
name|struct
name|inode
modifier|*
name|ip
parameter_list|,
name|struct
name|ext4_extent_header
modifier|*
name|ehp
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"header %p => (magic 0x%x entries %d max %d depth %d gen %d)\n"
argument_list|,
name|ehp
argument_list|,
name|ehp
operator|->
name|eh_magic
argument_list|,
name|ehp
operator|->
name|eh_ecount
argument_list|,
name|ehp
operator|->
name|eh_max
argument_list|,
name|ehp
operator|->
name|eh_depth
argument_list|,
name|ehp
operator|->
name|eh_gen
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ehp
operator|->
name|eh_ecount
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|ehp
operator|->
name|eh_depth
operator|!=
literal|0
condition|)
name|ext4_ext_print_index
argument_list|(
name|ip
argument_list|,
operator|(
expr|struct
name|ext4_extent_index
operator|*
operator|)
operator|(
name|ehp
operator|+
literal|1
operator|+
name|i
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
else|else
name|ext4_ext_print_extent
argument_list|(
operator|(
expr|struct
name|ext4_extent
operator|*
operator|)
operator|(
name|ehp
operator|+
literal|1
operator|+
name|i
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ext4_ext_print_path
parameter_list|(
name|struct
name|inode
modifier|*
name|ip
parameter_list|,
name|struct
name|ext4_extent_path
modifier|*
name|path
parameter_list|)
block|{
name|int
name|k
decl_stmt|,
name|l
decl_stmt|;
name|l
operator|=
name|path
operator|->
name|ep_depth
name|printf
argument_list|(
literal|"ip=%d, Path:\n"
argument_list|,
name|ip
operator|->
name|i_number
argument_list|)
expr_stmt|;
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<=
name|l
condition|;
name|k
operator|++
operator|,
name|path
operator|++
control|)
block|{
if|if
condition|(
name|path
operator|->
name|ep_index
condition|)
block|{
name|ext4_ext_print_index
argument_list|(
name|ip
argument_list|,
name|path
operator|->
name|ep_index
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|path
operator|->
name|ep_ext
condition|)
block|{
name|ext4_ext_print_extent
argument_list|(
name|path
operator|->
name|ep_ext
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|void
name|ext4_ext_print_extent_tree_status
parameter_list|(
name|struct
name|inode
modifier|*
name|ip
parameter_list|)
block|{
name|struct
name|m_ext2fs
modifier|*
name|fs
decl_stmt|;
name|struct
name|ext4_extent_header
modifier|*
name|ehp
decl_stmt|;
name|fs
operator|=
name|ip
operator|->
name|i_e2fs
expr_stmt|;
name|ehp
operator|=
operator|(
expr|struct
name|ext4_extent_header
operator|*
operator|)
operator|(
name|char
operator|*
operator|)
name|ip
operator|->
name|i_db
expr_stmt|;
name|printf
argument_list|(
literal|"Extent status:ip=%d\n"
argument_list|,
name|ip
operator|->
name|i_number
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ip
operator|->
name|i_flag
operator|&
name|IN_E4EXTENTS
operator|)
condition|)
return|return;
name|ext4_ext_print_header
argument_list|(
name|ip
argument_list|,
name|ehp
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
specifier|inline
name|struct
name|ext4_extent_header
modifier|*
name|ext4_ext_inode_header
parameter_list|(
name|struct
name|inode
modifier|*
name|ip
parameter_list|)
block|{
return|return
operator|(
operator|(
expr|struct
name|ext4_extent_header
operator|*
operator|)
name|ip
operator|->
name|i_db
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|struct
name|ext4_extent_header
modifier|*
name|ext4_ext_block_header
parameter_list|(
name|char
modifier|*
name|bdata
parameter_list|)
block|{
return|return
operator|(
operator|(
expr|struct
name|ext4_extent_header
operator|*
operator|)
name|bdata
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|unsigned
name|short
name|ext4_ext_inode_depth
parameter_list|(
name|struct
name|inode
modifier|*
name|ip
parameter_list|)
block|{
name|struct
name|ext4_extent_header
modifier|*
name|ehp
decl_stmt|;
name|ehp
operator|=
operator|(
expr|struct
name|ext4_extent_header
operator|*
operator|)
name|ip
operator|->
name|i_data
expr_stmt|;
return|return
operator|(
name|ehp
operator|->
name|eh_depth
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|e4fs_daddr_t
name|ext4_ext_index_pblock
parameter_list|(
name|struct
name|ext4_extent_index
modifier|*
name|index
parameter_list|)
block|{
name|e4fs_daddr_t
name|blk
decl_stmt|;
name|blk
operator|=
name|index
operator|->
name|ei_leaf_lo
expr_stmt|;
name|blk
operator||=
operator|(
name|e4fs_daddr_t
operator|)
name|index
operator|->
name|ei_leaf_hi
operator|<<
literal|32
expr_stmt|;
return|return
operator|(
name|blk
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|ext4_index_store_pblock
parameter_list|(
name|struct
name|ext4_extent_index
modifier|*
name|index
parameter_list|,
name|e4fs_daddr_t
name|pb
parameter_list|)
block|{
name|index
operator|->
name|ei_leaf_lo
operator|=
name|pb
operator|&
literal|0xffffffff
expr_stmt|;
name|index
operator|->
name|ei_leaf_hi
operator|=
operator|(
name|pb
operator|>>
literal|32
operator|)
operator|&
literal|0xffff
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|e4fs_daddr_t
name|ext4_ext_extent_pblock
parameter_list|(
name|struct
name|ext4_extent
modifier|*
name|extent
parameter_list|)
block|{
name|e4fs_daddr_t
name|blk
decl_stmt|;
name|blk
operator|=
name|extent
operator|->
name|e_start_lo
expr_stmt|;
name|blk
operator||=
operator|(
name|e4fs_daddr_t
operator|)
name|extent
operator|->
name|e_start_hi
operator|<<
literal|32
expr_stmt|;
return|return
operator|(
name|blk
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|ext4_ext_store_pblock
parameter_list|(
name|struct
name|ext4_extent
modifier|*
name|ex
parameter_list|,
name|e4fs_daddr_t
name|pb
parameter_list|)
block|{
name|ex
operator|->
name|e_start_lo
operator|=
name|pb
operator|&
literal|0xffffffff
expr_stmt|;
name|ex
operator|->
name|e_start_hi
operator|=
operator|(
name|pb
operator|>>
literal|32
operator|)
operator|&
literal|0xffff
expr_stmt|;
block|}
end_function

begin_function
name|int
name|ext4_ext_in_cache
parameter_list|(
name|struct
name|inode
modifier|*
name|ip
parameter_list|,
name|daddr_t
name|lbn
parameter_list|,
name|struct
name|ext4_extent
modifier|*
name|ep
parameter_list|)
block|{
name|struct
name|ext4_extent_cache
modifier|*
name|ecp
decl_stmt|;
name|int
name|ret
init|=
name|EXT4_EXT_CACHE_NO
decl_stmt|;
name|ecp
operator|=
operator|&
name|ip
operator|->
name|i_ext_cache
expr_stmt|;
if|if
condition|(
name|ecp
operator|->
name|ec_type
operator|==
name|EXT4_EXT_CACHE_NO
condition|)
return|return
operator|(
name|ret
operator|)
return|;
if|if
condition|(
name|lbn
operator|>=
name|ecp
operator|->
name|ec_blk
operator|&&
name|lbn
operator|<
name|ecp
operator|->
name|ec_blk
operator|+
name|ecp
operator|->
name|ec_len
condition|)
block|{
name|ep
operator|->
name|e_blk
operator|=
name|ecp
operator|->
name|ec_blk
expr_stmt|;
name|ep
operator|->
name|e_start_lo
operator|=
name|ecp
operator|->
name|ec_start
operator|&
literal|0xffffffff
expr_stmt|;
name|ep
operator|->
name|e_start_hi
operator|=
name|ecp
operator|->
name|ec_start
operator|>>
literal|32
operator|&
literal|0xffff
expr_stmt|;
name|ep
operator|->
name|e_len
operator|=
name|ecp
operator|->
name|ec_len
expr_stmt|;
name|ret
operator|=
name|ecp
operator|->
name|ec_type
expr_stmt|;
block|}
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ext4_ext_check_header
parameter_list|(
name|struct
name|inode
modifier|*
name|ip
parameter_list|,
name|struct
name|ext4_extent_header
modifier|*
name|eh
parameter_list|)
block|{
name|struct
name|m_ext2fs
modifier|*
name|fs
decl_stmt|;
name|char
modifier|*
name|error_msg
decl_stmt|;
name|fs
operator|=
name|ip
operator|->
name|i_e2fs
expr_stmt|;
if|if
condition|(
name|eh
operator|->
name|eh_magic
operator|!=
name|EXT4_EXT_MAGIC
condition|)
block|{
name|error_msg
operator|=
literal|"invalid magic"
expr_stmt|;
goto|goto
name|corrupted
goto|;
block|}
if|if
condition|(
name|eh
operator|->
name|eh_max
operator|==
literal|0
condition|)
block|{
name|error_msg
operator|=
literal|"invalid eh_max"
expr_stmt|;
goto|goto
name|corrupted
goto|;
block|}
if|if
condition|(
name|eh
operator|->
name|eh_ecount
operator|>
name|eh
operator|->
name|eh_max
condition|)
block|{
name|error_msg
operator|=
literal|"invalid eh_entries"
expr_stmt|;
goto|goto
name|corrupted
goto|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|corrupted
label|:
name|ext2_fserr
argument_list|(
name|fs
argument_list|,
name|ip
operator|->
name|i_uid
argument_list|,
name|error_msg
argument_list|)
expr_stmt|;
return|return
operator|(
name|EIO
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ext4_ext_binsearch_index
parameter_list|(
name|struct
name|ext4_extent_path
modifier|*
name|path
parameter_list|,
name|int
name|blk
parameter_list|)
block|{
name|struct
name|ext4_extent_header
modifier|*
name|eh
decl_stmt|;
name|struct
name|ext4_extent_index
modifier|*
name|r
decl_stmt|,
modifier|*
name|l
decl_stmt|,
modifier|*
name|m
decl_stmt|;
name|eh
operator|=
name|path
operator|->
name|ep_header
expr_stmt|;
name|KASSERT
argument_list|(
name|eh
operator|->
name|eh_ecount
operator|<=
name|eh
operator|->
name|eh_max
operator|&&
name|eh
operator|->
name|eh_ecount
operator|>
literal|0
argument_list|,
operator|(
literal|"ext4_ext_binsearch_index: bad args"
operator|)
argument_list|)
expr_stmt|;
name|l
operator|=
name|EXT_FIRST_INDEX
argument_list|(
name|eh
argument_list|)
operator|+
literal|1
expr_stmt|;
name|r
operator|=
name|EXT_FIRST_INDEX
argument_list|(
name|eh
argument_list|)
operator|+
name|eh
operator|->
name|eh_ecount
operator|-
literal|1
expr_stmt|;
while|while
condition|(
name|l
operator|<=
name|r
condition|)
block|{
name|m
operator|=
name|l
operator|+
operator|(
name|r
operator|-
name|l
operator|)
operator|/
literal|2
expr_stmt|;
if|if
condition|(
name|blk
operator|<
name|m
operator|->
name|ei_blk
condition|)
name|r
operator|=
name|m
operator|-
literal|1
expr_stmt|;
else|else
name|l
operator|=
name|m
operator|+
literal|1
expr_stmt|;
block|}
name|path
operator|->
name|ep_index
operator|=
name|l
operator|-
literal|1
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ext4_ext_binsearch_ext
parameter_list|(
name|struct
name|ext4_extent_path
modifier|*
name|path
parameter_list|,
name|int
name|blk
parameter_list|)
block|{
name|struct
name|ext4_extent_header
modifier|*
name|eh
decl_stmt|;
name|struct
name|ext4_extent
modifier|*
name|r
decl_stmt|,
modifier|*
name|l
decl_stmt|,
modifier|*
name|m
decl_stmt|;
name|eh
operator|=
name|path
operator|->
name|ep_header
expr_stmt|;
name|KASSERT
argument_list|(
name|eh
operator|->
name|eh_ecount
operator|<=
name|eh
operator|->
name|eh_max
argument_list|,
operator|(
literal|"ext4_ext_binsearch_ext: bad args"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|eh
operator|->
name|eh_ecount
operator|==
literal|0
condition|)
return|return;
name|l
operator|=
name|EXT_FIRST_EXTENT
argument_list|(
name|eh
argument_list|)
operator|+
literal|1
expr_stmt|;
name|r
operator|=
name|EXT_FIRST_EXTENT
argument_list|(
name|eh
argument_list|)
operator|+
name|eh
operator|->
name|eh_ecount
operator|-
literal|1
expr_stmt|;
while|while
condition|(
name|l
operator|<=
name|r
condition|)
block|{
name|m
operator|=
name|l
operator|+
operator|(
name|r
operator|-
name|l
operator|)
operator|/
literal|2
expr_stmt|;
if|if
condition|(
name|blk
operator|<
name|m
operator|->
name|e_blk
condition|)
name|r
operator|=
name|m
operator|-
literal|1
expr_stmt|;
else|else
name|l
operator|=
name|m
operator|+
literal|1
expr_stmt|;
block|}
name|path
operator|->
name|ep_ext
operator|=
name|l
operator|-
literal|1
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|ext4_ext_fill_path_bdata
parameter_list|(
name|struct
name|ext4_extent_path
modifier|*
name|path
parameter_list|,
name|struct
name|buf
modifier|*
name|bp
parameter_list|,
name|uint64_t
name|blk
parameter_list|)
block|{
name|KASSERT
argument_list|(
name|path
operator|->
name|ep_data
operator|==
name|NULL
argument_list|,
operator|(
literal|"ext4_ext_fill_path_bdata: bad ep_data"
operator|)
argument_list|)
expr_stmt|;
name|path
operator|->
name|ep_data
operator|=
name|malloc
argument_list|(
name|bp
operator|->
name|b_bufsize
argument_list|,
name|M_EXT2EXTENTS
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|path
operator|->
name|ep_data
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
name|memcpy
argument_list|(
name|path
operator|->
name|ep_data
argument_list|,
name|bp
operator|->
name|b_data
argument_list|,
name|bp
operator|->
name|b_bufsize
argument_list|)
expr_stmt|;
name|path
operator|->
name|ep_blk
operator|=
name|blk
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ext4_ext_fill_path_buf
parameter_list|(
name|struct
name|ext4_extent_path
modifier|*
name|path
parameter_list|,
name|struct
name|buf
modifier|*
name|bp
parameter_list|)
block|{
name|KASSERT
argument_list|(
name|path
operator|->
name|ep_data
operator|!=
name|NULL
argument_list|,
operator|(
literal|"ext4_ext_fill_path_buf: bad ep_data"
operator|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|bp
operator|->
name|b_data
argument_list|,
name|path
operator|->
name|ep_data
argument_list|,
name|bp
operator|->
name|b_bufsize
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ext4_ext_drop_refs
parameter_list|(
name|struct
name|ext4_extent_path
modifier|*
name|path
parameter_list|)
block|{
name|int
name|depth
decl_stmt|,
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|path
condition|)
return|return;
name|depth
operator|=
name|path
operator|->
name|ep_depth
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
name|depth
condition|;
name|i
operator|++
operator|,
name|path
operator|++
control|)
if|if
condition|(
name|path
operator|->
name|ep_data
condition|)
block|{
name|free
argument_list|(
name|path
operator|->
name|ep_data
argument_list|,
name|M_EXT2EXTENTS
argument_list|)
expr_stmt|;
name|path
operator|->
name|ep_data
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|ext4_ext_path_free
parameter_list|(
name|struct
name|ext4_extent_path
modifier|*
name|path
parameter_list|)
block|{
if|if
condition|(
operator|!
name|path
condition|)
return|return;
name|ext4_ext_drop_refs
argument_list|(
name|path
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|path
argument_list|,
name|M_EXT2EXTENTS
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|ext4_ext_find_extent
parameter_list|(
name|struct
name|inode
modifier|*
name|ip
parameter_list|,
name|daddr_t
name|block
parameter_list|,
name|struct
name|ext4_extent_path
modifier|*
modifier|*
name|ppath
parameter_list|)
block|{
name|struct
name|m_ext2fs
modifier|*
name|fs
decl_stmt|;
name|struct
name|ext4_extent_header
modifier|*
name|eh
decl_stmt|;
name|struct
name|ext4_extent_path
modifier|*
name|path
decl_stmt|;
name|struct
name|buf
modifier|*
name|bp
decl_stmt|;
name|uint64_t
name|blk
decl_stmt|;
name|int
name|error
decl_stmt|,
name|depth
decl_stmt|,
name|i
decl_stmt|,
name|ppos
decl_stmt|,
name|alloc
decl_stmt|;
name|fs
operator|=
name|ip
operator|->
name|i_e2fs
expr_stmt|;
name|eh
operator|=
name|ext4_ext_inode_header
argument_list|(
name|ip
argument_list|)
expr_stmt|;
name|depth
operator|=
name|ext4_ext_inode_depth
argument_list|(
name|ip
argument_list|)
expr_stmt|;
name|ppos
operator|=
literal|0
expr_stmt|;
name|alloc
operator|=
literal|0
expr_stmt|;
name|error
operator|=
name|ext4_ext_check_header
argument_list|(
name|ip
argument_list|,
name|eh
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
if|if
condition|(
operator|!
name|ppath
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|path
operator|=
operator|*
name|ppath
expr_stmt|;
if|if
condition|(
operator|!
name|path
condition|)
block|{
name|path
operator|=
name|malloc
argument_list|(
name|EXT4_EXT_DEPTH_MAX
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|ext4_extent_path
argument_list|)
argument_list|,
name|M_EXT2EXTENTS
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|path
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
operator|*
name|ppath
operator|=
name|path
expr_stmt|;
name|alloc
operator|=
literal|1
expr_stmt|;
block|}
name|path
index|[
literal|0
index|]
operator|.
name|ep_header
operator|=
name|eh
expr_stmt|;
name|path
index|[
literal|0
index|]
operator|.
name|ep_data
operator|=
name|NULL
expr_stmt|;
comment|/* Walk through the tree. */
name|i
operator|=
name|depth
expr_stmt|;
while|while
condition|(
name|i
condition|)
block|{
name|ext4_ext_binsearch_index
argument_list|(
operator|&
name|path
index|[
name|ppos
index|]
argument_list|,
name|block
argument_list|)
expr_stmt|;
name|blk
operator|=
name|ext4_ext_index_pblock
argument_list|(
name|path
index|[
name|ppos
index|]
operator|.
name|ep_index
argument_list|)
expr_stmt|;
name|path
index|[
name|ppos
index|]
operator|.
name|ep_depth
operator|=
name|i
expr_stmt|;
name|path
index|[
name|ppos
index|]
operator|.
name|ep_ext
operator|=
name|NULL
expr_stmt|;
name|error
operator|=
name|bread
argument_list|(
name|ip
operator|->
name|i_devvp
argument_list|,
name|fsbtodb
argument_list|(
name|ip
operator|->
name|i_e2fs
argument_list|,
name|blk
argument_list|)
argument_list|,
name|ip
operator|->
name|i_e2fs
operator|->
name|e2fs_bsize
argument_list|,
name|NOCRED
argument_list|,
operator|&
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|brelse
argument_list|(
name|bp
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|ppos
operator|++
expr_stmt|;
if|if
condition|(
name|ppos
operator|>
name|depth
condition|)
block|{
name|ext2_fserr
argument_list|(
name|fs
argument_list|,
name|ip
operator|->
name|i_uid
argument_list|,
literal|"ppos> depth => extent corrupted"
argument_list|)
expr_stmt|;
name|error
operator|=
name|EIO
expr_stmt|;
name|brelse
argument_list|(
name|bp
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|ext4_ext_fill_path_bdata
argument_list|(
operator|&
name|path
index|[
name|ppos
index|]
argument_list|,
name|bp
argument_list|,
name|blk
argument_list|)
expr_stmt|;
name|brelse
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|eh
operator|=
name|ext4_ext_block_header
argument_list|(
name|path
index|[
name|ppos
index|]
operator|.
name|ep_data
argument_list|)
expr_stmt|;
name|error
operator|=
name|ext4_ext_check_header
argument_list|(
name|ip
argument_list|,
name|eh
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|error
goto|;
name|path
index|[
name|ppos
index|]
operator|.
name|ep_header
operator|=
name|eh
expr_stmt|;
name|i
operator|--
expr_stmt|;
block|}
name|error
operator|=
name|ext4_ext_check_header
argument_list|(
name|ip
argument_list|,
name|eh
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|error
goto|;
comment|/* Find extent. */
name|path
index|[
name|ppos
index|]
operator|.
name|ep_depth
operator|=
name|i
expr_stmt|;
name|path
index|[
name|ppos
index|]
operator|.
name|ep_header
operator|=
name|eh
expr_stmt|;
name|path
index|[
name|ppos
index|]
operator|.
name|ep_ext
operator|=
name|NULL
expr_stmt|;
name|path
index|[
name|ppos
index|]
operator|.
name|ep_index
operator|=
name|NULL
expr_stmt|;
name|ext4_ext_binsearch_ext
argument_list|(
operator|&
name|path
index|[
name|ppos
index|]
argument_list|,
name|block
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|error
label|:
name|ext4_ext_drop_refs
argument_list|(
name|path
argument_list|)
expr_stmt|;
if|if
condition|(
name|alloc
condition|)
name|free
argument_list|(
name|path
argument_list|,
name|M_EXT2EXTENTS
argument_list|)
expr_stmt|;
operator|*
name|ppath
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|int
name|ext4_ext_space_root
parameter_list|(
name|struct
name|inode
modifier|*
name|ip
parameter_list|)
block|{
name|int
name|size
decl_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
name|ip
operator|->
name|i_data
argument_list|)
expr_stmt|;
name|size
operator|-=
sizeof|sizeof
argument_list|(
expr|struct
name|ext4_extent_header
argument_list|)
expr_stmt|;
name|size
operator|/=
sizeof|sizeof
argument_list|(
expr|struct
name|ext4_extent
argument_list|)
expr_stmt|;
return|return
operator|(
name|size
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|int
name|ext4_ext_space_block
parameter_list|(
name|struct
name|inode
modifier|*
name|ip
parameter_list|)
block|{
name|struct
name|m_ext2fs
modifier|*
name|fs
decl_stmt|;
name|int
name|size
decl_stmt|;
name|fs
operator|=
name|ip
operator|->
name|i_e2fs
expr_stmt|;
name|size
operator|=
operator|(
name|fs
operator|->
name|e2fs_bsize
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|ext4_extent_header
argument_list|)
operator|)
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|ext4_extent
argument_list|)
expr_stmt|;
return|return
operator|(
name|size
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|int
name|ext4_ext_space_block_index
parameter_list|(
name|struct
name|inode
modifier|*
name|ip
parameter_list|)
block|{
name|struct
name|m_ext2fs
modifier|*
name|fs
decl_stmt|;
name|int
name|size
decl_stmt|;
name|fs
operator|=
name|ip
operator|->
name|i_e2fs
expr_stmt|;
name|size
operator|=
operator|(
name|fs
operator|->
name|e2fs_bsize
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|ext4_extent_header
argument_list|)
operator|)
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|ext4_extent_index
argument_list|)
expr_stmt|;
return|return
operator|(
name|size
operator|)
return|;
block|}
end_function

begin_function
name|void
name|ext4_ext_tree_init
parameter_list|(
name|struct
name|inode
modifier|*
name|ip
parameter_list|)
block|{
name|struct
name|ext4_extent_header
modifier|*
name|ehp
decl_stmt|;
name|ip
operator|->
name|i_flag
operator||=
name|IN_E4EXTENTS
expr_stmt|;
name|memset
argument_list|(
name|ip
operator|->
name|i_data
argument_list|,
literal|0
argument_list|,
name|EXT2_NDADDR
operator|+
name|EXT2_NIADDR
argument_list|)
expr_stmt|;
name|ehp
operator|=
operator|(
expr|struct
name|ext4_extent_header
operator|*
operator|)
name|ip
operator|->
name|i_data
expr_stmt|;
name|ehp
operator|->
name|eh_magic
operator|=
name|EXT4_EXT_MAGIC
expr_stmt|;
name|ehp
operator|->
name|eh_max
operator|=
name|ext4_ext_space_root
argument_list|(
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|->
name|i_ext_cache
operator|.
name|ec_type
operator|=
name|EXT4_EXT_CACHE_NO
expr_stmt|;
name|ip
operator|->
name|i_flag
operator||=
name|IN_CHANGE
operator||
name|IN_UPDATE
expr_stmt|;
name|ext2_update
argument_list|(
name|ip
operator|->
name|i_vnode
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|ext4_ext_put_in_cache
parameter_list|(
name|struct
name|inode
modifier|*
name|ip
parameter_list|,
name|uint32_t
name|blk
parameter_list|,
name|uint32_t
name|len
parameter_list|,
name|uint32_t
name|start
parameter_list|,
name|int
name|type
parameter_list|)
block|{
name|KASSERT
argument_list|(
name|len
operator|!=
literal|0
argument_list|,
operator|(
literal|"ext4_ext_put_in_cache: bad input"
operator|)
argument_list|)
expr_stmt|;
name|ip
operator|->
name|i_ext_cache
operator|.
name|ec_type
operator|=
name|type
expr_stmt|;
name|ip
operator|->
name|i_ext_cache
operator|.
name|ec_blk
operator|=
name|blk
expr_stmt|;
name|ip
operator|->
name|i_ext_cache
operator|.
name|ec_len
operator|=
name|len
expr_stmt|;
name|ip
operator|->
name|i_ext_cache
operator|.
name|ec_start
operator|=
name|start
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|e4fs_daddr_t
name|ext4_ext_blkpref
parameter_list|(
name|struct
name|inode
modifier|*
name|ip
parameter_list|,
name|struct
name|ext4_extent_path
modifier|*
name|path
parameter_list|,
name|e4fs_daddr_t
name|block
parameter_list|)
block|{
name|struct
name|m_ext2fs
modifier|*
name|fs
decl_stmt|;
name|struct
name|ext4_extent
modifier|*
name|ex
decl_stmt|;
name|e4fs_daddr_t
name|bg_start
decl_stmt|;
name|int
name|depth
decl_stmt|;
name|fs
operator|=
name|ip
operator|->
name|i_e2fs
expr_stmt|;
if|if
condition|(
name|path
condition|)
block|{
name|depth
operator|=
name|path
operator|->
name|ep_depth
expr_stmt|;
name|ex
operator|=
name|path
index|[
name|depth
index|]
operator|.
name|ep_ext
expr_stmt|;
if|if
condition|(
name|ex
condition|)
block|{
name|e4fs_daddr_t
name|pblk
init|=
name|ext4_ext_extent_pblock
argument_list|(
name|ex
argument_list|)
decl_stmt|;
name|e2fs_daddr_t
name|blk
init|=
name|ex
operator|->
name|e_blk
decl_stmt|;
if|if
condition|(
name|block
operator|>
name|blk
condition|)
return|return
operator|(
name|pblk
operator|+
operator|(
name|block
operator|-
name|blk
operator|)
operator|)
return|;
else|else
return|return
operator|(
name|pblk
operator|-
operator|(
name|blk
operator|-
name|block
operator|)
operator|)
return|;
block|}
comment|/* Try to get block from index itself. */
if|if
condition|(
name|path
index|[
name|depth
index|]
operator|.
name|ep_data
condition|)
return|return
operator|(
name|path
index|[
name|depth
index|]
operator|.
name|ep_blk
operator|)
return|;
block|}
comment|/* Use inode's group. */
name|bg_start
operator|=
operator|(
name|ip
operator|->
name|i_block_group
operator|*
name|EXT2_BLOCKS_PER_GROUP
argument_list|(
name|ip
operator|->
name|i_e2fs
argument_list|)
operator|)
operator|+
name|fs
operator|->
name|e2fs
operator|->
name|e2fs_first_dblock
expr_stmt|;
return|return
operator|(
name|bg_start
operator|+
name|block
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
specifier|inline
name|ext4_can_extents_be_merged
parameter_list|(
name|struct
name|ext4_extent
modifier|*
name|ex1
parameter_list|,
name|struct
name|ext4_extent
modifier|*
name|ex2
parameter_list|)
block|{
if|if
condition|(
name|ex1
operator|->
name|e_blk
operator|+
name|ex1
operator|->
name|e_len
operator|!=
name|ex2
operator|->
name|e_blk
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|ex1
operator|->
name|e_len
operator|+
name|ex2
operator|->
name|e_len
operator|>
name|EXT4_MAX_LEN
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|ext4_ext_extent_pblock
argument_list|(
name|ex1
argument_list|)
operator|+
name|ex1
operator|->
name|e_len
operator|==
name|ext4_ext_extent_pblock
argument_list|(
name|ex2
argument_list|)
condition|)
return|return
operator|(
literal|1
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|unsigned
name|ext4_ext_next_leaf_block
parameter_list|(
name|struct
name|inode
modifier|*
name|ip
parameter_list|,
name|struct
name|ext4_extent_path
modifier|*
name|path
parameter_list|)
block|{
name|int
name|depth
init|=
name|path
operator|->
name|ep_depth
decl_stmt|;
comment|/* Empty tree */
if|if
condition|(
name|depth
operator|==
literal|0
condition|)
return|return
operator|(
name|EXT4_MAX_BLOCKS
operator|)
return|;
comment|/* Go to indexes. */
name|depth
operator|--
expr_stmt|;
while|while
condition|(
name|depth
operator|>=
literal|0
condition|)
block|{
if|if
condition|(
name|path
index|[
name|depth
index|]
operator|.
name|ep_index
operator|!=
name|EXT_LAST_INDEX
argument_list|(
name|path
index|[
name|depth
index|]
operator|.
name|ep_header
argument_list|)
condition|)
return|return
operator|(
name|path
index|[
name|depth
index|]
operator|.
name|ep_index
index|[
literal|1
index|]
operator|.
name|ei_blk
operator|)
return|;
name|depth
operator|--
expr_stmt|;
block|}
return|return
operator|(
name|EXT4_MAX_BLOCKS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ext4_ext_dirty
parameter_list|(
name|struct
name|inode
modifier|*
name|ip
parameter_list|,
name|struct
name|ext4_extent_path
modifier|*
name|path
parameter_list|)
block|{
name|struct
name|m_ext2fs
modifier|*
name|fs
decl_stmt|;
name|struct
name|buf
modifier|*
name|bp
decl_stmt|;
name|uint64_t
name|blk
decl_stmt|;
name|int
name|error
decl_stmt|;
name|fs
operator|=
name|ip
operator|->
name|i_e2fs
expr_stmt|;
if|if
condition|(
operator|!
name|path
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
name|path
operator|->
name|ep_data
condition|)
block|{
name|blk
operator|=
name|path
operator|->
name|ep_blk
expr_stmt|;
name|bp
operator|=
name|getblk
argument_list|(
name|ip
operator|->
name|i_devvp
argument_list|,
name|fsbtodb
argument_list|(
name|fs
argument_list|,
name|blk
argument_list|)
argument_list|,
name|fs
operator|->
name|e2fs_bsize
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bp
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
name|ext4_ext_fill_path_buf
argument_list|(
name|path
argument_list|,
name|bp
argument_list|)
expr_stmt|;
name|error
operator|=
name|bwrite
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ip
operator|->
name|i_flag
operator||=
name|IN_CHANGE
operator||
name|IN_UPDATE
expr_stmt|;
name|error
operator|=
name|ext2_update
argument_list|(
name|ip
operator|->
name|i_vnode
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ext4_ext_insert_index
parameter_list|(
name|struct
name|inode
modifier|*
name|ip
parameter_list|,
name|struct
name|ext4_extent_path
modifier|*
name|path
parameter_list|,
name|uint32_t
name|lblk
parameter_list|,
name|e4fs_daddr_t
name|blk
parameter_list|)
block|{
name|struct
name|m_ext2fs
modifier|*
name|fs
decl_stmt|;
name|struct
name|ext4_extent_index
modifier|*
name|idx
decl_stmt|;
name|int
name|len
decl_stmt|;
name|fs
operator|=
name|ip
operator|->
name|i_e2fs
expr_stmt|;
if|if
condition|(
name|lblk
operator|==
name|path
operator|->
name|ep_index
operator|->
name|ei_blk
condition|)
block|{
name|ext2_fserr
argument_list|(
name|fs
argument_list|,
name|ip
operator|->
name|i_uid
argument_list|,
literal|"lblk == index blk => extent corrupted"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EIO
operator|)
return|;
block|}
if|if
condition|(
name|path
operator|->
name|ep_header
operator|->
name|eh_ecount
operator|>=
name|path
operator|->
name|ep_header
operator|->
name|eh_max
condition|)
block|{
name|ext2_fserr
argument_list|(
name|fs
argument_list|,
name|ip
operator|->
name|i_uid
argument_list|,
literal|"ecout> maxcount => extent corrupted"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EIO
operator|)
return|;
block|}
if|if
condition|(
name|lblk
operator|>
name|path
operator|->
name|ep_index
operator|->
name|ei_blk
condition|)
block|{
comment|/* Insert after. */
name|idx
operator|=
name|path
operator|->
name|ep_index
operator|+
literal|1
expr_stmt|;
block|}
else|else
block|{
comment|/* Insert before. */
name|idx
operator|=
name|path
operator|->
name|ep_index
expr_stmt|;
block|}
name|len
operator|=
name|EXT_LAST_INDEX
argument_list|(
name|path
operator|->
name|ep_header
argument_list|)
operator|-
name|idx
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|len
operator|>
literal|0
condition|)
name|memmove
argument_list|(
name|idx
operator|+
literal|1
argument_list|,
name|idx
argument_list|,
name|len
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|ext4_extent_index
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|idx
operator|>
name|EXT_MAX_INDEX
argument_list|(
name|path
operator|->
name|ep_header
argument_list|)
condition|)
block|{
name|ext2_fserr
argument_list|(
name|fs
argument_list|,
name|ip
operator|->
name|i_uid
argument_list|,
literal|"index is out of range => extent corrupted"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EIO
operator|)
return|;
block|}
name|idx
operator|->
name|ei_blk
operator|=
name|lblk
expr_stmt|;
name|ext4_index_store_pblock
argument_list|(
name|idx
argument_list|,
name|blk
argument_list|)
expr_stmt|;
name|path
operator|->
name|ep_header
operator|->
name|eh_ecount
operator|++
expr_stmt|;
return|return
operator|(
name|ext4_ext_dirty
argument_list|(
name|ip
argument_list|,
name|path
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|e4fs_daddr_t
name|ext4_ext_alloc_meta
parameter_list|(
name|struct
name|inode
modifier|*
name|ip
parameter_list|)
block|{
name|e4fs_daddr_t
name|blk
init|=
name|ext2_alloc_meta
argument_list|(
name|ip
argument_list|)
decl_stmt|;
if|if
condition|(
name|blk
condition|)
block|{
name|ip
operator|->
name|i_blocks
operator|+=
name|btodb
argument_list|(
name|ip
operator|->
name|i_e2fs
operator|->
name|e2fs_bsize
argument_list|)
expr_stmt|;
name|ip
operator|->
name|i_flag
operator||=
name|IN_CHANGE
operator||
name|IN_UPDATE
expr_stmt|;
name|ext2_update
argument_list|(
name|ip
operator|->
name|i_vnode
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|blk
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ext4_ext_blkfree
parameter_list|(
name|struct
name|inode
modifier|*
name|ip
parameter_list|,
name|uint64_t
name|blk
parameter_list|,
name|int
name|count
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
name|struct
name|m_ext2fs
modifier|*
name|fs
decl_stmt|;
name|int
name|i
decl_stmt|,
name|blocksreleased
decl_stmt|;
name|fs
operator|=
name|ip
operator|->
name|i_e2fs
expr_stmt|;
name|blocksreleased
operator|=
name|count
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
name|ext2_blkfree
argument_list|(
name|ip
argument_list|,
name|blk
operator|+
name|i
argument_list|,
name|fs
operator|->
name|e2fs_bsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|ip
operator|->
name|i_blocks
operator|>=
name|blocksreleased
condition|)
name|ip
operator|->
name|i_blocks
operator|-=
operator|(
name|btodb
argument_list|(
name|fs
operator|->
name|e2fs_bsize
argument_list|)
operator|*
name|blocksreleased
operator|)
expr_stmt|;
else|else
name|ip
operator|->
name|i_blocks
operator|=
literal|0
expr_stmt|;
name|ip
operator|->
name|i_flag
operator||=
name|IN_CHANGE
operator||
name|IN_UPDATE
expr_stmt|;
name|ext2_update
argument_list|(
name|ip
operator|->
name|i_vnode
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|ext4_ext_split
parameter_list|(
name|struct
name|inode
modifier|*
name|ip
parameter_list|,
name|struct
name|ext4_extent_path
modifier|*
name|path
parameter_list|,
name|struct
name|ext4_extent
modifier|*
name|newext
parameter_list|,
name|int
name|at
parameter_list|)
block|{
name|struct
name|m_ext2fs
modifier|*
name|fs
decl_stmt|;
name|struct
name|buf
modifier|*
name|bp
decl_stmt|;
name|int
name|depth
init|=
name|ext4_ext_inode_depth
argument_list|(
name|ip
argument_list|)
decl_stmt|;
name|struct
name|ext4_extent_header
modifier|*
name|neh
decl_stmt|;
name|struct
name|ext4_extent_index
modifier|*
name|fidx
decl_stmt|;
name|struct
name|ext4_extent
modifier|*
name|ex
decl_stmt|;
name|int
name|i
init|=
name|at
decl_stmt|,
name|k
decl_stmt|,
name|m
decl_stmt|,
name|a
decl_stmt|;
name|e4fs_daddr_t
name|newblk
decl_stmt|,
name|oldblk
decl_stmt|;
name|uint32_t
name|border
decl_stmt|;
name|e4fs_daddr_t
modifier|*
name|ablks
init|=
name|NULL
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|fs
operator|=
name|ip
operator|->
name|i_e2fs
expr_stmt|;
name|bp
operator|=
name|NULL
expr_stmt|;
comment|/* 	 * We will split at current extent for now. 	 */
if|if
condition|(
name|path
index|[
name|depth
index|]
operator|.
name|ep_ext
operator|>
name|EXT_MAX_EXTENT
argument_list|(
name|path
index|[
name|depth
index|]
operator|.
name|ep_header
argument_list|)
condition|)
block|{
name|ext2_fserr
argument_list|(
name|fs
argument_list|,
name|ip
operator|->
name|i_uid
argument_list|,
literal|"extent is out of range => extent corrupted"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EIO
operator|)
return|;
block|}
if|if
condition|(
name|path
index|[
name|depth
index|]
operator|.
name|ep_ext
operator|!=
name|EXT_MAX_EXTENT
argument_list|(
name|path
index|[
name|depth
index|]
operator|.
name|ep_header
argument_list|)
condition|)
name|border
operator|=
name|path
index|[
name|depth
index|]
operator|.
name|ep_ext
index|[
literal|1
index|]
operator|.
name|e_blk
expr_stmt|;
else|else
name|border
operator|=
name|newext
operator|->
name|e_blk
expr_stmt|;
comment|/* Allocate new blocks. */
name|ablks
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|e4fs_daddr_t
argument_list|)
operator|*
name|depth
argument_list|,
name|M_EXT2EXTENTS
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ablks
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
for|for
control|(
name|a
operator|=
literal|0
init|;
name|a
operator|<
name|depth
operator|-
name|at
condition|;
name|a
operator|++
control|)
block|{
name|newblk
operator|=
name|ext4_ext_alloc_meta
argument_list|(
name|ip
argument_list|)
expr_stmt|;
if|if
condition|(
name|newblk
operator|==
literal|0
condition|)
goto|goto
name|cleanup
goto|;
name|ablks
index|[
name|a
index|]
operator|=
name|newblk
expr_stmt|;
block|}
name|newblk
operator|=
name|ablks
index|[
operator|--
name|a
index|]
expr_stmt|;
name|bp
operator|=
name|getblk
argument_list|(
name|ip
operator|->
name|i_devvp
argument_list|,
name|fsbtodb
argument_list|(
name|fs
argument_list|,
name|newblk
argument_list|)
argument_list|,
name|fs
operator|->
name|e2fs_bsize
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bp
condition|)
block|{
name|error
operator|=
name|EIO
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|neh
operator|=
name|ext4_ext_block_header
argument_list|(
name|bp
operator|->
name|b_data
argument_list|)
expr_stmt|;
name|neh
operator|->
name|eh_ecount
operator|=
literal|0
expr_stmt|;
name|neh
operator|->
name|eh_max
operator|=
name|ext4_ext_space_block
argument_list|(
name|ip
argument_list|)
expr_stmt|;
name|neh
operator|->
name|eh_magic
operator|=
name|EXT4_EXT_MAGIC
expr_stmt|;
name|neh
operator|->
name|eh_depth
operator|=
literal|0
expr_stmt|;
name|ex
operator|=
name|EXT_FIRST_EXTENT
argument_list|(
name|neh
argument_list|)
expr_stmt|;
if|if
condition|(
name|path
index|[
name|depth
index|]
operator|.
name|ep_header
operator|->
name|eh_ecount
operator|!=
name|path
index|[
name|depth
index|]
operator|.
name|ep_header
operator|->
name|eh_max
condition|)
block|{
name|ext2_fserr
argument_list|(
name|fs
argument_list|,
name|ip
operator|->
name|i_uid
argument_list|,
literal|"extents count out of range => extent corrupted"
argument_list|)
expr_stmt|;
name|error
operator|=
name|EIO
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
comment|/* Start copy from next extent. */
name|m
operator|=
literal|0
expr_stmt|;
name|path
index|[
name|depth
index|]
operator|.
name|ep_ext
operator|++
expr_stmt|;
while|while
condition|(
name|path
index|[
name|depth
index|]
operator|.
name|ep_ext
operator|<=
name|EXT_MAX_EXTENT
argument_list|(
name|path
index|[
name|depth
index|]
operator|.
name|ep_header
argument_list|)
condition|)
block|{
name|path
index|[
name|depth
index|]
operator|.
name|ep_ext
operator|++
expr_stmt|;
name|m
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|m
condition|)
block|{
name|memmove
argument_list|(
name|ex
argument_list|,
name|path
index|[
name|depth
index|]
operator|.
name|ep_ext
operator|-
name|m
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ext4_extent
argument_list|)
operator|*
name|m
argument_list|)
expr_stmt|;
name|neh
operator|->
name|eh_ecount
operator|=
name|neh
operator|->
name|eh_ecount
operator|+
name|m
expr_stmt|;
block|}
name|bwrite
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|bp
operator|=
name|NULL
expr_stmt|;
comment|/* Fix old leaf. */
if|if
condition|(
name|m
condition|)
block|{
name|path
index|[
name|depth
index|]
operator|.
name|ep_header
operator|->
name|eh_ecount
operator|=
name|path
index|[
name|depth
index|]
operator|.
name|ep_header
operator|->
name|eh_ecount
operator|-
name|m
expr_stmt|;
name|ext4_ext_dirty
argument_list|(
name|ip
argument_list|,
name|path
operator|+
name|depth
argument_list|)
expr_stmt|;
block|}
comment|/* Create intermediate indexes. */
name|k
operator|=
name|depth
operator|-
name|at
operator|-
literal|1
expr_stmt|;
name|KASSERT
argument_list|(
name|k
operator|>=
literal|0
argument_list|,
operator|(
literal|"ext4_ext_split: negative k"
operator|)
argument_list|)
expr_stmt|;
comment|/* Insert new index into current index block. */
name|i
operator|=
name|depth
operator|-
literal|1
expr_stmt|;
while|while
condition|(
name|k
operator|--
condition|)
block|{
name|oldblk
operator|=
name|newblk
expr_stmt|;
name|newblk
operator|=
name|ablks
index|[
operator|--
name|a
index|]
expr_stmt|;
name|error
operator|=
name|bread
argument_list|(
name|ip
operator|->
name|i_devvp
argument_list|,
name|fsbtodb
argument_list|(
name|fs
argument_list|,
name|newblk
argument_list|)
argument_list|,
operator|(
name|int
operator|)
name|fs
operator|->
name|e2fs_bsize
argument_list|,
name|NOCRED
argument_list|,
operator|&
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|brelse
argument_list|(
name|bp
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|neh
operator|=
operator|(
expr|struct
name|ext4_extent_header
operator|*
operator|)
name|bp
operator|->
name|b_data
expr_stmt|;
name|neh
operator|->
name|eh_ecount
operator|=
literal|1
expr_stmt|;
name|neh
operator|->
name|eh_magic
operator|=
name|EXT4_EXT_MAGIC
expr_stmt|;
name|neh
operator|->
name|eh_max
operator|=
name|ext4_ext_space_block_index
argument_list|(
name|ip
argument_list|)
expr_stmt|;
name|neh
operator|->
name|eh_depth
operator|=
name|depth
operator|-
name|i
expr_stmt|;
name|fidx
operator|=
name|EXT_FIRST_INDEX
argument_list|(
name|neh
argument_list|)
expr_stmt|;
name|fidx
operator|->
name|ei_blk
operator|=
name|border
expr_stmt|;
name|ext4_index_store_pblock
argument_list|(
name|fidx
argument_list|,
name|oldblk
argument_list|)
expr_stmt|;
name|m
operator|=
literal|0
expr_stmt|;
name|path
index|[
name|i
index|]
operator|.
name|ep_index
operator|++
expr_stmt|;
while|while
condition|(
name|path
index|[
name|i
index|]
operator|.
name|ep_index
operator|<=
name|EXT_MAX_INDEX
argument_list|(
name|path
index|[
name|i
index|]
operator|.
name|ep_header
argument_list|)
condition|)
block|{
name|path
index|[
name|i
index|]
operator|.
name|ep_index
operator|++
expr_stmt|;
name|m
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|m
condition|)
block|{
name|memmove
argument_list|(
operator|++
name|fidx
argument_list|,
name|path
index|[
name|i
index|]
operator|.
name|ep_index
operator|-
name|m
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ext4_extent_index
argument_list|)
operator|*
name|m
argument_list|)
expr_stmt|;
name|neh
operator|->
name|eh_ecount
operator|=
name|neh
operator|->
name|eh_ecount
operator|+
name|m
expr_stmt|;
block|}
name|bwrite
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|bp
operator|=
name|NULL
expr_stmt|;
comment|/* Fix old index. */
if|if
condition|(
name|m
condition|)
block|{
name|path
index|[
name|i
index|]
operator|.
name|ep_header
operator|->
name|eh_ecount
operator|=
name|path
index|[
name|i
index|]
operator|.
name|ep_header
operator|->
name|eh_ecount
operator|-
name|m
expr_stmt|;
name|ext4_ext_dirty
argument_list|(
name|ip
argument_list|,
name|path
operator|+
name|i
argument_list|)
expr_stmt|;
block|}
name|i
operator|--
expr_stmt|;
block|}
name|error
operator|=
name|ext4_ext_insert_index
argument_list|(
name|ip
argument_list|,
name|path
operator|+
name|at
argument_list|,
name|border
argument_list|,
name|newblk
argument_list|)
expr_stmt|;
name|cleanup
label|:
if|if
condition|(
name|bp
condition|)
name|brelse
argument_list|(
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|depth
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|ablks
index|[
name|i
index|]
condition|)
continue|continue;
name|ext4_ext_blkfree
argument_list|(
name|ip
argument_list|,
name|ablks
index|[
name|i
index|]
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
name|free
argument_list|(
name|ablks
argument_list|,
name|M_EXT2EXTENTS
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ext4_ext_grow_indepth
parameter_list|(
name|struct
name|inode
modifier|*
name|ip
parameter_list|,
name|struct
name|ext4_extent_path
modifier|*
name|path
parameter_list|,
name|struct
name|ext4_extent
modifier|*
name|newext
parameter_list|)
block|{
name|struct
name|m_ext2fs
modifier|*
name|fs
decl_stmt|;
name|struct
name|ext4_extent_path
modifier|*
name|curpath
decl_stmt|;
name|struct
name|ext4_extent_header
modifier|*
name|neh
decl_stmt|;
name|struct
name|ext4_extent_index
modifier|*
name|fidx
decl_stmt|;
name|struct
name|buf
modifier|*
name|bp
decl_stmt|;
name|e4fs_daddr_t
name|newblk
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|fs
operator|=
name|ip
operator|->
name|i_e2fs
expr_stmt|;
name|curpath
operator|=
name|path
expr_stmt|;
name|newblk
operator|=
name|ext4_ext_alloc_meta
argument_list|(
name|ip
argument_list|)
expr_stmt|;
if|if
condition|(
name|newblk
operator|==
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|bp
operator|=
name|getblk
argument_list|(
name|ip
operator|->
name|i_devvp
argument_list|,
name|fsbtodb
argument_list|(
name|fs
argument_list|,
name|newblk
argument_list|)
argument_list|,
name|fs
operator|->
name|e2fs_bsize
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bp
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
comment|/* Move top-level index/leaf into new block. */
name|memmove
argument_list|(
name|bp
operator|->
name|b_data
argument_list|,
name|curpath
operator|->
name|ep_header
argument_list|,
sizeof|sizeof
argument_list|(
name|ip
operator|->
name|i_data
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Set size of new block */
name|neh
operator|=
name|ext4_ext_block_header
argument_list|(
name|bp
operator|->
name|b_data
argument_list|)
expr_stmt|;
name|neh
operator|->
name|eh_magic
operator|=
name|EXT4_EXT_MAGIC
expr_stmt|;
if|if
condition|(
name|ext4_ext_inode_depth
argument_list|(
name|ip
argument_list|)
condition|)
name|neh
operator|->
name|eh_max
operator|=
name|ext4_ext_space_block_index
argument_list|(
name|ip
argument_list|)
expr_stmt|;
else|else
name|neh
operator|->
name|eh_max
operator|=
name|ext4_ext_space_block
argument_list|(
name|ip
argument_list|)
expr_stmt|;
name|error
operator|=
name|bwrite
argument_list|(
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|out
goto|;
name|bp
operator|=
name|NULL
expr_stmt|;
name|curpath
operator|->
name|ep_header
operator|->
name|eh_magic
operator|=
name|EXT4_EXT_MAGIC
expr_stmt|;
name|curpath
operator|->
name|ep_header
operator|->
name|eh_max
operator|=
name|ext4_ext_space_root
argument_list|(
name|ip
argument_list|)
expr_stmt|;
name|curpath
operator|->
name|ep_header
operator|->
name|eh_ecount
operator|=
literal|1
expr_stmt|;
name|curpath
operator|->
name|ep_index
operator|=
name|EXT_FIRST_INDEX
argument_list|(
name|curpath
operator|->
name|ep_header
argument_list|)
expr_stmt|;
name|curpath
operator|->
name|ep_index
operator|->
name|ei_blk
operator|=
name|EXT_FIRST_EXTENT
argument_list|(
name|path
index|[
literal|0
index|]
operator|.
name|ep_header
argument_list|)
operator|->
name|e_blk
expr_stmt|;
name|ext4_index_store_pblock
argument_list|(
name|curpath
operator|->
name|ep_index
argument_list|,
name|newblk
argument_list|)
expr_stmt|;
name|neh
operator|=
name|ext4_ext_inode_header
argument_list|(
name|ip
argument_list|)
expr_stmt|;
name|fidx
operator|=
name|EXT_FIRST_INDEX
argument_list|(
name|neh
argument_list|)
expr_stmt|;
name|neh
operator|->
name|eh_depth
operator|=
name|path
operator|->
name|ep_depth
operator|+
literal|1
expr_stmt|;
name|ext4_ext_dirty
argument_list|(
name|ip
argument_list|,
name|curpath
argument_list|)
expr_stmt|;
name|out
label|:
name|brelse
argument_list|(
name|bp
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ext4_ext_create_new_leaf
parameter_list|(
name|struct
name|inode
modifier|*
name|ip
parameter_list|,
name|struct
name|ext4_extent_path
modifier|*
name|path
parameter_list|,
name|struct
name|ext4_extent
modifier|*
name|newext
parameter_list|)
block|{
name|struct
name|m_ext2fs
modifier|*
name|fs
decl_stmt|;
name|struct
name|ext4_extent_path
modifier|*
name|curpath
decl_stmt|;
name|int
name|depth
decl_stmt|,
name|i
decl_stmt|,
name|error
decl_stmt|;
name|fs
operator|=
name|ip
operator|->
name|i_e2fs
expr_stmt|;
name|repeat
label|:
name|i
operator|=
name|depth
operator|=
name|ext4_ext_inode_depth
argument_list|(
name|ip
argument_list|)
expr_stmt|;
comment|/* Look for free index entry int the tree */
name|curpath
operator|=
name|path
operator|+
name|depth
expr_stmt|;
while|while
condition|(
name|i
operator|>
literal|0
operator|&&
operator|!
name|EXT_HAS_FREE_INDEX
argument_list|(
name|curpath
argument_list|)
condition|)
block|{
name|i
operator|--
expr_stmt|;
name|curpath
operator|--
expr_stmt|;
block|}
comment|/* 	 * We use already allocated block for index block, 	 * so subsequent data blocks should be contiguous. 	 */
if|if
condition|(
name|EXT_HAS_FREE_INDEX
argument_list|(
name|curpath
argument_list|)
condition|)
block|{
name|error
operator|=
name|ext4_ext_split
argument_list|(
name|ip
argument_list|,
name|path
argument_list|,
name|newext
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|out
goto|;
comment|/* Refill path. */
name|ext4_ext_drop_refs
argument_list|(
name|path
argument_list|)
expr_stmt|;
name|error
operator|=
name|ext4_ext_find_extent
argument_list|(
name|ip
argument_list|,
name|newext
operator|->
name|e_blk
argument_list|,
operator|&
name|path
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|out
goto|;
block|}
else|else
block|{
comment|/* Tree is full, do grow in depth. */
name|error
operator|=
name|ext4_ext_grow_indepth
argument_list|(
name|ip
argument_list|,
name|path
argument_list|,
name|newext
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|out
goto|;
comment|/* Refill path. */
name|ext4_ext_drop_refs
argument_list|(
name|path
argument_list|)
expr_stmt|;
name|error
operator|=
name|ext4_ext_find_extent
argument_list|(
name|ip
argument_list|,
name|newext
operator|->
name|e_blk
argument_list|,
operator|&
name|path
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|out
goto|;
comment|/* Check and split tree if required. */
name|depth
operator|=
name|ext4_ext_inode_depth
argument_list|(
name|ip
argument_list|)
expr_stmt|;
if|if
condition|(
name|path
index|[
name|depth
index|]
operator|.
name|ep_header
operator|->
name|eh_ecount
operator|==
name|path
index|[
name|depth
index|]
operator|.
name|ep_header
operator|->
name|eh_max
condition|)
goto|goto
name|repeat
goto|;
block|}
name|out
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ext4_ext_correct_indexes
parameter_list|(
name|struct
name|inode
modifier|*
name|ip
parameter_list|,
name|struct
name|ext4_extent_path
modifier|*
name|path
parameter_list|)
block|{
name|struct
name|ext4_extent_header
modifier|*
name|eh
decl_stmt|;
name|struct
name|ext4_extent
modifier|*
name|ex
decl_stmt|;
name|int32_t
name|border
decl_stmt|;
name|int
name|depth
decl_stmt|,
name|k
decl_stmt|;
name|depth
operator|=
name|ext4_ext_inode_depth
argument_list|(
name|ip
argument_list|)
expr_stmt|;
name|eh
operator|=
name|path
index|[
name|depth
index|]
operator|.
name|ep_header
expr_stmt|;
name|ex
operator|=
name|path
index|[
name|depth
index|]
operator|.
name|ep_ext
expr_stmt|;
if|if
condition|(
name|ex
operator|==
name|NULL
operator|||
name|eh
operator|==
name|NULL
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
if|if
condition|(
operator|!
name|depth
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* We will correct tree if first leaf got modified only. */
if|if
condition|(
name|ex
operator|!=
name|EXT_FIRST_EXTENT
argument_list|(
name|eh
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|k
operator|=
name|depth
operator|-
literal|1
expr_stmt|;
name|border
operator|=
name|path
index|[
name|depth
index|]
operator|.
name|ep_ext
operator|->
name|e_blk
expr_stmt|;
name|path
index|[
name|k
index|]
operator|.
name|ep_index
operator|->
name|ei_blk
operator|=
name|border
expr_stmt|;
name|ext4_ext_dirty
argument_list|(
name|ip
argument_list|,
name|path
operator|+
name|k
argument_list|)
expr_stmt|;
while|while
condition|(
name|k
operator|--
condition|)
block|{
comment|/* Change all left-side indexes. */
if|if
condition|(
name|path
index|[
name|k
operator|+
literal|1
index|]
operator|.
name|ep_index
operator|!=
name|EXT_FIRST_INDEX
argument_list|(
name|path
index|[
name|k
operator|+
literal|1
index|]
operator|.
name|ep_header
argument_list|)
condition|)
break|break;
name|path
index|[
name|k
index|]
operator|.
name|ep_index
operator|->
name|ei_blk
operator|=
name|border
expr_stmt|;
name|ext4_ext_dirty
argument_list|(
name|ip
argument_list|,
name|path
operator|+
name|k
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ext4_ext_insert_extent
parameter_list|(
name|struct
name|inode
modifier|*
name|ip
parameter_list|,
name|struct
name|ext4_extent_path
modifier|*
name|path
parameter_list|,
name|struct
name|ext4_extent
modifier|*
name|newext
parameter_list|)
block|{
name|struct
name|m_ext2fs
modifier|*
name|fs
decl_stmt|;
name|struct
name|ext4_extent_header
modifier|*
name|eh
decl_stmt|;
name|struct
name|ext4_extent
modifier|*
name|ex
decl_stmt|,
modifier|*
name|nex
decl_stmt|,
modifier|*
name|nearex
decl_stmt|;
name|struct
name|ext4_extent_path
modifier|*
name|npath
decl_stmt|;
name|int
name|depth
decl_stmt|,
name|len
decl_stmt|,
name|error
decl_stmt|,
name|next
decl_stmt|;
name|fs
operator|=
name|ip
operator|->
name|i_e2fs
expr_stmt|;
name|depth
operator|=
name|ext4_ext_inode_depth
argument_list|(
name|ip
argument_list|)
expr_stmt|;
name|ex
operator|=
name|path
index|[
name|depth
index|]
operator|.
name|ep_ext
expr_stmt|;
name|npath
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|newext
operator|->
name|e_len
operator|==
literal|0
operator|||
name|path
index|[
name|depth
index|]
operator|.
name|ep_header
operator|==
name|NULL
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
comment|/* Insert block into found extent. */
if|if
condition|(
name|ex
operator|&&
name|ext4_can_extents_be_merged
argument_list|(
name|ex
argument_list|,
name|newext
argument_list|)
condition|)
block|{
name|ex
operator|->
name|e_len
operator|=
name|ex
operator|->
name|e_len
operator|+
name|newext
operator|->
name|e_len
expr_stmt|;
name|eh
operator|=
name|path
index|[
name|depth
index|]
operator|.
name|ep_header
expr_stmt|;
name|nearex
operator|=
name|ex
expr_stmt|;
goto|goto
name|merge
goto|;
block|}
name|repeat
label|:
name|depth
operator|=
name|ext4_ext_inode_depth
argument_list|(
name|ip
argument_list|)
expr_stmt|;
name|eh
operator|=
name|path
index|[
name|depth
index|]
operator|.
name|ep_header
expr_stmt|;
if|if
condition|(
name|eh
operator|->
name|eh_ecount
operator|<
name|eh
operator|->
name|eh_max
condition|)
goto|goto
name|has_space
goto|;
comment|/* Try next leaf */
name|nex
operator|=
name|EXT_LAST_EXTENT
argument_list|(
name|eh
argument_list|)
expr_stmt|;
name|next
operator|=
name|ext4_ext_next_leaf_block
argument_list|(
name|ip
argument_list|,
name|path
argument_list|)
expr_stmt|;
if|if
condition|(
name|newext
operator|->
name|e_blk
operator|>
name|nex
operator|->
name|e_blk
operator|&&
name|next
operator|!=
name|EXT4_MAX_BLOCKS
condition|)
block|{
name|KASSERT
argument_list|(
name|npath
operator|==
name|NULL
argument_list|,
operator|(
literal|"ext4_ext_insert_extent: bad path"
operator|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|ext4_ext_find_extent
argument_list|(
name|ip
argument_list|,
name|next
argument_list|,
operator|&
name|npath
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|cleanup
goto|;
if|if
condition|(
name|npath
operator|->
name|ep_depth
operator|!=
name|path
operator|->
name|ep_depth
condition|)
block|{
name|error
operator|=
name|EIO
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|eh
operator|=
name|npath
index|[
name|depth
index|]
operator|.
name|ep_header
expr_stmt|;
if|if
condition|(
name|eh
operator|->
name|eh_ecount
operator|<
name|eh
operator|->
name|eh_max
condition|)
block|{
name|path
operator|=
name|npath
expr_stmt|;
goto|goto
name|repeat
goto|;
block|}
block|}
comment|/* 	 * There is no free space in the found leaf, 	 * try to add a new leaf to the tree. 	 */
name|error
operator|=
name|ext4_ext_create_new_leaf
argument_list|(
name|ip
argument_list|,
name|path
argument_list|,
name|newext
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|cleanup
goto|;
name|depth
operator|=
name|ext4_ext_inode_depth
argument_list|(
name|ip
argument_list|)
expr_stmt|;
name|eh
operator|=
name|path
index|[
name|depth
index|]
operator|.
name|ep_header
expr_stmt|;
name|has_space
label|:
name|nearex
operator|=
name|path
index|[
name|depth
index|]
operator|.
name|ep_ext
expr_stmt|;
if|if
condition|(
operator|!
name|nearex
condition|)
block|{
comment|/* Create new extent in the leaf. */
name|path
index|[
name|depth
index|]
operator|.
name|ep_ext
operator|=
name|EXT_FIRST_EXTENT
argument_list|(
name|eh
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|newext
operator|->
name|e_blk
operator|>
name|nearex
operator|->
name|e_blk
condition|)
block|{
if|if
condition|(
name|nearex
operator|!=
name|EXT_LAST_EXTENT
argument_list|(
name|eh
argument_list|)
condition|)
block|{
name|len
operator|=
name|EXT_MAX_EXTENT
argument_list|(
name|eh
argument_list|)
operator|-
name|nearex
expr_stmt|;
name|len
operator|=
operator|(
name|len
operator|-
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|ext4_extent
argument_list|)
expr_stmt|;
name|len
operator|=
name|len
operator|<
literal|0
condition|?
literal|0
else|:
name|len
expr_stmt|;
name|memmove
argument_list|(
name|nearex
operator|+
literal|2
argument_list|,
name|nearex
operator|+
literal|1
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
name|path
index|[
name|depth
index|]
operator|.
name|ep_ext
operator|=
name|nearex
operator|+
literal|1
expr_stmt|;
block|}
else|else
block|{
name|len
operator|=
operator|(
name|EXT_MAX_EXTENT
argument_list|(
name|eh
argument_list|)
operator|-
name|nearex
operator|)
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|ext4_extent
argument_list|)
expr_stmt|;
name|len
operator|=
name|len
operator|<
literal|0
condition|?
literal|0
else|:
name|len
expr_stmt|;
name|memmove
argument_list|(
name|nearex
operator|+
literal|1
argument_list|,
name|nearex
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|path
index|[
name|depth
index|]
operator|.
name|ep_ext
operator|=
name|nearex
expr_stmt|;
block|}
name|eh
operator|->
name|eh_ecount
operator|=
name|eh
operator|->
name|eh_ecount
operator|+
literal|1
expr_stmt|;
name|nearex
operator|=
name|path
index|[
name|depth
index|]
operator|.
name|ep_ext
expr_stmt|;
name|nearex
operator|->
name|e_blk
operator|=
name|newext
operator|->
name|e_blk
expr_stmt|;
name|nearex
operator|->
name|e_start_lo
operator|=
name|newext
operator|->
name|e_start_lo
expr_stmt|;
name|nearex
operator|->
name|e_start_hi
operator|=
name|newext
operator|->
name|e_start_hi
expr_stmt|;
name|nearex
operator|->
name|e_len
operator|=
name|newext
operator|->
name|e_len
expr_stmt|;
name|merge
label|:
comment|/* Try to merge extents to the right. */
while|while
condition|(
name|nearex
operator|<
name|EXT_LAST_EXTENT
argument_list|(
name|eh
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|ext4_can_extents_be_merged
argument_list|(
name|nearex
argument_list|,
name|nearex
operator|+
literal|1
argument_list|)
condition|)
break|break;
comment|/* Merge with next extent. */
name|nearex
operator|->
name|e_len
operator|=
name|nearex
operator|->
name|e_len
operator|+
name|nearex
index|[
literal|1
index|]
operator|.
name|e_len
expr_stmt|;
if|if
condition|(
name|nearex
operator|+
literal|1
operator|<
name|EXT_LAST_EXTENT
argument_list|(
name|eh
argument_list|)
condition|)
block|{
name|len
operator|=
operator|(
name|EXT_LAST_EXTENT
argument_list|(
name|eh
argument_list|)
operator|-
name|nearex
operator|-
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|ext4_extent
argument_list|)
expr_stmt|;
name|memmove
argument_list|(
name|nearex
operator|+
literal|1
argument_list|,
name|nearex
operator|+
literal|2
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
name|eh
operator|->
name|eh_ecount
operator|=
name|eh
operator|->
name|eh_ecount
operator|-
literal|1
expr_stmt|;
name|KASSERT
argument_list|(
name|eh
operator|->
name|eh_ecount
operator|!=
literal|0
argument_list|,
operator|(
literal|"ext4_ext_insert_extent: bad ecount"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Try to merge extents to the left, 	 * start from inexes correction. 	 */
name|error
operator|=
name|ext4_ext_correct_indexes
argument_list|(
name|ip
argument_list|,
name|path
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|cleanup
goto|;
name|ext4_ext_dirty
argument_list|(
name|ip
argument_list|,
name|path
operator|+
name|depth
argument_list|)
expr_stmt|;
name|cleanup
label|:
if|if
condition|(
name|npath
condition|)
block|{
name|ext4_ext_drop_refs
argument_list|(
name|npath
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|npath
argument_list|,
name|M_EXT2EXTENTS
argument_list|)
expr_stmt|;
block|}
name|ip
operator|->
name|i_ext_cache
operator|.
name|ec_type
operator|=
name|EXT4_EXT_CACHE_NO
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|e4fs_daddr_t
name|ext4_new_blocks
parameter_list|(
name|struct
name|inode
modifier|*
name|ip
parameter_list|,
name|daddr_t
name|lbn
parameter_list|,
name|e4fs_daddr_t
name|pref
parameter_list|,
name|struct
name|ucred
modifier|*
name|cred
parameter_list|,
name|unsigned
name|long
modifier|*
name|count
parameter_list|,
name|int
modifier|*
name|perror
parameter_list|)
block|{
name|struct
name|m_ext2fs
modifier|*
name|fs
decl_stmt|;
name|struct
name|ext2mount
modifier|*
name|ump
decl_stmt|;
name|e4fs_daddr_t
name|newblk
decl_stmt|;
name|fs
operator|=
name|ip
operator|->
name|i_e2fs
expr_stmt|;
name|ump
operator|=
name|ip
operator|->
name|i_ump
expr_stmt|;
comment|/* 	 * We will allocate only single block for now. 	 */
if|if
condition|(
operator|*
name|count
operator|>
literal|1
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|EXT2_LOCK
argument_list|(
name|ip
operator|->
name|i_ump
argument_list|)
expr_stmt|;
operator|*
name|perror
operator|=
name|ext2_alloc
argument_list|(
name|ip
argument_list|,
name|lbn
argument_list|,
name|pref
argument_list|,
operator|(
name|int
operator|)
name|fs
operator|->
name|e2fs_bsize
argument_list|,
name|cred
argument_list|,
operator|&
name|newblk
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|perror
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|newblk
condition|)
block|{
name|ip
operator|->
name|i_flag
operator||=
name|IN_CHANGE
operator||
name|IN_UPDATE
expr_stmt|;
name|ext2_update
argument_list|(
name|ip
operator|->
name|i_vnode
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|newblk
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ext4_ext_get_blocks
parameter_list|(
name|struct
name|inode
modifier|*
name|ip
parameter_list|,
name|e4fs_daddr_t
name|iblk
parameter_list|,
name|unsigned
name|long
name|max_blocks
parameter_list|,
name|struct
name|ucred
modifier|*
name|cred
parameter_list|,
name|struct
name|buf
modifier|*
modifier|*
name|bpp
parameter_list|,
name|int
modifier|*
name|pallocated
parameter_list|,
name|uint32_t
modifier|*
name|nb
parameter_list|)
block|{
name|struct
name|m_ext2fs
modifier|*
name|fs
decl_stmt|;
name|struct
name|buf
modifier|*
name|bp
init|=
name|NULL
decl_stmt|;
name|struct
name|ext4_extent_path
modifier|*
name|path
decl_stmt|;
name|struct
name|ext4_extent
name|newex
decl_stmt|,
modifier|*
name|ex
decl_stmt|;
name|e4fs_daddr_t
name|bpref
decl_stmt|,
name|newblk
init|=
literal|0
decl_stmt|;
name|unsigned
name|long
name|allocated
init|=
literal|0
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|,
name|depth
decl_stmt|;
name|fs
operator|=
name|ip
operator|->
name|i_e2fs
expr_stmt|;
operator|*
name|pallocated
operator|=
literal|0
expr_stmt|;
name|path
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|bpp
condition|)
operator|*
name|bpp
operator|=
name|NULL
expr_stmt|;
comment|/* Check cache. */
if|if
condition|(
operator|(
name|bpref
operator|=
name|ext4_ext_in_cache
argument_list|(
name|ip
argument_list|,
name|iblk
argument_list|,
operator|&
name|newex
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
name|bpref
operator|==
name|EXT4_EXT_CACHE_IN
condition|)
block|{
comment|/* Block is already allocated. */
name|newblk
operator|=
name|iblk
operator|-
name|newex
operator|.
name|e_blk
operator|+
name|ext4_ext_extent_pblock
argument_list|(
operator|&
name|newex
argument_list|)
expr_stmt|;
name|allocated
operator|=
name|newex
operator|.
name|e_len
operator|-
operator|(
name|iblk
operator|-
name|newex
operator|.
name|e_blk
operator|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
else|else
block|{
name|error
operator|=
name|EIO
expr_stmt|;
goto|goto
name|out2
goto|;
block|}
block|}
name|error
operator|=
name|ext4_ext_find_extent
argument_list|(
name|ip
argument_list|,
name|iblk
argument_list|,
operator|&
name|path
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
goto|goto
name|out2
goto|;
block|}
name|depth
operator|=
name|ext4_ext_inode_depth
argument_list|(
name|ip
argument_list|)
expr_stmt|;
if|if
condition|(
name|path
index|[
name|depth
index|]
operator|.
name|ep_ext
operator|==
name|NULL
operator|&&
name|depth
operator|!=
literal|0
condition|)
block|{
name|error
operator|=
name|EIO
expr_stmt|;
goto|goto
name|out2
goto|;
block|}
if|if
condition|(
operator|(
name|ex
operator|=
name|path
index|[
name|depth
index|]
operator|.
name|ep_ext
operator|)
condition|)
block|{
name|uint64_t
name|lblk
init|=
name|ex
operator|->
name|e_blk
decl_stmt|;
name|uint16_t
name|e_len
init|=
name|ex
operator|->
name|e_len
decl_stmt|;
name|e4fs_daddr_t
name|e_start
init|=
name|ext4_ext_extent_pblock
argument_list|(
name|ex
argument_list|)
decl_stmt|;
if|if
condition|(
name|e_len
operator|>
name|EXT4_MAX_LEN
condition|)
goto|goto
name|out2
goto|;
comment|/* If we found extent covers block, simply return it. */
if|if
condition|(
name|iblk
operator|>=
name|lblk
operator|&&
name|iblk
operator|<
name|lblk
operator|+
name|e_len
condition|)
block|{
name|newblk
operator|=
name|iblk
operator|-
name|lblk
operator|+
name|e_start
expr_stmt|;
name|allocated
operator|=
name|e_len
operator|-
operator|(
name|iblk
operator|-
name|lblk
operator|)
expr_stmt|;
name|ext4_ext_put_in_cache
argument_list|(
name|ip
argument_list|,
name|lblk
argument_list|,
name|e_len
argument_list|,
name|e_start
argument_list|,
name|EXT4_EXT_CACHE_IN
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
comment|/* Allocate the new block. */
if|if
condition|(
name|S_ISREG
argument_list|(
name|ip
operator|->
name|i_mode
argument_list|)
operator|&&
operator|(
operator|!
name|ip
operator|->
name|i_next_alloc_block
operator|)
condition|)
block|{
name|ip
operator|->
name|i_next_alloc_goal
operator|=
literal|0
expr_stmt|;
block|}
name|bpref
operator|=
name|ext4_ext_blkpref
argument_list|(
name|ip
argument_list|,
name|path
argument_list|,
name|iblk
argument_list|)
expr_stmt|;
name|allocated
operator|=
name|max_blocks
expr_stmt|;
name|newblk
operator|=
name|ext4_new_blocks
argument_list|(
name|ip
argument_list|,
name|iblk
argument_list|,
name|bpref
argument_list|,
name|cred
argument_list|,
operator|&
name|allocated
argument_list|,
operator|&
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|newblk
condition|)
goto|goto
name|out2
goto|;
comment|/* Try to insert new extent into found leaf and return. */
name|newex
operator|.
name|e_blk
operator|=
name|iblk
expr_stmt|;
name|ext4_ext_store_pblock
argument_list|(
operator|&
name|newex
argument_list|,
name|newblk
argument_list|)
expr_stmt|;
name|newex
operator|.
name|e_len
operator|=
name|allocated
expr_stmt|;
name|error
operator|=
name|ext4_ext_insert_extent
argument_list|(
name|ip
argument_list|,
name|path
argument_list|,
operator|&
name|newex
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|out2
goto|;
name|newblk
operator|=
name|ext4_ext_extent_pblock
argument_list|(
operator|&
name|newex
argument_list|)
expr_stmt|;
name|ext4_ext_put_in_cache
argument_list|(
name|ip
argument_list|,
name|iblk
argument_list|,
name|allocated
argument_list|,
name|newblk
argument_list|,
name|EXT4_EXT_CACHE_IN
argument_list|)
expr_stmt|;
operator|*
name|pallocated
operator|=
literal|1
expr_stmt|;
name|out
label|:
if|if
condition|(
name|allocated
operator|>
name|max_blocks
condition|)
name|allocated
operator|=
name|max_blocks
expr_stmt|;
if|if
condition|(
name|bpp
condition|)
block|{
name|error
operator|=
name|bread
argument_list|(
name|ip
operator|->
name|i_devvp
argument_list|,
name|fsbtodb
argument_list|(
name|fs
argument_list|,
name|newblk
argument_list|)
argument_list|,
name|fs
operator|->
name|e2fs_bsize
argument_list|,
name|cred
argument_list|,
operator|&
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|brelse
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|*
name|bpp
operator|=
name|bp
expr_stmt|;
block|}
block|}
name|out2
label|:
if|if
condition|(
name|path
condition|)
block|{
name|ext4_ext_drop_refs
argument_list|(
name|path
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|path
argument_list|,
name|M_EXT2EXTENTS
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|nb
condition|)
operator|*
name|nb
operator|=
name|newblk
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|uint16_t
name|ext4_ext_get_actual_len
parameter_list|(
name|struct
name|ext4_extent
modifier|*
name|ext
parameter_list|)
block|{
return|return
operator|(
name|ext
operator|->
name|e_len
operator|<=
name|EXT_INIT_MAX_LEN
condition|?
name|ext
operator|->
name|e_len
else|:
operator|(
name|ext
operator|->
name|e_len
operator|-
name|EXT_INIT_MAX_LEN
operator|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|struct
name|ext4_extent_header
modifier|*
name|ext4_ext_header
parameter_list|(
name|struct
name|inode
modifier|*
name|ip
parameter_list|)
block|{
return|return
operator|(
expr|struct
name|ext4_extent_header
operator|*
operator|)
name|ip
operator|->
name|i_db
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ext4_remove_blocks
parameter_list|(
name|struct
name|inode
modifier|*
name|ip
parameter_list|,
name|struct
name|ext4_extent
modifier|*
name|ex
parameter_list|,
name|unsigned
name|long
name|from
parameter_list|,
name|unsigned
name|long
name|to
parameter_list|)
block|{
name|unsigned
name|long
name|num
decl_stmt|,
name|start
decl_stmt|;
if|if
condition|(
name|from
operator|>=
name|ex
operator|->
name|e_blk
operator|&&
name|to
operator|==
name|ex
operator|->
name|e_blk
operator|+
name|ext4_ext_get_actual_len
argument_list|(
name|ex
argument_list|)
operator|-
literal|1
condition|)
block|{
comment|/* Tail cleanup. */
name|num
operator|=
name|ex
operator|->
name|e_blk
operator|+
name|ext4_ext_get_actual_len
argument_list|(
name|ex
argument_list|)
operator|-
name|from
expr_stmt|;
name|start
operator|=
name|ext4_ext_extent_pblock
argument_list|(
name|ex
argument_list|)
operator|+
name|ext4_ext_get_actual_len
argument_list|(
name|ex
argument_list|)
operator|-
name|num
expr_stmt|;
name|ext4_ext_blkfree
argument_list|(
name|ip
argument_list|,
name|start
argument_list|,
name|num
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ext4_ext_rm_index
parameter_list|(
name|struct
name|inode
modifier|*
name|ip
parameter_list|,
name|struct
name|ext4_extent_path
modifier|*
name|path
parameter_list|)
block|{
name|e4fs_daddr_t
name|leaf
decl_stmt|;
comment|/* Free index block. */
name|path
operator|--
expr_stmt|;
name|leaf
operator|=
name|ext4_ext_index_pblock
argument_list|(
name|path
operator|->
name|ep_index
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|path
operator|->
name|ep_header
operator|->
name|eh_ecount
operator|!=
literal|0
argument_list|,
operator|(
literal|"ext4_ext_rm_index: bad ecount"
operator|)
argument_list|)
expr_stmt|;
name|path
operator|->
name|ep_header
operator|->
name|eh_ecount
operator|--
expr_stmt|;
name|ext4_ext_dirty
argument_list|(
name|ip
argument_list|,
name|path
argument_list|)
expr_stmt|;
name|ext4_ext_blkfree
argument_list|(
name|ip
argument_list|,
name|leaf
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ext4_ext_rm_leaf
parameter_list|(
name|struct
name|inode
modifier|*
name|ip
parameter_list|,
name|struct
name|ext4_extent_path
modifier|*
name|path
parameter_list|,
name|uint64_t
name|start
parameter_list|)
block|{
name|struct
name|m_ext2fs
modifier|*
name|fs
decl_stmt|;
name|int
name|depth
decl_stmt|,
name|credits
decl_stmt|;
name|struct
name|ext4_extent_header
modifier|*
name|eh
decl_stmt|;
name|unsigned
name|int
name|a
decl_stmt|,
name|b
decl_stmt|,
name|block
decl_stmt|,
name|num
decl_stmt|;
name|unsigned
name|long
name|ex_blk
decl_stmt|;
name|unsigned
name|short
name|ex_len
decl_stmt|;
name|struct
name|ext4_extent
modifier|*
name|ex
decl_stmt|;
name|int
name|error
decl_stmt|,
name|correct_index
decl_stmt|;
name|fs
operator|=
name|ip
operator|->
name|i_e2fs
expr_stmt|;
name|depth
operator|=
name|ext4_ext_inode_depth
argument_list|(
name|ip
argument_list|)
expr_stmt|;
name|correct_index
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|path
index|[
name|depth
index|]
operator|.
name|ep_header
condition|)
block|{
if|if
condition|(
name|path
index|[
name|depth
index|]
operator|.
name|ep_data
operator|==
name|NULL
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|path
index|[
name|depth
index|]
operator|.
name|ep_header
operator|=
operator|(
expr|struct
name|ext4_extent_header
operator|*
operator|)
name|path
index|[
name|depth
index|]
operator|.
name|ep_data
expr_stmt|;
block|}
name|eh
operator|=
name|path
index|[
name|depth
index|]
operator|.
name|ep_header
expr_stmt|;
if|if
condition|(
operator|!
name|eh
condition|)
block|{
name|ext2_fserr
argument_list|(
name|fs
argument_list|,
name|ip
operator|->
name|i_uid
argument_list|,
literal|"bad header => extent corrupted"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EIO
operator|)
return|;
block|}
name|ex
operator|=
name|EXT_LAST_EXTENT
argument_list|(
name|eh
argument_list|)
expr_stmt|;
name|ex_blk
operator|=
name|ex
operator|->
name|e_blk
expr_stmt|;
name|ex_len
operator|=
name|ext4_ext_get_actual_len
argument_list|(
name|ex
argument_list|)
expr_stmt|;
while|while
condition|(
name|ex
operator|>=
name|EXT_FIRST_EXTENT
argument_list|(
name|eh
argument_list|)
operator|&&
name|ex_blk
operator|+
name|ex_len
operator|>
name|start
condition|)
block|{
name|path
index|[
name|depth
index|]
operator|.
name|ep_ext
operator|=
name|ex
expr_stmt|;
name|a
operator|=
name|ex_blk
operator|>
name|start
condition|?
name|ex_blk
else|:
name|start
expr_stmt|;
name|b
operator|=
operator|(
name|uint64_t
operator|)
name|ex_blk
operator|+
name|ex_len
operator|-
literal|1
operator|<
name|EXT4_MAX_BLOCKS
condition|?
name|ex_blk
operator|+
name|ex_len
operator|-
literal|1
else|:
name|EXT4_MAX_BLOCKS
expr_stmt|;
if|if
condition|(
name|a
operator|!=
name|ex_blk
operator|&&
name|b
operator|!=
name|ex_blk
operator|+
name|ex_len
operator|-
literal|1
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
elseif|else
if|if
condition|(
name|a
operator|!=
name|ex_blk
condition|)
block|{
comment|/* Remove tail of the extent. */
name|block
operator|=
name|ex_blk
expr_stmt|;
name|num
operator|=
name|a
operator|-
name|block
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|b
operator|!=
name|ex_blk
operator|+
name|ex_len
operator|-
literal|1
condition|)
block|{
comment|/* Remove head of the extent, not implemented. */
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
else|else
block|{
comment|/* Remove whole extent. */
name|block
operator|=
name|ex_blk
expr_stmt|;
name|num
operator|=
literal|0
expr_stmt|;
name|KASSERT
argument_list|(
name|a
operator|==
name|ex_blk
argument_list|,
operator|(
literal|"ext4_ext_rm_leaf: bad a"
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|b
operator|!=
name|ex_blk
operator|+
name|ex_len
operator|-
literal|1
argument_list|,
operator|(
literal|"ext4_ext_rm_leaf: bad b"
operator|)
argument_list|)
expr_stmt|;
block|}
name|credits
operator|=
name|EXT4_EXT_DEPTH_MAX
expr_stmt|;
if|if
condition|(
name|ex
operator|==
name|EXT_FIRST_EXTENT
argument_list|(
name|eh
argument_list|)
condition|)
block|{
name|correct_index
operator|=
literal|1
expr_stmt|;
name|credits
operator|+=
operator|(
name|ext4_ext_inode_depth
argument_list|(
name|ip
argument_list|)
operator|)
operator|+
literal|1
expr_stmt|;
block|}
name|error
operator|=
name|ext4_remove_blocks
argument_list|(
name|ip
argument_list|,
name|ex
argument_list|,
name|a
argument_list|,
name|b
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
name|num
operator|==
literal|0
condition|)
block|{
name|ext4_ext_store_pblock
argument_list|(
name|ex
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|eh
operator|->
name|eh_ecount
operator|--
expr_stmt|;
block|}
name|ex
operator|->
name|e_blk
operator|=
name|block
expr_stmt|;
name|ex
operator|->
name|e_len
operator|=
name|num
expr_stmt|;
name|ext4_ext_dirty
argument_list|(
name|ip
argument_list|,
name|path
operator|+
name|depth
argument_list|)
expr_stmt|;
name|ex
operator|--
expr_stmt|;
name|ex_blk
operator|=
name|ex
operator|->
name|e_blk
expr_stmt|;
name|ex_len
operator|=
name|ext4_ext_get_actual_len
argument_list|(
name|ex
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
if|if
condition|(
name|correct_index
operator|&&
name|eh
operator|->
name|eh_ecount
condition|)
name|error
operator|=
name|ext4_ext_correct_indexes
argument_list|(
name|ip
argument_list|,
name|path
argument_list|)
expr_stmt|;
comment|/* 	 * If this leaf is free, we should 	 * remove it from index block above. 	 */
if|if
condition|(
name|error
operator|==
literal|0
operator|&&
name|eh
operator|->
name|eh_ecount
operator|==
literal|0
operator|&&
name|path
index|[
name|depth
index|]
operator|.
name|ep_data
operator|!=
name|NULL
condition|)
name|error
operator|=
name|ext4_ext_rm_index
argument_list|(
name|ip
argument_list|,
name|path
operator|+
name|depth
argument_list|)
expr_stmt|;
name|out
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|buf
modifier|*
name|ext4_read_extent_tree_block
parameter_list|(
name|struct
name|inode
modifier|*
name|ip
parameter_list|,
name|e4fs_daddr_t
name|pblk
parameter_list|,
name|int
name|depth
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
name|struct
name|m_ext2fs
modifier|*
name|fs
decl_stmt|;
name|struct
name|ext4_extent_header
modifier|*
name|eh
decl_stmt|;
name|struct
name|buf
modifier|*
name|bp
decl_stmt|;
name|int
name|error
decl_stmt|;
name|fs
operator|=
name|ip
operator|->
name|i_e2fs
expr_stmt|;
name|error
operator|=
name|bread
argument_list|(
name|ip
operator|->
name|i_devvp
argument_list|,
name|fsbtodb
argument_list|(
name|fs
argument_list|,
name|pblk
argument_list|)
argument_list|,
name|fs
operator|->
name|e2fs_bsize
argument_list|,
name|NOCRED
argument_list|,
operator|&
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|brelse
argument_list|(
name|bp
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|eh
operator|=
name|ext4_ext_block_header
argument_list|(
name|bp
operator|->
name|b_data
argument_list|)
expr_stmt|;
if|if
condition|(
name|eh
operator|->
name|eh_depth
operator|!=
name|depth
condition|)
block|{
name|ext2_fserr
argument_list|(
name|fs
argument_list|,
name|ip
operator|->
name|i_uid
argument_list|,
literal|"unexpected eh_depth"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|error
operator|=
name|ext4_ext_check_header
argument_list|(
name|ip
argument_list|,
name|eh
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|err
goto|;
return|return
operator|(
name|bp
operator|)
return|;
name|err
label|:
name|brelse
argument_list|(
name|bp
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
specifier|inline
name|ext4_ext_more_to_rm
parameter_list|(
name|struct
name|ext4_extent_path
modifier|*
name|path
parameter_list|)
block|{
name|KASSERT
argument_list|(
name|path
operator|->
name|ep_index
operator|!=
name|NULL
argument_list|,
operator|(
literal|"ext4_ext_more_to_rm: bad index from path"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|path
operator|->
name|ep_index
operator|<
name|EXT_FIRST_INDEX
argument_list|(
name|path
operator|->
name|ep_header
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|path
operator|->
name|ep_header
operator|->
name|eh_ecount
operator|==
name|path
operator|->
name|index_count
condition|)
return|return
operator|(
literal|0
operator|)
return|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ext4_ext_remove_space
parameter_list|(
name|struct
name|inode
modifier|*
name|ip
parameter_list|,
name|off_t
name|length
parameter_list|,
name|int
name|flags
parameter_list|,
name|struct
name|ucred
modifier|*
name|cred
parameter_list|,
name|struct
name|thread
modifier|*
name|td
parameter_list|)
block|{
name|struct
name|buf
modifier|*
name|bp
decl_stmt|;
name|struct
name|ext4_extent_header
modifier|*
name|ehp
decl_stmt|;
name|struct
name|ext4_extent_path
modifier|*
name|path
decl_stmt|;
name|int
name|depth
decl_stmt|;
name|int
name|i
decl_stmt|,
name|error
decl_stmt|;
name|ehp
operator|=
operator|(
expr|struct
name|ext4_extent_header
operator|*
operator|)
name|ip
operator|->
name|i_db
expr_stmt|;
name|depth
operator|=
name|ext4_ext_inode_depth
argument_list|(
name|ip
argument_list|)
expr_stmt|;
name|error
operator|=
name|ext4_ext_check_header
argument_list|(
name|ip
argument_list|,
name|ehp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|path
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|ext4_extent_path
argument_list|)
operator|*
operator|(
name|depth
operator|+
literal|1
operator|)
argument_list|,
name|M_EXT2EXTENTS
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|path
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
name|i
operator|=
literal|0
expr_stmt|;
name|path
index|[
literal|0
index|]
operator|.
name|ep_header
operator|=
name|ehp
expr_stmt|;
name|path
index|[
literal|0
index|]
operator|.
name|ep_depth
operator|=
name|depth
expr_stmt|;
while|while
condition|(
name|i
operator|>=
literal|0
operator|&&
name|error
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|i
operator|==
name|depth
condition|)
block|{
comment|/* This is leaf. */
name|error
operator|=
name|ext4_ext_rm_leaf
argument_list|(
name|ip
argument_list|,
name|path
argument_list|,
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
break|break;
name|free
argument_list|(
name|path
index|[
name|i
index|]
operator|.
name|ep_data
argument_list|,
name|M_EXT2EXTENTS
argument_list|)
expr_stmt|;
name|path
index|[
name|i
index|]
operator|.
name|ep_data
operator|=
name|NULL
expr_stmt|;
name|i
operator|--
expr_stmt|;
continue|continue;
block|}
comment|/* This is index. */
if|if
condition|(
operator|!
name|path
index|[
name|i
index|]
operator|.
name|ep_header
condition|)
name|path
index|[
name|i
index|]
operator|.
name|ep_header
operator|=
operator|(
expr|struct
name|ext4_extent_header
operator|*
operator|)
name|path
index|[
name|i
index|]
operator|.
name|ep_data
expr_stmt|;
if|if
condition|(
operator|!
name|path
index|[
name|i
index|]
operator|.
name|ep_index
condition|)
block|{
comment|/* This level hasn't touched yet. */
name|path
index|[
name|i
index|]
operator|.
name|ep_index
operator|=
name|EXT_LAST_INDEX
argument_list|(
name|path
index|[
name|i
index|]
operator|.
name|ep_header
argument_list|)
expr_stmt|;
name|path
index|[
name|i
index|]
operator|.
name|index_count
operator|=
name|path
index|[
name|i
index|]
operator|.
name|ep_header
operator|->
name|eh_ecount
operator|+
literal|1
expr_stmt|;
block|}
else|else
block|{
comment|/* We've already was here, see at next index. */
name|path
index|[
name|i
index|]
operator|.
name|ep_index
operator|--
expr_stmt|;
block|}
if|if
condition|(
name|ext4_ext_more_to_rm
argument_list|(
name|path
operator|+
name|i
argument_list|)
condition|)
block|{
name|memset
argument_list|(
name|path
operator|+
name|i
operator|+
literal|1
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|path
argument_list|)
argument_list|)
expr_stmt|;
name|bp
operator|=
name|ext4_read_extent_tree_block
argument_list|(
name|ip
argument_list|,
name|ext4_ext_index_pblock
argument_list|(
name|path
index|[
name|i
index|]
operator|.
name|ep_index
argument_list|)
argument_list|,
name|path
index|[
literal|0
index|]
operator|.
name|ep_depth
operator|-
operator|(
name|i
operator|+
literal|1
operator|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bp
condition|)
block|{
name|error
operator|=
name|EIO
expr_stmt|;
break|break;
block|}
name|ext4_ext_fill_path_bdata
argument_list|(
operator|&
name|path
index|[
name|i
operator|+
literal|1
index|]
argument_list|,
name|bp
argument_list|,
name|ext4_ext_index_pblock
argument_list|(
name|path
index|[
name|i
index|]
operator|.
name|ep_index
argument_list|)
argument_list|)
expr_stmt|;
name|brelse
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|path
index|[
name|i
index|]
operator|.
name|index_count
operator|=
name|path
index|[
name|i
index|]
operator|.
name|ep_header
operator|->
name|eh_ecount
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|path
index|[
name|i
index|]
operator|.
name|ep_header
operator|->
name|eh_ecount
operator|==
literal|0
operator|&&
name|i
operator|>
literal|0
condition|)
block|{
comment|/* Index is empty, remove it. */
name|error
operator|=
name|ext4_ext_rm_index
argument_list|(
name|ip
argument_list|,
name|path
operator|+
name|i
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|path
index|[
name|i
index|]
operator|.
name|ep_data
argument_list|,
name|M_EXT2EXTENTS
argument_list|)
expr_stmt|;
name|path
index|[
name|i
index|]
operator|.
name|ep_data
operator|=
name|NULL
expr_stmt|;
name|i
operator|--
expr_stmt|;
block|}
block|}
if|if
condition|(
name|path
operator|->
name|ep_header
operator|->
name|eh_ecount
operator|==
literal|0
condition|)
block|{
comment|/* 		 * Truncate the tree to zero. 		 */
name|ext4_ext_header
argument_list|(
name|ip
argument_list|)
operator|->
name|eh_depth
operator|=
literal|0
expr_stmt|;
name|ext4_ext_header
argument_list|(
name|ip
argument_list|)
operator|->
name|eh_max
operator|=
name|ext4_ext_space_root
argument_list|(
name|ip
argument_list|)
expr_stmt|;
name|ext4_ext_dirty
argument_list|(
name|ip
argument_list|,
name|path
argument_list|)
expr_stmt|;
block|}
name|ext4_ext_drop_refs
argument_list|(
name|path
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|path
argument_list|,
name|M_EXT2EXTENTS
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2010 Zheng Liu<lz@freebsd.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/vnode.h>
end_include

begin_include
include|#
directive|include
file|<sys/bio.h>
end_include

begin_include
include|#
directive|include
file|<sys/buf.h>
end_include

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_include
include|#
directive|include
file|<fs/ext2fs/ext2_mount.h>
end_include

begin_include
include|#
directive|include
file|<fs/ext2fs/fs.h>
end_include

begin_include
include|#
directive|include
file|<fs/ext2fs/inode.h>
end_include

begin_include
include|#
directive|include
file|<fs/ext2fs/ext2fs.h>
end_include

begin_include
include|#
directive|include
file|<fs/ext2fs/ext2_extents.h>
end_include

begin_include
include|#
directive|include
file|<fs/ext2fs/ext2_extern.h>
end_include

begin_function
specifier|static
name|int
name|ext4_ext_binsearch_index
parameter_list|(
name|struct
name|inode
modifier|*
name|ip
parameter_list|,
name|struct
name|ext4_extent_path
modifier|*
name|path
parameter_list|,
name|daddr_t
name|lbn
parameter_list|,
name|daddr_t
modifier|*
name|first_lbn
parameter_list|,
name|daddr_t
modifier|*
name|last_lbn
parameter_list|)
block|{
name|struct
name|ext4_extent_header
modifier|*
name|ehp
init|=
name|path
operator|->
name|ep_header
decl_stmt|;
name|struct
name|ext4_extent_index
modifier|*
name|first
decl_stmt|,
modifier|*
name|last
decl_stmt|,
modifier|*
name|l
decl_stmt|,
modifier|*
name|r
decl_stmt|,
modifier|*
name|m
decl_stmt|;
name|first
operator|=
operator|(
expr|struct
name|ext4_extent_index
operator|*
operator|)
operator|(
name|char
operator|*
operator|)
operator|(
name|ehp
operator|+
literal|1
operator|)
expr_stmt|;
name|last
operator|=
name|first
operator|+
name|ehp
operator|->
name|eh_ecount
operator|-
literal|1
expr_stmt|;
name|l
operator|=
name|first
expr_stmt|;
name|r
operator|=
name|last
expr_stmt|;
while|while
condition|(
name|l
operator|<=
name|r
condition|)
block|{
name|m
operator|=
name|l
operator|+
operator|(
name|r
operator|-
name|l
operator|)
operator|/
literal|2
expr_stmt|;
if|if
condition|(
name|lbn
operator|<
name|m
operator|->
name|ei_blk
condition|)
name|r
operator|=
name|m
operator|-
literal|1
expr_stmt|;
else|else
name|l
operator|=
name|m
operator|+
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|l
operator|==
name|first
condition|)
block|{
name|path
operator|->
name|ep_sparse_ext
operator|.
name|e_blk
operator|=
operator|*
name|first_lbn
expr_stmt|;
name|path
operator|->
name|ep_sparse_ext
operator|.
name|e_len
operator|=
name|first
operator|->
name|ei_blk
operator|-
operator|*
name|first_lbn
expr_stmt|;
name|path
operator|->
name|ep_sparse_ext
operator|.
name|e_start_hi
operator|=
literal|0
expr_stmt|;
name|path
operator|->
name|ep_sparse_ext
operator|.
name|e_start_lo
operator|=
literal|0
expr_stmt|;
name|path
operator|->
name|ep_is_sparse
operator|=
literal|1
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|path
operator|->
name|ep_index
operator|=
name|l
operator|-
literal|1
expr_stmt|;
operator|*
name|first_lbn
operator|=
name|path
operator|->
name|ep_index
operator|->
name|ei_blk
expr_stmt|;
if|if
condition|(
name|path
operator|->
name|ep_index
operator|<
name|last
condition|)
operator|*
name|last_lbn
operator|=
name|l
operator|->
name|ei_blk
operator|-
literal|1
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ext4_ext_binsearch
parameter_list|(
name|struct
name|inode
modifier|*
name|ip
parameter_list|,
name|struct
name|ext4_extent_path
modifier|*
name|path
parameter_list|,
name|daddr_t
name|lbn
parameter_list|,
name|daddr_t
name|first_lbn
parameter_list|,
name|daddr_t
name|last_lbn
parameter_list|)
block|{
name|struct
name|ext4_extent_header
modifier|*
name|ehp
init|=
name|path
operator|->
name|ep_header
decl_stmt|;
name|struct
name|ext4_extent
modifier|*
name|first
decl_stmt|,
modifier|*
name|l
decl_stmt|,
modifier|*
name|r
decl_stmt|,
modifier|*
name|m
decl_stmt|;
if|if
condition|(
name|ehp
operator|->
name|eh_ecount
operator|==
literal|0
condition|)
return|return;
name|first
operator|=
operator|(
expr|struct
name|ext4_extent
operator|*
operator|)
operator|(
name|char
operator|*
operator|)
operator|(
name|ehp
operator|+
literal|1
operator|)
expr_stmt|;
name|l
operator|=
name|first
expr_stmt|;
name|r
operator|=
name|first
operator|+
name|ehp
operator|->
name|eh_ecount
operator|-
literal|1
expr_stmt|;
while|while
condition|(
name|l
operator|<=
name|r
condition|)
block|{
name|m
operator|=
name|l
operator|+
operator|(
name|r
operator|-
name|l
operator|)
operator|/
literal|2
expr_stmt|;
if|if
condition|(
name|lbn
operator|<
name|m
operator|->
name|e_blk
condition|)
name|r
operator|=
name|m
operator|-
literal|1
expr_stmt|;
else|else
name|l
operator|=
name|m
operator|+
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|l
operator|==
name|first
condition|)
block|{
name|path
operator|->
name|ep_sparse_ext
operator|.
name|e_blk
operator|=
name|first_lbn
expr_stmt|;
name|path
operator|->
name|ep_sparse_ext
operator|.
name|e_len
operator|=
name|first
operator|->
name|e_blk
operator|-
name|first_lbn
expr_stmt|;
name|path
operator|->
name|ep_sparse_ext
operator|.
name|e_start_hi
operator|=
literal|0
expr_stmt|;
name|path
operator|->
name|ep_sparse_ext
operator|.
name|e_start_lo
operator|=
literal|0
expr_stmt|;
name|path
operator|->
name|ep_is_sparse
operator|=
literal|1
expr_stmt|;
return|return;
block|}
name|path
operator|->
name|ep_ext
operator|=
name|l
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|path
operator|->
name|ep_ext
operator|->
name|e_blk
operator|+
name|path
operator|->
name|ep_ext
operator|->
name|e_len
operator|<=
name|lbn
condition|)
block|{
name|path
operator|->
name|ep_sparse_ext
operator|.
name|e_blk
operator|=
name|path
operator|->
name|ep_ext
operator|->
name|e_blk
operator|+
name|path
operator|->
name|ep_ext
operator|->
name|e_len
expr_stmt|;
if|if
condition|(
name|l
operator|<=
operator|(
name|first
operator|+
name|ehp
operator|->
name|eh_ecount
operator|-
literal|1
operator|)
condition|)
name|path
operator|->
name|ep_sparse_ext
operator|.
name|e_len
operator|=
name|l
operator|->
name|e_blk
operator|-
name|path
operator|->
name|ep_sparse_ext
operator|.
name|e_blk
expr_stmt|;
else|else
name|path
operator|->
name|ep_sparse_ext
operator|.
name|e_len
operator|=
name|last_lbn
operator|-
name|path
operator|->
name|ep_sparse_ext
operator|.
name|e_blk
operator|+
literal|1
expr_stmt|;
name|path
operator|->
name|ep_sparse_ext
operator|.
name|e_start_hi
operator|=
literal|0
expr_stmt|;
name|path
operator|->
name|ep_sparse_ext
operator|.
name|e_start_lo
operator|=
literal|0
expr_stmt|;
name|path
operator|->
name|ep_is_sparse
operator|=
literal|1
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Find a block in ext4 extent cache.  */
end_comment

begin_function
name|int
name|ext4_ext_in_cache
parameter_list|(
name|struct
name|inode
modifier|*
name|ip
parameter_list|,
name|daddr_t
name|lbn
parameter_list|,
name|struct
name|ext4_extent
modifier|*
name|ep
parameter_list|)
block|{
name|struct
name|ext4_extent_cache
modifier|*
name|ecp
decl_stmt|;
name|int
name|ret
init|=
name|EXT4_EXT_CACHE_NO
decl_stmt|;
name|ecp
operator|=
operator|&
name|ip
operator|->
name|i_ext_cache
expr_stmt|;
comment|/* cache is invalid */
if|if
condition|(
name|ecp
operator|->
name|ec_type
operator|==
name|EXT4_EXT_CACHE_NO
condition|)
return|return
operator|(
name|ret
operator|)
return|;
if|if
condition|(
name|lbn
operator|>=
name|ecp
operator|->
name|ec_blk
operator|&&
name|lbn
operator|<
name|ecp
operator|->
name|ec_blk
operator|+
name|ecp
operator|->
name|ec_len
condition|)
block|{
name|ep
operator|->
name|e_blk
operator|=
name|ecp
operator|->
name|ec_blk
expr_stmt|;
name|ep
operator|->
name|e_start_lo
operator|=
name|ecp
operator|->
name|ec_start
operator|&
literal|0xffffffff
expr_stmt|;
name|ep
operator|->
name|e_start_hi
operator|=
name|ecp
operator|->
name|ec_start
operator|>>
literal|32
operator|&
literal|0xffff
expr_stmt|;
name|ep
operator|->
name|e_len
operator|=
name|ecp
operator|->
name|ec_len
expr_stmt|;
name|ret
operator|=
name|ecp
operator|->
name|ec_type
expr_stmt|;
block|}
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Put an ext4_extent structure in ext4 cache.  */
end_comment

begin_function
name|void
name|ext4_ext_put_cache
parameter_list|(
name|struct
name|inode
modifier|*
name|ip
parameter_list|,
name|struct
name|ext4_extent
modifier|*
name|ep
parameter_list|,
name|int
name|type
parameter_list|)
block|{
name|struct
name|ext4_extent_cache
modifier|*
name|ecp
decl_stmt|;
name|ecp
operator|=
operator|&
name|ip
operator|->
name|i_ext_cache
expr_stmt|;
name|ecp
operator|->
name|ec_type
operator|=
name|type
expr_stmt|;
name|ecp
operator|->
name|ec_blk
operator|=
name|ep
operator|->
name|e_blk
expr_stmt|;
name|ecp
operator|->
name|ec_len
operator|=
name|ep
operator|->
name|e_len
expr_stmt|;
name|ecp
operator|->
name|ec_start
operator|=
operator|(
name|daddr_t
operator|)
name|ep
operator|->
name|e_start_hi
operator|<<
literal|32
operator||
name|ep
operator|->
name|e_start_lo
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Find an extent.  */
end_comment

begin_function
name|struct
name|ext4_extent_path
modifier|*
name|ext4_ext_find_extent
parameter_list|(
name|struct
name|m_ext2fs
modifier|*
name|fs
parameter_list|,
name|struct
name|inode
modifier|*
name|ip
parameter_list|,
name|daddr_t
name|lbn
parameter_list|,
name|struct
name|ext4_extent_path
modifier|*
name|path
parameter_list|)
block|{
name|struct
name|ext4_extent_header
modifier|*
name|ehp
decl_stmt|;
name|uint16_t
name|i
decl_stmt|;
name|int
name|error
decl_stmt|,
name|size
decl_stmt|;
name|daddr_t
name|nblk
decl_stmt|;
name|ehp
operator|=
operator|(
expr|struct
name|ext4_extent_header
operator|*
operator|)
operator|(
name|char
operator|*
operator|)
name|ip
operator|->
name|i_db
expr_stmt|;
if|if
condition|(
name|ehp
operator|->
name|eh_magic
operator|!=
name|EXT4_EXT_MAGIC
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|path
operator|->
name|ep_header
operator|=
name|ehp
expr_stmt|;
name|daddr_t
name|first_lbn
init|=
literal|0
decl_stmt|;
name|daddr_t
name|last_lbn
init|=
name|lblkno
argument_list|(
name|ip
operator|->
name|i_e2fs
argument_list|,
name|ip
operator|->
name|i_size
argument_list|)
decl_stmt|;
for|for
control|(
name|i
operator|=
name|ehp
operator|->
name|eh_depth
init|;
name|i
operator|!=
literal|0
condition|;
operator|--
name|i
control|)
block|{
name|path
operator|->
name|ep_depth
operator|=
name|i
expr_stmt|;
name|path
operator|->
name|ep_ext
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|ext4_ext_binsearch_index
argument_list|(
name|ip
argument_list|,
name|path
argument_list|,
name|lbn
argument_list|,
operator|&
name|first_lbn
argument_list|,
operator|&
name|last_lbn
argument_list|)
condition|)
block|{
return|return
operator|(
name|path
operator|)
return|;
block|}
name|nblk
operator|=
operator|(
name|daddr_t
operator|)
name|path
operator|->
name|ep_index
operator|->
name|ei_leaf_hi
operator|<<
literal|32
operator||
name|path
operator|->
name|ep_index
operator|->
name|ei_leaf_lo
expr_stmt|;
name|size
operator|=
name|blksize
argument_list|(
name|fs
argument_list|,
name|ip
argument_list|,
name|nblk
argument_list|)
expr_stmt|;
if|if
condition|(
name|path
operator|->
name|ep_bp
operator|!=
name|NULL
condition|)
block|{
name|brelse
argument_list|(
name|path
operator|->
name|ep_bp
argument_list|)
expr_stmt|;
name|path
operator|->
name|ep_bp
operator|=
name|NULL
expr_stmt|;
block|}
name|error
operator|=
name|bread
argument_list|(
name|ip
operator|->
name|i_devvp
argument_list|,
name|fsbtodb
argument_list|(
name|fs
argument_list|,
name|nblk
argument_list|)
argument_list|,
name|size
argument_list|,
name|NOCRED
argument_list|,
operator|&
name|path
operator|->
name|ep_bp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|brelse
argument_list|(
name|path
operator|->
name|ep_bp
argument_list|)
expr_stmt|;
name|path
operator|->
name|ep_bp
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|ehp
operator|=
operator|(
expr|struct
name|ext4_extent_header
operator|*
operator|)
name|path
operator|->
name|ep_bp
operator|->
name|b_data
expr_stmt|;
name|path
operator|->
name|ep_header
operator|=
name|ehp
expr_stmt|;
block|}
name|path
operator|->
name|ep_depth
operator|=
name|i
expr_stmt|;
name|path
operator|->
name|ep_ext
operator|=
name|NULL
expr_stmt|;
name|path
operator|->
name|ep_index
operator|=
name|NULL
expr_stmt|;
name|path
operator|->
name|ep_is_sparse
operator|=
literal|0
expr_stmt|;
name|ext4_ext_binsearch
argument_list|(
name|ip
argument_list|,
name|path
argument_list|,
name|lbn
argument_list|,
name|first_lbn
argument_list|,
name|last_lbn
argument_list|)
expr_stmt|;
return|return
operator|(
name|path
operator|)
return|;
block|}
end_function

end_unit


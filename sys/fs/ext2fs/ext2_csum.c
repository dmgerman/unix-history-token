begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2017, Fedor Uporov  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/vnode.h>
end_include

begin_include
include|#
directive|include
file|<sys/bio.h>
end_include

begin_include
include|#
directive|include
file|<sys/buf.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_include
include|#
directive|include
file|<sys/mount.h>
end_include

begin_include
include|#
directive|include
file|<fs/ext2fs/fs.h>
end_include

begin_include
include|#
directive|include
file|<fs/ext2fs/ext2fs.h>
end_include

begin_include
include|#
directive|include
file|<fs/ext2fs/inode.h>
end_include

begin_include
include|#
directive|include
file|<fs/ext2fs/ext2_extern.h>
end_include

begin_function
specifier|static
name|uint16_t
name|ext2_crc16
parameter_list|(
name|uint16_t
name|crc
parameter_list|,
specifier|const
name|void
modifier|*
name|buffer
parameter_list|,
name|unsigned
name|int
name|len
parameter_list|)
block|{
specifier|const
name|unsigned
name|char
modifier|*
name|cp
init|=
name|buffer
decl_stmt|;
comment|/* CRC table for the CRC-16. The poly is 0x8005 (x16 + x15 + x2 + 1). */
specifier|static
name|uint16_t
specifier|const
name|crc16_table
index|[
literal|256
index|]
init|=
block|{
literal|0x0000
block|,
literal|0xC0C1
block|,
literal|0xC181
block|,
literal|0x0140
block|,
literal|0xC301
block|,
literal|0x03C0
block|,
literal|0x0280
block|,
literal|0xC241
block|,
literal|0xC601
block|,
literal|0x06C0
block|,
literal|0x0780
block|,
literal|0xC741
block|,
literal|0x0500
block|,
literal|0xC5C1
block|,
literal|0xC481
block|,
literal|0x0440
block|,
literal|0xCC01
block|,
literal|0x0CC0
block|,
literal|0x0D80
block|,
literal|0xCD41
block|,
literal|0x0F00
block|,
literal|0xCFC1
block|,
literal|0xCE81
block|,
literal|0x0E40
block|,
literal|0x0A00
block|,
literal|0xCAC1
block|,
literal|0xCB81
block|,
literal|0x0B40
block|,
literal|0xC901
block|,
literal|0x09C0
block|,
literal|0x0880
block|,
literal|0xC841
block|,
literal|0xD801
block|,
literal|0x18C0
block|,
literal|0x1980
block|,
literal|0xD941
block|,
literal|0x1B00
block|,
literal|0xDBC1
block|,
literal|0xDA81
block|,
literal|0x1A40
block|,
literal|0x1E00
block|,
literal|0xDEC1
block|,
literal|0xDF81
block|,
literal|0x1F40
block|,
literal|0xDD01
block|,
literal|0x1DC0
block|,
literal|0x1C80
block|,
literal|0xDC41
block|,
literal|0x1400
block|,
literal|0xD4C1
block|,
literal|0xD581
block|,
literal|0x1540
block|,
literal|0xD701
block|,
literal|0x17C0
block|,
literal|0x1680
block|,
literal|0xD641
block|,
literal|0xD201
block|,
literal|0x12C0
block|,
literal|0x1380
block|,
literal|0xD341
block|,
literal|0x1100
block|,
literal|0xD1C1
block|,
literal|0xD081
block|,
literal|0x1040
block|,
literal|0xF001
block|,
literal|0x30C0
block|,
literal|0x3180
block|,
literal|0xF141
block|,
literal|0x3300
block|,
literal|0xF3C1
block|,
literal|0xF281
block|,
literal|0x3240
block|,
literal|0x3600
block|,
literal|0xF6C1
block|,
literal|0xF781
block|,
literal|0x3740
block|,
literal|0xF501
block|,
literal|0x35C0
block|,
literal|0x3480
block|,
literal|0xF441
block|,
literal|0x3C00
block|,
literal|0xFCC1
block|,
literal|0xFD81
block|,
literal|0x3D40
block|,
literal|0xFF01
block|,
literal|0x3FC0
block|,
literal|0x3E80
block|,
literal|0xFE41
block|,
literal|0xFA01
block|,
literal|0x3AC0
block|,
literal|0x3B80
block|,
literal|0xFB41
block|,
literal|0x3900
block|,
literal|0xF9C1
block|,
literal|0xF881
block|,
literal|0x3840
block|,
literal|0x2800
block|,
literal|0xE8C1
block|,
literal|0xE981
block|,
literal|0x2940
block|,
literal|0xEB01
block|,
literal|0x2BC0
block|,
literal|0x2A80
block|,
literal|0xEA41
block|,
literal|0xEE01
block|,
literal|0x2EC0
block|,
literal|0x2F80
block|,
literal|0xEF41
block|,
literal|0x2D00
block|,
literal|0xEDC1
block|,
literal|0xEC81
block|,
literal|0x2C40
block|,
literal|0xE401
block|,
literal|0x24C0
block|,
literal|0x2580
block|,
literal|0xE541
block|,
literal|0x2700
block|,
literal|0xE7C1
block|,
literal|0xE681
block|,
literal|0x2640
block|,
literal|0x2200
block|,
literal|0xE2C1
block|,
literal|0xE381
block|,
literal|0x2340
block|,
literal|0xE101
block|,
literal|0x21C0
block|,
literal|0x2080
block|,
literal|0xE041
block|,
literal|0xA001
block|,
literal|0x60C0
block|,
literal|0x6180
block|,
literal|0xA141
block|,
literal|0x6300
block|,
literal|0xA3C1
block|,
literal|0xA281
block|,
literal|0x6240
block|,
literal|0x6600
block|,
literal|0xA6C1
block|,
literal|0xA781
block|,
literal|0x6740
block|,
literal|0xA501
block|,
literal|0x65C0
block|,
literal|0x6480
block|,
literal|0xA441
block|,
literal|0x6C00
block|,
literal|0xACC1
block|,
literal|0xAD81
block|,
literal|0x6D40
block|,
literal|0xAF01
block|,
literal|0x6FC0
block|,
literal|0x6E80
block|,
literal|0xAE41
block|,
literal|0xAA01
block|,
literal|0x6AC0
block|,
literal|0x6B80
block|,
literal|0xAB41
block|,
literal|0x6900
block|,
literal|0xA9C1
block|,
literal|0xA881
block|,
literal|0x6840
block|,
literal|0x7800
block|,
literal|0xB8C1
block|,
literal|0xB981
block|,
literal|0x7940
block|,
literal|0xBB01
block|,
literal|0x7BC0
block|,
literal|0x7A80
block|,
literal|0xBA41
block|,
literal|0xBE01
block|,
literal|0x7EC0
block|,
literal|0x7F80
block|,
literal|0xBF41
block|,
literal|0x7D00
block|,
literal|0xBDC1
block|,
literal|0xBC81
block|,
literal|0x7C40
block|,
literal|0xB401
block|,
literal|0x74C0
block|,
literal|0x7580
block|,
literal|0xB541
block|,
literal|0x7700
block|,
literal|0xB7C1
block|,
literal|0xB681
block|,
literal|0x7640
block|,
literal|0x7200
block|,
literal|0xB2C1
block|,
literal|0xB381
block|,
literal|0x7340
block|,
literal|0xB101
block|,
literal|0x71C0
block|,
literal|0x7080
block|,
literal|0xB041
block|,
literal|0x5000
block|,
literal|0x90C1
block|,
literal|0x9181
block|,
literal|0x5140
block|,
literal|0x9301
block|,
literal|0x53C0
block|,
literal|0x5280
block|,
literal|0x9241
block|,
literal|0x9601
block|,
literal|0x56C0
block|,
literal|0x5780
block|,
literal|0x9741
block|,
literal|0x5500
block|,
literal|0x95C1
block|,
literal|0x9481
block|,
literal|0x5440
block|,
literal|0x9C01
block|,
literal|0x5CC0
block|,
literal|0x5D80
block|,
literal|0x9D41
block|,
literal|0x5F00
block|,
literal|0x9FC1
block|,
literal|0x9E81
block|,
literal|0x5E40
block|,
literal|0x5A00
block|,
literal|0x9AC1
block|,
literal|0x9B81
block|,
literal|0x5B40
block|,
literal|0x9901
block|,
literal|0x59C0
block|,
literal|0x5880
block|,
literal|0x9841
block|,
literal|0x8801
block|,
literal|0x48C0
block|,
literal|0x4980
block|,
literal|0x8941
block|,
literal|0x4B00
block|,
literal|0x8BC1
block|,
literal|0x8A81
block|,
literal|0x4A40
block|,
literal|0x4E00
block|,
literal|0x8EC1
block|,
literal|0x8F81
block|,
literal|0x4F40
block|,
literal|0x8D01
block|,
literal|0x4DC0
block|,
literal|0x4C80
block|,
literal|0x8C41
block|,
literal|0x4400
block|,
literal|0x84C1
block|,
literal|0x8581
block|,
literal|0x4540
block|,
literal|0x8701
block|,
literal|0x47C0
block|,
literal|0x4680
block|,
literal|0x8641
block|,
literal|0x8201
block|,
literal|0x42C0
block|,
literal|0x4380
block|,
literal|0x8341
block|,
literal|0x4100
block|,
literal|0x81C1
block|,
literal|0x8081
block|,
literal|0x4040
block|}
decl_stmt|;
while|while
condition|(
name|len
operator|--
condition|)
name|crc
operator|=
operator|(
operator|(
operator|(
name|crc
operator|>>
literal|8
operator|)
operator|&
literal|0xffU
operator|)
operator|^
name|crc16_table
index|[
operator|(
name|crc
operator|^
operator|*
name|cp
operator|++
operator|)
operator|&
literal|0xffU
index|]
operator|)
operator|&
literal|0x0000ffffU
expr_stmt|;
return|return
name|crc
return|;
block|}
end_function

begin_function
specifier|static
name|uint16_t
name|ext2_gd_csum
parameter_list|(
name|struct
name|m_ext2fs
modifier|*
name|fs
parameter_list|,
name|uint32_t
name|block_group
parameter_list|,
name|struct
name|ext2_gd
modifier|*
name|gd
parameter_list|)
block|{
name|size_t
name|offset
decl_stmt|;
name|uint16_t
name|crc
decl_stmt|;
name|offset
operator|=
name|offsetof
argument_list|(
expr|struct
name|ext2_gd
argument_list|,
name|ext4bgd_csum
argument_list|)
expr_stmt|;
if|if
condition|(
name|EXT2_HAS_RO_COMPAT_FEATURE
argument_list|(
name|fs
argument_list|,
name|EXT2F_ROCOMPAT_GDT_CSUM
argument_list|)
condition|)
block|{
name|crc
operator|=
name|ext2_crc16
argument_list|(
operator|~
literal|0
argument_list|,
name|fs
operator|->
name|e2fs
operator|->
name|e2fs_uuid
argument_list|,
sizeof|sizeof
argument_list|(
name|fs
operator|->
name|e2fs
operator|->
name|e2fs_uuid
argument_list|)
argument_list|)
expr_stmt|;
name|crc
operator|=
name|ext2_crc16
argument_list|(
name|crc
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|block_group
argument_list|,
sizeof|sizeof
argument_list|(
name|block_group
argument_list|)
argument_list|)
expr_stmt|;
name|crc
operator|=
name|ext2_crc16
argument_list|(
name|crc
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
name|gd
argument_list|,
name|offset
argument_list|)
expr_stmt|;
name|offset
operator|+=
sizeof|sizeof
argument_list|(
name|gd
operator|->
name|ext4bgd_csum
argument_list|)
expr_stmt|;
comment|/* skip checksum */
if|if
condition|(
name|EXT2_HAS_INCOMPAT_FEATURE
argument_list|(
name|fs
argument_list|,
name|EXT2F_INCOMPAT_64BIT
argument_list|)
operator|&&
name|offset
operator|<
name|fs
operator|->
name|e2fs
operator|->
name|e3fs_desc_size
condition|)
name|crc
operator|=
name|ext2_crc16
argument_list|(
name|crc
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
name|gd
operator|+
name|offset
argument_list|,
name|fs
operator|->
name|e2fs
operator|->
name|e3fs_desc_size
operator|-
name|offset
argument_list|)
expr_stmt|;
return|return
operator|(
name|crc
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ext2_gd_csum_verify
parameter_list|(
name|struct
name|m_ext2fs
modifier|*
name|fs
parameter_list|,
name|struct
name|cdev
modifier|*
name|dev
parameter_list|)
block|{
name|unsigned
name|int
name|i
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|fs
operator|->
name|e2fs_gcount
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|fs
operator|->
name|e2fs_gd
index|[
name|i
index|]
operator|.
name|ext4bgd_csum
operator|!=
name|ext2_gd_csum
argument_list|(
name|fs
argument_list|,
name|i
argument_list|,
operator|&
name|fs
operator|->
name|e2fs_gd
index|[
name|i
index|]
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"WARNING: mount of %s denied due bad gd=%d csum=0x%x, expected=0x%x - run fsck\n"
argument_list|,
name|devtoname
argument_list|(
name|dev
argument_list|)
argument_list|,
name|i
argument_list|,
name|fs
operator|->
name|e2fs_gd
index|[
name|i
index|]
operator|.
name|ext4bgd_csum
argument_list|,
name|ext2_gd_csum
argument_list|(
name|fs
argument_list|,
name|i
argument_list|,
operator|&
name|fs
operator|->
name|e2fs_gd
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
name|void
name|ext2_gd_csum_set
parameter_list|(
name|struct
name|m_ext2fs
modifier|*
name|fs
parameter_list|)
block|{
name|unsigned
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|fs
operator|->
name|e2fs_gcount
condition|;
name|i
operator|++
control|)
name|fs
operator|->
name|e2fs_gd
index|[
name|i
index|]
operator|.
name|ext4bgd_csum
operator|=
name|ext2_gd_csum
argument_list|(
name|fs
argument_list|,
name|i
argument_list|,
operator|&
name|fs
operator|->
name|e2fs_gd
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 1989, 1993  *	The Regents of the University of California.  All rights reserved.  *  * This code is derived from software contributed to Berkeley by  * Rick Macklem at The University of Guelph.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 4. Neither the name of the University nor the names of its contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*  * nfs version 2, 3 and 4 server calls to vnode ops  * - these routines generally have 3 phases  *   1 - break down and validate rpc request in mbuf list  *   2 - do the vnode ops for the request, usually by calling a nfsvno_XXX()  *       function in nfsd_port.c  *   3 - build the rpc reply in an mbuf list  * For nfsv4, these functions are called for each Op within the Compound RPC.  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|APPLEKEXT
end_ifndef

begin_include
include|#
directive|include
file|<fs/nfs/nfsport.h>
end_include

begin_comment
comment|/* Global vars */
end_comment

begin_decl_stmt
specifier|extern
name|u_int32_t
name|newnfs_false
decl_stmt|,
name|newnfs_true
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|enum
name|vtype
name|nv34tov_type
index|[
literal|8
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|struct
name|timeval
name|nfsboottime
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|nfs_rootfhset
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|nfsrv_enable_crossmntpt
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* !APPLEKEXT */
end_comment

begin_comment
comment|/*  * This list defines the GSS mechanisms supported.  * (Don't ask me how you get these strings from the RFC stuff like  *  iso(1), org(3)... but someone did it, so I don't need to know.)  */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|nfsgss_mechlist
name|nfsgss_mechlist
index|[]
init|=
block|{
block|{
literal|9
block|,
literal|"\052\206\110\206\367\022\001\002\002"
block|,
literal|11
block|}
block|,
block|{
literal|0
block|,
literal|""
block|,
literal|0
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* local functions */
end_comment

begin_function_decl
specifier|static
name|void
name|nfsrvd_symlinksub
parameter_list|(
name|struct
name|nfsrv_descript
modifier|*
name|nd
parameter_list|,
name|struct
name|nameidata
modifier|*
name|ndp
parameter_list|,
name|struct
name|nfsvattr
modifier|*
name|nvap
parameter_list|,
name|fhandle_t
modifier|*
name|fhp
parameter_list|,
name|vnode_t
modifier|*
name|vpp
parameter_list|,
name|vnode_t
name|dirp
parameter_list|,
name|struct
name|nfsvattr
modifier|*
name|dirforp
parameter_list|,
name|struct
name|nfsvattr
modifier|*
name|diraftp
parameter_list|,
name|int
modifier|*
name|diraft_retp
parameter_list|,
name|nfsattrbit_t
modifier|*
name|attrbitp
parameter_list|,
name|NFSACL_T
modifier|*
name|aclp
parameter_list|,
name|NFSPROC_T
modifier|*
name|p
parameter_list|,
name|struct
name|nfsexstuff
modifier|*
name|exp
parameter_list|,
name|char
modifier|*
name|pathcp
parameter_list|,
name|int
name|pathlen
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|nfsrvd_mkdirsub
parameter_list|(
name|struct
name|nfsrv_descript
modifier|*
name|nd
parameter_list|,
name|struct
name|nameidata
modifier|*
name|ndp
parameter_list|,
name|struct
name|nfsvattr
modifier|*
name|nvap
parameter_list|,
name|fhandle_t
modifier|*
name|fhp
parameter_list|,
name|vnode_t
modifier|*
name|vpp
parameter_list|,
name|vnode_t
name|dirp
parameter_list|,
name|struct
name|nfsvattr
modifier|*
name|dirforp
parameter_list|,
name|struct
name|nfsvattr
modifier|*
name|diraftp
parameter_list|,
name|int
modifier|*
name|diraft_retp
parameter_list|,
name|nfsattrbit_t
modifier|*
name|attrbitp
parameter_list|,
name|NFSACL_T
modifier|*
name|aclp
parameter_list|,
name|NFSPROC_T
modifier|*
name|p
parameter_list|,
name|struct
name|nfsexstuff
modifier|*
name|exp
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * nfs access service (not a part of NFS V2)  */
end_comment

begin_function
name|APPLESTATIC
name|int
name|nfsrvd_access
parameter_list|(
name|struct
name|nfsrv_descript
modifier|*
name|nd
parameter_list|,
name|__unused
name|int
name|isdgram
parameter_list|,
name|vnode_t
name|vp
parameter_list|,
name|NFSPROC_T
modifier|*
name|p
parameter_list|,
name|struct
name|nfsexstuff
modifier|*
name|exp
parameter_list|)
block|{
name|u_int32_t
modifier|*
name|tl
decl_stmt|;
name|int
name|getret
decl_stmt|,
name|error
init|=
literal|0
decl_stmt|;
name|struct
name|nfsvattr
name|nva
decl_stmt|;
name|u_int32_t
name|testmode
decl_stmt|,
name|nfsmode
decl_stmt|,
name|supported
init|=
literal|0
decl_stmt|;
name|accmode_t
name|deletebit
decl_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|nfsrv_postopattr
argument_list|(
name|nd
argument_list|,
literal|1
argument_list|,
operator|&
name|nva
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|NFSM_DISSECT
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|nfsmode
operator|=
name|fxdr_unsigned
argument_list|(
name|u_int32_t
argument_list|,
operator|*
name|tl
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV4
operator|)
operator|&&
operator|(
name|nfsmode
operator|&
operator|~
operator|(
name|NFSACCESS_READ
operator||
name|NFSACCESS_LOOKUP
operator||
name|NFSACCESS_MODIFY
operator||
name|NFSACCESS_EXTEND
operator||
name|NFSACCESS_DELETE
operator||
name|NFSACCESS_EXECUTE
operator|)
operator|)
condition|)
block|{
name|nd
operator|->
name|nd_repstat
operator|=
name|NFSERR_INVAL
expr_stmt|;
name|vput
argument_list|(
name|vp
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|nfsmode
operator|&
name|NFSACCESS_READ
condition|)
block|{
name|supported
operator||=
name|NFSACCESS_READ
expr_stmt|;
if|if
condition|(
name|nfsvno_accchk
argument_list|(
name|vp
argument_list|,
name|VREAD
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|exp
argument_list|,
name|p
argument_list|,
name|NFSACCCHK_NOOVERRIDE
argument_list|,
name|NFSACCCHK_VPISLOCKED
argument_list|,
operator|&
name|supported
argument_list|)
condition|)
name|nfsmode
operator|&=
operator|~
name|NFSACCESS_READ
expr_stmt|;
block|}
if|if
condition|(
name|nfsmode
operator|&
name|NFSACCESS_MODIFY
condition|)
block|{
name|supported
operator||=
name|NFSACCESS_MODIFY
expr_stmt|;
if|if
condition|(
name|nfsvno_accchk
argument_list|(
name|vp
argument_list|,
name|VWRITE
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|exp
argument_list|,
name|p
argument_list|,
name|NFSACCCHK_NOOVERRIDE
argument_list|,
name|NFSACCCHK_VPISLOCKED
argument_list|,
operator|&
name|supported
argument_list|)
condition|)
name|nfsmode
operator|&=
operator|~
name|NFSACCESS_MODIFY
expr_stmt|;
block|}
if|if
condition|(
name|nfsmode
operator|&
name|NFSACCESS_EXTEND
condition|)
block|{
name|supported
operator||=
name|NFSACCESS_EXTEND
expr_stmt|;
if|if
condition|(
name|nfsvno_accchk
argument_list|(
name|vp
argument_list|,
name|VWRITE
operator||
name|VAPPEND
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|exp
argument_list|,
name|p
argument_list|,
name|NFSACCCHK_NOOVERRIDE
argument_list|,
name|NFSACCCHK_VPISLOCKED
argument_list|,
operator|&
name|supported
argument_list|)
condition|)
name|nfsmode
operator|&=
operator|~
name|NFSACCESS_EXTEND
expr_stmt|;
block|}
if|if
condition|(
name|nfsmode
operator|&
name|NFSACCESS_DELETE
condition|)
block|{
name|supported
operator||=
name|NFSACCESS_DELETE
expr_stmt|;
if|if
condition|(
name|vp
operator|->
name|v_type
operator|==
name|VDIR
condition|)
name|deletebit
operator|=
name|VDELETE_CHILD
expr_stmt|;
else|else
name|deletebit
operator|=
name|VDELETE
expr_stmt|;
if|if
condition|(
name|nfsvno_accchk
argument_list|(
name|vp
argument_list|,
name|deletebit
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|exp
argument_list|,
name|p
argument_list|,
name|NFSACCCHK_NOOVERRIDE
argument_list|,
name|NFSACCCHK_VPISLOCKED
argument_list|,
operator|&
name|supported
argument_list|)
condition|)
name|nfsmode
operator|&=
operator|~
name|NFSACCESS_DELETE
expr_stmt|;
block|}
if|if
condition|(
name|vnode_vtype
argument_list|(
name|vp
argument_list|)
operator|==
name|VDIR
condition|)
name|testmode
operator|=
name|NFSACCESS_LOOKUP
expr_stmt|;
else|else
name|testmode
operator|=
name|NFSACCESS_EXECUTE
expr_stmt|;
if|if
condition|(
name|nfsmode
operator|&
name|testmode
condition|)
block|{
name|supported
operator||=
operator|(
name|nfsmode
operator|&
name|testmode
operator|)
expr_stmt|;
if|if
condition|(
name|nfsvno_accchk
argument_list|(
name|vp
argument_list|,
name|VEXEC
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|exp
argument_list|,
name|p
argument_list|,
name|NFSACCCHK_NOOVERRIDE
argument_list|,
name|NFSACCCHK_VPISLOCKED
argument_list|,
operator|&
name|supported
argument_list|)
condition|)
name|nfsmode
operator|&=
operator|~
name|testmode
expr_stmt|;
block|}
name|nfsmode
operator|&=
name|supported
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV3
condition|)
block|{
name|getret
operator|=
name|nfsvno_getattr
argument_list|(
name|vp
argument_list|,
operator|&
name|nva
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|nfsrv_postopattr
argument_list|(
name|nd
argument_list|,
name|getret
argument_list|,
operator|&
name|nva
argument_list|)
expr_stmt|;
block|}
name|vput
argument_list|(
name|vp
argument_list|)
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV4
condition|)
block|{
name|NFSM_BUILD
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
literal|2
operator|*
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
name|txdr_unsigned
argument_list|(
name|supported
argument_list|)
expr_stmt|;
block|}
else|else
name|NFSM_BUILD
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|=
name|txdr_unsigned
argument_list|(
name|nfsmode
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|nfsmout
label|:
name|vput
argument_list|(
name|vp
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * nfs getattr service  */
end_comment

begin_function
name|APPLESTATIC
name|int
name|nfsrvd_getattr
parameter_list|(
name|struct
name|nfsrv_descript
modifier|*
name|nd
parameter_list|,
name|int
name|isdgram
parameter_list|,
name|vnode_t
name|vp
parameter_list|,
name|NFSPROC_T
modifier|*
name|p
parameter_list|,
name|__unused
name|struct
name|nfsexstuff
modifier|*
name|exp
parameter_list|)
block|{
name|struct
name|nfsvattr
name|nva
decl_stmt|;
name|fhandle_t
name|fh
decl_stmt|;
name|int
name|at_root
init|=
literal|0
decl_stmt|,
name|error
init|=
literal|0
decl_stmt|,
name|supports_nfsv4acls
decl_stmt|;
name|struct
name|nfsreferral
modifier|*
name|refp
decl_stmt|;
name|nfsattrbit_t
name|attrbits
decl_stmt|,
name|tmpbits
decl_stmt|;
name|struct
name|mount
modifier|*
name|mp
decl_stmt|;
name|struct
name|vnode
modifier|*
name|tvp
init|=
name|NULL
decl_stmt|;
name|struct
name|vattr
name|va
decl_stmt|;
name|uint64_t
name|mounted_on_fileno
init|=
literal|0
decl_stmt|;
name|accmode_t
name|accmode
decl_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_repstat
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV4
condition|)
block|{
name|error
operator|=
name|nfsrv_getattrbits
argument_list|(
name|nd
argument_list|,
operator|&
name|attrbits
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|vput
argument_list|(
name|vp
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
comment|/* 		 * Check for a referral. 		 */
name|refp
operator|=
name|nfsv4root_getreferral
argument_list|(
name|vp
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|refp
operator|!=
name|NULL
condition|)
block|{
operator|(
name|void
operator|)
name|nfsrv_putreferralattr
argument_list|(
name|nd
argument_list|,
operator|&
name|attrbits
argument_list|,
name|refp
argument_list|,
literal|1
argument_list|,
operator|&
name|nd
operator|->
name|nd_repstat
argument_list|)
expr_stmt|;
name|vput
argument_list|(
name|vp
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|nd
operator|->
name|nd_repstat
operator|==
literal|0
condition|)
block|{
name|accmode
operator|=
literal|0
expr_stmt|;
name|NFSSET_ATTRBIT
argument_list|(
operator|&
name|tmpbits
argument_list|,
operator|&
name|attrbits
argument_list|)
expr_stmt|;
if|if
condition|(
name|NFSISSET_ATTRBIT
argument_list|(
operator|&
name|tmpbits
argument_list|,
name|NFSATTRBIT_ACL
argument_list|)
condition|)
block|{
name|NFSCLRBIT_ATTRBIT
argument_list|(
operator|&
name|tmpbits
argument_list|,
name|NFSATTRBIT_ACL
argument_list|)
expr_stmt|;
name|accmode
operator||=
name|VREAD_ACL
expr_stmt|;
block|}
if|if
condition|(
name|NFSNONZERO_ATTRBIT
argument_list|(
operator|&
name|tmpbits
argument_list|)
condition|)
name|accmode
operator||=
name|VREAD_ATTRIBUTES
expr_stmt|;
if|if
condition|(
name|accmode
operator|!=
literal|0
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_accchk
argument_list|(
name|vp
argument_list|,
name|accmode
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|exp
argument_list|,
name|p
argument_list|,
name|NFSACCCHK_NOOVERRIDE
argument_list|,
name|NFSACCCHK_VPISLOCKED
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_getattr
argument_list|(
name|vp
argument_list|,
operator|&
name|nva
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
block|{
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV4
condition|)
block|{
if|if
condition|(
name|NFSISSET_ATTRBIT
argument_list|(
operator|&
name|attrbits
argument_list|,
name|NFSATTRBIT_FILEHANDLE
argument_list|)
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_getfh
argument_list|(
name|vp
argument_list|,
operator|&
name|fh
argument_list|,
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsrv_checkgetattr
argument_list|(
name|nd
argument_list|,
name|vp
argument_list|,
operator|&
name|nva
argument_list|,
operator|&
name|attrbits
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_repstat
operator|==
literal|0
condition|)
block|{
name|supports_nfsv4acls
operator|=
name|nfs_supportsnfsv4acls
argument_list|(
name|vp
argument_list|)
expr_stmt|;
name|mp
operator|=
name|vp
operator|->
name|v_mount
expr_stmt|;
if|if
condition|(
name|nfsrv_enable_crossmntpt
operator|!=
literal|0
operator|&&
name|vp
operator|->
name|v_type
operator|==
name|VDIR
operator|&&
operator|(
name|vp
operator|->
name|v_vflag
operator|&
name|VV_ROOT
operator|)
operator|!=
literal|0
operator|&&
name|vp
operator|!=
name|rootvnode
condition|)
block|{
name|tvp
operator|=
name|mp
operator|->
name|mnt_vnodecovered
expr_stmt|;
name|VREF
argument_list|(
name|tvp
argument_list|)
expr_stmt|;
name|at_root
operator|=
literal|1
expr_stmt|;
block|}
else|else
name|at_root
operator|=
literal|0
expr_stmt|;
name|vfs_ref
argument_list|(
name|mp
argument_list|)
expr_stmt|;
name|VOP_UNLOCK
argument_list|(
name|vp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|at_root
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|nd
operator|->
name|nd_repstat
operator|=
name|vn_lock
argument_list|(
name|tvp
argument_list|,
name|LK_SHARED
argument_list|)
operator|)
operator|==
literal|0
condition|)
block|{
name|nd
operator|->
name|nd_repstat
operator|=
name|VOP_GETATTR
argument_list|(
name|tvp
argument_list|,
operator|&
name|va
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|)
expr_stmt|;
name|vput
argument_list|(
name|tvp
argument_list|)
expr_stmt|;
block|}
else|else
name|vrele
argument_list|(
name|tvp
argument_list|)
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_repstat
operator|==
literal|0
condition|)
name|mounted_on_fileno
operator|=
operator|(
name|uint64_t
operator|)
name|va
operator|.
name|va_fileid
expr_stmt|;
else|else
name|at_root
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|nd
operator|->
name|nd_repstat
operator|==
literal|0
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|vfs_busy
argument_list|(
name|mp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|vfs_rel
argument_list|(
name|mp
argument_list|)
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_repstat
operator|==
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|nfsvno_fillattr
argument_list|(
name|nd
argument_list|,
name|mp
argument_list|,
name|vp
argument_list|,
operator|&
name|nva
argument_list|,
operator|&
name|fh
argument_list|,
literal|0
argument_list|,
operator|&
name|attrbits
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
name|isdgram
argument_list|,
literal|1
argument_list|,
name|supports_nfsv4acls
argument_list|,
name|at_root
argument_list|,
name|mounted_on_fileno
argument_list|)
expr_stmt|;
name|vfs_unbusy
argument_list|(
name|mp
argument_list|)
expr_stmt|;
block|}
name|vrele
argument_list|(
name|vp
argument_list|)
expr_stmt|;
block|}
else|else
name|vput
argument_list|(
name|vp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|nfsrv_fillattr
argument_list|(
name|nd
argument_list|,
operator|&
name|nva
argument_list|)
expr_stmt|;
name|vput
argument_list|(
name|vp
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|vput
argument_list|(
name|vp
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * nfs setattr service  */
end_comment

begin_function
name|APPLESTATIC
name|int
name|nfsrvd_setattr
parameter_list|(
name|struct
name|nfsrv_descript
modifier|*
name|nd
parameter_list|,
name|__unused
name|int
name|isdgram
parameter_list|,
name|vnode_t
name|vp
parameter_list|,
name|NFSPROC_T
modifier|*
name|p
parameter_list|,
name|struct
name|nfsexstuff
modifier|*
name|exp
parameter_list|)
block|{
name|struct
name|nfsvattr
name|nva
decl_stmt|,
name|nva2
decl_stmt|;
name|u_int32_t
modifier|*
name|tl
decl_stmt|;
name|int
name|preat_ret
init|=
literal|1
decl_stmt|,
name|postat_ret
init|=
literal|1
decl_stmt|,
name|gcheck
init|=
literal|0
decl_stmt|,
name|error
init|=
literal|0
decl_stmt|;
name|struct
name|timespec
name|guard
init|=
block|{
literal|0
block|,
literal|0
block|}
decl_stmt|;
name|nfsattrbit_t
name|attrbits
decl_stmt|,
name|retbits
decl_stmt|;
name|nfsv4stateid_t
name|stateid
decl_stmt|;
name|NFSACL_T
modifier|*
name|aclp
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|nfsrv_wcc
argument_list|(
name|nd
argument_list|,
name|preat_ret
argument_list|,
operator|&
name|nva2
argument_list|,
name|postat_ret
argument_list|,
operator|&
name|nva
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
ifdef|#
directive|ifdef
name|NFS4_ACL_EXTATTR_NAME
name|aclp
operator|=
name|acl_alloc
argument_list|(
name|M_WAITOK
argument_list|)
expr_stmt|;
name|aclp
operator|->
name|acl_cnt
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
name|NFSVNO_ATTRINIT
argument_list|(
operator|&
name|nva
argument_list|)
expr_stmt|;
name|NFSZERO_ATTRBIT
argument_list|(
operator|&
name|retbits
argument_list|)
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV4
condition|)
block|{
name|NFSM_DISSECT
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
name|NFSX_STATEID
argument_list|)
expr_stmt|;
name|stateid
operator|.
name|seqid
operator|=
name|fxdr_unsigned
argument_list|(
name|u_int32_t
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
expr_stmt|;
name|NFSBCOPY
argument_list|(
operator|(
name|caddr_t
operator|)
name|tl
argument_list|,
operator|(
name|caddr_t
operator|)
name|stateid
operator|.
name|other
argument_list|,
name|NFSX_STATEIDOTHER
argument_list|)
expr_stmt|;
block|}
name|error
operator|=
name|nfsrv_sattr
argument_list|(
name|nd
argument_list|,
operator|&
name|nva
argument_list|,
operator|&
name|attrbits
argument_list|,
name|aclp
argument_list|,
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|nfsmout
goto|;
name|preat_ret
operator|=
name|nfsvno_getattr
argument_list|(
name|vp
argument_list|,
operator|&
name|nva2
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|preat_ret
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV3
condition|)
block|{
name|NFSM_DISSECT
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|gcheck
operator|=
name|fxdr_unsigned
argument_list|(
name|int
argument_list|,
operator|*
name|tl
argument_list|)
expr_stmt|;
if|if
condition|(
name|gcheck
condition|)
block|{
name|NFSM_DISSECT
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
literal|2
operator|*
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|fxdr_nfsv3time
argument_list|(
name|tl
argument_list|,
operator|&
name|guard
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
operator|&&
name|gcheck
operator|&&
operator|(
name|nva2
operator|.
name|na_ctime
operator|.
name|tv_sec
operator|!=
name|guard
operator|.
name|tv_sec
operator|||
name|nva2
operator|.
name|na_ctime
operator|.
name|tv_nsec
operator|!=
name|guard
operator|.
name|tv_nsec
operator|)
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|NFSERR_NOT_SYNC
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|vput
argument_list|(
name|vp
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|NFS4_ACL_EXTATTR_NAME
name|acl_free
argument_list|(
name|aclp
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|nfsrv_wcc
argument_list|(
name|nd
argument_list|,
name|preat_ret
argument_list|,
operator|&
name|nva2
argument_list|,
name|postat_ret
argument_list|,
operator|&
name|nva
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
elseif|else
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
operator|&&
operator|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV4
operator|)
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsrv_checkuidgid
argument_list|(
name|nd
argument_list|,
operator|&
name|nva
argument_list|)
expr_stmt|;
comment|/* 	 * Now that we have all the fields, lets do it. 	 * If the size is being changed write access is required, otherwise 	 * just check for a read only file system. 	 */
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
block|{
if|if
condition|(
name|NFSVNO_NOTSETSIZE
argument_list|(
operator|&
name|nva
argument_list|)
condition|)
block|{
if|if
condition|(
name|NFSVNO_EXRDONLY
argument_list|(
name|exp
argument_list|)
operator|||
operator|(
name|vfs_flags
argument_list|(
name|vnode_mount
argument_list|(
name|vp
argument_list|)
argument_list|)
operator|&
name|MNT_RDONLY
operator|)
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|EROFS
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|vnode_vtype
argument_list|(
name|vp
argument_list|)
operator|!=
name|VREG
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|EINVAL
expr_stmt|;
elseif|else
if|if
condition|(
name|nva2
operator|.
name|na_uid
operator|!=
name|nd
operator|->
name|nd_cred
operator|->
name|cr_uid
operator|||
name|NFSVNO_EXSTRICTACCESS
argument_list|(
name|exp
argument_list|)
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_accchk
argument_list|(
name|vp
argument_list|,
name|VWRITE
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|exp
argument_list|,
name|p
argument_list|,
name|NFSACCCHK_NOOVERRIDE
argument_list|,
name|NFSACCCHK_VPISLOCKED
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
operator|&&
operator|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV4
operator|)
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsrv_checksetattr
argument_list|(
name|vp
argument_list|,
name|nd
argument_list|,
operator|&
name|stateid
argument_list|,
operator|&
name|nva
argument_list|,
operator|&
name|attrbits
argument_list|,
name|exp
argument_list|,
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
operator|&&
operator|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV4
operator|)
condition|)
block|{
comment|/* 	     * For V4, try setting the attrbutes in sets, so that the 	     * reply bitmap will be correct for an error case. 	     */
if|if
condition|(
name|NFSISSET_ATTRBIT
argument_list|(
operator|&
name|attrbits
argument_list|,
name|NFSATTRBIT_OWNER
argument_list|)
operator|||
name|NFSISSET_ATTRBIT
argument_list|(
operator|&
name|attrbits
argument_list|,
name|NFSATTRBIT_OWNERGROUP
argument_list|)
condition|)
block|{
name|NFSVNO_ATTRINIT
argument_list|(
operator|&
name|nva2
argument_list|)
expr_stmt|;
name|NFSVNO_SETATTRVAL
argument_list|(
operator|&
name|nva2
argument_list|,
name|uid
argument_list|,
name|nva
operator|.
name|na_uid
argument_list|)
expr_stmt|;
name|NFSVNO_SETATTRVAL
argument_list|(
operator|&
name|nva2
argument_list|,
name|gid
argument_list|,
name|nva
operator|.
name|na_gid
argument_list|)
expr_stmt|;
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_setattr
argument_list|(
name|vp
argument_list|,
operator|&
name|nva2
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
name|exp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
block|{
if|if
condition|(
name|NFSISSET_ATTRBIT
argument_list|(
operator|&
name|attrbits
argument_list|,
name|NFSATTRBIT_OWNER
argument_list|)
condition|)
name|NFSSETBIT_ATTRBIT
argument_list|(
operator|&
name|retbits
argument_list|,
name|NFSATTRBIT_OWNER
argument_list|)
expr_stmt|;
if|if
condition|(
name|NFSISSET_ATTRBIT
argument_list|(
operator|&
name|attrbits
argument_list|,
name|NFSATTRBIT_OWNERGROUP
argument_list|)
condition|)
name|NFSSETBIT_ATTRBIT
argument_list|(
operator|&
name|retbits
argument_list|,
name|NFSATTRBIT_OWNERGROUP
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
operator|&&
name|NFSISSET_ATTRBIT
argument_list|(
operator|&
name|attrbits
argument_list|,
name|NFSATTRBIT_SIZE
argument_list|)
condition|)
block|{
name|NFSVNO_ATTRINIT
argument_list|(
operator|&
name|nva2
argument_list|)
expr_stmt|;
name|NFSVNO_SETATTRVAL
argument_list|(
operator|&
name|nva2
argument_list|,
name|size
argument_list|,
name|nva
operator|.
name|na_size
argument_list|)
expr_stmt|;
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_setattr
argument_list|(
name|vp
argument_list|,
operator|&
name|nva2
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
name|exp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
name|NFSSETBIT_ATTRBIT
argument_list|(
operator|&
name|retbits
argument_list|,
name|NFSATTRBIT_SIZE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
operator|&&
operator|(
name|NFSISSET_ATTRBIT
argument_list|(
operator|&
name|attrbits
argument_list|,
name|NFSATTRBIT_TIMEACCESSSET
argument_list|)
operator|||
name|NFSISSET_ATTRBIT
argument_list|(
operator|&
name|attrbits
argument_list|,
name|NFSATTRBIT_TIMEMODIFYSET
argument_list|)
operator|)
condition|)
block|{
name|NFSVNO_ATTRINIT
argument_list|(
operator|&
name|nva2
argument_list|)
expr_stmt|;
name|NFSVNO_SETATTRVAL
argument_list|(
operator|&
name|nva2
argument_list|,
name|atime
argument_list|,
name|nva
operator|.
name|na_atime
argument_list|)
expr_stmt|;
name|NFSVNO_SETATTRVAL
argument_list|(
operator|&
name|nva2
argument_list|,
name|mtime
argument_list|,
name|nva
operator|.
name|na_mtime
argument_list|)
expr_stmt|;
if|if
condition|(
name|nva
operator|.
name|na_vaflags
operator|&
name|VA_UTIMES_NULL
condition|)
block|{
name|nva2
operator|.
name|na_vaflags
operator||=
name|VA_UTIMES_NULL
expr_stmt|;
name|NFSVNO_SETACTIVE
argument_list|(
operator|&
name|nva2
argument_list|,
name|vaflags
argument_list|)
expr_stmt|;
block|}
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_setattr
argument_list|(
name|vp
argument_list|,
operator|&
name|nva2
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
name|exp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
block|{
if|if
condition|(
name|NFSISSET_ATTRBIT
argument_list|(
operator|&
name|attrbits
argument_list|,
name|NFSATTRBIT_TIMEACCESSSET
argument_list|)
condition|)
name|NFSSETBIT_ATTRBIT
argument_list|(
operator|&
name|retbits
argument_list|,
name|NFSATTRBIT_TIMEACCESSSET
argument_list|)
expr_stmt|;
if|if
condition|(
name|NFSISSET_ATTRBIT
argument_list|(
operator|&
name|attrbits
argument_list|,
name|NFSATTRBIT_TIMEMODIFYSET
argument_list|)
condition|)
name|NFSSETBIT_ATTRBIT
argument_list|(
operator|&
name|retbits
argument_list|,
name|NFSATTRBIT_TIMEMODIFYSET
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
operator|&&
name|NFSISSET_ATTRBIT
argument_list|(
operator|&
name|attrbits
argument_list|,
name|NFSATTRBIT_MODE
argument_list|)
condition|)
block|{
name|NFSVNO_ATTRINIT
argument_list|(
operator|&
name|nva2
argument_list|)
expr_stmt|;
name|NFSVNO_SETATTRVAL
argument_list|(
operator|&
name|nva2
argument_list|,
name|mode
argument_list|,
name|nva
operator|.
name|na_mode
argument_list|)
expr_stmt|;
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_setattr
argument_list|(
name|vp
argument_list|,
operator|&
name|nva2
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
name|exp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
name|NFSSETBIT_ATTRBIT
argument_list|(
operator|&
name|retbits
argument_list|,
name|NFSATTRBIT_MODE
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|NFS4_ACL_EXTATTR_NAME
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
operator|&&
name|aclp
operator|->
name|acl_cnt
operator|>
literal|0
operator|&&
name|NFSISSET_ATTRBIT
argument_list|(
operator|&
name|attrbits
argument_list|,
name|NFSATTRBIT_ACL
argument_list|)
condition|)
block|{
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsrv_setacl
argument_list|(
name|vp
argument_list|,
name|aclp
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
name|NFSSETBIT_ATTRBIT
argument_list|(
operator|&
name|retbits
argument_list|,
name|NFSATTRBIT_ACL
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
block|}
elseif|else
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_setattr
argument_list|(
name|vp
argument_list|,
operator|&
name|nva
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
name|exp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
operator|(
name|ND_NFSV2
operator||
name|ND_NFSV3
operator|)
condition|)
block|{
name|postat_ret
operator|=
name|nfsvno_getattr
argument_list|(
name|vp
argument_list|,
operator|&
name|nva
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|postat_ret
expr_stmt|;
block|}
name|vput
argument_list|(
name|vp
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|NFS4_ACL_EXTATTR_NAME
name|acl_free
argument_list|(
name|aclp
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV3
condition|)
name|nfsrv_wcc
argument_list|(
name|nd
argument_list|,
name|preat_ret
argument_list|,
operator|&
name|nva2
argument_list|,
name|postat_ret
argument_list|,
operator|&
name|nva
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV4
condition|)
operator|(
name|void
operator|)
name|nfsrv_putattrbit
argument_list|(
name|nd
argument_list|,
operator|&
name|retbits
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
name|nfsrv_fillattr
argument_list|(
name|nd
argument_list|,
operator|&
name|nva
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|nfsmout
label|:
name|vput
argument_list|(
name|vp
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|NFS4_ACL_EXTATTR_NAME
name|acl_free
argument_list|(
name|aclp
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV4
condition|)
block|{
comment|/* 		 * For all nd_repstat, the V4 reply includes a bitmap, 		 * even NFSERR_BADXDR, which is what this will end up 		 * returning. 		 */
operator|(
name|void
operator|)
name|nfsrv_putattrbit
argument_list|(
name|nd
argument_list|,
operator|&
name|retbits
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * nfs lookup rpc  * (Also performs lookup parent for v4)  */
end_comment

begin_function
name|APPLESTATIC
name|int
name|nfsrvd_lookup
parameter_list|(
name|struct
name|nfsrv_descript
modifier|*
name|nd
parameter_list|,
name|__unused
name|int
name|isdgram
parameter_list|,
name|vnode_t
name|dp
parameter_list|,
name|vnode_t
modifier|*
name|vpp
parameter_list|,
name|fhandle_t
modifier|*
name|fhp
parameter_list|,
name|NFSPROC_T
modifier|*
name|p
parameter_list|,
name|struct
name|nfsexstuff
modifier|*
name|exp
parameter_list|)
block|{
name|struct
name|nameidata
name|named
decl_stmt|;
name|vnode_t
name|vp
decl_stmt|,
name|dirp
init|=
name|NULL
decl_stmt|;
name|int
name|error
decl_stmt|,
name|dattr_ret
init|=
literal|1
decl_stmt|;
name|struct
name|nfsvattr
name|nva
decl_stmt|,
name|dattr
decl_stmt|;
name|char
modifier|*
name|bufp
decl_stmt|;
name|u_long
modifier|*
name|hashp
decl_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|nfsrv_postopattr
argument_list|(
name|nd
argument_list|,
name|dattr_ret
argument_list|,
operator|&
name|dattr
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
comment|/* 	 * For some reason, if dp is a symlink, the error 	 * returned is supposed to be NFSERR_SYMLINK and not NFSERR_NOTDIR. 	 */
if|if
condition|(
name|dp
operator|->
name|v_type
operator|==
name|VLNK
operator|&&
operator|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV4
operator|)
condition|)
block|{
name|nd
operator|->
name|nd_repstat
operator|=
name|NFSERR_SYMLINK
expr_stmt|;
name|vrele
argument_list|(
name|dp
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|NFSNAMEICNDSET
argument_list|(
operator|&
name|named
operator|.
name|ni_cnd
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|LOOKUP
argument_list|,
name|LOCKLEAF
operator||
name|SAVESTART
argument_list|)
expr_stmt|;
name|nfsvno_setpathbuf
argument_list|(
operator|&
name|named
argument_list|,
operator|&
name|bufp
argument_list|,
operator|&
name|hashp
argument_list|)
expr_stmt|;
name|error
operator|=
name|nfsrv_parsename
argument_list|(
name|nd
argument_list|,
name|bufp
argument_list|,
name|hashp
argument_list|,
operator|&
name|named
operator|.
name|ni_pathlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|vrele
argument_list|(
name|dp
argument_list|)
expr_stmt|;
name|nfsvno_relpathbuf
argument_list|(
operator|&
name|named
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_namei
argument_list|(
name|nd
argument_list|,
operator|&
name|named
argument_list|,
name|dp
argument_list|,
literal|0
argument_list|,
name|exp
argument_list|,
name|p
argument_list|,
operator|&
name|dirp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|vrele
argument_list|(
name|dp
argument_list|)
expr_stmt|;
name|nfsvno_relpathbuf
argument_list|(
operator|&
name|named
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|nd
operator|->
name|nd_repstat
condition|)
block|{
if|if
condition|(
name|dirp
condition|)
block|{
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV3
condition|)
name|dattr_ret
operator|=
name|nfsvno_getattr
argument_list|(
name|dirp
argument_list|,
operator|&
name|dattr
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|vrele
argument_list|(
name|dirp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV3
condition|)
name|nfsrv_postopattr
argument_list|(
name|nd
argument_list|,
name|dattr_ret
argument_list|,
operator|&
name|dattr
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|named
operator|.
name|ni_startdir
condition|)
name|vrele
argument_list|(
name|named
operator|.
name|ni_startdir
argument_list|)
expr_stmt|;
name|nfsvno_relpathbuf
argument_list|(
operator|&
name|named
argument_list|)
expr_stmt|;
name|vp
operator|=
name|named
operator|.
name|ni_vp
expr_stmt|;
if|if
condition|(
operator|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV4
operator|)
operator|!=
literal|0
operator|&&
operator|!
name|NFSVNO_EXPORTED
argument_list|(
name|exp
argument_list|)
operator|&&
name|vp
operator|->
name|v_type
operator|!=
name|VDIR
operator|&&
name|vp
operator|->
name|v_type
operator|!=
name|VLNK
condition|)
comment|/* 		 * Only allow lookup of VDIR and VLNK for traversal of 		 * non-exported volumes during NFSv4 mounting. 		 */
name|nd
operator|->
name|nd_repstat
operator|=
name|ENOENT
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_repstat
operator|==
literal|0
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_getfh
argument_list|(
name|vp
argument_list|,
name|fhp
argument_list|,
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV4
operator|)
operator|&&
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_getattr
argument_list|(
name|vp
argument_list|,
operator|&
name|nva
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|vpp
operator|!=
name|NULL
operator|&&
name|nd
operator|->
name|nd_repstat
operator|==
literal|0
condition|)
operator|*
name|vpp
operator|=
name|vp
expr_stmt|;
else|else
name|vput
argument_list|(
name|vp
argument_list|)
expr_stmt|;
if|if
condition|(
name|dirp
condition|)
block|{
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV3
condition|)
name|dattr_ret
operator|=
name|nfsvno_getattr
argument_list|(
name|dirp
argument_list|,
operator|&
name|dattr
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|vrele
argument_list|(
name|dirp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|nd
operator|->
name|nd_repstat
condition|)
block|{
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV3
condition|)
name|nfsrv_postopattr
argument_list|(
name|nd
argument_list|,
name|dattr_ret
argument_list|,
operator|&
name|dattr
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV2
condition|)
block|{
operator|(
name|void
operator|)
name|nfsm_fhtom
argument_list|(
name|nd
argument_list|,
operator|(
name|u_int8_t
operator|*
operator|)
name|fhp
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|nfsrv_fillattr
argument_list|(
name|nd
argument_list|,
operator|&
name|nva
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV3
condition|)
block|{
operator|(
name|void
operator|)
name|nfsm_fhtom
argument_list|(
name|nd
argument_list|,
operator|(
name|u_int8_t
operator|*
operator|)
name|fhp
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|nfsrv_postopattr
argument_list|(
name|nd
argument_list|,
literal|0
argument_list|,
operator|&
name|nva
argument_list|)
expr_stmt|;
name|nfsrv_postopattr
argument_list|(
name|nd
argument_list|,
name|dattr_ret
argument_list|,
operator|&
name|dattr
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * nfs readlink service  */
end_comment

begin_function
name|APPLESTATIC
name|int
name|nfsrvd_readlink
parameter_list|(
name|struct
name|nfsrv_descript
modifier|*
name|nd
parameter_list|,
name|__unused
name|int
name|isdgram
parameter_list|,
name|vnode_t
name|vp
parameter_list|,
name|NFSPROC_T
modifier|*
name|p
parameter_list|,
name|__unused
name|struct
name|nfsexstuff
modifier|*
name|exp
parameter_list|)
block|{
name|u_int32_t
modifier|*
name|tl
decl_stmt|;
name|mbuf_t
name|mp
init|=
name|NULL
decl_stmt|,
name|mpend
init|=
name|NULL
decl_stmt|;
name|int
name|getret
init|=
literal|1
decl_stmt|,
name|len
decl_stmt|;
name|struct
name|nfsvattr
name|nva
decl_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|nfsrv_postopattr
argument_list|(
name|nd
argument_list|,
name|getret
argument_list|,
operator|&
name|nva
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|vnode_vtype
argument_list|(
name|vp
argument_list|)
operator|!=
name|VLNK
condition|)
block|{
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV2
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|ENXIO
expr_stmt|;
else|else
name|nd
operator|->
name|nd_repstat
operator|=
name|EINVAL
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_readlink
argument_list|(
name|vp
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
operator|&
name|mp
argument_list|,
operator|&
name|mpend
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV3
condition|)
name|getret
operator|=
name|nfsvno_getattr
argument_list|(
name|vp
argument_list|,
operator|&
name|nva
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|vput
argument_list|(
name|vp
argument_list|)
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV3
condition|)
name|nfsrv_postopattr
argument_list|(
name|nd
argument_list|,
name|getret
argument_list|,
operator|&
name|nva
argument_list|)
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_repstat
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|NFSM_BUILD
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|=
name|txdr_unsigned
argument_list|(
name|len
argument_list|)
expr_stmt|;
name|mbuf_setnext
argument_list|(
name|nd
operator|->
name|nd_mb
argument_list|,
name|mp
argument_list|)
expr_stmt|;
name|nd
operator|->
name|nd_mb
operator|=
name|mpend
expr_stmt|;
name|nd
operator|->
name|nd_bpos
operator|=
name|NFSMTOD
argument_list|(
name|mpend
argument_list|,
name|caddr_t
argument_list|)
operator|+
name|mbuf_len
argument_list|(
name|mpend
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * nfs read service  */
end_comment

begin_function
name|APPLESTATIC
name|int
name|nfsrvd_read
parameter_list|(
name|struct
name|nfsrv_descript
modifier|*
name|nd
parameter_list|,
name|__unused
name|int
name|isdgram
parameter_list|,
name|vnode_t
name|vp
parameter_list|,
name|NFSPROC_T
modifier|*
name|p
parameter_list|,
name|struct
name|nfsexstuff
modifier|*
name|exp
parameter_list|)
block|{
name|u_int32_t
modifier|*
name|tl
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|,
name|cnt
decl_stmt|,
name|len
decl_stmt|,
name|getret
init|=
literal|1
decl_stmt|,
name|reqlen
decl_stmt|,
name|eof
init|=
literal|0
decl_stmt|;
name|mbuf_t
name|m2
decl_stmt|,
name|m3
decl_stmt|;
name|struct
name|nfsvattr
name|nva
decl_stmt|;
name|off_t
name|off
init|=
literal|0x0
decl_stmt|;
name|struct
name|nfsstate
name|st
decl_stmt|,
modifier|*
name|stp
init|=
operator|&
name|st
decl_stmt|;
name|struct
name|nfslock
name|lo
decl_stmt|,
modifier|*
name|lop
init|=
operator|&
name|lo
decl_stmt|;
name|nfsv4stateid_t
name|stateid
decl_stmt|;
name|nfsquad_t
name|clientid
decl_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|nfsrv_postopattr
argument_list|(
name|nd
argument_list|,
name|getret
argument_list|,
operator|&
name|nva
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV2
condition|)
block|{
name|NFSM_DISSECT
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
literal|2
operator|*
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|off
operator|=
operator|(
name|off_t
operator|)
name|fxdr_unsigned
argument_list|(
name|u_int32_t
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
expr_stmt|;
name|reqlen
operator|=
name|fxdr_unsigned
argument_list|(
name|int
argument_list|,
operator|*
name|tl
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV3
condition|)
block|{
name|NFSM_DISSECT
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
literal|3
operator|*
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|off
operator|=
name|fxdr_hyper
argument_list|(
name|tl
argument_list|)
expr_stmt|;
name|tl
operator|+=
literal|2
expr_stmt|;
name|reqlen
operator|=
name|fxdr_unsigned
argument_list|(
name|int
argument_list|,
operator|*
name|tl
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|NFSM_DISSECT
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
name|NFSX_STATEID
operator|+
literal|3
operator|*
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|reqlen
operator|=
name|fxdr_unsigned
argument_list|(
name|int
argument_list|,
operator|*
operator|(
name|tl
operator|+
literal|6
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|reqlen
operator|>
name|NFS_SRVMAXDATA
argument_list|(
name|nd
argument_list|)
condition|)
block|{
name|reqlen
operator|=
name|NFS_SRVMAXDATA
argument_list|(
name|nd
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|reqlen
operator|<
literal|0
condition|)
block|{
name|error
operator|=
name|EBADRPC
expr_stmt|;
goto|goto
name|nfsmout
goto|;
block|}
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV4
condition|)
block|{
name|stp
operator|->
name|ls_flags
operator|=
operator|(
name|NFSLCK_CHECK
operator||
name|NFSLCK_READACCESS
operator|)
expr_stmt|;
name|lop
operator|->
name|lo_flags
operator|=
name|NFSLCK_READ
expr_stmt|;
name|stp
operator|->
name|ls_ownerlen
operator|=
literal|0
expr_stmt|;
name|stp
operator|->
name|ls_op
operator|=
name|NULL
expr_stmt|;
name|stp
operator|->
name|ls_uid
operator|=
name|nd
operator|->
name|nd_cred
operator|->
name|cr_uid
expr_stmt|;
name|stp
operator|->
name|ls_stateid
operator|.
name|seqid
operator|=
name|fxdr_unsigned
argument_list|(
name|u_int32_t
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
expr_stmt|;
name|clientid
operator|.
name|lval
index|[
literal|0
index|]
operator|=
name|stp
operator|->
name|ls_stateid
operator|.
name|other
index|[
literal|0
index|]
operator|=
operator|*
name|tl
operator|++
expr_stmt|;
name|clientid
operator|.
name|lval
index|[
literal|1
index|]
operator|=
name|stp
operator|->
name|ls_stateid
operator|.
name|other
index|[
literal|1
index|]
operator|=
operator|*
name|tl
operator|++
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_IMPLIEDCLID
condition|)
block|{
if|if
condition|(
name|nd
operator|->
name|nd_clientid
operator|.
name|qval
operator|!=
name|clientid
operator|.
name|qval
condition|)
name|printf
argument_list|(
literal|"EEK! multiple clids\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|nd
operator|->
name|nd_flag
operator||=
name|ND_IMPLIEDCLID
expr_stmt|;
name|nd
operator|->
name|nd_clientid
operator|.
name|qval
operator|=
name|clientid
operator|.
name|qval
expr_stmt|;
block|}
name|stp
operator|->
name|ls_stateid
operator|.
name|other
index|[
literal|2
index|]
operator|=
operator|*
name|tl
operator|++
expr_stmt|;
name|off
operator|=
name|fxdr_hyper
argument_list|(
name|tl
argument_list|)
expr_stmt|;
name|lop
operator|->
name|lo_first
operator|=
name|off
expr_stmt|;
name|tl
operator|+=
literal|2
expr_stmt|;
name|lop
operator|->
name|lo_end
operator|=
name|off
operator|+
name|reqlen
expr_stmt|;
comment|/* 		 * Paranoia, just in case it wraps around. 		 */
if|if
condition|(
name|lop
operator|->
name|lo_end
operator|<
name|off
condition|)
name|lop
operator|->
name|lo_end
operator|=
name|NFS64BITSSET
expr_stmt|;
block|}
if|if
condition|(
name|vnode_vtype
argument_list|(
name|vp
argument_list|)
operator|!=
name|VREG
condition|)
block|{
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV3
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|EINVAL
expr_stmt|;
else|else
name|nd
operator|->
name|nd_repstat
operator|=
operator|(
name|vnode_vtype
argument_list|(
name|vp
argument_list|)
operator|==
name|VDIR
operator|)
condition|?
name|EISDIR
else|:
name|EINVAL
expr_stmt|;
block|}
name|getret
operator|=
name|nfsvno_getattr
argument_list|(
name|vp
argument_list|,
operator|&
name|nva
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|getret
expr_stmt|;
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
operator|&&
operator|(
name|nva
operator|.
name|na_uid
operator|!=
name|nd
operator|->
name|nd_cred
operator|->
name|cr_uid
operator|||
name|NFSVNO_EXSTRICTACCESS
argument_list|(
name|exp
argument_list|)
operator|)
condition|)
block|{
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_accchk
argument_list|(
name|vp
argument_list|,
name|VREAD
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|exp
argument_list|,
name|p
argument_list|,
name|NFSACCCHK_ALLOWOWNER
argument_list|,
name|NFSACCCHK_VPISLOCKED
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_repstat
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_accchk
argument_list|(
name|vp
argument_list|,
name|VEXEC
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|exp
argument_list|,
name|p
argument_list|,
name|NFSACCCHK_ALLOWOWNER
argument_list|,
name|NFSACCCHK_VPISLOCKED
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV4
operator|)
operator|&&
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsrv_lockctrl
argument_list|(
name|vp
argument_list|,
operator|&
name|stp
argument_list|,
operator|&
name|lop
argument_list|,
name|NULL
argument_list|,
name|clientid
argument_list|,
operator|&
name|stateid
argument_list|,
name|exp
argument_list|,
name|nd
argument_list|,
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|vput
argument_list|(
name|vp
argument_list|)
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV3
condition|)
name|nfsrv_postopattr
argument_list|(
name|nd
argument_list|,
name|getret
argument_list|,
operator|&
name|nva
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|off
operator|>=
name|nva
operator|.
name|na_size
condition|)
block|{
name|cnt
operator|=
literal|0
expr_stmt|;
name|eof
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|reqlen
operator|==
literal|0
condition|)
name|cnt
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|off
operator|+
name|reqlen
operator|)
operator|>
name|nva
operator|.
name|na_size
condition|)
name|cnt
operator|=
name|nva
operator|.
name|na_size
operator|-
name|off
expr_stmt|;
else|else
name|cnt
operator|=
name|reqlen
expr_stmt|;
name|len
operator|=
name|NFSM_RNDUP
argument_list|(
name|cnt
argument_list|)
expr_stmt|;
name|m3
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|cnt
operator|>
literal|0
condition|)
block|{
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_read
argument_list|(
name|vp
argument_list|,
name|off
argument_list|,
name|cnt
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
operator|&
name|m3
argument_list|,
operator|&
name|m2
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV4
operator|)
condition|)
block|{
name|getret
operator|=
name|nfsvno_getattr
argument_list|(
name|vp
argument_list|,
operator|&
name|nva
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|getret
expr_stmt|;
block|}
if|if
condition|(
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|vput
argument_list|(
name|vp
argument_list|)
expr_stmt|;
if|if
condition|(
name|m3
condition|)
name|mbuf_freem
argument_list|(
name|m3
argument_list|)
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV3
condition|)
name|nfsrv_postopattr
argument_list|(
name|nd
argument_list|,
name|getret
argument_list|,
operator|&
name|nva
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
name|vput
argument_list|(
name|vp
argument_list|)
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV2
condition|)
block|{
name|nfsrv_fillattr
argument_list|(
name|nd
argument_list|,
operator|&
name|nva
argument_list|)
expr_stmt|;
name|NFSM_BUILD
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV3
condition|)
block|{
name|nfsrv_postopattr
argument_list|(
name|nd
argument_list|,
name|getret
argument_list|,
operator|&
name|nva
argument_list|)
expr_stmt|;
name|NFSM_BUILD
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
literal|3
operator|*
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
name|txdr_unsigned
argument_list|(
name|cnt
argument_list|)
expr_stmt|;
block|}
else|else
name|NFSM_BUILD
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
literal|2
operator|*
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
name|reqlen
operator|||
name|eof
condition|)
operator|*
name|tl
operator|++
operator|=
name|newnfs_true
expr_stmt|;
else|else
operator|*
name|tl
operator|++
operator|=
name|newnfs_false
expr_stmt|;
block|}
operator|*
name|tl
operator|=
name|txdr_unsigned
argument_list|(
name|cnt
argument_list|)
expr_stmt|;
if|if
condition|(
name|m3
condition|)
block|{
name|mbuf_setnext
argument_list|(
name|nd
operator|->
name|nd_mb
argument_list|,
name|m3
argument_list|)
expr_stmt|;
name|nd
operator|->
name|nd_mb
operator|=
name|m2
expr_stmt|;
name|nd
operator|->
name|nd_bpos
operator|=
name|NFSMTOD
argument_list|(
name|m2
argument_list|,
name|caddr_t
argument_list|)
operator|+
name|mbuf_len
argument_list|(
name|m2
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|nfsmout
label|:
name|vput
argument_list|(
name|vp
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * nfs write service  */
end_comment

begin_function
name|APPLESTATIC
name|int
name|nfsrvd_write
parameter_list|(
name|struct
name|nfsrv_descript
modifier|*
name|nd
parameter_list|,
name|__unused
name|int
name|isdgram
parameter_list|,
name|vnode_t
name|vp
parameter_list|,
name|NFSPROC_T
modifier|*
name|p
parameter_list|,
name|struct
name|nfsexstuff
modifier|*
name|exp
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|cnt
decl_stmt|;
name|u_int32_t
modifier|*
name|tl
decl_stmt|;
name|mbuf_t
name|mp
decl_stmt|;
name|struct
name|nfsvattr
name|nva
decl_stmt|,
name|forat
decl_stmt|;
name|int
name|aftat_ret
init|=
literal|1
decl_stmt|,
name|retlen
decl_stmt|,
name|len
decl_stmt|,
name|error
init|=
literal|0
decl_stmt|,
name|forat_ret
init|=
literal|1
decl_stmt|;
name|int
name|stable
init|=
name|NFSWRITE_FILESYNC
decl_stmt|;
name|off_t
name|off
decl_stmt|;
name|struct
name|nfsstate
name|st
decl_stmt|,
modifier|*
name|stp
init|=
operator|&
name|st
decl_stmt|;
name|struct
name|nfslock
name|lo
decl_stmt|,
modifier|*
name|lop
init|=
operator|&
name|lo
decl_stmt|;
name|nfsv4stateid_t
name|stateid
decl_stmt|;
name|nfsquad_t
name|clientid
decl_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|nfsrv_wcc
argument_list|(
name|nd
argument_list|,
name|forat_ret
argument_list|,
operator|&
name|forat
argument_list|,
name|aftat_ret
argument_list|,
operator|&
name|nva
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV2
condition|)
block|{
name|NFSM_DISSECT
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
literal|4
operator|*
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|off
operator|=
operator|(
name|off_t
operator|)
name|fxdr_unsigned
argument_list|(
name|u_int32_t
argument_list|,
operator|*
operator|++
name|tl
argument_list|)
expr_stmt|;
name|tl
operator|+=
literal|2
expr_stmt|;
name|retlen
operator|=
name|len
operator|=
name|fxdr_unsigned
argument_list|(
name|int32_t
argument_list|,
operator|*
name|tl
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV3
condition|)
block|{
name|NFSM_DISSECT
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
literal|5
operator|*
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|off
operator|=
name|fxdr_hyper
argument_list|(
name|tl
argument_list|)
expr_stmt|;
name|tl
operator|+=
literal|3
expr_stmt|;
name|stable
operator|=
name|fxdr_unsigned
argument_list|(
name|int
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
expr_stmt|;
name|retlen
operator|=
name|len
operator|=
name|fxdr_unsigned
argument_list|(
name|int32_t
argument_list|,
operator|*
name|tl
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|NFSM_DISSECT
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
name|NFSX_STATEID
operator|+
literal|4
operator|*
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|stp
operator|->
name|ls_flags
operator|=
operator|(
name|NFSLCK_CHECK
operator||
name|NFSLCK_WRITEACCESS
operator|)
expr_stmt|;
name|lop
operator|->
name|lo_flags
operator|=
name|NFSLCK_WRITE
expr_stmt|;
name|stp
operator|->
name|ls_ownerlen
operator|=
literal|0
expr_stmt|;
name|stp
operator|->
name|ls_op
operator|=
name|NULL
expr_stmt|;
name|stp
operator|->
name|ls_uid
operator|=
name|nd
operator|->
name|nd_cred
operator|->
name|cr_uid
expr_stmt|;
name|stp
operator|->
name|ls_stateid
operator|.
name|seqid
operator|=
name|fxdr_unsigned
argument_list|(
name|u_int32_t
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
expr_stmt|;
name|clientid
operator|.
name|lval
index|[
literal|0
index|]
operator|=
name|stp
operator|->
name|ls_stateid
operator|.
name|other
index|[
literal|0
index|]
operator|=
operator|*
name|tl
operator|++
expr_stmt|;
name|clientid
operator|.
name|lval
index|[
literal|1
index|]
operator|=
name|stp
operator|->
name|ls_stateid
operator|.
name|other
index|[
literal|1
index|]
operator|=
operator|*
name|tl
operator|++
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_IMPLIEDCLID
condition|)
block|{
if|if
condition|(
name|nd
operator|->
name|nd_clientid
operator|.
name|qval
operator|!=
name|clientid
operator|.
name|qval
condition|)
name|printf
argument_list|(
literal|"EEK! multiple clids\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|nd
operator|->
name|nd_flag
operator||=
name|ND_IMPLIEDCLID
expr_stmt|;
name|nd
operator|->
name|nd_clientid
operator|.
name|qval
operator|=
name|clientid
operator|.
name|qval
expr_stmt|;
block|}
name|stp
operator|->
name|ls_stateid
operator|.
name|other
index|[
literal|2
index|]
operator|=
operator|*
name|tl
operator|++
expr_stmt|;
name|off
operator|=
name|fxdr_hyper
argument_list|(
name|tl
argument_list|)
expr_stmt|;
name|lop
operator|->
name|lo_first
operator|=
name|off
expr_stmt|;
name|tl
operator|+=
literal|2
expr_stmt|;
name|stable
operator|=
name|fxdr_unsigned
argument_list|(
name|int
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
expr_stmt|;
name|retlen
operator|=
name|len
operator|=
name|fxdr_unsigned
argument_list|(
name|int32_t
argument_list|,
operator|*
name|tl
argument_list|)
expr_stmt|;
name|lop
operator|->
name|lo_end
operator|=
name|off
operator|+
name|len
expr_stmt|;
comment|/* 		 * Paranoia, just in case it wraps around, which shouldn't 		 * ever happen anyhow. 		 */
if|if
condition|(
name|lop
operator|->
name|lo_end
operator|<
name|lop
operator|->
name|lo_first
condition|)
name|lop
operator|->
name|lo_end
operator|=
name|NFS64BITSSET
expr_stmt|;
block|}
comment|/* 	 * Loop through the mbuf chain, counting how many mbufs are a 	 * part of this write operation, so the iovec size is known. 	 */
name|cnt
operator|=
literal|0
expr_stmt|;
name|mp
operator|=
name|nd
operator|->
name|nd_md
expr_stmt|;
name|i
operator|=
name|NFSMTOD
argument_list|(
name|mp
argument_list|,
name|caddr_t
argument_list|)
operator|+
name|mbuf_len
argument_list|(
name|mp
argument_list|)
operator|-
name|nd
operator|->
name|nd_dpos
expr_stmt|;
while|while
condition|(
name|len
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|i
operator|>
literal|0
condition|)
block|{
name|len
operator|-=
name|i
expr_stmt|;
name|cnt
operator|++
expr_stmt|;
block|}
name|mp
operator|=
name|mbuf_next
argument_list|(
name|mp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mp
condition|)
block|{
if|if
condition|(
name|len
operator|>
literal|0
condition|)
block|{
name|error
operator|=
name|EBADRPC
expr_stmt|;
goto|goto
name|nfsmout
goto|;
block|}
block|}
else|else
name|i
operator|=
name|mbuf_len
argument_list|(
name|mp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|retlen
operator|>
name|NFS_MAXDATA
operator|||
name|retlen
operator|<
literal|0
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|EIO
expr_stmt|;
if|if
condition|(
name|vnode_vtype
argument_list|(
name|vp
argument_list|)
operator|!=
name|VREG
operator|&&
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
block|{
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV3
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|EINVAL
expr_stmt|;
else|else
name|nd
operator|->
name|nd_repstat
operator|=
operator|(
name|vnode_vtype
argument_list|(
name|vp
argument_list|)
operator|==
name|VDIR
operator|)
condition|?
name|EISDIR
else|:
name|EINVAL
expr_stmt|;
block|}
name|forat_ret
operator|=
name|nfsvno_getattr
argument_list|(
name|vp
argument_list|,
operator|&
name|forat
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|forat_ret
expr_stmt|;
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
operator|&&
operator|(
name|forat
operator|.
name|na_uid
operator|!=
name|nd
operator|->
name|nd_cred
operator|->
name|cr_uid
operator|||
name|NFSVNO_EXSTRICTACCESS
argument_list|(
name|exp
argument_list|)
operator|)
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_accchk
argument_list|(
name|vp
argument_list|,
name|VWRITE
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|exp
argument_list|,
name|p
argument_list|,
name|NFSACCCHK_ALLOWOWNER
argument_list|,
name|NFSACCCHK_VPISLOCKED
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV4
operator|)
operator|&&
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsrv_lockctrl
argument_list|(
name|vp
argument_list|,
operator|&
name|stp
argument_list|,
operator|&
name|lop
argument_list|,
name|NULL
argument_list|,
name|clientid
argument_list|,
operator|&
name|stateid
argument_list|,
name|exp
argument_list|,
name|nd
argument_list|,
name|p
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|vput
argument_list|(
name|vp
argument_list|)
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV3
condition|)
name|nfsrv_wcc
argument_list|(
name|nd
argument_list|,
name|forat_ret
argument_list|,
operator|&
name|forat
argument_list|,
name|aftat_ret
argument_list|,
operator|&
name|nva
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
comment|/* 	 * For NFS Version 2, it is not obvious what a write of zero length 	 * should do, but I might as well be consistent with Version 3, 	 * which is to return ok so long as there are no permission problems. 	 */
if|if
condition|(
name|retlen
operator|>
literal|0
condition|)
block|{
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_write
argument_list|(
name|vp
argument_list|,
name|off
argument_list|,
name|retlen
argument_list|,
name|cnt
argument_list|,
name|stable
argument_list|,
name|nd
operator|->
name|nd_md
argument_list|,
name|nd
operator|->
name|nd_dpos
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|error
operator|=
name|nfsm_advance
argument_list|(
name|nd
argument_list|,
name|NFSM_RNDUP
argument_list|(
name|retlen
argument_list|)
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
name|panic
argument_list|(
literal|"nfsrv_write mbuf"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV4
condition|)
name|aftat_ret
operator|=
literal|0
expr_stmt|;
else|else
name|aftat_ret
operator|=
name|nfsvno_getattr
argument_list|(
name|vp
argument_list|,
operator|&
name|nva
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|vput
argument_list|(
name|vp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|aftat_ret
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
operator|(
name|ND_NFSV3
operator||
name|ND_NFSV4
operator|)
condition|)
block|{
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV3
condition|)
name|nfsrv_wcc
argument_list|(
name|nd
argument_list|,
name|forat_ret
argument_list|,
operator|&
name|forat
argument_list|,
name|aftat_ret
argument_list|,
operator|&
name|nva
argument_list|)
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_repstat
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|NFSM_BUILD
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
literal|4
operator|*
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
name|txdr_unsigned
argument_list|(
name|retlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|stable
operator|==
name|NFSWRITE_UNSTABLE
condition|)
operator|*
name|tl
operator|++
operator|=
name|txdr_unsigned
argument_list|(
name|stable
argument_list|)
expr_stmt|;
else|else
operator|*
name|tl
operator|++
operator|=
name|txdr_unsigned
argument_list|(
name|NFSWRITE_FILESYNC
argument_list|)
expr_stmt|;
comment|/* 		 * Actually, there is no need to txdr these fields, 		 * but it may make the values more human readable, 		 * for debugging purposes. 		 */
operator|*
name|tl
operator|++
operator|=
name|txdr_unsigned
argument_list|(
name|nfsboottime
operator|.
name|tv_sec
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|=
name|txdr_unsigned
argument_list|(
name|nfsboottime
operator|.
name|tv_usec
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
name|nfsrv_fillattr
argument_list|(
name|nd
argument_list|,
operator|&
name|nva
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|nfsmout
label|:
name|vput
argument_list|(
name|vp
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * nfs create service (creates regular files for V2 and V3. Spec. files for V2.)  * now does a truncate to 0 length via. setattr if it already exists  * The core creation routine has been extracted out into nfsrv_creatsub(),  * so it can also be used by nfsrv_open() for V4.  */
end_comment

begin_function
name|APPLESTATIC
name|int
name|nfsrvd_create
parameter_list|(
name|struct
name|nfsrv_descript
modifier|*
name|nd
parameter_list|,
name|__unused
name|int
name|isdgram
parameter_list|,
name|vnode_t
name|dp
parameter_list|,
name|NFSPROC_T
modifier|*
name|p
parameter_list|,
name|struct
name|nfsexstuff
modifier|*
name|exp
parameter_list|)
block|{
name|struct
name|nfsvattr
name|nva
decl_stmt|,
name|dirfor
decl_stmt|,
name|diraft
decl_stmt|;
name|struct
name|nfsv2_sattr
modifier|*
name|sp
decl_stmt|;
name|struct
name|nameidata
name|named
decl_stmt|;
name|u_int32_t
modifier|*
name|tl
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|,
name|tsize
decl_stmt|,
name|dirfor_ret
init|=
literal|1
decl_stmt|,
name|diraft_ret
init|=
literal|1
decl_stmt|;
name|int
name|how
init|=
name|NFSCREATE_UNCHECKED
decl_stmt|,
name|exclusive_flag
init|=
literal|0
decl_stmt|;
name|NFSDEV_T
name|rdev
init|=
literal|0
decl_stmt|;
name|vnode_t
name|vp
init|=
name|NULL
decl_stmt|,
name|dirp
init|=
name|NULL
decl_stmt|;
name|fhandle_t
name|fh
decl_stmt|;
name|char
modifier|*
name|bufp
decl_stmt|;
name|u_long
modifier|*
name|hashp
decl_stmt|;
name|enum
name|vtype
name|vtyp
decl_stmt|;
name|int32_t
name|cverf
index|[
literal|2
index|]
decl_stmt|,
name|tverf
index|[
literal|2
index|]
init|=
block|{
literal|0
block|,
literal|0
block|}
decl_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|nfsrv_wcc
argument_list|(
name|nd
argument_list|,
name|dirfor_ret
argument_list|,
operator|&
name|dirfor
argument_list|,
name|diraft_ret
argument_list|,
operator|&
name|diraft
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|NFSNAMEICNDSET
argument_list|(
operator|&
name|named
operator|.
name|ni_cnd
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|CREATE
argument_list|,
name|LOCKPARENT
operator||
name|LOCKLEAF
operator||
name|SAVESTART
argument_list|)
expr_stmt|;
name|nfsvno_setpathbuf
argument_list|(
operator|&
name|named
argument_list|,
operator|&
name|bufp
argument_list|,
operator|&
name|hashp
argument_list|)
expr_stmt|;
name|error
operator|=
name|nfsrv_parsename
argument_list|(
name|nd
argument_list|,
name|bufp
argument_list|,
name|hashp
argument_list|,
operator|&
name|named
operator|.
name|ni_pathlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|vput
argument_list|(
name|dp
argument_list|)
expr_stmt|;
name|nfsvno_relpathbuf
argument_list|(
operator|&
name|named
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|NFSVNO_ATTRINIT
argument_list|(
operator|&
name|nva
argument_list|)
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV2
condition|)
block|{
name|NFSM_DISSECT
argument_list|(
name|sp
argument_list|,
expr|struct
name|nfsv2_sattr
operator|*
argument_list|,
name|NFSX_V2SATTR
argument_list|)
expr_stmt|;
name|vtyp
operator|=
name|IFTOVT
argument_list|(
name|fxdr_unsigned
argument_list|(
name|u_int32_t
argument_list|,
name|sp
operator|->
name|sa_mode
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vtyp
operator|==
name|VNON
condition|)
name|vtyp
operator|=
name|VREG
expr_stmt|;
name|NFSVNO_SETATTRVAL
argument_list|(
operator|&
name|nva
argument_list|,
name|type
argument_list|,
name|vtyp
argument_list|)
expr_stmt|;
name|NFSVNO_SETATTRVAL
argument_list|(
operator|&
name|nva
argument_list|,
name|mode
argument_list|,
name|nfstov_mode
argument_list|(
name|sp
operator|->
name|sa_mode
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|nva
operator|.
name|na_type
condition|)
block|{
case|case
name|VREG
case|:
name|tsize
operator|=
name|fxdr_unsigned
argument_list|(
name|int32_t
argument_list|,
name|sp
operator|->
name|sa_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|tsize
operator|!=
operator|-
literal|1
condition|)
name|NFSVNO_SETATTRVAL
argument_list|(
operator|&
name|nva
argument_list|,
name|size
argument_list|,
operator|(
name|u_quad_t
operator|)
name|tsize
argument_list|)
expr_stmt|;
break|break;
case|case
name|VCHR
case|:
case|case
name|VBLK
case|:
case|case
name|VFIFO
case|:
name|rdev
operator|=
name|fxdr_unsigned
argument_list|(
name|NFSDEV_T
argument_list|,
name|sp
operator|->
name|sa_size
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
empty_stmt|;
block|}
else|else
block|{
name|NFSM_DISSECT
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|how
operator|=
name|fxdr_unsigned
argument_list|(
name|int
argument_list|,
operator|*
name|tl
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|how
condition|)
block|{
case|case
name|NFSCREATE_GUARDED
case|:
case|case
name|NFSCREATE_UNCHECKED
case|:
name|error
operator|=
name|nfsrv_sattr
argument_list|(
name|nd
argument_list|,
operator|&
name|nva
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|nfsmout
goto|;
break|break;
case|case
name|NFSCREATE_EXCLUSIVE
case|:
name|NFSM_DISSECT
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
name|NFSX_VERF
argument_list|)
expr_stmt|;
name|cverf
index|[
literal|0
index|]
operator|=
operator|*
name|tl
operator|++
expr_stmt|;
name|cverf
index|[
literal|1
index|]
operator|=
operator|*
name|tl
expr_stmt|;
name|exclusive_flag
operator|=
literal|1
expr_stmt|;
break|break;
block|}
empty_stmt|;
name|NFSVNO_SETATTRVAL
argument_list|(
operator|&
name|nva
argument_list|,
name|type
argument_list|,
name|VREG
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|nfsvno_relpathbuf
argument_list|(
operator|&
name|named
argument_list|)
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV3
condition|)
block|{
name|dirfor_ret
operator|=
name|nfsvno_getattr
argument_list|(
name|dp
argument_list|,
operator|&
name|dirfor
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|nfsrv_wcc
argument_list|(
name|nd
argument_list|,
name|dirfor_ret
argument_list|,
operator|&
name|dirfor
argument_list|,
name|diraft_ret
argument_list|,
operator|&
name|diraft
argument_list|)
expr_stmt|;
block|}
name|vput
argument_list|(
name|dp
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_namei
argument_list|(
name|nd
argument_list|,
operator|&
name|named
argument_list|,
name|dp
argument_list|,
literal|1
argument_list|,
name|exp
argument_list|,
name|p
argument_list|,
operator|&
name|dirp
argument_list|)
expr_stmt|;
if|if
condition|(
name|dirp
condition|)
block|{
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV2
condition|)
block|{
name|vrele
argument_list|(
name|dirp
argument_list|)
expr_stmt|;
name|dirp
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|dirfor_ret
operator|=
name|nfsvno_getattr
argument_list|(
name|dirp
argument_list|,
operator|&
name|dirfor
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|nd
operator|->
name|nd_repstat
condition|)
block|{
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV3
condition|)
name|nfsrv_wcc
argument_list|(
name|nd
argument_list|,
name|dirfor_ret
argument_list|,
operator|&
name|dirfor
argument_list|,
name|diraft_ret
argument_list|,
operator|&
name|diraft
argument_list|)
expr_stmt|;
if|if
condition|(
name|dirp
condition|)
name|vrele
argument_list|(
name|dirp
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
operator|!
operator|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV2
operator|)
condition|)
block|{
switch|switch
condition|(
name|how
condition|)
block|{
case|case
name|NFSCREATE_GUARDED
case|:
if|if
condition|(
name|named
operator|.
name|ni_vp
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|EEXIST
expr_stmt|;
break|break;
case|case
name|NFSCREATE_UNCHECKED
case|:
break|break;
case|case
name|NFSCREATE_EXCLUSIVE
case|:
if|if
condition|(
name|named
operator|.
name|ni_vp
operator|==
name|NULL
condition|)
name|NFSVNO_SETATTRVAL
argument_list|(
operator|&
name|nva
argument_list|,
name|mode
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
empty_stmt|;
block|}
comment|/* 	 * Iff doesn't exist, create it 	 * otherwise just truncate to 0 length 	 *   should I set the mode too ? 	 */
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_createsub
argument_list|(
name|nd
argument_list|,
operator|&
name|named
argument_list|,
operator|&
name|vp
argument_list|,
operator|&
name|nva
argument_list|,
operator|&
name|exclusive_flag
argument_list|,
name|cverf
argument_list|,
name|rdev
argument_list|,
name|p
argument_list|,
name|exp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_getfh
argument_list|(
name|vp
argument_list|,
operator|&
name|fh
argument_list|,
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_getattr
argument_list|(
name|vp
argument_list|,
operator|&
name|nva
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|vput
argument_list|(
name|vp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|tverf
index|[
literal|0
index|]
operator|=
name|nva
operator|.
name|na_atime
operator|.
name|tv_sec
expr_stmt|;
name|tverf
index|[
literal|1
index|]
operator|=
name|nva
operator|.
name|na_atime
operator|.
name|tv_nsec
expr_stmt|;
block|}
block|}
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV2
condition|)
block|{
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
block|{
operator|(
name|void
operator|)
name|nfsm_fhtom
argument_list|(
name|nd
argument_list|,
operator|(
name|u_int8_t
operator|*
operator|)
operator|&
name|fh
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|nfsrv_fillattr
argument_list|(
name|nd
argument_list|,
operator|&
name|nva
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|exclusive_flag
operator|&&
operator|!
name|nd
operator|->
name|nd_repstat
operator|&&
operator|(
name|cverf
index|[
literal|0
index|]
operator|!=
name|tverf
index|[
literal|0
index|]
operator|||
name|cverf
index|[
literal|1
index|]
operator|!=
name|tverf
index|[
literal|1
index|]
operator|)
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|EEXIST
expr_stmt|;
name|diraft_ret
operator|=
name|nfsvno_getattr
argument_list|(
name|dirp
argument_list|,
operator|&
name|diraft
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|vrele
argument_list|(
name|dirp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
block|{
operator|(
name|void
operator|)
name|nfsm_fhtom
argument_list|(
name|nd
argument_list|,
operator|(
name|u_int8_t
operator|*
operator|)
operator|&
name|fh
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|nfsrv_postopattr
argument_list|(
name|nd
argument_list|,
literal|0
argument_list|,
operator|&
name|nva
argument_list|)
expr_stmt|;
block|}
name|nfsrv_wcc
argument_list|(
name|nd
argument_list|,
name|dirfor_ret
argument_list|,
operator|&
name|dirfor
argument_list|,
name|diraft_ret
argument_list|,
operator|&
name|diraft
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|nfsmout
label|:
name|vput
argument_list|(
name|dp
argument_list|)
expr_stmt|;
name|nfsvno_relpathbuf
argument_list|(
operator|&
name|named
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * nfs v3 mknod service (and v4 create)  */
end_comment

begin_function
name|APPLESTATIC
name|int
name|nfsrvd_mknod
parameter_list|(
name|struct
name|nfsrv_descript
modifier|*
name|nd
parameter_list|,
name|__unused
name|int
name|isdgram
parameter_list|,
name|vnode_t
name|dp
parameter_list|,
name|vnode_t
modifier|*
name|vpp
parameter_list|,
name|fhandle_t
modifier|*
name|fhp
parameter_list|,
name|NFSPROC_T
modifier|*
name|p
parameter_list|,
name|struct
name|nfsexstuff
modifier|*
name|exp
parameter_list|)
block|{
name|struct
name|nfsvattr
name|nva
decl_stmt|,
name|dirfor
decl_stmt|,
name|diraft
decl_stmt|;
name|u_int32_t
modifier|*
name|tl
decl_stmt|;
name|struct
name|nameidata
name|named
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|,
name|dirfor_ret
init|=
literal|1
decl_stmt|,
name|diraft_ret
init|=
literal|1
decl_stmt|,
name|pathlen
decl_stmt|;
name|u_int32_t
name|major
decl_stmt|,
name|minor
decl_stmt|;
name|enum
name|vtype
name|vtyp
init|=
name|VNON
decl_stmt|;
name|nfstype
name|nfs4type
init|=
name|NFNON
decl_stmt|;
name|vnode_t
name|vp
decl_stmt|,
name|dirp
init|=
name|NULL
decl_stmt|;
name|nfsattrbit_t
name|attrbits
decl_stmt|;
name|char
modifier|*
name|bufp
init|=
name|NULL
decl_stmt|,
modifier|*
name|pathcp
init|=
name|NULL
decl_stmt|;
name|u_long
modifier|*
name|hashp
decl_stmt|,
name|cnflags
decl_stmt|;
name|NFSACL_T
modifier|*
name|aclp
init|=
name|NULL
decl_stmt|;
name|NFSVNO_ATTRINIT
argument_list|(
operator|&
name|nva
argument_list|)
expr_stmt|;
name|cnflags
operator|=
operator|(
name|LOCKPARENT
operator||
name|SAVESTART
operator|)
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|nfsrv_wcc
argument_list|(
name|nd
argument_list|,
name|dirfor_ret
argument_list|,
operator|&
name|dirfor
argument_list|,
name|diraft_ret
argument_list|,
operator|&
name|diraft
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
ifdef|#
directive|ifdef
name|NFS4_ACL_EXTATTR_NAME
name|aclp
operator|=
name|acl_alloc
argument_list|(
name|M_WAITOK
argument_list|)
expr_stmt|;
name|aclp
operator|->
name|acl_cnt
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
comment|/* 	 * For V4, the creation stuff is here, Yuck! 	 */
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV4
condition|)
block|{
name|NFSM_DISSECT
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|vtyp
operator|=
name|nfsv34tov_type
argument_list|(
operator|*
name|tl
argument_list|)
expr_stmt|;
name|nfs4type
operator|=
name|fxdr_unsigned
argument_list|(
name|nfstype
argument_list|,
operator|*
name|tl
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|nfs4type
condition|)
block|{
case|case
name|NFLNK
case|:
name|error
operator|=
name|nfsvno_getsymlink
argument_list|(
name|nd
argument_list|,
operator|&
name|nva
argument_list|,
name|p
argument_list|,
operator|&
name|pathcp
argument_list|,
operator|&
name|pathlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|vrele
argument_list|(
name|dp
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|NFS4_ACL_EXTATTR_NAME
name|acl_free
argument_list|(
name|aclp
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
name|error
operator|)
return|;
block|}
break|break;
case|case
name|NFCHR
case|:
case|case
name|NFBLK
case|:
name|NFSM_DISSECT
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
literal|2
operator|*
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|major
operator|=
name|fxdr_unsigned
argument_list|(
name|u_int32_t
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
expr_stmt|;
name|minor
operator|=
name|fxdr_unsigned
argument_list|(
name|u_int32_t
argument_list|,
operator|*
name|tl
argument_list|)
expr_stmt|;
name|nva
operator|.
name|na_rdev
operator|=
name|NFSMAKEDEV
argument_list|(
name|major
argument_list|,
name|minor
argument_list|)
expr_stmt|;
break|break;
case|case
name|NFSOCK
case|:
case|case
name|NFFIFO
case|:
break|break;
case|case
name|NFDIR
case|:
name|cnflags
operator|=
operator|(
name|LOCKPARENT
operator||
name|SAVENAME
operator|)
expr_stmt|;
break|break;
default|default:
name|nd
operator|->
name|nd_repstat
operator|=
name|NFSERR_BADTYPE
expr_stmt|;
name|vrele
argument_list|(
name|dp
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|NFS4_ACL_EXTATTR_NAME
name|acl_free
argument_list|(
name|aclp
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
literal|0
operator|)
return|;
block|}
empty_stmt|;
block|}
name|NFSNAMEICNDSET
argument_list|(
operator|&
name|named
operator|.
name|ni_cnd
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|CREATE
argument_list|,
name|cnflags
argument_list|)
expr_stmt|;
name|nfsvno_setpathbuf
argument_list|(
operator|&
name|named
argument_list|,
operator|&
name|bufp
argument_list|,
operator|&
name|hashp
argument_list|)
expr_stmt|;
name|error
operator|=
name|nfsrv_parsename
argument_list|(
name|nd
argument_list|,
name|bufp
argument_list|,
name|hashp
argument_list|,
operator|&
name|named
operator|.
name|ni_pathlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|vrele
argument_list|(
name|dp
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|NFS4_ACL_EXTATTR_NAME
name|acl_free
argument_list|(
name|aclp
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|nfsvno_relpathbuf
argument_list|(
operator|&
name|named
argument_list|)
expr_stmt|;
if|if
condition|(
name|pathcp
condition|)
name|FREE
argument_list|(
name|pathcp
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
block|{
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV3
condition|)
block|{
name|NFSM_DISSECT
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|vtyp
operator|=
name|nfsv34tov_type
argument_list|(
operator|*
name|tl
argument_list|)
expr_stmt|;
block|}
name|error
operator|=
name|nfsrv_sattr
argument_list|(
name|nd
argument_list|,
operator|&
name|nva
argument_list|,
operator|&
name|attrbits
argument_list|,
name|aclp
argument_list|,
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|vrele
argument_list|(
name|dp
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|NFS4_ACL_EXTATTR_NAME
name|acl_free
argument_list|(
name|aclp
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|nfsvno_relpathbuf
argument_list|(
operator|&
name|named
argument_list|)
expr_stmt|;
if|if
condition|(
name|pathcp
condition|)
name|FREE
argument_list|(
name|pathcp
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|nva
operator|.
name|na_type
operator|=
name|vtyp
expr_stmt|;
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
operator|&&
operator|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV3
operator|)
operator|&&
operator|(
name|vtyp
operator|==
name|VCHR
operator|||
name|vtyp
operator|==
name|VBLK
operator|)
condition|)
block|{
name|NFSM_DISSECT
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
literal|2
operator|*
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|major
operator|=
name|fxdr_unsigned
argument_list|(
name|u_int32_t
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
expr_stmt|;
name|minor
operator|=
name|fxdr_unsigned
argument_list|(
name|u_int32_t
argument_list|,
operator|*
name|tl
argument_list|)
expr_stmt|;
name|nva
operator|.
name|na_rdev
operator|=
name|NFSMAKEDEV
argument_list|(
name|major
argument_list|,
name|minor
argument_list|)
expr_stmt|;
block|}
block|}
name|dirfor_ret
operator|=
name|nfsvno_getattr
argument_list|(
name|dp
argument_list|,
operator|&
name|dirfor
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
operator|&&
operator|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV4
operator|)
condition|)
block|{
if|if
condition|(
operator|!
name|dirfor_ret
operator|&&
name|NFSVNO_ISSETGID
argument_list|(
operator|&
name|nva
argument_list|)
operator|&&
name|dirfor
operator|.
name|na_gid
operator|==
name|nva
operator|.
name|na_gid
condition|)
name|NFSVNO_UNSET
argument_list|(
operator|&
name|nva
argument_list|,
name|gid
argument_list|)
expr_stmt|;
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsrv_checkuidgid
argument_list|(
name|nd
argument_list|,
operator|&
name|nva
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|vrele
argument_list|(
name|dp
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|NFS4_ACL_EXTATTR_NAME
name|acl_free
argument_list|(
name|aclp
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|nfsvno_relpathbuf
argument_list|(
operator|&
name|named
argument_list|)
expr_stmt|;
if|if
condition|(
name|pathcp
condition|)
name|FREE
argument_list|(
name|pathcp
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV3
condition|)
name|nfsrv_wcc
argument_list|(
name|nd
argument_list|,
name|dirfor_ret
argument_list|,
operator|&
name|dirfor
argument_list|,
name|diraft_ret
argument_list|,
operator|&
name|diraft
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
comment|/* 	 * Yuck! For V4, mkdir and link are here and some V4 clients don't fill 	 * in va_mode, so we'll have to set a default here. 	 */
if|if
condition|(
name|NFSVNO_NOTSETMODE
argument_list|(
operator|&
name|nva
argument_list|)
condition|)
block|{
if|if
condition|(
name|vtyp
operator|==
name|VLNK
condition|)
name|nva
operator|.
name|na_mode
operator|=
literal|0755
expr_stmt|;
else|else
name|nva
operator|.
name|na_mode
operator|=
literal|0400
expr_stmt|;
block|}
if|if
condition|(
name|vtyp
operator|==
name|VDIR
condition|)
name|named
operator|.
name|ni_cnd
operator|.
name|cn_flags
operator||=
name|WILLBEDIR
expr_stmt|;
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_namei
argument_list|(
name|nd
argument_list|,
operator|&
name|named
argument_list|,
name|dp
argument_list|,
literal|0
argument_list|,
name|exp
argument_list|,
name|p
argument_list|,
operator|&
name|dirp
argument_list|)
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_repstat
condition|)
block|{
if|if
condition|(
name|dirp
condition|)
block|{
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV3
condition|)
name|dirfor_ret
operator|=
name|nfsvno_getattr
argument_list|(
name|dirp
argument_list|,
operator|&
name|dirfor
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|vrele
argument_list|(
name|dirp
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|NFS4_ACL_EXTATTR_NAME
name|acl_free
argument_list|(
name|aclp
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV3
condition|)
name|nfsrv_wcc
argument_list|(
name|nd
argument_list|,
name|dirfor_ret
argument_list|,
operator|&
name|dirfor
argument_list|,
name|diraft_ret
argument_list|,
operator|&
name|diraft
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|dirp
condition|)
name|dirfor_ret
operator|=
name|nfsvno_getattr
argument_list|(
name|dirp
argument_list|,
operator|&
name|dirfor
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV4
operator|)
operator|&&
operator|(
name|vtyp
operator|==
name|VDIR
operator|||
name|vtyp
operator|==
name|VLNK
operator|)
condition|)
block|{
if|if
condition|(
name|vtyp
operator|==
name|VDIR
condition|)
block|{
name|nfsrvd_mkdirsub
argument_list|(
name|nd
argument_list|,
operator|&
name|named
argument_list|,
operator|&
name|nva
argument_list|,
name|fhp
argument_list|,
name|vpp
argument_list|,
name|dirp
argument_list|,
operator|&
name|dirfor
argument_list|,
operator|&
name|diraft
argument_list|,
operator|&
name|diraft_ret
argument_list|,
operator|&
name|attrbits
argument_list|,
name|aclp
argument_list|,
name|p
argument_list|,
name|exp
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|NFS4_ACL_EXTATTR_NAME
name|acl_free
argument_list|(
name|aclp
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
literal|0
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|vtyp
operator|==
name|VLNK
condition|)
block|{
name|nfsrvd_symlinksub
argument_list|(
name|nd
argument_list|,
operator|&
name|named
argument_list|,
operator|&
name|nva
argument_list|,
name|fhp
argument_list|,
name|vpp
argument_list|,
name|dirp
argument_list|,
operator|&
name|dirfor
argument_list|,
operator|&
name|diraft
argument_list|,
operator|&
name|diraft_ret
argument_list|,
operator|&
name|attrbits
argument_list|,
name|aclp
argument_list|,
name|p
argument_list|,
name|exp
argument_list|,
name|pathcp
argument_list|,
name|pathlen
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|NFS4_ACL_EXTATTR_NAME
name|acl_free
argument_list|(
name|aclp
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|FREE
argument_list|(
name|pathcp
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_mknod
argument_list|(
operator|&
name|named
argument_list|,
operator|&
name|nva
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|vp
operator|=
name|named
operator|.
name|ni_vp
expr_stmt|;
name|nfsrv_fixattr
argument_list|(
name|nd
argument_list|,
name|vp
argument_list|,
operator|&
name|nva
argument_list|,
name|aclp
argument_list|,
name|p
argument_list|,
operator|&
name|attrbits
argument_list|,
name|exp
argument_list|)
expr_stmt|;
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_getfh
argument_list|(
name|vp
argument_list|,
name|fhp
argument_list|,
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV3
operator|)
operator|&&
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_getattr
argument_list|(
name|vp
argument_list|,
operator|&
name|nva
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|vpp
operator|!=
name|NULL
operator|&&
name|nd
operator|->
name|nd_repstat
operator|==
literal|0
condition|)
block|{
name|VOP_UNLOCK
argument_list|(
name|vp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|*
name|vpp
operator|=
name|vp
expr_stmt|;
block|}
else|else
name|vput
argument_list|(
name|vp
argument_list|)
expr_stmt|;
block|}
name|diraft_ret
operator|=
name|nfsvno_getattr
argument_list|(
name|dirp
argument_list|,
operator|&
name|diraft
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|vrele
argument_list|(
name|dirp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
block|{
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV3
condition|)
block|{
operator|(
name|void
operator|)
name|nfsm_fhtom
argument_list|(
name|nd
argument_list|,
operator|(
name|u_int8_t
operator|*
operator|)
name|fhp
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|nfsrv_postopattr
argument_list|(
name|nd
argument_list|,
literal|0
argument_list|,
operator|&
name|nva
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|NFSM_BUILD
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
literal|5
operator|*
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
name|newnfs_false
expr_stmt|;
name|txdr_hyper
argument_list|(
name|dirfor
operator|.
name|na_filerev
argument_list|,
name|tl
argument_list|)
expr_stmt|;
name|tl
operator|+=
literal|2
expr_stmt|;
name|txdr_hyper
argument_list|(
name|diraft
operator|.
name|na_filerev
argument_list|,
name|tl
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|nfsrv_putattrbit
argument_list|(
name|nd
argument_list|,
operator|&
name|attrbits
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV3
condition|)
name|nfsrv_wcc
argument_list|(
name|nd
argument_list|,
name|dirfor_ret
argument_list|,
operator|&
name|dirfor
argument_list|,
name|diraft_ret
argument_list|,
operator|&
name|diraft
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|NFS4_ACL_EXTATTR_NAME
name|acl_free
argument_list|(
name|aclp
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
literal|0
operator|)
return|;
name|nfsmout
label|:
name|vrele
argument_list|(
name|dp
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|NFS4_ACL_EXTATTR_NAME
name|acl_free
argument_list|(
name|aclp
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|bufp
condition|)
name|nfsvno_relpathbuf
argument_list|(
operator|&
name|named
argument_list|)
expr_stmt|;
if|if
condition|(
name|pathcp
condition|)
name|FREE
argument_list|(
name|pathcp
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * nfs remove service  */
end_comment

begin_function
name|APPLESTATIC
name|int
name|nfsrvd_remove
parameter_list|(
name|struct
name|nfsrv_descript
modifier|*
name|nd
parameter_list|,
name|__unused
name|int
name|isdgram
parameter_list|,
name|vnode_t
name|dp
parameter_list|,
name|NFSPROC_T
modifier|*
name|p
parameter_list|,
name|struct
name|nfsexstuff
modifier|*
name|exp
parameter_list|)
block|{
name|struct
name|nameidata
name|named
decl_stmt|;
name|u_int32_t
modifier|*
name|tl
decl_stmt|;
name|int
name|error
decl_stmt|,
name|dirfor_ret
init|=
literal|1
decl_stmt|,
name|diraft_ret
init|=
literal|1
decl_stmt|;
name|vnode_t
name|dirp
init|=
name|NULL
decl_stmt|;
name|struct
name|nfsvattr
name|dirfor
decl_stmt|,
name|diraft
decl_stmt|;
name|char
modifier|*
name|bufp
decl_stmt|;
name|u_long
modifier|*
name|hashp
decl_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|nfsrv_wcc
argument_list|(
name|nd
argument_list|,
name|dirfor_ret
argument_list|,
operator|&
name|dirfor
argument_list|,
name|diraft_ret
argument_list|,
operator|&
name|diraft
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|NFSNAMEICNDSET
argument_list|(
operator|&
name|named
operator|.
name|ni_cnd
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|DELETE
argument_list|,
name|LOCKPARENT
operator||
name|LOCKLEAF
argument_list|)
expr_stmt|;
name|nfsvno_setpathbuf
argument_list|(
operator|&
name|named
argument_list|,
operator|&
name|bufp
argument_list|,
operator|&
name|hashp
argument_list|)
expr_stmt|;
name|error
operator|=
name|nfsrv_parsename
argument_list|(
name|nd
argument_list|,
name|bufp
argument_list|,
name|hashp
argument_list|,
operator|&
name|named
operator|.
name|ni_pathlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|vput
argument_list|(
name|dp
argument_list|)
expr_stmt|;
name|nfsvno_relpathbuf
argument_list|(
operator|&
name|named
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_namei
argument_list|(
name|nd
argument_list|,
operator|&
name|named
argument_list|,
name|dp
argument_list|,
literal|1
argument_list|,
name|exp
argument_list|,
name|p
argument_list|,
operator|&
name|dirp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|vput
argument_list|(
name|dp
argument_list|)
expr_stmt|;
name|nfsvno_relpathbuf
argument_list|(
operator|&
name|named
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dirp
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV2
operator|)
condition|)
block|{
name|dirfor_ret
operator|=
name|nfsvno_getattr
argument_list|(
name|dirp
argument_list|,
operator|&
name|dirfor
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|vrele
argument_list|(
name|dirp
argument_list|)
expr_stmt|;
name|dirp
operator|=
name|NULL
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
block|{
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV4
condition|)
block|{
if|if
condition|(
name|vnode_vtype
argument_list|(
name|named
operator|.
name|ni_vp
argument_list|)
operator|==
name|VDIR
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_rmdirsub
argument_list|(
operator|&
name|named
argument_list|,
literal|1
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
name|exp
argument_list|)
expr_stmt|;
else|else
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_removesub
argument_list|(
operator|&
name|named
argument_list|,
literal|1
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
name|exp
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|nd
operator|->
name|nd_procnum
operator|==
name|NFSPROC_RMDIR
condition|)
block|{
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_rmdirsub
argument_list|(
operator|&
name|named
argument_list|,
literal|0
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
name|exp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_removesub
argument_list|(
operator|&
name|named
argument_list|,
literal|0
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
name|exp
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
operator|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV2
operator|)
condition|)
block|{
if|if
condition|(
name|dirp
condition|)
block|{
name|diraft_ret
operator|=
name|nfsvno_getattr
argument_list|(
name|dirp
argument_list|,
operator|&
name|diraft
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|vrele
argument_list|(
name|dirp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV3
condition|)
block|{
name|nfsrv_wcc
argument_list|(
name|nd
argument_list|,
name|dirfor_ret
argument_list|,
operator|&
name|dirfor
argument_list|,
name|diraft_ret
argument_list|,
operator|&
name|diraft
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|NFSM_BUILD
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
literal|5
operator|*
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
name|newnfs_false
expr_stmt|;
name|txdr_hyper
argument_list|(
name|dirfor
operator|.
name|na_filerev
argument_list|,
name|tl
argument_list|)
expr_stmt|;
name|tl
operator|+=
literal|2
expr_stmt|;
name|txdr_hyper
argument_list|(
name|diraft
operator|.
name|na_filerev
argument_list|,
name|tl
argument_list|)
expr_stmt|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * nfs rename service  */
end_comment

begin_function
name|APPLESTATIC
name|int
name|nfsrvd_rename
parameter_list|(
name|struct
name|nfsrv_descript
modifier|*
name|nd
parameter_list|,
name|int
name|isdgram
parameter_list|,
name|vnode_t
name|dp
parameter_list|,
name|vnode_t
name|todp
parameter_list|,
name|NFSPROC_T
modifier|*
name|p
parameter_list|,
name|struct
name|nfsexstuff
modifier|*
name|exp
parameter_list|,
name|struct
name|nfsexstuff
modifier|*
name|toexp
parameter_list|)
block|{
name|u_int32_t
modifier|*
name|tl
decl_stmt|;
name|int
name|error
decl_stmt|,
name|fdirfor_ret
init|=
literal|1
decl_stmt|,
name|fdiraft_ret
init|=
literal|1
decl_stmt|;
name|int
name|tdirfor_ret
init|=
literal|1
decl_stmt|,
name|tdiraft_ret
init|=
literal|1
decl_stmt|;
name|struct
name|nameidata
name|fromnd
decl_stmt|,
name|tond
decl_stmt|;
name|vnode_t
name|fdirp
init|=
name|NULL
decl_stmt|,
name|tdirp
init|=
name|NULL
decl_stmt|,
name|tdp
init|=
name|NULL
decl_stmt|;
name|struct
name|nfsvattr
name|fdirfor
decl_stmt|,
name|fdiraft
decl_stmt|,
name|tdirfor
decl_stmt|,
name|tdiraft
decl_stmt|;
name|struct
name|nfsexstuff
name|tnes
decl_stmt|;
name|struct
name|nfsrvfh
name|tfh
decl_stmt|;
name|char
modifier|*
name|bufp
decl_stmt|,
modifier|*
name|tbufp
init|=
name|NULL
decl_stmt|;
name|u_long
modifier|*
name|hashp
decl_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|nfsrv_wcc
argument_list|(
name|nd
argument_list|,
name|fdirfor_ret
argument_list|,
operator|&
name|fdirfor
argument_list|,
name|fdiraft_ret
argument_list|,
operator|&
name|fdiraft
argument_list|)
expr_stmt|;
name|nfsrv_wcc
argument_list|(
name|nd
argument_list|,
name|tdirfor_ret
argument_list|,
operator|&
name|tdirfor
argument_list|,
name|tdiraft_ret
argument_list|,
operator|&
name|tdiraft
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
operator|!
operator|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV2
operator|)
condition|)
name|fdirfor_ret
operator|=
name|nfsvno_getattr
argument_list|(
name|dp
argument_list|,
operator|&
name|fdirfor
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|tond
operator|.
name|ni_cnd
operator|.
name|cn_nameiop
operator|=
literal|0
expr_stmt|;
name|tond
operator|.
name|ni_startdir
operator|=
name|NULL
expr_stmt|;
name|NFSNAMEICNDSET
argument_list|(
operator|&
name|fromnd
operator|.
name|ni_cnd
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|DELETE
argument_list|,
name|WANTPARENT
operator||
name|SAVESTART
argument_list|)
expr_stmt|;
name|nfsvno_setpathbuf
argument_list|(
operator|&
name|fromnd
argument_list|,
operator|&
name|bufp
argument_list|,
operator|&
name|hashp
argument_list|)
expr_stmt|;
name|error
operator|=
name|nfsrv_parsename
argument_list|(
name|nd
argument_list|,
name|bufp
argument_list|,
name|hashp
argument_list|,
operator|&
name|fromnd
operator|.
name|ni_pathlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|vput
argument_list|(
name|dp
argument_list|)
expr_stmt|;
if|if
condition|(
name|todp
condition|)
name|vrele
argument_list|(
name|todp
argument_list|)
expr_stmt|;
name|nfsvno_relpathbuf
argument_list|(
operator|&
name|fromnd
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV4
condition|)
block|{
name|tdp
operator|=
name|todp
expr_stmt|;
name|tnes
operator|=
operator|*
name|toexp
expr_stmt|;
name|tdirfor_ret
operator|=
name|nfsvno_getattr
argument_list|(
name|tdp
argument_list|,
operator|&
name|tdirfor
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|error
operator|=
name|nfsrv_mtofh
argument_list|(
name|nd
argument_list|,
operator|&
name|tfh
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|vput
argument_list|(
name|dp
argument_list|)
expr_stmt|;
comment|/* todp is always NULL except NFSv4 */
name|nfsvno_relpathbuf
argument_list|(
operator|&
name|fromnd
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|nd
operator|->
name|nd_cred
operator|->
name|cr_uid
operator|=
name|nd
operator|->
name|nd_saveduid
expr_stmt|;
name|nfsd_fhtovp
argument_list|(
name|nd
argument_list|,
operator|&
name|tfh
argument_list|,
name|LK_EXCLUSIVE
argument_list|,
operator|&
name|tdp
argument_list|,
operator|&
name|tnes
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|tdp
condition|)
block|{
name|tdirfor_ret
operator|=
name|nfsvno_getattr
argument_list|(
name|tdp
argument_list|,
operator|&
name|tdirfor
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|NFSVOPUNLOCK
argument_list|(
name|tdp
argument_list|,
literal|0
argument_list|,
name|p
argument_list|)
expr_stmt|;
block|}
block|}
name|NFSNAMEICNDSET
argument_list|(
operator|&
name|tond
operator|.
name|ni_cnd
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|RENAME
argument_list|,
name|LOCKPARENT
operator||
name|LOCKLEAF
operator||
name|NOCACHE
operator||
name|SAVESTART
argument_list|)
expr_stmt|;
name|nfsvno_setpathbuf
argument_list|(
operator|&
name|tond
argument_list|,
operator|&
name|tbufp
argument_list|,
operator|&
name|hashp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|error
operator|=
name|nfsrv_parsename
argument_list|(
name|nd
argument_list|,
name|tbufp
argument_list|,
name|hashp
argument_list|,
operator|&
name|tond
operator|.
name|ni_pathlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
if|if
condition|(
name|tdp
condition|)
name|vrele
argument_list|(
name|tdp
argument_list|)
expr_stmt|;
name|vput
argument_list|(
name|dp
argument_list|)
expr_stmt|;
name|nfsvno_relpathbuf
argument_list|(
operator|&
name|fromnd
argument_list|)
expr_stmt|;
name|nfsvno_relpathbuf
argument_list|(
operator|&
name|tond
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
block|}
if|if
condition|(
name|nd
operator|->
name|nd_repstat
condition|)
block|{
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV3
condition|)
block|{
name|nfsrv_wcc
argument_list|(
name|nd
argument_list|,
name|fdirfor_ret
argument_list|,
operator|&
name|fdirfor
argument_list|,
name|fdiraft_ret
argument_list|,
operator|&
name|fdiraft
argument_list|)
expr_stmt|;
name|nfsrv_wcc
argument_list|(
name|nd
argument_list|,
name|tdirfor_ret
argument_list|,
operator|&
name|tdirfor
argument_list|,
name|tdiraft_ret
argument_list|,
operator|&
name|tdiraft
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|tdp
condition|)
name|vrele
argument_list|(
name|tdp
argument_list|)
expr_stmt|;
name|vput
argument_list|(
name|dp
argument_list|)
expr_stmt|;
name|nfsvno_relpathbuf
argument_list|(
operator|&
name|fromnd
argument_list|)
expr_stmt|;
name|nfsvno_relpathbuf
argument_list|(
operator|&
name|tond
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
comment|/* 	 * Done parsing, now down to business. 	 */
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_namei
argument_list|(
name|nd
argument_list|,
operator|&
name|fromnd
argument_list|,
name|dp
argument_list|,
literal|1
argument_list|,
name|exp
argument_list|,
name|p
argument_list|,
operator|&
name|fdirp
argument_list|)
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_repstat
condition|)
block|{
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV3
condition|)
block|{
name|nfsrv_wcc
argument_list|(
name|nd
argument_list|,
name|fdirfor_ret
argument_list|,
operator|&
name|fdirfor
argument_list|,
name|fdiraft_ret
argument_list|,
operator|&
name|fdiraft
argument_list|)
expr_stmt|;
name|nfsrv_wcc
argument_list|(
name|nd
argument_list|,
name|tdirfor_ret
argument_list|,
operator|&
name|tdirfor
argument_list|,
name|tdiraft_ret
argument_list|,
operator|&
name|tdiraft
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fdirp
condition|)
name|vrele
argument_list|(
name|fdirp
argument_list|)
expr_stmt|;
if|if
condition|(
name|tdp
condition|)
name|vrele
argument_list|(
name|tdp
argument_list|)
expr_stmt|;
name|nfsvno_relpathbuf
argument_list|(
operator|&
name|tond
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|vnode_vtype
argument_list|(
name|fromnd
operator|.
name|ni_vp
argument_list|)
operator|==
name|VDIR
condition|)
name|tond
operator|.
name|ni_cnd
operator|.
name|cn_flags
operator||=
name|WILLBEDIR
expr_stmt|;
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_namei
argument_list|(
name|nd
argument_list|,
operator|&
name|tond
argument_list|,
name|tdp
argument_list|,
literal|0
argument_list|,
operator|&
name|tnes
argument_list|,
name|p
argument_list|,
operator|&
name|tdirp
argument_list|)
expr_stmt|;
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_rename
argument_list|(
operator|&
name|fromnd
argument_list|,
operator|&
name|tond
argument_list|,
name|nd
operator|->
name|nd_repstat
argument_list|,
name|nd
operator|->
name|nd_flag
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|fdirp
condition|)
name|fdiraft_ret
operator|=
name|nfsvno_getattr
argument_list|(
name|fdirp
argument_list|,
operator|&
name|fdiraft
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|tdirp
condition|)
name|tdiraft_ret
operator|=
name|nfsvno_getattr
argument_list|(
name|tdirp
argument_list|,
operator|&
name|tdiraft
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|fdirp
condition|)
name|vrele
argument_list|(
name|fdirp
argument_list|)
expr_stmt|;
if|if
condition|(
name|tdirp
condition|)
name|vrele
argument_list|(
name|tdirp
argument_list|)
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV3
condition|)
block|{
name|nfsrv_wcc
argument_list|(
name|nd
argument_list|,
name|fdirfor_ret
argument_list|,
operator|&
name|fdirfor
argument_list|,
name|fdiraft_ret
argument_list|,
operator|&
name|fdiraft
argument_list|)
expr_stmt|;
name|nfsrv_wcc
argument_list|(
name|nd
argument_list|,
name|tdirfor_ret
argument_list|,
operator|&
name|tdirfor
argument_list|,
name|tdiraft_ret
argument_list|,
operator|&
name|tdiraft
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV4
operator|)
operator|&&
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|NFSM_BUILD
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
literal|10
operator|*
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
name|newnfs_false
expr_stmt|;
name|txdr_hyper
argument_list|(
name|fdirfor
operator|.
name|na_filerev
argument_list|,
name|tl
argument_list|)
expr_stmt|;
name|tl
operator|+=
literal|2
expr_stmt|;
name|txdr_hyper
argument_list|(
name|fdiraft
operator|.
name|na_filerev
argument_list|,
name|tl
argument_list|)
expr_stmt|;
name|tl
operator|+=
literal|2
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
name|newnfs_false
expr_stmt|;
name|txdr_hyper
argument_list|(
name|tdirfor
operator|.
name|na_filerev
argument_list|,
name|tl
argument_list|)
expr_stmt|;
name|tl
operator|+=
literal|2
expr_stmt|;
name|txdr_hyper
argument_list|(
name|tdiraft
operator|.
name|na_filerev
argument_list|,
name|tl
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * nfs link service  */
end_comment

begin_function
name|APPLESTATIC
name|int
name|nfsrvd_link
parameter_list|(
name|struct
name|nfsrv_descript
modifier|*
name|nd
parameter_list|,
name|int
name|isdgram
parameter_list|,
name|vnode_t
name|vp
parameter_list|,
name|vnode_t
name|tovp
parameter_list|,
name|NFSPROC_T
modifier|*
name|p
parameter_list|,
name|struct
name|nfsexstuff
modifier|*
name|exp
parameter_list|,
name|struct
name|nfsexstuff
modifier|*
name|toexp
parameter_list|)
block|{
name|struct
name|nameidata
name|named
decl_stmt|;
name|u_int32_t
modifier|*
name|tl
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|,
name|dirfor_ret
init|=
literal|1
decl_stmt|,
name|diraft_ret
init|=
literal|1
decl_stmt|,
name|getret
init|=
literal|1
decl_stmt|;
name|vnode_t
name|dirp
init|=
name|NULL
decl_stmt|,
name|dp
init|=
name|NULL
decl_stmt|;
name|struct
name|nfsvattr
name|dirfor
decl_stmt|,
name|diraft
decl_stmt|,
name|at
decl_stmt|;
name|struct
name|nfsexstuff
name|tnes
decl_stmt|;
name|struct
name|nfsrvfh
name|dfh
decl_stmt|;
name|char
modifier|*
name|bufp
decl_stmt|;
name|u_long
modifier|*
name|hashp
decl_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|nfsrv_postopattr
argument_list|(
name|nd
argument_list|,
name|getret
argument_list|,
operator|&
name|at
argument_list|)
expr_stmt|;
name|nfsrv_wcc
argument_list|(
name|nd
argument_list|,
name|dirfor_ret
argument_list|,
operator|&
name|dirfor
argument_list|,
name|diraft_ret
argument_list|,
operator|&
name|diraft
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|NFSVOPUNLOCK
argument_list|(
name|vp
argument_list|,
literal|0
argument_list|,
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|vnode_vtype
argument_list|(
name|vp
argument_list|)
operator|==
name|VDIR
condition|)
block|{
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV4
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|NFSERR_ISDIR
expr_stmt|;
else|else
name|nd
operator|->
name|nd_repstat
operator|=
name|NFSERR_INVAL
expr_stmt|;
if|if
condition|(
name|tovp
condition|)
name|vrele
argument_list|(
name|tovp
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|vnode_vtype
argument_list|(
name|vp
argument_list|)
operator|==
name|VLNK
condition|)
block|{
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV2
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|NFSERR_INVAL
expr_stmt|;
else|else
name|nd
operator|->
name|nd_repstat
operator|=
name|NFSERR_NOTSUPP
expr_stmt|;
if|if
condition|(
name|tovp
condition|)
name|vrele
argument_list|(
name|tovp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
block|{
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV4
condition|)
block|{
name|dp
operator|=
name|tovp
expr_stmt|;
name|tnes
operator|=
operator|*
name|toexp
expr_stmt|;
block|}
else|else
block|{
name|error
operator|=
name|nfsrv_mtofh
argument_list|(
name|nd
argument_list|,
operator|&
name|dfh
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|vrele
argument_list|(
name|vp
argument_list|)
expr_stmt|;
comment|/* tovp is always NULL unless NFSv4 */
return|return
operator|(
name|error
operator|)
return|;
block|}
name|nfsd_fhtovp
argument_list|(
name|nd
argument_list|,
operator|&
name|dfh
argument_list|,
name|LK_EXCLUSIVE
argument_list|,
operator|&
name|dp
argument_list|,
operator|&
name|tnes
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|dp
condition|)
name|NFSVOPUNLOCK
argument_list|(
name|dp
argument_list|,
literal|0
argument_list|,
name|p
argument_list|)
expr_stmt|;
block|}
block|}
name|NFSNAMEICNDSET
argument_list|(
operator|&
name|named
operator|.
name|ni_cnd
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|CREATE
argument_list|,
name|LOCKPARENT
operator||
name|SAVENAME
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|nfsvno_setpathbuf
argument_list|(
operator|&
name|named
argument_list|,
operator|&
name|bufp
argument_list|,
operator|&
name|hashp
argument_list|)
expr_stmt|;
name|error
operator|=
name|nfsrv_parsename
argument_list|(
name|nd
argument_list|,
name|bufp
argument_list|,
name|hashp
argument_list|,
operator|&
name|named
operator|.
name|ni_pathlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|vrele
argument_list|(
name|vp
argument_list|)
expr_stmt|;
if|if
condition|(
name|dp
condition|)
name|vrele
argument_list|(
name|dp
argument_list|)
expr_stmt|;
name|nfsvno_relpathbuf
argument_list|(
operator|&
name|named
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_namei
argument_list|(
name|nd
argument_list|,
operator|&
name|named
argument_list|,
name|dp
argument_list|,
literal|0
argument_list|,
operator|&
name|tnes
argument_list|,
name|p
argument_list|,
operator|&
name|dirp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|dp
condition|)
name|vrele
argument_list|(
name|dp
argument_list|)
expr_stmt|;
name|nfsvno_relpathbuf
argument_list|(
operator|&
name|named
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|dirp
condition|)
block|{
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV2
condition|)
block|{
name|vrele
argument_list|(
name|dirp
argument_list|)
expr_stmt|;
name|dirp
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|dirfor_ret
operator|=
name|nfsvno_getattr
argument_list|(
name|dirp
argument_list|,
operator|&
name|dirfor
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_link
argument_list|(
operator|&
name|named
argument_list|,
name|vp
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
name|exp
argument_list|)
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV3
condition|)
name|getret
operator|=
name|nfsvno_getattr
argument_list|(
name|vp
argument_list|,
operator|&
name|at
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|dirp
condition|)
block|{
name|diraft_ret
operator|=
name|nfsvno_getattr
argument_list|(
name|dirp
argument_list|,
operator|&
name|diraft
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|vrele
argument_list|(
name|dirp
argument_list|)
expr_stmt|;
block|}
name|vrele
argument_list|(
name|vp
argument_list|)
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV3
condition|)
block|{
name|nfsrv_postopattr
argument_list|(
name|nd
argument_list|,
name|getret
argument_list|,
operator|&
name|at
argument_list|)
expr_stmt|;
name|nfsrv_wcc
argument_list|(
name|nd
argument_list|,
name|dirfor_ret
argument_list|,
operator|&
name|dirfor
argument_list|,
name|diraft_ret
argument_list|,
operator|&
name|diraft
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV4
operator|)
operator|&&
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|NFSM_BUILD
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
literal|5
operator|*
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
name|newnfs_false
expr_stmt|;
name|txdr_hyper
argument_list|(
name|dirfor
operator|.
name|na_filerev
argument_list|,
name|tl
argument_list|)
expr_stmt|;
name|tl
operator|+=
literal|2
expr_stmt|;
name|txdr_hyper
argument_list|(
name|diraft
operator|.
name|na_filerev
argument_list|,
name|tl
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * nfs symbolic link service  */
end_comment

begin_function
name|APPLESTATIC
name|int
name|nfsrvd_symlink
parameter_list|(
name|struct
name|nfsrv_descript
modifier|*
name|nd
parameter_list|,
name|__unused
name|int
name|isdgram
parameter_list|,
name|vnode_t
name|dp
parameter_list|,
name|vnode_t
modifier|*
name|vpp
parameter_list|,
name|fhandle_t
modifier|*
name|fhp
parameter_list|,
name|NFSPROC_T
modifier|*
name|p
parameter_list|,
name|struct
name|nfsexstuff
modifier|*
name|exp
parameter_list|)
block|{
name|struct
name|nfsvattr
name|nva
decl_stmt|,
name|dirfor
decl_stmt|,
name|diraft
decl_stmt|;
name|struct
name|nameidata
name|named
decl_stmt|;
name|int
name|error
decl_stmt|,
name|dirfor_ret
init|=
literal|1
decl_stmt|,
name|diraft_ret
init|=
literal|1
decl_stmt|,
name|pathlen
decl_stmt|;
name|vnode_t
name|dirp
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|bufp
decl_stmt|,
modifier|*
name|pathcp
init|=
name|NULL
decl_stmt|;
name|u_long
modifier|*
name|hashp
decl_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|nfsrv_wcc
argument_list|(
name|nd
argument_list|,
name|dirfor_ret
argument_list|,
operator|&
name|dirfor
argument_list|,
name|diraft_ret
argument_list|,
operator|&
name|diraft
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|vpp
condition|)
operator|*
name|vpp
operator|=
name|NULL
expr_stmt|;
name|NFSVNO_ATTRINIT
argument_list|(
operator|&
name|nva
argument_list|)
expr_stmt|;
name|NFSNAMEICNDSET
argument_list|(
operator|&
name|named
operator|.
name|ni_cnd
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|CREATE
argument_list|,
name|LOCKPARENT
operator||
name|SAVESTART
argument_list|)
expr_stmt|;
name|nfsvno_setpathbuf
argument_list|(
operator|&
name|named
argument_list|,
operator|&
name|bufp
argument_list|,
operator|&
name|hashp
argument_list|)
expr_stmt|;
name|error
operator|=
name|nfsrv_parsename
argument_list|(
name|nd
argument_list|,
name|bufp
argument_list|,
name|hashp
argument_list|,
operator|&
name|named
operator|.
name|ni_pathlen
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
operator|&&
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
name|error
operator|=
name|nfsvno_getsymlink
argument_list|(
name|nd
argument_list|,
operator|&
name|nva
argument_list|,
name|p
argument_list|,
operator|&
name|pathcp
argument_list|,
operator|&
name|pathlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|vrele
argument_list|(
name|dp
argument_list|)
expr_stmt|;
name|nfsvno_relpathbuf
argument_list|(
operator|&
name|named
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_namei
argument_list|(
name|nd
argument_list|,
operator|&
name|named
argument_list|,
name|dp
argument_list|,
literal|0
argument_list|,
name|exp
argument_list|,
name|p
argument_list|,
operator|&
name|dirp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|vrele
argument_list|(
name|dp
argument_list|)
expr_stmt|;
name|nfsvno_relpathbuf
argument_list|(
operator|&
name|named
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dirp
operator|!=
name|NULL
operator|&&
operator|!
operator|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV3
operator|)
condition|)
block|{
name|vrele
argument_list|(
name|dirp
argument_list|)
expr_stmt|;
name|dirp
operator|=
name|NULL
expr_stmt|;
block|}
comment|/* 	 * And call nfsrvd_symlinksub() to do the common code. It will 	 * return EBADRPC upon a parsing error, 0 otherwise. 	 */
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
block|{
if|if
condition|(
name|dirp
operator|!=
name|NULL
condition|)
name|dirfor_ret
operator|=
name|nfsvno_getattr
argument_list|(
name|dirp
argument_list|,
operator|&
name|dirfor
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|nfsrvd_symlinksub
argument_list|(
name|nd
argument_list|,
operator|&
name|named
argument_list|,
operator|&
name|nva
argument_list|,
name|fhp
argument_list|,
name|vpp
argument_list|,
name|dirp
argument_list|,
operator|&
name|dirfor
argument_list|,
operator|&
name|diraft
argument_list|,
operator|&
name|diraft_ret
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|p
argument_list|,
name|exp
argument_list|,
name|pathcp
argument_list|,
name|pathlen
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|dirp
operator|!=
name|NULL
condition|)
block|{
name|dirfor_ret
operator|=
name|nfsvno_getattr
argument_list|(
name|dirp
argument_list|,
operator|&
name|dirfor
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|vrele
argument_list|(
name|dirp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pathcp
condition|)
name|FREE
argument_list|(
name|pathcp
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV3
condition|)
block|{
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
block|{
operator|(
name|void
operator|)
name|nfsm_fhtom
argument_list|(
name|nd
argument_list|,
operator|(
name|u_int8_t
operator|*
operator|)
name|fhp
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|nfsrv_postopattr
argument_list|(
name|nd
argument_list|,
literal|0
argument_list|,
operator|&
name|nva
argument_list|)
expr_stmt|;
block|}
name|nfsrv_wcc
argument_list|(
name|nd
argument_list|,
name|dirfor_ret
argument_list|,
operator|&
name|dirfor
argument_list|,
name|diraft_ret
argument_list|,
operator|&
name|diraft
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Common code for creating a symbolic link.  */
end_comment

begin_function
specifier|static
name|void
name|nfsrvd_symlinksub
parameter_list|(
name|struct
name|nfsrv_descript
modifier|*
name|nd
parameter_list|,
name|struct
name|nameidata
modifier|*
name|ndp
parameter_list|,
name|struct
name|nfsvattr
modifier|*
name|nvap
parameter_list|,
name|fhandle_t
modifier|*
name|fhp
parameter_list|,
name|vnode_t
modifier|*
name|vpp
parameter_list|,
name|vnode_t
name|dirp
parameter_list|,
name|struct
name|nfsvattr
modifier|*
name|dirforp
parameter_list|,
name|struct
name|nfsvattr
modifier|*
name|diraftp
parameter_list|,
name|int
modifier|*
name|diraft_retp
parameter_list|,
name|nfsattrbit_t
modifier|*
name|attrbitp
parameter_list|,
name|NFSACL_T
modifier|*
name|aclp
parameter_list|,
name|NFSPROC_T
modifier|*
name|p
parameter_list|,
name|struct
name|nfsexstuff
modifier|*
name|exp
parameter_list|,
name|char
modifier|*
name|pathcp
parameter_list|,
name|int
name|pathlen
parameter_list|)
block|{
name|u_int32_t
modifier|*
name|tl
decl_stmt|;
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_symlink
argument_list|(
name|ndp
argument_list|,
name|nvap
argument_list|,
name|pathcp
argument_list|,
name|pathlen
argument_list|,
operator|!
operator|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV2
operator|)
argument_list|,
name|nd
operator|->
name|nd_saveduid
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
name|exp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
operator|&&
operator|!
operator|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV2
operator|)
condition|)
block|{
name|nfsrv_fixattr
argument_list|(
name|nd
argument_list|,
name|ndp
operator|->
name|ni_vp
argument_list|,
name|nvap
argument_list|,
name|aclp
argument_list|,
name|p
argument_list|,
name|attrbitp
argument_list|,
name|exp
argument_list|)
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV3
condition|)
block|{
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_getfh
argument_list|(
name|ndp
operator|->
name|ni_vp
argument_list|,
name|fhp
argument_list|,
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_getattr
argument_list|(
name|ndp
operator|->
name|ni_vp
argument_list|,
name|nvap
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|vpp
operator|!=
name|NULL
operator|&&
name|nd
operator|->
name|nd_repstat
operator|==
literal|0
condition|)
block|{
name|VOP_UNLOCK
argument_list|(
name|ndp
operator|->
name|ni_vp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|*
name|vpp
operator|=
name|ndp
operator|->
name|ni_vp
expr_stmt|;
block|}
else|else
name|vput
argument_list|(
name|ndp
operator|->
name|ni_vp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dirp
condition|)
block|{
operator|*
name|diraft_retp
operator|=
name|nfsvno_getattr
argument_list|(
name|dirp
argument_list|,
name|diraftp
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|vrele
argument_list|(
name|dirp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV4
operator|)
operator|&&
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|NFSM_BUILD
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
literal|5
operator|*
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
name|newnfs_false
expr_stmt|;
name|txdr_hyper
argument_list|(
name|dirforp
operator|->
name|na_filerev
argument_list|,
name|tl
argument_list|)
expr_stmt|;
name|tl
operator|+=
literal|2
expr_stmt|;
name|txdr_hyper
argument_list|(
name|diraftp
operator|->
name|na_filerev
argument_list|,
name|tl
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|nfsrv_putattrbit
argument_list|(
name|nd
argument_list|,
name|attrbitp
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * nfs mkdir service  */
end_comment

begin_function
name|APPLESTATIC
name|int
name|nfsrvd_mkdir
parameter_list|(
name|struct
name|nfsrv_descript
modifier|*
name|nd
parameter_list|,
name|__unused
name|int
name|isdgram
parameter_list|,
name|vnode_t
name|dp
parameter_list|,
name|vnode_t
modifier|*
name|vpp
parameter_list|,
name|fhandle_t
modifier|*
name|fhp
parameter_list|,
name|NFSPROC_T
modifier|*
name|p
parameter_list|,
name|struct
name|nfsexstuff
modifier|*
name|exp
parameter_list|)
block|{
name|struct
name|nfsvattr
name|nva
decl_stmt|,
name|dirfor
decl_stmt|,
name|diraft
decl_stmt|;
name|struct
name|nameidata
name|named
decl_stmt|;
name|u_int32_t
modifier|*
name|tl
decl_stmt|;
name|int
name|error
decl_stmt|,
name|dirfor_ret
init|=
literal|1
decl_stmt|,
name|diraft_ret
init|=
literal|1
decl_stmt|;
name|vnode_t
name|dirp
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|bufp
decl_stmt|;
name|u_long
modifier|*
name|hashp
decl_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|nfsrv_wcc
argument_list|(
name|nd
argument_list|,
name|dirfor_ret
argument_list|,
operator|&
name|dirfor
argument_list|,
name|diraft_ret
argument_list|,
operator|&
name|diraft
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|NFSNAMEICNDSET
argument_list|(
operator|&
name|named
operator|.
name|ni_cnd
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|CREATE
argument_list|,
name|LOCKPARENT
operator||
name|SAVENAME
argument_list|)
expr_stmt|;
name|nfsvno_setpathbuf
argument_list|(
operator|&
name|named
argument_list|,
operator|&
name|bufp
argument_list|,
operator|&
name|hashp
argument_list|)
expr_stmt|;
name|error
operator|=
name|nfsrv_parsename
argument_list|(
name|nd
argument_list|,
name|bufp
argument_list|,
name|hashp
argument_list|,
operator|&
name|named
operator|.
name|ni_pathlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|vrele
argument_list|(
name|dp
argument_list|)
expr_stmt|;
name|nfsvno_relpathbuf
argument_list|(
operator|&
name|named
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|NFSVNO_ATTRINIT
argument_list|(
operator|&
name|nva
argument_list|)
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV3
condition|)
block|{
name|error
operator|=
name|nfsrv_sattr
argument_list|(
name|nd
argument_list|,
operator|&
name|nva
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|vrele
argument_list|(
name|dp
argument_list|)
expr_stmt|;
name|nfsvno_relpathbuf
argument_list|(
operator|&
name|named
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
block|}
else|else
block|{
name|NFSM_DISSECT
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|nva
operator|.
name|na_mode
operator|=
name|nfstov_mode
argument_list|(
operator|*
name|tl
operator|++
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_namei
argument_list|(
name|nd
argument_list|,
operator|&
name|named
argument_list|,
name|dp
argument_list|,
literal|0
argument_list|,
name|exp
argument_list|,
name|p
argument_list|,
operator|&
name|dirp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|vrele
argument_list|(
name|dp
argument_list|)
expr_stmt|;
name|nfsvno_relpathbuf
argument_list|(
operator|&
name|named
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dirp
operator|!=
name|NULL
operator|&&
operator|!
operator|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV3
operator|)
condition|)
block|{
name|vrele
argument_list|(
name|dirp
argument_list|)
expr_stmt|;
name|dirp
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|nd
operator|->
name|nd_repstat
condition|)
block|{
if|if
condition|(
name|dirp
operator|!=
name|NULL
condition|)
block|{
name|dirfor_ret
operator|=
name|nfsvno_getattr
argument_list|(
name|dirp
argument_list|,
operator|&
name|dirfor
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|vrele
argument_list|(
name|dirp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV3
condition|)
name|nfsrv_wcc
argument_list|(
name|nd
argument_list|,
name|dirfor_ret
argument_list|,
operator|&
name|dirfor
argument_list|,
name|diraft_ret
argument_list|,
operator|&
name|diraft
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|dirp
operator|!=
name|NULL
condition|)
name|dirfor_ret
operator|=
name|nfsvno_getattr
argument_list|(
name|dirp
argument_list|,
operator|&
name|dirfor
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* 	 * Call nfsrvd_mkdirsub() for the code common to V4 as well. 	 */
name|nfsrvd_mkdirsub
argument_list|(
name|nd
argument_list|,
operator|&
name|named
argument_list|,
operator|&
name|nva
argument_list|,
name|fhp
argument_list|,
name|vpp
argument_list|,
name|dirp
argument_list|,
operator|&
name|dirfor
argument_list|,
operator|&
name|diraft
argument_list|,
operator|&
name|diraft_ret
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|p
argument_list|,
name|exp
argument_list|)
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV3
condition|)
block|{
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
block|{
operator|(
name|void
operator|)
name|nfsm_fhtom
argument_list|(
name|nd
argument_list|,
operator|(
name|u_int8_t
operator|*
operator|)
name|fhp
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|nfsrv_postopattr
argument_list|(
name|nd
argument_list|,
literal|0
argument_list|,
operator|&
name|nva
argument_list|)
expr_stmt|;
block|}
name|nfsrv_wcc
argument_list|(
name|nd
argument_list|,
name|dirfor_ret
argument_list|,
operator|&
name|dirfor
argument_list|,
name|diraft_ret
argument_list|,
operator|&
name|diraft
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
block|{
operator|(
name|void
operator|)
name|nfsm_fhtom
argument_list|(
name|nd
argument_list|,
operator|(
name|u_int8_t
operator|*
operator|)
name|fhp
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|nfsrv_fillattr
argument_list|(
name|nd
argument_list|,
operator|&
name|nva
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|nfsmout
label|:
name|vrele
argument_list|(
name|dp
argument_list|)
expr_stmt|;
name|nfsvno_relpathbuf
argument_list|(
operator|&
name|named
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Code common to mkdir for V2,3 and 4.  */
end_comment

begin_function
specifier|static
name|void
name|nfsrvd_mkdirsub
parameter_list|(
name|struct
name|nfsrv_descript
modifier|*
name|nd
parameter_list|,
name|struct
name|nameidata
modifier|*
name|ndp
parameter_list|,
name|struct
name|nfsvattr
modifier|*
name|nvap
parameter_list|,
name|fhandle_t
modifier|*
name|fhp
parameter_list|,
name|vnode_t
modifier|*
name|vpp
parameter_list|,
name|vnode_t
name|dirp
parameter_list|,
name|struct
name|nfsvattr
modifier|*
name|dirforp
parameter_list|,
name|struct
name|nfsvattr
modifier|*
name|diraftp
parameter_list|,
name|int
modifier|*
name|diraft_retp
parameter_list|,
name|nfsattrbit_t
modifier|*
name|attrbitp
parameter_list|,
name|NFSACL_T
modifier|*
name|aclp
parameter_list|,
name|NFSPROC_T
modifier|*
name|p
parameter_list|,
name|struct
name|nfsexstuff
modifier|*
name|exp
parameter_list|)
block|{
name|vnode_t
name|vp
decl_stmt|;
name|u_int32_t
modifier|*
name|tl
decl_stmt|;
name|NFSVNO_SETATTRVAL
argument_list|(
name|nvap
argument_list|,
name|type
argument_list|,
name|VDIR
argument_list|)
expr_stmt|;
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_mkdir
argument_list|(
name|ndp
argument_list|,
name|nvap
argument_list|,
name|nd
operator|->
name|nd_saveduid
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
name|exp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|vp
operator|=
name|ndp
operator|->
name|ni_vp
expr_stmt|;
name|nfsrv_fixattr
argument_list|(
name|nd
argument_list|,
name|vp
argument_list|,
name|nvap
argument_list|,
name|aclp
argument_list|,
name|p
argument_list|,
name|attrbitp
argument_list|,
name|exp
argument_list|)
expr_stmt|;
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_getfh
argument_list|(
name|vp
argument_list|,
name|fhp
argument_list|,
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV4
operator|)
operator|&&
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_getattr
argument_list|(
name|vp
argument_list|,
name|nvap
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|vpp
operator|&&
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|NFSVOPUNLOCK
argument_list|(
name|vp
argument_list|,
literal|0
argument_list|,
name|p
argument_list|)
expr_stmt|;
operator|*
name|vpp
operator|=
name|vp
expr_stmt|;
block|}
else|else
block|{
name|vput
argument_list|(
name|vp
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|dirp
condition|)
block|{
operator|*
name|diraft_retp
operator|=
name|nfsvno_getattr
argument_list|(
name|dirp
argument_list|,
name|diraftp
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|vrele
argument_list|(
name|dirp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV4
operator|)
operator|&&
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|NFSM_BUILD
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
literal|5
operator|*
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
name|newnfs_false
expr_stmt|;
name|txdr_hyper
argument_list|(
name|dirforp
operator|->
name|na_filerev
argument_list|,
name|tl
argument_list|)
expr_stmt|;
name|tl
operator|+=
literal|2
expr_stmt|;
name|txdr_hyper
argument_list|(
name|diraftp
operator|->
name|na_filerev
argument_list|,
name|tl
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|nfsrv_putattrbit
argument_list|(
name|nd
argument_list|,
name|attrbitp
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * nfs commit service  */
end_comment

begin_function
name|APPLESTATIC
name|int
name|nfsrvd_commit
parameter_list|(
name|struct
name|nfsrv_descript
modifier|*
name|nd
parameter_list|,
name|__unused
name|int
name|isdgram
parameter_list|,
name|vnode_t
name|vp
parameter_list|,
name|NFSPROC_T
modifier|*
name|p
parameter_list|,
name|__unused
name|struct
name|nfsexstuff
modifier|*
name|exp
parameter_list|)
block|{
name|struct
name|nfsvattr
name|bfor
decl_stmt|,
name|aft
decl_stmt|;
name|u_int32_t
modifier|*
name|tl
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|,
name|for_ret
init|=
literal|1
decl_stmt|,
name|aft_ret
init|=
literal|1
decl_stmt|,
name|cnt
decl_stmt|;
name|u_int64_t
name|off
decl_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|nfsrv_wcc
argument_list|(
name|nd
argument_list|,
name|for_ret
argument_list|,
operator|&
name|bfor
argument_list|,
name|aft_ret
argument_list|,
operator|&
name|aft
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|NFSM_DISSECT
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
literal|3
operator|*
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
comment|/* 	 * XXX At this time VOP_FSYNC() does not accept offset and byte 	 * count parameters, so these arguments are useless (someday maybe). 	 */
name|off
operator|=
name|fxdr_hyper
argument_list|(
name|tl
argument_list|)
expr_stmt|;
name|tl
operator|+=
literal|2
expr_stmt|;
name|cnt
operator|=
name|fxdr_unsigned
argument_list|(
name|int
argument_list|,
operator|*
name|tl
argument_list|)
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV3
condition|)
name|for_ret
operator|=
name|nfsvno_getattr
argument_list|(
name|vp
argument_list|,
operator|&
name|bfor
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_fsync
argument_list|(
name|vp
argument_list|,
name|off
argument_list|,
name|cnt
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV3
condition|)
block|{
name|aft_ret
operator|=
name|nfsvno_getattr
argument_list|(
name|vp
argument_list|,
operator|&
name|aft
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|nfsrv_wcc
argument_list|(
name|nd
argument_list|,
name|for_ret
argument_list|,
operator|&
name|bfor
argument_list|,
name|aft_ret
argument_list|,
operator|&
name|aft
argument_list|)
expr_stmt|;
block|}
name|vput
argument_list|(
name|vp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|NFSM_BUILD
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
name|NFSX_VERF
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
name|txdr_unsigned
argument_list|(
name|nfsboottime
operator|.
name|tv_sec
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|=
name|txdr_unsigned
argument_list|(
name|nfsboottime
operator|.
name|tv_usec
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|nfsmout
label|:
name|vput
argument_list|(
name|vp
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * nfs statfs service  */
end_comment

begin_function
name|APPLESTATIC
name|int
name|nfsrvd_statfs
parameter_list|(
name|struct
name|nfsrv_descript
modifier|*
name|nd
parameter_list|,
name|__unused
name|int
name|isdgram
parameter_list|,
name|vnode_t
name|vp
parameter_list|,
name|NFSPROC_T
modifier|*
name|p
parameter_list|,
name|__unused
name|struct
name|nfsexstuff
modifier|*
name|exp
parameter_list|)
block|{
name|struct
name|statfs
modifier|*
name|sf
decl_stmt|;
name|u_int32_t
modifier|*
name|tl
decl_stmt|;
name|int
name|getret
init|=
literal|1
decl_stmt|;
name|struct
name|nfsvattr
name|at
decl_stmt|;
name|struct
name|statfs
name|sfs
decl_stmt|;
name|u_quad_t
name|tval
decl_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|nfsrv_postopattr
argument_list|(
name|nd
argument_list|,
name|getret
argument_list|,
operator|&
name|at
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|sf
operator|=
operator|&
name|sfs
expr_stmt|;
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_statfs
argument_list|(
name|vp
argument_list|,
name|sf
argument_list|)
expr_stmt|;
name|getret
operator|=
name|nfsvno_getattr
argument_list|(
name|vp
argument_list|,
operator|&
name|at
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|vput
argument_list|(
name|vp
argument_list|)
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV3
condition|)
name|nfsrv_postopattr
argument_list|(
name|nd
argument_list|,
name|getret
argument_list|,
operator|&
name|at
argument_list|)
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_repstat
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_NFSV2
condition|)
block|{
name|NFSM_BUILD
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
name|NFSX_V2STATFS
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
name|txdr_unsigned
argument_list|(
name|NFS_V2MAXDATA
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
name|txdr_unsigned
argument_list|(
name|sf
operator|->
name|f_bsize
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
name|txdr_unsigned
argument_list|(
name|sf
operator|->
name|f_blocks
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
name|txdr_unsigned
argument_list|(
name|sf
operator|->
name|f_bfree
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|=
name|txdr_unsigned
argument_list|(
name|sf
operator|->
name|f_bavail
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|NFSM_BUILD
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
name|NFSX_V3STATFS
argument_list|)
expr_stmt|;
name|tval
operator|=
operator|(
name|u_quad_t
operator|)
name|sf
operator|->
name|f_blocks
expr_stmt|;
name|tval
operator|*=
operator|(
name|u_quad_t
operator|)
name|sf
operator|->
name|f_bsize
expr_stmt|;
name|txdr_hyper
argument_list|(
name|tval
argument_list|,
name|tl
argument_list|)
expr_stmt|;
name|tl
operator|+=
literal|2
expr_stmt|;
name|tval
operator|=
operator|(
name|u_quad_t
operator|)
name|sf
operator|->
name|f_bfree
expr_stmt|;
name|tval
operator|*=
operator|(
name|u_quad_t
operator|)
name|sf
operator|->
name|f_bsize
expr_stmt|;
name|txdr_hyper
argument_list|(
name|tval
argument_list|,
name|tl
argument_list|)
expr_stmt|;
name|tl
operator|+=
literal|2
expr_stmt|;
name|tval
operator|=
operator|(
name|u_quad_t
operator|)
name|sf
operator|->
name|f_bavail
expr_stmt|;
name|tval
operator|*=
operator|(
name|u_quad_t
operator|)
name|sf
operator|->
name|f_bsize
expr_stmt|;
name|txdr_hyper
argument_list|(
name|tval
argument_list|,
name|tl
argument_list|)
expr_stmt|;
name|tl
operator|+=
literal|2
expr_stmt|;
name|tval
operator|=
operator|(
name|u_quad_t
operator|)
name|sf
operator|->
name|f_files
expr_stmt|;
name|txdr_hyper
argument_list|(
name|tval
argument_list|,
name|tl
argument_list|)
expr_stmt|;
name|tl
operator|+=
literal|2
expr_stmt|;
name|tval
operator|=
operator|(
name|u_quad_t
operator|)
name|sf
operator|->
name|f_ffree
expr_stmt|;
name|txdr_hyper
argument_list|(
name|tval
argument_list|,
name|tl
argument_list|)
expr_stmt|;
name|tl
operator|+=
literal|2
expr_stmt|;
name|tval
operator|=
operator|(
name|u_quad_t
operator|)
name|sf
operator|->
name|f_ffree
expr_stmt|;
name|txdr_hyper
argument_list|(
name|tval
argument_list|,
name|tl
argument_list|)
expr_stmt|;
name|tl
operator|+=
literal|2
expr_stmt|;
operator|*
name|tl
operator|=
literal|0
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * nfs fsinfo service  */
end_comment

begin_function
name|APPLESTATIC
name|int
name|nfsrvd_fsinfo
parameter_list|(
name|struct
name|nfsrv_descript
modifier|*
name|nd
parameter_list|,
name|int
name|isdgram
parameter_list|,
name|vnode_t
name|vp
parameter_list|,
name|NFSPROC_T
modifier|*
name|p
parameter_list|,
name|__unused
name|struct
name|nfsexstuff
modifier|*
name|exp
parameter_list|)
block|{
name|u_int32_t
modifier|*
name|tl
decl_stmt|;
name|struct
name|nfsfsinfo
name|fs
decl_stmt|;
name|int
name|getret
init|=
literal|1
decl_stmt|;
name|struct
name|nfsvattr
name|at
decl_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|nfsrv_postopattr
argument_list|(
name|nd
argument_list|,
name|getret
argument_list|,
operator|&
name|at
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|getret
operator|=
name|nfsvno_getattr
argument_list|(
name|vp
argument_list|,
operator|&
name|at
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|nfsvno_getfs
argument_list|(
operator|&
name|fs
argument_list|,
name|isdgram
argument_list|)
expr_stmt|;
name|vput
argument_list|(
name|vp
argument_list|)
expr_stmt|;
name|nfsrv_postopattr
argument_list|(
name|nd
argument_list|,
name|getret
argument_list|,
operator|&
name|at
argument_list|)
expr_stmt|;
name|NFSM_BUILD
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
name|NFSX_V3FSINFO
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
name|txdr_unsigned
argument_list|(
name|fs
operator|.
name|fs_rtmax
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
name|txdr_unsigned
argument_list|(
name|fs
operator|.
name|fs_rtpref
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
name|txdr_unsigned
argument_list|(
name|fs
operator|.
name|fs_rtmult
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
name|txdr_unsigned
argument_list|(
name|fs
operator|.
name|fs_wtmax
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
name|txdr_unsigned
argument_list|(
name|fs
operator|.
name|fs_wtpref
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
name|txdr_unsigned
argument_list|(
name|fs
operator|.
name|fs_wtmult
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
name|txdr_unsigned
argument_list|(
name|fs
operator|.
name|fs_dtpref
argument_list|)
expr_stmt|;
name|txdr_hyper
argument_list|(
name|fs
operator|.
name|fs_maxfilesize
argument_list|,
name|tl
argument_list|)
expr_stmt|;
name|tl
operator|+=
literal|2
expr_stmt|;
name|txdr_nfsv3time
argument_list|(
operator|&
name|fs
operator|.
name|fs_timedelta
argument_list|,
name|tl
argument_list|)
expr_stmt|;
name|tl
operator|+=
literal|2
expr_stmt|;
operator|*
name|tl
operator|=
name|txdr_unsigned
argument_list|(
name|fs
operator|.
name|fs_properties
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * nfs pathconf service  */
end_comment

begin_function
name|APPLESTATIC
name|int
name|nfsrvd_pathconf
parameter_list|(
name|struct
name|nfsrv_descript
modifier|*
name|nd
parameter_list|,
name|__unused
name|int
name|isdgram
parameter_list|,
name|vnode_t
name|vp
parameter_list|,
name|NFSPROC_T
modifier|*
name|p
parameter_list|,
name|__unused
name|struct
name|nfsexstuff
modifier|*
name|exp
parameter_list|)
block|{
name|struct
name|nfsv3_pathconf
modifier|*
name|pc
decl_stmt|;
name|int
name|getret
init|=
literal|1
decl_stmt|;
name|register_t
name|linkmax
decl_stmt|,
name|namemax
decl_stmt|,
name|chownres
decl_stmt|,
name|notrunc
decl_stmt|;
name|struct
name|nfsvattr
name|at
decl_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|nfsrv_postopattr
argument_list|(
name|nd
argument_list|,
name|getret
argument_list|,
operator|&
name|at
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_pathconf
argument_list|(
name|vp
argument_list|,
name|_PC_LINK_MAX
argument_list|,
operator|&
name|linkmax
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_pathconf
argument_list|(
name|vp
argument_list|,
name|_PC_NAME_MAX
argument_list|,
operator|&
name|namemax
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_pathconf
argument_list|(
name|vp
argument_list|,
name|_PC_CHOWN_RESTRICTED
argument_list|,
operator|&
name|chownres
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_pathconf
argument_list|(
name|vp
argument_list|,
name|_PC_NO_TRUNC
argument_list|,
operator|&
name|notrunc
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|getret
operator|=
name|nfsvno_getattr
argument_list|(
name|vp
argument_list|,
operator|&
name|at
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|vput
argument_list|(
name|vp
argument_list|)
expr_stmt|;
name|nfsrv_postopattr
argument_list|(
name|nd
argument_list|,
name|getret
argument_list|,
operator|&
name|at
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|NFSM_BUILD
argument_list|(
name|pc
argument_list|,
expr|struct
name|nfsv3_pathconf
operator|*
argument_list|,
name|NFSX_V3PATHCONF
argument_list|)
expr_stmt|;
name|pc
operator|->
name|pc_linkmax
operator|=
name|txdr_unsigned
argument_list|(
name|linkmax
argument_list|)
expr_stmt|;
name|pc
operator|->
name|pc_namemax
operator|=
name|txdr_unsigned
argument_list|(
name|namemax
argument_list|)
expr_stmt|;
name|pc
operator|->
name|pc_notrunc
operator|=
name|txdr_unsigned
argument_list|(
name|notrunc
argument_list|)
expr_stmt|;
name|pc
operator|->
name|pc_chownrestricted
operator|=
name|txdr_unsigned
argument_list|(
name|chownres
argument_list|)
expr_stmt|;
comment|/* 		 * These should probably be supported by VOP_PATHCONF(), but 		 * until msdosfs is exportable (why would you want to?), the 		 * Unix defaults should be ok. 		 */
name|pc
operator|->
name|pc_caseinsensitive
operator|=
name|newnfs_false
expr_stmt|;
name|pc
operator|->
name|pc_casepreserving
operator|=
name|newnfs_true
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * nfsv4 lock service  */
end_comment

begin_function
name|APPLESTATIC
name|int
name|nfsrvd_lock
parameter_list|(
name|struct
name|nfsrv_descript
modifier|*
name|nd
parameter_list|,
name|__unused
name|int
name|isdgram
parameter_list|,
name|vnode_t
name|vp
parameter_list|,
name|NFSPROC_T
modifier|*
name|p
parameter_list|,
name|struct
name|nfsexstuff
modifier|*
name|exp
parameter_list|)
block|{
name|u_int32_t
modifier|*
name|tl
decl_stmt|;
name|int
name|i
decl_stmt|;
name|struct
name|nfsstate
modifier|*
name|stp
init|=
name|NULL
decl_stmt|;
name|struct
name|nfslock
modifier|*
name|lop
decl_stmt|;
name|struct
name|nfslockconflict
name|cf
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|u_short
name|flags
init|=
name|NFSLCK_LOCK
decl_stmt|,
name|lflags
decl_stmt|;
name|u_int64_t
name|offset
decl_stmt|,
name|len
decl_stmt|;
name|nfsv4stateid_t
name|stateid
decl_stmt|;
name|nfsquad_t
name|clientid
decl_stmt|;
name|NFSM_DISSECT
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
literal|7
operator|*
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|i
operator|=
name|fxdr_unsigned
argument_list|(
name|int
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|i
condition|)
block|{
case|case
name|NFSV4LOCKT_READW
case|:
name|flags
operator||=
name|NFSLCK_BLOCKING
expr_stmt|;
case|case
name|NFSV4LOCKT_READ
case|:
name|lflags
operator|=
name|NFSLCK_READ
expr_stmt|;
break|break;
case|case
name|NFSV4LOCKT_WRITEW
case|:
name|flags
operator||=
name|NFSLCK_BLOCKING
expr_stmt|;
case|case
name|NFSV4LOCKT_WRITE
case|:
name|lflags
operator|=
name|NFSLCK_WRITE
expr_stmt|;
break|break;
default|default:
name|nd
operator|->
name|nd_repstat
operator|=
name|NFSERR_BADXDR
expr_stmt|;
goto|goto
name|nfsmout
goto|;
block|}
empty_stmt|;
if|if
condition|(
operator|*
name|tl
operator|++
operator|==
name|newnfs_true
condition|)
name|flags
operator||=
name|NFSLCK_RECLAIM
expr_stmt|;
name|offset
operator|=
name|fxdr_hyper
argument_list|(
name|tl
argument_list|)
expr_stmt|;
name|tl
operator|+=
literal|2
expr_stmt|;
name|len
operator|=
name|fxdr_hyper
argument_list|(
name|tl
argument_list|)
expr_stmt|;
name|tl
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
operator|*
name|tl
operator|==
name|newnfs_true
condition|)
name|flags
operator||=
name|NFSLCK_OPENTOLOCK
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|NFSLCK_OPENTOLOCK
condition|)
block|{
name|NFSM_DISSECT
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
literal|5
operator|*
name|NFSX_UNSIGNED
operator|+
name|NFSX_STATEID
argument_list|)
expr_stmt|;
name|i
operator|=
name|fxdr_unsigned
argument_list|(
name|int
argument_list|,
operator|*
operator|(
name|tl
operator|+
literal|4
operator|+
operator|(
name|NFSX_STATEID
operator|/
name|NFSX_UNSIGNED
operator|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|<=
literal|0
operator|||
name|i
operator|>
name|NFSV4_OPAQUELIMIT
condition|)
block|{
name|nd
operator|->
name|nd_repstat
operator|=
name|NFSERR_BADXDR
expr_stmt|;
goto|goto
name|nfsmout
goto|;
block|}
name|MALLOC
argument_list|(
name|stp
argument_list|,
expr|struct
name|nfsstate
operator|*
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|nfsstate
argument_list|)
operator|+
name|i
argument_list|,
name|M_NFSDSTATE
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|stp
operator|->
name|ls_ownerlen
operator|=
name|i
expr_stmt|;
name|stp
operator|->
name|ls_op
operator|=
name|nd
operator|->
name|nd_rp
expr_stmt|;
name|stp
operator|->
name|ls_seq
operator|=
name|fxdr_unsigned
argument_list|(
name|int
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
expr_stmt|;
name|stp
operator|->
name|ls_stateid
operator|.
name|seqid
operator|=
name|fxdr_unsigned
argument_list|(
name|u_int32_t
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
expr_stmt|;
name|NFSBCOPY
argument_list|(
operator|(
name|caddr_t
operator|)
name|tl
argument_list|,
operator|(
name|caddr_t
operator|)
name|stp
operator|->
name|ls_stateid
operator|.
name|other
argument_list|,
name|NFSX_STATEIDOTHER
argument_list|)
expr_stmt|;
name|tl
operator|+=
operator|(
name|NFSX_STATEIDOTHER
operator|/
name|NFSX_UNSIGNED
operator|)
expr_stmt|;
name|stp
operator|->
name|ls_opentolockseq
operator|=
name|fxdr_unsigned
argument_list|(
name|int
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
expr_stmt|;
name|clientid
operator|.
name|lval
index|[
literal|0
index|]
operator|=
operator|*
name|tl
operator|++
expr_stmt|;
name|clientid
operator|.
name|lval
index|[
literal|1
index|]
operator|=
operator|*
name|tl
operator|++
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_IMPLIEDCLID
condition|)
block|{
if|if
condition|(
name|nd
operator|->
name|nd_clientid
operator|.
name|qval
operator|!=
name|clientid
operator|.
name|qval
condition|)
name|printf
argument_list|(
literal|"EEK! multiple clids\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|nd
operator|->
name|nd_flag
operator||=
name|ND_IMPLIEDCLID
expr_stmt|;
name|nd
operator|->
name|nd_clientid
operator|.
name|qval
operator|=
name|clientid
operator|.
name|qval
expr_stmt|;
block|}
name|error
operator|=
name|nfsrv_mtostr
argument_list|(
name|nd
argument_list|,
name|stp
operator|->
name|ls_owner
argument_list|,
name|stp
operator|->
name|ls_ownerlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|nfsmout
goto|;
block|}
else|else
block|{
name|NFSM_DISSECT
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
name|NFSX_STATEID
operator|+
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|MALLOC
argument_list|(
name|stp
argument_list|,
expr|struct
name|nfsstate
operator|*
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|nfsstate
argument_list|)
argument_list|,
name|M_NFSDSTATE
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|stp
operator|->
name|ls_ownerlen
operator|=
literal|0
expr_stmt|;
name|stp
operator|->
name|ls_op
operator|=
name|nd
operator|->
name|nd_rp
expr_stmt|;
name|stp
operator|->
name|ls_stateid
operator|.
name|seqid
operator|=
name|fxdr_unsigned
argument_list|(
name|u_int32_t
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
expr_stmt|;
name|NFSBCOPY
argument_list|(
operator|(
name|caddr_t
operator|)
name|tl
argument_list|,
operator|(
name|caddr_t
operator|)
name|stp
operator|->
name|ls_stateid
operator|.
name|other
argument_list|,
name|NFSX_STATEIDOTHER
argument_list|)
expr_stmt|;
name|tl
operator|+=
operator|(
name|NFSX_STATEIDOTHER
operator|/
name|NFSX_UNSIGNED
operator|)
expr_stmt|;
name|stp
operator|->
name|ls_seq
operator|=
name|fxdr_unsigned
argument_list|(
name|int
argument_list|,
operator|*
name|tl
argument_list|)
expr_stmt|;
name|clientid
operator|.
name|lval
index|[
literal|0
index|]
operator|=
name|stp
operator|->
name|ls_stateid
operator|.
name|other
index|[
literal|0
index|]
expr_stmt|;
name|clientid
operator|.
name|lval
index|[
literal|1
index|]
operator|=
name|stp
operator|->
name|ls_stateid
operator|.
name|other
index|[
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_IMPLIEDCLID
condition|)
block|{
if|if
condition|(
name|nd
operator|->
name|nd_clientid
operator|.
name|qval
operator|!=
name|clientid
operator|.
name|qval
condition|)
name|printf
argument_list|(
literal|"EEK! multiple clids\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|nd
operator|->
name|nd_flag
operator||=
name|ND_IMPLIEDCLID
expr_stmt|;
name|nd
operator|->
name|nd_clientid
operator|.
name|qval
operator|=
name|clientid
operator|.
name|qval
expr_stmt|;
block|}
block|}
name|MALLOC
argument_list|(
name|lop
argument_list|,
expr|struct
name|nfslock
operator|*
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|nfslock
argument_list|)
argument_list|,
name|M_NFSDLOCK
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|lop
operator|->
name|lo_first
operator|=
name|offset
expr_stmt|;
if|if
condition|(
name|len
operator|==
name|NFS64BITSSET
condition|)
block|{
name|lop
operator|->
name|lo_end
operator|=
name|NFS64BITSSET
expr_stmt|;
block|}
else|else
block|{
name|lop
operator|->
name|lo_end
operator|=
name|offset
operator|+
name|len
expr_stmt|;
if|if
condition|(
name|lop
operator|->
name|lo_end
operator|<=
name|lop
operator|->
name|lo_first
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|NFSERR_INVAL
expr_stmt|;
block|}
name|lop
operator|->
name|lo_flags
operator|=
name|lflags
expr_stmt|;
name|stp
operator|->
name|ls_flags
operator|=
name|flags
expr_stmt|;
name|stp
operator|->
name|ls_uid
operator|=
name|nd
operator|->
name|nd_cred
operator|->
name|cr_uid
expr_stmt|;
comment|/* 	 * Do basic access checking. 	 */
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
operator|&&
name|vnode_vtype
argument_list|(
name|vp
argument_list|)
operator|!=
name|VREG
condition|)
block|{
if|if
condition|(
name|vnode_vtype
argument_list|(
name|vp
argument_list|)
operator|==
name|VDIR
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|NFSERR_ISDIR
expr_stmt|;
else|else
name|nd
operator|->
name|nd_repstat
operator|=
name|NFSERR_INVAL
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
block|{
if|if
condition|(
name|lflags
operator|&
name|NFSLCK_WRITE
condition|)
block|{
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_accchk
argument_list|(
name|vp
argument_list|,
name|VWRITE
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|exp
argument_list|,
name|p
argument_list|,
name|NFSACCCHK_ALLOWOWNER
argument_list|,
name|NFSACCCHK_VPISLOCKED
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_accchk
argument_list|(
name|vp
argument_list|,
name|VREAD
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|exp
argument_list|,
name|p
argument_list|,
name|NFSACCCHK_ALLOWOWNER
argument_list|,
name|NFSACCCHK_VPISLOCKED
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_repstat
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_accchk
argument_list|(
name|vp
argument_list|,
name|VEXEC
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|exp
argument_list|,
name|p
argument_list|,
name|NFSACCCHK_ALLOWOWNER
argument_list|,
name|NFSACCCHK_VPISLOCKED
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* 	 * We call nfsrv_lockctrl() even if nd_repstat set, so that the 	 * seqid# gets updated. nfsrv_lockctrl() will return the value 	 * of nd_repstat, if it gets that far. 	 */
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsrv_lockctrl
argument_list|(
name|vp
argument_list|,
operator|&
name|stp
argument_list|,
operator|&
name|lop
argument_list|,
operator|&
name|cf
argument_list|,
name|clientid
argument_list|,
operator|&
name|stateid
argument_list|,
name|exp
argument_list|,
name|nd
argument_list|,
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|lop
condition|)
name|FREE
argument_list|(
operator|(
name|caddr_t
operator|)
name|lop
argument_list|,
name|M_NFSDLOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|stp
condition|)
name|FREE
argument_list|(
operator|(
name|caddr_t
operator|)
name|stp
argument_list|,
name|M_NFSDSTATE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|NFSM_BUILD
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
name|NFSX_STATEID
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
name|txdr_unsigned
argument_list|(
name|stateid
operator|.
name|seqid
argument_list|)
expr_stmt|;
name|NFSBCOPY
argument_list|(
operator|(
name|caddr_t
operator|)
name|stateid
operator|.
name|other
argument_list|,
operator|(
name|caddr_t
operator|)
name|tl
argument_list|,
name|NFSX_STATEIDOTHER
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|nd
operator|->
name|nd_repstat
operator|==
name|NFSERR_DENIED
condition|)
block|{
name|NFSM_BUILD
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
literal|7
operator|*
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|txdr_hyper
argument_list|(
name|cf
operator|.
name|cl_first
argument_list|,
name|tl
argument_list|)
expr_stmt|;
name|tl
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|cf
operator|.
name|cl_end
operator|==
name|NFS64BITSSET
condition|)
name|len
operator|=
name|NFS64BITSSET
expr_stmt|;
else|else
name|len
operator|=
name|cf
operator|.
name|cl_end
operator|-
name|cf
operator|.
name|cl_first
expr_stmt|;
name|txdr_hyper
argument_list|(
name|len
argument_list|,
name|tl
argument_list|)
expr_stmt|;
name|tl
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|cf
operator|.
name|cl_flags
operator|==
name|NFSLCK_WRITE
condition|)
operator|*
name|tl
operator|++
operator|=
name|txdr_unsigned
argument_list|(
name|NFSV4LOCKT_WRITE
argument_list|)
expr_stmt|;
else|else
operator|*
name|tl
operator|++
operator|=
name|txdr_unsigned
argument_list|(
name|NFSV4LOCKT_READ
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
name|stateid
operator|.
name|other
index|[
literal|0
index|]
expr_stmt|;
operator|*
name|tl
operator|=
name|stateid
operator|.
name|other
index|[
literal|1
index|]
expr_stmt|;
operator|(
name|void
operator|)
name|nfsm_strtom
argument_list|(
name|nd
argument_list|,
name|cf
operator|.
name|cl_owner
argument_list|,
name|cf
operator|.
name|cl_ownerlen
argument_list|)
expr_stmt|;
block|}
name|vput
argument_list|(
name|vp
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|nfsmout
label|:
name|vput
argument_list|(
name|vp
argument_list|)
expr_stmt|;
if|if
condition|(
name|stp
condition|)
name|free
argument_list|(
operator|(
name|caddr_t
operator|)
name|stp
argument_list|,
name|M_NFSDSTATE
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * nfsv4 lock test service  */
end_comment

begin_function
name|APPLESTATIC
name|int
name|nfsrvd_lockt
parameter_list|(
name|struct
name|nfsrv_descript
modifier|*
name|nd
parameter_list|,
name|__unused
name|int
name|isdgram
parameter_list|,
name|vnode_t
name|vp
parameter_list|,
name|NFSPROC_T
modifier|*
name|p
parameter_list|,
name|struct
name|nfsexstuff
modifier|*
name|exp
parameter_list|)
block|{
name|u_int32_t
modifier|*
name|tl
decl_stmt|;
name|int
name|i
decl_stmt|;
name|struct
name|nfsstate
modifier|*
name|stp
init|=
name|NULL
decl_stmt|;
name|struct
name|nfslock
name|lo
decl_stmt|,
modifier|*
name|lop
init|=
operator|&
name|lo
decl_stmt|;
name|struct
name|nfslockconflict
name|cf
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|nfsv4stateid_t
name|stateid
decl_stmt|;
name|nfsquad_t
name|clientid
decl_stmt|;
name|u_int64_t
name|len
decl_stmt|;
name|NFSM_DISSECT
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
literal|8
operator|*
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|i
operator|=
name|fxdr_unsigned
argument_list|(
name|int
argument_list|,
operator|*
operator|(
name|tl
operator|+
literal|7
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|<=
literal|0
operator|||
name|i
operator|>
name|NFSV4_OPAQUELIMIT
condition|)
block|{
name|nd
operator|->
name|nd_repstat
operator|=
name|NFSERR_BADXDR
expr_stmt|;
goto|goto
name|nfsmout
goto|;
block|}
name|MALLOC
argument_list|(
name|stp
argument_list|,
expr|struct
name|nfsstate
operator|*
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|nfsstate
argument_list|)
operator|+
name|i
argument_list|,
name|M_NFSDSTATE
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|stp
operator|->
name|ls_ownerlen
operator|=
name|i
expr_stmt|;
name|stp
operator|->
name|ls_op
operator|=
name|NULL
expr_stmt|;
name|stp
operator|->
name|ls_flags
operator|=
name|NFSLCK_TEST
expr_stmt|;
name|stp
operator|->
name|ls_uid
operator|=
name|nd
operator|->
name|nd_cred
operator|->
name|cr_uid
expr_stmt|;
name|i
operator|=
name|fxdr_unsigned
argument_list|(
name|int
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|i
condition|)
block|{
case|case
name|NFSV4LOCKT_READW
case|:
name|stp
operator|->
name|ls_flags
operator||=
name|NFSLCK_BLOCKING
expr_stmt|;
case|case
name|NFSV4LOCKT_READ
case|:
name|lo
operator|.
name|lo_flags
operator|=
name|NFSLCK_READ
expr_stmt|;
break|break;
case|case
name|NFSV4LOCKT_WRITEW
case|:
name|stp
operator|->
name|ls_flags
operator||=
name|NFSLCK_BLOCKING
expr_stmt|;
case|case
name|NFSV4LOCKT_WRITE
case|:
name|lo
operator|.
name|lo_flags
operator|=
name|NFSLCK_WRITE
expr_stmt|;
break|break;
default|default:
name|nd
operator|->
name|nd_repstat
operator|=
name|NFSERR_BADXDR
expr_stmt|;
goto|goto
name|nfsmout
goto|;
block|}
empty_stmt|;
name|lo
operator|.
name|lo_first
operator|=
name|fxdr_hyper
argument_list|(
name|tl
argument_list|)
expr_stmt|;
name|tl
operator|+=
literal|2
expr_stmt|;
name|len
operator|=
name|fxdr_hyper
argument_list|(
name|tl
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|==
name|NFS64BITSSET
condition|)
block|{
name|lo
operator|.
name|lo_end
operator|=
name|NFS64BITSSET
expr_stmt|;
block|}
else|else
block|{
name|lo
operator|.
name|lo_end
operator|=
name|lo
operator|.
name|lo_first
operator|+
name|len
expr_stmt|;
if|if
condition|(
name|lo
operator|.
name|lo_end
operator|<=
name|lo
operator|.
name|lo_first
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|NFSERR_INVAL
expr_stmt|;
block|}
name|tl
operator|+=
literal|2
expr_stmt|;
name|clientid
operator|.
name|lval
index|[
literal|0
index|]
operator|=
operator|*
name|tl
operator|++
expr_stmt|;
name|clientid
operator|.
name|lval
index|[
literal|1
index|]
operator|=
operator|*
name|tl
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_IMPLIEDCLID
condition|)
block|{
if|if
condition|(
name|nd
operator|->
name|nd_clientid
operator|.
name|qval
operator|!=
name|clientid
operator|.
name|qval
condition|)
name|printf
argument_list|(
literal|"EEK! multiple clids\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|nd
operator|->
name|nd_flag
operator||=
name|ND_IMPLIEDCLID
expr_stmt|;
name|nd
operator|->
name|nd_clientid
operator|.
name|qval
operator|=
name|clientid
operator|.
name|qval
expr_stmt|;
block|}
name|error
operator|=
name|nfsrv_mtostr
argument_list|(
name|nd
argument_list|,
name|stp
operator|->
name|ls_owner
argument_list|,
name|stp
operator|->
name|ls_ownerlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|nfsmout
goto|;
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
operator|&&
name|vnode_vtype
argument_list|(
name|vp
argument_list|)
operator|!=
name|VREG
condition|)
block|{
if|if
condition|(
name|vnode_vtype
argument_list|(
name|vp
argument_list|)
operator|==
name|VDIR
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|NFSERR_ISDIR
expr_stmt|;
else|else
name|nd
operator|->
name|nd_repstat
operator|=
name|NFSERR_INVAL
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsrv_lockctrl
argument_list|(
name|vp
argument_list|,
operator|&
name|stp
argument_list|,
operator|&
name|lop
argument_list|,
operator|&
name|cf
argument_list|,
name|clientid
argument_list|,
operator|&
name|stateid
argument_list|,
name|exp
argument_list|,
name|nd
argument_list|,
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|stp
condition|)
name|FREE
argument_list|(
operator|(
name|caddr_t
operator|)
name|stp
argument_list|,
name|M_NFSDSTATE
argument_list|)
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_repstat
condition|)
block|{
if|if
condition|(
name|nd
operator|->
name|nd_repstat
operator|==
name|NFSERR_DENIED
condition|)
block|{
name|NFSM_BUILD
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
literal|7
operator|*
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|txdr_hyper
argument_list|(
name|cf
operator|.
name|cl_first
argument_list|,
name|tl
argument_list|)
expr_stmt|;
name|tl
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|cf
operator|.
name|cl_end
operator|==
name|NFS64BITSSET
condition|)
name|len
operator|=
name|NFS64BITSSET
expr_stmt|;
else|else
name|len
operator|=
name|cf
operator|.
name|cl_end
operator|-
name|cf
operator|.
name|cl_first
expr_stmt|;
name|txdr_hyper
argument_list|(
name|len
argument_list|,
name|tl
argument_list|)
expr_stmt|;
name|tl
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|cf
operator|.
name|cl_flags
operator|==
name|NFSLCK_WRITE
condition|)
operator|*
name|tl
operator|++
operator|=
name|txdr_unsigned
argument_list|(
name|NFSV4LOCKT_WRITE
argument_list|)
expr_stmt|;
else|else
operator|*
name|tl
operator|++
operator|=
name|txdr_unsigned
argument_list|(
name|NFSV4LOCKT_READ
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
name|stp
operator|->
name|ls_stateid
operator|.
name|other
index|[
literal|0
index|]
expr_stmt|;
operator|*
name|tl
operator|=
name|stp
operator|->
name|ls_stateid
operator|.
name|other
index|[
literal|1
index|]
expr_stmt|;
operator|(
name|void
operator|)
name|nfsm_strtom
argument_list|(
name|nd
argument_list|,
name|cf
operator|.
name|cl_owner
argument_list|,
name|cf
operator|.
name|cl_ownerlen
argument_list|)
expr_stmt|;
block|}
block|}
name|vput
argument_list|(
name|vp
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|nfsmout
label|:
name|vput
argument_list|(
name|vp
argument_list|)
expr_stmt|;
if|if
condition|(
name|stp
condition|)
name|free
argument_list|(
operator|(
name|caddr_t
operator|)
name|stp
argument_list|,
name|M_NFSDSTATE
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * nfsv4 unlock service  */
end_comment

begin_function
name|APPLESTATIC
name|int
name|nfsrvd_locku
parameter_list|(
name|struct
name|nfsrv_descript
modifier|*
name|nd
parameter_list|,
name|__unused
name|int
name|isdgram
parameter_list|,
name|vnode_t
name|vp
parameter_list|,
name|NFSPROC_T
modifier|*
name|p
parameter_list|,
name|struct
name|nfsexstuff
modifier|*
name|exp
parameter_list|)
block|{
name|u_int32_t
modifier|*
name|tl
decl_stmt|;
name|int
name|i
decl_stmt|;
name|struct
name|nfsstate
modifier|*
name|stp
decl_stmt|;
name|struct
name|nfslock
modifier|*
name|lop
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|nfsv4stateid_t
name|stateid
decl_stmt|;
name|nfsquad_t
name|clientid
decl_stmt|;
name|u_int64_t
name|len
decl_stmt|;
name|NFSM_DISSECT
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
literal|6
operator|*
name|NFSX_UNSIGNED
operator|+
name|NFSX_STATEID
argument_list|)
expr_stmt|;
name|MALLOC
argument_list|(
name|stp
argument_list|,
expr|struct
name|nfsstate
operator|*
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|nfsstate
argument_list|)
argument_list|,
name|M_NFSDSTATE
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|MALLOC
argument_list|(
name|lop
argument_list|,
expr|struct
name|nfslock
operator|*
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|nfslock
argument_list|)
argument_list|,
name|M_NFSDLOCK
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|stp
operator|->
name|ls_flags
operator|=
name|NFSLCK_UNLOCK
expr_stmt|;
name|lop
operator|->
name|lo_flags
operator|=
name|NFSLCK_UNLOCK
expr_stmt|;
name|stp
operator|->
name|ls_op
operator|=
name|nd
operator|->
name|nd_rp
expr_stmt|;
name|i
operator|=
name|fxdr_unsigned
argument_list|(
name|int
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|i
condition|)
block|{
case|case
name|NFSV4LOCKT_READW
case|:
name|stp
operator|->
name|ls_flags
operator||=
name|NFSLCK_BLOCKING
expr_stmt|;
case|case
name|NFSV4LOCKT_READ
case|:
break|break;
case|case
name|NFSV4LOCKT_WRITEW
case|:
name|stp
operator|->
name|ls_flags
operator||=
name|NFSLCK_BLOCKING
expr_stmt|;
case|case
name|NFSV4LOCKT_WRITE
case|:
break|break;
default|default:
name|nd
operator|->
name|nd_repstat
operator|=
name|NFSERR_BADXDR
expr_stmt|;
name|free
argument_list|(
name|stp
argument_list|,
name|M_NFSDSTATE
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|lop
argument_list|,
name|M_NFSDLOCK
argument_list|)
expr_stmt|;
goto|goto
name|nfsmout
goto|;
block|}
empty_stmt|;
name|stp
operator|->
name|ls_ownerlen
operator|=
literal|0
expr_stmt|;
name|stp
operator|->
name|ls_uid
operator|=
name|nd
operator|->
name|nd_cred
operator|->
name|cr_uid
expr_stmt|;
name|stp
operator|->
name|ls_seq
operator|=
name|fxdr_unsigned
argument_list|(
name|int
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
expr_stmt|;
name|stp
operator|->
name|ls_stateid
operator|.
name|seqid
operator|=
name|fxdr_unsigned
argument_list|(
name|u_int32_t
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
expr_stmt|;
name|NFSBCOPY
argument_list|(
operator|(
name|caddr_t
operator|)
name|tl
argument_list|,
operator|(
name|caddr_t
operator|)
name|stp
operator|->
name|ls_stateid
operator|.
name|other
argument_list|,
name|NFSX_STATEIDOTHER
argument_list|)
expr_stmt|;
name|tl
operator|+=
operator|(
name|NFSX_STATEIDOTHER
operator|/
name|NFSX_UNSIGNED
operator|)
expr_stmt|;
name|lop
operator|->
name|lo_first
operator|=
name|fxdr_hyper
argument_list|(
name|tl
argument_list|)
expr_stmt|;
name|tl
operator|+=
literal|2
expr_stmt|;
name|len
operator|=
name|fxdr_hyper
argument_list|(
name|tl
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|==
name|NFS64BITSSET
condition|)
block|{
name|lop
operator|->
name|lo_end
operator|=
name|NFS64BITSSET
expr_stmt|;
block|}
else|else
block|{
name|lop
operator|->
name|lo_end
operator|=
name|lop
operator|->
name|lo_first
operator|+
name|len
expr_stmt|;
if|if
condition|(
name|lop
operator|->
name|lo_end
operator|<=
name|lop
operator|->
name|lo_first
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|NFSERR_INVAL
expr_stmt|;
block|}
name|clientid
operator|.
name|lval
index|[
literal|0
index|]
operator|=
name|stp
operator|->
name|ls_stateid
operator|.
name|other
index|[
literal|0
index|]
expr_stmt|;
name|clientid
operator|.
name|lval
index|[
literal|1
index|]
operator|=
name|stp
operator|->
name|ls_stateid
operator|.
name|other
index|[
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_IMPLIEDCLID
condition|)
block|{
if|if
condition|(
name|nd
operator|->
name|nd_clientid
operator|.
name|qval
operator|!=
name|clientid
operator|.
name|qval
condition|)
name|printf
argument_list|(
literal|"EEK! multiple clids\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|nd
operator|->
name|nd_flag
operator||=
name|ND_IMPLIEDCLID
expr_stmt|;
name|nd
operator|->
name|nd_clientid
operator|.
name|qval
operator|=
name|clientid
operator|.
name|qval
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
operator|&&
name|vnode_vtype
argument_list|(
name|vp
argument_list|)
operator|!=
name|VREG
condition|)
block|{
if|if
condition|(
name|vnode_vtype
argument_list|(
name|vp
argument_list|)
operator|==
name|VDIR
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|NFSERR_ISDIR
expr_stmt|;
else|else
name|nd
operator|->
name|nd_repstat
operator|=
name|NFSERR_INVAL
expr_stmt|;
block|}
comment|/* 	 * Call nfsrv_lockctrl() even if nd_repstat is set, so that the 	 * seqid# gets incremented. nfsrv_lockctrl() will return the 	 * value of nd_repstat, if it gets that far. 	 */
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsrv_lockctrl
argument_list|(
name|vp
argument_list|,
operator|&
name|stp
argument_list|,
operator|&
name|lop
argument_list|,
name|NULL
argument_list|,
name|clientid
argument_list|,
operator|&
name|stateid
argument_list|,
name|exp
argument_list|,
name|nd
argument_list|,
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|stp
condition|)
name|FREE
argument_list|(
operator|(
name|caddr_t
operator|)
name|stp
argument_list|,
name|M_NFSDSTATE
argument_list|)
expr_stmt|;
if|if
condition|(
name|lop
condition|)
name|free
argument_list|(
operator|(
name|caddr_t
operator|)
name|lop
argument_list|,
name|M_NFSDLOCK
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|NFSM_BUILD
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
name|NFSX_STATEID
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
name|txdr_unsigned
argument_list|(
name|stateid
operator|.
name|seqid
argument_list|)
expr_stmt|;
name|NFSBCOPY
argument_list|(
operator|(
name|caddr_t
operator|)
name|stateid
operator|.
name|other
argument_list|,
operator|(
name|caddr_t
operator|)
name|tl
argument_list|,
name|NFSX_STATEIDOTHER
argument_list|)
expr_stmt|;
block|}
name|nfsmout
label|:
name|vput
argument_list|(
name|vp
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * nfsv4 open service  */
end_comment

begin_function
name|APPLESTATIC
name|int
name|nfsrvd_open
parameter_list|(
name|struct
name|nfsrv_descript
modifier|*
name|nd
parameter_list|,
name|__unused
name|int
name|isdgram
parameter_list|,
name|vnode_t
name|dp
parameter_list|,
name|vnode_t
modifier|*
name|vpp
parameter_list|,
name|__unused
name|fhandle_t
modifier|*
name|fhp
parameter_list|,
name|NFSPROC_T
modifier|*
name|p
parameter_list|,
name|struct
name|nfsexstuff
modifier|*
name|exp
parameter_list|)
block|{
name|u_int32_t
modifier|*
name|tl
decl_stmt|;
name|int
name|i
decl_stmt|;
name|struct
name|nfsstate
modifier|*
name|stp
init|=
name|NULL
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|,
name|create
decl_stmt|,
name|claim
decl_stmt|,
name|exclusive_flag
init|=
literal|0
decl_stmt|;
name|u_int32_t
name|rflags
init|=
name|NFSV4OPEN_LOCKTYPEPOSIX
decl_stmt|,
name|acemask
decl_stmt|;
name|int
name|how
init|=
name|NFSCREATE_UNCHECKED
decl_stmt|;
name|int32_t
name|cverf
index|[
literal|2
index|]
decl_stmt|,
name|tverf
index|[
literal|2
index|]
init|=
block|{
literal|0
block|,
literal|0
block|}
decl_stmt|;
name|vnode_t
name|vp
init|=
name|NULL
decl_stmt|,
name|dirp
init|=
name|NULL
decl_stmt|;
name|struct
name|nfsvattr
name|nva
decl_stmt|,
name|dirfor
decl_stmt|,
name|diraft
decl_stmt|;
name|struct
name|nameidata
name|named
decl_stmt|;
name|nfsv4stateid_t
name|stateid
decl_stmt|,
name|delegstateid
decl_stmt|;
name|nfsattrbit_t
name|attrbits
decl_stmt|;
name|nfsquad_t
name|clientid
decl_stmt|;
name|char
modifier|*
name|bufp
init|=
name|NULL
decl_stmt|;
name|u_long
modifier|*
name|hashp
decl_stmt|;
name|NFSACL_T
modifier|*
name|aclp
init|=
name|NULL
decl_stmt|;
ifdef|#
directive|ifdef
name|NFS4_ACL_EXTATTR_NAME
name|aclp
operator|=
name|acl_alloc
argument_list|(
name|M_WAITOK
argument_list|)
expr_stmt|;
name|aclp
operator|->
name|acl_cnt
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
name|NFSZERO_ATTRBIT
argument_list|(
operator|&
name|attrbits
argument_list|)
expr_stmt|;
name|named
operator|.
name|ni_startdir
operator|=
name|NULL
expr_stmt|;
name|named
operator|.
name|ni_cnd
operator|.
name|cn_nameiop
operator|=
literal|0
expr_stmt|;
name|NFSM_DISSECT
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
literal|6
operator|*
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|i
operator|=
name|fxdr_unsigned
argument_list|(
name|int
argument_list|,
operator|*
operator|(
name|tl
operator|+
literal|5
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|<=
literal|0
operator|||
name|i
operator|>
name|NFSV4_OPAQUELIMIT
condition|)
block|{
name|nd
operator|->
name|nd_repstat
operator|=
name|NFSERR_BADXDR
expr_stmt|;
name|vrele
argument_list|(
name|dp
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|NFS4_ACL_EXTATTR_NAME
name|acl_free
argument_list|(
name|aclp
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|MALLOC
argument_list|(
name|stp
argument_list|,
expr|struct
name|nfsstate
operator|*
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|nfsstate
argument_list|)
operator|+
name|i
argument_list|,
name|M_NFSDSTATE
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|stp
operator|->
name|ls_ownerlen
operator|=
name|i
expr_stmt|;
name|stp
operator|->
name|ls_op
operator|=
name|nd
operator|->
name|nd_rp
expr_stmt|;
name|stp
operator|->
name|ls_flags
operator|=
name|NFSLCK_OPEN
expr_stmt|;
name|stp
operator|->
name|ls_uid
operator|=
name|nd
operator|->
name|nd_cred
operator|->
name|cr_uid
expr_stmt|;
name|stp
operator|->
name|ls_seq
operator|=
name|fxdr_unsigned
argument_list|(
name|u_int32_t
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
expr_stmt|;
name|i
operator|=
name|fxdr_unsigned
argument_list|(
name|int
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|i
condition|)
block|{
case|case
name|NFSV4OPEN_ACCESSREAD
case|:
name|stp
operator|->
name|ls_flags
operator||=
name|NFSLCK_READACCESS
expr_stmt|;
break|break;
case|case
name|NFSV4OPEN_ACCESSWRITE
case|:
name|stp
operator|->
name|ls_flags
operator||=
name|NFSLCK_WRITEACCESS
expr_stmt|;
break|break;
case|case
name|NFSV4OPEN_ACCESSBOTH
case|:
name|stp
operator|->
name|ls_flags
operator||=
operator|(
name|NFSLCK_READACCESS
operator||
name|NFSLCK_WRITEACCESS
operator|)
expr_stmt|;
break|break;
default|default:
name|nd
operator|->
name|nd_repstat
operator|=
name|NFSERR_INVAL
expr_stmt|;
block|}
empty_stmt|;
name|i
operator|=
name|fxdr_unsigned
argument_list|(
name|int
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|i
condition|)
block|{
case|case
name|NFSV4OPEN_DENYNONE
case|:
break|break;
case|case
name|NFSV4OPEN_DENYREAD
case|:
name|stp
operator|->
name|ls_flags
operator||=
name|NFSLCK_READDENY
expr_stmt|;
break|break;
case|case
name|NFSV4OPEN_DENYWRITE
case|:
name|stp
operator|->
name|ls_flags
operator||=
name|NFSLCK_WRITEDENY
expr_stmt|;
break|break;
case|case
name|NFSV4OPEN_DENYBOTH
case|:
name|stp
operator|->
name|ls_flags
operator||=
operator|(
name|NFSLCK_READDENY
operator||
name|NFSLCK_WRITEDENY
operator|)
expr_stmt|;
break|break;
default|default:
name|nd
operator|->
name|nd_repstat
operator|=
name|NFSERR_INVAL
expr_stmt|;
block|}
empty_stmt|;
name|clientid
operator|.
name|lval
index|[
literal|0
index|]
operator|=
operator|*
name|tl
operator|++
expr_stmt|;
name|clientid
operator|.
name|lval
index|[
literal|1
index|]
operator|=
operator|*
name|tl
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_IMPLIEDCLID
condition|)
block|{
if|if
condition|(
name|nd
operator|->
name|nd_clientid
operator|.
name|qval
operator|!=
name|clientid
operator|.
name|qval
condition|)
name|printf
argument_list|(
literal|"EEK! multiple clids\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|nd
operator|->
name|nd_flag
operator||=
name|ND_IMPLIEDCLID
expr_stmt|;
name|nd
operator|->
name|nd_clientid
operator|.
name|qval
operator|=
name|clientid
operator|.
name|qval
expr_stmt|;
block|}
name|error
operator|=
name|nfsrv_mtostr
argument_list|(
name|nd
argument_list|,
name|stp
operator|->
name|ls_owner
argument_list|,
name|stp
operator|->
name|ls_ownerlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|vrele
argument_list|(
name|dp
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|NFS4_ACL_EXTATTR_NAME
name|acl_free
argument_list|(
name|aclp
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|FREE
argument_list|(
operator|(
name|caddr_t
operator|)
name|stp
argument_list|,
name|M_NFSDSTATE
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|NFSVNO_ATTRINIT
argument_list|(
operator|&
name|nva
argument_list|)
expr_stmt|;
name|NFSM_DISSECT
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|create
operator|=
name|fxdr_unsigned
argument_list|(
name|int
argument_list|,
operator|*
name|tl
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_getattr
argument_list|(
name|dp
argument_list|,
operator|&
name|dirfor
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|create
operator|==
name|NFSV4OPEN_CREATE
condition|)
block|{
name|nva
operator|.
name|na_type
operator|=
name|VREG
expr_stmt|;
name|nva
operator|.
name|na_mode
operator|=
literal|0
expr_stmt|;
name|NFSM_DISSECT
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|how
operator|=
name|fxdr_unsigned
argument_list|(
name|int
argument_list|,
operator|*
name|tl
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|how
condition|)
block|{
case|case
name|NFSCREATE_UNCHECKED
case|:
case|case
name|NFSCREATE_GUARDED
case|:
name|error
operator|=
name|nfsv4_sattr
argument_list|(
name|nd
argument_list|,
operator|&
name|nva
argument_list|,
operator|&
name|attrbits
argument_list|,
name|aclp
argument_list|,
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|vrele
argument_list|(
name|dp
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|NFS4_ACL_EXTATTR_NAME
name|acl_free
argument_list|(
name|aclp
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|FREE
argument_list|(
operator|(
name|caddr_t
operator|)
name|stp
argument_list|,
name|M_NFSDSTATE
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
comment|/* 			 * If the na_gid being set is the same as that of 			 * the directory it is going in, clear it, since 			 * that is what will be set by default. This allows 			 * a user that isn't in that group to do the create. 			 */
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
operator|&&
name|NFSVNO_ISSETGID
argument_list|(
operator|&
name|nva
argument_list|)
operator|&&
name|nva
operator|.
name|na_gid
operator|==
name|dirfor
operator|.
name|na_gid
condition|)
name|NFSVNO_UNSET
argument_list|(
operator|&
name|nva
argument_list|,
name|gid
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsrv_checkuidgid
argument_list|(
name|nd
argument_list|,
operator|&
name|nva
argument_list|)
expr_stmt|;
break|break;
case|case
name|NFSCREATE_EXCLUSIVE
case|:
name|NFSM_DISSECT
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
name|NFSX_VERF
argument_list|)
expr_stmt|;
name|cverf
index|[
literal|0
index|]
operator|=
operator|*
name|tl
operator|++
expr_stmt|;
name|cverf
index|[
literal|1
index|]
operator|=
operator|*
name|tl
expr_stmt|;
break|break;
default|default:
name|nd
operator|->
name|nd_repstat
operator|=
name|NFSERR_BADXDR
expr_stmt|;
name|vrele
argument_list|(
name|dp
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|NFS4_ACL_EXTATTR_NAME
name|acl_free
argument_list|(
name|aclp
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|FREE
argument_list|(
operator|(
name|caddr_t
operator|)
name|stp
argument_list|,
name|M_NFSDSTATE
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
empty_stmt|;
block|}
elseif|else
if|if
condition|(
name|create
operator|!=
name|NFSV4OPEN_NOCREATE
condition|)
block|{
name|nd
operator|->
name|nd_repstat
operator|=
name|NFSERR_BADXDR
expr_stmt|;
name|vrele
argument_list|(
name|dp
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|NFS4_ACL_EXTATTR_NAME
name|acl_free
argument_list|(
name|aclp
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|FREE
argument_list|(
operator|(
name|caddr_t
operator|)
name|stp
argument_list|,
name|M_NFSDSTATE
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
comment|/* 	 * Now, handle the claim, which usually includes looking up a 	 * name in the directory referenced by dp. The exception is 	 * NFSV4OPEN_CLAIMPREVIOUS. 	 */
name|NFSM_DISSECT
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|claim
operator|=
name|fxdr_unsigned
argument_list|(
name|int
argument_list|,
operator|*
name|tl
argument_list|)
expr_stmt|;
if|if
condition|(
name|claim
operator|==
name|NFSV4OPEN_CLAIMDELEGATECUR
condition|)
block|{
name|NFSM_DISSECT
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
name|NFSX_STATEID
argument_list|)
expr_stmt|;
name|stateid
operator|.
name|seqid
operator|=
name|fxdr_unsigned
argument_list|(
name|u_int32_t
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
expr_stmt|;
name|NFSBCOPY
argument_list|(
operator|(
name|caddr_t
operator|)
name|tl
argument_list|,
operator|(
name|caddr_t
operator|)
name|stateid
operator|.
name|other
argument_list|,
name|NFSX_STATEIDOTHER
argument_list|)
expr_stmt|;
name|stp
operator|->
name|ls_flags
operator||=
name|NFSLCK_DELEGCUR
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|claim
operator|==
name|NFSV4OPEN_CLAIMDELEGATEPREV
condition|)
block|{
name|stp
operator|->
name|ls_flags
operator||=
name|NFSLCK_DELEGPREV
expr_stmt|;
block|}
if|if
condition|(
name|claim
operator|==
name|NFSV4OPEN_CLAIMNULL
operator|||
name|claim
operator|==
name|NFSV4OPEN_CLAIMDELEGATECUR
operator|||
name|claim
operator|==
name|NFSV4OPEN_CLAIMDELEGATEPREV
condition|)
block|{
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
operator|&&
name|create
operator|==
name|NFSV4OPEN_CREATE
operator|&&
name|claim
operator|!=
name|NFSV4OPEN_CLAIMNULL
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|NFSERR_INVAL
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsrv_opencheck
argument_list|(
name|clientid
argument_list|,
operator|&
name|stateid
argument_list|,
name|stp
argument_list|,
name|NULL
argument_list|,
name|nd
argument_list|,
name|p
argument_list|,
name|nd
operator|->
name|nd_repstat
argument_list|)
expr_stmt|;
name|vrele
argument_list|(
name|dp
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|NFS4_ACL_EXTATTR_NAME
name|acl_free
argument_list|(
name|aclp
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|FREE
argument_list|(
operator|(
name|caddr_t
operator|)
name|stp
argument_list|,
name|M_NFSDSTATE
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|create
operator|==
name|NFSV4OPEN_CREATE
condition|)
name|NFSNAMEICNDSET
argument_list|(
operator|&
name|named
operator|.
name|ni_cnd
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|CREATE
argument_list|,
name|LOCKPARENT
operator||
name|LOCKLEAF
operator||
name|SAVESTART
argument_list|)
expr_stmt|;
else|else
name|NFSNAMEICNDSET
argument_list|(
operator|&
name|named
operator|.
name|ni_cnd
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|LOOKUP
argument_list|,
name|LOCKLEAF
operator||
name|SAVESTART
argument_list|)
expr_stmt|;
name|nfsvno_setpathbuf
argument_list|(
operator|&
name|named
argument_list|,
operator|&
name|bufp
argument_list|,
operator|&
name|hashp
argument_list|)
expr_stmt|;
name|error
operator|=
name|nfsrv_parsename
argument_list|(
name|nd
argument_list|,
name|bufp
argument_list|,
name|hashp
argument_list|,
operator|&
name|named
operator|.
name|ni_pathlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|vrele
argument_list|(
name|dp
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|NFS4_ACL_EXTATTR_NAME
name|acl_free
argument_list|(
name|aclp
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|FREE
argument_list|(
operator|(
name|caddr_t
operator|)
name|stp
argument_list|,
name|M_NFSDSTATE
argument_list|)
expr_stmt|;
name|nfsvno_relpathbuf
argument_list|(
operator|&
name|named
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_namei
argument_list|(
name|nd
argument_list|,
operator|&
name|named
argument_list|,
name|dp
argument_list|,
literal|0
argument_list|,
name|exp
argument_list|,
name|p
argument_list|,
operator|&
name|dirp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|vrele
argument_list|(
name|dp
argument_list|)
expr_stmt|;
name|nfsvno_relpathbuf
argument_list|(
operator|&
name|named
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|create
operator|==
name|NFSV4OPEN_CREATE
condition|)
block|{
switch|switch
condition|(
name|how
condition|)
block|{
case|case
name|NFSCREATE_UNCHECKED
case|:
if|if
condition|(
name|named
operator|.
name|ni_vp
condition|)
block|{
comment|/* 				 * Clear the setable attribute bits, except 				 * for Size, if it is being truncated. 				 */
name|NFSZERO_ATTRBIT
argument_list|(
operator|&
name|attrbits
argument_list|)
expr_stmt|;
if|if
condition|(
name|NFSVNO_ISSETSIZE
argument_list|(
operator|&
name|nva
argument_list|)
condition|)
name|NFSSETBIT_ATTRBIT
argument_list|(
operator|&
name|attrbits
argument_list|,
name|NFSATTRBIT_SIZE
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|NFSCREATE_GUARDED
case|:
if|if
condition|(
name|named
operator|.
name|ni_vp
operator|&&
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|EEXIST
expr_stmt|;
break|break;
case|case
name|NFSCREATE_EXCLUSIVE
case|:
name|exclusive_flag
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|named
operator|.
name|ni_vp
condition|)
name|nva
operator|.
name|na_mode
operator|=
literal|0
expr_stmt|;
block|}
empty_stmt|;
block|}
name|nfsvno_open
argument_list|(
name|nd
argument_list|,
operator|&
name|named
argument_list|,
name|clientid
argument_list|,
operator|&
name|stateid
argument_list|,
name|stp
argument_list|,
operator|&
name|exclusive_flag
argument_list|,
operator|&
name|nva
argument_list|,
name|cverf
argument_list|,
name|create
argument_list|,
name|aclp
argument_list|,
operator|&
name|attrbits
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
name|exp
argument_list|,
operator|&
name|vp
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|claim
operator|==
name|NFSV4OPEN_CLAIMPREVIOUS
condition|)
block|{
name|NFSM_DISSECT
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|i
operator|=
name|fxdr_unsigned
argument_list|(
name|int
argument_list|,
operator|*
name|tl
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|i
condition|)
block|{
case|case
name|NFSV4OPEN_DELEGATEREAD
case|:
name|stp
operator|->
name|ls_flags
operator||=
name|NFSLCK_DELEGREAD
expr_stmt|;
break|break;
case|case
name|NFSV4OPEN_DELEGATEWRITE
case|:
name|stp
operator|->
name|ls_flags
operator||=
name|NFSLCK_DELEGWRITE
expr_stmt|;
case|case
name|NFSV4OPEN_DELEGATENONE
case|:
break|break;
default|default:
name|nd
operator|->
name|nd_repstat
operator|=
name|NFSERR_BADXDR
expr_stmt|;
name|vrele
argument_list|(
name|dp
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|NFS4_ACL_EXTATTR_NAME
name|acl_free
argument_list|(
name|aclp
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|FREE
argument_list|(
operator|(
name|caddr_t
operator|)
name|stp
argument_list|,
name|M_NFSDSTATE
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
empty_stmt|;
name|stp
operator|->
name|ls_flags
operator||=
name|NFSLCK_RECLAIM
expr_stmt|;
name|vp
operator|=
name|dp
expr_stmt|;
name|vn_lock
argument_list|(
name|vp
argument_list|,
name|LK_EXCLUSIVE
operator||
name|LK_RETRY
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|vp
operator|->
name|v_iflag
operator|&
name|VI_DOOMED
operator|)
operator|==
literal|0
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsrv_opencheck
argument_list|(
name|clientid
argument_list|,
operator|&
name|stateid
argument_list|,
name|stp
argument_list|,
name|vp
argument_list|,
name|nd
argument_list|,
name|p
argument_list|,
name|nd
operator|->
name|nd_repstat
argument_list|)
expr_stmt|;
else|else
name|nd
operator|->
name|nd_repstat
operator|=
name|NFSERR_PERM
expr_stmt|;
block|}
else|else
block|{
name|nd
operator|->
name|nd_repstat
operator|=
name|NFSERR_BADXDR
expr_stmt|;
name|vrele
argument_list|(
name|dp
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|NFS4_ACL_EXTATTR_NAME
name|acl_free
argument_list|(
name|aclp
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|FREE
argument_list|(
operator|(
name|caddr_t
operator|)
name|stp
argument_list|,
name|M_NFSDSTATE
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
comment|/* 	 * Do basic access checking. 	 */
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
operator|&&
name|vnode_vtype
argument_list|(
name|vp
argument_list|)
operator|!=
name|VREG
condition|)
block|{
if|if
condition|(
name|vnode_vtype
argument_list|(
name|vp
argument_list|)
operator|==
name|VDIR
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|NFSERR_ISDIR
expr_stmt|;
elseif|else
if|if
condition|(
name|vnode_vtype
argument_list|(
name|vp
argument_list|)
operator|==
name|VLNK
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|NFSERR_SYMLINK
expr_stmt|;
else|else
name|nd
operator|->
name|nd_repstat
operator|=
name|NFSERR_INVAL
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
operator|&&
operator|(
name|stp
operator|->
name|ls_flags
operator|&
name|NFSLCK_WRITEACCESS
operator|)
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_accchk
argument_list|(
name|vp
argument_list|,
name|VWRITE
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|exp
argument_list|,
name|p
argument_list|,
name|NFSACCCHK_ALLOWOWNER
argument_list|,
name|NFSACCCHK_VPISLOCKED
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
operator|&&
operator|(
name|stp
operator|->
name|ls_flags
operator|&
name|NFSLCK_READACCESS
operator|)
condition|)
block|{
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_accchk
argument_list|(
name|vp
argument_list|,
name|VREAD
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|exp
argument_list|,
name|p
argument_list|,
name|NFSACCCHK_ALLOWOWNER
argument_list|,
name|NFSACCCHK_VPISLOCKED
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_repstat
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_accchk
argument_list|(
name|vp
argument_list|,
name|VEXEC
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|exp
argument_list|,
name|p
argument_list|,
name|NFSACCCHK_ALLOWOWNER
argument_list|,
name|NFSACCCHK_VPISLOCKED
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_getattr
argument_list|(
name|vp
argument_list|,
operator|&
name|nva
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|tverf
index|[
literal|0
index|]
operator|=
name|nva
operator|.
name|na_atime
operator|.
name|tv_sec
expr_stmt|;
name|tverf
index|[
literal|1
index|]
operator|=
name|nva
operator|.
name|na_atime
operator|.
name|tv_nsec
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
operator|&&
name|exclusive_flag
operator|&&
operator|(
name|cverf
index|[
literal|0
index|]
operator|!=
name|tverf
index|[
literal|0
index|]
operator|||
name|cverf
index|[
literal|1
index|]
operator|!=
name|tverf
index|[
literal|1
index|]
operator|)
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|EEXIST
expr_stmt|;
comment|/* 	 * Do the open locking/delegation stuff. 	 */
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsrv_openctrl
argument_list|(
name|nd
argument_list|,
name|vp
argument_list|,
operator|&
name|stp
argument_list|,
name|clientid
argument_list|,
operator|&
name|stateid
argument_list|,
operator|&
name|delegstateid
argument_list|,
operator|&
name|rflags
argument_list|,
name|exp
argument_list|,
name|p
argument_list|,
name|nva
operator|.
name|na_filerev
argument_list|)
expr_stmt|;
comment|/* 	 * vp must be unlocked before the call to nfsvno_getattr(dirp,...) 	 * below, to avoid a deadlock with the lookup in nfsvno_namei() above. 	 * (ie: Leave the NFSVOPUNLOCK() about here.) 	 */
if|if
condition|(
name|vp
condition|)
name|NFSVOPUNLOCK
argument_list|(
name|vp
argument_list|,
literal|0
argument_list|,
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|stp
condition|)
name|FREE
argument_list|(
operator|(
name|caddr_t
operator|)
name|stp
argument_list|,
name|M_NFSDSTATE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
operator|&&
name|dirp
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_getattr
argument_list|(
name|dirp
argument_list|,
operator|&
name|diraft
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|NFSM_BUILD
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
name|NFSX_STATEID
operator|+
literal|6
operator|*
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
name|txdr_unsigned
argument_list|(
name|stateid
operator|.
name|seqid
argument_list|)
expr_stmt|;
name|NFSBCOPY
argument_list|(
operator|(
name|caddr_t
operator|)
name|stateid
operator|.
name|other
argument_list|,
operator|(
name|caddr_t
operator|)
name|tl
argument_list|,
name|NFSX_STATEIDOTHER
argument_list|)
expr_stmt|;
name|tl
operator|+=
operator|(
name|NFSX_STATEIDOTHER
operator|/
name|NFSX_UNSIGNED
operator|)
expr_stmt|;
if|if
condition|(
name|claim
operator|==
name|NFSV4OPEN_CLAIMPREVIOUS
condition|)
block|{
operator|*
name|tl
operator|++
operator|=
name|newnfs_true
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
literal|0
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
literal|0
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
literal|0
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
operator|*
name|tl
operator|++
operator|=
name|newnfs_false
expr_stmt|;
comment|/* Since dirp is not locked */
name|txdr_hyper
argument_list|(
name|dirfor
operator|.
name|na_filerev
argument_list|,
name|tl
argument_list|)
expr_stmt|;
name|tl
operator|+=
literal|2
expr_stmt|;
name|txdr_hyper
argument_list|(
name|diraft
operator|.
name|na_filerev
argument_list|,
name|tl
argument_list|)
expr_stmt|;
name|tl
operator|+=
literal|2
expr_stmt|;
block|}
operator|*
name|tl
operator|=
name|txdr_unsigned
argument_list|(
name|rflags
operator|&
name|NFSV4OPEN_RFLAGS
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|nfsrv_putattrbit
argument_list|(
name|nd
argument_list|,
operator|&
name|attrbits
argument_list|)
expr_stmt|;
name|NFSM_BUILD
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
if|if
condition|(
name|rflags
operator|&
name|NFSV4OPEN_READDELEGATE
condition|)
operator|*
name|tl
operator|=
name|txdr_unsigned
argument_list|(
name|NFSV4OPEN_DELEGATEREAD
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|rflags
operator|&
name|NFSV4OPEN_WRITEDELEGATE
condition|)
operator|*
name|tl
operator|=
name|txdr_unsigned
argument_list|(
name|NFSV4OPEN_DELEGATEWRITE
argument_list|)
expr_stmt|;
else|else
operator|*
name|tl
operator|=
name|txdr_unsigned
argument_list|(
name|NFSV4OPEN_DELEGATENONE
argument_list|)
expr_stmt|;
if|if
condition|(
name|rflags
operator|&
operator|(
name|NFSV4OPEN_READDELEGATE
operator||
name|NFSV4OPEN_WRITEDELEGATE
operator|)
condition|)
block|{
name|NFSM_BUILD
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
name|NFSX_STATEID
operator|+
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
name|txdr_unsigned
argument_list|(
name|delegstateid
operator|.
name|seqid
argument_list|)
expr_stmt|;
name|NFSBCOPY
argument_list|(
operator|(
name|caddr_t
operator|)
name|delegstateid
operator|.
name|other
argument_list|,
operator|(
name|caddr_t
operator|)
name|tl
argument_list|,
name|NFSX_STATEIDOTHER
argument_list|)
expr_stmt|;
name|tl
operator|+=
operator|(
name|NFSX_STATEIDOTHER
operator|/
name|NFSX_UNSIGNED
operator|)
expr_stmt|;
if|if
condition|(
name|rflags
operator|&
name|NFSV4OPEN_RECALL
condition|)
operator|*
name|tl
operator|=
name|newnfs_true
expr_stmt|;
else|else
operator|*
name|tl
operator|=
name|newnfs_false
expr_stmt|;
if|if
condition|(
name|rflags
operator|&
name|NFSV4OPEN_WRITEDELEGATE
condition|)
block|{
name|NFSM_BUILD
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
literal|3
operator|*
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
name|txdr_unsigned
argument_list|(
name|NFSV4OPEN_LIMITSIZE
argument_list|)
expr_stmt|;
name|txdr_hyper
argument_list|(
name|nva
operator|.
name|na_size
argument_list|,
name|tl
argument_list|)
expr_stmt|;
block|}
name|NFSM_BUILD
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
literal|3
operator|*
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
name|txdr_unsigned
argument_list|(
name|NFSV4ACE_ALLOWEDTYPE
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
name|txdr_unsigned
argument_list|(
literal|0x0
argument_list|)
expr_stmt|;
name|acemask
operator|=
name|NFSV4ACE_ALLFILESMASK
expr_stmt|;
if|if
condition|(
name|nva
operator|.
name|na_mode
operator|&
name|S_IRUSR
condition|)
name|acemask
operator||=
name|NFSV4ACE_READMASK
expr_stmt|;
if|if
condition|(
name|nva
operator|.
name|na_mode
operator|&
name|S_IWUSR
condition|)
name|acemask
operator||=
name|NFSV4ACE_WRITEMASK
expr_stmt|;
if|if
condition|(
name|nva
operator|.
name|na_mode
operator|&
name|S_IXUSR
condition|)
name|acemask
operator||=
name|NFSV4ACE_EXECUTEMASK
expr_stmt|;
operator|*
name|tl
operator|=
name|txdr_unsigned
argument_list|(
name|acemask
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|nfsm_strtom
argument_list|(
name|nd
argument_list|,
literal|"OWNER@"
argument_list|,
literal|6
argument_list|)
expr_stmt|;
block|}
operator|*
name|vpp
operator|=
name|vp
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|vp
condition|)
block|{
name|vrele
argument_list|(
name|vp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dirp
condition|)
name|vrele
argument_list|(
name|dirp
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|NFS4_ACL_EXTATTR_NAME
name|acl_free
argument_list|(
name|aclp
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
literal|0
operator|)
return|;
name|nfsmout
label|:
name|vrele
argument_list|(
name|dp
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|NFS4_ACL_EXTATTR_NAME
name|acl_free
argument_list|(
name|aclp
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|stp
condition|)
name|FREE
argument_list|(
operator|(
name|caddr_t
operator|)
name|stp
argument_list|,
name|M_NFSDSTATE
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * nfsv4 close service  */
end_comment

begin_function
name|APPLESTATIC
name|int
name|nfsrvd_close
parameter_list|(
name|struct
name|nfsrv_descript
modifier|*
name|nd
parameter_list|,
name|__unused
name|int
name|isdgram
parameter_list|,
name|vnode_t
name|vp
parameter_list|,
name|NFSPROC_T
modifier|*
name|p
parameter_list|,
name|__unused
name|struct
name|nfsexstuff
modifier|*
name|exp
parameter_list|)
block|{
name|u_int32_t
modifier|*
name|tl
decl_stmt|;
name|struct
name|nfsstate
name|st
decl_stmt|,
modifier|*
name|stp
init|=
operator|&
name|st
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|nfsv4stateid_t
name|stateid
decl_stmt|;
name|nfsquad_t
name|clientid
decl_stmt|;
name|NFSM_DISSECT
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
name|NFSX_UNSIGNED
operator|+
name|NFSX_STATEID
argument_list|)
expr_stmt|;
name|stp
operator|->
name|ls_seq
operator|=
name|fxdr_unsigned
argument_list|(
name|u_int32_t
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
expr_stmt|;
name|stp
operator|->
name|ls_ownerlen
operator|=
literal|0
expr_stmt|;
name|stp
operator|->
name|ls_op
operator|=
name|nd
operator|->
name|nd_rp
expr_stmt|;
name|stp
operator|->
name|ls_uid
operator|=
name|nd
operator|->
name|nd_cred
operator|->
name|cr_uid
expr_stmt|;
name|stp
operator|->
name|ls_stateid
operator|.
name|seqid
operator|=
name|fxdr_unsigned
argument_list|(
name|u_int32_t
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
expr_stmt|;
name|NFSBCOPY
argument_list|(
operator|(
name|caddr_t
operator|)
name|tl
argument_list|,
operator|(
name|caddr_t
operator|)
name|stp
operator|->
name|ls_stateid
operator|.
name|other
argument_list|,
name|NFSX_STATEIDOTHER
argument_list|)
expr_stmt|;
name|stp
operator|->
name|ls_flags
operator|=
name|NFSLCK_CLOSE
expr_stmt|;
name|clientid
operator|.
name|lval
index|[
literal|0
index|]
operator|=
name|stp
operator|->
name|ls_stateid
operator|.
name|other
index|[
literal|0
index|]
expr_stmt|;
name|clientid
operator|.
name|lval
index|[
literal|1
index|]
operator|=
name|stp
operator|->
name|ls_stateid
operator|.
name|other
index|[
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_IMPLIEDCLID
condition|)
block|{
if|if
condition|(
name|nd
operator|->
name|nd_clientid
operator|.
name|qval
operator|!=
name|clientid
operator|.
name|qval
condition|)
name|printf
argument_list|(
literal|"EEK! multiple clids\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|nd
operator|->
name|nd_flag
operator||=
name|ND_IMPLIEDCLID
expr_stmt|;
name|nd
operator|->
name|nd_clientid
operator|.
name|qval
operator|=
name|clientid
operator|.
name|qval
expr_stmt|;
block|}
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsrv_openupdate
argument_list|(
name|vp
argument_list|,
name|stp
argument_list|,
name|clientid
argument_list|,
operator|&
name|stateid
argument_list|,
name|nd
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|vput
argument_list|(
name|vp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|NFSM_BUILD
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
name|NFSX_STATEID
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
name|txdr_unsigned
argument_list|(
name|stateid
operator|.
name|seqid
argument_list|)
expr_stmt|;
name|NFSBCOPY
argument_list|(
operator|(
name|caddr_t
operator|)
name|stateid
operator|.
name|other
argument_list|,
operator|(
name|caddr_t
operator|)
name|tl
argument_list|,
name|NFSX_STATEIDOTHER
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|nfsmout
label|:
name|vput
argument_list|(
name|vp
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * nfsv4 delegpurge service  */
end_comment

begin_function
name|APPLESTATIC
name|int
name|nfsrvd_delegpurge
parameter_list|(
name|struct
name|nfsrv_descript
modifier|*
name|nd
parameter_list|,
name|__unused
name|int
name|isdgram
parameter_list|,
name|__unused
name|vnode_t
name|vp
parameter_list|,
name|__unused
name|NFSPROC_T
modifier|*
name|p
parameter_list|,
name|__unused
name|struct
name|nfsexstuff
modifier|*
name|exp
parameter_list|)
block|{
name|u_int32_t
modifier|*
name|tl
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|nfsquad_t
name|clientid
decl_stmt|;
if|if
condition|(
name|nfs_rootfhset
operator|==
literal|0
operator|||
name|nfsd_checkrootexp
argument_list|(
name|nd
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|nd
operator|->
name|nd_repstat
operator|=
name|NFSERR_WRONGSEC
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|NFSM_DISSECT
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
literal|2
operator|*
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|clientid
operator|.
name|lval
index|[
literal|0
index|]
operator|=
operator|*
name|tl
operator|++
expr_stmt|;
name|clientid
operator|.
name|lval
index|[
literal|1
index|]
operator|=
operator|*
name|tl
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_IMPLIEDCLID
condition|)
block|{
if|if
condition|(
name|nd
operator|->
name|nd_clientid
operator|.
name|qval
operator|!=
name|clientid
operator|.
name|qval
condition|)
name|printf
argument_list|(
literal|"EEK! multiple clids\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|nd
operator|->
name|nd_flag
operator||=
name|ND_IMPLIEDCLID
expr_stmt|;
name|nd
operator|->
name|nd_clientid
operator|.
name|qval
operator|=
name|clientid
operator|.
name|qval
expr_stmt|;
block|}
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsrv_delegupdate
argument_list|(
name|clientid
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NFSV4OP_DELEGPURGE
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|nfsmout
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * nfsv4 delegreturn service  */
end_comment

begin_function
name|APPLESTATIC
name|int
name|nfsrvd_delegreturn
parameter_list|(
name|struct
name|nfsrv_descript
modifier|*
name|nd
parameter_list|,
name|__unused
name|int
name|isdgram
parameter_list|,
name|vnode_t
name|vp
parameter_list|,
name|NFSPROC_T
modifier|*
name|p
parameter_list|,
name|__unused
name|struct
name|nfsexstuff
modifier|*
name|exp
parameter_list|)
block|{
name|u_int32_t
modifier|*
name|tl
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|nfsv4stateid_t
name|stateid
decl_stmt|;
name|nfsquad_t
name|clientid
decl_stmt|;
name|NFSM_DISSECT
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
name|NFSX_STATEID
argument_list|)
expr_stmt|;
name|stateid
operator|.
name|seqid
operator|=
name|fxdr_unsigned
argument_list|(
name|u_int32_t
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
expr_stmt|;
name|NFSBCOPY
argument_list|(
operator|(
name|caddr_t
operator|)
name|tl
argument_list|,
operator|(
name|caddr_t
operator|)
name|stateid
operator|.
name|other
argument_list|,
name|NFSX_STATEIDOTHER
argument_list|)
expr_stmt|;
name|clientid
operator|.
name|lval
index|[
literal|0
index|]
operator|=
name|stateid
operator|.
name|other
index|[
literal|0
index|]
expr_stmt|;
name|clientid
operator|.
name|lval
index|[
literal|1
index|]
operator|=
name|stateid
operator|.
name|other
index|[
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_IMPLIEDCLID
condition|)
block|{
if|if
condition|(
name|nd
operator|->
name|nd_clientid
operator|.
name|qval
operator|!=
name|clientid
operator|.
name|qval
condition|)
name|printf
argument_list|(
literal|"EEK! multiple clids\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|nd
operator|->
name|nd_flag
operator||=
name|ND_IMPLIEDCLID
expr_stmt|;
name|nd
operator|->
name|nd_clientid
operator|.
name|qval
operator|=
name|clientid
operator|.
name|qval
expr_stmt|;
block|}
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsrv_delegupdate
argument_list|(
name|clientid
argument_list|,
operator|&
name|stateid
argument_list|,
name|vp
argument_list|,
name|NFSV4OP_DELEGRETURN
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|nfsmout
label|:
name|vput
argument_list|(
name|vp
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * nfsv4 get file handle service  */
end_comment

begin_function
name|APPLESTATIC
name|int
name|nfsrvd_getfh
parameter_list|(
name|struct
name|nfsrv_descript
modifier|*
name|nd
parameter_list|,
name|__unused
name|int
name|isdgram
parameter_list|,
name|vnode_t
name|vp
parameter_list|,
name|NFSPROC_T
modifier|*
name|p
parameter_list|,
name|__unused
name|struct
name|nfsexstuff
modifier|*
name|exp
parameter_list|)
block|{
name|fhandle_t
name|fh
decl_stmt|;
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_getfh
argument_list|(
name|vp
argument_list|,
operator|&
name|fh
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|vput
argument_list|(
name|vp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
operator|(
name|void
operator|)
name|nfsm_fhtom
argument_list|(
name|nd
argument_list|,
operator|(
name|u_int8_t
operator|*
operator|)
operator|&
name|fh
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * nfsv4 open confirm service  */
end_comment

begin_function
name|APPLESTATIC
name|int
name|nfsrvd_openconfirm
parameter_list|(
name|struct
name|nfsrv_descript
modifier|*
name|nd
parameter_list|,
name|__unused
name|int
name|isdgram
parameter_list|,
name|vnode_t
name|vp
parameter_list|,
name|NFSPROC_T
modifier|*
name|p
parameter_list|,
name|__unused
name|struct
name|nfsexstuff
modifier|*
name|exp
parameter_list|)
block|{
name|u_int32_t
modifier|*
name|tl
decl_stmt|;
name|struct
name|nfsstate
name|st
decl_stmt|,
modifier|*
name|stp
init|=
operator|&
name|st
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|nfsv4stateid_t
name|stateid
decl_stmt|;
name|nfsquad_t
name|clientid
decl_stmt|;
name|NFSM_DISSECT
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
name|NFSX_STATEID
operator|+
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|stp
operator|->
name|ls_ownerlen
operator|=
literal|0
expr_stmt|;
name|stp
operator|->
name|ls_op
operator|=
name|nd
operator|->
name|nd_rp
expr_stmt|;
name|stp
operator|->
name|ls_uid
operator|=
name|nd
operator|->
name|nd_cred
operator|->
name|cr_uid
expr_stmt|;
name|stp
operator|->
name|ls_stateid
operator|.
name|seqid
operator|=
name|fxdr_unsigned
argument_list|(
name|u_int32_t
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
expr_stmt|;
name|NFSBCOPY
argument_list|(
operator|(
name|caddr_t
operator|)
name|tl
argument_list|,
operator|(
name|caddr_t
operator|)
name|stp
operator|->
name|ls_stateid
operator|.
name|other
argument_list|,
name|NFSX_STATEIDOTHER
argument_list|)
expr_stmt|;
name|tl
operator|+=
operator|(
name|NFSX_STATEIDOTHER
operator|/
name|NFSX_UNSIGNED
operator|)
expr_stmt|;
name|stp
operator|->
name|ls_seq
operator|=
name|fxdr_unsigned
argument_list|(
name|u_int32_t
argument_list|,
operator|*
name|tl
argument_list|)
expr_stmt|;
name|stp
operator|->
name|ls_flags
operator|=
name|NFSLCK_CONFIRM
expr_stmt|;
name|clientid
operator|.
name|lval
index|[
literal|0
index|]
operator|=
name|stp
operator|->
name|ls_stateid
operator|.
name|other
index|[
literal|0
index|]
expr_stmt|;
name|clientid
operator|.
name|lval
index|[
literal|1
index|]
operator|=
name|stp
operator|->
name|ls_stateid
operator|.
name|other
index|[
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_IMPLIEDCLID
condition|)
block|{
if|if
condition|(
name|nd
operator|->
name|nd_clientid
operator|.
name|qval
operator|!=
name|clientid
operator|.
name|qval
condition|)
name|printf
argument_list|(
literal|"EEK! multiple clids\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|nd
operator|->
name|nd_flag
operator||=
name|ND_IMPLIEDCLID
expr_stmt|;
name|nd
operator|->
name|nd_clientid
operator|.
name|qval
operator|=
name|clientid
operator|.
name|qval
expr_stmt|;
block|}
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsrv_openupdate
argument_list|(
name|vp
argument_list|,
name|stp
argument_list|,
name|clientid
argument_list|,
operator|&
name|stateid
argument_list|,
name|nd
argument_list|,
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|NFSM_BUILD
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
name|NFSX_STATEID
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
name|txdr_unsigned
argument_list|(
name|stateid
operator|.
name|seqid
argument_list|)
expr_stmt|;
name|NFSBCOPY
argument_list|(
operator|(
name|caddr_t
operator|)
name|stateid
operator|.
name|other
argument_list|,
operator|(
name|caddr_t
operator|)
name|tl
argument_list|,
name|NFSX_STATEIDOTHER
argument_list|)
expr_stmt|;
block|}
name|nfsmout
label|:
name|vput
argument_list|(
name|vp
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * nfsv4 open downgrade service  */
end_comment

begin_function
name|APPLESTATIC
name|int
name|nfsrvd_opendowngrade
parameter_list|(
name|struct
name|nfsrv_descript
modifier|*
name|nd
parameter_list|,
name|__unused
name|int
name|isdgram
parameter_list|,
name|vnode_t
name|vp
parameter_list|,
name|NFSPROC_T
modifier|*
name|p
parameter_list|,
name|__unused
name|struct
name|nfsexstuff
modifier|*
name|exp
parameter_list|)
block|{
name|u_int32_t
modifier|*
name|tl
decl_stmt|;
name|int
name|i
decl_stmt|;
name|struct
name|nfsstate
name|st
decl_stmt|,
modifier|*
name|stp
init|=
operator|&
name|st
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|nfsv4stateid_t
name|stateid
decl_stmt|;
name|nfsquad_t
name|clientid
decl_stmt|;
name|NFSM_DISSECT
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
name|NFSX_STATEID
operator|+
literal|3
operator|*
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|stp
operator|->
name|ls_ownerlen
operator|=
literal|0
expr_stmt|;
name|stp
operator|->
name|ls_op
operator|=
name|nd
operator|->
name|nd_rp
expr_stmt|;
name|stp
operator|->
name|ls_uid
operator|=
name|nd
operator|->
name|nd_cred
operator|->
name|cr_uid
expr_stmt|;
name|stp
operator|->
name|ls_stateid
operator|.
name|seqid
operator|=
name|fxdr_unsigned
argument_list|(
name|u_int32_t
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
expr_stmt|;
name|NFSBCOPY
argument_list|(
operator|(
name|caddr_t
operator|)
name|tl
argument_list|,
operator|(
name|caddr_t
operator|)
name|stp
operator|->
name|ls_stateid
operator|.
name|other
argument_list|,
name|NFSX_STATEIDOTHER
argument_list|)
expr_stmt|;
name|tl
operator|+=
operator|(
name|NFSX_STATEIDOTHER
operator|/
name|NFSX_UNSIGNED
operator|)
expr_stmt|;
name|stp
operator|->
name|ls_seq
operator|=
name|fxdr_unsigned
argument_list|(
name|u_int32_t
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
expr_stmt|;
name|i
operator|=
name|fxdr_unsigned
argument_list|(
name|int
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|i
condition|)
block|{
case|case
name|NFSV4OPEN_ACCESSREAD
case|:
name|stp
operator|->
name|ls_flags
operator|=
operator|(
name|NFSLCK_READACCESS
operator||
name|NFSLCK_DOWNGRADE
operator|)
expr_stmt|;
break|break;
case|case
name|NFSV4OPEN_ACCESSWRITE
case|:
name|stp
operator|->
name|ls_flags
operator|=
operator|(
name|NFSLCK_WRITEACCESS
operator||
name|NFSLCK_DOWNGRADE
operator|)
expr_stmt|;
break|break;
case|case
name|NFSV4OPEN_ACCESSBOTH
case|:
name|stp
operator|->
name|ls_flags
operator|=
operator|(
name|NFSLCK_READACCESS
operator||
name|NFSLCK_WRITEACCESS
operator||
name|NFSLCK_DOWNGRADE
operator|)
expr_stmt|;
break|break;
default|default:
name|nd
operator|->
name|nd_repstat
operator|=
name|NFSERR_BADXDR
expr_stmt|;
block|}
empty_stmt|;
name|i
operator|=
name|fxdr_unsigned
argument_list|(
name|int
argument_list|,
operator|*
name|tl
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|i
condition|)
block|{
case|case
name|NFSV4OPEN_DENYNONE
case|:
break|break;
case|case
name|NFSV4OPEN_DENYREAD
case|:
name|stp
operator|->
name|ls_flags
operator||=
name|NFSLCK_READDENY
expr_stmt|;
break|break;
case|case
name|NFSV4OPEN_DENYWRITE
case|:
name|stp
operator|->
name|ls_flags
operator||=
name|NFSLCK_WRITEDENY
expr_stmt|;
break|break;
case|case
name|NFSV4OPEN_DENYBOTH
case|:
name|stp
operator|->
name|ls_flags
operator||=
operator|(
name|NFSLCK_READDENY
operator||
name|NFSLCK_WRITEDENY
operator|)
expr_stmt|;
break|break;
default|default:
name|nd
operator|->
name|nd_repstat
operator|=
name|NFSERR_BADXDR
expr_stmt|;
block|}
empty_stmt|;
name|clientid
operator|.
name|lval
index|[
literal|0
index|]
operator|=
name|stp
operator|->
name|ls_stateid
operator|.
name|other
index|[
literal|0
index|]
expr_stmt|;
name|clientid
operator|.
name|lval
index|[
literal|1
index|]
operator|=
name|stp
operator|->
name|ls_stateid
operator|.
name|other
index|[
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_IMPLIEDCLID
condition|)
block|{
if|if
condition|(
name|nd
operator|->
name|nd_clientid
operator|.
name|qval
operator|!=
name|clientid
operator|.
name|qval
condition|)
name|printf
argument_list|(
literal|"EEK! multiple clids\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|nd
operator|->
name|nd_flag
operator||=
name|ND_IMPLIEDCLID
expr_stmt|;
name|nd
operator|->
name|nd_clientid
operator|.
name|qval
operator|=
name|clientid
operator|.
name|qval
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsrv_openupdate
argument_list|(
name|vp
argument_list|,
name|stp
argument_list|,
name|clientid
argument_list|,
operator|&
name|stateid
argument_list|,
name|nd
argument_list|,
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|NFSM_BUILD
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
name|NFSX_STATEID
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
name|txdr_unsigned
argument_list|(
name|stateid
operator|.
name|seqid
argument_list|)
expr_stmt|;
name|NFSBCOPY
argument_list|(
operator|(
name|caddr_t
operator|)
name|stateid
operator|.
name|other
argument_list|,
operator|(
name|caddr_t
operator|)
name|tl
argument_list|,
name|NFSX_STATEIDOTHER
argument_list|)
expr_stmt|;
block|}
name|nfsmout
label|:
name|vput
argument_list|(
name|vp
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * nfsv4 renew lease service  */
end_comment

begin_function
name|APPLESTATIC
name|int
name|nfsrvd_renew
parameter_list|(
name|struct
name|nfsrv_descript
modifier|*
name|nd
parameter_list|,
name|__unused
name|int
name|isdgram
parameter_list|,
name|__unused
name|vnode_t
name|vp
parameter_list|,
name|NFSPROC_T
modifier|*
name|p
parameter_list|,
name|__unused
name|struct
name|nfsexstuff
modifier|*
name|exp
parameter_list|)
block|{
name|u_int32_t
modifier|*
name|tl
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|nfsquad_t
name|clientid
decl_stmt|;
if|if
condition|(
name|nfs_rootfhset
operator|==
literal|0
operator|||
name|nfsd_checkrootexp
argument_list|(
name|nd
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|nd
operator|->
name|nd_repstat
operator|=
name|NFSERR_WRONGSEC
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|NFSM_DISSECT
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
name|NFSX_HYPER
argument_list|)
expr_stmt|;
name|clientid
operator|.
name|lval
index|[
literal|0
index|]
operator|=
operator|*
name|tl
operator|++
expr_stmt|;
name|clientid
operator|.
name|lval
index|[
literal|1
index|]
operator|=
operator|*
name|tl
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_IMPLIEDCLID
condition|)
block|{
if|if
condition|(
name|nd
operator|->
name|nd_clientid
operator|.
name|qval
operator|!=
name|clientid
operator|.
name|qval
condition|)
name|printf
argument_list|(
literal|"EEK! multiple clids\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|nd
operator|->
name|nd_flag
operator||=
name|ND_IMPLIEDCLID
expr_stmt|;
name|nd
operator|->
name|nd_clientid
operator|.
name|qval
operator|=
name|clientid
operator|.
name|qval
expr_stmt|;
block|}
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsrv_getclient
argument_list|(
name|clientid
argument_list|,
operator|(
name|CLOPS_RENEWOP
operator||
name|CLOPS_RENEW
operator|)
argument_list|,
name|NULL
argument_list|,
call|(
name|nfsquad_t
call|)
argument_list|(
operator|(
name|u_quad_t
operator|)
literal|0
argument_list|)
argument_list|,
name|nd
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|nfsmout
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * nfsv4 security info service  */
end_comment

begin_function
name|APPLESTATIC
name|int
name|nfsrvd_secinfo
parameter_list|(
name|struct
name|nfsrv_descript
modifier|*
name|nd
parameter_list|,
name|int
name|isdgram
parameter_list|,
name|vnode_t
name|dp
parameter_list|,
name|NFSPROC_T
modifier|*
name|p
parameter_list|,
name|struct
name|nfsexstuff
modifier|*
name|exp
parameter_list|)
block|{
name|u_int32_t
modifier|*
name|tl
decl_stmt|;
name|int
name|len
decl_stmt|;
name|struct
name|nameidata
name|named
decl_stmt|;
name|vnode_t
name|dirp
init|=
name|NULL
decl_stmt|,
name|vp
decl_stmt|;
name|struct
name|nfsrvfh
name|fh
decl_stmt|;
name|struct
name|nfsexstuff
name|retnes
decl_stmt|;
name|u_int32_t
modifier|*
name|sizp
decl_stmt|;
name|int
name|error
decl_stmt|,
name|savflag
decl_stmt|,
name|i
decl_stmt|;
name|char
modifier|*
name|bufp
decl_stmt|;
name|u_long
modifier|*
name|hashp
decl_stmt|;
comment|/* 	 * All this just to get the export flags for the name. 	 */
name|NFSNAMEICNDSET
argument_list|(
operator|&
name|named
operator|.
name|ni_cnd
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|LOOKUP
argument_list|,
name|LOCKLEAF
operator||
name|SAVESTART
argument_list|)
expr_stmt|;
name|nfsvno_setpathbuf
argument_list|(
operator|&
name|named
argument_list|,
operator|&
name|bufp
argument_list|,
operator|&
name|hashp
argument_list|)
expr_stmt|;
name|error
operator|=
name|nfsrv_parsename
argument_list|(
name|nd
argument_list|,
name|bufp
argument_list|,
name|hashp
argument_list|,
operator|&
name|named
operator|.
name|ni_pathlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|vput
argument_list|(
name|dp
argument_list|)
expr_stmt|;
name|nfsvno_relpathbuf
argument_list|(
operator|&
name|named
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_namei
argument_list|(
name|nd
argument_list|,
operator|&
name|named
argument_list|,
name|dp
argument_list|,
literal|1
argument_list|,
name|exp
argument_list|,
name|p
argument_list|,
operator|&
name|dirp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|vput
argument_list|(
name|dp
argument_list|)
expr_stmt|;
name|nfsvno_relpathbuf
argument_list|(
operator|&
name|named
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dirp
condition|)
name|vrele
argument_list|(
name|dirp
argument_list|)
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_repstat
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|vrele
argument_list|(
name|named
operator|.
name|ni_startdir
argument_list|)
expr_stmt|;
name|nfsvno_relpathbuf
argument_list|(
operator|&
name|named
argument_list|)
expr_stmt|;
name|fh
operator|.
name|nfsrvfh_len
operator|=
name|NFSX_MYFH
expr_stmt|;
name|vp
operator|=
name|named
operator|.
name|ni_vp
expr_stmt|;
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_getfh
argument_list|(
name|vp
argument_list|,
operator|(
name|fhandle_t
operator|*
operator|)
name|fh
operator|.
name|nfsrvfh_data
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|vput
argument_list|(
name|vp
argument_list|)
expr_stmt|;
name|savflag
operator|=
name|nd
operator|->
name|nd_flag
expr_stmt|;
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|nfsd_fhtovp
argument_list|(
name|nd
argument_list|,
operator|&
name|fh
argument_list|,
name|LK_SHARED
argument_list|,
operator|&
name|vp
argument_list|,
operator|&
name|retnes
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|vp
condition|)
name|vput
argument_list|(
name|vp
argument_list|)
expr_stmt|;
block|}
name|nd
operator|->
name|nd_flag
operator|=
name|savflag
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_repstat
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* 	 * Finally have the export flags for name, so we can create 	 * the security info. 	 */
name|len
operator|=
literal|0
expr_stmt|;
name|NFSM_BUILD
argument_list|(
name|sizp
argument_list|,
name|u_int32_t
operator|*
argument_list|,
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|retnes
operator|.
name|nes_numsecflavor
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|retnes
operator|.
name|nes_secflavors
index|[
name|i
index|]
operator|==
name|AUTH_SYS
condition|)
block|{
name|NFSM_BUILD
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|=
name|txdr_unsigned
argument_list|(
name|RPCAUTH_UNIX
argument_list|)
expr_stmt|;
name|len
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|retnes
operator|.
name|nes_secflavors
index|[
name|i
index|]
operator|==
name|RPCSEC_GSS_KRB5
condition|)
block|{
name|NFSM_BUILD
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
name|txdr_unsigned
argument_list|(
name|RPCAUTH_GSS
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|nfsm_strtom
argument_list|(
name|nd
argument_list|,
name|nfsgss_mechlist
index|[
name|KERBV_MECH
index|]
operator|.
name|str
argument_list|,
name|nfsgss_mechlist
index|[
name|KERBV_MECH
index|]
operator|.
name|len
argument_list|)
expr_stmt|;
name|NFSM_BUILD
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
literal|2
operator|*
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
name|txdr_unsigned
argument_list|(
name|GSS_KERBV_QOP
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|=
name|txdr_unsigned
argument_list|(
name|RPCAUTHGSS_SVCNONE
argument_list|)
expr_stmt|;
name|len
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|retnes
operator|.
name|nes_secflavors
index|[
name|i
index|]
operator|==
name|RPCSEC_GSS_KRB5I
condition|)
block|{
name|NFSM_BUILD
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
name|txdr_unsigned
argument_list|(
name|RPCAUTH_GSS
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|nfsm_strtom
argument_list|(
name|nd
argument_list|,
name|nfsgss_mechlist
index|[
name|KERBV_MECH
index|]
operator|.
name|str
argument_list|,
name|nfsgss_mechlist
index|[
name|KERBV_MECH
index|]
operator|.
name|len
argument_list|)
expr_stmt|;
name|NFSM_BUILD
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
literal|2
operator|*
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
name|txdr_unsigned
argument_list|(
name|GSS_KERBV_QOP
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|=
name|txdr_unsigned
argument_list|(
name|RPCAUTHGSS_SVCINTEGRITY
argument_list|)
expr_stmt|;
name|len
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|retnes
operator|.
name|nes_secflavors
index|[
name|i
index|]
operator|==
name|RPCSEC_GSS_KRB5P
condition|)
block|{
name|NFSM_BUILD
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
name|txdr_unsigned
argument_list|(
name|RPCAUTH_GSS
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|nfsm_strtom
argument_list|(
name|nd
argument_list|,
name|nfsgss_mechlist
index|[
name|KERBV_MECH
index|]
operator|.
name|str
argument_list|,
name|nfsgss_mechlist
index|[
name|KERBV_MECH
index|]
operator|.
name|len
argument_list|)
expr_stmt|;
name|NFSM_BUILD
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
literal|2
operator|*
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
name|txdr_unsigned
argument_list|(
name|GSS_KERBV_QOP
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|=
name|txdr_unsigned
argument_list|(
name|RPCAUTHGSS_SVCPRIVACY
argument_list|)
expr_stmt|;
name|len
operator|++
expr_stmt|;
block|}
block|}
operator|*
name|sizp
operator|=
name|txdr_unsigned
argument_list|(
name|len
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * nfsv4 set client id service  */
end_comment

begin_function
name|APPLESTATIC
name|int
name|nfsrvd_setclientid
parameter_list|(
name|struct
name|nfsrv_descript
modifier|*
name|nd
parameter_list|,
name|__unused
name|int
name|isdgram
parameter_list|,
name|__unused
name|vnode_t
name|vp
parameter_list|,
name|NFSPROC_T
modifier|*
name|p
parameter_list|,
name|__unused
name|struct
name|nfsexstuff
modifier|*
name|exp
parameter_list|)
block|{
name|u_int32_t
modifier|*
name|tl
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|,
name|idlen
decl_stmt|;
name|struct
name|nfsclient
modifier|*
name|clp
init|=
name|NULL
decl_stmt|;
name|struct
name|sockaddr_in
modifier|*
name|rad
decl_stmt|;
name|u_char
modifier|*
name|verf
decl_stmt|,
modifier|*
name|ucp
decl_stmt|,
modifier|*
name|ucp2
decl_stmt|,
name|addrbuf
index|[
literal|24
index|]
decl_stmt|;
name|nfsquad_t
name|clientid
decl_stmt|,
name|confirm
decl_stmt|;
if|if
condition|(
name|nfs_rootfhset
operator|==
literal|0
operator|||
name|nfsd_checkrootexp
argument_list|(
name|nd
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|nd
operator|->
name|nd_repstat
operator|=
name|NFSERR_WRONGSEC
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|NFSM_DISSECT
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
name|NFSX_VERF
operator|+
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|verf
operator|=
operator|(
name|u_char
operator|*
operator|)
name|tl
expr_stmt|;
name|tl
operator|+=
operator|(
name|NFSX_VERF
operator|/
name|NFSX_UNSIGNED
operator|)
expr_stmt|;
name|i
operator|=
name|fxdr_unsigned
argument_list|(
name|int
argument_list|,
operator|*
name|tl
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|>
name|NFSV4_OPAQUELIMIT
operator|||
name|i
operator|<=
literal|0
condition|)
block|{
name|nd
operator|->
name|nd_repstat
operator|=
name|NFSERR_BADXDR
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|idlen
operator|=
name|i
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_GSS
condition|)
name|i
operator|+=
name|nd
operator|->
name|nd_princlen
expr_stmt|;
name|MALLOC
argument_list|(
name|clp
argument_list|,
expr|struct
name|nfsclient
operator|*
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|nfsclient
argument_list|)
operator|+
name|i
argument_list|,
name|M_NFSDCLIENT
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|NFSBZERO
argument_list|(
operator|(
name|caddr_t
operator|)
name|clp
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|nfsclient
argument_list|)
operator|+
name|i
argument_list|)
expr_stmt|;
name|NFSINITSOCKMUTEX
argument_list|(
operator|&
name|clp
operator|->
name|lc_req
operator|.
name|nr_mtx
argument_list|)
expr_stmt|;
name|NFSSOCKADDRALLOC
argument_list|(
name|clp
operator|->
name|lc_req
operator|.
name|nr_nam
argument_list|)
expr_stmt|;
name|NFSSOCKADDRSIZE
argument_list|(
name|clp
operator|->
name|lc_req
operator|.
name|nr_nam
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
argument_list|)
expr_stmt|;
name|clp
operator|->
name|lc_req
operator|.
name|nr_cred
operator|=
name|NULL
expr_stmt|;
name|NFSBCOPY
argument_list|(
name|verf
argument_list|,
name|clp
operator|->
name|lc_verf
argument_list|,
name|NFSX_VERF
argument_list|)
expr_stmt|;
name|clp
operator|->
name|lc_idlen
operator|=
name|idlen
expr_stmt|;
name|error
operator|=
name|nfsrv_mtostr
argument_list|(
name|nd
argument_list|,
name|clp
operator|->
name|lc_id
argument_list|,
name|idlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|nfsmout
goto|;
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_GSS
condition|)
block|{
name|clp
operator|->
name|lc_flags
operator|=
name|LCL_GSS
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_GSSINTEGRITY
condition|)
name|clp
operator|->
name|lc_flags
operator||=
name|LCL_GSSINTEGRITY
expr_stmt|;
elseif|else
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_GSSPRIVACY
condition|)
name|clp
operator|->
name|lc_flags
operator||=
name|LCL_GSSPRIVACY
expr_stmt|;
block|}
else|else
block|{
name|clp
operator|->
name|lc_flags
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_GSS
operator|)
operator|&&
name|nd
operator|->
name|nd_princlen
operator|>
literal|0
condition|)
block|{
name|clp
operator|->
name|lc_flags
operator||=
name|LCL_NAME
expr_stmt|;
name|clp
operator|->
name|lc_namelen
operator|=
name|nd
operator|->
name|nd_princlen
expr_stmt|;
name|clp
operator|->
name|lc_name
operator|=
operator|&
name|clp
operator|->
name|lc_id
index|[
name|idlen
index|]
expr_stmt|;
name|NFSBCOPY
argument_list|(
name|nd
operator|->
name|nd_principal
argument_list|,
name|clp
operator|->
name|lc_name
argument_list|,
name|clp
operator|->
name|lc_namelen
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|clp
operator|->
name|lc_uid
operator|=
name|nd
operator|->
name|nd_cred
operator|->
name|cr_uid
expr_stmt|;
name|clp
operator|->
name|lc_gid
operator|=
name|nd
operator|->
name|nd_cred
operator|->
name|cr_gid
expr_stmt|;
block|}
name|NFSM_DISSECT
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|clp
operator|->
name|lc_program
operator|=
name|fxdr_unsigned
argument_list|(
name|u_int32_t
argument_list|,
operator|*
name|tl
argument_list|)
expr_stmt|;
name|error
operator|=
name|nfsrv_getclientipaddr
argument_list|(
name|nd
argument_list|,
name|clp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|nfsmout
goto|;
name|NFSM_DISSECT
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|clp
operator|->
name|lc_callback
operator|=
name|fxdr_unsigned
argument_list|(
name|u_int32_t
argument_list|,
operator|*
name|tl
argument_list|)
expr_stmt|;
comment|/* 	 * nfsrv_setclient() does the actual work of adding it to the 	 * client list. If there is no error, the structure has been 	 * linked into the client list and clp should no longer be used 	 * here. When an error is returned, it has not been linked in, 	 * so it should be free'd. 	 */
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsrv_setclient
argument_list|(
name|nd
argument_list|,
operator|&
name|clp
argument_list|,
operator|&
name|clientid
argument_list|,
operator|&
name|confirm
argument_list|,
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_repstat
operator|==
name|NFSERR_CLIDINUSE
condition|)
block|{
if|if
condition|(
name|clp
operator|->
name|lc_flags
operator|&
name|LCL_TCPCALLBACK
condition|)
operator|(
name|void
operator|)
name|nfsm_strtom
argument_list|(
name|nd
argument_list|,
literal|"tcp"
argument_list|,
literal|3
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|nfsm_strtom
argument_list|(
name|nd
argument_list|,
literal|"udp"
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|rad
operator|=
name|NFSSOCKADDR
argument_list|(
name|clp
operator|->
name|lc_req
operator|.
name|nr_nam
argument_list|,
expr|struct
name|sockaddr_in
operator|*
argument_list|)
expr_stmt|;
name|ucp
operator|=
operator|(
name|u_char
operator|*
operator|)
operator|&
name|rad
operator|->
name|sin_addr
operator|.
name|s_addr
expr_stmt|;
name|ucp2
operator|=
operator|(
name|u_char
operator|*
operator|)
operator|&
name|rad
operator|->
name|sin_port
expr_stmt|;
name|sprintf
argument_list|(
name|addrbuf
argument_list|,
literal|"%d.%d.%d.%d.%d.%d"
argument_list|,
name|ucp
index|[
literal|0
index|]
operator|&
literal|0xff
argument_list|,
name|ucp
index|[
literal|1
index|]
operator|&
literal|0xff
argument_list|,
name|ucp
index|[
literal|2
index|]
operator|&
literal|0xff
argument_list|,
name|ucp
index|[
literal|3
index|]
operator|&
literal|0xff
argument_list|,
name|ucp2
index|[
literal|0
index|]
operator|&
literal|0xff
argument_list|,
name|ucp2
index|[
literal|1
index|]
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|nfsm_strtom
argument_list|(
name|nd
argument_list|,
name|addrbuf
argument_list|,
name|strlen
argument_list|(
name|addrbuf
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|clp
condition|)
block|{
name|NFSSOCKADDRFREE
argument_list|(
name|clp
operator|->
name|lc_req
operator|.
name|nr_nam
argument_list|)
expr_stmt|;
name|NFSFREEMUTEX
argument_list|(
operator|&
name|clp
operator|->
name|lc_req
operator|.
name|nr_mtx
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|caddr_t
operator|)
name|clp
argument_list|,
name|M_NFSDCLIENT
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|NFSM_BUILD
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
literal|2
operator|*
name|NFSX_HYPER
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
name|clientid
operator|.
name|lval
index|[
literal|0
index|]
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
name|clientid
operator|.
name|lval
index|[
literal|1
index|]
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
name|confirm
operator|.
name|lval
index|[
literal|0
index|]
expr_stmt|;
operator|*
name|tl
operator|=
name|confirm
operator|.
name|lval
index|[
literal|1
index|]
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|nfsmout
label|:
if|if
condition|(
name|clp
condition|)
block|{
name|NFSSOCKADDRFREE
argument_list|(
name|clp
operator|->
name|lc_req
operator|.
name|nr_nam
argument_list|)
expr_stmt|;
name|NFSFREEMUTEX
argument_list|(
operator|&
name|clp
operator|->
name|lc_req
operator|.
name|nr_mtx
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|caddr_t
operator|)
name|clp
argument_list|,
name|M_NFSDCLIENT
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * nfsv4 set client id confirm service  */
end_comment

begin_function
name|APPLESTATIC
name|int
name|nfsrvd_setclientidcfrm
parameter_list|(
name|struct
name|nfsrv_descript
modifier|*
name|nd
parameter_list|,
name|__unused
name|int
name|isdgram
parameter_list|,
name|__unused
name|vnode_t
name|vp
parameter_list|,
name|NFSPROC_T
modifier|*
name|p
parameter_list|,
name|__unused
name|struct
name|nfsexstuff
modifier|*
name|exp
parameter_list|)
block|{
name|u_int32_t
modifier|*
name|tl
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|nfsquad_t
name|clientid
decl_stmt|,
name|confirm
decl_stmt|;
if|if
condition|(
name|nfs_rootfhset
operator|==
literal|0
operator|||
name|nfsd_checkrootexp
argument_list|(
name|nd
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|nd
operator|->
name|nd_repstat
operator|=
name|NFSERR_WRONGSEC
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|NFSM_DISSECT
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
literal|2
operator|*
name|NFSX_HYPER
argument_list|)
expr_stmt|;
name|clientid
operator|.
name|lval
index|[
literal|0
index|]
operator|=
operator|*
name|tl
operator|++
expr_stmt|;
name|clientid
operator|.
name|lval
index|[
literal|1
index|]
operator|=
operator|*
name|tl
operator|++
expr_stmt|;
name|confirm
operator|.
name|lval
index|[
literal|0
index|]
operator|=
operator|*
name|tl
operator|++
expr_stmt|;
name|confirm
operator|.
name|lval
index|[
literal|1
index|]
operator|=
operator|*
name|tl
expr_stmt|;
comment|/* 	 * nfsrv_getclient() searches the client list for a match and 	 * returns the appropriate NFSERR status. 	 */
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsrv_getclient
argument_list|(
name|clientid
argument_list|,
operator|(
name|CLOPS_CONFIRM
operator||
name|CLOPS_RENEW
operator|)
argument_list|,
name|NULL
argument_list|,
name|confirm
argument_list|,
name|nd
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|nfsmout
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * nfsv4 verify service  */
end_comment

begin_function
name|APPLESTATIC
name|int
name|nfsrvd_verify
parameter_list|(
name|struct
name|nfsrv_descript
modifier|*
name|nd
parameter_list|,
name|int
name|isdgram
parameter_list|,
name|vnode_t
name|vp
parameter_list|,
name|NFSPROC_T
modifier|*
name|p
parameter_list|,
name|__unused
name|struct
name|nfsexstuff
modifier|*
name|exp
parameter_list|)
block|{
name|int
name|error
init|=
literal|0
decl_stmt|,
name|ret
decl_stmt|,
name|fhsize
init|=
name|NFSX_MYFH
decl_stmt|;
name|struct
name|nfsvattr
name|nva
decl_stmt|;
name|struct
name|statfs
name|sf
decl_stmt|;
name|struct
name|nfsfsinfo
name|fs
decl_stmt|;
name|fhandle_t
name|fh
decl_stmt|;
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_getattr
argument_list|(
name|vp
argument_list|,
operator|&
name|nva
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|,
name|p
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_statfs
argument_list|(
name|vp
argument_list|,
operator|&
name|sf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsvno_getfh
argument_list|(
name|vp
argument_list|,
operator|&
name|fh
argument_list|,
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|nd
operator|->
name|nd_repstat
condition|)
block|{
name|nfsvno_getfs
argument_list|(
operator|&
name|fs
argument_list|,
name|isdgram
argument_list|)
expr_stmt|;
name|error
operator|=
name|nfsv4_loadattr
argument_list|(
name|nd
argument_list|,
name|vp
argument_list|,
operator|&
name|nva
argument_list|,
name|NULL
argument_list|,
operator|&
name|fh
argument_list|,
name|fhsize
argument_list|,
name|NULL
argument_list|,
operator|&
name|sf
argument_list|,
name|NULL
argument_list|,
operator|&
name|fs
argument_list|,
name|NULL
argument_list|,
literal|1
argument_list|,
operator|&
name|ret
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|p
argument_list|,
name|nd
operator|->
name|nd_cred
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
block|{
if|if
condition|(
name|nd
operator|->
name|nd_procnum
operator|==
name|NFSV4OP_NVERIFY
condition|)
block|{
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|NFSERR_SAME
expr_stmt|;
elseif|else
if|if
condition|(
name|ret
operator|!=
name|NFSERR_NOTSAME
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|ret
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ret
condition|)
name|nd
operator|->
name|nd_repstat
operator|=
name|ret
expr_stmt|;
block|}
block|}
name|vput
argument_list|(
name|vp
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * nfs openattr rpc  */
end_comment

begin_function
name|APPLESTATIC
name|int
name|nfsrvd_openattr
parameter_list|(
name|struct
name|nfsrv_descript
modifier|*
name|nd
parameter_list|,
name|__unused
name|int
name|isdgram
parameter_list|,
name|vnode_t
name|dp
parameter_list|,
name|__unused
name|vnode_t
modifier|*
name|vpp
parameter_list|,
name|__unused
name|fhandle_t
modifier|*
name|fhp
parameter_list|,
name|__unused
name|NFSPROC_T
modifier|*
name|p
parameter_list|,
name|__unused
name|struct
name|nfsexstuff
modifier|*
name|exp
parameter_list|)
block|{
name|u_int32_t
modifier|*
name|tl
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|,
name|createdir
decl_stmt|;
name|NFSM_DISSECT
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|createdir
operator|=
name|fxdr_unsigned
argument_list|(
name|int
argument_list|,
operator|*
name|tl
argument_list|)
expr_stmt|;
name|nd
operator|->
name|nd_repstat
operator|=
name|NFSERR_NOTSUPP
expr_stmt|;
name|nfsmout
label|:
name|vrele
argument_list|(
name|dp
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * nfsv4 release lock owner service  */
end_comment

begin_function
name|APPLESTATIC
name|int
name|nfsrvd_releaselckown
parameter_list|(
name|struct
name|nfsrv_descript
modifier|*
name|nd
parameter_list|,
name|__unused
name|int
name|isdgram
parameter_list|,
name|__unused
name|vnode_t
name|vp
parameter_list|,
name|NFSPROC_T
modifier|*
name|p
parameter_list|,
name|__unused
name|struct
name|nfsexstuff
modifier|*
name|exp
parameter_list|)
block|{
name|u_int32_t
modifier|*
name|tl
decl_stmt|;
name|struct
name|nfsstate
modifier|*
name|stp
init|=
name|NULL
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|,
name|len
decl_stmt|;
name|nfsquad_t
name|clientid
decl_stmt|;
if|if
condition|(
name|nfs_rootfhset
operator|==
literal|0
operator|||
name|nfsd_checkrootexp
argument_list|(
name|nd
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|nd
operator|->
name|nd_repstat
operator|=
name|NFSERR_WRONGSEC
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|NFSM_DISSECT
argument_list|(
name|tl
argument_list|,
name|u_int32_t
operator|*
argument_list|,
literal|3
operator|*
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|len
operator|=
name|fxdr_unsigned
argument_list|(
name|int
argument_list|,
operator|*
operator|(
name|tl
operator|+
literal|2
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<=
literal|0
operator|||
name|len
operator|>
name|NFSV4_OPAQUELIMIT
condition|)
block|{
name|nd
operator|->
name|nd_repstat
operator|=
name|NFSERR_BADXDR
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|MALLOC
argument_list|(
name|stp
argument_list|,
expr|struct
name|nfsstate
operator|*
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|nfsstate
argument_list|)
operator|+
name|len
argument_list|,
name|M_NFSDSTATE
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|stp
operator|->
name|ls_ownerlen
operator|=
name|len
expr_stmt|;
name|stp
operator|->
name|ls_op
operator|=
name|NULL
expr_stmt|;
name|stp
operator|->
name|ls_flags
operator|=
name|NFSLCK_RELEASE
expr_stmt|;
name|stp
operator|->
name|ls_uid
operator|=
name|nd
operator|->
name|nd_cred
operator|->
name|cr_uid
expr_stmt|;
name|clientid
operator|.
name|lval
index|[
literal|0
index|]
operator|=
operator|*
name|tl
operator|++
expr_stmt|;
name|clientid
operator|.
name|lval
index|[
literal|1
index|]
operator|=
operator|*
name|tl
expr_stmt|;
if|if
condition|(
name|nd
operator|->
name|nd_flag
operator|&
name|ND_IMPLIEDCLID
condition|)
block|{
if|if
condition|(
name|nd
operator|->
name|nd_clientid
operator|.
name|qval
operator|!=
name|clientid
operator|.
name|qval
condition|)
name|printf
argument_list|(
literal|"EEK! multiple clids\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|nd
operator|->
name|nd_flag
operator||=
name|ND_IMPLIEDCLID
expr_stmt|;
name|nd
operator|->
name|nd_clientid
operator|.
name|qval
operator|=
name|clientid
operator|.
name|qval
expr_stmt|;
block|}
name|error
operator|=
name|nfsrv_mtostr
argument_list|(
name|nd
argument_list|,
name|stp
operator|->
name|ls_owner
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|nfsmout
goto|;
name|nd
operator|->
name|nd_repstat
operator|=
name|nfsrv_releaselckown
argument_list|(
name|stp
argument_list|,
name|clientid
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|FREE
argument_list|(
operator|(
name|caddr_t
operator|)
name|stp
argument_list|,
name|M_NFSDSTATE
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|nfsmout
label|:
if|if
condition|(
name|stp
condition|)
name|free
argument_list|(
operator|(
name|caddr_t
operator|)
name|stp
argument_list|,
name|M_NFSDSTATE
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 1998, 1999 Semen Ustimenko (semenu@FreeBSD.org)  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<sys/vnode.h>
end_include

begin_include
include|#
directive|include
file|<sys/mount.h>
end_include

begin_include
include|#
directive|include
file|<sys/namei.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/bio.h>
end_include

begin_include
include|#
directive|include
file|<sys/buf.h>
end_include

begin_include
include|#
directive|include
file|<fs/hpfs/hpfs.h>
end_include

begin_include
include|#
directive|include
file|<fs/hpfs/hpfsmount.h>
end_include

begin_include
include|#
directive|include
file|<fs/hpfs/hpfs_subr.h>
end_include

begin_function
name|u_long
name|hpfs_checksum
parameter_list|(
name|u_int8_t
modifier|*
name|object
parameter_list|,
name|int
name|size
parameter_list|)
block|{
specifier|register
name|int
name|i
decl_stmt|;
name|u_long
name|csum
init|=
literal|0L
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|size
condition|;
name|i
operator|++
control|)
block|{
name|csum
operator|+=
operator|(
name|u_long
operator|)
operator|*
name|object
operator|++
expr_stmt|;
name|csum
operator|=
operator|(
name|csum
operator|<<
literal|7
operator|)
operator|+
operator|(
name|csum
operator|>>
operator|(
literal|25
operator|)
operator|)
expr_stmt|;
block|}
return|return
operator|(
name|csum
operator|)
return|;
block|}
end_function

begin_function
name|void
name|hpfs_bmdeinit
parameter_list|(
name|struct
name|hpfsmount
modifier|*
name|hpmp
parameter_list|)
block|{
name|struct
name|buf
modifier|*
name|bp
decl_stmt|;
name|int
name|i
decl_stmt|;
name|dprintf
argument_list|(
operator|(
literal|"hpmp_bmdeinit: "
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|hpmp
operator|->
name|hpm_mp
operator|->
name|mnt_flag
operator|&
name|MNT_RDONLY
operator|)
condition|)
block|{
comment|/* 		 * Write down BitMap. 		 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|hpmp
operator|->
name|hpm_dbnum
condition|;
name|i
operator|++
control|)
block|{
name|dprintf
argument_list|(
operator|(
literal|"[%d: 0x%x] "
operator|,
name|i
operator|,
name|hpmp
operator|->
name|hpm_bmind
index|[
name|i
index|]
operator|)
argument_list|)
expr_stmt|;
name|bp
operator|=
name|getblk
argument_list|(
name|hpmp
operator|->
name|hpm_devvp
argument_list|,
name|hpmp
operator|->
name|hpm_bmind
index|[
name|i
index|]
argument_list|,
name|BMSIZE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|clrbuf
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|hpmp
operator|->
name|hpm_bitmap
operator|+
name|BMSIZE
operator|*
name|i
argument_list|,
name|bp
operator|->
name|b_data
argument_list|,
name|BMSIZE
argument_list|)
expr_stmt|;
name|bwrite
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
block|}
name|FREE
argument_list|(
name|hpmp
operator|->
name|hpm_bitmap
argument_list|,
name|M_HPFSMNT
argument_list|)
expr_stmt|;
name|FREE
argument_list|(
name|hpmp
operator|->
name|hpm_bmind
argument_list|,
name|M_HPFSMNT
argument_list|)
expr_stmt|;
name|dprintf
argument_list|(
operator|(
literal|"\n"
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Initialize BitMap management, includes calculation of  * available blocks number.  */
end_comment

begin_function
name|int
name|hpfs_bminit
parameter_list|(
name|struct
name|hpfsmount
modifier|*
name|hpmp
parameter_list|)
block|{
name|struct
name|buf
modifier|*
name|bp
decl_stmt|;
name|int
name|error
decl_stmt|,
name|i
decl_stmt|,
name|k
decl_stmt|;
name|u_long
name|dbavail
decl_stmt|;
name|dprintf
argument_list|(
operator|(
literal|"hpfs_bminit: "
operator|)
argument_list|)
expr_stmt|;
name|hpmp
operator|->
name|hpm_dbnum
operator|=
operator|(
name|hpmp
operator|->
name|hpm_su
operator|.
name|su_btotal
operator|+
literal|0x3FFF
operator|)
operator|/
literal|0x4000
expr_stmt|;
name|dprintf
argument_list|(
operator|(
literal|"0x%lx data bands, "
operator|,
name|hpmp
operator|->
name|hpm_dbnum
operator|)
argument_list|)
expr_stmt|;
name|MALLOC
argument_list|(
name|hpmp
operator|->
name|hpm_bmind
argument_list|,
name|lsn_t
operator|*
argument_list|,
name|hpmp
operator|->
name|hpm_dbnum
operator|*
sizeof|sizeof
argument_list|(
name|lsn_t
argument_list|)
argument_list|,
name|M_HPFSMNT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|MALLOC
argument_list|(
name|hpmp
operator|->
name|hpm_bitmap
argument_list|,
name|u_int8_t
operator|*
argument_list|,
name|hpmp
operator|->
name|hpm_dbnum
operator|*
name|BMSIZE
argument_list|,
name|M_HPFSMNT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|error
operator|=
name|bread
argument_list|(
name|hpmp
operator|->
name|hpm_devvp
argument_list|,
name|hpmp
operator|->
name|hpm_su
operator|.
name|su_bitmap
operator|.
name|lsn1
argument_list|,
operator|(
operator|(
name|hpmp
operator|->
name|hpm_dbnum
operator|+
literal|0x7F
operator|)
operator|&
operator|~
operator|(
literal|0x7F
operator|)
operator|)
operator|<<
literal|2
argument_list|,
name|NOCRED
argument_list|,
operator|&
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|brelse
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|FREE
argument_list|(
name|hpmp
operator|->
name|hpm_bitmap
argument_list|,
name|M_HPFSMNT
argument_list|)
expr_stmt|;
name|FREE
argument_list|(
name|hpmp
operator|->
name|hpm_bmind
argument_list|,
name|M_HPFSMNT
argument_list|)
expr_stmt|;
name|dprintf
argument_list|(
operator|(
literal|" error %d\n"
operator|,
name|error
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|bcopy
argument_list|(
name|bp
operator|->
name|b_data
argument_list|,
name|hpmp
operator|->
name|hpm_bmind
argument_list|,
name|hpmp
operator|->
name|hpm_dbnum
operator|*
sizeof|sizeof
argument_list|(
name|lsn_t
argument_list|)
argument_list|)
expr_stmt|;
name|brelse
argument_list|(
name|bp
argument_list|)
expr_stmt|;
comment|/* 	 * Read in all BitMap 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|hpmp
operator|->
name|hpm_dbnum
condition|;
name|i
operator|++
control|)
block|{
name|dprintf
argument_list|(
operator|(
literal|"[%d: 0x%x] "
operator|,
name|i
operator|,
name|hpmp
operator|->
name|hpm_bmind
index|[
name|i
index|]
operator|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|bread
argument_list|(
name|hpmp
operator|->
name|hpm_devvp
argument_list|,
name|hpmp
operator|->
name|hpm_bmind
index|[
name|i
index|]
argument_list|,
name|BMSIZE
argument_list|,
name|NOCRED
argument_list|,
operator|&
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|brelse
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|FREE
argument_list|(
name|hpmp
operator|->
name|hpm_bitmap
argument_list|,
name|M_HPFSMNT
argument_list|)
expr_stmt|;
name|FREE
argument_list|(
name|hpmp
operator|->
name|hpm_bmind
argument_list|,
name|M_HPFSMNT
argument_list|)
expr_stmt|;
name|dprintf
argument_list|(
operator|(
literal|" error %d\n"
operator|,
name|error
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|bcopy
argument_list|(
name|bp
operator|->
name|b_data
argument_list|,
name|hpmp
operator|->
name|hpm_bitmap
operator|+
name|BMSIZE
operator|*
name|i
argument_list|,
name|BMSIZE
argument_list|)
expr_stmt|;
name|brelse
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Look througth BitMap	and count free bits 	 */
name|dbavail
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|hpmp
operator|->
name|hpm_su
operator|.
name|su_btotal
operator|>>
literal|5
condition|;
name|i
operator|++
control|)
block|{
specifier|register
name|u_int32_t
name|mask
decl_stmt|;
for|for
control|(
name|k
operator|=
literal|0
operator|,
name|mask
operator|=
literal|1
init|;
name|k
operator|<
literal|32
condition|;
name|k
operator|++
operator|,
name|mask
operator|<<=
literal|1
control|)
if|if
condition|(
operator|(
operator|(
name|u_int32_t
operator|*
operator|)
name|hpmp
operator|->
name|hpm_bitmap
operator|)
index|[
name|i
index|]
operator|&
name|mask
condition|)
name|dbavail
operator|++
expr_stmt|;
block|}
name|hpmp
operator|->
name|hpm_bavail
operator|=
name|dbavail
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|hpfs_cmpfname
parameter_list|(
name|struct
name|hpfsmount
modifier|*
name|hpmp
parameter_list|,
name|char
modifier|*
name|uname
parameter_list|,
name|int
name|ulen
parameter_list|,
name|char
modifier|*
name|dname
parameter_list|,
name|int
name|dlen
parameter_list|,
name|u_int16_t
name|cp
parameter_list|)
block|{
specifier|register
name|int
name|i
decl_stmt|,
name|res
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ulen
operator|&&
name|i
operator|<
name|dlen
condition|;
name|i
operator|++
control|)
block|{
name|res
operator|=
name|hpfs_toupper
argument_list|(
name|hpmp
argument_list|,
name|hpfs_u2d
argument_list|(
name|hpmp
argument_list|,
name|uname
index|[
name|i
index|]
argument_list|)
argument_list|,
name|cp
argument_list|)
operator|-
name|hpfs_toupper
argument_list|(
name|hpmp
argument_list|,
name|dname
index|[
name|i
index|]
argument_list|,
name|cp
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
condition|)
return|return
name|res
return|;
block|}
return|return
operator|(
name|ulen
operator|-
name|dlen
operator|)
return|;
block|}
end_function

begin_function
name|int
name|hpfs_cpstrnnicmp
parameter_list|(
name|struct
name|hpfsmount
modifier|*
name|hpmp
parameter_list|,
name|char
modifier|*
name|str1
parameter_list|,
name|int
name|str1len
parameter_list|,
name|u_int16_t
name|str1cp
parameter_list|,
name|char
modifier|*
name|str2
parameter_list|,
name|int
name|str2len
parameter_list|,
name|u_int16_t
name|str2cp
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|res
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|str1len
operator|&&
name|i
operator|<
name|str2len
condition|;
name|i
operator|++
control|)
block|{
name|res
operator|=
operator|(
name|int
operator|)
name|hpfs_toupper
argument_list|(
name|hpmp
argument_list|,
operator|(
operator|(
name|u_char
operator|*
operator|)
name|str1
operator|)
index|[
name|i
index|]
argument_list|,
name|str1cp
argument_list|)
operator|-
operator|(
name|int
operator|)
name|hpfs_toupper
argument_list|(
name|hpmp
argument_list|,
operator|(
operator|(
name|u_char
operator|*
operator|)
name|str2
operator|)
index|[
name|i
index|]
argument_list|,
name|str2cp
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
condition|)
return|return
name|res
return|;
block|}
return|return
operator|(
name|str1len
operator|-
name|str2len
operator|)
return|;
block|}
end_function

begin_function
name|int
name|hpfs_cpload
parameter_list|(
name|struct
name|hpfsmount
modifier|*
name|hpmp
parameter_list|,
name|struct
name|cpiblk
modifier|*
name|cpibp
parameter_list|,
name|struct
name|cpdblk
modifier|*
name|cpdbp
parameter_list|)
block|{
name|struct
name|buf
modifier|*
name|bp
decl_stmt|;
name|struct
name|cpdsec
modifier|*
name|cpdsp
decl_stmt|;
name|int
name|error
decl_stmt|,
name|i
decl_stmt|;
name|error
operator|=
name|bread
argument_list|(
name|hpmp
operator|->
name|hpm_devvp
argument_list|,
name|cpibp
operator|->
name|b_cpdsec
argument_list|,
name|DEV_BSIZE
argument_list|,
name|NOCRED
argument_list|,
operator|&
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|brelse
argument_list|(
name|bp
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|cpdsp
operator|=
operator|(
expr|struct
name|cpdsec
operator|*
operator|)
name|bp
operator|->
name|b_data
expr_stmt|;
for|for
control|(
name|i
operator|=
name|cpdsp
operator|->
name|d_cpfirst
init|;
name|i
operator|<
name|cpdsp
operator|->
name|d_cpcnt
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|cpdsp
operator|->
name|d_cpdblk
index|[
name|i
index|]
operator|.
name|b_cpid
operator|==
name|cpibp
operator|->
name|b_cpid
condition|)
block|{
name|bcopy
argument_list|(
name|cpdsp
operator|->
name|d_cpdblk
operator|+
name|i
argument_list|,
name|cpdbp
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|cpdblk
argument_list|)
argument_list|)
expr_stmt|;
name|brelse
argument_list|(
name|bp
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
name|brelse
argument_list|(
name|bp
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOENT
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Initialize Code Page information management.  * Load all copdepages in memory.  */
end_comment

begin_function
name|int
name|hpfs_cpinit
parameter_list|(
name|struct
name|hpfsmount
modifier|*
name|hpmp
parameter_list|,
name|struct
name|hpfs_args
modifier|*
name|argsp
parameter_list|)
block|{
name|struct
name|buf
modifier|*
name|bp
decl_stmt|;
name|int
name|error
decl_stmt|,
name|i
decl_stmt|;
name|lsn_t
name|lsn
decl_stmt|;
name|int
name|cpicnt
decl_stmt|;
name|struct
name|cpisec
modifier|*
name|cpisp
decl_stmt|;
name|struct
name|cpiblk
modifier|*
name|cpibp
decl_stmt|;
name|struct
name|cpdblk
modifier|*
name|cpdbp
decl_stmt|;
name|dprintf
argument_list|(
operator|(
literal|"hpfs_cpinit: \n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|argsp
operator|->
name|flags
operator|&
name|HPFSMNT_TABLES
condition|)
block|{
name|bcopy
argument_list|(
name|argsp
operator|->
name|d2u
argument_list|,
name|hpmp
operator|->
name|hpm_d2u
argument_list|,
sizeof|sizeof
argument_list|(
name|u_char
argument_list|)
operator|*
literal|0x80
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|argsp
operator|->
name|u2d
argument_list|,
name|hpmp
operator|->
name|hpm_u2d
argument_list|,
sizeof|sizeof
argument_list|(
name|u_char
argument_list|)
operator|*
literal|0x80
argument_list|)
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0x0
init|;
name|i
operator|<
literal|0x80
condition|;
name|i
operator|++
control|)
block|{
name|hpmp
operator|->
name|hpm_d2u
index|[
name|i
index|]
operator|=
name|i
operator|+
literal|0x80
expr_stmt|;
name|hpmp
operator|->
name|hpm_u2d
index|[
name|i
index|]
operator|=
name|i
operator|+
literal|0x80
expr_stmt|;
block|}
block|}
name|cpicnt
operator|=
name|hpmp
operator|->
name|hpm_sp
operator|.
name|sp_cpinum
expr_stmt|;
name|MALLOC
argument_list|(
name|hpmp
operator|->
name|hpm_cpdblk
argument_list|,
expr|struct
name|cpdblk
operator|*
argument_list|,
name|cpicnt
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|cpdblk
argument_list|)
argument_list|,
name|M_HPFSMNT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|cpdbp
operator|=
name|hpmp
operator|->
name|hpm_cpdblk
expr_stmt|;
name|lsn
operator|=
name|hpmp
operator|->
name|hpm_sp
operator|.
name|sp_cpi
expr_stmt|;
while|while
condition|(
name|cpicnt
operator|>
literal|0
condition|)
block|{
name|error
operator|=
name|bread
argument_list|(
name|hpmp
operator|->
name|hpm_devvp
argument_list|,
name|lsn
argument_list|,
name|DEV_BSIZE
argument_list|,
name|NOCRED
argument_list|,
operator|&
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|brelse
argument_list|(
name|bp
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|cpisp
operator|=
operator|(
expr|struct
name|cpisec
operator|*
operator|)
name|bp
operator|->
name|b_data
expr_stmt|;
name|cpibp
operator|=
name|cpisp
operator|->
name|s_cpi
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cpisp
operator|->
name|s_cpicnt
condition|;
name|i
operator|++
operator|,
name|cpicnt
operator|--
operator|,
name|cpdbp
operator|++
operator|,
name|cpibp
operator|++
control|)
block|{
name|dprintf
argument_list|(
operator|(
literal|"hpfs_cpinit: Country: %d, CP: %d (%d)\n"
operator|,
name|cpibp
operator|->
name|b_country
operator|,
name|cpibp
operator|->
name|b_cpid
operator|,
name|cpibp
operator|->
name|b_vcpid
operator|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|hpfs_cpload
argument_list|(
name|hpmp
argument_list|,
name|cpibp
argument_list|,
name|cpdbp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|brelse
argument_list|(
name|bp
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
block|}
name|lsn
operator|=
name|cpisp
operator|->
name|s_next
expr_stmt|;
name|brelse
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|hpfs_cpdeinit
parameter_list|(
name|struct
name|hpfsmount
modifier|*
name|hpmp
parameter_list|)
block|{
name|dprintf
argument_list|(
operator|(
literal|"hpmp_cpdeinit: "
operator|)
argument_list|)
expr_stmt|;
name|FREE
argument_list|(
name|hpmp
operator|->
name|hpm_cpdblk
argument_list|,
name|M_HPFSMNT
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Lookup for a run of blocks.  */
end_comment

begin_function
name|int
name|hpfs_bmlookup
parameter_list|(
name|struct
name|hpfsmount
modifier|*
name|hpmp
parameter_list|,
name|u_long
name|flags
parameter_list|,
comment|/* 1 means we want right len blocks in run, not less */
name|lsn_t
name|lsn
parameter_list|,
comment|/* We want near this one */
name|u_long
name|len
parameter_list|,
comment|/* We want such long */
name|lsn_t
modifier|*
name|lsnp
parameter_list|,
comment|/* We got here */
name|u_long
modifier|*
name|lenp
parameter_list|)
comment|/* We got this long */
block|{
name|u_int32_t
modifier|*
name|bitmap
decl_stmt|;
specifier|register
name|u_int32_t
name|mask
decl_stmt|;
name|int
name|i
decl_stmt|,
name|k
decl_stmt|;
name|int
name|cband
decl_stmt|,
name|vcband
decl_stmt|;
name|u_int
name|bandsz
decl_stmt|;
name|int
name|count
decl_stmt|;
name|dprintf
argument_list|(
operator|(
literal|"hpfs_bmlookup: lsn: 0x%x, len 0x%lx | Step1\n"
operator|,
name|lsn
operator|,
name|len
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|lsn
operator|>
name|hpmp
operator|->
name|hpm_su
operator|.
name|su_btotal
condition|)
block|{
name|printf
argument_list|(
literal|"hpfs_bmlookup: OUT OF VOLUME\n"
argument_list|)
expr_stmt|;
return|return
name|ENOSPC
return|;
block|}
if|if
condition|(
name|len
operator|>
name|hpmp
operator|->
name|hpm_bavail
condition|)
block|{
name|printf
argument_list|(
literal|"hpfs_bmlookup: OUT OF SPACE\n"
argument_list|)
expr_stmt|;
return|return
name|ENOSPC
return|;
block|}
name|i
operator|=
name|lsn
operator|>>
literal|5
expr_stmt|;
name|k
operator|=
name|lsn
operator|&
literal|0x1F
expr_stmt|;
name|mask
operator|=
literal|1
operator|<<
name|k
expr_stmt|;
name|bitmap
operator|=
operator|(
name|u_int32_t
operator|*
operator|)
name|hpmp
operator|->
name|hpm_bitmap
operator|+
name|i
expr_stmt|;
if|if
condition|(
operator|*
name|bitmap
operator|&
name|mask
condition|)
block|{
operator|*
name|lsnp
operator|=
name|lsn
expr_stmt|;
operator|*
name|lenp
operator|=
literal|0
expr_stmt|;
for|for
control|(
init|;
name|k
operator|<
literal|32
condition|;
name|k
operator|++
operator|,
name|mask
operator|<<=
literal|1
control|)
block|{
if|if
condition|(
operator|*
name|bitmap
operator|&
name|mask
condition|)
operator|(
operator|*
name|lenp
operator|)
operator|++
expr_stmt|;
else|else
block|{
if|if
condition|(
name|flags
operator|&
literal|1
condition|)
goto|goto
name|step2
goto|;
else|else
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
operator|*
name|lenp
operator|==
name|len
condition|)
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|bitmap
operator|++
expr_stmt|;
name|i
operator|++
expr_stmt|;
for|for
control|(
init|;
name|i
operator|<
name|hpmp
operator|->
name|hpm_su
operator|.
name|su_btotal
operator|>>
literal|5
condition|;
name|i
operator|++
operator|,
name|bitmap
operator|++
control|)
block|{
for|for
control|(
name|k
operator|=
literal|0
operator|,
name|mask
operator|=
literal|1
init|;
name|k
operator|<
literal|32
condition|;
name|k
operator|++
operator|,
name|mask
operator|<<=
literal|1
control|)
block|{
if|if
condition|(
operator|*
name|bitmap
operator|&
name|mask
condition|)
operator|(
operator|*
name|lenp
operator|)
operator|++
expr_stmt|;
else|else
block|{
if|if
condition|(
name|flags
operator|&
literal|1
condition|)
goto|goto
name|step2
goto|;
else|else
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
operator|*
name|lenp
operator|==
name|len
condition|)
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|step2
label|:
comment|/* 	 * Lookup all bands begining from cband, lookup for first block 	 */
name|cband
operator|=
operator|(
name|lsn
operator|>>
literal|14
operator|)
expr_stmt|;
name|dprintf
argument_list|(
operator|(
literal|"hpfs_bmlookup: Step2: band 0x%x (0x%lx)\n"
operator|,
name|cband
operator|,
name|hpmp
operator|->
name|hpm_dbnum
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|vcband
operator|=
literal|0
init|;
name|vcband
operator|<
name|hpmp
operator|->
name|hpm_dbnum
condition|;
name|vcband
operator|++
operator|,
name|cband
operator|++
control|)
block|{
name|cband
operator|=
name|cband
operator|%
name|hpmp
operator|->
name|hpm_dbnum
expr_stmt|;
name|bandsz
operator|=
name|min
argument_list|(
name|hpmp
operator|->
name|hpm_su
operator|.
name|su_btotal
operator|-
operator|(
name|cband
operator|<<
literal|14
operator|)
argument_list|,
literal|0x4000
argument_list|)
expr_stmt|;
name|dprintf
argument_list|(
operator|(
literal|"hpfs_bmlookup: band: %d, sz: 0x%x\n"
operator|,
name|cband
operator|,
name|bandsz
operator|)
argument_list|)
expr_stmt|;
name|bitmap
operator|=
operator|(
name|u_int32_t
operator|*
operator|)
name|hpmp
operator|->
name|hpm_bitmap
operator|+
operator|(
name|cband
operator|<<
literal|9
operator|)
expr_stmt|;
operator|*
name|lsnp
operator|=
name|cband
operator|<<
literal|14
expr_stmt|;
operator|*
name|lenp
operator|=
literal|0
expr_stmt|;
name|count
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|bandsz
operator|>>
literal|5
condition|;
name|i
operator|++
operator|,
name|bitmap
operator|++
control|)
block|{
for|for
control|(
name|k
operator|=
literal|0
operator|,
name|mask
operator|=
literal|1
init|;
name|k
operator|<
literal|32
condition|;
name|k
operator|++
operator|,
name|mask
operator|<<=
literal|1
control|)
block|{
if|if
condition|(
operator|*
name|bitmap
operator|&
name|mask
condition|)
block|{
if|if
condition|(
name|count
condition|)
block|{
operator|(
operator|*
name|lenp
operator|)
operator|++
expr_stmt|;
block|}
else|else
block|{
name|count
operator|=
literal|1
expr_stmt|;
operator|*
name|lsnp
operator|=
operator|(
name|cband
operator|<<
literal|14
operator|)
operator|+
operator|(
name|i
operator|<<
literal|5
operator|)
operator|+
name|k
expr_stmt|;
operator|*
name|lenp
operator|=
literal|1
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
operator|(
operator|*
name|lenp
operator|)
operator|&&
operator|!
operator|(
name|flags
operator|&
literal|1
operator|)
condition|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
else|else
block|{
name|count
operator|=
literal|0
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|*
name|lenp
operator|==
name|len
condition|)
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
if|if
condition|(
name|cband
operator|==
name|hpmp
operator|->
name|hpm_dbnum
operator|-
literal|1
condition|)
block|{
if|if
condition|(
operator|(
operator|*
name|lenp
operator|)
operator|&&
operator|!
operator|(
name|flags
operator|&
literal|1
operator|)
condition|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
else|else
block|{
name|count
operator|=
literal|0
expr_stmt|;
block|}
block|}
block|}
return|return
operator|(
name|ENOSPC
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Lookup a single free block.	XXX Need locking on BitMap operations  * VERY STUPID ROUTINE!!!  */
end_comment

begin_function
name|int
name|hpfs_bmfblookup
parameter_list|(
name|struct
name|hpfsmount
modifier|*
name|hpmp
parameter_list|,
name|lsn_t
modifier|*
name|lp
parameter_list|)
block|{
name|u_int32_t
modifier|*
name|bitmap
decl_stmt|;
name|int
name|i
decl_stmt|,
name|k
decl_stmt|;
name|dprintf
argument_list|(
operator|(
literal|"hpfs_bmfblookup: "
operator|)
argument_list|)
expr_stmt|;
name|bitmap
operator|=
operator|(
name|u_int32_t
operator|*
operator|)
name|hpmp
operator|->
name|hpm_bitmap
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|hpmp
operator|->
name|hpm_su
operator|.
name|su_btotal
operator|>>
literal|5
condition|;
name|i
operator|++
operator|,
name|bitmap
operator|++
control|)
block|{
name|k
operator|=
name|ffs
argument_list|(
operator|*
name|bitmap
argument_list|)
expr_stmt|;
if|if
condition|(
name|k
condition|)
block|{
operator|*
name|lp
operator|=
operator|(
name|i
operator|<<
literal|5
operator|)
operator|+
name|k
operator|-
literal|1
expr_stmt|;
name|dprintf
argument_list|(
operator|(
literal|" found: 0x%x\n"
operator|,
operator|*
name|lp
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
return|return
operator|(
name|ENOSPC
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Mark contignous block of blocks.  */
end_comment

begin_function
name|int
name|hpfs_bmmark
parameter_list|(
name|struct
name|hpfsmount
modifier|*
name|hpmp
parameter_list|,
name|lsn_t
name|bn
parameter_list|,
name|u_long
name|bl
parameter_list|,
name|int
name|state
parameter_list|)
block|{
name|u_int32_t
modifier|*
name|bitmap
decl_stmt|;
name|int
name|i
decl_stmt|,
name|didprint
init|=
literal|0
decl_stmt|;
name|dprintf
argument_list|(
operator|(
literal|"hpfs_bmmark(0x%x, 0x%lx, %d): \n"
operator|,
name|bn
operator|,
name|bl
operator|,
name|state
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|bn
operator|>
name|hpmp
operator|->
name|hpm_su
operator|.
name|su_btotal
operator|)
operator|||
operator|(
name|bn
operator|+
name|bl
operator|>
name|hpmp
operator|->
name|hpm_su
operator|.
name|su_btotal
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"hpfs_bmmark: MARKING OUT OF VOLUME\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|bitmap
operator|=
operator|(
name|u_int32_t
operator|*
operator|)
name|hpmp
operator|->
name|hpm_bitmap
expr_stmt|;
name|bitmap
operator|+=
name|bn
operator|>>
literal|5
expr_stmt|;
while|while
condition|(
name|bl
operator|>
literal|0
condition|)
block|{
for|for
control|(
name|i
operator|=
name|bn
operator|&
literal|0x1F
init|;
operator|(
name|i
operator|<
literal|0x20
operator|)
operator|&&
operator|(
name|bl
operator|>
literal|0
operator|)
condition|;
name|i
operator|++
operator|,
name|bl
operator|--
control|)
block|{
if|if
condition|(
name|state
condition|)
block|{
if|if
condition|(
operator|*
name|bitmap
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
condition|)
block|{
if|if
condition|(
operator|!
name|didprint
condition|)
block|{
name|printf
argument_list|(
literal|"hpfs_bmmark: ALREADY FREE\n"
argument_list|)
expr_stmt|;
name|didprint
operator|=
literal|1
expr_stmt|;
block|}
block|}
else|else
name|hpmp
operator|->
name|hpm_bavail
operator|++
expr_stmt|;
operator|*
name|bitmap
operator||=
operator|(
literal|1
operator|<<
name|i
operator|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|(
operator|~
operator|(
operator|*
name|bitmap
operator|)
operator|)
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
condition|)
block|{
if|if
condition|(
operator|!
name|didprint
condition|)
block|{
name|printf
argument_list|(
literal|"hpfs_bmmark: ALREADY BUSY\n"
argument_list|)
expr_stmt|;
name|didprint
operator|=
literal|1
expr_stmt|;
block|}
block|}
else|else
name|hpmp
operator|->
name|hpm_bavail
operator|--
expr_stmt|;
operator|*
name|bitmap
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|i
operator|)
expr_stmt|;
block|}
block|}
name|bn
operator|=
literal|0
expr_stmt|;
name|bitmap
operator|++
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|hpfs_validateparent
parameter_list|(
name|struct
name|hpfsnode
modifier|*
name|hp
parameter_list|)
block|{
name|struct
name|hpfsnode
modifier|*
name|dhp
decl_stmt|;
name|struct
name|vnode
modifier|*
name|dvp
decl_stmt|;
name|struct
name|hpfsmount
modifier|*
name|hpmp
init|=
name|hp
operator|->
name|h_hpmp
decl_stmt|;
name|struct
name|buf
modifier|*
name|bp
decl_stmt|;
name|struct
name|dirblk
modifier|*
name|dp
decl_stmt|;
name|struct
name|hpfsdirent
modifier|*
name|dep
decl_stmt|;
name|lsn_t
name|lsn
decl_stmt|,
name|olsn
decl_stmt|;
name|int
name|level
decl_stmt|,
name|error
decl_stmt|;
name|dprintf
argument_list|(
operator|(
literal|"hpfs_validatetimes(0x%x): [parent: 0x%x] "
operator|,
name|hp
operator|->
name|h_no
operator|,
name|hp
operator|->
name|h_fn
operator|.
name|fn_parent
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|hp
operator|->
name|h_no
operator|==
name|hp
operator|->
name|h_fn
operator|.
name|fn_parent
condition|)
block|{
name|dhp
operator|=
name|hp
expr_stmt|;
block|}
else|else
block|{
name|error
operator|=
name|VFS_VGET
argument_list|(
name|hpmp
operator|->
name|hpm_mp
argument_list|,
name|hp
operator|->
name|h_fn
operator|.
name|fn_parent
argument_list|,
name|LK_EXCLUSIVE
argument_list|,
operator|&
name|dvp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|dhp
operator|=
name|VTOHP
argument_list|(
name|dvp
argument_list|)
expr_stmt|;
block|}
name|lsn
operator|=
operator|(
operator|(
name|alleaf_t
operator|*
operator|)
name|dhp
operator|->
name|h_fn
operator|.
name|fn_abd
operator|)
operator|->
name|al_lsn
expr_stmt|;
name|olsn
operator|=
literal|0
expr_stmt|;
name|level
operator|=
literal|1
expr_stmt|;
name|bp
operator|=
name|NULL
expr_stmt|;
name|dive
label|:
name|dprintf
argument_list|(
operator|(
literal|"[dive 0x%x] "
operator|,
name|lsn
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bp
operator|!=
name|NULL
condition|)
name|brelse
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|error
operator|=
name|bread
argument_list|(
name|dhp
operator|->
name|h_devvp
argument_list|,
name|lsn
argument_list|,
name|D_BSIZE
argument_list|,
name|NOCRED
argument_list|,
operator|&
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|failed
goto|;
name|dp
operator|=
operator|(
expr|struct
name|dirblk
operator|*
operator|)
name|bp
operator|->
name|b_data
expr_stmt|;
if|if
condition|(
name|dp
operator|->
name|d_magic
operator|!=
name|D_MAGIC
condition|)
block|{
name|printf
argument_list|(
literal|"hpfs_validatetimes: magic doesn't match\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|failed
goto|;
block|}
name|dep
operator|=
name|D_DIRENT
argument_list|(
name|dp
argument_list|)
expr_stmt|;
if|if
condition|(
name|olsn
condition|)
block|{
name|dprintf
argument_list|(
operator|(
literal|"[restore 0x%x] "
operator|,
name|olsn
operator|)
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
operator|(
name|dep
operator|->
name|de_flag
operator|&
name|DE_END
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|dep
operator|->
name|de_flag
operator|&
name|DE_DOWN
operator|)
operator|&&
operator|(
name|olsn
operator|==
name|DE_DOWNLSN
argument_list|(
name|dep
argument_list|)
operator|)
condition|)
break|break;
name|dep
operator|=
operator|(
name|hpfsdirent_t
operator|*
operator|)
operator|(
operator|(
name|caddr_t
operator|)
name|dep
operator|+
name|dep
operator|->
name|de_reclen
operator|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|dep
operator|->
name|de_flag
operator|&
name|DE_DOWN
operator|)
operator|&&
operator|(
name|olsn
operator|==
name|DE_DOWNLSN
argument_list|(
name|dep
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
name|dep
operator|->
name|de_flag
operator|&
name|DE_END
condition|)
goto|goto
name|blockdone
goto|;
if|if
condition|(
name|hp
operator|->
name|h_no
operator|==
name|dep
operator|->
name|de_fnode
condition|)
block|{
name|dprintf
argument_list|(
operator|(
literal|"[found] "
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|readdone
goto|;
block|}
name|dep
operator|=
operator|(
name|hpfsdirent_t
operator|*
operator|)
operator|(
operator|(
name|caddr_t
operator|)
name|dep
operator|+
name|dep
operator|->
name|de_reclen
operator|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"hpfs_validatetimes: ERROR! oLSN not found\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|failed
goto|;
block|}
block|}
name|olsn
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|!
operator|(
name|dep
operator|->
name|de_flag
operator|&
name|DE_END
operator|)
condition|)
block|{
if|if
condition|(
name|dep
operator|->
name|de_flag
operator|&
name|DE_DOWN
condition|)
block|{
name|lsn
operator|=
name|DE_DOWNLSN
argument_list|(
name|dep
argument_list|)
expr_stmt|;
name|level
operator|++
expr_stmt|;
goto|goto
name|dive
goto|;
block|}
if|if
condition|(
name|hp
operator|->
name|h_no
operator|==
name|dep
operator|->
name|de_fnode
condition|)
block|{
name|dprintf
argument_list|(
operator|(
literal|"[found] "
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|readdone
goto|;
block|}
name|dep
operator|=
operator|(
name|hpfsdirent_t
operator|*
operator|)
operator|(
operator|(
name|caddr_t
operator|)
name|dep
operator|+
name|dep
operator|->
name|de_reclen
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|dep
operator|->
name|de_flag
operator|&
name|DE_DOWN
condition|)
block|{
name|dprintf
argument_list|(
operator|(
literal|"[enddive] "
operator|)
argument_list|)
expr_stmt|;
name|lsn
operator|=
name|DE_DOWNLSN
argument_list|(
name|dep
argument_list|)
expr_stmt|;
name|level
operator|++
expr_stmt|;
goto|goto
name|dive
goto|;
block|}
name|blockdone
label|:
name|dprintf
argument_list|(
operator|(
literal|"[EOB] "
operator|)
argument_list|)
expr_stmt|;
name|olsn
operator|=
name|lsn
expr_stmt|;
name|lsn
operator|=
name|dp
operator|->
name|d_parent
expr_stmt|;
name|level
operator|--
expr_stmt|;
name|dprintf
argument_list|(
operator|(
literal|"[level %d] "
operator|,
name|level
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|level
operator|>
literal|0
condition|)
goto|goto
name|dive
goto|;
comment|/* undive really */
goto|goto
name|failed
goto|;
name|readdone
label|:
name|bcopy
argument_list|(
name|dep
operator|->
name|de_name
argument_list|,
name|hp
operator|->
name|h_name
argument_list|,
name|dep
operator|->
name|de_namelen
argument_list|)
expr_stmt|;
name|hp
operator|->
name|h_name
index|[
name|dep
operator|->
name|de_namelen
index|]
operator|=
literal|'\0'
expr_stmt|;
name|hp
operator|->
name|h_namelen
operator|=
name|dep
operator|->
name|de_namelen
expr_stmt|;
name|hp
operator|->
name|h_ctime
operator|=
name|dep
operator|->
name|de_ctime
expr_stmt|;
name|hp
operator|->
name|h_atime
operator|=
name|dep
operator|->
name|de_atime
expr_stmt|;
name|hp
operator|->
name|h_mtime
operator|=
name|dep
operator|->
name|de_mtime
expr_stmt|;
name|hp
operator|->
name|h_flag
operator||=
name|H_PARVALID
expr_stmt|;
name|dprintf
argument_list|(
operator|(
literal|"[readdone]"
operator|)
argument_list|)
expr_stmt|;
name|failed
label|:
name|dprintf
argument_list|(
operator|(
literal|"\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bp
operator|!=
name|NULL
condition|)
name|brelse
argument_list|(
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
name|hp
operator|!=
name|dhp
condition|)
name|vput
argument_list|(
name|dvp
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
name|struct
name|timespec
name|hpfstimetounix
parameter_list|(
name|u_long
name|hptime
parameter_list|)
block|{
name|struct
name|timespec
name|t
decl_stmt|;
name|t
operator|.
name|tv_nsec
operator|=
literal|0
expr_stmt|;
name|t
operator|.
name|tv_sec
operator|=
name|hptime
expr_stmt|;
return|return
name|t
return|;
block|}
end_function

begin_comment
comment|/*  * Write down changes done to parent dir, these are only times for now.   * hpfsnode have to be locked.  */
end_comment

begin_function
name|int
name|hpfs_updateparent
parameter_list|(
name|struct
name|hpfsnode
modifier|*
name|hp
parameter_list|)
block|{
name|struct
name|hpfsnode
modifier|*
name|dhp
decl_stmt|;
name|struct
name|vnode
modifier|*
name|dvp
decl_stmt|;
name|struct
name|hpfsdirent
modifier|*
name|dep
decl_stmt|;
name|struct
name|buf
modifier|*
name|bp
decl_stmt|;
name|int
name|error
decl_stmt|;
name|dprintf
argument_list|(
operator|(
literal|"hpfs_updateparent(0x%x): \n"
operator|,
name|hp
operator|->
name|h_no
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|hp
operator|->
name|h_flag
operator|&
name|H_PARCHANGE
operator|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
operator|!
operator|(
name|hp
operator|->
name|h_flag
operator|&
name|H_PARVALID
operator|)
condition|)
block|{
name|error
operator|=
name|hpfs_validateparent
argument_list|(
name|hp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
block|}
if|if
condition|(
name|hp
operator|->
name|h_no
operator|==
name|hp
operator|->
name|h_fn
operator|.
name|fn_parent
condition|)
block|{
name|dhp
operator|=
name|hp
expr_stmt|;
block|}
else|else
block|{
name|error
operator|=
name|VFS_VGET
argument_list|(
name|hp
operator|->
name|h_hpmp
operator|->
name|hpm_mp
argument_list|,
name|hp
operator|->
name|h_fn
operator|.
name|fn_parent
argument_list|,
name|LK_EXCLUSIVE
argument_list|,
operator|&
name|dvp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|dhp
operator|=
name|VTOHP
argument_list|(
name|dvp
argument_list|)
expr_stmt|;
block|}
name|error
operator|=
name|hpfs_genlookupbyname
argument_list|(
name|dhp
argument_list|,
name|hp
operator|->
name|h_name
argument_list|,
name|hp
operator|->
name|h_namelen
argument_list|,
operator|&
name|bp
argument_list|,
operator|&
name|dep
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
goto|goto
name|failed
goto|;
block|}
name|dep
operator|->
name|de_atime
operator|=
name|hp
operator|->
name|h_atime
expr_stmt|;
name|dep
operator|->
name|de_mtime
operator|=
name|hp
operator|->
name|h_mtime
expr_stmt|;
name|dep
operator|->
name|de_size
operator|=
name|hp
operator|->
name|h_fn
operator|.
name|fn_size
expr_stmt|;
name|bdwrite
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|hp
operator|->
name|h_flag
operator|&=
operator|~
name|H_PARCHANGE
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
name|failed
label|:
if|if
condition|(
name|hp
operator|!=
name|dhp
condition|)
name|vput
argument_list|(
name|dvp
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Write down on disk changes done to fnode. hpfsnode have to be locked.  */
end_comment

begin_function
name|int
name|hpfs_update
parameter_list|(
name|struct
name|hpfsnode
modifier|*
name|hp
parameter_list|)
block|{
name|struct
name|buf
modifier|*
name|bp
decl_stmt|;
name|dprintf
argument_list|(
operator|(
literal|"hpfs_update(0x%x): \n"
operator|,
name|hp
operator|->
name|h_no
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|hp
operator|->
name|h_flag
operator|&
name|H_CHANGE
operator|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|bp
operator|=
name|getblk
argument_list|(
name|hp
operator|->
name|h_devvp
argument_list|,
name|hp
operator|->
name|h_no
argument_list|,
name|FNODESIZE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|clrbuf
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|&
name|hp
operator|->
name|h_fn
argument_list|,
name|bp
operator|->
name|b_data
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|fnode
argument_list|)
argument_list|)
expr_stmt|;
name|bdwrite
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|hp
operator|->
name|h_flag
operator|&=
operator|~
name|H_CHANGE
expr_stmt|;
if|if
condition|(
name|hp
operator|->
name|h_flag
operator|&
name|H_PARCHANGE
condition|)
return|return
operator|(
name|hpfs_updateparent
argument_list|(
name|hp
argument_list|)
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Truncate file to specifed size. hpfsnode have to be locked.  */
end_comment

begin_function
name|int
name|hpfs_truncate
parameter_list|(
name|struct
name|hpfsnode
modifier|*
name|hp
parameter_list|,
name|u_long
name|size
parameter_list|)
block|{
name|struct
name|hpfsmount
modifier|*
name|hpmp
init|=
name|hp
operator|->
name|h_hpmp
decl_stmt|;
name|lsn_t
name|newblen
decl_stmt|,
name|oldblen
decl_stmt|;
name|int
name|error
decl_stmt|,
name|pf
decl_stmt|;
name|dprintf
argument_list|(
operator|(
literal|"hpfs_truncate(0x%x, 0x%x -> 0x%lx): "
operator|,
name|hp
operator|->
name|h_no
operator|,
name|hp
operator|->
name|h_fn
operator|.
name|fn_size
operator|,
name|size
operator|)
argument_list|)
expr_stmt|;
name|newblen
operator|=
operator|(
name|size
operator|+
name|DEV_BSIZE
operator|-
literal|1
operator|)
operator|>>
name|DEV_BSHIFT
expr_stmt|;
name|oldblen
operator|=
operator|(
name|hp
operator|->
name|h_fn
operator|.
name|fn_size
operator|+
name|DEV_BSIZE
operator|-
literal|1
operator|)
operator|>>
name|DEV_BSHIFT
expr_stmt|;
name|dprintf
argument_list|(
operator|(
literal|"blen: 0x%x -> 0x%x\n"
operator|,
name|oldblen
operator|,
name|newblen
operator|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|hpfs_truncatealblk
argument_list|(
name|hpmp
argument_list|,
operator|&
name|hp
operator|->
name|h_fn
operator|.
name|fn_ab
argument_list|,
name|newblen
argument_list|,
operator|&
name|pf
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
if|if
condition|(
name|pf
condition|)
block|{
name|hp
operator|->
name|h_fn
operator|.
name|fn_ab
operator|.
name|ab_flag
operator|=
literal|0
expr_stmt|;
name|hp
operator|->
name|h_fn
operator|.
name|fn_ab
operator|.
name|ab_freecnt
operator|=
literal|0x8
expr_stmt|;
name|hp
operator|->
name|h_fn
operator|.
name|fn_ab
operator|.
name|ab_busycnt
operator|=
literal|0x0
expr_stmt|;
name|hp
operator|->
name|h_fn
operator|.
name|fn_ab
operator|.
name|ab_freeoff
operator|=
sizeof|sizeof
argument_list|(
name|alblk_t
argument_list|)
expr_stmt|;
block|}
name|hp
operator|->
name|h_fn
operator|.
name|fn_size
operator|=
name|size
expr_stmt|;
name|hp
operator|->
name|h_flag
operator||=
operator|(
name|H_CHANGE
operator||
name|H_PARCHANGE
operator|)
expr_stmt|;
name|dprintf
argument_list|(
operator|(
literal|"hpfs_truncate: successful\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Enlarge file to specifed size. hpfsnode have to be locked.  */
end_comment

begin_function
name|int
name|hpfs_extend
parameter_list|(
name|struct
name|hpfsnode
modifier|*
name|hp
parameter_list|,
name|u_long
name|size
parameter_list|)
block|{
name|struct
name|hpfsmount
modifier|*
name|hpmp
init|=
name|hp
operator|->
name|h_hpmp
decl_stmt|;
name|lsn_t
name|newblen
decl_stmt|,
name|oldblen
decl_stmt|;
name|int
name|error
decl_stmt|;
name|dprintf
argument_list|(
operator|(
literal|"hpfs_extend(0x%x, 0x%x -> 0x%lx): "
operator|,
name|hp
operator|->
name|h_no
operator|,
name|hp
operator|->
name|h_fn
operator|.
name|fn_size
operator|,
name|size
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|hpmp
operator|->
name|hpm_bavail
operator|<
literal|0x10
condition|)
return|return
operator|(
name|ENOSPC
operator|)
return|;
name|newblen
operator|=
operator|(
name|size
operator|+
name|DEV_BSIZE
operator|-
literal|1
operator|)
operator|>>
name|DEV_BSHIFT
expr_stmt|;
name|oldblen
operator|=
operator|(
name|hp
operator|->
name|h_fn
operator|.
name|fn_size
operator|+
name|DEV_BSIZE
operator|-
literal|1
operator|)
operator|>>
name|DEV_BSHIFT
expr_stmt|;
name|dprintf
argument_list|(
operator|(
literal|"blen: 0x%x -> 0x%x\n"
operator|,
name|oldblen
operator|,
name|newblen
operator|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|hpfs_addextent
argument_list|(
name|hpmp
argument_list|,
name|hp
argument_list|,
name|newblen
operator|-
name|oldblen
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|printf
argument_list|(
literal|"hpfs_extend: FAILED TO ADD EXTENT %d\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|hp
operator|->
name|h_fn
operator|.
name|fn_size
operator|=
name|size
expr_stmt|;
name|hp
operator|->
name|h_flag
operator||=
operator|(
name|H_CHANGE
operator||
name|H_PARCHANGE
operator|)
expr_stmt|;
name|dprintf
argument_list|(
operator|(
literal|"hpfs_extend: successful\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Read AlSec structure, and check if magic is valid.  * You don't need to brelse buf on error.  */
end_comment

begin_function
name|int
name|hpfs_breadstruct
parameter_list|(
name|struct
name|hpfsmount
modifier|*
name|hpmp
parameter_list|,
name|lsn_t
name|lsn
parameter_list|,
name|u_int
name|len
parameter_list|,
name|u_int32_t
name|magic
parameter_list|,
name|struct
name|buf
modifier|*
modifier|*
name|bpp
parameter_list|)
block|{
name|struct
name|buf
modifier|*
name|bp
decl_stmt|;
name|u_int32_t
modifier|*
name|mp
decl_stmt|;
name|int
name|error
decl_stmt|;
name|dprintf
argument_list|(
operator|(
literal|"hpfs_breadstruct: reading at 0x%x\n"
operator|,
name|lsn
operator|)
argument_list|)
expr_stmt|;
operator|*
name|bpp
operator|=
name|NULL
expr_stmt|;
name|error
operator|=
name|bread
argument_list|(
name|hpmp
operator|->
name|hpm_devvp
argument_list|,
name|lsn
argument_list|,
name|len
argument_list|,
name|NOCRED
argument_list|,
operator|&
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|brelse
argument_list|(
name|bp
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|mp
operator|=
operator|(
name|u_int32_t
operator|*
operator|)
name|bp
operator|->
name|b_data
expr_stmt|;
if|if
condition|(
operator|*
name|mp
operator|!=
name|magic
condition|)
block|{
name|brelse
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"hpfs_breadstruct: MAGIC DOESN'T MATCH (0x%08x != 0x%08x)\n"
argument_list|,
operator|*
name|mp
argument_list|,
name|magic
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
operator|*
name|bpp
operator|=
name|bp
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


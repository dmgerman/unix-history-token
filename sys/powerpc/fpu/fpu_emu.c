begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	$NetBSD: fpu_emu.c,v 1.14 2005/12/11 12:18:42 christos Exp $ */
end_comment

begin_comment
comment|/*  * Copyright 2001 Wasabi Systems, Inc.  * All rights reserved.  *  * Written by Eduardo Horvath and Simon Burge for Wasabi Systems, Inc.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. All advertising materials mentioning features or use of this software  *    must display the following acknowledgement:  *      This product includes software developed for the NetBSD Project by  *      Wasabi Systems, Inc.  * 4. The name of Wasabi Systems, Inc. may not be used to endorse  *    or promote products derived from this software without specific prior  *    written permission.  *  * THIS SOFTWARE IS PROVIDED BY WASABI SYSTEMS, INC. ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED  * TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL WASABI SYSTEMS, INC  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE  * POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_comment
comment|/*  * Copyright (c) 1992, 1993  *	The Regents of the University of California.  All rights reserved.  *  * This software was developed by the Computer Systems Engineering group  * at Lawrence Berkeley Laboratory under DARPA contract BG 91-66 and  * contributed to Berkeley.  *  * All advertising materials mentioning features or use of this software  * must display the following acknowledgement:  *	This product includes software developed by the University of  *	California, Lawrence Berkeley Laboratory.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. Neither the name of the University nor the names of its contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  *	@(#)fpu.c	8.1 (Berkeley) 6/11/93  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"opt_ddb.h"
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kdb.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/signal.h>
end_include

begin_include
include|#
directive|include
file|<sys/syslog.h>
end_include

begin_include
include|#
directive|include
file|<sys/signalvar.h>
end_include

begin_include
include|#
directive|include
file|<machine/fpu.h>
end_include

begin_include
include|#
directive|include
file|<machine/reg.h>
end_include

begin_include
include|#
directive|include
file|<powerpc/fpu/fpu_emu.h>
end_include

begin_include
include|#
directive|include
file|<powerpc/fpu/fpu_extern.h>
end_include

begin_include
include|#
directive|include
file|<powerpc/fpu/fpu_instr.h>
end_include

begin_expr_stmt
specifier|static
name|SYSCTL_NODE
argument_list|(
name|_hw
argument_list|,
name|OID_AUTO
argument_list|,
name|fpu_emu
argument_list|,
name|CTLFLAG_RW
argument_list|,
literal|0
argument_list|,
literal|"FPU emulator"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_define
define|#
directive|define
name|FPU_EMU_EVCNT_DECL
parameter_list|(
name|name
parameter_list|)
define|\
value|static u_int fpu_emu_evcnt_##name;					\ SYSCTL_INT(_hw_fpu_emu, OID_AUTO, evcnt_##name, CTLFLAG_RD,		\&fpu_emu_evcnt_##name, 0, "")
end_define

begin_define
define|#
directive|define
name|FPU_EMU_EVCNT_INCR
parameter_list|(
name|name
parameter_list|)
value|fpu_emu_evcnt_##name++
end_define

begin_expr_stmt
name|FPU_EMU_EVCNT_DECL
argument_list|(
name|stfiwx
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|FPU_EMU_EVCNT_DECL
argument_list|(
name|fpstore
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|FPU_EMU_EVCNT_DECL
argument_list|(
name|fpload
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|FPU_EMU_EVCNT_DECL
argument_list|(
name|fcmpu
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|FPU_EMU_EVCNT_DECL
argument_list|(
name|frsp
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|FPU_EMU_EVCNT_DECL
argument_list|(
name|fctiw
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|FPU_EMU_EVCNT_DECL
argument_list|(
name|fcmpo
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|FPU_EMU_EVCNT_DECL
argument_list|(
name|mtfsb1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|FPU_EMU_EVCNT_DECL
argument_list|(
name|fnegabs
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|FPU_EMU_EVCNT_DECL
argument_list|(
name|mcrfs
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|FPU_EMU_EVCNT_DECL
argument_list|(
name|mtfsb0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|FPU_EMU_EVCNT_DECL
argument_list|(
name|fmr
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|FPU_EMU_EVCNT_DECL
argument_list|(
name|mtfsfi
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|FPU_EMU_EVCNT_DECL
argument_list|(
name|fnabs
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|FPU_EMU_EVCNT_DECL
argument_list|(
name|fabs
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|FPU_EMU_EVCNT_DECL
argument_list|(
name|mffs
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|FPU_EMU_EVCNT_DECL
argument_list|(
name|mtfsf
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|FPU_EMU_EVCNT_DECL
argument_list|(
name|fctid
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|FPU_EMU_EVCNT_DECL
argument_list|(
name|fcfid
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|FPU_EMU_EVCNT_DECL
argument_list|(
name|fdiv
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|FPU_EMU_EVCNT_DECL
argument_list|(
name|fsub
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|FPU_EMU_EVCNT_DECL
argument_list|(
name|fadd
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|FPU_EMU_EVCNT_DECL
argument_list|(
name|fsqrt
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|FPU_EMU_EVCNT_DECL
argument_list|(
name|fsel
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|FPU_EMU_EVCNT_DECL
argument_list|(
name|fpres
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|FPU_EMU_EVCNT_DECL
argument_list|(
name|fmul
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|FPU_EMU_EVCNT_DECL
argument_list|(
name|frsqrte
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|FPU_EMU_EVCNT_DECL
argument_list|(
name|fmulsub
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|FPU_EMU_EVCNT_DECL
argument_list|(
name|fmuladd
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|FPU_EMU_EVCNT_DECL
argument_list|(
name|fnmsub
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|FPU_EMU_EVCNT_DECL
argument_list|(
name|fnmadd
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* FPSR exception masks */
end_comment

begin_define
define|#
directive|define
name|FPSR_EX_MSK
value|(FPSCR_VX|FPSCR_OX|FPSCR_UX|FPSCR_ZX|		\ 			FPSCR_XX|FPSCR_VXSNAN|FPSCR_VXISI|FPSCR_VXIDI|	\ 			FPSCR_VXZDZ|FPSCR_VXIMZ|FPSCR_VXVC|FPSCR_VXSOFT|\ 			FPSCR_VXSQRT|FPSCR_VXCVI)
end_define

begin_define
define|#
directive|define
name|FPSR_EX
value|(FPSCR_VE|FPSCR_OE|FPSCR_UE|FPSCR_ZE|FPSCR_XE)
end_define

begin_define
define|#
directive|define
name|FPSR_EXOP
value|(FPSR_EX_MSK&(~FPSR_EX))
end_define

begin_decl_stmt
name|int
name|fpe_debug
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|DEBUG
end_ifdef

begin_function_decl
name|vm_offset_t
name|opc_disasm
parameter_list|(
name|vm_offset_t
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * Dump a `fpn' structure.  */
end_comment

begin_function
name|void
name|fpu_dumpfpn
parameter_list|(
name|struct
name|fpn
modifier|*
name|fp
parameter_list|)
block|{
specifier|static
specifier|const
name|char
modifier|*
name|class
index|[]
init|=
block|{
literal|"SNAN"
block|,
literal|"QNAN"
block|,
literal|"ZERO"
block|,
literal|"NUM"
block|,
literal|"INF"
block|}
decl_stmt|;
name|printf
argument_list|(
literal|"%s %c.%x %x %x %xE%d"
argument_list|,
name|class
index|[
name|fp
operator|->
name|fp_class
operator|+
literal|2
index|]
argument_list|,
name|fp
operator|->
name|fp_sign
condition|?
literal|'-'
else|:
literal|' '
argument_list|,
name|fp
operator|->
name|fp_mant
index|[
literal|0
index|]
argument_list|,
name|fp
operator|->
name|fp_mant
index|[
literal|1
index|]
argument_list|,
name|fp
operator|->
name|fp_mant
index|[
literal|2
index|]
argument_list|,
name|fp
operator|->
name|fp_mant
index|[
literal|3
index|]
argument_list|,
name|fp
operator|->
name|fp_exp
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * fpu_execute returns the following error numbers (0 = no error):  */
end_comment

begin_define
define|#
directive|define
name|FPE
value|1
end_define

begin_comment
comment|/* take a floating point exception */
end_comment

begin_define
define|#
directive|define
name|NOTFPU
value|2
end_define

begin_comment
comment|/* not an FPU instruction */
end_comment

begin_define
define|#
directive|define
name|FAULT
value|3
end_define

begin_comment
comment|/*  * Emulate a floating-point instruction.  * Return zero for success, else signal number.  * (Typically: zero, SIGFPE, SIGILL, SIGSEGV)  */
end_comment

begin_function
name|int
name|fpu_emulate
parameter_list|(
name|struct
name|trapframe
modifier|*
name|frame
parameter_list|,
name|struct
name|fpreg
modifier|*
name|fpf
parameter_list|)
block|{
specifier|static
name|union
name|instr
name|insn
decl_stmt|;
specifier|static
name|struct
name|fpemu
name|fe
decl_stmt|;
specifier|static
name|int
name|lastill
init|=
literal|0
decl_stmt|;
name|int
name|sig
decl_stmt|;
comment|/* initialize insn.is_datasize to tell it is *not* initialized */
name|fe
operator|.
name|fe_fpstate
operator|=
name|fpf
expr_stmt|;
name|fe
operator|.
name|fe_cx
operator|=
literal|0
expr_stmt|;
comment|/* always set this (to avoid a warning) */
if|if
condition|(
name|copyin
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|(
name|frame
operator|->
name|srr0
operator|)
argument_list|,
operator|&
name|insn
operator|.
name|i_int
argument_list|,
sizeof|sizeof
argument_list|(
name|insn
operator|.
name|i_int
argument_list|)
argument_list|)
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|printf
argument_list|(
literal|"fpu_emulate: fault reading opcode\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|SIGSEGV
return|;
block|}
name|DPRINTF
argument_list|(
name|FPE_EX
argument_list|,
operator|(
literal|"fpu_emulate: emulating insn %x at %p\n"
operator|,
name|insn
operator|.
name|i_int
operator|,
operator|(
name|void
operator|*
operator|)
name|frame
operator|->
name|srr0
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|insn
operator|.
name|i_any
operator|.
name|i_opcd
operator|==
name|OPC_TWI
operator|)
operator|||
operator|(
operator|(
name|insn
operator|.
name|i_any
operator|.
name|i_opcd
operator|==
name|OPC_integer_31
operator|)
operator|&&
operator|(
name|insn
operator|.
name|i_x
operator|.
name|i_xo
operator|==
name|OPC31_TW
operator|)
operator|)
condition|)
block|{
comment|/* Check for the two trap insns. */
name|DPRINTF
argument_list|(
name|FPE_EX
argument_list|,
operator|(
literal|"fpu_emulate: SIGTRAP\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|SIGTRAP
operator|)
return|;
block|}
name|sig
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|fpu_execute
argument_list|(
name|frame
argument_list|,
operator|&
name|fe
argument_list|,
operator|&
name|insn
argument_list|)
condition|)
block|{
case|case
literal|0
case|:
name|DPRINTF
argument_list|(
name|FPE_EX
argument_list|,
operator|(
literal|"fpu_emulate: success\n"
operator|)
argument_list|)
expr_stmt|;
name|frame
operator|->
name|srr0
operator|+=
literal|4
expr_stmt|;
break|break;
case|case
name|FPE
case|:
name|DPRINTF
argument_list|(
name|FPE_EX
argument_list|,
operator|(
literal|"fpu_emulate: SIGFPE\n"
operator|)
argument_list|)
expr_stmt|;
name|sig
operator|=
name|SIGFPE
expr_stmt|;
break|break;
case|case
name|FAULT
case|:
name|DPRINTF
argument_list|(
name|FPE_EX
argument_list|,
operator|(
literal|"fpu_emulate: SIGSEGV\n"
operator|)
argument_list|)
expr_stmt|;
name|sig
operator|=
name|SIGSEGV
expr_stmt|;
break|break;
case|case
name|NOTFPU
case|:
default|default:
name|DPRINTF
argument_list|(
name|FPE_EX
argument_list|,
operator|(
literal|"fpu_emulate: SIGILL\n"
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|fpe_debug
operator|&
name|FPE_EX
condition|)
block|{
name|printf
argument_list|(
literal|"fpu_emulate:  illegal insn %x at %p:"
argument_list|,
name|insn
operator|.
name|i_int
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
name|frame
operator|->
name|srr0
operator|)
argument_list|)
expr_stmt|;
name|opc_disasm
argument_list|(
name|frame
operator|->
name|srr0
argument_list|,
name|insn
operator|.
name|i_int
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* 		* XXXX retry an illegal insn once due to cache issues. 		*/
if|if
condition|(
name|lastill
operator|==
name|frame
operator|->
name|srr0
condition|)
block|{
name|sig
operator|=
name|SIGILL
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|fpe_debug
operator|&
name|FPE_EX
condition|)
name|kdb_enter
argument_list|(
name|KDB_WHY_UNSET
argument_list|,
literal|"illegal instruction"
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
name|lastill
operator|=
name|frame
operator|->
name|srr0
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|sig
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Execute an FPU instruction (one that runs entirely in the FPU; not  * FBfcc or STF, for instance).  On return, fe->fe_fs->fs_fsr will be  * modified to reflect the setting the hardware would have left.  *  * Note that we do not catch all illegal opcodes, so you can, for instance,  * multiply two integers this way.  */
end_comment

begin_function
name|int
name|fpu_execute
parameter_list|(
name|struct
name|trapframe
modifier|*
name|tf
parameter_list|,
name|struct
name|fpemu
modifier|*
name|fe
parameter_list|,
name|union
name|instr
modifier|*
name|insn
parameter_list|)
block|{
name|struct
name|fpn
modifier|*
name|fp
decl_stmt|;
name|union
name|instr
name|instr
init|=
operator|*
name|insn
decl_stmt|;
name|int
modifier|*
name|a
decl_stmt|;
name|vm_offset_t
name|addr
decl_stmt|;
name|int
name|ra
decl_stmt|,
name|rb
decl_stmt|,
name|rc
decl_stmt|,
name|rt
decl_stmt|,
name|type
decl_stmt|,
name|mask
decl_stmt|,
name|fsr
decl_stmt|,
name|cx
decl_stmt|,
name|bf
decl_stmt|,
name|setcr
decl_stmt|;
name|unsigned
name|int
name|cond
decl_stmt|;
name|struct
name|fpreg
modifier|*
name|fs
decl_stmt|;
comment|/* Setup work. */
name|fp
operator|=
name|NULL
expr_stmt|;
name|fs
operator|=
name|fe
operator|->
name|fe_fpstate
expr_stmt|;
name|fe
operator|->
name|fe_fpscr
operator|=
operator|(
operator|(
name|int
operator|*
operator|)
operator|&
name|fs
operator|->
name|fpscr
operator|)
index|[
literal|1
index|]
expr_stmt|;
comment|/* 	 * On PowerPC all floating point values are stored in registers 	 * as doubles, even when used for single precision operations. 	 */
name|type
operator|=
name|FTYPE_DBL
expr_stmt|;
name|cond
operator|=
name|instr
operator|.
name|i_any
operator|.
name|i_rc
expr_stmt|;
name|setcr
operator|=
literal|0
expr_stmt|;
name|bf
operator|=
literal|0
expr_stmt|;
comment|/* XXX gcc */
if|#
directive|if
name|defined
argument_list|(
name|DDB
argument_list|)
operator|&&
name|defined
argument_list|(
name|DEBUG
argument_list|)
if|if
condition|(
name|fpe_debug
operator|&
name|FPE_EX
condition|)
block|{
name|vm_offset_t
name|loc
init|=
name|tf
operator|->
name|srr0
decl_stmt|;
name|printf
argument_list|(
literal|"Trying to emulate: %p "
argument_list|,
operator|(
name|void
operator|*
operator|)
name|loc
argument_list|)
expr_stmt|;
name|opc_disasm
argument_list|(
name|loc
argument_list|,
name|instr
operator|.
name|i_int
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* 	 * `Decode' and execute instruction. 	 */
if|if
condition|(
operator|(
name|instr
operator|.
name|i_any
operator|.
name|i_opcd
operator|>=
name|OPC_LFS
operator|&&
name|instr
operator|.
name|i_any
operator|.
name|i_opcd
operator|<=
name|OPC_STFDU
operator|)
operator|||
name|instr
operator|.
name|i_any
operator|.
name|i_opcd
operator|==
name|OPC_integer_31
condition|)
block|{
comment|/* 		 * Handle load/store insns: 		 * 		 * Convert to/from single if needed, calculate addr, 		 * and update index reg if needed. 		 */
name|double
name|buf
decl_stmt|;
name|size_t
name|size
init|=
sizeof|sizeof
argument_list|(
name|float
argument_list|)
decl_stmt|;
name|int
name|store
decl_stmt|,
name|update
decl_stmt|;
name|cond
operator|=
literal|0
expr_stmt|;
comment|/* ld/st never set condition codes */
if|if
condition|(
name|instr
operator|.
name|i_any
operator|.
name|i_opcd
operator|==
name|OPC_integer_31
condition|)
block|{
if|if
condition|(
name|instr
operator|.
name|i_x
operator|.
name|i_xo
operator|==
name|OPC31_STFIWX
condition|)
block|{
name|FPU_EMU_EVCNT_INCR
argument_list|(
name|stfiwx
argument_list|)
expr_stmt|;
comment|/* Store as integer */
name|ra
operator|=
name|instr
operator|.
name|i_x
operator|.
name|i_ra
expr_stmt|;
name|rb
operator|=
name|instr
operator|.
name|i_x
operator|.
name|i_rb
expr_stmt|;
name|DPRINTF
argument_list|(
name|FPE_INSN
argument_list|,
operator|(
literal|"reg %d has %x reg %d has %x\n"
operator|,
name|ra
operator|,
name|tf
operator|->
name|fixreg
index|[
name|ra
index|]
operator|,
name|rb
operator|,
name|tf
operator|->
name|fixreg
index|[
name|rb
index|]
operator|)
argument_list|)
expr_stmt|;
name|addr
operator|=
name|tf
operator|->
name|fixreg
index|[
name|rb
index|]
expr_stmt|;
if|if
condition|(
name|ra
operator|!=
literal|0
condition|)
name|addr
operator|+=
name|tf
operator|->
name|fixreg
index|[
name|ra
index|]
expr_stmt|;
name|rt
operator|=
name|instr
operator|.
name|i_x
operator|.
name|i_rt
expr_stmt|;
name|a
operator|=
operator|(
name|int
operator|*
operator|)
operator|&
name|fs
operator|->
name|fpreg
index|[
name|rt
index|]
expr_stmt|;
name|DPRINTF
argument_list|(
name|FPE_INSN
argument_list|,
operator|(
literal|"fpu_execute: Store INT %x at %p\n"
operator|,
name|a
index|[
literal|1
index|]
operator|,
operator|(
name|void
operator|*
operator|)
name|addr
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|copyout
argument_list|(
operator|&
name|a
index|[
literal|1
index|]
argument_list|,
operator|(
name|void
operator|*
operator|)
name|addr
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
condition|)
return|return
operator|(
name|FAULT
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|instr
operator|.
name|i_x
operator|.
name|i_xo
operator|&
name|OPC31_FPMASK
operator|)
operator|!=
name|OPC31_FPOP
condition|)
comment|/* Not an indexed FP load/store op */
return|return
operator|(
name|NOTFPU
operator|)
return|;
name|store
operator|=
operator|(
name|instr
operator|.
name|i_x
operator|.
name|i_xo
operator|&
literal|0x80
operator|)
expr_stmt|;
if|if
condition|(
name|instr
operator|.
name|i_x
operator|.
name|i_xo
operator|&
literal|0x40
condition|)
name|size
operator|=
sizeof|sizeof
argument_list|(
name|double
argument_list|)
expr_stmt|;
else|else
name|type
operator|=
name|FTYPE_SNG
expr_stmt|;
name|update
operator|=
operator|(
name|instr
operator|.
name|i_x
operator|.
name|i_xo
operator|&
literal|0x20
operator|)
expr_stmt|;
comment|/* calculate EA of load/store */
name|ra
operator|=
name|instr
operator|.
name|i_x
operator|.
name|i_ra
expr_stmt|;
name|rb
operator|=
name|instr
operator|.
name|i_x
operator|.
name|i_rb
expr_stmt|;
name|DPRINTF
argument_list|(
name|FPE_INSN
argument_list|,
operator|(
literal|"reg %d has %x reg %d has %x\n"
operator|,
name|ra
operator|,
name|tf
operator|->
name|fixreg
index|[
name|ra
index|]
operator|,
name|rb
operator|,
name|tf
operator|->
name|fixreg
index|[
name|rb
index|]
operator|)
argument_list|)
expr_stmt|;
name|addr
operator|=
name|tf
operator|->
name|fixreg
index|[
name|rb
index|]
expr_stmt|;
if|if
condition|(
name|ra
operator|!=
literal|0
condition|)
name|addr
operator|+=
name|tf
operator|->
name|fixreg
index|[
name|ra
index|]
expr_stmt|;
name|rt
operator|=
name|instr
operator|.
name|i_x
operator|.
name|i_rt
expr_stmt|;
block|}
else|else
block|{
name|store
operator|=
name|instr
operator|.
name|i_d
operator|.
name|i_opcd
operator|&
literal|0x4
expr_stmt|;
if|if
condition|(
name|instr
operator|.
name|i_d
operator|.
name|i_opcd
operator|&
literal|0x2
condition|)
name|size
operator|=
sizeof|sizeof
argument_list|(
name|double
argument_list|)
expr_stmt|;
else|else
name|type
operator|=
name|FTYPE_SNG
expr_stmt|;
name|update
operator|=
name|instr
operator|.
name|i_d
operator|.
name|i_opcd
operator|&
literal|0x1
expr_stmt|;
comment|/* calculate EA of load/store */
name|ra
operator|=
name|instr
operator|.
name|i_d
operator|.
name|i_ra
expr_stmt|;
name|addr
operator|=
name|instr
operator|.
name|i_d
operator|.
name|i_d
expr_stmt|;
name|DPRINTF
argument_list|(
name|FPE_INSN
argument_list|,
operator|(
literal|"reg %d has %x displ %x\n"
operator|,
name|ra
operator|,
name|tf
operator|->
name|fixreg
index|[
name|ra
index|]
operator|,
name|addr
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ra
operator|!=
literal|0
condition|)
name|addr
operator|+=
name|tf
operator|->
name|fixreg
index|[
name|ra
index|]
expr_stmt|;
name|rt
operator|=
name|instr
operator|.
name|i_d
operator|.
name|i_rt
expr_stmt|;
block|}
if|if
condition|(
name|update
operator|&&
name|ra
operator|==
literal|0
condition|)
return|return
operator|(
name|NOTFPU
operator|)
return|;
if|if
condition|(
name|store
condition|)
block|{
comment|/* Store */
name|FPU_EMU_EVCNT_INCR
argument_list|(
name|fpstore
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|!=
name|FTYPE_DBL
condition|)
block|{
name|DPRINTF
argument_list|(
name|FPE_INSN
argument_list|,
operator|(
literal|"fpu_execute: Store SNG at %p\n"
operator|,
operator|(
name|void
operator|*
operator|)
name|addr
operator|)
argument_list|)
expr_stmt|;
name|fpu_explode
argument_list|(
name|fe
argument_list|,
name|fp
operator|=
operator|&
name|fe
operator|->
name|fe_f1
argument_list|,
name|FTYPE_DBL
argument_list|,
name|rt
argument_list|)
expr_stmt|;
name|fpu_implode
argument_list|(
name|fe
argument_list|,
name|fp
argument_list|,
name|type
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|copyout
argument_list|(
operator|&
name|buf
argument_list|,
operator|(
name|void
operator|*
operator|)
name|addr
argument_list|,
name|size
argument_list|)
condition|)
return|return
operator|(
name|FAULT
operator|)
return|;
block|}
else|else
block|{
name|DPRINTF
argument_list|(
name|FPE_INSN
argument_list|,
operator|(
literal|"fpu_execute: Store DBL at %p\n"
operator|,
operator|(
name|void
operator|*
operator|)
name|addr
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|copyout
argument_list|(
operator|&
name|fs
operator|->
name|fpreg
index|[
name|rt
index|]
argument_list|,
operator|(
name|void
operator|*
operator|)
name|addr
argument_list|,
name|size
argument_list|)
condition|)
return|return
operator|(
name|FAULT
operator|)
return|;
block|}
block|}
else|else
block|{
comment|/* Load */
name|FPU_EMU_EVCNT_INCR
argument_list|(
name|fpload
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
name|FPE_INSN
argument_list|,
operator|(
literal|"fpu_execute: Load from %p\n"
operator|,
operator|(
name|void
operator|*
operator|)
name|addr
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|copyin
argument_list|(
operator|(
specifier|const
name|void
operator|*
operator|)
name|addr
argument_list|,
operator|&
name|fs
operator|->
name|fpreg
index|[
name|rt
index|]
argument_list|,
name|size
argument_list|)
condition|)
return|return
operator|(
name|FAULT
operator|)
return|;
if|if
condition|(
name|type
operator|!=
name|FTYPE_DBL
condition|)
block|{
name|fpu_explode
argument_list|(
name|fe
argument_list|,
name|fp
operator|=
operator|&
name|fe
operator|->
name|fe_f1
argument_list|,
name|type
argument_list|,
name|rt
argument_list|)
expr_stmt|;
name|fpu_implode
argument_list|(
name|fe
argument_list|,
name|fp
argument_list|,
name|FTYPE_DBL
argument_list|,
operator|(
name|u_int
operator|*
operator|)
operator|&
name|fs
operator|->
name|fpreg
index|[
name|rt
index|]
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|update
condition|)
name|tf
operator|->
name|fixreg
index|[
name|ra
index|]
operator|=
name|addr
expr_stmt|;
comment|/* Complete. */
return|return
operator|(
literal|0
operator|)
return|;
ifdef|#
directive|ifdef
name|notyet
block|}
elseif|else
if|if
condition|(
name|instr
operator|.
name|i_any
operator|.
name|i_opcd
operator|==
name|OPC_load_st_62
condition|)
block|{
comment|/* These are 64-bit extenstions */
return|return
operator|(
name|NOTFPU
operator|)
return|;
endif|#
directive|endif
block|}
elseif|else
if|if
condition|(
name|instr
operator|.
name|i_any
operator|.
name|i_opcd
operator|==
name|OPC_sp_fp_59
operator|||
name|instr
operator|.
name|i_any
operator|.
name|i_opcd
operator|==
name|OPC_dp_fp_63
condition|)
block|{
if|if
condition|(
name|instr
operator|.
name|i_any
operator|.
name|i_opcd
operator|==
name|OPC_dp_fp_63
operator|&&
operator|!
operator|(
name|instr
operator|.
name|i_a
operator|.
name|i_xo
operator|&
name|OPC63M_MASK
operator|)
condition|)
block|{
comment|/* Format X */
name|rt
operator|=
name|instr
operator|.
name|i_x
operator|.
name|i_rt
expr_stmt|;
name|ra
operator|=
name|instr
operator|.
name|i_x
operator|.
name|i_ra
expr_stmt|;
name|rb
operator|=
name|instr
operator|.
name|i_x
operator|.
name|i_rb
expr_stmt|;
comment|/* One of the special opcodes.... */
switch|switch
condition|(
name|instr
operator|.
name|i_x
operator|.
name|i_xo
condition|)
block|{
case|case
name|OPC63_FCMPU
case|:
name|FPU_EMU_EVCNT_INCR
argument_list|(
name|fcmpu
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
name|FPE_INSN
argument_list|,
operator|(
literal|"fpu_execute: FCMPU\n"
operator|)
argument_list|)
expr_stmt|;
name|rt
operator|>>=
literal|2
expr_stmt|;
name|fpu_explode
argument_list|(
name|fe
argument_list|,
operator|&
name|fe
operator|->
name|fe_f1
argument_list|,
name|type
argument_list|,
name|ra
argument_list|)
expr_stmt|;
name|fpu_explode
argument_list|(
name|fe
argument_list|,
operator|&
name|fe
operator|->
name|fe_f2
argument_list|,
name|type
argument_list|,
name|rb
argument_list|)
expr_stmt|;
name|fpu_compare
argument_list|(
name|fe
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Make sure we do the condition regs. */
name|cond
operator|=
literal|0
expr_stmt|;
comment|/* N.B.: i_rs is already left shifted by two. */
name|bf
operator|=
name|instr
operator|.
name|i_x
operator|.
name|i_rs
operator|&
literal|0xfc
expr_stmt|;
name|setcr
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|OPC63_FRSP
case|:
comment|/* 				 * Convert to single:  				 * 				 * PowerPC uses this to round a double 				 * precision value to single precision, 				 * but values in registers are always  				 * stored in double precision format. 				 */
name|FPU_EMU_EVCNT_INCR
argument_list|(
name|frsp
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
name|FPE_INSN
argument_list|,
operator|(
literal|"fpu_execute: FRSP\n"
operator|)
argument_list|)
expr_stmt|;
name|fpu_explode
argument_list|(
name|fe
argument_list|,
name|fp
operator|=
operator|&
name|fe
operator|->
name|fe_f1
argument_list|,
name|FTYPE_DBL
argument_list|,
name|rb
argument_list|)
expr_stmt|;
name|fpu_implode
argument_list|(
name|fe
argument_list|,
name|fp
argument_list|,
name|FTYPE_SNG
argument_list|,
operator|(
name|u_int
operator|*
operator|)
operator|&
name|fs
operator|->
name|fpreg
index|[
name|rt
index|]
argument_list|)
expr_stmt|;
name|fpu_explode
argument_list|(
name|fe
argument_list|,
name|fp
operator|=
operator|&
name|fe
operator|->
name|fe_f1
argument_list|,
name|FTYPE_SNG
argument_list|,
name|rt
argument_list|)
expr_stmt|;
name|type
operator|=
name|FTYPE_DBL
expr_stmt|;
break|break;
case|case
name|OPC63_FCTIW
case|:
case|case
name|OPC63_FCTIWZ
case|:
name|FPU_EMU_EVCNT_INCR
argument_list|(
name|fctiw
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
name|FPE_INSN
argument_list|,
operator|(
literal|"fpu_execute: FCTIW\n"
operator|)
argument_list|)
expr_stmt|;
name|fpu_explode
argument_list|(
name|fe
argument_list|,
name|fp
operator|=
operator|&
name|fe
operator|->
name|fe_f1
argument_list|,
name|type
argument_list|,
name|rb
argument_list|)
expr_stmt|;
name|type
operator|=
name|FTYPE_INT
expr_stmt|;
break|break;
case|case
name|OPC63_FCMPO
case|:
name|FPU_EMU_EVCNT_INCR
argument_list|(
name|fcmpo
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
name|FPE_INSN
argument_list|,
operator|(
literal|"fpu_execute: FCMPO\n"
operator|)
argument_list|)
expr_stmt|;
name|rt
operator|>>=
literal|2
expr_stmt|;
name|fpu_explode
argument_list|(
name|fe
argument_list|,
operator|&
name|fe
operator|->
name|fe_f1
argument_list|,
name|type
argument_list|,
name|ra
argument_list|)
expr_stmt|;
name|fpu_explode
argument_list|(
name|fe
argument_list|,
operator|&
name|fe
operator|->
name|fe_f2
argument_list|,
name|type
argument_list|,
name|rb
argument_list|)
expr_stmt|;
name|fpu_compare
argument_list|(
name|fe
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* Make sure we do the condition regs. */
name|cond
operator|=
literal|0
expr_stmt|;
comment|/* N.B.: i_rs is already left shifted by two. */
name|bf
operator|=
name|instr
operator|.
name|i_x
operator|.
name|i_rs
operator|&
literal|0xfc
expr_stmt|;
name|setcr
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|OPC63_MTFSB1
case|:
name|FPU_EMU_EVCNT_INCR
argument_list|(
name|mtfsb1
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
name|FPE_INSN
argument_list|,
operator|(
literal|"fpu_execute: MTFSB1\n"
operator|)
argument_list|)
expr_stmt|;
name|fe
operator|->
name|fe_fpscr
operator||=
operator|(
operator|~
operator|(
name|FPSCR_VX
operator||
name|FPSR_EX
operator|)
operator|&
operator|(
literal|1
operator|<<
operator|(
literal|31
operator|-
name|rt
operator|)
operator|)
operator|)
expr_stmt|;
break|break;
case|case
name|OPC63_FNEG
case|:
name|FPU_EMU_EVCNT_INCR
argument_list|(
name|fnegabs
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
name|FPE_INSN
argument_list|,
operator|(
literal|"fpu_execute: FNEGABS\n"
operator|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|fs
operator|->
name|fpreg
index|[
name|rt
index|]
argument_list|,
operator|&
name|fs
operator|->
name|fpreg
index|[
name|rb
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|double
argument_list|)
argument_list|)
expr_stmt|;
name|a
operator|=
operator|(
name|int
operator|*
operator|)
operator|&
name|fs
operator|->
name|fpreg
index|[
name|rt
index|]
expr_stmt|;
operator|*
name|a
operator|^=
operator|(
literal|1U
operator|<<
literal|31
operator|)
expr_stmt|;
break|break;
case|case
name|OPC63_MCRFS
case|:
name|FPU_EMU_EVCNT_INCR
argument_list|(
name|mcrfs
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
name|FPE_INSN
argument_list|,
operator|(
literal|"fpu_execute: MCRFS\n"
operator|)
argument_list|)
expr_stmt|;
name|cond
operator|=
literal|0
expr_stmt|;
name|rt
operator|&=
literal|0x1c
expr_stmt|;
name|ra
operator|&=
literal|0x1c
expr_stmt|;
comment|/* Extract the bits we want */
name|mask
operator|=
operator|(
name|fe
operator|->
name|fe_fpscr
operator|>>
operator|(
literal|28
operator|-
name|ra
operator|)
operator|)
operator|&
literal|0xf
expr_stmt|;
comment|/* Clear the bits we copied. */
name|fe
operator|->
name|fe_cx
operator|=
operator|(
name|FPSR_EX_MSK
operator||
operator|(
literal|0xf
operator|<<
operator|(
literal|28
operator|-
name|ra
operator|)
operator|)
operator|)
expr_stmt|;
name|fe
operator|->
name|fe_fpscr
operator|&=
name|fe
operator|->
name|fe_cx
expr_stmt|;
comment|/* Now shove them in the right part of cr */
name|tf
operator|->
name|cr
operator|&=
operator|~
operator|(
literal|0xf
operator|<<
operator|(
literal|28
operator|-
name|rt
operator|)
operator|)
expr_stmt|;
name|tf
operator|->
name|cr
operator||=
operator|(
name|mask
operator|<<
operator|(
literal|28
operator|-
name|rt
operator|)
operator|)
expr_stmt|;
break|break;
case|case
name|OPC63_MTFSB0
case|:
name|FPU_EMU_EVCNT_INCR
argument_list|(
name|mtfsb0
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
name|FPE_INSN
argument_list|,
operator|(
literal|"fpu_execute: MTFSB0\n"
operator|)
argument_list|)
expr_stmt|;
name|fe
operator|->
name|fe_fpscr
operator|&=
operator|(
operator|(
name|FPSCR_VX
operator||
name|FPSR_EX
operator|)
operator|&
operator|~
operator|(
literal|1
operator|<<
operator|(
literal|31
operator|-
name|rt
operator|)
operator|)
operator|)
expr_stmt|;
break|break;
case|case
name|OPC63_FMR
case|:
name|FPU_EMU_EVCNT_INCR
argument_list|(
name|fmr
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
name|FPE_INSN
argument_list|,
operator|(
literal|"fpu_execute: FMR\n"
operator|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|fs
operator|->
name|fpreg
index|[
name|rt
index|]
argument_list|,
operator|&
name|fs
operator|->
name|fpreg
index|[
name|rb
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|double
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OPC63_MTFSFI
case|:
name|FPU_EMU_EVCNT_INCR
argument_list|(
name|mtfsfi
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
name|FPE_INSN
argument_list|,
operator|(
literal|"fpu_execute: MTFSFI\n"
operator|)
argument_list|)
expr_stmt|;
name|rb
operator|>>=
literal|1
expr_stmt|;
name|rt
operator|&=
literal|0x1c
expr_stmt|;
comment|/* Already left-shifted 4 */
name|fe
operator|->
name|fe_cx
operator|=
name|rb
operator|<<
operator|(
literal|28
operator|-
name|rt
operator|)
expr_stmt|;
name|mask
operator|=
literal|0xf
operator|<<
operator|(
literal|28
operator|-
name|rt
operator|)
expr_stmt|;
name|fe
operator|->
name|fe_fpscr
operator|=
operator|(
name|fe
operator|->
name|fe_fpscr
operator|&
operator|~
name|mask
operator|)
operator||
name|fe
operator|->
name|fe_cx
expr_stmt|;
comment|/* XXX weird stuff about OX, FX, FEX, and VX should be handled */
break|break;
case|case
name|OPC63_FNABS
case|:
name|FPU_EMU_EVCNT_INCR
argument_list|(
name|fnabs
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
name|FPE_INSN
argument_list|,
operator|(
literal|"fpu_execute: FABS\n"
operator|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|fs
operator|->
name|fpreg
index|[
name|rt
index|]
argument_list|,
operator|&
name|fs
operator|->
name|fpreg
index|[
name|rb
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|double
argument_list|)
argument_list|)
expr_stmt|;
name|a
operator|=
operator|(
name|int
operator|*
operator|)
operator|&
name|fs
operator|->
name|fpreg
index|[
name|rt
index|]
expr_stmt|;
operator|*
name|a
operator||=
operator|(
literal|1U
operator|<<
literal|31
operator|)
expr_stmt|;
break|break;
case|case
name|OPC63_FABS
case|:
name|FPU_EMU_EVCNT_INCR
argument_list|(
name|fabs
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
name|FPE_INSN
argument_list|,
operator|(
literal|"fpu_execute: FABS\n"
operator|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|fs
operator|->
name|fpreg
index|[
name|rt
index|]
argument_list|,
operator|&
name|fs
operator|->
name|fpreg
index|[
name|rb
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|double
argument_list|)
argument_list|)
expr_stmt|;
name|a
operator|=
operator|(
name|int
operator|*
operator|)
operator|&
name|fs
operator|->
name|fpreg
index|[
name|rt
index|]
expr_stmt|;
operator|*
name|a
operator|&=
operator|~
operator|(
literal|1U
operator|<<
literal|31
operator|)
expr_stmt|;
break|break;
case|case
name|OPC63_MFFS
case|:
name|FPU_EMU_EVCNT_INCR
argument_list|(
name|mffs
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
name|FPE_INSN
argument_list|,
operator|(
literal|"fpu_execute: MFFS\n"
operator|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|fs
operator|->
name|fpreg
index|[
name|rt
index|]
argument_list|,
operator|&
name|fs
operator|->
name|fpscr
argument_list|,
sizeof|sizeof
argument_list|(
name|fs
operator|->
name|fpscr
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OPC63_MTFSF
case|:
name|FPU_EMU_EVCNT_INCR
argument_list|(
name|mtfsf
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
name|FPE_INSN
argument_list|,
operator|(
literal|"fpu_execute: MTFSF\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rt
operator|=
name|instr
operator|.
name|i_xfl
operator|.
name|i_flm
operator|)
operator|==
operator|-
literal|1
condition|)
name|mask
operator|=
operator|-
literal|1
expr_stmt|;
else|else
block|{
name|mask
operator|=
literal|0
expr_stmt|;
comment|/* Convert 1 bit -> 4 bits */
for|for
control|(
name|ra
operator|=
literal|0
init|;
name|ra
operator|<
literal|8
condition|;
name|ra
operator|++
control|)
if|if
condition|(
name|rt
operator|&
operator|(
literal|1
operator|<<
name|ra
operator|)
condition|)
name|mask
operator||=
operator|(
literal|0xf
operator|<<
operator|(
literal|4
operator|*
name|ra
operator|)
operator|)
expr_stmt|;
block|}
name|a
operator|=
operator|(
name|int
operator|*
operator|)
operator|&
name|fs
operator|->
name|fpreg
index|[
name|rt
index|]
expr_stmt|;
name|fe
operator|->
name|fe_cx
operator|=
name|mask
operator|&
name|a
index|[
literal|1
index|]
expr_stmt|;
name|fe
operator|->
name|fe_fpscr
operator|=
operator|(
name|fe
operator|->
name|fe_fpscr
operator|&
operator|~
name|mask
operator|)
operator||
operator|(
name|fe
operator|->
name|fe_cx
operator|)
expr_stmt|;
comment|/* XXX weird stuff about OX, FX, FEX, and VX should be handled */
break|break;
case|case
name|OPC63_FCTID
case|:
case|case
name|OPC63_FCTIDZ
case|:
name|FPU_EMU_EVCNT_INCR
argument_list|(
name|fctid
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
name|FPE_INSN
argument_list|,
operator|(
literal|"fpu_execute: FCTID\n"
operator|)
argument_list|)
expr_stmt|;
name|fpu_explode
argument_list|(
name|fe
argument_list|,
name|fp
operator|=
operator|&
name|fe
operator|->
name|fe_f1
argument_list|,
name|type
argument_list|,
name|rb
argument_list|)
expr_stmt|;
name|type
operator|=
name|FTYPE_LNG
expr_stmt|;
break|break;
case|case
name|OPC63_FCFID
case|:
name|FPU_EMU_EVCNT_INCR
argument_list|(
name|fcfid
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
name|FPE_INSN
argument_list|,
operator|(
literal|"fpu_execute: FCFID\n"
operator|)
argument_list|)
expr_stmt|;
name|type
operator|=
name|FTYPE_LNG
expr_stmt|;
name|fpu_explode
argument_list|(
name|fe
argument_list|,
name|fp
operator|=
operator|&
name|fe
operator|->
name|fe_f1
argument_list|,
name|type
argument_list|,
name|rb
argument_list|)
expr_stmt|;
name|type
operator|=
name|FTYPE_DBL
expr_stmt|;
break|break;
default|default:
return|return
operator|(
name|NOTFPU
operator|)
return|;
break|break;
block|}
block|}
else|else
block|{
comment|/* Format A */
name|rt
operator|=
name|instr
operator|.
name|i_a
operator|.
name|i_frt
expr_stmt|;
name|ra
operator|=
name|instr
operator|.
name|i_a
operator|.
name|i_fra
expr_stmt|;
name|rb
operator|=
name|instr
operator|.
name|i_a
operator|.
name|i_frb
expr_stmt|;
name|rc
operator|=
name|instr
operator|.
name|i_a
operator|.
name|i_frc
expr_stmt|;
comment|/* 			 * All arithmetic operations work on registers, which 			 * are stored as doubles. 			 */
name|type
operator|=
name|FTYPE_DBL
expr_stmt|;
switch|switch
condition|(
operator|(
name|unsigned
name|int
operator|)
name|instr
operator|.
name|i_a
operator|.
name|i_xo
condition|)
block|{
case|case
name|OPC59_FDIVS
case|:
name|FPU_EMU_EVCNT_INCR
argument_list|(
name|fdiv
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
name|FPE_INSN
argument_list|,
operator|(
literal|"fpu_execute: FDIV\n"
operator|)
argument_list|)
expr_stmt|;
name|fpu_explode
argument_list|(
name|fe
argument_list|,
operator|&
name|fe
operator|->
name|fe_f1
argument_list|,
name|type
argument_list|,
name|ra
argument_list|)
expr_stmt|;
name|fpu_explode
argument_list|(
name|fe
argument_list|,
operator|&
name|fe
operator|->
name|fe_f2
argument_list|,
name|type
argument_list|,
name|rb
argument_list|)
expr_stmt|;
name|fp
operator|=
name|fpu_div
argument_list|(
name|fe
argument_list|)
expr_stmt|;
break|break;
case|case
name|OPC59_FSUBS
case|:
name|FPU_EMU_EVCNT_INCR
argument_list|(
name|fsub
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
name|FPE_INSN
argument_list|,
operator|(
literal|"fpu_execute: FSUB\n"
operator|)
argument_list|)
expr_stmt|;
name|fpu_explode
argument_list|(
name|fe
argument_list|,
operator|&
name|fe
operator|->
name|fe_f1
argument_list|,
name|type
argument_list|,
name|ra
argument_list|)
expr_stmt|;
name|fpu_explode
argument_list|(
name|fe
argument_list|,
operator|&
name|fe
operator|->
name|fe_f2
argument_list|,
name|type
argument_list|,
name|rb
argument_list|)
expr_stmt|;
name|fp
operator|=
name|fpu_sub
argument_list|(
name|fe
argument_list|)
expr_stmt|;
break|break;
case|case
name|OPC59_FADDS
case|:
name|FPU_EMU_EVCNT_INCR
argument_list|(
name|fadd
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
name|FPE_INSN
argument_list|,
operator|(
literal|"fpu_execute: FADD\n"
operator|)
argument_list|)
expr_stmt|;
name|fpu_explode
argument_list|(
name|fe
argument_list|,
operator|&
name|fe
operator|->
name|fe_f1
argument_list|,
name|type
argument_list|,
name|ra
argument_list|)
expr_stmt|;
name|fpu_explode
argument_list|(
name|fe
argument_list|,
operator|&
name|fe
operator|->
name|fe_f2
argument_list|,
name|type
argument_list|,
name|rb
argument_list|)
expr_stmt|;
name|fp
operator|=
name|fpu_add
argument_list|(
name|fe
argument_list|)
expr_stmt|;
break|break;
case|case
name|OPC59_FSQRTS
case|:
name|FPU_EMU_EVCNT_INCR
argument_list|(
name|fsqrt
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
name|FPE_INSN
argument_list|,
operator|(
literal|"fpu_execute: FSQRT\n"
operator|)
argument_list|)
expr_stmt|;
name|fpu_explode
argument_list|(
name|fe
argument_list|,
operator|&
name|fe
operator|->
name|fe_f1
argument_list|,
name|type
argument_list|,
name|rb
argument_list|)
expr_stmt|;
name|fp
operator|=
name|fpu_sqrt
argument_list|(
name|fe
argument_list|)
expr_stmt|;
break|break;
case|case
name|OPC63M_FSEL
case|:
name|FPU_EMU_EVCNT_INCR
argument_list|(
name|fsel
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
name|FPE_INSN
argument_list|,
operator|(
literal|"fpu_execute: FSEL\n"
operator|)
argument_list|)
expr_stmt|;
name|a
operator|=
operator|(
name|int
operator|*
operator|)
operator|&
name|fe
operator|->
name|fe_fpstate
operator|->
name|fpreg
index|[
name|ra
index|]
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|a
operator|&
literal|0x80000000
operator|)
operator|&&
operator|(
operator|*
name|a
operator|&
literal|0x7fffffff
operator|)
condition|)
comment|/* fra< 0 */
name|rc
operator|=
name|rb
expr_stmt|;
name|DPRINTF
argument_list|(
name|FPE_INSN
argument_list|,
operator|(
literal|"f%d => f%d\n"
operator|,
name|rc
operator|,
name|rt
operator|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|fs
operator|->
name|fpreg
index|[
name|rt
index|]
argument_list|,
operator|&
name|fs
operator|->
name|fpreg
index|[
name|rc
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|double
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OPC59_FRES
case|:
name|FPU_EMU_EVCNT_INCR
argument_list|(
name|fpres
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
name|FPE_INSN
argument_list|,
operator|(
literal|"fpu_execute: FPRES\n"
operator|)
argument_list|)
expr_stmt|;
name|fpu_explode
argument_list|(
name|fe
argument_list|,
operator|&
name|fe
operator|->
name|fe_f1
argument_list|,
name|type
argument_list|,
name|rb
argument_list|)
expr_stmt|;
name|fp
operator|=
name|fpu_sqrt
argument_list|(
name|fe
argument_list|)
expr_stmt|;
comment|/* now we've gotta overwrite the dest reg */
operator|*
operator|(
operator|(
name|int
operator|*
operator|)
operator|&
name|fe
operator|->
name|fe_fpstate
operator|->
name|fpreg
index|[
name|rt
index|]
operator|)
operator|=
literal|1
expr_stmt|;
name|fpu_explode
argument_list|(
name|fe
argument_list|,
operator|&
name|fe
operator|->
name|fe_f1
argument_list|,
name|FTYPE_INT
argument_list|,
name|rt
argument_list|)
expr_stmt|;
name|fpu_div
argument_list|(
name|fe
argument_list|)
expr_stmt|;
break|break;
case|case
name|OPC59_FMULS
case|:
name|FPU_EMU_EVCNT_INCR
argument_list|(
name|fmul
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
name|FPE_INSN
argument_list|,
operator|(
literal|"fpu_execute: FMUL\n"
operator|)
argument_list|)
expr_stmt|;
name|fpu_explode
argument_list|(
name|fe
argument_list|,
operator|&
name|fe
operator|->
name|fe_f1
argument_list|,
name|type
argument_list|,
name|ra
argument_list|)
expr_stmt|;
name|fpu_explode
argument_list|(
name|fe
argument_list|,
operator|&
name|fe
operator|->
name|fe_f2
argument_list|,
name|type
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|fp
operator|=
name|fpu_mul
argument_list|(
name|fe
argument_list|)
expr_stmt|;
break|break;
case|case
name|OPC63M_FRSQRTE
case|:
comment|/* Reciprocal sqrt() estimate */
name|FPU_EMU_EVCNT_INCR
argument_list|(
name|frsqrte
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
name|FPE_INSN
argument_list|,
operator|(
literal|"fpu_execute: FRSQRTE\n"
operator|)
argument_list|)
expr_stmt|;
name|fpu_explode
argument_list|(
name|fe
argument_list|,
operator|&
name|fe
operator|->
name|fe_f1
argument_list|,
name|type
argument_list|,
name|rb
argument_list|)
expr_stmt|;
name|fp
operator|=
name|fpu_sqrt
argument_list|(
name|fe
argument_list|)
expr_stmt|;
name|fe
operator|->
name|fe_f2
operator|=
operator|*
name|fp
expr_stmt|;
comment|/* now we've gotta overwrite the dest reg */
operator|*
operator|(
operator|(
name|int
operator|*
operator|)
operator|&
name|fe
operator|->
name|fe_fpstate
operator|->
name|fpreg
index|[
name|rt
index|]
operator|)
operator|=
literal|1
expr_stmt|;
name|fpu_explode
argument_list|(
name|fe
argument_list|,
operator|&
name|fe
operator|->
name|fe_f1
argument_list|,
name|FTYPE_INT
argument_list|,
name|rt
argument_list|)
expr_stmt|;
name|fpu_div
argument_list|(
name|fe
argument_list|)
expr_stmt|;
break|break;
case|case
name|OPC59_FMSUBS
case|:
name|FPU_EMU_EVCNT_INCR
argument_list|(
name|fmulsub
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
name|FPE_INSN
argument_list|,
operator|(
literal|"fpu_execute: FMULSUB\n"
operator|)
argument_list|)
expr_stmt|;
name|fpu_explode
argument_list|(
name|fe
argument_list|,
operator|&
name|fe
operator|->
name|fe_f1
argument_list|,
name|type
argument_list|,
name|ra
argument_list|)
expr_stmt|;
name|fpu_explode
argument_list|(
name|fe
argument_list|,
operator|&
name|fe
operator|->
name|fe_f2
argument_list|,
name|type
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|fp
operator|=
name|fpu_mul
argument_list|(
name|fe
argument_list|)
expr_stmt|;
name|fe
operator|->
name|fe_f1
operator|=
operator|*
name|fp
expr_stmt|;
name|fpu_explode
argument_list|(
name|fe
argument_list|,
operator|&
name|fe
operator|->
name|fe_f2
argument_list|,
name|type
argument_list|,
name|rb
argument_list|)
expr_stmt|;
name|fp
operator|=
name|fpu_sub
argument_list|(
name|fe
argument_list|)
expr_stmt|;
break|break;
case|case
name|OPC59_FMADDS
case|:
name|FPU_EMU_EVCNT_INCR
argument_list|(
name|fmuladd
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
name|FPE_INSN
argument_list|,
operator|(
literal|"fpu_execute: FMULADD\n"
operator|)
argument_list|)
expr_stmt|;
name|fpu_explode
argument_list|(
name|fe
argument_list|,
operator|&
name|fe
operator|->
name|fe_f1
argument_list|,
name|type
argument_list|,
name|ra
argument_list|)
expr_stmt|;
name|fpu_explode
argument_list|(
name|fe
argument_list|,
operator|&
name|fe
operator|->
name|fe_f2
argument_list|,
name|type
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|fp
operator|=
name|fpu_mul
argument_list|(
name|fe
argument_list|)
expr_stmt|;
name|fe
operator|->
name|fe_f1
operator|=
operator|*
name|fp
expr_stmt|;
name|fpu_explode
argument_list|(
name|fe
argument_list|,
operator|&
name|fe
operator|->
name|fe_f2
argument_list|,
name|type
argument_list|,
name|rb
argument_list|)
expr_stmt|;
name|fp
operator|=
name|fpu_add
argument_list|(
name|fe
argument_list|)
expr_stmt|;
break|break;
case|case
name|OPC59_FNMSUBS
case|:
name|FPU_EMU_EVCNT_INCR
argument_list|(
name|fnmsub
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
name|FPE_INSN
argument_list|,
operator|(
literal|"fpu_execute: FNMSUB\n"
operator|)
argument_list|)
expr_stmt|;
name|fpu_explode
argument_list|(
name|fe
argument_list|,
operator|&
name|fe
operator|->
name|fe_f1
argument_list|,
name|type
argument_list|,
name|ra
argument_list|)
expr_stmt|;
name|fpu_explode
argument_list|(
name|fe
argument_list|,
operator|&
name|fe
operator|->
name|fe_f2
argument_list|,
name|type
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|fp
operator|=
name|fpu_mul
argument_list|(
name|fe
argument_list|)
expr_stmt|;
name|fe
operator|->
name|fe_f1
operator|=
operator|*
name|fp
expr_stmt|;
name|fpu_explode
argument_list|(
name|fe
argument_list|,
operator|&
name|fe
operator|->
name|fe_f2
argument_list|,
name|type
argument_list|,
name|rb
argument_list|)
expr_stmt|;
name|fp
operator|=
name|fpu_sub
argument_list|(
name|fe
argument_list|)
expr_stmt|;
comment|/* Negate */
name|fp
operator|->
name|fp_sign
operator|^=
literal|1
expr_stmt|;
break|break;
case|case
name|OPC59_FNMADDS
case|:
name|FPU_EMU_EVCNT_INCR
argument_list|(
name|fnmadd
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
name|FPE_INSN
argument_list|,
operator|(
literal|"fpu_execute: FNMADD\n"
operator|)
argument_list|)
expr_stmt|;
name|fpu_explode
argument_list|(
name|fe
argument_list|,
operator|&
name|fe
operator|->
name|fe_f1
argument_list|,
name|type
argument_list|,
name|ra
argument_list|)
expr_stmt|;
name|fpu_explode
argument_list|(
name|fe
argument_list|,
operator|&
name|fe
operator|->
name|fe_f2
argument_list|,
name|type
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|fp
operator|=
name|fpu_mul
argument_list|(
name|fe
argument_list|)
expr_stmt|;
name|fe
operator|->
name|fe_f1
operator|=
operator|*
name|fp
expr_stmt|;
name|fpu_explode
argument_list|(
name|fe
argument_list|,
operator|&
name|fe
operator|->
name|fe_f2
argument_list|,
name|type
argument_list|,
name|rb
argument_list|)
expr_stmt|;
name|fp
operator|=
name|fpu_add
argument_list|(
name|fe
argument_list|)
expr_stmt|;
comment|/* Negate */
name|fp
operator|->
name|fp_sign
operator|^=
literal|1
expr_stmt|;
break|break;
default|default:
return|return
operator|(
name|NOTFPU
operator|)
return|;
break|break;
block|}
comment|/* If the instruction was single precision, round */
if|if
condition|(
operator|!
operator|(
name|instr
operator|.
name|i_any
operator|.
name|i_opcd
operator|&
literal|0x4
operator|)
condition|)
block|{
name|fpu_implode
argument_list|(
name|fe
argument_list|,
name|fp
argument_list|,
name|FTYPE_SNG
argument_list|,
operator|(
name|u_int
operator|*
operator|)
operator|&
name|fs
operator|->
name|fpreg
index|[
name|rt
index|]
argument_list|)
expr_stmt|;
name|fpu_explode
argument_list|(
name|fe
argument_list|,
name|fp
operator|=
operator|&
name|fe
operator|->
name|fe_f1
argument_list|,
name|FTYPE_SNG
argument_list|,
name|rt
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
return|return
operator|(
name|NOTFPU
operator|)
return|;
block|}
comment|/* 	 * ALU operation is complete.  Collapse the result and then check 	 * for exceptions.  If we got any, and they are enabled, do not 	 * alter the destination register, just stop with an exception. 	 * Otherwise set new current exceptions and accrue. 	 */
if|if
condition|(
name|fp
condition|)
name|fpu_implode
argument_list|(
name|fe
argument_list|,
name|fp
argument_list|,
name|type
argument_list|,
operator|(
name|u_int
operator|*
operator|)
operator|&
name|fs
operator|->
name|fpreg
index|[
name|rt
index|]
argument_list|)
expr_stmt|;
name|cx
operator|=
name|fe
operator|->
name|fe_cx
expr_stmt|;
name|fsr
operator|=
name|fe
operator|->
name|fe_fpscr
expr_stmt|;
if|if
condition|(
name|cx
operator|!=
literal|0
condition|)
block|{
name|fsr
operator|&=
operator|~
name|FPSCR_FX
expr_stmt|;
if|if
condition|(
operator|(
name|cx
operator|^
name|fsr
operator|)
operator|&
name|FPSR_EX_MSK
condition|)
name|fsr
operator||=
name|FPSCR_FX
expr_stmt|;
name|mask
operator|=
name|fsr
operator|&
name|FPSR_EX
expr_stmt|;
name|mask
operator|<<=
operator|(
literal|25
operator|-
literal|3
operator|)
expr_stmt|;
if|if
condition|(
name|cx
operator|&
name|mask
condition|)
name|fsr
operator||=
name|FPSCR_FEX
expr_stmt|;
if|if
condition|(
name|cx
operator|&
name|FPSCR_FPRF
condition|)
block|{
comment|/* Need to replace CC */
name|fsr
operator|&=
operator|~
name|FPSCR_FPRF
expr_stmt|;
block|}
if|if
condition|(
name|cx
operator|&
operator|(
name|FPSR_EXOP
operator|)
condition|)
name|fsr
operator||=
name|FPSCR_VX
expr_stmt|;
name|fsr
operator||=
name|cx
expr_stmt|;
name|DPRINTF
argument_list|(
name|FPE_INSN
argument_list|,
operator|(
literal|"fpu_execute: cx %x, fsr %x\n"
operator|,
name|cx
operator|,
name|fsr
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|cond
condition|)
block|{
name|cond
operator|=
name|fsr
operator|&
literal|0xf0000000
expr_stmt|;
comment|/* Isolate condition codes */
name|cond
operator|>>=
literal|28
expr_stmt|;
comment|/* Move fpu condition codes to cr[1] */
name|tf
operator|->
name|cr
operator|&=
operator|(
literal|0x0f000000
operator|)
expr_stmt|;
name|tf
operator|->
name|cr
operator||=
operator|(
name|cond
operator|<<
literal|24
operator|)
expr_stmt|;
name|DPRINTF
argument_list|(
name|FPE_INSN
argument_list|,
operator|(
literal|"fpu_execute: cr[1]<= %x\n"
operator|,
name|cond
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|setcr
condition|)
block|{
name|cond
operator|=
name|fsr
operator|&
name|FPSCR_FPCC
expr_stmt|;
comment|/* Isolate condition codes */
name|cond
operator|<<=
literal|16
expr_stmt|;
comment|/* Move fpu condition codes to cr[1] */
name|tf
operator|->
name|cr
operator|&=
operator|~
operator|(
literal|0xf0000000
operator|>>
name|bf
operator|)
expr_stmt|;
name|tf
operator|->
name|cr
operator||=
operator|(
name|cond
operator|>>
name|bf
operator|)
expr_stmt|;
name|DPRINTF
argument_list|(
name|FPE_INSN
argument_list|,
operator|(
literal|"fpu_execute: cr[%d] (cr=%x)<= %x\n"
operator|,
name|bf
operator|/
literal|4
operator|,
name|tf
operator|->
name|cr
operator|,
name|cond
operator|)
argument_list|)
expr_stmt|;
block|}
operator|(
operator|(
name|int
operator|*
operator|)
operator|&
name|fs
operator|->
name|fpscr
operator|)
index|[
literal|1
index|]
operator|=
name|fsr
expr_stmt|;
if|if
condition|(
name|fsr
operator|&
name|FPSCR_FEX
condition|)
return|return
operator|(
name|FPE
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
comment|/* success */
block|}
end_function

end_unit


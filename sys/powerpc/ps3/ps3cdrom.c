begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (C) 2010 Nathan Whitehorn  * Copyright (C) 2011 glevand<geoffrey.levand@mail.ru>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer,  *    without modification, immediately at the beginning of the file.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/ata.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_include
include|#
directive|include
file|<sys/kthread.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm.h>
end_include

begin_include
include|#
directive|include
file|<vm/pmap.h>
end_include

begin_include
include|#
directive|include
file|<machine/pio.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/platform.h>
end_include

begin_include
include|#
directive|include
file|<machine/pmap.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<cam/cam.h>
end_include

begin_include
include|#
directive|include
file|<cam/cam_ccb.h>
end_include

begin_include
include|#
directive|include
file|<cam/cam_sim.h>
end_include

begin_include
include|#
directive|include
file|<cam/cam_xpt_sim.h>
end_include

begin_include
include|#
directive|include
file|<cam/cam_debug.h>
end_include

begin_include
include|#
directive|include
file|<cam/scsi/scsi_all.h>
end_include

begin_include
include|#
directive|include
file|"ps3bus.h"
end_include

begin_include
include|#
directive|include
file|"ps3-hvcall.h"
end_include

begin_define
define|#
directive|define
name|PS3CDROM_LOCK_INIT
parameter_list|(
name|_sc
parameter_list|)
define|\
value|mtx_init(&_sc->sc_mtx, device_get_nameunit(_sc->sc_dev), "ps3cdrom", \ 	    MTX_DEF)
end_define

begin_define
define|#
directive|define
name|PS3CDROM_LOCK_DESTROY
parameter_list|(
name|_sc
parameter_list|)
value|mtx_destroy(&_sc->sc_mtx);
end_define

begin_define
define|#
directive|define
name|PS3CDROM_LOCK
parameter_list|(
name|_sc
parameter_list|)
value|mtx_lock(&(_sc)->sc_mtx)
end_define

begin_define
define|#
directive|define
name|PS3CDROM_UNLOCK
parameter_list|(
name|_sc
parameter_list|)
value|mtx_unlock(&(_sc)->sc_mtx)
end_define

begin_define
define|#
directive|define
name|PS3CDROM_ASSERT_LOCKED
parameter_list|(
name|_sc
parameter_list|)
value|mtx_assert(&_sc->sc_mtx, MA_OWNED);
end_define

begin_define
define|#
directive|define
name|PS3CDROM_ASSERT_UNLOCKED
parameter_list|(
name|_sc
parameter_list|)
value|mtx_assert(&_sc->sc_mtx, MA_NOTOWNED);
end_define

begin_define
define|#
directive|define
name|PS3CDROM_MAX_XFERS
value|3
end_define

begin_define
define|#
directive|define
name|LV1_STORAGE_SEND_ATAPI_COMMAND
value|0x01
end_define

begin_struct_decl
struct_decl|struct
name|ps3cdrom_softc
struct_decl|;
end_struct_decl

begin_struct
struct|struct
name|ps3cdrom_xfer
block|{
name|TAILQ_ENTRY
argument_list|(
argument|ps3cdrom_xfer
argument_list|)
name|x_queue
expr_stmt|;
name|struct
name|ps3cdrom_softc
modifier|*
name|x_sc
decl_stmt|;
name|union
name|ccb
modifier|*
name|x_ccb
decl_stmt|;
name|bus_dmamap_t
name|x_dmamap
decl_stmt|;
name|uint64_t
name|x_tag
decl_stmt|;
block|}
struct|;
end_struct

begin_expr_stmt
name|TAILQ_HEAD
argument_list|(
name|ps3cdrom_xferq
argument_list|,
name|ps3cdrom_xfer
argument_list|)
expr_stmt|;
end_expr_stmt

begin_struct
struct|struct
name|ps3cdrom_softc
block|{
name|device_t
name|sc_dev
decl_stmt|;
name|struct
name|mtx
name|sc_mtx
decl_stmt|;
name|uint64_t
name|sc_blksize
decl_stmt|;
name|uint64_t
name|sc_nblocks
decl_stmt|;
name|int
name|sc_irqid
decl_stmt|;
name|struct
name|resource
modifier|*
name|sc_irq
decl_stmt|;
name|void
modifier|*
name|sc_irqctx
decl_stmt|;
name|bus_dma_tag_t
name|sc_dmatag
decl_stmt|;
name|struct
name|cam_sim
modifier|*
name|sc_sim
decl_stmt|;
name|struct
name|cam_path
modifier|*
name|sc_path
decl_stmt|;
name|struct
name|ps3cdrom_xfer
name|sc_xfer
index|[
name|PS3CDROM_MAX_XFERS
index|]
decl_stmt|;
name|struct
name|ps3cdrom_xferq
name|sc_active_xferq
decl_stmt|;
name|struct
name|ps3cdrom_xferq
name|sc_free_xferq
decl_stmt|;
block|}
struct|;
end_struct

begin_enum
enum|enum
name|lv1_ata_proto
block|{
name|NON_DATA_PROTO
init|=
literal|0x00
block|,
name|PIO_DATA_IN_PROTO
init|=
literal|0x01
block|,
name|PIO_DATA_OUT_PROTO
init|=
literal|0x02
block|,
name|DMA_PROTO
init|=
literal|0x03
block|}
enum|;
end_enum

begin_enum
enum|enum
name|lv1_ata_in_out
block|{
name|DIR_WRITE
init|=
literal|0x00
block|,
name|DIR_READ
init|=
literal|0x01
block|}
enum|;
end_enum

begin_struct
struct|struct
name|lv1_atapi_cmd
block|{
name|uint8_t
name|pkt
index|[
literal|32
index|]
decl_stmt|;
name|uint32_t
name|pktlen
decl_stmt|;
name|uint32_t
name|nblocks
decl_stmt|;
name|uint32_t
name|blksize
decl_stmt|;
name|uint32_t
name|proto
decl_stmt|;
comment|/* enum lv1_ata_proto */
name|uint32_t
name|in_out
decl_stmt|;
comment|/* enum lv1_ata_in_out */
name|uint64_t
name|buf
decl_stmt|;
name|uint32_t
name|arglen
decl_stmt|;
block|}
struct|;
end_struct

begin_function_decl
specifier|static
name|void
name|ps3cdrom_action
parameter_list|(
name|struct
name|cam_sim
modifier|*
name|sim
parameter_list|,
name|union
name|ccb
modifier|*
name|ccb
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ps3cdrom_poll
parameter_list|(
name|struct
name|cam_sim
modifier|*
name|sim
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ps3cdrom_async
parameter_list|(
name|void
modifier|*
name|callback_arg
parameter_list|,
name|u_int32_t
name|code
parameter_list|,
name|struct
name|cam_path
modifier|*
name|path
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ps3cdrom_intr
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ps3cdrom_transfer
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|segs
parameter_list|,
name|int
name|nsegs
parameter_list|,
name|int
name|error
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ps3cdrom_decode_lv1_status
parameter_list|(
name|uint64_t
name|status
parameter_list|,
name|u_int8_t
modifier|*
name|sense_key
parameter_list|,
name|u_int8_t
modifier|*
name|asc
parameter_list|,
name|u_int8_t
modifier|*
name|ascq
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|int
name|ps3cdrom_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
if|if
condition|(
name|ps3bus_get_bustype
argument_list|(
name|dev
argument_list|)
operator|!=
name|PS3_BUSTYPE_STORAGE
operator|||
name|ps3bus_get_devtype
argument_list|(
name|dev
argument_list|)
operator|!=
name|PS3_DEVTYPE_CDROM
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"Playstation 3 CDROM"
argument_list|)
expr_stmt|;
return|return
operator|(
name|BUS_PROBE_SPECIFIC
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ps3cdrom_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ps3cdrom_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|cam_devq
modifier|*
name|devq
decl_stmt|;
name|struct
name|ps3cdrom_xfer
modifier|*
name|xp
decl_stmt|;
name|struct
name|ccb_setasync
name|csa
decl_stmt|;
name|int
name|i
decl_stmt|,
name|err
decl_stmt|;
name|sc
operator|->
name|sc_dev
operator|=
name|dev
expr_stmt|;
name|PS3CDROM_LOCK_INIT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Setup interrupt handler */
name|sc
operator|->
name|sc_irqid
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_irq
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
operator|&
name|sc
operator|->
name|sc_irqid
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sc
operator|->
name|sc_irq
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Could not allocate IRQ\n"
argument_list|)
expr_stmt|;
name|err
operator|=
name|ENXIO
expr_stmt|;
goto|goto
name|fail_destroy_lock
goto|;
block|}
name|err
operator|=
name|bus_setup_intr
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|sc_irq
argument_list|,
name|INTR_TYPE_CAM
operator||
name|INTR_MPSAFE
operator||
name|INTR_ENTROPY
argument_list|,
name|NULL
argument_list|,
name|ps3cdrom_intr
argument_list|,
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|sc_irqctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Could not setup IRQ\n"
argument_list|)
expr_stmt|;
name|err
operator|=
name|ENXIO
expr_stmt|;
goto|goto
name|fail_release_intr
goto|;
block|}
comment|/* Setup DMA */
name|err
operator|=
name|bus_dma_tag_create
argument_list|(
name|bus_get_dma_tag
argument_list|(
name|dev
argument_list|)
argument_list|,
literal|4096
argument_list|,
literal|0
argument_list|,
name|BUS_SPACE_MAXADDR
argument_list|,
name|BUS_SPACE_MAXADDR
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|BUS_SPACE_UNRESTRICTED
argument_list|,
literal|1
argument_list|,
name|PAGE_SIZE
argument_list|,
literal|0
argument_list|,
name|busdma_lock_mutex
argument_list|,
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|,
operator|&
name|sc
operator|->
name|sc_dmatag
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Could not create DMA tag\n"
argument_list|)
expr_stmt|;
name|err
operator|=
name|ENXIO
expr_stmt|;
goto|goto
name|fail_teardown_intr
goto|;
block|}
comment|/* Setup transfer queues */
name|TAILQ_INIT
argument_list|(
operator|&
name|sc
operator|->
name|sc_active_xferq
argument_list|)
expr_stmt|;
name|TAILQ_INIT
argument_list|(
operator|&
name|sc
operator|->
name|sc_free_xferq
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|PS3CDROM_MAX_XFERS
condition|;
name|i
operator|++
control|)
block|{
name|xp
operator|=
operator|&
name|sc
operator|->
name|sc_xfer
index|[
name|i
index|]
expr_stmt|;
name|xp
operator|->
name|x_sc
operator|=
name|sc
expr_stmt|;
name|err
operator|=
name|bus_dmamap_create
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
name|BUS_DMA_COHERENT
argument_list|,
operator|&
name|xp
operator|->
name|x_dmamap
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Could not create DMA map (%d)\n"
argument_list|,
name|err
argument_list|)
expr_stmt|;
goto|goto
name|fail_destroy_dmamap
goto|;
block|}
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|sc
operator|->
name|sc_free_xferq
argument_list|,
name|xp
argument_list|,
name|x_queue
argument_list|)
expr_stmt|;
block|}
comment|/* Setup CAM */
name|devq
operator|=
name|cam_simq_alloc
argument_list|(
name|PS3CDROM_MAX_XFERS
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|devq
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Could not allocate SIM queue\n"
argument_list|)
expr_stmt|;
name|err
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|fail_destroy_dmatag
goto|;
block|}
name|sc
operator|->
name|sc_sim
operator|=
name|cam_sim_alloc
argument_list|(
name|ps3cdrom_action
argument_list|,
name|ps3cdrom_poll
argument_list|,
literal|"ps3cdrom"
argument_list|,
name|sc
argument_list|,
name|device_get_unit
argument_list|(
name|dev
argument_list|)
argument_list|,
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|,
name|PS3CDROM_MAX_XFERS
operator|-
literal|1
argument_list|,
literal|0
argument_list|,
name|devq
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sc
operator|->
name|sc_sim
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Could not allocate SIM\n"
argument_list|)
expr_stmt|;
name|cam_simq_free
argument_list|(
name|devq
argument_list|)
expr_stmt|;
name|err
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|fail_destroy_dmatag
goto|;
block|}
comment|/* Setup XPT */
name|PS3CDROM_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|err
operator|=
name|xpt_bus_register
argument_list|(
name|sc
operator|->
name|sc_sim
argument_list|,
name|dev
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|CAM_SUCCESS
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Could not register XPT bus\n"
argument_list|)
expr_stmt|;
name|err
operator|=
name|ENXIO
expr_stmt|;
name|PS3CDROM_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
goto|goto
name|fail_free_sim
goto|;
block|}
name|err
operator|=
name|xpt_create_path
argument_list|(
operator|&
name|sc
operator|->
name|sc_path
argument_list|,
name|NULL
argument_list|,
name|cam_sim_path
argument_list|(
name|sc
operator|->
name|sc_sim
argument_list|)
argument_list|,
name|CAM_TARGET_WILDCARD
argument_list|,
name|CAM_LUN_WILDCARD
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|CAM_REQ_CMP
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Could not create XPT path\n"
argument_list|)
expr_stmt|;
name|err
operator|=
name|ENOMEM
expr_stmt|;
name|PS3CDROM_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
goto|goto
name|fail_unregister_xpt_bus
goto|;
block|}
name|xpt_setup_ccb
argument_list|(
operator|&
name|csa
operator|.
name|ccb_h
argument_list|,
name|sc
operator|->
name|sc_path
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|csa
operator|.
name|ccb_h
operator|.
name|func_code
operator|=
name|XPT_SASYNC_CB
expr_stmt|;
name|csa
operator|.
name|event_enable
operator|=
name|AC_LOST_DEVICE
expr_stmt|;
name|csa
operator|.
name|callback
operator|=
name|ps3cdrom_async
expr_stmt|;
name|csa
operator|.
name|callback_arg
operator|=
name|sc
operator|->
name|sc_sim
expr_stmt|;
name|xpt_action
argument_list|(
operator|(
expr|union
name|ccb
operator|*
operator|)
operator|&
name|csa
argument_list|)
expr_stmt|;
name|CAM_DEBUG
argument_list|(
name|sc
operator|->
name|sc_path
argument_list|,
name|CAM_DEBUG_TRACE
argument_list|,
operator|(
literal|"registered SIM for ps3cdrom%d\n"
operator|,
name|device_get_unit
argument_list|(
name|dev
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|PS3CDROM_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|BUS_PROBE_SPECIFIC
operator|)
return|;
name|fail_unregister_xpt_bus
label|:
name|xpt_bus_deregister
argument_list|(
name|cam_sim_path
argument_list|(
name|sc
operator|->
name|sc_sim
argument_list|)
argument_list|)
expr_stmt|;
name|fail_free_sim
label|:
name|cam_sim_free
argument_list|(
name|sc
operator|->
name|sc_sim
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|fail_destroy_dmamap
label|:
while|while
condition|(
operator|(
name|xp
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|sc
operator|->
name|sc_free_xferq
argument_list|)
operator|)
condition|)
block|{
name|TAILQ_REMOVE
argument_list|(
operator|&
name|sc
operator|->
name|sc_free_xferq
argument_list|,
name|xp
argument_list|,
name|x_queue
argument_list|)
expr_stmt|;
name|bus_dmamap_destroy
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
name|xp
operator|->
name|x_dmamap
argument_list|)
expr_stmt|;
block|}
name|fail_destroy_dmatag
label|:
name|bus_dma_tag_destroy
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|)
expr_stmt|;
name|fail_teardown_intr
label|:
name|bus_teardown_intr
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|sc_irq
argument_list|,
name|sc
operator|->
name|sc_irqctx
argument_list|)
expr_stmt|;
name|fail_release_intr
label|:
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
name|sc
operator|->
name|sc_irqid
argument_list|,
name|sc
operator|->
name|sc_irq
argument_list|)
expr_stmt|;
name|fail_destroy_lock
label|:
name|PS3CDROM_LOCK_DESTROY
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ps3cdrom_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ps3cdrom_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|i
decl_stmt|;
name|xpt_async
argument_list|(
name|AC_LOST_DEVICE
argument_list|,
name|sc
operator|->
name|sc_path
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|xpt_free_path
argument_list|(
name|sc
operator|->
name|sc_path
argument_list|)
expr_stmt|;
name|xpt_bus_deregister
argument_list|(
name|cam_sim_path
argument_list|(
name|sc
operator|->
name|sc_sim
argument_list|)
argument_list|)
expr_stmt|;
name|cam_sim_free
argument_list|(
name|sc
operator|->
name|sc_sim
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|PS3CDROM_MAX_XFERS
condition|;
name|i
operator|++
control|)
name|bus_dmamap_destroy
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
name|sc
operator|->
name|sc_xfer
index|[
name|i
index|]
operator|.
name|x_dmamap
argument_list|)
expr_stmt|;
name|bus_dma_tag_destroy
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|)
expr_stmt|;
name|bus_teardown_intr
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|sc_irq
argument_list|,
name|sc
operator|->
name|sc_irqctx
argument_list|)
expr_stmt|;
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
name|sc
operator|->
name|sc_irqid
argument_list|,
name|sc
operator|->
name|sc_irq
argument_list|)
expr_stmt|;
name|PS3CDROM_LOCK_DESTROY
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ps3cdrom_action
parameter_list|(
name|struct
name|cam_sim
modifier|*
name|sim
parameter_list|,
name|union
name|ccb
modifier|*
name|ccb
parameter_list|)
block|{
name|struct
name|ps3cdrom_softc
modifier|*
name|sc
init|=
operator|(
expr|struct
name|ps3cdrom_softc
operator|*
operator|)
name|cam_sim_softc
argument_list|(
name|sim
argument_list|)
decl_stmt|;
name|device_t
name|dev
init|=
name|sc
operator|->
name|sc_dev
decl_stmt|;
name|struct
name|ps3cdrom_xfer
modifier|*
name|xp
decl_stmt|;
name|int
name|err
decl_stmt|;
name|PS3CDROM_ASSERT_LOCKED
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|CAM_DEBUG
argument_list|(
name|ccb
operator|->
name|ccb_h
operator|.
name|path
argument_list|,
name|CAM_DEBUG_TRACE
argument_list|,
operator|(
literal|"function code 0x%02x\n"
operator|,
name|ccb
operator|->
name|ccb_h
operator|.
name|func_code
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ccb
operator|->
name|ccb_h
operator|.
name|func_code
condition|)
block|{
case|case
name|XPT_SCSI_IO
case|:
if|if
condition|(
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|&
name|CAM_STATUS_MASK
operator|)
operator|!=
name|CAM_REQ_INPROG
condition|)
break|break;
if|if
condition|(
name|ccb
operator|->
name|ccb_h
operator|.
name|target_id
operator|>
literal|0
condition|)
block|{
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_TID_INVALID
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ccb
operator|->
name|ccb_h
operator|.
name|target_lun
operator|>
literal|0
condition|)
block|{
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_LUN_INVALID
expr_stmt|;
break|break;
block|}
name|xp
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|sc
operator|->
name|sc_free_xferq
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|xp
operator|!=
name|NULL
argument_list|,
operator|(
literal|"no free transfers"
operator|)
argument_list|)
expr_stmt|;
name|xp
operator|->
name|x_ccb
operator|=
name|ccb
expr_stmt|;
name|TAILQ_REMOVE
argument_list|(
operator|&
name|sc
operator|->
name|sc_free_xferq
argument_list|,
name|xp
argument_list|,
name|x_queue
argument_list|)
expr_stmt|;
name|err
operator|=
name|bus_dmamap_load
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
name|xp
operator|->
name|x_dmamap
argument_list|,
name|ccb
operator|->
name|csio
operator|.
name|data_ptr
argument_list|,
name|ccb
operator|->
name|csio
operator|.
name|dxfer_len
argument_list|,
name|ps3cdrom_transfer
argument_list|,
name|xp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|&&
name|err
operator|!=
name|EINPROGRESS
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Could not load DMA map (%d)\n"
argument_list|,
name|err
argument_list|)
expr_stmt|;
name|xp
operator|->
name|x_ccb
operator|=
name|NULL
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|sc
operator|->
name|sc_free_xferq
argument_list|,
name|xp
argument_list|,
name|x_queue
argument_list|)
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_SCSI_STATUS_ERROR
expr_stmt|;
break|break;
block|}
return|return;
case|case
name|XPT_SET_TRAN_SETTINGS
case|:
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_FUNC_NOTAVAIL
expr_stmt|;
break|break;
case|case
name|XPT_GET_TRAN_SETTINGS
case|:
block|{
name|struct
name|ccb_trans_settings
modifier|*
name|cts
init|=
operator|&
name|ccb
operator|->
name|cts
decl_stmt|;
name|cts
operator|->
name|protocol
operator|=
name|PROTO_SCSI
expr_stmt|;
name|cts
operator|->
name|protocol_version
operator|=
name|SCSI_REV_2
expr_stmt|;
name|cts
operator|->
name|transport
operator|=
name|XPORT_SPI
expr_stmt|;
name|cts
operator|->
name|transport_version
operator|=
literal|2
expr_stmt|;
name|cts
operator|->
name|proto_specific
operator|.
name|valid
operator|=
literal|0
expr_stmt|;
name|cts
operator|->
name|xport_specific
operator|.
name|valid
operator|=
literal|0
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_CMP
expr_stmt|;
break|break;
block|}
case|case
name|XPT_RESET_BUS
case|:
case|case
name|XPT_RESET_DEV
case|:
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_CMP
expr_stmt|;
break|break;
case|case
name|XPT_CALC_GEOMETRY
case|:
name|cam_calc_geometry
argument_list|(
operator|&
name|ccb
operator|->
name|ccg
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|XPT_PATH_INQ
case|:
block|{
name|struct
name|ccb_pathinq
modifier|*
name|cpi
init|=
operator|&
name|ccb
operator|->
name|cpi
decl_stmt|;
name|cpi
operator|->
name|version_num
operator|=
literal|1
expr_stmt|;
name|cpi
operator|->
name|hba_inquiry
operator|=
literal|0
expr_stmt|;
name|cpi
operator|->
name|target_sprt
operator|=
literal|0
expr_stmt|;
name|cpi
operator|->
name|hba_inquiry
operator|=
name|PI_SDTR_ABLE
expr_stmt|;
name|cpi
operator|->
name|hba_misc
operator|=
name|PIM_NOBUSRESET
operator||
name|PIM_SEQSCAN
operator||
name|PIM_NO_6_BYTE
expr_stmt|;
name|cpi
operator|->
name|hba_eng_cnt
operator|=
literal|0
expr_stmt|;
name|bzero
argument_list|(
name|cpi
operator|->
name|vuhba_flags
argument_list|,
sizeof|sizeof
argument_list|(
name|cpi
operator|->
name|vuhba_flags
argument_list|)
argument_list|)
expr_stmt|;
name|cpi
operator|->
name|max_target
operator|=
literal|0
expr_stmt|;
name|cpi
operator|->
name|max_lun
operator|=
literal|0
expr_stmt|;
name|cpi
operator|->
name|initiator_id
operator|=
literal|7
expr_stmt|;
name|cpi
operator|->
name|bus_id
operator|=
name|cam_sim_bus
argument_list|(
name|sim
argument_list|)
expr_stmt|;
name|cpi
operator|->
name|unit_number
operator|=
name|cam_sim_unit
argument_list|(
name|sim
argument_list|)
expr_stmt|;
name|cpi
operator|->
name|base_transfer_speed
operator|=
literal|150000
expr_stmt|;
name|strncpy
argument_list|(
name|cpi
operator|->
name|sim_vid
argument_list|,
literal|"FreeBSD"
argument_list|,
name|SIM_IDLEN
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|cpi
operator|->
name|hba_vid
argument_list|,
literal|"Sony"
argument_list|,
name|HBA_IDLEN
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|cpi
operator|->
name|dev_name
argument_list|,
name|cam_sim_name
argument_list|(
name|sim
argument_list|)
argument_list|,
name|DEV_IDLEN
argument_list|)
expr_stmt|;
name|cpi
operator|->
name|transport
operator|=
name|XPORT_SPI
expr_stmt|;
name|cpi
operator|->
name|transport_version
operator|=
literal|2
expr_stmt|;
name|cpi
operator|->
name|protocol
operator|=
name|PROTO_SCSI
expr_stmt|;
name|cpi
operator|->
name|protocol_version
operator|=
name|SCSI_REV_2
expr_stmt|;
name|cpi
operator|->
name|maxio
operator|=
name|PAGE_SIZE
expr_stmt|;
name|cpi
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_CMP
expr_stmt|;
break|break;
block|}
default|default:
name|CAM_DEBUG
argument_list|(
name|ccb
operator|->
name|ccb_h
operator|.
name|path
argument_list|,
name|CAM_DEBUG_TRACE
argument_list|,
operator|(
literal|"unsupported function code 0x%02x\n"
operator|,
name|ccb
operator|->
name|ccb_h
operator|.
name|func_code
operator|)
argument_list|)
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_INVALID
expr_stmt|;
break|break;
block|}
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ps3cdrom_poll
parameter_list|(
name|struct
name|cam_sim
modifier|*
name|sim
parameter_list|)
block|{
name|ps3cdrom_intr
argument_list|(
name|cam_sim_softc
argument_list|(
name|sim
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ps3cdrom_async
parameter_list|(
name|void
modifier|*
name|callback_arg
parameter_list|,
name|u_int32_t
name|code
parameter_list|,
name|struct
name|cam_path
modifier|*
name|path
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
switch|switch
condition|(
name|code
condition|)
block|{
case|case
name|AC_LOST_DEVICE
case|:
name|xpt_print_path
argument_list|(
name|path
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ps3cdrom_intr
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|ps3cdrom_softc
modifier|*
name|sc
init|=
operator|(
expr|struct
name|ps3cdrom_softc
operator|*
operator|)
name|arg
decl_stmt|;
name|device_t
name|dev
init|=
name|sc
operator|->
name|sc_dev
decl_stmt|;
name|uint64_t
name|devid
init|=
name|ps3bus_get_device
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ps3cdrom_xfer
modifier|*
name|xp
decl_stmt|;
name|union
name|ccb
modifier|*
name|ccb
decl_stmt|;
name|u_int8_t
modifier|*
name|cdb
decl_stmt|,
name|sense_key
decl_stmt|,
name|asc
decl_stmt|,
name|ascq
decl_stmt|;
name|uint64_t
name|tag
decl_stmt|,
name|status
decl_stmt|;
if|if
condition|(
name|lv1_storage_get_async_status
argument_list|(
name|devid
argument_list|,
operator|&
name|tag
argument_list|,
operator|&
name|status
argument_list|)
operator|!=
literal|0
condition|)
return|return;
name|PS3CDROM_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Find transfer with the returned tag */
name|TAILQ_FOREACH
argument_list|(
argument|xp
argument_list|,
argument|&sc->sc_active_xferq
argument_list|,
argument|x_queue
argument_list|)
block|{
if|if
condition|(
name|xp
operator|->
name|x_tag
operator|==
name|tag
condition|)
break|break;
block|}
if|if
condition|(
name|xp
condition|)
block|{
name|ccb
operator|=
name|xp
operator|->
name|x_ccb
expr_stmt|;
name|cdb
operator|=
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_CDB_POINTER
operator|)
condition|?
name|ccb
operator|->
name|csio
operator|.
name|cdb_io
operator|.
name|cdb_ptr
else|:
name|ccb
operator|->
name|csio
operator|.
name|cdb_io
operator|.
name|cdb_bytes
expr_stmt|;
name|CAM_DEBUG
argument_list|(
name|ccb
operator|->
name|ccb_h
operator|.
name|path
argument_list|,
name|CAM_DEBUG_TRACE
argument_list|,
operator|(
literal|"ATAPI command 0x%02x tag 0x%016lx completed (0x%016lx)\n"
operator|,
name|cdb
index|[
literal|0
index|]
operator|,
name|tag
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|status
condition|)
block|{
name|ccb
operator|->
name|csio
operator|.
name|scsi_status
operator|=
name|SCSI_STATUS_OK
expr_stmt|;
name|ccb
operator|->
name|csio
operator|.
name|resid
operator|=
literal|0
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_CMP
expr_stmt|;
block|}
else|else
block|{
name|ccb
operator|->
name|csio
operator|.
name|scsi_status
operator|=
name|SCSI_STATUS_CHECK_COND
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_SCSI_STATUS_ERROR
expr_stmt|;
if|if
condition|(
operator|!
name|ps3cdrom_decode_lv1_status
argument_list|(
name|status
argument_list|,
operator|&
name|sense_key
argument_list|,
operator|&
name|asc
argument_list|,
operator|&
name|ascq
argument_list|)
condition|)
block|{
name|struct
name|scsi_sense_data
name|sense_data
decl_stmt|;
name|CAM_DEBUG
argument_list|(
name|ccb
operator|->
name|ccb_h
operator|.
name|path
argument_list|,
name|CAM_DEBUG_TRACE
argument_list|,
operator|(
literal|"sense key 0x%02x asc 0x%02x ascq 0x%02x\n"
operator|,
name|sense_key
operator|,
name|asc
operator|,
name|ascq
operator|)
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|sense_data
argument_list|,
sizeof|sizeof
argument_list|(
name|sense_data
argument_list|)
argument_list|)
expr_stmt|;
name|sense_data
operator|.
name|error_code
operator|=
name|SSD_CURRENT_ERROR
expr_stmt|;
name|sense_data
operator|.
name|flags
operator||=
name|sense_key
expr_stmt|;
name|sense_data
operator|.
name|extra_len
operator|=
literal|0xa
expr_stmt|;
name|sense_data
operator|.
name|add_sense_code
operator|=
name|asc
expr_stmt|;
name|sense_data
operator|.
name|add_sense_code_qual
operator|=
name|ascq
expr_stmt|;
name|ccb
operator|->
name|csio
operator|.
name|sense_len
operator|=
sizeof|sizeof
argument_list|(
name|sense_data
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|&
name|sense_data
argument_list|,
operator|&
name|ccb
operator|->
name|csio
operator|.
name|sense_data
argument_list|,
name|ccb
operator|->
name|csio
operator|.
name|sense_len
argument_list|)
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_SCSI_STATUS_ERROR
operator||
name|CAM_AUTOSNS_VALID
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_DIR_MASK
operator|)
operator|!=
name|CAM_DIR_NONE
condition|)
name|ccb
operator|->
name|csio
operator|.
name|resid
operator|=
name|ccb
operator|->
name|csio
operator|.
name|dxfer_len
expr_stmt|;
block|}
if|if
condition|(
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_DIR_IN
condition|)
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
name|xp
operator|->
name|x_dmamap
argument_list|,
name|BUS_DMASYNC_POSTREAD
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
name|xp
operator|->
name|x_dmamap
argument_list|)
expr_stmt|;
name|xp
operator|->
name|x_ccb
operator|=
name|NULL
expr_stmt|;
name|TAILQ_REMOVE
argument_list|(
operator|&
name|sc
operator|->
name|sc_active_xferq
argument_list|,
name|xp
argument_list|,
name|x_queue
argument_list|)
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|sc
operator|->
name|sc_free_xferq
argument_list|,
name|xp
argument_list|,
name|x_queue
argument_list|)
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Could not find transfer with tag 0x%016lx\n"
argument_list|,
name|tag
argument_list|)
expr_stmt|;
block|}
name|PS3CDROM_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ps3cdrom_transfer
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|segs
parameter_list|,
name|int
name|nsegs
parameter_list|,
name|int
name|error
parameter_list|)
block|{
name|struct
name|ps3cdrom_xfer
modifier|*
name|xp
init|=
operator|(
expr|struct
name|ps3cdrom_xfer
operator|*
operator|)
name|arg
decl_stmt|;
name|struct
name|ps3cdrom_softc
modifier|*
name|sc
init|=
name|xp
operator|->
name|x_sc
decl_stmt|;
name|device_t
name|dev
init|=
name|sc
operator|->
name|sc_dev
decl_stmt|;
name|uint64_t
name|devid
init|=
name|ps3bus_get_device
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|union
name|ccb
modifier|*
name|ccb
init|=
name|xp
operator|->
name|x_ccb
decl_stmt|;
name|u_int8_t
modifier|*
name|cdb
decl_stmt|;
name|uint64_t
name|start_sector
decl_stmt|,
name|block_count
decl_stmt|;
name|int
name|err
decl_stmt|;
name|KASSERT
argument_list|(
name|nsegs
operator|==
literal|1
argument_list|,
operator|(
literal|"invalid number of DMA segments"
operator|)
argument_list|)
expr_stmt|;
name|PS3CDROM_ASSERT_LOCKED
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Could not load DMA map (%d)\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|xp
operator|->
name|x_ccb
operator|=
name|NULL
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|sc
operator|->
name|sc_free_xferq
argument_list|,
name|xp
argument_list|,
name|x_queue
argument_list|)
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_SCSI_STATUS_ERROR
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
return|return;
block|}
name|cdb
operator|=
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_CDB_POINTER
operator|)
condition|?
name|ccb
operator|->
name|csio
operator|.
name|cdb_io
operator|.
name|cdb_ptr
else|:
name|ccb
operator|->
name|csio
operator|.
name|cdb_io
operator|.
name|cdb_bytes
expr_stmt|;
name|CAM_DEBUG
argument_list|(
name|ccb
operator|->
name|ccb_h
operator|.
name|path
argument_list|,
name|CAM_DEBUG_TRACE
argument_list|,
operator|(
literal|"ATAPI command 0x%02x cdb_len %d dxfer_len %d\n "
operator|,
name|cdb
index|[
literal|0
index|]
operator|,
name|ccb
operator|->
name|csio
operator|.
name|cdb_len
operator|,
name|ccb
operator|->
name|csio
operator|.
name|dxfer_len
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cdb
index|[
literal|0
index|]
condition|)
block|{
case|case
name|READ_10
case|:
name|start_sector
operator|=
operator|(
name|cdb
index|[
literal|2
index|]
operator|<<
literal|24
operator|)
operator||
operator|(
name|cdb
index|[
literal|3
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
name|cdb
index|[
literal|4
index|]
operator|<<
literal|8
operator|)
operator||
name|cdb
index|[
literal|5
index|]
expr_stmt|;
name|block_count
operator|=
operator|(
name|cdb
index|[
literal|7
index|]
operator|<<
literal|8
operator|)
operator||
name|cdb
index|[
literal|8
index|]
expr_stmt|;
name|err
operator|=
name|lv1_storage_read
argument_list|(
name|devid
argument_list|,
literal|0
comment|/* region id */
argument_list|,
name|start_sector
argument_list|,
name|block_count
argument_list|,
literal|0
comment|/* flags */
argument_list|,
name|segs
index|[
literal|0
index|]
operator|.
name|ds_addr
argument_list|,
operator|&
name|xp
operator|->
name|x_tag
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
name|xp
operator|->
name|x_dmamap
argument_list|,
name|BUS_DMASYNC_POSTREAD
argument_list|)
expr_stmt|;
break|break;
case|case
name|WRITE_10
case|:
name|start_sector
operator|=
operator|(
name|cdb
index|[
literal|2
index|]
operator|<<
literal|24
operator|)
operator||
operator|(
name|cdb
index|[
literal|3
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
name|cdb
index|[
literal|4
index|]
operator|<<
literal|8
operator|)
operator||
name|cdb
index|[
literal|5
index|]
expr_stmt|;
name|block_count
operator|=
operator|(
name|cdb
index|[
literal|7
index|]
operator|<<
literal|8
operator|)
operator||
name|cdb
index|[
literal|8
index|]
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
name|xp
operator|->
name|x_dmamap
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
name|err
operator|=
name|lv1_storage_write
argument_list|(
name|devid
argument_list|,
literal|0
comment|/* region id */
argument_list|,
name|start_sector
argument_list|,
name|block_count
argument_list|,
literal|0
comment|/* flags */
argument_list|,
name|segs
index|[
literal|0
index|]
operator|.
name|ds_addr
argument_list|,
operator|&
name|xp
operator|->
name|x_tag
argument_list|)
expr_stmt|;
break|break;
default|default:
block|{
name|struct
name|lv1_atapi_cmd
name|atapi_cmd
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|atapi_cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|atapi_cmd
argument_list|)
argument_list|)
expr_stmt|;
name|atapi_cmd
operator|.
name|pktlen
operator|=
literal|12
expr_stmt|;
name|bcopy
argument_list|(
name|cdb
argument_list|,
name|atapi_cmd
operator|.
name|pkt
argument_list|,
name|ccb
operator|->
name|csio
operator|.
name|cdb_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_DIR_IN
condition|)
block|{
name|atapi_cmd
operator|.
name|in_out
operator|=
name|DIR_READ
expr_stmt|;
name|atapi_cmd
operator|.
name|proto
operator|=
operator|(
name|ccb
operator|->
name|csio
operator|.
name|dxfer_len
operator|>=
literal|2048
operator|)
condition|?
name|DMA_PROTO
else|:
name|PIO_DATA_IN_PROTO
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_DIR_OUT
condition|)
block|{
name|atapi_cmd
operator|.
name|in_out
operator|=
name|DIR_WRITE
expr_stmt|;
name|atapi_cmd
operator|.
name|proto
operator|=
operator|(
name|ccb
operator|->
name|csio
operator|.
name|dxfer_len
operator|>=
literal|2048
operator|)
condition|?
name|DMA_PROTO
else|:
name|PIO_DATA_OUT_PROTO
expr_stmt|;
block|}
else|else
block|{
name|atapi_cmd
operator|.
name|proto
operator|=
name|NON_DATA_PROTO
expr_stmt|;
block|}
name|atapi_cmd
operator|.
name|nblocks
operator|=
name|atapi_cmd
operator|.
name|arglen
operator|=
name|segs
index|[
literal|0
index|]
operator|.
name|ds_len
expr_stmt|;
name|atapi_cmd
operator|.
name|blksize
operator|=
literal|1
expr_stmt|;
name|atapi_cmd
operator|.
name|buf
operator|=
name|segs
index|[
literal|0
index|]
operator|.
name|ds_addr
expr_stmt|;
if|if
condition|(
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_DIR_OUT
condition|)
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
name|xp
operator|->
name|x_dmamap
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
name|err
operator|=
name|lv1_storage_send_device_command
argument_list|(
name|devid
argument_list|,
name|LV1_STORAGE_SEND_ATAPI_COMMAND
argument_list|,
name|vtophys
argument_list|(
operator|&
name|atapi_cmd
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|atapi_cmd
argument_list|)
argument_list|,
name|atapi_cmd
operator|.
name|buf
argument_list|,
name|atapi_cmd
operator|.
name|arglen
argument_list|,
operator|&
name|xp
operator|->
name|x_tag
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|err
condition|)
block|{
name|struct
name|scsi_sense_data
name|sense_data
decl_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"ATAPI command 0x%02x failed (%d)\n"
argument_list|,
name|cdb
index|[
literal|0
index|]
argument_list|,
name|err
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
name|xp
operator|->
name|x_dmamap
argument_list|)
expr_stmt|;
name|xp
operator|->
name|x_ccb
operator|=
name|NULL
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|sc
operator|->
name|sc_free_xferq
argument_list|,
name|xp
argument_list|,
name|x_queue
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|sense_data
argument_list|,
sizeof|sizeof
argument_list|(
name|sense_data
argument_list|)
argument_list|)
expr_stmt|;
name|sense_data
operator|.
name|error_code
operator|=
name|SSD_CURRENT_ERROR
expr_stmt|;
name|sense_data
operator|.
name|flags
operator||=
name|SSD_KEY_ILLEGAL_REQUEST
expr_stmt|;
name|ccb
operator|->
name|csio
operator|.
name|sense_len
operator|=
sizeof|sizeof
argument_list|(
name|sense_data
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|&
name|sense_data
argument_list|,
operator|&
name|ccb
operator|->
name|csio
operator|.
name|sense_data
argument_list|,
name|ccb
operator|->
name|csio
operator|.
name|sense_len
argument_list|)
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_SCSI_STATUS_ERROR
operator||
name|CAM_AUTOSNS_VALID
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|CAM_DEBUG
argument_list|(
name|ccb
operator|->
name|ccb_h
operator|.
name|path
argument_list|,
name|CAM_DEBUG_TRACE
argument_list|,
operator|(
literal|"ATAPI command 0x%02x tag 0x%016lx submitted\n "
operator|,
name|cdb
index|[
literal|0
index|]
operator|,
name|xp
operator|->
name|x_tag
operator|)
argument_list|)
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|sc
operator|->
name|sc_active_xferq
argument_list|,
name|xp
argument_list|,
name|x_queue
argument_list|)
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator||=
name|CAM_SIM_QUEUED
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|ps3cdrom_decode_lv1_status
parameter_list|(
name|uint64_t
name|status
parameter_list|,
name|u_int8_t
modifier|*
name|sense_key
parameter_list|,
name|u_int8_t
modifier|*
name|asc
parameter_list|,
name|u_int8_t
modifier|*
name|ascq
parameter_list|)
block|{
if|if
condition|(
operator|(
operator|(
name|status
operator|>>
literal|24
operator|)
operator|&
literal|0xff
operator|)
operator|!=
name|SCSI_STATUS_CHECK_COND
condition|)
return|return
operator|-
literal|1
return|;
operator|*
name|sense_key
operator|=
operator|(
name|status
operator|>>
literal|16
operator|)
operator|&
literal|0xff
expr_stmt|;
operator|*
name|asc
operator|=
operator|(
name|status
operator|>>
literal|8
operator|)
operator|&
literal|0xff
expr_stmt|;
operator|*
name|ascq
operator|=
name|status
operator|&
literal|0xff
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|device_method_t
name|ps3cdrom_methods
index|[]
init|=
block|{
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|ps3cdrom_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|ps3cdrom_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|ps3cdrom_detach
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|ps3cdrom_driver
init|=
block|{
literal|"ps3cdrom"
block|,
name|ps3cdrom_methods
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|ps3cdrom_softc
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|ps3cdrom_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|ps3cdrom
argument_list|,
name|ps3bus
argument_list|,
name|ps3cdrom_driver
argument_list|,
name|ps3cdrom_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|ps3cdrom
argument_list|,
name|cam
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	$FreeBSD$ */
end_comment

begin_comment
comment|/*	$NetBSD: db_trace.c,v 1.20 2002/05/13 20:30:09 matt Exp $	*/
end_comment

begin_comment
comment|/*	$OpenBSD: db_trace.c,v 1.3 1997/03/21 02:10:48 niklas Exp $	*/
end_comment

begin_comment
comment|/*   * Mach Operating System  * Copyright (c) 1992 Carnegie Mellon University  * All Rights Reserved.  *   * Permission to use, copy, modify and distribute this software and its  * documentation is hereby granted, provided that both the copyright  * notice and this permission notice appear in all copies of the  * software, derivative works or modified versions, and any portions  * thereof, and that both notices appear in supporting documentation.  *   * CARNEGIE MELLON ALLOWS FREE USE OF THIS SOFTWARE IN ITS "AS IS"  * CONDITION.  CARNEGIE MELLON DISCLAIMS ANY LIABILITY OF ANY KIND FOR  * ANY DAMAGES WHATSOEVER RESULTING FROM THE USE OF THIS SOFTWARE.  *   * Carnegie Mellon requests users of this software to return to  *   *  Software Distribution Coordinator  or  Software.Distribution@CS.CMU.EDU  *  School of Computer Science  *  Carnegie Mellon University  *  Pittsburgh PA 15213-3890  *   * any improvements or extensions that they make and grant Carnegie Mellon   * the rights to redistribute these changes.  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/user.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm.h>
end_include

begin_include
include|#
directive|include
file|<vm/pmap.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm_extern.h>
end_include

begin_include
include|#
directive|include
file|<machine/db_machdep.h>
end_include

begin_include
include|#
directive|include
file|<machine/spr.h>
end_include

begin_include
include|#
directive|include
file|<machine/trap.h>
end_include

begin_include
include|#
directive|include
file|<ddb/ddb.h>
end_include

begin_include
include|#
directive|include
file|<ddb/db_access.h>
end_include

begin_include
include|#
directive|include
file|<ddb/db_sym.h>
end_include

begin_include
include|#
directive|include
file|<ddb/db_variables.h>
end_include

begin_decl_stmt
name|struct
name|db_variable
name|db_regs
index|[]
init|=
block|{
block|{
literal|"r0"
block|,
operator|(
name|long
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|r
index|[
literal|0
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r1"
block|,
operator|(
name|long
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|r
index|[
literal|1
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r2"
block|,
operator|(
name|long
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|r
index|[
literal|2
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r3"
block|,
operator|(
name|long
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|r
index|[
literal|3
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r4"
block|,
operator|(
name|long
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|r
index|[
literal|4
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r5"
block|,
operator|(
name|long
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|r
index|[
literal|5
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r6"
block|,
operator|(
name|long
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|r
index|[
literal|6
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r7"
block|,
operator|(
name|long
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|r
index|[
literal|7
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r8"
block|,
operator|(
name|long
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|r
index|[
literal|8
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r9"
block|,
operator|(
name|long
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|r
index|[
literal|9
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r10"
block|,
operator|(
name|long
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|r
index|[
literal|10
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r11"
block|,
operator|(
name|long
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|r
index|[
literal|11
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r12"
block|,
operator|(
name|long
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|r
index|[
literal|12
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r13"
block|,
operator|(
name|long
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|r
index|[
literal|13
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r14"
block|,
operator|(
name|long
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|r
index|[
literal|14
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r15"
block|,
operator|(
name|long
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|r
index|[
literal|15
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r16"
block|,
operator|(
name|long
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|r
index|[
literal|16
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r17"
block|,
operator|(
name|long
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|r
index|[
literal|17
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r18"
block|,
operator|(
name|long
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|r
index|[
literal|18
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r19"
block|,
operator|(
name|long
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|r
index|[
literal|19
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r20"
block|,
operator|(
name|long
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|r
index|[
literal|20
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r21"
block|,
operator|(
name|long
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|r
index|[
literal|21
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r22"
block|,
operator|(
name|long
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|r
index|[
literal|22
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r23"
block|,
operator|(
name|long
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|r
index|[
literal|23
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r24"
block|,
operator|(
name|long
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|r
index|[
literal|24
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r25"
block|,
operator|(
name|long
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|r
index|[
literal|25
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r26"
block|,
operator|(
name|long
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|r
index|[
literal|26
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r27"
block|,
operator|(
name|long
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|r
index|[
literal|27
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r28"
block|,
operator|(
name|long
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|r
index|[
literal|28
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r29"
block|,
operator|(
name|long
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|r
index|[
literal|29
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r30"
block|,
operator|(
name|long
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|r
index|[
literal|30
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r31"
block|,
operator|(
name|long
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|r
index|[
literal|31
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"iar"
block|,
operator|(
name|long
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|iar
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"msr"
block|,
operator|(
name|long
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|msr
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"lr"
block|,
operator|(
name|long
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|lr
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"ctr"
block|,
operator|(
name|long
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|ctr
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"cr"
block|,
operator|(
name|long
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|cr
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"xer"
block|,
operator|(
name|long
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|xer
block|,
name|FCN_NULL
block|}
block|,
ifdef|#
directive|ifdef
name|PPC_IBM4XX
block|{
literal|"dear"
block|,
operator|(
name|long
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|dear
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"esr"
block|,
operator|(
name|long
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|esr
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"pid"
block|,
operator|(
name|long
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|pid
block|,
name|FCN_NULL
block|}
block|,
endif|#
directive|endif
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|db_variable
modifier|*
name|db_eregs
init|=
name|db_regs
operator|+
sizeof|sizeof
argument_list|(
name|db_regs
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|db_regs
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|trapexit
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|end
index|[]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  *	Frame tracing.  */
end_comment

begin_function_decl
name|void
name|db_stack_trace_print
parameter_list|(
name|addr
parameter_list|,
name|have_addr
parameter_list|,
name|count
parameter_list|,
name|modif
parameter_list|,
name|pr
parameter_list|)
name|db_expr_t
name|addr
decl_stmt|;
name|int
name|have_addr
decl_stmt|;
name|db_expr_t
name|count
decl_stmt|;
name|char
modifier|*
name|modif
decl_stmt|;
function_decl|void
parameter_list|(
function_decl|*pr
end_function_decl

begin_expr_stmt
unit|)
name|__P
argument_list|(
operator|(
specifier|const
name|char
operator|*
operator|,
operator|...
operator|)
argument_list|)
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|db_addr_t
name|frame
decl_stmt|,
name|lr
decl_stmt|,
name|caller
decl_stmt|,
modifier|*
name|args
decl_stmt|;
name|db_addr_t
name|fakeframe
index|[
literal|2
index|]
decl_stmt|;
name|db_expr_t
name|diff
decl_stmt|;
name|db_sym_t
name|sym
decl_stmt|;
name|char
modifier|*
name|symname
decl_stmt|;
name|boolean_t
name|kernel_only
init|=
name|TRUE
decl_stmt|;
name|boolean_t
name|trace_thread
init|=
name|FALSE
decl_stmt|;
name|boolean_t
name|full
init|=
name|FALSE
decl_stmt|;
block|{
specifier|register
name|char
modifier|*
name|cp
init|=
name|modif
decl_stmt|;
specifier|register
name|char
name|c
decl_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
operator|*
name|cp
operator|++
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|c
operator|==
literal|'t'
condition|)
name|trace_thread
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|'u'
condition|)
name|kernel_only
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|'f'
condition|)
name|full
operator|=
name|TRUE
expr_stmt|;
block|}
block|}
if|if
condition|(
name|have_addr
condition|)
block|{
if|#
directive|if
literal|0
block|if (trace_thread) { 			struct proc *p; 			struct user *u;  			(*pr)("trace: pid %d ", (int)addr); 			p = pfind(addr); 			if (p == NULL) { 				(*pr)("not found\n"); 				return; 			}	 			if (!(p->p_flag&P_INMEM)) { 				(*pr)("swapped out\n"); 				return; 			} 			u = p->p_addr; 			frame = (db_addr_t)u->u_pcb.pcb_sp; 			(*pr)("at %p\n", frame); 		} else
endif|#
directive|endif
name|frame
operator|=
operator|(
name|db_addr_t
operator|)
name|addr
expr_stmt|;
block|}
else|else
block|{
name|frame
operator|=
operator|(
name|db_addr_t
operator|)
name|ddb_regs
operator|.
name|r
index|[
literal|1
index|]
expr_stmt|;
block|}
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|frame
operator|<
name|PAGE_SIZE
condition|)
break|break;
ifdef|#
directive|ifdef
name|PPC_MPC6XX
if|if
condition|(
name|kernel_only
operator|&&
operator|(
operator|(
name|frame
operator|>
operator|(
name|db_addr_t
operator|)
name|end
operator|&&
name|frame
operator|<
name|VM_MIN_KERNEL_ADDRESS
operator|)
operator|||
name|frame
operator|>=
name|VM_MAX_KERNEL_ADDRESS
operator|)
condition|)
break|break;
endif|#
directive|endif
name|frame
operator|=
operator|*
operator|(
name|db_addr_t
operator|*
operator|)
name|frame
expr_stmt|;
name|next_frame
label|:
name|args
operator|=
operator|(
name|db_addr_t
operator|*
operator|)
operator|(
name|frame
operator|+
literal|8
operator|)
expr_stmt|;
if|if
condition|(
name|frame
operator|<
name|PAGE_SIZE
condition|)
break|break;
ifdef|#
directive|ifdef
name|PPC_MPC6XX
if|if
condition|(
name|kernel_only
operator|&&
operator|(
operator|(
name|frame
operator|>
operator|(
name|db_addr_t
operator|)
name|end
operator|&&
name|frame
operator|<
name|VM_MIN_KERNEL_ADDRESS
operator|)
operator|||
name|frame
operator|>=
name|VM_MAX_KERNEL_ADDRESS
operator|)
condition|)
break|break;
endif|#
directive|endif
if|if
condition|(
name|count
operator|--
operator|==
literal|0
condition|)
break|break;
name|lr
operator|=
operator|*
operator|(
name|db_addr_t
operator|*
operator|)
operator|(
name|frame
operator|+
literal|4
operator|)
operator|-
literal|4
expr_stmt|;
if|if
condition|(
operator|(
name|lr
operator|&
literal|3
operator|)
operator|||
operator|(
name|lr
operator|<
literal|0x100
operator|)
condition|)
block|{
call|(
modifier|*
name|pr
call|)
argument_list|(
literal|"saved LR(0x%x) is invalid."
argument_list|,
name|lr
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|(
name|caller
operator|=
operator|(
name|db_addr_t
operator|)
name|vtophys
argument_list|(
name|lr
argument_list|)
operator|)
operator|==
literal|0
condition|)
name|caller
operator|=
name|lr
expr_stmt|;
if|if
condition|(
name|frame
operator|!=
operator|(
name|db_addr_t
operator|)
name|fakeframe
condition|)
block|{
call|(
modifier|*
name|pr
call|)
argument_list|(
literal|"0x%08lx: "
argument_list|,
name|frame
argument_list|)
expr_stmt|;
block|}
else|else
block|{
call|(
modifier|*
name|pr
call|)
argument_list|(
literal|"<?>  : "
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|caller
operator|+
literal|4
operator|==
operator|(
name|db_addr_t
operator|)
operator|&
name|trapexit
condition|)
block|{
specifier|const
name|char
modifier|*
name|trapstr
decl_stmt|;
name|struct
name|trapframe
modifier|*
name|tf
init|=
operator|(
expr|struct
name|trapframe
operator|*
operator|)
operator|(
name|frame
operator|+
literal|8
operator|)
decl_stmt|;
call|(
modifier|*
name|pr
call|)
argument_list|(
literal|"%s "
argument_list|,
name|tf
operator|->
name|srr1
operator|&
name|PSL_PR
condition|?
literal|"user"
else|:
literal|"kernel"
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|tf
operator|->
name|exc
condition|)
block|{
case|case
name|EXC_DSI
case|:
ifdef|#
directive|ifdef
name|PPC_MPC6XX
call|(
modifier|*
name|pr
call|)
argument_list|(
literal|"DSI %s trap @ %#x by "
argument_list|,
name|tf
operator|->
name|dsisr
operator|&
name|DSISR_STORE
condition|?
literal|"write"
else|:
literal|"read"
argument_list|,
name|tf
operator|->
name|dar
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|PPC_IBM4XX
call|(
modifier|*
name|pr
call|)
argument_list|(
literal|"DSI %s trap @ %#x by "
argument_list|,
name|tf
operator|->
name|esr
operator|&
name|ESR_DST
condition|?
literal|"write"
else|:
literal|"read"
argument_list|,
name|tf
operator|->
name|dear
argument_list|)
expr_stmt|;
endif|#
directive|endif
goto|goto
name|print_trap
goto|;
case|case
name|EXC_ISI
case|:
name|trapstr
operator|=
literal|"ISI"
expr_stmt|;
break|break;
case|case
name|EXC_PGM
case|:
name|trapstr
operator|=
literal|"PGM"
expr_stmt|;
break|break;
case|case
name|EXC_SC
case|:
name|trapstr
operator|=
literal|"SC"
expr_stmt|;
break|break;
case|case
name|EXC_EXI
case|:
name|trapstr
operator|=
literal|"EXI"
expr_stmt|;
break|break;
case|case
name|EXC_MCHK
case|:
name|trapstr
operator|=
literal|"MCHK"
expr_stmt|;
break|break;
case|case
name|EXC_VEC
case|:
name|trapstr
operator|=
literal|"VEC"
expr_stmt|;
break|break;
case|case
name|EXC_FPU
case|:
name|trapstr
operator|=
literal|"FPU"
expr_stmt|;
break|break;
case|case
name|EXC_FPA
case|:
name|trapstr
operator|=
literal|"FPA"
expr_stmt|;
break|break;
case|case
name|EXC_DECR
case|:
name|trapstr
operator|=
literal|"DECR"
expr_stmt|;
break|break;
case|case
name|EXC_ALI
case|:
name|trapstr
operator|=
literal|"ALI"
expr_stmt|;
break|break;
case|case
name|EXC_BPT
case|:
name|trapstr
operator|=
literal|"BPT"
expr_stmt|;
break|break;
case|case
name|EXC_TRC
case|:
name|trapstr
operator|=
literal|"TRC"
expr_stmt|;
break|break;
case|case
name|EXC_RUNMODETRC
case|:
name|trapstr
operator|=
literal|"RUNMODETRC"
expr_stmt|;
break|break;
case|case
name|EXC_PERF
case|:
name|trapstr
operator|=
literal|"PERF"
expr_stmt|;
break|break;
case|case
name|EXC_SMI
case|:
name|trapstr
operator|=
literal|"SMI"
expr_stmt|;
break|break;
case|case
name|EXC_RST
case|:
name|trapstr
operator|=
literal|"RST"
expr_stmt|;
break|break;
default|default:
name|trapstr
operator|=
name|NULL
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|trapstr
operator|!=
name|NULL
condition|)
block|{
call|(
modifier|*
name|pr
call|)
argument_list|(
literal|"%s trap by "
argument_list|,
name|trapstr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
call|(
modifier|*
name|pr
call|)
argument_list|(
literal|"trap %#x by "
argument_list|,
name|tf
operator|->
name|exc
argument_list|)
expr_stmt|;
block|}
name|print_trap
label|:
name|lr
operator|=
operator|(
name|db_addr_t
operator|)
name|tf
operator|->
name|srr0
expr_stmt|;
if|if
condition|(
operator|(
name|caller
operator|=
operator|(
name|db_addr_t
operator|)
name|vtophys
argument_list|(
name|lr
argument_list|)
operator|)
operator|==
literal|0
condition|)
name|caller
operator|=
name|lr
expr_stmt|;
name|diff
operator|=
literal|0
expr_stmt|;
name|symname
operator|=
name|NULL
expr_stmt|;
name|sym
operator|=
name|db_search_symbol
argument_list|(
name|caller
argument_list|,
name|DB_STGY_ANY
argument_list|,
operator|&
name|diff
argument_list|)
expr_stmt|;
name|db_symbol_values
argument_list|(
name|sym
argument_list|,
operator|&
name|symname
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|symname
operator|==
name|NULL
operator|||
operator|!
name|strcmp
argument_list|(
name|symname
argument_list|,
literal|"end"
argument_list|)
condition|)
block|{
call|(
modifier|*
name|pr
call|)
argument_list|(
literal|"%p: srr1=%#x\n"
argument_list|,
name|caller
argument_list|,
name|tf
operator|->
name|srr1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
call|(
modifier|*
name|pr
call|)
argument_list|(
literal|"%s+%x: srr1=%#x\n"
argument_list|,
name|symname
argument_list|,
name|diff
argument_list|,
name|tf
operator|->
name|srr1
argument_list|)
expr_stmt|;
block|}
call|(
modifier|*
name|pr
call|)
argument_list|(
literal|"%-10s  r1=%#x cr=%#x xer=%#x ctr=%#x"
argument_list|,
literal|""
argument_list|,
name|tf
operator|->
name|fixreg
index|[
literal|1
index|]
argument_list|,
name|tf
operator|->
name|cr
argument_list|,
name|tf
operator|->
name|xer
argument_list|,
name|tf
operator|->
name|ctr
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|PPC_MPC6XX
if|if
condition|(
name|tf
operator|->
name|exc
operator|==
name|EXC_DSI
condition|)
call|(
modifier|*
name|pr
call|)
argument_list|(
literal|" dsisr=%#x"
argument_list|,
name|tf
operator|->
name|dsisr
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|PPC_IBM4XX
if|if
condition|(
name|tf
operator|->
name|exc
operator|==
name|EXC_DSI
condition|)
call|(
modifier|*
name|pr
call|)
argument_list|(
literal|" dear=%#x"
argument_list|,
name|tf
operator|->
name|dear
argument_list|)
expr_stmt|;
call|(
modifier|*
name|pr
call|)
argument_list|(
literal|" esr=%#x pid=%#x"
argument_list|,
name|tf
operator|->
name|esr
argument_list|,
name|tf
operator|->
name|pid
argument_list|)
expr_stmt|;
endif|#
directive|endif
call|(
modifier|*
name|pr
call|)
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|fakeframe
index|[
literal|0
index|]
operator|=
operator|(
name|db_addr_t
operator|)
name|tf
operator|->
name|fixreg
index|[
literal|1
index|]
expr_stmt|;
name|fakeframe
index|[
literal|1
index|]
operator|=
operator|(
name|db_addr_t
operator|)
name|tf
operator|->
name|lr
expr_stmt|;
name|frame
operator|=
operator|(
name|db_addr_t
operator|)
name|fakeframe
expr_stmt|;
if|if
condition|(
name|kernel_only
operator|&&
operator|(
name|tf
operator|->
name|srr1
operator|&
name|PSL_PR
operator|)
condition|)
break|break;
goto|goto
name|next_frame
goto|;
block|}
name|diff
operator|=
literal|0
expr_stmt|;
name|symname
operator|=
name|NULL
expr_stmt|;
name|sym
operator|=
name|db_search_symbol
argument_list|(
name|caller
argument_list|,
name|DB_STGY_ANY
argument_list|,
operator|&
name|diff
argument_list|)
expr_stmt|;
name|db_symbol_values
argument_list|(
name|sym
argument_list|,
operator|&
name|symname
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|symname
operator|==
name|NULL
operator|||
operator|!
name|strcmp
argument_list|(
name|symname
argument_list|,
literal|"end"
argument_list|)
condition|)
call|(
modifier|*
name|pr
call|)
argument_list|(
literal|"at %p"
argument_list|,
name|caller
argument_list|)
expr_stmt|;
else|else
call|(
modifier|*
name|pr
call|)
argument_list|(
literal|"at %s+%#x"
argument_list|,
name|symname
argument_list|,
name|diff
argument_list|)
expr_stmt|;
if|if
condition|(
name|full
condition|)
comment|/* Print all the args stored in that stackframe. */
call|(
modifier|*
name|pr
call|)
argument_list|(
literal|"(%lx, %lx, %lx, %lx, %lx, %lx, %lx, %lx)"
argument_list|,
name|args
index|[
literal|0
index|]
argument_list|,
name|args
index|[
literal|1
index|]
argument_list|,
name|args
index|[
literal|2
index|]
argument_list|,
name|args
index|[
literal|3
index|]
argument_list|,
name|args
index|[
literal|4
index|]
argument_list|,
name|args
index|[
literal|5
index|]
argument_list|,
name|args
index|[
literal|6
index|]
argument_list|,
name|args
index|[
literal|7
index|]
argument_list|)
expr_stmt|;
call|(
modifier|*
name|pr
call|)
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_function
name|void
name|db_stack_trace_cmd
parameter_list|(
name|db_expr_t
name|addr
parameter_list|,
name|boolean_t
name|have_addr
parameter_list|,
name|db_expr_t
name|count
parameter_list|,
name|char
modifier|*
name|modif
parameter_list|)
block|{
name|db_stack_trace_print
argument_list|(
name|addr
argument_list|,
name|have_addr
argument_list|,
name|count
argument_list|,
name|modif
argument_list|,
name|db_printf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|db_print_backtrace
parameter_list|(
name|void
parameter_list|)
block|{ }
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright 2013 Nathan Whitehorn  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/selinfo.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_include
include|#
directive|include
file|<sys/eventhandler.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus_dma.h>
end_include

begin_include
include|#
directive|include
file|<sys/bio.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioccom.h>
end_include

begin_include
include|#
directive|include
file|<sys/uio.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/signalvar.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|<sys/vmem.h>
end_include

begin_include
include|#
directive|include
file|<cam/cam.h>
end_include

begin_include
include|#
directive|include
file|<cam/cam_ccb.h>
end_include

begin_include
include|#
directive|include
file|<cam/cam_debug.h>
end_include

begin_include
include|#
directive|include
file|<cam/cam_periph.h>
end_include

begin_include
include|#
directive|include
file|<cam/cam_sim.h>
end_include

begin_include
include|#
directive|include
file|<cam/cam_xpt_periph.h>
end_include

begin_include
include|#
directive|include
file|<cam/cam_xpt_sim.h>
end_include

begin_include
include|#
directive|include
file|<cam/scsi/scsi_all.h>
end_include

begin_include
include|#
directive|include
file|<cam/scsi/scsi_message.h>
end_include

begin_include
include|#
directive|include
file|<dev/ofw/openfirm.h>
end_include

begin_include
include|#
directive|include
file|<dev/ofw/ofw_bus.h>
end_include

begin_include
include|#
directive|include
file|<dev/ofw/ofw_bus_subr.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<powerpc/pseries/phyp-hvcall.h>
end_include

begin_struct_decl
struct_decl|struct
name|vscsi_softc
struct_decl|;
end_struct_decl

begin_comment
comment|/* VSCSI CRQ format from table 260 of PAPR spec 2.4 (page 760) */
end_comment

begin_struct
struct|struct
name|vscsi_crq
block|{
name|uint8_t
name|valid
decl_stmt|;
name|uint8_t
name|format
decl_stmt|;
name|uint8_t
name|reserved
decl_stmt|;
name|uint8_t
name|status
decl_stmt|;
name|uint16_t
name|timeout
decl_stmt|;
name|uint16_t
name|iu_length
decl_stmt|;
name|uint64_t
name|iu_data
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|vscsi_xfer
block|{
name|TAILQ_ENTRY
argument_list|(
argument|vscsi_xfer
argument_list|)
name|queue
expr_stmt|;
name|struct
name|vscsi_softc
modifier|*
name|sc
decl_stmt|;
name|union
name|ccb
modifier|*
name|ccb
decl_stmt|;
name|bus_dmamap_t
name|dmamap
decl_stmt|;
name|uint64_t
name|tag
decl_stmt|;
name|vmem_addr_t
name|srp_iu_offset
decl_stmt|;
name|vmem_size_t
name|srp_iu_size
decl_stmt|;
block|}
struct|;
end_struct

begin_expr_stmt
name|TAILQ_HEAD
argument_list|(
name|vscsi_xferq
argument_list|,
name|vscsi_xfer
argument_list|)
expr_stmt|;
end_expr_stmt

begin_struct
struct|struct
name|vscsi_softc
block|{
name|device_t
name|dev
decl_stmt|;
name|struct
name|cam_devq
modifier|*
name|devq
decl_stmt|;
name|struct
name|cam_sim
modifier|*
name|sim
decl_stmt|;
name|struct
name|cam_path
modifier|*
name|path
decl_stmt|;
name|struct
name|mtx
name|io_lock
decl_stmt|;
name|cell_t
name|unit
decl_stmt|;
name|int
name|bus_initialized
decl_stmt|;
name|int
name|bus_logged_in
decl_stmt|;
name|int
name|max_transactions
decl_stmt|;
name|int
name|irqid
decl_stmt|;
name|struct
name|resource
modifier|*
name|irq
decl_stmt|;
name|void
modifier|*
name|irq_cookie
decl_stmt|;
name|bus_dma_tag_t
name|crq_tag
decl_stmt|;
name|struct
name|vscsi_crq
modifier|*
name|crq_queue
decl_stmt|;
name|int
name|n_crqs
decl_stmt|,
name|cur_crq
decl_stmt|;
name|bus_dmamap_t
name|crq_map
decl_stmt|;
name|bus_addr_t
name|crq_phys
decl_stmt|;
name|vmem_t
modifier|*
name|srp_iu_arena
decl_stmt|;
name|void
modifier|*
name|srp_iu_queue
decl_stmt|;
name|bus_addr_t
name|srp_iu_phys
decl_stmt|;
name|bus_dma_tag_t
name|data_tag
decl_stmt|;
name|struct
name|vscsi_xfer
name|loginxp
decl_stmt|;
name|struct
name|vscsi_xfer
modifier|*
name|xfer
decl_stmt|;
name|struct
name|vscsi_xferq
name|active_xferq
decl_stmt|;
name|struct
name|vscsi_xferq
name|free_xferq
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|srp_login
block|{
name|uint8_t
name|type
decl_stmt|;
name|uint8_t
name|reserved
index|[
literal|7
index|]
decl_stmt|;
name|uint64_t
name|tag
decl_stmt|;
name|uint64_t
name|max_cmd_length
decl_stmt|;
name|uint32_t
name|reserved2
decl_stmt|;
name|uint16_t
name|buffer_formats
decl_stmt|;
name|uint8_t
name|flags
decl_stmt|;
name|uint8_t
name|reserved3
index|[
literal|5
index|]
decl_stmt|;
name|uint8_t
name|initiator_port_id
index|[
literal|16
index|]
decl_stmt|;
name|uint8_t
name|target_port_id
index|[
literal|16
index|]
decl_stmt|;
block|}
name|__packed
struct|;
end_struct

begin_struct
struct|struct
name|srp_login_rsp
block|{
name|uint8_t
name|type
decl_stmt|;
name|uint8_t
name|reserved
index|[
literal|3
index|]
decl_stmt|;
name|uint32_t
name|request_limit_delta
decl_stmt|;
name|uint8_t
name|tag
decl_stmt|;
name|uint32_t
name|max_i_to_t_len
decl_stmt|;
name|uint32_t
name|max_t_to_i_len
decl_stmt|;
name|uint16_t
name|buffer_formats
decl_stmt|;
name|uint8_t
name|flags
decl_stmt|;
comment|/* Some reserved bits follow */
block|}
name|__packed
struct|;
end_struct

begin_struct
struct|struct
name|srp_cmd
block|{
name|uint8_t
name|type
decl_stmt|;
name|uint8_t
name|flags1
decl_stmt|;
name|uint8_t
name|reserved
index|[
literal|3
index|]
decl_stmt|;
name|uint8_t
name|formats
decl_stmt|;
name|uint8_t
name|out_buffer_count
decl_stmt|;
name|uint8_t
name|in_buffer_count
decl_stmt|;
name|uint64_t
name|tag
decl_stmt|;
name|uint32_t
name|reserved2
decl_stmt|;
name|uint64_t
name|lun
decl_stmt|;
name|uint8_t
name|reserved3
index|[
literal|3
index|]
decl_stmt|;
name|uint8_t
name|additional_cdb
decl_stmt|;
name|uint8_t
name|cdb
index|[
literal|16
index|]
decl_stmt|;
name|uint8_t
name|data_payload
index|[
literal|0
index|]
decl_stmt|;
block|}
name|__packed
struct|;
end_struct

begin_struct
struct|struct
name|srp_rsp
block|{
name|uint8_t
name|type
decl_stmt|;
name|uint8_t
name|reserved
index|[
literal|3
index|]
decl_stmt|;
name|uint32_t
name|request_limit_delta
decl_stmt|;
name|uint64_t
name|tag
decl_stmt|;
name|uint16_t
name|reserved2
decl_stmt|;
name|uint8_t
name|flags
decl_stmt|;
name|uint8_t
name|status
decl_stmt|;
name|uint32_t
name|data_out_resid
decl_stmt|;
name|uint32_t
name|data_in_resid
decl_stmt|;
name|uint32_t
name|sense_data_len
decl_stmt|;
name|uint32_t
name|response_data_len
decl_stmt|;
name|uint8_t
name|data_payload
index|[
literal|0
index|]
decl_stmt|;
block|}
name|__packed
struct|;
end_struct

begin_struct
struct|struct
name|srp_tsk_mgmt
block|{
name|uint8_t
name|type
decl_stmt|;
name|uint8_t
name|reserved
index|[
literal|7
index|]
decl_stmt|;
name|uint64_t
name|tag
decl_stmt|;
name|uint32_t
name|reserved2
decl_stmt|;
name|uint64_t
name|lun
decl_stmt|;
name|uint8_t
name|reserved3
index|[
literal|2
index|]
decl_stmt|;
name|uint8_t
name|function
decl_stmt|;
name|uint8_t
name|reserved4
decl_stmt|;
name|uint64_t
name|manage_tag
decl_stmt|;
name|uint64_t
name|reserved5
decl_stmt|;
block|}
name|__packed
struct|;
end_struct

begin_comment
comment|/* Message code type */
end_comment

begin_define
define|#
directive|define
name|SRP_LOGIN_REQ
value|0x00
end_define

begin_define
define|#
directive|define
name|SRP_TSK_MGMT
value|0x01
end_define

begin_define
define|#
directive|define
name|SRP_CMD
value|0x02
end_define

begin_define
define|#
directive|define
name|SRP_I_LOGOUT
value|0x03
end_define

begin_define
define|#
directive|define
name|SRP_LOGIN_RSP
value|0xC0
end_define

begin_define
define|#
directive|define
name|SRP_RSP
value|0xC1
end_define

begin_define
define|#
directive|define
name|SRP_LOGIN_REJ
value|0xC2
end_define

begin_define
define|#
directive|define
name|SRP_T_LOGOUT
value|0x80
end_define

begin_define
define|#
directive|define
name|SRP_CRED_REQ
value|0x81
end_define

begin_define
define|#
directive|define
name|SRP_AER_REQ
value|0x82
end_define

begin_define
define|#
directive|define
name|SRP_CRED_RSP
value|0x41
end_define

begin_define
define|#
directive|define
name|SRP_AER_RSP
value|0x41
end_define

begin_comment
comment|/* Flags for srp_rsp flags field */
end_comment

begin_define
define|#
directive|define
name|SRP_RSPVALID
value|0x01
end_define

begin_define
define|#
directive|define
name|SRP_SNSVALID
value|0x02
end_define

begin_define
define|#
directive|define
name|SRP_DOOVER
value|0x04
end_define

begin_define
define|#
directive|define
name|SRP_DOUNDER
value|0x08
end_define

begin_define
define|#
directive|define
name|SRP_DIOVER
value|0x10
end_define

begin_define
define|#
directive|define
name|SRP_DIUNDER
value|0x20
end_define

begin_define
define|#
directive|define
name|MAD_SUCESS
value|0x00
end_define

begin_define
define|#
directive|define
name|MAD_NOT_SUPPORTED
value|0xf1
end_define

begin_define
define|#
directive|define
name|MAD_FAILED
value|0xf7
end_define

begin_define
define|#
directive|define
name|MAD_EMPTY_IU
value|0x01
end_define

begin_define
define|#
directive|define
name|MAD_ERROR_LOGGING_REQUEST
value|0x02
end_define

begin_define
define|#
directive|define
name|MAD_ADAPTER_INFO_REQUEST
value|0x03
end_define

begin_define
define|#
directive|define
name|MAD_CAPABILITIES_EXCHANGE
value|0x05
end_define

begin_define
define|#
directive|define
name|MAD_PHYS_ADAP_INFO_REQUEST
value|0x06
end_define

begin_define
define|#
directive|define
name|MAD_TAPE_PASSTHROUGH_REQUEST
value|0x07
end_define

begin_define
define|#
directive|define
name|MAD_ENABLE_FAST_FAIL
value|0x08
end_define

begin_function_decl
specifier|static
name|int
name|vscsi_probe
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vscsi_attach
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vscsi_detach
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vscsi_cam_action
parameter_list|(
name|struct
name|cam_sim
modifier|*
parameter_list|,
name|union
name|ccb
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vscsi_cam_poll
parameter_list|(
name|struct
name|cam_sim
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vscsi_intr
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vscsi_check_response_queue
parameter_list|(
name|struct
name|vscsi_softc
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vscsi_setup_bus
parameter_list|(
name|struct
name|vscsi_softc
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vscsi_srp_login
parameter_list|(
name|struct
name|vscsi_softc
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vscsi_crq_load_cb
parameter_list|(
name|void
modifier|*
parameter_list|,
name|bus_dma_segment_t
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vscsi_scsi_command
parameter_list|(
name|void
modifier|*
name|xxp
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|segs
parameter_list|,
name|int
name|nsegs
parameter_list|,
name|int
name|err
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vscsi_task_management
parameter_list|(
name|struct
name|vscsi_softc
modifier|*
name|sc
parameter_list|,
name|union
name|ccb
modifier|*
name|ccb
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vscsi_srp_response
parameter_list|(
name|struct
name|vscsi_xfer
modifier|*
parameter_list|,
name|struct
name|vscsi_crq
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|devclass_t
name|vscsi_devclass
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|device_method_t
name|vscsi_methods
index|[]
init|=
block|{
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|vscsi_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|vscsi_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|vscsi_detach
argument_list|)
block|,
name|DEVMETHOD_END
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|vscsi_driver
init|=
block|{
literal|"vscsi"
block|,
name|vscsi_methods
block|,
expr|sizeof
operator|(
expr|struct
name|vscsi_softc
operator|)
block|}
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|vscsi
argument_list|,
name|vdevice
argument_list|,
name|vscsi_driver
argument_list|,
name|vscsi_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MALLOC_DEFINE
argument_list|(
name|M_VSCSI
argument_list|,
literal|"vscsi"
argument_list|,
literal|"CAM device queue for VSCSI"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|int
name|vscsi_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
if|if
condition|(
operator|!
name|ofw_bus_is_compatible
argument_list|(
name|dev
argument_list|,
literal|"IBM,v-scsi"
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"POWER Hypervisor Virtual SCSI Bus"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vscsi_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|vscsi_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|vscsi_xfer
modifier|*
name|xp
decl_stmt|;
name|int
name|error
decl_stmt|,
name|i
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|==
name|NULL
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|sc
operator|->
name|dev
operator|=
name|dev
expr_stmt|;
name|mtx_init
argument_list|(
operator|&
name|sc
operator|->
name|io_lock
argument_list|,
literal|"vscsi"
argument_list|,
name|NULL
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
comment|/* Get properties */
name|OF_getprop
argument_list|(
name|ofw_bus_get_node
argument_list|(
name|dev
argument_list|)
argument_list|,
literal|"reg"
argument_list|,
operator|&
name|sc
operator|->
name|unit
argument_list|,
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|unit
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Setup interrupt */
name|sc
operator|->
name|irqid
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|irq
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
operator|&
name|sc
operator|->
name|irqid
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sc
operator|->
name|irq
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Could not allocate IRQ\n"
argument_list|)
expr_stmt|;
name|mtx_destroy
argument_list|(
operator|&
name|sc
operator|->
name|io_lock
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|bus_setup_intr
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|irq
argument_list|,
name|INTR_TYPE_CAM
operator||
name|INTR_MPSAFE
operator||
name|INTR_ENTROPY
argument_list|,
name|NULL
argument_list|,
name|vscsi_intr
argument_list|,
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|irq_cookie
argument_list|)
expr_stmt|;
comment|/* Data DMA */
name|error
operator|=
name|bus_dma_tag_create
argument_list|(
name|bus_get_dma_tag
argument_list|(
name|dev
argument_list|)
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
name|BUS_SPACE_MAXADDR
argument_list|,
name|BUS_SPACE_MAXADDR
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|BUS_SPACE_MAXSIZE
argument_list|,
literal|256
argument_list|,
name|BUS_SPACE_MAXSIZE_32BIT
argument_list|,
literal|0
argument_list|,
name|busdma_lock_mutex
argument_list|,
operator|&
name|sc
operator|->
name|io_lock
argument_list|,
operator|&
name|sc
operator|->
name|data_tag
argument_list|)
expr_stmt|;
name|TAILQ_INIT
argument_list|(
operator|&
name|sc
operator|->
name|active_xferq
argument_list|)
expr_stmt|;
name|TAILQ_INIT
argument_list|(
operator|&
name|sc
operator|->
name|free_xferq
argument_list|)
expr_stmt|;
comment|/* First XFER for login data */
name|sc
operator|->
name|loginxp
operator|.
name|sc
operator|=
name|sc
expr_stmt|;
name|bus_dmamap_create
argument_list|(
name|sc
operator|->
name|data_tag
argument_list|,
literal|0
argument_list|,
operator|&
name|sc
operator|->
name|loginxp
operator|.
name|dmamap
argument_list|)
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|sc
operator|->
name|free_xferq
argument_list|,
operator|&
name|sc
operator|->
name|loginxp
argument_list|,
name|queue
argument_list|)
expr_stmt|;
comment|/* CRQ area */
name|error
operator|=
name|bus_dma_tag_create
argument_list|(
name|bus_get_dma_tag
argument_list|(
name|dev
argument_list|)
argument_list|,
name|PAGE_SIZE
argument_list|,
literal|0
argument_list|,
name|BUS_SPACE_MAXADDR
argument_list|,
name|BUS_SPACE_MAXADDR
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|8
operator|*
name|PAGE_SIZE
argument_list|,
literal|1
argument_list|,
name|BUS_SPACE_MAXSIZE
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|sc
operator|->
name|crq_tag
argument_list|)
expr_stmt|;
name|error
operator|=
name|bus_dmamem_alloc
argument_list|(
name|sc
operator|->
name|crq_tag
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|sc
operator|->
name|crq_queue
argument_list|,
name|BUS_DMA_WAITOK
operator||
name|BUS_DMA_ZERO
argument_list|,
operator|&
name|sc
operator|->
name|crq_map
argument_list|)
expr_stmt|;
name|sc
operator|->
name|crq_phys
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|n_crqs
operator|=
literal|0
expr_stmt|;
name|error
operator|=
name|bus_dmamap_load
argument_list|(
name|sc
operator|->
name|crq_tag
argument_list|,
name|sc
operator|->
name|crq_map
argument_list|,
name|sc
operator|->
name|crq_queue
argument_list|,
literal|8
operator|*
name|PAGE_SIZE
argument_list|,
name|vscsi_crq_load_cb
argument_list|,
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|sc
operator|->
name|io_lock
argument_list|)
expr_stmt|;
name|vscsi_setup_bus
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|xfer
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|xfer
index|[
literal|0
index|]
argument_list|)
operator|*
name|sc
operator|->
name|max_transactions
argument_list|,
name|M_VSCSI
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|max_transactions
condition|;
name|i
operator|++
control|)
block|{
name|xp
operator|=
operator|&
name|sc
operator|->
name|xfer
index|[
name|i
index|]
expr_stmt|;
name|xp
operator|->
name|sc
operator|=
name|sc
expr_stmt|;
name|error
operator|=
name|bus_dmamap_create
argument_list|(
name|sc
operator|->
name|data_tag
argument_list|,
literal|0
argument_list|,
operator|&
name|xp
operator|->
name|dmamap
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Could not create DMA map (%d)\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
break|break;
block|}
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|sc
operator|->
name|free_xferq
argument_list|,
name|xp
argument_list|,
name|queue
argument_list|)
expr_stmt|;
block|}
name|mtx_unlock
argument_list|(
operator|&
name|sc
operator|->
name|io_lock
argument_list|)
expr_stmt|;
comment|/* Allocate CAM bits */
if|if
condition|(
operator|(
name|sc
operator|->
name|devq
operator|=
name|cam_simq_alloc
argument_list|(
name|sc
operator|->
name|max_transactions
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
name|sc
operator|->
name|sim
operator|=
name|cam_sim_alloc
argument_list|(
name|vscsi_cam_action
argument_list|,
name|vscsi_cam_poll
argument_list|,
literal|"vscsi"
argument_list|,
name|sc
argument_list|,
name|device_get_unit
argument_list|(
name|dev
argument_list|)
argument_list|,
operator|&
name|sc
operator|->
name|io_lock
argument_list|,
name|sc
operator|->
name|max_transactions
argument_list|,
name|sc
operator|->
name|max_transactions
argument_list|,
name|sc
operator|->
name|devq
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sim
operator|==
name|NULL
condition|)
block|{
name|cam_simq_free
argument_list|(
name|sc
operator|->
name|devq
argument_list|)
expr_stmt|;
name|sc
operator|->
name|devq
operator|=
name|NULL
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"CAM SIM attach failed\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
name|mtx_lock
argument_list|(
operator|&
name|sc
operator|->
name|io_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|xpt_bus_register
argument_list|(
name|sc
operator|->
name|sim
argument_list|,
name|dev
argument_list|,
literal|0
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"XPT bus registration failed\n"
argument_list|)
expr_stmt|;
name|cam_sim_free
argument_list|(
name|sc
operator|->
name|sim
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sim
operator|=
name|NULL
expr_stmt|;
name|cam_simq_free
argument_list|(
name|sc
operator|->
name|devq
argument_list|)
expr_stmt|;
name|sc
operator|->
name|devq
operator|=
name|NULL
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|sc
operator|->
name|io_lock
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
name|mtx_unlock
argument_list|(
operator|&
name|sc
operator|->
name|io_lock
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vscsi_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|vscsi_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|==
name|NULL
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
name|sc
operator|->
name|sim
operator|!=
name|NULL
condition|)
block|{
name|mtx_lock
argument_list|(
operator|&
name|sc
operator|->
name|io_lock
argument_list|)
expr_stmt|;
name|xpt_bus_deregister
argument_list|(
name|cam_sim_path
argument_list|(
name|sc
operator|->
name|sim
argument_list|)
argument_list|)
expr_stmt|;
name|cam_sim_free
argument_list|(
name|sc
operator|->
name|sim
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sim
operator|=
name|NULL
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|sc
operator|->
name|io_lock
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|devq
operator|!=
name|NULL
condition|)
block|{
name|cam_simq_free
argument_list|(
name|sc
operator|->
name|devq
argument_list|)
expr_stmt|;
name|sc
operator|->
name|devq
operator|=
name|NULL
expr_stmt|;
block|}
name|mtx_destroy
argument_list|(
operator|&
name|sc
operator|->
name|io_lock
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vscsi_cam_action
parameter_list|(
name|struct
name|cam_sim
modifier|*
name|sim
parameter_list|,
name|union
name|ccb
modifier|*
name|ccb
parameter_list|)
block|{
name|struct
name|vscsi_softc
modifier|*
name|sc
init|=
name|cam_sim_softc
argument_list|(
name|sim
argument_list|)
decl_stmt|;
name|mtx_assert
argument_list|(
operator|&
name|sc
operator|->
name|io_lock
argument_list|,
name|MA_OWNED
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ccb
operator|->
name|ccb_h
operator|.
name|func_code
condition|)
block|{
case|case
name|XPT_PATH_INQ
case|:
block|{
name|struct
name|ccb_pathinq
modifier|*
name|cpi
init|=
operator|&
name|ccb
operator|->
name|cpi
decl_stmt|;
name|cpi
operator|->
name|version_num
operator|=
literal|1
expr_stmt|;
name|cpi
operator|->
name|hba_inquiry
operator|=
name|PI_TAG_ABLE
expr_stmt|;
name|cpi
operator|->
name|hba_misc
operator|=
name|PIM_EXTLUNS
expr_stmt|;
name|cpi
operator|->
name|target_sprt
operator|=
literal|0
expr_stmt|;
name|cpi
operator|->
name|hba_eng_cnt
operator|=
literal|0
expr_stmt|;
name|cpi
operator|->
name|max_target
operator|=
literal|0
expr_stmt|;
name|cpi
operator|->
name|max_lun
operator|=
literal|0
expr_stmt|;
name|cpi
operator|->
name|initiator_id
operator|=
operator|~
literal|0
expr_stmt|;
name|strncpy
argument_list|(
name|cpi
operator|->
name|sim_vid
argument_list|,
literal|"FreeBSD"
argument_list|,
name|SIM_IDLEN
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|cpi
operator|->
name|hba_vid
argument_list|,
literal|"IBM"
argument_list|,
name|HBA_IDLEN
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|cpi
operator|->
name|dev_name
argument_list|,
name|cam_sim_name
argument_list|(
name|sim
argument_list|)
argument_list|,
name|DEV_IDLEN
argument_list|)
expr_stmt|;
name|cpi
operator|->
name|unit_number
operator|=
name|cam_sim_unit
argument_list|(
name|sim
argument_list|)
expr_stmt|;
name|cpi
operator|->
name|bus_id
operator|=
name|cam_sim_bus
argument_list|(
name|sim
argument_list|)
expr_stmt|;
name|cpi
operator|->
name|base_transfer_speed
operator|=
literal|150000
expr_stmt|;
name|cpi
operator|->
name|transport
operator|=
name|XPORT_SRP
expr_stmt|;
name|cpi
operator|->
name|transport_version
operator|=
literal|0
expr_stmt|;
name|cpi
operator|->
name|protocol
operator|=
name|PROTO_SCSI
expr_stmt|;
name|cpi
operator|->
name|protocol_version
operator|=
name|SCSI_REV_SPC4
expr_stmt|;
name|cpi
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_CMP
expr_stmt|;
break|break;
block|}
case|case
name|XPT_RESET_BUS
case|:
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_CMP
expr_stmt|;
break|break;
case|case
name|XPT_RESET_DEV
case|:
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_INPROG
expr_stmt|;
name|vscsi_task_management
argument_list|(
name|sc
argument_list|,
name|ccb
argument_list|)
expr_stmt|;
return|return;
case|case
name|XPT_GET_TRAN_SETTINGS
case|:
name|ccb
operator|->
name|cts
operator|.
name|protocol
operator|=
name|PROTO_SCSI
expr_stmt|;
name|ccb
operator|->
name|cts
operator|.
name|protocol_version
operator|=
name|SCSI_REV_SPC4
expr_stmt|;
name|ccb
operator|->
name|cts
operator|.
name|transport
operator|=
name|XPORT_SRP
expr_stmt|;
name|ccb
operator|->
name|cts
operator|.
name|transport_version
operator|=
literal|0
expr_stmt|;
name|ccb
operator|->
name|cts
operator|.
name|proto_specific
operator|.
name|valid
operator|=
literal|0
expr_stmt|;
name|ccb
operator|->
name|cts
operator|.
name|xport_specific
operator|.
name|valid
operator|=
literal|0
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_CMP
expr_stmt|;
break|break;
case|case
name|XPT_SET_TRAN_SETTINGS
case|:
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_FUNC_NOTAVAIL
expr_stmt|;
break|break;
case|case
name|XPT_SCSI_IO
case|:
block|{
name|struct
name|vscsi_xfer
modifier|*
name|xp
decl_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_INPROG
expr_stmt|;
name|xp
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|sc
operator|->
name|free_xferq
argument_list|)
expr_stmt|;
if|if
condition|(
name|xp
operator|==
name|NULL
condition|)
name|panic
argument_list|(
literal|"SCSI queue flooded"
argument_list|)
expr_stmt|;
name|xp
operator|->
name|ccb
operator|=
name|ccb
expr_stmt|;
name|TAILQ_REMOVE
argument_list|(
operator|&
name|sc
operator|->
name|free_xferq
argument_list|,
name|xp
argument_list|,
name|queue
argument_list|)
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|sc
operator|->
name|active_xferq
argument_list|,
name|xp
argument_list|,
name|queue
argument_list|)
expr_stmt|;
name|bus_dmamap_load_ccb
argument_list|(
name|sc
operator|->
name|data_tag
argument_list|,
name|xp
operator|->
name|dmamap
argument_list|,
name|ccb
argument_list|,
name|vscsi_scsi_command
argument_list|,
name|xp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
default|default:
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_INVALID
expr_stmt|;
break|break;
block|}
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|vscsi_srp_login
parameter_list|(
name|struct
name|vscsi_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|vscsi_xfer
modifier|*
name|xp
decl_stmt|;
name|struct
name|srp_login
modifier|*
name|login
decl_stmt|;
name|struct
name|vscsi_crq
name|crq
decl_stmt|;
name|int
name|err
decl_stmt|;
name|mtx_assert
argument_list|(
operator|&
name|sc
operator|->
name|io_lock
argument_list|,
name|MA_OWNED
argument_list|)
expr_stmt|;
name|xp
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|sc
operator|->
name|free_xferq
argument_list|)
expr_stmt|;
if|if
condition|(
name|xp
operator|==
name|NULL
condition|)
name|panic
argument_list|(
literal|"SCSI queue flooded"
argument_list|)
expr_stmt|;
name|xp
operator|->
name|ccb
operator|=
name|NULL
expr_stmt|;
name|TAILQ_REMOVE
argument_list|(
operator|&
name|sc
operator|->
name|free_xferq
argument_list|,
name|xp
argument_list|,
name|queue
argument_list|)
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|sc
operator|->
name|active_xferq
argument_list|,
name|xp
argument_list|,
name|queue
argument_list|)
expr_stmt|;
comment|/* Set up command */
name|xp
operator|->
name|srp_iu_size
operator|=
name|crq
operator|.
name|iu_length
operator|=
literal|64
expr_stmt|;
name|err
operator|=
name|vmem_alloc
argument_list|(
name|xp
operator|->
name|sc
operator|->
name|srp_iu_arena
argument_list|,
name|xp
operator|->
name|srp_iu_size
argument_list|,
name|M_BESTFIT
operator||
name|M_NOWAIT
argument_list|,
operator|&
name|xp
operator|->
name|srp_iu_offset
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|panic
argument_list|(
literal|"Error during VMEM allocation (%d)"
argument_list|,
name|err
argument_list|)
expr_stmt|;
name|login
operator|=
operator|(
expr|struct
name|srp_login
operator|*
operator|)
operator|(
operator|(
name|uint8_t
operator|*
operator|)
name|xp
operator|->
name|sc
operator|->
name|srp_iu_queue
operator|+
operator|(
name|uintptr_t
operator|)
name|xp
operator|->
name|srp_iu_offset
operator|)
expr_stmt|;
name|bzero
argument_list|(
name|login
argument_list|,
name|xp
operator|->
name|srp_iu_size
argument_list|)
expr_stmt|;
name|login
operator|->
name|type
operator|=
name|SRP_LOGIN_REQ
expr_stmt|;
name|login
operator|->
name|tag
operator|=
call|(
name|uint64_t
call|)
argument_list|(
name|xp
argument_list|)
expr_stmt|;
name|login
operator|->
name|max_cmd_length
operator|=
name|htobe64
argument_list|(
literal|256
argument_list|)
expr_stmt|;
name|login
operator|->
name|buffer_formats
operator|=
name|htobe16
argument_list|(
literal|0x1
operator||
literal|0x2
argument_list|)
expr_stmt|;
comment|/* Direct and indirect */
name|login
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
comment|/* Create CRQ entry */
name|crq
operator|.
name|valid
operator|=
literal|0x80
expr_stmt|;
name|crq
operator|.
name|format
operator|=
literal|0x01
expr_stmt|;
name|crq
operator|.
name|iu_data
operator|=
name|xp
operator|->
name|sc
operator|->
name|srp_iu_phys
operator|+
name|xp
operator|->
name|srp_iu_offset
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|crq_tag
argument_list|,
name|sc
operator|->
name|crq_map
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
name|err
operator|=
name|phyp_hcall
argument_list|(
name|H_SEND_CRQ
argument_list|,
name|xp
operator|->
name|sc
operator|->
name|unit
argument_list|,
operator|(
operator|(
name|uint64_t
operator|*
operator|)
operator|(
operator|&
name|crq
operator|)
operator|)
index|[
literal|0
index|]
argument_list|,
operator|(
operator|(
name|uint64_t
operator|*
operator|)
operator|(
operator|&
name|crq
operator|)
operator|)
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
name|panic
argument_list|(
literal|"CRQ send failure (%d)"
argument_list|,
name|err
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vscsi_task_management
parameter_list|(
name|struct
name|vscsi_softc
modifier|*
name|sc
parameter_list|,
name|union
name|ccb
modifier|*
name|ccb
parameter_list|)
block|{
name|struct
name|srp_tsk_mgmt
modifier|*
name|cmd
decl_stmt|;
name|struct
name|vscsi_xfer
modifier|*
name|xp
decl_stmt|;
name|struct
name|vscsi_crq
name|crq
decl_stmt|;
name|int
name|err
decl_stmt|;
name|mtx_assert
argument_list|(
operator|&
name|sc
operator|->
name|io_lock
argument_list|,
name|MA_OWNED
argument_list|)
expr_stmt|;
name|xp
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|sc
operator|->
name|free_xferq
argument_list|)
expr_stmt|;
if|if
condition|(
name|xp
operator|==
name|NULL
condition|)
name|panic
argument_list|(
literal|"SCSI queue flooded"
argument_list|)
expr_stmt|;
name|xp
operator|->
name|ccb
operator|=
name|ccb
expr_stmt|;
name|TAILQ_REMOVE
argument_list|(
operator|&
name|sc
operator|->
name|free_xferq
argument_list|,
name|xp
argument_list|,
name|queue
argument_list|)
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|sc
operator|->
name|active_xferq
argument_list|,
name|xp
argument_list|,
name|queue
argument_list|)
expr_stmt|;
name|xp
operator|->
name|srp_iu_size
operator|=
name|crq
operator|.
name|iu_length
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|cmd
argument_list|)
expr_stmt|;
name|err
operator|=
name|vmem_alloc
argument_list|(
name|xp
operator|->
name|sc
operator|->
name|srp_iu_arena
argument_list|,
name|xp
operator|->
name|srp_iu_size
argument_list|,
name|M_BESTFIT
operator||
name|M_NOWAIT
argument_list|,
operator|&
name|xp
operator|->
name|srp_iu_offset
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|panic
argument_list|(
literal|"Error during VMEM allocation (%d)"
argument_list|,
name|err
argument_list|)
expr_stmt|;
name|cmd
operator|=
operator|(
expr|struct
name|srp_tsk_mgmt
operator|*
operator|)
operator|(
operator|(
name|uint8_t
operator|*
operator|)
name|xp
operator|->
name|sc
operator|->
name|srp_iu_queue
operator|+
operator|(
name|uintptr_t
operator|)
name|xp
operator|->
name|srp_iu_offset
operator|)
expr_stmt|;
name|bzero
argument_list|(
name|cmd
argument_list|,
name|xp
operator|->
name|srp_iu_size
argument_list|)
expr_stmt|;
name|cmd
operator|->
name|type
operator|=
name|SRP_TSK_MGMT
expr_stmt|;
name|cmd
operator|->
name|tag
operator|=
operator|(
name|uint64_t
operator|)
name|xp
expr_stmt|;
name|cmd
operator|->
name|lun
operator|=
name|htobe64
argument_list|(
name|CAM_EXTLUN_BYTE_SWIZZLE
argument_list|(
name|ccb
operator|->
name|ccb_h
operator|.
name|target_lun
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ccb
operator|->
name|ccb_h
operator|.
name|func_code
condition|)
block|{
case|case
name|XPT_RESET_DEV
case|:
name|cmd
operator|->
name|function
operator|=
literal|0x08
expr_stmt|;
break|break;
default|default:
name|panic
argument_list|(
literal|"Unimplemented code %d"
argument_list|,
name|ccb
operator|->
name|ccb_h
operator|.
name|func_code
argument_list|)
expr_stmt|;
break|break;
block|}
name|bus_dmamap_sync
argument_list|(
name|xp
operator|->
name|sc
operator|->
name|crq_tag
argument_list|,
name|xp
operator|->
name|sc
operator|->
name|crq_map
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
comment|/* Create CRQ entry */
name|crq
operator|.
name|valid
operator|=
literal|0x80
expr_stmt|;
name|crq
operator|.
name|format
operator|=
literal|0x01
expr_stmt|;
name|crq
operator|.
name|iu_data
operator|=
name|xp
operator|->
name|sc
operator|->
name|srp_iu_phys
operator|+
name|xp
operator|->
name|srp_iu_offset
expr_stmt|;
name|err
operator|=
name|phyp_hcall
argument_list|(
name|H_SEND_CRQ
argument_list|,
name|xp
operator|->
name|sc
operator|->
name|unit
argument_list|,
operator|(
operator|(
name|uint64_t
operator|*
operator|)
operator|(
operator|&
name|crq
operator|)
operator|)
index|[
literal|0
index|]
argument_list|,
operator|(
operator|(
name|uint64_t
operator|*
operator|)
operator|(
operator|&
name|crq
operator|)
operator|)
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
name|panic
argument_list|(
literal|"CRQ send failure (%d)"
argument_list|,
name|err
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vscsi_scsi_command
parameter_list|(
name|void
modifier|*
name|xxp
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|segs
parameter_list|,
name|int
name|nsegs
parameter_list|,
name|int
name|err
parameter_list|)
block|{
name|struct
name|vscsi_xfer
modifier|*
name|xp
init|=
name|xxp
decl_stmt|;
name|uint8_t
modifier|*
name|cdb
decl_stmt|;
name|union
name|ccb
modifier|*
name|ccb
init|=
name|xp
operator|->
name|ccb
decl_stmt|;
name|struct
name|srp_cmd
modifier|*
name|cmd
decl_stmt|;
name|uint64_t
name|chunk_addr
decl_stmt|;
name|uint32_t
name|chunk_size
decl_stmt|;
name|int
name|desc_start
decl_stmt|,
name|i
decl_stmt|;
name|struct
name|vscsi_crq
name|crq
decl_stmt|;
name|KASSERT
argument_list|(
name|err
operator|==
literal|0
argument_list|,
operator|(
literal|"DMA error %d\n"
operator|,
name|err
operator|)
argument_list|)
expr_stmt|;
name|mtx_assert
argument_list|(
operator|&
name|xp
operator|->
name|sc
operator|->
name|io_lock
argument_list|,
name|MA_OWNED
argument_list|)
expr_stmt|;
name|cdb
operator|=
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_CDB_POINTER
operator|)
condition|?
name|ccb
operator|->
name|csio
operator|.
name|cdb_io
operator|.
name|cdb_ptr
else|:
name|ccb
operator|->
name|csio
operator|.
name|cdb_io
operator|.
name|cdb_bytes
expr_stmt|;
comment|/* Command format from Table 20, page 37 of SRP spec */
name|crq
operator|.
name|iu_length
operator|=
literal|48
operator|+
operator|(
operator|(
name|nsegs
operator|>
literal|1
operator|)
condition|?
literal|20
else|:
literal|16
operator|)
operator|+
operator|(
operator|(
name|ccb
operator|->
name|csio
operator|.
name|cdb_len
operator|>
literal|16
operator|)
condition|?
operator|(
name|ccb
operator|->
name|csio
operator|.
name|cdb_len
operator|-
literal|16
operator|)
else|:
literal|0
operator|)
expr_stmt|;
name|xp
operator|->
name|srp_iu_size
operator|=
name|crq
operator|.
name|iu_length
expr_stmt|;
if|if
condition|(
name|nsegs
operator|>
literal|1
condition|)
name|xp
operator|->
name|srp_iu_size
operator|+=
name|nsegs
operator|*
literal|16
expr_stmt|;
name|xp
operator|->
name|srp_iu_size
operator|=
name|roundup
argument_list|(
name|xp
operator|->
name|srp_iu_size
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|err
operator|=
name|vmem_alloc
argument_list|(
name|xp
operator|->
name|sc
operator|->
name|srp_iu_arena
argument_list|,
name|xp
operator|->
name|srp_iu_size
argument_list|,
name|M_BESTFIT
operator||
name|M_NOWAIT
argument_list|,
operator|&
name|xp
operator|->
name|srp_iu_offset
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|panic
argument_list|(
literal|"Error during VMEM allocation (%d)"
argument_list|,
name|err
argument_list|)
expr_stmt|;
name|cmd
operator|=
operator|(
expr|struct
name|srp_cmd
operator|*
operator|)
operator|(
operator|(
name|uint8_t
operator|*
operator|)
name|xp
operator|->
name|sc
operator|->
name|srp_iu_queue
operator|+
operator|(
name|uintptr_t
operator|)
name|xp
operator|->
name|srp_iu_offset
operator|)
expr_stmt|;
name|bzero
argument_list|(
name|cmd
argument_list|,
name|xp
operator|->
name|srp_iu_size
argument_list|)
expr_stmt|;
name|cmd
operator|->
name|type
operator|=
name|SRP_CMD
expr_stmt|;
if|if
condition|(
name|ccb
operator|->
name|csio
operator|.
name|cdb_len
operator|>
literal|16
condition|)
name|cmd
operator|->
name|additional_cdb
operator|=
operator|(
name|ccb
operator|->
name|csio
operator|.
name|cdb_len
operator|-
literal|16
operator|)
operator|<<
literal|2
expr_stmt|;
name|memcpy
argument_list|(
name|cmd
operator|->
name|cdb
argument_list|,
name|cdb
argument_list|,
name|ccb
operator|->
name|csio
operator|.
name|cdb_len
argument_list|)
expr_stmt|;
name|cmd
operator|->
name|tag
operator|=
call|(
name|uint64_t
call|)
argument_list|(
name|xp
argument_list|)
expr_stmt|;
comment|/* Let the responder find this again */
name|cmd
operator|->
name|lun
operator|=
name|htobe64
argument_list|(
name|CAM_EXTLUN_BYTE_SWIZZLE
argument_list|(
name|ccb
operator|->
name|ccb_h
operator|.
name|target_lun
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|nsegs
operator|>
literal|1
condition|)
block|{
comment|/* Use indirect descriptors */
switch|switch
condition|(
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_DIR_MASK
condition|)
block|{
case|case
name|CAM_DIR_OUT
case|:
name|cmd
operator|->
name|formats
operator|=
operator|(
literal|2
operator|<<
literal|4
operator|)
expr_stmt|;
break|break;
case|case
name|CAM_DIR_IN
case|:
name|cmd
operator|->
name|formats
operator|=
literal|2
expr_stmt|;
break|break;
default|default:
name|panic
argument_list|(
literal|"Does not support bidirectional commands (%d)"
argument_list|,
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_DIR_MASK
argument_list|)
expr_stmt|;
break|break;
block|}
name|desc_start
operator|=
operator|(
operator|(
name|ccb
operator|->
name|csio
operator|.
name|cdb_len
operator|>
literal|16
operator|)
condition|?
name|ccb
operator|->
name|csio
operator|.
name|cdb_len
operator|-
literal|16
else|:
literal|0
operator|)
expr_stmt|;
name|chunk_addr
operator|=
name|xp
operator|->
name|sc
operator|->
name|srp_iu_phys
operator|+
name|xp
operator|->
name|srp_iu_offset
operator|+
literal|20
operator|+
name|desc_start
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|cmd
argument_list|)
expr_stmt|;
name|chunk_size
operator|=
literal|16
operator|*
name|nsegs
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|cmd
operator|->
name|data_payload
index|[
name|desc_start
index|]
argument_list|,
operator|&
name|chunk_addr
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|cmd
operator|->
name|data_payload
index|[
name|desc_start
operator|+
literal|12
index|]
argument_list|,
operator|&
name|chunk_size
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|chunk_size
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nsegs
condition|;
name|i
operator|++
control|)
name|chunk_size
operator|+=
name|segs
index|[
name|i
index|]
operator|.
name|ds_len
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|cmd
operator|->
name|data_payload
index|[
name|desc_start
operator|+
literal|16
index|]
argument_list|,
operator|&
name|chunk_size
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|desc_start
operator|+=
literal|20
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nsegs
condition|;
name|i
operator|++
control|)
block|{
name|chunk_addr
operator|=
name|segs
index|[
name|i
index|]
operator|.
name|ds_addr
expr_stmt|;
name|chunk_size
operator|=
name|segs
index|[
name|i
index|]
operator|.
name|ds_len
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|cmd
operator|->
name|data_payload
index|[
name|desc_start
operator|+
literal|16
operator|*
name|i
index|]
argument_list|,
operator|&
name|chunk_addr
argument_list|,
literal|8
argument_list|)
expr_stmt|;
comment|/* Set handle tag to 0 */
name|memcpy
argument_list|(
operator|&
name|cmd
operator|->
name|data_payload
index|[
name|desc_start
operator|+
literal|16
operator|*
name|i
operator|+
literal|12
index|]
argument_list|,
operator|&
name|chunk_size
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|nsegs
operator|==
literal|1
condition|)
block|{
switch|switch
condition|(
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_DIR_MASK
condition|)
block|{
case|case
name|CAM_DIR_OUT
case|:
name|cmd
operator|->
name|formats
operator|=
operator|(
literal|1
operator|<<
literal|4
operator|)
expr_stmt|;
break|break;
case|case
name|CAM_DIR_IN
case|:
name|cmd
operator|->
name|formats
operator|=
literal|1
expr_stmt|;
break|break;
default|default:
name|panic
argument_list|(
literal|"Does not support bidirectional commands (%d)"
argument_list|,
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_DIR_MASK
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* 		 * Memory descriptor: 		 * 8 byte address 		 * 4 byte handle 		 * 4 byte length 		 */
name|chunk_addr
operator|=
name|segs
index|[
literal|0
index|]
operator|.
name|ds_addr
expr_stmt|;
name|chunk_size
operator|=
name|segs
index|[
literal|0
index|]
operator|.
name|ds_len
expr_stmt|;
name|desc_start
operator|=
operator|(
operator|(
name|ccb
operator|->
name|csio
operator|.
name|cdb_len
operator|>
literal|16
operator|)
condition|?
name|ccb
operator|->
name|csio
operator|.
name|cdb_len
operator|-
literal|16
else|:
literal|0
operator|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|cmd
operator|->
name|data_payload
index|[
name|desc_start
index|]
argument_list|,
operator|&
name|chunk_addr
argument_list|,
literal|8
argument_list|)
expr_stmt|;
comment|/* Set handle tag to 0 */
name|memcpy
argument_list|(
operator|&
name|cmd
operator|->
name|data_payload
index|[
name|desc_start
operator|+
literal|12
index|]
argument_list|,
operator|&
name|chunk_size
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|xp
operator|->
name|srp_iu_size
operator|>=
literal|48
operator|+
operator|(
operator|(
name|ccb
operator|->
name|csio
operator|.
name|cdb_len
operator|>
literal|16
operator|)
condition|?
name|ccb
operator|->
name|csio
operator|.
name|cdb_len
else|:
literal|16
operator|)
argument_list|,
operator|(
literal|"SRP IU command length"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|cmd
operator|->
name|formats
operator|=
literal|0
expr_stmt|;
block|}
name|bus_dmamap_sync
argument_list|(
name|xp
operator|->
name|sc
operator|->
name|crq_tag
argument_list|,
name|xp
operator|->
name|sc
operator|->
name|crq_map
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
comment|/* Create CRQ entry */
name|crq
operator|.
name|valid
operator|=
literal|0x80
expr_stmt|;
name|crq
operator|.
name|format
operator|=
literal|0x01
expr_stmt|;
name|crq
operator|.
name|iu_data
operator|=
name|xp
operator|->
name|sc
operator|->
name|srp_iu_phys
operator|+
name|xp
operator|->
name|srp_iu_offset
expr_stmt|;
name|err
operator|=
name|phyp_hcall
argument_list|(
name|H_SEND_CRQ
argument_list|,
name|xp
operator|->
name|sc
operator|->
name|unit
argument_list|,
operator|(
operator|(
name|uint64_t
operator|*
operator|)
operator|(
operator|&
name|crq
operator|)
operator|)
index|[
literal|0
index|]
argument_list|,
operator|(
operator|(
name|uint64_t
operator|*
operator|)
operator|(
operator|&
name|crq
operator|)
operator|)
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
name|panic
argument_list|(
literal|"CRQ send failure (%d)"
argument_list|,
name|err
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vscsi_crq_load_cb
parameter_list|(
name|void
modifier|*
name|xsc
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|segs
parameter_list|,
name|int
name|nsegs
parameter_list|,
name|int
name|err
parameter_list|)
block|{
name|struct
name|vscsi_softc
modifier|*
name|sc
init|=
name|xsc
decl_stmt|;
name|sc
operator|->
name|crq_phys
operator|=
name|segs
index|[
literal|0
index|]
operator|.
name|ds_addr
expr_stmt|;
name|sc
operator|->
name|n_crqs
operator|=
name|PAGE_SIZE
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|vscsi_crq
argument_list|)
expr_stmt|;
name|sc
operator|->
name|srp_iu_queue
operator|=
operator|(
name|uint8_t
operator|*
operator|)
operator|(
name|sc
operator|->
name|crq_queue
operator|)
expr_stmt|;
name|sc
operator|->
name|srp_iu_phys
operator|=
name|segs
index|[
literal|0
index|]
operator|.
name|ds_addr
expr_stmt|;
name|sc
operator|->
name|srp_iu_arena
operator|=
name|vmem_create
argument_list|(
literal|"VSCSI SRP IU"
argument_list|,
name|PAGE_SIZE
argument_list|,
name|segs
index|[
literal|0
index|]
operator|.
name|ds_len
operator|-
name|PAGE_SIZE
argument_list|,
literal|16
argument_list|,
literal|0
argument_list|,
name|M_BESTFIT
operator||
name|M_NOWAIT
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vscsi_setup_bus
parameter_list|(
name|struct
name|vscsi_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|vscsi_crq
name|crq
decl_stmt|;
name|struct
name|vscsi_xfer
modifier|*
name|xp
decl_stmt|;
name|int
name|error
decl_stmt|;
struct|struct
block|{
name|uint32_t
name|type
decl_stmt|;
name|uint16_t
name|status
decl_stmt|;
name|uint16_t
name|length
decl_stmt|;
name|uint64_t
name|tag
decl_stmt|;
name|uint64_t
name|buffer
decl_stmt|;
struct|struct
block|{
name|char
name|srp_version
index|[
literal|8
index|]
decl_stmt|;
name|char
name|partition_name
index|[
literal|96
index|]
decl_stmt|;
name|uint32_t
name|partition_number
decl_stmt|;
name|uint32_t
name|mad_version
decl_stmt|;
name|uint32_t
name|os_type
decl_stmt|;
name|uint32_t
name|port_max_txu
index|[
literal|8
index|]
decl_stmt|;
block|}
name|payload
struct|;
block|}
name|mad_adapter_info
struct|;
name|bzero
argument_list|(
operator|&
name|crq
argument_list|,
sizeof|sizeof
argument_list|(
name|crq
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Init message */
name|crq
operator|.
name|valid
operator|=
literal|0xc0
expr_stmt|;
name|crq
operator|.
name|format
operator|=
literal|0x01
expr_stmt|;
do|do
block|{
name|error
operator|=
name|phyp_hcall
argument_list|(
name|H_FREE_CRQ
argument_list|,
name|sc
operator|->
name|unit
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|error
operator|==
name|H_BUSY
condition|)
do|;
comment|/* See initialization sequence page 757 */
name|bzero
argument_list|(
name|sc
operator|->
name|crq_queue
argument_list|,
name|sc
operator|->
name|n_crqs
operator|*
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|crq_queue
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|cur_crq
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|bus_initialized
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|bus_logged_in
operator|=
literal|0
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|crq_tag
argument_list|,
name|sc
operator|->
name|crq_map
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
name|error
operator|=
name|phyp_hcall
argument_list|(
name|H_REG_CRQ
argument_list|,
name|sc
operator|->
name|unit
argument_list|,
name|sc
operator|->
name|crq_phys
argument_list|,
name|sc
operator|->
name|n_crqs
operator|*
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|crq_queue
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|error
operator|==
literal|0
argument_list|,
operator|(
literal|"CRQ registration success"
operator|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|phyp_hcall
argument_list|(
name|H_SEND_CRQ
argument_list|,
name|sc
operator|->
name|unit
argument_list|,
operator|(
operator|(
name|uint64_t
operator|*
operator|)
operator|(
operator|&
name|crq
operator|)
operator|)
index|[
literal|0
index|]
argument_list|,
operator|(
operator|(
name|uint64_t
operator|*
operator|)
operator|(
operator|&
name|crq
operator|)
operator|)
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
name|panic
argument_list|(
literal|"CRQ setup failure (%d)"
argument_list|,
name|error
argument_list|)
expr_stmt|;
while|while
condition|(
name|sc
operator|->
name|bus_initialized
operator|==
literal|0
condition|)
name|vscsi_check_response_queue
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Send MAD adapter info */
name|mad_adapter_info
operator|.
name|type
operator|=
name|MAD_ADAPTER_INFO_REQUEST
expr_stmt|;
name|mad_adapter_info
operator|.
name|status
operator|=
literal|0
expr_stmt|;
name|mad_adapter_info
operator|.
name|length
operator|=
sizeof|sizeof
argument_list|(
name|mad_adapter_info
operator|.
name|payload
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|mad_adapter_info
operator|.
name|payload
operator|.
name|srp_version
argument_list|,
literal|"16.a"
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|mad_adapter_info
operator|.
name|payload
operator|.
name|partition_name
argument_list|,
literal|"UNKNOWN"
argument_list|)
expr_stmt|;
name|mad_adapter_info
operator|.
name|payload
operator|.
name|partition_number
operator|=
operator|-
literal|1
expr_stmt|;
name|mad_adapter_info
operator|.
name|payload
operator|.
name|mad_version
operator|=
literal|1
expr_stmt|;
name|mad_adapter_info
operator|.
name|payload
operator|.
name|os_type
operator|=
literal|2
expr_stmt|;
comment|/* Claim we are Linux */
name|mad_adapter_info
operator|.
name|payload
operator|.
name|port_max_txu
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
comment|/* If this fails, we get the defaults above */
name|OF_getprop
argument_list|(
name|OF_finddevice
argument_list|(
literal|"/"
argument_list|)
argument_list|,
literal|"ibm,partition-name"
argument_list|,
name|mad_adapter_info
operator|.
name|payload
operator|.
name|partition_name
argument_list|,
sizeof|sizeof
argument_list|(
name|mad_adapter_info
operator|.
name|payload
operator|.
name|partition_name
argument_list|)
argument_list|)
expr_stmt|;
name|OF_getprop
argument_list|(
name|OF_finddevice
argument_list|(
literal|"/"
argument_list|)
argument_list|,
literal|"ibm,partition-no"
argument_list|,
operator|&
name|mad_adapter_info
operator|.
name|payload
operator|.
name|partition_number
argument_list|,
sizeof|sizeof
argument_list|(
name|mad_adapter_info
operator|.
name|payload
operator|.
name|partition_number
argument_list|)
argument_list|)
expr_stmt|;
name|xp
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|sc
operator|->
name|free_xferq
argument_list|)
expr_stmt|;
name|xp
operator|->
name|ccb
operator|=
name|NULL
expr_stmt|;
name|TAILQ_REMOVE
argument_list|(
operator|&
name|sc
operator|->
name|free_xferq
argument_list|,
name|xp
argument_list|,
name|queue
argument_list|)
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|sc
operator|->
name|active_xferq
argument_list|,
name|xp
argument_list|,
name|queue
argument_list|)
expr_stmt|;
name|xp
operator|->
name|srp_iu_size
operator|=
name|crq
operator|.
name|iu_length
operator|=
sizeof|sizeof
argument_list|(
name|mad_adapter_info
argument_list|)
expr_stmt|;
name|vmem_alloc
argument_list|(
name|xp
operator|->
name|sc
operator|->
name|srp_iu_arena
argument_list|,
name|xp
operator|->
name|srp_iu_size
argument_list|,
name|M_BESTFIT
operator||
name|M_NOWAIT
argument_list|,
operator|&
name|xp
operator|->
name|srp_iu_offset
argument_list|)
expr_stmt|;
name|mad_adapter_info
operator|.
name|buffer
operator|=
name|xp
operator|->
name|sc
operator|->
name|srp_iu_phys
operator|+
name|xp
operator|->
name|srp_iu_offset
operator|+
literal|24
expr_stmt|;
name|mad_adapter_info
operator|.
name|tag
operator|=
operator|(
name|uint64_t
operator|)
name|xp
expr_stmt|;
name|memcpy
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
name|xp
operator|->
name|sc
operator|->
name|srp_iu_queue
operator|+
operator|(
name|uintptr_t
operator|)
name|xp
operator|->
name|srp_iu_offset
argument_list|,
operator|&
name|mad_adapter_info
argument_list|,
sizeof|sizeof
argument_list|(
name|mad_adapter_info
argument_list|)
argument_list|)
expr_stmt|;
name|crq
operator|.
name|valid
operator|=
literal|0x80
expr_stmt|;
name|crq
operator|.
name|format
operator|=
literal|0x02
expr_stmt|;
name|crq
operator|.
name|iu_data
operator|=
name|xp
operator|->
name|sc
operator|->
name|srp_iu_phys
operator|+
name|xp
operator|->
name|srp_iu_offset
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|crq_tag
argument_list|,
name|sc
operator|->
name|crq_map
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
name|phyp_hcall
argument_list|(
name|H_SEND_CRQ
argument_list|,
name|xp
operator|->
name|sc
operator|->
name|unit
argument_list|,
operator|(
operator|(
name|uint64_t
operator|*
operator|)
operator|(
operator|&
name|crq
operator|)
operator|)
index|[
literal|0
index|]
argument_list|,
operator|(
operator|(
name|uint64_t
operator|*
operator|)
operator|(
operator|&
name|crq
operator|)
operator|)
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
while|while
condition|(
name|TAILQ_EMPTY
argument_list|(
operator|&
name|sc
operator|->
name|free_xferq
argument_list|)
condition|)
name|vscsi_check_response_queue
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Send SRP login */
name|vscsi_srp_login
argument_list|(
name|sc
argument_list|)
expr_stmt|;
while|while
condition|(
name|sc
operator|->
name|bus_logged_in
operator|==
literal|0
condition|)
name|vscsi_check_response_queue
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|error
operator|=
name|phyp_hcall
argument_list|(
name|H_VIO_SIGNAL
argument_list|,
name|sc
operator|->
name|unit
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* Enable interrupts */
block|}
end_function

begin_function
specifier|static
name|void
name|vscsi_intr
parameter_list|(
name|void
modifier|*
name|xsc
parameter_list|)
block|{
name|struct
name|vscsi_softc
modifier|*
name|sc
init|=
name|xsc
decl_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|sc
operator|->
name|io_lock
argument_list|)
expr_stmt|;
name|vscsi_check_response_queue
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|sc
operator|->
name|io_lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vscsi_srp_response
parameter_list|(
name|struct
name|vscsi_xfer
modifier|*
name|xp
parameter_list|,
name|struct
name|vscsi_crq
modifier|*
name|crq
parameter_list|)
block|{
name|union
name|ccb
modifier|*
name|ccb
init|=
name|xp
operator|->
name|ccb
decl_stmt|;
name|struct
name|vscsi_softc
modifier|*
name|sc
init|=
name|xp
operator|->
name|sc
decl_stmt|;
name|struct
name|srp_rsp
modifier|*
name|rsp
decl_stmt|;
name|uint32_t
name|sense_len
decl_stmt|;
comment|/* SRP response packet in original request */
name|rsp
operator|=
operator|(
expr|struct
name|srp_rsp
operator|*
operator|)
operator|(
operator|(
name|uint8_t
operator|*
operator|)
name|sc
operator|->
name|srp_iu_queue
operator|+
operator|(
name|uintptr_t
operator|)
name|xp
operator|->
name|srp_iu_offset
operator|)
expr_stmt|;
name|ccb
operator|->
name|csio
operator|.
name|scsi_status
operator|=
name|rsp
operator|->
name|status
expr_stmt|;
if|if
condition|(
name|ccb
operator|->
name|csio
operator|.
name|scsi_status
operator|==
name|SCSI_STATUS_OK
condition|)
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_CMP
expr_stmt|;
else|else
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_SCSI_STATUS_ERROR
expr_stmt|;
ifdef|#
directive|ifdef
name|NOTYET
comment|/* Collect fast fail codes */
if|if
condition|(
name|crq
operator|->
name|status
operator|!=
literal|0
condition|)
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_CMP_ERR
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|!=
name|CAM_REQ_CMP
condition|)
block|{
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator||=
name|CAM_DEV_QFRZN
expr_stmt|;
name|xpt_freeze_devq
argument_list|(
name|ccb
operator|->
name|ccb_h
operator|.
name|path
argument_list|,
comment|/*count*/
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|(
name|rsp
operator|->
name|flags
operator|&
name|SRP_RSPVALID
operator|)
condition|)
name|rsp
operator|->
name|response_data_len
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|rsp
operator|->
name|flags
operator|&
name|SRP_SNSVALID
operator|)
condition|)
name|rsp
operator|->
name|sense_data_len
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|rsp
operator|->
name|flags
operator|&
operator|(
name|SRP_DOOVER
operator||
name|SRP_DOUNDER
operator|)
operator|)
condition|)
name|rsp
operator|->
name|data_out_resid
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|rsp
operator|->
name|flags
operator|&
operator|(
name|SRP_DIOVER
operator||
name|SRP_DIUNDER
operator|)
operator|)
condition|)
name|rsp
operator|->
name|data_in_resid
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|rsp
operator|->
name|flags
operator|&
name|SRP_SNSVALID
condition|)
block|{
name|bzero
argument_list|(
operator|&
name|ccb
operator|->
name|csio
operator|.
name|sense_data
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|scsi_sense_data
argument_list|)
argument_list|)
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator||=
name|CAM_AUTOSNS_VALID
expr_stmt|;
name|sense_len
operator|=
name|min
argument_list|(
name|be32toh
argument_list|(
name|rsp
operator|->
name|sense_data_len
argument_list|)
argument_list|,
name|ccb
operator|->
name|csio
operator|.
name|sense_len
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|ccb
operator|->
name|csio
operator|.
name|sense_data
argument_list|,
operator|&
name|rsp
operator|->
name|data_payload
index|[
name|be32toh
argument_list|(
name|rsp
operator|->
name|response_data_len
argument_list|)
index|]
argument_list|,
name|sense_len
argument_list|)
expr_stmt|;
name|ccb
operator|->
name|csio
operator|.
name|sense_resid
operator|=
name|ccb
operator|->
name|csio
operator|.
name|sense_len
operator|-
name|be32toh
argument_list|(
name|rsp
operator|->
name|sense_data_len
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_DIR_MASK
condition|)
block|{
case|case
name|CAM_DIR_OUT
case|:
name|ccb
operator|->
name|csio
operator|.
name|resid
operator|=
name|rsp
operator|->
name|data_out_resid
expr_stmt|;
break|break;
case|case
name|CAM_DIR_IN
case|:
name|ccb
operator|->
name|csio
operator|.
name|resid
operator|=
name|rsp
operator|->
name|data_in_resid
expr_stmt|;
break|break;
block|}
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|data_tag
argument_list|,
name|xp
operator|->
name|dmamap
argument_list|,
name|BUS_DMASYNC_POSTREAD
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|sc
operator|->
name|data_tag
argument_list|,
name|xp
operator|->
name|dmamap
argument_list|)
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
name|xp
operator|->
name|ccb
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vscsi_login_response
parameter_list|(
name|struct
name|vscsi_xfer
modifier|*
name|xp
parameter_list|,
name|struct
name|vscsi_crq
modifier|*
name|crq
parameter_list|)
block|{
name|struct
name|vscsi_softc
modifier|*
name|sc
init|=
name|xp
operator|->
name|sc
decl_stmt|;
name|struct
name|srp_login_rsp
modifier|*
name|rsp
decl_stmt|;
comment|/* SRP response packet in original request */
name|rsp
operator|=
operator|(
expr|struct
name|srp_login_rsp
operator|*
operator|)
operator|(
operator|(
name|uint8_t
operator|*
operator|)
name|sc
operator|->
name|srp_iu_queue
operator|+
operator|(
name|uintptr_t
operator|)
name|xp
operator|->
name|srp_iu_offset
operator|)
expr_stmt|;
name|KASSERT
argument_list|(
name|be16toh
argument_list|(
name|rsp
operator|->
name|buffer_formats
argument_list|)
operator|&
literal|0x3
argument_list|,
operator|(
literal|"Both direct and indirect "
literal|"buffers supported"
operator|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|max_transactions
operator|=
name|be32toh
argument_list|(
name|rsp
operator|->
name|request_limit_delta
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Queue depth %d commands\n"
argument_list|,
name|sc
operator|->
name|max_transactions
argument_list|)
expr_stmt|;
name|sc
operator|->
name|bus_logged_in
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vscsi_cam_poll
parameter_list|(
name|struct
name|cam_sim
modifier|*
name|sim
parameter_list|)
block|{
name|struct
name|vscsi_softc
modifier|*
name|sc
init|=
name|cam_sim_softc
argument_list|(
name|sim
argument_list|)
decl_stmt|;
name|vscsi_check_response_queue
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vscsi_check_response_queue
parameter_list|(
name|struct
name|vscsi_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|vscsi_crq
modifier|*
name|crq
decl_stmt|;
name|struct
name|vscsi_xfer
modifier|*
name|xp
decl_stmt|;
name|int
name|code
decl_stmt|;
name|mtx_assert
argument_list|(
operator|&
name|sc
operator|->
name|io_lock
argument_list|,
name|MA_OWNED
argument_list|)
expr_stmt|;
name|phyp_hcall
argument_list|(
name|H_VIO_SIGNAL
argument_list|,
name|sc
operator|->
name|unit
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|crq_tag
argument_list|,
name|sc
operator|->
name|crq_map
argument_list|,
name|BUS_DMASYNC_POSTREAD
argument_list|)
expr_stmt|;
while|while
condition|(
name|sc
operator|->
name|crq_queue
index|[
name|sc
operator|->
name|cur_crq
index|]
operator|.
name|valid
operator|!=
literal|0
condition|)
block|{
name|crq
operator|=
operator|&
name|sc
operator|->
name|crq_queue
index|[
name|sc
operator|->
name|cur_crq
index|]
expr_stmt|;
switch|switch
condition|(
name|crq
operator|->
name|valid
condition|)
block|{
case|case
literal|0xc0
case|:
if|if
condition|(
name|crq
operator|->
name|format
operator|==
literal|0x02
condition|)
name|sc
operator|->
name|bus_initialized
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|0x80
case|:
comment|/* IU data is set to tag pointer (the XP) */
name|xp
operator|=
operator|(
expr|struct
name|vscsi_xfer
operator|*
operator|)
name|crq
operator|->
name|iu_data
expr_stmt|;
switch|switch
condition|(
name|crq
operator|->
name|format
condition|)
block|{
case|case
literal|0x01
case|:
name|code
operator|=
operator|*
operator|(
operator|(
name|uint8_t
operator|*
operator|)
name|sc
operator|->
name|srp_iu_queue
operator|+
operator|(
name|uintptr_t
operator|)
name|xp
operator|->
name|srp_iu_offset
operator|)
expr_stmt|;
switch|switch
condition|(
name|code
condition|)
block|{
case|case
name|SRP_RSP
case|:
name|vscsi_srp_response
argument_list|(
name|xp
argument_list|,
name|crq
argument_list|)
expr_stmt|;
break|break;
case|case
name|SRP_LOGIN_RSP
case|:
name|vscsi_login_response
argument_list|(
name|xp
argument_list|,
name|crq
argument_list|)
expr_stmt|;
break|break;
default|default:
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Unknown SRP "
literal|"response code %d\n"
argument_list|,
name|code
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|0x02
case|:
comment|/* Ignore management datagrams */
break|break;
default|default:
name|panic
argument_list|(
literal|"Unknown CRQ format %d\n"
argument_list|,
name|crq
operator|->
name|format
argument_list|)
expr_stmt|;
break|break;
block|}
name|vmem_free
argument_list|(
name|sc
operator|->
name|srp_iu_arena
argument_list|,
name|xp
operator|->
name|srp_iu_offset
argument_list|,
name|xp
operator|->
name|srp_iu_size
argument_list|)
expr_stmt|;
name|TAILQ_REMOVE
argument_list|(
operator|&
name|sc
operator|->
name|active_xferq
argument_list|,
name|xp
argument_list|,
name|queue
argument_list|)
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|sc
operator|->
name|free_xferq
argument_list|,
name|xp
argument_list|,
name|queue
argument_list|)
expr_stmt|;
break|break;
default|default:
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Unknown CRQ message type %d\n"
argument_list|,
name|crq
operator|->
name|valid
argument_list|)
expr_stmt|;
break|break;
block|}
name|crq
operator|->
name|valid
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|cur_crq
operator|=
operator|(
name|sc
operator|->
name|cur_crq
operator|+
literal|1
operator|)
operator|%
name|sc
operator|->
name|n_crqs
expr_stmt|;
block|}
empty_stmt|;
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|crq_tag
argument_list|,
name|sc
operator|->
name|crq_map
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
name|phyp_hcall
argument_list|(
name|H_VIO_SIGNAL
argument_list|,
name|sc
operator|->
name|unit
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


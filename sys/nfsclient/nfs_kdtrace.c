begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2009 Robert N. M. Watson  * All rights reserved.  *  * This software was developed at the University of Cambridge Computer  * Laboratory with support from a grant from Google, Inc.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/dtrace.h>
end_include

begin_include
include|#
directive|include
file|<sys/dtrace_bsd.h>
end_include

begin_include
include|#
directive|include
file|<nfs/nfsproto.h>
end_include

begin_comment
comment|/*  * dtnfsclient is a DTrace provider that tracks the intent to perform RPCs  * in the NFS client, as well as acess to and maintenance of the access and  * attribute caches.  This is not quite the same as RPCs, because NFS may  * issue multiple RPC transactions in the event that authentication fails,  * there's a jukebox error, or none at all if the access or attribute cache  * hits.  However, it cleanly represents the logical layer between RPC  * transmission and vnode/vfs operations, providing access to state linking  * the two.  */
end_comment

begin_function_decl
specifier|static
name|int
name|dtnfsclient_unload
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dtnfsclient_getargdesc
parameter_list|(
name|void
modifier|*
parameter_list|,
name|dtrace_id_t
parameter_list|,
name|void
modifier|*
parameter_list|,
name|dtrace_argdesc_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dtnfsclient_provide
parameter_list|(
name|void
modifier|*
parameter_list|,
name|dtrace_probedesc_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dtnfsclient_destroy
parameter_list|(
name|void
modifier|*
parameter_list|,
name|dtrace_id_t
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dtnfsclient_enable
parameter_list|(
name|void
modifier|*
parameter_list|,
name|dtrace_id_t
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dtnfsclient_disable
parameter_list|(
name|void
modifier|*
parameter_list|,
name|dtrace_id_t
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dtnfsclient_load
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|dtrace_pattr_t
name|dtnfsclient_attr
init|=
block|{
block|{
name|DTRACE_STABILITY_STABLE
block|,
name|DTRACE_STABILITY_STABLE
block|,
name|DTRACE_CLASS_COMMON
block|}
block|,
block|{
name|DTRACE_STABILITY_PRIVATE
block|,
name|DTRACE_STABILITY_PRIVATE
block|,
name|DTRACE_CLASS_UNKNOWN
block|}
block|,
block|{
name|DTRACE_STABILITY_PRIVATE
block|,
name|DTRACE_STABILITY_PRIVATE
block|,
name|DTRACE_CLASS_UNKNOWN
block|}
block|,
block|{
name|DTRACE_STABILITY_STABLE
block|,
name|DTRACE_STABILITY_STABLE
block|,
name|DTRACE_CLASS_COMMON
block|}
block|,
block|{
name|DTRACE_STABILITY_STABLE
block|,
name|DTRACE_STABILITY_STABLE
block|,
name|DTRACE_CLASS_COMMON
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Description of NFSv3 and (optional) NFSv2 probes for a procedure.  */
end_comment

begin_struct
struct|struct
name|dtnfsclient_rpc
block|{
name|char
modifier|*
name|nr_v3_name
decl_stmt|;
name|char
modifier|*
name|nr_v2_name
decl_stmt|;
comment|/* Or NULL if none. */
comment|/* 	 * IDs for the start and done cases, for both NFSv2 and NFSv3. 	 */
name|uint32_t
name|nr_v2_id_start
decl_stmt|,
name|nr_v2_id_done
decl_stmt|;
name|uint32_t
name|nr_v3_id_start
decl_stmt|,
name|nr_v3_id_done
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/*  * This table is indexed by NFSv3 procedure number, but also used for NFSv2  * procedure names.  */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|dtnfsclient_rpc
name|dtnfsclient_rpcs
index|[
name|NFS_NPROCS
index|]
init|=
block|{
block|{
literal|"null"
block|,
literal|"null"
block|}
block|,
block|{
literal|"getattr"
block|,
literal|"getattr"
block|}
block|,
block|{
literal|"setattr"
block|,
literal|"setattr"
block|}
block|,
block|{
literal|"lookup"
block|,
literal|"lookup"
block|}
block|,
block|{
literal|"access"
block|}
block|,
block|{
literal|"readlink"
block|,
literal|"readlink"
block|}
block|,
block|{
literal|"read"
block|,
literal|"read"
block|}
block|,
block|{
literal|"write"
block|,
literal|"write"
block|}
block|,
block|{
literal|"create"
block|,
literal|"create"
block|}
block|,
block|{
literal|"mkdir"
block|,
literal|"mkdir"
block|}
block|,
block|{
literal|"symlink"
block|,
literal|"symlink"
block|}
block|,
block|{
literal|"mknod"
block|}
block|,
block|{
literal|"remove"
block|,
literal|"remove"
block|}
block|,
block|{
literal|"rmdir"
block|,
literal|"rmdir"
block|}
block|,
block|{
literal|"rename"
block|,
literal|"rename"
block|}
block|,
block|{
literal|"link"
block|,
literal|"link"
block|}
block|,
block|{
literal|"readdir"
block|,
literal|"readdir"
block|}
block|,
block|{
literal|"readdirplus"
block|}
block|,
block|{
literal|"fsstat"
block|,
literal|"statfs"
block|}
block|,
block|{
literal|"fsinfo"
block|}
block|,
block|{
literal|"pathconf"
block|}
block|,
block|{
literal|"commit"
block|}
block|,
block|{
literal|"noop"
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Module name strings.  */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|dtnfsclient_accesscache_str
init|=
literal|"accesscache"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|dtnfsclient_attrcache_str
init|=
literal|"attrcache"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|dtnfsclient_nfs2_str
init|=
literal|"nfs2"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|dtnfsclient_nfs3_str
init|=
literal|"nfs3"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Function name strings.  */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|dtnfsclient_flush_str
init|=
literal|"flush"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|dtnfsclient_load_str
init|=
literal|"load"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|dtnfsclient_get_str
init|=
literal|"get"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Name strings.  */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|dtnfsclient_done_str
init|=
literal|"done"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|dtnfsclient_hit_str
init|=
literal|"hit"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|dtnfsclient_miss_str
init|=
literal|"miss"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|dtnfsclient_start_str
init|=
literal|"start"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|dtrace_pops_t
name|dtnfsclient_pops
init|=
block|{
name|dtnfsclient_provide
block|,
name|NULL
block|,
name|dtnfsclient_enable
block|,
name|dtnfsclient_disable
block|,
name|NULL
block|,
name|NULL
block|,
name|dtnfsclient_getargdesc
block|,
name|NULL
block|,
name|NULL
block|,
name|dtnfsclient_destroy
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|dtrace_provider_id_t
name|dtnfsclient_id
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Most probes are generated from the above RPC table, but for access and  * attribute caches, we have specific IDs we recognize and handle specially  * in various spots.  */
end_comment

begin_decl_stmt
specifier|extern
name|uint32_t
name|nfsclient_accesscache_flush_done_id
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|uint32_t
name|nfsclient_accesscache_get_hit_id
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|uint32_t
name|nfsclient_accesscache_get_miss_id
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|uint32_t
name|nfsclient_accesscache_load_done_id
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|uint32_t
name|nfsclient_attrcache_flush_done_id
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|uint32_t
name|nfsclient_attrcache_get_hit_id
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|uint32_t
name|nfsclient_attrcache_get_miss_id
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|uint32_t
name|nfsclient_attrcache_load_done_id
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * When tracing on a procedure is enabled, the DTrace ID for an RPC event is  * stored in one of these two NFS client-allocated arrays; 0 indicates that  * the event is not being traced so probes should not be called.  *  * For simplicity, we allocate both v2 and v3 arrays as NFS_NPROCS, and the  * v2 array is simply sparse.  */
end_comment

begin_decl_stmt
specifier|extern
name|uint32_t
name|nfsclient_nfs2_start_probes
index|[
name|NFS_NPROCS
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|uint32_t
name|nfsclient_nfs2_done_probes
index|[
name|NFS_NPROCS
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|uint32_t
name|nfsclient_nfs3_start_probes
index|[
name|NFS_NPROCS
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|uint32_t
name|nfsclient_nfs3_done_probes
index|[
name|NFS_NPROCS
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Look up a DTrace probe ID to see if it's associated with a "done" event --  * if so, we will return a fourth argument type of "int".  */
end_comment

begin_function
specifier|static
name|int
name|dtnfs23_isdoneprobe
parameter_list|(
name|dtrace_id_t
name|id
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NFS_NPROCS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|dtnfsclient_rpcs
index|[
name|i
index|]
operator|.
name|nr_v3_id_done
operator|==
name|id
operator|||
name|dtnfsclient_rpcs
index|[
name|i
index|]
operator|.
name|nr_v2_id_done
operator|==
name|id
condition|)
return|return
operator|(
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|dtnfsclient_getargdesc
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|dtrace_id_t
name|id
parameter_list|,
name|void
modifier|*
name|parg
parameter_list|,
name|dtrace_argdesc_t
modifier|*
name|desc
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|p
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|id
operator|==
name|nfsclient_accesscache_flush_done_id
operator|||
name|id
operator|==
name|nfsclient_attrcache_flush_done_id
operator|||
name|id
operator|==
name|nfsclient_attrcache_get_miss_id
condition|)
block|{
switch|switch
condition|(
name|desc
operator|->
name|dtargd_ndx
condition|)
block|{
case|case
literal|0
case|:
name|p
operator|=
literal|"struct vnode *"
expr_stmt|;
break|break;
default|default:
name|desc
operator|->
name|dtargd_ndx
operator|=
name|DTRACE_ARGNONE
expr_stmt|;
break|break;
block|}
block|}
elseif|else
if|if
condition|(
name|id
operator|==
name|nfsclient_accesscache_get_hit_id
operator|||
name|id
operator|==
name|nfsclient_accesscache_get_miss_id
condition|)
block|{
switch|switch
condition|(
name|desc
operator|->
name|dtargd_ndx
condition|)
block|{
case|case
literal|0
case|:
name|p
operator|=
literal|"struct vnode *"
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|p
operator|=
literal|"uid_t"
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|p
operator|=
literal|"uint32_t"
expr_stmt|;
break|break;
default|default:
name|desc
operator|->
name|dtargd_ndx
operator|=
name|DTRACE_ARGNONE
expr_stmt|;
break|break;
block|}
block|}
elseif|else
if|if
condition|(
name|id
operator|==
name|nfsclient_accesscache_load_done_id
condition|)
block|{
switch|switch
condition|(
name|desc
operator|->
name|dtargd_ndx
condition|)
block|{
case|case
literal|0
case|:
name|p
operator|=
literal|"struct vnode *"
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|p
operator|=
literal|"uid_t"
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|p
operator|=
literal|"uint32_t"
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|p
operator|=
literal|"int"
expr_stmt|;
break|break;
default|default:
name|desc
operator|->
name|dtargd_ndx
operator|=
name|DTRACE_ARGNONE
expr_stmt|;
break|break;
block|}
block|}
elseif|else
if|if
condition|(
name|id
operator|==
name|nfsclient_attrcache_get_hit_id
condition|)
block|{
switch|switch
condition|(
name|desc
operator|->
name|dtargd_ndx
condition|)
block|{
case|case
literal|0
case|:
name|p
operator|=
literal|"struct vnode *"
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|p
operator|=
literal|"struct vattr *"
expr_stmt|;
break|break;
default|default:
name|desc
operator|->
name|dtargd_ndx
operator|=
name|DTRACE_ARGNONE
expr_stmt|;
break|break;
block|}
block|}
elseif|else
if|if
condition|(
name|id
operator|==
name|nfsclient_attrcache_load_done_id
condition|)
block|{
switch|switch
condition|(
name|desc
operator|->
name|dtargd_ndx
condition|)
block|{
case|case
literal|0
case|:
name|p
operator|=
literal|"struct vnode *"
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|p
operator|=
literal|"struct vattr *"
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|p
operator|=
literal|"int"
expr_stmt|;
break|break;
default|default:
name|desc
operator|->
name|dtargd_ndx
operator|=
name|DTRACE_ARGNONE
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
switch|switch
condition|(
name|desc
operator|->
name|dtargd_ndx
condition|)
block|{
case|case
literal|0
case|:
name|p
operator|=
literal|"struct vnode *"
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|p
operator|=
literal|"struct mbuf *"
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|p
operator|=
literal|"struct ucred *"
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|p
operator|=
literal|"int"
expr_stmt|;
break|break;
case|case
literal|4
case|:
if|if
condition|(
name|dtnfs23_isdoneprobe
argument_list|(
name|id
argument_list|)
condition|)
block|{
name|p
operator|=
literal|"int"
expr_stmt|;
break|break;
block|}
comment|/* FALLSTHROUGH */
default|default:
name|desc
operator|->
name|dtargd_ndx
operator|=
name|DTRACE_ARGNONE
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|p
operator|!=
name|NULL
condition|)
name|strlcpy
argument_list|(
name|desc
operator|->
name|dtargd_native
argument_list|,
name|p
argument_list|,
sizeof|sizeof
argument_list|(
name|desc
operator|->
name|dtargd_native
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dtnfsclient_provide
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|dtrace_probedesc_t
modifier|*
name|desc
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|desc
operator|!=
name|NULL
condition|)
return|return;
comment|/* 	 * Register access cache probes. 	 */
if|if
condition|(
name|dtrace_probe_lookup
argument_list|(
name|dtnfsclient_id
argument_list|,
name|dtnfsclient_accesscache_str
argument_list|,
name|dtnfsclient_flush_str
argument_list|,
name|dtnfsclient_done_str
argument_list|)
operator|==
literal|0
condition|)
block|{
name|nfsclient_accesscache_flush_done_id
operator|=
name|dtrace_probe_create
argument_list|(
name|dtnfsclient_id
argument_list|,
name|dtnfsclient_accesscache_str
argument_list|,
name|dtnfsclient_flush_str
argument_list|,
name|dtnfsclient_done_str
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dtrace_probe_lookup
argument_list|(
name|dtnfsclient_id
argument_list|,
name|dtnfsclient_accesscache_str
argument_list|,
name|dtnfsclient_get_str
argument_list|,
name|dtnfsclient_hit_str
argument_list|)
operator|==
literal|0
condition|)
block|{
name|nfsclient_accesscache_get_hit_id
operator|=
name|dtrace_probe_create
argument_list|(
name|dtnfsclient_id
argument_list|,
name|dtnfsclient_accesscache_str
argument_list|,
name|dtnfsclient_get_str
argument_list|,
name|dtnfsclient_hit_str
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dtrace_probe_lookup
argument_list|(
name|dtnfsclient_id
argument_list|,
name|dtnfsclient_accesscache_str
argument_list|,
name|dtnfsclient_get_str
argument_list|,
name|dtnfsclient_miss_str
argument_list|)
operator|==
literal|0
condition|)
block|{
name|nfsclient_accesscache_get_miss_id
operator|=
name|dtrace_probe_create
argument_list|(
name|dtnfsclient_id
argument_list|,
name|dtnfsclient_accesscache_str
argument_list|,
name|dtnfsclient_get_str
argument_list|,
name|dtnfsclient_miss_str
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dtrace_probe_lookup
argument_list|(
name|dtnfsclient_id
argument_list|,
name|dtnfsclient_accesscache_str
argument_list|,
name|dtnfsclient_load_str
argument_list|,
name|dtnfsclient_done_str
argument_list|)
operator|==
literal|0
condition|)
block|{
name|nfsclient_accesscache_load_done_id
operator|=
name|dtrace_probe_create
argument_list|(
name|dtnfsclient_id
argument_list|,
name|dtnfsclient_accesscache_str
argument_list|,
name|dtnfsclient_load_str
argument_list|,
name|dtnfsclient_done_str
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Register attribute cache probes. 	 */
if|if
condition|(
name|dtrace_probe_lookup
argument_list|(
name|dtnfsclient_id
argument_list|,
name|dtnfsclient_attrcache_str
argument_list|,
name|dtnfsclient_flush_str
argument_list|,
name|dtnfsclient_done_str
argument_list|)
operator|==
literal|0
condition|)
block|{
name|nfsclient_attrcache_flush_done_id
operator|=
name|dtrace_probe_create
argument_list|(
name|dtnfsclient_id
argument_list|,
name|dtnfsclient_attrcache_str
argument_list|,
name|dtnfsclient_flush_str
argument_list|,
name|dtnfsclient_done_str
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dtrace_probe_lookup
argument_list|(
name|dtnfsclient_id
argument_list|,
name|dtnfsclient_attrcache_str
argument_list|,
name|dtnfsclient_get_str
argument_list|,
name|dtnfsclient_hit_str
argument_list|)
operator|==
literal|0
condition|)
block|{
name|nfsclient_attrcache_get_hit_id
operator|=
name|dtrace_probe_create
argument_list|(
name|dtnfsclient_id
argument_list|,
name|dtnfsclient_attrcache_str
argument_list|,
name|dtnfsclient_get_str
argument_list|,
name|dtnfsclient_hit_str
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dtrace_probe_lookup
argument_list|(
name|dtnfsclient_id
argument_list|,
name|dtnfsclient_attrcache_str
argument_list|,
name|dtnfsclient_get_str
argument_list|,
name|dtnfsclient_miss_str
argument_list|)
operator|==
literal|0
condition|)
block|{
name|nfsclient_attrcache_get_miss_id
operator|=
name|dtrace_probe_create
argument_list|(
name|dtnfsclient_id
argument_list|,
name|dtnfsclient_attrcache_str
argument_list|,
name|dtnfsclient_get_str
argument_list|,
name|dtnfsclient_miss_str
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dtrace_probe_lookup
argument_list|(
name|dtnfsclient_id
argument_list|,
name|dtnfsclient_attrcache_str
argument_list|,
name|dtnfsclient_load_str
argument_list|,
name|dtnfsclient_done_str
argument_list|)
operator|==
literal|0
condition|)
block|{
name|nfsclient_attrcache_load_done_id
operator|=
name|dtrace_probe_create
argument_list|(
name|dtnfsclient_id
argument_list|,
name|dtnfsclient_attrcache_str
argument_list|,
name|dtnfsclient_load_str
argument_list|,
name|dtnfsclient_done_str
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Register NFSv2 RPC procedures; note sparseness check for each slot 	 * in the NFSv3 procnum-indexed array. 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NFS_NPROCS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|dtnfsclient_rpcs
index|[
name|i
index|]
operator|.
name|nr_v2_name
operator|!=
name|NULL
operator|&&
name|dtrace_probe_lookup
argument_list|(
name|dtnfsclient_id
argument_list|,
name|dtnfsclient_nfs2_str
argument_list|,
name|dtnfsclient_rpcs
index|[
name|i
index|]
operator|.
name|nr_v2_name
argument_list|,
name|dtnfsclient_start_str
argument_list|)
operator|==
literal|0
condition|)
block|{
name|dtnfsclient_rpcs
index|[
name|i
index|]
operator|.
name|nr_v2_id_start
operator|=
name|dtrace_probe_create
argument_list|(
name|dtnfsclient_id
argument_list|,
name|dtnfsclient_nfs2_str
argument_list|,
name|dtnfsclient_rpcs
index|[
name|i
index|]
operator|.
name|nr_v2_name
argument_list|,
name|dtnfsclient_start_str
argument_list|,
literal|0
argument_list|,
operator|&
name|nfsclient_nfs2_start_probes
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dtnfsclient_rpcs
index|[
name|i
index|]
operator|.
name|nr_v2_name
operator|!=
name|NULL
operator|&&
name|dtrace_probe_lookup
argument_list|(
name|dtnfsclient_id
argument_list|,
name|dtnfsclient_nfs2_str
argument_list|,
name|dtnfsclient_rpcs
index|[
name|i
index|]
operator|.
name|nr_v2_name
argument_list|,
name|dtnfsclient_done_str
argument_list|)
operator|==
literal|0
condition|)
block|{
name|dtnfsclient_rpcs
index|[
name|i
index|]
operator|.
name|nr_v2_id_done
operator|=
name|dtrace_probe_create
argument_list|(
name|dtnfsclient_id
argument_list|,
name|dtnfsclient_nfs2_str
argument_list|,
name|dtnfsclient_rpcs
index|[
name|i
index|]
operator|.
name|nr_v2_name
argument_list|,
name|dtnfsclient_done_str
argument_list|,
literal|0
argument_list|,
operator|&
name|nfsclient_nfs2_done_probes
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* 	 * Register NFSv3 RPC procedures. 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NFS_NPROCS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|dtrace_probe_lookup
argument_list|(
name|dtnfsclient_id
argument_list|,
name|dtnfsclient_nfs3_str
argument_list|,
name|dtnfsclient_rpcs
index|[
name|i
index|]
operator|.
name|nr_v3_name
argument_list|,
name|dtnfsclient_start_str
argument_list|)
operator|==
literal|0
condition|)
block|{
name|dtnfsclient_rpcs
index|[
name|i
index|]
operator|.
name|nr_v3_id_start
operator|=
name|dtrace_probe_create
argument_list|(
name|dtnfsclient_id
argument_list|,
name|dtnfsclient_nfs3_str
argument_list|,
name|dtnfsclient_rpcs
index|[
name|i
index|]
operator|.
name|nr_v3_name
argument_list|,
name|dtnfsclient_start_str
argument_list|,
literal|0
argument_list|,
operator|&
name|nfsclient_nfs3_start_probes
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dtrace_probe_lookup
argument_list|(
name|dtnfsclient_id
argument_list|,
name|dtnfsclient_nfs3_str
argument_list|,
name|dtnfsclient_rpcs
index|[
name|i
index|]
operator|.
name|nr_v3_name
argument_list|,
name|dtnfsclient_done_str
argument_list|)
operator|==
literal|0
condition|)
block|{
name|dtnfsclient_rpcs
index|[
name|i
index|]
operator|.
name|nr_v3_id_done
operator|=
name|dtrace_probe_create
argument_list|(
name|dtnfsclient_id
argument_list|,
name|dtnfsclient_nfs3_str
argument_list|,
name|dtnfsclient_rpcs
index|[
name|i
index|]
operator|.
name|nr_v3_name
argument_list|,
name|dtnfsclient_done_str
argument_list|,
literal|0
argument_list|,
operator|&
name|nfsclient_nfs3_done_probes
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|dtnfsclient_destroy
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|dtrace_id_t
name|id
parameter_list|,
name|void
modifier|*
name|parg
parameter_list|)
block|{ }
end_function

begin_function
specifier|static
name|void
name|dtnfsclient_enable
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|dtrace_id_t
name|id
parameter_list|,
name|void
modifier|*
name|parg
parameter_list|)
block|{
name|uint32_t
modifier|*
name|p
init|=
name|parg
decl_stmt|;
name|void
modifier|*
name|f
init|=
name|dtrace_probe
decl_stmt|;
if|if
condition|(
name|id
operator|==
name|nfsclient_accesscache_flush_done_id
condition|)
name|dtrace_nfsclient_accesscache_flush_done_probe
operator|=
name|f
expr_stmt|;
elseif|else
if|if
condition|(
name|id
operator|==
name|nfsclient_accesscache_get_hit_id
condition|)
name|dtrace_nfsclient_accesscache_get_hit_probe
operator|=
name|f
expr_stmt|;
elseif|else
if|if
condition|(
name|id
operator|==
name|nfsclient_accesscache_get_miss_id
condition|)
name|dtrace_nfsclient_accesscache_get_miss_probe
operator|=
name|f
expr_stmt|;
elseif|else
if|if
condition|(
name|id
operator|==
name|nfsclient_accesscache_load_done_id
condition|)
name|dtrace_nfsclient_accesscache_load_done_probe
operator|=
name|f
expr_stmt|;
elseif|else
if|if
condition|(
name|id
operator|==
name|nfsclient_attrcache_flush_done_id
condition|)
name|dtrace_nfsclient_attrcache_flush_done_probe
operator|=
name|f
expr_stmt|;
elseif|else
if|if
condition|(
name|id
operator|==
name|nfsclient_attrcache_get_hit_id
condition|)
name|dtrace_nfsclient_attrcache_get_hit_probe
operator|=
name|f
expr_stmt|;
elseif|else
if|if
condition|(
name|id
operator|==
name|nfsclient_attrcache_get_miss_id
condition|)
name|dtrace_nfsclient_attrcache_get_miss_probe
operator|=
name|f
expr_stmt|;
elseif|else
if|if
condition|(
name|id
operator|==
name|nfsclient_attrcache_load_done_id
condition|)
name|dtrace_nfsclient_attrcache_load_done_probe
operator|=
name|f
expr_stmt|;
else|else
operator|*
name|p
operator|=
name|id
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dtnfsclient_disable
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|dtrace_id_t
name|id
parameter_list|,
name|void
modifier|*
name|parg
parameter_list|)
block|{
name|uint32_t
modifier|*
name|p
init|=
name|parg
decl_stmt|;
if|if
condition|(
name|id
operator|==
name|nfsclient_accesscache_flush_done_id
condition|)
name|dtrace_nfsclient_accesscache_flush_done_probe
operator|=
name|NULL
expr_stmt|;
elseif|else
if|if
condition|(
name|id
operator|==
name|nfsclient_accesscache_get_hit_id
condition|)
name|dtrace_nfsclient_accesscache_get_hit_probe
operator|=
name|NULL
expr_stmt|;
elseif|else
if|if
condition|(
name|id
operator|==
name|nfsclient_accesscache_get_miss_id
condition|)
name|dtrace_nfsclient_accesscache_get_miss_probe
operator|=
name|NULL
expr_stmt|;
elseif|else
if|if
condition|(
name|id
operator|==
name|nfsclient_accesscache_load_done_id
condition|)
name|dtrace_nfsclient_accesscache_load_done_probe
operator|=
name|NULL
expr_stmt|;
elseif|else
if|if
condition|(
name|id
operator|==
name|nfsclient_attrcache_flush_done_id
condition|)
name|dtrace_nfsclient_attrcache_flush_done_probe
operator|=
name|NULL
expr_stmt|;
elseif|else
if|if
condition|(
name|id
operator|==
name|nfsclient_attrcache_get_hit_id
condition|)
name|dtrace_nfsclient_attrcache_get_hit_probe
operator|=
name|NULL
expr_stmt|;
elseif|else
if|if
condition|(
name|id
operator|==
name|nfsclient_attrcache_get_miss_id
condition|)
name|dtrace_nfsclient_attrcache_get_miss_probe
operator|=
name|NULL
expr_stmt|;
elseif|else
if|if
condition|(
name|id
operator|==
name|nfsclient_attrcache_load_done_id
condition|)
name|dtrace_nfsclient_attrcache_load_done_probe
operator|=
name|NULL
expr_stmt|;
else|else
operator|*
name|p
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dtnfsclient_load
parameter_list|(
name|void
modifier|*
name|dummy
parameter_list|)
block|{
if|if
condition|(
name|dtrace_register
argument_list|(
literal|"nfsclient"
argument_list|,
operator|&
name|dtnfsclient_attr
argument_list|,
name|DTRACE_PRIV_USER
argument_list|,
name|NULL
argument_list|,
operator|&
name|dtnfsclient_pops
argument_list|,
name|NULL
argument_list|,
operator|&
name|dtnfsclient_id
argument_list|)
operator|!=
literal|0
condition|)
return|return;
name|dtrace_nfsclient_nfs23_start_probe
operator|=
operator|(
name|dtrace_nfsclient_nfs23_start_probe_func_t
operator|)
name|dtrace_probe
expr_stmt|;
name|dtrace_nfsclient_nfs23_done_probe
operator|=
operator|(
name|dtrace_nfsclient_nfs23_done_probe_func_t
operator|)
name|dtrace_probe
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|dtnfsclient_unload
parameter_list|()
block|{
name|int
name|error
init|=
literal|0
decl_stmt|;
name|dtrace_nfsclient_nfs23_start_probe
operator|=
name|NULL
expr_stmt|;
name|dtrace_nfsclient_nfs23_done_probe
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|dtrace_unregister
argument_list|(
name|dtnfsclient_id
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dtnfsclient_modevent
parameter_list|(
name|module_t
name|mod
name|__unused
parameter_list|,
name|int
name|type
parameter_list|,
name|void
modifier|*
name|data
name|__unused
parameter_list|)
block|{
name|int
name|error
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|MOD_LOAD
case|:
break|break;
case|case
name|MOD_UNLOAD
case|:
break|break;
case|case
name|MOD_SHUTDOWN
case|:
break|break;
default|default:
name|error
operator|=
name|EOPNOTSUPP
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_expr_stmt
name|SYSINIT
argument_list|(
name|dtnfsclient_load
argument_list|,
name|SI_SUB_DTRACE_PROVIDER
argument_list|,
name|SI_ORDER_ANY
argument_list|,
name|dtnfsclient_load
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|SYSUNINIT
argument_list|(
name|dtnfsclient_unload
argument_list|,
name|SI_SUB_DTRACE_PROVIDER
argument_list|,
name|SI_ORDER_ANY
argument_list|,
name|dtnfsclient_unload
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DEV_MODULE
argument_list|(
name|dtnfsclient
argument_list|,
name|dtnfsclient_modevent
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_VERSION
argument_list|(
name|dtnfsclient
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|dtnfsclient
argument_list|,
name|dtrace
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|dtnfsclient
argument_list|,
name|opensolaris
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|dtnfsclient
argument_list|,
name|nfs
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  *	from: unknown  *	$Id: tp_driver.c,v 1.4 1993/11/25 01:36:00 wollman Exp $  */
end_comment

begin_define
define|#
directive|define
name|_XEBEC_PG
value|static
end_define

begin_include
include|#
directive|include
file|"tp_states.h"
end_include

begin_struct
specifier|static
struct|struct
name|act_ent
block|{
name|int
name|a_newstate
decl_stmt|;
name|int
name|a_action
decl_stmt|;
block|}
name|statetable
index|[]
init|=
block|{
block|{
literal|0
block|,
literal|0
block|}
block|,
include|#
directive|include
file|"tp_states.init"
block|}
struct|;
end_struct

begin_comment
comment|/*	%W% (Berkeley) %G% */
end_comment

begin_include
include|#
directive|include
file|"param.h"
end_include

begin_include
include|#
directive|include
file|"systm.h"
end_include

begin_include
include|#
directive|include
file|"socket.h"
end_include

begin_include
include|#
directive|include
file|"socketvar.h"
end_include

begin_include
include|#
directive|include
file|"protosw.h"
end_include

begin_include
include|#
directive|include
file|"mbuf.h"
end_include

begin_include
include|#
directive|include
file|"time.h"
end_include

begin_include
include|#
directive|include
file|"errno.h"
end_include

begin_include
include|#
directive|include
file|"../netiso/tp_param.h"
end_include

begin_include
include|#
directive|include
file|"../netiso/tp_stat.h"
end_include

begin_include
include|#
directive|include
file|"../netiso/tp_pcb.h"
end_include

begin_include
include|#
directive|include
file|"../netiso/tp_tpdu.h"
end_include

begin_include
include|#
directive|include
file|"../netiso/argo_debug.h"
end_include

begin_include
include|#
directive|include
file|"../netiso/tp_trace.h"
end_include

begin_include
include|#
directive|include
file|"../netiso/iso_errno.h"
end_include

begin_include
include|#
directive|include
file|"../netiso/tp_seq.h"
end_include

begin_include
include|#
directive|include
file|"../netiso/cons.h"
end_include

begin_define
define|#
directive|define
name|DRIVERTRACE
value|TPPTdriver
end_define

begin_define
define|#
directive|define
name|sbwakeup
parameter_list|(
name|sb
parameter_list|)
value|sowakeup(p->tp_sock, sb);
end_define

begin_define
define|#
directive|define
name|MCPY
parameter_list|(
name|d
parameter_list|,
name|w
parameter_list|)
value|(d ? m_copym(d, 0, (int)M_COPYALL, w): 0)
end_define

begin_expr_stmt
specifier|static
name|trick_hc
operator|=
literal|1
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|tp_emit
argument_list|()
decl_stmt|,
name|tp_goodack
argument_list|()
decl_stmt|,
name|tp_goodXack
argument_list|()
decl_stmt|,
name|tp_stash
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|tp_indicate
argument_list|()
decl_stmt|,
name|tp_getoptions
argument_list|()
decl_stmt|,
name|tp_soisdisconnecting
argument_list|()
decl_stmt|,
name|tp_soisdisconnected
argument_list|()
decl_stmt|,
name|tp_recycle_tsuffix
argument_list|()
decl_stmt|,
name|tp_etimeout
argument_list|()
decl_stmt|,
name|tp_euntimeout
argument_list|()
decl_stmt|,
name|tp_euntimeout_lss
argument_list|()
decl_stmt|,
name|tp_ctimeout
argument_list|()
decl_stmt|,
name|tp_cuntimeout
argument_list|()
decl_stmt|,
name|tp_ctimeout_MIN
argument_list|()
decl_stmt|,
name|tp_freeref
argument_list|()
decl_stmt|,
name|tp_detach
argument_list|()
decl_stmt|,
name|tp0_stash
argument_list|()
decl_stmt|,
name|tp0_send
argument_list|()
decl_stmt|,
name|tp_netcmd
argument_list|()
decl_stmt|;
end_decl_stmt

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_typedef
typedef|typedef
name|struct
name|tp_pcb
name|tpcb_struct
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|tpcb_struct
name|tp_PCB_
typedef|;
end_typedef

begin_include
include|#
directive|include
file|"tp_events.h"
end_include

begin_function
name|_XEBEC_PG
name|int
name|_Xebec_action
parameter_list|(
name|a
parameter_list|,
name|e
parameter_list|,
name|p
parameter_list|)
name|int
name|a
decl_stmt|;
name|struct
name|tp_event
modifier|*
name|e
decl_stmt|;
name|tp_PCB_
modifier|*
name|p
decl_stmt|;
block|{
switch|switch
condition|(
name|a
condition|)
block|{
case|case
operator|-
literal|1
case|:
return|return
name|tp_protocol_error
argument_list|(
name|e
argument_list|,
name|p
argument_list|)
return|;
case|case
literal|0x1
case|:
block|{
operator|(
name|void
operator|)
name|tp_emit
argument_list|(
name|DC_TPDU_type
argument_list|,
name|p
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|MNULL
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|0x2
case|:
block|{
ifdef|#
directive|ifdef
name|TP_DEBUG
if|if
condition|(
name|e
operator|->
name|ev_number
operator|!=
name|AK_TPDU
condition|)
name|printf
argument_list|(
literal|"TPDU 0x%x in REFWAIT!!!!\n"
argument_list|,
name|e
operator|->
name|ev_number
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|TP_DEBUG
block|}
break|break;
case|case
literal|0x3
case|:
block|{
comment|/* oh, man is this grotesque or what? */
operator|(
name|void
operator|)
name|tp_goodack
argument_list|(
name|p
argument_list|,
name|e
operator|->
name|ev_union
operator|.
name|EV_AK_TPDU
operator|.
name|e_cdt
argument_list|,
name|e
operator|->
name|ev_union
operator|.
name|EV_AK_TPDU
operator|.
name|e_seq
argument_list|,
name|e
operator|->
name|ev_union
operator|.
name|EV_AK_TPDU
operator|.
name|e_subseq
argument_list|)
expr_stmt|;
comment|/* but it's necessary because this pseudo-ack may happen 		 * before the CC arrives, but we HAVE to adjust the 		 * snduna as a result of the ack, WHENEVER it arrives 		 */
block|}
break|break;
case|case
literal|0x4
case|:
block|{
name|tp_detach
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|0x5
case|:
block|{
name|p
operator|->
name|tp_refp
operator|->
name|tpr_state
operator|=
name|REF_OPEN
expr_stmt|;
comment|/* has timers ??? */
block|}
break|break;
case|case
literal|0x6
case|:
block|{
name|IFTRACE
argument_list|(
argument|D_CONN
argument_list|)
name|tptrace
argument_list|(
name|TPPTmisc
argument_list|,
literal|"CR datalen data"
argument_list|,
name|e
operator|->
name|ev_union
operator|.
name|EV_CR_TPDU
operator|.
name|e_datalen
argument_list|,
name|e
operator|->
name|ev_union
operator|.
name|EV_CR_TPDU
operator|.
name|e_data
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ENDTRACE
name|IFDEBUG
argument_list|(
name|D_CONN
argument_list|)
name|printf
argument_list|(
literal|"CR datalen 0x%x data 0x%x"
argument_list|,
name|e
operator|->
name|ev_union
operator|.
name|EV_CR_TPDU
operator|.
name|e_datalen
argument_list|,
name|e
operator|->
name|ev_union
operator|.
name|EV_CR_TPDU
operator|.
name|e_data
argument_list|)
decl_stmt|;
name|ENDDEBUG
name|p
operator|->
name|tp_refp
operator|->
name|tpr_state
init|=
name|REF_OPEN
decl_stmt|;
comment|/* has timers */
name|p
operator|->
name|tp_fcredit
operator|=
name|e
operator|->
name|ev_union
operator|.
name|EV_CR_TPDU
operator|.
name|e_cdt
expr_stmt|;
if|if
condition|(
name|e
operator|->
name|ev_union
operator|.
name|EV_CR_TPDU
operator|.
name|e_datalen
operator|>
literal|0
condition|)
block|{
comment|/* n/a for class 0 */
name|ASSERT
argument_list|(
name|p
operator|->
name|tp_Xrcv
operator|.
name|sb_cc
operator|==
literal|0
argument_list|)
expr_stmt|;
name|sbappendrecord
argument_list|(
operator|&
name|p
operator|->
name|tp_Xrcv
argument_list|,
name|e
operator|->
name|ev_union
operator|.
name|EV_CR_TPDU
operator|.
name|e_data
argument_list|)
expr_stmt|;
name|e
operator|->
name|ev_union
operator|.
name|EV_CR_TPDU
operator|.
name|e_data
operator|=
name|MNULL
expr_stmt|;
block|}
block|}
break|break;
case|case
literal|0x7
case|:
block|{
name|IncStat
argument_list|(
name|ts_tp0_conn
argument_list|)
expr_stmt|;
name|IFTRACE
argument_list|(
argument|D_CONN
argument_list|)
name|tptrace
argument_list|(
name|TPPTmisc
argument_list|,
literal|"Confiming"
argument_list|,
name|p
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ENDTRACE
name|IFDEBUG
argument_list|(
name|D_CONN
argument_list|)
name|printf
argument_list|(
literal|"Confirming connection: p"
argument_list|)
decl_stmt|;
name|ENDDEBUG
name|soisconnected
argument_list|(
name|p
operator|->
name|tp_sock
argument_list|)
decl_stmt|;
operator|(
name|void
operator|)
name|tp_emit
argument_list|(
name|CC_TPDU_type
argument_list|,
name|p
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|MNULL
argument_list|)
expr_stmt|;
name|p
operator|->
name|tp_fcredit
operator|=
literal|1
expr_stmt|;
block|}
break|break;
case|case
literal|0x8
case|:
block|{
name|IncStat
argument_list|(
name|ts_tp4_conn
argument_list|)
expr_stmt|;
comment|/* even though not quite open */
name|IFTRACE
argument_list|(
argument|D_CONN
argument_list|)
name|tptrace
argument_list|(
name|TPPTmisc
argument_list|,
literal|"Confiming"
argument_list|,
name|p
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ENDTRACE
name|IFDEBUG
argument_list|(
name|D_CONN
argument_list|)
name|printf
argument_list|(
literal|"Confirming connection: p"
argument_list|)
decl_stmt|;
name|ENDDEBUG
name|soisconnecting
argument_list|(
name|p
operator|->
name|tp_sock
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|p
operator|->
name|tp_rx_strat
operator|&
name|TPRX_FASTSTART
operator|)
operator|&&
operator|(
name|p
operator|->
name|tp_fcredit
operator|>
literal|0
operator|)
condition|)
name|p
operator|->
name|tp_cong_win
operator|=
name|p
operator|->
name|tp_fcredit
expr_stmt|;
name|p
operator|->
name|tp_retrans
operator|=
name|p
operator|->
name|tp_Nretrans
expr_stmt|;
name|tp_ctimeout
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_retrans
argument_list|,
operator|(
name|int
operator|)
name|p
operator|->
name|tp_cc_ticks
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|0x9
case|:
block|{
specifier|register
name|struct
name|tp_ref
modifier|*
name|r
init|=
name|p
operator|->
name|tp_refp
decl_stmt|;
name|IFDEBUG
argument_list|(
argument|D_CONN
argument_list|)
name|printf
argument_list|(
literal|"event: CR_TPDU emit CC failed done "
argument_list|)
expr_stmt|;
name|ENDDEBUG
name|soisdisconnected
argument_list|(
name|p
operator|->
name|tp_sock
argument_list|)
decl_stmt|;
name|tp_recycle_tsuffix
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|tp_freeref
argument_list|(
name|r
argument_list|)
expr_stmt|;
name|tp_detach
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|0xa
case|:
block|{
name|int
name|error
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|data
init|=
name|MNULL
decl_stmt|;
name|IFTRACE
argument_list|(
argument|D_CONN
argument_list|)
name|tptrace
argument_list|(
name|TPPTmisc
argument_list|,
literal|"T_CONN_req flags ucddata"
argument_list|,
operator|(
name|int
operator|)
name|p
operator|->
name|tp_flags
argument_list|,
name|p
operator|->
name|tp_ucddata
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ENDTRACE
name|data
init|=
name|MCPY
argument_list|(
name|p
operator|->
name|tp_ucddata
argument_list|,
name|M_WAIT
argument_list|)
decl_stmt|;
if|if
condition|(
name|data
condition|)
block|{
name|IFDEBUG
argument_list|(
argument|D_CONN
argument_list|)
name|printf
argument_list|(
literal|"T_CONN_req.trans m_copy cc 0x%x\n"
argument_list|,
name|p
operator|->
name|tp_ucddata
argument_list|)
expr_stmt|;
name|dump_mbuf
argument_list|(
name|data
argument_list|,
literal|"sosnd @ T_CONN_req"
argument_list|)
expr_stmt|;
name|ENDDEBUG
block|}
if|if
condition|(
name|error
operator|=
name|tp_emit
argument_list|(
name|CR_TPDU_type
argument_list|,
name|p
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|data
argument_list|)
condition|)
return|return
name|error
return|;
comment|/* driver WON'T change state; will return error */
name|p
operator|->
name|tp_refp
operator|->
name|tpr_state
operator|=
name|REF_OPEN
expr_stmt|;
comment|/* has timers */
if|if
condition|(
name|p
operator|->
name|tp_class
operator|!=
name|TP_CLASS_0
condition|)
block|{
name|p
operator|->
name|tp_retrans
operator|=
name|p
operator|->
name|tp_Nretrans
expr_stmt|;
name|tp_ctimeout
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_retrans
argument_list|,
operator|(
name|int
operator|)
name|p
operator|->
name|tp_cr_ticks
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
case|case
literal|0xb
case|:
block|{
name|sbflush
argument_list|(
operator|&
name|p
operator|->
name|tp_Xrcv
argument_list|)
expr_stmt|;
comment|/* purge non-delivered data data */
if|if
condition|(
name|e
operator|->
name|ev_union
operator|.
name|EV_DR_TPDU
operator|.
name|e_datalen
operator|>
literal|0
condition|)
block|{
name|sbappendrecord
argument_list|(
operator|&
name|p
operator|->
name|tp_Xrcv
argument_list|,
name|e
operator|->
name|ev_union
operator|.
name|EV_DR_TPDU
operator|.
name|e_data
argument_list|)
expr_stmt|;
name|e
operator|->
name|ev_union
operator|.
name|EV_DR_TPDU
operator|.
name|e_data
operator|=
name|MNULL
expr_stmt|;
block|}
comment|/* must return no error, or disc data and reason can't be read */
name|tp_indicate
argument_list|(
name|T_DISCONNECT
argument_list|,
name|p
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|tp_soisdisconnected
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|tp_class
operator|!=
name|TP_CLASS_0
condition|)
block|{
if|if
condition|(
name|p
operator|->
name|tp_state
operator|==
name|TP_OPEN
condition|)
block|{
name|tp_euntimeout
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_data_retrans
argument_list|)
expr_stmt|;
comment|/* all */
name|tp_cuntimeout
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_retrans
argument_list|)
expr_stmt|;
name|tp_cuntimeout
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_inact
argument_list|)
expr_stmt|;
name|tp_cuntimeout
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_sendack
argument_list|)
expr_stmt|;
block|}
name|tp_cuntimeout
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_retrans
argument_list|)
expr_stmt|;
if|if
condition|(
name|e
operator|->
name|ev_union
operator|.
name|EV_DR_TPDU
operator|.
name|e_sref
operator|!=
literal|0
condition|)
operator|(
name|void
operator|)
name|tp_emit
argument_list|(
name|DC_TPDU_type
argument_list|,
name|p
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|MNULL
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
case|case
literal|0xc
case|:
block|{
if|if
condition|(
name|e
operator|->
name|ev_union
operator|.
name|EV_DR_TPDU
operator|.
name|e_sref
operator|!=
literal|0
condition|)
operator|(
name|void
operator|)
name|tp_emit
argument_list|(
name|DC_TPDU_type
argument_list|,
name|p
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|MNULL
argument_list|)
expr_stmt|;
comment|/* reference timer already set - reset it to be safe (???) */
name|tp_euntimeout
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_reference
argument_list|)
expr_stmt|;
comment|/* all */
name|tp_etimeout
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_reference
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|(
name|int
operator|)
name|p
operator|->
name|tp_refer_ticks
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|0xd
case|:
block|{
name|tp_cuntimeout
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_retrans
argument_list|)
expr_stmt|;
name|tp_indicate
argument_list|(
name|ER_TPDU
argument_list|,
name|p
argument_list|,
name|e
operator|->
name|ev_union
operator|.
name|EV_ER_TPDU
operator|.
name|e_reason
argument_list|)
expr_stmt|;
name|tp_soisdisconnected
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|0xe
case|:
block|{
name|tp_cuntimeout
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_retrans
argument_list|)
expr_stmt|;
name|tp_soisdisconnected
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|0xf
case|:
block|{
name|tp_indicate
argument_list|(
name|ER_TPDU
argument_list|,
name|p
argument_list|,
name|e
operator|->
name|ev_union
operator|.
name|EV_ER_TPDU
operator|.
name|e_reason
argument_list|)
expr_stmt|;
name|tp_cuntimeout
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_retrans
argument_list|)
expr_stmt|;
name|tp_soisdisconnected
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|0x10
case|:
block|{
name|tp_cuntimeout
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_retrans
argument_list|)
expr_stmt|;
name|tp_soisdisconnected
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|0x11
case|:
block|{
comment|/* don't ask me why we have to do this - spec says so */
operator|(
name|void
operator|)
name|tp_emit
argument_list|(
name|DR_TPDU_type
argument_list|,
name|p
argument_list|,
literal|0
argument_list|,
name|E_TP_NO_SESSION
argument_list|,
name|MNULL
argument_list|)
expr_stmt|;
comment|/* don't bother with retransmissions of the DR */
block|}
break|break;
case|case
literal|0x12
case|:
block|{
name|tp_soisdisconnecting
argument_list|(
name|p
operator|->
name|tp_sock
argument_list|)
expr_stmt|;
name|tp_indicate
argument_list|(
name|ER_TPDU
argument_list|,
name|p
argument_list|,
name|e
operator|->
name|ev_union
operator|.
name|EV_ER_TPDU
operator|.
name|e_reason
argument_list|)
expr_stmt|;
name|tp_soisdisconnected
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|tp_netcmd
argument_list|(
name|p
argument_list|,
name|CONN_CLOSE
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|0x13
case|:
block|{
if|if
condition|(
name|p
operator|->
name|tp_state
operator|==
name|TP_OPEN
condition|)
block|{
name|tp_euntimeout
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_data_retrans
argument_list|)
expr_stmt|;
comment|/* all */
name|tp_cuntimeout
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_inact
argument_list|)
expr_stmt|;
name|tp_cuntimeout
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_sendack
argument_list|)
expr_stmt|;
block|}
name|tp_soisdisconnecting
argument_list|(
name|p
operator|->
name|tp_sock
argument_list|)
expr_stmt|;
name|tp_indicate
argument_list|(
name|ER_TPDU
argument_list|,
name|p
argument_list|,
name|e
operator|->
name|ev_union
operator|.
name|EV_ER_TPDU
operator|.
name|e_reason
argument_list|)
expr_stmt|;
name|p
operator|->
name|tp_retrans
operator|=
name|p
operator|->
name|tp_Nretrans
expr_stmt|;
name|tp_ctimeout
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_retrans
argument_list|,
operator|(
name|int
operator|)
name|p
operator|->
name|tp_dr_ticks
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|tp_emit
argument_list|(
name|DR_TPDU_type
argument_list|,
name|p
argument_list|,
literal|0
argument_list|,
name|E_TP_PROTO_ERR
argument_list|,
name|MNULL
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|0x14
case|:
block|{
name|tp_cuntimeout
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_retrans
argument_list|)
expr_stmt|;
name|IncStat
argument_list|(
name|ts_tp0_conn
argument_list|)
expr_stmt|;
name|p
operator|->
name|tp_fcredit
operator|=
literal|1
expr_stmt|;
name|soisconnected
argument_list|(
name|p
operator|->
name|tp_sock
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|0x15
case|:
block|{
name|IFDEBUG
argument_list|(
argument|D_CONN
argument_list|)
name|printf
argument_list|(
literal|"trans: CC_TPDU in CRSENT state flags 0x%x\n"
argument_list|,
operator|(
name|int
operator|)
name|p
operator|->
name|tp_flags
argument_list|)
expr_stmt|;
name|ENDDEBUG
name|IncStat
argument_list|(
name|ts_tp4_conn
argument_list|)
decl_stmt|;
name|p
operator|->
name|tp_fref
operator|=
name|e
operator|->
name|ev_union
operator|.
name|EV_CC_TPDU
operator|.
name|e_sref
expr_stmt|;
name|p
operator|->
name|tp_fcredit
operator|=
name|e
operator|->
name|ev_union
operator|.
name|EV_CC_TPDU
operator|.
name|e_cdt
expr_stmt|;
name|p
operator|->
name|tp_ackrcvd
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|p
operator|->
name|tp_rx_strat
operator|&
name|TPRX_FASTSTART
operator|)
operator|&&
operator|(
name|e
operator|->
name|ev_union
operator|.
name|EV_CC_TPDU
operator|.
name|e_cdt
operator|>
literal|0
operator|)
condition|)
name|p
operator|->
name|tp_cong_win
operator|=
name|e
operator|->
name|ev_union
operator|.
name|EV_CC_TPDU
operator|.
name|e_cdt
expr_stmt|;
name|tp_getoptions
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|tp_cuntimeout
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_retrans
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|tp_ucddata
condition|)
block|{
name|IFDEBUG
argument_list|(
argument|D_CONN
argument_list|)
name|printf
argument_list|(
literal|"dropping user connect data cc 0x%x\n"
argument_list|,
name|p
operator|->
name|tp_ucddata
operator|->
name|m_len
argument_list|)
expr_stmt|;
name|ENDDEBUG
name|m_freem
argument_list|(
name|p
operator|->
name|tp_ucddata
argument_list|)
decl_stmt|;
name|p
operator|->
name|tp_ucddata
operator|=
literal|0
expr_stmt|;
block|}
name|soisconnected
argument_list|(
name|p
operator|->
name|tp_sock
argument_list|)
expr_stmt|;
if|if
condition|(
name|e
operator|->
name|ev_union
operator|.
name|EV_CC_TPDU
operator|.
name|e_datalen
operator|>
literal|0
condition|)
block|{
name|ASSERT
argument_list|(
name|p
operator|->
name|tp_Xrcv
operator|.
name|sb_cc
operator|==
literal|0
argument_list|)
expr_stmt|;
comment|/* should be empty */
name|sbappendrecord
argument_list|(
operator|&
name|p
operator|->
name|tp_Xrcv
argument_list|,
name|e
operator|->
name|ev_union
operator|.
name|EV_CC_TPDU
operator|.
name|e_data
argument_list|)
expr_stmt|;
name|e
operator|->
name|ev_union
operator|.
name|EV_CC_TPDU
operator|.
name|e_data
operator|=
name|MNULL
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|tp_emit
argument_list|(
name|AK_TPDU_type
argument_list|,
name|p
argument_list|,
name|p
operator|->
name|tp_rcvnxt
argument_list|,
literal|0
argument_list|,
name|MNULL
argument_list|)
expr_stmt|;
name|tp_ctimeout
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_inact
argument_list|,
operator|(
name|int
operator|)
name|p
operator|->
name|tp_inact_ticks
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|0x16
case|:
block|{
name|struct
name|mbuf
modifier|*
name|data
init|=
name|MNULL
decl_stmt|;
name|int
name|error
decl_stmt|;
name|IncStat
argument_list|(
name|ts_retrans_cr
argument_list|)
expr_stmt|;
name|p
operator|->
name|tp_cong_win
operator|=
literal|1
expr_stmt|;
name|p
operator|->
name|tp_ackrcvd
operator|=
literal|0
expr_stmt|;
name|data
operator|=
name|MCPY
argument_list|(
name|p
operator|->
name|tp_ucddata
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|tp_ucddata
condition|)
block|{
name|IFDEBUG
argument_list|(
argument|D_CONN
argument_list|)
name|printf
argument_list|(
literal|"TM_retrans.trans m_copy cc 0x%x\n"
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|dump_mbuf
argument_list|(
name|p
operator|->
name|tp_ucddata
argument_list|,
literal|"sosnd @ TM_retrans"
argument_list|)
expr_stmt|;
name|ENDDEBUG
if|if
condition|(
name|data
operator|==
name|MNULL
condition|)
return|return
name|ENOBUFS
return|;
block|}
name|p
operator|->
name|tp_retrans
operator|--
expr_stmt|;
if|if
condition|(
name|error
operator|=
name|tp_emit
argument_list|(
name|CR_TPDU_type
argument_list|,
name|p
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|data
argument_list|)
condition|)
block|{
name|p
operator|->
name|tp_sock
operator|->
name|so_error
operator|=
name|error
expr_stmt|;
block|}
name|tp_ctimeout
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_retrans
argument_list|,
operator|(
name|int
operator|)
name|p
operator|->
name|tp_cr_ticks
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|0x17
case|:
block|{
name|IncStat
argument_list|(
name|ts_conn_gaveup
argument_list|)
expr_stmt|;
name|p
operator|->
name|tp_sock
operator|->
name|so_error
operator|=
name|ETIMEDOUT
expr_stmt|;
name|tp_indicate
argument_list|(
name|T_DISCONNECT
argument_list|,
name|p
argument_list|,
name|ETIMEDOUT
argument_list|)
expr_stmt|;
name|tp_soisdisconnected
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|0x18
case|:
block|{
name|int
name|error
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|data
init|=
name|MCPY
argument_list|(
name|p
operator|->
name|tp_ucddata
argument_list|,
name|M_WAIT
argument_list|)
decl_stmt|;
if|if
condition|(
name|error
operator|=
name|tp_emit
argument_list|(
name|CC_TPDU_type
argument_list|,
name|p
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|data
argument_list|)
condition|)
block|{
name|p
operator|->
name|tp_sock
operator|->
name|so_error
operator|=
name|error
expr_stmt|;
block|}
name|p
operator|->
name|tp_retrans
operator|=
name|p
operator|->
name|tp_Nretrans
expr_stmt|;
name|tp_ctimeout
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_retrans
argument_list|,
operator|(
name|int
operator|)
name|p
operator|->
name|tp_cc_ticks
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|0x19
case|:
block|{
name|int
name|doack
decl_stmt|;
comment|/* 		 * Get rid of any confirm or connect data, so that if we 		 * crash or close, it isn't thought of as disconnect data. 		 */
if|if
condition|(
name|p
operator|->
name|tp_ucddata
condition|)
block|{
name|m_freem
argument_list|(
name|p
operator|->
name|tp_ucddata
argument_list|)
expr_stmt|;
name|p
operator|->
name|tp_ucddata
operator|=
literal|0
expr_stmt|;
block|}
name|tp_ctimeout
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_inact
argument_list|,
operator|(
name|int
operator|)
name|p
operator|->
name|tp_inact_ticks
argument_list|)
expr_stmt|;
name|tp_cuntimeout
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_retrans
argument_list|)
expr_stmt|;
name|soisconnected
argument_list|(
name|p
operator|->
name|tp_sock
argument_list|)
expr_stmt|;
name|tp_getoptions
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|tp_ctimeout
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_inact
argument_list|,
operator|(
name|int
operator|)
name|p
operator|->
name|tp_inact_ticks
argument_list|)
expr_stmt|;
comment|/* see also next 2 transitions, if you make any changes */
name|doack
operator|=
name|tp_stash
argument_list|(
name|p
argument_list|,
name|e
argument_list|)
expr_stmt|;
name|IFDEBUG
argument_list|(
argument|D_DATA
argument_list|)
name|printf
argument_list|(
literal|"tp_stash returns %d\n"
argument_list|,
name|doack
argument_list|)
expr_stmt|;
name|ENDDEBUG
if|if
condition|(
name|doack
condition|)
block|{
operator|(
name|void
operator|)
name|tp_emit
argument_list|(
name|AK_TPDU_type
argument_list|,
name|p
argument_list|,
name|p
operator|->
name|tp_rcvnxt
argument_list|,
literal|0
argument_list|,
name|MNULL
argument_list|)
expr_stmt|;
name|tp_ctimeout
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_sendack
argument_list|,
operator|(
name|int
operator|)
name|p
operator|->
name|tp_keepalive_ticks
argument_list|)
expr_stmt|;
block|}
else|else
name|tp_ctimeout
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_sendack
argument_list|,
operator|(
name|int
operator|)
name|p
operator|->
name|tp_sendack_ticks
argument_list|)
expr_stmt|;
name|IFDEBUG
argument_list|(
argument|D_DATA
argument_list|)
name|printf
argument_list|(
literal|"after stash calling sbwakeup\n"
argument_list|)
expr_stmt|;
name|ENDDEBUG
block|}
break|break;
case|case
literal|0x1a
case|:
block|{
name|tp0_stash
argument_list|(
name|p
argument_list|,
name|e
argument_list|)
expr_stmt|;
name|sbwakeup
argument_list|(
operator|&
name|p
operator|->
name|tp_sock
operator|->
name|so_rcv
argument_list|)
expr_stmt|;
name|IFDEBUG
argument_list|(
argument|D_DATA
argument_list|)
name|printf
argument_list|(
literal|"after stash calling sbwakeup\n"
argument_list|)
expr_stmt|;
name|ENDDEBUG
block|}
break|break;
case|case
literal|0x1b
case|:
block|{
name|int
name|doack
decl_stmt|;
comment|/* tells if we must ack immediately */
name|tp_ctimeout
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_inact
argument_list|,
operator|(
name|int
operator|)
name|p
operator|->
name|tp_inact_ticks
argument_list|)
expr_stmt|;
name|sbwakeup
argument_list|(
operator|&
name|p
operator|->
name|tp_sock
operator|->
name|so_rcv
argument_list|)
expr_stmt|;
name|doack
operator|=
name|tp_stash
argument_list|(
name|p
argument_list|,
name|e
argument_list|)
expr_stmt|;
name|IFDEBUG
argument_list|(
argument|D_DATA
argument_list|)
name|printf
argument_list|(
literal|"tp_stash returns %d\n"
argument_list|,
name|doack
argument_list|)
expr_stmt|;
name|ENDDEBUG
if|if
condition|(
name|doack
condition|)
operator|(
name|void
operator|)
name|tp_emit
argument_list|(
name|AK_TPDU_type
argument_list|,
name|p
argument_list|,
name|p
operator|->
name|tp_rcvnxt
argument_list|,
literal|0
argument_list|,
name|MNULL
argument_list|)
expr_stmt|;
else|else
name|tp_ctimeout_MIN
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_sendack
argument_list|,
operator|(
name|int
operator|)
name|p
operator|->
name|tp_sendack_ticks
argument_list|)
expr_stmt|;
name|IFDEBUG
argument_list|(
argument|D_DATA
argument_list|)
name|printf
argument_list|(
literal|"after stash calling sbwakeup\n"
argument_list|)
expr_stmt|;
name|ENDDEBUG
block|}
break|break;
case|case
literal|0x1c
case|:
block|{
name|IFTRACE
argument_list|(
argument|D_DATA
argument_list|)
name|tptrace
argument_list|(
name|TPPTmisc
argument_list|,
literal|"NIW seq rcvnxt lcredit "
argument_list|,
name|e
operator|->
name|ev_union
operator|.
name|EV_DT_TPDU
operator|.
name|e_seq
argument_list|,
name|p
operator|->
name|tp_rcvnxt
argument_list|,
name|p
operator|->
name|tp_lcredit
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ENDTRACE
name|IncStat
argument_list|(
name|ts_dt_niw
argument_list|)
decl_stmt|;
name|m_freem
argument_list|(
name|e
operator|->
name|ev_union
operator|.
name|EV_DT_TPDU
operator|.
name|e_data
argument_list|)
expr_stmt|;
name|tp_ctimeout
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_inact
argument_list|,
operator|(
name|int
operator|)
name|p
operator|->
name|tp_inact_ticks
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|tp_emit
argument_list|(
name|AK_TPDU_type
argument_list|,
name|p
argument_list|,
name|p
operator|->
name|tp_rcvnxt
argument_list|,
literal|0
argument_list|,
name|MNULL
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|0x1d
case|:
block|{
if|if
condition|(
name|p
operator|->
name|tp_ucddata
condition|)
block|{
name|m_freem
argument_list|(
name|p
operator|->
name|tp_ucddata
argument_list|)
expr_stmt|;
name|p
operator|->
name|tp_ucddata
operator|=
literal|0
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|tp_goodack
argument_list|(
name|p
argument_list|,
name|e
operator|->
name|ev_union
operator|.
name|EV_AK_TPDU
operator|.
name|e_cdt
argument_list|,
name|e
operator|->
name|ev_union
operator|.
name|EV_AK_TPDU
operator|.
name|e_seq
argument_list|,
name|e
operator|->
name|ev_union
operator|.
name|EV_AK_TPDU
operator|.
name|e_subseq
argument_list|)
expr_stmt|;
name|tp_cuntimeout
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_retrans
argument_list|)
expr_stmt|;
name|tp_getoptions
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|soisconnected
argument_list|(
name|p
operator|->
name|tp_sock
argument_list|)
expr_stmt|;
name|IFTRACE
argument_list|(
argument|D_CONN
argument_list|)
name|struct
name|socket
modifier|*
name|so
init|=
name|p
operator|->
name|tp_sock
decl_stmt|;
name|tptrace
argument_list|(
name|TPPTmisc
argument_list|,
literal|"called sosiconn: so so_state rcv.sb_sel rcv.sb_flags"
argument_list|,
name|so
argument_list|,
name|so
operator|->
name|so_state
argument_list|,
name|so
operator|->
name|so_rcv
operator|.
name|sb_sel
argument_list|,
name|so
operator|->
name|so_rcv
operator|.
name|sb_flags
argument_list|)
expr_stmt|;
name|tptrace
argument_list|(
name|TPPTmisc
argument_list|,
literal|"called sosiconn 2: so_qlen so_error so_rcv.sb_cc so_head"
argument_list|,
name|so
operator|->
name|so_qlen
argument_list|,
name|so
operator|->
name|so_error
argument_list|,
name|so
operator|->
name|so_rcv
operator|.
name|sb_cc
argument_list|,
name|so
operator|->
name|so_head
argument_list|)
expr_stmt|;
name|ENDTRACE
name|tp_ctimeout
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_sendack
argument_list|,
operator|(
name|int
operator|)
name|p
operator|->
name|tp_keepalive_ticks
argument_list|)
decl_stmt|;
name|tp_ctimeout
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_inact
argument_list|,
operator|(
name|int
operator|)
name|p
operator|->
name|tp_inact_ticks
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|0x1e
case|:
block|{
if|if
condition|(
name|p
operator|->
name|tp_state
operator|==
name|TP_AKWAIT
condition|)
block|{
if|if
condition|(
name|p
operator|->
name|tp_ucddata
condition|)
block|{
name|m_freem
argument_list|(
name|p
operator|->
name|tp_ucddata
argument_list|)
expr_stmt|;
name|p
operator|->
name|tp_ucddata
operator|=
literal|0
expr_stmt|;
block|}
name|tp_cuntimeout
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_retrans
argument_list|)
expr_stmt|;
name|tp_getoptions
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|soisconnected
argument_list|(
name|p
operator|->
name|tp_sock
argument_list|)
expr_stmt|;
name|tp_ctimeout
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_sendack
argument_list|,
operator|(
name|int
operator|)
name|p
operator|->
name|tp_keepalive_ticks
argument_list|)
expr_stmt|;
name|tp_ctimeout
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_inact
argument_list|,
operator|(
name|int
operator|)
name|p
operator|->
name|tp_inact_ticks
argument_list|)
expr_stmt|;
block|}
name|IFTRACE
argument_list|(
argument|D_XPD
argument_list|)
name|tptrace
argument_list|(
name|TPPTmisc
argument_list|,
literal|"XPD tpdu accepted Xrcvnxt, e_seq datalen m_len\n"
argument_list|,
name|p
operator|->
name|tp_Xrcvnxt
argument_list|,
name|e
operator|->
name|ev_union
operator|.
name|EV_XPD_TPDU
operator|.
name|e_seq
argument_list|,
name|e
operator|->
name|ev_union
operator|.
name|EV_XPD_TPDU
operator|.
name|e_datalen
argument_list|,
name|e
operator|->
name|ev_union
operator|.
name|EV_XPD_TPDU
operator|.
name|e_data
operator|->
name|m_len
argument_list|)
expr_stmt|;
name|ENDTRACE
name|p
operator|->
name|tp_sock
operator|->
name|so_state
operator||=
name|SS_RCVATMARK
expr_stmt|;
name|e
operator|->
name|ev_union
operator|.
name|EV_XPD_TPDU
operator|.
name|e_data
operator|->
name|m_flags
operator||=
name|M_EOR
expr_stmt|;
name|sbinsertoob
argument_list|(
operator|&
name|p
operator|->
name|tp_Xrcv
argument_list|,
name|e
operator|->
name|ev_union
operator|.
name|EV_XPD_TPDU
operator|.
name|e_data
argument_list|)
expr_stmt|;
name|IFDEBUG
argument_list|(
argument|D_XPD
argument_list|)
name|dump_mbuf
argument_list|(
name|e
operator|->
name|ev_union
operator|.
name|EV_XPD_TPDU
operator|.
name|e_data
argument_list|,
literal|"XPD TPDU: tp_Xrcv"
argument_list|)
expr_stmt|;
name|ENDDEBUG
name|tp_indicate
argument_list|(
name|T_XDATA
argument_list|,
name|p
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|sbwakeup
argument_list|(
operator|&
name|p
operator|->
name|tp_Xrcv
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|tp_emit
argument_list|(
name|XAK_TPDU_type
argument_list|,
name|p
argument_list|,
name|p
operator|->
name|tp_Xrcvnxt
argument_list|,
literal|0
argument_list|,
name|MNULL
argument_list|)
expr_stmt|;
name|SEQ_INC
argument_list|(
name|p
argument_list|,
name|p
operator|->
name|tp_Xrcvnxt
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|0x1f
case|:
block|{
if|if
condition|(
name|p
operator|->
name|tp_Xrcv
operator|.
name|sb_cc
operator|==
literal|0
condition|)
block|{
comment|/* kludge for select(): */
comment|/* p->tp_sock->so_state&= ~SS_OOBAVAIL; */
block|}
block|}
break|break;
case|case
literal|0x20
case|:
block|{
name|IFTRACE
argument_list|(
argument|D_XPD
argument_list|)
name|tptrace
argument_list|(
name|TPPTmisc
argument_list|,
literal|"XPD tpdu niw (Xrcvnxt, e_seq) or not cdt (cc)\n"
argument_list|,
name|p
operator|->
name|tp_Xrcvnxt
argument_list|,
name|e
operator|->
name|ev_union
operator|.
name|EV_XPD_TPDU
operator|.
name|e_seq
argument_list|,
name|p
operator|->
name|tp_Xrcv
operator|.
name|sb_cc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ENDTRACE
if|if
condition|(
name|p
operator|->
name|tp_Xrcvnxt
operator|!=
name|e
operator|->
name|ev_union
operator|.
name|EV_XPD_TPDU
operator|.
name|e_seq
condition|)
name|IncStat
argument_list|(
name|ts_xpd_niw
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|tp_Xrcv
operator|.
name|sb_cc
condition|)
block|{
comment|/* might as well kick 'em again */
name|tp_indicate
argument_list|(
name|T_XDATA
argument_list|,
name|p
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|IncStat
argument_list|(
name|ts_xpd_dup
argument_list|)
expr_stmt|;
block|}
name|m_freem
argument_list|(
name|e
operator|->
name|ev_union
operator|.
name|EV_XPD_TPDU
operator|.
name|e_data
argument_list|)
expr_stmt|;
name|tp_ctimeout
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_inact
argument_list|,
operator|(
name|int
operator|)
name|p
operator|->
name|tp_inact_ticks
argument_list|)
expr_stmt|;
comment|/* don't send an xack because the xak gives "last one received", not 		 * "next one i expect" (dumb) 		 */
block|}
break|break;
case|case
literal|0x21
case|:
block|{
name|struct
name|socket
modifier|*
name|so
init|=
name|p
operator|->
name|tp_sock
decl_stmt|;
comment|/* detach from parent socket so it can finish closing */
if|if
condition|(
name|so
operator|->
name|so_head
condition|)
block|{
if|if
condition|(
operator|!
name|soqremque
argument_list|(
name|so
argument_list|,
literal|0
argument_list|)
operator|&&
operator|!
name|soqremque
argument_list|(
name|so
argument_list|,
literal|1
argument_list|)
condition|)
name|panic
argument_list|(
literal|"tp: T_DETACH"
argument_list|)
expr_stmt|;
name|so
operator|->
name|so_head
operator|=
literal|0
expr_stmt|;
block|}
name|tp_soisdisconnecting
argument_list|(
name|p
operator|->
name|tp_sock
argument_list|)
expr_stmt|;
name|tp_netcmd
argument_list|(
name|p
argument_list|,
name|CONN_CLOSE
argument_list|)
expr_stmt|;
name|tp_soisdisconnected
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|0x22
case|:
block|{
name|struct
name|socket
modifier|*
name|so
init|=
name|p
operator|->
name|tp_sock
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|data
init|=
name|MNULL
decl_stmt|;
comment|/* detach from parent socket so it can finish closing */
if|if
condition|(
name|so
operator|->
name|so_head
condition|)
block|{
if|if
condition|(
operator|!
name|soqremque
argument_list|(
name|so
argument_list|,
literal|0
argument_list|)
operator|&&
operator|!
name|soqremque
argument_list|(
name|so
argument_list|,
literal|1
argument_list|)
condition|)
name|panic
argument_list|(
literal|"tp: T_DETACH"
argument_list|)
expr_stmt|;
name|so
operator|->
name|so_head
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|p
operator|->
name|tp_state
operator|!=
name|TP_CLOSING
condition|)
block|{
name|tp_soisdisconnecting
argument_list|(
name|p
operator|->
name|tp_sock
argument_list|)
expr_stmt|;
name|data
operator|=
name|MCPY
argument_list|(
name|p
operator|->
name|tp_ucddata
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|tp_emit
argument_list|(
name|DR_TPDU_type
argument_list|,
name|p
argument_list|,
literal|0
argument_list|,
name|E_TP_NORMAL_DISC
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|p
operator|->
name|tp_retrans
operator|=
name|p
operator|->
name|tp_Nretrans
expr_stmt|;
name|tp_ctimeout
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_retrans
argument_list|,
operator|(
name|int
operator|)
name|p
operator|->
name|tp_dr_ticks
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
case|case
literal|0x23
case|:
block|{
name|tp_soisdisconnecting
argument_list|(
name|p
operator|->
name|tp_sock
argument_list|)
expr_stmt|;
name|tp_netcmd
argument_list|(
name|p
argument_list|,
name|CONN_CLOSE
argument_list|)
expr_stmt|;
name|tp_soisdisconnected
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|0x24
case|:
block|{
name|struct
name|mbuf
modifier|*
name|data
init|=
name|MCPY
argument_list|(
name|p
operator|->
name|tp_ucddata
argument_list|,
name|M_WAIT
argument_list|)
decl_stmt|;
if|if
condition|(
name|p
operator|->
name|tp_state
operator|==
name|TP_OPEN
condition|)
block|{
name|tp_euntimeout
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_data_retrans
argument_list|)
expr_stmt|;
comment|/* all */
name|tp_cuntimeout
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_inact
argument_list|)
expr_stmt|;
name|tp_cuntimeout
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_sendack
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|data
condition|)
block|{
name|IFDEBUG
argument_list|(
argument|D_CONN
argument_list|)
name|printf
argument_list|(
literal|"T_DISC_req.trans tp_ucddata 0x%x\n"
argument_list|,
name|p
operator|->
name|tp_ucddata
argument_list|)
expr_stmt|;
name|dump_mbuf
argument_list|(
name|data
argument_list|,
literal|"ucddata @ T_DISC_req"
argument_list|)
expr_stmt|;
name|ENDDEBUG
block|}
name|tp_soisdisconnecting
argument_list|(
name|p
operator|->
name|tp_sock
argument_list|)
expr_stmt|;
name|p
operator|->
name|tp_retrans
operator|=
name|p
operator|->
name|tp_Nretrans
expr_stmt|;
name|tp_ctimeout
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_retrans
argument_list|,
operator|(
name|int
operator|)
name|p
operator|->
name|tp_dr_ticks
argument_list|)
expr_stmt|;
if|if
condition|(
name|trick_hc
condition|)
return|return
name|tp_emit
argument_list|(
name|DR_TPDU_type
argument_list|,
name|p
argument_list|,
literal|0
argument_list|,
name|e
operator|->
name|ev_union
operator|.
name|EV_T_DISC_req
operator|.
name|e_reason
argument_list|,
name|data
argument_list|)
return|;
block|}
break|break;
case|case
literal|0x25
case|:
block|{
name|int
name|error
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|data
init|=
name|MCPY
argument_list|(
name|p
operator|->
name|tp_ucddata
argument_list|,
name|M_WAIT
argument_list|)
decl_stmt|;
name|IncStat
argument_list|(
name|ts_retrans_cc
argument_list|)
expr_stmt|;
name|p
operator|->
name|tp_retrans
operator|--
expr_stmt|;
name|p
operator|->
name|tp_cong_win
operator|=
literal|1
expr_stmt|;
name|p
operator|->
name|tp_ackrcvd
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|error
operator|=
name|tp_emit
argument_list|(
name|CC_TPDU_type
argument_list|,
name|p
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|data
argument_list|)
condition|)
name|p
operator|->
name|tp_sock
operator|->
name|so_error
operator|=
name|error
expr_stmt|;
name|tp_ctimeout
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_retrans
argument_list|,
operator|(
name|int
operator|)
name|p
operator|->
name|tp_cc_ticks
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|0x26
case|:
block|{
name|IncStat
argument_list|(
name|ts_conn_gaveup
argument_list|)
expr_stmt|;
name|tp_soisdisconnecting
argument_list|(
name|p
operator|->
name|tp_sock
argument_list|)
expr_stmt|;
name|p
operator|->
name|tp_sock
operator|->
name|so_error
operator|=
name|ETIMEDOUT
expr_stmt|;
name|tp_indicate
argument_list|(
name|T_DISCONNECT
argument_list|,
name|p
argument_list|,
name|ETIMEDOUT
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|tp_emit
argument_list|(
name|DR_TPDU_type
argument_list|,
name|p
argument_list|,
literal|0
argument_list|,
name|E_TP_CONGEST
argument_list|,
name|MNULL
argument_list|)
expr_stmt|;
name|p
operator|->
name|tp_retrans
operator|=
name|p
operator|->
name|tp_Nretrans
expr_stmt|;
name|tp_ctimeout
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_retrans
argument_list|,
operator|(
name|int
operator|)
name|p
operator|->
name|tp_dr_ticks
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|0x27
case|:
block|{
name|tp_euntimeout
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_data_retrans
argument_list|)
expr_stmt|;
comment|/* all */
name|tp_cuntimeout
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_inact
argument_list|)
expr_stmt|;
name|tp_cuntimeout
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_sendack
argument_list|)
expr_stmt|;
name|IncStat
argument_list|(
name|ts_conn_gaveup
argument_list|)
expr_stmt|;
name|tp_soisdisconnecting
argument_list|(
name|p
operator|->
name|tp_sock
argument_list|)
expr_stmt|;
name|p
operator|->
name|tp_sock
operator|->
name|so_error
operator|=
name|ETIMEDOUT
expr_stmt|;
name|tp_indicate
argument_list|(
name|T_DISCONNECT
argument_list|,
name|p
argument_list|,
name|ETIMEDOUT
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|tp_emit
argument_list|(
name|DR_TPDU_type
argument_list|,
name|p
argument_list|,
literal|0
argument_list|,
name|E_TP_CONGEST_2
argument_list|,
name|MNULL
argument_list|)
expr_stmt|;
name|p
operator|->
name|tp_retrans
operator|=
name|p
operator|->
name|tp_Nretrans
expr_stmt|;
name|tp_ctimeout
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_retrans
argument_list|,
operator|(
name|int
operator|)
name|p
operator|->
name|tp_dr_ticks
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|0x28
case|:
block|{
name|p
operator|->
name|tp_cong_win
operator|=
literal|1
expr_stmt|;
name|p
operator|->
name|tp_ackrcvd
operator|=
literal|0
expr_stmt|;
comment|/* resume XPD */
if|if
condition|(
name|p
operator|->
name|tp_Xsnd
operator|.
name|sb_mb
condition|)
block|{
name|struct
name|mbuf
modifier|*
name|m
init|=
name|m_copy
argument_list|(
name|p
operator|->
name|tp_Xsnd
operator|.
name|sb_mb
argument_list|,
literal|0
argument_list|,
operator|(
name|int
operator|)
name|p
operator|->
name|tp_Xsnd
operator|.
name|sb_cc
argument_list|)
decl_stmt|;
comment|/* m_copy doesn't preserve the m_xlink field, but at this pt. 			 * that doesn't matter 			 */
name|IFTRACE
argument_list|(
argument|D_XPD
argument_list|)
name|tptrace
argument_list|(
name|TPPTmisc
argument_list|,
literal|"XPD retrans: Xuna Xsndnxt sndhiwat snduna"
argument_list|,
name|p
operator|->
name|tp_Xuna
argument_list|,
name|p
operator|->
name|tp_Xsndnxt
argument_list|,
name|p
operator|->
name|tp_sndhiwat
argument_list|,
name|p
operator|->
name|tp_snduna
argument_list|)
expr_stmt|;
name|ENDTRACE
name|IFDEBUG
argument_list|(
name|D_XPD
argument_list|)
name|dump_mbuf
argument_list|(
name|m
argument_list|,
literal|"XPD retrans emitting M"
argument_list|)
decl_stmt|;
name|ENDDEBUG
name|IncStat
argument_list|(
name|ts_retrans_xpd
argument_list|)
decl_stmt|;
name|p
operator|->
name|tp_retrans
operator|--
expr_stmt|;
operator|(
name|void
operator|)
name|tp_emit
argument_list|(
name|XPD_TPDU_type
argument_list|,
name|p
argument_list|,
name|p
operator|->
name|tp_Xuna
argument_list|,
literal|1
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|tp_ctimeout
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_retrans
argument_list|,
operator|(
name|int
operator|)
name|p
operator|->
name|tp_xpd_ticks
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
case|case
literal|0x29
case|:
block|{
specifier|register
name|SeqNum
name|low
decl_stmt|,
name|lowsave
init|=
literal|0
decl_stmt|;
specifier|register
name|struct
name|tp_rtc
modifier|*
name|r
init|=
name|p
operator|->
name|tp_snduna_rtc
decl_stmt|;
specifier|register
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
specifier|register
name|SeqNum
name|high
init|=
name|e
operator|->
name|ev_union
operator|.
name|EV_TM_data_retrans
operator|.
name|e_high
decl_stmt|;
name|low
operator|=
name|p
operator|->
name|tp_snduna
expr_stmt|;
name|lowsave
operator|=
name|high
operator|=
name|low
expr_stmt|;
name|tp_euntimeout_lss
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_data_retrans
argument_list|,
name|SEQ_ADD
argument_list|(
name|p
argument_list|,
name|p
operator|->
name|tp_sndhiwat
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|p
operator|->
name|tp_retrans_hiwat
operator|=
name|p
operator|->
name|tp_sndhiwat
expr_stmt|;
if|if
condition|(
operator|(
name|p
operator|->
name|tp_rx_strat
operator|&
name|TPRX_EACH
operator|)
operator|==
literal|0
condition|)
name|high
operator|=
operator|(
name|high
operator|>
name|low
operator|)
condition|?
name|low
else|:
name|high
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|tp_rx_strat
operator|&
name|TPRX_USE_CW
condition|)
block|{
specifier|register
name|int
name|i
decl_stmt|;
name|p
operator|->
name|tp_cong_win
operator|=
literal|1
expr_stmt|;
name|p
operator|->
name|tp_ackrcvd
operator|=
literal|0
expr_stmt|;
name|i
operator|=
name|SEQ_ADD
argument_list|(
name|p
argument_list|,
name|low
argument_list|,
name|p
operator|->
name|tp_cong_win
argument_list|)
expr_stmt|;
name|high
operator|=
name|SEQ_MIN
argument_list|(
name|p
argument_list|,
name|high
argument_list|,
name|p
operator|->
name|tp_sndhiwat
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
name|SEQ_LEQ
argument_list|(
name|p
argument_list|,
name|low
argument_list|,
name|high
argument_list|)
condition|)
block|{
if|if
condition|(
name|r
operator|==
operator|(
expr|struct
name|tp_rtc
operator|*
operator|)
literal|0
condition|)
block|{
name|IFDEBUG
argument_list|(
argument|D_RTC
argument_list|)
name|printf
argument_list|(
literal|"tp: retrans rtc list is GONE!\n"
argument_list|)
expr_stmt|;
name|ENDDEBUG
break|break;
block|}
if|if
condition|(
name|r
operator|->
name|tprt_seq
operator|==
name|low
condition|)
block|{
if|if
condition|(
operator|(
name|m
operator|=
name|m_copy
argument_list|(
name|r
operator|->
name|tprt_data
argument_list|,
literal|0
argument_list|,
name|r
operator|->
name|tprt_octets
argument_list|)
operator|)
operator|==
name|MNULL
condition|)
break|break;
operator|(
name|void
operator|)
name|tp_emit
argument_list|(
name|DT_TPDU_type
argument_list|,
name|p
argument_list|,
name|low
argument_list|,
name|r
operator|->
name|tprt_eot
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|IncStat
argument_list|(
name|ts_retrans_dt
argument_list|)
expr_stmt|;
name|SEQ_INC
argument_list|(
name|p
argument_list|,
name|low
argument_list|)
expr_stmt|;
block|}
name|r
operator|=
name|r
operator|->
name|tprt_next
expr_stmt|;
block|}
comment|/* CE_BIT 		if ( SEQ_LEQ(p, lowsave, high) ){ */
name|e
operator|->
name|ev_union
operator|.
name|EV_TM_data_retrans
operator|.
name|e_retrans
operator|--
expr_stmt|;
name|tp_etimeout
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_data_retrans
argument_list|,
operator|(
name|caddr_t
operator|)
name|lowsave
argument_list|,
operator|(
name|caddr_t
operator|)
name|high
argument_list|,
name|e
operator|->
name|ev_union
operator|.
name|EV_TM_data_retrans
operator|.
name|e_retrans
argument_list|,
operator|(
name|p
operator|->
name|tp_Nretrans
operator|-
name|e
operator|->
name|ev_union
operator|.
name|EV_TM_data_retrans
operator|.
name|e_retrans
operator|)
operator|*
operator|(
name|int
operator|)
name|p
operator|->
name|tp_dt_ticks
argument_list|)
expr_stmt|;
comment|/* CE_BIT 		} */
block|}
break|break;
case|case
literal|0x2a
case|:
block|{
name|p
operator|->
name|tp_retrans
operator|--
expr_stmt|;
operator|(
name|void
operator|)
name|tp_emit
argument_list|(
name|DR_TPDU_type
argument_list|,
name|p
argument_list|,
literal|0
argument_list|,
name|E_TP_DR_NO_REAS
argument_list|,
name|MNULL
argument_list|)
expr_stmt|;
name|IncStat
argument_list|(
name|ts_retrans_dr
argument_list|)
expr_stmt|;
name|tp_ctimeout
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_retrans
argument_list|,
operator|(
name|int
operator|)
name|p
operator|->
name|tp_dr_ticks
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|0x2b
case|:
block|{
name|p
operator|->
name|tp_sock
operator|->
name|so_error
operator|=
name|ETIMEDOUT
expr_stmt|;
name|p
operator|->
name|tp_refp
operator|->
name|tpr_state
operator|=
name|REF_FROZEN
expr_stmt|;
name|tp_recycle_tsuffix
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|tp_etimeout
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_reference
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|(
name|int
operator|)
name|p
operator|->
name|tp_refer_ticks
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|0x2c
case|:
block|{
name|tp_freeref
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|)
expr_stmt|;
name|tp_detach
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|0x2d
case|:
block|{
if|if
condition|(
name|p
operator|->
name|tp_class
operator|!=
name|TP_CLASS_0
condition|)
block|{
name|tp_ctimeout
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_inact
argument_list|,
operator|(
name|int
operator|)
name|p
operator|->
name|tp_inact_ticks
argument_list|)
expr_stmt|;
if|if
condition|(
name|e
operator|->
name|ev_number
operator|==
name|CC_TPDU
condition|)
operator|(
name|void
operator|)
name|tp_emit
argument_list|(
name|AK_TPDU_type
argument_list|,
name|p
argument_list|,
name|p
operator|->
name|tp_rcvnxt
argument_list|,
literal|0
argument_list|,
name|MNULL
argument_list|)
expr_stmt|;
block|}
comment|/* ignore it if class 0 - state tables are blank for this */
block|}
break|break;
case|case
literal|0x2e
case|:
block|{
name|IFTRACE
argument_list|(
argument|D_DATA
argument_list|)
name|tptrace
argument_list|(
name|TPPTmisc
argument_list|,
literal|"T_DATA_req sndhiwat snduna fcredit, tpcb"
argument_list|,
name|p
operator|->
name|tp_sndhiwat
argument_list|,
name|p
operator|->
name|tp_snduna
argument_list|,
name|p
operator|->
name|tp_fcredit
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|ENDTRACE
name|tp_send
argument_list|(
name|p
argument_list|)
decl_stmt|;
block|}
break|break;
case|case
literal|0x2f
case|:
block|{
name|int
name|error
init|=
literal|0
decl_stmt|;
comment|/* resume XPD */
if|if
condition|(
name|p
operator|->
name|tp_Xsnd
operator|.
name|sb_mb
condition|)
block|{
name|struct
name|mbuf
modifier|*
name|m
init|=
name|m_copy
argument_list|(
name|p
operator|->
name|tp_Xsnd
operator|.
name|sb_mb
argument_list|,
literal|0
argument_list|,
operator|(
name|int
operator|)
name|p
operator|->
name|tp_Xsnd
operator|.
name|sb_cc
argument_list|)
decl_stmt|;
comment|/* m_copy doesn't preserve the m_xlink field, but at this pt. 			 * that doesn't matter 			 */
name|IFTRACE
argument_list|(
argument|D_XPD
argument_list|)
name|tptrace
argument_list|(
name|TPPTmisc
argument_list|,
literal|"XPD req: Xuna Xsndnxt sndhiwat snduna"
argument_list|,
name|p
operator|->
name|tp_Xuna
argument_list|,
name|p
operator|->
name|tp_Xsndnxt
argument_list|,
name|p
operator|->
name|tp_sndhiwat
argument_list|,
name|p
operator|->
name|tp_snduna
argument_list|)
expr_stmt|;
name|ENDTRACE
name|IFDEBUG
argument_list|(
name|D_XPD
argument_list|)
name|printf
argument_list|(
literal|"T_XPD_req: sb_cc 0x%x\n"
argument_list|,
name|p
operator|->
name|tp_Xsnd
operator|.
name|sb_cc
argument_list|)
decl_stmt|;
name|dump_mbuf
argument_list|(
name|m
argument_list|,
literal|"XPD req emitting M"
argument_list|)
expr_stmt|;
name|ENDDEBUG
name|error
init|=
name|tp_emit
argument_list|(
name|XPD_TPDU_type
argument_list|,
name|p
argument_list|,
name|p
operator|->
name|tp_Xuna
argument_list|,
literal|1
argument_list|,
name|m
argument_list|)
decl_stmt|;
name|p
operator|->
name|tp_retrans
operator|=
name|p
operator|->
name|tp_Nretrans
expr_stmt|;
name|tp_ctimeout
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_retrans
argument_list|,
operator|(
name|int
operator|)
name|p
operator|->
name|tp_xpd_ticks
argument_list|)
expr_stmt|;
name|SEQ_INC
argument_list|(
name|p
argument_list|,
name|p
operator|->
name|tp_Xsndnxt
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|trick_hc
condition|)
return|return
name|error
return|;
block|}
break|break;
case|case
literal|0x30
case|:
block|{
name|IFDEBUG
argument_list|(
argument|D_ACKRECV
argument_list|)
name|printf
argument_list|(
literal|"GOOD ACK seq 0x%x cdt 0x%x\n"
argument_list|,
name|e
operator|->
name|ev_union
operator|.
name|EV_AK_TPDU
operator|.
name|e_seq
argument_list|,
name|e
operator|->
name|ev_union
operator|.
name|EV_AK_TPDU
operator|.
name|e_cdt
argument_list|)
expr_stmt|;
name|ENDDEBUG
if|if
condition|(
name|p
operator|->
name|tp_class
operator|!=
name|TP_CLASS_0
condition|)
block|{
name|tp_ctimeout
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_inact
argument_list|,
operator|(
name|int
operator|)
name|p
operator|->
name|tp_inact_ticks
argument_list|)
expr_stmt|;
name|tp_euntimeout_lss
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_data_retrans
argument_list|,
name|e
operator|->
name|ev_union
operator|.
name|EV_AK_TPDU
operator|.
name|e_seq
argument_list|)
expr_stmt|;
block|}
name|sbwakeup
argument_list|(
operator|&
name|p
operator|->
name|tp_sock
operator|->
name|so_snd
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|tp_sndhiwat
operator|<=
name|p
operator|->
name|tp_retrans_hiwat
operator|&&
name|p
operator|->
name|tp_snduna
operator|<=
name|p
operator|->
name|tp_retrans_hiwat
condition|)
block|{
specifier|register
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
comment|/* extern      struct mbuf     *m_copy(); */
specifier|register
name|struct
name|tp_rtc
modifier|*
name|r
decl_stmt|;
name|SeqNum
name|high
decl_stmt|,
name|retrans
decl_stmt|,
name|low_save
decl_stmt|;
name|high
operator|=
name|SEQ_MIN
argument_list|(
name|p
argument_list|,
name|SEQ_ADD
argument_list|(
name|p
argument_list|,
name|p
operator|->
name|tp_snduna
argument_list|,
name|MIN
argument_list|(
name|p
operator|->
name|tp_cong_win
argument_list|,
name|p
operator|->
name|tp_fcredit
argument_list|)
argument_list|)
operator|-
literal|1
argument_list|,
name|p
operator|->
name|tp_sndhiwat
argument_list|)
expr_stmt|;
name|low_save
operator|=
name|retrans
operator|=
name|SEQ_MAX
argument_list|(
name|p
argument_list|,
name|SEQ_ADD
argument_list|(
name|p
argument_list|,
name|p
operator|->
name|tp_last_retrans
argument_list|,
literal|1
argument_list|)
argument_list|,
name|p
operator|->
name|tp_snduna
argument_list|)
expr_stmt|;
for|for
control|(
init|;
name|SEQ_LEQ
argument_list|(
name|p
argument_list|,
name|retrans
argument_list|,
name|high
argument_list|)
condition|;
name|SEQ_INC
argument_list|(
name|p
argument_list|,
name|retrans
argument_list|)
control|)
block|{
for|for
control|(
name|r
operator|=
name|p
operator|->
name|tp_snduna_rtc
init|;
name|r
condition|;
name|r
operator|=
name|r
operator|->
name|tprt_next
control|)
block|{
if|if
condition|(
name|r
operator|->
name|tprt_seq
operator|==
name|retrans
condition|)
block|{
if|if
condition|(
operator|(
name|m
operator|=
name|m_copy
argument_list|(
name|r
operator|->
name|tprt_data
argument_list|,
literal|0
argument_list|,
name|r
operator|->
name|tprt_octets
argument_list|)
operator|)
operator|==
name|MNULL
condition|)
break|break;
operator|(
name|void
operator|)
name|tp_emit
argument_list|(
name|DT_TPDU_type
argument_list|,
name|p
argument_list|,
name|retrans
argument_list|,
name|r
operator|->
name|tprt_eot
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|p
operator|->
name|tp_last_retrans
operator|=
name|retrans
expr_stmt|;
name|IncStat
argument_list|(
name|ts_retrans_dt
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|r
operator|==
operator|(
expr|struct
name|tp_rtc
operator|*
operator|)
literal|0
condition|)
block|{
name|IFDEBUG
argument_list|(
argument|D_RTC
argument_list|)
name|printf
argument_list|(
literal|"tp: retrans rtc list is GONE!\n"
argument_list|)
expr_stmt|;
name|ENDDEBUG
break|break;
block|}
block|}
name|tp_etimeout
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_data_retrans
argument_list|,
operator|(
name|caddr_t
operator|)
name|low_save
argument_list|,
operator|(
name|caddr_t
operator|)
name|high
argument_list|,
name|p
operator|->
name|tp_retrans
argument_list|,
operator|(
name|int
operator|)
name|p
operator|->
name|tp_dt_ticks
argument_list|)
expr_stmt|;
if|if
condition|(
name|SEQ_DEC
argument_list|(
name|p
argument_list|,
name|retrans
argument_list|)
operator|==
name|p
operator|->
name|tp_retrans_hiwat
condition|)
name|tp_send
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tp_send
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
name|IFDEBUG
argument_list|(
argument|D_ACKRECV
argument_list|)
name|printf
argument_list|(
literal|"GOOD ACK new sndhiwat 0x%x\n"
argument_list|,
name|p
operator|->
name|tp_sndhiwat
argument_list|)
expr_stmt|;
name|ENDDEBUG
block|}
break|break;
case|case
literal|0x31
case|:
block|{
name|IFTRACE
argument_list|(
argument|D_ACKRECV
argument_list|)
name|tptrace
argument_list|(
name|TPPTmisc
argument_list|,
literal|"BOGUS ACK fcc_present, tp_r_subseq e_subseq"
argument_list|,
name|e
operator|->
name|ev_union
operator|.
name|EV_AK_TPDU
operator|.
name|e_fcc_present
argument_list|,
name|p
operator|->
name|tp_r_subseq
argument_list|,
name|e
operator|->
name|ev_union
operator|.
name|EV_AK_TPDU
operator|.
name|e_subseq
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ENDTRACE
if|if
condition|(
name|p
operator|->
name|tp_class
operator|!=
name|TP_CLASS_0
condition|)
block|{
if|if
condition|(
operator|!
name|e
operator|->
name|ev_union
operator|.
name|EV_AK_TPDU
operator|.
name|e_fcc_present
condition|)
block|{
comment|/* send ACK with FCC */
name|IncStat
argument_list|(
name|ts_ackreason
index|[
name|_ACK_FCC_
index|]
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|tp_emit
argument_list|(
name|AK_TPDU_type
argument_list|,
name|p
argument_list|,
name|p
operator|->
name|tp_rcvnxt
argument_list|,
literal|1
argument_list|,
name|MNULL
argument_list|)
expr_stmt|;
block|}
name|tp_ctimeout
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_inact
argument_list|,
operator|(
name|int
operator|)
name|p
operator|->
name|tp_inact_ticks
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
case|case
literal|0x32
case|:
block|{
name|tp_ctimeout
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_inact
argument_list|,
operator|(
name|int
operator|)
name|p
operator|->
name|tp_inact_ticks
argument_list|)
expr_stmt|;
name|tp_cuntimeout
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_retrans
argument_list|)
expr_stmt|;
name|sbwakeup
argument_list|(
operator|&
name|p
operator|->
name|tp_sock
operator|->
name|so_snd
argument_list|)
expr_stmt|;
comment|/* resume normal data */
name|tp_send
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|0x33
case|:
block|{
name|IFTRACE
argument_list|(
argument|D_ACKRECV
argument_list|)
name|tptrace
argument_list|(
name|TPPTmisc
argument_list|,
literal|"BOGUS XACK eventtype "
argument_list|,
name|e
operator|->
name|ev_number
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ENDTRACE
if|if
condition|(
name|p
operator|->
name|tp_class
operator|!=
name|TP_CLASS_0
condition|)
block|{
name|tp_ctimeout
argument_list|(
name|p
operator|->
name|tp_refp
argument_list|,
name|TM_inact
argument_list|,
operator|(
name|int
operator|)
name|p
operator|->
name|tp_inact_ticks
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
case|case
literal|0x34
case|:
block|{
name|IFTRACE
argument_list|(
argument|D_TIMER
argument_list|)
name|tptrace
argument_list|(
name|TPPTsendack
argument_list|,
operator|-
literal|1
argument_list|,
name|p
operator|->
name|tp_lcredit
argument_list|,
name|p
operator|->
name|tp_sent_uwe
argument_list|,
name|p
operator|->
name|tp_sent_lcdt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ENDTRACE
name|IncPStat
argument_list|(
name|p
argument_list|,
name|tps_n_TMsendack
argument_list|)
decl_stmt|;
operator|(
name|void
operator|)
name|tp_emit
argument_list|(
name|AK_TPDU_type
argument_list|,
name|p
argument_list|,
name|p
operator|->
name|tp_rcvnxt
argument_list|,
literal|0
argument_list|,
name|MNULL
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|0x35
case|:
block|{
if|if
condition|(
name|sbspace
argument_list|(
operator|&
name|p
operator|->
name|tp_sock
operator|->
name|so_rcv
argument_list|)
operator|>
literal|0
condition|)
name|tp0_openflow
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|0x36
case|:
block|{
if|if
condition|(
name|trick_hc
condition|)
block|{
name|IncStat
argument_list|(
name|ts_ackreason
index|[
name|_ACK_USRRCV_
index|]
argument_list|)
expr_stmt|;
comment|/* send an ACK only if there's new information */
name|LOCAL_CREDIT
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p
operator|->
name|tp_rcvnxt
operator|!=
name|p
operator|->
name|tp_sent_rcvnxt
operator|)
operator|||
operator|(
name|p
operator|->
name|tp_lcredit
operator|!=
name|p
operator|->
name|tp_sent_lcdt
operator|)
condition|)
return|return
name|tp_emit
argument_list|(
name|AK_TPDU_type
argument_list|,
name|p
argument_list|,
name|p
operator|->
name|tp_rcvnxt
argument_list|,
literal|0
argument_list|,
name|MNULL
argument_list|)
return|;
block|}
block|}
break|break;
case|case
literal|0x37
case|:
block|{
if|if
condition|(
name|trick_hc
condition|)
return|return
name|ECONNABORTED
return|;
block|}
break|break;
case|case
literal|0x38
case|:
block|{
name|ASSERT
argument_list|(
name|p
operator|->
name|tp_state
operator|!=
name|TP_LISTENING
argument_list|)
expr_stmt|;
name|tp_indicate
argument_list|(
name|T_DISCONNECT
argument_list|,
name|p
argument_list|,
name|ECONNRESET
argument_list|)
expr_stmt|;
name|tp_soisdisconnected
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|_XEBEC_PG
name|int
name|_Xebec_index
parameter_list|(
name|e
parameter_list|,
name|p
parameter_list|)
name|struct
name|tp_event
modifier|*
name|e
decl_stmt|;
name|tp_PCB_
modifier|*
name|p
decl_stmt|;
block|{
switch|switch
condition|(
operator|(
name|e
operator|->
name|ev_number
operator|<<
literal|4
operator|)
operator|+
operator|(
name|p
operator|->
name|tp_state
operator|)
condition|)
block|{
case|case
literal|0x12
case|:
if|if
condition|(
name|p
operator|->
name|tp_retrans
operator|>
literal|0
condition|)
return|return
literal|0x1e
return|;
else|else
return|return
literal|0x1f
return|;
case|case
literal|0x13
case|:
if|if
condition|(
name|p
operator|->
name|tp_retrans
operator|>
literal|0
condition|)
return|return
literal|0x2f
return|;
else|else
return|return
literal|0x30
return|;
case|case
literal|0x14
case|:
if|if
condition|(
name|p
operator|->
name|tp_retrans
operator|>
literal|0
condition|)
return|return
literal|0x32
return|;
else|else
return|return
literal|0x31
return|;
case|case
literal|0x15
case|:
if|if
condition|(
name|p
operator|->
name|tp_retrans
operator|>
literal|0
condition|)
return|return
literal|0x34
return|;
else|else
return|return
literal|0x35
return|;
case|case
literal|0x54
case|:
if|if
condition|(
name|e
operator|->
name|ev_union
operator|.
name|EV_TM_data_retrans
operator|.
name|e_retrans
operator|>
literal|0
condition|)
return|return
literal|0x33
return|;
else|else
return|return
literal|0x31
return|;
case|case
literal|0x64
case|:
if|if
condition|(
name|p
operator|->
name|tp_class
operator|==
name|TP_CLASS_0
condition|)
return|return
literal|0x1a
return|;
else|else
return|return
literal|0x1b
return|;
case|case
literal|0x77
case|:
if|if
condition|(
name|p
operator|->
name|tp_class
operator|==
name|TP_CLASS_0
condition|)
return|return
literal|0xd
return|;
else|else
return|return
literal|0xe
return|;
case|case
literal|0x86
case|:
if|if
condition|(
name|e
operator|->
name|ev_union
operator|.
name|EV_DR_TPDU
operator|.
name|e_sref
operator|!=
literal|0
condition|)
return|return
literal|0x2
return|;
else|else
return|return
literal|0x3
return|;
case|case
literal|0xa2
case|:
if|if
condition|(
name|p
operator|->
name|tp_class
operator|==
name|TP_CLASS_0
condition|)
return|return
literal|0x1c
return|;
else|else
return|return
literal|0x1d
return|;
case|case
literal|0xb2
case|:
if|if
condition|(
name|p
operator|->
name|tp_class
operator|==
name|TP_CLASS_0
condition|)
return|return
literal|0x5
return|;
else|else
return|return
literal|0x0
return|;
case|case
literal|0xb4
case|:
if|if
condition|(
name|tp_goodack
argument_list|(
name|p
argument_list|,
name|e
operator|->
name|ev_union
operator|.
name|EV_AK_TPDU
operator|.
name|e_cdt
argument_list|,
name|e
operator|->
name|ev_union
operator|.
name|EV_AK_TPDU
operator|.
name|e_seq
argument_list|,
name|e
operator|->
name|ev_union
operator|.
name|EV_AK_TPDU
operator|.
name|e_subseq
argument_list|)
condition|)
return|return
literal|0x3a
return|;
else|else
return|return
literal|0x3b
return|;
case|case
literal|0xc3
case|:
if|if
condition|(
name|IN_RWINDOW
argument_list|(
name|p
argument_list|,
name|e
operator|->
name|ev_union
operator|.
name|EV_DT_TPDU
operator|.
name|e_seq
argument_list|,
name|p
operator|->
name|tp_rcvnxt
argument_list|,
name|SEQ
argument_list|(
name|p
argument_list|,
name|p
operator|->
name|tp_rcvnxt
operator|+
name|p
operator|->
name|tp_lcredit
argument_list|)
argument_list|)
condition|)
return|return
literal|0x21
return|;
else|else
return|return
literal|0x24
return|;
case|case
literal|0xc4
case|:
if|if
condition|(
name|p
operator|->
name|tp_class
operator|==
name|TP_CLASS_0
condition|)
return|return
literal|0x22
return|;
elseif|else
if|if
condition|(
name|IN_RWINDOW
argument_list|(
name|p
argument_list|,
name|e
operator|->
name|ev_union
operator|.
name|EV_DT_TPDU
operator|.
name|e_seq
argument_list|,
name|p
operator|->
name|tp_rcvnxt
argument_list|,
name|SEQ
argument_list|(
name|p
argument_list|,
name|p
operator|->
name|tp_rcvnxt
operator|+
name|p
operator|->
name|tp_lcredit
argument_list|)
argument_list|)
condition|)
return|return
literal|0x23
return|;
else|else
return|return
literal|0x25
return|;
case|case
literal|0xd3
case|:
if|if
condition|(
name|p
operator|->
name|tp_Xrcvnxt
operator|==
name|e
operator|->
name|ev_union
operator|.
name|EV_XPD_TPDU
operator|.
name|e_seq
condition|)
return|return
literal|0x27
return|;
else|else
return|return
literal|0x2a
return|;
case|case
literal|0xd4
case|:
if|if
condition|(
name|p
operator|->
name|tp_Xrcvnxt
operator|==
name|e
operator|->
name|ev_union
operator|.
name|EV_XPD_TPDU
operator|.
name|e_seq
condition|)
return|return
literal|0x27
return|;
else|else
return|return
literal|0x29
return|;
case|case
literal|0xe4
case|:
if|if
condition|(
name|tp_goodXack
argument_list|(
name|p
argument_list|,
name|e
operator|->
name|ev_union
operator|.
name|EV_XAK_TPDU
operator|.
name|e_seq
argument_list|)
condition|)
return|return
literal|0x3c
return|;
else|else
return|return
literal|0x3d
return|;
case|case
literal|0x102
case|:
if|if
condition|(
name|p
operator|->
name|tp_class
operator|==
name|TP_CLASS_0
condition|)
return|return
literal|0x2d
return|;
else|else
return|return
literal|0x2e
return|;
case|case
literal|0x104
case|:
if|if
condition|(
name|p
operator|->
name|tp_class
operator|==
name|TP_CLASS_0
condition|)
return|return
literal|0x2d
return|;
else|else
return|return
literal|0x2e
return|;
case|case
literal|0x144
case|:
if|if
condition|(
name|p
operator|->
name|tp_class
operator|==
name|TP_CLASS_0
condition|)
return|return
literal|0x3f
return|;
else|else
return|return
literal|0x40
return|;
case|case
literal|0x162
case|:
if|if
condition|(
name|p
operator|->
name|tp_class
operator|==
name|TP_CLASS_0
condition|)
return|return
literal|0x2b
return|;
else|else
return|return
literal|0x2c
return|;
case|case
literal|0x172
case|:
if|if
condition|(
name|p
operator|->
name|tp_class
operator|!=
name|TP_CLASS_4
condition|)
return|return
literal|0x42
return|;
else|else
return|return
literal|0x46
return|;
case|case
literal|0x174
case|:
if|if
condition|(
name|p
operator|->
name|tp_class
operator|!=
name|TP_CLASS_4
condition|)
return|return
literal|0x42
return|;
else|else
return|return
literal|0x47
return|;
case|case
literal|0x177
case|:
if|if
condition|(
name|p
operator|->
name|tp_class
operator|!=
name|TP_CLASS_4
condition|)
return|return
literal|0x42
return|;
else|else
return|return
literal|0x43
return|;
case|case
literal|0x188
case|:
if|if
condition|(
name|p
operator|->
name|tp_class
operator|==
name|TP_CLASS_0
condition|)
return|return
literal|0xf
return|;
elseif|else
if|if
condition|(
name|tp_emit
argument_list|(
name|CC_TPDU_type
argument_list|,
name|p
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|MCPY
argument_list|(
name|p
operator|->
name|tp_ucddata
argument_list|,
name|M_NOWAIT
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|0x10
return|;
else|else
return|return
literal|0x11
return|;
default|default:
return|return
literal|0
return|;
block|}
comment|/* end switch */
block|}
end_function

begin_comment
comment|/* _Xebec_index() */
end_comment

begin_decl_stmt
specifier|static
name|int
name|inx
index|[
literal|26
index|]
index|[
literal|9
index|]
init|=
block|{
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,}
block|,
block|{
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x31
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|, }
block|,
block|{
literal|0x0
block|,
literal|0x0
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|, }
block|,
block|{
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x3e
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|, }
block|,
block|{
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|, }
block|,
block|{
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x36
block|,
literal|0x0
block|,
literal|0x0
block|, }
block|,
block|{
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|,
operator|-
literal|1
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|, }
block|,
block|{
literal|0x0
block|,
literal|0x7
block|,
literal|0x15
block|,
literal|0x1b
block|,
operator|-
literal|1
block|,
literal|0x17
block|,
literal|0x3
block|,
literal|0xa
block|,
literal|0x0
block|, }
block|,
block|{
literal|0x0
block|,
literal|0x19
block|,
literal|0x6
block|,
literal|0x20
block|,
literal|0x37
block|,
literal|0x8
block|,
literal|0x3
block|,
operator|-
literal|1
block|,
literal|0x0
block|, }
block|,
block|{
literal|0x0
block|,
literal|0x14
block|,
literal|0x13
block|,
literal|0x13
block|,
literal|0x13
block|,
literal|0x16
block|,
operator|-
literal|1
block|,
literal|0xa
block|,
literal|0x0
block|, }
block|,
block|{
literal|0x0
block|,
literal|0x7
block|,
literal|0x6
block|,
literal|0x1
block|,
literal|0x9
block|,
literal|0x18
block|,
literal|0x3
block|,
literal|0xa
block|,
literal|0x0
block|, }
block|,
block|{
literal|0x0
block|,
literal|0x19
block|,
operator|-
literal|1
block|,
literal|0x1
block|,
literal|0x37
block|,
literal|0x8
block|,
literal|0x3
block|,
literal|0xa
block|,
literal|0x0
block|, }
block|,
block|{
literal|0x0
block|,
literal|0x7
block|,
operator|-
literal|1
block|,
literal|0x26
block|,
operator|-
literal|1
block|,
literal|0x8
block|,
literal|0x3
block|,
literal|0xa
block|,
literal|0x0
block|, }
block|,
block|{
literal|0x0
block|,
literal|0x7
block|,
literal|0x6
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
literal|0x8
block|,
literal|0x3
block|,
literal|0xa
block|,
literal|0x0
block|, }
block|,
block|{
literal|0x0
block|,
literal|0x7
block|,
literal|0x6
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
literal|0x8
block|,
literal|0x3
block|,
literal|0xa
block|,
literal|0x0
block|, }
block|,
block|{
literal|0x0
block|,
literal|0x7
block|,
literal|0x6
block|,
literal|0x1
block|,
operator|-
literal|1
block|,
literal|0x8
block|,
literal|0x3
block|,
literal|0xa
block|,
literal|0x0
block|, }
block|,
block|{
literal|0x0
block|,
literal|0x12
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|, }
block|,
block|{
literal|0x0
block|,
literal|0x0
block|,
operator|-
literal|1
block|,
literal|0x2e
block|,
operator|-
literal|1
block|,
literal|0x0
block|,
literal|0x4
block|,
literal|0x0
block|,
literal|0x2e
block|, }
block|,
block|{
literal|0x0
block|,
literal|0xb
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|, }
block|,
block|{
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x38
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|, }
block|,
block|{
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x39
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|, }
block|,
block|{
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|,
operator|-
literal|1
block|,
literal|0x0
block|,
literal|0x41
block|,
literal|0x0
block|,
literal|0x0
block|, }
block|,
block|{
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x28
block|,
literal|0x0
block|,
literal|0x41
block|,
literal|0x0
block|,
literal|0x0
block|, }
block|,
block|{
literal|0x0
block|,
literal|0xc
block|,
operator|-
literal|1
block|,
literal|0x2c
block|,
literal|0x0
block|,
literal|0x2c
block|,
literal|0x4
block|,
literal|0xc
block|,
literal|0x2c
block|, }
block|,
block|{
literal|0x0
block|,
literal|0x49
block|,
operator|-
literal|1
block|,
literal|0x45
block|,
operator|-
literal|1
block|,
literal|0x44
block|,
literal|0x48
block|,
operator|-
literal|1
block|,
literal|0x0
block|, }
block|,
block|{
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|,
operator|-
literal|1
block|, }
block|, }
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|tp_driver
parameter_list|(
name|p
parameter_list|,
name|e
parameter_list|)
specifier|register
name|tp_PCB_
modifier|*
name|p
decl_stmt|;
specifier|register
name|struct
name|tp_event
modifier|*
name|e
decl_stmt|;
block|{
specifier|register
name|int
name|index
decl_stmt|,
name|error
init|=
literal|0
decl_stmt|;
name|struct
name|act_ent
modifier|*
name|a
decl_stmt|;
specifier|static
name|struct
name|act_ent
name|erroraction
init|=
block|{
literal|0
block|,
operator|-
literal|1
block|}
decl_stmt|;
name|index
operator|=
name|inx
index|[
literal|1
operator|+
name|e
operator|->
name|ev_number
index|]
index|[
name|p
operator|->
name|tp_state
index|]
expr_stmt|;
if|if
condition|(
name|index
operator|<
literal|0
condition|)
name|index
operator|=
name|_Xebec_index
argument_list|(
name|e
argument_list|,
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|index
operator|==
literal|0
condition|)
block|{
name|a
operator|=
operator|&
name|erroraction
expr_stmt|;
block|}
else|else
name|a
operator|=
operator|&
name|statetable
index|[
name|index
index|]
expr_stmt|;
if|if
condition|(
name|a
operator|->
name|a_action
condition|)
name|error
operator|=
name|_Xebec_action
argument_list|(
name|a
operator|->
name|a_action
argument_list|,
name|e
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|IFTRACE
argument_list|(
argument|D_DRIVER
argument_list|)
name|tptrace
argument_list|(
name|DRIVERTRACE
argument_list|,
name|a
operator|->
name|a_newstate
argument_list|,
name|p
operator|->
name|tp_state
argument_list|,
name|e
operator|->
name|ev_number
argument_list|,
name|a
operator|->
name|a_action
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ENDTRACE
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|p
operator|->
name|tp_state
operator|=
name|a
operator|->
name|a_newstate
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

end_unit


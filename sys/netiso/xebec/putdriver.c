begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* $FreeBSD$ */
end_comment

begin_comment
comment|/* $Source: /pub/FreeBSD/FreeBSD-CVS/src/sys/netiso/xebec/Attic/putdriver.c,v $ */
end_comment

begin_comment
comment|/*  * This code is such a kludge that I don't want to put my name on it.  * It was a ridiculously fast hack and needs rewriting.  * However it does work...  */
end_comment

begin_comment
comment|/* The original idea was to put all the driver code  * in one place so it would be easy to modify  * but as hacks got thrown in it got worse and worse...  * It's to the point where a user would be better off  * writing his own driver and xebec should JUST produce  * the tables.  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|"main.h"
end_include

begin_include
include|#
directive|include
file|"debug.h"
end_include

begin_decl_stmt
specifier|extern
name|char
name|protocol
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|Eventshiftstring
index|[
literal|10
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|statename
index|[]
init|=
block|{
literal|'_'
block|,
literal|'s'
block|,
literal|'t'
block|,
literal|'a'
block|,
literal|'t'
block|,
literal|'e'
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|strings
index|[]
init|=
block|{
define|#
directive|define
name|PART1
value|{ 0,3 }
literal|"\n#include \""
block|,
name|kerneldirname
block|,
name|protocol
block|,
literal|"_states.h\""
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
define|#
directive|define
name|PART12
value|{ 10,12 }
literal|"\n\nstatic struct act_ent {\n"
block|,
literal|"\tint a_newstate;\n\tint a_action;\n"
block|,
literal|"} statetable[] = { {0,0},\n"
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
define|#
directive|define
name|PART2
value|{ 20,20 }
literal|"};\n"
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
define|#
directive|define
name|PART3
value|{ 30,41 }
literal|"\n"
block|,
name|protocol
block|,
literal|"_driver(p, e)\nregister "
block|,
name|protocol
block|,
name|PCBNAME
block|,
literal|" *p;\nregister struct "
block|,
name|protocol
block|,
literal|"_event *e;\n"
block|,
literal|"{\n"
block|,
literal|"\tregister int index, error=0;\n"
block|,
literal|"\tstruct act_ent *a;\n"
block|,
literal|"\tstatic struct act_ent erroraction = {0,-1};\n"
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
define|#
directive|define
name|PART4
value|{ 50,54 }
literal|"\textern int "
block|,
name|protocol
block|,
literal|"_debug;\n\textern FILE *"
block|,
name|protocol
block|,
literal|"_astringfile;\n"
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
define|#
directive|define
name|PART6
value|{ 60, 65 }
literal|"\n\tindex = inx[1 + e->ev_number][p->"
block|,
name|protocol
block|,
name|statename
block|,
literal|"];\n\tif(index<0) index=_Xebec_index(e, p);\n"
block|,
literal|"\tif (index==0) {\n\t\ta =&erroraction;\n"
block|,
literal|"\t} else\n\t\ta =&statetable[index];\n\n"
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
define|#
directive|define
name|PART7
value|{70, 77 }
literal|"\tif("
block|,
name|protocol
block|,
literal|"_debug) fprintf("
block|,
name|protocol
block|,
literal|"_astringfile, \"%15s<-- %15s [%15s] \\n\\t%s\\n\",\n"
block|,
literal|"\t\tsstring[a->a_newstate], sstring[p->"
block|,
name|protocol
block|,
literal|"_state], estring[e->ev_number], astring[a->a_action]);\n\n"
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
define|#
directive|define
name|PART8
value|{ 80, 84 }
literal|"\tif(a->a_action)\n"
block|,
literal|"\t\terror = _Xebec_action( a->a_action, e, p );\n"
block|,
literal|"\tif(error==0)\n\tp->"
block|,
name|protocol
block|,
literal|"_state = a->a_newstate;\n\treturn error;\n}\n"
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
define|#
directive|define
name|PART9
value|{ 90, 99 }
literal|"\n_XEBEC_PG int _Xebec_action(a,e,p)\nint a;\nstruct "
block|,
name|protocol
block|,
literal|"_event *e;\n"
block|,
name|protocol
block|,
name|PCBNAME
block|,
literal|" *p;\n{\n"
block|,
literal|"switch(a) {\n"
block|,
literal|"case -1:  return "
block|,
name|protocol
block|,
literal|"_protocol_error(e,p);\n"
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
define|#
directive|define
name|PART10
value|{ 101, 105 }
literal|"\tif("
block|,
name|protocol
block|,
literal|"_debug) fprintf("
block|,
name|protocol
block|,
literal|"_astringfile, \"index 0x%5x\\n\", index);\n"
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
define|#
directive|define
name|PART5
value|{ 110, 121 }
literal|"\n_XEBEC_PG int\n_Xebec_index( e,p )\n"
block|,
literal|"\tstruct "
block|,
name|protocol
block|,
literal|"_event *e;\n\t"
block|,
name|protocol
block|,
name|PCBNAME
block|,
literal|" *p;\n{\nswitch( (e->ev_number<<"
block|,
name|Eventshiftstring
block|,
literal|")+(p->"
block|,
name|protocol
block|,
name|statename
block|,
literal|") ) {\n"
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
define|#
directive|define
name|PART11
value|{130, 137 }
literal|"\tIFTRACE(D_DRIVER)\n"
block|,
literal|"\t"
block|,
name|protocol
block|,
literal|"trace(DRIVERTRACE,"
block|,
literal|"\t\ta->a_newstate, p->"
block|,
name|protocol
block|,
literal|"_state, e->ev_number, a->a_action, 0);\n\n"
block|,
literal|"\tENDTRACE\n"
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
define|#
directive|define
name|PART13
value|{140, 147 }
literal|"\tif("
block|,
name|protocol
block|,
literal|"_debug) fprintf("
block|,
name|protocol
block|,
literal|"_astringfile, \"%15s<-- %15s [%15s] \\n\",\n"
block|,
literal|"\t\tsstring[a->a_newstate], sstring[p->"
block|,
name|protocol
block|,
literal|"_state], estring[e->ev_number]);\n\n"
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
define|#
directive|define
name|PART14
value|{ 150,150 }
literal|"#define _XEBEC_PG static\n"
block|,
define|#
directive|define
name|PART15
value|{ 151,151 }
literal|"#define _XEBEC_PG  \n"
block|,  }
decl_stmt|;
end_decl_stmt

begin_struct
specifier|static
struct|struct
block|{
name|int
name|start
decl_stmt|;
name|int
name|finish
decl_stmt|;
block|}
name|parts
index|[]
init|=
block|{
block|{
literal|0
block|,
literal|0
block|}
block|,
name|PART1
block|,
name|PART2
block|,
name|PART3
block|,
name|PART4
block|,
name|PART5
block|,
name|PART6
block|,
name|PART7
block|,
name|PART8
block|,
name|PART9
block|,
name|PART10
block|,
name|PART11
block|,
name|PART12
block|,
name|PART13
block|,
name|PART14
block|,
name|PART15
block|, }
struct|;
end_struct

begin_macro
name|putdriver
argument_list|(
argument|f
argument_list|,
argument|x
argument_list|)
end_macro

begin_decl_stmt
name|FILE
modifier|*
name|f
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|x
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
name|parts
index|[
name|x
index|]
operator|.
name|start
init|;
name|i
operator|<=
name|parts
index|[
name|x
index|]
operator|.
name|finish
condition|;
name|i
operator|++
control|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"%s"
argument_list|,
name|strings
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|IFDEBUG
argument_list|(
argument|d
argument_list|)
name|fflush
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|ENDDEBUG
block|}
end_block

end_unit


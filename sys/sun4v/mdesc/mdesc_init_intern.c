begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * CDDL HEADER START  *  * The contents of this file are subject to the terms of the  * Common Development and Distribution License (the "License").  * You may not use this file except in compliance with the License.  *  * You can obtain a copy of the license at usr/src/OPENSOLARIS.LICENSE  * or http://www.opensolaris.org/os/licensing.  * See the License for the specific language governing permissions  * and limitations under the License.  *  * When distributing Covered Code, include this CDDL HEADER in each  * file and include the License file at usr/src/OPENSOLARIS.LICENSE.  * If applicable, add the following below this CDDL HEADER, with the  * fields enclosed by brackets "[]" replaced with your own identifying  * information: Portions Copyright [yyyy] [name of copyright owner]  *  * CDDL HEADER END  * $FreeBSD$  */
end_comment

begin_comment
comment|/*  * Copyright 2006 Sun Microsystems, Inc.  All rights reserved.  * Use is subject to license terms.  */
end_comment

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<machine/cddl/mdesc.h>
end_include

begin_include
include|#
directive|include
file|<machine/cddl/mdesc_impl.h>
end_include

begin_function
name|md_t
modifier|*
name|md_init_intern
parameter_list|(
name|uint64_t
modifier|*
name|ptr
parameter_list|,
name|void
modifier|*
function_decl|(
modifier|*
name|allocp
function_decl|)
parameter_list|(
name|size_t
parameter_list|)
parameter_list|,
name|void
function_decl|(
modifier|*
name|freep
function_decl|)
parameter_list|(
name|void
modifier|*
parameter_list|,
name|size_t
parameter_list|)
parameter_list|)
block|{
name|md_impl_t
modifier|*
name|mdp
decl_stmt|;
name|int
name|idx
decl_stmt|;
name|int
name|count
decl_stmt|;
name|int
name|done
decl_stmt|;
name|uint64_t
name|gen
decl_stmt|;
name|mde_str_cookie_t
name|root_name
decl_stmt|;
comment|/* 	 * Very basic checkup for alignment to avoid 	 * bus error issues. 	 */
if|if
condition|(
operator|(
operator|(
operator|(
name|uintptr_t
operator|)
name|ptr
operator|)
operator|&
literal|7
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|mdp
operator|=
operator|(
name|md_impl_t
operator|*
operator|)
name|allocp
argument_list|(
sizeof|sizeof
argument_list|(
name|md_impl_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|mdp
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|mdp
operator|->
name|allocp
operator|=
name|allocp
expr_stmt|;
name|mdp
operator|->
name|freep
operator|=
name|freep
expr_stmt|;
name|mdp
operator|->
name|caddr
operator|=
operator|(
name|char
operator|*
operator|)
name|ptr
expr_stmt|;
comment|/* 	 * setup internal structures 	 */
name|mdp
operator|->
name|headerp
operator|=
operator|(
name|md_header_t
operator|*
operator|)
name|mdp
operator|->
name|caddr
expr_stmt|;
if|if
condition|(
name|mdtoh32
argument_list|(
name|mdp
operator|->
name|headerp
operator|->
name|transport_version
argument_list|)
operator|!=
name|MD_TRANSPORT_VERSION
condition|)
block|{
goto|goto
name|cleanup_nohash
goto|;
block|}
name|mdp
operator|->
name|node_blk_size
operator|=
name|mdtoh32
argument_list|(
name|mdp
operator|->
name|headerp
operator|->
name|node_blk_sz
argument_list|)
expr_stmt|;
name|mdp
operator|->
name|name_blk_size
operator|=
name|mdtoh32
argument_list|(
name|mdp
operator|->
name|headerp
operator|->
name|name_blk_sz
argument_list|)
expr_stmt|;
name|mdp
operator|->
name|data_blk_size
operator|=
name|mdtoh32
argument_list|(
name|mdp
operator|->
name|headerp
operator|->
name|data_blk_sz
argument_list|)
expr_stmt|;
name|mdp
operator|->
name|size
operator|=
name|MD_HEADER_SIZE
operator|+
name|mdp
operator|->
name|node_blk_size
operator|+
name|mdp
operator|->
name|name_blk_size
operator|+
name|mdp
operator|->
name|data_blk_size
expr_stmt|;
name|mdp
operator|->
name|mdep
operator|=
operator|(
name|md_element_t
operator|*
operator|)
operator|(
name|mdp
operator|->
name|caddr
operator|+
name|MD_HEADER_SIZE
operator|)
expr_stmt|;
name|mdp
operator|->
name|namep
operator|=
operator|(
name|char
operator|*
operator|)
operator|(
name|mdp
operator|->
name|caddr
operator|+
name|MD_HEADER_SIZE
operator|+
name|mdp
operator|->
name|node_blk_size
operator|)
expr_stmt|;
name|mdp
operator|->
name|datap
operator|=
operator|(
name|uint8_t
operator|*
operator|)
operator|(
name|mdp
operator|->
name|caddr
operator|+
name|MD_HEADER_SIZE
operator|+
name|mdp
operator|->
name|name_blk_size
operator|+
name|mdp
operator|->
name|node_blk_size
operator|)
expr_stmt|;
name|mdp
operator|->
name|root_node
operator|=
name|MDE_INVAL_ELEM_COOKIE
expr_stmt|;
comment|/* 	 * Should do a lot more sanity checking here. 	 */
comment|/* 	 * Should initialize a name hash here if we intend to use one 	 */
comment|/* 	 * Setup to find the root node 	 */
name|root_name
operator|=
name|md_find_name
argument_list|(
operator|(
name|md_t
operator|*
operator|)
name|mdp
argument_list|,
literal|"root"
argument_list|)
expr_stmt|;
if|if
condition|(
name|root_name
operator|==
name|MDE_INVAL_STR_COOKIE
condition|)
block|{
goto|goto
name|cleanup
goto|;
block|}
comment|/* 	 * One more property we need is the count of nodes in the 	 * DAG, not just the number of elements. 	 * 	 * We try and pickup the root node along the way here. 	 */
for|for
control|(
name|done
operator|=
literal|0
operator|,
name|idx
operator|=
literal|0
operator|,
name|count
operator|=
literal|0
init|;
operator|!
name|done
condition|;
control|)
block|{
name|md_element_t
modifier|*
name|np
decl_stmt|;
name|np
operator|=
operator|&
operator|(
name|mdp
operator|->
name|mdep
index|[
name|idx
index|]
operator|)
expr_stmt|;
switch|switch
condition|(
name|MDE_TAG
argument_list|(
name|np
argument_list|)
condition|)
block|{
case|case
name|MDET_LIST_END
case|:
name|done
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|MDET_NODE
case|:
if|if
condition|(
name|root_name
operator|==
name|MDE_NAME
argument_list|(
name|np
argument_list|)
condition|)
block|{
if|if
condition|(
name|mdp
operator|->
name|root_node
operator|!=
name|MDE_INVAL_ELEM_COOKIE
condition|)
block|{
comment|/* Gah .. more than one root */
goto|goto
name|cleanup
goto|;
block|}
name|mdp
operator|->
name|root_node
operator|=
operator|(
name|mde_cookie_t
operator|)
name|idx
expr_stmt|;
block|}
name|idx
operator|=
name|MDE_PROP_INDEX
argument_list|(
name|np
argument_list|)
expr_stmt|;
name|count
operator|++
expr_stmt|;
break|break;
default|default:
name|idx
operator|++
expr_stmt|;
comment|/* ignore */
block|}
block|}
comment|/* 	 * Ensure there is a root node 	 */
if|if
condition|(
name|mdp
operator|->
name|root_node
operator|==
name|MDE_INVAL_ELEM_COOKIE
condition|)
block|{
goto|goto
name|cleanup
goto|;
block|}
comment|/* 	 * Register the counts 	 */
name|mdp
operator|->
name|element_count
operator|=
name|idx
operator|+
literal|1
expr_stmt|;
comment|/* include LIST_END */
name|mdp
operator|->
name|node_count
operator|=
name|count
expr_stmt|;
comment|/* 	 * Final sanity check that everything adds up 	 */
if|if
condition|(
name|mdp
operator|->
name|element_count
operator|!=
operator|(
name|mdp
operator|->
name|node_blk_size
operator|/
name|MD_ELEMENT_SIZE
operator|)
condition|)
goto|goto
name|cleanup
goto|;
name|mdp
operator|->
name|md_magic
operator|=
name|LIBMD_MAGIC
expr_stmt|;
comment|/* 	 * Setup MD generation 	 */
if|if
condition|(
name|md_get_prop_val
argument_list|(
operator|(
name|md_t
operator|*
operator|)
name|mdp
argument_list|,
name|mdp
operator|->
name|root_node
argument_list|,
literal|"md-generation#"
argument_list|,
operator|&
name|gen
argument_list|)
operator|!=
literal|0
condition|)
name|mdp
operator|->
name|gen
operator|=
name|MDESC_INVAL_GEN
expr_stmt|;
else|else
name|mdp
operator|->
name|gen
operator|=
name|gen
expr_stmt|;
return|return
operator|(
operator|(
name|md_t
operator|*
operator|)
name|mdp
operator|)
return|;
name|cleanup
label|:
comment|/* 	 * Clean up here - including a name hash if 	 * we build one. 	 */
name|cleanup_nohash
label|:
name|mdp
operator|->
name|freep
argument_list|(
name|mdp
argument_list|,
sizeof|sizeof
argument_list|(
name|md_impl_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/******************************************************************************  *  * Module Name: examples - Example ACPICA code  *  *****************************************************************************/
end_comment

begin_comment
comment|/*  * Copyright (C) 2000 - 2013, Intel Corp.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions, and the following disclaimer,  *    without modification.  * 2. Redistributions in binary form must reproduce at minimum a disclaimer  *    substantially similar to the "NO WARRANTY" disclaimer below  *    ("Disclaimer") and any redistribution must be conditioned upon  *    including a substantially similar Disclaimer requirement for further  *    binary redistribution.  * 3. Neither the names of the above-listed copyright holders nor the names  *    of any contributors may be used to endorse or promote products derived  *    from this software without specific prior written permission.  *  * Alternatively, this software may be distributed under the terms of the  * GNU General Public License ("GPL") version 2 as published by the Free  * Software Foundation.  *  * NO WARRANTY  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS  * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR  * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT  * HOLDERS OR CONTRIBUTORS BE LIABLE FOR SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,  * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING  * IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE  * POSSIBILITY OF SUCH DAMAGES.  */
end_comment

begin_comment
comment|/* Set the ACPICA application type for use in include/platform/acenv.h */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|WIN32
end_ifndef

begin_define
define|#
directive|define
name|WIN32
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|ACPI_DEBUG_OUTPUT
end_define

begin_comment
comment|/* ACPICA public headers */
end_comment

begin_include
include|#
directive|include
file|"acpi.h"
end_include

begin_define
define|#
directive|define
name|_COMPONENT
value|ACPI_EXAMPLE
end_define

begin_macro
name|ACPI_MODULE_NAME
argument_list|(
literal|"examples"
argument_list|)
end_macro

begin_comment
comment|/******************************************************************************  *  * ACPICA Example Code  *  * This module contains examples of how the host OS should interface to the  * ACPICA subsystem.  *  * 1) How to use the platform/acenv.h file and how to set configuration  *      options.  *  * 2) main - using the debug output mechanism and the error/warning output  *      macros.  *  * 3) Two examples of the ACPICA initialization sequence. The first is a  *      initialization with no "early" ACPI table access. The second shows  *      how to use ACPICA to obtain the tables very early during kernel  *      initialization, even before dynamic memory is available.  *  * 4) How to invoke a control method, including argument setup and how to  *      access the return value.  *  *****************************************************************************/
end_comment

begin_comment
comment|/* Standard Clib headers */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_comment
comment|/* Local Prototypes */
end_comment

begin_function_decl
name|ACPI_STATUS
name|InitializeFullAcpi
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|ACPI_STATUS
name|InstallHandlers
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|ExecuteOSI
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/******************************************************************************  *  * FUNCTION:    main  *  * PARAMETERS:  argc, argv  *  * RETURN:      Status  *  * DESCRIPTION: Main routine. Shows the use of the various output macros, as  *              well as the use of the debug layer/level globals.  *  *****************************************************************************/
end_comment

begin_function
name|int
name|ACPI_SYSTEM_XFACE
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|ACPI_FUNCTION_NAME
argument_list|(
name|Examples
operator|-
expr|main
argument_list|)
expr_stmt|;
name|InitializeFullAcpi
argument_list|()
expr_stmt|;
comment|/* Enable debug output, example debug print */
name|AcpiDbgLayer
operator|=
name|ACPI_EXAMPLE
expr_stmt|;
name|AcpiDbgLevel
operator|=
name|ACPI_LV_INIT
expr_stmt|;
name|ACPI_DEBUG_PRINT
argument_list|(
operator|(
name|ACPI_DB_INIT
operator|,
literal|"Example Debug output\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Example warning and error output */
name|ACPI_INFO
argument_list|(
operator|(
name|AE_INFO
operator|,
literal|"ACPICA example info message"
operator|)
argument_list|)
expr_stmt|;
name|ACPI_WARNING
argument_list|(
operator|(
name|AE_INFO
operator|,
literal|"ACPICA example warning message"
operator|)
argument_list|)
expr_stmt|;
name|ACPI_ERROR
argument_list|(
operator|(
name|AE_INFO
operator|,
literal|"ACPICA example error message"
operator|)
argument_list|)
expr_stmt|;
name|ACPI_EXCEPTION
argument_list|(
operator|(
name|AE_INFO
operator|,
name|AE_AML_OPERAND_TYPE
operator|,
literal|"Example exception message"
operator|)
argument_list|)
expr_stmt|;
name|ExecuteOSI
argument_list|()
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************  *  * Example ACPICA initialization code. This shows a full initialization with  * no early ACPI table access.  *  *****************************************************************************/
end_comment

begin_function
name|ACPI_STATUS
name|InitializeFullAcpi
parameter_list|(
name|void
parameter_list|)
block|{
name|ACPI_STATUS
name|Status
decl_stmt|;
comment|/* Initialize the ACPICA subsystem */
name|Status
operator|=
name|AcpiInitializeSubsystem
argument_list|()
expr_stmt|;
if|if
condition|(
name|ACPI_FAILURE
argument_list|(
name|Status
argument_list|)
condition|)
block|{
name|ACPI_EXCEPTION
argument_list|(
operator|(
name|AE_INFO
operator|,
name|Status
operator|,
literal|"While initializing ACPICA"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|Status
operator|)
return|;
block|}
comment|/* Initialize the ACPICA Table Manager and get all ACPI tables */
name|Status
operator|=
name|AcpiInitializeTables
argument_list|(
name|NULL
argument_list|,
literal|16
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|ACPI_FAILURE
argument_list|(
name|Status
argument_list|)
condition|)
block|{
name|ACPI_EXCEPTION
argument_list|(
operator|(
name|AE_INFO
operator|,
name|Status
operator|,
literal|"While initializing Table Manager"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|Status
operator|)
return|;
block|}
comment|/* Create the ACPI namespace from ACPI tables */
name|Status
operator|=
name|AcpiLoadTables
argument_list|()
expr_stmt|;
if|if
condition|(
name|ACPI_FAILURE
argument_list|(
name|Status
argument_list|)
condition|)
block|{
name|ACPI_EXCEPTION
argument_list|(
operator|(
name|AE_INFO
operator|,
name|Status
operator|,
literal|"While loading ACPI tables"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|Status
operator|)
return|;
block|}
comment|/* Install local handlers */
name|Status
operator|=
name|InstallHandlers
argument_list|()
expr_stmt|;
if|if
condition|(
name|ACPI_FAILURE
argument_list|(
name|Status
argument_list|)
condition|)
block|{
name|ACPI_EXCEPTION
argument_list|(
operator|(
name|AE_INFO
operator|,
name|Status
operator|,
literal|"While installing handlers"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|Status
operator|)
return|;
block|}
comment|/* Initialize the ACPI hardware */
name|Status
operator|=
name|AcpiEnableSubsystem
argument_list|(
name|ACPI_FULL_INITIALIZATION
argument_list|)
expr_stmt|;
if|if
condition|(
name|ACPI_FAILURE
argument_list|(
name|Status
argument_list|)
condition|)
block|{
name|ACPI_EXCEPTION
argument_list|(
operator|(
name|AE_INFO
operator|,
name|Status
operator|,
literal|"While enabling ACPICA"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|Status
operator|)
return|;
block|}
comment|/* Complete the ACPI namespace object initialization */
name|Status
operator|=
name|AcpiInitializeObjects
argument_list|(
name|ACPI_FULL_INITIALIZATION
argument_list|)
expr_stmt|;
if|if
condition|(
name|ACPI_FAILURE
argument_list|(
name|Status
argument_list|)
condition|)
block|{
name|ACPI_EXCEPTION
argument_list|(
operator|(
name|AE_INFO
operator|,
name|Status
operator|,
literal|"While initializing ACPICA objects"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|Status
operator|)
return|;
block|}
return|return
operator|(
name|AE_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************  *  * Example ACPICA initialization code with early ACPI table access. This shows  * an initialization that requires early access to ACPI tables (before  * kernel dynamic memory is available)  *  *****************************************************************************/
end_comment

begin_comment
comment|/*  * The purpose of this static table array is to avoid the use of kernel  * dynamic memory which may not be available during early ACPI table  * access.  */
end_comment

begin_define
define|#
directive|define
name|ACPI_MAX_INIT_TABLES
value|16
end_define

begin_decl_stmt
specifier|static
name|ACPI_TABLE_DESC
name|TableArray
index|[
name|ACPI_MAX_INIT_TABLES
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * This function would be called early in kernel initialization. After this  * is called, all ACPI tables are available to the host.  */
end_comment

begin_function
name|ACPI_STATUS
name|InitializeAcpiTables
parameter_list|(
name|void
parameter_list|)
block|{
name|ACPI_STATUS
name|Status
decl_stmt|;
comment|/* Initialize the ACPICA Table Manager and get all ACPI tables */
name|Status
operator|=
name|AcpiInitializeTables
argument_list|(
name|TableArray
argument_list|,
name|ACPI_MAX_INIT_TABLES
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
return|return
operator|(
name|Status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * This function would be called after the kernel is initialized and  * dynamic/virtual memory is available. It completes the initialization of  * the ACPICA subsystem.  */
end_comment

begin_function
name|ACPI_STATUS
name|InitializeAcpi
parameter_list|(
name|void
parameter_list|)
block|{
name|ACPI_STATUS
name|Status
decl_stmt|;
comment|/* Initialize the ACPICA subsystem */
name|Status
operator|=
name|AcpiInitializeSubsystem
argument_list|()
expr_stmt|;
if|if
condition|(
name|ACPI_FAILURE
argument_list|(
name|Status
argument_list|)
condition|)
block|{
return|return
operator|(
name|Status
operator|)
return|;
block|}
comment|/* Copy the root table list to dynamic memory */
name|Status
operator|=
name|AcpiReallocateRootTable
argument_list|()
expr_stmt|;
if|if
condition|(
name|ACPI_FAILURE
argument_list|(
name|Status
argument_list|)
condition|)
block|{
return|return
operator|(
name|Status
operator|)
return|;
block|}
comment|/* Create the ACPI namespace from ACPI tables */
name|Status
operator|=
name|AcpiLoadTables
argument_list|()
expr_stmt|;
if|if
condition|(
name|ACPI_FAILURE
argument_list|(
name|Status
argument_list|)
condition|)
block|{
return|return
operator|(
name|Status
operator|)
return|;
block|}
comment|/* Install local handlers */
name|Status
operator|=
name|InstallHandlers
argument_list|()
expr_stmt|;
if|if
condition|(
name|ACPI_FAILURE
argument_list|(
name|Status
argument_list|)
condition|)
block|{
name|ACPI_EXCEPTION
argument_list|(
operator|(
name|AE_INFO
operator|,
name|Status
operator|,
literal|"While installing handlers"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|Status
operator|)
return|;
block|}
comment|/* Initialize the ACPI hardware */
name|Status
operator|=
name|AcpiEnableSubsystem
argument_list|(
name|ACPI_FULL_INITIALIZATION
argument_list|)
expr_stmt|;
if|if
condition|(
name|ACPI_FAILURE
argument_list|(
name|Status
argument_list|)
condition|)
block|{
return|return
operator|(
name|Status
operator|)
return|;
block|}
comment|/* Complete the ACPI namespace object initialization */
name|Status
operator|=
name|AcpiInitializeObjects
argument_list|(
name|ACPI_FULL_INITIALIZATION
argument_list|)
expr_stmt|;
if|if
condition|(
name|ACPI_FAILURE
argument_list|(
name|Status
argument_list|)
condition|)
block|{
return|return
operator|(
name|Status
operator|)
return|;
block|}
return|return
operator|(
name|AE_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************  *  * Example ACPICA handler and handler installation  *  *****************************************************************************/
end_comment

begin_function
name|void
name|NotifyHandler
parameter_list|(
name|ACPI_HANDLE
name|Device
parameter_list|,
name|UINT32
name|Value
parameter_list|,
name|void
modifier|*
name|Context
parameter_list|)
block|{
name|ACPI_INFO
argument_list|(
operator|(
name|AE_INFO
operator|,
literal|"Received a notify 0x%X"
operator|,
name|Value
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|ACPI_STATUS
name|InstallHandlers
parameter_list|(
name|void
parameter_list|)
block|{
name|ACPI_STATUS
name|Status
decl_stmt|;
comment|/* Install global notify handler */
name|Status
operator|=
name|AcpiInstallNotifyHandler
argument_list|(
name|ACPI_ROOT_OBJECT
argument_list|,
name|ACPI_SYSTEM_NOTIFY
argument_list|,
name|NotifyHandler
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ACPI_FAILURE
argument_list|(
name|Status
argument_list|)
condition|)
block|{
name|ACPI_EXCEPTION
argument_list|(
operator|(
name|AE_INFO
operator|,
name|Status
operator|,
literal|"While installing Notify handler"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|Status
operator|)
return|;
block|}
return|return
operator|(
name|AE_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************  *  * Example control method execution.  *  * _OSI is a predefined method that is implemented internally within ACPICA.  *  * Shows the following elements:  *  * 1) How to setup a control method argument and argument list  * 2) How to setup the return value object  * 3) How to invoke AcpiEvaluateObject  * 4) How to check the returned ACPI_STATUS  * 5) How to analyze the return value  *  *****************************************************************************/
end_comment

begin_function
name|void
name|ExecuteOSI
parameter_list|(
name|void
parameter_list|)
block|{
name|ACPI_STATUS
name|Status
decl_stmt|;
name|ACPI_OBJECT_LIST
name|ArgList
decl_stmt|;
name|ACPI_OBJECT
name|Arg
index|[
literal|1
index|]
decl_stmt|;
name|ACPI_BUFFER
name|ReturnValue
decl_stmt|;
name|ACPI_OBJECT
modifier|*
name|Object
decl_stmt|;
name|ACPI_INFO
argument_list|(
operator|(
name|AE_INFO
operator|,
literal|"Executing OSI method"
operator|)
argument_list|)
expr_stmt|;
comment|/* Setup input argument */
name|ArgList
operator|.
name|Count
operator|=
literal|1
expr_stmt|;
name|ArgList
operator|.
name|Pointer
operator|=
name|Arg
expr_stmt|;
name|Arg
index|[
literal|0
index|]
operator|.
name|Type
operator|=
name|ACPI_TYPE_STRING
expr_stmt|;
name|Arg
index|[
literal|0
index|]
operator|.
name|String
operator|.
name|Pointer
operator|=
literal|"Windows 2001"
expr_stmt|;
name|Arg
index|[
literal|0
index|]
operator|.
name|String
operator|.
name|Length
operator|=
name|strlen
argument_list|(
name|Arg
index|[
literal|0
index|]
operator|.
name|String
operator|.
name|Pointer
argument_list|)
expr_stmt|;
comment|/* Ask ACPICA to allocate space for the return object */
name|ReturnValue
operator|.
name|Length
operator|=
name|ACPI_ALLOCATE_BUFFER
expr_stmt|;
name|Status
operator|=
name|AcpiEvaluateObject
argument_list|(
name|NULL
argument_list|,
literal|"\\_OSI"
argument_list|,
operator|&
name|ArgList
argument_list|,
operator|&
name|ReturnValue
argument_list|)
expr_stmt|;
if|if
condition|(
name|ACPI_FAILURE
argument_list|(
name|Status
argument_list|)
condition|)
block|{
name|ACPI_EXCEPTION
argument_list|(
operator|(
name|AE_INFO
operator|,
name|Status
operator|,
literal|"While executing _OSI"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Ensure that the return object is large enough */
if|if
condition|(
name|ReturnValue
operator|.
name|Length
operator|<
sizeof|sizeof
argument_list|(
name|ACPI_OBJECT
argument_list|)
condition|)
block|{
name|AcpiOsPrintf
argument_list|(
literal|"Return value from _OSI method too small, %.8X\n"
argument_list|,
name|ReturnValue
operator|.
name|Length
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Expect an integer return value from execution of _OSI */
name|Object
operator|=
name|ReturnValue
operator|.
name|Pointer
expr_stmt|;
if|if
condition|(
name|Object
operator|->
name|Type
operator|!=
name|ACPI_TYPE_INTEGER
condition|)
block|{
name|AcpiOsPrintf
argument_list|(
literal|"Invalid return type from _OSI, %.2X\n"
argument_list|,
name|Object
operator|->
name|Type
argument_list|)
expr_stmt|;
block|}
name|ACPI_INFO
argument_list|(
operator|(
name|AE_INFO
operator|,
literal|"_OSI returned 0x%8.8X"
operator|,
operator|(
name|UINT32
operator|)
name|Object
operator|->
name|Integer
operator|.
name|Value
operator|)
argument_list|)
expr_stmt|;
name|AcpiOsFree
argument_list|(
name|Object
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/******************************************************************************  *  * OSL support (only needed to link to the windows OSL)  *  *****************************************************************************/
end_comment

begin_decl_stmt
name|FILE
modifier|*
name|AcpiGbl_DebugFile
decl_stmt|;
end_decl_stmt

begin_function
name|ACPI_PHYSICAL_ADDRESS
name|AeLocalGetRootPointer
parameter_list|(
name|void
parameter_list|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|ACPI_THREAD_ID
name|AcpiOsGetThreadId
parameter_list|(
name|void
parameter_list|)
block|{
return|return
operator|(
literal|0xFFFF
operator|)
return|;
block|}
end_function

begin_function
name|ACPI_STATUS
name|AcpiOsExecute
parameter_list|(
name|ACPI_EXECUTE_TYPE
name|Type
parameter_list|,
name|ACPI_OSD_EXEC_CALLBACK
name|Function
parameter_list|,
name|void
modifier|*
name|Context
parameter_list|)
block|{
return|return
operator|(
name|AE_SUPPORT
operator|)
return|;
block|}
end_function

end_unit


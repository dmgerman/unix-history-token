begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/******************************************************************************  *  * Module Name: osefixf - EFI OSL interfaces  *  *****************************************************************************/
end_comment

begin_comment
comment|/*  * Copyright (C) 2000 - 2014, Intel Corp.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions, and the following disclaimer,  *    without modification.  * 2. Redistributions in binary form must reproduce at minimum a disclaimer  *    substantially similar to the "NO WARRANTY" disclaimer below  *    ("Disclaimer") and any redistribution must be conditioned upon  *    including a substantially similar Disclaimer requirement for further  *    binary redistribution.  * 3. Neither the names of the above-listed copyright holders nor the names  *    of any contributors may be used to endorse or promote products derived  *    from this software without specific prior written permission.  *  * Alternatively, this software may be distributed under the terms of the  * GNU General Public License ("GPL") version 2 as published by the Free  * Software Foundation.  *  * NO WARRANTY  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS  * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR  * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT  * HOLDERS OR CONTRIBUTORS BE LIABLE FOR SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,  * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING  * IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE  * POSSIBILITY OF SUCH DAMAGES.  */
end_comment

begin_include
include|#
directive|include
file|"acpi.h"
end_include

begin_include
include|#
directive|include
file|"accommon.h"
end_include

begin_include
include|#
directive|include
file|"acapps.h"
end_include

begin_comment
comment|/* Local definitions */
end_comment

begin_define
define|#
directive|define
name|ACPI_EFI_PRINT_LENGTH
value|256
end_define

begin_comment
comment|/* Local prototypes */
end_comment

begin_function_decl
specifier|static
name|ACPI_STATUS
name|AcpiEfiArgify
parameter_list|(
name|char
modifier|*
name|String
parameter_list|,
name|int
modifier|*
name|ArgcPtr
parameter_list|,
name|char
modifier|*
modifier|*
modifier|*
name|ArgvPtr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|BOOLEAN
name|AcpiEfiCompareGuid
parameter_list|(
name|EFI_GUID
modifier|*
name|Guid1
parameter_list|,
name|EFI_GUID
modifier|*
name|Guid2
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ACPI_STATUS
name|AcpiEfiConvertArgcv
parameter_list|(
name|CHAR16
modifier|*
name|LoadOpt
parameter_list|,
name|UINT32
name|LoadOptSize
parameter_list|,
name|int
modifier|*
name|ArgcPtr
parameter_list|,
name|char
modifier|*
modifier|*
modifier|*
name|ArgvPtr
parameter_list|,
name|char
modifier|*
modifier|*
name|BufferPtr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ACPI_PHYSICAL_ADDRESS
name|AcpiEfiGetRsdpViaGuid
parameter_list|(
name|EFI_GUID
modifier|*
name|Guid
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|CHAR16
modifier|*
name|AcpiEfiFlushFile
parameter_list|(
name|ACPI_FILE
name|File
parameter_list|,
name|CHAR16
modifier|*
name|Begin
parameter_list|,
name|CHAR16
modifier|*
name|End
parameter_list|,
name|CHAR16
modifier|*
name|Pos
parameter_list|,
name|BOOLEAN
name|FlushAll
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* Local variables */
end_comment

begin_decl_stmt
specifier|static
name|EFI_FILE_HANDLE
name|AcpiGbl_EfiCurrentVolume
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_comment
comment|/******************************************************************************  *  * FUNCTION:    AcpiEfiGetRsdpViaGuid  *  * PARAMETERS:  Guid1               - GUID to compare  *              Guid2               - GUID to compare  *  * RETURN:      TRUE if Guid1 == Guid2  *  * DESCRIPTION: Compares two GUIDs  *  *****************************************************************************/
end_comment

begin_function
specifier|static
name|BOOLEAN
name|AcpiEfiCompareGuid
parameter_list|(
name|EFI_GUID
modifier|*
name|Guid1
parameter_list|,
name|EFI_GUID
modifier|*
name|Guid2
parameter_list|)
block|{
name|INT32
modifier|*
name|g1
decl_stmt|;
name|INT32
modifier|*
name|g2
decl_stmt|;
name|INT32
name|r
decl_stmt|;
name|g1
operator|=
operator|(
name|INT32
operator|*
operator|)
name|Guid1
expr_stmt|;
name|g2
operator|=
operator|(
name|INT32
operator|*
operator|)
name|Guid2
expr_stmt|;
name|r
operator|=
name|g1
index|[
literal|0
index|]
operator|-
name|g2
index|[
literal|0
index|]
expr_stmt|;
name|r
operator||=
name|g1
index|[
literal|1
index|]
operator|-
name|g2
index|[
literal|1
index|]
expr_stmt|;
name|r
operator||=
name|g1
index|[
literal|2
index|]
operator|-
name|g2
index|[
literal|2
index|]
expr_stmt|;
name|r
operator||=
name|g1
index|[
literal|3
index|]
operator|-
name|g2
index|[
literal|3
index|]
expr_stmt|;
return|return
operator|(
name|r
condition|?
name|FALSE
else|:
name|TRUE
operator|)
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************  *  * FUNCTION:    AcpiEfiGetRsdpViaGuid  *  * PARAMETERS:  None  *  * RETURN:      RSDP address if found  *  * DESCRIPTION: Find RSDP address via EFI using specified GUID.  *  *****************************************************************************/
end_comment

begin_function
specifier|static
name|ACPI_PHYSICAL_ADDRESS
name|AcpiEfiGetRsdpViaGuid
parameter_list|(
name|EFI_GUID
modifier|*
name|Guid
parameter_list|)
block|{
name|unsigned
name|long
name|Address
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ST
operator|->
name|NumberOfTableEntries
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|AcpiEfiCompareGuid
argument_list|(
operator|&
name|ST
operator|->
name|ConfigurationTable
index|[
name|i
index|]
operator|.
name|VendorGuid
argument_list|,
name|Guid
argument_list|)
condition|)
block|{
name|Address
operator|=
operator|(
name|ACPI_PHYSICAL_ADDRESS
operator|)
name|ST
operator|->
name|ConfigurationTable
index|[
name|i
index|]
operator|.
name|VendorTable
expr_stmt|;
break|break;
block|}
block|}
return|return
operator|(
call|(
name|ACPI_PHYSICAL_ADDRESS
call|)
argument_list|(
name|Address
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************  *  * FUNCTION:    AcpiOsGetRootPointer  *  * PARAMETERS:  None  *  * RETURN:      RSDP physical address  *  * DESCRIPTION: Gets the ACPI root pointer (RSDP)  *  *****************************************************************************/
end_comment

begin_function
name|ACPI_PHYSICAL_ADDRESS
name|AcpiOsGetRootPointer
parameter_list|(
name|void
parameter_list|)
block|{
name|ACPI_PHYSICAL_ADDRESS
name|Address
decl_stmt|;
name|EFI_GUID
name|Guid10
init|=
name|ACPI_TABLE_GUID
decl_stmt|;
name|EFI_GUID
name|Guid20
init|=
name|ACPI_20_TABLE_GUID
decl_stmt|;
name|Address
operator|=
name|AcpiEfiGetRsdpViaGuid
argument_list|(
operator|&
name|Guid20
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|Address
condition|)
block|{
name|Address
operator|=
name|AcpiEfiGetRsdpViaGuid
argument_list|(
operator|&
name|Guid10
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|Address
operator|)
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************  *  * FUNCTION:    AcpiOsMapMemory  *  * PARAMETERS:  where               - Physical address of memory to be mapped  *              length              - How much memory to map  *  * RETURN:      Pointer to mapped memory. Null on error.  *  * DESCRIPTION: Map physical memory into caller's address space  *  *****************************************************************************/
end_comment

begin_function
name|void
modifier|*
name|AcpiOsMapMemory
parameter_list|(
name|ACPI_PHYSICAL_ADDRESS
name|where
parameter_list|,
name|ACPI_SIZE
name|length
parameter_list|)
block|{
return|return
operator|(
name|ACPI_TO_POINTER
argument_list|(
operator|(
name|ACPI_SIZE
operator|)
name|where
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************  *  * FUNCTION:    AcpiOsUnmapMemory  *  * PARAMETERS:  where               - Logical address of memory to be unmapped  *              length              - How much memory to unmap  *  * RETURN:      None  *  * DESCRIPTION: Delete a previously created mapping. Where and Length must  *              correspond to a previous mapping exactly.  *  *****************************************************************************/
end_comment

begin_function
name|void
name|AcpiOsUnmapMemory
parameter_list|(
name|void
modifier|*
name|where
parameter_list|,
name|ACPI_SIZE
name|length
parameter_list|)
block|{
return|return;
block|}
end_function

begin_comment
comment|/******************************************************************************  *  * FUNCTION:    Spinlock interfaces  *  * DESCRIPTION: No-op on single threaded BIOS  *  *****************************************************************************/
end_comment

begin_function
name|ACPI_STATUS
name|AcpiOsCreateLock
parameter_list|(
name|ACPI_SPINLOCK
modifier|*
name|OutHandle
parameter_list|)
block|{
return|return
operator|(
name|AE_OK
operator|)
return|;
block|}
end_function

begin_function
name|void
name|AcpiOsDeleteLock
parameter_list|(
name|ACPI_SPINLOCK
name|Handle
parameter_list|)
block|{ }
end_function

begin_function
name|ACPI_CPU_FLAGS
name|AcpiOsAcquireLock
parameter_list|(
name|ACPI_SPINLOCK
name|Handle
parameter_list|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|void
name|AcpiOsReleaseLock
parameter_list|(
name|ACPI_SPINLOCK
name|Handle
parameter_list|,
name|ACPI_CPU_FLAGS
name|Flags
parameter_list|)
block|{ }
end_function

begin_comment
comment|/******************************************************************************  *  * FUNCTION:    AcpiOsAllocate  *  * PARAMETERS:  Size                - Amount to allocate, in bytes  *  * RETURN:      Pointer to the new allocation. Null on error.  *  * DESCRIPTION: Allocate memory. Algorithm is dependent on the OS.  *  *****************************************************************************/
end_comment

begin_function
name|void
modifier|*
name|AcpiOsAllocate
parameter_list|(
name|ACPI_SIZE
name|Size
parameter_list|)
block|{
name|EFI_STATUS
name|EfiStatus
decl_stmt|;
name|void
modifier|*
name|Mem
decl_stmt|;
name|EfiStatus
operator|=
name|uefi_call_wrapper
argument_list|(
name|BS
operator|->
name|AllocatePool
argument_list|,
literal|3
argument_list|,
name|EfiLoaderData
argument_list|,
name|Size
argument_list|,
operator|&
name|Mem
argument_list|)
expr_stmt|;
if|if
condition|(
name|EFI_ERROR
argument_list|(
name|EfiStatus
argument_list|)
condition|)
block|{
name|AcpiLogError
argument_list|(
literal|"EFI_BOOT_SERVICES->AllocatePool(EfiLoaderData) failure.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
return|return
operator|(
name|Mem
operator|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|USE_NATIVE_ALLOCATE_ZEROED
end_ifdef

begin_comment
comment|/******************************************************************************  *  * FUNCTION:    AcpiOsAllocateZeroed  *  * PARAMETERS:  Size                - Amount to allocate, in bytes  *  * RETURN:      Pointer to the new allocation. Null on error.  *  * DESCRIPTION: Allocate and zero memory. Algorithm is dependent on the OS.  *  *****************************************************************************/
end_comment

begin_function
name|void
modifier|*
name|AcpiOsAllocateZeroed
parameter_list|(
name|ACPI_SIZE
name|Size
parameter_list|)
block|{
name|void
modifier|*
name|Mem
decl_stmt|;
name|Mem
operator|=
name|AcpiOsAllocate
argument_list|(
name|Size
argument_list|)
expr_stmt|;
if|if
condition|(
name|Mem
condition|)
block|{
name|ACPI_MEMSET
argument_list|(
name|Mem
argument_list|,
literal|0
argument_list|,
name|Size
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|Mem
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/******************************************************************************  *  * FUNCTION:    AcpiOsFree  *  * PARAMETERS:  Mem                 - Pointer to previously allocated memory  *  * RETURN:      None  *  * DESCRIPTION: Free memory allocated via AcpiOsAllocate  *  *****************************************************************************/
end_comment

begin_function
name|void
name|AcpiOsFree
parameter_list|(
name|void
modifier|*
name|Mem
parameter_list|)
block|{
name|uefi_call_wrapper
argument_list|(
name|BS
operator|->
name|FreePool
argument_list|,
literal|1
argument_list|,
name|Mem
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*******************************************************************************  *  * FUNCTION:    AcpiOsOpenFile  *  * PARAMETERS:  Path                - File path  *              Modes               - File operation type  *  * RETURN:      File descriptor  *  * DESCRIPTION: Open a file for reading (ACPI_FILE_READING) or/and writing  *              (ACPI_FILE_WRITING).  *  ******************************************************************************/
end_comment

begin_function
name|ACPI_FILE
name|AcpiOsOpenFile
parameter_list|(
specifier|const
name|char
modifier|*
name|Path
parameter_list|,
name|UINT8
name|Modes
parameter_list|)
block|{
name|EFI_STATUS
name|EfiStatus
init|=
name|EFI_SUCCESS
decl_stmt|;
name|UINT64
name|OpenModes
decl_stmt|;
name|EFI_FILE_HANDLE
name|EfiFile
init|=
name|NULL
decl_stmt|;
name|CHAR16
modifier|*
name|Path16
init|=
name|NULL
decl_stmt|;
name|CHAR16
modifier|*
name|Pos16
decl_stmt|;
specifier|const
name|char
modifier|*
name|Pos
decl_stmt|;
name|INTN
name|Count
decl_stmt|,
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|Path
condition|)
block|{
return|return
operator|(
name|NULL
operator|)
return|;
block|}
comment|/* Convert modes */
name|OpenModes
operator|=
name|EFI_FILE_MODE_READ
expr_stmt|;
if|if
condition|(
name|Modes
operator|&
name|ACPI_FILE_WRITING
condition|)
block|{
name|OpenModes
operator||=
operator|(
name|EFI_FILE_MODE_WRITE
operator||
name|EFI_FILE_MODE_CREATE
operator|)
expr_stmt|;
block|}
comment|/* Allocate path buffer */
name|Count
operator|=
name|ACPI_STRLEN
argument_list|(
name|Path
argument_list|)
expr_stmt|;
name|Path16
operator|=
name|ACPI_ALLOCATE_ZEROED
argument_list|(
operator|(
name|Count
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|CHAR16
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|Path16
condition|)
block|{
name|EfiStatus
operator|=
name|EFI_BAD_BUFFER_SIZE
expr_stmt|;
goto|goto
name|ErrorExit
goto|;
block|}
name|Pos
operator|=
name|Path
expr_stmt|;
name|Pos16
operator|=
name|Path16
expr_stmt|;
while|while
condition|(
operator|*
name|Pos
operator|==
literal|'/'
operator|||
operator|*
name|Pos
operator|==
literal|'\\'
condition|)
block|{
name|Pos
operator|++
expr_stmt|;
name|Count
operator|--
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|Count
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|*
name|Pos
operator|==
literal|'/'
condition|)
block|{
operator|*
name|Pos16
operator|++
operator|=
literal|'\\'
expr_stmt|;
name|Pos
operator|++
expr_stmt|;
block|}
else|else
block|{
operator|*
name|Pos16
operator|++
operator|=
operator|*
name|Pos
operator|++
expr_stmt|;
block|}
block|}
operator|*
name|Pos16
operator|=
literal|'\0'
expr_stmt|;
name|EfiStatus
operator|=
name|uefi_call_wrapper
argument_list|(
name|AcpiGbl_EfiCurrentVolume
operator|->
name|Open
argument_list|,
literal|5
argument_list|,
name|AcpiGbl_EfiCurrentVolume
argument_list|,
operator|&
name|EfiFile
argument_list|,
name|Path16
argument_list|,
name|OpenModes
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|EFI_ERROR
argument_list|(
name|EfiStatus
argument_list|)
condition|)
block|{
name|AcpiLogError
argument_list|(
literal|"EFI_FILE_HANDLE->Open() failure.\n"
argument_list|)
expr_stmt|;
goto|goto
name|ErrorExit
goto|;
block|}
name|ErrorExit
label|:
if|if
condition|(
name|Path16
condition|)
block|{
name|ACPI_FREE
argument_list|(
name|Path16
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
operator|(
name|ACPI_FILE
operator|)
name|EfiFile
operator|)
return|;
block|}
end_function

begin_comment
comment|/*******************************************************************************  *  * FUNCTION:    AcpiOsCloseFile  *  * PARAMETERS:  File                - File descriptor  *  * RETURN:      None.  *  * DESCRIPTION: Close a file.  *  ******************************************************************************/
end_comment

begin_function
name|void
name|AcpiOsCloseFile
parameter_list|(
name|ACPI_FILE
name|File
parameter_list|)
block|{
name|EFI_FILE_HANDLE
name|EfiFile
decl_stmt|;
if|if
condition|(
name|File
operator|==
name|ACPI_FILE_OUT
operator|||
name|File
operator|==
name|ACPI_FILE_ERR
condition|)
block|{
return|return;
block|}
name|EfiFile
operator|=
operator|(
name|EFI_FILE_HANDLE
operator|)
name|File
expr_stmt|;
operator|(
name|void
operator|)
name|uefi_call_wrapper
argument_list|(
name|AcpiGbl_EfiCurrentVolume
operator|->
name|Close
argument_list|,
literal|1
argument_list|,
name|EfiFile
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*******************************************************************************  *  * FUNCTION:    AcpiOsReadFile  *  * PARAMETERS:  File                - File descriptor  *              Buffer              - Data buffer  *              Size                - Data block size  *              Count               - Number of data blocks  *  * RETURN:      Size of successfully read buffer  *  * DESCRIPTION: Read from a file.  *  ******************************************************************************/
end_comment

begin_function
name|int
name|AcpiOsReadFile
parameter_list|(
name|ACPI_FILE
name|File
parameter_list|,
name|void
modifier|*
name|Buffer
parameter_list|,
name|ACPI_SIZE
name|Size
parameter_list|,
name|ACPI_SIZE
name|Count
parameter_list|)
block|{
name|int
name|Length
init|=
operator|-
literal|1
decl_stmt|;
name|EFI_FILE_HANDLE
name|EfiFile
decl_stmt|;
name|UINTN
name|ReadSize
decl_stmt|;
name|EFI_STATUS
name|EfiStatus
decl_stmt|;
if|if
condition|(
name|File
operator|==
name|ACPI_FILE_OUT
operator|||
name|File
operator|==
name|ACPI_FILE_ERR
condition|)
block|{     }
else|else
block|{
name|EfiFile
operator|=
operator|(
name|EFI_FILE_HANDLE
operator|)
name|File
expr_stmt|;
if|if
condition|(
operator|!
name|EfiFile
condition|)
block|{
goto|goto
name|ErrorExit
goto|;
block|}
name|ReadSize
operator|=
name|Size
operator|*
name|Count
expr_stmt|;
name|EfiStatus
operator|=
name|uefi_call_wrapper
argument_list|(
name|AcpiGbl_EfiCurrentVolume
operator|->
name|Read
argument_list|,
literal|3
argument_list|,
name|EfiFile
argument_list|,
operator|&
name|ReadSize
argument_list|,
name|Buffer
argument_list|)
expr_stmt|;
if|if
condition|(
name|EFI_ERROR
argument_list|(
name|EfiStatus
argument_list|)
condition|)
block|{
name|AcpiLogError
argument_list|(
literal|"EFI_FILE_HANDLE->Read() failure.\n"
argument_list|)
expr_stmt|;
goto|goto
name|ErrorExit
goto|;
block|}
name|Length
operator|=
name|ReadSize
expr_stmt|;
block|}
name|ErrorExit
label|:
return|return
operator|(
name|Length
operator|)
return|;
block|}
end_function

begin_comment
comment|/*******************************************************************************  *  * FUNCTION:    AcpiEfiFlushFile  *  * PARAMETERS:  File                - File descriptor  *              Begin               - String with boundary  *              End                 - Boundary of the string  *              Pos                 - Current position  *              FlushAll            - Whether checking boundary before flushing  *  * RETURN:      Updated position  *  * DESCRIPTION: Flush cached buffer to the file.  *  ******************************************************************************/
end_comment

begin_function
specifier|static
name|CHAR16
modifier|*
name|AcpiEfiFlushFile
parameter_list|(
name|ACPI_FILE
name|File
parameter_list|,
name|CHAR16
modifier|*
name|Begin
parameter_list|,
name|CHAR16
modifier|*
name|End
parameter_list|,
name|CHAR16
modifier|*
name|Pos
parameter_list|,
name|BOOLEAN
name|FlushAll
parameter_list|)
block|{
if|if
condition|(
name|FlushAll
operator|||
name|Pos
operator|>=
operator|(
name|End
operator|-
literal|1
operator|)
condition|)
block|{
operator|*
name|Pos
operator|=
literal|0
expr_stmt|;
name|uefi_call_wrapper
argument_list|(
name|File
operator|->
name|OutputString
argument_list|,
literal|2
argument_list|,
name|File
argument_list|,
name|Begin
argument_list|)
expr_stmt|;
name|Pos
operator|=
name|Begin
expr_stmt|;
block|}
return|return
operator|(
name|Pos
operator|)
return|;
block|}
end_function

begin_comment
comment|/*******************************************************************************  *  * FUNCTION:    AcpiOsWriteFile  *  * PARAMETERS:  File                - File descriptor  *              Buffer              - Data buffer  *              Size                - Data block size  *              Count               - Number of data blocks  *  * RETURN:      Size of successfully written buffer  *  * DESCRIPTION: Write to a file.  *  ******************************************************************************/
end_comment

begin_function
name|int
name|AcpiOsWriteFile
parameter_list|(
name|ACPI_FILE
name|File
parameter_list|,
name|void
modifier|*
name|Buffer
parameter_list|,
name|ACPI_SIZE
name|Size
parameter_list|,
name|ACPI_SIZE
name|Count
parameter_list|)
block|{
name|int
name|Length
init|=
operator|-
literal|1
decl_stmt|;
name|CHAR16
name|String
index|[
name|ACPI_EFI_PRINT_LENGTH
index|]
decl_stmt|;
specifier|const
name|char
modifier|*
name|Ascii
decl_stmt|;
name|CHAR16
modifier|*
name|End
decl_stmt|;
name|CHAR16
modifier|*
name|Pos
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|EFI_FILE_HANDLE
name|EfiFile
decl_stmt|;
name|UINTN
name|WriteSize
decl_stmt|;
name|EFI_STATUS
name|EfiStatus
decl_stmt|;
if|if
condition|(
name|File
operator|==
name|ACPI_FILE_OUT
operator|||
name|File
operator|==
name|ACPI_FILE_ERR
condition|)
block|{
name|Pos
operator|=
name|String
expr_stmt|;
name|End
operator|=
name|String
operator|+
name|ACPI_EFI_PRINT_LENGTH
operator|-
literal|1
expr_stmt|;
name|Ascii
operator|=
name|ACPI_CAST_PTR
argument_list|(
specifier|const
name|char
argument_list|,
name|Buffer
argument_list|)
expr_stmt|;
name|Length
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|Count
condition|;
name|j
operator|++
control|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|Size
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|*
name|Ascii
operator|==
literal|'\n'
condition|)
block|{
operator|*
name|Pos
operator|++
operator|=
literal|'\r'
expr_stmt|;
name|Pos
operator|=
name|AcpiEfiFlushFile
argument_list|(
name|File
argument_list|,
name|String
argument_list|,
name|End
argument_list|,
name|Pos
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
block|}
operator|*
name|Pos
operator|++
operator|=
operator|*
name|Ascii
operator|++
expr_stmt|;
name|Length
operator|++
expr_stmt|;
name|Pos
operator|=
name|AcpiEfiFlushFile
argument_list|(
name|File
argument_list|,
name|String
argument_list|,
name|End
argument_list|,
name|Pos
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
block|}
block|}
name|Pos
operator|=
name|AcpiEfiFlushFile
argument_list|(
name|File
argument_list|,
name|String
argument_list|,
name|End
argument_list|,
name|Pos
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|EfiFile
operator|=
operator|(
name|EFI_FILE_HANDLE
operator|)
name|File
expr_stmt|;
if|if
condition|(
operator|!
name|EfiFile
condition|)
block|{
goto|goto
name|ErrorExit
goto|;
block|}
name|WriteSize
operator|=
name|Size
operator|*
name|Count
expr_stmt|;
name|EfiStatus
operator|=
name|uefi_call_wrapper
argument_list|(
name|AcpiGbl_EfiCurrentVolume
operator|->
name|Write
argument_list|,
literal|3
argument_list|,
name|EfiFile
argument_list|,
operator|&
name|WriteSize
argument_list|,
name|Buffer
argument_list|)
expr_stmt|;
if|if
condition|(
name|EFI_ERROR
argument_list|(
name|EfiStatus
argument_list|)
condition|)
block|{
name|AcpiLogError
argument_list|(
literal|"EFI_FILE_HANDLE->Write() failure.\n"
argument_list|)
expr_stmt|;
goto|goto
name|ErrorExit
goto|;
block|}
name|Length
operator|=
name|WriteSize
expr_stmt|;
block|}
name|ErrorExit
label|:
return|return
operator|(
name|Length
operator|)
return|;
block|}
end_function

begin_comment
comment|/*******************************************************************************  *  * FUNCTION:    AcpiOsGetFileOffset  *  * PARAMETERS:  File                - File descriptor  *  * RETURN:      Size of current position  *  * DESCRIPTION: Get current file offset.  *  ******************************************************************************/
end_comment

begin_function
name|long
name|AcpiOsGetFileOffset
parameter_list|(
name|ACPI_FILE
name|File
parameter_list|)
block|{
name|long
name|Offset
init|=
operator|-
literal|1
decl_stmt|;
return|return
operator|(
name|Offset
operator|)
return|;
block|}
end_function

begin_comment
comment|/*******************************************************************************  *  * FUNCTION:    AcpiOsSetFileOffset  *  * PARAMETERS:  File                - File descriptor  *              Offset              - File offset  *              From                - From begin/end of file  *  * RETURN:      Status  *  * DESCRIPTION: Set current file offset.  *  ******************************************************************************/
end_comment

begin_function
name|ACPI_STATUS
name|AcpiOsSetFileOffset
parameter_list|(
name|ACPI_FILE
name|File
parameter_list|,
name|long
name|Offset
parameter_list|,
name|UINT8
name|From
parameter_list|)
block|{
return|return
operator|(
name|AE_SUPPORT
operator|)
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************  *  * FUNCTION:    AcpiOsPrintf  *  * PARAMETERS:  Format, ...         - Standard printf format  *  * RETURN:      None  *  * DESCRIPTION: Formatted output.  *  *****************************************************************************/
end_comment

begin_function
name|void
name|ACPI_INTERNAL_VAR_XFACE
name|AcpiOsPrintf
parameter_list|(
specifier|const
name|char
modifier|*
name|Format
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|Args
decl_stmt|;
name|va_start
argument_list|(
name|Args
argument_list|,
name|Format
argument_list|)
expr_stmt|;
name|AcpiOsVprintf
argument_list|(
name|Format
argument_list|,
name|Args
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|Args
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/******************************************************************************  *  * FUNCTION:    AcpiOsVprintf  *  * PARAMETERS:  Format              - Standard printf format  *              Args                - Argument list  *  * RETURN:      None  *  * DESCRIPTION: Formatted output with arguments list pointer.  *  *****************************************************************************/
end_comment

begin_function
name|void
name|AcpiOsVprintf
parameter_list|(
specifier|const
name|char
modifier|*
name|Format
parameter_list|,
name|va_list
name|Args
parameter_list|)
block|{
operator|(
name|void
operator|)
name|AcpiUtFileVprintf
argument_list|(
name|ACPI_FILE_OUT
argument_list|,
name|Format
argument_list|,
name|Args
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/******************************************************************************  *  * FUNCTION:    AcpiOsInitialize  *  * PARAMETERS:  None  *  * RETURN:      Status  *  * DESCRIPTION: Initialize this module.  *  *****************************************************************************/
end_comment

begin_function
name|ACPI_STATUS
name|AcpiOsInitialize
parameter_list|(
name|void
parameter_list|)
block|{
return|return
operator|(
name|AE_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************  *  * FUNCTION:    AcpiEfiArgify  *  * PARAMETERS:  String              - Pointer to command line argument strings  *                                    which are seperated with spaces  *              ArgcPtr             - Return number of the arguments  *              ArgvPtr             - Return vector of the arguments  *  * RETURN:      Status  *  * DESCRIPTION: Convert EFI arguments into C arguments.  *  *****************************************************************************/
end_comment

begin_function
specifier|static
name|ACPI_STATUS
name|AcpiEfiArgify
parameter_list|(
name|char
modifier|*
name|String
parameter_list|,
name|int
modifier|*
name|ArgcPtr
parameter_list|,
name|char
modifier|*
modifier|*
modifier|*
name|ArgvPtr
parameter_list|)
block|{
name|char
modifier|*
name|CopyBuffer
decl_stmt|;
name|int
name|MaxArgc
init|=
operator|*
name|ArgcPtr
decl_stmt|;
name|int
name|Argc
init|=
literal|0
decl_stmt|;
name|char
modifier|*
modifier|*
name|Argv
init|=
operator|*
name|ArgvPtr
decl_stmt|;
name|char
modifier|*
name|Arg
decl_stmt|;
name|BOOLEAN
name|IsSingleQuote
init|=
name|FALSE
decl_stmt|;
name|BOOLEAN
name|IsDoubleQuote
init|=
name|FALSE
decl_stmt|;
name|BOOLEAN
name|IsEscape
init|=
name|FALSE
decl_stmt|;
if|if
condition|(
name|String
operator|==
name|NULL
condition|)
block|{
return|return
operator|(
name|AE_BAD_PARAMETER
operator|)
return|;
block|}
name|CopyBuffer
operator|=
name|String
expr_stmt|;
while|while
condition|(
operator|*
name|String
operator|!=
literal|'\0'
condition|)
block|{
while|while
condition|(
name|ACPI_IS_SPACE
argument_list|(
operator|*
name|String
argument_list|)
condition|)
block|{
operator|*
name|String
operator|++
operator|=
literal|'\0'
expr_stmt|;
block|}
name|Arg
operator|=
name|CopyBuffer
expr_stmt|;
while|while
condition|(
operator|*
name|String
operator|!=
literal|'\0'
condition|)
block|{
if|if
condition|(
name|ACPI_IS_SPACE
argument_list|(
operator|*
name|String
argument_list|)
operator|&&
operator|!
name|IsSingleQuote
operator|&&
operator|!
name|IsDoubleQuote
operator|&&
operator|!
name|IsEscape
condition|)
block|{
operator|*
name|Arg
operator|++
operator|=
literal|'\0'
expr_stmt|;
name|String
operator|++
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|IsEscape
condition|)
block|{
name|IsEscape
operator|=
name|FALSE
expr_stmt|;
operator|*
name|Arg
operator|++
operator|=
operator|*
name|String
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|*
name|String
operator|==
literal|'\\'
condition|)
block|{
name|IsEscape
operator|=
name|TRUE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|IsSingleQuote
condition|)
block|{
if|if
condition|(
operator|*
name|String
operator|==
literal|'\''
condition|)
block|{
name|IsSingleQuote
operator|=
name|FALSE
expr_stmt|;
operator|*
name|Arg
operator|++
operator|=
literal|'\0'
expr_stmt|;
block|}
else|else
block|{
operator|*
name|Arg
operator|++
operator|=
operator|*
name|String
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|IsDoubleQuote
condition|)
block|{
if|if
condition|(
operator|*
name|String
operator|==
literal|'"'
condition|)
block|{
name|IsDoubleQuote
operator|=
name|FALSE
expr_stmt|;
operator|*
name|Arg
operator|=
literal|'\0'
expr_stmt|;
block|}
else|else
block|{
operator|*
name|Arg
operator|++
operator|=
operator|*
name|String
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
operator|*
name|String
operator|==
literal|'\''
condition|)
block|{
name|IsSingleQuote
operator|=
name|TRUE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|*
name|String
operator|==
literal|'"'
condition|)
block|{
name|IsDoubleQuote
operator|=
name|TRUE
expr_stmt|;
block|}
else|else
block|{
operator|*
name|Arg
operator|++
operator|=
operator|*
name|String
expr_stmt|;
block|}
block|}
name|String
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|Argv
operator|&&
name|Argc
operator|<
name|MaxArgc
condition|)
block|{
name|Argv
index|[
name|Argc
index|]
operator|=
name|CopyBuffer
expr_stmt|;
block|}
name|Argc
operator|++
expr_stmt|;
name|CopyBuffer
operator|=
name|Arg
expr_stmt|;
block|}
if|if
condition|(
name|Argv
operator|&&
name|Argc
operator|<
name|MaxArgc
condition|)
block|{
name|Argv
index|[
name|Argc
index|]
operator|=
name|NULL
expr_stmt|;
block|}
operator|*
name|ArgcPtr
operator|=
name|Argc
expr_stmt|;
operator|*
name|ArgvPtr
operator|=
name|Argv
expr_stmt|;
return|return
operator|(
operator|(
name|MaxArgc
operator|<
name|Argc
operator|)
condition|?
name|AE_NO_MEMORY
else|:
name|AE_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************  *  * FUNCTION:    AcpiEfiConvertArgcv  *  * PARAMETERS:  LoadOptions         - Pointer to the EFI options buffer, which  *                                    is NULL terminated  *              LoadOptionsSize     - Size of the EFI options buffer  *              ArgcPtr             - Return number of the arguments  *              ArgvPtr             - Return vector of the arguments  *              BufferPtr           - Buffer to contain the argument strings  *  * RETURN:      Status  *  * DESCRIPTION: Convert EFI arguments into C arguments.  *  *****************************************************************************/
end_comment

begin_function
specifier|static
name|ACPI_STATUS
name|AcpiEfiConvertArgcv
parameter_list|(
name|CHAR16
modifier|*
name|LoadOptions
parameter_list|,
name|UINT32
name|LoadOptionsSize
parameter_list|,
name|int
modifier|*
name|ArgcPtr
parameter_list|,
name|char
modifier|*
modifier|*
modifier|*
name|ArgvPtr
parameter_list|,
name|char
modifier|*
modifier|*
name|BufferPtr
parameter_list|)
block|{
name|ACPI_STATUS
name|Status
init|=
name|AE_OK
decl_stmt|;
name|UINT32
name|Count
init|=
name|LoadOptionsSize
operator|/
sizeof|sizeof
argument_list|(
name|CHAR16
argument_list|)
decl_stmt|;
name|UINT32
name|i
decl_stmt|;
name|CHAR16
modifier|*
name|From
decl_stmt|;
name|char
modifier|*
name|To
decl_stmt|;
name|int
name|Argc
init|=
literal|0
decl_stmt|;
name|char
modifier|*
modifier|*
name|Argv
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|Buffer
decl_stmt|;
comment|/* Prepare a buffer to contain the argument strings */
name|Buffer
operator|=
name|ACPI_ALLOCATE_ZEROED
argument_list|(
name|Count
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|Buffer
condition|)
block|{
name|Status
operator|=
name|AE_NO_MEMORY
expr_stmt|;
goto|goto
name|ErrorExit
goto|;
block|}
name|TryAgain
label|:
comment|/* Extend the argument vector */
if|if
condition|(
name|Argv
condition|)
block|{
name|ACPI_FREE
argument_list|(
name|Argv
argument_list|)
expr_stmt|;
name|Argv
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|Argc
operator|>
literal|0
condition|)
block|{
name|Argv
operator|=
name|ACPI_ALLOCATE_ZEROED
argument_list|(
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
operator|*
operator|(
name|Argc
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|Argv
condition|)
block|{
name|Status
operator|=
name|AE_NO_MEMORY
expr_stmt|;
goto|goto
name|ErrorExit
goto|;
block|}
block|}
comment|/*      * Note: As AcpiEfiArgify() will modify the content of the buffer, so      *       we need to restore it each time before invoking      *       AcpiEfiArgify().      */
name|From
operator|=
name|LoadOptions
expr_stmt|;
name|To
operator|=
name|ACPI_CAST_PTR
argument_list|(
name|char
argument_list|,
name|Buffer
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|Count
condition|;
name|i
operator|++
control|)
block|{
operator|*
name|To
operator|++
operator|=
operator|(
name|char
operator|)
operator|*
name|From
operator|++
expr_stmt|;
block|}
comment|/*      * The "Buffer" will contain NULL terminated strings after invoking      * AcpiEfiArgify(). The number of the strings are saved in Argc and the      * pointers of the strings are saved in Argv.      */
name|Status
operator|=
name|AcpiEfiArgify
argument_list|(
name|Buffer
argument_list|,
operator|&
name|Argc
argument_list|,
operator|&
name|Argv
argument_list|)
expr_stmt|;
if|if
condition|(
name|ACPI_FAILURE
argument_list|(
name|Status
argument_list|)
condition|)
block|{
if|if
condition|(
name|Status
operator|==
name|AE_NO_MEMORY
condition|)
block|{
goto|goto
name|TryAgain
goto|;
block|}
block|}
name|ErrorExit
label|:
if|if
condition|(
name|ACPI_FAILURE
argument_list|(
name|Status
argument_list|)
condition|)
block|{
name|ACPI_FREE
argument_list|(
name|Buffer
argument_list|)
expr_stmt|;
name|ACPI_FREE
argument_list|(
name|Argv
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|*
name|ArgcPtr
operator|=
name|Argc
expr_stmt|;
operator|*
name|ArgvPtr
operator|=
name|Argv
expr_stmt|;
operator|*
name|BufferPtr
operator|=
name|Buffer
expr_stmt|;
block|}
return|return
operator|(
name|Status
operator|)
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************  *  * FUNCTION:    efi_main  *  * PARAMETERS:  Image               - EFI image handle  *              SystemTab           - EFI system table  *  * RETURN:      EFI Status  *  * DESCRIPTION: Entry point of EFI executable  *  *****************************************************************************/
end_comment

begin_function
name|EFI_STATUS
name|efi_main
parameter_list|(
name|EFI_HANDLE
name|Image
parameter_list|,
name|EFI_SYSTEM_TABLE
modifier|*
name|SystemTab
parameter_list|)
block|{
name|EFI_LOADED_IMAGE
modifier|*
name|Info
decl_stmt|;
name|EFI_STATUS
name|EfiStatus
init|=
name|EFI_SUCCESS
decl_stmt|;
name|ACPI_STATUS
name|Status
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|OptBuffer
init|=
name|NULL
decl_stmt|;
name|EFI_FILE_IO_INTERFACE
modifier|*
name|Volume
init|=
name|NULL
decl_stmt|;
comment|/* Initialize EFI library */
name|InitializeLib
argument_list|(
name|Image
argument_list|,
name|SystemTab
argument_list|)
expr_stmt|;
comment|/* Retrieve image information */
name|EfiStatus
operator|=
name|uefi_call_wrapper
argument_list|(
name|BS
operator|->
name|HandleProtocol
argument_list|,
literal|3
argument_list|,
name|Image
argument_list|,
operator|&
name|LoadedImageProtocol
argument_list|,
name|ACPI_CAST_PTR
argument_list|(
name|VOID
argument_list|,
operator|&
name|Info
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|EFI_ERROR
argument_list|(
name|EfiStatus
argument_list|)
condition|)
block|{
name|AcpiLogError
argument_list|(
literal|"EFI_BOOT_SERVICES->HandleProtocol(LoadedImageProtocol) failure.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EfiStatus
operator|)
return|;
block|}
name|EfiStatus
operator|=
name|uefi_call_wrapper
argument_list|(
name|BS
operator|->
name|HandleProtocol
argument_list|,
literal|3
argument_list|,
name|Info
operator|->
name|DeviceHandle
argument_list|,
operator|&
name|FileSystemProtocol
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|Volume
argument_list|)
expr_stmt|;
if|if
condition|(
name|EFI_ERROR
argument_list|(
name|EfiStatus
argument_list|)
condition|)
block|{
name|AcpiLogError
argument_list|(
literal|"EFI_BOOT_SERVICES->HandleProtocol(FileSystemProtocol) failure.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EfiStatus
operator|)
return|;
block|}
name|EfiStatus
operator|=
name|uefi_call_wrapper
argument_list|(
name|Volume
operator|->
name|OpenVolume
argument_list|,
literal|2
argument_list|,
name|Volume
argument_list|,
operator|&
name|AcpiGbl_EfiCurrentVolume
argument_list|)
expr_stmt|;
if|if
condition|(
name|EFI_ERROR
argument_list|(
name|EfiStatus
argument_list|)
condition|)
block|{
name|AcpiLogError
argument_list|(
literal|"EFI_FILE_IO_INTERFACE->OpenVolume() failure.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EfiStatus
operator|)
return|;
block|}
name|Status
operator|=
name|AcpiEfiConvertArgcv
argument_list|(
name|Info
operator|->
name|LoadOptions
argument_list|,
name|Info
operator|->
name|LoadOptionsSize
argument_list|,
operator|&
name|argc
argument_list|,
operator|&
name|argv
argument_list|,
operator|&
name|OptBuffer
argument_list|)
expr_stmt|;
if|if
condition|(
name|ACPI_FAILURE
argument_list|(
name|Status
argument_list|)
condition|)
block|{
name|EfiStatus
operator|=
name|EFI_DEVICE_ERROR
expr_stmt|;
goto|goto
name|ErrorAlloc
goto|;
block|}
name|acpi_main
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|)
expr_stmt|;
name|ErrorAlloc
label|:
if|if
condition|(
name|argv
condition|)
block|{
name|ACPI_FREE
argument_list|(
name|argv
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|OptBuffer
condition|)
block|{
name|ACPI_FREE
argument_list|(
name|OptBuffer
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|EfiStatus
operator|)
return|;
block|}
end_function

end_unit


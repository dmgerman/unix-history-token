begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* call_graph.c  -  Create call graphs.     Copyright 2000, 2001, 2002 Free Software Foundation, Inc.     This file is part of GNU Binutils.     This program is free software; you can redistribute it and/or modify    it under the terms of the GNU General Public License as published by    the Free Software Foundation; either version 2 of the License, or    (at your option) any later version.     This program is distributed in the hope that it will be useful,    but WITHOUT ANY WARRANTY; without even the implied warranty of    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the    GNU General Public License for more details.     You should have received a copy of the GNU General Public License    along with this program; if not, write to the Free Software    Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA    02111-1307, USA.  */
end_comment

begin_escape
end_escape

begin_include
include|#
directive|include
file|"gprof.h"
end_include

begin_include
include|#
directive|include
file|"search_list.h"
end_include

begin_include
include|#
directive|include
file|"source.h"
end_include

begin_include
include|#
directive|include
file|"symtab.h"
end_include

begin_include
include|#
directive|include
file|"cg_arcs.h"
end_include

begin_include
include|#
directive|include
file|"call_graph.h"
end_include

begin_include
include|#
directive|include
file|"corefile.h"
end_include

begin_include
include|#
directive|include
file|"gmon_io.h"
end_include

begin_include
include|#
directive|include
file|"gmon_out.h"
end_include

begin_include
include|#
directive|include
file|"sym_ids.h"
end_include

begin_function
name|void
name|cg_tally
parameter_list|(
name|from_pc
parameter_list|,
name|self_pc
parameter_list|,
name|count
parameter_list|)
name|bfd_vma
name|from_pc
decl_stmt|;
name|bfd_vma
name|self_pc
decl_stmt|;
name|unsigned
name|long
name|count
decl_stmt|;
block|{
name|Sym
modifier|*
name|parent
decl_stmt|;
name|Sym
modifier|*
name|child
decl_stmt|;
name|parent
operator|=
name|sym_lookup
argument_list|(
operator|&
name|symtab
argument_list|,
name|from_pc
argument_list|)
expr_stmt|;
name|child
operator|=
name|sym_lookup
argument_list|(
operator|&
name|symtab
argument_list|,
name|self_pc
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
name|NULL
operator|||
name|parent
operator|==
name|NULL
condition|)
return|return;
comment|/* If we're doing line-by-line profiling, both the parent and the      child will probably point to line symbols instead of function      symbols.  For the parent this is fine, since this identifies the      line number in the calling routing, but the child should always      point to a function entry point, so we back up in the symbol      table until we find it.       For normal profiling, is_func will be set on all symbols, so this      code will do nothing.  */
while|while
condition|(
name|child
operator|>=
name|symtab
operator|.
name|base
operator|&&
operator|!
name|child
operator|->
name|is_func
condition|)
operator|--
name|child
expr_stmt|;
if|if
condition|(
name|child
operator|<
name|symtab
operator|.
name|base
condition|)
return|return;
comment|/* Keep arc if it is on INCL_ARCS table or if the INCL_ARCS table      is empty and it is not in the EXCL_ARCS table.  */
if|if
condition|(
name|sym_id_arc_is_present
argument_list|(
operator|&
name|syms
index|[
name|INCL_ARCS
index|]
argument_list|,
name|parent
argument_list|,
name|child
argument_list|)
operator|||
operator|(
name|syms
index|[
name|INCL_ARCS
index|]
operator|.
name|len
operator|==
literal|0
operator|&&
operator|!
name|sym_id_arc_is_present
argument_list|(
operator|&
name|syms
index|[
name|EXCL_ARCS
index|]
argument_list|,
name|parent
argument_list|,
name|child
argument_list|)
operator|)
condition|)
block|{
name|child
operator|->
name|ncalls
operator|+=
name|count
expr_stmt|;
name|DBG
argument_list|(
name|TALLYDEBUG
argument_list|,
name|printf
argument_list|(
name|_
argument_list|(
literal|"[cg_tally] arc from %s to %s traversed %lu times\n"
argument_list|)
argument_list|,
name|parent
operator|->
name|name
argument_list|,
name|child
operator|->
name|name
argument_list|,
name|count
argument_list|)
argument_list|)
expr_stmt|;
name|arc_add
argument_list|(
name|parent
argument_list|,
name|child
argument_list|,
name|count
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* Read a record from file IFP describing an arc in the function    call-graph and the count of how many times the arc has been    traversed.  FILENAME is the name of file IFP and is provided    for formatting error-messages only.  */
end_comment

begin_function
name|void
name|cg_read_rec
parameter_list|(
name|ifp
parameter_list|,
name|filename
parameter_list|)
name|FILE
modifier|*
name|ifp
decl_stmt|;
specifier|const
name|char
modifier|*
name|filename
decl_stmt|;
block|{
name|bfd_vma
name|from_pc
decl_stmt|,
name|self_pc
decl_stmt|;
name|unsigned
name|int
name|count
decl_stmt|;
if|if
condition|(
name|gmon_io_read_vma
argument_list|(
name|ifp
argument_list|,
operator|&
name|from_pc
argument_list|)
operator|||
name|gmon_io_read_vma
argument_list|(
name|ifp
argument_list|,
operator|&
name|self_pc
argument_list|)
operator|||
name|gmon_io_read_32
argument_list|(
name|ifp
argument_list|,
operator|&
name|count
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
name|_
argument_list|(
literal|"%s: %s: unexpected end of file\n"
argument_list|)
argument_list|,
name|whoami
argument_list|,
name|filename
argument_list|)
expr_stmt|;
name|done
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|DBG
argument_list|(
name|SAMPLEDEBUG
argument_list|,
name|printf
argument_list|(
literal|"[cg_read_rec] frompc 0x%lx selfpc 0x%lx count %lu\n"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|from_pc
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|self_pc
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|count
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Add this arc:  */
name|cg_tally
argument_list|(
name|from_pc
argument_list|,
name|self_pc
argument_list|,
name|count
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Write all the arcs in the call-graph to file OFP.  FILENAME is    the name of OFP and is provided for formatting error-messages    only.  */
end_comment

begin_function
name|void
name|cg_write_arcs
parameter_list|(
name|ofp
parameter_list|,
name|filename
parameter_list|)
name|FILE
modifier|*
name|ofp
decl_stmt|;
specifier|const
name|char
modifier|*
name|filename
decl_stmt|;
block|{
name|Arc
modifier|*
name|arc
decl_stmt|;
name|Sym
modifier|*
name|sym
decl_stmt|;
for|for
control|(
name|sym
operator|=
name|symtab
operator|.
name|base
init|;
name|sym
operator|<
name|symtab
operator|.
name|limit
condition|;
name|sym
operator|++
control|)
block|{
for|for
control|(
name|arc
operator|=
name|sym
operator|->
name|cg
operator|.
name|children
init|;
name|arc
condition|;
name|arc
operator|=
name|arc
operator|->
name|next_child
control|)
block|{
if|if
condition|(
name|gmon_io_write_8
argument_list|(
name|ofp
argument_list|,
name|GMON_TAG_CG_ARC
argument_list|)
operator|||
name|gmon_io_write_vma
argument_list|(
name|ofp
argument_list|,
name|arc
operator|->
name|parent
operator|->
name|addr
argument_list|)
operator|||
name|gmon_io_write_vma
argument_list|(
name|ofp
argument_list|,
name|arc
operator|->
name|child
operator|->
name|addr
argument_list|)
operator|||
name|gmon_io_write_32
argument_list|(
name|ofp
argument_list|,
name|arc
operator|->
name|count
argument_list|)
condition|)
block|{
name|perror
argument_list|(
name|filename
argument_list|)
expr_stmt|;
name|done
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|DBG
argument_list|(
name|SAMPLEDEBUG
argument_list|,
name|printf
argument_list|(
literal|"[cg_write_arcs] frompc 0x%lx selfpc 0x%lx count %lu\n"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|arc
operator|->
name|parent
operator|->
name|addr
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|arc
operator|->
name|child
operator|->
name|addr
argument_list|,
name|arc
operator|->
name|count
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

end_unit


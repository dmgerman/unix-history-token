begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<ck_array.h>
end_include

begin_include
include|#
directive|include
file|<limits.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|"../../common.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|ITERATION
end_ifndef

begin_define
define|#
directive|define
name|ITERATION
value|128
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|void
name|my_free
parameter_list|(
name|void
modifier|*
name|p
parameter_list|,
name|size_t
name|m
parameter_list|,
name|bool
name|d
parameter_list|)
block|{
operator|(
name|void
operator|)
name|m
expr_stmt|;
operator|(
name|void
operator|)
name|d
expr_stmt|;
name|free
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|my_malloc
parameter_list|(
name|size_t
name|b
parameter_list|)
block|{
return|return
name|malloc
argument_list|(
name|b
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|my_realloc
parameter_list|(
name|void
modifier|*
name|r
parameter_list|,
name|size_t
name|a
parameter_list|,
name|size_t
name|b
parameter_list|,
name|bool
name|d
parameter_list|)
block|{
operator|(
name|void
operator|)
name|a
expr_stmt|;
operator|(
name|void
operator|)
name|d
expr_stmt|;
return|return
name|realloc
argument_list|(
name|r
argument_list|,
name|b
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|void
parameter_list|)
block|{
name|void
modifier|*
name|r
decl_stmt|;
name|uintptr_t
name|i
decl_stmt|;
name|ck_array_t
name|array
decl_stmt|;
name|ck_array_iterator_t
name|iterator
decl_stmt|;
name|struct
name|ck_malloc
name|m
init|=
block|{
operator|.
name|malloc
operator|=
name|my_malloc
block|,
operator|.
name|free
operator|=
name|NULL
block|,
operator|.
name|realloc
operator|=
name|my_realloc
block|}
decl_stmt|;
if|if
condition|(
name|ck_array_init
argument_list|(
operator|&
name|array
argument_list|,
name|CK_ARRAY_MODE_SPMC
argument_list|,
operator|&
name|m
argument_list|,
literal|4
argument_list|)
operator|==
name|true
condition|)
name|ck_error
argument_list|(
literal|"ck_array_init with NULL free succeeded\n"
argument_list|)
expr_stmt|;
name|m
operator|.
name|free
operator|=
name|my_free
expr_stmt|;
if|if
condition|(
name|ck_array_init
argument_list|(
operator|&
name|array
argument_list|,
name|CK_ARRAY_MODE_SPMC
argument_list|,
operator|&
name|m
argument_list|,
literal|4
argument_list|)
operator|==
name|false
condition|)
name|ck_error
argument_list|(
literal|"ck_array_init\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ITERATION
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ck_array_put
argument_list|(
operator|&
name|array
argument_list|,
operator|(
name|void
operator|*
operator|)
name|i
argument_list|)
operator|==
name|false
condition|)
name|ck_error
argument_list|(
literal|"ck_error_put\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ck_array_remove
argument_list|(
operator|&
name|array
argument_list|,
operator|(
name|void
operator|*
operator|)
name|i
argument_list|)
operator|==
name|false
condition|)
name|ck_error
argument_list|(
literal|"ck_error_remove after put\n"
argument_list|)
expr_stmt|;
block|}
name|i
operator|=
literal|0
expr_stmt|;
name|CK_ARRAY_FOREACH
argument_list|(
argument|&array
argument_list|,
argument|&iterator
argument_list|,
argument|&r
argument_list|)
name|i
operator|++
expr_stmt|;
if|if
condition|(
name|i
operator|!=
literal|0
condition|)
name|ck_error
argument_list|(
literal|"Non-empty array after put -> remove workload.\n"
argument_list|)
expr_stmt|;
name|ck_array_commit
argument_list|(
operator|&
name|array
argument_list|)
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
name|CK_ARRAY_FOREACH
argument_list|(
argument|&array
argument_list|,
argument|&iterator
argument_list|,
argument|&r
argument_list|)
name|i
operator|++
expr_stmt|;
if|if
condition|(
name|i
operator|!=
literal|0
condition|)
name|ck_error
argument_list|(
literal|"Non-empty array after put -> remove -> commit workload.\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ITERATION
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ck_array_put
argument_list|(
operator|&
name|array
argument_list|,
operator|(
name|void
operator|*
operator|)
name|i
argument_list|)
operator|==
name|false
condition|)
name|ck_error
argument_list|(
literal|"ck_error_put\n"
argument_list|)
expr_stmt|;
block|}
name|i
operator|=
literal|0
expr_stmt|;
name|CK_ARRAY_FOREACH
argument_list|(
argument|&array
argument_list|,
argument|&iterator
argument_list|,
argument|&r
argument_list|)
name|i
operator|++
expr_stmt|;
if|if
condition|(
name|i
operator|!=
literal|0
condition|)
name|ck_error
argument_list|(
literal|"Non-empty array after put workload.\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ITERATION
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ck_array_remove
argument_list|(
operator|&
name|array
argument_list|,
operator|(
name|void
operator|*
operator|)
name|i
argument_list|)
operator|==
name|false
condition|)
name|ck_error
argument_list|(
literal|"ck_error_remove after put\n"
argument_list|)
expr_stmt|;
block|}
name|i
operator|=
literal|0
expr_stmt|;
name|CK_ARRAY_FOREACH
argument_list|(
argument|&array
argument_list|,
argument|&iterator
argument_list|,
argument|&r
argument_list|)
name|i
operator|++
expr_stmt|;
if|if
condition|(
name|i
operator|!=
literal|0
condition|)
name|ck_error
argument_list|(
literal|"Non-empty array after put -> remove workload.\n"
argument_list|)
expr_stmt|;
name|ck_array_commit
argument_list|(
operator|&
name|array
argument_list|)
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
name|CK_ARRAY_FOREACH
argument_list|(
argument|&array
argument_list|,
argument|&iterator
argument_list|,
argument|&r
argument_list|)
name|i
operator|++
expr_stmt|;
if|if
condition|(
name|i
operator|!=
literal|0
condition|)
name|ck_error
argument_list|(
literal|"Non-empty array after put -> remove -> commit workload.\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ITERATION
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ck_array_put
argument_list|(
operator|&
name|array
argument_list|,
operator|(
name|void
operator|*
operator|)
name|i
argument_list|)
operator|==
name|false
condition|)
name|ck_error
argument_list|(
literal|"ck_error_put\n"
argument_list|)
expr_stmt|;
block|}
name|ck_array_commit
argument_list|(
operator|&
name|array
argument_list|)
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
name|CK_ARRAY_FOREACH
argument_list|(
argument|&array
argument_list|,
argument|&iterator
argument_list|,
argument|&r
argument_list|)
block|{
name|i
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|!=
name|ITERATION
condition|)
name|ck_error
argument_list|(
literal|"Incorrect item count in iteration\n"
argument_list|)
expr_stmt|;
name|ck_array_remove
argument_list|(
operator|&
name|array
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
literal|0
argument_list|)
expr_stmt|;
name|ck_array_remove
argument_list|(
operator|&
name|array
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
literal|1
argument_list|)
expr_stmt|;
name|ck_array_commit
argument_list|(
operator|&
name|array
argument_list|)
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
name|CK_ARRAY_FOREACH
argument_list|(
argument|&array
argument_list|,
argument|&iterator
argument_list|,
argument|&r
argument_list|)
name|i
operator|++
expr_stmt|;
if|if
condition|(
name|i
operator|!=
name|ITERATION
operator|-
literal|2
operator|||
name|ck_array_length
argument_list|(
operator|&
name|array
argument_list|)
operator|!=
name|ITERATION
operator|-
literal|2
condition|)
name|ck_error
argument_list|(
literal|"Incorrect item count in iteration after remove\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ck_array_put_unique
argument_list|(
operator|&
name|array
argument_list|,
operator|(
name|void
operator|*
operator|)
name|UINTPTR_MAX
argument_list|)
operator|!=
literal|0
condition|)
name|ck_error
argument_list|(
literal|"Unique value put failed.\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ck_array_put_unique
argument_list|(
operator|&
name|array
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
literal|4
argument_list|)
operator|!=
literal|1
condition|)
name|ck_error
argument_list|(
literal|"put of 4 not detected as non-unique.\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ck_array_put_unique
argument_list|(
operator|&
name|array
argument_list|,
operator|(
name|void
operator|*
operator|)
name|UINTPTR_MAX
argument_list|)
operator|!=
literal|1
condition|)
name|ck_error
argument_list|(
literal|"put of UINTPTR_MAX not detected as non-unique.\n"
argument_list|)
expr_stmt|;
name|ck_array_commit
argument_list|(
operator|&
name|array
argument_list|)
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
name|CK_ARRAY_FOREACH
argument_list|(
argument|&array
argument_list|,
argument|&iterator
argument_list|,
argument|&r
argument_list|)
block|{
name|i
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|!=
name|ITERATION
operator|-
literal|1
operator|||
name|ck_array_length
argument_list|(
operator|&
name|array
argument_list|)
operator|!=
name|ITERATION
operator|-
literal|1
condition|)
name|ck_error
argument_list|(
literal|"Incorrect item count in iteration after unique put\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ck_array_initialized
argument_list|(
operator|&
name|array
argument_list|)
operator|==
name|false
condition|)
name|ck_error
argument_list|(
literal|"Error, expected array to be initialized.\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ITERATION
operator|*
literal|4
condition|;
name|i
operator|++
control|)
block|{
name|ck_array_remove
argument_list|(
operator|&
name|array
argument_list|,
operator|(
name|void
operator|*
operator|)
name|i
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ITERATION
operator|*
literal|16
condition|;
name|i
operator|++
control|)
block|{
name|ck_array_put
argument_list|(
operator|&
name|array
argument_list|,
operator|(
name|void
operator|*
operator|)
name|i
argument_list|)
expr_stmt|;
block|}
name|ck_array_commit
argument_list|(
operator|&
name|array
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ITERATION
operator|*
literal|128
condition|;
name|i
operator|++
control|)
block|{
name|ck_array_put
argument_list|(
operator|&
name|array
argument_list|,
operator|(
name|void
operator|*
operator|)
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|ck_array_put_unique
argument_list|(
operator|&
name|array
argument_list|,
operator|(
name|void
operator|*
operator|)
name|i
argument_list|)
operator|!=
literal|1
condition|)
name|ck_error
argument_list|(
literal|"put_unique for non-unique value should fail.\n"
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ITERATION
operator|*
literal|64
condition|;
name|i
operator|++
control|)
block|{
name|bool
name|f
init|=
name|ck_array_remove
argument_list|(
operator|&
name|array
argument_list|,
operator|(
name|void
operator|*
operator|)
name|i
argument_list|)
decl_stmt|;
if|if
condition|(
name|f
operator|==
name|false
operator|&&
name|i
operator|<
name|ITERATION
operator|*
literal|144
condition|)
name|ck_error
argument_list|(
literal|"Remove failed for existing entry.\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|==
name|true
operator|&&
name|i
operator|>
name|ITERATION
operator|*
literal|144
condition|)
name|ck_error
argument_list|(
literal|"Remove succeeded for non-existing entry.\n"
argument_list|)
expr_stmt|;
block|}
name|ck_array_commit
argument_list|(
operator|&
name|array
argument_list|)
expr_stmt|;
name|ck_array_deinit
argument_list|(
operator|&
name|array
argument_list|,
name|false
argument_list|)
expr_stmt|;
if|if
condition|(
name|ck_array_initialized
argument_list|(
operator|&
name|array
argument_list|)
operator|==
name|true
condition|)
name|ck_error
argument_list|(
literal|"Error, expected array to be uninitialized.\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


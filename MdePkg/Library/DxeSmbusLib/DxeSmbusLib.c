begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/** @file Implementation of SmBusLib class library for DXE phase.  Copyright (c) 2006 - 2010, Intel Corporation. All rights reserved.<BR> This program and the accompanying materials are licensed and made available under the terms and conditions of the BSD License which accompanies this distribution.  The full text of the license may be found at http://opensource.org/licenses/bsd-license.php.  THE PROGRAM IS DISTRIBUTED UNDER THE BSD LICENSE ON AN "AS IS" BASIS, WITHOUT WARRANTIES OR REPRESENTATIONS OF ANY KIND, EITHER EXPRESS OR IMPLIED.   **/
end_comment

begin_include
include|#
directive|include
file|"InternalSmbusLib.h"
end_include

begin_comment
comment|//
end_comment

begin_comment
comment|// Globle varible to cache pointer to Smbus protocol.
end_comment

begin_comment
comment|//
end_comment

begin_decl_stmt
name|EFI_SMBUS_HC_PROTOCOL
modifier|*
name|mSmbus
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_comment
comment|/**   The constructor function caches the pointer to Smbus protocol.    The constructor function locates Smbus protocol from protocol database.   It will ASSERT() if that operation fails and it will always return EFI_SUCCESS.    @param  ImageHandle   The firmware allocated handle for the EFI image.   @param  SystemTable   A pointer to the EFI System Table.    @retval EFI_SUCCESS   The constructor always returns EFI_SUCCESS.  **/
end_comment

begin_function
name|EFI_STATUS
name|EFIAPI
name|SmbusLibConstructor
parameter_list|(
name|IN
name|EFI_HANDLE
name|ImageHandle
parameter_list|,
name|IN
name|EFI_SYSTEM_TABLE
modifier|*
name|SystemTable
parameter_list|)
block|{
name|EFI_STATUS
name|Status
decl_stmt|;
name|Status
operator|=
name|gBS
operator|->
name|LocateProtocol
argument_list|(
operator|&
name|gEfiSmbusHcProtocolGuid
argument_list|,
name|NULL
argument_list|,
operator|(
name|VOID
operator|*
operator|*
operator|)
operator|&
name|mSmbus
argument_list|)
expr_stmt|;
name|ASSERT_EFI_ERROR
argument_list|(
name|Status
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|mSmbus
operator|!=
name|NULL
argument_list|)
expr_stmt|;
return|return
name|Status
return|;
block|}
end_function

begin_comment
comment|/**   Executes an SMBus operation to an SMBus controller.    This function provides a standard way to execute Smbus script   as defined in the SmBus Specification. The data can either be of   the Length byte, word, or a block of data.    @param  SmbusOperation  Signifies which particular SMBus hardware protocol instance                            that it will use to execute the SMBus transactions.   @param  SmBusAddress    The address that encodes the SMBUS Slave Address,                           SMBUS Command, SMBUS Data Length, and PEC.   @param  Length          Signifies the number of bytes that this operation will do.                            The maximum number of bytes can be revision specific                            and operation specific.   @param  Buffer          Contains the value of data to execute to the SMBus slave                            device. Not all operations require this argument. The                            length of this buffer is identified by Length.   @param  Status          Return status for the executed command.                           This is an optional parameter and may be NULL.    @return The actual number of bytes that are executed for this operation.  **/
end_comment

begin_function
name|UINTN
name|InternalSmBusExec
parameter_list|(
name|IN
name|EFI_SMBUS_OPERATION
name|SmbusOperation
parameter_list|,
name|IN
name|UINTN
name|SmBusAddress
parameter_list|,
name|IN
name|UINTN
name|Length
parameter_list|,
name|IN
name|OUT
name|VOID
modifier|*
name|Buffer
parameter_list|,
name|OUT
name|RETURN_STATUS
modifier|*
name|Status
name|OPTIONAL
parameter_list|)
block|{
name|RETURN_STATUS
name|ReturnStatus
decl_stmt|;
name|EFI_SMBUS_DEVICE_ADDRESS
name|SmbusDeviceAddress
decl_stmt|;
name|SmbusDeviceAddress
operator|.
name|SmbusDeviceAddress
operator|=
name|SMBUS_LIB_SLAVE_ADDRESS
argument_list|(
name|SmBusAddress
argument_list|)
expr_stmt|;
name|ReturnStatus
operator|=
name|mSmbus
operator|->
name|Execute
argument_list|(
name|mSmbus
argument_list|,
name|SmbusDeviceAddress
argument_list|,
name|SMBUS_LIB_COMMAND
argument_list|(
name|SmBusAddress
argument_list|)
argument_list|,
name|SmbusOperation
argument_list|,
name|SMBUS_LIB_PEC
argument_list|(
name|SmBusAddress
argument_list|)
argument_list|,
operator|&
name|Length
argument_list|,
name|Buffer
argument_list|)
expr_stmt|;
if|if
condition|(
name|Status
operator|!=
name|NULL
condition|)
block|{
operator|*
name|Status
operator|=
name|ReturnStatus
expr_stmt|;
block|}
return|return
name|Length
return|;
block|}
end_function

end_unit


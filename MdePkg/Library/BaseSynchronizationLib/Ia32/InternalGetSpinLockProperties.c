begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/** @file   Internal function to get spin lock alignment.    Copyright (c) 2016, Intel Corporation. All rights reserved.<BR>   This program and the accompanying materials   are licensed and made available under the terms and conditions of the BSD License   which accompanies this distribution.  The full text of the license may be found at   http://opensource.org/licenses/bsd-license.php.    THE PROGRAM IS DISTRIBUTED UNDER THE BSD LICENSE ON AN "AS IS" BASIS,   WITHOUT WARRANTIES OR REPRESENTATIONS OF ANY KIND, EITHER EXPRESS OR IMPLIED.  **/
end_comment

begin_include
include|#
directive|include
file|"BaseSynchronizationLibInternals.h"
end_include

begin_comment
comment|/**   Internal function to retrieve the architecture specific spin lock alignment   requirements for optimal spin lock performance.    @return The architecture specific spin lock alignment.    **/
end_comment

begin_function
name|UINTN
name|InternalGetSpinLockProperties
parameter_list|(
name|VOID
parameter_list|)
block|{
name|UINT32
name|RegEax
decl_stmt|;
name|UINT32
name|RegEbx
decl_stmt|;
name|UINTN
name|FamilyId
decl_stmt|;
name|UINTN
name|ModelId
decl_stmt|;
name|UINTN
name|CacheLineSize
decl_stmt|;
comment|//
comment|// Retrieve CPUID Version Information
comment|//
name|AsmCpuid
argument_list|(
literal|0x01
argument_list|,
operator|&
name|RegEax
argument_list|,
operator|&
name|RegEbx
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|//
comment|// EBX: Bits 15 - 08: CLFLUSH line size (Value * 8 = cache line size)
comment|//
name|CacheLineSize
operator|=
operator|(
operator|(
name|RegEbx
operator|>>
literal|8
operator|)
operator|&
literal|0xff
operator|)
operator|*
literal|8
expr_stmt|;
comment|//
comment|// Retrieve CPU Family and Model
comment|//
name|FamilyId
operator|=
operator|(
name|RegEax
operator|>>
literal|8
operator|)
operator|&
literal|0xf
expr_stmt|;
name|ModelId
operator|=
operator|(
name|RegEax
operator|>>
literal|4
operator|)
operator|&
literal|0xf
expr_stmt|;
if|if
condition|(
name|FamilyId
operator|==
literal|0x0f
condition|)
block|{
comment|//
comment|// In processors based on Intel NetBurst microarchitecture, use two cache lines
comment|//
name|ModelId
operator|=
name|ModelId
operator||
operator|(
operator|(
name|RegEax
operator|>>
literal|12
operator|)
operator|&
literal|0xf0
operator|)
expr_stmt|;
if|if
condition|(
name|ModelId
operator|<=
literal|0x04
operator|||
name|ModelId
operator|==
literal|0x06
condition|)
block|{
name|CacheLineSize
operator|*=
literal|2
expr_stmt|;
block|}
block|}
if|if
condition|(
name|CacheLineSize
operator|<
literal|32
condition|)
block|{
name|CacheLineSize
operator|=
literal|32
expr_stmt|;
block|}
return|return
name|CacheLineSize
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/** @file   Specific relocation fixups for ARM architecture.    Copyright (c) 2006 - 2009, Intel Corporation. All rights reserved.<BR>   Portions copyright (c) 2008 - 2010, Apple Inc. All rights reserved.<BR>   This program and the accompanying materials   are licensed and made available under the terms and conditions of the BSD License   which accompanies this distribution.  The full text of the license may be found at   http://opensource.org/licenses/bsd-license.php.    THE PROGRAM IS DISTRIBUTED UNDER THE BSD LICENSE ON AN "AS IS" BASIS,   WITHOUT WARRANTIES OR REPRESENTATIONS OF ANY KIND, EITHER EXPRESS OR IMPLIED.  **/
end_comment

begin_include
include|#
directive|include
file|"BasePeCoffLibInternals.h"
end_include

begin_include
include|#
directive|include
file|<Library/BaseLib.h>
end_include

begin_comment
comment|/**   Pass in a pointer to an ARM MOVT or MOVW immediate instruciton and    return the immediate data encoded in the instruction.    @param  Instruction   Pointer to ARM MOVT or MOVW immediate instruction    @return Immediate address encoded in the instruction  **/
end_comment

begin_function
name|UINT16
name|ThumbMovtImmediateAddress
parameter_list|(
name|IN
name|UINT16
modifier|*
name|Instruction
parameter_list|)
block|{
name|UINT32
name|Movt
decl_stmt|;
name|UINT16
name|Address
decl_stmt|;
comment|// Thumb2 is two 16-bit instructions working together. Not a single 32-bit instruction
comment|// Example MOVT R0, #0 is 0x0000f2c0 or 0xf2c0 0x0000
name|Movt
operator|=
operator|(
operator|*
name|Instruction
operator|<<
literal|16
operator|)
operator||
operator|(
operator|*
operator|(
name|Instruction
operator|+
literal|1
operator|)
operator|)
expr_stmt|;
comment|// imm16 = imm4:i:imm3:imm8
comment|//         imm4 -> Bit19:Bit16
comment|//         i    -> Bit26
comment|//         imm3 -> Bit14:Bit12
comment|//         imm8 -> Bit7:Bit0
name|Address
operator|=
call|(
name|UINT16
call|)
argument_list|(
name|Movt
operator|&
literal|0x000000ff
argument_list|)
expr_stmt|;
comment|// imm8
name|Address
operator||=
call|(
name|UINT16
call|)
argument_list|(
operator|(
name|Movt
operator|>>
literal|4
operator|)
operator|&
literal|0x0000f700
argument_list|)
expr_stmt|;
comment|// imm4 imm3
name|Address
operator||=
operator|(
operator|(
operator|(
name|Movt
operator|&
name|BIT26
operator|)
operator|!=
literal|0
operator|)
condition|?
name|BIT11
else|:
literal|0
operator|)
expr_stmt|;
comment|// i
return|return
name|Address
return|;
block|}
end_function

begin_comment
comment|/**   Update an ARM MOVT or MOVW immediate instruction immediate data.    @param  Instruction   Pointer to ARM MOVT or MOVW immediate instruction   @param  Address       New addres to patch into the instruction **/
end_comment

begin_function
name|VOID
name|ThumbMovtImmediatePatch
parameter_list|(
name|IN
name|OUT
name|UINT16
modifier|*
name|Instruction
parameter_list|,
name|IN
name|UINT16
name|Address
parameter_list|)
block|{
name|UINT16
name|Patch
decl_stmt|;
comment|// First 16-bit chunk of instruciton
name|Patch
operator|=
operator|(
operator|(
name|Address
operator|>>
literal|12
operator|)
operator|&
literal|0x000f
operator|)
expr_stmt|;
comment|// imm4
name|Patch
operator||=
operator|(
operator|(
operator|(
name|Address
operator|&
name|BIT11
operator|)
operator|!=
literal|0
operator|)
condition|?
name|BIT10
else|:
literal|0
operator|)
expr_stmt|;
comment|// i
comment|// Mask out instruction bits and or in address
operator|*
operator|(
name|Instruction
operator|)
operator|=
operator|(
operator|*
name|Instruction
operator|&
operator|~
literal|0x040f
operator|)
operator||
name|Patch
expr_stmt|;
comment|// Second 16-bit chunk of instruction
name|Patch
operator|=
name|Address
operator|&
literal|0x000000ff
expr_stmt|;
comment|// imm8
name|Patch
operator||=
operator|(
operator|(
name|Address
operator|<<
literal|4
operator|)
operator|&
literal|0x00007000
operator|)
expr_stmt|;
comment|// imm3
comment|// Mask out instruction bits and or in address
name|Instruction
operator|++
expr_stmt|;
operator|*
name|Instruction
operator|=
operator|(
operator|*
name|Instruction
operator|&
operator|~
literal|0x70ff
operator|)
operator||
name|Patch
expr_stmt|;
block|}
end_function

begin_comment
comment|/**   Pass in a pointer to an ARM MOVW/MOVT instruciton pair and    return the immediate data encoded in the two` instruction.    @param  Instructions  Pointer to ARM MOVW/MOVT insturction pair    @return Immediate address encoded in the instructions  **/
end_comment

begin_function
name|UINT32
name|ThumbMovwMovtImmediateAddress
parameter_list|(
name|IN
name|UINT16
modifier|*
name|Instructions
parameter_list|)
block|{
name|UINT16
modifier|*
name|Word
decl_stmt|;
name|UINT16
modifier|*
name|Top
decl_stmt|;
name|Word
operator|=
name|Instructions
expr_stmt|;
comment|// MOVW
name|Top
operator|=
name|Word
operator|+
literal|2
expr_stmt|;
comment|// MOVT
return|return
operator|(
name|ThumbMovtImmediateAddress
argument_list|(
name|Top
argument_list|)
operator|<<
literal|16
operator|)
operator|+
name|ThumbMovtImmediateAddress
argument_list|(
name|Word
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**   Update an ARM MOVW/MOVT immediate instruction instruction pair.    @param  Instructions  Pointer to ARM MOVW/MOVT instruction pair   @param  Address       New addres to patch into the instructions **/
end_comment

begin_function
name|VOID
name|ThumbMovwMovtImmediatePatch
parameter_list|(
name|IN
name|OUT
name|UINT16
modifier|*
name|Instructions
parameter_list|,
name|IN
name|UINT32
name|Address
parameter_list|)
block|{
name|UINT16
modifier|*
name|Word
decl_stmt|;
name|UINT16
modifier|*
name|Top
decl_stmt|;
name|Word
operator|=
name|Instructions
expr_stmt|;
comment|// MOVW
name|Top
operator|=
name|Word
operator|+
literal|2
expr_stmt|;
comment|// MOVT
name|ThumbMovtImmediatePatch
argument_list|(
name|Word
argument_list|,
call|(
name|UINT16
call|)
argument_list|(
name|Address
operator|&
literal|0xffff
argument_list|)
argument_list|)
expr_stmt|;
name|ThumbMovtImmediatePatch
argument_list|(
name|Top
argument_list|,
call|(
name|UINT16
call|)
argument_list|(
name|Address
operator|>>
literal|16
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**   Performs an ARM-based specific relocation fixup and is a no-op on other   instruction sets.    @param  Reloc       The pointer to the relocation record.   @param  Fixup       The pointer to the address to fix up.   @param  FixupData   The pointer to a buffer to log the fixups.   @param  Adjust      The offset to adjust the fixup.    @return Status code.  **/
end_comment

begin_function
name|RETURN_STATUS
name|PeCoffLoaderRelocateImageEx
parameter_list|(
name|IN
name|UINT16
modifier|*
name|Reloc
parameter_list|,
name|IN
name|OUT
name|CHAR8
modifier|*
name|Fixup
parameter_list|,
name|IN
name|OUT
name|CHAR8
modifier|*
modifier|*
name|FixupData
parameter_list|,
name|IN
name|UINT64
name|Adjust
parameter_list|)
block|{
name|UINT16
modifier|*
name|Fixup16
decl_stmt|;
name|UINT32
name|FixupVal
decl_stmt|;
name|Fixup16
operator|=
operator|(
name|UINT16
operator|*
operator|)
name|Fixup
expr_stmt|;
switch|switch
condition|(
operator|(
operator|*
name|Reloc
operator|)
operator|>>
literal|12
condition|)
block|{
case|case
name|EFI_IMAGE_REL_BASED_ARM_MOV32T
case|:
name|FixupVal
operator|=
name|ThumbMovwMovtImmediateAddress
argument_list|(
name|Fixup16
argument_list|)
operator|+
operator|(
name|UINT32
operator|)
name|Adjust
expr_stmt|;
name|ThumbMovwMovtImmediatePatch
argument_list|(
name|Fixup16
argument_list|,
name|FixupVal
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|FixupData
operator|!=
name|NULL
condition|)
block|{
operator|*
name|FixupData
operator|=
name|ALIGN_POINTER
argument_list|(
operator|*
name|FixupData
argument_list|,
sizeof|sizeof
argument_list|(
name|UINT64
argument_list|)
argument_list|)
expr_stmt|;
comment|// Fixup16 is not aligned so we must copy it. Thumb instructions are streams of 16 bytes.
name|CopyMem
argument_list|(
operator|*
name|FixupData
argument_list|,
name|Fixup16
argument_list|,
sizeof|sizeof
argument_list|(
name|UINT64
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|FixupData
operator|=
operator|*
name|FixupData
operator|+
sizeof|sizeof
argument_list|(
name|UINT64
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|EFI_IMAGE_REL_BASED_ARM_MOV32A
case|:
name|ASSERT
argument_list|(
name|FALSE
argument_list|)
expr_stmt|;
comment|// break omitted - ARM instruction encoding not implemented
default|default:
return|return
name|RETURN_UNSUPPORTED
return|;
block|}
return|return
name|RETURN_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**   Returns TRUE if the machine type of PE/COFF image is supported. Supported   does not mean the image can be executed it means the PE/COFF loader supports   loading and relocating of the image type. It's up to the caller to support   the entry point.      @param  Machine   Machine type from the PE Header.    @return TRUE if this PE/COFF loader can load the image  **/
end_comment

begin_function
name|BOOLEAN
name|PeCoffLoaderImageFormatSupported
parameter_list|(
name|IN
name|UINT16
name|Machine
parameter_list|)
block|{
if|if
condition|(
operator|(
name|Machine
operator|==
name|IMAGE_FILE_MACHINE_ARMTHUMB_MIXED
operator|)
operator|||
operator|(
name|Machine
operator|==
name|IMAGE_FILE_MACHINE_EBC
operator|)
condition|)
block|{
return|return
name|TRUE
return|;
block|}
return|return
name|FALSE
return|;
block|}
end_function

begin_comment
comment|/**   Performs an ARM-based specific re-relocation fixup and is a no-op on other   instruction sets. This is used to re-relocated the image into the EFI virtual   space for runtime calls.    @param  Reloc       The pointer to the relocation record.   @param  Fixup       The pointer to the address to fix up.   @param  FixupData   The pointer to a buffer to log the fixups.   @param  Adjust      The offset to adjust the fixup.    @return Status code.  **/
end_comment

begin_function
name|RETURN_STATUS
name|PeHotRelocateImageEx
parameter_list|(
name|IN
name|UINT16
modifier|*
name|Reloc
parameter_list|,
name|IN
name|OUT
name|CHAR8
modifier|*
name|Fixup
parameter_list|,
name|IN
name|OUT
name|CHAR8
modifier|*
modifier|*
name|FixupData
parameter_list|,
name|IN
name|UINT64
name|Adjust
parameter_list|)
block|{
name|UINT16
modifier|*
name|Fixup16
decl_stmt|;
name|UINT32
name|FixupVal
decl_stmt|;
name|Fixup16
operator|=
operator|(
name|UINT16
operator|*
operator|)
name|Fixup
expr_stmt|;
switch|switch
condition|(
operator|(
operator|*
name|Reloc
operator|)
operator|>>
literal|12
condition|)
block|{
case|case
name|EFI_IMAGE_REL_BASED_ARM_MOV32T
case|:
operator|*
name|FixupData
operator|=
name|ALIGN_POINTER
argument_list|(
operator|*
name|FixupData
argument_list|,
sizeof|sizeof
argument_list|(
name|UINT64
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
operator|(
name|UINT64
operator|*
operator|)
operator|(
operator|*
name|FixupData
operator|)
operator|==
name|ReadUnaligned64
argument_list|(
operator|(
name|UINT64
operator|*
operator|)
name|Fixup16
argument_list|)
condition|)
block|{
name|FixupVal
operator|=
name|ThumbMovwMovtImmediateAddress
argument_list|(
name|Fixup16
argument_list|)
operator|+
operator|(
name|UINT32
operator|)
name|Adjust
expr_stmt|;
name|ThumbMovwMovtImmediatePatch
argument_list|(
name|Fixup16
argument_list|,
name|FixupVal
argument_list|)
expr_stmt|;
block|}
operator|*
name|FixupData
operator|=
operator|*
name|FixupData
operator|+
sizeof|sizeof
argument_list|(
name|UINT64
argument_list|)
expr_stmt|;
break|break;
case|case
name|EFI_IMAGE_REL_BASED_ARM_MOV32A
case|:
name|ASSERT
argument_list|(
name|FALSE
argument_list|)
expr_stmt|;
comment|// break omitted - ARM instruction encoding not implemented
default|default:
name|DEBUG
argument_list|(
operator|(
name|EFI_D_ERROR
operator|,
literal|"PeHotRelocateEx:unknown fixed type\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|RETURN_UNSUPPORTED
return|;
block|}
return|return
name|RETURN_SUCCESS
return|;
block|}
end_function

end_unit


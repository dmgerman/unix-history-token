begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/** @file   Defines file-path manipulation functions.    Copyright (c) 2011 - 2016, Intel Corporation. All rights reserved.<BR>   This program and the accompanying materials   are licensed and made available under the terms and conditions of the BSD License   which accompanies this distribution.  The full text of the license may be found at   http://opensource.org/licenses/bsd-license.php.    THE PROGRAM IS DISTRIBUTED UNDER THE BSD LICENSE ON AN "AS IS" BASIS,   WITHOUT WARRANTIES OR REPRESENTATIONS OF ANY KIND, EITHER EXPRESS OR IMPLIED. **/
end_comment

begin_include
include|#
directive|include
file|<Library/BaseMemoryLib.h>
end_include

begin_include
include|#
directive|include
file|<Library/BaseLib.h>
end_include

begin_comment
comment|/**   Removes the last directory or file entry in a path. For a path which is   like L"fs0:startup.nsh", it's converted to L"fs0:".    @param[in,out] Path     A pointer to the path to modify.    @retval FALSE     Nothing was found to remove.   @retval TRUE      A directory or file was removed. **/
end_comment

begin_function
name|BOOLEAN
name|EFIAPI
name|PathRemoveLastItem
parameter_list|(
name|IN
name|OUT
name|CHAR16
modifier|*
name|Path
parameter_list|)
block|{
name|CHAR16
modifier|*
name|Walker
decl_stmt|;
name|CHAR16
modifier|*
name|LastSlash
decl_stmt|;
comment|//
comment|// get directory name from path... ('chop' off extra)
comment|//
for|for
control|(
name|Walker
operator|=
name|Path
operator|,
name|LastSlash
operator|=
name|NULL
init|;
name|Walker
operator|!=
name|NULL
operator|&&
operator|*
name|Walker
operator|!=
name|CHAR_NULL
condition|;
name|Walker
operator|++
control|)
block|{
if|if
condition|(
operator|*
name|Walker
operator|==
literal|L'
expr|\\'
operator|&&
operator|*
operator|(
name|Walker
operator|+
literal|1
operator|)
operator|!=
name|CHAR_NULL
condition|)
block|{
name|LastSlash
operator|=
name|Walker
operator|+
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|*
name|Walker
operator|==
literal|L'
expr|:'
operator|&&
operator|*
operator|(
name|Walker
operator|+
literal|1
operator|)
operator|!=
literal|L'
expr|\\'
operator|&&
operator|*
operator|(
name|Walker
operator|+
literal|1
operator|)
operator|!=
name|CHAR_NULL
condition|)
block|{
name|LastSlash
operator|=
name|Walker
operator|+
literal|1
expr_stmt|;
block|}
block|}
if|if
condition|(
name|LastSlash
operator|!=
name|NULL
condition|)
block|{
operator|*
name|LastSlash
operator|=
name|CHAR_NULL
expr_stmt|;
return|return
operator|(
name|TRUE
operator|)
return|;
block|}
return|return
operator|(
name|FALSE
operator|)
return|;
block|}
end_function

begin_comment
comment|/**   Function to clean up paths.    - Single periods in the path are removed.   - Double periods in the path are removed along with a single parent directory.   - Forward slashes L'/' are converted to backward slashes L'\'.    This will be done inline and the existing buffer may be larger than required   upon completion.    @param[in] Path       The pointer to the string containing the path.    @return       Returns Path, otherwise returns NULL to indicate that an error has occured. **/
end_comment

begin_function
name|CHAR16
modifier|*
name|EFIAPI
name|PathCleanUpDirectories
parameter_list|(
name|IN
name|CHAR16
modifier|*
name|Path
parameter_list|)
block|{
name|CHAR16
modifier|*
name|TempString
decl_stmt|;
if|if
condition|(
name|Path
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
comment|//
comment|// Replace the '/' with '\'
comment|//
for|for
control|(
name|TempString
operator|=
name|Path
init|;
operator|*
name|TempString
operator|!=
name|CHAR_NULL
condition|;
name|TempString
operator|++
control|)
block|{
if|if
condition|(
operator|*
name|TempString
operator|==
literal|L'
expr|/'
condition|)
block|{
operator|*
name|TempString
operator|=
literal|L'
expr|\\'
expr_stmt|;
block|}
block|}
comment|//
comment|// Remove all the "\.". E.g.: fs0:\abc\.\def\.
comment|//
while|while
condition|(
operator|(
name|TempString
operator|=
name|StrStr
argument_list|(
name|Path
argument_list|,
literal|L"\\.\\"
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|CopyMem
argument_list|(
name|TempString
argument_list|,
name|TempString
operator|+
literal|2
argument_list|,
name|StrSize
argument_list|(
name|TempString
operator|+
literal|2
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|StrCmp
argument_list|(
name|Path
operator|+
name|StrLen
argument_list|(
name|Path
argument_list|)
operator|-
literal|2
argument_list|,
literal|L"\\."
argument_list|)
operator|==
literal|0
condition|)
block|{
name|Path
index|[
name|StrLen
argument_list|(
name|Path
argument_list|)
operator|-
literal|1
index|]
operator|=
name|CHAR_NULL
expr_stmt|;
block|}
comment|//
comment|// Remove all the "\..". E.g.: fs0:\abc\..\def\..
comment|//
while|while
condition|(
operator|(
operator|(
name|TempString
operator|=
name|StrStr
argument_list|(
name|Path
argument_list|,
literal|L"\\.."
argument_list|)
operator|)
operator|!=
name|NULL
operator|)
operator|&&
operator|(
operator|(
operator|*
operator|(
name|TempString
operator|+
literal|3
operator|)
operator|==
literal|L'
expr|\\'
operator|)
operator|||
operator|(
operator|*
operator|(
name|TempString
operator|+
literal|3
operator|)
operator|==
name|CHAR_NULL
operator|)
operator|)
condition|)
block|{
operator|*
operator|(
name|TempString
operator|+
literal|1
operator|)
operator|=
name|CHAR_NULL
expr_stmt|;
name|PathRemoveLastItem
argument_list|(
name|Path
argument_list|)
expr_stmt|;
name|CopyMem
argument_list|(
name|Path
operator|+
name|StrLen
argument_list|(
name|Path
argument_list|)
argument_list|,
name|TempString
operator|+
literal|3
argument_list|,
name|StrSize
argument_list|(
name|TempString
operator|+
literal|3
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|//
comment|// Replace the "\\" with "\"
comment|//
while|while
condition|(
operator|(
name|TempString
operator|=
name|StrStr
argument_list|(
name|Path
argument_list|,
literal|L"\\\\"
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|CopyMem
argument_list|(
name|TempString
argument_list|,
name|TempString
operator|+
literal|1
argument_list|,
name|StrSize
argument_list|(
name|TempString
operator|+
literal|1
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|Path
return|;
block|}
end_function

end_unit


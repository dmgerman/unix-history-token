begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/** @file   Real Mode Thunk Functions for IA32 and x64.    Copyright (c) 2006 - 2012, Intel Corporation. All rights reserved.<BR>   This program and the accompanying materials   are licensed and made available under the terms and conditions of the BSD License   which accompanies this distribution.  The full text of the license may be found at   http://opensource.org/licenses/bsd-license.php.    THE PROGRAM IS DISTRIBUTED UNDER THE BSD LICENSE ON AN "AS IS" BASIS,   WITHOUT WARRANTIES OR REPRESENTATIONS OF ANY KIND, EITHER EXPRESS OR IMPLIED.  **/
end_comment

begin_include
include|#
directive|include
file|"BaseLibInternals.h"
end_include

begin_decl_stmt
specifier|extern
name|CONST
name|UINT8
name|m16Start
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|CONST
name|UINT16
name|m16Size
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|CONST
name|UINT16
name|mThunk16Attr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|CONST
name|UINT16
name|m16Gdt
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|CONST
name|UINT16
name|m16GdtrBase
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|CONST
name|UINT16
name|mTransition
decl_stmt|;
end_decl_stmt

begin_comment
comment|/**   Invokes 16-bit code in big real mode and returns the updated register set.    This function transfers control to the 16-bit code specified by CS:EIP using   the stack specified by SS:ESP in RegisterSet. The updated registers are saved   on the real mode stack and the starting address of the save area is returned.    @param  RegisterSet Values of registers before invocation of 16-bit code.   @param  Transition  The pointer to the transition code under 1MB.    @return The pointer to a IA32_REGISTER_SET structure containing the updated           register values.  **/
end_comment

begin_function_decl
name|IA32_REGISTER_SET
modifier|*
name|EFIAPI
name|InternalAsmThunk16
parameter_list|(
name|IN
name|IA32_REGISTER_SET
modifier|*
name|RegisterSet
parameter_list|,
name|IN
name|OUT
name|VOID
modifier|*
name|Transition
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/**   Retrieves the properties for 16-bit thunk functions.    Computes the size of the buffer and stack below 1MB required to use the   AsmPrepareThunk16(), AsmThunk16() and AsmPrepareAndThunk16() functions. This   buffer size is returned in RealModeBufferSize, and the stack size is returned   in ExtraStackSize. If parameters are passed to the 16-bit real mode code,   then the actual minimum stack size is ExtraStackSize plus the maximum number   of bytes that need to be passed to the 16-bit real mode code.    If RealModeBufferSize is NULL, then ASSERT().   If ExtraStackSize is NULL, then ASSERT().    @param  RealModeBufferSize  A pointer to the size of the buffer below 1MB                               required to use the 16-bit thunk functions.   @param  ExtraStackSize      A pointer to the extra size of stack below 1MB                               that the 16-bit thunk functions require for                               temporary storage in the transition to and from                               16-bit real mode.  **/
end_comment

begin_function
name|VOID
name|EFIAPI
name|AsmGetThunk16Properties
parameter_list|(
name|OUT
name|UINT32
modifier|*
name|RealModeBufferSize
parameter_list|,
name|OUT
name|UINT32
modifier|*
name|ExtraStackSize
parameter_list|)
block|{
name|ASSERT
argument_list|(
name|RealModeBufferSize
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|ExtraStackSize
operator|!=
name|NULL
argument_list|)
expr_stmt|;
operator|*
name|RealModeBufferSize
operator|=
name|m16Size
expr_stmt|;
comment|//
comment|// Extra 4 bytes for return address, and another 4 bytes for mode transition
comment|//
operator|*
name|ExtraStackSize
operator|=
sizeof|sizeof
argument_list|(
name|IA32_DWORD_REGS
argument_list|)
operator|+
literal|8
expr_stmt|;
block|}
end_function

begin_comment
comment|/**   Prepares all structures a code required to use AsmThunk16().    Prepares all structures and code required to use AsmThunk16().      This interface is limited to be used in either physical mode or virtual modes with paging enabled where the   virtual to physical mappings for ThunkContext.RealModeBuffer is mapped 1:1.    If ThunkContext is NULL, then ASSERT().    @param  ThunkContext  A pointer to the context structure that describes the                         16-bit real mode code to call.  **/
end_comment

begin_function
name|VOID
name|EFIAPI
name|AsmPrepareThunk16
parameter_list|(
name|IN
name|OUT
name|THUNK_CONTEXT
modifier|*
name|ThunkContext
parameter_list|)
block|{
name|IA32_SEGMENT_DESCRIPTOR
modifier|*
name|RealModeGdt
decl_stmt|;
name|ASSERT
argument_list|(
name|ThunkContext
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
operator|(
name|UINTN
operator|)
name|ThunkContext
operator|->
name|RealModeBuffer
operator|<
literal|0x100000
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|ThunkContext
operator|->
name|RealModeBufferSize
operator|>=
name|m16Size
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
operator|(
name|UINTN
operator|)
name|ThunkContext
operator|->
name|RealModeBuffer
operator|+
name|m16Size
operator|<=
literal|0x100000
argument_list|)
expr_stmt|;
name|CopyMem
argument_list|(
name|ThunkContext
operator|->
name|RealModeBuffer
argument_list|,
operator|&
name|m16Start
argument_list|,
name|m16Size
argument_list|)
expr_stmt|;
comment|//
comment|// Point RealModeGdt to the GDT to be used in transition
comment|//
comment|// RealModeGdt[0]: Reserved as NULL descriptor
comment|// RealModeGdt[1]: Code Segment
comment|// RealModeGdt[2]: Data Segment
comment|// RealModeGdt[3]: Call Gate
comment|//
name|RealModeGdt
operator|=
operator|(
name|IA32_SEGMENT_DESCRIPTOR
operator|*
operator|)
operator|(
operator|(
name|UINTN
operator|)
name|ThunkContext
operator|->
name|RealModeBuffer
operator|+
name|m16Gdt
operator|)
expr_stmt|;
comment|//
comment|// Update Code& Data Segment Descriptor
comment|//
name|RealModeGdt
index|[
literal|1
index|]
operator|.
name|Bits
operator|.
name|BaseLow
operator|=
operator|(
name|UINT32
operator|)
operator|(
name|UINTN
operator|)
name|ThunkContext
operator|->
name|RealModeBuffer
operator|&
operator|~
literal|0xf
expr_stmt|;
name|RealModeGdt
index|[
literal|1
index|]
operator|.
name|Bits
operator|.
name|BaseMid
operator|=
operator|(
name|UINT32
operator|)
operator|(
name|UINTN
operator|)
name|ThunkContext
operator|->
name|RealModeBuffer
operator|>>
literal|16
expr_stmt|;
comment|//
comment|// Update transition code entry point offset
comment|//
operator|*
operator|(
name|UINT32
operator|*
operator|)
operator|(
operator|(
name|UINTN
operator|)
name|ThunkContext
operator|->
name|RealModeBuffer
operator|+
name|mTransition
operator|)
operator|+=
operator|(
name|UINT32
operator|)
operator|(
name|UINTN
operator|)
name|ThunkContext
operator|->
name|RealModeBuffer
operator|&
literal|0xf
expr_stmt|;
comment|//
comment|// Update Segment Limits for both Code and Data Segment Descriptors
comment|//
if|if
condition|(
operator|(
name|ThunkContext
operator|->
name|ThunkAttributes
operator|&
name|THUNK_ATTRIBUTE_BIG_REAL_MODE
operator|)
operator|==
literal|0
condition|)
block|{
comment|//
comment|// Set segment limits to 64KB
comment|//
name|RealModeGdt
index|[
literal|1
index|]
operator|.
name|Bits
operator|.
name|LimitHigh
operator|=
literal|0
expr_stmt|;
name|RealModeGdt
index|[
literal|1
index|]
operator|.
name|Bits
operator|.
name|G
operator|=
literal|0
expr_stmt|;
name|RealModeGdt
index|[
literal|2
index|]
operator|.
name|Bits
operator|.
name|LimitHigh
operator|=
literal|0
expr_stmt|;
name|RealModeGdt
index|[
literal|2
index|]
operator|.
name|Bits
operator|.
name|G
operator|=
literal|0
expr_stmt|;
block|}
comment|//
comment|// Update GDTBASE for this thunk context
comment|//
operator|*
operator|(
name|VOID
operator|*
operator|*
operator|)
operator|(
operator|(
name|UINTN
operator|)
name|ThunkContext
operator|->
name|RealModeBuffer
operator|+
name|m16GdtrBase
operator|)
operator|=
name|RealModeGdt
expr_stmt|;
comment|//
comment|// Update Thunk Attributes
comment|//
operator|*
operator|(
name|UINT32
operator|*
operator|)
operator|(
operator|(
name|UINTN
operator|)
name|ThunkContext
operator|->
name|RealModeBuffer
operator|+
name|mThunk16Attr
operator|)
operator|=
name|ThunkContext
operator|->
name|ThunkAttributes
expr_stmt|;
block|}
end_function

begin_comment
comment|/**   Transfers control to a 16-bit real mode entry point and returns the results.    Transfers control to a 16-bit real mode entry point and returns the results.   AsmPrepareThunk16() must be called with ThunkContext before this function is used.   This function must be called with interrupts disabled.    The register state from the RealModeState field of ThunkContext is restored just prior    to calling the 16-bit real mode entry point.  This includes the EFLAGS field of RealModeState,    which is used to set the interrupt state when a 16-bit real mode entry point is called.   Control is transferred to the 16-bit real mode entry point specified by the CS and Eip fields of RealModeState.   The stack is initialized to the SS and ESP fields of RealModeState.  Any parameters passed to    the 16-bit real mode code must be populated by the caller at SS:ESP prior to calling this function.     The 16-bit real mode entry point is invoked with a 16-bit CALL FAR instruction,   so when accessing stack contents, the 16-bit real mode code must account for the 16-bit segment    and 16-bit offset of the return address that were pushed onto the stack. The 16-bit real mode entry    point must exit with a RETF instruction. The register state is captured into RealModeState immediately    after the RETF instruction is executed.      If EFLAGS specifies interrupts enabled, or any of the 16-bit real mode code enables interrupts,    or any of the 16-bit real mode code makes a SW interrupt, then the caller is responsible for making sure    the IDT at address 0 is initialized to handle any HW or SW interrupts that may occur while in 16-bit real mode.       If EFLAGS specifies interrupts enabled, or any of the 16-bit real mode code enables interrupts,    then the caller is responsible for making sure the 8259 PIC is in a state compatible with 16-bit real mode.     This includes the base vectors, the interrupt masks, and the edge/level trigger mode.      If THUNK_ATTRIBUTE_BIG_REAL_MODE is set in the ThunkAttributes field of ThunkContext, then the user code    is invoked in big real mode.  Otherwise, the user code is invoked in 16-bit real mode with 64KB segment limits.      If neither THUNK_ATTRIBUTE_DISABLE_A20_MASK_INT_15 nor THUNK_ATTRIBUTE_DISABLE_A20_MASK_KBD_CTRL are set in    ThunkAttributes, then it is assumed that the user code did not enable the A20 mask, and no attempt is made to    disable the A20 mask.      If THUNK_ATTRIBUTE_DISABLE_A20_MASK_INT_15 is set and THUNK_ATTRIBUTE_DISABLE_A20_MASK_KBD_CTRL is clear in    ThunkAttributes, then attempt to use the INT 15 service to disable the A20 mask.  If this INT 15 call fails,    then attempt to disable the A20 mask by directly accessing the 8042 keyboard controller I/O ports.      If THUNK_ATTRIBUTE_DISABLE_A20_MASK_INT_15 is clear and THUNK_ATTRIBUTE_DISABLE_A20_MASK_KBD_CTRL is set in    ThunkAttributes, then attempt to disable the A20 mask by directly accessing the 8042 keyboard controller I/O ports.        If ThunkContext is NULL, then ASSERT().   If AsmPrepareThunk16() was not previously called with ThunkContext, then ASSERT().   If both THUNK_ATTRIBUTE_DISABLE_A20_MASK_INT_15 and THUNK_ATTRIBUTE_DISABLE_A20_MASK_KBD_CTRL are set in    ThunkAttributes, then ASSERT().    This interface is limited to be used in either physical mode or virtual modes with paging enabled where the   virtual to physical mappings for ThunkContext.RealModeBuffer is mapped 1:1.      @param  ThunkContext  A pointer to the context structure that describes the                         16-bit real mode code to call.  **/
end_comment

begin_function
name|VOID
name|EFIAPI
name|AsmThunk16
parameter_list|(
name|IN
name|OUT
name|THUNK_CONTEXT
modifier|*
name|ThunkContext
parameter_list|)
block|{
name|IA32_REGISTER_SET
modifier|*
name|UpdatedRegs
decl_stmt|;
name|ASSERT
argument_list|(
name|ThunkContext
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
operator|(
name|UINTN
operator|)
name|ThunkContext
operator|->
name|RealModeBuffer
operator|<
literal|0x100000
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|ThunkContext
operator|->
name|RealModeBufferSize
operator|>=
name|m16Size
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
operator|(
name|UINTN
operator|)
name|ThunkContext
operator|->
name|RealModeBuffer
operator|+
name|m16Size
operator|<=
literal|0x100000
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
operator|(
operator|(
name|ThunkContext
operator|->
name|ThunkAttributes
operator|&
operator|(
name|THUNK_ATTRIBUTE_DISABLE_A20_MASK_INT_15
operator||
name|THUNK_ATTRIBUTE_DISABLE_A20_MASK_KBD_CTRL
operator|)
operator|)
operator|!=
expr|\
operator|(
name|THUNK_ATTRIBUTE_DISABLE_A20_MASK_INT_15
operator||
name|THUNK_ATTRIBUTE_DISABLE_A20_MASK_KBD_CTRL
operator|)
operator|)
argument_list|)
expr_stmt|;
name|UpdatedRegs
operator|=
name|InternalAsmThunk16
argument_list|(
name|ThunkContext
operator|->
name|RealModeState
argument_list|,
name|ThunkContext
operator|->
name|RealModeBuffer
argument_list|)
expr_stmt|;
name|CopyMem
argument_list|(
name|ThunkContext
operator|->
name|RealModeState
argument_list|,
name|UpdatedRegs
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|UpdatedRegs
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**   Prepares all structures and code for a 16-bit real mode thunk, transfers   control to a 16-bit real mode entry point, and returns the results.    Prepares all structures and code for a 16-bit real mode thunk, transfers   control to a 16-bit real mode entry point, and returns the results. If the   caller only need to perform a single 16-bit real mode thunk, then this   service should be used. If the caller intends to make more than one 16-bit   real mode thunk, then it is more efficient if AsmPrepareThunk16() is called   once and AsmThunk16() can be called for each 16-bit real mode thunk.    This interface is limited to be used in either physical mode or virtual modes with paging enabled where the   virtual to physical mappings for ThunkContext.RealModeBuffer is mapped 1:1.      See AsmPrepareThunk16() and AsmThunk16() for the detailed description and ASSERT() conditions.    @param  ThunkContext  A pointer to the context structure that describes the                         16-bit real mode code to call.  **/
end_comment

begin_function
name|VOID
name|EFIAPI
name|AsmPrepareAndThunk16
parameter_list|(
name|IN
name|OUT
name|THUNK_CONTEXT
modifier|*
name|ThunkContext
parameter_list|)
block|{
name|AsmPrepareThunk16
argument_list|(
name|ThunkContext
argument_list|)
expr_stmt|;
name|AsmThunk16
argument_list|(
name|ThunkContext
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/** @file   Mde UEFI library API implementation.   Print to StdErr or ConOut defined in EFI_SYSTEM_TABLE    Copyright (c) 2007 - 2015, Intel Corporation. All rights reserved.<BR>   This program and the accompanying materials   are licensed and made available under the terms and conditions of the BSD License   which accompanies this distribution.  The full text of the license may be found at   http://opensource.org/licenses/bsd-license.php.    THE PROGRAM IS DISTRIBUTED UNDER THE BSD LICENSE ON AN "AS IS" BASIS,   WITHOUT WARRANTIES OR REPRESENTATIONS OF ANY KIND, EITHER EXPRESS OR IMPLIED.  **/
end_comment

begin_include
include|#
directive|include
file|"UefiLibInternal.h"
end_include

begin_decl_stmt
name|GLOBAL_REMOVE_IF_UNREFERENCED
name|EFI_GRAPHICS_OUTPUT_BLT_PIXEL
name|mEfiColors
index|[
literal|16
index|]
init|=
block|{
block|{
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|}
block|,
block|{
literal|0x98
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|}
block|,
block|{
literal|0x00
block|,
literal|0x98
block|,
literal|0x00
block|,
literal|0x00
block|}
block|,
block|{
literal|0x98
block|,
literal|0x98
block|,
literal|0x00
block|,
literal|0x00
block|}
block|,
block|{
literal|0x00
block|,
literal|0x00
block|,
literal|0x98
block|,
literal|0x00
block|}
block|,
block|{
literal|0x98
block|,
literal|0x00
block|,
literal|0x98
block|,
literal|0x00
block|}
block|,
block|{
literal|0x00
block|,
literal|0x98
block|,
literal|0x98
block|,
literal|0x00
block|}
block|,
block|{
literal|0x98
block|,
literal|0x98
block|,
literal|0x98
block|,
literal|0x00
block|}
block|,
block|{
literal|0x10
block|,
literal|0x10
block|,
literal|0x10
block|,
literal|0x00
block|}
block|,
block|{
literal|0xff
block|,
literal|0x10
block|,
literal|0x10
block|,
literal|0x00
block|}
block|,
block|{
literal|0x10
block|,
literal|0xff
block|,
literal|0x10
block|,
literal|0x00
block|}
block|,
block|{
literal|0xff
block|,
literal|0xff
block|,
literal|0x10
block|,
literal|0x00
block|}
block|,
block|{
literal|0x10
block|,
literal|0x10
block|,
literal|0xff
block|,
literal|0x00
block|}
block|,
block|{
literal|0xf0
block|,
literal|0x10
block|,
literal|0xff
block|,
literal|0x00
block|}
block|,
block|{
literal|0x10
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0x00
block|}
block|,
block|{
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0x00
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/**   Internal function which prints a formatted Unicode string to the console output device   specified by Console    This function prints a formatted Unicode string to the console output device   specified by Console and returns the number of Unicode characters that printed   to it.  If the length of the formatted Unicode string is greater than PcdUefiLibMaxPrintBufferSize,   then only the first PcdUefiLibMaxPrintBufferSize characters are sent to Console.   If Format is NULL, then ASSERT().   If Format is not aligned on a 16-bit boundary, then ASSERT().    @param Format   A Null-terminated Unicode format string.   @param Console  The output console.   @param Marker   A VA_LIST marker for the variable argument list.    @return The number of Unicode characters in the produced           output buffer, not including the Null-terminator. **/
end_comment

begin_function
name|UINTN
name|InternalPrint
parameter_list|(
name|IN
name|CONST
name|CHAR16
modifier|*
name|Format
parameter_list|,
name|IN
name|EFI_SIMPLE_TEXT_OUTPUT_PROTOCOL
modifier|*
name|Console
parameter_list|,
name|IN
name|VA_LIST
name|Marker
parameter_list|)
block|{
name|EFI_STATUS
name|Status
decl_stmt|;
name|UINTN
name|Return
decl_stmt|;
name|CHAR16
modifier|*
name|Buffer
decl_stmt|;
name|UINTN
name|BufferSize
decl_stmt|;
name|ASSERT
argument_list|(
name|Format
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
operator|(
operator|(
name|UINTN
operator|)
name|Format
operator|&
name|BIT0
operator|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|Console
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|BufferSize
operator|=
operator|(
name|PcdGet32
argument_list|(
name|PcdUefiLibMaxPrintBufferSize
argument_list|)
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|CHAR16
argument_list|)
expr_stmt|;
name|Buffer
operator|=
operator|(
name|CHAR16
operator|*
operator|)
name|AllocatePool
argument_list|(
name|BufferSize
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|Buffer
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|Return
operator|=
name|UnicodeVSPrint
argument_list|(
name|Buffer
argument_list|,
name|BufferSize
argument_list|,
name|Format
argument_list|,
name|Marker
argument_list|)
expr_stmt|;
if|if
condition|(
name|Console
operator|!=
name|NULL
operator|&&
name|Return
operator|>
literal|0
condition|)
block|{
comment|//
comment|// To be extra safe make sure Console has been initialized
comment|//
name|Status
operator|=
name|Console
operator|->
name|OutputString
argument_list|(
name|Console
argument_list|,
name|Buffer
argument_list|)
expr_stmt|;
if|if
condition|(
name|EFI_ERROR
argument_list|(
name|Status
argument_list|)
condition|)
block|{
name|Return
operator|=
literal|0
expr_stmt|;
block|}
block|}
name|FreePool
argument_list|(
name|Buffer
argument_list|)
expr_stmt|;
return|return
name|Return
return|;
block|}
end_function

begin_comment
comment|/**    Prints a formatted Unicode string to the console output device specified by    ConOut defined in the EFI_SYSTEM_TABLE.    This function prints a formatted Unicode string to the console output device    specified by ConOut in EFI_SYSTEM_TABLE and returns the number of Unicode    characters that printed to ConOut.  If the length of the formatted Unicode    string is greater than PcdUefiLibMaxPrintBufferSize, then only the first    PcdUefiLibMaxPrintBufferSize characters are sent to ConOut.   If Format is NULL, then ASSERT().   If Format is not aligned on a 16-bit boundary, then ASSERT().   If gST->ConOut is NULL, then ASSERT().    @param Format   A Null-terminated Unicode format string.   @param ...      A Variable argument list whose contents are accessed based                    on the format string specified by Format.      @return The number of Unicode characters printed to ConOut.  **/
end_comment

begin_function
name|UINTN
name|EFIAPI
name|Print
parameter_list|(
name|IN
name|CONST
name|CHAR16
modifier|*
name|Format
parameter_list|,
modifier|...
parameter_list|)
block|{
name|VA_LIST
name|Marker
decl_stmt|;
name|UINTN
name|Return
decl_stmt|;
name|VA_START
argument_list|(
name|Marker
argument_list|,
name|Format
argument_list|)
expr_stmt|;
name|Return
operator|=
name|InternalPrint
argument_list|(
name|Format
argument_list|,
name|gST
operator|->
name|ConOut
argument_list|,
name|Marker
argument_list|)
expr_stmt|;
name|VA_END
argument_list|(
name|Marker
argument_list|)
expr_stmt|;
return|return
name|Return
return|;
block|}
end_function

begin_comment
comment|/**    Prints a formatted Unicode string to the console output device specified by    StdErr defined in the EFI_SYSTEM_TABLE.    This function prints a formatted Unicode string to the console output device    specified by StdErr in EFI_SYSTEM_TABLE and returns the number of Unicode    characters that printed to StdErr.  If the length of the formatted Unicode    string is greater than PcdUefiLibMaxPrintBufferSize, then only the first    PcdUefiLibMaxPrintBufferSize characters are sent to StdErr.   If Format is NULL, then ASSERT().   If Format is not aligned on a 16-bit boundary, then ASSERT().   If gST->StdErr is NULL, then ASSERT().    @param Format   A Null-terminated Unicode format string.   @param ...      Variable argument list whose contents are accessed based                    on the format string specified by Format.      @return The number of Unicode characters printed to StdErr.  **/
end_comment

begin_function
name|UINTN
name|EFIAPI
name|ErrorPrint
parameter_list|(
name|IN
name|CONST
name|CHAR16
modifier|*
name|Format
parameter_list|,
modifier|...
parameter_list|)
block|{
name|VA_LIST
name|Marker
decl_stmt|;
name|UINTN
name|Return
decl_stmt|;
name|VA_START
argument_list|(
name|Marker
argument_list|,
name|Format
argument_list|)
expr_stmt|;
name|Return
operator|=
name|InternalPrint
argument_list|(
name|Format
argument_list|,
name|gST
operator|->
name|StdErr
argument_list|,
name|Marker
argument_list|)
expr_stmt|;
name|VA_END
argument_list|(
name|Marker
argument_list|)
expr_stmt|;
return|return
name|Return
return|;
block|}
end_function

begin_comment
comment|/**   Internal function which prints a formatted ASCII string to the console output device   specified by Console    This function prints a formatted ASCII string to the console output device   specified by Console and returns the number of ASCII characters that printed   to it.  If the length of the formatted ASCII string is greater than PcdUefiLibMaxPrintBufferSize,   then only the first PcdUefiLibMaxPrintBufferSize characters are sent to Console.    If Format is NULL, then ASSERT().    @param Format   A Null-terminated ASCII format string.   @param Console  The output console.   @param Marker   VA_LIST marker for the variable argument list.    @return The number of Unicode characters in the produced           output buffer not including the Null-terminator.  **/
end_comment

begin_function
name|UINTN
name|AsciiInternalPrint
parameter_list|(
name|IN
name|CONST
name|CHAR8
modifier|*
name|Format
parameter_list|,
name|IN
name|EFI_SIMPLE_TEXT_OUTPUT_PROTOCOL
modifier|*
name|Console
parameter_list|,
name|IN
name|VA_LIST
name|Marker
parameter_list|)
block|{
name|EFI_STATUS
name|Status
decl_stmt|;
name|UINTN
name|Return
decl_stmt|;
name|CHAR16
modifier|*
name|Buffer
decl_stmt|;
name|UINTN
name|BufferSize
decl_stmt|;
name|ASSERT
argument_list|(
name|Format
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|Console
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|BufferSize
operator|=
operator|(
name|PcdGet32
argument_list|(
name|PcdUefiLibMaxPrintBufferSize
argument_list|)
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|CHAR16
argument_list|)
expr_stmt|;
name|Buffer
operator|=
operator|(
name|CHAR16
operator|*
operator|)
name|AllocatePool
argument_list|(
name|BufferSize
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|Buffer
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|Return
operator|=
name|UnicodeVSPrintAsciiFormat
argument_list|(
name|Buffer
argument_list|,
name|BufferSize
argument_list|,
name|Format
argument_list|,
name|Marker
argument_list|)
expr_stmt|;
if|if
condition|(
name|Console
operator|!=
name|NULL
condition|)
block|{
comment|//
comment|// To be extra safe make sure Console has been initialized
comment|//
name|Status
operator|=
name|Console
operator|->
name|OutputString
argument_list|(
name|Console
argument_list|,
name|Buffer
argument_list|)
expr_stmt|;
if|if
condition|(
name|EFI_ERROR
argument_list|(
name|Status
argument_list|)
condition|)
block|{
name|Return
operator|=
literal|0
expr_stmt|;
block|}
block|}
name|FreePool
argument_list|(
name|Buffer
argument_list|)
expr_stmt|;
return|return
name|Return
return|;
block|}
end_function

begin_comment
comment|/**    Prints a formatted ASCII string to the console output device specified by    ConOut defined in the EFI_SYSTEM_TABLE.    This function prints a formatted ASCII string to the console output device    specified by ConOut in EFI_SYSTEM_TABLE and returns the number of ASCII    characters that printed to ConOut.  If the length of the formatted ASCII    string is greater than PcdUefiLibMaxPrintBufferSize, then only the first    PcdUefiLibMaxPrintBufferSize characters are sent to ConOut.   If Format is NULL, then ASSERT().   If gST->ConOut is NULL, then ASSERT().    @param Format   A Null-terminated ASCII format string.   @param ...      Variable argument list whose contents are accessed based                    on the format string specified by Format.      @return The number of ASCII characters printed to ConOut.  **/
end_comment

begin_function
name|UINTN
name|EFIAPI
name|AsciiPrint
parameter_list|(
name|IN
name|CONST
name|CHAR8
modifier|*
name|Format
parameter_list|,
modifier|...
parameter_list|)
block|{
name|VA_LIST
name|Marker
decl_stmt|;
name|UINTN
name|Return
decl_stmt|;
name|ASSERT
argument_list|(
name|Format
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|VA_START
argument_list|(
name|Marker
argument_list|,
name|Format
argument_list|)
expr_stmt|;
name|Return
operator|=
name|AsciiInternalPrint
argument_list|(
name|Format
argument_list|,
name|gST
operator|->
name|ConOut
argument_list|,
name|Marker
argument_list|)
expr_stmt|;
name|VA_END
argument_list|(
name|Marker
argument_list|)
expr_stmt|;
return|return
name|Return
return|;
block|}
end_function

begin_comment
comment|/**    Prints a formatted ASCII string to the console output device specified by    StdErr defined in the EFI_SYSTEM_TABLE.    This function prints a formatted ASCII string to the console output device    specified by StdErr in EFI_SYSTEM_TABLE and returns the number of ASCII    characters that printed to StdErr.  If the length of the formatted ASCII    string is greater than PcdUefiLibMaxPrintBufferSize, then only the first    PcdUefiLibMaxPrintBufferSize characters are sent to StdErr.   If Format is NULL, then ASSERT().   If gST->StdErr is NULL, then ASSERT().    @param Format   A Null-terminated ASCII format string.   @param ...      Variable argument list whose contents are accessed based                    on the format string specified by Format.      @return The number of ASCII characters printed to ConErr.  **/
end_comment

begin_function
name|UINTN
name|EFIAPI
name|AsciiErrorPrint
parameter_list|(
name|IN
name|CONST
name|CHAR8
modifier|*
name|Format
parameter_list|,
modifier|...
parameter_list|)
block|{
name|VA_LIST
name|Marker
decl_stmt|;
name|UINTN
name|Return
decl_stmt|;
name|ASSERT
argument_list|(
name|Format
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|VA_START
argument_list|(
name|Marker
argument_list|,
name|Format
argument_list|)
expr_stmt|;
name|Return
operator|=
name|AsciiInternalPrint
argument_list|(
name|Format
argument_list|,
name|gST
operator|->
name|StdErr
argument_list|,
name|Marker
argument_list|)
expr_stmt|;
name|VA_END
argument_list|(
name|Marker
argument_list|)
expr_stmt|;
return|return
name|Return
return|;
block|}
end_function

begin_comment
comment|/**   Internal function to print a formatted Unicode string to a graphics console device specified by   ConsoleOutputHandle defined in the EFI_SYSTEM_TABLE at the given (X,Y) coordinates.    This function prints a formatted Unicode string to the graphics console device   specified by ConsoleOutputHandle in EFI_SYSTEM_TABLE and returns the number of   Unicode characters printed. The EFI_HII_FONT_PROTOCOL is used to convert the   string to a bitmap using the glyphs registered with the   HII database.  No wrapping is performed, so any portions of the string the fall   outside the active display region will not be displayed.    If a graphics console device is not associated with the ConsoleOutputHandle   defined in the EFI_SYSTEM_TABLE then no string is printed, and 0 is returned.   If the EFI_HII_FONT_PROTOCOL is not present in the handle database, then no   string is printed, and 0 is returned.    @param  PointX       An X coordinate to print the string.   @param  PointY       A Y coordinate to print the string.   @param  Foreground   The foreground color of the string being printed.  This is                        an optional parameter that may be NULL.  If it is NULL,                        then the foreground color of the current ConOut device                        in the EFI_SYSTEM_TABLE is used.   @param  Background   The background color of the string being printed.  This is                        an optional parameter that may be NULL.  If it is NULL,                        then the background color of the current ConOut device                        in the EFI_SYSTEM_TABLE is used.   @param  Buffer       A Null-terminated Unicode formatted string.   @param  PrintNum     The number of Unicode formatted string to be printed.    @return  The number of Unicode Characters printed. Zero means no any character            displayed successfully.  **/
end_comment

begin_function
name|UINTN
name|InternalPrintGraphic
parameter_list|(
name|IN
name|UINTN
name|PointX
parameter_list|,
name|IN
name|UINTN
name|PointY
parameter_list|,
name|IN
name|EFI_GRAPHICS_OUTPUT_BLT_PIXEL
modifier|*
name|Foreground
parameter_list|,
name|IN
name|EFI_GRAPHICS_OUTPUT_BLT_PIXEL
modifier|*
name|Background
parameter_list|,
name|IN
name|CHAR16
modifier|*
name|Buffer
parameter_list|,
name|IN
name|UINTN
name|PrintNum
parameter_list|)
block|{
name|EFI_STATUS
name|Status
decl_stmt|;
name|UINT32
name|HorizontalResolution
decl_stmt|;
name|UINT32
name|VerticalResolution
decl_stmt|;
name|UINT32
name|ColorDepth
decl_stmt|;
name|UINT32
name|RefreshRate
decl_stmt|;
name|EFI_HII_FONT_PROTOCOL
modifier|*
name|HiiFont
decl_stmt|;
name|EFI_IMAGE_OUTPUT
modifier|*
name|Blt
decl_stmt|;
name|EFI_FONT_DISPLAY_INFO
name|FontInfo
decl_stmt|;
name|EFI_HII_ROW_INFO
modifier|*
name|RowInfoArray
decl_stmt|;
name|UINTN
name|RowInfoArraySize
decl_stmt|;
name|EFI_GRAPHICS_OUTPUT_PROTOCOL
modifier|*
name|GraphicsOutput
decl_stmt|;
name|EFI_UGA_DRAW_PROTOCOL
modifier|*
name|UgaDraw
decl_stmt|;
name|EFI_SIMPLE_TEXT_OUTPUT_PROTOCOL
modifier|*
name|Sto
decl_stmt|;
name|EFI_HANDLE
name|ConsoleHandle
decl_stmt|;
name|UINTN
name|Width
decl_stmt|;
name|UINTN
name|Height
decl_stmt|;
name|UINTN
name|Delta
decl_stmt|;
name|HorizontalResolution
operator|=
literal|0
expr_stmt|;
name|VerticalResolution
operator|=
literal|0
expr_stmt|;
name|Blt
operator|=
name|NULL
expr_stmt|;
name|RowInfoArray
operator|=
name|NULL
expr_stmt|;
name|ConsoleHandle
operator|=
name|gST
operator|->
name|ConsoleOutHandle
expr_stmt|;
name|ASSERT
argument_list|(
name|ConsoleHandle
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|Status
operator|=
name|gBS
operator|->
name|HandleProtocol
argument_list|(
name|ConsoleHandle
argument_list|,
operator|&
name|gEfiGraphicsOutputProtocolGuid
argument_list|,
operator|(
name|VOID
operator|*
operator|*
operator|)
operator|&
name|GraphicsOutput
argument_list|)
expr_stmt|;
name|UgaDraw
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|EFI_ERROR
argument_list|(
name|Status
argument_list|)
operator|&&
name|FeaturePcdGet
argument_list|(
name|PcdUgaConsumeSupport
argument_list|)
condition|)
block|{
comment|//
comment|// If no GOP available, try to open UGA Draw protocol if supported.
comment|//
name|GraphicsOutput
operator|=
name|NULL
expr_stmt|;
name|Status
operator|=
name|gBS
operator|->
name|HandleProtocol
argument_list|(
name|ConsoleHandle
argument_list|,
operator|&
name|gEfiUgaDrawProtocolGuid
argument_list|,
operator|(
name|VOID
operator|*
operator|*
operator|)
operator|&
name|UgaDraw
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|EFI_ERROR
argument_list|(
name|Status
argument_list|)
condition|)
block|{
goto|goto
name|Error
goto|;
block|}
name|Status
operator|=
name|gBS
operator|->
name|HandleProtocol
argument_list|(
name|ConsoleHandle
argument_list|,
operator|&
name|gEfiSimpleTextOutProtocolGuid
argument_list|,
operator|(
name|VOID
operator|*
operator|*
operator|)
operator|&
name|Sto
argument_list|)
expr_stmt|;
if|if
condition|(
name|EFI_ERROR
argument_list|(
name|Status
argument_list|)
condition|)
block|{
goto|goto
name|Error
goto|;
block|}
if|if
condition|(
name|GraphicsOutput
operator|!=
name|NULL
condition|)
block|{
name|HorizontalResolution
operator|=
name|GraphicsOutput
operator|->
name|Mode
operator|->
name|Info
operator|->
name|HorizontalResolution
expr_stmt|;
name|VerticalResolution
operator|=
name|GraphicsOutput
operator|->
name|Mode
operator|->
name|Info
operator|->
name|VerticalResolution
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|UgaDraw
operator|!=
name|NULL
operator|&&
name|FeaturePcdGet
argument_list|(
name|PcdUgaConsumeSupport
argument_list|)
condition|)
block|{
name|UgaDraw
operator|->
name|GetMode
argument_list|(
name|UgaDraw
argument_list|,
operator|&
name|HorizontalResolution
argument_list|,
operator|&
name|VerticalResolution
argument_list|,
operator|&
name|ColorDepth
argument_list|,
operator|&
name|RefreshRate
argument_list|)
expr_stmt|;
block|}
else|else
block|{
goto|goto
name|Error
goto|;
block|}
name|ASSERT
argument_list|(
operator|(
name|HorizontalResolution
operator|!=
literal|0
operator|)
operator|&&
operator|(
name|VerticalResolution
operator|!=
literal|0
operator|)
argument_list|)
expr_stmt|;
name|Status
operator|=
name|gBS
operator|->
name|LocateProtocol
argument_list|(
operator|&
name|gEfiHiiFontProtocolGuid
argument_list|,
name|NULL
argument_list|,
operator|(
name|VOID
operator|*
operator|*
operator|)
operator|&
name|HiiFont
argument_list|)
expr_stmt|;
if|if
condition|(
name|EFI_ERROR
argument_list|(
name|Status
argument_list|)
condition|)
block|{
goto|goto
name|Error
goto|;
block|}
name|Blt
operator|=
operator|(
name|EFI_IMAGE_OUTPUT
operator|*
operator|)
name|AllocateZeroPool
argument_list|(
sizeof|sizeof
argument_list|(
name|EFI_IMAGE_OUTPUT
argument_list|)
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|Blt
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|Blt
operator|->
name|Width
operator|=
call|(
name|UINT16
call|)
argument_list|(
name|HorizontalResolution
argument_list|)
expr_stmt|;
name|Blt
operator|->
name|Height
operator|=
call|(
name|UINT16
call|)
argument_list|(
name|VerticalResolution
argument_list|)
expr_stmt|;
name|ZeroMem
argument_list|(
operator|&
name|FontInfo
argument_list|,
sizeof|sizeof
argument_list|(
name|EFI_FONT_DISPLAY_INFO
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|Foreground
operator|!=
name|NULL
condition|)
block|{
name|CopyMem
argument_list|(
operator|&
name|FontInfo
operator|.
name|ForegroundColor
argument_list|,
name|Foreground
argument_list|,
sizeof|sizeof
argument_list|(
name|EFI_GRAPHICS_OUTPUT_BLT_PIXEL
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|CopyMem
argument_list|(
operator|&
name|FontInfo
operator|.
name|ForegroundColor
argument_list|,
operator|&
name|mEfiColors
index|[
name|Sto
operator|->
name|Mode
operator|->
name|Attribute
operator|&
literal|0x0f
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|EFI_GRAPHICS_OUTPUT_BLT_PIXEL
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|Background
operator|!=
name|NULL
condition|)
block|{
name|CopyMem
argument_list|(
operator|&
name|FontInfo
operator|.
name|BackgroundColor
argument_list|,
name|Background
argument_list|,
sizeof|sizeof
argument_list|(
name|EFI_GRAPHICS_OUTPUT_BLT_PIXEL
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|CopyMem
argument_list|(
operator|&
name|FontInfo
operator|.
name|BackgroundColor
argument_list|,
operator|&
name|mEfiColors
index|[
name|Sto
operator|->
name|Mode
operator|->
name|Attribute
operator|>>
literal|4
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|EFI_GRAPHICS_OUTPUT_BLT_PIXEL
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|GraphicsOutput
operator|!=
name|NULL
condition|)
block|{
name|Blt
operator|->
name|Image
operator|.
name|Screen
operator|=
name|GraphicsOutput
expr_stmt|;
name|Status
operator|=
name|HiiFont
operator|->
name|StringToImage
argument_list|(
name|HiiFont
argument_list|,
name|EFI_HII_IGNORE_IF_NO_GLYPH
operator||
name|EFI_HII_OUT_FLAG_CLIP
operator||
name|EFI_HII_OUT_FLAG_CLIP_CLEAN_X
operator||
name|EFI_HII_OUT_FLAG_CLIP_CLEAN_Y
operator||
name|EFI_HII_IGNORE_LINE_BREAK
operator||
name|EFI_HII_DIRECT_TO_SCREEN
argument_list|,
name|Buffer
argument_list|,
operator|&
name|FontInfo
argument_list|,
operator|&
name|Blt
argument_list|,
name|PointX
argument_list|,
name|PointY
argument_list|,
operator|&
name|RowInfoArray
argument_list|,
operator|&
name|RowInfoArraySize
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|EFI_ERROR
argument_list|(
name|Status
argument_list|)
condition|)
block|{
goto|goto
name|Error
goto|;
block|}
block|}
elseif|else
if|if
condition|(
name|FeaturePcdGet
argument_list|(
name|PcdUgaConsumeSupport
argument_list|)
condition|)
block|{
name|ASSERT
argument_list|(
name|UgaDraw
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|Blt
operator|->
name|Image
operator|.
name|Bitmap
operator|=
name|AllocateZeroPool
argument_list|(
name|Blt
operator|->
name|Width
operator|*
name|Blt
operator|->
name|Height
operator|*
sizeof|sizeof
argument_list|(
name|EFI_GRAPHICS_OUTPUT_BLT_PIXEL
argument_list|)
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|Blt
operator|->
name|Image
operator|.
name|Bitmap
operator|!=
name|NULL
argument_list|)
expr_stmt|;
comment|//
comment|//  StringToImage only support blt'ing image to device using GOP protocol. If GOP is not supported in this platform,
comment|//  we ask StringToImage to print the string to blt buffer, then blt to device using UgaDraw.
comment|//
name|Status
operator|=
name|HiiFont
operator|->
name|StringToImage
argument_list|(
name|HiiFont
argument_list|,
name|EFI_HII_IGNORE_IF_NO_GLYPH
operator||
name|EFI_HII_OUT_FLAG_CLIP
operator||
name|EFI_HII_OUT_FLAG_CLIP_CLEAN_X
operator||
name|EFI_HII_OUT_FLAG_CLIP_CLEAN_Y
operator||
name|EFI_HII_IGNORE_LINE_BREAK
argument_list|,
name|Buffer
argument_list|,
operator|&
name|FontInfo
argument_list|,
operator|&
name|Blt
argument_list|,
name|PointX
argument_list|,
name|PointY
argument_list|,
operator|&
name|RowInfoArray
argument_list|,
operator|&
name|RowInfoArraySize
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|EFI_ERROR
argument_list|(
name|Status
argument_list|)
condition|)
block|{
name|ASSERT
argument_list|(
name|RowInfoArray
operator|!=
name|NULL
argument_list|)
expr_stmt|;
comment|//
comment|// Explicit Line break characters are ignored, so the updated parameter RowInfoArraySize by StringToImage will
comment|// always be 1 or 0 (if there is no valid Unicode Char can be printed). ASSERT here to make sure.
comment|//
name|ASSERT
argument_list|(
name|RowInfoArraySize
operator|<=
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|RowInfoArraySize
operator|!=
literal|0
condition|)
block|{
name|Width
operator|=
name|RowInfoArray
index|[
literal|0
index|]
operator|.
name|LineWidth
expr_stmt|;
name|Height
operator|=
name|RowInfoArray
index|[
literal|0
index|]
operator|.
name|LineHeight
expr_stmt|;
name|Delta
operator|=
name|Blt
operator|->
name|Width
operator|*
sizeof|sizeof
argument_list|(
name|EFI_GRAPHICS_OUTPUT_BLT_PIXEL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|Width
operator|=
literal|0
expr_stmt|;
name|Height
operator|=
literal|0
expr_stmt|;
name|Delta
operator|=
literal|0
expr_stmt|;
block|}
name|Status
operator|=
name|UgaDraw
operator|->
name|Blt
argument_list|(
name|UgaDraw
argument_list|,
operator|(
name|EFI_UGA_PIXEL
operator|*
operator|)
name|Blt
operator|->
name|Image
operator|.
name|Bitmap
argument_list|,
name|EfiUgaBltBufferToVideo
argument_list|,
name|PointX
argument_list|,
name|PointY
argument_list|,
name|PointX
argument_list|,
name|PointY
argument_list|,
name|Width
argument_list|,
name|Height
argument_list|,
name|Delta
argument_list|)
expr_stmt|;
block|}
else|else
block|{
goto|goto
name|Error
goto|;
block|}
name|FreePool
argument_list|(
name|Blt
operator|->
name|Image
operator|.
name|Bitmap
argument_list|)
expr_stmt|;
block|}
else|else
block|{
goto|goto
name|Error
goto|;
block|}
comment|//
comment|// Calculate the number of actual printed characters
comment|//
if|if
condition|(
name|RowInfoArraySize
operator|!=
literal|0
condition|)
block|{
name|PrintNum
operator|=
name|RowInfoArray
index|[
literal|0
index|]
operator|.
name|EndIndex
operator|-
name|RowInfoArray
index|[
literal|0
index|]
operator|.
name|StartIndex
operator|+
literal|1
expr_stmt|;
block|}
else|else
block|{
name|PrintNum
operator|=
literal|0
expr_stmt|;
block|}
name|FreePool
argument_list|(
name|RowInfoArray
argument_list|)
expr_stmt|;
name|FreePool
argument_list|(
name|Blt
argument_list|)
expr_stmt|;
return|return
name|PrintNum
return|;
name|Error
label|:
if|if
condition|(
name|Blt
operator|!=
name|NULL
condition|)
block|{
name|FreePool
argument_list|(
name|Blt
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**   Prints a formatted Unicode string to a graphics console device specified by    ConsoleOutputHandle defined in the EFI_SYSTEM_TABLE at the given (X,Y) coordinates.    This function prints a formatted Unicode string to the graphics console device    specified by ConsoleOutputHandle in EFI_SYSTEM_TABLE and returns the number of    Unicode characters displayed, not including partial characters that may be clipped    by the right edge of the display.  If the length of the formatted Unicode string is   greater than PcdUefiLibMaxPrintBufferSize, then at most the first    PcdUefiLibMaxPrintBufferSize characters are printed.The EFI_HII_FONT_PROTOCOL   StringToImage() service is used to convert the string to a bitmap using the glyphs    registered with the HII database. No wrapping is performed, so any portions of the    string the fall outside the active display region will not be displayed. Please see    Section 27.2.6 of the UEFI Specification for a description of the supported string   format including the set of control codes supported by the StringToImage() service.    If a graphics console device is not associated with the ConsoleOutputHandle    defined in the EFI_SYSTEM_TABLE then no string is printed, and 0 is returned.   If the EFI_HII_FONT_PROTOCOL is not present in the handle database, then no    string is printed, and 0 is returned.   If Format is NULL, then ASSERT().   If Format is not aligned on a 16-bit boundary, then ASSERT().   If gST->ConsoleOutputHandle is NULL, then ASSERT().    @param  PointX       An X coordinate to print the string.   @param  PointY       A Y coordinate to print the string.   @param  ForeGround   The foreground color of the string being printed.  This is                        an optional parameter that may be NULL.  If it is NULL,                        then the foreground color of the current ConOut device                        in the EFI_SYSTEM_TABLE is used.   @param  BackGround   The background color of the string being printed.  This is                        an optional parameter that may be NULL.  If it is NULL,                         then the background color of the current ConOut device                        in the EFI_SYSTEM_TABLE is used.   @param  Format       A Null-terminated Unicode format string.  See Print Library                         for the supported format string syntax.   @param  ...          A Variable argument list whose contents are accessed based on                         the format string specified by Format.             @return  The number of Unicode characters printed.  **/
end_comment

begin_function
name|UINTN
name|EFIAPI
name|PrintXY
parameter_list|(
name|IN
name|UINTN
name|PointX
parameter_list|,
name|IN
name|UINTN
name|PointY
parameter_list|,
name|IN
name|EFI_GRAPHICS_OUTPUT_BLT_PIXEL
modifier|*
name|ForeGround
parameter_list|,
name|OPTIONAL
name|IN
name|EFI_GRAPHICS_OUTPUT_BLT_PIXEL
modifier|*
name|BackGround
parameter_list|,
name|OPTIONAL
name|IN
name|CONST
name|CHAR16
modifier|*
name|Format
parameter_list|,
modifier|...
parameter_list|)
block|{
name|VA_LIST
name|Marker
decl_stmt|;
name|CHAR16
modifier|*
name|Buffer
decl_stmt|;
name|UINTN
name|BufferSize
decl_stmt|;
name|UINTN
name|PrintNum
decl_stmt|;
name|UINTN
name|ReturnNum
decl_stmt|;
name|ASSERT
argument_list|(
name|Format
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
operator|(
operator|(
name|UINTN
operator|)
name|Format
operator|&
name|BIT0
operator|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|VA_START
argument_list|(
name|Marker
argument_list|,
name|Format
argument_list|)
expr_stmt|;
name|BufferSize
operator|=
operator|(
name|PcdGet32
argument_list|(
name|PcdUefiLibMaxPrintBufferSize
argument_list|)
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|CHAR16
argument_list|)
expr_stmt|;
name|Buffer
operator|=
operator|(
name|CHAR16
operator|*
operator|)
name|AllocatePool
argument_list|(
name|BufferSize
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|Buffer
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|PrintNum
operator|=
name|UnicodeVSPrint
argument_list|(
name|Buffer
argument_list|,
name|BufferSize
argument_list|,
name|Format
argument_list|,
name|Marker
argument_list|)
expr_stmt|;
name|VA_END
argument_list|(
name|Marker
argument_list|)
expr_stmt|;
name|ReturnNum
operator|=
name|InternalPrintGraphic
argument_list|(
name|PointX
argument_list|,
name|PointY
argument_list|,
name|ForeGround
argument_list|,
name|BackGround
argument_list|,
name|Buffer
argument_list|,
name|PrintNum
argument_list|)
expr_stmt|;
name|FreePool
argument_list|(
name|Buffer
argument_list|)
expr_stmt|;
return|return
name|ReturnNum
return|;
block|}
end_function

begin_comment
comment|/**   Prints a formatted ASCII string to a graphics console device specified by    ConsoleOutputHandle defined in the EFI_SYSTEM_TABLE at the given (X,Y) coordinates.    This function prints a formatted ASCII string to the graphics console device    specified by ConsoleOutputHandle in EFI_SYSTEM_TABLE and returns the number of    ASCII characters displayed, not including partial characters that may be clipped    by the right edge of the display.  If the length of the formatted ASCII string is   greater than PcdUefiLibMaxPrintBufferSize, then at most the first    PcdUefiLibMaxPrintBufferSize characters are printed.The EFI_HII_FONT_PROTOCOL   StringToImage() service is used to convert the string to a bitmap using the glyphs    registered with the HII database. No wrapping is performed, so any portions of the    string the fall outside the active display region will not be displayed. Please see    Section 27.2.6 of the UEFI Specification for a description of the supported string   format including the set of control codes supported by the StringToImage() service.    If a graphics console device is not associated with the ConsoleOutputHandle    defined in the EFI_SYSTEM_TABLE then no string is printed, and 0 is returned.   If the EFI_HII_FONT_PROTOCOL is not present in the handle database, then no    string is printed, and 0 is returned.   If Format is NULL, then ASSERT().   If gST->ConsoleOutputHandle is NULL, then ASSERT().    @param  PointX       An X coordinate to print the string.   @param  PointY       A Y coordinate to print the string.   @param  ForeGround   The foreground color of the string being printed.  This is                        an optional parameter that may be NULL.  If it is NULL,                        then the foreground color of the current ConOut device                        in the EFI_SYSTEM_TABLE is used.   @param  BackGround   The background color of the string being printed.  This is                        an optional parameter that may be NULL.  If it is NULL,                         then the background color of the current ConOut device                        in the EFI_SYSTEM_TABLE is used.   @param  Format       A Null-terminated ASCII format string.  See Print Library                         for the supported format string syntax.   @param  ...          Variable argument list whose contents are accessed based on                         the format string specified by Format.             @return  The number of ASCII characters printed.  **/
end_comment

begin_function
name|UINTN
name|EFIAPI
name|AsciiPrintXY
parameter_list|(
name|IN
name|UINTN
name|PointX
parameter_list|,
name|IN
name|UINTN
name|PointY
parameter_list|,
name|IN
name|EFI_GRAPHICS_OUTPUT_BLT_PIXEL
modifier|*
name|ForeGround
parameter_list|,
name|OPTIONAL
name|IN
name|EFI_GRAPHICS_OUTPUT_BLT_PIXEL
modifier|*
name|BackGround
parameter_list|,
name|OPTIONAL
name|IN
name|CONST
name|CHAR8
modifier|*
name|Format
parameter_list|,
modifier|...
parameter_list|)
block|{
name|VA_LIST
name|Marker
decl_stmt|;
name|CHAR16
modifier|*
name|Buffer
decl_stmt|;
name|UINTN
name|BufferSize
decl_stmt|;
name|UINTN
name|PrintNum
decl_stmt|;
name|UINTN
name|ReturnNum
decl_stmt|;
name|ASSERT
argument_list|(
name|Format
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|VA_START
argument_list|(
name|Marker
argument_list|,
name|Format
argument_list|)
expr_stmt|;
name|BufferSize
operator|=
operator|(
name|PcdGet32
argument_list|(
name|PcdUefiLibMaxPrintBufferSize
argument_list|)
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|CHAR16
argument_list|)
expr_stmt|;
name|Buffer
operator|=
operator|(
name|CHAR16
operator|*
operator|)
name|AllocatePool
argument_list|(
name|BufferSize
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|Buffer
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|PrintNum
operator|=
name|UnicodeSPrintAsciiFormat
argument_list|(
name|Buffer
argument_list|,
name|BufferSize
argument_list|,
name|Format
argument_list|,
name|Marker
argument_list|)
expr_stmt|;
name|VA_END
argument_list|(
name|Marker
argument_list|)
expr_stmt|;
name|ReturnNum
operator|=
name|InternalPrintGraphic
argument_list|(
name|PointX
argument_list|,
name|PointY
argument_list|,
name|ForeGround
argument_list|,
name|BackGround
argument_list|,
name|Buffer
argument_list|,
name|PrintNum
argument_list|)
expr_stmt|;
name|FreePool
argument_list|(
name|Buffer
argument_list|)
expr_stmt|;
return|return
name|ReturnNum
return|;
block|}
end_function

begin_comment
comment|/**    Appends a formatted Unicode string to a Null-terminated Unicode string     This function appends a formatted Unicode string to the Null-terminated    Unicode string specified by String.   String is optional and may be NULL.   Storage for the formatted Unicode string returned is allocated using    AllocatePool().  The pointer to the appended string is returned.  The caller   is responsible for freeing the returned string.     If String is not NULL and not aligned on a 16-bit boundary, then ASSERT().   If FormatString is NULL, then ASSERT().   If FormatString is not aligned on a 16-bit boundary, then ASSERT().     @param[in] String         A Null-terminated Unicode string.   @param[in] FormatString   A Null-terminated Unicode format string.   @param[in]  Marker        VA_LIST marker for the variable argument list.    @retval NULL    There was not enough available memory.   @return         Null-terminated Unicode string is that is the formatted                    string appended to String. **/
end_comment

begin_function
name|CHAR16
modifier|*
name|EFIAPI
name|CatVSPrint
parameter_list|(
name|IN
name|CHAR16
modifier|*
name|String
parameter_list|,
name|OPTIONAL
name|IN
name|CONST
name|CHAR16
modifier|*
name|FormatString
parameter_list|,
name|IN
name|VA_LIST
name|Marker
parameter_list|)
block|{
name|UINTN
name|CharactersRequired
decl_stmt|;
name|UINTN
name|SizeRequired
decl_stmt|;
name|CHAR16
modifier|*
name|BufferToReturn
decl_stmt|;
name|VA_LIST
name|ExtraMarker
decl_stmt|;
name|VA_COPY
argument_list|(
name|ExtraMarker
argument_list|,
name|Marker
argument_list|)
expr_stmt|;
name|CharactersRequired
operator|=
name|SPrintLength
argument_list|(
name|FormatString
argument_list|,
name|ExtraMarker
argument_list|)
expr_stmt|;
name|VA_END
argument_list|(
name|ExtraMarker
argument_list|)
expr_stmt|;
if|if
condition|(
name|String
operator|!=
name|NULL
condition|)
block|{
name|SizeRequired
operator|=
name|StrSize
argument_list|(
name|String
argument_list|)
operator|+
operator|(
name|CharactersRequired
operator|*
sizeof|sizeof
argument_list|(
name|CHAR16
argument_list|)
operator|)
expr_stmt|;
block|}
else|else
block|{
name|SizeRequired
operator|=
sizeof|sizeof
argument_list|(
name|CHAR16
argument_list|)
operator|+
operator|(
name|CharactersRequired
operator|*
sizeof|sizeof
argument_list|(
name|CHAR16
argument_list|)
operator|)
expr_stmt|;
block|}
name|BufferToReturn
operator|=
name|AllocatePool
argument_list|(
name|SizeRequired
argument_list|)
expr_stmt|;
if|if
condition|(
name|BufferToReturn
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
else|else
block|{
name|BufferToReturn
index|[
literal|0
index|]
operator|=
literal|L'
expr|\0'
expr_stmt|;
block|}
if|if
condition|(
name|String
operator|!=
name|NULL
condition|)
block|{
name|StrCpyS
argument_list|(
name|BufferToReturn
argument_list|,
name|SizeRequired
operator|/
sizeof|sizeof
argument_list|(
name|CHAR16
argument_list|)
argument_list|,
name|String
argument_list|)
expr_stmt|;
block|}
name|UnicodeVSPrint
argument_list|(
name|BufferToReturn
operator|+
name|StrLen
argument_list|(
name|BufferToReturn
argument_list|)
argument_list|,
operator|(
name|CharactersRequired
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|CHAR16
argument_list|)
argument_list|,
name|FormatString
argument_list|,
name|Marker
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|StrSize
argument_list|(
name|BufferToReturn
argument_list|)
operator|==
name|SizeRequired
argument_list|)
expr_stmt|;
return|return
operator|(
name|BufferToReturn
operator|)
return|;
block|}
end_function

begin_comment
comment|/**    Appends a formatted Unicode string to a Null-terminated Unicode string     This function appends a formatted Unicode string to the Null-terminated    Unicode string specified by String.   String is optional and may be NULL.   Storage for the formatted Unicode string returned is allocated using    AllocatePool().  The pointer to the appended string is returned.  The caller   is responsible for freeing the returned string.     If String is not NULL and not aligned on a 16-bit boundary, then ASSERT().   If FormatString is NULL, then ASSERT().   If FormatString is not aligned on a 16-bit boundary, then ASSERT().     @param[in] String         A Null-terminated Unicode string.   @param[in] FormatString   A Null-terminated Unicode format string.   @param[in] ...            The variable argument list whose contents are                              accessed based on the format string specified by                              FormatString.    @retval NULL    There was not enough available memory.   @return         Null-terminated Unicode string is that is the formatted                    string appended to String. **/
end_comment

begin_function
name|CHAR16
modifier|*
name|EFIAPI
name|CatSPrint
parameter_list|(
name|IN
name|CHAR16
modifier|*
name|String
parameter_list|,
name|OPTIONAL
name|IN
name|CONST
name|CHAR16
modifier|*
name|FormatString
parameter_list|,
modifier|...
parameter_list|)
block|{
name|VA_LIST
name|Marker
decl_stmt|;
name|CHAR16
modifier|*
name|NewString
decl_stmt|;
name|VA_START
argument_list|(
name|Marker
argument_list|,
name|FormatString
argument_list|)
expr_stmt|;
name|NewString
operator|=
name|CatVSPrint
argument_list|(
name|String
argument_list|,
name|FormatString
argument_list|,
name|Marker
argument_list|)
expr_stmt|;
name|VA_END
argument_list|(
name|Marker
argument_list|)
expr_stmt|;
return|return
name|NewString
return|;
block|}
end_function

end_unit


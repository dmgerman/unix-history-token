begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/** @file   Library functions that abstract areas of conflict between framework and UEFI 2.0.    Help Port Framework code that has conflicts with UEFI 2.0 by hiding the   old conflicts with library functions and supporting implementations of the old   (EDK/EFI 1.10) and new (EDK II/UEFI 2.0) way. This module is a DXE driver as   it contains DXE enum extensions for EFI event services.  Copyright (c) 2006 - 2017, Intel Corporation. All rights reserved.<BR> This program and the accompanying materials are licensed and made available under the terms and conditions of the BSD License which accompanies this distribution.  The full text of the license may be found at http://opensource.org/licenses/bsd-license.php  THE PROGRAM IS DISTRIBUTED UNDER THE BSD LICENSE ON AN "AS IS" BASIS, WITHOUT WARRANTIES OR REPRESENTATIONS OF ANY KIND, EITHER EXPRESS OR IMPLIED.  **/
end_comment

begin_include
include|#
directive|include
file|"UefiLibInternal.h"
end_include

begin_comment
comment|/**   Creates an EFI event in the Legacy Boot Event Group.    Prior to UEFI 2.0 this was done via a non blessed UEFI extensions and this library   abstracts the implementation mechanism of this event from the caller. This function   abstracts the creation of the Legacy Boot Event. The Framework moved from a proprietary   to UEFI 2.0 based mechanism.  This library abstracts the caller from how this event   is created to prevent to code form having to change with the version of the   specification supported.   If LegacyBootEvent is NULL, then ASSERT().    @param  LegacyBootEvent   Returns the EFI event returned from gBS->CreateEvent(Ex).    @retval EFI_SUCCESS       Event was created.   @retval Other             Event was not created.  **/
end_comment

begin_function
name|EFI_STATUS
name|EFIAPI
name|EfiCreateEventLegacyBoot
parameter_list|(
name|OUT
name|EFI_EVENT
modifier|*
name|LegacyBootEvent
parameter_list|)
block|{
return|return
name|EfiCreateEventLegacyBootEx
argument_list|(
name|TPL_CALLBACK
argument_list|,
name|EfiEventEmptyFunction
argument_list|,
name|NULL
argument_list|,
name|LegacyBootEvent
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**   Create an EFI event in the Legacy Boot Event Group and allows   the caller to specify a notification function.        This function abstracts the creation of the Legacy Boot Event.   The Framework moved from a proprietary to UEFI 2.0 based mechanism.   This library abstracts the caller from how this event is created to prevent   to code form having to change with the version of the specification supported.   If LegacyBootEvent is NULL, then ASSERT().    @param  NotifyTpl         The task priority level of the event.   @param  NotifyFunction    The notification function to call when the event is signaled.   @param  NotifyContext     The content to pass to NotifyFunction when the event is signaled.   @param  LegacyBootEvent   Returns the EFI event returned from gBS->CreateEvent(Ex).    @retval EFI_SUCCESS       Event was created.   @retval Other             Event was not created.  **/
end_comment

begin_function
name|EFI_STATUS
name|EFIAPI
name|EfiCreateEventLegacyBootEx
parameter_list|(
name|IN
name|EFI_TPL
name|NotifyTpl
parameter_list|,
name|IN
name|EFI_EVENT_NOTIFY
name|NotifyFunction
parameter_list|,
name|OPTIONAL
name|IN
name|VOID
modifier|*
name|NotifyContext
parameter_list|,
name|OPTIONAL
name|OUT
name|EFI_EVENT
modifier|*
name|LegacyBootEvent
parameter_list|)
block|{
name|EFI_STATUS
name|Status
decl_stmt|;
name|EFI_EVENT_NOTIFY
name|WorkerNotifyFunction
decl_stmt|;
name|ASSERT
argument_list|(
name|LegacyBootEvent
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|gST
operator|->
name|Hdr
operator|.
name|Revision
operator|<
name|EFI_2_00_SYSTEM_TABLE_REVISION
condition|)
block|{
name|DEBUG
argument_list|(
operator|(
name|EFI_D_ERROR
operator|,
literal|"EFI1.1 can't support LegacyBootEvent!"
operator|)
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|FALSE
argument_list|)
expr_stmt|;
return|return
name|EFI_UNSUPPORTED
return|;
block|}
else|else
block|{
comment|//
comment|// For UEFI 2.0 and the future use an Event Group
comment|//
if|if
condition|(
name|NotifyFunction
operator|==
name|NULL
condition|)
block|{
comment|//
comment|// CreateEventEx will check NotifyFunction is NULL or not and return error.
comment|// Use dummy routine for the case NotifyFunction is NULL.
comment|//
name|WorkerNotifyFunction
operator|=
name|EfiEventEmptyFunction
expr_stmt|;
block|}
else|else
block|{
name|WorkerNotifyFunction
operator|=
name|NotifyFunction
expr_stmt|;
block|}
name|Status
operator|=
name|gBS
operator|->
name|CreateEventEx
argument_list|(
name|EVT_NOTIFY_SIGNAL
argument_list|,
name|NotifyTpl
argument_list|,
name|WorkerNotifyFunction
argument_list|,
name|NotifyContext
argument_list|,
operator|&
name|gEfiEventLegacyBootGuid
argument_list|,
name|LegacyBootEvent
argument_list|)
expr_stmt|;
block|}
return|return
name|Status
return|;
block|}
end_function

begin_comment
comment|/**   Create an EFI event in the Ready To Boot Event Group.    Prior to UEFI 2.0 this was done via a non-standard UEFI extension, and this library   abstracts the implementation mechanism of this event from the caller.      This function abstracts the creation of the Ready to Boot Event.  The Framework    moved from a proprietary to UEFI 2.0-based mechanism.  This library abstracts    the caller from how this event is created to prevent the code form having to    change with the version of the specification supported.   If ReadyToBootEvent is NULL, then ASSERT().    @param  ReadyToBootEvent  Returns the EFI event returned from gBS->CreateEvent(Ex).    @retval EFI_SUCCESS       Event was created.   @retval Other             Event was not created.  **/
end_comment

begin_function
name|EFI_STATUS
name|EFIAPI
name|EfiCreateEventReadyToBoot
parameter_list|(
name|OUT
name|EFI_EVENT
modifier|*
name|ReadyToBootEvent
parameter_list|)
block|{
return|return
name|EfiCreateEventReadyToBootEx
argument_list|(
name|TPL_CALLBACK
argument_list|,
name|EfiEventEmptyFunction
argument_list|,
name|NULL
argument_list|,
name|ReadyToBootEvent
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**   Create an EFI event in the Ready To Boot Event Group and allows   the caller to specify a notification function.        This function abstracts the creation of the Ready to Boot Event.   The Framework moved from a proprietary to UEFI 2.0 based mechanism.   This library abstracts the caller from how this event is created to prevent   to code form having to change with the version of the specification supported.   If ReadyToBootEvent is NULL, then ASSERT().    @param  NotifyTpl         The task priority level of the event.   @param  NotifyFunction    The notification function to call when the event is signaled.   @param  NotifyContext     The content to pass to NotifyFunction when the event is signaled.   @param  ReadyToBootEvent  Returns the EFI event returned from gBS->CreateEvent(Ex).    @retval EFI_SUCCESS       Event was created.   @retval Other             Event was not created.  **/
end_comment

begin_function
name|EFI_STATUS
name|EFIAPI
name|EfiCreateEventReadyToBootEx
parameter_list|(
name|IN
name|EFI_TPL
name|NotifyTpl
parameter_list|,
name|IN
name|EFI_EVENT_NOTIFY
name|NotifyFunction
parameter_list|,
name|OPTIONAL
name|IN
name|VOID
modifier|*
name|NotifyContext
parameter_list|,
name|OPTIONAL
name|OUT
name|EFI_EVENT
modifier|*
name|ReadyToBootEvent
parameter_list|)
block|{
name|EFI_STATUS
name|Status
decl_stmt|;
name|EFI_EVENT_NOTIFY
name|WorkerNotifyFunction
decl_stmt|;
name|ASSERT
argument_list|(
name|ReadyToBootEvent
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|gST
operator|->
name|Hdr
operator|.
name|Revision
operator|<
name|EFI_2_00_SYSTEM_TABLE_REVISION
condition|)
block|{
name|DEBUG
argument_list|(
operator|(
name|EFI_D_ERROR
operator|,
literal|"EFI1.1 can't support ReadyToBootEvent!"
operator|)
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|FALSE
argument_list|)
expr_stmt|;
return|return
name|EFI_UNSUPPORTED
return|;
block|}
else|else
block|{
comment|//
comment|// For UEFI 2.0 and the future use an Event Group
comment|//
if|if
condition|(
name|NotifyFunction
operator|==
name|NULL
condition|)
block|{
comment|//
comment|// CreateEventEx will check NotifyFunction is NULL or not and return error.
comment|// Use dummy routine for the case NotifyFunction is NULL.
comment|//
name|WorkerNotifyFunction
operator|=
name|EfiEventEmptyFunction
expr_stmt|;
block|}
else|else
block|{
name|WorkerNotifyFunction
operator|=
name|NotifyFunction
expr_stmt|;
block|}
name|Status
operator|=
name|gBS
operator|->
name|CreateEventEx
argument_list|(
name|EVT_NOTIFY_SIGNAL
argument_list|,
name|NotifyTpl
argument_list|,
name|WorkerNotifyFunction
argument_list|,
name|NotifyContext
argument_list|,
operator|&
name|gEfiEventReadyToBootGuid
argument_list|,
name|ReadyToBootEvent
argument_list|)
expr_stmt|;
block|}
return|return
name|Status
return|;
block|}
end_function

begin_comment
comment|/**   Create, Signal, and Close the Ready to Boot event using EfiSignalEventReadyToBoot().      This function abstracts the signaling of the Ready to Boot Event. The Framework moved   from a proprietary to UEFI 2.0 based mechanism. This library abstracts the caller   from how this event is created to prevent to code form having to change with the   version of the specification supported.  **/
end_comment

begin_function
name|VOID
name|EFIAPI
name|EfiSignalEventReadyToBoot
parameter_list|(
name|VOID
parameter_list|)
block|{
name|EFI_STATUS
name|Status
decl_stmt|;
name|EFI_EVENT
name|ReadyToBootEvent
decl_stmt|;
name|Status
operator|=
name|EfiCreateEventReadyToBoot
argument_list|(
operator|&
name|ReadyToBootEvent
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|EFI_ERROR
argument_list|(
name|Status
argument_list|)
condition|)
block|{
name|gBS
operator|->
name|SignalEvent
argument_list|(
name|ReadyToBootEvent
argument_list|)
expr_stmt|;
name|gBS
operator|->
name|CloseEvent
argument_list|(
name|ReadyToBootEvent
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**   Create, Signal, and Close the Ready to Boot event using EfiSignalEventLegacyBoot().    This function abstracts the signaling of the Legacy Boot Event. The Framework moved from   a proprietary to UEFI 2.0 based mechanism.  This library abstracts the caller from how   this event is created to prevent to code form having to change with the version of the   specification supported.  **/
end_comment

begin_function
name|VOID
name|EFIAPI
name|EfiSignalEventLegacyBoot
parameter_list|(
name|VOID
parameter_list|)
block|{
name|EFI_STATUS
name|Status
decl_stmt|;
name|EFI_EVENT
name|LegacyBootEvent
decl_stmt|;
name|Status
operator|=
name|EfiCreateEventLegacyBoot
argument_list|(
operator|&
name|LegacyBootEvent
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|EFI_ERROR
argument_list|(
name|Status
argument_list|)
condition|)
block|{
name|gBS
operator|->
name|SignalEvent
argument_list|(
name|LegacyBootEvent
argument_list|)
expr_stmt|;
name|gBS
operator|->
name|CloseEvent
argument_list|(
name|LegacyBootEvent
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**   Check to see if the Firmware Volume (FV) Media Device Path is valid       The Framework FwVol Device Path changed to conform to the UEFI 2.0 specification.     This library function abstracts validating a device path node.   Check the MEDIA_FW_VOL_FILEPATH_DEVICE_PATH data structure to see if it's valid.     If it is valid, then return the GUID file name from the device path node.  Otherwise,    return NULL.  This device path changed in the DXE CIS version 0.92 in a non back ward    compatible way to not conflict with the UEFI 2.0 specification.  This function abstracts    the differences from the caller.   If FvDevicePathNode is NULL, then ASSERT().    @param  FvDevicePathNode  The pointer to FV device path to check.    @retval NULL              FvDevicePathNode is not valid.   @retval Other             FvDevicePathNode is valid and pointer to NameGuid was returned.  **/
end_comment

begin_function
name|EFI_GUID
modifier|*
name|EFIAPI
name|EfiGetNameGuidFromFwVolDevicePathNode
parameter_list|(
name|IN
name|CONST
name|MEDIA_FW_VOL_FILEPATH_DEVICE_PATH
modifier|*
name|FvDevicePathNode
parameter_list|)
block|{
name|ASSERT
argument_list|(
name|FvDevicePathNode
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|DevicePathType
argument_list|(
operator|&
name|FvDevicePathNode
operator|->
name|Header
argument_list|)
operator|==
name|MEDIA_DEVICE_PATH
operator|&&
name|DevicePathSubType
argument_list|(
operator|&
name|FvDevicePathNode
operator|->
name|Header
argument_list|)
operator|==
name|MEDIA_PIWG_FW_FILE_DP
condition|)
block|{
return|return
operator|(
name|EFI_GUID
operator|*
operator|)
operator|&
name|FvDevicePathNode
operator|->
name|FvFileName
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/**   Initialize a Firmware Volume (FV) Media Device Path node.      The Framework FwVol Device Path changed to conform to the UEFI 2.0 specification.     This library function abstracts initializing a device path node.     Initialize the MEDIA_FW_VOL_FILEPATH_DEVICE_PATH data structure.  This device    path changed in the DXE CIS version 0.92 in a non back ward compatible way to    not conflict with the UEFI 2.0 specification.  This function abstracts the    differences from the caller.   If FvDevicePathNode is NULL, then ASSERT().   If NameGuid is NULL, then ASSERT().      @param  FvDevicePathNode  The pointer to a FV device path node to initialize   @param  NameGuid          FV file name to use in FvDevicePathNode  **/
end_comment

begin_function
name|VOID
name|EFIAPI
name|EfiInitializeFwVolDevicepathNode
parameter_list|(
name|IN
name|OUT
name|MEDIA_FW_VOL_FILEPATH_DEVICE_PATH
modifier|*
name|FvDevicePathNode
parameter_list|,
name|IN
name|CONST
name|EFI_GUID
modifier|*
name|NameGuid
parameter_list|)
block|{
name|ASSERT
argument_list|(
name|FvDevicePathNode
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|NameGuid
operator|!=
name|NULL
argument_list|)
expr_stmt|;
comment|//
comment|// Use the new Device path that does not conflict with the UEFI
comment|//
name|FvDevicePathNode
operator|->
name|Header
operator|.
name|Type
operator|=
name|MEDIA_DEVICE_PATH
expr_stmt|;
name|FvDevicePathNode
operator|->
name|Header
operator|.
name|SubType
operator|=
name|MEDIA_PIWG_FW_FILE_DP
expr_stmt|;
name|SetDevicePathNodeLength
argument_list|(
operator|&
name|FvDevicePathNode
operator|->
name|Header
argument_list|,
sizeof|sizeof
argument_list|(
name|MEDIA_FW_VOL_FILEPATH_DEVICE_PATH
argument_list|)
argument_list|)
expr_stmt|;
name|CopyGuid
argument_list|(
operator|&
name|FvDevicePathNode
operator|->
name|FvFileName
argument_list|,
name|NameGuid
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


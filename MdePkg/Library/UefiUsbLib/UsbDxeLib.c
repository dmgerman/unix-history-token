begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/** @file    The library provides the USB Standard Device Requests defined    in Usb specification 9.4 section.      Copyright (c) 2004 - 2008, Intel Corporation. All rights reserved.<BR>   This program and the accompanying materials are   licensed and made available under the terms and conditions of   the BSD License which accompanies this distribution.  The full   text of the license may be found at   http://opensource.org/licenses/bsd-license.php.      THE PROGRAM IS DISTRIBUTED UNDER THE BSD LICENSE ON AN "AS IS" BASIS,   WITHOUT WARRANTIES OR REPRESENTATIONS OF ANY KIND, EITHER EXPRESS OR IMPLIED.  **/
end_comment

begin_include
include|#
directive|include
file|"UefiUsbLibInternal.h"
end_include

begin_comment
comment|/**   Get the descriptor of the specified USB device.    Submit a USB get descriptor request for the USB device specified by UsbIo, Value,   and Index, and return the descriptor in the buffer specified by Descriptor.   The status of the transfer is returned in Status.   If UsbIo is NULL, then ASSERT().   If Descriptor is NULL, then ASSERT().   If Status is NULL, then ASSERT().    @param  UsbIo             A pointer to the USB I/O Protocol instance for the specific USB target.   @param  Value             The device request value.   @param  Index             The device request index.   @param  DescriptorLength  The size, in bytes, of Descriptor.   @param  Descriptor        A pointer to the descriptor buffer to get.   @param  Status            A pointer to the status of the transfer.    @retval EFI_SUCCESS           The request executed successfully.   @retval EFI_OUT_OF_RESOURCES  The request could not be completed because the                                 buffer specified by DescriptorLength and Descriptor                                 is not large enough to hold the result of the request.   @retval EFI_TIMEOUT           A timeout occurred executing the request.   @retval EFI_DEVICE_ERROR      The request failed due to a device error. The transfer                                 status is returned in Status.  **/
end_comment

begin_function
name|EFI_STATUS
name|EFIAPI
name|UsbGetDescriptor
parameter_list|(
name|IN
name|EFI_USB_IO_PROTOCOL
modifier|*
name|UsbIo
parameter_list|,
name|IN
name|UINT16
name|Value
parameter_list|,
name|IN
name|UINT16
name|Index
parameter_list|,
name|IN
name|UINT16
name|DescriptorLength
parameter_list|,
name|OUT
name|VOID
modifier|*
name|Descriptor
parameter_list|,
name|OUT
name|UINT32
modifier|*
name|Status
parameter_list|)
block|{
name|EFI_USB_DEVICE_REQUEST
name|DevReq
decl_stmt|;
name|ASSERT
argument_list|(
name|UsbIo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|Descriptor
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|Status
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ZeroMem
argument_list|(
operator|&
name|DevReq
argument_list|,
sizeof|sizeof
argument_list|(
name|EFI_USB_DEVICE_REQUEST
argument_list|)
argument_list|)
expr_stmt|;
name|DevReq
operator|.
name|RequestType
operator|=
name|USB_DEV_GET_DESCRIPTOR_REQ_TYPE
expr_stmt|;
name|DevReq
operator|.
name|Request
operator|=
name|USB_REQ_GET_DESCRIPTOR
expr_stmt|;
name|DevReq
operator|.
name|Value
operator|=
name|Value
expr_stmt|;
name|DevReq
operator|.
name|Index
operator|=
name|Index
expr_stmt|;
name|DevReq
operator|.
name|Length
operator|=
name|DescriptorLength
expr_stmt|;
return|return
name|UsbIo
operator|->
name|UsbControlTransfer
argument_list|(
name|UsbIo
argument_list|,
operator|&
name|DevReq
argument_list|,
name|EfiUsbDataIn
argument_list|,
name|PcdGet32
argument_list|(
name|PcdUsbTransferTimeoutValue
argument_list|)
argument_list|,
name|Descriptor
argument_list|,
name|DescriptorLength
argument_list|,
name|Status
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**   Set the descriptor of the specified USB device.    Submit a USB set descriptor request for the USB device specified by UsbIo,   Value, and Index, and set the descriptor using the buffer specified by DesriptorLength   and Descriptor.  The status of the transfer is returned in Status.   If UsbIo is NULL, then ASSERT().   If Descriptor is NULL, then ASSERT().   If Status is NULL, then ASSERT().    @param  UsbIo             A pointer to the USB I/O Protocol instance for the specific USB target.   @param  Value             The device request value.   @param  Index             The device request index.   @param  DescriptorLength  The size, in bytes, of Descriptor.   @param  Descriptor        A pointer to the descriptor buffer to set.   @param  Status            A pointer to the status of the transfer.    @retval  EFI_SUCCESS       The request executed successfully.   @retval  EFI_TIMEOUT       A timeout occurred executing the request.   @retval  EFI_DEVICE_ERROR  The request failed due to a device error.                              The transfer status is returned in Status.  **/
end_comment

begin_function
name|EFI_STATUS
name|EFIAPI
name|UsbSetDescriptor
parameter_list|(
name|IN
name|EFI_USB_IO_PROTOCOL
modifier|*
name|UsbIo
parameter_list|,
name|IN
name|UINT16
name|Value
parameter_list|,
name|IN
name|UINT16
name|Index
parameter_list|,
name|IN
name|UINT16
name|DescriptorLength
parameter_list|,
name|IN
name|VOID
modifier|*
name|Descriptor
parameter_list|,
name|OUT
name|UINT32
modifier|*
name|Status
parameter_list|)
block|{
name|EFI_USB_DEVICE_REQUEST
name|DevReq
decl_stmt|;
name|ASSERT
argument_list|(
name|UsbIo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|Descriptor
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|Status
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ZeroMem
argument_list|(
operator|&
name|DevReq
argument_list|,
sizeof|sizeof
argument_list|(
name|EFI_USB_DEVICE_REQUEST
argument_list|)
argument_list|)
expr_stmt|;
name|DevReq
operator|.
name|RequestType
operator|=
name|USB_DEV_SET_DESCRIPTOR_REQ_TYPE
expr_stmt|;
name|DevReq
operator|.
name|Request
operator|=
name|USB_REQ_SET_DESCRIPTOR
expr_stmt|;
name|DevReq
operator|.
name|Value
operator|=
name|Value
expr_stmt|;
name|DevReq
operator|.
name|Index
operator|=
name|Index
expr_stmt|;
name|DevReq
operator|.
name|Length
operator|=
name|DescriptorLength
expr_stmt|;
return|return
name|UsbIo
operator|->
name|UsbControlTransfer
argument_list|(
name|UsbIo
argument_list|,
operator|&
name|DevReq
argument_list|,
name|EfiUsbDataOut
argument_list|,
name|PcdGet32
argument_list|(
name|PcdUsbTransferTimeoutValue
argument_list|)
argument_list|,
name|Descriptor
argument_list|,
name|DescriptorLength
argument_list|,
name|Status
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**   Get the interface setting of the specified USB device.    Submit a USB get interface request for the USB device specified by UsbIo,   and Interface, and place the result in the buffer specified by AlternateSetting.   The status of the transfer is returned in Status.   If UsbIo is NULL, then ASSERT().   If AlternateSetting is NULL, then ASSERT().   If Status is NULL, then ASSERT().    @param  UsbIo             A pointer to the USB I/O Protocol instance for the specific USB target.   @param  Interface         The interface index value.   @param  AlternateSetting  A pointer to the alternate setting to be retrieved.   @param  Status            A pointer to the status of the transfer.    @retval EFI_SUCCESS       The request executed successfully.   @retval EFI_TIMEOUT       A timeout occurred executing the request.   @retval EFI_DEVICE_ERROR  The request failed due to a device error.                             The transfer status is returned in Status.  **/
end_comment

begin_function
name|EFI_STATUS
name|EFIAPI
name|UsbGetInterface
parameter_list|(
name|IN
name|EFI_USB_IO_PROTOCOL
modifier|*
name|UsbIo
parameter_list|,
name|IN
name|UINT16
name|Interface
parameter_list|,
name|OUT
name|UINT16
modifier|*
name|AlternateSetting
parameter_list|,
name|OUT
name|UINT32
modifier|*
name|Status
parameter_list|)
block|{
name|EFI_USB_DEVICE_REQUEST
name|DevReq
decl_stmt|;
name|ASSERT
argument_list|(
name|UsbIo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|AlternateSetting
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|Status
operator|!=
name|NULL
argument_list|)
expr_stmt|;
operator|*
name|AlternateSetting
operator|=
literal|0
expr_stmt|;
name|ZeroMem
argument_list|(
operator|&
name|DevReq
argument_list|,
sizeof|sizeof
argument_list|(
name|EFI_USB_DEVICE_REQUEST
argument_list|)
argument_list|)
expr_stmt|;
name|DevReq
operator|.
name|RequestType
operator|=
name|USB_DEV_GET_INTERFACE_REQ_TYPE
expr_stmt|;
name|DevReq
operator|.
name|Request
operator|=
name|USB_REQ_GET_INTERFACE
expr_stmt|;
name|DevReq
operator|.
name|Index
operator|=
name|Interface
expr_stmt|;
name|DevReq
operator|.
name|Length
operator|=
literal|1
expr_stmt|;
return|return
name|UsbIo
operator|->
name|UsbControlTransfer
argument_list|(
name|UsbIo
argument_list|,
operator|&
name|DevReq
argument_list|,
name|EfiUsbDataIn
argument_list|,
name|PcdGet32
argument_list|(
name|PcdUsbTransferTimeoutValue
argument_list|)
argument_list|,
name|AlternateSetting
argument_list|,
literal|1
argument_list|,
name|Status
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**   Set the interface setting of the specified USB device.    Submit a USB set interface request for the USB device specified by UsbIo, and   Interface, and set the alternate setting to the value specified by AlternateSetting.   The status of the transfer is returned in Status.   If UsbIo is NULL, then ASSERT().   If Status is NULL, then ASSERT().    @param  UsbIo             A pointer to the USB I/O Protocol instance for the specific USB target.   @param  Interface         The interface index value.   @param  AlternateSetting  The alternate setting to be set.   @param  Status            A pointer to the status of the transfer.    @retval EFI_SUCCESS  The request executed successfully.   @retval EFI_TIMEOUT  A timeout occurred executing the request.   @retval EFI_SUCCESS  The request failed due to a device error.                        The transfer status is returned in Status.  **/
end_comment

begin_function
name|EFI_STATUS
name|EFIAPI
name|UsbSetInterface
parameter_list|(
name|IN
name|EFI_USB_IO_PROTOCOL
modifier|*
name|UsbIo
parameter_list|,
name|IN
name|UINT16
name|Interface
parameter_list|,
name|IN
name|UINT16
name|AlternateSetting
parameter_list|,
name|OUT
name|UINT32
modifier|*
name|Status
parameter_list|)
block|{
name|EFI_USB_DEVICE_REQUEST
name|DevReq
decl_stmt|;
name|ASSERT
argument_list|(
name|UsbIo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|Status
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ZeroMem
argument_list|(
operator|&
name|DevReq
argument_list|,
sizeof|sizeof
argument_list|(
name|EFI_USB_DEVICE_REQUEST
argument_list|)
argument_list|)
expr_stmt|;
name|DevReq
operator|.
name|RequestType
operator|=
name|USB_DEV_SET_INTERFACE_REQ_TYPE
expr_stmt|;
name|DevReq
operator|.
name|Request
operator|=
name|USB_REQ_SET_INTERFACE
expr_stmt|;
name|DevReq
operator|.
name|Value
operator|=
name|AlternateSetting
expr_stmt|;
name|DevReq
operator|.
name|Index
operator|=
name|Interface
expr_stmt|;
return|return
name|UsbIo
operator|->
name|UsbControlTransfer
argument_list|(
name|UsbIo
argument_list|,
operator|&
name|DevReq
argument_list|,
name|EfiUsbNoData
argument_list|,
name|PcdGet32
argument_list|(
name|PcdUsbTransferTimeoutValue
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|Status
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**   Get the device configuration.    Submit a USB get configuration request for the USB device specified by UsbIo   and place the result in the buffer specified by ConfigurationValue. The status   of the transfer is returned in Status.   If UsbIo is NULL, then ASSERT().   If ConfigurationValue is NULL, then ASSERT().   If Status is NULL, then ASSERT().    @param  UsbIo               A pointer to the USB I/O Protocol instance for the specific USB target.   @param  ConfigurationValue  A pointer to the device configuration to be retrieved.   @param  Status              A pointer to the status of the transfer.    @retval EFI_SUCCESS        The request executed successfully.   @retval EFI_TIMEOUT        A timeout occurred executing the request.   @retval EFI_DEVICE_ERROR   The request failed due to a device error.                              The transfer status is returned in Status.  **/
end_comment

begin_function
name|EFI_STATUS
name|EFIAPI
name|UsbGetConfiguration
parameter_list|(
name|IN
name|EFI_USB_IO_PROTOCOL
modifier|*
name|UsbIo
parameter_list|,
name|OUT
name|UINT16
modifier|*
name|ConfigurationValue
parameter_list|,
name|OUT
name|UINT32
modifier|*
name|Status
parameter_list|)
block|{
name|EFI_USB_DEVICE_REQUEST
name|DevReq
decl_stmt|;
name|ASSERT
argument_list|(
name|UsbIo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|ConfigurationValue
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|Status
operator|!=
name|NULL
argument_list|)
expr_stmt|;
operator|*
name|ConfigurationValue
operator|=
literal|0
expr_stmt|;
name|ZeroMem
argument_list|(
operator|&
name|DevReq
argument_list|,
sizeof|sizeof
argument_list|(
name|EFI_USB_DEVICE_REQUEST
argument_list|)
argument_list|)
expr_stmt|;
name|DevReq
operator|.
name|RequestType
operator|=
name|USB_DEV_GET_CONFIGURATION_REQ_TYPE
expr_stmt|;
name|DevReq
operator|.
name|Request
operator|=
name|USB_REQ_GET_CONFIG
expr_stmt|;
name|DevReq
operator|.
name|Length
operator|=
literal|1
expr_stmt|;
return|return
name|UsbIo
operator|->
name|UsbControlTransfer
argument_list|(
name|UsbIo
argument_list|,
operator|&
name|DevReq
argument_list|,
name|EfiUsbDataIn
argument_list|,
name|PcdGet32
argument_list|(
name|PcdUsbTransferTimeoutValue
argument_list|)
argument_list|,
name|ConfigurationValue
argument_list|,
literal|1
argument_list|,
name|Status
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**   Set the device configuration.    Submit a USB set configuration request for the USB device specified by UsbIo   and set the device configuration to the value specified by ConfigurationValue.   The status of the transfer is returned in Status.   If UsbIo is NULL, then ASSERT().   If Status is NULL, then ASSERT().    @param  UsbIo               A pointer to the USB I/O Protocol instance for the specific USB target.   @param  ConfigurationValue  The device configuration value to be set.   @param  Status              A pointer to the status of the transfer.    @retval EFI_SUCCESS       The request executed successfully.   @retval EFI_TIMEOUT       A timeout occurred executing the request.   @retval EFI_DEVICE_ERROR  The request failed due to a device error.                             The transfer status is returned in Status.  **/
end_comment

begin_function
name|EFI_STATUS
name|EFIAPI
name|UsbSetConfiguration
parameter_list|(
name|IN
name|EFI_USB_IO_PROTOCOL
modifier|*
name|UsbIo
parameter_list|,
name|IN
name|UINT16
name|ConfigurationValue
parameter_list|,
name|OUT
name|UINT32
modifier|*
name|Status
parameter_list|)
block|{
name|EFI_USB_DEVICE_REQUEST
name|DevReq
decl_stmt|;
name|ASSERT
argument_list|(
name|UsbIo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|Status
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ZeroMem
argument_list|(
operator|&
name|DevReq
argument_list|,
sizeof|sizeof
argument_list|(
name|EFI_USB_DEVICE_REQUEST
argument_list|)
argument_list|)
expr_stmt|;
name|DevReq
operator|.
name|RequestType
operator|=
name|USB_DEV_SET_CONFIGURATION_REQ_TYPE
expr_stmt|;
name|DevReq
operator|.
name|Request
operator|=
name|USB_REQ_SET_CONFIG
expr_stmt|;
name|DevReq
operator|.
name|Value
operator|=
name|ConfigurationValue
expr_stmt|;
return|return
name|UsbIo
operator|->
name|UsbControlTransfer
argument_list|(
name|UsbIo
argument_list|,
operator|&
name|DevReq
argument_list|,
name|EfiUsbNoData
argument_list|,
name|PcdGet32
argument_list|(
name|PcdUsbTransferTimeoutValue
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|Status
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**   Set the specified feature of the specified device.    Submit a USB set device feature request for the USB device specified by UsbIo,   Recipient, and Target to the value specified by Value.  The status of the   transfer is returned in Status.   If UsbIo is NULL, then ASSERT().   If Status is NULL, then ASSERT().    @param  UsbIo      A pointer to the USB I/O Protocol instance for the specific USB target.   @param  Recipient  The USB data recipient type (i.e. Device, Interface, Endpoint).                      Type USB_TYPES_DEFINITION is defined in the MDE Package Industry                      Standard include file Usb.h.   @param  Value      The value of the feature to be set.   @param  Target     The index of the device to be set.   @param  Status     A pointer to the status of the transfer.    @retval EFI_SUCCESS       The request executed successfully.   @retval EFI_TIMEOUT       A timeout occurred executing the request.   @retval EFI_DEVICE_ERROR  The request failed due to a device error.                             The transfer status is returned in Status.  **/
end_comment

begin_function
name|EFI_STATUS
name|EFIAPI
name|UsbSetFeature
parameter_list|(
name|IN
name|EFI_USB_IO_PROTOCOL
modifier|*
name|UsbIo
parameter_list|,
name|IN
name|USB_TYPES_DEFINITION
name|Recipient
parameter_list|,
name|IN
name|UINT16
name|Value
parameter_list|,
name|IN
name|UINT16
name|Target
parameter_list|,
name|OUT
name|UINT32
modifier|*
name|Status
parameter_list|)
block|{
name|EFI_USB_DEVICE_REQUEST
name|DevReq
decl_stmt|;
name|ASSERT
argument_list|(
name|UsbIo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|Status
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ZeroMem
argument_list|(
operator|&
name|DevReq
argument_list|,
sizeof|sizeof
argument_list|(
name|EFI_USB_DEVICE_REQUEST
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|Recipient
condition|)
block|{
case|case
name|USB_TARGET_DEVICE
case|:
name|DevReq
operator|.
name|RequestType
operator|=
name|USB_DEV_SET_FEATURE_REQ_TYPE_D
expr_stmt|;
break|break;
case|case
name|USB_TARGET_INTERFACE
case|:
name|DevReq
operator|.
name|RequestType
operator|=
name|USB_DEV_SET_FEATURE_REQ_TYPE_I
expr_stmt|;
break|break;
case|case
name|USB_TARGET_ENDPOINT
case|:
name|DevReq
operator|.
name|RequestType
operator|=
name|USB_DEV_SET_FEATURE_REQ_TYPE_E
expr_stmt|;
break|break;
default|default:
break|break;
block|}
comment|//
comment|// Fill device request, see USB1.1 spec
comment|//
name|DevReq
operator|.
name|Request
operator|=
name|USB_REQ_SET_FEATURE
expr_stmt|;
name|DevReq
operator|.
name|Value
operator|=
name|Value
expr_stmt|;
name|DevReq
operator|.
name|Index
operator|=
name|Target
expr_stmt|;
return|return
name|UsbIo
operator|->
name|UsbControlTransfer
argument_list|(
name|UsbIo
argument_list|,
operator|&
name|DevReq
argument_list|,
name|EfiUsbNoData
argument_list|,
name|PcdGet32
argument_list|(
name|PcdUsbTransferTimeoutValue
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|Status
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**   Clear the specified feature of the specified device.    Submit a USB clear device feature request for the USB device specified by UsbIo,   Recipient, and Target to the value specified by Value.  The status of the transfer   is returned in Status.   If UsbIo is NULL, then ASSERT().   If Status is NULL, then ASSERT().    @param  UsbIo      A pointer to the USB I/O Protocol instance for the specific USB target.   @param  Recipient  The USB data recipient type (i.e. Device, Interface, Endpoint).                      Type USB_TYPES_DEFINITION is defined in the MDE Package Industry Standard                      include file Usb.h.   @param  Value      The value of the feature to be cleared.   @param  Target     The index of the device to be cleared.   @param  Status     A pointer to the status of the transfer.    @retval EFI_SUCCESS       The request executed successfully.   @retval EFI_TIMEOUT       A timeout occurred executing the request.   @retval EFI_DEVICE_ERROR  The request failed due to a device error.                             The transfer status is returned in Status.  **/
end_comment

begin_function
name|EFI_STATUS
name|EFIAPI
name|UsbClearFeature
parameter_list|(
name|IN
name|EFI_USB_IO_PROTOCOL
modifier|*
name|UsbIo
parameter_list|,
name|IN
name|USB_TYPES_DEFINITION
name|Recipient
parameter_list|,
name|IN
name|UINT16
name|Value
parameter_list|,
name|IN
name|UINT16
name|Target
parameter_list|,
name|OUT
name|UINT32
modifier|*
name|Status
parameter_list|)
block|{
name|EFI_USB_DEVICE_REQUEST
name|DevReq
decl_stmt|;
name|ASSERT
argument_list|(
name|UsbIo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|Status
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ZeroMem
argument_list|(
operator|&
name|DevReq
argument_list|,
sizeof|sizeof
argument_list|(
name|EFI_USB_DEVICE_REQUEST
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|Recipient
condition|)
block|{
case|case
name|USB_TARGET_DEVICE
case|:
name|DevReq
operator|.
name|RequestType
operator|=
name|USB_DEV_CLEAR_FEATURE_REQ_TYPE_D
expr_stmt|;
break|break;
case|case
name|USB_TARGET_INTERFACE
case|:
name|DevReq
operator|.
name|RequestType
operator|=
name|USB_DEV_CLEAR_FEATURE_REQ_TYPE_I
expr_stmt|;
break|break;
case|case
name|USB_TARGET_ENDPOINT
case|:
name|DevReq
operator|.
name|RequestType
operator|=
name|USB_DEV_CLEAR_FEATURE_REQ_TYPE_E
expr_stmt|;
break|break;
default|default:
break|break;
block|}
comment|//
comment|// Fill device request, see USB1.1 spec
comment|//
name|DevReq
operator|.
name|Request
operator|=
name|USB_REQ_CLEAR_FEATURE
expr_stmt|;
name|DevReq
operator|.
name|Value
operator|=
name|Value
expr_stmt|;
name|DevReq
operator|.
name|Index
operator|=
name|Target
expr_stmt|;
return|return
name|UsbIo
operator|->
name|UsbControlTransfer
argument_list|(
name|UsbIo
argument_list|,
operator|&
name|DevReq
argument_list|,
name|EfiUsbNoData
argument_list|,
name|PcdGet32
argument_list|(
name|PcdUsbTransferTimeoutValue
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|Status
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**   Get the status of the specified device.    Submit a USB device get status request for the USB device specified by UsbIo,   Recipient, and Target and place the result in the buffer specified by DeviceStatus.   The status of the transfer is returned in Status.   If UsbIo is NULL, then ASSERT().   If DeviceStatus is NULL, then ASSERT().   If Status is NULL, then ASSERT().    @param  UsbIo         A pointer to the USB I/O Protocol instance for the specific USB target.   @param  Recipient     The USB data recipient type (i.e. Device, Interface, Endpoint).                         Type USB_TYPES_DEFINITION is defined in the MDE Package Industry Standard                         include file Usb.h.   @param  Target        The index of the device to be get the status of.   @param  DeviceStatus  A pointer to the device status to be retrieved.   @param  Status        A pointer to the status of the transfer.    @retval EFI_SUCCESS       The request executed successfully.   @retval EFI_TIMEOUT       A timeout occurred executing the request.   @retval EFI_DEVICE_ERROR  The request failed due to a device error.                             The transfer status is returned in Status.  **/
end_comment

begin_function
name|EFI_STATUS
name|EFIAPI
name|UsbGetStatus
parameter_list|(
name|IN
name|EFI_USB_IO_PROTOCOL
modifier|*
name|UsbIo
parameter_list|,
name|IN
name|USB_TYPES_DEFINITION
name|Recipient
parameter_list|,
name|IN
name|UINT16
name|Target
parameter_list|,
name|OUT
name|UINT16
modifier|*
name|DeviceStatus
parameter_list|,
name|OUT
name|UINT32
modifier|*
name|Status
parameter_list|)
block|{
name|EFI_USB_DEVICE_REQUEST
name|DevReq
decl_stmt|;
name|ASSERT
argument_list|(
name|UsbIo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|DeviceStatus
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|Status
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ZeroMem
argument_list|(
operator|&
name|DevReq
argument_list|,
sizeof|sizeof
argument_list|(
name|EFI_USB_DEVICE_REQUEST
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|Recipient
condition|)
block|{
case|case
name|USB_TARGET_DEVICE
case|:
name|DevReq
operator|.
name|RequestType
operator|=
name|USB_DEV_GET_STATUS_REQ_TYPE_D
expr_stmt|;
break|break;
case|case
name|USB_TARGET_INTERFACE
case|:
name|DevReq
operator|.
name|RequestType
operator|=
name|USB_DEV_GET_STATUS_REQ_TYPE_I
expr_stmt|;
break|break;
case|case
name|USB_TARGET_ENDPOINT
case|:
name|DevReq
operator|.
name|RequestType
operator|=
name|USB_DEV_GET_STATUS_REQ_TYPE_E
expr_stmt|;
break|break;
default|default:
break|break;
block|}
comment|//
comment|// Fill device request, see USB1.1 spec
comment|//
name|DevReq
operator|.
name|Request
operator|=
name|USB_REQ_GET_STATUS
expr_stmt|;
name|DevReq
operator|.
name|Value
operator|=
literal|0
expr_stmt|;
name|DevReq
operator|.
name|Index
operator|=
name|Target
expr_stmt|;
name|DevReq
operator|.
name|Length
operator|=
literal|2
expr_stmt|;
return|return
name|UsbIo
operator|->
name|UsbControlTransfer
argument_list|(
name|UsbIo
argument_list|,
operator|&
name|DevReq
argument_list|,
name|EfiUsbDataIn
argument_list|,
name|PcdGet32
argument_list|(
name|PcdUsbTransferTimeoutValue
argument_list|)
argument_list|,
name|DeviceStatus
argument_list|,
literal|2
argument_list|,
name|Status
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**   Clear halt feature of the specified usb endpoint.    Retrieve the USB endpoint descriptor specified by UsbIo and EndPoint.   If the USB endpoint descriptor can not be retrieved, then return EFI_NOT_FOUND.   If the endpoint descriptor is found, then clear the halt feature of this USB endpoint.   The status of the transfer is returned in Status.   If UsbIo is NULL, then ASSERT().   If Status is NULL, then ASSERT().    @param  UsbIo     A pointer to the USB I/O Protocol instance for the specific USB target.   @param  Endpoint  The endpoint address.   @param  Status    A pointer to the status of the transfer.    @retval EFI_SUCCESS       The request executed successfully.   @retval EFI_TIMEOUT       A timeout occurred executing the request.   @retval EFI_DEVICE_ERROR  The request failed due to a device error.                             The transfer status is returned in Status.   @retval EFI_NOT_FOUND     The specified USB endpoint descriptor can not be found  **/
end_comment

begin_function
name|EFI_STATUS
name|EFIAPI
name|UsbClearEndpointHalt
parameter_list|(
name|IN
name|EFI_USB_IO_PROTOCOL
modifier|*
name|UsbIo
parameter_list|,
name|IN
name|UINT8
name|Endpoint
parameter_list|,
name|OUT
name|UINT32
modifier|*
name|Status
parameter_list|)
block|{
name|EFI_STATUS
name|Result
decl_stmt|;
name|EFI_USB_ENDPOINT_DESCRIPTOR
name|EndpointDescriptor
decl_stmt|;
name|EFI_USB_INTERFACE_DESCRIPTOR
name|InterfaceDescriptor
decl_stmt|;
name|UINT8
name|Index
decl_stmt|;
name|ASSERT
argument_list|(
name|UsbIo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|Status
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ZeroMem
argument_list|(
operator|&
name|EndpointDescriptor
argument_list|,
sizeof|sizeof
argument_list|(
name|EFI_USB_ENDPOINT_DESCRIPTOR
argument_list|)
argument_list|)
expr_stmt|;
comment|//
comment|// First search the endpoint descriptor for that endpoint addr
comment|//
name|Result
operator|=
name|UsbIo
operator|->
name|UsbGetInterfaceDescriptor
argument_list|(
name|UsbIo
argument_list|,
operator|&
name|InterfaceDescriptor
argument_list|)
expr_stmt|;
if|if
condition|(
name|EFI_ERROR
argument_list|(
name|Result
argument_list|)
condition|)
block|{
return|return
name|Result
return|;
block|}
for|for
control|(
name|Index
operator|=
literal|0
init|;
name|Index
operator|<
name|InterfaceDescriptor
operator|.
name|NumEndpoints
condition|;
name|Index
operator|++
control|)
block|{
name|Result
operator|=
name|UsbIo
operator|->
name|UsbGetEndpointDescriptor
argument_list|(
name|UsbIo
argument_list|,
name|Index
argument_list|,
operator|&
name|EndpointDescriptor
argument_list|)
expr_stmt|;
if|if
condition|(
name|EFI_ERROR
argument_list|(
name|Result
argument_list|)
condition|)
block|{
continue|continue;
block|}
if|if
condition|(
name|EndpointDescriptor
operator|.
name|EndpointAddress
operator|==
name|Endpoint
condition|)
block|{
break|break;
block|}
block|}
if|if
condition|(
name|Index
operator|==
name|InterfaceDescriptor
operator|.
name|NumEndpoints
condition|)
block|{
comment|//
comment|// No such endpoint
comment|//
return|return
name|EFI_NOT_FOUND
return|;
block|}
name|Result
operator|=
name|UsbClearFeature
argument_list|(
name|UsbIo
argument_list|,
name|USB_TARGET_ENDPOINT
argument_list|,
name|USB_FEATURE_ENDPOINT_HALT
argument_list|,
name|EndpointDescriptor
operator|.
name|EndpointAddress
argument_list|,
name|Status
argument_list|)
expr_stmt|;
return|return
name|Result
return|;
block|}
end_function

end_unit


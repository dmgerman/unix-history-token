begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/** @file   PAL Call Services Function.    Copyright (c) 2006 - 2010, Intel Corporation. All rights reserved.<BR>   This program and the accompanying materials                             are licensed and made available under the terms and conditions of the BSD License            which accompanies this distribution.  The full text of the license may be found at           http://opensource.org/licenses/bsd-license.php.                                                THE PROGRAM IS DISTRIBUTED UNDER THE BSD LICENSE ON AN "AS IS" BASIS,                        WITHOUT WARRANTIES OR REPRESENTATIONS OF ANY KIND, EITHER EXPRESS OR IMPLIED.       **/
end_comment

begin_include
include|#
directive|include
file|<PiPei.h>
end_include

begin_include
include|#
directive|include
file|<Ppi/SecPlatformInformation.h>
end_include

begin_include
include|#
directive|include
file|<Library/PalLib.h>
end_include

begin_include
include|#
directive|include
file|<Library/PeiServicesTablePointerLib.h>
end_include

begin_include
include|#
directive|include
file|<Library/PeiServicesLib.h>
end_include

begin_include
include|#
directive|include
file|<Library/BaseLib.h>
end_include

begin_include
include|#
directive|include
file|<Library/DebugLib.h>
end_include

begin_comment
comment|/**   Makes a PAL procedure call.    This is a wrapper function to make a PAL procedure call.  Based on the Index value,   this API will make static or stacked PAL call. Architected procedures may be designated   as required or optional.  If a PAL procedure is specified as optional, a unique return   code of 0xFFFFFFFFFFFFFFFF is returned in the Status field of the PAL_CALL_RETURN structure.   This indicates that the procedure is not present in this PAL implementation.  It is the   caller's responsibility to check for this return code after calling any optional PAL   procedure. No parameter checking is performed on the 4 input parameters, but there are   some common rules that the caller should follow when making a PAL call.  Any address   passed to PAL as buffers for return parameters must be 8-byte aligned.  Unaligned addresses   may cause undefined results.  For those parameters defined as reserved or some fields   defined as reserved must be zero filled or the invalid argument return value may be   returned or undefined result may occur during the execution of the procedure.   This function is only available on IPF.    @param Index  The PAL procedure Index number.   @param Arg2   The 2nd parameter for PAL procedure calls.   @param Arg3   The 3rd parameter for PAL procedure calls.   @param Arg4   The 4th parameter for PAL procedure calls.    @return Structure returned from the PAL Call procedure, including the status and return value.  **/
end_comment

begin_function
name|PAL_CALL_RETURN
name|EFIAPI
name|PalCall
parameter_list|(
name|IN
name|UINT64
name|Index
parameter_list|,
name|IN
name|UINT64
name|Arg2
parameter_list|,
name|IN
name|UINT64
name|Arg3
parameter_list|,
name|IN
name|UINT64
name|Arg4
parameter_list|)
block|{
name|UINT64
name|PalCallAddress
decl_stmt|;
name|PAL_CALL_RETURN
name|ReturnVal
decl_stmt|;
name|CONST
name|EFI_PEI_SERVICES
modifier|*
modifier|*
name|PeiServices
decl_stmt|;
name|EFI_STATUS
name|Status
decl_stmt|;
name|EFI_SEC_PLATFORM_INFORMATION_PPI
modifier|*
name|SecPlatformPpi
decl_stmt|;
name|EFI_SEC_PLATFORM_INFORMATION_RECORD
name|SecPlatformInfoRecord
decl_stmt|;
name|UINT64
name|RecordSize
decl_stmt|;
comment|//
comment|// Get PEI Service Table Pointer
comment|//
name|PeiServices
operator|=
name|GetPeiServicesTablePointer
argument_list|()
expr_stmt|;
comment|//
comment|// Locate SEC Platform Information PPI
comment|//
name|Status
operator|=
name|PeiServicesLocatePpi
argument_list|(
operator|&
name|gEfiSecPlatformInformationPpiGuid
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
operator|(
name|VOID
operator|*
operator|*
operator|)
operator|&
name|SecPlatformPpi
argument_list|)
expr_stmt|;
name|ASSERT_EFI_ERROR
argument_list|(
name|Status
argument_list|)
expr_stmt|;
comment|//
comment|// Retrieve PAL call address from platform information reported by the PPI
comment|//
name|RecordSize
operator|=
sizeof|sizeof
argument_list|(
name|SecPlatformInfoRecord
argument_list|)
expr_stmt|;
name|SecPlatformPpi
operator|->
name|PlatformInformation
argument_list|(
name|PeiServices
argument_list|,
operator|&
name|RecordSize
argument_list|,
operator|&
name|SecPlatformInfoRecord
argument_list|)
expr_stmt|;
name|PalCallAddress
operator|=
name|SecPlatformInfoRecord
operator|.
name|ItaniumHealthFlags
operator|.
name|PalCallAddress
expr_stmt|;
name|ReturnVal
operator|=
name|AsmPalCall
argument_list|(
name|PalCallAddress
argument_list|,
name|Index
argument_list|,
name|Arg2
argument_list|,
name|Arg3
argument_list|,
name|Arg4
argument_list|)
expr_stmt|;
return|return
name|ReturnVal
return|;
block|}
end_function

end_unit


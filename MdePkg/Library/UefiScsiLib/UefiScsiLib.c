begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/** @file   UEFI SCSI Library implementation    Copyright (c) 2006 - 2015, Intel Corporation. All rights reserved.<BR>   This program and the accompanying materials                             are licensed and made available under the terms and conditions of the BSD License            which accompanies this distribution.  The full text of the license may be found at           http://opensource.org/licenses/bsd-license.php.                                                THE PROGRAM IS DISTRIBUTED UNDER THE BSD LICENSE ON AN "AS IS" BASIS,                        WITHOUT WARRANTIES OR REPRESENTATIONS OF ANY KIND, EITHER EXPRESS OR IMPLIED.               **/
end_comment

begin_include
include|#
directive|include
file|<Uefi.h>
end_include

begin_include
include|#
directive|include
file|<Library/BaseLib.h>
end_include

begin_include
include|#
directive|include
file|<Library/DebugLib.h>
end_include

begin_include
include|#
directive|include
file|<Library/UefiScsiLib.h>
end_include

begin_include
include|#
directive|include
file|<Library/BaseMemoryLib.h>
end_include

begin_include
include|#
directive|include
file|<Library/MemoryAllocationLib.h>
end_include

begin_include
include|#
directive|include
file|<Library/UefiBootServicesTableLib.h>
end_include

begin_include
include|#
directive|include
file|<IndustryStandard/Scsi.h>
end_include

begin_comment
comment|//
end_comment

begin_comment
comment|// Scsi Command Length
end_comment

begin_comment
comment|//
end_comment

begin_define
define|#
directive|define
name|EFI_SCSI_OP_LENGTH_SIX
value|0x6
end_define

begin_define
define|#
directive|define
name|EFI_SCSI_OP_LENGTH_TEN
value|0xa
end_define

begin_define
define|#
directive|define
name|EFI_SCSI_OP_LENGTH_SIXTEEN
value|0x10
end_define

begin_comment
comment|//
end_comment

begin_comment
comment|// The context structure used when non-blocking SCSI read/write operation
end_comment

begin_comment
comment|// completes.
end_comment

begin_comment
comment|//
end_comment

begin_typedef
typedef|typedef
struct|struct
block|{
comment|///
comment|/// The SCSI request packet to send to the SCSI controller specified by
comment|/// the device handle.
comment|///
name|EFI_SCSI_IO_SCSI_REQUEST_PACKET
name|CommandPacket
decl_stmt|;
comment|///
comment|/// The length of the output sense data.
comment|///
name|UINT8
modifier|*
name|SenseDataLength
decl_stmt|;
comment|///
comment|/// The status of the SCSI host adapter.
comment|///
name|UINT8
modifier|*
name|HostAdapterStatus
decl_stmt|;
comment|///
comment|/// The status of the target SCSI device.
comment|///
name|UINT8
modifier|*
name|TargetStatus
decl_stmt|;
comment|///
comment|/// The length of the data buffer for the SCSI read/write command.
comment|///
name|UINT32
modifier|*
name|DataLength
decl_stmt|;
comment|///
comment|/// The caller event to be signaled when the SCSI read/write command
comment|/// completes.
comment|///
name|EFI_EVENT
name|CallerEvent
decl_stmt|;
block|}
name|EFI_SCSI_LIB_ASYNC_CONTEXT
typedef|;
end_typedef

begin_comment
comment|/**   Execute Test Unit Ready SCSI command on a specific SCSI target.    Executes the Test Unit Ready command on the SCSI target specified by ScsiIo.   If Timeout is zero, then this function waits indefinitely for the command to complete.   If Timeout is greater than zero, then the command is executed and will timeout after Timeout 100 ns units.   If ScsiIo is NULL, then ASSERT().   If SenseDataLength is NULL, then ASSERT().   If HostAdapterStatus is NULL, then ASSERT().   If TargetStatus is NULL, then ASSERT().    If SenseDataLength is non-zero and SenseData is not NULL, SenseData must meet buffer   alignment requirement defined in EFI_SCSI_IO_PROTOCOL. Otherwise EFI_INVALID_PARAMETER   gets returned.    @param[in]     ScsiIo             A pointer to the SCSI I/O Protocol instance                                     for the specific SCSI target.   @param[in]     Timeout            The timeout in 100 ns units to use for the execution                                     of this SCSI Request Packet. A Timeout value of                                     zero means that this function will wait indefinitely                                     for the SCSI Request Packet to execute. If Timeout                                     is greater than zero, then this function will return                                     EFI_TIMEOUT if the time required to execute the SCSI                                     Request Packet is greater than Timeout.   @param[in, out] SenseData         A pointer to sense data that was generated by                                     the execution of the SCSI Request Packet. This                                     buffer must be allocated by the caller.                                     If SenseDataLength is 0, then this parameter is                                     optional and may be NULL.   @param[in, out] SenseDataLength   On input, a pointer to the length in bytes of                                     the SenseData buffer. On output, a pointer to                                     the number of bytes written to the SenseData buffer.    @param[out]     HostAdapterStatus The status of the SCSI Host Controller that produces                                     the SCSI bus containing the SCSI target specified by                                     ScsiIo when the SCSI Request Packet was executed.                                     See the EFI SCSI I/O Protocol in the UEFI Specification                                     for details on the possible return values.   @param[out]     TargetStatus      The status returned by the SCSI target specified                                     by ScsiIo when the SCSI Request Packet was executed                                     on the SCSI Host Controller. See the EFI SCSI I/O                                     Protocol in the UEFI Specification for details on                                     the possible return values.     @retval EFI_SUCCESS               The command was executed successfully.                                     See HostAdapterStatus, TargetStatus, SenseDataLength,                                     and SenseData in that order for additional status                                     information.   @retval EFI_NOT_READY             The SCSI Request Packet could not be sent because                                     there are too many SCSI Command Packets already                                     queued. The SCSI Request Packet was not sent, so                                     no additional status information is available.                                     The caller may retry again later.   @retval EFI_DEVICE_ERROR          A device error occurred while attempting to send                                     SCSI Request Packet.  See HostAdapterStatus,                                     TargetStatus, SenseDataLength, and SenseData in that                                     order for additional status information.   @retval EFI_UNSUPPORTED           The command described by the SCSI Request Packet                                     is not supported by the SCSI initiator(i.e., SCSI                                     Host Controller). The SCSI Request Packet was not                                     sent, so no additional status information is available.   @retval EFI_TIMEOUT               A timeout occurred while waiting for the SCSI Request                                     Packet to execute.  See HostAdapterStatus, TargetStatus,                                     SenseDataLength, and SenseData in that order for                                     additional status information.   @retval EFI_INVALID_PARAMETER     The contents of the SCSI Request Packet are invalid.  **/
end_comment

begin_function
name|EFI_STATUS
name|EFIAPI
name|ScsiTestUnitReadyCommand
parameter_list|(
name|IN
name|EFI_SCSI_IO_PROTOCOL
modifier|*
name|ScsiIo
parameter_list|,
name|IN
name|UINT64
name|Timeout
parameter_list|,
name|IN
name|OUT
name|VOID
modifier|*
name|SenseData
parameter_list|,
name|OPTIONAL
name|IN
name|OUT
name|UINT8
modifier|*
name|SenseDataLength
parameter_list|,
name|OUT
name|UINT8
modifier|*
name|HostAdapterStatus
parameter_list|,
name|OUT
name|UINT8
modifier|*
name|TargetStatus
parameter_list|)
block|{
name|EFI_SCSI_IO_SCSI_REQUEST_PACKET
name|CommandPacket
decl_stmt|;
name|EFI_STATUS
name|Status
decl_stmt|;
name|UINT8
name|Cdb
index|[
name|EFI_SCSI_OP_LENGTH_SIX
index|]
decl_stmt|;
name|ASSERT
argument_list|(
name|SenseDataLength
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|HostAdapterStatus
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|TargetStatus
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|ScsiIo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ZeroMem
argument_list|(
operator|&
name|CommandPacket
argument_list|,
sizeof|sizeof
argument_list|(
name|EFI_SCSI_IO_SCSI_REQUEST_PACKET
argument_list|)
argument_list|)
expr_stmt|;
name|ZeroMem
argument_list|(
name|Cdb
argument_list|,
name|EFI_SCSI_OP_LENGTH_SIX
argument_list|)
expr_stmt|;
name|CommandPacket
operator|.
name|Timeout
operator|=
name|Timeout
expr_stmt|;
name|CommandPacket
operator|.
name|InDataBuffer
operator|=
name|NULL
expr_stmt|;
name|CommandPacket
operator|.
name|InTransferLength
operator|=
literal|0
expr_stmt|;
name|CommandPacket
operator|.
name|OutDataBuffer
operator|=
name|NULL
expr_stmt|;
name|CommandPacket
operator|.
name|OutTransferLength
operator|=
literal|0
expr_stmt|;
name|CommandPacket
operator|.
name|SenseData
operator|=
name|SenseData
expr_stmt|;
name|CommandPacket
operator|.
name|Cdb
operator|=
name|Cdb
expr_stmt|;
comment|//
comment|// Fill Cdb for Test Unit Ready Command
comment|//
name|Cdb
index|[
literal|0
index|]
operator|=
name|EFI_SCSI_OP_TEST_UNIT_READY
expr_stmt|;
name|CommandPacket
operator|.
name|CdbLength
operator|=
operator|(
name|UINT8
operator|)
name|EFI_SCSI_OP_LENGTH_SIX
expr_stmt|;
name|CommandPacket
operator|.
name|SenseDataLength
operator|=
operator|*
name|SenseDataLength
expr_stmt|;
name|Status
operator|=
name|ScsiIo
operator|->
name|ExecuteScsiCommand
argument_list|(
name|ScsiIo
argument_list|,
operator|&
name|CommandPacket
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
operator|*
name|HostAdapterStatus
operator|=
name|CommandPacket
operator|.
name|HostAdapterStatus
expr_stmt|;
operator|*
name|TargetStatus
operator|=
name|CommandPacket
operator|.
name|TargetStatus
expr_stmt|;
operator|*
name|SenseDataLength
operator|=
name|CommandPacket
operator|.
name|SenseDataLength
expr_stmt|;
return|return
name|Status
return|;
block|}
end_function

begin_comment
comment|/**   Execute Inquiry SCSI command on a specific SCSI target.    Executes the Inquiry command on the SCSI target specified by ScsiIo.   If Timeout is zero, then this function waits indefinitely for the command to complete.   If Timeout is greater than zero, then the command is executed and will timeout after Timeout 100 ns units.   If ScsiIo is NULL, then ASSERT().   If SenseDataLength is NULL, then ASSERT().   If HostAdapterStatus is NULL, then ASSERT().   If TargetStatus is NULL, then ASSERT().   If InquiryDataLength is NULL, then ASSERT().    If SenseDataLength is non-zero and SenseData is not NULL, SenseData must meet buffer   alignment requirement defined in EFI_SCSI_IO_PROTOCOL. Otherwise EFI_INVALID_PARAMETER   gets returned.    If InquiryDataLength is non-zero and InquiryDataBuffer is not NULL, InquiryDataBuffer   must meet buffer alignment requirement defined in EFI_SCSI_IO_PROTOCOL. Otherwise   EFI_INVALID_PARAMETER gets returned.    @param[in]      ScsiIo                 A pointer to the SCSI I/O Protocol instance                                          for the specific SCSI target.   @param[in]      Timeout                The timeout in 100 ns units to use for the                                          execution of this SCSI Request Packet. A Timeout                                          value of zero means that this function will wait                                          indefinitely for the SCSI Request Packet to execute.                                          If Timeout is greater than zero, then this function                                          will return EFI_TIMEOUT if the time required to                                          execute the SCSI Request Packet is greater than Timeout.   @param[in, out] SenseData              A pointer to sense data that was generated                                          by the execution of the SCSI Request Packet.                                          This buffer must be allocated by the caller.                                          If SenseDataLength is 0, then this parameter                                          is optional and may be NULL.   @param[in, out] SenseDataLength        On input, the length in bytes of the SenseData buffer.                                          On output, the number of bytes written to the SenseData buffer.    @param[out]     HostAdapterStatus      The status of the SCSI Host Controller that                                          produces the SCSI bus containing the SCSI                                          target specified by ScsiIo when the SCSI                                          Request Packet was executed.  See the EFI                                          SCSI I/O Protocol in the UEFI Specification                                          for details on the possible return values.   @param[out]     TargetStatus           The status returned by the SCSI target specified                                          by ScsiIo when the SCSI Request Packet was                                          executed on the SCSI Host Controller.                                          See the EFI SCSI I/O Protocol in the UEFI                                          Specification for details on the possible                                          return values.    @param[in, out] InquiryDataBuffer      A pointer to inquiry data that was generated                                          by the execution of the SCSI Request Packet.                                          This buffer must be allocated by the caller.                                          If InquiryDataLength is 0, then this parameter                                          is optional and may be NULL.    @param[in, out] InquiryDataLength      On input, a pointer to the length in bytes                                          of the InquiryDataBuffer buffer.                                          On output, a pointer to the number of bytes                                          written to the InquiryDataBuffer buffer.   @param[in]      EnableVitalProductData If TRUE, then the supported vital product                                          data for the PageCode is returned in InquiryDataBuffer.                                          If FALSE, then the standard inquiry data is                                          returned in InquiryDataBuffer and PageCode is ignored.   @param[in]      PageCode               The page code of the vital product data.                                          It's ignored if EnableVitalProductData is FALSE.    @retval EFI_SUCCESS                    The command executed successfully. See HostAdapterStatus,                                          TargetStatus, SenseDataLength, and SenseData in that order                                          for additional status information.   @retval EFI_BAD_BUFFER_SIZE            The SCSI Request Packet was executed, but the entire                                          InquiryDataBuffer could not be transferred. The actual                                          number of bytes transferred is returned in InquiryDataLength.   @retval EFI_NOT_READY                  The SCSI Request Packet could not be sent because there                                          are too many SCSI Command Packets already queued.                                          The SCSI Request Packet was not sent, so no additional                                          status information is available. The caller may retry again later.   @retval EFI_DEVICE_ERROR               A device error occurred while attempting to send SCSI                                          Request Packet.  See HostAdapterStatus, TargetStatus,                                          SenseDataLength, and SenseData in that order for additional                                          status information.   @retval EFI_UNSUPPORTED                The command described by the SCSI Request Packet is not                                          supported by the SCSI initiator(i.e., SCSI  Host Controller).                                          The SCSI Request Packet was not sent, so no additional                                          status information is available.   @retval EFI_TIMEOUT                    A timeout occurred while waiting for the SCSI Request                                          Packet to execute.  See HostAdapterStatus, TargetStatus,                                          SenseDataLength, and SenseData in that order for                                          additional status information.   @retval EFI_INVALID_PARAMETER          The contents of the SCSI Request Packet are invalid.  **/
end_comment

begin_function
name|EFI_STATUS
name|EFIAPI
name|ScsiInquiryCommandEx
parameter_list|(
name|IN
name|EFI_SCSI_IO_PROTOCOL
modifier|*
name|ScsiIo
parameter_list|,
name|IN
name|UINT64
name|Timeout
parameter_list|,
name|IN
name|OUT
name|VOID
modifier|*
name|SenseData
parameter_list|,
name|OPTIONAL
name|IN
name|OUT
name|UINT8
modifier|*
name|SenseDataLength
parameter_list|,
name|OUT
name|UINT8
modifier|*
name|HostAdapterStatus
parameter_list|,
name|OUT
name|UINT8
modifier|*
name|TargetStatus
parameter_list|,
name|IN
name|OUT
name|VOID
modifier|*
name|InquiryDataBuffer
parameter_list|,
name|OPTIONAL
name|IN
name|OUT
name|UINT32
modifier|*
name|InquiryDataLength
parameter_list|,
name|IN
name|BOOLEAN
name|EnableVitalProductData
parameter_list|,
name|IN
name|UINT8
name|PageCode
parameter_list|)
block|{
name|EFI_SCSI_IO_SCSI_REQUEST_PACKET
name|CommandPacket
decl_stmt|;
name|EFI_STATUS
name|Status
decl_stmt|;
name|UINT8
name|Cdb
index|[
name|EFI_SCSI_OP_LENGTH_SIX
index|]
decl_stmt|;
name|ASSERT
argument_list|(
name|SenseDataLength
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|HostAdapterStatus
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|TargetStatus
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|InquiryDataLength
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|ScsiIo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ZeroMem
argument_list|(
operator|&
name|CommandPacket
argument_list|,
sizeof|sizeof
argument_list|(
name|EFI_SCSI_IO_SCSI_REQUEST_PACKET
argument_list|)
argument_list|)
expr_stmt|;
name|ZeroMem
argument_list|(
name|Cdb
argument_list|,
name|EFI_SCSI_OP_LENGTH_SIX
argument_list|)
expr_stmt|;
name|CommandPacket
operator|.
name|Timeout
operator|=
name|Timeout
expr_stmt|;
name|CommandPacket
operator|.
name|InDataBuffer
operator|=
name|InquiryDataBuffer
expr_stmt|;
name|CommandPacket
operator|.
name|InTransferLength
operator|=
operator|*
name|InquiryDataLength
expr_stmt|;
name|CommandPacket
operator|.
name|SenseData
operator|=
name|SenseData
expr_stmt|;
name|CommandPacket
operator|.
name|SenseDataLength
operator|=
operator|*
name|SenseDataLength
expr_stmt|;
name|CommandPacket
operator|.
name|Cdb
operator|=
name|Cdb
expr_stmt|;
name|Cdb
index|[
literal|0
index|]
operator|=
name|EFI_SCSI_OP_INQUIRY
expr_stmt|;
if|if
condition|(
name|EnableVitalProductData
condition|)
block|{
name|Cdb
index|[
literal|1
index|]
operator||=
literal|0x01
expr_stmt|;
name|Cdb
index|[
literal|2
index|]
operator|=
name|PageCode
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|InquiryDataLength
operator|>
literal|0xff
condition|)
block|{
operator|*
name|InquiryDataLength
operator|=
literal|0xff
expr_stmt|;
block|}
name|Cdb
index|[
literal|4
index|]
operator|=
call|(
name|UINT8
call|)
argument_list|(
operator|*
name|InquiryDataLength
argument_list|)
expr_stmt|;
name|CommandPacket
operator|.
name|CdbLength
operator|=
operator|(
name|UINT8
operator|)
name|EFI_SCSI_OP_LENGTH_SIX
expr_stmt|;
name|CommandPacket
operator|.
name|DataDirection
operator|=
name|EFI_SCSI_DATA_IN
expr_stmt|;
name|Status
operator|=
name|ScsiIo
operator|->
name|ExecuteScsiCommand
argument_list|(
name|ScsiIo
argument_list|,
operator|&
name|CommandPacket
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
operator|*
name|HostAdapterStatus
operator|=
name|CommandPacket
operator|.
name|HostAdapterStatus
expr_stmt|;
operator|*
name|TargetStatus
operator|=
name|CommandPacket
operator|.
name|TargetStatus
expr_stmt|;
operator|*
name|SenseDataLength
operator|=
name|CommandPacket
operator|.
name|SenseDataLength
expr_stmt|;
operator|*
name|InquiryDataLength
operator|=
name|CommandPacket
operator|.
name|InTransferLength
expr_stmt|;
return|return
name|Status
return|;
block|}
end_function

begin_comment
comment|/**   Execute Inquiry SCSI command on a specific SCSI target.    Executes the Inquiry command on the SCSI target specified by ScsiIo.   If Timeout is zero, then this function waits indefinitely for the command to complete.   If Timeout is greater than zero, then the command is executed and will timeout after Timeout 100 ns units.   If ScsiIo is NULL, then ASSERT().   If SenseDataLength is NULL, then ASSERT().   If HostAdapterStatus is NULL, then ASSERT().   If TargetStatus is NULL, then ASSERT().   If InquiryDataLength is NULL, then ASSERT().    If SenseDataLength is non-zero and SenseData is not NULL, SenseData must meet buffer   alignment requirement defined in EFI_SCSI_IO_PROTOCOL. Otherwise EFI_INVALID_PARAMETER   gets returned.    If InquiryDataLength is non-zero and InquiryDataBuffer is not NULL, InquiryDataBuffer   must meet buffer alignment requirement defined in EFI_SCSI_IO_PROTOCOL. Otherwise   EFI_INVALID_PARAMETER gets returned.    @param[in]      ScsiIo                 A pointer to the SCSI I/O Protocol instance                                          for the specific SCSI target.   @param[in]      Timeout                The timeout in 100 ns units to use for the                                          execution of this SCSI Request Packet. A Timeout                                          value of zero means that this function will wait                                          indefinitely for the SCSI Request Packet to execute.                                          If Timeout is greater than zero, then this function                                          will return EFI_TIMEOUT if the time required to                                          execute the SCSI Request Packet is greater than Timeout.   @param[in, out] SenseData              A pointer to sense data that was generated                                          by the execution of the SCSI Request Packet.                                          This buffer must be allocated by the caller.                                          If SenseDataLength is 0, then this parameter                                          is optional and may be NULL.   @param[in, out] SenseDataLength        On input, the length in bytes of the SenseData buffer.                                          On output, the number of bytes written to the SenseData buffer.    @param[out]     HostAdapterStatus      The status of the SCSI Host Controller that                                          produces the SCSI bus containing the SCSI                                          target specified by ScsiIo when the SCSI                                          Request Packet was executed.  See the EFI                                          SCSI I/O Protocol in the UEFI Specification                                          for details on the possible return values.   @param[out]     TargetStatus           The status returned by the SCSI target specified                                          by ScsiIo when the SCSI Request Packet was                                          executed on the SCSI Host Controller.                                          See the EFI SCSI I/O Protocol in the UEFI                                          Specification for details on the possible                                          return values.    @param[in, out] InquiryDataBuffer      A pointer to inquiry data that was generated                                          by the execution of the SCSI Request Packet.                                          This buffer must be allocated by the caller.                                          If InquiryDataLength is 0, then this parameter                                          is optional and may be NULL.    @param[in, out] InquiryDataLength      On input, a pointer to the length in bytes                                          of the InquiryDataBuffer buffer.                                          On output, a pointer to the number of bytes                                          written to the InquiryDataBuffer buffer.   @param[in]      EnableVitalProductData If TRUE, then the supported vital product                                          data is returned in InquiryDataBuffer.                                          If FALSE, then the standard inquiry data is                                          returned in InquiryDataBuffer.     @retval EFI_SUCCESS                    The command was executed successfully. See HostAdapterStatus,                                          TargetStatus, SenseDataLength, and SenseData in that order                                          for additional status information.   @retval EFI_BAD_BUFFER_SIZE            The SCSI Request Packet was executed, but the entire                                          InquiryDataBuffer could not be transferred. The actual                                          number of bytes transferred is returned in InquiryDataLength.   @retval EFI_NOT_READY                  The SCSI Request Packet could not be sent because there                                          are too many SCSI Command Packets already queued.                                          The SCSI Request Packet was not sent, so no additional                                          status information is available. The caller may retry again later.   @retval EFI_DEVICE_ERROR               A device error occurred while attempting to send SCSI                                          Request Packet.  See HostAdapterStatus, TargetStatus,                                          SenseDataLength, and SenseData in that order for additional                                          status information.   @retval EFI_UNSUPPORTED                The command described by the SCSI Request Packet is not                                          supported by the SCSI initiator(i.e., SCSI  Host Controller).                                          The SCSI Request Packet was not sent, so no additional                                          status information is available.   @retval EFI_TIMEOUT                    A timeout occurred while waiting for the SCSI Request                                          Packet to execute.  See HostAdapterStatus, TargetStatus,                                          SenseDataLength, and SenseData in that order for                                          additional status information.   @retval EFI_INVALID_PARAMETER          The contents of the SCSI Request Packet are invalid.  **/
end_comment

begin_function
name|EFI_STATUS
name|EFIAPI
name|ScsiInquiryCommand
parameter_list|(
name|IN
name|EFI_SCSI_IO_PROTOCOL
modifier|*
name|ScsiIo
parameter_list|,
name|IN
name|UINT64
name|Timeout
parameter_list|,
name|IN
name|OUT
name|VOID
modifier|*
name|SenseData
parameter_list|,
name|OPTIONAL
name|IN
name|OUT
name|UINT8
modifier|*
name|SenseDataLength
parameter_list|,
name|OUT
name|UINT8
modifier|*
name|HostAdapterStatus
parameter_list|,
name|OUT
name|UINT8
modifier|*
name|TargetStatus
parameter_list|,
name|IN
name|OUT
name|VOID
modifier|*
name|InquiryDataBuffer
parameter_list|,
name|OPTIONAL
name|IN
name|OUT
name|UINT32
modifier|*
name|InquiryDataLength
parameter_list|,
name|IN
name|BOOLEAN
name|EnableVitalProductData
parameter_list|)
block|{
return|return
name|ScsiInquiryCommandEx
argument_list|(
name|ScsiIo
argument_list|,
name|Timeout
argument_list|,
name|SenseData
argument_list|,
name|SenseDataLength
argument_list|,
name|HostAdapterStatus
argument_list|,
name|TargetStatus
argument_list|,
name|InquiryDataBuffer
argument_list|,
name|InquiryDataLength
argument_list|,
name|EnableVitalProductData
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**   Execute Mode Sense(10) SCSI command on a specific SCSI target.    Executes the SCSI Mode Sense(10) command on the SCSI target specified by ScsiIo.   If Timeout is zero, then this function waits indefinitely for the command to complete.   If Timeout is greater than zero, then the command is executed and will timeout   after Timeout 100 ns units.  The DBDField, PageControl, and PageCode parameters   are used to construct the CDB for this SCSI command.   If ScsiIo is NULL, then ASSERT().   If SenseDataLength is NULL, then ASSERT().   If HostAdapterStatus is NULL, then ASSERT().   If TargetStatus is NULL, then ASSERT().   If DataLength is NULL, then ASSERT().    If SenseDataLength is non-zero and SenseData is not NULL, SenseData must meet buffer   alignment requirement defined in EFI_SCSI_IO_PROTOCOL. Otherwise EFI_INVALID_PARAMETER   gets returned.    If DataLength is non-zero and DataBuffer is not NULL, DataBuffer must meet buffer   alignment requirement defined in EFI_SCSI_IO_PROTOCOL. Otherwise EFI_INVALID_PARAMETER   gets returned.    @param[in]      ScsiIo             A pointer to the SCSI I/O Protocol instance                                      for the specific SCSI target.   @param[in]      Timeout            The timeout in 100 ns units to use for the                                      execution of this SCSI Request Packet. A Timeout                                      value of zero means that this function will wait                                      indefinitely for the SCSI Request Packet to execute.                                      If Timeout is greater than zero, then this function                                      will return EFI_TIMEOUT if the time required to                                      execute the SCSI Request Packet is greater than Timeout.   @param[in, out]  SenseData         A pointer to sense data that was generated                                      by the execution of the SCSI Request Packet.                                      This buffer must be allocated by the caller.                                      If SenseDataLength is 0, then this parameter                                      is optional and may be NULL.   @param[in, out]  SenseDataLength   On input, the length in bytes of the SenseData buffer.                                      On output, the number of bytes written to the SenseData buffer.    @param[out]     HostAdapterStatus  The status of the SCSI Host Controller that                                      produces the SCSI bus containing the SCSI target                                      specified by ScsiIo when the SCSI Request Packet                                      was executed. See the EFI SCSI I/O Protocol in the                                      UEFI Specification for details on the possible                                      return values.   @param[out]     TargetStatus       The status returned by the SCSI target specified                                      by ScsiIo when the SCSI Request Packet was executed                                      on the SCSI Host Controller.  See the EFI SCSI                                      I/O Protocol in the UEFI Specification for details                                      on the possible return values.   @param[in, out]  DataBuffer        A pointer to data that was generated by the                                      execution of the SCSI Request Packet.  This                                      buffer must be allocated by the caller. If                                      DataLength is 0, then this parameter is optional                                      and may be NULL.    @param[in, out]  DataLength        On input, a pointer to the length in bytes of                                      the DataBuffer buffer.  On output, a pointer                                      to the number of bytes written to the DataBuffer                                      buffer.    @param[in]      DBDField           Specifies the DBD field of the CDB for this SCSI Command.   @param[in]      PageControl        Specifies the PC field of the CDB for this SCSI Command.    @param[in]      PageCode           Specifies the Page Control field of the CDB for this SCSI Command.     @retval EFI_SUCCESS                The command was executed successfully.                                      See HostAdapterStatus, TargetStatus, SenseDataLength,                                      and SenseData in that order for additional status information.   @retval EFI_BAD_BUFFER_SIZE        The SCSI Request Packet was executed, but the                                      entire DataBuffer could not be transferred.                                      The actual number of bytes transferred is returned                                      in DataLength.   @retval EFI_NOT_READY              The SCSI Request Packet could not be sent because                                      there are too many SCSI Command Packets already queued.                                      The SCSI Request Packet was not sent, so no additional                                      status information is available.  The caller may retry                                      again later.   @retval EFI_DEVICE_ERROR           A device error occurred while attempting to send                                      SCSI Request Packet.  See HostAdapterStatus, TargetStatus,                                      SenseDataLength, and SenseData in that order for                                      additional status information.   @retval EFI_UNSUPPORTED            The command described by the SCSI Request Packet                                      is not supported by the SCSI initiator(i.e., SCSI                                      Host Controller). The SCSI Request Packet was not                                      sent, so no additional status information is available.   @retval EFI_TIMEOUT                A timeout occurred while waiting for the SCSI                                      Request Packet to execute.  See HostAdapterStatus,                                      TargetStatus, SenseDataLength, and SenseData in that                                      order for additional status information.   @retval EFI_INVALID_PARAMETER      The contents of the SCSI Request Packet are invalid.  **/
end_comment

begin_function
name|EFI_STATUS
name|EFIAPI
name|ScsiModeSense10Command
parameter_list|(
name|IN
name|EFI_SCSI_IO_PROTOCOL
modifier|*
name|ScsiIo
parameter_list|,
name|IN
name|UINT64
name|Timeout
parameter_list|,
name|IN
name|OUT
name|VOID
modifier|*
name|SenseData
parameter_list|,
name|OPTIONAL
name|IN
name|OUT
name|UINT8
modifier|*
name|SenseDataLength
parameter_list|,
name|OUT
name|UINT8
modifier|*
name|HostAdapterStatus
parameter_list|,
name|OUT
name|UINT8
modifier|*
name|TargetStatus
parameter_list|,
name|IN
name|OUT
name|VOID
modifier|*
name|DataBuffer
parameter_list|,
name|OPTIONAL
name|IN
name|OUT
name|UINT32
modifier|*
name|DataLength
parameter_list|,
name|IN
name|UINT8
name|DBDField
parameter_list|,
name|OPTIONAL
name|IN
name|UINT8
name|PageControl
parameter_list|,
name|IN
name|UINT8
name|PageCode
parameter_list|)
block|{
name|EFI_SCSI_IO_SCSI_REQUEST_PACKET
name|CommandPacket
decl_stmt|;
name|EFI_STATUS
name|Status
decl_stmt|;
name|UINT8
name|Cdb
index|[
name|EFI_SCSI_OP_LENGTH_TEN
index|]
decl_stmt|;
name|ASSERT
argument_list|(
name|SenseDataLength
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|HostAdapterStatus
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|TargetStatus
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|DataLength
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|ScsiIo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ZeroMem
argument_list|(
operator|&
name|CommandPacket
argument_list|,
sizeof|sizeof
argument_list|(
name|EFI_SCSI_IO_SCSI_REQUEST_PACKET
argument_list|)
argument_list|)
expr_stmt|;
name|ZeroMem
argument_list|(
name|Cdb
argument_list|,
name|EFI_SCSI_OP_LENGTH_TEN
argument_list|)
expr_stmt|;
name|CommandPacket
operator|.
name|Timeout
operator|=
name|Timeout
expr_stmt|;
name|CommandPacket
operator|.
name|InDataBuffer
operator|=
name|DataBuffer
expr_stmt|;
name|CommandPacket
operator|.
name|SenseData
operator|=
name|SenseData
expr_stmt|;
name|CommandPacket
operator|.
name|InTransferLength
operator|=
operator|*
name|DataLength
expr_stmt|;
name|CommandPacket
operator|.
name|Cdb
operator|=
name|Cdb
expr_stmt|;
comment|//
comment|// Fill Cdb for Mode Sense (10) Command
comment|//
name|Cdb
index|[
literal|0
index|]
operator|=
name|EFI_SCSI_OP_MODE_SEN10
expr_stmt|;
comment|//
comment|// DBDField is in Cdb[1] bit3 of (bit7..0)
comment|//
name|Cdb
index|[
literal|1
index|]
operator|=
call|(
name|UINT8
call|)
argument_list|(
operator|(
name|DBDField
operator|<<
literal|3
operator|)
operator|&
literal|0x08
argument_list|)
expr_stmt|;
comment|//
comment|// PageControl is in Cdb[2] bit7..6, PageCode is in Cdb[2] bit5..0
comment|//
name|Cdb
index|[
literal|2
index|]
operator|=
call|(
name|UINT8
call|)
argument_list|(
operator|(
operator|(
name|PageControl
operator|<<
literal|6
operator|)
operator|&
literal|0xc0
operator|)
operator||
operator|(
name|PageCode
operator|&
literal|0x3f
operator|)
argument_list|)
expr_stmt|;
name|Cdb
index|[
literal|7
index|]
operator|=
call|(
name|UINT8
call|)
argument_list|(
operator|*
name|DataLength
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|Cdb
index|[
literal|8
index|]
operator|=
call|(
name|UINT8
call|)
argument_list|(
operator|*
name|DataLength
argument_list|)
expr_stmt|;
name|CommandPacket
operator|.
name|CdbLength
operator|=
name|EFI_SCSI_OP_LENGTH_TEN
expr_stmt|;
name|CommandPacket
operator|.
name|DataDirection
operator|=
name|EFI_SCSI_DATA_IN
expr_stmt|;
name|CommandPacket
operator|.
name|SenseDataLength
operator|=
operator|*
name|SenseDataLength
expr_stmt|;
name|Status
operator|=
name|ScsiIo
operator|->
name|ExecuteScsiCommand
argument_list|(
name|ScsiIo
argument_list|,
operator|&
name|CommandPacket
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
operator|*
name|HostAdapterStatus
operator|=
name|CommandPacket
operator|.
name|HostAdapterStatus
expr_stmt|;
operator|*
name|TargetStatus
operator|=
name|CommandPacket
operator|.
name|TargetStatus
expr_stmt|;
operator|*
name|SenseDataLength
operator|=
name|CommandPacket
operator|.
name|SenseDataLength
expr_stmt|;
operator|*
name|DataLength
operator|=
name|CommandPacket
operator|.
name|InTransferLength
expr_stmt|;
return|return
name|Status
return|;
block|}
end_function

begin_comment
comment|/**   Execute Request Sense SCSI command on a specific SCSI target.    Executes the Request Sense command on the SCSI target specified by ScsiIo.   If Timeout is zero, then this function waits indefinitely for the command to complete.   If Timeout is greater than zero, then the command is executed and will timeout after Timeout 100 ns units.   If ScsiIo is NULL, then ASSERT().   If SenseDataLength is NULL, then ASSERT().   If HostAdapterStatus is NULL, then ASSERT().   If TargetStatus is NULL, then ASSERT().    If SenseDataLength is non-zero and SenseData is not NULL, SenseData must meet buffer   alignment requirement defined in EFI_SCSI_IO_PROTOCOL. Otherwise EFI_INVALID_PARAMETER   gets returned.    @param[in]       ScsiIo               A pointer to SCSI IO protocol.   @param[in]       Timeout              The length of timeout period.   @param[in, out]  SenseData            A pointer to output sense data.   @param[in, out]  SenseDataLength      The length of output sense data.   @param[out]      HostAdapterStatus    The status of Host Adapter.   @param[out]      TargetStatus         The status of the target.    @retval EFI_SUCCESS                   Command is executed successfully.   @retval EFI_NOT_READY                 The SCSI Request Packet could not be sent because there are                                         too many SCSI Command Packets already queued.   @retval EFI_DEVICE_ERROR              A device error occurred while attempting to send SCSI Request Packet.   @retval EFI_UNSUPPORTED               The command described by the SCSI Request Packet is not supported by                                         the SCSI initiator(i.e., SCSI  Host Controller)   @retval EFI_TIMEOUT                   A timeout occurred while waiting for the SCSI Request Packet to execute.   @retval EFI_INVALID_PARAMETER         The contents of the SCSI Request Packet are invalid.  **/
end_comment

begin_function
name|EFI_STATUS
name|EFIAPI
name|ScsiRequestSenseCommand
parameter_list|(
name|IN
name|EFI_SCSI_IO_PROTOCOL
modifier|*
name|ScsiIo
parameter_list|,
name|IN
name|UINT64
name|Timeout
parameter_list|,
name|IN
name|OUT
name|VOID
modifier|*
name|SenseData
parameter_list|,
name|OPTIONAL
name|IN
name|OUT
name|UINT8
modifier|*
name|SenseDataLength
parameter_list|,
name|OUT
name|UINT8
modifier|*
name|HostAdapterStatus
parameter_list|,
name|OUT
name|UINT8
modifier|*
name|TargetStatus
parameter_list|)
block|{
name|EFI_SCSI_IO_SCSI_REQUEST_PACKET
name|CommandPacket
decl_stmt|;
name|EFI_STATUS
name|Status
decl_stmt|;
name|UINT8
name|Cdb
index|[
name|EFI_SCSI_OP_LENGTH_SIX
index|]
decl_stmt|;
name|ASSERT
argument_list|(
name|SenseDataLength
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|HostAdapterStatus
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|TargetStatus
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|ScsiIo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ZeroMem
argument_list|(
operator|&
name|CommandPacket
argument_list|,
sizeof|sizeof
argument_list|(
name|EFI_SCSI_IO_SCSI_REQUEST_PACKET
argument_list|)
argument_list|)
expr_stmt|;
name|ZeroMem
argument_list|(
name|Cdb
argument_list|,
name|EFI_SCSI_OP_LENGTH_SIX
argument_list|)
expr_stmt|;
name|CommandPacket
operator|.
name|Timeout
operator|=
name|Timeout
expr_stmt|;
name|CommandPacket
operator|.
name|InDataBuffer
operator|=
name|SenseData
expr_stmt|;
name|CommandPacket
operator|.
name|SenseData
operator|=
name|NULL
expr_stmt|;
name|CommandPacket
operator|.
name|InTransferLength
operator|=
operator|*
name|SenseDataLength
expr_stmt|;
name|CommandPacket
operator|.
name|Cdb
operator|=
name|Cdb
expr_stmt|;
comment|//
comment|// Fill Cdb for Request Sense Command
comment|//
name|Cdb
index|[
literal|0
index|]
operator|=
name|EFI_SCSI_OP_REQUEST_SENSE
expr_stmt|;
name|Cdb
index|[
literal|4
index|]
operator|=
call|(
name|UINT8
call|)
argument_list|(
operator|*
name|SenseDataLength
argument_list|)
expr_stmt|;
name|CommandPacket
operator|.
name|CdbLength
operator|=
operator|(
name|UINT8
operator|)
name|EFI_SCSI_OP_LENGTH_SIX
expr_stmt|;
name|CommandPacket
operator|.
name|DataDirection
operator|=
name|EFI_SCSI_DATA_IN
expr_stmt|;
name|CommandPacket
operator|.
name|SenseDataLength
operator|=
literal|0
expr_stmt|;
name|Status
operator|=
name|ScsiIo
operator|->
name|ExecuteScsiCommand
argument_list|(
name|ScsiIo
argument_list|,
operator|&
name|CommandPacket
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
operator|*
name|HostAdapterStatus
operator|=
name|CommandPacket
operator|.
name|HostAdapterStatus
expr_stmt|;
operator|*
name|TargetStatus
operator|=
name|CommandPacket
operator|.
name|TargetStatus
expr_stmt|;
operator|*
name|SenseDataLength
operator|=
operator|(
name|UINT8
operator|)
name|CommandPacket
operator|.
name|InTransferLength
expr_stmt|;
return|return
name|Status
return|;
block|}
end_function

begin_comment
comment|/**   Execute Read Capacity SCSI command on a specific SCSI target.    Executes the SCSI Read Capacity command on the SCSI target specified by ScsiIo.   If Timeout is zero, then this function waits indefinitely for the command to complete.   If Timeout is greater than zero, then the command is executed and will timeout after   Timeout 100 ns units.  The Pmi parameter is used to construct the CDB for this SCSI command.   If ScsiIo is NULL, then ASSERT().   If SenseDataLength is NULL, then ASSERT().   If HostAdapterStatus is NULL, then ASSERT().   If TargetStatus is NULL, then ASSERT().   If DataLength is NULL, then ASSERT().    If SenseDataLength is non-zero and SenseData is not NULL, SenseData must meet buffer   alignment requirement defined in EFI_SCSI_IO_PROTOCOL. Otherwise EFI_INVALID_PARAMETER   gets returned.    If DataLength is non-zero and DataBuffer is not NULL, DataBuffer must meet buffer   alignment requirement defined in EFI_SCSI_IO_PROTOCOL. Otherwise EFI_INVALID_PARAMETER   gets returned.    @param[in]      ScsiIo               A pointer to SCSI IO protocol.   @param[in]      Timeout              The length of timeout period.   @param[in, out] SenseData            A pointer to output sense data.   @param[in, out] SenseDataLength      The length of output sense data.   @param[out]     HostAdapterStatus    The status of Host Adapter.   @param[out]     TargetStatus         The status of the target.   @param[in, out] DataBuffer           A pointer to a data buffer.   @param[in, out] DataLength           The length of data buffer.   @param[in]      Pmi                  Partial medium indicator.    @retval  EFI_SUCCESS                 Command is executed successfully.   @retval  EFI_BAD_BUFFER_SIZE         The SCSI Request Packet was executed, but the entire                                        DataBuffer could not be transferred. The actual                                        number of bytes transferred is returned in DataLength.   @retval  EFI_NOT_READY               The SCSI Request Packet could not be sent because                                        there are too many SCSI Command Packets already queued.   @retval  EFI_DEVICE_ERROR            A device error occurred while attempting to send SCSI Request Packet.   @retval  EFI_UNSUPPORTED             The command described by the SCSI Request Packet                                        is not supported by the SCSI initiator(i.e., SCSI  Host Controller)   @retval  EFI_TIMEOUT                 A timeout occurred while waiting for the SCSI Request Packet to execute.   @retval  EFI_INVALID_PARAMETER       The contents of the SCSI Request Packet are invalid.  **/
end_comment

begin_function
name|EFI_STATUS
name|EFIAPI
name|ScsiReadCapacityCommand
parameter_list|(
name|IN
name|EFI_SCSI_IO_PROTOCOL
modifier|*
name|ScsiIo
parameter_list|,
name|IN
name|UINT64
name|Timeout
parameter_list|,
name|IN
name|OUT
name|VOID
modifier|*
name|SenseData
parameter_list|,
name|OPTIONAL
name|IN
name|OUT
name|UINT8
modifier|*
name|SenseDataLength
parameter_list|,
name|OUT
name|UINT8
modifier|*
name|HostAdapterStatus
parameter_list|,
name|OUT
name|UINT8
modifier|*
name|TargetStatus
parameter_list|,
name|IN
name|OUT
name|VOID
modifier|*
name|DataBuffer
parameter_list|,
name|OPTIONAL
name|IN
name|OUT
name|UINT32
modifier|*
name|DataLength
parameter_list|,
name|IN
name|BOOLEAN
name|Pmi
parameter_list|)
block|{
name|EFI_SCSI_IO_SCSI_REQUEST_PACKET
name|CommandPacket
decl_stmt|;
name|EFI_STATUS
name|Status
decl_stmt|;
name|UINT8
name|Cdb
index|[
name|EFI_SCSI_OP_LENGTH_TEN
index|]
decl_stmt|;
name|ASSERT
argument_list|(
name|SenseDataLength
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|HostAdapterStatus
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|TargetStatus
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|DataLength
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|ScsiIo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ZeroMem
argument_list|(
operator|&
name|CommandPacket
argument_list|,
sizeof|sizeof
argument_list|(
name|EFI_SCSI_IO_SCSI_REQUEST_PACKET
argument_list|)
argument_list|)
expr_stmt|;
name|ZeroMem
argument_list|(
name|Cdb
argument_list|,
name|EFI_SCSI_OP_LENGTH_TEN
argument_list|)
expr_stmt|;
name|CommandPacket
operator|.
name|Timeout
operator|=
name|Timeout
expr_stmt|;
name|CommandPacket
operator|.
name|InDataBuffer
operator|=
name|DataBuffer
expr_stmt|;
name|CommandPacket
operator|.
name|SenseData
operator|=
name|SenseData
expr_stmt|;
name|CommandPacket
operator|.
name|InTransferLength
operator|=
operator|*
name|DataLength
expr_stmt|;
name|CommandPacket
operator|.
name|Cdb
operator|=
name|Cdb
expr_stmt|;
comment|//
comment|// Fill Cdb for Read Capacity Command
comment|//
name|Cdb
index|[
literal|0
index|]
operator|=
name|EFI_SCSI_OP_READ_CAPACITY
expr_stmt|;
if|if
condition|(
operator|!
name|Pmi
condition|)
block|{
comment|//
comment|// Partial medium indicator,if Pmi is FALSE, the Cdb.2 ~ Cdb.5 MUST BE ZERO.
comment|//
name|ZeroMem
argument_list|(
operator|(
name|Cdb
operator|+
literal|2
operator|)
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|Cdb
index|[
literal|8
index|]
operator||=
literal|0x01
expr_stmt|;
block|}
name|CommandPacket
operator|.
name|CdbLength
operator|=
name|EFI_SCSI_OP_LENGTH_TEN
expr_stmt|;
name|CommandPacket
operator|.
name|DataDirection
operator|=
name|EFI_SCSI_DATA_IN
expr_stmt|;
name|CommandPacket
operator|.
name|SenseDataLength
operator|=
operator|*
name|SenseDataLength
expr_stmt|;
name|Status
operator|=
name|ScsiIo
operator|->
name|ExecuteScsiCommand
argument_list|(
name|ScsiIo
argument_list|,
operator|&
name|CommandPacket
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
operator|*
name|HostAdapterStatus
operator|=
name|CommandPacket
operator|.
name|HostAdapterStatus
expr_stmt|;
operator|*
name|TargetStatus
operator|=
name|CommandPacket
operator|.
name|TargetStatus
expr_stmt|;
operator|*
name|SenseDataLength
operator|=
name|CommandPacket
operator|.
name|SenseDataLength
expr_stmt|;
operator|*
name|DataLength
operator|=
name|CommandPacket
operator|.
name|InTransferLength
expr_stmt|;
return|return
name|Status
return|;
block|}
end_function

begin_comment
comment|/**   Execute Read Capacity SCSI 16 command on a specific SCSI target.    Executes the SCSI Read Capacity 16 command on the SCSI target specified by ScsiIo.   If Timeout is zero, then this function waits indefinitely for the command to complete.   If Timeout is greater than zero, then the command is executed and will timeout after   Timeout 100 ns units.  The Pmi parameter is used to construct the CDB for this SCSI command.   If ScsiIo is NULL, then ASSERT().   If SenseDataLength is NULL, then ASSERT().   If HostAdapterStatus is NULL, then ASSERT().   If TargetStatus is NULL, then ASSERT().   If DataLength is NULL, then ASSERT().    If SenseDataLength is non-zero and SenseData is not NULL, SenseData must meet buffer   alignment requirement defined in EFI_SCSI_IO_PROTOCOL. Otherwise EFI_INVALID_PARAMETER   gets returned.    If DataLength is non-zero and DataBuffer is not NULL, DataBuffer must meet buffer   alignment requirement defined in EFI_SCSI_IO_PROTOCOL. Otherwise EFI_INVALID_PARAMETER   gets returned.    @param[in]      ScsiIo               A pointer to SCSI IO protocol.   @param[in]      Timeout              The length of timeout period.   @param[in, out] SenseData            A pointer to output sense data.   @param[in, out] SenseDataLength      The length of output sense data.   @param[out]     HostAdapterStatus    The status of Host Adapter.   @param[out]     TargetStatus         The status of the target.   @param[in, out] DataBuffer           A pointer to a data buffer.   @param[in, out] DataLength           The length of data buffer.   @param[in]      Pmi                  Partial medium indicator.    @retval  EFI_SUCCESS                 Command is executed successfully.   @retval  EFI_BAD_BUFFER_SIZE         The SCSI Request Packet was executed, but the entire                                        DataBuffer could not be transferred. The actual                                        number of bytes transferred is returned in DataLength.   @retval  EFI_NOT_READY               The SCSI Request Packet could not be sent because                                        there are too many SCSI Command Packets already queued.   @retval  EFI_DEVICE_ERROR            A device error occurred while attempting to send SCSI Request Packet.   @retval  EFI_UNSUPPORTED             The command described by the SCSI Request Packet                                        is not supported by the SCSI initiator(i.e., SCSI  Host Controller)   @retval  EFI_TIMEOUT                 A timeout occurred while waiting for the SCSI Request Packet to execute.   @retval  EFI_INVALID_PARAMETER       The contents of the SCSI Request Packet are invalid.  **/
end_comment

begin_function
name|EFI_STATUS
name|EFIAPI
name|ScsiReadCapacity16Command
parameter_list|(
name|IN
name|EFI_SCSI_IO_PROTOCOL
modifier|*
name|ScsiIo
parameter_list|,
name|IN
name|UINT64
name|Timeout
parameter_list|,
name|IN
name|OUT
name|VOID
modifier|*
name|SenseData
parameter_list|,
name|OPTIONAL
name|IN
name|OUT
name|UINT8
modifier|*
name|SenseDataLength
parameter_list|,
name|OUT
name|UINT8
modifier|*
name|HostAdapterStatus
parameter_list|,
name|OUT
name|UINT8
modifier|*
name|TargetStatus
parameter_list|,
name|IN
name|OUT
name|VOID
modifier|*
name|DataBuffer
parameter_list|,
name|OPTIONAL
name|IN
name|OUT
name|UINT32
modifier|*
name|DataLength
parameter_list|,
name|IN
name|BOOLEAN
name|Pmi
parameter_list|)
block|{
name|EFI_SCSI_IO_SCSI_REQUEST_PACKET
name|CommandPacket
decl_stmt|;
name|EFI_STATUS
name|Status
decl_stmt|;
name|UINT8
name|Cdb
index|[
literal|16
index|]
decl_stmt|;
name|ASSERT
argument_list|(
name|SenseDataLength
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|HostAdapterStatus
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|TargetStatus
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|DataLength
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|ScsiIo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ZeroMem
argument_list|(
operator|&
name|CommandPacket
argument_list|,
sizeof|sizeof
argument_list|(
name|EFI_SCSI_IO_SCSI_REQUEST_PACKET
argument_list|)
argument_list|)
expr_stmt|;
name|ZeroMem
argument_list|(
name|Cdb
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|CommandPacket
operator|.
name|Timeout
operator|=
name|Timeout
expr_stmt|;
name|CommandPacket
operator|.
name|InDataBuffer
operator|=
name|DataBuffer
expr_stmt|;
name|CommandPacket
operator|.
name|SenseData
operator|=
name|SenseData
expr_stmt|;
name|CommandPacket
operator|.
name|InTransferLength
operator|=
operator|*
name|DataLength
expr_stmt|;
name|CommandPacket
operator|.
name|Cdb
operator|=
name|Cdb
expr_stmt|;
comment|//
comment|// Fill Cdb for Read Capacity Command
comment|//
name|Cdb
index|[
literal|0
index|]
operator|=
name|EFI_SCSI_OP_READ_CAPACITY16
expr_stmt|;
name|Cdb
index|[
literal|1
index|]
operator|=
literal|0x10
expr_stmt|;
if|if
condition|(
operator|!
name|Pmi
condition|)
block|{
comment|//
comment|// Partial medium indicator,if Pmi is FALSE, the Cdb.2 ~ Cdb.9 MUST BE ZERO.
comment|//
name|ZeroMem
argument_list|(
operator|(
name|Cdb
operator|+
literal|2
operator|)
argument_list|,
literal|8
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|Cdb
index|[
literal|14
index|]
operator||=
literal|0x01
expr_stmt|;
block|}
name|Cdb
index|[
literal|13
index|]
operator|=
literal|0x20
expr_stmt|;
name|CommandPacket
operator|.
name|CdbLength
operator|=
literal|16
expr_stmt|;
name|CommandPacket
operator|.
name|DataDirection
operator|=
name|EFI_SCSI_DATA_IN
expr_stmt|;
name|CommandPacket
operator|.
name|SenseDataLength
operator|=
operator|*
name|SenseDataLength
expr_stmt|;
name|Status
operator|=
name|ScsiIo
operator|->
name|ExecuteScsiCommand
argument_list|(
name|ScsiIo
argument_list|,
operator|&
name|CommandPacket
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
operator|*
name|HostAdapterStatus
operator|=
name|CommandPacket
operator|.
name|HostAdapterStatus
expr_stmt|;
operator|*
name|TargetStatus
operator|=
name|CommandPacket
operator|.
name|TargetStatus
expr_stmt|;
operator|*
name|SenseDataLength
operator|=
name|CommandPacket
operator|.
name|SenseDataLength
expr_stmt|;
operator|*
name|DataLength
operator|=
name|CommandPacket
operator|.
name|InTransferLength
expr_stmt|;
return|return
name|Status
return|;
block|}
end_function

begin_comment
comment|/**   Execute Read(10) SCSI command on a specific SCSI target.    Executes the SCSI Read(10) command on the SCSI target specified by ScsiIo.   If Timeout is zero, then this function waits indefinitely for the command to complete.   If Timeout is greater than zero, then the command is executed and will timeout   after Timeout 100 ns units.  The StartLba and SectorSize parameters are used to   construct the CDB for this SCSI command.   If ScsiIo is NULL, then ASSERT().   If SenseDataLength is NULL, then ASSERT().   If HostAdapterStatus is NULL, then ASSERT().   If TargetStatus is NULL, then ASSERT().   If DataLength is NULL, then ASSERT().    If SenseDataLength is non-zero and SenseData is not NULL, SenseData must meet buffer   alignment requirement defined in EFI_SCSI_IO_PROTOCOL. Otherwise EFI_INVALID_PARAMETER   gets returned.    If DataLength is non-zero and DataBuffer is not NULL, DataBuffer must meet buffer   alignment requirement defined in EFI_SCSI_IO_PROTOCOL. Otherwise EFI_INVALID_PARAMETER   gets returned.    @param[in]      ScsiIo               A pointer to SCSI IO protocol.   @param[in]      Timeout              The length of timeout period.   @param[in, out] SenseData            A pointer to output sense data.   @param[in, out] SenseDataLength      The length of output sense data.   @param[out]     HostAdapterStatus    The status of Host Adapter.   @param[out]     TargetStatus         The status of the target.   @param[in, out] DataBuffer           Read 10 command data.   @param[in, out] DataLength           The length of data buffer.   @param[in]      StartLba             The start address of LBA.   @param[in]      SectorSize           The number of contiguous logical blocks of data that shall be transferred.    @retval  EFI_SUCCESS                 Command is executed successfully.   @retval  EFI_BAD_BUFFER_SIZE         The SCSI Request Packet was executed, but the entire DataBuffer could                                        not be transferred. The actual number of bytes transferred is returned in DataLength.   @retval  EFI_NOT_READY               The SCSI Request Packet could not be sent because there are too many                                        SCSI Command Packets already queued.   @retval  EFI_DEVICE_ERROR            A device error occurred while attempting to send SCSI Request Packet.   @retval  EFI_UNSUPPORTED             The command described by the SCSI Request Packet is not supported by                                        the SCSI initiator(i.e., SCSI  Host Controller)   @retval  EFI_TIMEOUT                 A timeout occurred while waiting for the SCSI Request Packet to execute.   @retval  EFI_INVALID_PARAMETER       The contents of the SCSI Request Packet are invalid.  **/
end_comment

begin_function
name|EFI_STATUS
name|EFIAPI
name|ScsiRead10Command
parameter_list|(
name|IN
name|EFI_SCSI_IO_PROTOCOL
modifier|*
name|ScsiIo
parameter_list|,
name|IN
name|UINT64
name|Timeout
parameter_list|,
name|IN
name|OUT
name|VOID
modifier|*
name|SenseData
parameter_list|,
name|OPTIONAL
name|IN
name|OUT
name|UINT8
modifier|*
name|SenseDataLength
parameter_list|,
name|OUT
name|UINT8
modifier|*
name|HostAdapterStatus
parameter_list|,
name|OUT
name|UINT8
modifier|*
name|TargetStatus
parameter_list|,
name|IN
name|OUT
name|VOID
modifier|*
name|DataBuffer
parameter_list|,
name|OPTIONAL
name|IN
name|OUT
name|UINT32
modifier|*
name|DataLength
parameter_list|,
name|IN
name|UINT32
name|StartLba
parameter_list|,
name|IN
name|UINT32
name|SectorSize
parameter_list|)
block|{
name|EFI_SCSI_IO_SCSI_REQUEST_PACKET
name|CommandPacket
decl_stmt|;
name|EFI_STATUS
name|Status
decl_stmt|;
name|UINT8
name|Cdb
index|[
name|EFI_SCSI_OP_LENGTH_TEN
index|]
decl_stmt|;
name|ASSERT
argument_list|(
name|SenseDataLength
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|HostAdapterStatus
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|TargetStatus
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|DataLength
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|ScsiIo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ZeroMem
argument_list|(
operator|&
name|CommandPacket
argument_list|,
sizeof|sizeof
argument_list|(
name|EFI_SCSI_IO_SCSI_REQUEST_PACKET
argument_list|)
argument_list|)
expr_stmt|;
name|ZeroMem
argument_list|(
name|Cdb
argument_list|,
name|EFI_SCSI_OP_LENGTH_TEN
argument_list|)
expr_stmt|;
name|CommandPacket
operator|.
name|Timeout
operator|=
name|Timeout
expr_stmt|;
name|CommandPacket
operator|.
name|InDataBuffer
operator|=
name|DataBuffer
expr_stmt|;
name|CommandPacket
operator|.
name|SenseData
operator|=
name|SenseData
expr_stmt|;
name|CommandPacket
operator|.
name|InTransferLength
operator|=
operator|*
name|DataLength
expr_stmt|;
name|CommandPacket
operator|.
name|Cdb
operator|=
name|Cdb
expr_stmt|;
comment|//
comment|// Fill Cdb for Read (10) Command
comment|//
name|Cdb
index|[
literal|0
index|]
operator|=
name|EFI_SCSI_OP_READ10
expr_stmt|;
name|WriteUnaligned32
argument_list|(
operator|(
name|UINT32
operator|*
operator|)
operator|&
name|Cdb
index|[
literal|2
index|]
argument_list|,
name|SwapBytes32
argument_list|(
name|StartLba
argument_list|)
argument_list|)
expr_stmt|;
name|WriteUnaligned16
argument_list|(
operator|(
name|UINT16
operator|*
operator|)
operator|&
name|Cdb
index|[
literal|7
index|]
argument_list|,
name|SwapBytes16
argument_list|(
operator|(
name|UINT16
operator|)
name|SectorSize
argument_list|)
argument_list|)
expr_stmt|;
name|CommandPacket
operator|.
name|CdbLength
operator|=
name|EFI_SCSI_OP_LENGTH_TEN
expr_stmt|;
name|CommandPacket
operator|.
name|DataDirection
operator|=
name|EFI_SCSI_DATA_IN
expr_stmt|;
name|CommandPacket
operator|.
name|SenseDataLength
operator|=
operator|*
name|SenseDataLength
expr_stmt|;
name|Status
operator|=
name|ScsiIo
operator|->
name|ExecuteScsiCommand
argument_list|(
name|ScsiIo
argument_list|,
operator|&
name|CommandPacket
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
operator|*
name|HostAdapterStatus
operator|=
name|CommandPacket
operator|.
name|HostAdapterStatus
expr_stmt|;
operator|*
name|TargetStatus
operator|=
name|CommandPacket
operator|.
name|TargetStatus
expr_stmt|;
operator|*
name|SenseDataLength
operator|=
name|CommandPacket
operator|.
name|SenseDataLength
expr_stmt|;
operator|*
name|DataLength
operator|=
name|CommandPacket
operator|.
name|InTransferLength
expr_stmt|;
return|return
name|Status
return|;
block|}
end_function

begin_comment
comment|/**   Execute Write(10) SCSI command on a specific SCSI target.    Executes the SCSI Write(10) command on the SCSI target specified by ScsiIo.   If Timeout is zero, then this function waits indefinitely for the command to complete.   If Timeout is greater than zero, then the command is executed and will timeout after   Timeout 100 ns units.  The StartLba and SectorSize parameters are used to construct   the CDB for this SCSI command.   If ScsiIo is NULL, then ASSERT().   If SenseDataLength is NULL, then ASSERT().   If HostAdapterStatus is NULL, then ASSERT().   If TargetStatus is NULL, then ASSERT().   If DataLength is NULL, then ASSERT().    If SenseDataLength is non-zero and SenseData is not NULL, SenseData must meet buffer   alignment requirement defined in EFI_SCSI_IO_PROTOCOL. Otherwise EFI_INVALID_PARAMETER   gets returned.    If DataLength is non-zero and DataBuffer is not NULL, DataBuffer must meet buffer   alignment requirement defined in EFI_SCSI_IO_PROTOCOL. Otherwise EFI_INVALID_PARAMETER   gets returned.    @param[in]      ScsiIo               SCSI IO Protocol to use   @param[in]      Timeout              The length of timeout period.   @param[in, out] SenseData            A pointer to output sense data.   @param[in, out] SenseDataLength      The length of output sense data.   @param[out]     HostAdapterStatus    The status of Host Adapter.   @param[out]     TargetStatus         The status of the target.   @param[in, out] DataBuffer           A pointer to a data buffer.   @param[in, out] DataLength           The length of data buffer.   @param[in]      StartLba             The start address of LBA.   @param[in]      SectorSize           The number of contiguous logical blocks of data that shall be transferred.    @retval  EFI_SUCCESS                 Command is executed successfully.   @retval  EFI_BAD_BUFFER_SIZE         The SCSI Request Packet was executed, but the entire DataBuffer could                                        not be transferred. The actual number of bytes transferred is returned in DataLength.   @retval  EFI_NOT_READY               The SCSI Request Packet could not be sent because there are too many                                        SCSI Command Packets already queued.   @retval  EFI_DEVICE_ERROR            A device error occurred while attempting to send SCSI Request Packet.   @retval  EFI_UNSUPPORTED             The command described by the SCSI Request Packet is not supported by                                        the SCSI initiator(i.e., SCSI  Host Controller)   @retval  EFI_TIMEOUT                 A timeout occurred while waiting for the SCSI Request Packet to execute.   @retval  EFI_INVALID_PARAMETER       The contents of the SCSI Request Packet are invalid.  **/
end_comment

begin_function
name|EFI_STATUS
name|EFIAPI
name|ScsiWrite10Command
parameter_list|(
name|IN
name|EFI_SCSI_IO_PROTOCOL
modifier|*
name|ScsiIo
parameter_list|,
name|IN
name|UINT64
name|Timeout
parameter_list|,
name|IN
name|OUT
name|VOID
modifier|*
name|SenseData
parameter_list|,
name|OPTIONAL
name|IN
name|OUT
name|UINT8
modifier|*
name|SenseDataLength
parameter_list|,
name|OUT
name|UINT8
modifier|*
name|HostAdapterStatus
parameter_list|,
name|OUT
name|UINT8
modifier|*
name|TargetStatus
parameter_list|,
name|IN
name|OUT
name|VOID
modifier|*
name|DataBuffer
parameter_list|,
name|OPTIONAL
name|IN
name|OUT
name|UINT32
modifier|*
name|DataLength
parameter_list|,
name|IN
name|UINT32
name|StartLba
parameter_list|,
name|IN
name|UINT32
name|SectorSize
parameter_list|)
block|{
name|EFI_SCSI_IO_SCSI_REQUEST_PACKET
name|CommandPacket
decl_stmt|;
name|EFI_STATUS
name|Status
decl_stmt|;
name|UINT8
name|Cdb
index|[
name|EFI_SCSI_OP_LENGTH_TEN
index|]
decl_stmt|;
name|ASSERT
argument_list|(
name|SenseDataLength
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|HostAdapterStatus
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|TargetStatus
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|DataLength
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|ScsiIo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ZeroMem
argument_list|(
operator|&
name|CommandPacket
argument_list|,
sizeof|sizeof
argument_list|(
name|EFI_SCSI_IO_SCSI_REQUEST_PACKET
argument_list|)
argument_list|)
expr_stmt|;
name|ZeroMem
argument_list|(
name|Cdb
argument_list|,
name|EFI_SCSI_OP_LENGTH_TEN
argument_list|)
expr_stmt|;
name|CommandPacket
operator|.
name|Timeout
operator|=
name|Timeout
expr_stmt|;
name|CommandPacket
operator|.
name|OutDataBuffer
operator|=
name|DataBuffer
expr_stmt|;
name|CommandPacket
operator|.
name|SenseData
operator|=
name|SenseData
expr_stmt|;
name|CommandPacket
operator|.
name|OutTransferLength
operator|=
operator|*
name|DataLength
expr_stmt|;
name|CommandPacket
operator|.
name|Cdb
operator|=
name|Cdb
expr_stmt|;
comment|//
comment|// Fill Cdb for Write (10) Command
comment|//
name|Cdb
index|[
literal|0
index|]
operator|=
name|EFI_SCSI_OP_WRITE10
expr_stmt|;
name|WriteUnaligned32
argument_list|(
operator|(
name|UINT32
operator|*
operator|)
operator|&
name|Cdb
index|[
literal|2
index|]
argument_list|,
name|SwapBytes32
argument_list|(
name|StartLba
argument_list|)
argument_list|)
expr_stmt|;
name|WriteUnaligned16
argument_list|(
operator|(
name|UINT16
operator|*
operator|)
operator|&
name|Cdb
index|[
literal|7
index|]
argument_list|,
name|SwapBytes16
argument_list|(
operator|(
name|UINT16
operator|)
name|SectorSize
argument_list|)
argument_list|)
expr_stmt|;
name|CommandPacket
operator|.
name|CdbLength
operator|=
name|EFI_SCSI_OP_LENGTH_TEN
expr_stmt|;
name|CommandPacket
operator|.
name|DataDirection
operator|=
name|EFI_SCSI_DATA_OUT
expr_stmt|;
name|CommandPacket
operator|.
name|SenseDataLength
operator|=
operator|*
name|SenseDataLength
expr_stmt|;
name|Status
operator|=
name|ScsiIo
operator|->
name|ExecuteScsiCommand
argument_list|(
name|ScsiIo
argument_list|,
operator|&
name|CommandPacket
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
operator|*
name|HostAdapterStatus
operator|=
name|CommandPacket
operator|.
name|HostAdapterStatus
expr_stmt|;
operator|*
name|TargetStatus
operator|=
name|CommandPacket
operator|.
name|TargetStatus
expr_stmt|;
operator|*
name|SenseDataLength
operator|=
name|CommandPacket
operator|.
name|SenseDataLength
expr_stmt|;
operator|*
name|DataLength
operator|=
name|CommandPacket
operator|.
name|OutTransferLength
expr_stmt|;
return|return
name|Status
return|;
block|}
end_function

begin_comment
comment|/**   Execute Read(16) SCSI command on a specific SCSI target.    Executes the SCSI Read(16) command on the SCSI target specified by ScsiIo.   If Timeout is zero, then this function waits indefinitely for the command to complete.   If Timeout is greater than zero, then the command is executed and will timeout   after Timeout 100 ns units.  The StartLba and SectorSize parameters are used to   construct the CDB for this SCSI command.   If ScsiIo is NULL, then ASSERT().   If SenseDataLength is NULL, then ASSERT().   If HostAdapterStatus is NULL, then ASSERT().   If TargetStatus is NULL, then ASSERT().   If DataLength is NULL, then ASSERT().    If SenseDataLength is non-zero and SenseData is not NULL, SenseData must meet buffer   alignment requirement defined in EFI_SCSI_IO_PROTOCOL. Otherwise EFI_INVALID_PARAMETER   gets returned.    If DataLength is non-zero and DataBuffer is not NULL, DataBuffer must meet buffer   alignment requirement defined in EFI_SCSI_IO_PROTOCOL. Otherwise EFI_INVALID_PARAMETER   gets returned.    @param[in]      ScsiIo               A pointer to SCSI IO protocol.   @param[in]      Timeout              The length of timeout period.   @param[in, out] SenseData            A pointer to output sense data.   @param[in, out] SenseDataLength      The length of output sense data.   @param[out]     HostAdapterStatus    The status of Host Adapter.   @param[out]     TargetStatus         The status of the target.   @param[in, out] DataBuffer           Read 16 command data.   @param[in, out] DataLength           The length of data buffer.   @param[in]      StartLba             The start address of LBA.   @param[in]      SectorSize           The number of contiguous logical blocks of data that shall be transferred.    @retval  EFI_SUCCESS                 Command is executed successfully.   @retval  EFI_BAD_BUFFER_SIZE         The SCSI Request Packet was executed, but the entire DataBuffer could                                        not be transferred. The actual number of bytes transferred is returned in DataLength.   @retval  EFI_NOT_READY               The SCSI Request Packet could not be sent because there are too many                                        SCSI Command Packets already queued.   @retval  EFI_DEVICE_ERROR            A device error occurred while attempting to send SCSI Request Packet.   @retval  EFI_UNSUPPORTED             The command described by the SCSI Request Packet is not supported by                                        the SCSI initiator(i.e., SCSI  Host Controller)   @retval  EFI_TIMEOUT                 A timeout occurred while waiting for the SCSI Request Packet to execute.   @retval  EFI_INVALID_PARAMETER       The contents of the SCSI Request Packet are invalid.  **/
end_comment

begin_function
name|EFI_STATUS
name|EFIAPI
name|ScsiRead16Command
parameter_list|(
name|IN
name|EFI_SCSI_IO_PROTOCOL
modifier|*
name|ScsiIo
parameter_list|,
name|IN
name|UINT64
name|Timeout
parameter_list|,
name|IN
name|OUT
name|VOID
modifier|*
name|SenseData
parameter_list|,
name|OPTIONAL
name|IN
name|OUT
name|UINT8
modifier|*
name|SenseDataLength
parameter_list|,
name|OUT
name|UINT8
modifier|*
name|HostAdapterStatus
parameter_list|,
name|OUT
name|UINT8
modifier|*
name|TargetStatus
parameter_list|,
name|IN
name|OUT
name|VOID
modifier|*
name|DataBuffer
parameter_list|,
name|OPTIONAL
name|IN
name|OUT
name|UINT32
modifier|*
name|DataLength
parameter_list|,
name|IN
name|UINT64
name|StartLba
parameter_list|,
name|IN
name|UINT32
name|SectorSize
parameter_list|)
block|{
name|EFI_SCSI_IO_SCSI_REQUEST_PACKET
name|CommandPacket
decl_stmt|;
name|EFI_STATUS
name|Status
decl_stmt|;
name|UINT8
name|Cdb
index|[
name|EFI_SCSI_OP_LENGTH_SIXTEEN
index|]
decl_stmt|;
name|ASSERT
argument_list|(
name|SenseDataLength
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|HostAdapterStatus
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|TargetStatus
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|DataLength
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|ScsiIo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ZeroMem
argument_list|(
operator|&
name|CommandPacket
argument_list|,
sizeof|sizeof
argument_list|(
name|EFI_SCSI_IO_SCSI_REQUEST_PACKET
argument_list|)
argument_list|)
expr_stmt|;
name|ZeroMem
argument_list|(
name|Cdb
argument_list|,
name|EFI_SCSI_OP_LENGTH_SIXTEEN
argument_list|)
expr_stmt|;
name|CommandPacket
operator|.
name|Timeout
operator|=
name|Timeout
expr_stmt|;
name|CommandPacket
operator|.
name|InDataBuffer
operator|=
name|DataBuffer
expr_stmt|;
name|CommandPacket
operator|.
name|SenseData
operator|=
name|SenseData
expr_stmt|;
name|CommandPacket
operator|.
name|InTransferLength
operator|=
operator|*
name|DataLength
expr_stmt|;
name|CommandPacket
operator|.
name|Cdb
operator|=
name|Cdb
expr_stmt|;
comment|//
comment|// Fill Cdb for Read (16) Command
comment|//
name|Cdb
index|[
literal|0
index|]
operator|=
name|EFI_SCSI_OP_READ16
expr_stmt|;
name|WriteUnaligned64
argument_list|(
operator|(
name|UINT64
operator|*
operator|)
operator|&
name|Cdb
index|[
literal|2
index|]
argument_list|,
name|SwapBytes64
argument_list|(
name|StartLba
argument_list|)
argument_list|)
expr_stmt|;
name|WriteUnaligned32
argument_list|(
operator|(
name|UINT32
operator|*
operator|)
operator|&
name|Cdb
index|[
literal|10
index|]
argument_list|,
name|SwapBytes32
argument_list|(
name|SectorSize
argument_list|)
argument_list|)
expr_stmt|;
name|CommandPacket
operator|.
name|CdbLength
operator|=
name|EFI_SCSI_OP_LENGTH_SIXTEEN
expr_stmt|;
name|CommandPacket
operator|.
name|DataDirection
operator|=
name|EFI_SCSI_DATA_IN
expr_stmt|;
name|CommandPacket
operator|.
name|SenseDataLength
operator|=
operator|*
name|SenseDataLength
expr_stmt|;
name|Status
operator|=
name|ScsiIo
operator|->
name|ExecuteScsiCommand
argument_list|(
name|ScsiIo
argument_list|,
operator|&
name|CommandPacket
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
operator|*
name|HostAdapterStatus
operator|=
name|CommandPacket
operator|.
name|HostAdapterStatus
expr_stmt|;
operator|*
name|TargetStatus
operator|=
name|CommandPacket
operator|.
name|TargetStatus
expr_stmt|;
operator|*
name|SenseDataLength
operator|=
name|CommandPacket
operator|.
name|SenseDataLength
expr_stmt|;
operator|*
name|DataLength
operator|=
name|CommandPacket
operator|.
name|InTransferLength
expr_stmt|;
return|return
name|Status
return|;
block|}
end_function

begin_comment
comment|/**   Execute Write(16) SCSI command on a specific SCSI target.    Executes the SCSI Write(16) command on the SCSI target specified by ScsiIo.   If Timeout is zero, then this function waits indefinitely for the command to complete.   If Timeout is greater than zero, then the command is executed and will timeout after   Timeout 100 ns units.  The StartLba and SectorSize parameters are used to construct   the CDB for this SCSI command.   If ScsiIo is NULL, then ASSERT().   If SenseDataLength is NULL, then ASSERT().   If HostAdapterStatus is NULL, then ASSERT().   If TargetStatus is NULL, then ASSERT().   If DataLength is NULL, then ASSERT().    If SenseDataLength is non-zero and SenseData is not NULL, SenseData must meet buffer   alignment requirement defined in EFI_SCSI_IO_PROTOCOL. Otherwise EFI_INVALID_PARAMETER   gets returned.    If DataLength is non-zero and DataBuffer is not NULL, DataBuffer must meet buffer   alignment requirement defined in EFI_SCSI_IO_PROTOCOL. Otherwise EFI_INVALID_PARAMETER   gets returned.    @param[in]      ScsiIo               SCSI IO Protocol to use   @param[in]      Timeout              The length of timeout period.   @param[in, out] SenseData            A pointer to output sense data.   @param[in, out] SenseDataLength      The length of output sense data.   @param[out]     HostAdapterStatus    The status of Host Adapter.   @param[out]     TargetStatus         The status of the target.   @param[in, out] DataBuffer           A pointer to a data buffer.   @param[in, out] DataLength           The length of data buffer.   @param[in]      StartLba             The start address of LBA.   @param[in]      SectorSize           The number of contiguous logical blocks of data that shall be transferred.    @retval  EFI_SUCCESS                 Command is executed successfully.   @retval  EFI_BAD_BUFFER_SIZE         The SCSI Request Packet was executed, but the entire DataBuffer could                                        not be transferred. The actual number of bytes transferred is returned in DataLength.   @retval  EFI_NOT_READY               The SCSI Request Packet could not be sent because there are too many                                        SCSI Command Packets already queued.   @retval  EFI_DEVICE_ERROR            A device error occurred while attempting to send SCSI Request Packet.   @retval  EFI_UNSUPPORTED             The command described by the SCSI Request Packet is not supported by                                        the SCSI initiator(i.e., SCSI  Host Controller)   @retval  EFI_TIMEOUT                 A timeout occurred while waiting for the SCSI Request Packet to execute.   @retval  EFI_INVALID_PARAMETER       The contents of the SCSI Request Packet are invalid.  **/
end_comment

begin_function
name|EFI_STATUS
name|EFIAPI
name|ScsiWrite16Command
parameter_list|(
name|IN
name|EFI_SCSI_IO_PROTOCOL
modifier|*
name|ScsiIo
parameter_list|,
name|IN
name|UINT64
name|Timeout
parameter_list|,
name|IN
name|OUT
name|VOID
modifier|*
name|SenseData
parameter_list|,
name|OPTIONAL
name|IN
name|OUT
name|UINT8
modifier|*
name|SenseDataLength
parameter_list|,
name|OUT
name|UINT8
modifier|*
name|HostAdapterStatus
parameter_list|,
name|OUT
name|UINT8
modifier|*
name|TargetStatus
parameter_list|,
name|IN
name|OUT
name|VOID
modifier|*
name|DataBuffer
parameter_list|,
name|OPTIONAL
name|IN
name|OUT
name|UINT32
modifier|*
name|DataLength
parameter_list|,
name|IN
name|UINT64
name|StartLba
parameter_list|,
name|IN
name|UINT32
name|SectorSize
parameter_list|)
block|{
name|EFI_SCSI_IO_SCSI_REQUEST_PACKET
name|CommandPacket
decl_stmt|;
name|EFI_STATUS
name|Status
decl_stmt|;
name|UINT8
name|Cdb
index|[
name|EFI_SCSI_OP_LENGTH_SIXTEEN
index|]
decl_stmt|;
name|ASSERT
argument_list|(
name|SenseDataLength
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|HostAdapterStatus
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|TargetStatus
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|DataLength
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|ScsiIo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ZeroMem
argument_list|(
operator|&
name|CommandPacket
argument_list|,
sizeof|sizeof
argument_list|(
name|EFI_SCSI_IO_SCSI_REQUEST_PACKET
argument_list|)
argument_list|)
expr_stmt|;
name|ZeroMem
argument_list|(
name|Cdb
argument_list|,
name|EFI_SCSI_OP_LENGTH_SIXTEEN
argument_list|)
expr_stmt|;
name|CommandPacket
operator|.
name|Timeout
operator|=
name|Timeout
expr_stmt|;
name|CommandPacket
operator|.
name|OutDataBuffer
operator|=
name|DataBuffer
expr_stmt|;
name|CommandPacket
operator|.
name|SenseData
operator|=
name|SenseData
expr_stmt|;
name|CommandPacket
operator|.
name|OutTransferLength
operator|=
operator|*
name|DataLength
expr_stmt|;
name|CommandPacket
operator|.
name|Cdb
operator|=
name|Cdb
expr_stmt|;
comment|//
comment|// Fill Cdb for Write (16) Command
comment|//
name|Cdb
index|[
literal|0
index|]
operator|=
name|EFI_SCSI_OP_WRITE16
expr_stmt|;
name|WriteUnaligned64
argument_list|(
operator|(
name|UINT64
operator|*
operator|)
operator|&
name|Cdb
index|[
literal|2
index|]
argument_list|,
name|SwapBytes64
argument_list|(
name|StartLba
argument_list|)
argument_list|)
expr_stmt|;
name|WriteUnaligned32
argument_list|(
operator|(
name|UINT32
operator|*
operator|)
operator|&
name|Cdb
index|[
literal|10
index|]
argument_list|,
name|SwapBytes32
argument_list|(
name|SectorSize
argument_list|)
argument_list|)
expr_stmt|;
name|CommandPacket
operator|.
name|CdbLength
operator|=
name|EFI_SCSI_OP_LENGTH_SIXTEEN
expr_stmt|;
name|CommandPacket
operator|.
name|DataDirection
operator|=
name|EFI_SCSI_DATA_OUT
expr_stmt|;
name|CommandPacket
operator|.
name|SenseDataLength
operator|=
operator|*
name|SenseDataLength
expr_stmt|;
name|Status
operator|=
name|ScsiIo
operator|->
name|ExecuteScsiCommand
argument_list|(
name|ScsiIo
argument_list|,
operator|&
name|CommandPacket
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
operator|*
name|HostAdapterStatus
operator|=
name|CommandPacket
operator|.
name|HostAdapterStatus
expr_stmt|;
operator|*
name|TargetStatus
operator|=
name|CommandPacket
operator|.
name|TargetStatus
expr_stmt|;
operator|*
name|SenseDataLength
operator|=
name|CommandPacket
operator|.
name|SenseDataLength
expr_stmt|;
operator|*
name|DataLength
operator|=
name|CommandPacket
operator|.
name|OutTransferLength
expr_stmt|;
return|return
name|Status
return|;
block|}
end_function

begin_comment
comment|/**   Internal helper notify function in which update the result of the   non-blocking SCSI Read/Write commands and signal caller event.    @param  Event    The instance of EFI_EVENT.   @param  Context  The parameter passed in.  **/
end_comment

begin_function
name|VOID
name|EFIAPI
name|ScsiLibNotify
parameter_list|(
name|IN
name|EFI_EVENT
name|Event
parameter_list|,
name|IN
name|VOID
modifier|*
name|Context
parameter_list|)
block|{
name|EFI_SCSI_LIB_ASYNC_CONTEXT
modifier|*
name|LibContext
decl_stmt|;
name|EFI_SCSI_IO_SCSI_REQUEST_PACKET
modifier|*
name|CommandPacket
decl_stmt|;
name|EFI_EVENT
name|CallerEvent
decl_stmt|;
name|LibContext
operator|=
operator|(
name|EFI_SCSI_LIB_ASYNC_CONTEXT
operator|*
operator|)
name|Context
expr_stmt|;
name|CommandPacket
operator|=
operator|&
name|LibContext
operator|->
name|CommandPacket
expr_stmt|;
name|CallerEvent
operator|=
name|LibContext
operator|->
name|CallerEvent
expr_stmt|;
comment|//
comment|// Update SCSI Read/Write operation results
comment|//
operator|*
name|LibContext
operator|->
name|SenseDataLength
operator|=
name|CommandPacket
operator|->
name|SenseDataLength
expr_stmt|;
operator|*
name|LibContext
operator|->
name|HostAdapterStatus
operator|=
name|CommandPacket
operator|->
name|HostAdapterStatus
expr_stmt|;
operator|*
name|LibContext
operator|->
name|TargetStatus
operator|=
name|CommandPacket
operator|->
name|TargetStatus
expr_stmt|;
if|if
condition|(
name|CommandPacket
operator|->
name|InDataBuffer
operator|!=
name|NULL
condition|)
block|{
operator|*
name|LibContext
operator|->
name|DataLength
operator|=
name|CommandPacket
operator|->
name|InTransferLength
expr_stmt|;
block|}
else|else
block|{
operator|*
name|LibContext
operator|->
name|DataLength
operator|=
name|CommandPacket
operator|->
name|OutTransferLength
expr_stmt|;
block|}
if|if
condition|(
name|CommandPacket
operator|->
name|Cdb
operator|!=
name|NULL
condition|)
block|{
name|FreePool
argument_list|(
name|CommandPacket
operator|->
name|Cdb
argument_list|)
expr_stmt|;
block|}
name|FreePool
argument_list|(
name|Context
argument_list|)
expr_stmt|;
name|gBS
operator|->
name|CloseEvent
argument_list|(
name|Event
argument_list|)
expr_stmt|;
name|gBS
operator|->
name|SignalEvent
argument_list|(
name|CallerEvent
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**   Execute blocking/non-blocking Read(10) SCSI command on a specific SCSI   target.    Executes the SCSI Read(10) command on the SCSI target specified by ScsiIo.   When Event is NULL, blocking command will be executed. Otherwise non-blocking   command will be executed.   For blocking I/O, if Timeout is zero, this function will wait indefinitely   for the command to complete. If Timeout is greater than zero, then the   command is executed and will timeout after Timeout 100 ns units.   For non-blocking I/O, if Timeout is zero, Event will be signaled only after   the command to completes. If Timeout is greater than zero, Event will also be   signaled after Timeout 100 ns units.   The StartLba and SectorSize parameters are used to construct the CDB for this   SCSI command.    If ScsiIo is NULL, then ASSERT().   If SenseDataLength is NULL, then ASSERT().   If HostAdapterStatus is NULL, then ASSERT().   If TargetStatus is NULL, then ASSERT().   If DataLength is NULL, then ASSERT().    If SenseDataLength is non-zero and SenseData is not NULL, SenseData must meet   buffer alignment requirement defined in EFI_SCSI_IO_PROTOCOL. Otherwise   EFI_INVALID_PARAMETER gets returned.    If DataLength is non-zero and DataBuffer is not NULL, DataBuffer must meet   buffer alignment requirement defined in EFI_SCSI_IO_PROTOCOL. Otherwise   EFI_INVALID_PARAMETER gets returned.    @param[in]      ScsiIo               A pointer to SCSI IO protocol.   @param[in]      Timeout              The length of timeout period.   @param[in, out] SenseData            A pointer to output sense data.   @param[in, out] SenseDataLength      The length of output sense data.   @param[out]     HostAdapterStatus    The status of Host Adapter.   @param[out]     TargetStatus         The status of the target.   @param[in, out] DataBuffer           Read 16 command data.   @param[in, out] DataLength           The length of data buffer.   @param[in]      StartLba             The start address of LBA.   @param[in]      SectorSize           The number of contiguous logical blocks                                        of data that shall be transferred.   @param[in]      Event                If the SCSI target does not support                                        non-blocking I/O, then Event is ignored,                                        and blocking I/O is performed. If Event                                        is NULL, then blocking I/O is performed.                                        If Event is not NULL and non-blocking                                        I/O is supported, then non-blocking I/O                                        is performed, and Event will be signaled                                        when the SCSI Read(10) command                                        completes.    @retval  EFI_SUCCESS                 Command is executed successfully.   @retval  EFI_BAD_BUFFER_SIZE         The SCSI Request Packet was executed,                                        but the entire DataBuffer could not be                                        transferred. The actual number of bytes                                        transferred is returned in DataLength.   @retval  EFI_NOT_READY               The SCSI Request Packet could not be                                        sent because there are too many SCSI                                        Command Packets already queued.   @retval  EFI_DEVICE_ERROR            A device error occurred while attempting                                        to send SCSI Request Packet.   @retval  EFI_UNSUPPORTED             The command described by the SCSI                                        Request Packet is not supported by the                                        SCSI initiator(i.e., SCSI  Host                                        Controller)   @retval  EFI_TIMEOUT                 A timeout occurred while waiting for the                                        SCSI Request Packet to execute.   @retval  EFI_INVALID_PARAMETER       The contents of the SCSI Request Packet                                        are invalid.   @retval  EFI_OUT_OF_RESOURCES        The request could not be completed due                                        to a lack of resources.  **/
end_comment

begin_function
name|EFI_STATUS
name|EFIAPI
name|ScsiRead10CommandEx
parameter_list|(
name|IN
name|EFI_SCSI_IO_PROTOCOL
modifier|*
name|ScsiIo
parameter_list|,
name|IN
name|UINT64
name|Timeout
parameter_list|,
name|IN
name|OUT
name|VOID
modifier|*
name|SenseData
parameter_list|,
name|OPTIONAL
name|IN
name|OUT
name|UINT8
modifier|*
name|SenseDataLength
parameter_list|,
name|OUT
name|UINT8
modifier|*
name|HostAdapterStatus
parameter_list|,
name|OUT
name|UINT8
modifier|*
name|TargetStatus
parameter_list|,
name|IN
name|OUT
name|VOID
modifier|*
name|DataBuffer
parameter_list|,
name|OPTIONAL
name|IN
name|OUT
name|UINT32
modifier|*
name|DataLength
parameter_list|,
name|IN
name|UINT32
name|StartLba
parameter_list|,
name|IN
name|UINT32
name|SectorSize
parameter_list|,
name|IN
name|EFI_EVENT
name|Event
name|OPTIONAL
parameter_list|)
block|{
name|EFI_SCSI_LIB_ASYNC_CONTEXT
modifier|*
name|Context
decl_stmt|;
name|EFI_SCSI_IO_SCSI_REQUEST_PACKET
modifier|*
name|CommandPacket
decl_stmt|;
name|EFI_STATUS
name|Status
decl_stmt|;
name|UINT8
modifier|*
name|Cdb
decl_stmt|;
name|EFI_EVENT
name|SelfEvent
decl_stmt|;
if|if
condition|(
name|Event
operator|==
name|NULL
condition|)
block|{
return|return
name|ScsiRead10Command
argument_list|(
name|ScsiIo
argument_list|,
name|Timeout
argument_list|,
name|SenseData
argument_list|,
name|SenseDataLength
argument_list|,
name|HostAdapterStatus
argument_list|,
name|TargetStatus
argument_list|,
name|DataBuffer
argument_list|,
name|DataLength
argument_list|,
name|StartLba
argument_list|,
name|SectorSize
argument_list|)
return|;
block|}
name|ASSERT
argument_list|(
name|SenseDataLength
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|HostAdapterStatus
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|TargetStatus
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|DataLength
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|ScsiIo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|Context
operator|=
name|AllocateZeroPool
argument_list|(
sizeof|sizeof
argument_list|(
name|EFI_SCSI_LIB_ASYNC_CONTEXT
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|Context
operator|==
name|NULL
condition|)
block|{
return|return
name|EFI_OUT_OF_RESOURCES
return|;
block|}
name|Cdb
operator|=
name|AllocateZeroPool
argument_list|(
name|EFI_SCSI_OP_LENGTH_TEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|Cdb
operator|==
name|NULL
condition|)
block|{
name|Status
operator|=
name|EFI_OUT_OF_RESOURCES
expr_stmt|;
goto|goto
name|ErrorExit
goto|;
block|}
name|Context
operator|->
name|SenseDataLength
operator|=
name|SenseDataLength
expr_stmt|;
name|Context
operator|->
name|HostAdapterStatus
operator|=
name|HostAdapterStatus
expr_stmt|;
name|Context
operator|->
name|TargetStatus
operator|=
name|TargetStatus
expr_stmt|;
name|Context
operator|->
name|CallerEvent
operator|=
name|Event
expr_stmt|;
name|CommandPacket
operator|=
operator|&
name|Context
operator|->
name|CommandPacket
expr_stmt|;
name|CommandPacket
operator|->
name|Timeout
operator|=
name|Timeout
expr_stmt|;
name|CommandPacket
operator|->
name|InDataBuffer
operator|=
name|DataBuffer
expr_stmt|;
name|CommandPacket
operator|->
name|SenseData
operator|=
name|SenseData
expr_stmt|;
name|CommandPacket
operator|->
name|InTransferLength
operator|=
operator|*
name|DataLength
expr_stmt|;
name|CommandPacket
operator|->
name|Cdb
operator|=
name|Cdb
expr_stmt|;
comment|//
comment|// Fill Cdb for Read (10) Command
comment|//
name|Cdb
index|[
literal|0
index|]
operator|=
name|EFI_SCSI_OP_READ10
expr_stmt|;
name|WriteUnaligned32
argument_list|(
operator|(
name|UINT32
operator|*
operator|)
operator|&
name|Cdb
index|[
literal|2
index|]
argument_list|,
name|SwapBytes32
argument_list|(
name|StartLba
argument_list|)
argument_list|)
expr_stmt|;
name|WriteUnaligned16
argument_list|(
operator|(
name|UINT16
operator|*
operator|)
operator|&
name|Cdb
index|[
literal|7
index|]
argument_list|,
name|SwapBytes16
argument_list|(
operator|(
name|UINT16
operator|)
name|SectorSize
argument_list|)
argument_list|)
expr_stmt|;
name|CommandPacket
operator|->
name|CdbLength
operator|=
name|EFI_SCSI_OP_LENGTH_TEN
expr_stmt|;
name|CommandPacket
operator|->
name|DataDirection
operator|=
name|EFI_SCSI_DATA_IN
expr_stmt|;
name|CommandPacket
operator|->
name|SenseDataLength
operator|=
operator|*
name|SenseDataLength
expr_stmt|;
comment|//
comment|// Create Event
comment|//
name|Status
operator|=
name|gBS
operator|->
name|CreateEvent
argument_list|(
name|EVT_NOTIFY_SIGNAL
argument_list|,
name|TPL_NOTIFY
argument_list|,
name|ScsiLibNotify
argument_list|,
name|Context
argument_list|,
operator|&
name|SelfEvent
argument_list|)
expr_stmt|;
if|if
condition|(
name|EFI_ERROR
argument_list|(
name|Status
argument_list|)
condition|)
block|{
goto|goto
name|ErrorExit
goto|;
block|}
name|Status
operator|=
name|ScsiIo
operator|->
name|ExecuteScsiCommand
argument_list|(
name|ScsiIo
argument_list|,
name|CommandPacket
argument_list|,
name|SelfEvent
argument_list|)
expr_stmt|;
if|if
condition|(
name|EFI_ERROR
argument_list|(
name|Status
argument_list|)
condition|)
block|{
comment|//
comment|// Since ScsiLibNotify() will not be signaled if ExecuteScsiCommand()
comment|// returns with error, close the event here.
comment|//
name|gBS
operator|->
name|CloseEvent
argument_list|(
name|SelfEvent
argument_list|)
expr_stmt|;
goto|goto
name|ErrorExit
goto|;
block|}
else|else
block|{
return|return
name|EFI_SUCCESS
return|;
block|}
name|ErrorExit
label|:
if|if
condition|(
name|Context
operator|!=
name|NULL
condition|)
block|{
name|FreePool
argument_list|(
name|Context
argument_list|)
expr_stmt|;
block|}
return|return
name|Status
return|;
block|}
end_function

begin_comment
comment|/**   Execute blocking/non-blocking Write(10) SCSI command on a specific SCSI   target.    Executes the SCSI Write(10) command on the SCSI target specified by ScsiIo.   When Event is NULL, blocking command will be executed. Otherwise non-blocking   command will be executed.   For blocking I/O, if Timeout is zero, this function will wait indefinitely   for the command to complete. If Timeout is greater than zero, then the   command is executed and will timeout after Timeout 100 ns units.   For non-blocking I/O, if Timeout is zero, Event will be signaled only after   the command to completes. If Timeout is greater than zero, Event will also be   signaled after Timeout 100 ns units.   The StartLba and SectorSize parameters are used to construct the CDB for this   SCSI command.    If ScsiIo is NULL, then ASSERT().   If SenseDataLength is NULL, then ASSERT().   If HostAdapterStatus is NULL, then ASSERT().   If TargetStatus is NULL, then ASSERT().   If DataLength is NULL, then ASSERT().    If SenseDataLength is non-zero and SenseData is not NULL, SenseData must meet   buffer alignment requirement defined in EFI_SCSI_IO_PROTOCOL. Otherwise   EFI_INVALID_PARAMETER gets returned.    If DataLength is non-zero and DataBuffer is not NULL, DataBuffer must meet   buffer alignment requirement defined in EFI_SCSI_IO_PROTOCOL. Otherwise   EFI_INVALID_PARAMETER gets returned.    @param[in]      ScsiIo               SCSI IO Protocol to use   @param[in]      Timeout              The length of timeout period.   @param[in, out] SenseData            A pointer to output sense data.   @param[in, out] SenseDataLength      The length of output sense data.   @param[out]     HostAdapterStatus    The status of Host Adapter.   @param[out]     TargetStatus         The status of the target.   @param[in, out] DataBuffer           A pointer to a data buffer.   @param[in, out] DataLength           The length of data buffer.   @param[in]      StartLba             The start address of LBA.   @param[in]      SectorSize           The number of contiguous logical blocks                                        of data that shall be transferred.   @param[in]      Event                If the SCSI target does not support                                        non-blocking I/O, then Event is ignored,                                        and blocking I/O is performed. If Event                                        is NULL, then blocking I/O is performed.                                        If Event is not NULL and non-blocking                                        I/O is supported, then non-blocking I/O                                        is performed, and Event will be signaled                                        when the SCSI Write(10) command                                        completes.    @retval  EFI_SUCCESS                 Command is executed successfully.   @retval  EFI_BAD_BUFFER_SIZE         The SCSI Request Packet was executed,                                        but the entire DataBuffer could not be                                        transferred. The actual number of bytes                                        transferred is returned in DataLength.   @retval  EFI_NOT_READY               The SCSI Request Packet could not be                                        sent because there are too many SCSI                                        Command Packets already queued.   @retval  EFI_DEVICE_ERROR            A device error occurred while attempting                                        to send SCSI Request Packet.   @retval  EFI_UNSUPPORTED             The command described by the SCSI                                        Request Packet is not supported by the                                        SCSI initiator(i.e., SCSI  Host                                        Controller)   @retval  EFI_TIMEOUT                 A timeout occurred while waiting for the                                        SCSI Request Packet to execute.   @retval  EFI_INVALID_PARAMETER       The contents of the SCSI Request Packet                                        are invalid.   @retval  EFI_OUT_OF_RESOURCES        The request could not be completed due                                        to a lack of resources.  **/
end_comment

begin_function
name|EFI_STATUS
name|EFIAPI
name|ScsiWrite10CommandEx
parameter_list|(
name|IN
name|EFI_SCSI_IO_PROTOCOL
modifier|*
name|ScsiIo
parameter_list|,
name|IN
name|UINT64
name|Timeout
parameter_list|,
name|IN
name|OUT
name|VOID
modifier|*
name|SenseData
parameter_list|,
name|OPTIONAL
name|IN
name|OUT
name|UINT8
modifier|*
name|SenseDataLength
parameter_list|,
name|OUT
name|UINT8
modifier|*
name|HostAdapterStatus
parameter_list|,
name|OUT
name|UINT8
modifier|*
name|TargetStatus
parameter_list|,
name|IN
name|OUT
name|VOID
modifier|*
name|DataBuffer
parameter_list|,
name|OPTIONAL
name|IN
name|OUT
name|UINT32
modifier|*
name|DataLength
parameter_list|,
name|IN
name|UINT32
name|StartLba
parameter_list|,
name|IN
name|UINT32
name|SectorSize
parameter_list|,
name|IN
name|EFI_EVENT
name|Event
name|OPTIONAL
parameter_list|)
block|{
name|EFI_SCSI_LIB_ASYNC_CONTEXT
modifier|*
name|Context
decl_stmt|;
name|EFI_SCSI_IO_SCSI_REQUEST_PACKET
modifier|*
name|CommandPacket
decl_stmt|;
name|EFI_STATUS
name|Status
decl_stmt|;
name|UINT8
modifier|*
name|Cdb
decl_stmt|;
name|EFI_EVENT
name|SelfEvent
decl_stmt|;
if|if
condition|(
name|Event
operator|==
name|NULL
condition|)
block|{
return|return
name|ScsiWrite10Command
argument_list|(
name|ScsiIo
argument_list|,
name|Timeout
argument_list|,
name|SenseData
argument_list|,
name|SenseDataLength
argument_list|,
name|HostAdapterStatus
argument_list|,
name|TargetStatus
argument_list|,
name|DataBuffer
argument_list|,
name|DataLength
argument_list|,
name|StartLba
argument_list|,
name|SectorSize
argument_list|)
return|;
block|}
name|ASSERT
argument_list|(
name|SenseDataLength
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|HostAdapterStatus
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|TargetStatus
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|DataLength
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|ScsiIo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|Context
operator|=
name|AllocateZeroPool
argument_list|(
sizeof|sizeof
argument_list|(
name|EFI_SCSI_LIB_ASYNC_CONTEXT
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|Context
operator|==
name|NULL
condition|)
block|{
return|return
name|EFI_OUT_OF_RESOURCES
return|;
block|}
name|Cdb
operator|=
name|AllocateZeroPool
argument_list|(
name|EFI_SCSI_OP_LENGTH_TEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|Cdb
operator|==
name|NULL
condition|)
block|{
name|Status
operator|=
name|EFI_OUT_OF_RESOURCES
expr_stmt|;
goto|goto
name|ErrorExit
goto|;
block|}
name|Context
operator|->
name|SenseDataLength
operator|=
name|SenseDataLength
expr_stmt|;
name|Context
operator|->
name|HostAdapterStatus
operator|=
name|HostAdapterStatus
expr_stmt|;
name|Context
operator|->
name|TargetStatus
operator|=
name|TargetStatus
expr_stmt|;
name|Context
operator|->
name|CallerEvent
operator|=
name|Event
expr_stmt|;
name|CommandPacket
operator|=
operator|&
name|Context
operator|->
name|CommandPacket
expr_stmt|;
name|CommandPacket
operator|->
name|Timeout
operator|=
name|Timeout
expr_stmt|;
name|CommandPacket
operator|->
name|OutDataBuffer
operator|=
name|DataBuffer
expr_stmt|;
name|CommandPacket
operator|->
name|SenseData
operator|=
name|SenseData
expr_stmt|;
name|CommandPacket
operator|->
name|OutTransferLength
operator|=
operator|*
name|DataLength
expr_stmt|;
name|CommandPacket
operator|->
name|Cdb
operator|=
name|Cdb
expr_stmt|;
comment|//
comment|// Fill Cdb for Write (10) Command
comment|//
name|Cdb
index|[
literal|0
index|]
operator|=
name|EFI_SCSI_OP_WRITE10
expr_stmt|;
name|WriteUnaligned32
argument_list|(
operator|(
name|UINT32
operator|*
operator|)
operator|&
name|Cdb
index|[
literal|2
index|]
argument_list|,
name|SwapBytes32
argument_list|(
name|StartLba
argument_list|)
argument_list|)
expr_stmt|;
name|WriteUnaligned16
argument_list|(
operator|(
name|UINT16
operator|*
operator|)
operator|&
name|Cdb
index|[
literal|7
index|]
argument_list|,
name|SwapBytes16
argument_list|(
operator|(
name|UINT16
operator|)
name|SectorSize
argument_list|)
argument_list|)
expr_stmt|;
name|CommandPacket
operator|->
name|CdbLength
operator|=
name|EFI_SCSI_OP_LENGTH_TEN
expr_stmt|;
name|CommandPacket
operator|->
name|DataDirection
operator|=
name|EFI_SCSI_DATA_OUT
expr_stmt|;
name|CommandPacket
operator|->
name|SenseDataLength
operator|=
operator|*
name|SenseDataLength
expr_stmt|;
comment|//
comment|// Create Event
comment|//
name|Status
operator|=
name|gBS
operator|->
name|CreateEvent
argument_list|(
name|EVT_NOTIFY_SIGNAL
argument_list|,
name|TPL_NOTIFY
argument_list|,
name|ScsiLibNotify
argument_list|,
name|Context
argument_list|,
operator|&
name|SelfEvent
argument_list|)
expr_stmt|;
if|if
condition|(
name|EFI_ERROR
argument_list|(
name|Status
argument_list|)
condition|)
block|{
goto|goto
name|ErrorExit
goto|;
block|}
name|Status
operator|=
name|ScsiIo
operator|->
name|ExecuteScsiCommand
argument_list|(
name|ScsiIo
argument_list|,
name|CommandPacket
argument_list|,
name|SelfEvent
argument_list|)
expr_stmt|;
if|if
condition|(
name|EFI_ERROR
argument_list|(
name|Status
argument_list|)
condition|)
block|{
comment|//
comment|// Since ScsiLibNotify() will not be signaled if ExecuteScsiCommand()
comment|// returns with error, close the event here.
comment|//
name|gBS
operator|->
name|CloseEvent
argument_list|(
name|SelfEvent
argument_list|)
expr_stmt|;
goto|goto
name|ErrorExit
goto|;
block|}
else|else
block|{
return|return
name|EFI_SUCCESS
return|;
block|}
name|ErrorExit
label|:
if|if
condition|(
name|Context
operator|!=
name|NULL
condition|)
block|{
name|FreePool
argument_list|(
name|Context
argument_list|)
expr_stmt|;
block|}
return|return
name|Status
return|;
block|}
end_function

begin_comment
comment|/**   Execute blocking/non-blocking Read(16) SCSI command on a specific SCSI   target.    Executes the SCSI Read(16) command on the SCSI target specified by ScsiIo.   When Event is NULL, blocking command will be executed. Otherwise non-blocking   command will be executed.   For blocking I/O, if Timeout is zero, this function will wait indefinitely   for the command to complete. If Timeout is greater than zero, then the   command is executed and will timeout after Timeout 100 ns units.   For non-blocking I/O, if Timeout is zero, Event will be signaled only after   the command to completes. If Timeout is greater than zero, Event will also be   signaled after Timeout 100 ns units.   The StartLba and SectorSize parameters are used to construct the CDB for this   SCSI command.    If ScsiIo is NULL, then ASSERT().   If SenseDataLength is NULL, then ASSERT().   If HostAdapterStatus is NULL, then ASSERT().   If TargetStatus is NULL, then ASSERT().   If DataLength is NULL, then ASSERT().    If SenseDataLength is non-zero and SenseData is not NULL, SenseData must meet   buffer alignment requirement defined in EFI_SCSI_IO_PROTOCOL. Otherwise   EFI_INVALID_PARAMETER gets returned.    If DataLength is non-zero and DataBuffer is not NULL, DataBuffer must meet   buffer alignment requirement defined in EFI_SCSI_IO_PROTOCOL. Otherwise   EFI_INVALID_PARAMETER gets returned.    @param[in]      ScsiIo               A pointer to SCSI IO protocol.   @param[in]      Timeout              The length of timeout period.   @param[in, out] SenseData            A pointer to output sense data.   @param[in, out] SenseDataLength      The length of output sense data.   @param[out]     HostAdapterStatus    The status of Host Adapter.   @param[out]     TargetStatus         The status of the target.   @param[in, out] DataBuffer           Read 16 command data.   @param[in, out] DataLength           The length of data buffer.   @param[in]      StartLba             The start address of LBA.   @param[in]      SectorSize           The number of contiguous logical blocks                                        of data that shall be transferred.   @param[in]      Event                If the SCSI target does not support                                        non-blocking I/O, then Event is ignored,                                        and blocking I/O is performed. If Event                                        is NULL, then blocking I/O is performed.                                        If Event is not NULL and non-blocking                                        I/O is supported, then non-blocking I/O                                        is performed, and Event will be signaled                                        when the SCSI Read(16) command                                        completes.    @retval  EFI_SUCCESS                 Command is executed successfully.   @retval  EFI_BAD_BUFFER_SIZE         The SCSI Request Packet was executed,                                        but the entire DataBuffer could not be                                        transferred. The actual number of bytes                                        transferred is returned in DataLength.   @retval  EFI_NOT_READY               The SCSI Request Packet could not be                                        sent because there are too many SCSI                                        Command Packets already queued.   @retval  EFI_DEVICE_ERROR            A device error occurred while attempting                                        to send SCSI Request Packet.   @retval  EFI_UNSUPPORTED             The command described by the SCSI                                        Request Packet is not supported by the                                        SCSI initiator(i.e., SCSI  Host                                        Controller)   @retval  EFI_TIMEOUT                 A timeout occurred while waiting for the                                        SCSI Request Packet to execute.   @retval  EFI_INVALID_PARAMETER       The contents of the SCSI Request Packet                                        are invalid.   @retval  EFI_OUT_OF_RESOURCES        The request could not be completed due                                        to a lack of resources.  **/
end_comment

begin_function
name|EFI_STATUS
name|EFIAPI
name|ScsiRead16CommandEx
parameter_list|(
name|IN
name|EFI_SCSI_IO_PROTOCOL
modifier|*
name|ScsiIo
parameter_list|,
name|IN
name|UINT64
name|Timeout
parameter_list|,
name|IN
name|OUT
name|VOID
modifier|*
name|SenseData
parameter_list|,
name|OPTIONAL
name|IN
name|OUT
name|UINT8
modifier|*
name|SenseDataLength
parameter_list|,
name|OUT
name|UINT8
modifier|*
name|HostAdapterStatus
parameter_list|,
name|OUT
name|UINT8
modifier|*
name|TargetStatus
parameter_list|,
name|IN
name|OUT
name|VOID
modifier|*
name|DataBuffer
parameter_list|,
name|OPTIONAL
name|IN
name|OUT
name|UINT32
modifier|*
name|DataLength
parameter_list|,
name|IN
name|UINT64
name|StartLba
parameter_list|,
name|IN
name|UINT32
name|SectorSize
parameter_list|,
name|IN
name|EFI_EVENT
name|Event
name|OPTIONAL
parameter_list|)
block|{
name|EFI_SCSI_LIB_ASYNC_CONTEXT
modifier|*
name|Context
decl_stmt|;
name|EFI_SCSI_IO_SCSI_REQUEST_PACKET
modifier|*
name|CommandPacket
decl_stmt|;
name|EFI_STATUS
name|Status
decl_stmt|;
name|UINT8
modifier|*
name|Cdb
decl_stmt|;
name|EFI_EVENT
name|SelfEvent
decl_stmt|;
if|if
condition|(
name|Event
operator|==
name|NULL
condition|)
block|{
return|return
name|ScsiRead16Command
argument_list|(
name|ScsiIo
argument_list|,
name|Timeout
argument_list|,
name|SenseData
argument_list|,
name|SenseDataLength
argument_list|,
name|HostAdapterStatus
argument_list|,
name|TargetStatus
argument_list|,
name|DataBuffer
argument_list|,
name|DataLength
argument_list|,
name|StartLba
argument_list|,
name|SectorSize
argument_list|)
return|;
block|}
name|ASSERT
argument_list|(
name|SenseDataLength
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|HostAdapterStatus
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|TargetStatus
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|DataLength
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|ScsiIo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|Context
operator|=
name|AllocateZeroPool
argument_list|(
sizeof|sizeof
argument_list|(
name|EFI_SCSI_LIB_ASYNC_CONTEXT
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|Context
operator|==
name|NULL
condition|)
block|{
return|return
name|EFI_OUT_OF_RESOURCES
return|;
block|}
name|Cdb
operator|=
name|AllocateZeroPool
argument_list|(
name|EFI_SCSI_OP_LENGTH_SIXTEEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|Cdb
operator|==
name|NULL
condition|)
block|{
name|Status
operator|=
name|EFI_OUT_OF_RESOURCES
expr_stmt|;
goto|goto
name|ErrorExit
goto|;
block|}
name|Context
operator|->
name|SenseDataLength
operator|=
name|SenseDataLength
expr_stmt|;
name|Context
operator|->
name|HostAdapterStatus
operator|=
name|HostAdapterStatus
expr_stmt|;
name|Context
operator|->
name|TargetStatus
operator|=
name|TargetStatus
expr_stmt|;
name|Context
operator|->
name|CallerEvent
operator|=
name|Event
expr_stmt|;
name|CommandPacket
operator|=
operator|&
name|Context
operator|->
name|CommandPacket
expr_stmt|;
name|CommandPacket
operator|->
name|Timeout
operator|=
name|Timeout
expr_stmt|;
name|CommandPacket
operator|->
name|InDataBuffer
operator|=
name|DataBuffer
expr_stmt|;
name|CommandPacket
operator|->
name|SenseData
operator|=
name|SenseData
expr_stmt|;
name|CommandPacket
operator|->
name|InTransferLength
operator|=
operator|*
name|DataLength
expr_stmt|;
name|CommandPacket
operator|->
name|Cdb
operator|=
name|Cdb
expr_stmt|;
comment|//
comment|// Fill Cdb for Read (16) Command
comment|//
name|Cdb
index|[
literal|0
index|]
operator|=
name|EFI_SCSI_OP_READ16
expr_stmt|;
name|WriteUnaligned64
argument_list|(
operator|(
name|UINT64
operator|*
operator|)
operator|&
name|Cdb
index|[
literal|2
index|]
argument_list|,
name|SwapBytes64
argument_list|(
name|StartLba
argument_list|)
argument_list|)
expr_stmt|;
name|WriteUnaligned32
argument_list|(
operator|(
name|UINT32
operator|*
operator|)
operator|&
name|Cdb
index|[
literal|10
index|]
argument_list|,
name|SwapBytes32
argument_list|(
name|SectorSize
argument_list|)
argument_list|)
expr_stmt|;
name|CommandPacket
operator|->
name|CdbLength
operator|=
name|EFI_SCSI_OP_LENGTH_SIXTEEN
expr_stmt|;
name|CommandPacket
operator|->
name|DataDirection
operator|=
name|EFI_SCSI_DATA_IN
expr_stmt|;
name|CommandPacket
operator|->
name|SenseDataLength
operator|=
operator|*
name|SenseDataLength
expr_stmt|;
comment|//
comment|// Create Event
comment|//
name|Status
operator|=
name|gBS
operator|->
name|CreateEvent
argument_list|(
name|EVT_NOTIFY_SIGNAL
argument_list|,
name|TPL_NOTIFY
argument_list|,
name|ScsiLibNotify
argument_list|,
name|Context
argument_list|,
operator|&
name|SelfEvent
argument_list|)
expr_stmt|;
if|if
condition|(
name|EFI_ERROR
argument_list|(
name|Status
argument_list|)
condition|)
block|{
goto|goto
name|ErrorExit
goto|;
block|}
name|Status
operator|=
name|ScsiIo
operator|->
name|ExecuteScsiCommand
argument_list|(
name|ScsiIo
argument_list|,
name|CommandPacket
argument_list|,
name|SelfEvent
argument_list|)
expr_stmt|;
if|if
condition|(
name|EFI_ERROR
argument_list|(
name|Status
argument_list|)
condition|)
block|{
comment|//
comment|// Since ScsiLibNotify() will not be signaled if ExecuteScsiCommand()
comment|// returns with error, close the event here.
comment|//
name|gBS
operator|->
name|CloseEvent
argument_list|(
name|SelfEvent
argument_list|)
expr_stmt|;
goto|goto
name|ErrorExit
goto|;
block|}
else|else
block|{
return|return
name|EFI_SUCCESS
return|;
block|}
name|ErrorExit
label|:
if|if
condition|(
name|Context
operator|!=
name|NULL
condition|)
block|{
name|FreePool
argument_list|(
name|Context
argument_list|)
expr_stmt|;
block|}
return|return
name|Status
return|;
block|}
end_function

begin_comment
comment|/**   Execute blocking/non-blocking Write(16) SCSI command on a specific SCSI   target.    Executes the SCSI Write(16) command on the SCSI target specified by ScsiIo.   When Event is NULL, blocking command will be executed. Otherwise non-blocking   command will be executed.   For blocking I/O, if Timeout is zero, this function will wait indefinitely   for the command to complete. If Timeout is greater than zero, then the   command is executed and will timeout after Timeout 100 ns units.   For non-blocking I/O, if Timeout is zero, Event will be signaled only after   the command to completes. If Timeout is greater than zero, Event will also be   signaled after Timeout 100 ns units.   The StartLba and SectorSize parameters are used to construct the CDB for this   SCSI command.    If ScsiIo is NULL, then ASSERT().   If SenseDataLength is NULL, then ASSERT().   If HostAdapterStatus is NULL, then ASSERT().   If TargetStatus is NULL, then ASSERT().   If DataLength is NULL, then ASSERT().    If SenseDataLength is non-zero and SenseData is not NULL, SenseData must meet   buffer alignment requirement defined in EFI_SCSI_IO_PROTOCOL. Otherwise   EFI_INVALID_PARAMETER gets returned.    If DataLength is non-zero and DataBuffer is not NULL, DataBuffer must meet   buffer alignment requirement defined in EFI_SCSI_IO_PROTOCOL. Otherwise   EFI_INVALID_PARAMETER gets returned.    @param[in]      ScsiIo               SCSI IO Protocol to use   @param[in]      Timeout              The length of timeout period.   @param[in, out] SenseData            A pointer to output sense data.   @param[in, out] SenseDataLength      The length of output sense data.   @param[out]     HostAdapterStatus    The status of Host Adapter.   @param[out]     TargetStatus         The status of the target.   @param[in, out] DataBuffer           A pointer to a data buffer.   @param[in, out] DataLength           The length of data buffer.   @param[in]      StartLba             The start address of LBA.   @param[in]      SectorSize           The number of contiguous logical blocks                                        of data that shall be transferred.   @param[in]      Event                If the SCSI target does not support                                        non-blocking I/O, then Event is ignored,                                        and blocking I/O is performed. If Event                                        is NULL, then blocking I/O is performed.                                        If Event is not NULL and non-blocking                                        I/O is supported, then non-blocking I/O                                        is performed, and Event will be signaled                                        when the SCSI Write(16) command                                        completes.    @retval  EFI_SUCCESS                 Command is executed successfully.   @retval  EFI_BAD_BUFFER_SIZE         The SCSI Request Packet was executed,                                        but the entire DataBuffer could not be                                        transferred. The actual number of bytes                                        transferred is returned in DataLength.   @retval  EFI_NOT_READY               The SCSI Request Packet could not be                                        sent because there are too many SCSI                                        Command Packets already queued.   @retval  EFI_DEVICE_ERROR            A device error occurred while attempting                                        to send SCSI Request Packet.   @retval  EFI_UNSUPPORTED             The command described by the SCSI                                        Request Packet is not supported by the                                        SCSI initiator(i.e., SCSI  Host                                        Controller)   @retval  EFI_TIMEOUT                 A timeout occurred while waiting for the                                        SCSI Request Packet to execute.   @retval  EFI_INVALID_PARAMETER       The contents of the SCSI Request Packet                                        are invalid.   @retval  EFI_OUT_OF_RESOURCES        The request could not be completed due                                        to a lack of resources.  **/
end_comment

begin_function
name|EFI_STATUS
name|EFIAPI
name|ScsiWrite16CommandEx
parameter_list|(
name|IN
name|EFI_SCSI_IO_PROTOCOL
modifier|*
name|ScsiIo
parameter_list|,
name|IN
name|UINT64
name|Timeout
parameter_list|,
name|IN
name|OUT
name|VOID
modifier|*
name|SenseData
parameter_list|,
name|OPTIONAL
name|IN
name|OUT
name|UINT8
modifier|*
name|SenseDataLength
parameter_list|,
name|OUT
name|UINT8
modifier|*
name|HostAdapterStatus
parameter_list|,
name|OUT
name|UINT8
modifier|*
name|TargetStatus
parameter_list|,
name|IN
name|OUT
name|VOID
modifier|*
name|DataBuffer
parameter_list|,
name|OPTIONAL
name|IN
name|OUT
name|UINT32
modifier|*
name|DataLength
parameter_list|,
name|IN
name|UINT64
name|StartLba
parameter_list|,
name|IN
name|UINT32
name|SectorSize
parameter_list|,
name|IN
name|EFI_EVENT
name|Event
name|OPTIONAL
parameter_list|)
block|{
name|EFI_SCSI_LIB_ASYNC_CONTEXT
modifier|*
name|Context
decl_stmt|;
name|EFI_SCSI_IO_SCSI_REQUEST_PACKET
modifier|*
name|CommandPacket
decl_stmt|;
name|EFI_STATUS
name|Status
decl_stmt|;
name|UINT8
modifier|*
name|Cdb
decl_stmt|;
name|EFI_EVENT
name|SelfEvent
decl_stmt|;
if|if
condition|(
name|Event
operator|==
name|NULL
condition|)
block|{
return|return
name|ScsiWrite16Command
argument_list|(
name|ScsiIo
argument_list|,
name|Timeout
argument_list|,
name|SenseData
argument_list|,
name|SenseDataLength
argument_list|,
name|HostAdapterStatus
argument_list|,
name|TargetStatus
argument_list|,
name|DataBuffer
argument_list|,
name|DataLength
argument_list|,
name|StartLba
argument_list|,
name|SectorSize
argument_list|)
return|;
block|}
name|ASSERT
argument_list|(
name|SenseDataLength
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|HostAdapterStatus
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|TargetStatus
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|DataLength
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|ScsiIo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|Context
operator|=
name|AllocateZeroPool
argument_list|(
sizeof|sizeof
argument_list|(
name|EFI_SCSI_LIB_ASYNC_CONTEXT
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|Context
operator|==
name|NULL
condition|)
block|{
return|return
name|EFI_OUT_OF_RESOURCES
return|;
block|}
name|Cdb
operator|=
name|AllocateZeroPool
argument_list|(
name|EFI_SCSI_OP_LENGTH_SIXTEEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|Cdb
operator|==
name|NULL
condition|)
block|{
name|Status
operator|=
name|EFI_OUT_OF_RESOURCES
expr_stmt|;
goto|goto
name|ErrorExit
goto|;
block|}
name|Context
operator|->
name|SenseDataLength
operator|=
name|SenseDataLength
expr_stmt|;
name|Context
operator|->
name|HostAdapterStatus
operator|=
name|HostAdapterStatus
expr_stmt|;
name|Context
operator|->
name|TargetStatus
operator|=
name|TargetStatus
expr_stmt|;
name|Context
operator|->
name|CallerEvent
operator|=
name|Event
expr_stmt|;
name|CommandPacket
operator|=
operator|&
name|Context
operator|->
name|CommandPacket
expr_stmt|;
name|CommandPacket
operator|->
name|Timeout
operator|=
name|Timeout
expr_stmt|;
name|CommandPacket
operator|->
name|OutDataBuffer
operator|=
name|DataBuffer
expr_stmt|;
name|CommandPacket
operator|->
name|SenseData
operator|=
name|SenseData
expr_stmt|;
name|CommandPacket
operator|->
name|OutTransferLength
operator|=
operator|*
name|DataLength
expr_stmt|;
name|CommandPacket
operator|->
name|Cdb
operator|=
name|Cdb
expr_stmt|;
comment|//
comment|// Fill Cdb for Write (16) Command
comment|//
name|Cdb
index|[
literal|0
index|]
operator|=
name|EFI_SCSI_OP_WRITE16
expr_stmt|;
name|WriteUnaligned64
argument_list|(
operator|(
name|UINT64
operator|*
operator|)
operator|&
name|Cdb
index|[
literal|2
index|]
argument_list|,
name|SwapBytes64
argument_list|(
name|StartLba
argument_list|)
argument_list|)
expr_stmt|;
name|WriteUnaligned32
argument_list|(
operator|(
name|UINT32
operator|*
operator|)
operator|&
name|Cdb
index|[
literal|10
index|]
argument_list|,
name|SwapBytes32
argument_list|(
name|SectorSize
argument_list|)
argument_list|)
expr_stmt|;
name|CommandPacket
operator|->
name|CdbLength
operator|=
name|EFI_SCSI_OP_LENGTH_SIXTEEN
expr_stmt|;
name|CommandPacket
operator|->
name|DataDirection
operator|=
name|EFI_SCSI_DATA_OUT
expr_stmt|;
name|CommandPacket
operator|->
name|SenseDataLength
operator|=
operator|*
name|SenseDataLength
expr_stmt|;
comment|//
comment|// Create Event
comment|//
name|Status
operator|=
name|gBS
operator|->
name|CreateEvent
argument_list|(
name|EVT_NOTIFY_SIGNAL
argument_list|,
name|TPL_NOTIFY
argument_list|,
name|ScsiLibNotify
argument_list|,
name|Context
argument_list|,
operator|&
name|SelfEvent
argument_list|)
expr_stmt|;
if|if
condition|(
name|EFI_ERROR
argument_list|(
name|Status
argument_list|)
condition|)
block|{
goto|goto
name|ErrorExit
goto|;
block|}
name|Status
operator|=
name|ScsiIo
operator|->
name|ExecuteScsiCommand
argument_list|(
name|ScsiIo
argument_list|,
name|CommandPacket
argument_list|,
name|SelfEvent
argument_list|)
expr_stmt|;
if|if
condition|(
name|EFI_ERROR
argument_list|(
name|Status
argument_list|)
condition|)
block|{
comment|//
comment|// Since ScsiLibNotify() will not be signaled if ExecuteScsiCommand()
comment|// returns with error, close the event here.
comment|//
name|gBS
operator|->
name|CloseEvent
argument_list|(
name|SelfEvent
argument_list|)
expr_stmt|;
goto|goto
name|ErrorExit
goto|;
block|}
else|else
block|{
return|return
name|EFI_SUCCESS
return|;
block|}
name|ErrorExit
label|:
if|if
condition|(
name|Context
operator|!=
name|NULL
condition|)
block|{
name|FreePool
argument_list|(
name|Context
argument_list|)
expr_stmt|;
block|}
return|return
name|Status
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/** @file   PCI Segment Library implementation using PCI Root Bridge I/O Protocol.    Copyright (c) 2007 - 2012, Intel Corporation. All rights reserved.<BR>   This program and the accompanying materials are   licensed and made available under the terms and conditions of   the BSD License which accompanies this distribution.  The full   text of the license may be found at   http://opensource.org/licenses/bsd-license.php.      THE PROGRAM IS DISTRIBUTED UNDER THE BSD LICENSE ON AN "AS IS" BASIS,   WITHOUT WARRANTIES OR REPRESENTATIONS OF ANY KIND, EITHER EXPRESS OR IMPLIED.  **/
end_comment

begin_include
include|#
directive|include
file|"PciSegmentLib.h"
end_include

begin_comment
comment|//
end_comment

begin_comment
comment|// Global variable to record data of PCI Root Bridge I/O Protocol instances
end_comment

begin_comment
comment|//
end_comment

begin_decl_stmt
name|PCI_ROOT_BRIDGE_DATA
modifier|*
name|mPciRootBridgeData
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|UINTN
name|mNumberOfPciRootBridges
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/**   The constructor function caches data of PCI Root Bridge I/O Protocol instances.      The constructor function locates PCI Root Bridge I/O protocol instances,   and caches the protocol instances, together with their segment numbers and bus ranges.   It will ASSERT() if that related operation fails and it will always return EFI_SUCCESS.     @param  ImageHandle   The firmware allocated handle for the EFI image.   @param  SystemTable   A pointer to the EFI System Table.      @retval EFI_SUCCESS   The constructor always returns EFI_SUCCESS.  **/
end_comment

begin_function
name|EFI_STATUS
name|EFIAPI
name|PciSegmentLibConstructor
parameter_list|(
name|IN
name|EFI_HANDLE
name|ImageHandle
parameter_list|,
name|IN
name|EFI_SYSTEM_TABLE
modifier|*
name|SystemTable
parameter_list|)
block|{
name|EFI_STATUS
name|Status
decl_stmt|;
name|UINTN
name|Index
decl_stmt|;
name|UINTN
name|HandleCount
decl_stmt|;
name|EFI_HANDLE
modifier|*
name|HandleBuffer
decl_stmt|;
name|EFI_PCI_ROOT_BRIDGE_IO_PROTOCOL
modifier|*
name|PciRootBridgeIo
decl_stmt|;
name|EFI_ACPI_ADDRESS_SPACE_DESCRIPTOR
modifier|*
name|Descriptors
decl_stmt|;
name|HandleCount
operator|=
literal|0
expr_stmt|;
name|HandleBuffer
operator|=
name|NULL
expr_stmt|;
name|PciRootBridgeIo
operator|=
name|NULL
expr_stmt|;
name|Descriptors
operator|=
name|NULL
expr_stmt|;
name|Status
operator|=
name|gBS
operator|->
name|LocateHandleBuffer
argument_list|(
name|ByProtocol
argument_list|,
operator|&
name|gEfiPciRootBridgeIoProtocolGuid
argument_list|,
name|NULL
argument_list|,
operator|&
name|HandleCount
argument_list|,
operator|&
name|HandleBuffer
argument_list|)
expr_stmt|;
name|ASSERT_EFI_ERROR
argument_list|(
name|Status
argument_list|)
expr_stmt|;
name|mNumberOfPciRootBridges
operator|=
name|HandleCount
expr_stmt|;
name|mPciRootBridgeData
operator|=
name|AllocatePool
argument_list|(
name|HandleCount
operator|*
sizeof|sizeof
argument_list|(
name|PCI_ROOT_BRIDGE_DATA
argument_list|)
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|mPciRootBridgeData
operator|!=
name|NULL
argument_list|)
expr_stmt|;
comment|//
comment|// Traverse all PCI Root Bridge I/O Protocol instances, and record the protocol
comment|// instances, together with their segment numbers and bus ranges.
comment|//
for|for
control|(
name|Index
operator|=
literal|0
init|;
name|Index
operator|<
name|HandleCount
condition|;
name|Index
operator|++
control|)
block|{
name|Status
operator|=
name|gBS
operator|->
name|HandleProtocol
argument_list|(
name|HandleBuffer
index|[
name|Index
index|]
argument_list|,
operator|&
name|gEfiPciRootBridgeIoProtocolGuid
argument_list|,
operator|(
name|VOID
operator|*
operator|*
operator|)
operator|&
name|PciRootBridgeIo
argument_list|)
expr_stmt|;
name|ASSERT_EFI_ERROR
argument_list|(
name|Status
argument_list|)
expr_stmt|;
name|mPciRootBridgeData
index|[
name|Index
index|]
operator|.
name|PciRootBridgeIo
operator|=
name|PciRootBridgeIo
expr_stmt|;
name|mPciRootBridgeData
index|[
name|Index
index|]
operator|.
name|SegmentNumber
operator|=
name|PciRootBridgeIo
operator|->
name|SegmentNumber
expr_stmt|;
name|Status
operator|=
name|PciRootBridgeIo
operator|->
name|Configuration
argument_list|(
name|PciRootBridgeIo
argument_list|,
operator|(
name|VOID
operator|*
operator|*
operator|)
operator|&
name|Descriptors
argument_list|)
expr_stmt|;
name|ASSERT_EFI_ERROR
argument_list|(
name|Status
argument_list|)
expr_stmt|;
while|while
condition|(
name|Descriptors
operator|->
name|Desc
operator|!=
name|ACPI_END_TAG_DESCRIPTOR
condition|)
block|{
if|if
condition|(
name|Descriptors
operator|->
name|ResType
operator|==
name|ACPI_ADDRESS_SPACE_TYPE_BUS
condition|)
block|{
name|mPciRootBridgeData
index|[
name|Index
index|]
operator|.
name|MinBusNumber
operator|=
name|Descriptors
operator|->
name|AddrRangeMin
expr_stmt|;
name|mPciRootBridgeData
index|[
name|Index
index|]
operator|.
name|MaxBusNumber
operator|=
name|Descriptors
operator|->
name|AddrRangeMax
expr_stmt|;
break|break;
block|}
name|Descriptors
operator|++
expr_stmt|;
block|}
name|ASSERT
argument_list|(
name|Descriptors
operator|->
name|Desc
operator|!=
name|ACPI_END_TAG_DESCRIPTOR
argument_list|)
expr_stmt|;
block|}
name|FreePool
argument_list|(
name|HandleBuffer
argument_list|)
expr_stmt|;
return|return
name|EFI_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**   The destructor function frees memory allocated by constructor.      The destructor function frees memory for data of protocol instances allocated by constructor.   It will ASSERT() if that related operation fails and it will always return EFI_SUCCESS.     @param  ImageHandle   The firmware allocated handle for the EFI image.   @param  SystemTable   A pointer to the EFI System Table.      @retval EFI_SUCCESS   The constructor always returns EFI_SUCCESS.  **/
end_comment

begin_function
name|EFI_STATUS
name|EFIAPI
name|PciSegmentLibDestructor
parameter_list|(
name|IN
name|EFI_HANDLE
name|ImageHandle
parameter_list|,
name|IN
name|EFI_SYSTEM_TABLE
modifier|*
name|SystemTable
parameter_list|)
block|{
name|FreePool
argument_list|(
name|mPciRootBridgeData
argument_list|)
expr_stmt|;
return|return
name|EFI_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**   According to address, search for the corresponding PCI Root Bridge I/O Protocol instance.    This internal function extracts segment number and bus number data from address, and   retrieves the corresponding PCI Root Bridge I/O Protocol instance.    @param  Address The address that encodes the Segment, PCI Bus, Device, Function and                   Register.    @return The address for PCI Root Bridge I/O Protocol.  **/
end_comment

begin_function
name|EFI_PCI_ROOT_BRIDGE_IO_PROTOCOL
modifier|*
name|PciSegmentLibSearchForRootBridge
parameter_list|(
name|IN
name|UINT64
name|Address
parameter_list|)
block|{
name|UINTN
name|Index
decl_stmt|;
name|UINT64
name|SegmentNumber
decl_stmt|;
name|UINT64
name|BusNumber
decl_stmt|;
for|for
control|(
name|Index
operator|=
literal|0
init|;
name|Index
operator|<
name|mNumberOfPciRootBridges
condition|;
name|Index
operator|++
control|)
block|{
comment|//
comment|// Matches segment number of address with the segment number of protocol instance.
comment|//
name|SegmentNumber
operator|=
name|BitFieldRead64
argument_list|(
name|Address
argument_list|,
literal|32
argument_list|,
literal|63
argument_list|)
expr_stmt|;
if|if
condition|(
name|SegmentNumber
operator|==
name|mPciRootBridgeData
index|[
name|Index
index|]
operator|.
name|SegmentNumber
condition|)
block|{
comment|//
comment|// Matches the bus number of address with bus number range of protocol instance.
comment|//
name|BusNumber
operator|=
name|BitFieldRead64
argument_list|(
name|Address
argument_list|,
literal|20
argument_list|,
literal|27
argument_list|)
expr_stmt|;
if|if
condition|(
name|BusNumber
operator|>=
name|mPciRootBridgeData
index|[
name|Index
index|]
operator|.
name|MinBusNumber
operator|&&
name|BusNumber
operator|<=
name|mPciRootBridgeData
index|[
name|Index
index|]
operator|.
name|MaxBusNumber
condition|)
block|{
return|return
name|mPciRootBridgeData
index|[
name|Index
index|]
operator|.
name|PciRootBridgeIo
return|;
block|}
block|}
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/**   Internal worker function to read a PCI configuration register.    This function wraps EFI_PCI_ROOT_BRIDGE_IO_PROTOCOL.Pci.Read() service.   It reads and returns the PCI configuration register specified by Address,   the width of data is specified by Width.    @param  Address The address that encodes the PCI Bus, Device, Function and                   Register.   @param  Width   Width of data to read    @return The value read from the PCI configuration register.  **/
end_comment

begin_function
name|UINT32
name|DxePciSegmentLibPciRootBridgeIoReadWorker
parameter_list|(
name|IN
name|UINT64
name|Address
parameter_list|,
name|IN
name|EFI_PCI_ROOT_BRIDGE_IO_PROTOCOL_WIDTH
name|Width
parameter_list|)
block|{
name|UINT32
name|Data
decl_stmt|;
name|EFI_PCI_ROOT_BRIDGE_IO_PROTOCOL
modifier|*
name|PciRootBridgeIo
decl_stmt|;
name|PciRootBridgeIo
operator|=
name|PciSegmentLibSearchForRootBridge
argument_list|(
name|Address
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|PciRootBridgeIo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|PciRootBridgeIo
operator|->
name|Pci
operator|.
name|Read
argument_list|(
name|PciRootBridgeIo
argument_list|,
name|Width
argument_list|,
name|PCI_TO_PCI_ROOT_BRIDGE_IO_ADDRESS
argument_list|(
name|Address
argument_list|)
argument_list|,
literal|1
argument_list|,
operator|&
name|Data
argument_list|)
expr_stmt|;
return|return
name|Data
return|;
block|}
end_function

begin_comment
comment|/**   Internal worker function to writes a PCI configuration register.    This function wraps EFI_PCI_ROOT_BRIDGE_IO_PROTOCOL.Pci.Write() service.   It writes the PCI configuration register specified by Address with the   value specified by Data. The width of data is specifed by Width.   Data is returned.    @param  Address The address that encodes the PCI Bus, Device, Function and                   Register.   @param  Width   Width of data to write   @param  Data    The value to write.    @return The value written to the PCI configuration register.  **/
end_comment

begin_function
name|UINT32
name|DxePciSegmentLibPciRootBridgeIoWriteWorker
parameter_list|(
name|IN
name|UINT64
name|Address
parameter_list|,
name|IN
name|EFI_PCI_ROOT_BRIDGE_IO_PROTOCOL_WIDTH
name|Width
parameter_list|,
name|IN
name|UINT32
name|Data
parameter_list|)
block|{
name|EFI_PCI_ROOT_BRIDGE_IO_PROTOCOL
modifier|*
name|PciRootBridgeIo
decl_stmt|;
name|PciRootBridgeIo
operator|=
name|PciSegmentLibSearchForRootBridge
argument_list|(
name|Address
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|PciRootBridgeIo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|PciRootBridgeIo
operator|->
name|Pci
operator|.
name|Write
argument_list|(
name|PciRootBridgeIo
argument_list|,
name|Width
argument_list|,
name|PCI_TO_PCI_ROOT_BRIDGE_IO_ADDRESS
argument_list|(
name|Address
argument_list|)
argument_list|,
literal|1
argument_list|,
operator|&
name|Data
argument_list|)
expr_stmt|;
return|return
name|Data
return|;
block|}
end_function

begin_comment
comment|/**   Register a PCI device so PCI configuration registers may be accessed after    SetVirtualAddressMap().      If any reserved bits in Address are set, then ASSERT().    @param  Address The address that encodes the PCI Bus, Device, Function and                   Register.      @retval RETURN_SUCCESS           The PCI device was registered for runtime access.   @retval RETURN_UNSUPPORTED       An attempt was made to call this function                                     after ExitBootServices().   @retval RETURN_UNSUPPORTED       The resources required to access the PCI device                                    at runtime could not be mapped.   @retval RETURN_OUT_OF_RESOURCES  There are not enough resources available to                                    complete the registration.  **/
end_comment

begin_function
name|RETURN_STATUS
name|EFIAPI
name|PciSegmentRegisterForRuntimeAccess
parameter_list|(
name|IN
name|UINTN
name|Address
parameter_list|)
block|{
name|ASSERT_INVALID_PCI_SEGMENT_ADDRESS
argument_list|(
name|Address
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|RETURN_UNSUPPORTED
return|;
block|}
end_function

begin_comment
comment|/**   Reads an 8-bit PCI configuration register.    Reads and returns the 8-bit PCI configuration register specified by Address.   This function must guarantee that all PCI read and write operations are serialized.      If any reserved bits in Address are set, then ASSERT().      @param  Address   The address that encodes the PCI Segment, Bus, Device, Function, and Register.    @return The 8-bit PCI configuration register specified by Address.  **/
end_comment

begin_function
name|UINT8
name|EFIAPI
name|PciSegmentRead8
parameter_list|(
name|IN
name|UINT64
name|Address
parameter_list|)
block|{
name|ASSERT_INVALID_PCI_SEGMENT_ADDRESS
argument_list|(
name|Address
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|UINT8
operator|)
name|DxePciSegmentLibPciRootBridgeIoReadWorker
argument_list|(
name|Address
argument_list|,
name|EfiPciWidthUint8
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**   Writes an 8-bit PCI configuration register.    Writes the 8-bit PCI configuration register specified by Address with the value specified by Value.   Value is returned.  This function must guarantee that all PCI read and write operations are serialized.      If any reserved bits in Address are set, then ASSERT().    @param  Address     The address that encodes the PCI Segment, Bus, Device, Function, and Register.   @param  Value       The value to write.    @return The value written to the PCI configuration register.  **/
end_comment

begin_function
name|UINT8
name|EFIAPI
name|PciSegmentWrite8
parameter_list|(
name|IN
name|UINT64
name|Address
parameter_list|,
name|IN
name|UINT8
name|Value
parameter_list|)
block|{
name|ASSERT_INVALID_PCI_SEGMENT_ADDRESS
argument_list|(
name|Address
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|UINT8
operator|)
name|DxePciSegmentLibPciRootBridgeIoWriteWorker
argument_list|(
name|Address
argument_list|,
name|EfiPciWidthUint8
argument_list|,
name|Value
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**   Performs a bitwise OR of an 8-bit PCI configuration register with an 8-bit value.    Reads the 8-bit PCI configuration register specified by Address,   performs a bitwise OR between the read result and the value specified by OrData,   and writes the result to the 8-bit PCI configuration register specified by Address.   The value written to the PCI configuration register is returned.   This function must guarantee that all PCI read and write operations are serialized.      If any reserved bits in Address are set, then ASSERT().    @param  Address   The address that encodes the PCI Segment, Bus, Device, Function, and Register.   @param  OrData    The value to OR with the PCI configuration register.    @return The value written to the PCI configuration register.  **/
end_comment

begin_function
name|UINT8
name|EFIAPI
name|PciSegmentOr8
parameter_list|(
name|IN
name|UINT64
name|Address
parameter_list|,
name|IN
name|UINT8
name|OrData
parameter_list|)
block|{
return|return
name|PciSegmentWrite8
argument_list|(
name|Address
argument_list|,
call|(
name|UINT8
call|)
argument_list|(
name|PciSegmentRead8
argument_list|(
name|Address
argument_list|)
operator||
name|OrData
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**   Performs a bitwise AND of an 8-bit PCI configuration register with an 8-bit value.    Reads the 8-bit PCI configuration register specified by Address,   performs a bitwise AND between the read result and the value specified by AndData,   and writes the result to the 8-bit PCI configuration register specified by Address.   The value written to the PCI configuration register is returned.   This function must guarantee that all PCI read and write operations are serialized.   If any reserved bits in Address are set, then ASSERT().    @param  Address   The address that encodes the PCI Segment, Bus, Device, Function, and Register.   @param  AndData   The value to AND with the PCI configuration register.    @return The value written to the PCI configuration register.  **/
end_comment

begin_function
name|UINT8
name|EFIAPI
name|PciSegmentAnd8
parameter_list|(
name|IN
name|UINT64
name|Address
parameter_list|,
name|IN
name|UINT8
name|AndData
parameter_list|)
block|{
return|return
name|PciSegmentWrite8
argument_list|(
name|Address
argument_list|,
call|(
name|UINT8
call|)
argument_list|(
name|PciSegmentRead8
argument_list|(
name|Address
argument_list|)
operator|&
name|AndData
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**   Performs a bitwise AND of an 8-bit PCI configuration register with an 8-bit value,   followed a  bitwise OR with another 8-bit value.      Reads the 8-bit PCI configuration register specified by Address,   performs a bitwise AND between the read result and the value specified by AndData,   performs a bitwise OR between the result of the AND operation and the value specified by OrData,   and writes the result to the 8-bit PCI configuration register specified by Address.   The value written to the PCI configuration register is returned.   This function must guarantee that all PCI read and write operations are serialized.      If any reserved bits in Address are set, then ASSERT().    @param  Address   The address that encodes the PCI Segment, Bus, Device, Function, and Register.   @param  AndData    The value to AND with the PCI configuration register.   @param  OrData    The value to OR with the PCI configuration register.    @return The value written to the PCI configuration register.  **/
end_comment

begin_function
name|UINT8
name|EFIAPI
name|PciSegmentAndThenOr8
parameter_list|(
name|IN
name|UINT64
name|Address
parameter_list|,
name|IN
name|UINT8
name|AndData
parameter_list|,
name|IN
name|UINT8
name|OrData
parameter_list|)
block|{
return|return
name|PciSegmentWrite8
argument_list|(
name|Address
argument_list|,
call|(
name|UINT8
call|)
argument_list|(
operator|(
name|PciSegmentRead8
argument_list|(
name|Address
argument_list|)
operator|&
name|AndData
operator|)
operator||
name|OrData
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**   Reads a bit field of a PCI configuration register.    Reads the bit field in an 8-bit PCI configuration register. The bit field is   specified by the StartBit and the EndBit. The value of the bit field is   returned.    If any reserved bits in Address are set, then ASSERT().   If StartBit is greater than 7, then ASSERT().   If EndBit is greater than 7, then ASSERT().   If EndBit is less than StartBit, then ASSERT().    @param  Address   The PCI configuration register to read.   @param  StartBit  The ordinal of the least significant bit in the bit field.                     Range 0..7.   @param  EndBit    The ordinal of the most significant bit in the bit field.                     Range 0..7.    @return The value of the bit field read from the PCI configuration register.  **/
end_comment

begin_function
name|UINT8
name|EFIAPI
name|PciSegmentBitFieldRead8
parameter_list|(
name|IN
name|UINT64
name|Address
parameter_list|,
name|IN
name|UINTN
name|StartBit
parameter_list|,
name|IN
name|UINTN
name|EndBit
parameter_list|)
block|{
return|return
name|BitFieldRead8
argument_list|(
name|PciSegmentRead8
argument_list|(
name|Address
argument_list|)
argument_list|,
name|StartBit
argument_list|,
name|EndBit
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**   Writes a bit field to a PCI configuration register.    Writes Value to the bit field of the PCI configuration register. The bit   field is specified by the StartBit and the EndBit. All other bits in the   destination PCI configuration register are preserved. The new value of the   8-bit register is returned.    If any reserved bits in Address are set, then ASSERT().   If StartBit is greater than 7, then ASSERT().   If EndBit is greater than 7, then ASSERT().   If EndBit is less than StartBit, then ASSERT().   If Value is larger than the bitmask value range specified by StartBit and EndBit, then ASSERT().    @param  Address   The PCI configuration register to write.   @param  StartBit  The ordinal of the least significant bit in the bit field.                     Range 0..7.   @param  EndBit    The ordinal of the most significant bit in the bit field.                     Range 0..7.   @param  Value     The new value of the bit field.    @return The value written back to the PCI configuration register.  **/
end_comment

begin_function
name|UINT8
name|EFIAPI
name|PciSegmentBitFieldWrite8
parameter_list|(
name|IN
name|UINT64
name|Address
parameter_list|,
name|IN
name|UINTN
name|StartBit
parameter_list|,
name|IN
name|UINTN
name|EndBit
parameter_list|,
name|IN
name|UINT8
name|Value
parameter_list|)
block|{
return|return
name|PciSegmentWrite8
argument_list|(
name|Address
argument_list|,
name|BitFieldWrite8
argument_list|(
name|PciSegmentRead8
argument_list|(
name|Address
argument_list|)
argument_list|,
name|StartBit
argument_list|,
name|EndBit
argument_list|,
name|Value
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**   Reads a bit field in an 8-bit PCI configuration, performs a bitwise OR, and   writes the result back to the bit field in the 8-bit port.    Reads the 8-bit PCI configuration register specified by Address, performs a   bitwise OR between the read result and the value specified by   OrData, and writes the result to the 8-bit PCI configuration register   specified by Address. The value written to the PCI configuration register is   returned. This function must guarantee that all PCI read and write operations   are serialized. Extra left bits in OrData are stripped.    If any reserved bits in Address are set, then ASSERT().   If StartBit is greater than 7, then ASSERT().   If EndBit is greater than 7, then ASSERT().   If EndBit is less than StartBit, then ASSERT().   If OrData is larger than the bitmask value range specified by StartBit and EndBit, then ASSERT().    @param  Address   The PCI configuration register to write.   @param  StartBit  The ordinal of the least significant bit in the bit field.                     Range 0..7.   @param  EndBit    The ordinal of the most significant bit in the bit field.                     Range 0..7.   @param  OrData    The value to OR with the PCI configuration register.    @return The value written back to the PCI configuration register.  **/
end_comment

begin_function
name|UINT8
name|EFIAPI
name|PciSegmentBitFieldOr8
parameter_list|(
name|IN
name|UINT64
name|Address
parameter_list|,
name|IN
name|UINTN
name|StartBit
parameter_list|,
name|IN
name|UINTN
name|EndBit
parameter_list|,
name|IN
name|UINT8
name|OrData
parameter_list|)
block|{
return|return
name|PciSegmentWrite8
argument_list|(
name|Address
argument_list|,
name|BitFieldOr8
argument_list|(
name|PciSegmentRead8
argument_list|(
name|Address
argument_list|)
argument_list|,
name|StartBit
argument_list|,
name|EndBit
argument_list|,
name|OrData
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**   Reads a bit field in an 8-bit PCI configuration register, performs a bitwise   AND, and writes the result back to the bit field in the 8-bit register.    Reads the 8-bit PCI configuration register specified by Address, performs a   bitwise AND between the read result and the value specified by AndData, and   writes the result to the 8-bit PCI configuration register specified by   Address. The value written to the PCI configuration register is returned.   This function must guarantee that all PCI read and write operations are   serialized. Extra left bits in AndData are stripped.    If any reserved bits in Address are set, then ASSERT().   If StartBit is greater than 7, then ASSERT().   If EndBit is greater than 7, then ASSERT().   If EndBit is less than StartBit, then ASSERT().   If AndData is larger than the bitmask value range specified by StartBit and EndBit, then ASSERT().    @param  Address   The PCI configuration register to write.   @param  StartBit  The ordinal of the least significant bit in the bit field.                     Range 0..7.   @param  EndBit    The ordinal of the most significant bit in the bit field.                     Range 0..7.   @param  AndData   The value to AND with the PCI configuration register.    @return The value written back to the PCI configuration register.  **/
end_comment

begin_function
name|UINT8
name|EFIAPI
name|PciSegmentBitFieldAnd8
parameter_list|(
name|IN
name|UINT64
name|Address
parameter_list|,
name|IN
name|UINTN
name|StartBit
parameter_list|,
name|IN
name|UINTN
name|EndBit
parameter_list|,
name|IN
name|UINT8
name|AndData
parameter_list|)
block|{
return|return
name|PciSegmentWrite8
argument_list|(
name|Address
argument_list|,
name|BitFieldAnd8
argument_list|(
name|PciSegmentRead8
argument_list|(
name|Address
argument_list|)
argument_list|,
name|StartBit
argument_list|,
name|EndBit
argument_list|,
name|AndData
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**   Reads a bit field in an 8-bit port, performs a bitwise AND followed by a   bitwise OR, and writes the result back to the bit field in the   8-bit port.    Reads the 8-bit PCI configuration register specified by Address, performs a   bitwise AND followed by a bitwise OR between the read result and   the value specified by AndData, and writes the result to the 8-bit PCI   configuration register specified by Address. The value written to the PCI   configuration register is returned. This function must guarantee that all PCI   read and write operations are serialized. Extra left bits in both AndData and   OrData are stripped.    If any reserved bits in Address are set, then ASSERT().   If StartBit is greater than 7, then ASSERT().   If EndBit is greater than 7, then ASSERT().   If EndBit is less than StartBit, then ASSERT().   If AndData is larger than the bitmask value range specified by StartBit and EndBit, then ASSERT().   If OrData is larger than the bitmask value range specified by StartBit and EndBit, then ASSERT().    @param  Address   The PCI configuration register to write.   @param  StartBit  The ordinal of the least significant bit in the bit field.                     Range 0..7.   @param  EndBit    The ordinal of the most significant bit in the bit field.                     Range 0..7.   @param  AndData   The value to AND with the PCI configuration register.   @param  OrData    The value to OR with the result of the AND operation.    @return The value written back to the PCI configuration register.  **/
end_comment

begin_function
name|UINT8
name|EFIAPI
name|PciSegmentBitFieldAndThenOr8
parameter_list|(
name|IN
name|UINT64
name|Address
parameter_list|,
name|IN
name|UINTN
name|StartBit
parameter_list|,
name|IN
name|UINTN
name|EndBit
parameter_list|,
name|IN
name|UINT8
name|AndData
parameter_list|,
name|IN
name|UINT8
name|OrData
parameter_list|)
block|{
return|return
name|PciSegmentWrite8
argument_list|(
name|Address
argument_list|,
name|BitFieldAndThenOr8
argument_list|(
name|PciSegmentRead8
argument_list|(
name|Address
argument_list|)
argument_list|,
name|StartBit
argument_list|,
name|EndBit
argument_list|,
name|AndData
argument_list|,
name|OrData
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**   Reads a 16-bit PCI configuration register.    Reads and returns the 16-bit PCI configuration register specified by Address.   This function must guarantee that all PCI read and write operations are serialized.      If any reserved bits in Address are set, then ASSERT().   If Address is not aligned on a 16-bit boundary, then ASSERT().      @param  Address   The address that encodes the PCI Segment, Bus, Device, Function, and Register.    @return The 16-bit PCI configuration register specified by Address.  **/
end_comment

begin_function
name|UINT16
name|EFIAPI
name|PciSegmentRead16
parameter_list|(
name|IN
name|UINT64
name|Address
parameter_list|)
block|{
name|ASSERT_INVALID_PCI_SEGMENT_ADDRESS
argument_list|(
name|Address
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
operator|(
name|UINT16
operator|)
name|DxePciSegmentLibPciRootBridgeIoReadWorker
argument_list|(
name|Address
argument_list|,
name|EfiPciWidthUint16
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**   Writes a 16-bit PCI configuration register.    Writes the 16-bit PCI configuration register specified by Address with the value specified by Value.   Value is returned.  This function must guarantee that all PCI read and write operations are serialized.      If any reserved bits in Address are set, then ASSERT().   If Address is not aligned on a 16-bit boundary, then ASSERT().    @param  Address     The address that encodes the PCI Segment, Bus, Device, Function, and Register.   @param  Value       The value to write.    @return The parameter of Value.  **/
end_comment

begin_function
name|UINT16
name|EFIAPI
name|PciSegmentWrite16
parameter_list|(
name|IN
name|UINT64
name|Address
parameter_list|,
name|IN
name|UINT16
name|Value
parameter_list|)
block|{
name|ASSERT_INVALID_PCI_SEGMENT_ADDRESS
argument_list|(
name|Address
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
operator|(
name|UINT16
operator|)
name|DxePciSegmentLibPciRootBridgeIoWriteWorker
argument_list|(
name|Address
argument_list|,
name|EfiPciWidthUint16
argument_list|,
name|Value
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**   Performs a bitwise OR of a 16-bit PCI configuration register with   a 16-bit value.    Reads the 16-bit PCI configuration register specified by Address, performs a   bitwise OR between the read result and the value specified by   OrData, and writes the result to the 16-bit PCI configuration register   specified by Address. The value written to the PCI configuration register is   returned. This function must guarantee that all PCI read and write operations   are serialized.    If any reserved bits in Address are set, then ASSERT().   If Address is not aligned on a 16-bit boundary, then ASSERT().    @param  Address The address that encodes the PCI Segment, Bus, Device, Function and                   Register.   @param  OrData  The value to OR with the PCI configuration register.    @return The value written back to the PCI configuration register.  **/
end_comment

begin_function
name|UINT16
name|EFIAPI
name|PciSegmentOr16
parameter_list|(
name|IN
name|UINT64
name|Address
parameter_list|,
name|IN
name|UINT16
name|OrData
parameter_list|)
block|{
return|return
name|PciSegmentWrite16
argument_list|(
name|Address
argument_list|,
call|(
name|UINT16
call|)
argument_list|(
name|PciSegmentRead16
argument_list|(
name|Address
argument_list|)
operator||
name|OrData
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**   Performs a bitwise AND of a 16-bit PCI configuration register with a 16-bit value.    Reads the 16-bit PCI configuration register specified by Address,   performs a bitwise AND between the read result and the value specified by AndData,   and writes the result to the 16-bit PCI configuration register specified by Address.   The value written to the PCI configuration register is returned.   This function must guarantee that all PCI read and write operations are serialized.      If any reserved bits in Address are set, then ASSERT().   If Address is not aligned on a 16-bit boundary, then ASSERT().      @param  Address   The address that encodes the PCI Segment, Bus, Device, Function, and Register.   @param  AndData   The value to AND with the PCI configuration register.    @return The value written to the PCI configuration register.  **/
end_comment

begin_function
name|UINT16
name|EFIAPI
name|PciSegmentAnd16
parameter_list|(
name|IN
name|UINT64
name|Address
parameter_list|,
name|IN
name|UINT16
name|AndData
parameter_list|)
block|{
return|return
name|PciSegmentWrite16
argument_list|(
name|Address
argument_list|,
call|(
name|UINT16
call|)
argument_list|(
name|PciSegmentRead16
argument_list|(
name|Address
argument_list|)
operator|&
name|AndData
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**   Performs a bitwise AND of a 16-bit PCI configuration register with a 16-bit value,   followed a  bitwise OR with another 16-bit value.      Reads the 16-bit PCI configuration register specified by Address,   performs a bitwise AND between the read result and the value specified by AndData,   performs a bitwise OR between the result of the AND operation and the value specified by OrData,   and writes the result to the 16-bit PCI configuration register specified by Address.   The value written to the PCI configuration register is returned.   This function must guarantee that all PCI read and write operations are serialized.      If any reserved bits in Address are set, then ASSERT().   If Address is not aligned on a 16-bit boundary, then ASSERT().    @param  Address   The address that encodes the PCI Segment, Bus, Device, Function, and Register.   @param  AndData    The value to AND with the PCI configuration register.   @param  OrData    The value to OR with the PCI configuration register.    @return The value written to the PCI configuration register.  **/
end_comment

begin_function
name|UINT16
name|EFIAPI
name|PciSegmentAndThenOr16
parameter_list|(
name|IN
name|UINT64
name|Address
parameter_list|,
name|IN
name|UINT16
name|AndData
parameter_list|,
name|IN
name|UINT16
name|OrData
parameter_list|)
block|{
return|return
name|PciSegmentWrite16
argument_list|(
name|Address
argument_list|,
call|(
name|UINT16
call|)
argument_list|(
operator|(
name|PciSegmentRead16
argument_list|(
name|Address
argument_list|)
operator|&
name|AndData
operator|)
operator||
name|OrData
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**   Reads a bit field of a PCI configuration register.    Reads the bit field in a 16-bit PCI configuration register. The bit field is   specified by the StartBit and the EndBit. The value of the bit field is   returned.    If any reserved bits in Address are set, then ASSERT().   If Address is not aligned on a 16-bit boundary, then ASSERT().   If StartBit is greater than 15, then ASSERT().   If EndBit is greater than 15, then ASSERT().   If EndBit is less than StartBit, then ASSERT().    @param  Address   The PCI configuration register to read.   @param  StartBit  The ordinal of the least significant bit in the bit field.                     Range 0..15.   @param  EndBit    The ordinal of the most significant bit in the bit field.                     Range 0..15.    @return The value of the bit field read from the PCI configuration register.  **/
end_comment

begin_function
name|UINT16
name|EFIAPI
name|PciSegmentBitFieldRead16
parameter_list|(
name|IN
name|UINT64
name|Address
parameter_list|,
name|IN
name|UINTN
name|StartBit
parameter_list|,
name|IN
name|UINTN
name|EndBit
parameter_list|)
block|{
return|return
name|BitFieldRead16
argument_list|(
name|PciSegmentRead16
argument_list|(
name|Address
argument_list|)
argument_list|,
name|StartBit
argument_list|,
name|EndBit
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**   Writes a bit field to a PCI configuration register.    Writes Value to the bit field of the PCI configuration register. The bit   field is specified by the StartBit and the EndBit. All other bits in the   destination PCI configuration register are preserved. The new value of the   16-bit register is returned.    If any reserved bits in Address are set, then ASSERT().   If Address is not aligned on a 16-bit boundary, then ASSERT().   If StartBit is greater than 15, then ASSERT().   If EndBit is greater than 15, then ASSERT().   If EndBit is less than StartBit, then ASSERT().   If Value is larger than the bitmask value range specified by StartBit and EndBit, then ASSERT().    @param  Address   The PCI configuration register to write.   @param  StartBit  The ordinal of the least significant bit in the bit field.                     Range 0..15.   @param  EndBit    The ordinal of the most significant bit in the bit field.                     Range 0..15.   @param  Value     The new value of the bit field.    @return The value written back to the PCI configuration register.  **/
end_comment

begin_function
name|UINT16
name|EFIAPI
name|PciSegmentBitFieldWrite16
parameter_list|(
name|IN
name|UINT64
name|Address
parameter_list|,
name|IN
name|UINTN
name|StartBit
parameter_list|,
name|IN
name|UINTN
name|EndBit
parameter_list|,
name|IN
name|UINT16
name|Value
parameter_list|)
block|{
return|return
name|PciSegmentWrite16
argument_list|(
name|Address
argument_list|,
name|BitFieldWrite16
argument_list|(
name|PciSegmentRead16
argument_list|(
name|Address
argument_list|)
argument_list|,
name|StartBit
argument_list|,
name|EndBit
argument_list|,
name|Value
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**   Reads the 16-bit PCI configuration register specified by Address,   performs a bitwise OR between the read result and the value specified by OrData,   and writes the result to the 16-bit PCI configuration register specified by Address.     If any reserved bits in Address are set, then ASSERT().   If Address is not aligned on a 16-bit boundary, then ASSERT().   If StartBit is greater than 15, then ASSERT().   If EndBit is greater than 15, then ASSERT().   If EndBit is less than StartBit, then ASSERT().   If OrData is larger than the bitmask value range specified by StartBit and EndBit, then ASSERT().    @param  Address   The PCI configuration register to write.   @param  StartBit  The ordinal of the least significant bit in the bit field.                     Range 0..15.   @param  EndBit    The ordinal of the most significant bit in the bit field.                     Range 0..15.   @param  OrData    The value to OR with the PCI configuration register.    @return The value written back to the PCI configuration register.  **/
end_comment

begin_function
name|UINT16
name|EFIAPI
name|PciSegmentBitFieldOr16
parameter_list|(
name|IN
name|UINT64
name|Address
parameter_list|,
name|IN
name|UINTN
name|StartBit
parameter_list|,
name|IN
name|UINTN
name|EndBit
parameter_list|,
name|IN
name|UINT16
name|OrData
parameter_list|)
block|{
return|return
name|PciSegmentWrite16
argument_list|(
name|Address
argument_list|,
name|BitFieldOr16
argument_list|(
name|PciSegmentRead16
argument_list|(
name|Address
argument_list|)
argument_list|,
name|StartBit
argument_list|,
name|EndBit
argument_list|,
name|OrData
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**   Reads a bit field in a 16-bit PCI configuration, performs a bitwise OR,   and writes the result back to the bit field in the 16-bit port.    Reads the 16-bit PCI configuration register specified by Address,   performs a bitwise OR between the read result and the value specified by OrData,   and writes the result to the 16-bit PCI configuration register specified by Address.   The value written to the PCI configuration register is returned.   This function must guarantee that all PCI read and write operations are serialized.   Extra left bits in OrData are stripped.      If any reserved bits in Address are set, then ASSERT().   If Address is not aligned on a 16-bit boundary, then ASSERT().   If StartBit is greater than 7, then ASSERT().   If EndBit is greater than 7, then ASSERT().   If EndBit is less than StartBit, then ASSERT().   If AndData is larger than the bitmask value range specified by StartBit and EndBit, then ASSERT().    @param  Address   The address that encodes the PCI Segment, Bus, Device, Function, and Register.   @param  StartBit  The ordinal of the least significant bit in the bit field.                     The ordinal of the least significant bit in a byte is bit 0.   @param  EndBit    The ordinal of the most significant bit in the bit field.                     The ordinal of the most significant bit in a byte is bit 7.   @param  AndData   The value to AND with the read value from the PCI configuration register.    @return The value written to the PCI configuration register.  **/
end_comment

begin_function
name|UINT16
name|EFIAPI
name|PciSegmentBitFieldAnd16
parameter_list|(
name|IN
name|UINT64
name|Address
parameter_list|,
name|IN
name|UINTN
name|StartBit
parameter_list|,
name|IN
name|UINTN
name|EndBit
parameter_list|,
name|IN
name|UINT16
name|AndData
parameter_list|)
block|{
return|return
name|PciSegmentWrite16
argument_list|(
name|Address
argument_list|,
name|BitFieldAnd16
argument_list|(
name|PciSegmentRead16
argument_list|(
name|Address
argument_list|)
argument_list|,
name|StartBit
argument_list|,
name|EndBit
argument_list|,
name|AndData
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**   Reads a bit field in a 16-bit port, performs a bitwise AND followed by a   bitwise OR, and writes the result back to the bit field in the   16-bit port.    Reads the 16-bit PCI configuration register specified by Address, performs a   bitwise AND followed by a bitwise OR between the read result and   the value specified by AndData, and writes the result to the 16-bit PCI   configuration register specified by Address. The value written to the PCI   configuration register is returned. This function must guarantee that all PCI   read and write operations are serialized. Extra left bits in both AndData and   OrData are stripped.    If any reserved bits in Address are set, then ASSERT().   If StartBit is greater than 15, then ASSERT().   If EndBit is greater than 15, then ASSERT().   If EndBit is less than StartBit, then ASSERT().   If AndData is larger than the bitmask value range specified by StartBit and EndBit, then ASSERT().   If OrData is larger than the bitmask value range specified by StartBit and EndBit, then ASSERT().    @param  Address   The PCI configuration register to write.   @param  StartBit  The ordinal of the least significant bit in the bit field.                     Range 0..15.   @param  EndBit    The ordinal of the most significant bit in the bit field.                     Range 0..15.   @param  AndData   The value to AND with the PCI configuration register.   @param  OrData    The value to OR with the result of the AND operation.    @return The value written back to the PCI configuration register.  **/
end_comment

begin_function
name|UINT16
name|EFIAPI
name|PciSegmentBitFieldAndThenOr16
parameter_list|(
name|IN
name|UINT64
name|Address
parameter_list|,
name|IN
name|UINTN
name|StartBit
parameter_list|,
name|IN
name|UINTN
name|EndBit
parameter_list|,
name|IN
name|UINT16
name|AndData
parameter_list|,
name|IN
name|UINT16
name|OrData
parameter_list|)
block|{
return|return
name|PciSegmentWrite16
argument_list|(
name|Address
argument_list|,
name|BitFieldAndThenOr16
argument_list|(
name|PciSegmentRead16
argument_list|(
name|Address
argument_list|)
argument_list|,
name|StartBit
argument_list|,
name|EndBit
argument_list|,
name|AndData
argument_list|,
name|OrData
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**   Reads a 32-bit PCI configuration register.    Reads and returns the 32-bit PCI configuration register specified by Address.   This function must guarantee that all PCI read and write operations are serialized.      If any reserved bits in Address are set, then ASSERT().   If Address is not aligned on a 32-bit boundary, then ASSERT().    @param  Address   The address that encodes the PCI Segment, Bus, Device, Function, and Register.    @return The 32-bit PCI configuration register specified by Address.  **/
end_comment

begin_function
name|UINT32
name|EFIAPI
name|PciSegmentRead32
parameter_list|(
name|IN
name|UINT64
name|Address
parameter_list|)
block|{
name|ASSERT_INVALID_PCI_SEGMENT_ADDRESS
argument_list|(
name|Address
argument_list|,
literal|3
argument_list|)
expr_stmt|;
return|return
name|DxePciSegmentLibPciRootBridgeIoReadWorker
argument_list|(
name|Address
argument_list|,
name|EfiPciWidthUint32
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**   Writes a 32-bit PCI configuration register.    Writes the 32-bit PCI configuration register specified by Address with the value specified by Value.   Value is returned.  This function must guarantee that all PCI read and write operations are serialized.      If any reserved bits in Address are set, then ASSERT().   If Address is not aligned on a 32-bit boundary, then ASSERT().    @param  Address     The address that encodes the PCI Segment, Bus, Device, Function, and Register.   @param  Value       The value to write.    @return The parameter of Value.  **/
end_comment

begin_function
name|UINT32
name|EFIAPI
name|PciSegmentWrite32
parameter_list|(
name|IN
name|UINT64
name|Address
parameter_list|,
name|IN
name|UINT32
name|Value
parameter_list|)
block|{
name|ASSERT_INVALID_PCI_SEGMENT_ADDRESS
argument_list|(
name|Address
argument_list|,
literal|3
argument_list|)
expr_stmt|;
return|return
name|DxePciSegmentLibPciRootBridgeIoWriteWorker
argument_list|(
name|Address
argument_list|,
name|EfiPciWidthUint32
argument_list|,
name|Value
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**   Performs a bitwise OR of a 32-bit PCI configuration register with a 32-bit value.    Reads the 32-bit PCI configuration register specified by Address,   performs a bitwise OR between the read result and the value specified by OrData,   and writes the result to the 32-bit PCI configuration register specified by Address.   The value written to the PCI configuration register is returned.   This function must guarantee that all PCI read and write operations are serialized.      If any reserved bits in Address are set, then ASSERT().   If Address is not aligned on a 32-bit boundary, then ASSERT().    @param  Address   The address that encodes the PCI Segment, Bus, Device, Function, and Register.   @param  OrData    The value to OR with the PCI configuration register.    @return The value written to the PCI configuration register.  **/
end_comment

begin_function
name|UINT32
name|EFIAPI
name|PciSegmentOr32
parameter_list|(
name|IN
name|UINT64
name|Address
parameter_list|,
name|IN
name|UINT32
name|OrData
parameter_list|)
block|{
return|return
name|PciSegmentWrite32
argument_list|(
name|Address
argument_list|,
name|PciSegmentRead32
argument_list|(
name|Address
argument_list|)
operator||
name|OrData
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**   Performs a bitwise AND of a 32-bit PCI configuration register with a 32-bit value.    Reads the 32-bit PCI configuration register specified by Address,   performs a bitwise AND between the read result and the value specified by AndData,   and writes the result to the 32-bit PCI configuration register specified by Address.   The value written to the PCI configuration register is returned.   This function must guarantee that all PCI read and write operations are serialized.      If any reserved bits in Address are set, then ASSERT().   If Address is not aligned on a 32-bit boundary, then ASSERT().    @param  Address   The address that encodes the PCI Segment, Bus, Device, Function, and Register.   @param  AndData   The value to AND with the PCI configuration register.    @return The value written to the PCI configuration register.  **/
end_comment

begin_function
name|UINT32
name|EFIAPI
name|PciSegmentAnd32
parameter_list|(
name|IN
name|UINT64
name|Address
parameter_list|,
name|IN
name|UINT32
name|AndData
parameter_list|)
block|{
return|return
name|PciSegmentWrite32
argument_list|(
name|Address
argument_list|,
name|PciSegmentRead32
argument_list|(
name|Address
argument_list|)
operator|&
name|AndData
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**   Performs a bitwise AND of a 32-bit PCI configuration register with a 32-bit value,   followed a  bitwise OR with another 32-bit value.      Reads the 32-bit PCI configuration register specified by Address,   performs a bitwise AND between the read result and the value specified by AndData,   performs a bitwise OR between the result of the AND operation and the value specified by OrData,   and writes the result to the 32-bit PCI configuration register specified by Address.   The value written to the PCI configuration register is returned.   This function must guarantee that all PCI read and write operations are serialized.      If any reserved bits in Address are set, then ASSERT().   If Address is not aligned on a 32-bit boundary, then ASSERT().    @param  Address   The address that encodes the PCI Segment, Bus, Device, Function, and Register.   @param  AndData   The value to AND with the PCI configuration register.   @param  OrData    The value to OR with the PCI configuration register.    @return The value written to the PCI configuration register.  **/
end_comment

begin_function
name|UINT32
name|EFIAPI
name|PciSegmentAndThenOr32
parameter_list|(
name|IN
name|UINT64
name|Address
parameter_list|,
name|IN
name|UINT32
name|AndData
parameter_list|,
name|IN
name|UINT32
name|OrData
parameter_list|)
block|{
return|return
name|PciSegmentWrite32
argument_list|(
name|Address
argument_list|,
operator|(
name|PciSegmentRead32
argument_list|(
name|Address
argument_list|)
operator|&
name|AndData
operator|)
operator||
name|OrData
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**   Reads a bit field of a PCI configuration register.    Reads the bit field in a 32-bit PCI configuration register. The bit field is   specified by the StartBit and the EndBit. The value of the bit field is   returned.    If any reserved bits in Address are set, then ASSERT().   If Address is not aligned on a 32-bit boundary, then ASSERT().   If StartBit is greater than 31, then ASSERT().   If EndBit is greater than 31, then ASSERT().   If EndBit is less than StartBit, then ASSERT().    @param  Address   The PCI configuration register to read.   @param  StartBit  The ordinal of the least significant bit in the bit field.                     Range 0..31.   @param  EndBit    The ordinal of the most significant bit in the bit field.                     Range 0..31.    @return The value of the bit field read from the PCI configuration register.  **/
end_comment

begin_function
name|UINT32
name|EFIAPI
name|PciSegmentBitFieldRead32
parameter_list|(
name|IN
name|UINT64
name|Address
parameter_list|,
name|IN
name|UINTN
name|StartBit
parameter_list|,
name|IN
name|UINTN
name|EndBit
parameter_list|)
block|{
return|return
name|BitFieldRead32
argument_list|(
name|PciSegmentRead32
argument_list|(
name|Address
argument_list|)
argument_list|,
name|StartBit
argument_list|,
name|EndBit
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**   Writes a bit field to a PCI configuration register.    Writes Value to the bit field of the PCI configuration register. The bit   field is specified by the StartBit and the EndBit. All other bits in the   destination PCI configuration register are preserved. The new value of the   32-bit register is returned.    If any reserved bits in Address are set, then ASSERT().   If Address is not aligned on a 32-bit boundary, then ASSERT().   If StartBit is greater than 31, then ASSERT().   If EndBit is greater than 31, then ASSERT().   If EndBit is less than StartBit, then ASSERT().   If Value is larger than the bitmask value range specified by StartBit and EndBit, then ASSERT().    @param  Address   The PCI configuration register to write.   @param  StartBit  The ordinal of the least significant bit in the bit field.                     Range 0..31.   @param  EndBit    The ordinal of the most significant bit in the bit field.                     Range 0..31.   @param  Value     The new value of the bit field.    @return The value written back to the PCI configuration register.  **/
end_comment

begin_function
name|UINT32
name|EFIAPI
name|PciSegmentBitFieldWrite32
parameter_list|(
name|IN
name|UINT64
name|Address
parameter_list|,
name|IN
name|UINTN
name|StartBit
parameter_list|,
name|IN
name|UINTN
name|EndBit
parameter_list|,
name|IN
name|UINT32
name|Value
parameter_list|)
block|{
return|return
name|PciSegmentWrite32
argument_list|(
name|Address
argument_list|,
name|BitFieldWrite32
argument_list|(
name|PciSegmentRead32
argument_list|(
name|Address
argument_list|)
argument_list|,
name|StartBit
argument_list|,
name|EndBit
argument_list|,
name|Value
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**   Reads a bit field in a 32-bit PCI configuration, performs a bitwise OR, and   writes the result back to the bit field in the 32-bit port.    Reads the 32-bit PCI configuration register specified by Address, performs a   bitwise OR between the read result and the value specified by   OrData, and writes the result to the 32-bit PCI configuration register   specified by Address. The value written to the PCI configuration register is   returned. This function must guarantee that all PCI read and write operations   are serialized. Extra left bits in OrData are stripped.    If any reserved bits in Address are set, then ASSERT().   If StartBit is greater than 31, then ASSERT().   If EndBit is greater than 31, then ASSERT().   If EndBit is less than StartBit, then ASSERT().   If OrData is larger than the bitmask value range specified by StartBit and EndBit, then ASSERT().    @param  Address   The PCI configuration register to write.   @param  StartBit  The ordinal of the least significant bit in the bit field.                     Range 0..31.   @param  EndBit    The ordinal of the most significant bit in the bit field.                     Range 0..31.   @param  OrData    The value to OR with the PCI configuration register.    @return The value written back to the PCI configuration register.  **/
end_comment

begin_function
name|UINT32
name|EFIAPI
name|PciSegmentBitFieldOr32
parameter_list|(
name|IN
name|UINT64
name|Address
parameter_list|,
name|IN
name|UINTN
name|StartBit
parameter_list|,
name|IN
name|UINTN
name|EndBit
parameter_list|,
name|IN
name|UINT32
name|OrData
parameter_list|)
block|{
return|return
name|PciSegmentWrite32
argument_list|(
name|Address
argument_list|,
name|BitFieldOr32
argument_list|(
name|PciSegmentRead32
argument_list|(
name|Address
argument_list|)
argument_list|,
name|StartBit
argument_list|,
name|EndBit
argument_list|,
name|OrData
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**   Reads a bit field in a 32-bit PCI configuration register, performs a bitwise   AND, and writes the result back to the bit field in the 32-bit register.       Reads the 32-bit PCI configuration register specified by Address, performs a bitwise   AND between the read result and the value specified by AndData, and writes the result   to the 32-bit PCI configuration register specified by Address. The value written to   the PCI configuration register is returned.  This function must guarantee that all PCI   read and write operations are serialized.  Extra left bits in AndData are stripped.   If any reserved bits in Address are set, then ASSERT().   If Address is not aligned on a 32-bit boundary, then ASSERT().   If StartBit is greater than 31, then ASSERT().   If EndBit is greater than 31, then ASSERT().   If EndBit is less than StartBit, then ASSERT().   If AndData is larger than the bitmask value range specified by StartBit and EndBit, then ASSERT().    @param  Address   The PCI configuration register to write.   @param  StartBit  The ordinal of the least significant bit in the bit field.                     Range 0..31.   @param  EndBit    The ordinal of the most significant bit in the bit field.                     Range 0..31.   @param  AndData   The value to AND with the PCI configuration register.    @return The value written back to the PCI configuration register.  **/
end_comment

begin_function
name|UINT32
name|EFIAPI
name|PciSegmentBitFieldAnd32
parameter_list|(
name|IN
name|UINT64
name|Address
parameter_list|,
name|IN
name|UINTN
name|StartBit
parameter_list|,
name|IN
name|UINTN
name|EndBit
parameter_list|,
name|IN
name|UINT32
name|AndData
parameter_list|)
block|{
return|return
name|PciSegmentWrite32
argument_list|(
name|Address
argument_list|,
name|BitFieldAnd32
argument_list|(
name|PciSegmentRead32
argument_list|(
name|Address
argument_list|)
argument_list|,
name|StartBit
argument_list|,
name|EndBit
argument_list|,
name|AndData
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**   Reads a bit field in a 32-bit port, performs a bitwise AND followed by a   bitwise OR, and writes the result back to the bit field in the   32-bit port.    Reads the 32-bit PCI configuration register specified by Address, performs a   bitwise AND followed by a bitwise OR between the read result and   the value specified by AndData, and writes the result to the 32-bit PCI   configuration register specified by Address. The value written to the PCI   configuration register is returned. This function must guarantee that all PCI   read and write operations are serialized. Extra left bits in both AndData and   OrData are stripped.    If any reserved bits in Address are set, then ASSERT().   If StartBit is greater than 31, then ASSERT().   If EndBit is greater than 31, then ASSERT().   If EndBit is less than StartBit, then ASSERT().   If AndData is larger than the bitmask value range specified by StartBit and EndBit, then ASSERT().   If OrData is larger than the bitmask value range specified by StartBit and EndBit, then ASSERT().    @param  Address   The PCI configuration register to write.   @param  StartBit  The ordinal of the least significant bit in the bit field.                     Range 0..31.   @param  EndBit    The ordinal of the most significant bit in the bit field.                     Range 0..31.   @param  AndData   The value to AND with the PCI configuration register.   @param  OrData    The value to OR with the result of the AND operation.    @return The value written back to the PCI configuration register.  **/
end_comment

begin_function
name|UINT32
name|EFIAPI
name|PciSegmentBitFieldAndThenOr32
parameter_list|(
name|IN
name|UINT64
name|Address
parameter_list|,
name|IN
name|UINTN
name|StartBit
parameter_list|,
name|IN
name|UINTN
name|EndBit
parameter_list|,
name|IN
name|UINT32
name|AndData
parameter_list|,
name|IN
name|UINT32
name|OrData
parameter_list|)
block|{
return|return
name|PciSegmentWrite32
argument_list|(
name|Address
argument_list|,
name|BitFieldAndThenOr32
argument_list|(
name|PciSegmentRead32
argument_list|(
name|Address
argument_list|)
argument_list|,
name|StartBit
argument_list|,
name|EndBit
argument_list|,
name|AndData
argument_list|,
name|OrData
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**   Reads a range of PCI configuration registers into a caller supplied buffer.    Reads the range of PCI configuration registers specified by StartAddress and   Size into the buffer specified by Buffer. This function only allows the PCI   configuration registers from a single PCI function to be read. Size is   returned. When possible 32-bit PCI configuration read cycles are used to read   from StartAdress to StartAddress + Size. Due to alignment restrictions, 8-bit   and 16-bit PCI configuration read cycles may be used at the beginning and the   end of the range.    If any reserved bits in StartAddress are set, then ASSERT().   If ((StartAddress& 0xFFF) + Size)> 0x1000, then ASSERT().   If Size> 0 and Buffer is NULL, then ASSERT().    @param  StartAddress  The starting address that encodes the PCI Segment, Bus, Device,                         Function and Register.   @param  Size          The size in bytes of the transfer.   @param  Buffer        The pointer to a buffer receiving the data read.    @return Size  **/
end_comment

begin_function
name|UINTN
name|EFIAPI
name|PciSegmentReadBuffer
parameter_list|(
name|IN
name|UINT64
name|StartAddress
parameter_list|,
name|IN
name|UINTN
name|Size
parameter_list|,
name|OUT
name|VOID
modifier|*
name|Buffer
parameter_list|)
block|{
name|UINTN
name|ReturnValue
decl_stmt|;
name|ASSERT_INVALID_PCI_SEGMENT_ADDRESS
argument_list|(
name|StartAddress
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
operator|(
operator|(
name|StartAddress
operator|&
literal|0xFFF
operator|)
operator|+
name|Size
operator|)
operator|<=
literal|0x1000
argument_list|)
expr_stmt|;
if|if
condition|(
name|Size
operator|==
literal|0
condition|)
block|{
return|return
name|Size
return|;
block|}
name|ASSERT
argument_list|(
name|Buffer
operator|!=
name|NULL
argument_list|)
expr_stmt|;
comment|//
comment|// Save Size for return
comment|//
name|ReturnValue
operator|=
name|Size
expr_stmt|;
if|if
condition|(
operator|(
name|StartAddress
operator|&
name|BIT0
operator|)
operator|!=
literal|0
condition|)
block|{
comment|//
comment|// Read a byte if StartAddress is byte aligned
comment|//
operator|*
operator|(
specifier|volatile
name|UINT8
operator|*
operator|)
name|Buffer
operator|=
name|PciSegmentRead8
argument_list|(
name|StartAddress
argument_list|)
expr_stmt|;
name|StartAddress
operator|+=
sizeof|sizeof
argument_list|(
name|UINT8
argument_list|)
expr_stmt|;
name|Size
operator|-=
sizeof|sizeof
argument_list|(
name|UINT8
argument_list|)
expr_stmt|;
name|Buffer
operator|=
operator|(
name|UINT8
operator|*
operator|)
name|Buffer
operator|+
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|Size
operator|>=
sizeof|sizeof
argument_list|(
name|UINT16
argument_list|)
operator|&&
operator|(
name|StartAddress
operator|&
name|BIT1
operator|)
operator|!=
literal|0
condition|)
block|{
comment|//
comment|// Read a word if StartAddress is word aligned
comment|//
name|WriteUnaligned16
argument_list|(
name|Buffer
argument_list|,
name|PciSegmentRead16
argument_list|(
name|StartAddress
argument_list|)
argument_list|)
expr_stmt|;
name|StartAddress
operator|+=
sizeof|sizeof
argument_list|(
name|UINT16
argument_list|)
expr_stmt|;
name|Size
operator|-=
sizeof|sizeof
argument_list|(
name|UINT16
argument_list|)
expr_stmt|;
name|Buffer
operator|=
operator|(
name|UINT16
operator|*
operator|)
name|Buffer
operator|+
literal|1
expr_stmt|;
block|}
while|while
condition|(
name|Size
operator|>=
sizeof|sizeof
argument_list|(
name|UINT32
argument_list|)
condition|)
block|{
comment|//
comment|// Read as many double words as possible
comment|//
name|WriteUnaligned32
argument_list|(
name|Buffer
argument_list|,
name|PciSegmentRead32
argument_list|(
name|StartAddress
argument_list|)
argument_list|)
expr_stmt|;
name|StartAddress
operator|+=
sizeof|sizeof
argument_list|(
name|UINT32
argument_list|)
expr_stmt|;
name|Size
operator|-=
sizeof|sizeof
argument_list|(
name|UINT32
argument_list|)
expr_stmt|;
name|Buffer
operator|=
operator|(
name|UINT32
operator|*
operator|)
name|Buffer
operator|+
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|Size
operator|>=
sizeof|sizeof
argument_list|(
name|UINT16
argument_list|)
condition|)
block|{
comment|//
comment|// Read the last remaining word if exist
comment|//
name|WriteUnaligned16
argument_list|(
name|Buffer
argument_list|,
name|PciSegmentRead16
argument_list|(
name|StartAddress
argument_list|)
argument_list|)
expr_stmt|;
name|StartAddress
operator|+=
sizeof|sizeof
argument_list|(
name|UINT16
argument_list|)
expr_stmt|;
name|Size
operator|-=
sizeof|sizeof
argument_list|(
name|UINT16
argument_list|)
expr_stmt|;
name|Buffer
operator|=
operator|(
name|UINT16
operator|*
operator|)
name|Buffer
operator|+
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|Size
operator|>=
sizeof|sizeof
argument_list|(
name|UINT8
argument_list|)
condition|)
block|{
comment|//
comment|// Read the last remaining byte if exist
comment|//
operator|*
operator|(
specifier|volatile
name|UINT8
operator|*
operator|)
name|Buffer
operator|=
name|PciSegmentRead8
argument_list|(
name|StartAddress
argument_list|)
expr_stmt|;
block|}
return|return
name|ReturnValue
return|;
block|}
end_function

begin_comment
comment|/**   Copies the data in a caller supplied buffer to a specified range of PCI   configuration space.    Writes the range of PCI configuration registers specified by StartAddress and   Size from the buffer specified by Buffer. This function only allows the PCI   configuration registers from a single PCI function to be written. Size is   returned. When possible 32-bit PCI configuration write cycles are used to   write from StartAdress to StartAddress + Size. Due to alignment restrictions,   8-bit and 16-bit PCI configuration write cycles may be used at the beginning   and the end of the range.    If any reserved bits in StartAddress are set, then ASSERT().   If ((StartAddress& 0xFFF) + Size)> 0x1000, then ASSERT().   If Size> 0 and Buffer is NULL, then ASSERT().    @param  StartAddress  The starting address that encodes the PCI Segment, Bus, Device,                         Function and Register.   @param  Size          The size in bytes of the transfer.   @param  Buffer        The pointer to a buffer containing the data to write.    @return The parameter of Size.  **/
end_comment

begin_function
name|UINTN
name|EFIAPI
name|PciSegmentWriteBuffer
parameter_list|(
name|IN
name|UINT64
name|StartAddress
parameter_list|,
name|IN
name|UINTN
name|Size
parameter_list|,
name|IN
name|VOID
modifier|*
name|Buffer
parameter_list|)
block|{
name|UINTN
name|ReturnValue
decl_stmt|;
name|ASSERT_INVALID_PCI_SEGMENT_ADDRESS
argument_list|(
name|StartAddress
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
operator|(
operator|(
name|StartAddress
operator|&
literal|0xFFF
operator|)
operator|+
name|Size
operator|)
operator|<=
literal|0x1000
argument_list|)
expr_stmt|;
if|if
condition|(
name|Size
operator|==
literal|0
condition|)
block|{
return|return
literal|0
return|;
block|}
name|ASSERT
argument_list|(
name|Buffer
operator|!=
name|NULL
argument_list|)
expr_stmt|;
comment|//
comment|// Save Size for return
comment|//
name|ReturnValue
operator|=
name|Size
expr_stmt|;
if|if
condition|(
operator|(
name|StartAddress
operator|&
name|BIT0
operator|)
operator|!=
literal|0
condition|)
block|{
comment|//
comment|// Write a byte if StartAddress is byte aligned
comment|//
name|PciSegmentWrite8
argument_list|(
name|StartAddress
argument_list|,
operator|*
operator|(
name|UINT8
operator|*
operator|)
name|Buffer
argument_list|)
expr_stmt|;
name|StartAddress
operator|+=
sizeof|sizeof
argument_list|(
name|UINT8
argument_list|)
expr_stmt|;
name|Size
operator|-=
sizeof|sizeof
argument_list|(
name|UINT8
argument_list|)
expr_stmt|;
name|Buffer
operator|=
operator|(
name|UINT8
operator|*
operator|)
name|Buffer
operator|+
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|Size
operator|>=
sizeof|sizeof
argument_list|(
name|UINT16
argument_list|)
operator|&&
operator|(
name|StartAddress
operator|&
name|BIT1
operator|)
operator|!=
literal|0
condition|)
block|{
comment|//
comment|// Write a word if StartAddress is word aligned
comment|//
name|PciSegmentWrite16
argument_list|(
name|StartAddress
argument_list|,
name|ReadUnaligned16
argument_list|(
name|Buffer
argument_list|)
argument_list|)
expr_stmt|;
name|StartAddress
operator|+=
sizeof|sizeof
argument_list|(
name|UINT16
argument_list|)
expr_stmt|;
name|Size
operator|-=
sizeof|sizeof
argument_list|(
name|UINT16
argument_list|)
expr_stmt|;
name|Buffer
operator|=
operator|(
name|UINT16
operator|*
operator|)
name|Buffer
operator|+
literal|1
expr_stmt|;
block|}
while|while
condition|(
name|Size
operator|>=
sizeof|sizeof
argument_list|(
name|UINT32
argument_list|)
condition|)
block|{
comment|//
comment|// Write as many double words as possible
comment|//
name|PciSegmentWrite32
argument_list|(
name|StartAddress
argument_list|,
name|ReadUnaligned32
argument_list|(
name|Buffer
argument_list|)
argument_list|)
expr_stmt|;
name|StartAddress
operator|+=
sizeof|sizeof
argument_list|(
name|UINT32
argument_list|)
expr_stmt|;
name|Size
operator|-=
sizeof|sizeof
argument_list|(
name|UINT32
argument_list|)
expr_stmt|;
name|Buffer
operator|=
operator|(
name|UINT32
operator|*
operator|)
name|Buffer
operator|+
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|Size
operator|>=
sizeof|sizeof
argument_list|(
name|UINT16
argument_list|)
condition|)
block|{
comment|//
comment|// Write the last remaining word if exist
comment|//
name|PciSegmentWrite16
argument_list|(
name|StartAddress
argument_list|,
name|ReadUnaligned16
argument_list|(
name|Buffer
argument_list|)
argument_list|)
expr_stmt|;
name|StartAddress
operator|+=
sizeof|sizeof
argument_list|(
name|UINT16
argument_list|)
expr_stmt|;
name|Size
operator|-=
sizeof|sizeof
argument_list|(
name|UINT16
argument_list|)
expr_stmt|;
name|Buffer
operator|=
operator|(
name|UINT16
operator|*
operator|)
name|Buffer
operator|+
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|Size
operator|>=
sizeof|sizeof
argument_list|(
name|UINT8
argument_list|)
condition|)
block|{
comment|//
comment|// Write the last remaining byte if exist
comment|//
name|PciSegmentWrite8
argument_list|(
name|StartAddress
argument_list|,
operator|*
operator|(
name|UINT8
operator|*
operator|)
name|Buffer
argument_list|)
expr_stmt|;
block|}
return|return
name|ReturnValue
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/** @file    Copyright (c) 2015, Intel Corporation. All rights reserved.<BR>   This program and the accompanying materials   are licensed and made available under the terms and conditions of the BSD License   which accompanies this distribution.  The full text of the license may be found at   http://opensource.org/licenses/bsd-license.php    THE PROGRAM IS DISTRIBUTED UNDER THE BSD LICENSE ON AN "AS IS" BASIS,   WITHOUT WARRANTIES OR REPRESENTATIONS OF ANY KIND, EITHER EXPRESS OR IMPLIED.  **/
end_comment

begin_include
include|#
directive|include
file|"HstiDxe.h"
end_include

begin_comment
comment|/**   Find HSTI table in AIP protocol, and return the data.   This API will return the HSTI table with indicated Role and ImplementationID,   NULL ImplementationID means to find the first HSTI table with indicated Role.    @param Role             Role of HSTI data.   @param ImplementationID ImplementationID of HSTI data.                           NULL means find the first one match Role.   @param HstiData         HSTI data. This buffer is allocated by callee, and it                           is the responsibility of the caller to free it after                           using it.   @param HstiSize         HSTI size    @return Aip             The AIP protocol having this HSTI.   @return NULL            There is not HSTI table with the Role and ImplementationID published in system. **/
end_comment

begin_function
name|VOID
modifier|*
name|InternalHstiFindAip
parameter_list|(
name|IN
name|UINT32
name|Role
parameter_list|,
name|IN
name|CHAR16
modifier|*
name|ImplementationID
name|OPTIONAL
parameter_list|,
name|OUT
name|VOID
modifier|*
modifier|*
name|HstiData
name|OPTIONAL
parameter_list|,
name|OUT
name|UINTN
modifier|*
name|HstiSize
name|OPTIONAL
parameter_list|)
block|{
name|EFI_STATUS
name|Status
decl_stmt|;
name|EFI_ADAPTER_INFORMATION_PROTOCOL
modifier|*
name|Aip
decl_stmt|;
name|UINTN
name|NoHandles
decl_stmt|;
name|EFI_HANDLE
modifier|*
name|Handles
decl_stmt|;
name|UINTN
name|Index
decl_stmt|;
name|EFI_GUID
modifier|*
name|InfoTypesBuffer
decl_stmt|;
name|UINTN
name|InfoTypesBufferCount
decl_stmt|;
name|UINTN
name|InfoTypesIndex
decl_stmt|;
name|EFI_ADAPTER_INFORMATION_PROTOCOL
modifier|*
name|AipCandidate
decl_stmt|;
name|VOID
modifier|*
name|InformationBlock
decl_stmt|;
name|UINTN
name|InformationBlockSize
decl_stmt|;
name|ADAPTER_INFO_PLATFORM_SECURITY
modifier|*
name|Hsti
decl_stmt|;
name|Status
operator|=
name|gBS
operator|->
name|LocateHandleBuffer
argument_list|(
name|ByProtocol
argument_list|,
operator|&
name|gEfiAdapterInformationProtocolGuid
argument_list|,
name|NULL
argument_list|,
operator|&
name|NoHandles
argument_list|,
operator|&
name|Handles
argument_list|)
expr_stmt|;
if|if
condition|(
name|EFI_ERROR
argument_list|(
name|Status
argument_list|)
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|Hsti
operator|=
name|NULL
expr_stmt|;
name|Aip
operator|=
name|NULL
expr_stmt|;
name|InformationBlock
operator|=
name|NULL
expr_stmt|;
name|InformationBlockSize
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|Index
operator|=
literal|0
init|;
name|Index
operator|<
name|NoHandles
condition|;
name|Index
operator|++
control|)
block|{
name|Status
operator|=
name|gBS
operator|->
name|HandleProtocol
argument_list|(
name|Handles
index|[
name|Index
index|]
argument_list|,
operator|&
name|gEfiAdapterInformationProtocolGuid
argument_list|,
operator|(
name|VOID
operator|*
operator|*
operator|)
operator|&
name|Aip
argument_list|)
expr_stmt|;
if|if
condition|(
name|EFI_ERROR
argument_list|(
name|Status
argument_list|)
condition|)
block|{
continue|continue;
block|}
comment|//
comment|// Check AIP
comment|//
name|Status
operator|=
name|Aip
operator|->
name|GetSupportedTypes
argument_list|(
name|Aip
argument_list|,
operator|&
name|InfoTypesBuffer
argument_list|,
operator|&
name|InfoTypesBufferCount
argument_list|)
expr_stmt|;
if|if
condition|(
name|EFI_ERROR
argument_list|(
name|Status
argument_list|)
condition|)
block|{
continue|continue;
block|}
name|AipCandidate
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|InfoTypesIndex
operator|=
literal|0
init|;
name|InfoTypesIndex
operator|<
name|InfoTypesBufferCount
condition|;
name|InfoTypesIndex
operator|++
control|)
block|{
if|if
condition|(
name|CompareGuid
argument_list|(
operator|&
name|InfoTypesBuffer
index|[
name|InfoTypesIndex
index|]
argument_list|,
operator|&
name|gAdapterInfoPlatformSecurityGuid
argument_list|)
condition|)
block|{
name|AipCandidate
operator|=
name|Aip
expr_stmt|;
break|break;
block|}
block|}
name|FreePool
argument_list|(
name|InfoTypesBuffer
argument_list|)
expr_stmt|;
if|if
condition|(
name|AipCandidate
operator|==
name|NULL
condition|)
block|{
continue|continue;
block|}
comment|//
comment|// Check HSTI Role
comment|//
name|Aip
operator|=
name|AipCandidate
expr_stmt|;
name|Status
operator|=
name|Aip
operator|->
name|GetInformation
argument_list|(
name|Aip
argument_list|,
operator|&
name|gAdapterInfoPlatformSecurityGuid
argument_list|,
operator|&
name|InformationBlock
argument_list|,
operator|&
name|InformationBlockSize
argument_list|)
expr_stmt|;
if|if
condition|(
name|EFI_ERROR
argument_list|(
name|Status
argument_list|)
condition|)
block|{
continue|continue;
block|}
name|Hsti
operator|=
name|InformationBlock
expr_stmt|;
if|if
condition|(
operator|(
name|Hsti
operator|->
name|Role
operator|==
name|Role
operator|)
operator|&&
operator|(
operator|(
name|ImplementationID
operator|==
name|NULL
operator|)
operator|||
operator|(
name|StrCmp
argument_list|(
name|ImplementationID
argument_list|,
name|Hsti
operator|->
name|ImplementationID
argument_list|)
operator|==
literal|0
operator|)
operator|)
condition|)
block|{
break|break;
block|}
else|else
block|{
name|Hsti
operator|=
name|NULL
expr_stmt|;
name|FreePool
argument_list|(
name|InformationBlock
argument_list|)
expr_stmt|;
continue|continue;
block|}
block|}
name|FreePool
argument_list|(
name|Handles
argument_list|)
expr_stmt|;
if|if
condition|(
name|Hsti
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|HstiData
operator|!=
name|NULL
condition|)
block|{
operator|*
name|HstiData
operator|=
name|InformationBlock
expr_stmt|;
block|}
if|if
condition|(
name|HstiSize
operator|!=
name|NULL
condition|)
block|{
operator|*
name|HstiSize
operator|=
name|InformationBlockSize
expr_stmt|;
block|}
return|return
name|Aip
return|;
block|}
end_function

begin_comment
comment|/**   Return if input HSTI data follows HSTI specification.    @param HstiData  HSTI data   @param HstiSize  HSTI size    @retval TRUE  HSTI data follows HSTI specification.   @retval FALSE HSTI data does not follow HSTI specification. **/
end_comment

begin_function
name|BOOLEAN
name|InternalHstiIsValidTable
parameter_list|(
name|IN
name|VOID
modifier|*
name|HstiData
parameter_list|,
name|IN
name|UINTN
name|HstiSize
parameter_list|)
block|{
name|ADAPTER_INFO_PLATFORM_SECURITY
modifier|*
name|Hsti
decl_stmt|;
name|UINTN
name|Index
decl_stmt|;
name|CHAR16
modifier|*
name|ErrorString
decl_stmt|;
name|CHAR16
name|ErrorChar
decl_stmt|;
name|UINTN
name|ErrorStringSize
decl_stmt|;
name|UINTN
name|ErrorStringLength
decl_stmt|;
name|Hsti
operator|=
name|HstiData
expr_stmt|;
comment|//
comment|// basic check for header
comment|//
if|if
condition|(
name|HstiData
operator|==
name|NULL
condition|)
block|{
name|DEBUG
argument_list|(
operator|(
name|EFI_D_ERROR
operator|,
literal|"HstiData == NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
if|if
condition|(
name|HstiSize
operator|<
sizeof|sizeof
argument_list|(
name|ADAPTER_INFO_PLATFORM_SECURITY
argument_list|)
condition|)
block|{
name|DEBUG
argument_list|(
operator|(
name|EFI_D_ERROR
operator|,
literal|"HstiSize< sizeof(ADAPTER_INFO_PLATFORM_SECURITY)\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
if|if
condition|(
operator|(
operator|(
name|HstiSize
operator|-
sizeof|sizeof
argument_list|(
name|ADAPTER_INFO_PLATFORM_SECURITY
argument_list|)
operator|)
operator|/
literal|3
operator|)
operator|<
name|Hsti
operator|->
name|SecurityFeaturesSize
condition|)
block|{
name|DEBUG
argument_list|(
operator|(
name|EFI_D_ERROR
operator|,
literal|"((HstiSize - sizeof(ADAPTER_INFO_PLATFORM_SECURITY)) / 3)< SecurityFeaturesSize\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
comment|//
comment|// Check Version
comment|//
if|if
condition|(
name|Hsti
operator|->
name|Version
operator|!=
name|PLATFORM_SECURITY_VERSION_VNEXTCS
condition|)
block|{
name|DEBUG
argument_list|(
operator|(
name|EFI_D_ERROR
operator|,
literal|"Version != PLATFORM_SECURITY_VERSION_VNEXTCS\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
comment|//
comment|// Check Role
comment|//
if|if
condition|(
operator|(
name|Hsti
operator|->
name|Role
operator|<
name|PLATFORM_SECURITY_ROLE_PLATFORM_REFERENCE
operator|)
operator|||
operator|(
name|Hsti
operator|->
name|Role
operator|>
name|PLATFORM_SECURITY_ROLE_IMPLEMENTOR_ODM
operator|)
condition|)
block|{
name|DEBUG
argument_list|(
operator|(
name|EFI_D_ERROR
operator|,
literal|"Role< PLATFORM_SECURITY_ROLE_PLATFORM_REFERENCE ||\n"
operator|)
argument_list|)
expr_stmt|;
name|DEBUG
argument_list|(
operator|(
name|EFI_D_ERROR
operator|,
literal|"Role> PLATFORM_SECURITY_ROLE_IMPLEMENTOR_ODM\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
comment|//
comment|// Check ImplementationID
comment|//
for|for
control|(
name|Index
operator|=
literal|0
init|;
name|Index
operator|<
sizeof|sizeof
argument_list|(
name|Hsti
operator|->
name|ImplementationID
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|Hsti
operator|->
name|ImplementationID
index|[
literal|0
index|]
argument_list|)
condition|;
name|Index
operator|++
control|)
block|{
if|if
condition|(
name|Hsti
operator|->
name|ImplementationID
index|[
name|Index
index|]
operator|==
literal|0
condition|)
block|{
break|break;
block|}
block|}
if|if
condition|(
name|Index
operator|==
sizeof|sizeof
argument_list|(
name|Hsti
operator|->
name|ImplementationID
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|Hsti
operator|->
name|ImplementationID
index|[
literal|0
index|]
argument_list|)
condition|)
block|{
name|DEBUG
argument_list|(
operator|(
name|EFI_D_ERROR
operator|,
literal|"ImplementationID is no NUL CHAR\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
name|ErrorStringSize
operator|=
name|HstiSize
operator|-
sizeof|sizeof
argument_list|(
name|ADAPTER_INFO_PLATFORM_SECURITY
argument_list|)
operator|-
name|Hsti
operator|->
name|SecurityFeaturesSize
operator|*
literal|3
expr_stmt|;
name|ErrorString
operator|=
operator|(
name|CHAR16
operator|*
operator|)
operator|(
operator|(
name|UINTN
operator|)
name|Hsti
operator|+
sizeof|sizeof
argument_list|(
name|ADAPTER_INFO_PLATFORM_SECURITY
argument_list|)
operator|-
name|Hsti
operator|->
name|SecurityFeaturesSize
operator|*
literal|3
operator|)
expr_stmt|;
comment|//
comment|// basic check for ErrorString
comment|//
if|if
condition|(
name|ErrorStringSize
operator|==
literal|0
condition|)
block|{
name|DEBUG
argument_list|(
operator|(
name|EFI_D_ERROR
operator|,
literal|"ErrorStringSize == 0\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
if|if
condition|(
operator|(
name|ErrorStringSize
operator|&
name|BIT0
operator|)
operator|!=
literal|0
condition|)
block|{
name|DEBUG
argument_list|(
operator|(
name|EFI_D_ERROR
operator|,
literal|"(ErrorStringSize& BIT0) != 0\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
comment|//
comment|// ErrorString might not be CHAR16 aligned.
comment|//
name|CopyMem
argument_list|(
operator|&
name|ErrorChar
argument_list|,
name|ErrorString
argument_list|,
sizeof|sizeof
argument_list|(
name|ErrorChar
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|ErrorStringLength
operator|=
literal|0
init|;
operator|(
name|ErrorChar
operator|!=
literal|0
operator|)
operator|&&
operator|(
name|ErrorStringLength
operator|<
operator|(
name|ErrorStringSize
operator|/
literal|2
operator|)
operator|)
condition|;
name|ErrorStringLength
operator|++
control|)
block|{
name|ErrorString
operator|++
expr_stmt|;
name|CopyMem
argument_list|(
operator|&
name|ErrorChar
argument_list|,
name|ErrorString
argument_list|,
sizeof|sizeof
argument_list|(
name|ErrorChar
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|//
comment|// check the length of ErrorString
comment|//
if|if
condition|(
name|ErrorChar
operator|!=
literal|0
condition|)
block|{
name|DEBUG
argument_list|(
operator|(
name|EFI_D_ERROR
operator|,
literal|"ErrorString has no NUL CHAR\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
if|if
condition|(
name|ErrorStringLength
operator|==
operator|(
name|ErrorStringSize
operator|/
literal|2
operator|)
condition|)
block|{
name|DEBUG
argument_list|(
operator|(
name|EFI_D_ERROR
operator|,
literal|"ErrorString Length incorrect\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
return|return
name|TRUE
return|;
block|}
end_function

begin_comment
comment|/**   Publish HSTI table in AIP protocol.    One system should have only one PLATFORM_SECURITY_ROLE_PLATFORM_REFERENCE.    If the Role is NOT PLATFORM_SECURITY_ROLE_PLATFORM_REFERENCE,   SecurityFeaturesRequired field will be ignored.    @param Hsti      HSTI data   @param HstiSize  HSTI size    @retval EFI_SUCCESS          The HSTI data is published in AIP protocol.   @retval EFI_ALREADY_STARTED  There is already HSTI table with Role and ImplementationID published in system.   @retval EFI_VOLUME_CORRUPTED The input HSTI data does not follow HSTI specification.   @retval EFI_OUT_OF_RESOURCES There is not enough system resource to publish HSTI data in AIP protocol. **/
end_comment

begin_function
name|EFI_STATUS
name|EFIAPI
name|HstiLibSetTable
parameter_list|(
name|IN
name|VOID
modifier|*
name|Hsti
parameter_list|,
name|IN
name|UINTN
name|HstiSize
parameter_list|)
block|{
name|EFI_STATUS
name|Status
decl_stmt|;
name|EFI_HANDLE
name|Handle
decl_stmt|;
name|HSTI_AIP_PRIVATE_DATA
modifier|*
name|HstiAip
decl_stmt|;
name|EFI_ADAPTER_INFORMATION_PROTOCOL
modifier|*
name|Aip
decl_stmt|;
name|UINT32
name|Role
decl_stmt|;
name|CHAR16
modifier|*
name|ImplementationID
decl_stmt|;
name|UINT32
name|SecurityFeaturesSize
decl_stmt|;
name|UINT8
modifier|*
name|SecurityFeaturesRequired
decl_stmt|;
if|if
condition|(
operator|!
name|InternalHstiIsValidTable
argument_list|(
name|Hsti
argument_list|,
name|HstiSize
argument_list|)
condition|)
block|{
return|return
name|EFI_VOLUME_CORRUPTED
return|;
block|}
name|Role
operator|=
operator|(
operator|(
name|ADAPTER_INFO_PLATFORM_SECURITY
operator|*
operator|)
name|Hsti
operator|)
operator|->
name|Role
expr_stmt|;
name|ImplementationID
operator|=
operator|(
operator|(
name|ADAPTER_INFO_PLATFORM_SECURITY
operator|*
operator|)
name|Hsti
operator|)
operator|->
name|ImplementationID
expr_stmt|;
name|Aip
operator|=
name|InternalHstiFindAip
argument_list|(
name|Role
argument_list|,
name|ImplementationID
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|Aip
operator|!=
name|NULL
condition|)
block|{
return|return
name|EFI_ALREADY_STARTED
return|;
block|}
name|HstiAip
operator|=
name|AllocateZeroPool
argument_list|(
sizeof|sizeof
argument_list|(
name|HSTI_AIP_PRIVATE_DATA
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|HstiAip
operator|==
name|NULL
condition|)
block|{
return|return
name|EFI_OUT_OF_RESOURCES
return|;
block|}
name|HstiAip
operator|->
name|Hsti
operator|=
name|AllocateCopyPool
argument_list|(
name|HstiSize
argument_list|,
name|Hsti
argument_list|)
expr_stmt|;
if|if
condition|(
name|HstiAip
operator|->
name|Hsti
operator|==
name|NULL
condition|)
block|{
name|FreePool
argument_list|(
name|HstiAip
argument_list|)
expr_stmt|;
return|return
name|EFI_OUT_OF_RESOURCES
return|;
block|}
if|if
condition|(
name|Role
operator|!=
name|PLATFORM_SECURITY_ROLE_PLATFORM_REFERENCE
condition|)
block|{
name|SecurityFeaturesRequired
operator|=
operator|(
name|UINT8
operator|*
operator|)
name|HstiAip
operator|->
name|Hsti
operator|+
sizeof|sizeof
argument_list|(
name|ADAPTER_INFO_PLATFORM_SECURITY
argument_list|)
expr_stmt|;
name|SecurityFeaturesSize
operator|=
operator|(
operator|(
name|ADAPTER_INFO_PLATFORM_SECURITY
operator|*
operator|)
name|Hsti
operator|)
operator|->
name|SecurityFeaturesSize
expr_stmt|;
name|ZeroMem
argument_list|(
name|SecurityFeaturesRequired
argument_list|,
name|SecurityFeaturesSize
argument_list|)
expr_stmt|;
block|}
name|HstiAip
operator|->
name|Signature
operator|=
name|HSTI_AIP_PRIVATE_SIGNATURE
expr_stmt|;
name|CopyMem
argument_list|(
operator|&
name|HstiAip
operator|->
name|Aip
argument_list|,
operator|&
name|mAdapterInformationProtocol
argument_list|,
sizeof|sizeof
argument_list|(
name|EFI_ADAPTER_INFORMATION_PROTOCOL
argument_list|)
argument_list|)
expr_stmt|;
name|HstiAip
operator|->
name|HstiSize
operator|=
name|HstiSize
expr_stmt|;
name|HstiAip
operator|->
name|HstiMaxSize
operator|=
name|HstiSize
expr_stmt|;
name|Handle
operator|=
name|NULL
expr_stmt|;
name|Status
operator|=
name|gBS
operator|->
name|InstallMultipleProtocolInterfaces
argument_list|(
operator|&
name|Handle
argument_list|,
operator|&
name|gEfiAdapterInformationProtocolGuid
argument_list|,
operator|&
name|HstiAip
operator|->
name|Aip
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|EFI_ERROR
argument_list|(
name|Status
argument_list|)
condition|)
block|{
name|FreePool
argument_list|(
name|HstiAip
operator|->
name|Hsti
argument_list|)
expr_stmt|;
name|FreePool
argument_list|(
name|HstiAip
argument_list|)
expr_stmt|;
block|}
return|return
name|Status
return|;
block|}
end_function

begin_comment
comment|/**   Search HSTI table in AIP protocol, and return the data.   This API will return the HSTI table with indicated Role and ImplementationID,   NULL ImplementationID means to find the first HSTI table with indicated Role.    @param Role             Role of HSTI data.   @param ImplementationID ImplementationID of HSTI data.                           NULL means find the first one match Role.   @param Hsti             HSTI data. This buffer is allocated by callee, and it                           is the responsibility of the caller to free it after                           using it.   @param HstiSize         HSTI size    @retval EFI_SUCCESS          The HSTI data in AIP protocol is returned.   @retval EFI_NOT_FOUND        There is not HSTI table with the Role and ImplementationID published in system. **/
end_comment

begin_function
name|EFI_STATUS
name|EFIAPI
name|HstiLibGetTable
parameter_list|(
name|IN
name|UINT32
name|Role
parameter_list|,
name|IN
name|CHAR16
modifier|*
name|ImplementationID
name|OPTIONAL
parameter_list|,
name|OUT
name|VOID
modifier|*
modifier|*
name|Hsti
parameter_list|,
name|OUT
name|UINTN
modifier|*
name|HstiSize
parameter_list|)
block|{
name|EFI_ADAPTER_INFORMATION_PROTOCOL
modifier|*
name|Aip
decl_stmt|;
name|Aip
operator|=
name|InternalHstiFindAip
argument_list|(
name|Role
argument_list|,
name|ImplementationID
argument_list|,
name|Hsti
argument_list|,
name|HstiSize
argument_list|)
expr_stmt|;
if|if
condition|(
name|Aip
operator|==
name|NULL
condition|)
block|{
return|return
name|EFI_NOT_FOUND
return|;
block|}
return|return
name|EFI_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**   Record FeaturesVerified in published HSTI table.   This API will update the HSTI table with indicated Role and ImplementationID,   NULL ImplementationID means to find the first HSTI table with indicated Role.    @param Role             Role of HSTI data.   @param ImplementationID ImplementationID of HSTI data.                           NULL means find the first one match Role.   @param ByteIndex        Byte index of FeaturesVerified of HSTI data.   @param BitMask          Bit mask of FeaturesVerified of HSTI data.   @param Set              TRUE means to set the FeaturesVerified bit.                           FALSE means to clear the FeaturesVerified bit.    @retval EFI_SUCCESS          The FeaturesVerified of HSTI data updated in AIP protocol.   @retval EFI_NOT_STARTED      There is not HSTI table with the Role and ImplementationID published in system.   @retval EFI_UNSUPPORTED      The ByteIndex is invalid. **/
end_comment

begin_function
name|EFI_STATUS
name|InternalHstiRecordFeaturesVerified
parameter_list|(
name|IN
name|UINT32
name|Role
parameter_list|,
name|IN
name|CHAR16
modifier|*
name|ImplementationID
parameter_list|,
name|OPTIONAL
name|IN
name|UINT32
name|ByteIndex
parameter_list|,
name|IN
name|UINT8
name|Bit
parameter_list|,
name|IN
name|BOOLEAN
name|Set
parameter_list|)
block|{
name|EFI_ADAPTER_INFORMATION_PROTOCOL
modifier|*
name|Aip
decl_stmt|;
name|ADAPTER_INFO_PLATFORM_SECURITY
modifier|*
name|Hsti
decl_stmt|;
name|UINTN
name|HstiSize
decl_stmt|;
name|UINT8
modifier|*
name|SecurityFeaturesVerified
decl_stmt|;
name|EFI_STATUS
name|Status
decl_stmt|;
name|Aip
operator|=
name|InternalHstiFindAip
argument_list|(
name|Role
argument_list|,
name|ImplementationID
argument_list|,
operator|(
name|VOID
operator|*
operator|*
operator|)
operator|&
name|Hsti
argument_list|,
operator|&
name|HstiSize
argument_list|)
expr_stmt|;
if|if
condition|(
name|Aip
operator|==
name|NULL
condition|)
block|{
return|return
name|EFI_NOT_STARTED
return|;
block|}
if|if
condition|(
name|ByteIndex
operator|>=
name|Hsti
operator|->
name|SecurityFeaturesSize
condition|)
block|{
return|return
name|EFI_UNSUPPORTED
return|;
block|}
name|SecurityFeaturesVerified
operator|=
operator|(
name|UINT8
operator|*
operator|)
operator|(
operator|(
name|UINTN
operator|)
name|Hsti
operator|+
sizeof|sizeof
argument_list|(
name|ADAPTER_INFO_PLATFORM_SECURITY
argument_list|)
operator|+
name|Hsti
operator|->
name|SecurityFeaturesSize
operator|*
literal|2
operator|)
expr_stmt|;
if|if
condition|(
name|Set
condition|)
block|{
name|SecurityFeaturesVerified
index|[
name|ByteIndex
index|]
operator|=
call|(
name|UINT8
call|)
argument_list|(
name|SecurityFeaturesVerified
index|[
name|ByteIndex
index|]
operator||
operator|(
name|Bit
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SecurityFeaturesVerified
index|[
name|ByteIndex
index|]
operator|=
call|(
name|UINT8
call|)
argument_list|(
name|SecurityFeaturesVerified
index|[
name|ByteIndex
index|]
operator|&
operator|(
operator|~
name|Bit
operator|)
argument_list|)
expr_stmt|;
block|}
name|Status
operator|=
name|Aip
operator|->
name|SetInformation
argument_list|(
name|Aip
argument_list|,
operator|&
name|gAdapterInfoPlatformSecurityGuid
argument_list|,
name|Hsti
argument_list|,
name|HstiSize
argument_list|)
expr_stmt|;
return|return
name|Status
return|;
block|}
end_function

begin_comment
comment|/**   Set FeaturesVerified in published HSTI table.   This API will update the HSTI table with indicated Role and ImplementationID,   NULL ImplementationID means to find the first HSTI table with indicated Role.    @param Role             Role of HSTI data.   @param ImplementationID ImplementationID of HSTI data.                           NULL means find the first one match Role.   @param ByteIndex        Byte index of FeaturesVerified of HSTI data.   @param BitMask          Bit mask of FeaturesVerified of HSTI data.    @retval EFI_SUCCESS          The FeaturesVerified of HSTI data updated in AIP protocol.   @retval EFI_NOT_STARTED      There is not HSTI table with the Role and ImplementationID published in system.   @retval EFI_UNSUPPORTED      The ByteIndex is invalid. **/
end_comment

begin_function
name|EFI_STATUS
name|EFIAPI
name|HstiLibSetFeaturesVerified
parameter_list|(
name|IN
name|UINT32
name|Role
parameter_list|,
name|IN
name|CHAR16
modifier|*
name|ImplementationID
parameter_list|,
name|OPTIONAL
name|IN
name|UINT32
name|ByteIndex
parameter_list|,
name|IN
name|UINT8
name|BitMask
parameter_list|)
block|{
return|return
name|InternalHstiRecordFeaturesVerified
argument_list|(
name|Role
argument_list|,
name|ImplementationID
argument_list|,
name|ByteIndex
argument_list|,
name|BitMask
argument_list|,
name|TRUE
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**   Clear FeaturesVerified in published HSTI table.   This API will update the HSTI table with indicated Role and ImplementationID,   NULL ImplementationID means to find the first HSTI table with indicated Role.    @param Role             Role of HSTI data.   @param ImplementationID ImplementationID of HSTI data.                           NULL means find the first one match Role.   @param ByteIndex        Byte index of FeaturesVerified of HSTI data.   @param BitMask          Bit mask of FeaturesVerified of HSTI data.    @retval EFI_SUCCESS          The FeaturesVerified of HSTI data updated in AIP protocol.   @retval EFI_NOT_STARTED      There is not HSTI table with the Role and ImplementationID published in system.   @retval EFI_UNSUPPORTED      The ByteIndex is invalid. **/
end_comment

begin_function
name|EFI_STATUS
name|EFIAPI
name|HstiLibClearFeaturesVerified
parameter_list|(
name|IN
name|UINT32
name|Role
parameter_list|,
name|IN
name|CHAR16
modifier|*
name|ImplementationID
parameter_list|,
name|OPTIONAL
name|IN
name|UINT32
name|ByteIndex
parameter_list|,
name|IN
name|UINT8
name|BitMask
parameter_list|)
block|{
return|return
name|InternalHstiRecordFeaturesVerified
argument_list|(
name|Role
argument_list|,
name|ImplementationID
argument_list|,
name|ByteIndex
argument_list|,
name|BitMask
argument_list|,
name|FALSE
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**   Record ErrorString in published HSTI table.   This API will update the HSTI table with indicated Role and ImplementationID,   NULL ImplementationID means to find the first HSTI table with indicated Role.    @param Role             Role of HSTI data.   @param ImplementationID ImplementationID of HSTI data.                           NULL means find the first one match Role.   @param ErrorString      ErrorString of HSTI data.   @param Append           TRUE means to append the ErrorString to HSTI table.                           FALSE means to set the ErrorString in HSTI table.    @retval EFI_SUCCESS          The ErrorString of HSTI data is published in AIP protocol.   @retval EFI_NOT_STARTED      There is not HSTI table with the Role and ImplementationID published in system.   @retval EFI_OUT_OF_RESOURCES There is not enough system resource to update ErrorString. **/
end_comment

begin_function
name|EFI_STATUS
name|InternalHstiRecordErrorString
parameter_list|(
name|IN
name|UINT32
name|Role
parameter_list|,
name|IN
name|CHAR16
modifier|*
name|ImplementationID
parameter_list|,
name|OPTIONAL
name|IN
name|CHAR16
modifier|*
name|ErrorString
parameter_list|,
name|IN
name|BOOLEAN
name|Append
parameter_list|)
block|{
name|EFI_ADAPTER_INFORMATION_PROTOCOL
modifier|*
name|Aip
decl_stmt|;
name|ADAPTER_INFO_PLATFORM_SECURITY
modifier|*
name|Hsti
decl_stmt|;
name|UINTN
name|HstiSize
decl_stmt|;
name|UINTN
name|StringSize
decl_stmt|;
name|VOID
modifier|*
name|NewHsti
decl_stmt|;
name|UINTN
name|NewHstiSize
decl_stmt|;
name|UINTN
name|Offset
decl_stmt|;
name|EFI_STATUS
name|Status
decl_stmt|;
name|Aip
operator|=
name|InternalHstiFindAip
argument_list|(
name|Role
argument_list|,
name|ImplementationID
argument_list|,
operator|(
name|VOID
operator|*
operator|*
operator|)
operator|&
name|Hsti
argument_list|,
operator|&
name|HstiSize
argument_list|)
expr_stmt|;
if|if
condition|(
name|Aip
operator|==
name|NULL
condition|)
block|{
return|return
name|EFI_NOT_STARTED
return|;
block|}
if|if
condition|(
name|Append
condition|)
block|{
name|Offset
operator|=
name|HstiSize
operator|-
sizeof|sizeof
argument_list|(
name|CHAR16
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|Offset
operator|=
sizeof|sizeof
argument_list|(
name|ADAPTER_INFO_PLATFORM_SECURITY
argument_list|)
operator|+
name|Hsti
operator|->
name|SecurityFeaturesSize
operator|*
literal|3
expr_stmt|;
block|}
name|StringSize
operator|=
name|StrSize
argument_list|(
name|ErrorString
argument_list|)
expr_stmt|;
name|NewHstiSize
operator|=
name|Offset
operator|+
name|StringSize
expr_stmt|;
name|NewHsti
operator|=
name|AllocatePool
argument_list|(
name|NewHstiSize
argument_list|)
expr_stmt|;
if|if
condition|(
name|NewHsti
operator|==
name|NULL
condition|)
block|{
return|return
name|EFI_OUT_OF_RESOURCES
return|;
block|}
name|CopyMem
argument_list|(
name|NewHsti
argument_list|,
name|Hsti
argument_list|,
name|Offset
argument_list|)
expr_stmt|;
name|CopyMem
argument_list|(
operator|(
name|UINT8
operator|*
operator|)
name|NewHsti
operator|+
name|Offset
argument_list|,
name|ErrorString
argument_list|,
name|StringSize
argument_list|)
expr_stmt|;
name|Status
operator|=
name|Aip
operator|->
name|SetInformation
argument_list|(
name|Aip
argument_list|,
operator|&
name|gAdapterInfoPlatformSecurityGuid
argument_list|,
name|NewHsti
argument_list|,
name|NewHstiSize
argument_list|)
expr_stmt|;
return|return
name|Status
return|;
block|}
end_function

begin_comment
comment|/**   Append ErrorString in published HSTI table.   This API will update the HSTI table with indicated Role and ImplementationID,   NULL ImplementationID means to find the first HSTI table with indicated Role.    @param Role             Role of HSTI data.   @param ImplementationID ImplementationID of HSTI data.                           NULL means find the first one match Role.   @param ErrorString      ErrorString of HSTI data.    @retval EFI_SUCCESS          The ErrorString of HSTI data is updated in AIP protocol.   @retval EFI_NOT_STARTED      There is not HSTI table with the Role and ImplementationID published in system.   @retval EFI_OUT_OF_RESOURCES There is not enough system resource to update ErrorString. **/
end_comment

begin_function
name|EFI_STATUS
name|EFIAPI
name|HstiLibAppendErrorString
parameter_list|(
name|IN
name|UINT32
name|Role
parameter_list|,
name|IN
name|CHAR16
modifier|*
name|ImplementationID
parameter_list|,
name|OPTIONAL
name|IN
name|CHAR16
modifier|*
name|ErrorString
parameter_list|)
block|{
return|return
name|InternalHstiRecordErrorString
argument_list|(
name|Role
argument_list|,
name|ImplementationID
argument_list|,
name|ErrorString
argument_list|,
name|TRUE
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**   Set a new ErrorString in published HSTI table.   This API will update the HSTI table with indicated Role and ImplementationID,   NULL ImplementationID means to find the first HSTI table with indicated Role.    @param Role             Role of HSTI data.   @param ImplementationID ImplementationID of HSTI data.                           NULL means find the first one match Role.   @param ErrorString      ErrorString of HSTI data.    @retval EFI_SUCCESS          The ErrorString of HSTI data is updated in AIP protocol.   @retval EFI_NOT_STARTED      There is not HSTI table with the Role and ImplementationID published in system.   @retval EFI_OUT_OF_RESOURCES There is not enough system resource to update ErrorString. **/
end_comment

begin_function
name|EFI_STATUS
name|EFIAPI
name|HstiLibSetErrorString
parameter_list|(
name|IN
name|UINT32
name|Role
parameter_list|,
name|IN
name|CHAR16
modifier|*
name|ImplementationID
parameter_list|,
name|OPTIONAL
name|IN
name|CHAR16
modifier|*
name|ErrorString
parameter_list|)
block|{
return|return
name|InternalHstiRecordErrorString
argument_list|(
name|Role
argument_list|,
name|ImplementationID
argument_list|,
name|ErrorString
argument_list|,
name|FALSE
argument_list|)
return|;
block|}
end_function

end_unit


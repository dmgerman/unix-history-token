begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/** @file    Copyright (c) 2015, Intel Corporation. All rights reserved.<BR>   This program and the accompanying materials   are licensed and made available under the terms and conditions of the BSD License   which accompanies this distribution.  The full text of the license may be found at   http://opensource.org/licenses/bsd-license.php    THE PROGRAM IS DISTRIBUTED UNDER THE BSD LICENSE ON AN "AS IS" BASIS,   WITHOUT WARRANTIES OR REPRESENTATIONS OF ANY KIND, EITHER EXPRESS OR IMPLIED.  **/
end_comment

begin_include
include|#
directive|include
file|"HstiDxe.h"
end_include

begin_comment
comment|/**   Returns the current state information for the adapter.    This function returns information of type InformationType from the adapter.   If an adapter does not support the requested informational type, then   EFI_UNSUPPORTED is returned.     @param[in]  This                   A pointer to the EFI_ADAPTER_INFORMATION_PROTOCOL instance.   @param[in]  InformationType        A pointer to an EFI_GUID that defines the contents of InformationBlock.   @param[out] InformationBlock       The service returns a pointer to the buffer with the InformationBlock                                      structure which contains details about the data specific to InformationType.   @param[out] InformationBlockSize   The driver returns the size of the InformationBlock in bytes.    @retval EFI_SUCCESS                The InformationType information was retrieved.   @retval EFI_UNSUPPORTED            The InformationType is not known.   @retval EFI_DEVICE_ERROR           The device reported an error.   @retval EFI_OUT_OF_RESOURCES       The request could not be completed due to a lack of resources.   @retval EFI_INVALID_PARAMETER      This is NULL.    @retval EFI_INVALID_PARAMETER      InformationBlock is NULL.    @retval EFI_INVALID_PARAMETER      InformationBlockSize is NULL.  **/
end_comment

begin_function
name|EFI_STATUS
name|EFIAPI
name|HstiAipGetInfo
parameter_list|(
name|IN
name|EFI_ADAPTER_INFORMATION_PROTOCOL
modifier|*
name|This
parameter_list|,
name|IN
name|EFI_GUID
modifier|*
name|InformationType
parameter_list|,
name|OUT
name|VOID
modifier|*
modifier|*
name|InformationBlock
parameter_list|,
name|OUT
name|UINTN
modifier|*
name|InformationBlockSize
parameter_list|)
block|{
name|HSTI_AIP_PRIVATE_DATA
modifier|*
name|HstiAip
decl_stmt|;
if|if
condition|(
operator|(
name|This
operator|==
name|NULL
operator|)
operator|||
operator|(
name|InformationBlock
operator|==
name|NULL
operator|)
operator|||
operator|(
name|InformationBlockSize
operator|==
name|NULL
operator|)
condition|)
block|{
return|return
name|EFI_INVALID_PARAMETER
return|;
block|}
if|if
condition|(
operator|!
name|CompareGuid
argument_list|(
name|InformationType
argument_list|,
operator|&
name|gAdapterInfoPlatformSecurityGuid
argument_list|)
condition|)
block|{
return|return
name|EFI_UNSUPPORTED
return|;
block|}
name|HstiAip
operator|=
name|HSTI_AIP_PRIVATE_DATA_FROM_THIS
argument_list|(
name|This
argument_list|)
expr_stmt|;
operator|*
name|InformationBlock
operator|=
name|AllocateCopyPool
argument_list|(
name|HstiAip
operator|->
name|HstiSize
argument_list|,
name|HstiAip
operator|->
name|Hsti
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|InformationBlock
operator|==
name|NULL
condition|)
block|{
return|return
name|EFI_OUT_OF_RESOURCES
return|;
block|}
operator|*
name|InformationBlockSize
operator|=
name|HstiAip
operator|->
name|HstiSize
expr_stmt|;
return|return
name|EFI_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**   Sets state information for an adapter.    This function sends information of type InformationType for an adapter.   If an adapter does not support the requested information type, then EFI_UNSUPPORTED   is returned.    @param[in]  This                   A pointer to the EFI_ADAPTER_INFORMATION_PROTOCOL instance.   @param[in]  InformationType        A pointer to an EFI_GUID that defines the contents of InformationBlock.   @param[in]  InformationBlock       A pointer to the InformationBlock structure which contains details                                      about the data specific to InformationType.   @param[in]  InformationBlockSize   The size of the InformationBlock in bytes.    @retval EFI_SUCCESS                The information was received and interpreted successfully.   @retval EFI_UNSUPPORTED            The InformationType is not known.   @retval EFI_DEVICE_ERROR           The device reported an error.   @retval EFI_INVALID_PARAMETER      This is NULL.   @retval EFI_INVALID_PARAMETER      InformationBlock is NULL.   @retval EFI_WRITE_PROTECTED        The InformationType cannot be modified using EFI_ADAPTER_INFO_SET_INFO().  **/
end_comment

begin_function
name|EFI_STATUS
name|EFIAPI
name|HstiAipSetInfo
parameter_list|(
name|IN
name|EFI_ADAPTER_INFORMATION_PROTOCOL
modifier|*
name|This
parameter_list|,
name|IN
name|EFI_GUID
modifier|*
name|InformationType
parameter_list|,
name|IN
name|VOID
modifier|*
name|InformationBlock
parameter_list|,
name|IN
name|UINTN
name|InformationBlockSize
parameter_list|)
block|{
name|HSTI_AIP_PRIVATE_DATA
modifier|*
name|HstiAip
decl_stmt|;
name|VOID
modifier|*
name|NewHsti
decl_stmt|;
if|if
condition|(
operator|(
name|This
operator|==
name|NULL
operator|)
operator|||
operator|(
name|InformationBlock
operator|==
name|NULL
operator|)
condition|)
block|{
return|return
name|EFI_INVALID_PARAMETER
return|;
block|}
if|if
condition|(
operator|!
name|CompareGuid
argument_list|(
name|InformationType
argument_list|,
operator|&
name|gAdapterInfoPlatformSecurityGuid
argument_list|)
condition|)
block|{
return|return
name|EFI_UNSUPPORTED
return|;
block|}
if|if
condition|(
operator|!
name|InternalHstiIsValidTable
argument_list|(
name|InformationBlock
argument_list|,
name|InformationBlockSize
argument_list|)
condition|)
block|{
return|return
name|EFI_VOLUME_CORRUPTED
return|;
block|}
name|HstiAip
operator|=
name|HSTI_AIP_PRIVATE_DATA_FROM_THIS
argument_list|(
name|This
argument_list|)
expr_stmt|;
if|if
condition|(
name|InformationBlockSize
operator|>
name|HstiAip
operator|->
name|HstiMaxSize
condition|)
block|{
name|NewHsti
operator|=
name|AllocateZeroPool
argument_list|(
name|InformationBlockSize
argument_list|)
expr_stmt|;
if|if
condition|(
name|NewHsti
operator|==
name|NULL
condition|)
block|{
return|return
name|EFI_OUT_OF_RESOURCES
return|;
block|}
name|FreePool
argument_list|(
name|HstiAip
operator|->
name|Hsti
argument_list|)
expr_stmt|;
name|HstiAip
operator|->
name|Hsti
operator|=
name|NewHsti
expr_stmt|;
name|HstiAip
operator|->
name|HstiSize
operator|=
literal|0
expr_stmt|;
name|HstiAip
operator|->
name|HstiMaxSize
operator|=
name|InformationBlockSize
expr_stmt|;
block|}
name|CopyMem
argument_list|(
name|HstiAip
operator|->
name|Hsti
argument_list|,
name|InformationBlock
argument_list|,
name|InformationBlockSize
argument_list|)
expr_stmt|;
name|HstiAip
operator|->
name|HstiSize
operator|=
name|InformationBlockSize
expr_stmt|;
return|return
name|EFI_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**   Get a list of supported information types for this instance of the protocol.    This function returns a list of InformationType GUIDs that are supported on an   adapter with this instance of EFI_ADAPTER_INFORMATION_PROTOCOL. The list is returned   in InfoTypesBuffer, and the number of GUID pointers in InfoTypesBuffer is returned in   InfoTypesBufferCount.    @param[in]  This                  A pointer to the EFI_ADAPTER_INFORMATION_PROTOCOL instance.   @param[out] InfoTypesBuffer       A pointer to the array of InformationType GUIDs that are supported                                     by This.   @param[out] InfoTypesBufferCount  A pointer to the number of GUIDs present in InfoTypesBuffer.    @retval EFI_SUCCESS               The list of information type GUIDs that are supported on this adapter was                                     returned in InfoTypesBuffer. The number of information type GUIDs was                                     returned in InfoTypesBufferCount.   @retval EFI_INVALID_PARAMETER     This is NULL.   @retval EFI_INVALID_PARAMETER     InfoTypesBuffer is NULL.   @retval EFI_INVALID_PARAMETER     InfoTypesBufferCount is NULL.   @retval EFI_OUT_OF_RESOURCES      There is not enough pool memory to store the results.  **/
end_comment

begin_function
name|EFI_STATUS
name|EFIAPI
name|HstiAipGetSupportedTypes
parameter_list|(
name|IN
name|EFI_ADAPTER_INFORMATION_PROTOCOL
modifier|*
name|This
parameter_list|,
name|OUT
name|EFI_GUID
modifier|*
modifier|*
name|InfoTypesBuffer
parameter_list|,
name|OUT
name|UINTN
modifier|*
name|InfoTypesBufferCount
parameter_list|)
block|{
if|if
condition|(
operator|(
name|This
operator|==
name|NULL
operator|)
operator|||
operator|(
name|InfoTypesBuffer
operator|==
name|NULL
operator|)
operator|||
operator|(
name|InfoTypesBufferCount
operator|==
name|NULL
operator|)
condition|)
block|{
return|return
name|EFI_INVALID_PARAMETER
return|;
block|}
operator|*
name|InfoTypesBuffer
operator|=
name|AllocateCopyPool
argument_list|(
sizeof|sizeof
argument_list|(
name|gAdapterInfoPlatformSecurityGuid
argument_list|)
argument_list|,
operator|&
name|gAdapterInfoPlatformSecurityGuid
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|InfoTypesBuffer
operator|==
name|NULL
condition|)
block|{
return|return
name|EFI_OUT_OF_RESOURCES
return|;
block|}
operator|*
name|InfoTypesBufferCount
operator|=
literal|1
expr_stmt|;
return|return
name|EFI_SUCCESS
return|;
block|}
end_function

begin_decl_stmt
name|EFI_ADAPTER_INFORMATION_PROTOCOL
name|mAdapterInformationProtocol
init|=
block|{
name|HstiAipGetInfo
block|,
name|HstiAipSetInfo
block|,
name|HstiAipGetSupportedTypes
block|, }
decl_stmt|;
end_decl_stmt

end_unit


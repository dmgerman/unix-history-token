begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/** @file   PCI CF8 Library functions that use I/O ports 0xCF8 and 0xCFC to perform PCI Configuration cycles.   Layers on top of an I/O Library instance.    Copyright (c) 2006 - 2012, Intel Corporation. All rights reserved.<BR>   This program and the accompanying materials   are licensed and made available under the terms and conditions of the BSD License   which accompanies this distribution.  The full text of the license may be found at   http://opensource.org/licenses/bsd-license.php.    THE PROGRAM IS DISTRIBUTED UNDER THE BSD LICENSE ON AN "AS IS" BASIS,   WITHOUT WARRANTIES OR REPRESENTATIONS OF ANY KIND, EITHER EXPRESS OR IMPLIED.  **/
end_comment

begin_include
include|#
directive|include
file|<Base.h>
end_include

begin_include
include|#
directive|include
file|<Library/BaseLib.h>
end_include

begin_include
include|#
directive|include
file|<Library/PciCf8Lib.h>
end_include

begin_include
include|#
directive|include
file|<Library/IoLib.h>
end_include

begin_include
include|#
directive|include
file|<Library/DebugLib.h>
end_include

begin_comment
comment|//
end_comment

begin_comment
comment|// Declare I/O Ports used to perform PCI Confguration Cycles
end_comment

begin_comment
comment|//
end_comment

begin_define
define|#
directive|define
name|PCI_CONFIGURATION_ADDRESS_PORT
value|0xCF8
end_define

begin_define
define|#
directive|define
name|PCI_CONFIGURATION_DATA_PORT
value|0xCFC
end_define

begin_comment
comment|/**   Convert a PCI Library address to PCI CF8 formatted address.    Declare macro to convert PCI Library address to PCI CF8 formatted address.   Bit fields of PCI Library and CF8 formatted address is as follows:   PCI Library formatted address    CF8 Formatted Address  =============================    ======================     Bits 00..11  Register           Bits 00..07  Register     Bits 12..14  Function           Bits 08..10  Function     Bits 15..19  Device             Bits 11..15  Device     Bits 20..27  Bus                Bits 16..23  Bus     Bits 28..31  Reserved(MBZ)      Bits 24..30  Reserved(MBZ)                                     Bits 31..31  Must be 1    @param  A The address to convert.    @retval The coverted address.  **/
end_comment

begin_define
define|#
directive|define
name|PCI_TO_CF8_ADDRESS
parameter_list|(
name|A
parameter_list|)
define|\
value|((UINT32) ((((A)>> 4)& 0x00ffff00) | ((A)& 0xfc) | 0x80000000))
end_define

begin_comment
comment|/**   Assert the validity of a PCI CF8 address. A valid PCI CF8 address should contain 1's   only in the low 28 bits, excluding bits 08..11.    @param  A The address to validate.   @param  M Additional bits to assert to be zero.  **/
end_comment

begin_define
define|#
directive|define
name|ASSERT_INVALID_PCI_ADDRESS
parameter_list|(
name|A
parameter_list|,
name|M
parameter_list|)
define|\
value|ASSERT (((A)& (~0xffff0ff | (M))) == 0)
end_define

begin_comment
comment|/**   Registers a PCI device so PCI configuration registers may be accessed after    SetVirtualAddressMap().      Registers the PCI device specified by Address so all the PCI configuration registers    associated with that PCI device may be accessed after SetVirtualAddressMap() is called.      If Address> 0x0FFFFFFF, then ASSERT().   If the register specified by Address>= 0x100, then ASSERT().    @param  Address The address that encodes the PCI Bus, Device, Function and                   Register.      @retval RETURN_SUCCESS           The PCI device was registered for runtime access.   @retval RETURN_UNSUPPORTED       An attempt was made to call this function                                     after ExitBootServices().   @retval RETURN_UNSUPPORTED       The resources required to access the PCI device                                    at runtime could not be mapped.   @retval RETURN_OUT_OF_RESOURCES  There are not enough resources available to                                    complete the registration.  **/
end_comment

begin_function
name|RETURN_STATUS
name|EFIAPI
name|PciCf8RegisterForRuntimeAccess
parameter_list|(
name|IN
name|UINTN
name|Address
parameter_list|)
block|{
name|ASSERT_INVALID_PCI_ADDRESS
argument_list|(
name|Address
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|RETURN_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**   Reads an 8-bit PCI configuration register.    Reads and returns the 8-bit PCI configuration register specified by Address.   This function must guarantee that all PCI read and write operations are   serialized.    If Address> 0x0FFFFFFF, then ASSERT().   If the register specified by Address>= 0x100, then ASSERT().    @param  Address The address that encodes the PCI Bus, Device, Function and                   Register.    @return The read value from the PCI configuration register.  **/
end_comment

begin_function
name|UINT8
name|EFIAPI
name|PciCf8Read8
parameter_list|(
name|IN
name|UINTN
name|Address
parameter_list|)
block|{
name|BOOLEAN
name|InterruptState
decl_stmt|;
name|UINT32
name|AddressPort
decl_stmt|;
name|UINT8
name|Result
decl_stmt|;
name|ASSERT_INVALID_PCI_ADDRESS
argument_list|(
name|Address
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|InterruptState
operator|=
name|SaveAndDisableInterrupts
argument_list|()
expr_stmt|;
name|AddressPort
operator|=
name|IoRead32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|PCI_TO_CF8_ADDRESS
argument_list|(
name|Address
argument_list|)
argument_list|)
expr_stmt|;
name|Result
operator|=
name|IoRead8
argument_list|(
name|PCI_CONFIGURATION_DATA_PORT
operator|+
call|(
name|UINT16
call|)
argument_list|(
name|Address
operator|&
literal|3
argument_list|)
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|AddressPort
argument_list|)
expr_stmt|;
name|SetInterruptState
argument_list|(
name|InterruptState
argument_list|)
expr_stmt|;
return|return
name|Result
return|;
block|}
end_function

begin_comment
comment|/**   Writes an 8-bit PCI configuration register.    Writes the 8-bit PCI configuration register specified by Address with the   value specified by Value. Value is returned. This function must guarantee   that all PCI read and write operations are serialized.    If Address> 0x0FFFFFFF, then ASSERT().   If the register specified by Address>= 0x100, then ASSERT().    @param  Address The address that encodes the PCI Bus, Device, Function and                   Register.   @param  Value   The value to write.    @return The value written to the PCI configuration register.  **/
end_comment

begin_function
name|UINT8
name|EFIAPI
name|PciCf8Write8
parameter_list|(
name|IN
name|UINTN
name|Address
parameter_list|,
name|IN
name|UINT8
name|Value
parameter_list|)
block|{
name|BOOLEAN
name|InterruptState
decl_stmt|;
name|UINT32
name|AddressPort
decl_stmt|;
name|UINT8
name|Result
decl_stmt|;
name|ASSERT_INVALID_PCI_ADDRESS
argument_list|(
name|Address
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|InterruptState
operator|=
name|SaveAndDisableInterrupts
argument_list|()
expr_stmt|;
name|AddressPort
operator|=
name|IoRead32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|PCI_TO_CF8_ADDRESS
argument_list|(
name|Address
argument_list|)
argument_list|)
expr_stmt|;
name|Result
operator|=
name|IoWrite8
argument_list|(
name|PCI_CONFIGURATION_DATA_PORT
operator|+
call|(
name|UINT16
call|)
argument_list|(
name|Address
operator|&
literal|3
argument_list|)
argument_list|,
name|Value
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|AddressPort
argument_list|)
expr_stmt|;
name|SetInterruptState
argument_list|(
name|InterruptState
argument_list|)
expr_stmt|;
return|return
name|Result
return|;
block|}
end_function

begin_comment
comment|/**   Performs a bitwise OR of an 8-bit PCI configuration register with   an 8-bit value.    Reads the 8-bit PCI configuration register specified by Address, performs a   bitwise OR between the read result and the value specified by   OrData, and writes the result to the 8-bit PCI configuration register   specified by Address. The value written to the PCI configuration register is   returned. This function must guarantee that all PCI read and write operations   are serialized.    If Address> 0x0FFFFFFF, then ASSERT().   If the register specified by Address>= 0x100, then ASSERT().    @param  Address The address that encodes the PCI Bus, Device, Function and                   Register.   @param  OrData  The value to OR with the PCI configuration register.    @return The value written back to the PCI configuration register.  **/
end_comment

begin_function
name|UINT8
name|EFIAPI
name|PciCf8Or8
parameter_list|(
name|IN
name|UINTN
name|Address
parameter_list|,
name|IN
name|UINT8
name|OrData
parameter_list|)
block|{
name|BOOLEAN
name|InterruptState
decl_stmt|;
name|UINT32
name|AddressPort
decl_stmt|;
name|UINT8
name|Result
decl_stmt|;
name|ASSERT_INVALID_PCI_ADDRESS
argument_list|(
name|Address
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|InterruptState
operator|=
name|SaveAndDisableInterrupts
argument_list|()
expr_stmt|;
name|AddressPort
operator|=
name|IoRead32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|PCI_TO_CF8_ADDRESS
argument_list|(
name|Address
argument_list|)
argument_list|)
expr_stmt|;
name|Result
operator|=
name|IoOr8
argument_list|(
name|PCI_CONFIGURATION_DATA_PORT
operator|+
call|(
name|UINT16
call|)
argument_list|(
name|Address
operator|&
literal|3
argument_list|)
argument_list|,
name|OrData
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|AddressPort
argument_list|)
expr_stmt|;
name|SetInterruptState
argument_list|(
name|InterruptState
argument_list|)
expr_stmt|;
return|return
name|Result
return|;
block|}
end_function

begin_comment
comment|/**   Performs a bitwise AND of an 8-bit PCI configuration register with an 8-bit   value.    Reads the 8-bit PCI configuration register specified by Address, performs a   bitwise AND between the read result and the value specified by AndData, and   writes the result to the 8-bit PCI configuration register specified by   Address. The value written to the PCI configuration register is returned.   This function must guarantee that all PCI read and write operations are   serialized.    If Address> 0x0FFFFFFF, then ASSERT().   If the register specified by Address>= 0x100, then ASSERT().    @param  Address The address that encodes the PCI Bus, Device, Function and                   Register.   @param  AndData The value to AND with the PCI configuration register.    @return The value written back to the PCI configuration register.  **/
end_comment

begin_function
name|UINT8
name|EFIAPI
name|PciCf8And8
parameter_list|(
name|IN
name|UINTN
name|Address
parameter_list|,
name|IN
name|UINT8
name|AndData
parameter_list|)
block|{
name|BOOLEAN
name|InterruptState
decl_stmt|;
name|UINT32
name|AddressPort
decl_stmt|;
name|UINT8
name|Result
decl_stmt|;
name|ASSERT_INVALID_PCI_ADDRESS
argument_list|(
name|Address
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|InterruptState
operator|=
name|SaveAndDisableInterrupts
argument_list|()
expr_stmt|;
name|AddressPort
operator|=
name|IoRead32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|PCI_TO_CF8_ADDRESS
argument_list|(
name|Address
argument_list|)
argument_list|)
expr_stmt|;
name|Result
operator|=
name|IoAnd8
argument_list|(
name|PCI_CONFIGURATION_DATA_PORT
operator|+
call|(
name|UINT16
call|)
argument_list|(
name|Address
operator|&
literal|3
argument_list|)
argument_list|,
name|AndData
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|AddressPort
argument_list|)
expr_stmt|;
name|SetInterruptState
argument_list|(
name|InterruptState
argument_list|)
expr_stmt|;
return|return
name|Result
return|;
block|}
end_function

begin_comment
comment|/**   Performs a bitwise AND of an 8-bit PCI configuration register with an 8-bit   value, followed a  bitwise OR with another 8-bit value.    Reads the 8-bit PCI configuration register specified by Address, performs a   bitwise AND between the read result and the value specified by AndData,   performs a bitwise OR between the result of the AND operation and   the value specified by OrData, and writes the result to the 8-bit PCI   configuration register specified by Address. The value written to the PCI   configuration register is returned. This function must guarantee that all PCI   read and write operations are serialized.    If Address> 0x0FFFFFFF, then ASSERT().   If the register specified by Address>= 0x100, then ASSERT().    @param  Address The address that encodes the PCI Bus, Device, Function and                   Register.   @param  AndData The value to AND with the PCI configuration register.   @param  OrData  The value to OR with the result of the AND operation.    @return The value written back to the PCI configuration register.  **/
end_comment

begin_function
name|UINT8
name|EFIAPI
name|PciCf8AndThenOr8
parameter_list|(
name|IN
name|UINTN
name|Address
parameter_list|,
name|IN
name|UINT8
name|AndData
parameter_list|,
name|IN
name|UINT8
name|OrData
parameter_list|)
block|{
name|BOOLEAN
name|InterruptState
decl_stmt|;
name|UINT32
name|AddressPort
decl_stmt|;
name|UINT8
name|Result
decl_stmt|;
name|ASSERT_INVALID_PCI_ADDRESS
argument_list|(
name|Address
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|InterruptState
operator|=
name|SaveAndDisableInterrupts
argument_list|()
expr_stmt|;
name|AddressPort
operator|=
name|IoRead32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|PCI_TO_CF8_ADDRESS
argument_list|(
name|Address
argument_list|)
argument_list|)
expr_stmt|;
name|Result
operator|=
name|IoAndThenOr8
argument_list|(
name|PCI_CONFIGURATION_DATA_PORT
operator|+
call|(
name|UINT16
call|)
argument_list|(
name|Address
operator|&
literal|3
argument_list|)
argument_list|,
name|AndData
argument_list|,
name|OrData
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|AddressPort
argument_list|)
expr_stmt|;
name|SetInterruptState
argument_list|(
name|InterruptState
argument_list|)
expr_stmt|;
return|return
name|Result
return|;
block|}
end_function

begin_comment
comment|/**   Reads a bit field of a PCI configuration register.    Reads the bit field in an 8-bit PCI configuration register. The bit field is   specified by the StartBit and the EndBit. The value of the bit field is   returned.    If Address> 0x0FFFFFFF, then ASSERT().   If the register specified by Address>= 0x100, then ASSERT().   If StartBit is greater than 7, then ASSERT().   If EndBit is greater than 7, then ASSERT().   If EndBit is less than StartBit, then ASSERT().    @param  Address   The PCI configuration register to read.   @param  StartBit  The ordinal of the least significant bit in the bit field.                     Range 0..7.   @param  EndBit    The ordinal of the most significant bit in the bit field.                     Range 0..7.    @return The value of the bit field read from the PCI configuration register.  **/
end_comment

begin_function
name|UINT8
name|EFIAPI
name|PciCf8BitFieldRead8
parameter_list|(
name|IN
name|UINTN
name|Address
parameter_list|,
name|IN
name|UINTN
name|StartBit
parameter_list|,
name|IN
name|UINTN
name|EndBit
parameter_list|)
block|{
name|BOOLEAN
name|InterruptState
decl_stmt|;
name|UINT32
name|AddressPort
decl_stmt|;
name|UINT8
name|Result
decl_stmt|;
name|ASSERT_INVALID_PCI_ADDRESS
argument_list|(
name|Address
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|InterruptState
operator|=
name|SaveAndDisableInterrupts
argument_list|()
expr_stmt|;
name|AddressPort
operator|=
name|IoRead32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|PCI_TO_CF8_ADDRESS
argument_list|(
name|Address
argument_list|)
argument_list|)
expr_stmt|;
name|Result
operator|=
name|IoBitFieldRead8
argument_list|(
name|PCI_CONFIGURATION_DATA_PORT
operator|+
call|(
name|UINT16
call|)
argument_list|(
name|Address
operator|&
literal|3
argument_list|)
argument_list|,
name|StartBit
argument_list|,
name|EndBit
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|AddressPort
argument_list|)
expr_stmt|;
name|SetInterruptState
argument_list|(
name|InterruptState
argument_list|)
expr_stmt|;
return|return
name|Result
return|;
block|}
end_function

begin_comment
comment|/**   Writes a bit field to a PCI configuration register.    Writes Value to the bit field of the PCI configuration register. The bit   field is specified by the StartBit and the EndBit. All other bits in the   destination PCI configuration register are preserved. The new value of the   8-bit register is returned.    If Address> 0x0FFFFFFF, then ASSERT().   If the register specified by Address>= 0x100, then ASSERT().   If StartBit is greater than 7, then ASSERT().   If EndBit is greater than 7, then ASSERT().   If EndBit is less than StartBit, then ASSERT().   If Value is larger than the bitmask value range specified by StartBit and EndBit, then ASSERT().    @param  Address   The PCI configuration register to write.   @param  StartBit  The ordinal of the least significant bit in the bit field.                     Range 0..7.   @param  EndBit    The ordinal of the most significant bit in the bit field.                     Range 0..7.   @param  Value     The new value of the bit field.    @return The value written back to the PCI configuration register.  **/
end_comment

begin_function
name|UINT8
name|EFIAPI
name|PciCf8BitFieldWrite8
parameter_list|(
name|IN
name|UINTN
name|Address
parameter_list|,
name|IN
name|UINTN
name|StartBit
parameter_list|,
name|IN
name|UINTN
name|EndBit
parameter_list|,
name|IN
name|UINT8
name|Value
parameter_list|)
block|{
name|BOOLEAN
name|InterruptState
decl_stmt|;
name|UINT32
name|AddressPort
decl_stmt|;
name|UINT8
name|Result
decl_stmt|;
name|ASSERT_INVALID_PCI_ADDRESS
argument_list|(
name|Address
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|InterruptState
operator|=
name|SaveAndDisableInterrupts
argument_list|()
expr_stmt|;
name|AddressPort
operator|=
name|IoRead32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|PCI_TO_CF8_ADDRESS
argument_list|(
name|Address
argument_list|)
argument_list|)
expr_stmt|;
name|Result
operator|=
name|IoBitFieldWrite8
argument_list|(
name|PCI_CONFIGURATION_DATA_PORT
operator|+
call|(
name|UINT16
call|)
argument_list|(
name|Address
operator|&
literal|3
argument_list|)
argument_list|,
name|StartBit
argument_list|,
name|EndBit
argument_list|,
name|Value
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|AddressPort
argument_list|)
expr_stmt|;
name|SetInterruptState
argument_list|(
name|InterruptState
argument_list|)
expr_stmt|;
return|return
name|Result
return|;
block|}
end_function

begin_comment
comment|/**   Reads a bit field in an 8-bit PCI configuration, performs a bitwise OR, and   writes the result back to the bit field in the 8-bit port.    Reads the 8-bit PCI configuration register specified by Address, performs a   bitwise OR between the read result and the value specified by   OrData, and writes the result to the 8-bit PCI configuration register   specified by Address. The value written to the PCI configuration register is   returned. This function must guarantee that all PCI read and write operations   are serialized. Extra left bits in OrData are stripped.    If Address> 0x0FFFFFFF, then ASSERT().   If the register specified by Address>= 0x100, then ASSERT().   If StartBit is greater than 7, then ASSERT().   If EndBit is greater than 7, then ASSERT().   If EndBit is less than StartBit, then ASSERT().   If OrData is larger than the bitmask value range specified by StartBit and EndBit, then ASSERT().    @param  Address   The PCI configuration register to write.   @param  StartBit  The ordinal of the least significant bit in the bit field.                     Range 0..7.   @param  EndBit    The ordinal of the most significant bit in the bit field.                     Range 0..7.   @param  OrData    The value to OR with the PCI configuration register.    @return The value written back to the PCI configuration register.  **/
end_comment

begin_function
name|UINT8
name|EFIAPI
name|PciCf8BitFieldOr8
parameter_list|(
name|IN
name|UINTN
name|Address
parameter_list|,
name|IN
name|UINTN
name|StartBit
parameter_list|,
name|IN
name|UINTN
name|EndBit
parameter_list|,
name|IN
name|UINT8
name|OrData
parameter_list|)
block|{
name|BOOLEAN
name|InterruptState
decl_stmt|;
name|UINT32
name|AddressPort
decl_stmt|;
name|UINT8
name|Result
decl_stmt|;
name|ASSERT_INVALID_PCI_ADDRESS
argument_list|(
name|Address
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|InterruptState
operator|=
name|SaveAndDisableInterrupts
argument_list|()
expr_stmt|;
name|AddressPort
operator|=
name|IoRead32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|PCI_TO_CF8_ADDRESS
argument_list|(
name|Address
argument_list|)
argument_list|)
expr_stmt|;
name|Result
operator|=
name|IoBitFieldOr8
argument_list|(
name|PCI_CONFIGURATION_DATA_PORT
operator|+
call|(
name|UINT16
call|)
argument_list|(
name|Address
operator|&
literal|3
argument_list|)
argument_list|,
name|StartBit
argument_list|,
name|EndBit
argument_list|,
name|OrData
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|AddressPort
argument_list|)
expr_stmt|;
name|SetInterruptState
argument_list|(
name|InterruptState
argument_list|)
expr_stmt|;
return|return
name|Result
return|;
block|}
end_function

begin_comment
comment|/**   Reads a bit field in an 8-bit PCI configuration register, performs a bitwise   AND, and writes the result back to the bit field in the 8-bit register.    Reads the 8-bit PCI configuration register specified by Address, performs a   bitwise AND between the read result and the value specified by AndData, and   writes the result to the 8-bit PCI configuration register specified by   Address. The value written to the PCI configuration register is returned.   This function must guarantee that all PCI read and write operations are   serialized. Extra left bits in AndData are stripped.    If Address> 0x0FFFFFFF, then ASSERT().   If the register specified by Address>= 0x100, then ASSERT().   If StartBit is greater than 7, then ASSERT().   If EndBit is greater than 7, then ASSERT().   If EndBit is less than StartBit, then ASSERT().   If AndData is larger than the bitmask value range specified by StartBit and EndBit, then ASSERT().    @param  Address   The PCI configuration register to write.   @param  StartBit  The ordinal of the least significant bit in the bit field.                     Range 0..7.   @param  EndBit    The ordinal of the most significant bit in the bit field.                     Range 0..7.   @param  AndData   The value to AND with the PCI configuration register.    @return The value written back to the PCI configuration register.  **/
end_comment

begin_function
name|UINT8
name|EFIAPI
name|PciCf8BitFieldAnd8
parameter_list|(
name|IN
name|UINTN
name|Address
parameter_list|,
name|IN
name|UINTN
name|StartBit
parameter_list|,
name|IN
name|UINTN
name|EndBit
parameter_list|,
name|IN
name|UINT8
name|AndData
parameter_list|)
block|{
name|BOOLEAN
name|InterruptState
decl_stmt|;
name|UINT32
name|AddressPort
decl_stmt|;
name|UINT8
name|Result
decl_stmt|;
name|ASSERT_INVALID_PCI_ADDRESS
argument_list|(
name|Address
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|InterruptState
operator|=
name|SaveAndDisableInterrupts
argument_list|()
expr_stmt|;
name|AddressPort
operator|=
name|IoRead32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|PCI_TO_CF8_ADDRESS
argument_list|(
name|Address
argument_list|)
argument_list|)
expr_stmt|;
name|Result
operator|=
name|IoBitFieldAnd8
argument_list|(
name|PCI_CONFIGURATION_DATA_PORT
operator|+
call|(
name|UINT16
call|)
argument_list|(
name|Address
operator|&
literal|3
argument_list|)
argument_list|,
name|StartBit
argument_list|,
name|EndBit
argument_list|,
name|AndData
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|AddressPort
argument_list|)
expr_stmt|;
name|SetInterruptState
argument_list|(
name|InterruptState
argument_list|)
expr_stmt|;
return|return
name|Result
return|;
block|}
end_function

begin_comment
comment|/**   Reads a bit field in an 8-bit port, performs a bitwise AND followed by a   bitwise OR, and writes the result back to the bit field in the   8-bit port.    Reads the 8-bit PCI configuration register specified by Address, performs a   bitwise AND followed by a bitwise OR between the read result and   the value specified by AndData, and writes the result to the 8-bit PCI   configuration register specified by Address. The value written to the PCI   configuration register is returned. This function must guarantee that all PCI   read and write operations are serialized. Extra left bits in both AndData and   OrData are stripped.    If Address> 0x0FFFFFFF, then ASSERT().   If the register specified by Address>= 0x100, then ASSERT().   If StartBit is greater than 7, then ASSERT().   If EndBit is greater than 7, then ASSERT().   If EndBit is less than StartBit, then ASSERT().   If AndData is larger than the bitmask value range specified by StartBit and EndBit, then ASSERT().   If OrData is larger than the bitmask value range specified by StartBit and EndBit, then ASSERT().    @param  Address   The PCI configuration register to write.   @param  StartBit  The ordinal of the least significant bit in the bit field.                     Range 0..7.   @param  EndBit    The ordinal of the most significant bit in the bit field.                     Range 0..7.   @param  AndData   The value to AND with the PCI configuration register.   @param  OrData    The value to OR with the result of the AND operation.    @return The value written back to the PCI configuration register.  **/
end_comment

begin_function
name|UINT8
name|EFIAPI
name|PciCf8BitFieldAndThenOr8
parameter_list|(
name|IN
name|UINTN
name|Address
parameter_list|,
name|IN
name|UINTN
name|StartBit
parameter_list|,
name|IN
name|UINTN
name|EndBit
parameter_list|,
name|IN
name|UINT8
name|AndData
parameter_list|,
name|IN
name|UINT8
name|OrData
parameter_list|)
block|{
name|BOOLEAN
name|InterruptState
decl_stmt|;
name|UINT32
name|AddressPort
decl_stmt|;
name|UINT8
name|Result
decl_stmt|;
name|ASSERT_INVALID_PCI_ADDRESS
argument_list|(
name|Address
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|InterruptState
operator|=
name|SaveAndDisableInterrupts
argument_list|()
expr_stmt|;
name|AddressPort
operator|=
name|IoRead32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|PCI_TO_CF8_ADDRESS
argument_list|(
name|Address
argument_list|)
argument_list|)
expr_stmt|;
name|Result
operator|=
name|IoBitFieldAndThenOr8
argument_list|(
name|PCI_CONFIGURATION_DATA_PORT
operator|+
call|(
name|UINT16
call|)
argument_list|(
name|Address
operator|&
literal|3
argument_list|)
argument_list|,
name|StartBit
argument_list|,
name|EndBit
argument_list|,
name|AndData
argument_list|,
name|OrData
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|AddressPort
argument_list|)
expr_stmt|;
name|SetInterruptState
argument_list|(
name|InterruptState
argument_list|)
expr_stmt|;
return|return
name|Result
return|;
block|}
end_function

begin_comment
comment|/**   Reads a 16-bit PCI configuration register.    Reads and returns the 16-bit PCI configuration register specified by Address.   This function must guarantee that all PCI read and write operations are   serialized.    If Address> 0x0FFFFFFF, then ASSERT().   If Address is not aligned on a 16-bit boundary, then ASSERT().   If the register specified by Address>= 0x100, then ASSERT().    @param  Address The address that encodes the PCI Bus, Device, Function and                   Register.    @return The read value from the PCI configuration register.  **/
end_comment

begin_function
name|UINT16
name|EFIAPI
name|PciCf8Read16
parameter_list|(
name|IN
name|UINTN
name|Address
parameter_list|)
block|{
name|BOOLEAN
name|InterruptState
decl_stmt|;
name|UINT32
name|AddressPort
decl_stmt|;
name|UINT16
name|Result
decl_stmt|;
name|ASSERT_INVALID_PCI_ADDRESS
argument_list|(
name|Address
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|InterruptState
operator|=
name|SaveAndDisableInterrupts
argument_list|()
expr_stmt|;
name|AddressPort
operator|=
name|IoRead32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|PCI_TO_CF8_ADDRESS
argument_list|(
name|Address
argument_list|)
argument_list|)
expr_stmt|;
name|Result
operator|=
name|IoRead16
argument_list|(
name|PCI_CONFIGURATION_DATA_PORT
operator|+
call|(
name|UINT16
call|)
argument_list|(
name|Address
operator|&
literal|2
argument_list|)
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|AddressPort
argument_list|)
expr_stmt|;
name|SetInterruptState
argument_list|(
name|InterruptState
argument_list|)
expr_stmt|;
return|return
name|Result
return|;
block|}
end_function

begin_comment
comment|/**   Writes a 16-bit PCI configuration register.    Writes the 16-bit PCI configuration register specified by Address with the   value specified by Value. Value is returned. This function must guarantee   that all PCI read and write operations are serialized.    If Address> 0x0FFFFFFF, then ASSERT().   If Address is not aligned on a 16-bit boundary, then ASSERT().   If the register specified by Address>= 0x100, then ASSERT().    @param  Address The address that encodes the PCI Bus, Device, Function and                   Register.   @param  Value   The value to write.    @return The value written to the PCI configuration register.  **/
end_comment

begin_function
name|UINT16
name|EFIAPI
name|PciCf8Write16
parameter_list|(
name|IN
name|UINTN
name|Address
parameter_list|,
name|IN
name|UINT16
name|Value
parameter_list|)
block|{
name|BOOLEAN
name|InterruptState
decl_stmt|;
name|UINT32
name|AddressPort
decl_stmt|;
name|UINT16
name|Result
decl_stmt|;
name|ASSERT_INVALID_PCI_ADDRESS
argument_list|(
name|Address
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|InterruptState
operator|=
name|SaveAndDisableInterrupts
argument_list|()
expr_stmt|;
name|AddressPort
operator|=
name|IoRead32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|PCI_TO_CF8_ADDRESS
argument_list|(
name|Address
argument_list|)
argument_list|)
expr_stmt|;
name|Result
operator|=
name|IoWrite16
argument_list|(
name|PCI_CONFIGURATION_DATA_PORT
operator|+
call|(
name|UINT16
call|)
argument_list|(
name|Address
operator|&
literal|2
argument_list|)
argument_list|,
name|Value
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|AddressPort
argument_list|)
expr_stmt|;
name|SetInterruptState
argument_list|(
name|InterruptState
argument_list|)
expr_stmt|;
return|return
name|Result
return|;
block|}
end_function

begin_comment
comment|/**   Performs a bitwise OR of a 16-bit PCI configuration register with   a 16-bit value.    Reads the 16-bit PCI configuration register specified by Address, performs a   bitwise OR between the read result and the value specified by   OrData, and writes the result to the 16-bit PCI configuration register   specified by Address. The value written to the PCI configuration register is   returned. This function must guarantee that all PCI read and write operations   are serialized.    If Address> 0x0FFFFFFF, then ASSERT().   If Address is not aligned on a 16-bit boundary, then ASSERT().   If the register specified by Address>= 0x100, then ASSERT().    @param  Address The address that encodes the PCI Bus, Device, Function and                   Register.   @param  OrData  The value to OR with the PCI configuration register.    @return The value written back to the PCI configuration register.  **/
end_comment

begin_function
name|UINT16
name|EFIAPI
name|PciCf8Or16
parameter_list|(
name|IN
name|UINTN
name|Address
parameter_list|,
name|IN
name|UINT16
name|OrData
parameter_list|)
block|{
name|BOOLEAN
name|InterruptState
decl_stmt|;
name|UINT32
name|AddressPort
decl_stmt|;
name|UINT16
name|Result
decl_stmt|;
name|ASSERT_INVALID_PCI_ADDRESS
argument_list|(
name|Address
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|InterruptState
operator|=
name|SaveAndDisableInterrupts
argument_list|()
expr_stmt|;
name|AddressPort
operator|=
name|IoRead32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|PCI_TO_CF8_ADDRESS
argument_list|(
name|Address
argument_list|)
argument_list|)
expr_stmt|;
name|Result
operator|=
name|IoOr16
argument_list|(
name|PCI_CONFIGURATION_DATA_PORT
operator|+
call|(
name|UINT16
call|)
argument_list|(
name|Address
operator|&
literal|2
argument_list|)
argument_list|,
name|OrData
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|AddressPort
argument_list|)
expr_stmt|;
name|SetInterruptState
argument_list|(
name|InterruptState
argument_list|)
expr_stmt|;
return|return
name|Result
return|;
block|}
end_function

begin_comment
comment|/**   Performs a bitwise AND of a 16-bit PCI configuration register with a 16-bit   value.    Reads the 16-bit PCI configuration register specified by Address, performs a   bitwise AND between the read result and the value specified by AndData, and   writes the result to the 16-bit PCI configuration register specified by   Address. The value written to the PCI configuration register is returned.   This function must guarantee that all PCI read and write operations are   serialized.    If Address> 0x0FFFFFFF, then ASSERT().   If Address is not aligned on a 16-bit boundary, then ASSERT().   If the register specified by Address>= 0x100, then ASSERT().    @param  Address The address that encodes the PCI Bus, Device, Function and                   Register.   @param  AndData The value to AND with the PCI configuration register.    @return The value written back to the PCI configuration register.  **/
end_comment

begin_function
name|UINT16
name|EFIAPI
name|PciCf8And16
parameter_list|(
name|IN
name|UINTN
name|Address
parameter_list|,
name|IN
name|UINT16
name|AndData
parameter_list|)
block|{
name|BOOLEAN
name|InterruptState
decl_stmt|;
name|UINT32
name|AddressPort
decl_stmt|;
name|UINT16
name|Result
decl_stmt|;
name|ASSERT_INVALID_PCI_ADDRESS
argument_list|(
name|Address
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|InterruptState
operator|=
name|SaveAndDisableInterrupts
argument_list|()
expr_stmt|;
name|AddressPort
operator|=
name|IoRead32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|PCI_TO_CF8_ADDRESS
argument_list|(
name|Address
argument_list|)
argument_list|)
expr_stmt|;
name|Result
operator|=
name|IoAnd16
argument_list|(
name|PCI_CONFIGURATION_DATA_PORT
operator|+
call|(
name|UINT16
call|)
argument_list|(
name|Address
operator|&
literal|2
argument_list|)
argument_list|,
name|AndData
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|AddressPort
argument_list|)
expr_stmt|;
name|SetInterruptState
argument_list|(
name|InterruptState
argument_list|)
expr_stmt|;
return|return
name|Result
return|;
block|}
end_function

begin_comment
comment|/**   Performs a bitwise AND of a 16-bit PCI configuration register with a 16-bit   value, followed a  bitwise OR with another 16-bit value.    Reads the 16-bit PCI configuration register specified by Address, performs a   bitwise AND between the read result and the value specified by AndData,   performs a bitwise OR between the result of the AND operation and   the value specified by OrData, and writes the result to the 16-bit PCI   configuration register specified by Address. The value written to the PCI   configuration register is returned. This function must guarantee that all PCI   read and write operations are serialized.    If Address> 0x0FFFFFFF, then ASSERT().   If Address is not aligned on a 16-bit boundary, then ASSERT().   If the register specified by Address>= 0x100, then ASSERT().    @param  Address The address that encodes the PCI Bus, Device, Function and                   Register.   @param  AndData The value to AND with the PCI configuration register.   @param  OrData  The value to OR with the result of the AND operation.    @return The value written back to the PCI configuration register.  **/
end_comment

begin_function
name|UINT16
name|EFIAPI
name|PciCf8AndThenOr16
parameter_list|(
name|IN
name|UINTN
name|Address
parameter_list|,
name|IN
name|UINT16
name|AndData
parameter_list|,
name|IN
name|UINT16
name|OrData
parameter_list|)
block|{
name|BOOLEAN
name|InterruptState
decl_stmt|;
name|UINT32
name|AddressPort
decl_stmt|;
name|UINT16
name|Result
decl_stmt|;
name|ASSERT_INVALID_PCI_ADDRESS
argument_list|(
name|Address
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|InterruptState
operator|=
name|SaveAndDisableInterrupts
argument_list|()
expr_stmt|;
name|AddressPort
operator|=
name|IoRead32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|PCI_TO_CF8_ADDRESS
argument_list|(
name|Address
argument_list|)
argument_list|)
expr_stmt|;
name|Result
operator|=
name|IoAndThenOr16
argument_list|(
name|PCI_CONFIGURATION_DATA_PORT
operator|+
call|(
name|UINT16
call|)
argument_list|(
name|Address
operator|&
literal|2
argument_list|)
argument_list|,
name|AndData
argument_list|,
name|OrData
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|AddressPort
argument_list|)
expr_stmt|;
name|SetInterruptState
argument_list|(
name|InterruptState
argument_list|)
expr_stmt|;
return|return
name|Result
return|;
block|}
end_function

begin_comment
comment|/**   Reads a bit field of a PCI configuration register.    Reads the bit field in a 16-bit PCI configuration register. The bit field is   specified by the StartBit and the EndBit. The value of the bit field is   returned.    If Address> 0x0FFFFFFF, then ASSERT().   If Address is not aligned on a 16-bit boundary, then ASSERT().   If the register specified by Address>= 0x100, then ASSERT().   If StartBit is greater than 15, then ASSERT().   If EndBit is greater than 15, then ASSERT().   If EndBit is less than StartBit, then ASSERT().    @param  Address   The PCI configuration register to read.   @param  StartBit  The ordinal of the least significant bit in the bit field.                     Range 0..15.   @param  EndBit    The ordinal of the most significant bit in the bit field.                     Range 0..15.    @return The value of the bit field read from the PCI configuration register.  **/
end_comment

begin_function
name|UINT16
name|EFIAPI
name|PciCf8BitFieldRead16
parameter_list|(
name|IN
name|UINTN
name|Address
parameter_list|,
name|IN
name|UINTN
name|StartBit
parameter_list|,
name|IN
name|UINTN
name|EndBit
parameter_list|)
block|{
name|BOOLEAN
name|InterruptState
decl_stmt|;
name|UINT32
name|AddressPort
decl_stmt|;
name|UINT16
name|Result
decl_stmt|;
name|ASSERT_INVALID_PCI_ADDRESS
argument_list|(
name|Address
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|InterruptState
operator|=
name|SaveAndDisableInterrupts
argument_list|()
expr_stmt|;
name|AddressPort
operator|=
name|IoRead32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|PCI_TO_CF8_ADDRESS
argument_list|(
name|Address
argument_list|)
argument_list|)
expr_stmt|;
name|Result
operator|=
name|IoBitFieldRead16
argument_list|(
name|PCI_CONFIGURATION_DATA_PORT
operator|+
call|(
name|UINT16
call|)
argument_list|(
name|Address
operator|&
literal|2
argument_list|)
argument_list|,
name|StartBit
argument_list|,
name|EndBit
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|AddressPort
argument_list|)
expr_stmt|;
name|SetInterruptState
argument_list|(
name|InterruptState
argument_list|)
expr_stmt|;
return|return
name|Result
return|;
block|}
end_function

begin_comment
comment|/**   Writes a bit field to a PCI configuration register.    Writes Value to the bit field of the PCI configuration register. The bit   field is specified by the StartBit and the EndBit. All other bits in the   destination PCI configuration register are preserved. The new value of the   16-bit register is returned.    If Address> 0x0FFFFFFF, then ASSERT().   If Address is not aligned on a 16-bit boundary, then ASSERT().   If the register specified by Address>= 0x100, then ASSERT().   If StartBit is greater than 15, then ASSERT().   If EndBit is greater than 15, then ASSERT().   If EndBit is less than StartBit, then ASSERT().   If Value is larger than the bitmask value range specified by StartBit and EndBit, then ASSERT().    @param  Address   The PCI configuration register to write.   @param  StartBit  The ordinal of the least significant bit in the bit field.                     Range 0..15.   @param  EndBit    The ordinal of the most significant bit in the bit field.                     Range 0..15.   @param  Value     The new value of the bit field.    @return The value written back to the PCI configuration register.  **/
end_comment

begin_function
name|UINT16
name|EFIAPI
name|PciCf8BitFieldWrite16
parameter_list|(
name|IN
name|UINTN
name|Address
parameter_list|,
name|IN
name|UINTN
name|StartBit
parameter_list|,
name|IN
name|UINTN
name|EndBit
parameter_list|,
name|IN
name|UINT16
name|Value
parameter_list|)
block|{
name|BOOLEAN
name|InterruptState
decl_stmt|;
name|UINT32
name|AddressPort
decl_stmt|;
name|UINT16
name|Result
decl_stmt|;
name|ASSERT_INVALID_PCI_ADDRESS
argument_list|(
name|Address
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|InterruptState
operator|=
name|SaveAndDisableInterrupts
argument_list|()
expr_stmt|;
name|AddressPort
operator|=
name|IoRead32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|PCI_TO_CF8_ADDRESS
argument_list|(
name|Address
argument_list|)
argument_list|)
expr_stmt|;
name|Result
operator|=
name|IoBitFieldWrite16
argument_list|(
name|PCI_CONFIGURATION_DATA_PORT
operator|+
call|(
name|UINT16
call|)
argument_list|(
name|Address
operator|&
literal|2
argument_list|)
argument_list|,
name|StartBit
argument_list|,
name|EndBit
argument_list|,
name|Value
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|AddressPort
argument_list|)
expr_stmt|;
name|SetInterruptState
argument_list|(
name|InterruptState
argument_list|)
expr_stmt|;
return|return
name|Result
return|;
block|}
end_function

begin_comment
comment|/**   Reads a bit field in a 16-bit PCI configuration, performs a bitwise OR, and   writes the result back to the bit field in the 16-bit port.    Reads the 16-bit PCI configuration register specified by Address, performs a   bitwise OR between the read result and the value specified by   OrData, and writes the result to the 16-bit PCI configuration register   specified by Address. The value written to the PCI configuration register is   returned. This function must guarantee that all PCI read and write operations   are serialized. Extra left bits in OrData are stripped.    If Address> 0x0FFFFFFF, then ASSERT().   If Address is not aligned on a 16-bit boundary, then ASSERT().   If the register specified by Address>= 0x100, then ASSERT().   If StartBit is greater than 15, then ASSERT().   If EndBit is greater than 15, then ASSERT().   If EndBit is less than StartBit, then ASSERT().   If OrData is larger than the bitmask value range specified by StartBit and EndBit, then ASSERT().    @param  Address   The PCI configuration register to write.   @param  StartBit  The ordinal of the least significant bit in the bit field.                     Range 0..15.   @param  EndBit    The ordinal of the most significant bit in the bit field.                     Range 0..15.   @param  OrData    The value to OR with the PCI configuration register.    @return The value written back to the PCI configuration register.  **/
end_comment

begin_function
name|UINT16
name|EFIAPI
name|PciCf8BitFieldOr16
parameter_list|(
name|IN
name|UINTN
name|Address
parameter_list|,
name|IN
name|UINTN
name|StartBit
parameter_list|,
name|IN
name|UINTN
name|EndBit
parameter_list|,
name|IN
name|UINT16
name|OrData
parameter_list|)
block|{
name|BOOLEAN
name|InterruptState
decl_stmt|;
name|UINT32
name|AddressPort
decl_stmt|;
name|UINT16
name|Result
decl_stmt|;
name|ASSERT_INVALID_PCI_ADDRESS
argument_list|(
name|Address
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|InterruptState
operator|=
name|SaveAndDisableInterrupts
argument_list|()
expr_stmt|;
name|AddressPort
operator|=
name|IoRead32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|PCI_TO_CF8_ADDRESS
argument_list|(
name|Address
argument_list|)
argument_list|)
expr_stmt|;
name|Result
operator|=
name|IoBitFieldOr16
argument_list|(
name|PCI_CONFIGURATION_DATA_PORT
operator|+
call|(
name|UINT16
call|)
argument_list|(
name|Address
operator|&
literal|2
argument_list|)
argument_list|,
name|StartBit
argument_list|,
name|EndBit
argument_list|,
name|OrData
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|AddressPort
argument_list|)
expr_stmt|;
name|SetInterruptState
argument_list|(
name|InterruptState
argument_list|)
expr_stmt|;
return|return
name|Result
return|;
block|}
end_function

begin_comment
comment|/**   Reads a bit field in a 16-bit PCI configuration register, performs a bitwise   AND, and writes the result back to the bit field in the 16-bit register.    Reads the 16-bit PCI configuration register specified by Address, performs a   bitwise AND between the read result and the value specified by AndData, and   writes the result to the 16-bit PCI configuration register specified by   Address. The value written to the PCI configuration register is returned.   This function must guarantee that all PCI read and write operations are   serialized. Extra left bits in AndData are stripped.    If Address> 0x0FFFFFFF, then ASSERT().   If Address is not aligned on a 16-bit boundary, then ASSERT().   If the register specified by Address>= 0x100, then ASSERT().   If StartBit is greater than 15, then ASSERT().   If EndBit is greater than 15, then ASSERT().   If EndBit is less than StartBit, then ASSERT().   If AndData is larger than the bitmask value range specified by StartBit and EndBit, then ASSERT().    @param  Address   The PCI configuration register to write.   @param  StartBit  The ordinal of the least significant bit in the bit field.                     Range 0..15.   @param  EndBit    The ordinal of the most significant bit in the bit field.                     Range 0..15.   @param  AndData   The value to AND with the PCI configuration register.    @return The value written back to the PCI configuration register.  **/
end_comment

begin_function
name|UINT16
name|EFIAPI
name|PciCf8BitFieldAnd16
parameter_list|(
name|IN
name|UINTN
name|Address
parameter_list|,
name|IN
name|UINTN
name|StartBit
parameter_list|,
name|IN
name|UINTN
name|EndBit
parameter_list|,
name|IN
name|UINT16
name|AndData
parameter_list|)
block|{
name|BOOLEAN
name|InterruptState
decl_stmt|;
name|UINT32
name|AddressPort
decl_stmt|;
name|UINT16
name|Result
decl_stmt|;
name|ASSERT_INVALID_PCI_ADDRESS
argument_list|(
name|Address
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|InterruptState
operator|=
name|SaveAndDisableInterrupts
argument_list|()
expr_stmt|;
name|AddressPort
operator|=
name|IoRead32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|PCI_TO_CF8_ADDRESS
argument_list|(
name|Address
argument_list|)
argument_list|)
expr_stmt|;
name|Result
operator|=
name|IoBitFieldAnd16
argument_list|(
name|PCI_CONFIGURATION_DATA_PORT
operator|+
call|(
name|UINT16
call|)
argument_list|(
name|Address
operator|&
literal|2
argument_list|)
argument_list|,
name|StartBit
argument_list|,
name|EndBit
argument_list|,
name|AndData
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|AddressPort
argument_list|)
expr_stmt|;
name|SetInterruptState
argument_list|(
name|InterruptState
argument_list|)
expr_stmt|;
return|return
name|Result
return|;
block|}
end_function

begin_comment
comment|/**   Reads a bit field in a 16-bit port, performs a bitwise AND followed by a   bitwise OR, and writes the result back to the bit field in the   16-bit port.    Reads the 16-bit PCI configuration register specified by Address, performs a   bitwise AND followed by a bitwise OR between the read result and   the value specified by AndData, and writes the result to the 16-bit PCI   configuration register specified by Address. The value written to the PCI   configuration register is returned. This function must guarantee that all PCI   read and write operations are serialized. Extra left bits in both AndData and   OrData are stripped.    If Address> 0x0FFFFFFF, then ASSERT().   If Address is not aligned on a 16-bit boundary, then ASSERT().   If the register specified by Address>= 0x100, then ASSERT().   If StartBit is greater than 15, then ASSERT().   If EndBit is greater than 15, then ASSERT().   If EndBit is less than StartBit, then ASSERT().   If AndData is larger than the bitmask value range specified by StartBit and EndBit, then ASSERT().   If OrData is larger than the bitmask value range specified by StartBit and EndBit, then ASSERT().    @param  Address   The PCI configuration register to write.   @param  StartBit  The ordinal of the least significant bit in the bit field.                     Range 0..15.   @param  EndBit    The ordinal of the most significant bit in the bit field.                     Range 0..15.   @param  AndData   The value to AND with the PCI configuration register.   @param  OrData    The value to OR with the result of the AND operation.    @return The value written back to the PCI configuration register.  **/
end_comment

begin_function
name|UINT16
name|EFIAPI
name|PciCf8BitFieldAndThenOr16
parameter_list|(
name|IN
name|UINTN
name|Address
parameter_list|,
name|IN
name|UINTN
name|StartBit
parameter_list|,
name|IN
name|UINTN
name|EndBit
parameter_list|,
name|IN
name|UINT16
name|AndData
parameter_list|,
name|IN
name|UINT16
name|OrData
parameter_list|)
block|{
name|BOOLEAN
name|InterruptState
decl_stmt|;
name|UINT32
name|AddressPort
decl_stmt|;
name|UINT16
name|Result
decl_stmt|;
name|ASSERT_INVALID_PCI_ADDRESS
argument_list|(
name|Address
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|InterruptState
operator|=
name|SaveAndDisableInterrupts
argument_list|()
expr_stmt|;
name|AddressPort
operator|=
name|IoRead32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|PCI_TO_CF8_ADDRESS
argument_list|(
name|Address
argument_list|)
argument_list|)
expr_stmt|;
name|Result
operator|=
name|IoBitFieldAndThenOr16
argument_list|(
name|PCI_CONFIGURATION_DATA_PORT
operator|+
call|(
name|UINT16
call|)
argument_list|(
name|Address
operator|&
literal|2
argument_list|)
argument_list|,
name|StartBit
argument_list|,
name|EndBit
argument_list|,
name|AndData
argument_list|,
name|OrData
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|AddressPort
argument_list|)
expr_stmt|;
name|SetInterruptState
argument_list|(
name|InterruptState
argument_list|)
expr_stmt|;
return|return
name|Result
return|;
block|}
end_function

begin_comment
comment|/**   Reads a 32-bit PCI configuration register.    Reads and returns the 32-bit PCI configuration register specified by Address.   This function must guarantee that all PCI read and write operations are   serialized.    If Address> 0x0FFFFFFF, then ASSERT().   If Address is not aligned on a 32-bit boundary, then ASSERT().   If the register specified by Address>= 0x100, then ASSERT().    @param  Address The address that encodes the PCI Bus, Device, Function and                   Register.    @return The read value from the PCI configuration register.  **/
end_comment

begin_function
name|UINT32
name|EFIAPI
name|PciCf8Read32
parameter_list|(
name|IN
name|UINTN
name|Address
parameter_list|)
block|{
name|BOOLEAN
name|InterruptState
decl_stmt|;
name|UINT32
name|AddressPort
decl_stmt|;
name|UINT32
name|Result
decl_stmt|;
name|ASSERT_INVALID_PCI_ADDRESS
argument_list|(
name|Address
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|InterruptState
operator|=
name|SaveAndDisableInterrupts
argument_list|()
expr_stmt|;
name|AddressPort
operator|=
name|IoRead32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|PCI_TO_CF8_ADDRESS
argument_list|(
name|Address
argument_list|)
argument_list|)
expr_stmt|;
name|Result
operator|=
name|IoRead32
argument_list|(
name|PCI_CONFIGURATION_DATA_PORT
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|AddressPort
argument_list|)
expr_stmt|;
name|SetInterruptState
argument_list|(
name|InterruptState
argument_list|)
expr_stmt|;
return|return
name|Result
return|;
block|}
end_function

begin_comment
comment|/**   Writes a 32-bit PCI configuration register.    Writes the 32-bit PCI configuration register specified by Address with the   value specified by Value. Value is returned. This function must guarantee   that all PCI read and write operations are serialized.    If Address> 0x0FFFFFFF, then ASSERT().   If Address is not aligned on a 32-bit boundary, then ASSERT().   If the register specified by Address>= 0x100, then ASSERT().    @param  Address The address that encodes the PCI Bus, Device, Function and                   Register.   @param  Value   The value to write.    @return The value written to the PCI configuration register.  **/
end_comment

begin_function
name|UINT32
name|EFIAPI
name|PciCf8Write32
parameter_list|(
name|IN
name|UINTN
name|Address
parameter_list|,
name|IN
name|UINT32
name|Value
parameter_list|)
block|{
name|BOOLEAN
name|InterruptState
decl_stmt|;
name|UINT32
name|AddressPort
decl_stmt|;
name|UINT32
name|Result
decl_stmt|;
name|ASSERT_INVALID_PCI_ADDRESS
argument_list|(
name|Address
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|InterruptState
operator|=
name|SaveAndDisableInterrupts
argument_list|()
expr_stmt|;
name|AddressPort
operator|=
name|IoRead32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|PCI_TO_CF8_ADDRESS
argument_list|(
name|Address
argument_list|)
argument_list|)
expr_stmt|;
name|Result
operator|=
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_DATA_PORT
argument_list|,
name|Value
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|AddressPort
argument_list|)
expr_stmt|;
name|SetInterruptState
argument_list|(
name|InterruptState
argument_list|)
expr_stmt|;
return|return
name|Result
return|;
block|}
end_function

begin_comment
comment|/**   Performs a bitwise OR of a 32-bit PCI configuration register with   a 32-bit value.    Reads the 32-bit PCI configuration register specified by Address, performs a   bitwise OR between the read result and the value specified by   OrData, and writes the result to the 32-bit PCI configuration register   specified by Address. The value written to the PCI configuration register is   returned. This function must guarantee that all PCI read and write operations   are serialized.    If Address> 0x0FFFFFFF, then ASSERT().   If Address is not aligned on a 32-bit boundary, then ASSERT().   If the register specified by Address>= 0x100, then ASSERT().    @param  Address The address that encodes the PCI Bus, Device, Function and                   Register.   @param  OrData  The value to OR with the PCI configuration register.    @return The value written back to the PCI configuration register.  **/
end_comment

begin_function
name|UINT32
name|EFIAPI
name|PciCf8Or32
parameter_list|(
name|IN
name|UINTN
name|Address
parameter_list|,
name|IN
name|UINT32
name|OrData
parameter_list|)
block|{
name|BOOLEAN
name|InterruptState
decl_stmt|;
name|UINT32
name|AddressPort
decl_stmt|;
name|UINT32
name|Result
decl_stmt|;
name|ASSERT_INVALID_PCI_ADDRESS
argument_list|(
name|Address
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|InterruptState
operator|=
name|SaveAndDisableInterrupts
argument_list|()
expr_stmt|;
name|AddressPort
operator|=
name|IoRead32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|PCI_TO_CF8_ADDRESS
argument_list|(
name|Address
argument_list|)
argument_list|)
expr_stmt|;
name|Result
operator|=
name|IoOr32
argument_list|(
name|PCI_CONFIGURATION_DATA_PORT
argument_list|,
name|OrData
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|AddressPort
argument_list|)
expr_stmt|;
name|SetInterruptState
argument_list|(
name|InterruptState
argument_list|)
expr_stmt|;
return|return
name|Result
return|;
block|}
end_function

begin_comment
comment|/**   Performs a bitwise AND of a 32-bit PCI configuration register with a 32-bit   value.    Reads the 32-bit PCI configuration register specified by Address, performs a   bitwise AND between the read result and the value specified by AndData, and   writes the result to the 32-bit PCI configuration register specified by   Address. The value written to the PCI configuration register is returned.   This function must guarantee that all PCI read and write operations are   serialized.    If Address> 0x0FFFFFFF, then ASSERT().   If Address is not aligned on a 32-bit boundary, then ASSERT().   If the register specified by Address>= 0x100, then ASSERT().    @param  Address The address that encodes the PCI Bus, Device, Function and                   Register.   @param  AndData The value to AND with the PCI configuration register.    @return The value written back to the PCI configuration register.  **/
end_comment

begin_function
name|UINT32
name|EFIAPI
name|PciCf8And32
parameter_list|(
name|IN
name|UINTN
name|Address
parameter_list|,
name|IN
name|UINT32
name|AndData
parameter_list|)
block|{
name|BOOLEAN
name|InterruptState
decl_stmt|;
name|UINT32
name|AddressPort
decl_stmt|;
name|UINT32
name|Result
decl_stmt|;
name|ASSERT_INVALID_PCI_ADDRESS
argument_list|(
name|Address
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|InterruptState
operator|=
name|SaveAndDisableInterrupts
argument_list|()
expr_stmt|;
name|AddressPort
operator|=
name|IoRead32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|PCI_TO_CF8_ADDRESS
argument_list|(
name|Address
argument_list|)
argument_list|)
expr_stmt|;
name|Result
operator|=
name|IoAnd32
argument_list|(
name|PCI_CONFIGURATION_DATA_PORT
argument_list|,
name|AndData
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|AddressPort
argument_list|)
expr_stmt|;
name|SetInterruptState
argument_list|(
name|InterruptState
argument_list|)
expr_stmt|;
return|return
name|Result
return|;
block|}
end_function

begin_comment
comment|/**   Performs a bitwise AND of a 32-bit PCI configuration register with a 32-bit   value, followed a  bitwise OR with another 32-bit value.    Reads the 32-bit PCI configuration register specified by Address, performs a   bitwise AND between the read result and the value specified by AndData,   performs a bitwise OR between the result of the AND operation and   the value specified by OrData, and writes the result to the 32-bit PCI   configuration register specified by Address. The value written to the PCI   configuration register is returned. This function must guarantee that all PCI   read and write operations are serialized.    If Address> 0x0FFFFFFF, then ASSERT().   If Address is not aligned on a 32-bit boundary, then ASSERT().   If the register specified by Address>= 0x100, then ASSERT().    @param  Address The address that encodes the PCI Bus, Device, Function and                   Register.   @param  AndData The value to AND with the PCI configuration register.   @param  OrData  The value to OR with the result of the AND operation.    @return The value written back to the PCI configuration register.  **/
end_comment

begin_function
name|UINT32
name|EFIAPI
name|PciCf8AndThenOr32
parameter_list|(
name|IN
name|UINTN
name|Address
parameter_list|,
name|IN
name|UINT32
name|AndData
parameter_list|,
name|IN
name|UINT32
name|OrData
parameter_list|)
block|{
name|BOOLEAN
name|InterruptState
decl_stmt|;
name|UINT32
name|AddressPort
decl_stmt|;
name|UINT32
name|Result
decl_stmt|;
name|ASSERT_INVALID_PCI_ADDRESS
argument_list|(
name|Address
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|InterruptState
operator|=
name|SaveAndDisableInterrupts
argument_list|()
expr_stmt|;
name|AddressPort
operator|=
name|IoRead32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|PCI_TO_CF8_ADDRESS
argument_list|(
name|Address
argument_list|)
argument_list|)
expr_stmt|;
name|Result
operator|=
name|IoAndThenOr32
argument_list|(
name|PCI_CONFIGURATION_DATA_PORT
argument_list|,
name|AndData
argument_list|,
name|OrData
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|AddressPort
argument_list|)
expr_stmt|;
name|SetInterruptState
argument_list|(
name|InterruptState
argument_list|)
expr_stmt|;
return|return
name|Result
return|;
block|}
end_function

begin_comment
comment|/**   Reads a bit field of a PCI configuration register.    Reads the bit field in a 32-bit PCI configuration register. The bit field is   specified by the StartBit and the EndBit. The value of the bit field is   returned.    If Address> 0x0FFFFFFF, then ASSERT().   If Address is not aligned on a 32-bit boundary, then ASSERT().   If the register specified by Address>= 0x100, then ASSERT().   If StartBit is greater than 31, then ASSERT().   If EndBit is greater than 31, then ASSERT().   If EndBit is less than StartBit, then ASSERT().    @param  Address   The PCI configuration register to read.   @param  StartBit  The ordinal of the least significant bit in the bit field.                     Range 0..31.   @param  EndBit    The ordinal of the most significant bit in the bit field.                     Range 0..31.    @return The value of the bit field read from the PCI configuration register.  **/
end_comment

begin_function
name|UINT32
name|EFIAPI
name|PciCf8BitFieldRead32
parameter_list|(
name|IN
name|UINTN
name|Address
parameter_list|,
name|IN
name|UINTN
name|StartBit
parameter_list|,
name|IN
name|UINTN
name|EndBit
parameter_list|)
block|{
name|BOOLEAN
name|InterruptState
decl_stmt|;
name|UINT32
name|AddressPort
decl_stmt|;
name|UINT32
name|Result
decl_stmt|;
name|ASSERT_INVALID_PCI_ADDRESS
argument_list|(
name|Address
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|InterruptState
operator|=
name|SaveAndDisableInterrupts
argument_list|()
expr_stmt|;
name|AddressPort
operator|=
name|IoRead32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|PCI_TO_CF8_ADDRESS
argument_list|(
name|Address
argument_list|)
argument_list|)
expr_stmt|;
name|Result
operator|=
name|IoBitFieldRead32
argument_list|(
name|PCI_CONFIGURATION_DATA_PORT
argument_list|,
name|StartBit
argument_list|,
name|EndBit
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|AddressPort
argument_list|)
expr_stmt|;
name|SetInterruptState
argument_list|(
name|InterruptState
argument_list|)
expr_stmt|;
return|return
name|Result
return|;
block|}
end_function

begin_comment
comment|/**   Writes a bit field to a PCI configuration register.    Writes Value to the bit field of the PCI configuration register. The bit   field is specified by the StartBit and the EndBit. All other bits in the   destination PCI configuration register are preserved. The new value of the   32-bit register is returned.    If Address> 0x0FFFFFFF, then ASSERT().   If Address is not aligned on a 32-bit boundary, then ASSERT().   If the register specified by Address>= 0x100, then ASSERT().   If StartBit is greater than 31, then ASSERT().   If EndBit is greater than 31, then ASSERT().   If EndBit is less than StartBit, then ASSERT().   If Value is larger than the bitmask value range specified by StartBit and EndBit, then ASSERT().    @param  Address   The PCI configuration register to write.   @param  StartBit  The ordinal of the least significant bit in the bit field.                     Range 0..31.   @param  EndBit    The ordinal of the most significant bit in the bit field.                     Range 0..31.   @param  Value     The new value of the bit field.    @return The value written back to the PCI configuration register.  **/
end_comment

begin_function
name|UINT32
name|EFIAPI
name|PciCf8BitFieldWrite32
parameter_list|(
name|IN
name|UINTN
name|Address
parameter_list|,
name|IN
name|UINTN
name|StartBit
parameter_list|,
name|IN
name|UINTN
name|EndBit
parameter_list|,
name|IN
name|UINT32
name|Value
parameter_list|)
block|{
name|BOOLEAN
name|InterruptState
decl_stmt|;
name|UINT32
name|AddressPort
decl_stmt|;
name|UINT32
name|Result
decl_stmt|;
name|ASSERT_INVALID_PCI_ADDRESS
argument_list|(
name|Address
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|InterruptState
operator|=
name|SaveAndDisableInterrupts
argument_list|()
expr_stmt|;
name|AddressPort
operator|=
name|IoRead32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|PCI_TO_CF8_ADDRESS
argument_list|(
name|Address
argument_list|)
argument_list|)
expr_stmt|;
name|Result
operator|=
name|IoBitFieldWrite32
argument_list|(
name|PCI_CONFIGURATION_DATA_PORT
argument_list|,
name|StartBit
argument_list|,
name|EndBit
argument_list|,
name|Value
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|AddressPort
argument_list|)
expr_stmt|;
name|SetInterruptState
argument_list|(
name|InterruptState
argument_list|)
expr_stmt|;
return|return
name|Result
return|;
block|}
end_function

begin_comment
comment|/**   Reads a bit field in a 32-bit PCI configuration, performs a bitwise OR, and   writes the result back to the bit field in the 32-bit port.    Reads the 32-bit PCI configuration register specified by Address, performs a   bitwise OR between the read result and the value specified by   OrData, and writes the result to the 32-bit PCI configuration register   specified by Address. The value written to the PCI configuration register is   returned. This function must guarantee that all PCI read and write operations   are serialized. Extra left bits in OrData are stripped.    If Address> 0x0FFFFFFF, then ASSERT().   If Address is not aligned on a 32-bit boundary, then ASSERT().   If the register specified by Address>= 0x100, then ASSERT().   If StartBit is greater than 31, then ASSERT().   If EndBit is greater than 31, then ASSERT().   If EndBit is less than StartBit, then ASSERT().   If OrData is larger than the bitmask value range specified by StartBit and EndBit, then ASSERT().    @param  Address   The PCI configuration register to write.   @param  StartBit  The ordinal of the least significant bit in the bit field.                     Range 0..31.   @param  EndBit    The ordinal of the most significant bit in the bit field.                     Range 0..31.   @param  OrData    The value to OR with the PCI configuration register.    @return The value written back to the PCI configuration register.  **/
end_comment

begin_function
name|UINT32
name|EFIAPI
name|PciCf8BitFieldOr32
parameter_list|(
name|IN
name|UINTN
name|Address
parameter_list|,
name|IN
name|UINTN
name|StartBit
parameter_list|,
name|IN
name|UINTN
name|EndBit
parameter_list|,
name|IN
name|UINT32
name|OrData
parameter_list|)
block|{
name|BOOLEAN
name|InterruptState
decl_stmt|;
name|UINT32
name|AddressPort
decl_stmt|;
name|UINT32
name|Result
decl_stmt|;
name|ASSERT_INVALID_PCI_ADDRESS
argument_list|(
name|Address
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|InterruptState
operator|=
name|SaveAndDisableInterrupts
argument_list|()
expr_stmt|;
name|AddressPort
operator|=
name|IoRead32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|PCI_TO_CF8_ADDRESS
argument_list|(
name|Address
argument_list|)
argument_list|)
expr_stmt|;
name|Result
operator|=
name|IoBitFieldOr32
argument_list|(
name|PCI_CONFIGURATION_DATA_PORT
argument_list|,
name|StartBit
argument_list|,
name|EndBit
argument_list|,
name|OrData
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|AddressPort
argument_list|)
expr_stmt|;
name|SetInterruptState
argument_list|(
name|InterruptState
argument_list|)
expr_stmt|;
return|return
name|Result
return|;
block|}
end_function

begin_comment
comment|/**   Reads a bit field in a 32-bit PCI configuration register, performs a bitwise   AND, and writes the result back to the bit field in the 32-bit register.    Reads the 32-bit PCI configuration register specified by Address, performs a   bitwise AND between the read result and the value specified by AndData, and   writes the result to the 32-bit PCI configuration register specified by   Address. The value written to the PCI configuration register is returned.   This function must guarantee that all PCI read and write operations are   serialized. Extra left bits in AndData are stripped.    If Address> 0x0FFFFFFF, then ASSERT().   If Address is not aligned on a 32-bit boundary, then ASSERT().   If the register specified by Address>= 0x100, then ASSERT().   If StartBit is greater than 31, then ASSERT().   If EndBit is greater than 31, then ASSERT().   If EndBit is less than StartBit, then ASSERT().   If AndData is larger than the bitmask value range specified by StartBit and EndBit, then ASSERT().    @param  Address   The PCI configuration register to write.   @param  StartBit  The ordinal of the least significant bit in the bit field.                     Range 0..31.   @param  EndBit    The ordinal of the most significant bit in the bit field.                     Range 0..31.   @param  AndData   The value to AND with the PCI configuration register.    @return The value written back to the PCI configuration register.  **/
end_comment

begin_function
name|UINT32
name|EFIAPI
name|PciCf8BitFieldAnd32
parameter_list|(
name|IN
name|UINTN
name|Address
parameter_list|,
name|IN
name|UINTN
name|StartBit
parameter_list|,
name|IN
name|UINTN
name|EndBit
parameter_list|,
name|IN
name|UINT32
name|AndData
parameter_list|)
block|{
name|BOOLEAN
name|InterruptState
decl_stmt|;
name|UINT32
name|AddressPort
decl_stmt|;
name|UINT32
name|Result
decl_stmt|;
name|ASSERT_INVALID_PCI_ADDRESS
argument_list|(
name|Address
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|InterruptState
operator|=
name|SaveAndDisableInterrupts
argument_list|()
expr_stmt|;
name|AddressPort
operator|=
name|IoRead32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|PCI_TO_CF8_ADDRESS
argument_list|(
name|Address
argument_list|)
argument_list|)
expr_stmt|;
name|Result
operator|=
name|IoBitFieldAnd32
argument_list|(
name|PCI_CONFIGURATION_DATA_PORT
argument_list|,
name|StartBit
argument_list|,
name|EndBit
argument_list|,
name|AndData
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|AddressPort
argument_list|)
expr_stmt|;
name|SetInterruptState
argument_list|(
name|InterruptState
argument_list|)
expr_stmt|;
return|return
name|Result
return|;
block|}
end_function

begin_comment
comment|/**   Reads a bit field in a 32-bit port, performs a bitwise AND followed by a   bitwise OR, and writes the result back to the bit field in the   32-bit port.    Reads the 32-bit PCI configuration register specified by Address, performs a   bitwise AND followed by a bitwise OR between the read result and   the value specified by AndData, and writes the result to the 32-bit PCI   configuration register specified by Address. The value written to the PCI   configuration register is returned. This function must guarantee that all PCI   read and write operations are serialized. Extra left bits in both AndData and   OrData are stripped.    If Address> 0x0FFFFFFF, then ASSERT().   If Address is not aligned on a 32-bit boundary, then ASSERT().   If the register specified by Address>= 0x100, then ASSERT().   If StartBit is greater than 31, then ASSERT().   If EndBit is greater than 31, then ASSERT().   If EndBit is less than StartBit, then ASSERT().   If AndData is larger than the bitmask value range specified by StartBit and EndBit, then ASSERT().   If OrData is larger than the bitmask value range specified by StartBit and EndBit, then ASSERT().    @param  Address   The PCI configuration register to write.   @param  StartBit  The ordinal of the least significant bit in the bit field.                     Range 0..31.   @param  EndBit    The ordinal of the most significant bit in the bit field.                     Range 0..31.   @param  AndData   The value to AND with the PCI configuration register.   @param  OrData    The value to OR with the result of the AND operation.    @return The value written back to the PCI configuration register.  **/
end_comment

begin_function
name|UINT32
name|EFIAPI
name|PciCf8BitFieldAndThenOr32
parameter_list|(
name|IN
name|UINTN
name|Address
parameter_list|,
name|IN
name|UINTN
name|StartBit
parameter_list|,
name|IN
name|UINTN
name|EndBit
parameter_list|,
name|IN
name|UINT32
name|AndData
parameter_list|,
name|IN
name|UINT32
name|OrData
parameter_list|)
block|{
name|BOOLEAN
name|InterruptState
decl_stmt|;
name|UINT32
name|AddressPort
decl_stmt|;
name|UINT32
name|Result
decl_stmt|;
name|ASSERT_INVALID_PCI_ADDRESS
argument_list|(
name|Address
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|InterruptState
operator|=
name|SaveAndDisableInterrupts
argument_list|()
expr_stmt|;
name|AddressPort
operator|=
name|IoRead32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|PCI_TO_CF8_ADDRESS
argument_list|(
name|Address
argument_list|)
argument_list|)
expr_stmt|;
name|Result
operator|=
name|IoBitFieldAndThenOr32
argument_list|(
name|PCI_CONFIGURATION_DATA_PORT
argument_list|,
name|StartBit
argument_list|,
name|EndBit
argument_list|,
name|AndData
argument_list|,
name|OrData
argument_list|)
expr_stmt|;
name|IoWrite32
argument_list|(
name|PCI_CONFIGURATION_ADDRESS_PORT
argument_list|,
name|AddressPort
argument_list|)
expr_stmt|;
name|SetInterruptState
argument_list|(
name|InterruptState
argument_list|)
expr_stmt|;
return|return
name|Result
return|;
block|}
end_function

begin_comment
comment|/**   Reads a range of PCI configuration registers into a caller supplied buffer.    Reads the range of PCI configuration registers specified by StartAddress and   Size into the buffer specified by Buffer. This function only allows the PCI   configuration registers from a single PCI function to be read. Size is   returned. When possible 32-bit PCI configuration read cycles are used to read   from StartAdress to StartAddress + Size. Due to alignment restrictions, 8-bit   and 16-bit PCI configuration read cycles may be used at the beginning and the   end of the range.    If StartAddress> 0x0FFFFFFF, then ASSERT().   If the register specified by StartAddress>= 0x100, then ASSERT().   If ((StartAddress& 0xFFF) + Size)> 0x100, then ASSERT().   If Size> 0 and Buffer is NULL, then ASSERT().    @param  StartAddress  The starting address that encodes the PCI Bus, Device,                         Function and Register.   @param  Size          The size in bytes of the transfer.   @param  Buffer        The pointer to a buffer receiving the data read.    @return Size read from StartAddress.  **/
end_comment

begin_function
name|UINTN
name|EFIAPI
name|PciCf8ReadBuffer
parameter_list|(
name|IN
name|UINTN
name|StartAddress
parameter_list|,
name|IN
name|UINTN
name|Size
parameter_list|,
name|OUT
name|VOID
modifier|*
name|Buffer
parameter_list|)
block|{
name|UINTN
name|ReturnValue
decl_stmt|;
name|ASSERT_INVALID_PCI_ADDRESS
argument_list|(
name|StartAddress
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
operator|(
operator|(
name|StartAddress
operator|&
literal|0xFFF
operator|)
operator|+
name|Size
operator|)
operator|<=
literal|0x100
argument_list|)
expr_stmt|;
if|if
condition|(
name|Size
operator|==
literal|0
condition|)
block|{
return|return
name|Size
return|;
block|}
name|ASSERT
argument_list|(
name|Buffer
operator|!=
name|NULL
argument_list|)
expr_stmt|;
comment|//
comment|// Save Size for return
comment|//
name|ReturnValue
operator|=
name|Size
expr_stmt|;
if|if
condition|(
operator|(
name|StartAddress
operator|&
literal|1
operator|)
operator|!=
literal|0
condition|)
block|{
comment|//
comment|// Read a byte if StartAddress is byte aligned
comment|//
operator|*
operator|(
specifier|volatile
name|UINT8
operator|*
operator|)
name|Buffer
operator|=
name|PciCf8Read8
argument_list|(
name|StartAddress
argument_list|)
expr_stmt|;
name|StartAddress
operator|+=
sizeof|sizeof
argument_list|(
name|UINT8
argument_list|)
expr_stmt|;
name|Size
operator|-=
sizeof|sizeof
argument_list|(
name|UINT8
argument_list|)
expr_stmt|;
name|Buffer
operator|=
operator|(
name|UINT8
operator|*
operator|)
name|Buffer
operator|+
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|Size
operator|>=
sizeof|sizeof
argument_list|(
name|UINT16
argument_list|)
operator|&&
operator|(
name|StartAddress
operator|&
literal|2
operator|)
operator|!=
literal|0
condition|)
block|{
comment|//
comment|// Read a word if StartAddress is word aligned
comment|//
name|WriteUnaligned16
argument_list|(
operator|(
name|UINT16
operator|*
operator|)
name|Buffer
argument_list|,
operator|(
name|UINT16
operator|)
name|PciCf8Read16
argument_list|(
name|StartAddress
argument_list|)
argument_list|)
expr_stmt|;
name|StartAddress
operator|+=
sizeof|sizeof
argument_list|(
name|UINT16
argument_list|)
expr_stmt|;
name|Size
operator|-=
sizeof|sizeof
argument_list|(
name|UINT16
argument_list|)
expr_stmt|;
name|Buffer
operator|=
operator|(
name|UINT16
operator|*
operator|)
name|Buffer
operator|+
literal|1
expr_stmt|;
block|}
while|while
condition|(
name|Size
operator|>=
sizeof|sizeof
argument_list|(
name|UINT32
argument_list|)
condition|)
block|{
comment|//
comment|// Read as many double words as possible
comment|//
name|WriteUnaligned32
argument_list|(
operator|(
name|UINT32
operator|*
operator|)
name|Buffer
argument_list|,
operator|(
name|UINT32
operator|)
name|PciCf8Read32
argument_list|(
name|StartAddress
argument_list|)
argument_list|)
expr_stmt|;
name|StartAddress
operator|+=
sizeof|sizeof
argument_list|(
name|UINT32
argument_list|)
expr_stmt|;
name|Size
operator|-=
sizeof|sizeof
argument_list|(
name|UINT32
argument_list|)
expr_stmt|;
name|Buffer
operator|=
operator|(
name|UINT32
operator|*
operator|)
name|Buffer
operator|+
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|Size
operator|>=
sizeof|sizeof
argument_list|(
name|UINT16
argument_list|)
condition|)
block|{
comment|//
comment|// Read the last remaining word if exist
comment|//
name|WriteUnaligned16
argument_list|(
operator|(
name|UINT16
operator|*
operator|)
name|Buffer
argument_list|,
operator|(
name|UINT16
operator|)
name|PciCf8Read16
argument_list|(
name|StartAddress
argument_list|)
argument_list|)
expr_stmt|;
name|StartAddress
operator|+=
sizeof|sizeof
argument_list|(
name|UINT16
argument_list|)
expr_stmt|;
name|Size
operator|-=
sizeof|sizeof
argument_list|(
name|UINT16
argument_list|)
expr_stmt|;
name|Buffer
operator|=
operator|(
name|UINT16
operator|*
operator|)
name|Buffer
operator|+
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|Size
operator|>=
sizeof|sizeof
argument_list|(
name|UINT8
argument_list|)
condition|)
block|{
comment|//
comment|// Read the last remaining byte if exist
comment|//
operator|*
operator|(
specifier|volatile
name|UINT8
operator|*
operator|)
name|Buffer
operator|=
name|PciCf8Read8
argument_list|(
name|StartAddress
argument_list|)
expr_stmt|;
block|}
return|return
name|ReturnValue
return|;
block|}
end_function

begin_comment
comment|/**   Copies the data in a caller supplied buffer to a specified range of PCI   configuration space.    Writes the range of PCI configuration registers specified by StartAddress and   Size from the buffer specified by Buffer. This function only allows the PCI   configuration registers from a single PCI function to be written. Size is   returned. When possible 32-bit PCI configuration write cycles are used to   write from StartAdress to StartAddress + Size. Due to alignment restrictions,   8-bit and 16-bit PCI configuration write cycles may be used at the beginning   and the end of the range.    If StartAddress> 0x0FFFFFFF, then ASSERT().   If the register specified by StartAddress>= 0x100, then ASSERT().   If ((StartAddress& 0xFFF) + Size)> 0x100, then ASSERT().   If Size> 0 and Buffer is NULL, then ASSERT().    @param  StartAddress  The starting address that encodes the PCI Bus, Device,                         Function and Register.   @param  Size          The size in bytes of the transfer.   @param  Buffer        The pointer to a buffer containing the data to write.    @return Size written to StartAddress.  **/
end_comment

begin_function
name|UINTN
name|EFIAPI
name|PciCf8WriteBuffer
parameter_list|(
name|IN
name|UINTN
name|StartAddress
parameter_list|,
name|IN
name|UINTN
name|Size
parameter_list|,
name|IN
name|VOID
modifier|*
name|Buffer
parameter_list|)
block|{
name|UINTN
name|ReturnValue
decl_stmt|;
name|ASSERT_INVALID_PCI_ADDRESS
argument_list|(
name|StartAddress
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
operator|(
operator|(
name|StartAddress
operator|&
literal|0xFFF
operator|)
operator|+
name|Size
operator|)
operator|<=
literal|0x100
argument_list|)
expr_stmt|;
if|if
condition|(
name|Size
operator|==
literal|0
condition|)
block|{
return|return
literal|0
return|;
block|}
name|ASSERT
argument_list|(
name|Buffer
operator|!=
name|NULL
argument_list|)
expr_stmt|;
comment|//
comment|// Save Size for return
comment|//
name|ReturnValue
operator|=
name|Size
expr_stmt|;
if|if
condition|(
operator|(
name|StartAddress
operator|&
literal|1
operator|)
operator|!=
literal|0
condition|)
block|{
comment|//
comment|// Write a byte if StartAddress is byte aligned
comment|//
name|PciCf8Write8
argument_list|(
name|StartAddress
argument_list|,
operator|*
operator|(
name|UINT8
operator|*
operator|)
name|Buffer
argument_list|)
expr_stmt|;
name|StartAddress
operator|+=
sizeof|sizeof
argument_list|(
name|UINT8
argument_list|)
expr_stmt|;
name|Size
operator|-=
sizeof|sizeof
argument_list|(
name|UINT8
argument_list|)
expr_stmt|;
name|Buffer
operator|=
operator|(
name|UINT8
operator|*
operator|)
name|Buffer
operator|+
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|Size
operator|>=
sizeof|sizeof
argument_list|(
name|UINT16
argument_list|)
operator|&&
operator|(
name|StartAddress
operator|&
literal|2
operator|)
operator|!=
literal|0
condition|)
block|{
comment|//
comment|// Write a word if StartAddress is word aligned
comment|//
name|PciCf8Write16
argument_list|(
name|StartAddress
argument_list|,
name|ReadUnaligned16
argument_list|(
operator|(
name|UINT16
operator|*
operator|)
name|Buffer
argument_list|)
argument_list|)
expr_stmt|;
name|StartAddress
operator|+=
sizeof|sizeof
argument_list|(
name|UINT16
argument_list|)
expr_stmt|;
name|Size
operator|-=
sizeof|sizeof
argument_list|(
name|UINT16
argument_list|)
expr_stmt|;
name|Buffer
operator|=
operator|(
name|UINT16
operator|*
operator|)
name|Buffer
operator|+
literal|1
expr_stmt|;
block|}
while|while
condition|(
name|Size
operator|>=
sizeof|sizeof
argument_list|(
name|UINT32
argument_list|)
condition|)
block|{
comment|//
comment|// Write as many double words as possible
comment|//
name|PciCf8Write32
argument_list|(
name|StartAddress
argument_list|,
name|ReadUnaligned32
argument_list|(
operator|(
name|UINT32
operator|*
operator|)
name|Buffer
argument_list|)
argument_list|)
expr_stmt|;
name|StartAddress
operator|+=
sizeof|sizeof
argument_list|(
name|UINT32
argument_list|)
expr_stmt|;
name|Size
operator|-=
sizeof|sizeof
argument_list|(
name|UINT32
argument_list|)
expr_stmt|;
name|Buffer
operator|=
operator|(
name|UINT32
operator|*
operator|)
name|Buffer
operator|+
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|Size
operator|>=
sizeof|sizeof
argument_list|(
name|UINT16
argument_list|)
condition|)
block|{
comment|//
comment|// Write the last remaining word if exist
comment|//
name|PciCf8Write16
argument_list|(
name|StartAddress
argument_list|,
name|ReadUnaligned16
argument_list|(
operator|(
name|UINT16
operator|*
operator|)
name|Buffer
argument_list|)
argument_list|)
expr_stmt|;
name|StartAddress
operator|+=
sizeof|sizeof
argument_list|(
name|UINT16
argument_list|)
expr_stmt|;
name|Size
operator|-=
sizeof|sizeof
argument_list|(
name|UINT16
argument_list|)
expr_stmt|;
name|Buffer
operator|=
operator|(
name|UINT16
operator|*
operator|)
name|Buffer
operator|+
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|Size
operator|>=
sizeof|sizeof
argument_list|(
name|UINT8
argument_list|)
condition|)
block|{
comment|//
comment|// Write the last remaining byte if exist
comment|//
name|PciCf8Write8
argument_list|(
name|StartAddress
argument_list|,
operator|*
operator|(
name|UINT8
operator|*
operator|)
name|Buffer
argument_list|)
expr_stmt|;
block|}
return|return
name|ReturnValue
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/** @file   Provide Hob Library functions for Pei phase.  Copyright (c) 2007 - 2016, Intel Corporation. All rights reserved.<BR> This program and the accompanying materials are licensed and made available under the terms and conditions of the BSD License which accompanies this distribution.  The full text of the license may be found at http://opensource.org/licenses/bsd-license.php.  THE PROGRAM IS DISTRIBUTED UNDER THE BSD LICENSE ON AN "AS IS" BASIS, WITHOUT WARRANTIES OR REPRESENTATIONS OF ANY KIND, EITHER EXPRESS OR IMPLIED.  **/
end_comment

begin_include
include|#
directive|include
file|<PiPei.h>
end_include

begin_include
include|#
directive|include
file|<Guid/MemoryAllocationHob.h>
end_include

begin_include
include|#
directive|include
file|<Library/HobLib.h>
end_include

begin_include
include|#
directive|include
file|<Library/DebugLib.h>
end_include

begin_include
include|#
directive|include
file|<Library/PeiServicesLib.h>
end_include

begin_include
include|#
directive|include
file|<Library/BaseMemoryLib.h>
end_include

begin_comment
comment|/**   Returns the pointer to the HOB list.    This function returns the pointer to first HOB in the list.   For PEI phase, the PEI service GetHobList() can be used to retrieve the pointer    to the HOB list.  For the DXE phase, the HOB list pointer can be retrieved through   the EFI System Table by looking up theHOB list GUID in the System Configuration Table.   Since the System Configuration Table does not exist that the time the DXE Core is    launched, the DXE Core uses a global variable from the DXE Core Entry Point Library    to manage the pointer to the HOB list.      If the pointer to the HOB list is NULL, then ASSERT().      @return The pointer to the HOB list.  **/
end_comment

begin_function
name|VOID
modifier|*
name|EFIAPI
name|GetHobList
parameter_list|(
name|VOID
parameter_list|)
block|{
name|EFI_STATUS
name|Status
decl_stmt|;
name|VOID
modifier|*
name|HobList
decl_stmt|;
name|Status
operator|=
name|PeiServicesGetHobList
argument_list|(
operator|&
name|HobList
argument_list|)
expr_stmt|;
name|ASSERT_EFI_ERROR
argument_list|(
name|Status
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|HobList
operator|!=
name|NULL
argument_list|)
expr_stmt|;
return|return
name|HobList
return|;
block|}
end_function

begin_comment
comment|/**   Returns the next instance of a HOB type from the starting HOB.    This function searches the first instance of a HOB type from the starting HOB pointer.    If there does not exist such HOB type from the starting HOB pointer, it will return NULL.   In contrast with macro GET_NEXT_HOB(), this function does not skip the starting HOB pointer   unconditionally: it returns HobStart back if HobStart itself meets the requirement;   caller is required to use GET_NEXT_HOB() if it wishes to skip current HobStart.      If HobStart is NULL, then ASSERT().    @param  Type          The HOB type to return.   @param  HobStart      The starting HOB pointer to search from.    @return The next instance of a HOB type from the starting HOB.  **/
end_comment

begin_function
name|VOID
modifier|*
name|EFIAPI
name|GetNextHob
parameter_list|(
name|IN
name|UINT16
name|Type
parameter_list|,
name|IN
name|CONST
name|VOID
modifier|*
name|HobStart
parameter_list|)
block|{
name|EFI_PEI_HOB_POINTERS
name|Hob
decl_stmt|;
name|ASSERT
argument_list|(
name|HobStart
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|Hob
operator|.
name|Raw
operator|=
operator|(
name|UINT8
operator|*
operator|)
name|HobStart
expr_stmt|;
comment|//
comment|// Parse the HOB list until end of list or matching type is found.
comment|//
while|while
condition|(
operator|!
name|END_OF_HOB_LIST
argument_list|(
name|Hob
argument_list|)
condition|)
block|{
if|if
condition|(
name|Hob
operator|.
name|Header
operator|->
name|HobType
operator|==
name|Type
condition|)
block|{
return|return
name|Hob
operator|.
name|Raw
return|;
block|}
name|Hob
operator|.
name|Raw
operator|=
name|GET_NEXT_HOB
argument_list|(
name|Hob
argument_list|)
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/**   Returns the first instance of a HOB type among the whole HOB list.    This function searches the first instance of a HOB type among the whole HOB list.    If there does not exist such HOB type in the HOB list, it will return NULL.       If the pointer to the HOB list is NULL, then ASSERT().    @param  Type          The HOB type to return.    @return The next instance of a HOB type from the starting HOB.  **/
end_comment

begin_function
name|VOID
modifier|*
name|EFIAPI
name|GetFirstHob
parameter_list|(
name|IN
name|UINT16
name|Type
parameter_list|)
block|{
name|VOID
modifier|*
name|HobList
decl_stmt|;
name|HobList
operator|=
name|GetHobList
argument_list|()
expr_stmt|;
return|return
name|GetNextHob
argument_list|(
name|Type
argument_list|,
name|HobList
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**   Returns the next instance of the matched GUID HOB from the starting HOB.      This function searches the first instance of a HOB from the starting HOB pointer.    Such HOB should satisfy two conditions:    its HOB type is EFI_HOB_TYPE_GUID_EXTENSION and its GUID Name equals to the input Guid.    If there does not exist such HOB from the starting HOB pointer, it will return NULL.    Caller is required to apply GET_GUID_HOB_DATA () and GET_GUID_HOB_DATA_SIZE ()   to extract the data section and its size information, respectively.   In contrast with macro GET_NEXT_HOB(), this function does not skip the starting HOB pointer   unconditionally: it returns HobStart back if HobStart itself meets the requirement;   caller is required to use GET_NEXT_HOB() if it wishes to skip current HobStart.      If Guid is NULL, then ASSERT().   If HobStart is NULL, then ASSERT().    @param  Guid          The GUID to match with in the HOB list.   @param  HobStart      A pointer to a Guid.    @return The next instance of the matched GUID HOB from the starting HOB.  **/
end_comment

begin_function
name|VOID
modifier|*
name|EFIAPI
name|GetNextGuidHob
parameter_list|(
name|IN
name|CONST
name|EFI_GUID
modifier|*
name|Guid
parameter_list|,
name|IN
name|CONST
name|VOID
modifier|*
name|HobStart
parameter_list|)
block|{
name|EFI_PEI_HOB_POINTERS
name|GuidHob
decl_stmt|;
name|GuidHob
operator|.
name|Raw
operator|=
operator|(
name|UINT8
operator|*
operator|)
name|HobStart
expr_stmt|;
while|while
condition|(
operator|(
name|GuidHob
operator|.
name|Raw
operator|=
name|GetNextHob
argument_list|(
name|EFI_HOB_TYPE_GUID_EXTENSION
argument_list|,
name|GuidHob
operator|.
name|Raw
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|CompareGuid
argument_list|(
name|Guid
argument_list|,
operator|&
name|GuidHob
operator|.
name|Guid
operator|->
name|Name
argument_list|)
condition|)
block|{
break|break;
block|}
name|GuidHob
operator|.
name|Raw
operator|=
name|GET_NEXT_HOB
argument_list|(
name|GuidHob
argument_list|)
expr_stmt|;
block|}
return|return
name|GuidHob
operator|.
name|Raw
return|;
block|}
end_function

begin_comment
comment|/**   Returns the first instance of the matched GUID HOB among the whole HOB list.      This function searches the first instance of a HOB among the whole HOB list.    Such HOB should satisfy two conditions:   its HOB type is EFI_HOB_TYPE_GUID_EXTENSION and its GUID Name equals to the input Guid.   If there does not exist such HOB from the starting HOB pointer, it will return NULL.   Caller is required to apply GET_GUID_HOB_DATA () and GET_GUID_HOB_DATA_SIZE ()   to extract the data section and its size information, respectively.      If the pointer to the HOB list is NULL, then ASSERT().   If Guid is NULL, then ASSERT().    @param  Guid          The GUID to match with in the HOB list.    @return The first instance of the matched GUID HOB among the whole HOB list.  **/
end_comment

begin_function
name|VOID
modifier|*
name|EFIAPI
name|GetFirstGuidHob
parameter_list|(
name|IN
name|CONST
name|EFI_GUID
modifier|*
name|Guid
parameter_list|)
block|{
name|VOID
modifier|*
name|HobList
decl_stmt|;
name|HobList
operator|=
name|GetHobList
argument_list|()
expr_stmt|;
return|return
name|GetNextGuidHob
argument_list|(
name|Guid
argument_list|,
name|HobList
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**   Get the system boot mode from the HOB list.    This function returns the system boot mode information from the    PHIT HOB in HOB list.    If the pointer to the HOB list is NULL, then ASSERT().      @param  VOID.    @return The Boot Mode.  **/
end_comment

begin_function
name|EFI_BOOT_MODE
name|EFIAPI
name|GetBootModeHob
parameter_list|(
name|VOID
parameter_list|)
block|{
name|EFI_STATUS
name|Status
decl_stmt|;
name|EFI_BOOT_MODE
name|BootMode
decl_stmt|;
name|Status
operator|=
name|PeiServicesGetBootMode
argument_list|(
operator|&
name|BootMode
argument_list|)
expr_stmt|;
name|ASSERT_EFI_ERROR
argument_list|(
name|Status
argument_list|)
expr_stmt|;
return|return
name|BootMode
return|;
block|}
end_function

begin_comment
comment|/**   Adds a new HOB to the HOB List.    This internal function enables PEIMs to create various types of HOBs.    @param  Type          Type of the new HOB.   @param  Length        Length of the new HOB to allocate.    @retval  NULL         The HOB could not be allocated.   @retval  others       The address of new HOB.  **/
end_comment

begin_function
name|VOID
modifier|*
name|EFIAPI
name|InternalPeiCreateHob
parameter_list|(
name|IN
name|UINT16
name|Type
parameter_list|,
name|IN
name|UINT16
name|Length
parameter_list|)
block|{
name|EFI_STATUS
name|Status
decl_stmt|;
name|VOID
modifier|*
name|Hob
decl_stmt|;
name|Status
operator|=
name|PeiServicesCreateHob
argument_list|(
name|Type
argument_list|,
name|Length
argument_list|,
operator|&
name|Hob
argument_list|)
expr_stmt|;
if|if
condition|(
name|EFI_ERROR
argument_list|(
name|Status
argument_list|)
condition|)
block|{
name|Hob
operator|=
name|NULL
expr_stmt|;
block|}
comment|//
comment|// Assume the process of HOB building is always successful.
comment|//
name|ASSERT
argument_list|(
name|Hob
operator|!=
name|NULL
argument_list|)
expr_stmt|;
return|return
name|Hob
return|;
block|}
end_function

begin_comment
comment|/**   Builds a HOB for a loaded PE32 module.    This function builds a HOB for a loaded PE32 module.   It can only be invoked during PEI phase;   for DXE phase, it will ASSERT() since PEI HOB is read-only for DXE phase.      If ModuleName is NULL, then ASSERT().   If there is no additional space for HOB creation, then ASSERT().    @param  ModuleName              The GUID File Name of the module.   @param  MemoryAllocationModule  The 64 bit physical address of the module.   @param  ModuleLength            The length of the module in bytes.   @param  EntryPoint              The 64 bit physical address of the module entry point.  **/
end_comment

begin_function
name|VOID
name|EFIAPI
name|BuildModuleHob
parameter_list|(
name|IN
name|CONST
name|EFI_GUID
modifier|*
name|ModuleName
parameter_list|,
name|IN
name|EFI_PHYSICAL_ADDRESS
name|MemoryAllocationModule
parameter_list|,
name|IN
name|UINT64
name|ModuleLength
parameter_list|,
name|IN
name|EFI_PHYSICAL_ADDRESS
name|EntryPoint
parameter_list|)
block|{
name|EFI_HOB_MEMORY_ALLOCATION_MODULE
modifier|*
name|Hob
decl_stmt|;
name|ASSERT
argument_list|(
operator|(
operator|(
name|MemoryAllocationModule
operator|&
operator|(
name|EFI_PAGE_SIZE
operator|-
literal|1
operator|)
operator|)
operator|==
literal|0
operator|)
operator|&&
operator|(
operator|(
name|ModuleLength
operator|&
operator|(
name|EFI_PAGE_SIZE
operator|-
literal|1
operator|)
operator|)
operator|==
literal|0
operator|)
argument_list|)
expr_stmt|;
name|Hob
operator|=
name|InternalPeiCreateHob
argument_list|(
name|EFI_HOB_TYPE_MEMORY_ALLOCATION
argument_list|,
operator|(
name|UINT16
operator|)
sizeof|sizeof
argument_list|(
name|EFI_HOB_MEMORY_ALLOCATION_MODULE
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|Hob
operator|==
name|NULL
condition|)
block|{
return|return;
block|}
name|CopyGuid
argument_list|(
operator|&
operator|(
name|Hob
operator|->
name|MemoryAllocationHeader
operator|.
name|Name
operator|)
argument_list|,
operator|&
name|gEfiHobMemoryAllocModuleGuid
argument_list|)
expr_stmt|;
name|Hob
operator|->
name|MemoryAllocationHeader
operator|.
name|MemoryBaseAddress
operator|=
name|MemoryAllocationModule
expr_stmt|;
name|Hob
operator|->
name|MemoryAllocationHeader
operator|.
name|MemoryLength
operator|=
name|ModuleLength
expr_stmt|;
name|Hob
operator|->
name|MemoryAllocationHeader
operator|.
name|MemoryType
operator|=
name|EfiBootServicesCode
expr_stmt|;
comment|//
comment|// Zero the reserved space to match HOB spec
comment|//
name|ZeroMem
argument_list|(
name|Hob
operator|->
name|MemoryAllocationHeader
operator|.
name|Reserved
argument_list|,
sizeof|sizeof
argument_list|(
name|Hob
operator|->
name|MemoryAllocationHeader
operator|.
name|Reserved
argument_list|)
argument_list|)
expr_stmt|;
name|CopyGuid
argument_list|(
operator|&
name|Hob
operator|->
name|ModuleName
argument_list|,
name|ModuleName
argument_list|)
expr_stmt|;
name|Hob
operator|->
name|EntryPoint
operator|=
name|EntryPoint
expr_stmt|;
block|}
end_function

begin_comment
comment|/**   Builds a HOB that describes a chunk of system memory with Owner GUID.    This function builds a HOB that describes a chunk of system memory.   It can only be invoked during PEI phase;   for DXE phase, it will ASSERT() since PEI HOB is read-only for DXE phase.      If there is no additional space for HOB creation, then ASSERT().    @param  ResourceType        The type of resource described by this HOB.   @param  ResourceAttribute   The resource attributes of the memory described by this HOB.   @param  PhysicalStart       The 64 bit physical address of memory described by this HOB.   @param  NumberOfBytes       The length of the memory described by this HOB in bytes.   @param  OwnerGUID           GUID for the owner of this resource.  **/
end_comment

begin_function
name|VOID
name|EFIAPI
name|BuildResourceDescriptorWithOwnerHob
parameter_list|(
name|IN
name|EFI_RESOURCE_TYPE
name|ResourceType
parameter_list|,
name|IN
name|EFI_RESOURCE_ATTRIBUTE_TYPE
name|ResourceAttribute
parameter_list|,
name|IN
name|EFI_PHYSICAL_ADDRESS
name|PhysicalStart
parameter_list|,
name|IN
name|UINT64
name|NumberOfBytes
parameter_list|,
name|IN
name|EFI_GUID
modifier|*
name|OwnerGUID
parameter_list|)
block|{
name|EFI_HOB_RESOURCE_DESCRIPTOR
modifier|*
name|Hob
decl_stmt|;
name|Hob
operator|=
name|InternalPeiCreateHob
argument_list|(
name|EFI_HOB_TYPE_RESOURCE_DESCRIPTOR
argument_list|,
operator|(
name|UINT16
operator|)
sizeof|sizeof
argument_list|(
name|EFI_HOB_RESOURCE_DESCRIPTOR
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|Hob
operator|==
name|NULL
condition|)
block|{
return|return;
block|}
name|Hob
operator|->
name|ResourceType
operator|=
name|ResourceType
expr_stmt|;
name|Hob
operator|->
name|ResourceAttribute
operator|=
name|ResourceAttribute
expr_stmt|;
name|Hob
operator|->
name|PhysicalStart
operator|=
name|PhysicalStart
expr_stmt|;
name|Hob
operator|->
name|ResourceLength
operator|=
name|NumberOfBytes
expr_stmt|;
name|CopyGuid
argument_list|(
operator|&
name|Hob
operator|->
name|Owner
argument_list|,
name|OwnerGUID
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**   Builds a HOB that describes a chunk of system memory.    This function builds a HOB that describes a chunk of system memory.   It can only be invoked during PEI phase;   for DXE phase, it will ASSERT() since PEI HOB is read-only for DXE phase.      If there is no additional space for HOB creation, then ASSERT().    @param  ResourceType        The type of resource described by this HOB.   @param  ResourceAttribute   The resource attributes of the memory described by this HOB.   @param  PhysicalStart       The 64 bit physical address of memory described by this HOB.   @param  NumberOfBytes       The length of the memory described by this HOB in bytes.  **/
end_comment

begin_function
name|VOID
name|EFIAPI
name|BuildResourceDescriptorHob
parameter_list|(
name|IN
name|EFI_RESOURCE_TYPE
name|ResourceType
parameter_list|,
name|IN
name|EFI_RESOURCE_ATTRIBUTE_TYPE
name|ResourceAttribute
parameter_list|,
name|IN
name|EFI_PHYSICAL_ADDRESS
name|PhysicalStart
parameter_list|,
name|IN
name|UINT64
name|NumberOfBytes
parameter_list|)
block|{
name|EFI_HOB_RESOURCE_DESCRIPTOR
modifier|*
name|Hob
decl_stmt|;
name|Hob
operator|=
name|InternalPeiCreateHob
argument_list|(
name|EFI_HOB_TYPE_RESOURCE_DESCRIPTOR
argument_list|,
operator|(
name|UINT16
operator|)
sizeof|sizeof
argument_list|(
name|EFI_HOB_RESOURCE_DESCRIPTOR
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|Hob
operator|==
name|NULL
condition|)
block|{
return|return;
block|}
name|Hob
operator|->
name|ResourceType
operator|=
name|ResourceType
expr_stmt|;
name|Hob
operator|->
name|ResourceAttribute
operator|=
name|ResourceAttribute
expr_stmt|;
name|Hob
operator|->
name|PhysicalStart
operator|=
name|PhysicalStart
expr_stmt|;
name|Hob
operator|->
name|ResourceLength
operator|=
name|NumberOfBytes
expr_stmt|;
name|ZeroMem
argument_list|(
operator|&
operator|(
name|Hob
operator|->
name|Owner
operator|)
argument_list|,
sizeof|sizeof
argument_list|(
name|EFI_GUID
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**   Builds a customized HOB tagged with a GUID for identification and returns    the start address of GUID HOB data.    This function builds a customized HOB tagged with a GUID for identification    and returns the start address of GUID HOB data so that caller can fill the customized data.    The HOB Header and Name field is already stripped.   It can only be invoked during PEI phase;   for DXE phase, it will ASSERT() since PEI HOB is read-only for DXE phase.      If Guid is NULL, then ASSERT().   If there is no additional space for HOB creation, then ASSERT().   If DataLength> (0xFFF8 - sizeof (EFI_HOB_GUID_TYPE)), then ASSERT().   HobLength is UINT16 and multiples of 8 bytes, so the max HobLength is 0xFFF8.    @param  Guid          The GUID to tag the customized HOB.   @param  DataLength    The size of the data payload for the GUID HOB.    @retval  NULL         The GUID HOB could not be allocated.   @retval  others       The start address of GUID HOB data.  **/
end_comment

begin_function
name|VOID
modifier|*
name|EFIAPI
name|BuildGuidHob
parameter_list|(
name|IN
name|CONST
name|EFI_GUID
modifier|*
name|Guid
parameter_list|,
name|IN
name|UINTN
name|DataLength
parameter_list|)
block|{
name|EFI_HOB_GUID_TYPE
modifier|*
name|Hob
decl_stmt|;
comment|//
comment|// Make sure Guid is valid
comment|//
name|ASSERT
argument_list|(
name|Guid
operator|!=
name|NULL
argument_list|)
expr_stmt|;
comment|//
comment|// Make sure that data length is not too long.
comment|//
name|ASSERT
argument_list|(
name|DataLength
operator|<=
operator|(
literal|0xFFF8
operator|-
sizeof|sizeof
argument_list|(
name|EFI_HOB_GUID_TYPE
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|Hob
operator|=
name|InternalPeiCreateHob
argument_list|(
name|EFI_HOB_TYPE_GUID_EXTENSION
argument_list|,
call|(
name|UINT16
call|)
argument_list|(
sizeof|sizeof
argument_list|(
name|EFI_HOB_GUID_TYPE
argument_list|)
operator|+
name|DataLength
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|Hob
operator|==
name|NULL
condition|)
block|{
return|return
name|Hob
return|;
block|}
name|CopyGuid
argument_list|(
operator|&
name|Hob
operator|->
name|Name
argument_list|,
name|Guid
argument_list|)
expr_stmt|;
return|return
name|Hob
operator|+
literal|1
return|;
block|}
end_function

begin_comment
comment|/**   Builds a customized HOB tagged with a GUID for identification, copies the input data to the HOB    data field, and returns the start address of the GUID HOB data.    This function builds a customized HOB tagged with a GUID for identification and copies the input   data to the HOB data field and returns the start address of the GUID HOB data.  It can only be    invoked during PEI phase; for DXE phase, it will ASSERT() since PEI HOB is read-only for DXE phase.     The HOB Header and Name field is already stripped.   It can only be invoked during PEI phase;   for DXE phase, it will ASSERT() since PEI HOB is read-only for DXE phase.      If Guid is NULL, then ASSERT().   If Data is NULL and DataLength> 0, then ASSERT().   If there is no additional space for HOB creation, then ASSERT().   If DataLength> (0xFFF8 - sizeof (EFI_HOB_GUID_TYPE)), then ASSERT().   HobLength is UINT16 and multiples of 8 bytes, so the max HobLength is 0xFFF8.    @param  Guid          The GUID to tag the customized HOB.   @param  Data          The data to be copied into the data field of the GUID HOB.   @param  DataLength    The size of the data payload for the GUID HOB.    @retval  NULL         The GUID HOB could not be allocated.   @retval  others       The start address of GUID HOB data.  **/
end_comment

begin_function
name|VOID
modifier|*
name|EFIAPI
name|BuildGuidDataHob
parameter_list|(
name|IN
name|CONST
name|EFI_GUID
modifier|*
name|Guid
parameter_list|,
name|IN
name|VOID
modifier|*
name|Data
parameter_list|,
name|IN
name|UINTN
name|DataLength
parameter_list|)
block|{
name|VOID
modifier|*
name|HobData
decl_stmt|;
name|ASSERT
argument_list|(
name|Data
operator|!=
name|NULL
operator|||
name|DataLength
operator|==
literal|0
argument_list|)
expr_stmt|;
name|HobData
operator|=
name|BuildGuidHob
argument_list|(
name|Guid
argument_list|,
name|DataLength
argument_list|)
expr_stmt|;
if|if
condition|(
name|HobData
operator|==
name|NULL
condition|)
block|{
return|return
name|HobData
return|;
block|}
return|return
name|CopyMem
argument_list|(
name|HobData
argument_list|,
name|Data
argument_list|,
name|DataLength
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**   Check FV alignment.    @param  BaseAddress   The base address of the Firmware Volume.   @param  Length        The size of the Firmware Volume in bytes.    @retval TRUE          FvImage buffer is at its required alignment.   @retval FALSE         FvImage buffer is not at its required alignment.  **/
end_comment

begin_function
name|BOOLEAN
name|InternalCheckFvAlignment
parameter_list|(
name|IN
name|EFI_PHYSICAL_ADDRESS
name|BaseAddress
parameter_list|,
name|IN
name|UINT64
name|Length
parameter_list|)
block|{
name|EFI_FIRMWARE_VOLUME_HEADER
modifier|*
name|FwVolHeader
decl_stmt|;
name|UINT32
name|FvAlignment
decl_stmt|;
name|FvAlignment
operator|=
literal|0
expr_stmt|;
name|FwVolHeader
operator|=
operator|(
name|EFI_FIRMWARE_VOLUME_HEADER
operator|*
operator|)
operator|(
name|UINTN
operator|)
name|BaseAddress
expr_stmt|;
comment|//
comment|// If EFI_FVB2_WEAK_ALIGNMENT is set in the volume header then the first byte of the volume
comment|// can be aligned on any power-of-two boundary. A weakly aligned volume can not be moved from
comment|// its initial linked location and maintain its alignment.
comment|//
if|if
condition|(
operator|(
name|FwVolHeader
operator|->
name|Attributes
operator|&
name|EFI_FVB2_WEAK_ALIGNMENT
operator|)
operator|!=
name|EFI_FVB2_WEAK_ALIGNMENT
condition|)
block|{
comment|//
comment|// Get FvHeader alignment
comment|//
name|FvAlignment
operator|=
literal|1
operator|<<
operator|(
operator|(
name|FwVolHeader
operator|->
name|Attributes
operator|&
name|EFI_FVB2_ALIGNMENT
operator|)
operator|>>
literal|16
operator|)
expr_stmt|;
comment|//
comment|// FvAlignment must be greater than or equal to 8 bytes of the minimum FFS alignment value.
comment|//
if|if
condition|(
name|FvAlignment
operator|<
literal|8
condition|)
block|{
name|FvAlignment
operator|=
literal|8
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|UINTN
operator|)
name|BaseAddress
operator|%
name|FvAlignment
operator|!=
literal|0
condition|)
block|{
comment|//
comment|// FvImage buffer is not at its required alignment.
comment|//
name|DEBUG
argument_list|(
operator|(
name|DEBUG_ERROR
operator|,
literal|"Unaligned FvImage found at 0x%lx:0x%lx, the required alignment is 0x%x\n"
operator|,
name|BaseAddress
operator|,
name|Length
operator|,
name|FvAlignment
operator|)
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
block|}
return|return
name|TRUE
return|;
block|}
end_function

begin_comment
comment|/**   Builds a Firmware Volume HOB.    This function builds a Firmware Volume HOB.   It can only be invoked during PEI phase;   for DXE phase, it will ASSERT() since PEI HOB is read-only for DXE phase.      If there is no additional space for HOB creation, then ASSERT().   If the FvImage buffer is not at its required alignment, then ASSERT().    @param  BaseAddress   The base address of the Firmware Volume.   @param  Length        The size of the Firmware Volume in bytes.  **/
end_comment

begin_function
name|VOID
name|EFIAPI
name|BuildFvHob
parameter_list|(
name|IN
name|EFI_PHYSICAL_ADDRESS
name|BaseAddress
parameter_list|,
name|IN
name|UINT64
name|Length
parameter_list|)
block|{
name|EFI_HOB_FIRMWARE_VOLUME
modifier|*
name|Hob
decl_stmt|;
if|if
condition|(
operator|!
name|InternalCheckFvAlignment
argument_list|(
name|BaseAddress
argument_list|,
name|Length
argument_list|)
condition|)
block|{
name|ASSERT
argument_list|(
name|FALSE
argument_list|)
expr_stmt|;
return|return;
block|}
name|Hob
operator|=
name|InternalPeiCreateHob
argument_list|(
name|EFI_HOB_TYPE_FV
argument_list|,
operator|(
name|UINT16
operator|)
sizeof|sizeof
argument_list|(
name|EFI_HOB_FIRMWARE_VOLUME
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|Hob
operator|==
name|NULL
condition|)
block|{
return|return;
block|}
name|Hob
operator|->
name|BaseAddress
operator|=
name|BaseAddress
expr_stmt|;
name|Hob
operator|->
name|Length
operator|=
name|Length
expr_stmt|;
block|}
end_function

begin_comment
comment|/**   Builds a EFI_HOB_TYPE_FV2 HOB.    This function builds a EFI_HOB_TYPE_FV2 HOB.   It can only be invoked during PEI phase;   for DXE phase, it will ASSERT() since PEI HOB is read-only for DXE phase.      If there is no additional space for HOB creation, then ASSERT().   If the FvImage buffer is not at its required alignment, then ASSERT().    @param  BaseAddress   The base address of the Firmware Volume.   @param  Length        The size of the Firmware Volume in bytes.   @param  FvName        The name of the Firmware Volume.   @param  FileName      The name of the file.    **/
end_comment

begin_function
name|VOID
name|EFIAPI
name|BuildFv2Hob
parameter_list|(
name|IN
name|EFI_PHYSICAL_ADDRESS
name|BaseAddress
parameter_list|,
name|IN
name|UINT64
name|Length
parameter_list|,
name|IN
name|CONST
name|EFI_GUID
modifier|*
name|FvName
parameter_list|,
name|IN
name|CONST
name|EFI_GUID
modifier|*
name|FileName
parameter_list|)
block|{
name|EFI_HOB_FIRMWARE_VOLUME2
modifier|*
name|Hob
decl_stmt|;
if|if
condition|(
operator|!
name|InternalCheckFvAlignment
argument_list|(
name|BaseAddress
argument_list|,
name|Length
argument_list|)
condition|)
block|{
name|ASSERT
argument_list|(
name|FALSE
argument_list|)
expr_stmt|;
return|return;
block|}
name|Hob
operator|=
name|InternalPeiCreateHob
argument_list|(
name|EFI_HOB_TYPE_FV2
argument_list|,
operator|(
name|UINT16
operator|)
sizeof|sizeof
argument_list|(
name|EFI_HOB_FIRMWARE_VOLUME2
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|Hob
operator|==
name|NULL
condition|)
block|{
return|return;
block|}
name|Hob
operator|->
name|BaseAddress
operator|=
name|BaseAddress
expr_stmt|;
name|Hob
operator|->
name|Length
operator|=
name|Length
expr_stmt|;
name|CopyGuid
argument_list|(
operator|&
name|Hob
operator|->
name|FvName
argument_list|,
name|FvName
argument_list|)
expr_stmt|;
name|CopyGuid
argument_list|(
operator|&
name|Hob
operator|->
name|FileName
argument_list|,
name|FileName
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**   Builds a Capsule Volume HOB.    This function builds a Capsule Volume HOB.   It can only be invoked during PEI phase;   for DXE phase, it will ASSERT() since PEI HOB is read-only for DXE phase.      If the platform does not support Capsule Volume HOBs, then ASSERT().   If there is no additional space for HOB creation, then ASSERT().    @param  BaseAddress   The base address of the Capsule Volume.   @param  Length        The size of the Capsule Volume in bytes.  **/
end_comment

begin_function
name|VOID
name|EFIAPI
name|BuildCvHob
parameter_list|(
name|IN
name|EFI_PHYSICAL_ADDRESS
name|BaseAddress
parameter_list|,
name|IN
name|UINT64
name|Length
parameter_list|)
block|{
name|EFI_HOB_UEFI_CAPSULE
modifier|*
name|Hob
decl_stmt|;
name|Hob
operator|=
name|InternalPeiCreateHob
argument_list|(
name|EFI_HOB_TYPE_UEFI_CAPSULE
argument_list|,
operator|(
name|UINT16
operator|)
sizeof|sizeof
argument_list|(
name|EFI_HOB_UEFI_CAPSULE
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|Hob
operator|==
name|NULL
condition|)
block|{
return|return;
block|}
name|Hob
operator|->
name|BaseAddress
operator|=
name|BaseAddress
expr_stmt|;
name|Hob
operator|->
name|Length
operator|=
name|Length
expr_stmt|;
block|}
end_function

begin_comment
comment|/**   Builds a HOB for the CPU.    This function builds a HOB for the CPU.   It can only be invoked during PEI phase;   for DXE phase, it will ASSERT() since PEI HOB is read-only for DXE phase.      If there is no additional space for HOB creation, then ASSERT().    @param  SizeOfMemorySpace   The maximum physical memory addressability of the processor.   @param  SizeOfIoSpace       The maximum physical I/O addressability of the processor.  **/
end_comment

begin_function
name|VOID
name|EFIAPI
name|BuildCpuHob
parameter_list|(
name|IN
name|UINT8
name|SizeOfMemorySpace
parameter_list|,
name|IN
name|UINT8
name|SizeOfIoSpace
parameter_list|)
block|{
name|EFI_HOB_CPU
modifier|*
name|Hob
decl_stmt|;
name|Hob
operator|=
name|InternalPeiCreateHob
argument_list|(
name|EFI_HOB_TYPE_CPU
argument_list|,
operator|(
name|UINT16
operator|)
sizeof|sizeof
argument_list|(
name|EFI_HOB_CPU
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|Hob
operator|==
name|NULL
condition|)
block|{
return|return;
block|}
name|Hob
operator|->
name|SizeOfMemorySpace
operator|=
name|SizeOfMemorySpace
expr_stmt|;
name|Hob
operator|->
name|SizeOfIoSpace
operator|=
name|SizeOfIoSpace
expr_stmt|;
comment|//
comment|// Zero the reserved space to match HOB spec
comment|//
name|ZeroMem
argument_list|(
name|Hob
operator|->
name|Reserved
argument_list|,
sizeof|sizeof
argument_list|(
name|Hob
operator|->
name|Reserved
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**   Builds a HOB for the Stack.    This function builds a HOB for the stack.   It can only be invoked during PEI phase;   for DXE phase, it will ASSERT() since PEI HOB is read-only for DXE phase.      If there is no additional space for HOB creation, then ASSERT().    @param  BaseAddress   The 64 bit physical address of the Stack.   @param  Length        The length of the stack in bytes.  **/
end_comment

begin_function
name|VOID
name|EFIAPI
name|BuildStackHob
parameter_list|(
name|IN
name|EFI_PHYSICAL_ADDRESS
name|BaseAddress
parameter_list|,
name|IN
name|UINT64
name|Length
parameter_list|)
block|{
name|EFI_HOB_MEMORY_ALLOCATION_STACK
modifier|*
name|Hob
decl_stmt|;
name|ASSERT
argument_list|(
operator|(
operator|(
name|BaseAddress
operator|&
operator|(
name|EFI_PAGE_SIZE
operator|-
literal|1
operator|)
operator|)
operator|==
literal|0
operator|)
operator|&&
operator|(
operator|(
name|Length
operator|&
operator|(
name|EFI_PAGE_SIZE
operator|-
literal|1
operator|)
operator|)
operator|==
literal|0
operator|)
argument_list|)
expr_stmt|;
name|Hob
operator|=
name|InternalPeiCreateHob
argument_list|(
name|EFI_HOB_TYPE_MEMORY_ALLOCATION
argument_list|,
operator|(
name|UINT16
operator|)
sizeof|sizeof
argument_list|(
name|EFI_HOB_MEMORY_ALLOCATION_STACK
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|Hob
operator|==
name|NULL
condition|)
block|{
return|return;
block|}
name|CopyGuid
argument_list|(
operator|&
operator|(
name|Hob
operator|->
name|AllocDescriptor
operator|.
name|Name
operator|)
argument_list|,
operator|&
name|gEfiHobMemoryAllocStackGuid
argument_list|)
expr_stmt|;
name|Hob
operator|->
name|AllocDescriptor
operator|.
name|MemoryBaseAddress
operator|=
name|BaseAddress
expr_stmt|;
name|Hob
operator|->
name|AllocDescriptor
operator|.
name|MemoryLength
operator|=
name|Length
expr_stmt|;
name|Hob
operator|->
name|AllocDescriptor
operator|.
name|MemoryType
operator|=
name|EfiBootServicesData
expr_stmt|;
comment|//
comment|// Zero the reserved space to match HOB spec
comment|//
name|ZeroMem
argument_list|(
name|Hob
operator|->
name|AllocDescriptor
operator|.
name|Reserved
argument_list|,
sizeof|sizeof
argument_list|(
name|Hob
operator|->
name|AllocDescriptor
operator|.
name|Reserved
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**   Builds a HOB for the BSP store.    This function builds a HOB for BSP store.   It can only be invoked during PEI phase;   for DXE phase, it will ASSERT() since PEI HOB is read-only for DXE phase.      If there is no additional space for HOB creation, then ASSERT().    @param  BaseAddress   The 64 bit physical address of the BSP.   @param  Length        The length of the BSP store in bytes.   @param  MemoryType    The type of memory allocated by this HOB.  **/
end_comment

begin_function
name|VOID
name|EFIAPI
name|BuildBspStoreHob
parameter_list|(
name|IN
name|EFI_PHYSICAL_ADDRESS
name|BaseAddress
parameter_list|,
name|IN
name|UINT64
name|Length
parameter_list|,
name|IN
name|EFI_MEMORY_TYPE
name|MemoryType
parameter_list|)
block|{
name|EFI_HOB_MEMORY_ALLOCATION_BSP_STORE
modifier|*
name|Hob
decl_stmt|;
name|ASSERT
argument_list|(
operator|(
operator|(
name|BaseAddress
operator|&
operator|(
name|EFI_PAGE_SIZE
operator|-
literal|1
operator|)
operator|)
operator|==
literal|0
operator|)
operator|&&
operator|(
operator|(
name|Length
operator|&
operator|(
name|EFI_PAGE_SIZE
operator|-
literal|1
operator|)
operator|)
operator|==
literal|0
operator|)
argument_list|)
expr_stmt|;
name|Hob
operator|=
name|InternalPeiCreateHob
argument_list|(
name|EFI_HOB_TYPE_MEMORY_ALLOCATION
argument_list|,
operator|(
name|UINT16
operator|)
sizeof|sizeof
argument_list|(
name|EFI_HOB_MEMORY_ALLOCATION_BSP_STORE
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|Hob
operator|==
name|NULL
condition|)
block|{
return|return;
block|}
name|CopyGuid
argument_list|(
operator|&
operator|(
name|Hob
operator|->
name|AllocDescriptor
operator|.
name|Name
operator|)
argument_list|,
operator|&
name|gEfiHobMemoryAllocBspStoreGuid
argument_list|)
expr_stmt|;
name|Hob
operator|->
name|AllocDescriptor
operator|.
name|MemoryBaseAddress
operator|=
name|BaseAddress
expr_stmt|;
name|Hob
operator|->
name|AllocDescriptor
operator|.
name|MemoryLength
operator|=
name|Length
expr_stmt|;
name|Hob
operator|->
name|AllocDescriptor
operator|.
name|MemoryType
operator|=
name|MemoryType
expr_stmt|;
comment|//
comment|// Zero the reserved space to match HOB spec
comment|//
name|ZeroMem
argument_list|(
name|Hob
operator|->
name|AllocDescriptor
operator|.
name|Reserved
argument_list|,
sizeof|sizeof
argument_list|(
name|Hob
operator|->
name|AllocDescriptor
operator|.
name|Reserved
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**   Builds a HOB for the memory allocation.    This function builds a HOB for the memory allocation.   It can only be invoked during PEI phase;   for DXE phase, it will ASSERT() since PEI HOB is read-only for DXE phase.      If there is no additional space for HOB creation, then ASSERT().    @param  BaseAddress   The 64 bit physical address of the memory.   @param  Length        The length of the memory allocation in bytes.   @param  MemoryType    The type of memory allocated by this HOB.  **/
end_comment

begin_function
name|VOID
name|EFIAPI
name|BuildMemoryAllocationHob
parameter_list|(
name|IN
name|EFI_PHYSICAL_ADDRESS
name|BaseAddress
parameter_list|,
name|IN
name|UINT64
name|Length
parameter_list|,
name|IN
name|EFI_MEMORY_TYPE
name|MemoryType
parameter_list|)
block|{
name|EFI_HOB_MEMORY_ALLOCATION
modifier|*
name|Hob
decl_stmt|;
name|ASSERT
argument_list|(
operator|(
operator|(
name|BaseAddress
operator|&
operator|(
name|EFI_PAGE_SIZE
operator|-
literal|1
operator|)
operator|)
operator|==
literal|0
operator|)
operator|&&
operator|(
operator|(
name|Length
operator|&
operator|(
name|EFI_PAGE_SIZE
operator|-
literal|1
operator|)
operator|)
operator|==
literal|0
operator|)
argument_list|)
expr_stmt|;
name|Hob
operator|=
name|InternalPeiCreateHob
argument_list|(
name|EFI_HOB_TYPE_MEMORY_ALLOCATION
argument_list|,
operator|(
name|UINT16
operator|)
sizeof|sizeof
argument_list|(
name|EFI_HOB_MEMORY_ALLOCATION
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|Hob
operator|==
name|NULL
condition|)
block|{
return|return;
block|}
name|ZeroMem
argument_list|(
operator|&
operator|(
name|Hob
operator|->
name|AllocDescriptor
operator|.
name|Name
operator|)
argument_list|,
sizeof|sizeof
argument_list|(
name|EFI_GUID
argument_list|)
argument_list|)
expr_stmt|;
name|Hob
operator|->
name|AllocDescriptor
operator|.
name|MemoryBaseAddress
operator|=
name|BaseAddress
expr_stmt|;
name|Hob
operator|->
name|AllocDescriptor
operator|.
name|MemoryLength
operator|=
name|Length
expr_stmt|;
name|Hob
operator|->
name|AllocDescriptor
operator|.
name|MemoryType
operator|=
name|MemoryType
expr_stmt|;
comment|//
comment|// Zero the reserved space to match HOB spec
comment|//
name|ZeroMem
argument_list|(
name|Hob
operator|->
name|AllocDescriptor
operator|.
name|Reserved
argument_list|,
sizeof|sizeof
argument_list|(
name|Hob
operator|->
name|AllocDescriptor
operator|.
name|Reserved
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|"uucp.h"
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_decl_stmt
name|char
name|Tmplog
index|[
name|MAXFULLNAME
index|]
init|=
literal|""
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILE
modifier|*
name|Lp
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*******  *	logent(text, status)	make log entry  *	char *text, *status;  *  *	return code - none  */
end_comment

begin_macro
name|logent
argument_list|(
argument|text
argument_list|,
argument|status
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|text
decl_stmt|,
modifier|*
name|status
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|n
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
if|if
condition|(
name|Lp
operator|!=
name|NULL
condition|)
block|{
comment|/*  make entry in existing temp log file  */
name|mlogent
argument_list|(
name|Lp
argument_list|,
name|status
argument_list|,
name|text
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ulockf
argument_list|(
name|LOGLOCK
argument_list|,
literal|10l
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|fp
operator|=
name|fopen
argument_list|(
name|LOGFILE
argument_list|,
literal|"a"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|rmlock
argument_list|(
name|LOGLOCK
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|mlogent
argument_list|(
name|fp
argument_list|,
name|status
argument_list|,
name|text
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|rmlock
argument_list|(
name|LOGLOCK
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
comment|/*  make a temp log file  */
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
literal|10
condition|;
name|n
operator|++
control|)
block|{
name|sprintf
argument_list|(
name|Tmplog
argument_list|,
literal|"%s/LOG.%05d.%1d"
argument_list|,
name|LOGDIR
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|n
argument_list|)
expr_stmt|;
if|if
condition|(
name|access
argument_list|(
name|Tmplog
argument_list|,
literal|0
argument_list|)
operator|==
operator|-
literal|1
condition|)
break|break;
block|}
if|if
condition|(
operator|(
name|Lp
operator|=
name|fopen
argument_list|(
name|Tmplog
argument_list|,
literal|"w"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return;
name|chmod
argument_list|(
name|Tmplog
argument_list|,
literal|0222
argument_list|)
expr_stmt|;
name|setbuf
argument_list|(
name|Lp
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|mlogent
argument_list|(
name|Lp
argument_list|,
name|status
argument_list|,
name|text
argument_list|)
expr_stmt|;
return|return;
block|}
end_block

begin_comment
comment|/***  *	mlogent(fp, status, text)  - make a log entry  */
end_comment

begin_macro
name|mlogent
argument_list|(
argument|fp
argument_list|,
argument|status
argument_list|,
argument|text
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|text
decl_stmt|,
modifier|*
name|status
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILE
modifier|*
name|fp
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|tm
modifier|*
name|tp
decl_stmt|;
specifier|extern
name|struct
name|tm
modifier|*
name|localtime
parameter_list|()
function_decl|;
name|time_t
name|clock
decl_stmt|;
name|time
argument_list|(
operator|&
name|clock
argument_list|)
expr_stmt|;
name|tp
operator|=
name|localtime
argument_list|(
operator|&
name|clock
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%s %s "
argument_list|,
name|User
argument_list|,
name|Rmtname
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"(%d/%d-%d:%d) "
argument_list|,
name|tp
operator|->
name|tm_mon
operator|+
literal|1
argument_list|,
name|tp
operator|->
name|tm_mday
argument_list|,
name|tp
operator|->
name|tm_hour
argument_list|,
name|tp
operator|->
name|tm_min
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%s (%s)\n"
argument_list|,
name|status
argument_list|,
name|text
argument_list|)
expr_stmt|;
return|return;
block|}
end_block

begin_comment
comment|/***  *	logcls()	close log file  *  *	return codes:  none  */
end_comment

begin_macro
name|logcls
argument_list|()
end_macro

begin_block
block|{
if|if
condition|(
name|Lp
operator|!=
name|NULL
condition|)
block|{
name|fclose
argument_list|(
name|Lp
argument_list|)
expr_stmt|;
name|chmod
argument_list|(
name|Tmplog
argument_list|,
literal|0666
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_block

begin_comment
comment|/***  *	syslog(text)	make system log entry  *	char *text;  *  *	return codes - none  */
end_comment

begin_macro
name|syslog
argument_list|(
argument|text
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|text
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|tm
modifier|*
name|tp
decl_stmt|;
specifier|extern
name|struct
name|tm
modifier|*
name|localtime
parameter_list|()
function_decl|;
name|time_t
name|clock
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
name|time
argument_list|(
operator|&
name|clock
argument_list|)
expr_stmt|;
name|tp
operator|=
name|localtime
argument_list|(
operator|&
name|clock
argument_list|)
expr_stmt|;
name|fp
operator|=
name|fopen
argument_list|(
name|SYSLOG
argument_list|,
literal|"a"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|==
name|NULL
condition|)
return|return;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%s %s "
argument_list|,
name|User
argument_list|,
name|Rmtname
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"(%d/%d-%d:%d) "
argument_list|,
name|tp
operator|->
name|tm_mon
operator|+
literal|1
argument_list|,
name|tp
operator|->
name|tm_mday
argument_list|,
name|tp
operator|->
name|tm_hour
argument_list|,
name|tp
operator|->
name|tm_min
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%s\n"
argument_list|,
name|text
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
return|return;
block|}
end_block

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2003-2007 Tim Kientzle  * Copyright (c) 2011-2012 Michihiro NAKAJIMA  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR(S) ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHOR(S) BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|"test.h"
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD: head/lib/libarchive/test/test_read_format_mtree.c 201247 2009-12-30 05:59:21Z kientzle $"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|void
name|test_read_format_mtree1
parameter_list|(
name|void
parameter_list|)
block|{
specifier|const
name|char
name|reffile
index|[]
init|=
literal|"test_read_format_mtree.mtree"
decl_stmt|;
name|char
name|buff
index|[
literal|16
index|]
decl_stmt|;
name|struct
name|archive_entry
modifier|*
name|ae
decl_stmt|;
name|struct
name|archive
modifier|*
name|a
decl_stmt|;
name|FILE
modifier|*
name|f
decl_stmt|;
comment|/* Compute max 64-bit signed twos-complement value 	 * without relying on overflow.  This assumes that long long 	 * is at least 64 bits. */
specifier|static
specifier|const
name|long
name|long
name|max_int64
init|=
operator|(
operator|(
operator|(
operator|(
name|long
name|long
operator|)
literal|1
operator|)
operator|<<
literal|62
operator|)
operator|-
literal|1
operator|)
operator|+
operator|(
operator|(
operator|(
name|long
name|long
operator|)
literal|1
operator|)
operator|<<
literal|62
operator|)
decl_stmt|;
name|time_t
name|min_time
decl_stmt|;
specifier|volatile
name|time_t
name|t
decl_stmt|;
name|extract_reference_file
argument_list|(
name|reffile
argument_list|)
expr_stmt|;
comment|/* 	 * An access error occurred on some platform when mtree 	 * format handling open a directory. It is for through 	 * the routine which open a directory that we create 	 * "dir" and "dir2" directories. 	 */
name|assertMakeDir
argument_list|(
literal|"dir"
argument_list|,
literal|0775
argument_list|)
expr_stmt|;
name|assertMakeDir
argument_list|(
literal|"dir2"
argument_list|,
literal|0775
argument_list|)
expr_stmt|;
name|assert
argument_list|(
operator|(
name|a
operator|=
name|archive_read_new
argument_list|()
operator|)
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_support_filter_all
argument_list|(
name|a
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_support_format_all
argument_list|(
name|a
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_open_filename
argument_list|(
name|a
argument_list|,
name|reffile
argument_list|,
literal|11
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Read "file", whose data is available on disk. 	 */
name|f
operator|=
name|fopen
argument_list|(
literal|"file"
argument_list|,
literal|"wb"
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|f
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
literal|3
argument_list|,
name|fwrite
argument_list|(
literal|"hi\n"
argument_list|,
literal|1
argument_list|,
literal|3
argument_list|,
name|f
argument_list|)
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_format
argument_list|(
name|a
argument_list|)
argument_list|,
name|ARCHIVE_FORMAT_MTREE
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"file"
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_entry_uid
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|18
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|AE_IFREG
argument_list|,
name|archive_entry_filetype
argument_list|(
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_entry_mode
argument_list|(
name|ae
argument_list|)
argument_list|,
name|AE_IFREG
operator||
literal|0123
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_entry_size
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
literal|3
argument_list|,
name|archive_read_data
argument_list|(
name|a
argument_list|,
name|buff
argument_list|,
literal|3
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualMem
argument_list|(
name|buff
argument_list|,
literal|"hi\n"
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"dir"
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|AE_IFDIR
argument_list|,
name|archive_entry_filetype
argument_list|(
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"dir/file with space"
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"file with space"
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"dir2"
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"dir2/dir3a"
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"dir2/dir3a/indir3a"
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"dir2/fullindir2"
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_entry_mode
argument_list|(
name|ae
argument_list|)
argument_list|,
name|AE_IFREG
operator||
literal|0644
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"dir2/indir2"
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"dir2/dir3b"
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"dir2/dir3b/indir3b"
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"notindir"
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"dir2/emptyfile"
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_entry_size
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"dir2/smallfile"
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_entry_size
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* TODO: Mtree reader should probably return ARCHIVE_WARN for this. */
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"dir2/toosmallfile"
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_entry_size
argument_list|(
name|ae
argument_list|)
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"dir2/bigfile"
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_entry_size
argument_list|(
name|ae
argument_list|)
argument_list|,
name|max_int64
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"dir2/toobigfile"
argument_list|)
expr_stmt|;
comment|/* Size in mtree is max_int64 + 1; should return max_int64. */
name|assertEqualInt
argument_list|(
name|archive_entry_size
argument_list|(
name|ae
argument_list|)
argument_list|,
name|max_int64
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"dir2/veryoldfile"
argument_list|)
expr_stmt|;
comment|/* The value in the file is MIN_INT64_T, but time_t may be narrower. */
comment|/* Verify min_time is the smallest possible time_t. */
name|min_time
operator|=
name|archive_entry_mtime
argument_list|(
name|ae
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|min_time
operator|<=
literal|0
argument_list|)
expr_stmt|;
comment|/* Simply asserting min_time - 1> 0 breaks with some compiler optimizations. */
name|t
operator|=
name|min_time
operator|-
literal|1
expr_stmt|;
name|assert
argument_list|(
name|t
operator|>
literal|0
argument_list|)
expr_stmt|;
comment|/* toooldfile is 1 sec older, which should overflow and get returned 	 * with the same value. */
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"dir2/toooldfile"
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_entry_mtime
argument_list|(
name|ae
argument_list|)
argument_list|,
name|min_time
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_EOF
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
literal|19
argument_list|,
name|archive_file_count
argument_list|(
name|a
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|ARCHIVE_OK
argument_list|,
name|archive_read_close
argument_list|(
name|a
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|ARCHIVE_OK
argument_list|,
name|archive_read_free
argument_list|(
name|a
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|test_read_format_mtree2
parameter_list|(
name|void
parameter_list|)
block|{
specifier|static
name|char
name|archive
index|[]
init|=
literal|"#mtree\n"
literal|"d type=dir content=.\n"
decl_stmt|;
name|struct
name|archive_entry
modifier|*
name|ae
decl_stmt|;
name|struct
name|archive
modifier|*
name|a
decl_stmt|;
name|assert
argument_list|(
operator|(
name|a
operator|=
name|archive_read_new
argument_list|()
operator|)
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_support_filter_all
argument_list|(
name|a
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_support_format_all
argument_list|(
name|a
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_open_memory
argument_list|(
name|a
argument_list|,
name|archive
argument_list|,
sizeof|sizeof
argument_list|(
name|archive
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_format
argument_list|(
name|a
argument_list|)
argument_list|,
name|ARCHIVE_FORMAT_MTREE
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"d"
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_entry_filetype
argument_list|(
name|ae
argument_list|)
argument_list|,
name|AE_IFDIR
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_EOF
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
literal|1
argument_list|,
name|archive_file_count
argument_list|(
name|a
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|ARCHIVE_OK
argument_list|,
name|archive_read_close
argument_list|(
name|a
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|ARCHIVE_OK
argument_list|,
name|archive_read_free
argument_list|(
name|a
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Reported to libarchive.googlecode.com as Issue 121.  */
end_comment

begin_function
specifier|static
name|void
name|test_read_format_mtree3
parameter_list|(
name|void
parameter_list|)
block|{
specifier|static
name|char
name|archive
index|[]
init|=
literal|"#mtree\n"
literal|"a type=file contents=file\n"
literal|"b type=link link=a\n"
literal|"c type=file contents=file\n"
decl_stmt|;
name|struct
name|archive_entry
modifier|*
name|ae
decl_stmt|;
name|struct
name|archive
modifier|*
name|a
decl_stmt|;
name|assertMakeDir
argument_list|(
literal|"mtree3"
argument_list|,
literal|0777
argument_list|)
expr_stmt|;
name|assertChdir
argument_list|(
literal|"mtree3"
argument_list|)
expr_stmt|;
name|assertMakeFile
argument_list|(
literal|"file"
argument_list|,
literal|0644
argument_list|,
literal|"file contents"
argument_list|)
expr_stmt|;
name|assert
argument_list|(
operator|(
name|a
operator|=
name|archive_read_new
argument_list|()
operator|)
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_support_filter_all
argument_list|(
name|a
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_support_format_all
argument_list|(
name|a
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_open_memory
argument_list|(
name|a
argument_list|,
name|archive
argument_list|,
sizeof|sizeof
argument_list|(
name|archive
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"a"
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_entry_filetype
argument_list|(
name|ae
argument_list|)
argument_list|,
name|AE_IFREG
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"b"
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_entry_filetype
argument_list|(
name|ae
argument_list|)
argument_list|,
name|AE_IFLNK
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"c"
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_entry_filetype
argument_list|(
name|ae
argument_list|)
argument_list|,
name|AE_IFREG
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_EOF
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
literal|3
argument_list|,
name|archive_file_count
argument_list|(
name|a
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|ARCHIVE_OK
argument_list|,
name|archive_read_close
argument_list|(
name|a
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|ARCHIVE_OK
argument_list|,
name|archive_read_free
argument_list|(
name|a
argument_list|)
argument_list|)
expr_stmt|;
name|assertChdir
argument_list|(
literal|".."
argument_list|)
expr_stmt|;
block|}
end_function

begin_macro
name|DEFINE_TEST
argument_list|(
argument|test_read_format_mtree
argument_list|)
end_macro

begin_block
block|{
name|test_read_format_mtree1
argument_list|()
expr_stmt|;
name|test_read_format_mtree2
argument_list|()
expr_stmt|;
name|test_read_format_mtree3
argument_list|()
expr_stmt|;
block|}
end_block

begin_macro
name|DEFINE_TEST
argument_list|(
argument|test_read_format_mtree_filenames_only
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|char
name|archive
index|[]
init|=
literal|"/set type=file mode=0644\n"
literal|"./a\n"
literal|"./b\n"
literal|"./c\n"
literal|"./d\n"
literal|"./e\n"
literal|"./f mode=0444\n"
decl_stmt|;
name|struct
name|archive_entry
modifier|*
name|ae
decl_stmt|;
name|struct
name|archive
modifier|*
name|a
decl_stmt|;
name|assertMakeFile
argument_list|(
literal|"file"
argument_list|,
literal|0644
argument_list|,
literal|"file contents"
argument_list|)
expr_stmt|;
name|assert
argument_list|(
operator|(
name|a
operator|=
name|archive_read_new
argument_list|()
operator|)
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_support_filter_all
argument_list|(
name|a
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_support_format_all
argument_list|(
name|a
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_open_memory
argument_list|(
name|a
argument_list|,
name|archive
argument_list|,
sizeof|sizeof
argument_list|(
name|archive
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"./a"
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_entry_mode
argument_list|(
name|ae
argument_list|)
argument_list|,
name|AE_IFREG
operator||
literal|0644
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"./b"
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_entry_mode
argument_list|(
name|ae
argument_list|)
argument_list|,
name|AE_IFREG
operator||
literal|0644
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"./c"
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_entry_mode
argument_list|(
name|ae
argument_list|)
argument_list|,
name|AE_IFREG
operator||
literal|0644
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"./d"
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_entry_mode
argument_list|(
name|ae
argument_list|)
argument_list|,
name|AE_IFREG
operator||
literal|0644
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"./e"
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_entry_mode
argument_list|(
name|ae
argument_list|)
argument_list|,
name|AE_IFREG
operator||
literal|0644
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"./f"
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_entry_mode
argument_list|(
name|ae
argument_list|)
argument_list|,
name|AE_IFREG
operator||
literal|0444
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_EOF
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
literal|6
argument_list|,
name|archive_file_count
argument_list|(
name|a
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|ARCHIVE_OK
argument_list|,
name|archive_read_close
argument_list|(
name|a
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|ARCHIVE_OK
argument_list|,
name|archive_read_free
argument_list|(
name|a
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|DEFINE_TEST
argument_list|(
argument|test_read_format_mtree_nochange
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|char
name|archive
index|[]
init|=
literal|"#mtree\n"
literal|"./a type=file mode=0644 time=123\n"
literal|"./b type=file mode=0644 time=234\n"
literal|"./c type=file mode=0644 time=345\n"
decl_stmt|;
specifier|static
name|char
name|archive2
index|[]
init|=
literal|"#mtree\n"
literal|"./a type=file mode=0644 time=123 nochange\n"
literal|"./b type=file mode=0644 time=234\n"
literal|"./c type=file mode=0644 time=345 nochange\n"
decl_stmt|;
name|struct
name|archive_entry
modifier|*
name|ae
decl_stmt|;
name|struct
name|archive
modifier|*
name|a
decl_stmt|;
name|assertMakeFile
argument_list|(
literal|"a"
argument_list|,
literal|0640
argument_list|,
literal|"12345"
argument_list|)
expr_stmt|;
name|assertMakeFile
argument_list|(
literal|"b"
argument_list|,
literal|0664
argument_list|,
literal|"123456"
argument_list|)
expr_stmt|;
name|assertMakeFile
argument_list|(
literal|"c"
argument_list|,
literal|0755
argument_list|,
literal|"1234567"
argument_list|)
expr_stmt|;
comment|/* 	 * Test 1. Read a mtree archive without `nochange' keyword. 	 */
name|assert
argument_list|(
operator|(
name|a
operator|=
name|archive_read_new
argument_list|()
operator|)
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_support_filter_all
argument_list|(
name|a
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_support_format_all
argument_list|(
name|a
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_open_memory
argument_list|(
name|a
argument_list|,
name|archive
argument_list|,
sizeof|sizeof
argument_list|(
name|archive
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"./a"
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_entry_mode
argument_list|(
name|ae
argument_list|)
argument_list|,
name|AE_IFREG
operator||
literal|0644
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_entry_mtime
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|123
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_entry_size
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"./b"
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_entry_mode
argument_list|(
name|ae
argument_list|)
argument_list|,
name|AE_IFREG
operator||
literal|0644
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_entry_mtime
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|234
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_entry_size
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"./c"
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_entry_mode
argument_list|(
name|ae
argument_list|)
argument_list|,
name|AE_IFREG
operator||
literal|0644
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_entry_mtime
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|345
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_entry_size
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|7
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_EOF
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
literal|3
argument_list|,
name|archive_file_count
argument_list|(
name|a
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|ARCHIVE_OK
argument_list|,
name|archive_read_close
argument_list|(
name|a
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|ARCHIVE_OK
argument_list|,
name|archive_read_free
argument_list|(
name|a
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Test 2. Read a mtree archive with `nochange' keyword. 	 */
name|assert
argument_list|(
operator|(
name|a
operator|=
name|archive_read_new
argument_list|()
operator|)
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_support_filter_all
argument_list|(
name|a
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_support_format_all
argument_list|(
name|a
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_open_memory
argument_list|(
name|a
argument_list|,
name|archive2
argument_list|,
sizeof|sizeof
argument_list|(
name|archive2
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"./a"
argument_list|)
expr_stmt|;
if|#
directive|if
operator|!
name|defined
argument_list|(
name|_WIN32
argument_list|)
operator|||
name|defined
argument_list|(
name|__CYGWIN__
argument_list|)
name|assertEqualInt
argument_list|(
name|archive_entry_mode
argument_list|(
name|ae
argument_list|)
argument_list|,
name|AE_IFREG
operator||
literal|0640
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|assert
argument_list|(
name|archive_entry_mtime
argument_list|(
name|ae
argument_list|)
operator|!=
literal|123
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_entry_size
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"./b"
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_entry_mode
argument_list|(
name|ae
argument_list|)
argument_list|,
name|AE_IFREG
operator||
literal|0644
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_entry_mtime
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|234
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_entry_size
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"./c"
argument_list|)
expr_stmt|;
if|#
directive|if
operator|!
name|defined
argument_list|(
name|_WIN32
argument_list|)
operator|||
name|defined
argument_list|(
name|__CYGWIN__
argument_list|)
name|assertEqualInt
argument_list|(
name|archive_entry_mode
argument_list|(
name|ae
argument_list|)
argument_list|,
name|AE_IFREG
operator||
literal|0755
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|assert
argument_list|(
name|archive_entry_mtime
argument_list|(
name|ae
argument_list|)
operator|!=
literal|345
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_entry_size
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|7
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_EOF
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
literal|3
argument_list|,
name|archive_file_count
argument_list|(
name|a
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|ARCHIVE_OK
argument_list|,
name|archive_read_close
argument_list|(
name|a
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|ARCHIVE_OK
argument_list|,
name|archive_read_free
argument_list|(
name|a
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|DEFINE_TEST
argument_list|(
argument|test_read_format_mtree_nomagic_v1_form
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|char
name|reffile
index|[]
init|=
literal|"test_read_format_mtree_nomagic.mtree"
decl_stmt|;
name|char
name|buff
index|[
literal|16
index|]
decl_stmt|;
name|struct
name|archive_entry
modifier|*
name|ae
decl_stmt|;
name|struct
name|archive
modifier|*
name|a
decl_stmt|;
name|FILE
modifier|*
name|f
decl_stmt|;
name|extract_reference_file
argument_list|(
name|reffile
argument_list|)
expr_stmt|;
name|assert
argument_list|(
operator|(
name|a
operator|=
name|archive_read_new
argument_list|()
operator|)
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_support_filter_all
argument_list|(
name|a
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_support_format_all
argument_list|(
name|a
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_open_filename
argument_list|(
name|a
argument_list|,
name|reffile
argument_list|,
literal|11
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Read "file", whose data is available on disk. 	 */
name|f
operator|=
name|fopen
argument_list|(
literal|"file"
argument_list|,
literal|"wb"
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|f
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
literal|3
argument_list|,
name|fwrite
argument_list|(
literal|"hi\n"
argument_list|,
literal|1
argument_list|,
literal|3
argument_list|,
name|f
argument_list|)
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_format
argument_list|(
name|a
argument_list|)
argument_list|,
name|ARCHIVE_FORMAT_MTREE
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"file"
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_entry_uid
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|18
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|AE_IFREG
argument_list|,
name|archive_entry_filetype
argument_list|(
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_entry_mode
argument_list|(
name|ae
argument_list|)
argument_list|,
name|AE_IFREG
operator||
literal|0123
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_entry_size
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
literal|3
argument_list|,
name|archive_read_data
argument_list|(
name|a
argument_list|,
name|buff
argument_list|,
literal|3
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualMem
argument_list|(
name|buff
argument_list|,
literal|"hi\n"
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"dir"
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|AE_IFDIR
argument_list|,
name|archive_entry_filetype
argument_list|(
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"dir/file with space"
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"file with space"
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"dir2"
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"dir2/dir3a"
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"dir2/dir3a/indir3a"
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"dir2/fullindir2"
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_entry_mode
argument_list|(
name|ae
argument_list|)
argument_list|,
name|AE_IFREG
operator||
literal|0644
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"dir2/indir2"
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"dir2/dir3b"
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"dir2/dir3b/indir3b"
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"notindir"
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_EOF
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
literal|12
argument_list|,
name|archive_file_count
argument_list|(
name|a
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|ARCHIVE_OK
argument_list|,
name|archive_read_close
argument_list|(
name|a
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|ARCHIVE_OK
argument_list|,
name|archive_read_free
argument_list|(
name|a
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * Test for a format that NetBSD mtree -C generates.  */
end_comment

begin_macro
name|DEFINE_TEST
argument_list|(
argument|test_read_format_mtree_nomagic_v2_form
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|char
name|reffile
index|[]
init|=
literal|"test_read_format_mtree_nomagic2.mtree"
decl_stmt|;
name|char
name|buff
index|[
literal|16
index|]
decl_stmt|;
name|struct
name|archive_entry
modifier|*
name|ae
decl_stmt|;
name|struct
name|archive
modifier|*
name|a
decl_stmt|;
name|FILE
modifier|*
name|f
decl_stmt|;
name|extract_reference_file
argument_list|(
name|reffile
argument_list|)
expr_stmt|;
name|assert
argument_list|(
operator|(
name|a
operator|=
name|archive_read_new
argument_list|()
operator|)
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_support_filter_all
argument_list|(
name|a
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_support_format_all
argument_list|(
name|a
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_open_filename
argument_list|(
name|a
argument_list|,
name|reffile
argument_list|,
literal|11
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Read "file", whose data is available on disk. 	 */
name|f
operator|=
name|fopen
argument_list|(
literal|"file"
argument_list|,
literal|"wb"
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|f
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
literal|3
argument_list|,
name|fwrite
argument_list|(
literal|"hi\n"
argument_list|,
literal|1
argument_list|,
literal|3
argument_list|,
name|f
argument_list|)
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_format
argument_list|(
name|a
argument_list|)
argument_list|,
name|ARCHIVE_FORMAT_MTREE
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"./file"
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_entry_uid
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|18
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|AE_IFREG
argument_list|,
name|archive_entry_filetype
argument_list|(
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_entry_mode
argument_list|(
name|ae
argument_list|)
argument_list|,
name|AE_IFREG
operator||
literal|0123
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_entry_size
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
literal|3
argument_list|,
name|archive_read_data
argument_list|(
name|a
argument_list|,
name|buff
argument_list|,
literal|3
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualMem
argument_list|(
name|buff
argument_list|,
literal|"hi\n"
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"./dir"
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_entry_mode
argument_list|(
name|ae
argument_list|)
argument_list|,
name|AE_IFDIR
operator||
literal|0755
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"./dir/file with space"
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_entry_uid
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|18
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_entry_mode
argument_list|(
name|ae
argument_list|)
argument_list|,
name|AE_IFREG
operator||
literal|0644
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"./file with space"
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_entry_mode
argument_list|(
name|ae
argument_list|)
argument_list|,
name|AE_IFREG
operator||
literal|0644
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"./dir2"
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_entry_mode
argument_list|(
name|ae
argument_list|)
argument_list|,
name|AE_IFDIR
operator||
literal|0755
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"./dir2/dir3a"
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_entry_mode
argument_list|(
name|ae
argument_list|)
argument_list|,
name|AE_IFDIR
operator||
literal|0755
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_EOF
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
literal|6
argument_list|,
name|archive_file_count
argument_list|(
name|a
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|ARCHIVE_OK
argument_list|,
name|archive_read_close
argument_list|(
name|a
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|ARCHIVE_OK
argument_list|,
name|archive_read_free
argument_list|(
name|a
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * Test for a format that NetBSD mtree -D generates.  */
end_comment

begin_macro
name|DEFINE_TEST
argument_list|(
argument|test_read_format_mtree_nomagic_v2_netbsd_form
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|char
name|reffile
index|[]
init|=
literal|"test_read_format_mtree_nomagic3.mtree"
decl_stmt|;
name|char
name|buff
index|[
literal|16
index|]
decl_stmt|;
name|struct
name|archive_entry
modifier|*
name|ae
decl_stmt|;
name|struct
name|archive
modifier|*
name|a
decl_stmt|;
name|FILE
modifier|*
name|f
decl_stmt|;
name|extract_reference_file
argument_list|(
name|reffile
argument_list|)
expr_stmt|;
name|assert
argument_list|(
operator|(
name|a
operator|=
name|archive_read_new
argument_list|()
operator|)
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_support_filter_all
argument_list|(
name|a
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_support_format_all
argument_list|(
name|a
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_open_filename
argument_list|(
name|a
argument_list|,
name|reffile
argument_list|,
literal|11
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Read "file", whose data is available on disk. 	 */
name|f
operator|=
name|fopen
argument_list|(
literal|"file"
argument_list|,
literal|"wb"
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|f
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
literal|3
argument_list|,
name|fwrite
argument_list|(
literal|"hi\n"
argument_list|,
literal|1
argument_list|,
literal|3
argument_list|,
name|f
argument_list|)
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_format
argument_list|(
name|a
argument_list|)
argument_list|,
name|ARCHIVE_FORMAT_MTREE
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"./file"
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_entry_uid
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|18
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|AE_IFREG
argument_list|,
name|archive_entry_filetype
argument_list|(
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_entry_mode
argument_list|(
name|ae
argument_list|)
argument_list|,
name|AE_IFREG
operator||
literal|0123
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_entry_size
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
literal|3
argument_list|,
name|archive_read_data
argument_list|(
name|a
argument_list|,
name|buff
argument_list|,
literal|3
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualMem
argument_list|(
name|buff
argument_list|,
literal|"hi\n"
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"./dir"
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_entry_mode
argument_list|(
name|ae
argument_list|)
argument_list|,
name|AE_IFDIR
operator||
literal|0755
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"./dir/file with space"
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_entry_uid
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|18
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_entry_mode
argument_list|(
name|ae
argument_list|)
argument_list|,
name|AE_IFREG
operator||
literal|0644
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"./file with space"
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_entry_mode
argument_list|(
name|ae
argument_list|)
argument_list|,
name|AE_IFREG
operator||
literal|0644
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"./dir2"
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_entry_mode
argument_list|(
name|ae
argument_list|)
argument_list|,
name|AE_IFDIR
operator||
literal|0755
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"./dir2/dir3a"
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_entry_mode
argument_list|(
name|ae
argument_list|)
argument_list|,
name|AE_IFDIR
operator||
literal|0755
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_EOF
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
literal|6
argument_list|,
name|archive_file_count
argument_list|(
name|a
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|ARCHIVE_OK
argument_list|,
name|archive_read_close
argument_list|(
name|a
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|ARCHIVE_OK
argument_list|,
name|archive_read_free
argument_list|(
name|a
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * We should get a warning if the contents file doesn't exist.  */
end_comment

begin_macro
name|DEFINE_TEST
argument_list|(
argument|test_read_format_mtree_nonexistent_contents_file
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|char
name|archive
index|[]
init|=
literal|"#mtree\n"
literal|"a type=file contents=nonexistent_file\n"
decl_stmt|;
name|struct
name|archive_entry
modifier|*
name|ae
decl_stmt|;
name|struct
name|archive
modifier|*
name|a
decl_stmt|;
name|assert
argument_list|(
operator|(
name|a
operator|=
name|archive_read_new
argument_list|()
operator|)
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_support_filter_all
argument_list|(
name|a
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_support_format_all
argument_list|(
name|a
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_OK
argument_list|,
name|archive_read_open_memory
argument_list|(
name|a
argument_list|,
name|archive
argument_list|,
sizeof|sizeof
argument_list|(
name|archive
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_WARN
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|strlen
argument_list|(
name|archive_error_string
argument_list|(
name|a
argument_list|)
argument_list|)
operator|>
literal|0
argument_list|)
expr_stmt|;
name|assertEqualString
argument_list|(
name|archive_entry_pathname
argument_list|(
name|ae
argument_list|)
argument_list|,
literal|"a"
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|archive_entry_filetype
argument_list|(
name|ae
argument_list|)
argument_list|,
name|AE_IFREG
argument_list|)
expr_stmt|;
name|assertEqualIntA
argument_list|(
name|a
argument_list|,
name|ARCHIVE_EOF
argument_list|,
name|archive_read_next_header
argument_list|(
name|a
argument_list|,
operator|&
name|ae
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
literal|1
argument_list|,
name|archive_file_count
argument_list|(
name|a
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|ARCHIVE_OK
argument_list|,
name|archive_read_close
argument_list|(
name|a
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
name|ARCHIVE_OK
argument_list|,
name|archive_read_free
argument_list|(
name|a
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|"ulink.h"
end_include

begin_comment
comment|/*  * Memory initialization  */
end_comment

begin_decl_stmt
name|struct
name|gentry
modifier|*
modifier|*
name|ghash
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* hash area for global table */
end_comment

begin_decl_stmt
name|struct
name|ientry
modifier|*
modifier|*
name|ihash
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* hash area for identifier table */
end_comment

begin_decl_stmt
name|struct
name|fentry
modifier|*
modifier|*
name|fhash
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* hash area for field table */
end_comment

begin_decl_stmt
name|struct
name|lentry
modifier|*
name|ltable
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* local table */
end_comment

begin_decl_stmt
name|struct
name|gentry
modifier|*
name|gtable
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* global table */
end_comment

begin_decl_stmt
name|struct
name|centry
modifier|*
name|ctable
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* constant table */
end_comment

begin_decl_stmt
name|struct
name|ientry
modifier|*
name|itable
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* identifier table */
end_comment

begin_decl_stmt
name|struct
name|fentry
modifier|*
name|ftable
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* field table headers */
end_comment

begin_decl_stmt
name|struct
name|rentry
modifier|*
name|rtable
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* field table record lists */
end_comment

begin_decl_stmt
name|char
modifier|*
name|strings
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* string space */
end_comment

begin_decl_stmt
name|int
modifier|*
name|labels
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* label table */
end_comment

begin_decl_stmt
name|char
modifier|*
name|code
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* generated code space */
end_comment

begin_decl_stmt
name|struct
name|gentry
modifier|*
name|gfree
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* free pointer for global table */
end_comment

begin_decl_stmt
name|struct
name|ientry
modifier|*
name|ifree
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* free pointer for identifier table */
end_comment

begin_decl_stmt
name|struct
name|fentry
modifier|*
name|ffree
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* free pointer for field table headers */
end_comment

begin_decl_stmt
name|struct
name|rentry
modifier|*
name|rfree
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* free pointer for field table record lists */
end_comment

begin_decl_stmt
name|char
modifier|*
name|sfree
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* free pointer for string space */
end_comment

begin_decl_stmt
name|char
modifier|*
name|codep
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* free pointer for code space */
end_comment

begin_decl_stmt
name|int
name|lsize
init|=
name|LSIZE
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* size of local table */
end_comment

begin_decl_stmt
name|int
name|gsize
init|=
name|GSIZE
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* size of global table */
end_comment

begin_decl_stmt
name|int
name|csize
init|=
name|CSIZE
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* size of constant table */
end_comment

begin_decl_stmt
name|int
name|isize
init|=
name|ISIZE
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* size of identifier table */
end_comment

begin_decl_stmt
name|int
name|fsize
init|=
name|FSIZE
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* size of field table headers */
end_comment

begin_decl_stmt
name|int
name|rsize
init|=
name|RSIZE
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* size of field table record lists */
end_comment

begin_decl_stmt
name|int
name|ssize
init|=
name|SSIZE
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* size of string space */
end_comment

begin_decl_stmt
name|int
name|ghsize
init|=
name|GHSIZE
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* size of global hash table */
end_comment

begin_decl_stmt
name|int
name|ihsize
init|=
name|IHSIZE
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* size of identifier hash table */
end_comment

begin_decl_stmt
name|int
name|fhsize
init|=
name|FHSIZE
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* size of field hash table */
end_comment

begin_decl_stmt
name|int
name|maxlabels
init|=
name|MAXLABELS
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* maximum number of labels per procedure */
end_comment

begin_decl_stmt
name|int
name|maxcode
init|=
name|MAXCODE
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* maximum amount of code per procedure */
end_comment

begin_decl_stmt
name|int
name|gmask
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* mask for global table hash */
end_comment

begin_decl_stmt
name|int
name|imask
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* mask for identifier table hash */
end_comment

begin_decl_stmt
name|int
name|fmask
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* mask for field table hash */
end_comment

begin_decl_stmt
specifier|extern
name|char
name|end
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* first unused location */
end_comment

begin_decl_stmt
name|char
modifier|*
name|memfree
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|filelist
index|[
literal|64
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* list of input file names */
end_comment

begin_macro
name|meminit
argument_list|(
argument|argc
argument_list|,
argument|argv
argument_list|)
end_macro

begin_decl_stmt
name|int
name|argc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|aval
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
specifier|register
name|char
modifier|*
modifier|*
name|fp
decl_stmt|;
specifier|register
union|union
block|{
name|struct
name|gentry
modifier|*
modifier|*
name|gp
decl_stmt|;
name|struct
name|ientry
modifier|*
modifier|*
name|ip
decl_stmt|;
name|struct
name|fentry
modifier|*
modifier|*
name|fp
decl_stmt|;
block|}
name|p
union|;
specifier|extern
name|char
modifier|*
name|allocate
parameter_list|()
function_decl|;
specifier|extern
name|char
modifier|*
name|instalid
parameter_list|()
function_decl|;
specifier|extern
name|struct
name|gentry
modifier|*
name|putglob
parameter_list|()
function_decl|;
name|memfree
operator|=
operator|&
name|end
expr_stmt|;
name|fp
operator|=
name|filelist
expr_stmt|;
while|while
condition|(
operator|--
name|argc
condition|)
block|{
if|if
condition|(
operator|*
operator|*
operator|++
name|argv
operator|==
literal|'-'
condition|)
block|{
switch|switch
condition|(
operator|(
operator|*
name|argv
operator|)
index|[
literal|1
index|]
condition|)
block|{
case|case
literal|'m'
case|:
case|case
literal|'u'
case|:
continue|continue;
case|case
literal|'t'
case|:
name|trace
operator|=
operator|-
literal|1
expr_stmt|;
continue|continue;
case|case
literal|'D'
case|:
name|Dflag
operator|++
expr_stmt|;
continue|continue;
case|case
literal|'o'
case|:
name|strcpy
argument_list|(
name|outname
argument_list|,
operator|*
operator|++
name|argv
argument_list|)
expr_stmt|;
name|argc
operator|--
expr_stmt|;
continue|continue;
case|case
literal|'S'
case|:
if|if
condition|(
operator|(
operator|*
name|argv
operator|)
index|[
literal|3
index|]
operator|==
literal|'h'
condition|)
block|{
comment|/* change hash table size */
name|aval
operator|=
name|atoi
argument_list|(
operator|&
operator|(
operator|*
name|argv
operator|)
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|aval
operator|<=
literal|0
condition|)
goto|goto
name|badarg
goto|;
switch|switch
condition|(
operator|(
operator|*
name|argv
operator|)
index|[
literal|2
index|]
condition|)
block|{
case|case
literal|'i'
case|:
name|ihsize
operator|=
name|aval
expr_stmt|;
continue|continue;
case|case
literal|'g'
case|:
name|ghsize
operator|=
name|aval
expr_stmt|;
continue|continue;
case|case
literal|'c'
case|:
continue|continue;
case|case
literal|'f'
case|:
name|fhsize
operator|=
name|aval
expr_stmt|;
continue|continue;
case|case
literal|'l'
case|:
continue|continue;
block|}
block|}
else|else
block|{
comment|/* change symbol table size */
name|aval
operator|=
name|atoi
argument_list|(
operator|&
operator|(
operator|*
name|argv
operator|)
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|aval
operator|<=
literal|0
condition|)
goto|goto
name|badarg
goto|;
switch|switch
condition|(
operator|(
operator|*
name|argv
operator|)
index|[
literal|2
index|]
condition|)
block|{
case|case
literal|'c'
case|:
name|csize
operator|=
name|aval
expr_stmt|;
continue|continue;
case|case
literal|'i'
case|:
name|isize
operator|=
name|aval
expr_stmt|;
continue|continue;
case|case
literal|'g'
case|:
name|gsize
operator|=
name|aval
expr_stmt|;
continue|continue;
case|case
literal|'l'
case|:
name|lsize
operator|=
name|aval
expr_stmt|;
continue|continue;
case|case
literal|'s'
case|:
name|ssize
operator|=
name|aval
expr_stmt|;
continue|continue;
case|case
literal|'t'
case|:
continue|continue;
case|case
literal|'f'
case|:
name|fsize
operator|=
name|aval
expr_stmt|;
continue|continue;
case|case
literal|'r'
case|:
name|rsize
operator|=
name|aval
expr_stmt|;
continue|continue;
case|case
literal|'L'
case|:
name|maxlabels
operator|=
name|aval
expr_stmt|;
continue|continue;
case|case
literal|'C'
case|:
name|maxcode
operator|=
name|aval
expr_stmt|;
continue|continue;
block|}
block|}
default|default:
name|badarg
label|:
name|printf
argument_list|(
literal|"bad argument: %s\n"
argument_list|,
operator|*
name|argv
argument_list|)
expr_stmt|;
continue|continue;
block|}
block|}
else|else
operator|*
name|fp
operator|++
operator|=
operator|*
name|argv
expr_stmt|;
block|}
operator|*
name|fp
operator|++
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|ghsize
condition|;
name|i
operator|<<=
literal|1
control|)
empty_stmt|;
name|ghsize
operator|=
name|i
expr_stmt|;
name|gmask
operator|=
name|i
operator|-
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|ihsize
condition|;
name|i
operator|<<=
literal|1
control|)
empty_stmt|;
name|ihsize
operator|=
name|i
expr_stmt|;
name|imask
operator|=
name|i
operator|-
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|fhsize
condition|;
name|i
operator|<<=
literal|1
control|)
empty_stmt|;
name|fhsize
operator|=
name|i
expr_stmt|;
name|fmask
operator|=
name|i
operator|-
literal|1
expr_stmt|;
name|ghash
operator|=
operator|(
expr|struct
name|gentry
operator|*
operator|*
operator|)
name|allocate
argument_list|(
name|ghsize
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|gentry
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|ihash
operator|=
operator|(
expr|struct
name|ientry
operator|*
operator|*
operator|)
name|allocate
argument_list|(
name|ihsize
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ientry
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|fhash
operator|=
operator|(
expr|struct
name|fentry
operator|*
operator|*
operator|)
name|allocate
argument_list|(
name|fhsize
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|fentry
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|ltable
operator|=
operator|(
expr|struct
name|lentry
operator|*
operator|)
name|allocate
argument_list|(
name|lsize
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|lentry
argument_list|)
argument_list|)
expr_stmt|;
name|gtable
operator|=
operator|(
expr|struct
name|gentry
operator|*
operator|)
name|allocate
argument_list|(
name|gsize
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|gentry
argument_list|)
argument_list|)
expr_stmt|;
name|ctable
operator|=
operator|(
expr|struct
name|centry
operator|*
operator|)
name|allocate
argument_list|(
name|csize
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|centry
argument_list|)
argument_list|)
expr_stmt|;
name|itable
operator|=
operator|(
expr|struct
name|ientry
operator|*
operator|)
name|allocate
argument_list|(
name|isize
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ientry
argument_list|)
argument_list|)
expr_stmt|;
name|ftable
operator|=
operator|(
expr|struct
name|fentry
operator|*
operator|)
name|allocate
argument_list|(
name|fsize
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|fentry
argument_list|)
argument_list|)
expr_stmt|;
name|rtable
operator|=
operator|(
expr|struct
name|rentry
operator|*
operator|)
name|allocate
argument_list|(
name|rsize
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|rentry
argument_list|)
argument_list|)
expr_stmt|;
name|strings
operator|=
operator|(
name|char
operator|*
operator|)
name|allocate
argument_list|(
name|ssize
argument_list|,
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|labels
operator|=
operator|(
name|int
operator|*
operator|)
name|allocate
argument_list|(
name|maxlabels
argument_list|,
sizeof|sizeof
argument_list|(
name|int
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
operator|(
name|char
operator|*
operator|)
name|allocate
argument_list|(
name|maxcode
argument_list|,
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|code
operator|==
name|NULL
condition|)
name|syserr
argument_list|(
literal|"can't get enough memory"
argument_list|)
expr_stmt|;
name|gfree
operator|=
name|gtable
expr_stmt|;
name|ifree
operator|=
name|itable
expr_stmt|;
name|ffree
operator|=
name|ftable
expr_stmt|;
name|rfree
operator|=
name|rtable
expr_stmt|;
name|sfree
operator|=
name|strings
expr_stmt|;
name|codep
operator|=
name|code
expr_stmt|;
for|for
control|(
name|p
operator|.
name|gp
operator|=
name|ghash
init|;
name|p
operator|.
name|gp
operator|<
operator|&
name|ghash
index|[
name|ghsize
index|]
condition|;
name|p
operator|.
name|gp
operator|++
control|)
operator|*
name|p
operator|.
name|gp
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|p
operator|.
name|ip
operator|=
name|ihash
init|;
name|p
operator|.
name|ip
operator|<
operator|&
name|ihash
index|[
name|ihsize
index|]
condition|;
name|p
operator|.
name|ip
operator|++
control|)
operator|*
name|p
operator|.
name|ip
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|p
operator|.
name|fp
operator|=
name|fhash
init|;
name|p
operator|.
name|fp
operator|<
operator|&
name|fhash
index|[
name|fhsize
index|]
condition|;
name|p
operator|.
name|fp
operator|++
control|)
operator|*
name|p
operator|.
name|fp
operator|=
name|NULL
expr_stmt|;
name|putglob
argument_list|(
name|instalid
argument_list|(
literal|"main"
argument_list|)
argument_list|,
name|F_GLOBAL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * allocate - get more memory from system  */
end_comment

begin_function
name|char
modifier|*
name|allocate
parameter_list|(
name|n
parameter_list|,
name|size
parameter_list|)
name|int
name|n
decl_stmt|,
name|size
decl_stmt|;
block|{
specifier|register
name|int
name|need
decl_stmt|;
specifier|register
name|char
modifier|*
name|mfree
decl_stmt|;
specifier|extern
name|char
modifier|*
name|brk
parameter_list|()
function_decl|;
name|need
operator|=
name|n
operator|*
name|size
expr_stmt|;
name|mfree
operator|=
name|memfree
expr_stmt|;
if|if
condition|(
name|brk
argument_list|(
name|memfree
operator|+=
name|need
argument_list|)
operator|==
operator|(
name|char
operator|*
operator|)
operator|-
literal|1
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
return|return
operator|(
name|mfree
operator|)
return|;
block|}
end_function

end_unit


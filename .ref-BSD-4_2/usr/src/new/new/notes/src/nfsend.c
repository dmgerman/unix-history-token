begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_decl_stmt
specifier|static
name|char
modifier|*
name|sccsid
init|=
literal|"%W%"
decl_stmt|;
end_decl_stmt

begin_include
include|#
directive|include
file|"parms.h"
end_include

begin_include
include|#
directive|include
file|"structs.h"
end_include

begin_comment
comment|/*  *	nfsend will send the notes/responses to a new site that  *	that site has not seen (at least as far as we are concerned)  *	This means that we send them the ones that we received later  *	then the last time we sent them, and also that were not  *	written there nor were routed through there.  *  *	Also, a logfile is maintained of the network transmissions made.  *  *	Returns:	-1 if the notefile is not a networked notefile  *			else count of articles sent  *  *	Original Coding:	Ray Essick	December 1981  */
end_comment

begin_macro
name|nfsend
argument_list|(
argument|tosite
argument_list|,
argument|nfname
argument_list|,
argument|dmpfile
argument_list|,
argument|usetime
argument_list|,
argument|atime
argument_list|,
argument|sendnews
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|tosite
decl_stmt|,
comment|/* name of site we are sending to */
modifier|*
name|nfname
decl_stmt|,
comment|/* name of notefile sending to them */
modifier|*
name|dmpfile
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* and name of local file to place articles in */
end_comment

begin_decl_stmt
name|struct
name|when_f
modifier|*
name|atime
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* for explicitly specified times */
end_comment

begin_block
block|{
name|struct
name|io_f
name|io
decl_stmt|;
name|struct
name|note_f
name|note
decl_stmt|;
name|struct
name|resp_f
name|rsprec
decl_stmt|;
name|int
name|ncount
decl_stmt|,
name|rcount
decl_stmt|,
comment|/* how many of each sent */
name|num
decl_stmt|,
name|rrecnum
decl_stmt|,
name|roffset
decl_stmt|,
name|respnum
decl_stmt|;
name|FILE
modifier|*
name|log
decl_stmt|,
modifier|*
name|zfile
decl_stmt|,
modifier|*
name|fopen
argument_list|()
decl_stmt|;
comment|/* logfile stuff */
name|struct
name|when_f
name|entered
decl_stmt|;
name|char
name|seqname
index|[
name|SYSSZ
operator|+
literal|20
index|]
decl_stmt|;
comment|/* buffer for sequencer name */
name|char
name|line
index|[
name|DATELEN
index|]
decl_stmt|;
comment|/* hold a formatted date */
name|char
name|fn
index|[
name|WDLEN
index|]
decl_stmt|;
comment|/* path to network log */
name|char
name|sendtime
index|[
name|DATELEN
index|]
decl_stmt|;
comment|/* time we are doing this at */
name|struct
name|when_f
name|xsendtime
decl_stmt|;
comment|/* unformatted of above */
name|gettime
argument_list|(
operator|&
name|xsendtime
argument_list|)
expr_stmt|;
name|sprdate
argument_list|(
operator|&
name|xsendtime
argument_list|,
name|sendtime
argument_list|)
expr_stmt|;
comment|/* format when we sent it */
name|x
argument_list|(
operator|(
name|zfile
operator|=
name|fopen
argument_list|(
name|dmpfile
argument_list|,
literal|"w"
argument_list|)
operator|)
operator|==
name|NULL
argument_list|,
literal|"nfsend: scratch"
argument_list|)
expr_stmt|;
if|if
condition|(
name|init
argument_list|(
operator|&
name|io
argument_list|,
name|nfname
argument_list|)
operator|<
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s: no such notesfile: %s\n"
argument_list|,
name|SYSTEM
argument_list|,
name|nfname
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|zfile
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|allow
argument_list|(
operator|&
name|io
argument_list|,
name|DRCTOK
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* must be director */
name|printf
argument_list|(
literal|"%s: not a director of %s\n"
argument_list|,
name|SYSTEM
argument_list|,
name|nfname
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|zfile
argument_list|)
expr_stmt|;
name|finish
argument_list|(
operator|&
name|io
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|getperms
argument_list|(
operator|&
name|io
argument_list|,
literal|1
argument_list|,
name|tosite
argument_list|)
expr_stmt|;
comment|/* grab system name */
if|if
condition|(
name|allow
argument_list|(
operator|&
name|io
argument_list|,
name|READOK
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* is he allowed to read ?? */
name|printf
argument_list|(
literal|"%s: site %s has no read permission for %s\n"
argument_list|,
name|SYSTEM
argument_list|,
name|tosite
argument_list|,
name|nfname
argument_list|)
expr_stmt|;
name|finish
argument_list|(
operator|&
name|io
argument_list|)
expr_stmt|;
comment|/* close it */
name|fclose
argument_list|(
name|zfile
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
comment|/* and go back */
block|}
if|if
condition|(
operator|(
name|io
operator|.
name|descr
operator|.
name|d_stat
operator|&
name|NETWRKD
operator|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s: notefile %s is not networked\n"
argument_list|,
name|SYSTEM
argument_list|,
name|nfname
argument_list|)
expr_stmt|;
name|finish
argument_list|(
operator|&
name|io
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|zfile
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|gettime
argument_list|(
operator|&
name|entered
argument_list|)
expr_stmt|;
comment|/* get time for updating sequencer */
name|sprintf
argument_list|(
name|seqname
argument_list|,
literal|"Sy:%s"
argument_list|,
name|tosite
argument_list|)
expr_stmt|;
comment|/* make sequencer name */
name|getlast
argument_list|(
operator|&
name|io
operator|.
name|stime
argument_list|,
name|nfname
argument_list|,
literal|1
argument_list|,
name|seqname
argument_list|)
expr_stmt|;
comment|/* grab the time */
if|if
condition|(
name|usetime
condition|)
block|{
name|copydate
argument_list|(
name|atime
argument_list|,
operator|&
name|io
operator|.
name|stime
argument_list|)
expr_stmt|;
comment|/* use this one instead */
block|}
name|sprdate
argument_list|(
operator|&
name|io
operator|.
name|stime
argument_list|,
name|line
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s: %s: Sending articles more recent than %s to %s\n"
argument_list|,
name|SYSTEM
argument_list|,
name|nfname
argument_list|,
name|line
argument_list|,
name|tosite
argument_list|)
expr_stmt|;
name|rcount
operator|=
name|ncount
operator|=
literal|0
expr_stmt|;
comment|/* how many things sent */
name|num
operator|=
literal|0
expr_stmt|;
comment|/* start at the beginning */
while|while
condition|(
operator|(
name|num
operator|=
name|nxtnote
argument_list|(
operator|&
name|io
argument_list|,
name|num
argument_list|,
operator|&
name|io
operator|.
name|stime
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
name|getnrec
argument_list|(
operator|&
name|io
argument_list|,
name|num
argument_list|,
operator|&
name|note
argument_list|)
expr_stmt|;
comment|/* grab the header */
if|if
condition|(
name|strcmp
argument_list|(
name|note
operator|.
name|n_from
argument_list|,
name|tosite
argument_list|)
operator|==
literal|0
condition|)
block|{
goto|goto
name|doresps
goto|;
comment|/* they sent it to us */
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|note
operator|.
name|n_id
operator|.
name|sys
argument_list|,
name|tosite
argument_list|)
operator|==
literal|0
condition|)
block|{
goto|goto
name|doresps
goto|;
comment|/* written there */
block|}
if|if
condition|(
name|inorder
argument_list|(
operator|&
name|io
operator|.
name|stime
argument_list|,
operator|&
name|note
operator|.
name|n_rcvd
argument_list|)
operator|==
literal|0
condition|)
block|{
goto|goto
name|doresps
goto|;
comment|/* just modified since then */
block|}
if|if
condition|(
operator|(
name|note
operator|.
name|n_stat
operator|&
name|FRMNEWS
operator|)
operator|&&
operator|(
name|sendnews
operator|==
literal|0
operator|)
condition|)
block|{
comment|/* DO NOT send news */
goto|goto
name|doresps
goto|;
comment|/* cause uniqid probs */
block|}
comment|/* they should have copy */
name|dmpnote
argument_list|(
operator|&
name|io
argument_list|,
operator|&
name|note
argument_list|,
name|num
argument_list|,
name|zfile
argument_list|,
name|NODETAIL
argument_list|)
expr_stmt|;
comment|/* dump to output */
name|ncount
operator|++
expr_stmt|;
comment|/* bump count of sent articles */
name|io
operator|.
name|nnotxmit
operator|++
expr_stmt|;
comment|/* and global stats */
name|doresps
label|:
comment|/* process the responses */
name|respnum
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
name|respnum
operator|=
name|nxtresp
argument_list|(
operator|&
name|io
argument_list|,
name|num
argument_list|,
name|respnum
argument_list|,
operator|&
name|io
operator|.
name|stime
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|lrsp
argument_list|(
operator|&
name|io
argument_list|,
name|num
argument_list|,
name|respnum
argument_list|,
operator|&
name|rsprec
argument_list|,
operator|&
name|roffset
argument_list|,
operator|&
name|rrecnum
argument_list|)
operator|==
operator|-
literal|1
condition|)
break|break;
comment|/* no response */
if|if
condition|(
name|strcmp
argument_list|(
name|rsprec
operator|.
name|r_id
index|[
name|roffset
index|]
operator|.
name|sys
argument_list|,
name|tosite
argument_list|)
operator|==
literal|0
condition|)
block|{
continue|continue;
comment|/* written over there */
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|rsprec
operator|.
name|r_from
index|[
name|roffset
index|]
argument_list|,
name|tosite
argument_list|)
operator|==
literal|0
condition|)
block|{
continue|continue;
comment|/* came from over there */
block|}
if|if
condition|(
operator|(
name|rsprec
operator|.
name|r_stat
index|[
name|roffset
index|]
operator|&
name|FRMNEWS
operator|)
operator|&&
operator|(
name|sendnews
operator|==
literal|0
operator|)
condition|)
block|{
continue|continue;
comment|/* never forward NEWS(I) stuff */
block|}
name|dmprsp
argument_list|(
operator|&
name|io
argument_list|,
operator|&
name|note
argument_list|,
name|num
argument_list|,
name|zfile
argument_list|,
name|respnum
argument_list|,
name|NODETAIL
argument_list|)
expr_stmt|;
name|rcount
operator|++
expr_stmt|;
name|io
operator|.
name|nrspxmit
operator|++
expr_stmt|;
comment|/* and global stats */
block|}
block|}
name|fixlast
argument_list|(
operator|&
name|entered
argument_list|,
name|nfname
argument_list|,
literal|1
argument_list|,
name|seqname
argument_list|)
expr_stmt|;
comment|/* update the sequencer time */
name|lock
argument_list|(
operator|&
name|io
argument_list|,
literal|'n'
argument_list|)
expr_stmt|;
name|getdscr
argument_list|(
operator|&
name|io
argument_list|,
operator|&
name|io
operator|.
name|descr
argument_list|)
expr_stmt|;
name|gettime
argument_list|(
operator|&
name|io
operator|.
name|descr
operator|.
name|d_lstxmit
argument_list|)
expr_stmt|;
comment|/* mark as sent now */
if|if
condition|(
name|ncount
operator|+
name|rcount
operator|>
literal|0
condition|)
block|{
comment|/* only if sent stuff */
name|io
operator|.
name|descr
operator|.
name|netwrkouts
operator|++
expr_stmt|;
comment|/* increment number of xmits */
block|}
name|putdscr
argument_list|(
operator|&
name|io
argument_list|,
operator|&
name|io
operator|.
name|descr
argument_list|)
expr_stmt|;
name|unlock
argument_list|(
operator|&
name|io
argument_list|,
literal|'n'
argument_list|)
expr_stmt|;
name|finish
argument_list|(
operator|&
name|io
argument_list|)
expr_stmt|;
comment|/* close the notefile */
name|fclose
argument_list|(
name|zfile
argument_list|)
expr_stmt|;
comment|/* and the dumping file */
name|printf
argument_list|(
literal|"%s: %s: %d notes& %d responses sent to %s\n"
argument_list|,
name|SYSTEM
argument_list|,
name|nfname
argument_list|,
name|ncount
argument_list|,
name|rcount
argument_list|,
name|tosite
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|fn
argument_list|,
literal|"%s/%s/%s"
argument_list|,
name|MSTDIR
argument_list|,
name|UTILITY
argument_list|,
name|NETLOG
argument_list|)
expr_stmt|;
if|if
condition|(
name|ncount
operator|+
name|rcount
condition|)
block|{
comment|/* log only if sending */
name|glock
argument_list|(
operator|&
name|io
argument_list|,
name|LOGLOCK
argument_list|)
expr_stmt|;
comment|/* now, update the log file */
name|x
argument_list|(
operator|(
name|log
operator|=
name|fopen
argument_list|(
name|fn
argument_list|,
literal|"a"
argument_list|)
operator|)
operator|==
name|NULL
argument_list|,
literal|"nfsend: bad net log file"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|log
argument_list|,
literal|"%s: sent %d notes& %d responses to %s at %s\n"
argument_list|,
name|nfname
argument_list|,
name|ncount
argument_list|,
name|rcount
argument_list|,
name|tosite
argument_list|,
name|sendtime
argument_list|)
expr_stmt|;
name|x
argument_list|(
name|fclose
argument_list|(
name|log
argument_list|)
operator|==
name|EOF
argument_list|,
literal|"nfsend: trouble fclosing log file"
argument_list|)
expr_stmt|;
name|gunlock
argument_list|(
operator|&
name|io
argument_list|,
name|LOGLOCK
argument_list|)
expr_stmt|;
comment|/* and unlock */
block|}
return|return
operator|(
name|ncount
operator|+
name|rcount
operator|)
return|;
block|}
end_block

end_unit


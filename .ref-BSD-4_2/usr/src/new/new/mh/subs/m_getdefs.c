begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|"mh.h"
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_decl_stmt
name|char
name|defpath
index|[
literal|128
index|]
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|procs
block|{
name|char
modifier|*
name|procname
decl_stmt|;
name|char
modifier|*
modifier|*
name|procnaddr
decl_stmt|;
block|}
name|procs
index|[]
init|=
block|{
block|{
literal|"lsproc"
block|,
operator|&
name|lsproc
block|}
block|,
block|{
literal|"mh_deliver"
block|,
operator|&
name|mh_deliver
block|}
block|,
block|{
literal|"prproc"
block|,
operator|&
name|prproc
block|}
block|,
block|{
literal|"scanproc"
block|,
operator|&
name|scanproc
block|}
block|,
block|{
literal|"showproc"
block|,
operator|&
name|showproc
block|}
block|,
block|{
literal|"sendproc"
block|,
operator|&
name|sendproc
block|}
block|,
block|{
literal|"fileproc"
block|,
operator|&
name|fileproc
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|, }
struct|;
end_struct

begin_macro
name|m_getdefs
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|struct
name|node
modifier|*
name|np
decl_stmt|;
specifier|register
name|int
name|state
decl_stmt|,
name|wpid
decl_stmt|,
name|pid
decl_stmt|;
specifier|register
name|struct
name|procs
modifier|*
name|ps
decl_stmt|;
name|int
name|status
decl_stmt|;
name|FILE
modifier|*
name|ib
decl_stmt|;
name|char
name|name
index|[
name|NAMESZ
index|]
decl_stmt|,
name|field
index|[
literal|128
index|]
decl_stmt|;
if|if
condition|(
name|defpath
index|[
literal|0
index|]
condition|)
return|return;
comment|/* We've already been called!   */
if|if
condition|(
operator|!
name|mypath
condition|)
if|if
condition|(
operator|(
name|mypath
operator|=
name|getenv
argument_list|(
literal|"HOME"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"HOME environment variable not set!\n"
argument_list|)
expr_stmt|;
name|done
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|sprintf
argument_list|(
name|defpath
argument_list|,
literal|"%s%s"
argument_list|,
name|mypath
argument_list|,
name|mh_prof
argument_list|)
expr_stmt|;
comment|/***    copy(mh_prof, copy(mypath, defpath));           ***/
if|if
condition|(
operator|(
name|ib
operator|=
name|fopen
argument_list|(
name|defpath
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
name|pid
operator|=
name|fork
argument_list|()
operator|)
operator|==
literal|0
condition|)
block|{
name|execl
argument_list|(
name|installproc
argument_list|,
literal|"install-mh"
argument_list|,
literal|"-auto"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can't exec "
argument_list|)
expr_stmt|;
name|perror
argument_list|(
name|installproc
argument_list|)
expr_stmt|;
name|done
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pid
operator|==
operator|-
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"No forks!\n"
argument_list|)
expr_stmt|;
name|done
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
while|while
condition|(
operator|(
name|wpid
operator|=
name|wait
argument_list|(
operator|&
name|status
argument_list|)
operator|)
operator|!=
operator|-
literal|1
operator|&&
name|wpid
operator|!=
name|pid
condition|)
empty_stmt|;
if|if
condition|(
name|status
operator|||
operator|(
name|ib
operator|=
name|fopen
argument_list|(
name|defpath
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"[install-mh aborted]\n"
argument_list|)
expr_stmt|;
name|done
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
ifdef|#
directive|ifdef
name|NEWS
comment|/* NOT CONVERTED TO V7!!! */
name|fstat
argument_list|(
name|fildes
argument_list|(
name|ib
argument_list|)
argument_list|,
name|field
argument_list|)
expr_stmt|;
name|deftime
operator|=
operator|(
operator|&
name|field
operator|)
operator|->
name|i_atime
expr_stmt|;
endif|#
directive|endif
name|np
operator|=
operator|(
expr|struct
name|node
operator|*
operator|)
operator|&
name|m_defs
expr_stmt|;
name|state
operator|=
name|FLD
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
switch|switch
condition|(
name|state
operator|=
name|m_getfld
argument_list|(
name|state
argument_list|,
name|name
argument_list|,
name|field
argument_list|,
sizeof|sizeof
name|field
argument_list|,
name|ib
argument_list|)
condition|)
block|{
case|case
name|FLD
case|:
case|case
name|FLDEOF
case|:
name|np
operator|->
name|n_next
operator|=
operator|(
expr|struct
name|node
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
expr|*
name|np
argument_list|)
expr_stmt|;
name|np
operator|=
name|np
operator|->
name|n_next
expr_stmt|;
name|np
operator|->
name|n_name
operator|=
name|getcpy
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|np
operator|->
name|n_field
operator|=
name|trimcpy
argument_list|(
name|field
argument_list|)
expr_stmt|;
name|np
operator|->
name|n_next
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|ps
operator|=
name|procs
init|;
name|ps
operator|->
name|procname
condition|;
name|ps
operator|++
control|)
if|if
condition|(
name|strcmp
argument_list|(
name|np
operator|->
name|n_name
argument_list|,
name|ps
operator|->
name|procname
argument_list|)
operator|==
literal|0
condition|)
block|{
operator|*
name|ps
operator|->
name|procnaddr
operator|=
name|np
operator|->
name|n_field
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|state
operator|==
name|FLDEOF
condition|)
block|{
name|fclose
argument_list|(
name|ib
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
continue|continue;
case|case
name|BODY
case|:
case|case
name|BODYEOF
case|:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|".mh_profile must not contain a body--it can't \ end with a blank line!\n"
argument_list|)
expr_stmt|;
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Bad format: .mh_profile!\n"
argument_list|)
expr_stmt|;
name|done
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
end_block

end_unit


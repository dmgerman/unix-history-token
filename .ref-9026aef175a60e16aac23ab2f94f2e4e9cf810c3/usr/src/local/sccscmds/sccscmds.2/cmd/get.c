begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_comment
comment|/* for MAXPATHLEN */
end_comment

begin_undef
undef|#
directive|undef
name|MAX
end_undef

begin_include
include|#
directive|include
file|"../hdr/defines.h"
end_include

begin_include
include|#
directive|include
file|"../hdr/had.h"
end_include

begin_include
include|#
directive|include
file|<sys/dir.h>
end_include

begin_include
include|#
directive|include
file|"pathnames.h"
end_include

begin_decl_stmt
specifier|static
name|char
name|Sccsid
index|[]
init|=
literal|"@(#)get.c	4.12	%G%"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|Debug
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|packet
name|gpkt
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|sid
name|sid
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|Ser
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|num_files
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|had
index|[
literal|26
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|ilist
decl_stmt|,
modifier|*
name|elist
decl_stmt|,
modifier|*
name|lfile
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|long
name|cutoff
init|=
literal|0X7FFFFFFFL
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* max positive long */
end_comment

begin_decl_stmt
name|int
name|verbosity
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|Gfile
index|[
name|MAXNAMLEN
operator|+
literal|3
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|Mod
index|[
name|MAXNAMLEN
operator|+
literal|3
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* should be as large as Gfile? */
end_comment

begin_decl_stmt
name|char
modifier|*
name|Type
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|Did_id
decl_stmt|;
end_decl_stmt

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
specifier|register
name|char
modifier|*
name|argv
index|[]
decl_stmt|;
block|{
specifier|register
name|int
name|i
decl_stmt|;
specifier|register
name|char
modifier|*
name|p
decl_stmt|;
name|char
name|c
decl_stmt|;
name|int
name|testmore
decl_stmt|;
specifier|extern
name|int
name|Fcnt
decl_stmt|;
extern|extern get(
block|)
function|;
end_function

begin_expr_stmt
name|Fflags
operator|=
name|FTLEXIT
operator||
name|FTLMSG
operator||
name|FTLCLN
expr_stmt|;
end_expr_stmt

begin_for
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|argv
index|[
name|i
index|]
index|[
literal|0
index|]
operator|==
literal|'-'
operator|&&
operator|(
name|c
operator|=
name|argv
index|[
name|i
index|]
index|[
literal|1
index|]
operator|)
condition|)
block|{
name|p
operator|=
operator|&
name|argv
index|[
name|i
index|]
index|[
literal|2
index|]
expr_stmt|;
name|testmore
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'a'
case|:
if|if
condition|(
operator|!
name|p
index|[
literal|0
index|]
condition|)
block|{
name|argv
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
continue|continue;
block|}
name|Ser
operator|=
name|patoi
argument_list|(
name|p
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'r'
case|:
if|if
condition|(
operator|!
name|p
index|[
literal|0
index|]
condition|)
block|{
name|argv
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
continue|continue;
block|}
name|chksid
argument_list|(
name|sid_ab
argument_list|(
name|p
argument_list|,
operator|&
name|sid
argument_list|)
argument_list|,
operator|&
name|sid
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
if|if
condition|(
operator|!
name|p
index|[
literal|0
index|]
condition|)
block|{
name|argv
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|date_ab
argument_list|(
name|p
argument_list|,
operator|&
name|cutoff
argument_list|)
condition|)
name|fatal
argument_list|(
literal|"bad date/time (cm5)"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
name|lfile
operator|=
name|p
expr_stmt|;
break|break;
case|case
literal|'i'
case|:
if|if
condition|(
operator|!
name|p
index|[
literal|0
index|]
condition|)
block|{
name|argv
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
continue|continue;
block|}
name|ilist
operator|=
name|p
expr_stmt|;
break|break;
case|case
literal|'x'
case|:
if|if
condition|(
operator|!
name|p
index|[
literal|0
index|]
condition|)
block|{
name|argv
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
continue|continue;
block|}
name|elist
operator|=
name|p
expr_stmt|;
break|break;
case|case
literal|'b'
case|:
case|case
literal|'g'
case|:
case|case
literal|'e'
case|:
case|case
literal|'p'
case|:
case|case
literal|'k'
case|:
case|case
literal|'m'
case|:
case|case
literal|'n'
case|:
case|case
literal|'s'
case|:
case|case
literal|'t'
case|:
name|testmore
operator|++
expr_stmt|;
break|break;
default|default:
name|fatal
argument_list|(
literal|"unknown key letter (cm1)"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|testmore
condition|)
block|{
name|testmore
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|*
name|p
condition|)
block|{
name|sprintf
argument_list|(
name|Error
argument_list|,
literal|"value after %c arg (cm8)"
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|fatal
argument_list|(
name|Error
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|had
index|[
name|c
operator|-
literal|'a'
index|]
operator|++
condition|)
name|fatal
argument_list|(
literal|"key letter twice (cm2)"
argument_list|)
expr_stmt|;
name|argv
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
block|}
else|else
name|num_files
operator|++
expr_stmt|;
end_for

begin_if
if|if
condition|(
name|num_files
operator|==
literal|0
condition|)
name|fatal
argument_list|(
literal|"missing file arg (cm3)"
argument_list|)
expr_stmt|;
end_if

begin_if
if|if
condition|(
name|HADE
operator|&&
name|HADM
condition|)
name|fatal
argument_list|(
literal|"e not allowed with m (ge3)"
argument_list|)
expr_stmt|;
end_if

begin_if
if|if
condition|(
name|HADE
operator|||
name|HADI
operator|||
name|HADX
condition|)
name|HADK
operator|=
literal|1
expr_stmt|;
end_if

begin_if
if|if
condition|(
operator|!
name|HADS
condition|)
name|verbosity
operator|=
operator|-
literal|1
expr_stmt|;
end_if

begin_expr_stmt
name|setsig
argument_list|()
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|Fflags
operator|&=
operator|~
name|FTLEXIT
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|Fflags
operator||=
name|FTLJMP
expr_stmt|;
end_expr_stmt

begin_for
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|p
operator|=
name|argv
index|[
name|i
index|]
condition|)
name|do_file
argument_list|(
name|p
argument_list|,
name|get
argument_list|)
expr_stmt|;
end_for

begin_expr_stmt
name|exit
argument_list|(
name|Fcnt
condition|?
literal|1
else|:
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
unit|}   get
operator|(
name|file
operator|)
block|{
specifier|register
name|char
operator|*
name|p
block|;
specifier|register
name|unsigned
name|ser
block|;
specifier|extern
name|char
name|had_dir
block|,
name|had_standinp
block|;
specifier|extern
name|char
operator|*
name|Sflags
index|[]
block|; 	struct
name|stats
name|stats
block|;
name|char
name|str
index|[
literal|32
index|]
block|;
if|if
condition|(
name|setjmp
argument_list|(
name|Fjmp
argument_list|)
condition|)
return|return;
name|sinit
argument_list|(
operator|&
name|gpkt
argument_list|,
name|file
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|gpkt
operator|.
name|p_ixuser
operator|=
operator|(
name|HADI
operator||
name|HADX
operator|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|gpkt
operator|.
name|p_reqsid
operator|.
name|s_rel
operator|=
name|sid
operator|.
name|s_rel
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|gpkt
operator|.
name|p_reqsid
operator|.
name|s_lev
operator|=
name|sid
operator|.
name|s_lev
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|gpkt
operator|.
name|p_reqsid
operator|.
name|s_br
operator|=
name|sid
operator|.
name|s_br
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|gpkt
operator|.
name|p_reqsid
operator|.
name|s_seq
operator|=
name|sid
operator|.
name|s_seq
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|gpkt
operator|.
name|p_verbose
operator|=
name|verbosity
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|gpkt
operator|.
name|p_stdout
operator|=
operator|(
name|HADP
condition|?
name|stderr
else|:
name|stdout
operator|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|gpkt
operator|.
name|p_cutoff
operator|=
name|cutoff
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|gpkt
operator|.
name|p_lfile
operator|=
name|lfile
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|copy
argument_list|(
name|auxf
argument_list|(
name|gpkt
operator|.
name|p_file
argument_list|,
literal|'g'
argument_list|)
argument_list|,
name|Gfile
argument_list|)
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
name|gpkt
operator|.
name|p_verbose
operator|&&
operator|(
name|num_files
operator|>
literal|1
operator|||
name|had_dir
operator|||
name|had_standinp
operator|)
condition|)
name|fprintf
argument_list|(
name|gpkt
operator|.
name|p_stdout
argument_list|,
literal|"\n%s:\n"
argument_list|,
name|gpkt
operator|.
name|p_file
argument_list|)
expr_stmt|;
end_if

begin_if
if|if
condition|(
name|dodelt
argument_list|(
operator|&
name|gpkt
argument_list|,
operator|&
name|stats
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
operator|==
literal|0
condition|)
name|fmterr
argument_list|(
operator|&
name|gpkt
argument_list|)
expr_stmt|;
end_if

begin_expr_stmt
name|finduser
argument_list|(
operator|&
name|gpkt
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|doflags
argument_list|(
operator|&
name|gpkt
argument_list|)
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
operator|!
name|HADA
condition|)
name|ser
operator|=
name|getser
argument_list|(
operator|&
name|gpkt
argument_list|)
expr_stmt|;
else|else
block|{
if|if
condition|(
operator|(
name|ser
operator|=
name|Ser
operator|)
operator|>
name|maxser
argument_list|(
operator|&
name|gpkt
argument_list|)
condition|)
name|fatal
argument_list|(
literal|"serial number too large (ge19)"
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|&
name|gpkt
operator|.
name|p_idel
index|[
name|ser
index|]
operator|.
name|i_sid
argument_list|,
operator|&
name|gpkt
operator|.
name|p_gotsid
argument_list|,
sizeof|sizeof
argument_list|(
name|sid
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|HADR
operator|&&
name|sid
operator|.
name|s_rel
operator|!=
name|gpkt
operator|.
name|p_gotsid
operator|.
name|s_rel
condition|)
block|{
name|bzero
argument_list|(
operator|&
name|gpkt
operator|.
name|p_reqsid
argument_list|,
sizeof|sizeof
argument_list|(
name|gpkt
operator|.
name|p_reqsid
argument_list|)
argument_list|)
expr_stmt|;
name|gpkt
operator|.
name|p_reqsid
operator|.
name|s_rel
operator|=
name|sid
operator|.
name|s_rel
expr_stmt|;
block|}
else|else
name|bcopy
argument_list|(
operator|&
name|gpkt
operator|.
name|p_gotsid
argument_list|,
operator|&
name|gpkt
operator|.
name|p_reqsid
argument_list|,
sizeof|sizeof
argument_list|(
name|sid
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_if

begin_expr_stmt
name|doie
argument_list|(
operator|&
name|gpkt
argument_list|,
name|ilist
argument_list|,
name|elist
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|setup
argument_list|(
operator|&
name|gpkt
argument_list|,
name|ser
argument_list|)
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
operator|!
operator|(
name|Type
operator|=
name|Sflags
index|[
name|TYPEFLAG
operator|-
literal|'a'
index|]
operator|)
condition|)
name|Type
operator|=
name|Null
expr_stmt|;
end_if

begin_if
if|if
condition|(
operator|!
operator|(
name|HADP
operator|||
name|HADG
operator|)
operator|&&
name|writable
argument_list|(
name|Gfile
argument_list|)
condition|)
block|{
name|sprintf
argument_list|(
name|Error
argument_list|,
literal|"writable `%s' exists (ge4)"
argument_list|,
name|Gfile
argument_list|)
expr_stmt|;
name|fatal
argument_list|(
name|Error
argument_list|)
expr_stmt|;
block|}
end_if

begin_if
if|if
condition|(
name|gpkt
operator|.
name|p_verbose
condition|)
block|{
name|sid_ba
argument_list|(
operator|&
name|gpkt
operator|.
name|p_gotsid
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|gpkt
operator|.
name|p_stdout
argument_list|,
literal|"%s\n"
argument_list|,
name|str
argument_list|)
expr_stmt|;
block|}
end_if

begin_if
if|if
condition|(
name|HADE
condition|)
block|{
if|if
condition|(
operator|!
name|HADR
condition|)
name|bcopy
argument_list|(
operator|&
name|gpkt
operator|.
name|p_gotsid
argument_list|,
operator|&
name|gpkt
operator|.
name|p_reqsid
argument_list|,
sizeof|sizeof
argument_list|(
name|gpkt
operator|.
name|p_reqsid
argument_list|)
argument_list|)
expr_stmt|;
name|newsid
argument_list|(
operator|&
name|gpkt
argument_list|,
name|Sflags
index|[
name|BRCHFLAG
operator|-
literal|'a'
index|]
operator|&&
name|HADB
argument_list|)
expr_stmt|;
name|permiss
argument_list|(
operator|&
name|gpkt
argument_list|)
expr_stmt|;
name|wrtpfile
argument_list|(
operator|&
name|gpkt
argument_list|,
name|ilist
argument_list|,
name|elist
argument_list|)
expr_stmt|;
block|}
end_if

begin_expr_stmt
name|setuid
argument_list|(
name|getuid
argument_list|()
argument_list|)
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
name|HADL
condition|)
name|gen_lfile
argument_list|(
operator|&
name|gpkt
argument_list|)
expr_stmt|;
end_if

begin_if
if|if
condition|(
name|HADG
condition|)
block|{
name|fclose
argument_list|(
name|gpkt
operator|.
name|p_iop
argument_list|)
expr_stmt|;
name|xfreeall
argument_list|()
expr_stmt|;
return|return;
block|}
end_if

begin_expr_stmt
name|flushto
argument_list|(
operator|&
name|gpkt
argument_list|,
name|EUSERTXT
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|idsetup
argument_list|(
operator|&
name|gpkt
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|gpkt
operator|.
name|p_chkeof
operator|=
literal|1
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|Did_id
operator|=
literal|0
expr_stmt|;
end_expr_stmt

begin_while
while|while
condition|(
name|readmod
argument_list|(
operator|&
name|gpkt
argument_list|)
condition|)
block|{
if|if
condition|(
name|gpkt
operator|.
name|p_gout
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|HADP
condition|)
name|gpkt
operator|.
name|p_gout
operator|=
name|stdout
expr_stmt|;
else|else
name|gpkt
operator|.
name|p_gout
operator|=
name|xfcreat
argument_list|(
name|Gfile
argument_list|,
name|HADK
condition|?
literal|0666
else|:
literal|0444
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|HADN
condition|)
name|fprintf
argument_list|(
name|gpkt
operator|.
name|p_gout
argument_list|,
literal|"%s\t"
argument_list|,
name|Mod
argument_list|)
expr_stmt|;
if|if
condition|(
name|HADM
condition|)
block|{
name|sid_ba
argument_list|(
operator|&
name|gpkt
operator|.
name|p_inssid
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|gpkt
operator|.
name|p_gout
argument_list|,
literal|"%s\t"
argument_list|,
name|str
argument_list|)
expr_stmt|;
block|}
name|p
operator|=
name|gpkt
operator|.
name|p_line
expr_stmt|;
if|if
condition|(
operator|!
name|HADK
operator|&&
name|any
argument_list|(
literal|'%'
argument_list|,
name|p
argument_list|)
condition|)
name|p
operator|=
name|idsubst
argument_list|(
operator|&
name|gpkt
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
name|p
argument_list|,
name|gpkt
operator|.
name|p_gout
argument_list|)
expr_stmt|;
block|}
end_while

begin_expr_stmt
name|fflush
argument_list|(
name|gpkt
operator|.
name|p_gout
argument_list|)
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
name|gpkt
operator|.
name|p_gout
operator|&&
name|gpkt
operator|.
name|p_gout
operator|!=
name|stdout
condition|)
name|fclose
argument_list|(
name|gpkt
operator|.
name|p_gout
argument_list|)
expr_stmt|;
end_if

begin_if
if|if
condition|(
name|gpkt
operator|.
name|p_verbose
condition|)
name|fprintf
argument_list|(
name|gpkt
operator|.
name|p_stdout
argument_list|,
literal|"%u lines\n"
argument_list|,
name|gpkt
operator|.
name|p_glnno
argument_list|)
expr_stmt|;
end_if

begin_if
if|if
condition|(
operator|!
name|Did_id
operator|&&
operator|!
name|HADK
condition|)
if|if
condition|(
name|Sflags
index|[
name|IDFLAG
operator|-
literal|'a'
index|]
condition|)
name|fatal
argument_list|(
literal|"no id keywords (cm6)"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|gpkt
operator|.
name|p_verbose
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"No id keywords (cm7)\n"
argument_list|)
expr_stmt|;
end_if

begin_expr_stmt
name|xfreeall
argument_list|()
expr_stmt|;
end_expr_stmt

begin_expr_stmt
unit|}  writable
operator|(
name|fn
operator|)
name|char
operator|*
name|fn
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|struct
name|stat
name|s
decl_stmt|;
return|return
operator|(
name|stat
argument_list|(
name|fn
argument_list|,
operator|&
name|s
argument_list|)
operator|>=
literal|0
operator|&&
operator|(
name|s
operator|.
name|st_mode
operator|&
literal|0222
operator|)
operator|!=
literal|0
operator|)
return|;
block|}
end_block

begin_expr_stmt
name|newsid
argument_list|(
name|pkt
argument_list|,
name|branch
argument_list|)
specifier|register
expr|struct
name|packet
operator|*
name|pkt
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|branch
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|chkbr
decl_stmt|;
name|chkbr
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|pkt
operator|->
name|p_reqsid
operator|.
name|s_br
operator|==
literal|0
condition|)
block|{
name|pkt
operator|->
name|p_reqsid
operator|.
name|s_lev
operator|+=
literal|1
expr_stmt|;
if|if
condition|(
name|sidtoser
argument_list|(
operator|&
name|pkt
operator|->
name|p_reqsid
argument_list|,
name|pkt
argument_list|)
operator|||
name|pkt
operator|->
name|p_maxr
operator|>
name|pkt
operator|->
name|p_reqsid
operator|.
name|s_rel
operator|||
name|branch
condition|)
block|{
name|pkt
operator|->
name|p_reqsid
operator|.
name|s_rel
operator|=
name|pkt
operator|->
name|p_gotsid
operator|.
name|s_rel
expr_stmt|;
name|pkt
operator|->
name|p_reqsid
operator|.
name|s_lev
operator|=
name|pkt
operator|->
name|p_gotsid
operator|.
name|s_lev
expr_stmt|;
name|pkt
operator|->
name|p_reqsid
operator|.
name|s_br
operator|=
name|pkt
operator|->
name|p_gotsid
operator|.
name|s_br
operator|+
literal|1
expr_stmt|;
name|pkt
operator|->
name|p_reqsid
operator|.
name|s_seq
operator|=
literal|1
expr_stmt|;
name|chkbr
operator|++
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|pkt
operator|->
name|p_reqsid
operator|.
name|s_seq
operator|==
literal|0
operator|&&
operator|!
name|branch
condition|)
name|pkt
operator|->
name|p_reqsid
operator|.
name|s_seq
operator|=
name|pkt
operator|->
name|p_gotsid
operator|.
name|s_seq
operator|+
literal|1
expr_stmt|;
else|else
block|{
name|pkt
operator|->
name|p_reqsid
operator|.
name|s_seq
operator|+=
literal|1
expr_stmt|;
if|if
condition|(
name|branch
operator|||
name|sidtoser
argument_list|(
operator|&
name|pkt
operator|->
name|p_reqsid
argument_list|,
name|pkt
argument_list|)
condition|)
block|{
name|pkt
operator|->
name|p_reqsid
operator|.
name|s_br
operator|+=
literal|1
expr_stmt|;
name|pkt
operator|->
name|p_reqsid
operator|.
name|s_seq
operator|=
literal|1
expr_stmt|;
name|chkbr
operator|++
expr_stmt|;
block|}
block|}
if|if
condition|(
name|chkbr
condition|)
while|while
condition|(
name|sidtoser
argument_list|(
operator|&
name|pkt
operator|->
name|p_reqsid
argument_list|,
name|pkt
argument_list|)
condition|)
name|pkt
operator|->
name|p_reqsid
operator|.
name|s_br
operator|+=
literal|1
expr_stmt|;
if|if
condition|(
name|sidtoser
argument_list|(
operator|&
name|pkt
operator|->
name|p_reqsid
argument_list|,
name|pkt
argument_list|)
condition|)
name|fatal
argument_list|(
literal|"internal error in newsid()"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|enter
argument_list|(
argument|pkt
argument_list|,
argument|ch
argument_list|,
argument|n
argument_list|,
argument|sidp
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|packet
modifier|*
name|pkt
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|ch
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|n
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|sid
modifier|*
name|sidp
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
name|str
index|[
literal|32
index|]
decl_stmt|;
specifier|register
name|struct
name|apply
modifier|*
name|ap
decl_stmt|;
name|sid_ba
argument_list|(
name|sidp
argument_list|,
name|str
argument_list|)
expr_stmt|;
if|if
condition|(
name|pkt
operator|->
name|p_verbose
condition|)
name|fprintf
argument_list|(
name|pkt
operator|->
name|p_stdout
argument_list|,
literal|"%s\n"
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|ap
operator|=
operator|&
name|pkt
operator|->
name|p_apply
index|[
name|n
index|]
expr_stmt|;
switch|switch
condition|(
name|ap
operator|->
name|a_code
condition|)
block|{
case|case
name|EMPTY
case|:
if|if
condition|(
name|ch
operator|==
name|INCLUDE
condition|)
name|condset
argument_list|(
name|ap
argument_list|,
name|APPLY
argument_list|,
name|INCLUSER
argument_list|)
expr_stmt|;
else|else
name|condset
argument_list|(
name|ap
argument_list|,
name|NOAPPLY
argument_list|,
name|EXCLUSER
argument_list|)
expr_stmt|;
break|break;
case|case
name|APPLY
case|:
name|sid_ba
argument_list|(
name|sidp
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|Error
argument_list|,
literal|"%s already included (ge9)"
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|fatal
argument_list|(
name|Error
argument_list|)
expr_stmt|;
break|break;
case|case
name|NOAPPLY
case|:
name|sid_ba
argument_list|(
name|sidp
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|Error
argument_list|,
literal|"%s already excluded (ge10)"
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|fatal
argument_list|(
name|Error
argument_list|)
expr_stmt|;
break|break;
default|default:
name|fatal
argument_list|(
literal|"internal error in get/enter() (ge11)"
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_block

begin_expr_stmt
name|gen_lfile
argument_list|(
name|pkt
argument_list|)
specifier|register
expr|struct
name|packet
operator|*
name|pkt
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|int
name|n
decl_stmt|;
name|int
name|reason
decl_stmt|;
name|char
name|str
index|[
literal|32
index|]
decl_stmt|;
name|char
name|line
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|struct
name|deltab
name|dt
decl_stmt|;
name|FILE
modifier|*
name|in
decl_stmt|;
name|FILE
modifier|*
name|out
decl_stmt|;
name|in
operator|=
name|xfopen
argument_list|(
name|pkt
operator|->
name|p_file
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|pkt
operator|->
name|p_lfile
condition|)
name|out
operator|=
name|stdout
expr_stmt|;
else|else
name|out
operator|=
name|xfcreat
argument_list|(
name|auxf
argument_list|(
name|pkt
operator|->
name|p_file
argument_list|,
literal|'l'
argument_list|)
argument_list|,
literal|0444
argument_list|)
expr_stmt|;
name|fgets
argument_list|(
name|line
argument_list|,
sizeof|sizeof
argument_list|(
name|line
argument_list|)
argument_list|,
name|in
argument_list|)
expr_stmt|;
while|while
condition|(
name|fgets
argument_list|(
name|line
argument_list|,
sizeof|sizeof
argument_list|(
name|line
argument_list|)
argument_list|,
name|in
argument_list|)
operator|!=
name|NULL
operator|&&
name|line
index|[
literal|0
index|]
operator|==
name|CTLCHAR
operator|&&
name|line
index|[
literal|1
index|]
operator|==
name|STATS
condition|)
block|{
name|fgets
argument_list|(
name|line
argument_list|,
sizeof|sizeof
argument_list|(
name|line
argument_list|)
argument_list|,
name|in
argument_list|)
expr_stmt|;
name|del_ab
argument_list|(
name|line
argument_list|,
operator|&
name|dt
argument_list|)
expr_stmt|;
if|if
condition|(
name|dt
operator|.
name|d_type
operator|==
literal|'D'
condition|)
block|{
name|reason
operator|=
name|pkt
operator|->
name|p_apply
index|[
name|dt
operator|.
name|d_serial
index|]
operator|.
name|a_reason
expr_stmt|;
if|if
condition|(
name|pkt
operator|->
name|p_apply
index|[
name|dt
operator|.
name|d_serial
index|]
operator|.
name|a_code
operator|==
name|APPLY
condition|)
block|{
name|putc
argument_list|(
literal|' '
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|putc
argument_list|(
literal|' '
argument_list|,
name|out
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|putc
argument_list|(
literal|'*'
argument_list|,
name|out
argument_list|)
expr_stmt|;
if|if
condition|(
name|reason
operator|&
name|IGNR
condition|)
name|putc
argument_list|(
literal|' '
argument_list|,
name|out
argument_list|)
expr_stmt|;
else|else
name|putc
argument_list|(
literal|'*'
argument_list|,
name|out
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|reason
operator|&
operator|(
name|INCL
operator||
name|EXCL
operator||
name|CUTOFF
operator|)
condition|)
block|{
case|case
name|INCL
case|:
name|putc
argument_list|(
literal|'I'
argument_list|,
name|out
argument_list|)
expr_stmt|;
break|break;
case|case
name|EXCL
case|:
name|putc
argument_list|(
literal|'X'
argument_list|,
name|out
argument_list|)
expr_stmt|;
break|break;
case|case
name|CUTOFF
case|:
name|putc
argument_list|(
literal|'C'
argument_list|,
name|out
argument_list|)
expr_stmt|;
break|break;
default|default:
name|putc
argument_list|(
literal|' '
argument_list|,
name|out
argument_list|)
expr_stmt|;
break|break;
block|}
name|putc
argument_list|(
literal|' '
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|sid_ba
argument_list|(
operator|&
name|dt
operator|.
name|d_sid
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"%s\t"
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|date_ba
argument_list|(
operator|&
name|dt
operator|.
name|d_datetime
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"%s %s\n"
argument_list|,
name|str
argument_list|,
name|dt
operator|.
name|d_pgmr
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
operator|(
name|n
operator|=
name|fgets
argument_list|(
name|line
argument_list|,
sizeof|sizeof
argument_list|(
name|line
argument_list|)
argument_list|,
name|in
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
if|if
condition|(
name|line
index|[
literal|0
index|]
operator|!=
name|CTLCHAR
condition|)
break|break;
else|else
block|{
switch|switch
condition|(
name|line
index|[
literal|1
index|]
condition|)
block|{
case|case
name|EDELTAB
case|:
break|break;
default|default:
continue|continue;
case|case
name|MRNUM
case|:
case|case
name|COMMENTS
case|:
if|if
condition|(
name|dt
operator|.
name|d_type
operator|==
literal|'D'
condition|)
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"\t%s"
argument_list|,
operator|&
name|line
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
continue|continue;
block|}
break|break;
block|}
if|if
condition|(
name|n
operator|==
name|NULL
operator|||
name|line
index|[
literal|0
index|]
operator|!=
name|CTLCHAR
condition|)
break|break;
name|putc
argument_list|(
literal|'\n'
argument_list|,
name|out
argument_list|)
expr_stmt|;
block|}
name|fclose
argument_list|(
name|in
argument_list|)
expr_stmt|;
if|if
condition|(
name|out
operator|!=
name|stdout
condition|)
name|fclose
argument_list|(
name|out
argument_list|)
expr_stmt|;
block|}
end_block

begin_decl_stmt
name|char
name|Curdate
index|[
literal|18
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|Curtime
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|Gdate
index|[
literal|9
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|Chgdate
index|[
literal|18
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|Chgtime
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|Gchgdate
index|[
literal|9
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|Qchgdate
index|[
literal|30
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|Sid
index|[
literal|32
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|Olddir
index|[
name|MAXPATHLEN
operator|+
literal|1
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|Pname
index|[
name|MAXPATHLEN
operator|+
literal|1
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|Dir
index|[
name|MAXPATHLEN
operator|+
literal|1
index|]
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|idsetup
argument_list|(
name|pkt
argument_list|)
specifier|register
expr|struct
name|packet
operator|*
name|pkt
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|extern
name|long
name|Timenow
decl_stmt|;
specifier|register
name|int
name|n
decl_stmt|;
specifier|register
name|char
modifier|*
name|p
decl_stmt|;
name|date_ba
argument_list|(
operator|&
name|Timenow
argument_list|,
name|Curdate
argument_list|)
expr_stmt|;
name|Curtime
operator|=
operator|&
name|Curdate
index|[
literal|9
index|]
expr_stmt|;
name|Curdate
index|[
literal|8
index|]
operator|=
literal|0
expr_stmt|;
name|copy
argument_list|(
name|pkt
operator|->
name|p_file
argument_list|,
name|Dir
argument_list|)
expr_stmt|;
name|dname
argument_list|(
name|Dir
argument_list|)
expr_stmt|;
if|if
condition|(
name|getwd
argument_list|(
name|Olddir
argument_list|)
operator|==
literal|0
condition|)
name|fatal
argument_list|(
literal|"getwd failed (ge20)"
argument_list|)
expr_stmt|;
if|if
condition|(
name|chdir
argument_list|(
name|Dir
argument_list|)
operator|!=
literal|0
condition|)
name|fatal
argument_list|(
literal|"cannot change directory (ge22)"
argument_list|)
expr_stmt|;
if|if
condition|(
name|getwd
argument_list|(
name|Pname
argument_list|)
operator|==
literal|0
condition|)
name|fatal
argument_list|(
literal|"getwd failed (ge21)"
argument_list|)
expr_stmt|;
if|if
condition|(
name|chdir
argument_list|(
name|Olddir
argument_list|)
operator|!=
literal|0
condition|)
name|fatal
argument_list|(
literal|"cannot change directory (ge23)"
argument_list|)
expr_stmt|;
name|makgdate
argument_list|(
name|Curdate
argument_list|,
name|Gdate
argument_list|)
expr_stmt|;
for|for
control|(
name|n
operator|=
name|maxser
argument_list|(
name|pkt
argument_list|)
init|;
name|n
condition|;
name|n
operator|--
control|)
if|if
condition|(
name|pkt
operator|->
name|p_apply
index|[
name|n
index|]
operator|.
name|a_code
operator|==
name|APPLY
condition|)
break|break;
if|if
condition|(
name|n
condition|)
name|date_ba
argument_list|(
operator|&
name|pkt
operator|->
name|p_idel
index|[
name|n
index|]
operator|.
name|i_datetime
argument_list|,
name|Chgdate
argument_list|)
expr_stmt|;
name|Chgtime
operator|=
operator|&
name|Chgdate
index|[
literal|9
index|]
expr_stmt|;
name|Chgdate
index|[
literal|8
index|]
operator|=
literal|0
expr_stmt|;
name|makgdate
argument_list|(
name|Chgdate
argument_list|,
name|Gchgdate
argument_list|)
expr_stmt|;
name|makqdate
argument_list|(
name|Gchgdate
argument_list|,
name|Qchgdate
argument_list|)
expr_stmt|;
name|sid_ba
argument_list|(
operator|&
name|pkt
operator|->
name|p_gotsid
argument_list|,
name|Sid
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|=
name|Sflags
index|[
name|MODFLAG
operator|-
literal|'a'
index|]
condition|)
name|copy
argument_list|(
name|p
argument_list|,
name|Mod
argument_list|)
expr_stmt|;
else|else
name|copy
argument_list|(
name|Gfile
argument_list|,
name|Mod
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|makgdate
argument_list|(
name|old
argument_list|,
name|new
argument_list|)
specifier|register
name|char
operator|*
name|old
operator|,
operator|*
name|new
expr_stmt|;
end_expr_stmt

begin_block
block|{
if|if
condition|(
operator|(
operator|*
name|new
operator|=
name|old
index|[
literal|3
index|]
operator|)
operator|!=
literal|'0'
condition|)
name|new
operator|++
expr_stmt|;
operator|*
name|new
operator|++
operator|=
name|old
index|[
literal|4
index|]
expr_stmt|;
operator|*
name|new
operator|++
operator|=
literal|'/'
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|new
operator|=
name|old
index|[
literal|6
index|]
operator|)
operator|!=
literal|'0'
condition|)
name|new
operator|++
expr_stmt|;
operator|*
name|new
operator|++
operator|=
name|old
index|[
literal|7
index|]
expr_stmt|;
operator|*
name|new
operator|++
operator|=
literal|'/'
expr_stmt|;
operator|*
name|new
operator|++
operator|=
name|old
index|[
literal|0
index|]
expr_stmt|;
operator|*
name|new
operator|++
operator|=
name|old
index|[
literal|1
index|]
expr_stmt|;
operator|*
name|new
operator|=
literal|0
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|makqdate
argument_list|(
name|old
argument_list|,
name|new
argument_list|)
specifier|register
name|char
operator|*
name|old
operator|,
operator|*
name|new
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|static
name|char
modifier|*
name|months
index|[
literal|12
index|]
init|=
block|{
literal|"January"
block|,
literal|"February"
block|,
literal|"March"
block|,
literal|"April"
block|,
literal|"May"
block|,
literal|"June"
block|,
literal|"July"
block|,
literal|"August"
block|,
literal|"September"
block|,
literal|"October"
block|,
literal|"November"
block|,
literal|"December"
block|}
decl_stmt|;
name|strcpy
argument_list|(
name|new
argument_list|,
name|months
index|[
name|atoi
argument_list|(
name|old
argument_list|)
operator|-
literal|1
index|]
argument_list|)
expr_stmt|;
while|while
condition|(
operator|*
name|new
operator|!=
literal|'\0'
condition|)
name|new
operator|++
expr_stmt|;
while|while
condition|(
operator|*
name|old
operator|++
operator|!=
literal|'/'
condition|)
empty_stmt|;
operator|*
name|new
operator|++
operator|=
literal|' '
expr_stmt|;
operator|*
name|new
operator|++
operator|=
operator|*
name|old
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|old
operator|!=
literal|'/'
condition|)
operator|*
name|new
operator|++
operator|=
operator|*
name|old
operator|++
expr_stmt|;
operator|*
name|new
operator|++
operator|=
literal|','
expr_stmt|;
operator|*
name|new
operator|++
operator|=
literal|' '
expr_stmt|;
operator|*
name|new
operator|++
operator|=
literal|'1'
expr_stmt|;
operator|*
name|new
operator|++
operator|=
literal|'9'
expr_stmt|;
comment|/* works for this century at least */
operator|*
name|new
operator|++
operator|=
operator|*
operator|++
name|old
expr_stmt|;
operator|*
name|new
operator|++
operator|=
operator|*
operator|++
name|old
expr_stmt|;
operator|*
name|new
operator|=
literal|'\0'
expr_stmt|;
block|}
end_block

begin_decl_stmt
specifier|static
name|char
name|Zkeywd
index|[
literal|5
index|]
init|=
literal|"@(#)"
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|idsubst
argument_list|(
name|pkt
argument_list|,
name|line
argument_list|)
specifier|register
expr|struct
name|packet
operator|*
name|pkt
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|char
name|line
index|[]
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|static
name|char
name|tline
index|[
name|BUFSIZ
index|]
decl_stmt|;
specifier|static
name|char
name|str
index|[
literal|32
index|]
decl_stmt|;
specifier|register
name|char
modifier|*
name|lp
decl_stmt|,
modifier|*
name|tp
decl_stmt|,
modifier|*
name|p
decl_stmt|;
specifier|extern
name|char
modifier|*
name|Type
decl_stmt|;
specifier|extern
name|char
modifier|*
name|Sflags
index|[]
decl_stmt|;
name|tp
operator|=
name|tline
expr_stmt|;
for|for
control|(
name|lp
operator|=
name|line
init|;
operator|*
name|lp
operator|!=
literal|0
condition|;
name|lp
operator|++
control|)
block|{
if|if
condition|(
name|lp
index|[
literal|0
index|]
operator|!=
literal|'%'
operator|||
operator|!
name|lp
index|[
literal|1
index|]
operator|||
operator|!
name|lp
index|[
literal|2
index|]
condition|)
block|{
operator|*
name|tp
operator|++
operator|=
operator|*
name|lp
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|lp
index|[
literal|2
index|]
operator|==
literal|'%'
condition|)
block|{
switch|switch
condition|(
operator|*
operator|++
name|lp
condition|)
block|{
case|case
literal|'M'
case|:
name|tp
operator|=
name|trans
argument_list|(
name|tp
argument_list|,
name|Mod
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'R'
case|:
name|sprintf
argument_list|(
name|str
argument_list|,
literal|"%u"
argument_list|,
name|pkt
operator|->
name|p_gotsid
operator|.
name|s_rel
argument_list|)
expr_stmt|;
name|tp
operator|=
name|trans
argument_list|(
name|tp
argument_list|,
name|str
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'L'
case|:
name|sprintf
argument_list|(
name|str
argument_list|,
literal|"%u"
argument_list|,
name|pkt
operator|->
name|p_gotsid
operator|.
name|s_lev
argument_list|)
expr_stmt|;
name|tp
operator|=
name|trans
argument_list|(
name|tp
argument_list|,
name|str
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'B'
case|:
name|sprintf
argument_list|(
name|str
argument_list|,
literal|"%u"
argument_list|,
name|pkt
operator|->
name|p_gotsid
operator|.
name|s_br
argument_list|)
expr_stmt|;
name|tp
operator|=
name|trans
argument_list|(
name|tp
argument_list|,
name|str
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'S'
case|:
name|sprintf
argument_list|(
name|str
argument_list|,
literal|"%u"
argument_list|,
name|pkt
operator|->
name|p_gotsid
operator|.
name|s_seq
argument_list|)
expr_stmt|;
name|tp
operator|=
name|trans
argument_list|(
name|tp
argument_list|,
name|str
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'D'
case|:
name|tp
operator|=
name|trans
argument_list|(
name|tp
argument_list|,
name|Curdate
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'H'
case|:
name|tp
operator|=
name|trans
argument_list|(
name|tp
argument_list|,
name|Gdate
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'T'
case|:
name|tp
operator|=
name|trans
argument_list|(
name|tp
argument_list|,
name|Curtime
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'E'
case|:
name|tp
operator|=
name|trans
argument_list|(
name|tp
argument_list|,
name|Chgdate
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'G'
case|:
name|tp
operator|=
name|trans
argument_list|(
name|tp
argument_list|,
name|Gchgdate
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'Q'
case|:
name|tp
operator|=
name|trans
argument_list|(
name|tp
argument_list|,
name|Qchgdate
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'U'
case|:
name|tp
operator|=
name|trans
argument_list|(
name|tp
argument_list|,
name|Chgtime
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'Z'
case|:
name|tp
operator|=
name|trans
argument_list|(
name|tp
argument_list|,
name|Zkeywd
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'Y'
case|:
name|tp
operator|=
name|trans
argument_list|(
name|tp
argument_list|,
name|Type
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'W'
case|:
name|tp
operator|=
name|trans
argument_list|(
name|tp
argument_list|,
name|Zkeywd
argument_list|)
expr_stmt|;
name|tp
operator|=
name|trans
argument_list|(
name|tp
argument_list|,
name|Mod
argument_list|)
expr_stmt|;
operator|*
name|tp
operator|++
operator|=
literal|'\t'
expr_stmt|;
case|case
literal|'I'
case|:
name|tp
operator|=
name|trans
argument_list|(
name|tp
argument_list|,
name|Sid
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'P'
case|:
name|tp
operator|=
name|trans
argument_list|(
name|tp
argument_list|,
name|Pname
argument_list|)
expr_stmt|;
operator|*
name|tp
operator|++
operator|=
literal|'/'
expr_stmt|;
name|tp
operator|=
name|trans
argument_list|(
name|tp
argument_list|,
operator|(
name|sname
argument_list|(
name|pkt
operator|->
name|p_file
argument_list|)
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'F'
case|:
name|tp
operator|=
name|trans
argument_list|(
name|tp
argument_list|,
name|pkt
operator|->
name|p_file
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'C'
case|:
name|sprintf
argument_list|(
name|str
argument_list|,
literal|"%u"
argument_list|,
name|pkt
operator|->
name|p_glnno
argument_list|)
expr_stmt|;
name|tp
operator|=
name|trans
argument_list|(
name|tp
argument_list|,
name|str
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'A'
case|:
name|tp
operator|=
name|trans
argument_list|(
name|tp
argument_list|,
name|Zkeywd
argument_list|)
expr_stmt|;
name|tp
operator|=
name|trans
argument_list|(
name|tp
argument_list|,
name|Type
argument_list|)
expr_stmt|;
operator|*
name|tp
operator|++
operator|=
literal|' '
expr_stmt|;
name|tp
operator|=
name|trans
argument_list|(
name|tp
argument_list|,
name|Mod
argument_list|)
expr_stmt|;
operator|*
name|tp
operator|++
operator|=
literal|' '
expr_stmt|;
name|tp
operator|=
name|trans
argument_list|(
name|tp
argument_list|,
name|Sid
argument_list|)
expr_stmt|;
name|tp
operator|=
name|trans
argument_list|(
name|tp
argument_list|,
name|Zkeywd
argument_list|)
expr_stmt|;
break|break;
default|default:
operator|*
name|tp
operator|++
operator|=
literal|'%'
expr_stmt|;
operator|*
name|tp
operator|++
operator|=
operator|*
name|lp
expr_stmt|;
continue|continue;
block|}
name|lp
operator|++
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|lp
argument_list|,
literal|"%sccs.include."
argument_list|,
literal|14
argument_list|)
condition|)
block|{
for|for
control|(
name|p
operator|=
name|lp
operator|+
literal|14
init|;
operator|*
name|p
operator|&&
operator|*
name|p
operator|!=
literal|'%'
condition|;
operator|++
name|p
control|)
empty_stmt|;
if|if
condition|(
operator|*
name|p
operator|==
literal|'%'
condition|)
block|{
operator|*
name|p
operator|=
literal|'\0'
expr_stmt|;
name|readcopy
argument_list|(
name|lp
operator|+
literal|14
argument_list|,
name|tline
argument_list|)
expr_stmt|;
return|return
operator|(
name|tline
operator|)
return|;
block|}
block|}
operator|*
name|tp
operator|++
operator|=
literal|'%'
expr_stmt|;
block|}
operator|*
name|tp
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|tline
operator|)
return|;
block|}
end_block

begin_expr_stmt
name|trans
argument_list|(
name|tp
argument_list|,
name|str
argument_list|)
specifier|register
name|char
operator|*
name|tp
operator|,
operator|*
name|str
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|Did_id
operator|=
literal|1
expr_stmt|;
while|while
condition|(
operator|*
name|tp
operator|++
operator|=
operator|*
name|str
operator|++
condition|)
empty_stmt|;
return|return
operator|(
name|tp
operator|-
literal|1
operator|)
return|;
block|}
end_block

begin_expr_stmt
name|readcopy
argument_list|(
name|name
argument_list|,
name|p
argument_list|)
specifier|register
name|char
operator|*
name|name
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|char
modifier|*
name|p
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|FILE
modifier|*
name|fp
decl_stmt|;
specifier|register
name|int
name|ch
decl_stmt|;
name|char
name|path
index|[
name|MAXPATHLEN
index|]
decl_stmt|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|path
argument_list|,
literal|"%s/%s"
argument_list|,
name|_PATH_SCCSINCLUDE
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|fp
operator|=
name|fopen
argument_list|(
name|path
argument_list|,
literal|"r"
argument_list|)
operator|)
condition|)
block|{
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|Error
argument_list|,
literal|"can't read %s"
argument_list|,
name|path
argument_list|)
expr_stmt|;
name|fatal
argument_list|(
name|Error
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
operator|(
name|ch
operator|=
name|getc
argument_list|(
name|fp
argument_list|)
operator|)
operator|!=
name|EOF
condition|)
operator|*
name|p
operator|++
operator|=
name|ch
expr_stmt|;
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|clean_up
argument_list|(
argument|n
argument_list|)
end_macro

begin_block
block|{
if|if
condition|(
name|gpkt
operator|.
name|p_file
index|[
literal|0
index|]
condition|)
name|unlockit
argument_list|(
name|auxf
argument_list|(
name|gpkt
operator|.
name|p_file
argument_list|,
literal|'z'
argument_list|)
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|gpkt
operator|.
name|p_iop
condition|)
name|fclose
argument_list|(
name|gpkt
operator|.
name|p_iop
argument_list|)
expr_stmt|;
name|xfreeall
argument_list|()
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|wrtpfile
argument_list|(
name|pkt
argument_list|,
name|inc
argument_list|,
name|exc
argument_list|)
specifier|register
expr|struct
name|packet
operator|*
name|pkt
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|char
modifier|*
name|inc
decl_stmt|,
modifier|*
name|exc
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
name|line
index|[
literal|64
index|]
decl_stmt|,
name|str1
index|[
literal|32
index|]
decl_stmt|,
name|str2
index|[
literal|32
index|]
decl_stmt|;
name|char
modifier|*
name|user
decl_stmt|;
name|FILE
modifier|*
name|in
decl_stmt|,
modifier|*
name|out
decl_stmt|;
name|struct
name|pfile
name|pf
decl_stmt|;
specifier|register
name|char
modifier|*
name|p
decl_stmt|;
name|int
name|fd
decl_stmt|;
name|int
name|i
decl_stmt|;
specifier|extern
name|long
name|Timenow
decl_stmt|;
name|user
operator|=
name|logname
argument_list|()
expr_stmt|;
if|if
condition|(
name|lockit
argument_list|(
name|auxf
argument_list|(
name|pkt
operator|->
name|p_file
argument_list|,
literal|'z'
argument_list|)
argument_list|,
literal|2
argument_list|,
name|getpid
argument_list|()
argument_list|)
condition|)
name|fatal
argument_list|(
literal|"cannot create lock file (cm4)"
argument_list|)
expr_stmt|;
if|if
condition|(
name|exists
argument_list|(
name|p
operator|=
name|auxf
argument_list|(
name|pkt
operator|->
name|p_file
argument_list|,
literal|'p'
argument_list|)
argument_list|)
condition|)
block|{
name|fd
operator|=
name|xopen
argument_list|(
name|p
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|in
operator|=
name|fdopen
argument_list|(
name|fd
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
while|while
condition|(
name|fgets
argument_list|(
name|line
argument_list|,
sizeof|sizeof
argument_list|(
name|line
argument_list|)
argument_list|,
name|in
argument_list|)
operator|!=
name|NULL
condition|)
block|{
name|p
operator|=
name|line
expr_stmt|;
name|p
index|[
name|length
argument_list|(
name|p
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|pf_ab
argument_list|(
name|p
argument_list|,
operator|&
name|pf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pf
operator|.
name|pf_gsid
operator|.
name|s_rel
operator|==
name|pkt
operator|->
name|p_gotsid
operator|.
name|s_rel
operator|&&
name|pf
operator|.
name|pf_gsid
operator|.
name|s_lev
operator|==
name|pkt
operator|->
name|p_gotsid
operator|.
name|s_lev
operator|&&
name|pf
operator|.
name|pf_gsid
operator|.
name|s_br
operator|==
name|pkt
operator|->
name|p_gotsid
operator|.
name|s_br
operator|&&
name|pf
operator|.
name|pf_gsid
operator|.
name|s_seq
operator|==
name|pkt
operator|->
name|p_gotsid
operator|.
name|s_seq
operator|)
operator|||
operator|(
name|pf
operator|.
name|pf_nsid
operator|.
name|s_rel
operator|==
name|pkt
operator|->
name|p_reqsid
operator|.
name|s_rel
operator|&&
name|pf
operator|.
name|pf_nsid
operator|.
name|s_lev
operator|==
name|pkt
operator|->
name|p_reqsid
operator|.
name|s_lev
operator|&&
name|pf
operator|.
name|pf_nsid
operator|.
name|s_br
operator|==
name|pkt
operator|->
name|p_reqsid
operator|.
name|s_br
operator|&&
name|pf
operator|.
name|pf_nsid
operator|.
name|s_seq
operator|==
name|pkt
operator|->
name|p_reqsid
operator|.
name|s_seq
operator|)
condition|)
block|{
name|fclose
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|Error
argument_list|,
literal|"being edited: `%s' (ge17)"
argument_list|,
name|line
argument_list|)
expr_stmt|;
name|fatal
argument_list|(
name|Error
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|equal
argument_list|(
name|pf
operator|.
name|pf_user
argument_list|,
name|user
argument_list|)
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"WARNING: being edited: `%s' (ge18)\n"
argument_list|,
name|line
argument_list|)
expr_stmt|;
block|}
name|out
operator|=
name|fdopen
argument_list|(
name|dup
argument_list|(
name|fd
argument_list|)
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
else|else
name|out
operator|=
name|xfcreat
argument_list|(
name|p
argument_list|,
literal|0666
argument_list|)
expr_stmt|;
name|fseek
argument_list|(
name|out
argument_list|,
literal|0L
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|sid_ba
argument_list|(
operator|&
name|pkt
operator|->
name|p_gotsid
argument_list|,
name|str1
argument_list|)
expr_stmt|;
name|sid_ba
argument_list|(
operator|&
name|pkt
operator|->
name|p_reqsid
argument_list|,
name|str2
argument_list|)
expr_stmt|;
name|date_ba
argument_list|(
operator|&
name|Timenow
argument_list|,
name|line
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"%s %s %s %s"
argument_list|,
name|str1
argument_list|,
name|str2
argument_list|,
name|user
argument_list|,
name|line
argument_list|)
expr_stmt|;
if|if
condition|(
name|inc
condition|)
name|fprintf
argument_list|(
name|out
argument_list|,
literal|" -i%s"
argument_list|,
name|inc
argument_list|)
expr_stmt|;
if|if
condition|(
name|exc
condition|)
name|fprintf
argument_list|(
name|out
argument_list|,
literal|" -x%s"
argument_list|,
name|exc
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|out
argument_list|)
expr_stmt|;
if|if
condition|(
name|pkt
operator|->
name|p_verbose
condition|)
name|fprintf
argument_list|(
name|pkt
operator|->
name|p_stdout
argument_list|,
literal|"new delta %s\n"
argument_list|,
name|str2
argument_list|)
expr_stmt|;
name|unlockit
argument_list|(
name|auxf
argument_list|(
name|pkt
operator|->
name|p_file
argument_list|,
literal|'z'
argument_list|)
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|getser
argument_list|(
name|pkt
argument_list|)
specifier|register
expr|struct
name|packet
operator|*
name|pkt
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|struct
name|idel
modifier|*
name|rdp
decl_stmt|;
name|int
name|n
decl_stmt|,
name|ser
decl_stmt|,
name|def
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|;
specifier|extern
name|char
modifier|*
name|Sflags
index|[]
decl_stmt|;
name|def
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|pkt
operator|->
name|p_reqsid
operator|.
name|s_rel
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|p
operator|=
name|Sflags
index|[
name|DEFTFLAG
operator|-
literal|'a'
index|]
condition|)
name|chksid
argument_list|(
name|sid_ab
argument_list|(
name|p
argument_list|,
operator|&
name|pkt
operator|->
name|p_reqsid
argument_list|)
argument_list|,
operator|&
name|pkt
operator|->
name|p_reqsid
argument_list|)
expr_stmt|;
else|else
block|{
name|pkt
operator|->
name|p_reqsid
operator|.
name|s_rel
operator|=
name|MAX
expr_stmt|;
name|def
operator|=
literal|1
expr_stmt|;
block|}
block|}
name|ser
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|pkt
operator|->
name|p_reqsid
operator|.
name|s_lev
operator|==
literal|0
condition|)
block|{
for|for
control|(
name|n
operator|=
name|maxser
argument_list|(
name|pkt
argument_list|)
init|;
name|n
condition|;
name|n
operator|--
control|)
block|{
name|rdp
operator|=
operator|&
name|pkt
operator|->
name|p_idel
index|[
name|n
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|rdp
operator|->
name|i_sid
operator|.
name|s_br
operator|==
literal|0
operator|||
name|HADT
operator|)
operator|&&
name|pkt
operator|->
name|p_reqsid
operator|.
name|s_rel
operator|>=
name|rdp
operator|->
name|i_sid
operator|.
name|s_rel
operator|&&
name|rdp
operator|->
name|i_sid
operator|.
name|s_rel
operator|>
name|pkt
operator|->
name|p_gotsid
operator|.
name|s_rel
condition|)
block|{
name|ser
operator|=
name|n
expr_stmt|;
name|pkt
operator|->
name|p_gotsid
operator|.
name|s_rel
operator|=
name|rdp
operator|->
name|i_sid
operator|.
name|s_rel
expr_stmt|;
block|}
block|}
block|}
elseif|else
if|if
condition|(
name|pkt
operator|->
name|p_reqsid
operator|.
name|s_br
operator|&&
name|pkt
operator|->
name|p_reqsid
operator|.
name|s_seq
operator|==
literal|0
condition|)
block|{
for|for
control|(
name|n
operator|=
name|maxser
argument_list|(
name|pkt
argument_list|)
init|;
name|n
condition|;
name|n
operator|--
control|)
block|{
name|rdp
operator|=
operator|&
name|pkt
operator|->
name|p_idel
index|[
name|n
index|]
expr_stmt|;
if|if
condition|(
name|rdp
operator|->
name|i_sid
operator|.
name|s_rel
operator|==
name|pkt
operator|->
name|p_reqsid
operator|.
name|s_rel
operator|&&
name|rdp
operator|->
name|i_sid
operator|.
name|s_lev
operator|==
name|pkt
operator|->
name|p_reqsid
operator|.
name|s_lev
operator|&&
name|rdp
operator|->
name|i_sid
operator|.
name|s_br
operator|==
name|pkt
operator|->
name|p_reqsid
operator|.
name|s_br
condition|)
break|break;
block|}
name|ser
operator|=
name|n
expr_stmt|;
block|}
else|else
block|{
name|ser
operator|=
name|sidtoser
argument_list|(
operator|&
name|pkt
operator|->
name|p_reqsid
argument_list|,
name|pkt
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ser
operator|==
literal|0
condition|)
name|fatal
argument_list|(
literal|"nonexistent sid (ge5)"
argument_list|)
expr_stmt|;
name|rdp
operator|=
operator|&
name|pkt
operator|->
name|p_idel
index|[
name|ser
index|]
expr_stmt|;
name|bcopy
argument_list|(
operator|&
name|rdp
operator|->
name|i_sid
argument_list|,
operator|&
name|pkt
operator|->
name|p_gotsid
argument_list|,
sizeof|sizeof
argument_list|(
name|pkt
operator|->
name|p_gotsid
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|def
operator|||
operator|(
name|pkt
operator|->
name|p_reqsid
operator|.
name|s_lev
operator|==
literal|0
operator|&&
name|pkt
operator|->
name|p_reqsid
operator|.
name|s_rel
operator|==
name|pkt
operator|->
name|p_gotsid
operator|.
name|s_rel
operator|)
condition|)
name|bcopy
argument_list|(
operator|&
name|pkt
operator|->
name|p_gotsid
argument_list|,
operator|&
name|pkt
operator|->
name|p_reqsid
argument_list|,
sizeof|sizeof
argument_list|(
name|pkt
operator|->
name|p_gotsid
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|ser
operator|)
return|;
block|}
end_block

begin_comment
comment|/* Null routine to satisfy external reference from dodelt() */
end_comment

begin_macro
name|escdodelt
argument_list|()
end_macro

begin_block
block|{ }
end_block

end_unit


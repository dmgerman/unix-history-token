begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  *    $Source: /mit/krb5/.cvsroot/src/appl/bsd/forward.c,v $  *    $Id: forward.c,v 1.4 1993/10/15 16:41:29 tytso Exp $  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|rcsid_forward_c
init|=
literal|"$Id: forward.c,v 1.4 1993/10/15 16:41:29 tytso Exp $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* lint */
end_comment

begin_define
define|#
directive|define
name|LIBC_SCCS
end_define

begin_comment
comment|/*-  * Copyright (c) 1993  *	The Regents of the University of California.  All rights reserved.  *  * %sccs.include.redist.c%  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|sccsid
index|[]
init|=
literal|"@(#)forward.c	8.2 (Berkeley) %G%"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* not lint */
end_comment

begin_comment
comment|/* General-purpose forwarding routines. These routines may be put into */
end_comment

begin_comment
comment|/* libkrb5.a to allow widespread use */
end_comment

begin_if
if|#
directive|if
name|defined
argument_list|(
name|KRB5
argument_list|)
operator|&&
name|defined
argument_list|(
name|FORWARD
argument_list|)
end_if

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<pwd.h>
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_include
include|#
directive|include
file|<krb5/krb5.h>
end_include

begin_include
include|#
directive|include
file|<krb5/asn1.h>
end_include

begin_include
include|#
directive|include
file|<krb5/crc-32.h>
end_include

begin_include
include|#
directive|include
file|<krb5/los-proto.h>
end_include

begin_include
include|#
directive|include
file|<krb5/ext-proto.h>
end_include

begin_define
define|#
directive|define
name|KRB5_DEFAULT_LIFE
value|60*60*8
end_define

begin_comment
comment|/* 8 hours */
end_comment

begin_comment
comment|/* helper function: convert flags to necessary KDC options */
end_comment

begin_define
define|#
directive|define
name|flags2options
parameter_list|(
name|flags
parameter_list|)
value|(flags& KDC_TKT_COMMON_MASK)
end_define

begin_comment
comment|/* Get a TGT for use at the remote host */
end_comment

begin_function
name|krb5_error_code
name|get_for_creds
parameter_list|(
name|etype
parameter_list|,
name|sumtype
parameter_list|,
name|rhost
parameter_list|,
name|client
parameter_list|,
name|enc_key
parameter_list|,
name|forwardable
parameter_list|,
name|outbuf
parameter_list|)
specifier|const
name|krb5_enctype
name|etype
decl_stmt|;
specifier|const
name|krb5_cksumtype
name|sumtype
decl_stmt|;
name|char
modifier|*
name|rhost
decl_stmt|;
name|krb5_principal
name|client
decl_stmt|;
name|krb5_keyblock
modifier|*
name|enc_key
decl_stmt|;
name|int
name|forwardable
decl_stmt|;
comment|/* Should forwarded TGT also be forwardable? */
name|krb5_data
modifier|*
name|outbuf
decl_stmt|;
block|{
name|struct
name|hostent
modifier|*
name|hp
decl_stmt|;
name|krb5_address
modifier|*
modifier|*
name|addrs
decl_stmt|;
name|krb5_error_code
name|retval
decl_stmt|;
name|krb5_data
modifier|*
name|scratch
decl_stmt|;
name|krb5_kdc_rep
modifier|*
name|dec_rep
decl_stmt|;
name|krb5_error
modifier|*
name|err_reply
decl_stmt|;
name|krb5_response
name|tgsrep
decl_stmt|;
name|krb5_creds
name|creds
decl_stmt|,
name|tgt
decl_stmt|;
name|krb5_ccache
name|cc
decl_stmt|;
name|krb5_flags
name|kdcoptions
decl_stmt|;
name|krb5_timestamp
name|now
decl_stmt|;
name|char
modifier|*
name|remote_host
decl_stmt|;
name|char
modifier|*
modifier|*
name|hrealms
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|rhost
operator|||
operator|!
operator|(
name|hp
operator|=
name|gethostbyname
argument_list|(
name|rhost
argument_list|)
operator|)
condition|)
return|return
name|KRB5_ERR_BAD_HOSTNAME
return|;
name|remote_host
operator|=
operator|(
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|strlen
argument_list|(
name|hp
operator|->
name|h_name
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|remote_host
condition|)
return|return
name|ENOMEM
return|;
name|strcpy
argument_list|(
name|remote_host
argument_list|,
name|hp
operator|->
name|h_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
operator|=
name|krb5_get_host_realm
argument_list|(
name|remote_host
argument_list|,
operator|&
name|hrealms
argument_list|)
condition|)
block|{
name|free
argument_list|(
name|remote_host
argument_list|)
expr_stmt|;
return|return
name|retval
return|;
block|}
if|if
condition|(
operator|!
name|hrealms
index|[
literal|0
index|]
condition|)
block|{
name|free
argument_list|(
name|remote_host
argument_list|)
expr_stmt|;
name|krb5_xfree
argument_list|(
name|hrealms
argument_list|)
expr_stmt|;
return|return
name|KRB5_ERR_HOST_REALM_UNKNOWN
return|;
block|}
comment|/* Count elements */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|hp
operator|->
name|h_addr_list
index|[
name|i
index|]
condition|;
name|i
operator|++
control|)
empty_stmt|;
name|addrs
operator|=
operator|(
name|krb5_address
operator|*
operator|*
operator|)
name|malloc
argument_list|(
operator|(
name|i
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|addrs
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|addrs
condition|)
return|return
name|ENOMEM
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|hp
operator|->
name|h_addr_list
index|[
name|i
index|]
condition|;
name|i
operator|++
control|)
block|{
name|addrs
index|[
name|i
index|]
operator|=
operator|(
name|krb5_address
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|krb5_address
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|addrs
index|[
name|i
index|]
condition|)
block|{
name|addrs
index|[
name|i
index|]
operator|->
name|addrtype
operator|=
name|hp
operator|->
name|h_addrtype
expr_stmt|;
name|addrs
index|[
name|i
index|]
operator|->
name|length
operator|=
name|hp
operator|->
name|h_length
expr_stmt|;
name|addrs
index|[
name|i
index|]
operator|->
name|contents
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|addrs
index|[
name|i
index|]
operator|->
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|addrs
index|[
name|i
index|]
operator|->
name|contents
condition|)
block|{
name|krb5_free_addresses
argument_list|(
name|addrs
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
else|else
name|memmove
argument_list|(
operator|(
name|char
operator|*
operator|)
name|addrs
index|[
name|i
index|]
operator|->
name|contents
argument_list|,
name|hp
operator|->
name|h_addr_list
index|[
name|i
index|]
argument_list|,
name|addrs
index|[
name|i
index|]
operator|->
name|length
argument_list|)
expr_stmt|;
block|}
else|else
block|{
return|return
name|ENOMEM
return|;
block|}
block|}
name|addrs
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|memset
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|creds
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|creds
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
operator|=
name|krb5_copy_principal
argument_list|(
name|client
argument_list|,
operator|&
name|creds
operator|.
name|client
argument_list|)
condition|)
return|return
name|retval
return|;
if|if
condition|(
name|retval
operator|=
name|krb5_build_principal_ext
argument_list|(
operator|&
name|creds
operator|.
name|server
argument_list|,
name|strlen
argument_list|(
name|hrealms
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|hrealms
index|[
literal|0
index|]
argument_list|,
name|KRB5_TGS_NAME_SIZE
argument_list|,
name|KRB5_TGS_NAME
argument_list|,
name|client
operator|->
name|realm
operator|.
name|length
argument_list|,
name|client
operator|->
name|realm
operator|.
name|data
argument_list|,
literal|0
argument_list|)
condition|)
return|return
name|retval
return|;
name|creds
operator|.
name|times
operator|.
name|starttime
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|retval
operator|=
name|krb5_timeofday
argument_list|(
operator|&
name|now
argument_list|)
condition|)
block|{
return|return
name|retval
return|;
block|}
name|creds
operator|.
name|times
operator|.
name|endtime
operator|=
name|now
operator|+
name|KRB5_DEFAULT_LIFE
expr_stmt|;
name|creds
operator|.
name|times
operator|.
name|renew_till
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|retval
operator|=
name|krb5_cc_default
argument_list|(
operator|&
name|cc
argument_list|)
condition|)
block|{
return|return
name|retval
return|;
block|}
comment|/* fetch tgt directly from cache */
if|if
condition|(
name|retval
operator|=
name|krb5_cc_retrieve_cred
argument_list|(
name|cc
argument_list|,
name|KRB5_TC_MATCH_SRV_NAMEONLY
argument_list|,
operator|&
name|creds
argument_list|,
operator|&
name|tgt
argument_list|)
condition|)
block|{
return|return
name|retval
return|;
block|}
comment|/* tgt->client must be equal to creds.client */
if|if
condition|(
operator|!
name|krb5_principal_compare
argument_list|(
name|tgt
operator|.
name|client
argument_list|,
name|creds
operator|.
name|client
argument_list|)
condition|)
return|return
name|KRB5_PRINC_NOMATCH
return|;
if|if
condition|(
operator|!
name|tgt
operator|.
name|ticket
operator|.
name|length
condition|)
return|return
operator|(
name|KRB5_NO_TKT_SUPPLIED
operator|)
return|;
name|kdcoptions
operator|=
name|flags2options
argument_list|(
name|tgt
operator|.
name|ticket_flags
argument_list|)
operator||
name|KDC_OPT_FORWARDED
expr_stmt|;
if|if
condition|(
operator|!
name|forwardable
condition|)
comment|/* Reset KDC_OPT_FORWARDABLE */
name|kdcoptions
operator|&=
operator|~
operator|(
name|KDC_OPT_FORWARDABLE
operator|)
expr_stmt|;
if|if
condition|(
name|retval
operator|=
name|krb5_send_tgs
argument_list|(
name|kdcoptions
argument_list|,
operator|&
name|creds
operator|.
name|times
argument_list|,
name|etype
argument_list|,
name|sumtype
argument_list|,
name|creds
operator|.
name|server
argument_list|,
name|addrs
argument_list|,
name|creds
operator|.
name|authdata
argument_list|,
literal|0
argument_list|,
comment|/* no padata */
literal|0
argument_list|,
comment|/* no second ticket */
operator|&
name|tgt
argument_list|,
operator|&
name|tgsrep
argument_list|)
condition|)
return|return
name|retval
return|;
undef|#
directive|undef
name|cleanup
define|#
directive|define
name|cleanup
parameter_list|()
value|free(tgsrep.response.data)
switch|switch
condition|(
name|tgsrep
operator|.
name|message_type
condition|)
block|{
case|case
name|KRB5_TGS_REP
case|:
break|break;
case|case
name|KRB5_ERROR
case|:
default|default:
if|if
condition|(
operator|!
name|krb5_is_krb_error
argument_list|(
operator|&
name|tgsrep
operator|.
name|response
argument_list|)
condition|)
block|{
name|retval
operator|=
name|KRB5KRB_AP_ERR_MSG_TYPE
expr_stmt|;
block|}
else|else
name|retval
operator|=
name|decode_krb5_error
argument_list|(
operator|&
name|tgsrep
operator|.
name|response
argument_list|,
operator|&
name|err_reply
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
condition|)
block|{
name|cleanup
argument_list|()
expr_stmt|;
return|return
name|retval
return|;
comment|/* neither proper reply nor error! */
block|}
name|retval
operator|=
name|err_reply
operator|->
name|error
operator|+
name|ERROR_TABLE_BASE_krb5
expr_stmt|;
name|krb5_free_error
argument_list|(
name|err_reply
argument_list|)
expr_stmt|;
name|cleanup
argument_list|()
expr_stmt|;
return|return
name|retval
return|;
block|}
name|retval
operator|=
name|krb5_decode_kdc_rep
argument_list|(
operator|&
name|tgsrep
operator|.
name|response
argument_list|,
operator|&
name|tgt
operator|.
name|keyblock
argument_list|,
name|etype
argument_list|,
comment|/* enctype */
operator|&
name|dec_rep
argument_list|)
expr_stmt|;
name|cleanup
argument_list|()
expr_stmt|;
if|if
condition|(
name|retval
condition|)
return|return
name|retval
return|;
undef|#
directive|undef
name|cleanup
define|#
directive|define
name|cleanup
parameter_list|()
value|{\ 	memset((char *)dec_rep->enc_part2->session->contents, 0,\ 	      dec_rep->enc_part2->session->length);\ 		  krb5_free_kdc_rep(dec_rep); }
if|if
condition|(
name|dec_rep
operator|->
name|msg_type
operator|!=
name|KRB5_TGS_REP
condition|)
block|{
name|retval
operator|=
name|KRB5KRB_AP_ERR_MSG_TYPE
expr_stmt|;
name|cleanup
argument_list|()
expr_stmt|;
return|return
name|retval
return|;
block|}
comment|/* now it's decrypted and ready for prime time */
if|if
condition|(
operator|!
name|krb5_principal_compare
argument_list|(
name|dec_rep
operator|->
name|client
argument_list|,
name|tgt
operator|.
name|client
argument_list|)
condition|)
block|{
name|cleanup
argument_list|()
expr_stmt|;
return|return
name|KRB5_KDCREP_MODIFIED
return|;
block|}
if|if
condition|(
name|retval
operator|=
name|mk_cred
argument_list|(
name|dec_rep
argument_list|,
name|etype
argument_list|,
name|enc_key
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|outbuf
argument_list|)
condition|)
return|return
name|retval
return|;
name|krb5_free_kdc_rep
argument_list|(
name|dec_rep
argument_list|)
expr_stmt|;
return|return
name|retval
return|;
undef|#
directive|undef
name|cleanup
block|}
end_function

begin_comment
comment|/* Create asn.1 encoded KRB-CRED message from the kdc reply. */
end_comment

begin_function
name|krb5_error_code
name|mk_cred
parameter_list|(
name|dec_rep
parameter_list|,
name|etype
parameter_list|,
name|key
parameter_list|,
name|sender_addr
parameter_list|,
name|recv_addr
parameter_list|,
name|outbuf
parameter_list|)
name|krb5_kdc_rep
modifier|*
name|dec_rep
decl_stmt|;
name|krb5_enctype
name|etype
decl_stmt|;
name|krb5_keyblock
modifier|*
name|key
decl_stmt|;
name|krb5_address
modifier|*
name|sender_addr
decl_stmt|;
name|krb5_address
modifier|*
name|recv_addr
decl_stmt|;
name|krb5_data
modifier|*
name|outbuf
decl_stmt|;
block|{
name|krb5_error_code
name|retval
decl_stmt|;
name|krb5_encrypt_block
name|eblock
decl_stmt|;
name|krb5_cred
name|ret_cred
decl_stmt|;
name|krb5_cred_enc_part
name|cred_enc_part
decl_stmt|;
name|krb5_data
modifier|*
name|scratch
decl_stmt|;
if|if
condition|(
operator|!
name|valid_etype
argument_list|(
name|etype
argument_list|)
condition|)
return|return
name|KRB5_PROG_ETYPE_NOSUPP
return|;
name|ret_cred
operator|.
name|tickets
operator|=
operator|(
name|krb5_ticket
operator|*
operator|*
operator|)
name|calloc
argument_list|(
literal|2
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ret_cred
operator|.
name|tickets
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret_cred
operator|.
name|tickets
condition|)
return|return
name|ENOMEM
return|;
name|ret_cred
operator|.
name|tickets
index|[
literal|0
index|]
operator|=
name|dec_rep
operator|->
name|ticket
expr_stmt|;
name|ret_cred
operator|.
name|tickets
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|ret_cred
operator|.
name|enc_part
operator|.
name|etype
operator|=
name|etype
expr_stmt|;
name|ret_cred
operator|.
name|enc_part
operator|.
name|kvno
operator|=
literal|0
expr_stmt|;
name|cred_enc_part
operator|.
name|ticket_info
operator|=
operator|(
name|krb5_cred_info
operator|*
operator|*
operator|)
name|calloc
argument_list|(
literal|2
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|cred_enc_part
operator|.
name|ticket_info
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cred_enc_part
operator|.
name|ticket_info
condition|)
block|{
name|krb5_free_tickets
argument_list|(
name|ret_cred
operator|.
name|tickets
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|cred_enc_part
operator|.
name|ticket_info
index|[
literal|0
index|]
operator|=
operator|(
name|krb5_cred_info
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|cred_enc_part
operator|.
name|ticket_info
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cred_enc_part
operator|.
name|ticket_info
index|[
literal|0
index|]
condition|)
block|{
name|krb5_free_tickets
argument_list|(
name|ret_cred
operator|.
name|tickets
argument_list|)
expr_stmt|;
name|krb5_free_cred_enc_part
argument_list|(
name|cred_enc_part
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|cred_enc_part
operator|.
name|nonce
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|retval
operator|=
name|krb5_us_timeofday
argument_list|(
operator|&
name|cred_enc_part
operator|.
name|timestamp
argument_list|,
operator|&
name|cred_enc_part
operator|.
name|usec
argument_list|)
condition|)
return|return
name|retval
return|;
name|cred_enc_part
operator|.
name|s_address
operator|=
operator|(
name|krb5_address
operator|*
operator|)
name|sender_addr
expr_stmt|;
name|cred_enc_part
operator|.
name|r_address
operator|=
operator|(
name|krb5_address
operator|*
operator|)
name|recv_addr
expr_stmt|;
name|cred_enc_part
operator|.
name|ticket_info
index|[
literal|0
index|]
operator|->
name|session
operator|=
name|dec_rep
operator|->
name|enc_part2
operator|->
name|session
expr_stmt|;
name|cred_enc_part
operator|.
name|ticket_info
index|[
literal|0
index|]
operator|->
name|client
operator|=
name|dec_rep
operator|->
name|client
expr_stmt|;
name|cred_enc_part
operator|.
name|ticket_info
index|[
literal|0
index|]
operator|->
name|server
operator|=
name|dec_rep
operator|->
name|enc_part2
operator|->
name|server
expr_stmt|;
name|cred_enc_part
operator|.
name|ticket_info
index|[
literal|0
index|]
operator|->
name|flags
operator|=
name|dec_rep
operator|->
name|enc_part2
operator|->
name|flags
expr_stmt|;
name|cred_enc_part
operator|.
name|ticket_info
index|[
literal|0
index|]
operator|->
name|times
operator|=
name|dec_rep
operator|->
name|enc_part2
operator|->
name|times
expr_stmt|;
name|cred_enc_part
operator|.
name|ticket_info
index|[
literal|0
index|]
operator|->
name|caddrs
operator|=
name|dec_rep
operator|->
name|enc_part2
operator|->
name|caddrs
expr_stmt|;
name|cred_enc_part
operator|.
name|ticket_info
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
comment|/* start by encoding to-be-encrypted part of the message */
if|if
condition|(
name|retval
operator|=
name|encode_krb5_enc_cred_part
argument_list|(
operator|&
name|cred_enc_part
argument_list|,
operator|&
name|scratch
argument_list|)
condition|)
return|return
name|retval
return|;
define|#
directive|define
name|cleanup_scratch
parameter_list|()
value|{ (void) memset(scratch->data, 0, scratch->length); krb5_free_data(scratch); }
comment|/* put together an eblock for this encryption */
name|krb5_use_cstype
argument_list|(
operator|&
name|eblock
argument_list|,
name|etype
argument_list|)
expr_stmt|;
name|ret_cred
operator|.
name|enc_part
operator|.
name|ciphertext
operator|.
name|length
operator|=
name|krb5_encrypt_size
argument_list|(
name|scratch
operator|->
name|length
argument_list|,
name|eblock
operator|.
name|crypto_entry
argument_list|)
expr_stmt|;
comment|/* add padding area, and zero it */
if|if
condition|(
operator|!
operator|(
name|scratch
operator|->
name|data
operator|=
name|realloc
argument_list|(
name|scratch
operator|->
name|data
argument_list|,
name|ret_cred
operator|.
name|enc_part
operator|.
name|ciphertext
operator|.
name|length
argument_list|)
operator|)
condition|)
block|{
comment|/* may destroy scratch->data */
name|krb5_xfree
argument_list|(
name|scratch
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|memset
argument_list|(
name|scratch
operator|->
name|data
operator|+
name|scratch
operator|->
name|length
argument_list|,
literal|0
argument_list|,
name|ret_cred
operator|.
name|enc_part
operator|.
name|ciphertext
operator|.
name|length
operator|-
name|scratch
operator|->
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ret_cred
operator|.
name|enc_part
operator|.
name|ciphertext
operator|.
name|data
operator|=
name|malloc
argument_list|(
name|ret_cred
operator|.
name|enc_part
operator|.
name|ciphertext
operator|.
name|length
argument_list|)
operator|)
condition|)
block|{
name|retval
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|clean_scratch
goto|;
block|}
define|#
directive|define
name|cleanup_encpart
parameter_list|()
value|{\ 	(void) memset(ret_cred.enc_part.ciphertext.data, 0, \ 	     ret_cred.enc_part.ciphertext.length); \ 	free(ret_cred.enc_part.ciphertext.data); \ 	ret_cred.enc_part.ciphertext.length = 0; \ 	ret_cred.enc_part.ciphertext.data = 0;}
comment|/* do any necessary key pre-processing */
if|if
condition|(
name|retval
operator|=
name|krb5_process_key
argument_list|(
operator|&
name|eblock
argument_list|,
name|key
argument_list|)
condition|)
block|{
goto|goto
name|clean_encpart
goto|;
block|}
define|#
directive|define
name|cleanup_prockey
parameter_list|()
value|{(void) krb5_finish_key(&eblock);}
comment|/* call the encryption routine */
if|if
condition|(
name|retval
operator|=
name|krb5_encrypt
argument_list|(
operator|(
name|krb5_pointer
operator|)
name|scratch
operator|->
name|data
argument_list|,
operator|(
name|krb5_pointer
operator|)
name|ret_cred
operator|.
name|enc_part
operator|.
name|ciphertext
operator|.
name|data
argument_list|,
name|scratch
operator|->
name|length
argument_list|,
operator|&
name|eblock
argument_list|,
literal|0
argument_list|)
condition|)
block|{
goto|goto
name|clean_prockey
goto|;
block|}
comment|/* private message is now assembled-- do some cleanup */
name|cleanup_scratch
argument_list|()
expr_stmt|;
if|if
condition|(
name|retval
operator|=
name|krb5_finish_key
argument_list|(
operator|&
name|eblock
argument_list|)
condition|)
block|{
name|cleanup_encpart
argument_list|()
expr_stmt|;
return|return
name|retval
return|;
block|}
comment|/* encode private message */
if|if
condition|(
name|retval
operator|=
name|encode_krb5_cred
argument_list|(
operator|&
name|ret_cred
argument_list|,
operator|&
name|scratch
argument_list|)
condition|)
block|{
name|cleanup_encpart
argument_list|()
expr_stmt|;
return|return
name|retval
return|;
block|}
name|cleanup_encpart
argument_list|()
expr_stmt|;
operator|*
name|outbuf
operator|=
operator|*
name|scratch
expr_stmt|;
name|krb5_xfree
argument_list|(
name|scratch
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|clean_prockey
label|:
name|cleanup_prockey
argument_list|()
expr_stmt|;
name|clean_encpart
label|:
name|cleanup_encpart
argument_list|()
expr_stmt|;
name|clean_scratch
label|:
name|cleanup_scratch
argument_list|()
expr_stmt|;
return|return
name|retval
return|;
undef|#
directive|undef
name|cleanup_prockey
undef|#
directive|undef
name|cleanup_encpart
undef|#
directive|undef
name|cleanup_scratch
block|}
end_function

begin_comment
comment|/* Decode, decrypt and store the forwarded creds in the local ccache. */
end_comment

begin_function
name|krb5_error_code
name|rd_and_store_for_creds
parameter_list|(
name|inbuf
parameter_list|,
name|ticket
parameter_list|,
name|lusername
parameter_list|)
name|krb5_data
modifier|*
name|inbuf
decl_stmt|;
name|krb5_ticket
modifier|*
name|ticket
decl_stmt|;
name|char
modifier|*
name|lusername
decl_stmt|;
block|{
name|krb5_encrypt_block
name|eblock
decl_stmt|;
name|krb5_creds
name|creds
decl_stmt|;
name|krb5_error_code
name|retval
decl_stmt|;
name|char
name|ccname
index|[
literal|35
index|]
decl_stmt|;
name|krb5_ccache
name|ccache
init|=
name|NULL
decl_stmt|;
name|struct
name|passwd
modifier|*
name|pwd
decl_stmt|;
if|if
condition|(
name|retval
operator|=
name|rd_cred
argument_list|(
name|inbuf
argument_list|,
name|ticket
operator|->
name|enc_part2
operator|->
name|session
argument_list|,
operator|&
name|creds
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
condition|)
block|{
return|return
operator|(
name|retval
operator|)
return|;
block|}
if|if
condition|(
operator|!
operator|(
name|pwd
operator|=
operator|(
expr|struct
name|passwd
operator|*
operator|)
name|getpwnam
argument_list|(
name|lusername
argument_list|)
operator|)
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
name|sprintf
argument_list|(
name|ccname
argument_list|,
literal|"FILE:/tmp/krb5cc_%d"
argument_list|,
name|pwd
operator|->
name|pw_uid
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
operator|=
name|krb5_cc_resolve
argument_list|(
name|ccname
argument_list|,
operator|&
name|ccache
argument_list|)
condition|)
block|{
return|return
operator|(
name|retval
operator|)
return|;
block|}
if|if
condition|(
name|retval
operator|=
name|krb5_cc_initialize
argument_list|(
name|ccache
argument_list|,
name|ticket
operator|->
name|enc_part2
operator|->
name|client
argument_list|)
condition|)
block|{
return|return
operator|(
name|retval
operator|)
return|;
block|}
if|if
condition|(
name|retval
operator|=
name|krb5_cc_store_cred
argument_list|(
name|ccache
argument_list|,
operator|&
name|creds
argument_list|)
condition|)
block|{
return|return
operator|(
name|retval
operator|)
return|;
block|}
if|if
condition|(
name|retval
operator|=
name|chown
argument_list|(
name|ccname
operator|+
literal|5
argument_list|,
name|pwd
operator|->
name|pw_uid
argument_list|,
operator|-
literal|1
argument_list|)
condition|)
block|{
return|return
operator|(
name|retval
operator|)
return|;
block|}
return|return
name|retval
return|;
block|}
end_function

begin_decl_stmt
specifier|extern
name|krb5_deltat
name|krb5_clockskew
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|in_clock_skew
parameter_list|(
name|date
parameter_list|)
value|(abs((date)-currenttime)< krb5_clockskew)
end_define

begin_comment
comment|/* Decode the KRB-CRED message, and return creds */
end_comment

begin_function
name|krb5_error_code
name|rd_cred
parameter_list|(
name|inbuf
parameter_list|,
name|key
parameter_list|,
name|creds
parameter_list|,
name|sender_addr
parameter_list|,
name|recv_addr
parameter_list|)
specifier|const
name|krb5_data
modifier|*
name|inbuf
decl_stmt|;
specifier|const
name|krb5_keyblock
modifier|*
name|key
decl_stmt|;
name|krb5_creds
modifier|*
name|creds
decl_stmt|;
comment|/* Filled in */
specifier|const
name|krb5_address
modifier|*
name|sender_addr
decl_stmt|;
comment|/* optional */
specifier|const
name|krb5_address
modifier|*
name|recv_addr
decl_stmt|;
comment|/* optional */
block|{
name|krb5_error_code
name|retval
decl_stmt|;
name|krb5_encrypt_block
name|eblock
decl_stmt|;
name|krb5_cred
modifier|*
name|credmsg
decl_stmt|;
name|krb5_cred_enc_part
modifier|*
name|credmsg_enc_part
decl_stmt|;
name|krb5_data
modifier|*
name|scratch
decl_stmt|;
name|krb5_timestamp
name|currenttime
decl_stmt|;
if|if
condition|(
operator|!
name|krb5_is_krb_cred
argument_list|(
name|inbuf
argument_list|)
condition|)
return|return
name|KRB5KRB_AP_ERR_MSG_TYPE
return|;
comment|/* decode private message */
if|if
condition|(
name|retval
operator|=
name|decode_krb5_cred
argument_list|(
name|inbuf
argument_list|,
operator|&
name|credmsg
argument_list|)
condition|)
block|{
return|return
name|retval
return|;
block|}
define|#
directive|define
name|cleanup_credmsg
parameter_list|()
value|{(void)krb5_xfree(credmsg->enc_part.ciphertext.data); (void)krb5_xfree(credmsg);}
if|if
condition|(
operator|!
operator|(
name|scratch
operator|=
operator|(
name|krb5_data
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|scratch
argument_list|)
argument_list|)
operator|)
condition|)
block|{
name|cleanup_credmsg
argument_list|()
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
define|#
directive|define
name|cleanup_scratch
parameter_list|()
value|{(void)memset(scratch->data, 0, scratch->length); (void)krb5_xfree(scratch->data);}
if|if
condition|(
name|retval
operator|=
name|encode_krb5_ticket
argument_list|(
name|credmsg
operator|->
name|tickets
index|[
literal|0
index|]
argument_list|,
operator|&
name|scratch
argument_list|)
condition|)
block|{
name|cleanup_credmsg
argument_list|()
expr_stmt|;
name|cleanup_scratch
argument_list|()
expr_stmt|;
return|return
operator|(
name|retval
operator|)
return|;
block|}
name|creds
operator|->
name|ticket
operator|=
operator|*
name|scratch
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|creds
operator|->
name|ticket
operator|.
name|data
operator|=
name|malloc
argument_list|(
name|scratch
operator|->
name|length
argument_list|)
operator|)
condition|)
block|{
name|krb5_xfree
argument_list|(
name|creds
operator|->
name|ticket
operator|.
name|data
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|memmove
argument_list|(
operator|(
name|char
operator|*
operator|)
name|creds
operator|->
name|ticket
operator|.
name|data
argument_list|,
operator|(
name|char
operator|*
operator|)
name|scratch
operator|->
name|data
argument_list|,
name|scratch
operator|->
name|length
argument_list|)
expr_stmt|;
name|cleanup_scratch
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|valid_etype
argument_list|(
name|credmsg
operator|->
name|enc_part
operator|.
name|etype
argument_list|)
condition|)
block|{
name|cleanup_credmsg
argument_list|()
expr_stmt|;
return|return
name|KRB5_PROG_ETYPE_NOSUPP
return|;
block|}
comment|/* put together an eblock for this decryption */
name|krb5_use_cstype
argument_list|(
operator|&
name|eblock
argument_list|,
name|credmsg
operator|->
name|enc_part
operator|.
name|etype
argument_list|)
expr_stmt|;
name|scratch
operator|->
name|length
operator|=
name|credmsg
operator|->
name|enc_part
operator|.
name|ciphertext
operator|.
name|length
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|scratch
operator|->
name|data
operator|=
name|malloc
argument_list|(
name|scratch
operator|->
name|length
argument_list|)
operator|)
condition|)
block|{
name|cleanup_credmsg
argument_list|()
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
comment|/* do any necessary key pre-processing */
if|if
condition|(
name|retval
operator|=
name|krb5_process_key
argument_list|(
operator|&
name|eblock
argument_list|,
name|key
argument_list|)
condition|)
block|{
name|cleanup_credmsg
argument_list|()
expr_stmt|;
name|cleanup_scratch
argument_list|()
expr_stmt|;
return|return
name|retval
return|;
block|}
define|#
directive|define
name|cleanup_prockey
parameter_list|()
value|{(void) krb5_finish_key(&eblock);}
comment|/* call the decryption routine */
if|if
condition|(
name|retval
operator|=
name|krb5_decrypt
argument_list|(
operator|(
name|krb5_pointer
operator|)
name|credmsg
operator|->
name|enc_part
operator|.
name|ciphertext
operator|.
name|data
argument_list|,
operator|(
name|krb5_pointer
operator|)
name|scratch
operator|->
name|data
argument_list|,
name|scratch
operator|->
name|length
argument_list|,
operator|&
name|eblock
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|cleanup_credmsg
argument_list|()
expr_stmt|;
name|cleanup_scratch
argument_list|()
expr_stmt|;
name|cleanup_prockey
argument_list|()
expr_stmt|;
return|return
name|retval
return|;
block|}
comment|/* cred message is now decrypted -- do some cleanup */
name|cleanup_credmsg
argument_list|()
expr_stmt|;
if|if
condition|(
name|retval
operator|=
name|krb5_finish_key
argument_list|(
operator|&
name|eblock
argument_list|)
condition|)
block|{
name|cleanup_scratch
argument_list|()
expr_stmt|;
return|return
name|retval
return|;
block|}
comment|/*  now decode the decrypted stuff */
if|if
condition|(
name|retval
operator|=
name|decode_krb5_enc_cred_part
argument_list|(
name|scratch
argument_list|,
operator|&
name|credmsg_enc_part
argument_list|)
condition|)
block|{
name|cleanup_scratch
argument_list|()
expr_stmt|;
return|return
name|retval
return|;
block|}
name|cleanup_scratch
argument_list|()
expr_stmt|;
define|#
directive|define
name|cleanup_mesg
parameter_list|()
value|{(void)krb5_xfree(credmsg_enc_part);}
if|if
condition|(
name|retval
operator|=
name|krb5_timeofday
argument_list|(
operator|&
name|currenttime
argument_list|)
condition|)
block|{
name|cleanup_mesg
argument_list|()
expr_stmt|;
return|return
name|retval
return|;
block|}
if|if
condition|(
operator|!
name|in_clock_skew
argument_list|(
name|credmsg_enc_part
operator|->
name|timestamp
argument_list|)
condition|)
block|{
name|cleanup_mesg
argument_list|()
expr_stmt|;
return|return
name|KRB5KRB_AP_ERR_SKEW
return|;
block|}
if|if
condition|(
name|sender_addr
operator|&&
name|credmsg_enc_part
operator|->
name|s_address
operator|&&
operator|!
name|krb5_address_compare
argument_list|(
name|sender_addr
argument_list|,
name|credmsg_enc_part
operator|->
name|s_address
argument_list|)
condition|)
block|{
name|cleanup_mesg
argument_list|()
expr_stmt|;
return|return
name|KRB5KRB_AP_ERR_BADADDR
return|;
block|}
if|if
condition|(
name|recv_addr
operator|&&
name|credmsg_enc_part
operator|->
name|r_address
operator|&&
operator|!
name|krb5_address_compare
argument_list|(
name|recv_addr
argument_list|,
name|credmsg_enc_part
operator|->
name|r_address
argument_list|)
condition|)
block|{
name|cleanup_mesg
argument_list|()
expr_stmt|;
return|return
name|KRB5KRB_AP_ERR_BADADDR
return|;
block|}
if|if
condition|(
name|credmsg_enc_part
operator|->
name|r_address
condition|)
block|{
name|krb5_address
modifier|*
modifier|*
name|our_addrs
decl_stmt|;
if|if
condition|(
name|retval
operator|=
name|krb5_os_localaddr
argument_list|(
operator|&
name|our_addrs
argument_list|)
condition|)
block|{
name|cleanup_mesg
argument_list|()
expr_stmt|;
return|return
name|retval
return|;
block|}
if|if
condition|(
operator|!
name|krb5_address_search
argument_list|(
name|credmsg_enc_part
operator|->
name|r_address
argument_list|,
name|our_addrs
argument_list|)
condition|)
block|{
name|krb5_free_addresses
argument_list|(
name|our_addrs
argument_list|)
expr_stmt|;
name|cleanup_mesg
argument_list|()
expr_stmt|;
return|return
name|KRB5KRB_AP_ERR_BADADDR
return|;
block|}
name|krb5_free_addresses
argument_list|(
name|our_addrs
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|retval
operator|=
name|krb5_copy_principal
argument_list|(
name|credmsg_enc_part
operator|->
name|ticket_info
index|[
literal|0
index|]
operator|->
name|client
argument_list|,
operator|&
name|creds
operator|->
name|client
argument_list|)
condition|)
block|{
return|return
operator|(
name|retval
operator|)
return|;
block|}
if|if
condition|(
name|retval
operator|=
name|krb5_copy_principal
argument_list|(
name|credmsg_enc_part
operator|->
name|ticket_info
index|[
literal|0
index|]
operator|->
name|server
argument_list|,
operator|&
name|creds
operator|->
name|server
argument_list|)
condition|)
block|{
return|return
operator|(
name|retval
operator|)
return|;
block|}
if|if
condition|(
name|retval
operator|=
name|krb5_copy_keyblock_contents
argument_list|(
name|credmsg_enc_part
operator|->
name|ticket_info
index|[
literal|0
index|]
operator|->
name|session
argument_list|,
operator|&
name|creds
operator|->
name|keyblock
argument_list|)
condition|)
block|{
return|return
operator|(
name|retval
operator|)
return|;
block|}
undef|#
directive|undef
name|clean
define|#
directive|define
name|clean
parameter_list|()
value|{\ 	memset((char *)creds->keyblock.contents, 0, creds->keyblock.length);}
name|creds
operator|->
name|times
operator|=
name|credmsg_enc_part
operator|->
name|ticket_info
index|[
literal|0
index|]
operator|->
name|times
expr_stmt|;
name|creds
operator|->
name|is_skey
operator|=
name|FALSE
expr_stmt|;
name|creds
operator|->
name|ticket_flags
operator|=
name|credmsg_enc_part
operator|->
name|ticket_info
index|[
literal|0
index|]
operator|->
name|flags
expr_stmt|;
if|if
condition|(
name|retval
operator|=
name|krb5_copy_addresses
argument_list|(
name|credmsg_enc_part
operator|->
name|ticket_info
index|[
literal|0
index|]
operator|->
name|caddrs
argument_list|,
operator|&
name|creds
operator|->
name|addresses
argument_list|)
condition|)
block|{
name|clean
argument_list|()
expr_stmt|;
return|return
operator|(
name|retval
operator|)
return|;
block|}
name|creds
operator|->
name|second_ticket
operator|.
name|length
operator|=
literal|0
expr_stmt|;
name|creds
operator|->
name|authdata
operator|=
literal|0
expr_stmt|;
name|cleanup_mesg
argument_list|()
expr_stmt|;
return|return
literal|0
return|;
undef|#
directive|undef
name|clean
undef|#
directive|undef
name|cleanup_credmsg
undef|#
directive|undef
name|cleanup_scratch
undef|#
directive|undef
name|cleanup_prockey
undef|#
directive|undef
name|cleanup_mesg
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* defined(KRB5)&& defined(FORWARD) */
end_comment

end_unit


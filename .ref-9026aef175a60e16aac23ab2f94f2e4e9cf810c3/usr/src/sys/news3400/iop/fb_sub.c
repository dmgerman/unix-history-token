begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1992, 1993  *	The Regents of the University of California.  All rights reserved.  *  * This code is derived from software contributed to Berkeley by  * Sony Corp. and Kazumasa Utashiro of Software Research Associates, Inc.  *  * %sccs.include.redist.c%  *  * from: $Hdr: fb_sub.c,v 4.300 91/06/27 20:43:09 root Rel41 $ SONY  *  *	@(#)fb_sub.c	8.2 (Berkeley) %G%  */
end_comment

begin_include
include|#
directive|include
file|"fb.h"
end_include

begin_if
if|#
directive|if
name|NFB
operator|>
literal|0
end_if

begin_comment
comment|/*  * Frame buffer driver  */
end_comment

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<machine/pte.h>
end_include

begin_include
include|#
directive|include
file|<machine/cpu.h>
end_include

begin_include
include|#
directive|include
file|<machine/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/user.h>
end_include

begin_include
include|#
directive|include
file|<sys/buf.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/map.h>
end_include

begin_include
include|#
directive|include
file|<sys/uio.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<news3400/iop/framebuf.h>
end_include

begin_include
include|#
directive|include
file|<news3400/iop/fbreg.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|CPU_DOUBLE
end_ifdef

begin_ifdef
ifdef|#
directive|ifdef
name|IPC_MRX
end_ifdef

begin_include
include|#
directive|include
file|"../ipc/newsipc.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|mips
end_ifdef

begin_define
define|#
directive|define
name|ipc_phys
parameter_list|(
name|x
parameter_list|)
value|K0_TT0(x)
end_define

begin_define
define|#
directive|define
name|ipc_log
parameter_list|(
name|x
parameter_list|)
value|TT0_K0(x)
end_define

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* mips */
end_comment

begin_define
define|#
directive|define
name|ipc_phys
parameter_list|(
name|x
parameter_list|)
value|(caddr_t)((int)(x)& ~0x80000000)
end_define

begin_define
define|#
directive|define
name|ipc_log
parameter_list|(
name|x
parameter_list|)
value|(caddr_t)((int)(x) | 0x80000000)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* mips */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* IPC_MRX */
end_comment

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* CPU_DOUBLE */
end_comment

begin_define
define|#
directive|define
name|ipc_phys
parameter_list|(
name|x
parameter_list|)
value|(caddr_t)((int)(x))
end_define

begin_define
define|#
directive|define
name|ipc_log
parameter_list|(
name|x
parameter_list|)
value|(caddr_t)((int)(x) | 0x80000000)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CPU_DOUBLE */
end_comment

begin_define
define|#
directive|define
name|MAX_FBMAP
value|3
end_define

begin_decl_stmt
specifier|static
name|struct
name|fb_map
name|fbmap
index|[
name|MAX_FBMAP
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* bitblt type */
end_comment

begin_define
define|#
directive|define
name|BLTTYPE
parameter_list|(
name|ts
parameter_list|,
name|td
parameter_list|)
value|((ts)<< 2 | (td))
end_define

begin_decl_stmt
specifier|static
name|lSrcDest
name|srcdestlist
index|[
name|MAX_BATCHBITBLT
index|]
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|MAX_SIZE
value|(MAX_BATCHBITBLT * sizeof(lSrcDest))
end_define

begin_define
define|#
directive|define
name|ODD_ADDR
parameter_list|(
name|x
parameter_list|)
value|(((unsigned)(x))&1)
end_define

begin_define
define|#
directive|define
name|MAXMSEG
value|4
end_define

begin_decl_stmt
specifier|static
name|int
name|segind
decl_stmt|;
end_decl_stmt

begin_struct
specifier|static
struct|struct
name|memseg
block|{
name|caddr_t
name|adrs
decl_stmt|;
name|int
name|len
decl_stmt|;
name|int
name|rw
decl_stmt|;
name|caddr_t
name|oadrs
decl_stmt|;
name|int
name|olen
decl_stmt|;
name|struct
name|fb_map
modifier|*
name|map
decl_stmt|;
block|}
name|mseg
index|[
name|MAXMSEG
index|]
struct|;
end_struct

begin_define
define|#
directive|define
name|BASE
parameter_list|(
name|a
parameter_list|)
value|((int)(a)& ~(NBPG - 1))
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|CPU_DOUBLE
end_ifdef

begin_macro
name|COPYIN
argument_list|(
argument|src
argument_list|,
argument|dst
argument_list|,
argument|len
argument_list|,
argument|seg
argument_list|)
end_macro

begin_decl_stmt
name|caddr_t
name|src
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|caddr_t
name|dst
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|len
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|seg
decl_stmt|;
end_decl_stmt

begin_block
block|{
switch|switch
condition|(
name|seg
condition|)
block|{
case|case
name|UIO_SYSSPACE
case|:
name|bcopy
argument_list|(
name|src
argument_list|,
name|dst
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
case|case
name|UIO_USERSPACE
case|:
return|return
operator|(
name|copyin
argument_list|(
name|src
argument_list|,
name|dst
argument_list|,
name|len
argument_list|)
operator|)
return|;
default|default:
name|panic
argument_list|(
literal|"COPYIN: seg"
argument_list|)
expr_stmt|;
comment|/* NOTREACHED */
block|}
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CPU_DOUBLE */
end_comment

begin_macro
name|fbgetmap
argument_list|(
argument|addr
argument_list|,
argument|len
argument_list|,
argument|map
argument_list|)
end_macro

begin_decl_stmt
name|caddr_t
name|addr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|len
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|fb_map
modifier|*
name|map
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|struct
name|pte
modifier|*
name|pte
decl_stmt|;
specifier|register
name|caddr_t
modifier|*
name|p
decl_stmt|;
name|unsigned
name|v
decl_stmt|;
specifier|register
name|int
name|npf
decl_stmt|;
name|int
name|o
decl_stmt|;
name|v
operator|=
name|pmax_btop
argument_list|(
name|addr
argument_list|)
expr_stmt|;
name|o
operator|=
operator|(
name|int
operator|)
name|addr
operator|&
name|PGOFSET
expr_stmt|;
name|npf
operator|=
name|btoc
argument_list|(
name|len
operator|+
name|o
argument_list|)
expr_stmt|;
if|if
condition|(
name|npf
operator|>
name|NFBMAP
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|map
operator|->
name|fm_vaddr
operator|=
name|addr
expr_stmt|;
name|map
operator|->
name|fm_offset
operator|=
name|o
expr_stmt|;
name|map
operator|->
name|fm_count
operator|=
name|len
expr_stmt|;
ifdef|#
directive|ifdef
name|CPU_DOUBLE
if|if
condition|(
name|addr
operator|>=
operator|(
name|caddr_t
operator|)
name|KERNBASE
condition|)
block|{
ifdef|#
directive|ifdef
name|mips
name|p
operator|=
name|map
operator|->
name|fm_addr
expr_stmt|;
if|if
condition|(
name|MACH_IS_CACHED
argument_list|(
name|addr
argument_list|)
condition|)
block|{
name|addr
operator|=
name|ptob
argument_list|(
name|v
argument_list|)
expr_stmt|;
while|while
condition|(
operator|--
name|npf
operator|>=
literal|0
condition|)
block|{
operator|*
name|p
operator|++
operator|=
operator|(
name|caddr_t
operator|)
name|K0_TT0
argument_list|(
name|addr
argument_list|)
expr_stmt|;
name|addr
operator|+=
name|NBPG
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|MACH_IS_MAPPED
argument_list|(
name|addr
argument_list|)
condition|)
name|pte
operator|=
name|kvtopte
argument_list|(
name|addr
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|addr
operator|>=
operator|(
name|caddr_t
operator|)
operator|&
name|u
condition|)
name|pte
operator|=
name|curproc
operator|->
name|p_addr
operator|+
name|btop
argument_list|(
name|addr
operator|-
operator|(
name|caddr_t
operator|)
operator|&
name|u
argument_list|)
expr_stmt|;
else|else
name|panic
argument_list|(
literal|"fbgetmap: bad kernel addr"
argument_list|)
expr_stmt|;
while|while
condition|(
operator|--
name|npf
operator|>=
literal|0
condition|)
operator|*
name|p
operator|++
operator|=
operator|(
name|caddr_t
operator|)
name|PHYS_TT0
argument_list|(
name|ptob
argument_list|(
name|pte
operator|++
operator|->
name|pg_pfnum
argument_list|)
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* mips */
name|pte
operator|=
name|kvtopte
argument_list|(
name|addr
argument_list|)
expr_stmt|;
name|p
operator|=
name|map
operator|->
name|fm_addr
expr_stmt|;
while|while
condition|(
operator|--
name|npf
operator|>=
literal|0
condition|)
operator|*
name|p
operator|++
operator|=
operator|(
name|caddr_t
operator|)
name|ptob
argument_list|(
name|pte
operator|++
operator|->
name|pg_pfnum
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* mips */
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|pte
operator|=
name|vtopte
argument_list|(
name|curproc
argument_list|,
name|v
argument_list|)
expr_stmt|;
comment|/*KU:XXXXXXXXXXXXXXXXXX*/
name|p
operator|=
name|map
operator|->
name|fm_addr
expr_stmt|;
while|while
condition|(
operator|--
name|npf
operator|>=
literal|0
condition|)
block|{
if|if
condition|(
name|pte
operator|->
name|pg_pfnum
operator|==
literal|0
condition|)
name|panic
argument_list|(
literal|"iop zero uentry"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|mips
operator|*
name|p
operator|++
operator|=
operator|(
name|caddr_t
operator|)
name|PHYS_TT0
argument_list|(
name|ptob
argument_list|(
name|pte
operator|++
operator|->
name|pg_pfnum
argument_list|)
argument_list|)
expr_stmt|;
else|#
directive|else
operator|*
name|p
operator|++
operator|=
operator|(
name|caddr_t
operator|)
name|ptob
argument_list|(
name|pte
operator|++
operator|->
name|pg_pfnum
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
endif|#
directive|endif
comment|/* CPU_DOUBLE */
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_expr_stmt
name|fblockmem
argument_list|(
name|ad
argument_list|,
name|len
argument_list|,
name|rw
argument_list|,
name|map
argument_list|,
name|seg
argument_list|)
specifier|register
name|caddr_t
name|ad
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|int
name|len
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|rw
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|fb_map
modifier|*
name|map
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|seg
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|struct
name|memseg
modifier|*
name|msp
decl_stmt|;
comment|/* validity check */
if|if
condition|(
name|len
operator|<
literal|0
condition|)
return|return
name|EFAULT
return|;
elseif|else
if|if
condition|(
name|len
operator|==
literal|0
condition|)
return|return
literal|0
return|;
elseif|else
if|if
condition|(
name|ad
operator|==
literal|0
condition|)
return|return
name|EFAULT
return|;
elseif|else
if|if
condition|(
name|seg
operator|==
name|UIO_USERSPACE
operator|&&
operator|!
name|useracc
argument_list|(
name|ad
argument_list|,
name|len
argument_list|,
name|rw
operator|==
name|B_READ
condition|?
name|B_WRITE
else|:
name|B_READ
argument_list|)
condition|)
return|return
name|EFAULT
return|;
elseif|else
if|if
condition|(
name|segind
operator|>=
name|MAXMSEG
condition|)
return|return
name|EFAULT
return|;
comment|/* insertion sort */
for|for
control|(
name|msp
operator|=
name|mseg
operator|+
name|segind
operator|-
literal|1
init|;
name|msp
operator|>=
name|mseg
condition|;
name|msp
operator|--
control|)
block|{
if|if
condition|(
name|msp
operator|->
name|adrs
operator|>
name|ad
condition|)
operator|*
operator|(
name|msp
operator|+
literal|1
operator|)
operator|=
operator|*
name|msp
expr_stmt|;
else|else
break|break;
block|}
name|msp
operator|++
expr_stmt|;
ifdef|#
directive|ifdef
name|CPU_SINGLE
switch|switch
condition|(
name|seg
condition|)
block|{
case|case
name|UIO_SYSSPACE
case|:
name|map
operator|->
name|fm_vaddr
operator|=
name|ad
expr_stmt|;
name|map
operator|->
name|fm_offset
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|UIO_USERSPACE
case|:
name|msp
operator|->
name|adrs
operator|=
operator|(
name|caddr_t
operator|)
name|BASE
argument_list|(
name|ad
argument_list|)
expr_stmt|;
name|msp
operator|->
name|len
operator|=
operator|(
name|caddr_t
operator|)
name|BASE
argument_list|(
name|ad
operator|+
name|len
operator|+
name|NBPG
operator|-
literal|1
argument_list|)
operator|-
name|msp
operator|->
name|adrs
expr_stmt|;
break|break;
default|default:
name|panic
argument_list|(
literal|"fblockmem: seg"
argument_list|)
expr_stmt|;
comment|/* NOTREACHED */
block|}
else|#
directive|else
comment|/* CPU_SINGLE */
name|msp
operator|->
name|adrs
operator|=
operator|(
name|caddr_t
operator|)
name|BASE
argument_list|(
name|ad
argument_list|)
expr_stmt|;
name|msp
operator|->
name|len
operator|=
operator|(
name|caddr_t
operator|)
name|BASE
argument_list|(
name|ad
operator|+
name|len
operator|+
name|NBPG
operator|-
literal|1
argument_list|)
operator|-
name|msp
operator|->
name|adrs
expr_stmt|;
endif|#
directive|endif
comment|/* CPU_SINGLE */
name|msp
operator|->
name|rw
operator|=
name|rw
expr_stmt|;
name|msp
operator|->
name|oadrs
operator|=
name|ad
expr_stmt|;
name|msp
operator|->
name|olen
operator|=
name|len
expr_stmt|;
name|msp
operator|->
name|map
operator|=
name|map
expr_stmt|;
name|segind
operator|++
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_expr_stmt
name|fblocksbitmap
argument_list|(
name|bm
argument_list|,
name|rw
argument_list|,
name|map
argument_list|)
specifier|register
name|lBitmap
operator|*
name|bm
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|rw
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|fb_map
modifier|*
name|map
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|len
decl_stmt|;
specifier|register
name|int
name|error
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|bm
operator|->
name|depth
operator|>
literal|32
condition|)
return|return
name|EINVAL
return|;
if|if
condition|(
name|bm
operator|->
name|type
operator|==
name|BM_FB
operator|||
name|bm
operator|->
name|type
operator|==
name|BM_0
operator|||
name|bm
operator|->
name|type
operator|==
name|BM_1
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|bm
operator|->
name|type
operator|==
name|BM_MEM
condition|)
name|len
operator|=
name|bm
operator|->
name|width
operator|*
name|bm
operator|->
name|rect
operator|.
name|extent
operator|.
name|y
operator|*
name|bm
operator|->
name|depth
operator|*
sizeof|sizeof
argument_list|(
name|Word
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
operator|||
name|len
operator|>
name|FB_MAX_IO
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|error
operator|=
name|fblockmem
argument_list|(
call|(
name|caddr_t
call|)
argument_list|(
name|bm
operator|->
name|base
argument_list|)
argument_list|,
name|len
argument_list|,
name|rw
argument_list|,
name|map
argument_list|,
name|UIO_USERSPACE
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
name|bm
operator|->
name|base
operator|=
operator|(
name|Word
operator|*
operator|)
name|ipc_phys
argument_list|(
name|map
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_block

begin_function
name|void
name|fbinitlock
parameter_list|()
block|{
name|segind
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
name|void
name|fbdolock
parameter_list|()
block|{
specifier|register
name|struct
name|memseg
modifier|*
name|msp0
decl_stmt|,
modifier|*
name|msp1
decl_stmt|,
modifier|*
name|mspl
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|,
name|tlen
decl_stmt|;
name|mspl
operator|=
name|mseg
operator|+
name|segind
expr_stmt|;
for|for
control|(
name|msp0
operator|=
name|mseg
operator|,
name|msp1
operator|=
name|mseg
operator|+
literal|1
init|;
name|msp1
operator|<
name|mspl
condition|;
name|msp0
operator|++
operator|,
name|msp1
operator|++
control|)
block|{
if|if
condition|(
name|msp0
operator|->
name|adrs
operator|+
name|msp0
operator|->
name|len
operator|>
name|msp1
operator|->
name|adrs
condition|)
block|{
name|tlen
operator|=
name|msp1
operator|->
name|adrs
operator|-
name|msp0
operator|->
name|adrs
operator|+
name|msp1
operator|->
name|len
expr_stmt|;
name|msp1
operator|->
name|adrs
operator|=
name|msp0
operator|->
name|adrs
expr_stmt|;
name|msp1
operator|->
name|len
operator|=
name|msp0
operator|->
name|len
operator|>
name|tlen
condition|?
name|msp0
operator|->
name|len
else|:
name|tlen
expr_stmt|;
name|msp0
operator|->
name|len
operator|=
literal|0
expr_stmt|;
name|msp1
operator|->
name|rw
operator|=
operator|(
name|msp0
operator|->
name|rw
operator|==
name|B_READ
operator|||
name|msp1
operator|->
name|rw
operator|==
name|B_READ
operator|)
condition|?
name|B_READ
else|:
name|B_WRITE
expr_stmt|;
block|}
block|}
comment|/* lock */
name|curproc
operator|->
name|p_flag
operator||=
name|P_PHYSIO
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|segind
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|mseg
index|[
name|i
index|]
operator|.
name|len
operator|&&
name|mseg
index|[
name|i
index|]
operator|.
name|adrs
operator|&&
name|mseg
index|[
name|i
index|]
operator|.
name|adrs
operator|<
operator|(
name|caddr_t
operator|)
name|KERNBASE
condition|)
name|vslock
argument_list|(
name|mseg
index|[
name|i
index|]
operator|.
name|adrs
argument_list|,
name|mseg
index|[
name|i
index|]
operator|.
name|len
argument_list|)
expr_stmt|;
comment|/* make map */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|segind
condition|;
name|i
operator|++
control|)
name|fbgetmap
argument_list|(
name|mseg
index|[
name|i
index|]
operator|.
name|oadrs
argument_list|,
name|mseg
index|[
name|i
index|]
operator|.
name|olen
argument_list|,
name|mseg
index|[
name|i
index|]
operator|.
name|map
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|fbunlock
parameter_list|()
block|{
specifier|register
name|int
name|i
decl_stmt|;
name|int
name|s
init|=
name|splfb
argument_list|()
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|segind
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|mseg
index|[
name|i
index|]
operator|.
name|len
operator|&&
name|mseg
index|[
name|i
index|]
operator|.
name|adrs
operator|&&
name|mseg
index|[
name|i
index|]
operator|.
name|adrs
operator|<
operator|(
name|caddr_t
operator|)
name|KERNBASE
condition|)
block|{
name|vsunlock
argument_list|(
name|mseg
index|[
name|i
index|]
operator|.
name|adrs
argument_list|,
name|mseg
index|[
name|i
index|]
operator|.
name|len
argument_list|,
name|mseg
index|[
name|i
index|]
operator|.
name|rw
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|mips
argument_list|)
operator|&&
name|defined
argument_list|(
name|CPU_DOUBLE
argument_list|)
if|if
condition|(
name|mseg
index|[
name|i
index|]
operator|.
name|rw
operator|==
name|B_READ
condition|)
name|clean_kudcache
argument_list|(
name|curproc
argument_list|,
name|mseg
index|[
name|i
index|]
operator|.
name|adrs
argument_list|,
name|mseg
index|[
name|i
index|]
operator|.
name|len
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
block|}
name|curproc
operator|->
name|p_flag
operator|&=
operator|~
name|P_PHYSIO
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
comment|/* for 'fbinitlock() o wasureru ukkariyasan'... */
name|segind
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_expr_stmt
name|checkbitmap
argument_list|(
name|bm
argument_list|)
specifier|register
name|lBitmap
operator|*
name|bm
expr_stmt|;
end_expr_stmt

begin_block
block|{
if|if
condition|(
name|bm
operator|->
name|depth
operator|>
literal|32
condition|)
return|return
name|EINVAL
return|;
switch|switch
condition|(
name|bm
operator|->
name|type
condition|)
block|{
case|case
name|BM_FB
case|:
case|case
name|BM_0
case|:
case|case
name|BM_1
case|:
break|break;
case|case
name|BM_MEM
case|:
if|if
condition|(
name|ODD_ADDR
argument_list|(
name|bm
operator|->
name|base
argument_list|)
condition|)
return|return
name|EINVAL
return|;
if|if
condition|(
name|bm
operator|->
name|width
operator|==
literal|0
condition|)
return|return
name|EINVAL
return|;
if|if
condition|(
operator|(
name|bm
operator|->
name|width
operator|*
name|bm
operator|->
name|rect
operator|.
name|extent
operator|.
name|y
operator|)
operator|<<
literal|1
operator|>
name|FB_MAX_IO
condition|)
return|return
name|EINVAL
return|;
break|break;
default|default:
return|return
name|EINVAL
return|;
block|}
if|if
condition|(
name|bm
operator|->
name|rect
operator|.
name|extent
operator|.
name|x
operator|<
literal|0
operator|||
name|bm
operator|->
name|rect
operator|.
name|extent
operator|.
name|y
operator|<
literal|0
condition|)
return|return
name|EINVAL
return|;
else|else
return|return
literal|0
return|;
block|}
end_block

begin_macro
name|checkdepth
argument_list|(
argument|sbm
argument_list|,
argument|dbm
argument_list|)
end_macro

begin_decl_stmt
name|lBitmap
modifier|*
name|sbm
decl_stmt|,
modifier|*
name|dbm
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|ds
init|=
name|sbm
operator|->
name|depth
decl_stmt|;
specifier|register
name|int
name|dd
init|=
name|dbm
operator|->
name|depth
decl_stmt|;
if|if
condition|(
name|ds
operator|>
literal|1
operator|&&
name|dd
operator|>
literal|1
operator|&&
name|ds
operator|!=
name|dd
condition|)
return|return
operator|-
literal|1
return|;
else|else
return|return
operator|(
operator|(
name|ds
operator|>
literal|1
operator|)
operator|<<
literal|1
operator||
operator|(
name|dd
operator|>
literal|1
operator|)
operator|)
return|;
block|}
end_block

begin_macro
name|dobitblt
argument_list|(
argument|fbp
argument_list|,
argument|sbm
argument_list|,
argument|dbm
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|fbreg
modifier|*
name|fbp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|lBitmap
modifier|*
name|sbm
decl_stmt|,
modifier|*
name|dbm
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|error
decl_stmt|;
if|if
condition|(
name|error
operator|=
name|fblocksbitmap
argument_list|(
name|sbm
argument_list|,
name|B_WRITE
argument_list|,
name|fbmap
argument_list|)
condition|)
return|return
name|error
return|;
if|if
condition|(
name|error
operator|=
name|fblocksbitmap
argument_list|(
name|dbm
argument_list|,
name|B_READ
argument_list|,
name|fbmap
operator|+
literal|1
argument_list|)
condition|)
return|return
name|error
return|;
name|fbdolock
argument_list|()
expr_stmt|;
name|fbstart
argument_list|(
name|fbp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|fbunlock
argument_list|()
expr_stmt|;
comment|/* reset address */
if|if
condition|(
name|sbm
operator|->
name|type
operator|==
name|BM_MEM
condition|)
name|sbm
operator|->
name|base
operator|=
operator|(
name|Word
operator|*
operator|)
operator|(
operator|(
expr|struct
name|fb_map
operator|*
operator|)
name|ipc_log
argument_list|(
name|sbm
operator|->
name|base
argument_list|)
operator|)
operator|->
name|fm_vaddr
expr_stmt|;
if|if
condition|(
name|dbm
operator|->
name|type
operator|==
name|BM_MEM
condition|)
name|dbm
operator|->
name|base
operator|=
operator|(
name|Word
operator|*
operator|)
operator|(
operator|(
expr|struct
name|fb_map
operator|*
operator|)
name|ipc_log
argument_list|(
name|dbm
operator|->
name|base
argument_list|)
operator|)
operator|->
name|fm_vaddr
expr_stmt|;
return|return
literal|0
return|;
block|}
end_block

begin_expr_stmt
name|fbnbitblt
argument_list|(
name|fbp
argument_list|,
name|cmd
argument_list|)
specifier|register
expr|struct
name|fbreg
operator|*
name|fbp
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|lBitblt
modifier|*
name|cmd
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|lBitblt
modifier|*
name|regcmd
decl_stmt|;
specifier|register
name|int
name|len
decl_stmt|,
name|lens
decl_stmt|,
name|lend
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
name|int
name|pmask
decl_stmt|,
name|mode
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|int
name|blttype
init|=
name|BLTTYPE
argument_list|(
name|cmd
operator|->
name|srcBitmap
operator|.
name|type
argument_list|,
name|cmd
operator|->
name|destBitmap
operator|.
name|type
argument_list|)
decl_stmt|;
ifdef|#
directive|ifdef
name|CPU_DOUBLE
if|if
condition|(
operator|(
name|blttype
operator|==
name|BLTTYPE
argument_list|(
name|BM_MEM
argument_list|,
name|BM_MEM
argument_list|)
operator|)
operator|||
operator|(
name|blttype
operator|==
name|BLTTYPE
argument_list|(
name|BM_0
argument_list|,
name|BM_MEM
argument_list|)
operator|)
operator|||
operator|(
name|blttype
operator|==
name|BLTTYPE
argument_list|(
name|BM_1
argument_list|,
name|BM_MEM
argument_list|)
operator|)
condition|)
block|{
return|return
operator|(
name|mfbnbitblt
argument_list|(
name|fbp
argument_list|,
name|cmd
argument_list|)
operator|)
return|;
comment|/* NOTREACHED */
block|}
endif|#
directive|endif
name|fbinitlock
argument_list|()
expr_stmt|;
if|if
condition|(
name|error
operator|=
name|checkbitmap
argument_list|(
operator|&
name|cmd
operator|->
name|srcBitmap
argument_list|)
condition|)
return|return
name|error
return|;
if|if
condition|(
name|error
operator|=
name|checkbitmap
argument_list|(
operator|&
name|cmd
operator|->
name|destBitmap
argument_list|)
condition|)
return|return
name|error
return|;
if|if
condition|(
operator|(
name|mode
operator|=
name|checkdepth
argument_list|(
operator|&
name|cmd
operator|->
name|srcBitmap
argument_list|,
operator|&
name|cmd
operator|->
name|destBitmap
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|EINVAL
return|;
name|fbp
operator|->
name|fb_command
operator|=
name|FB_CBITBLT
expr_stmt|;
name|fbp
operator|->
name|fb_bitblt
operator|=
operator|*
name|cmd
expr_stmt|;
name|regcmd
operator|=
operator|&
name|fbp
operator|->
name|fb_bitblt
expr_stmt|;
comment|/* process bitblt command */
switch|switch
condition|(
name|blttype
condition|)
block|{
case|case
name|BLTTYPE
argument_list|(
name|BM_FB
argument_list|,
name|BM_FB
argument_list|)
case|:
case|case
name|BLTTYPE
argument_list|(
name|BM_0
argument_list|,
name|BM_FB
argument_list|)
case|:
case|case
name|BLTTYPE
argument_list|(
name|BM_1
argument_list|,
name|BM_FB
argument_list|)
case|:
name|fbstart
argument_list|(
name|fbp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|BLTTYPE
argument_list|(
name|BM_FB
argument_list|,
name|BM_MEM
argument_list|)
case|:
case|case
name|BLTTYPE
argument_list|(
name|BM_0
argument_list|,
name|BM_MEM
argument_list|)
case|:
case|case
name|BLTTYPE
argument_list|(
name|BM_1
argument_list|,
name|BM_MEM
argument_list|)
case|:
name|len
operator|=
name|cmd
operator|->
name|destBitmap
operator|.
name|width
operator|*
name|cmd
operator|->
name|destBitmap
operator|.
name|rect
operator|.
name|extent
operator|.
name|y
operator|<<
literal|1
expr_stmt|;
if|if
condition|(
name|len
operator|*
name|cmd
operator|->
name|destBitmap
operator|.
name|depth
operator|<=
name|FB_MAX_IO
condition|)
block|{
name|error
operator|=
name|dobitblt
argument_list|(
name|fbp
argument_list|,
operator|&
name|regcmd
operator|->
name|srcBitmap
argument_list|,
operator|&
name|regcmd
operator|->
name|destBitmap
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
comment|/* bitblt each plane */
name|regcmd
operator|->
name|destBitmap
operator|.
name|depth
operator|=
literal|1
expr_stmt|;
name|pmask
operator|=
name|regcmd
operator|->
name|planemask
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cmd
operator|->
name|destBitmap
operator|.
name|depth
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|mode
operator|==
literal|3
condition|)
comment|/* N to N */
name|regcmd
operator|->
name|planemask
operator|=
name|pmask
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
expr_stmt|;
if|if
condition|(
name|error
operator|=
name|dobitblt
argument_list|(
name|fbp
argument_list|,
operator|&
name|regcmd
operator|->
name|srcBitmap
argument_list|,
operator|&
name|regcmd
operator|->
name|destBitmap
argument_list|)
condition|)
return|return
name|error
return|;
name|regcmd
operator|->
name|destBitmap
operator|.
name|base
operator|+=
name|len
operator|>>
literal|1
expr_stmt|;
if|if
condition|(
name|mode
operator|==
literal|1
condition|)
block|{
comment|/* N to N */
name|regcmd
operator|->
name|planemask
operator|>>=
literal|1
expr_stmt|;
name|regcmd
operator|->
name|fore_color
operator|>>=
literal|1
expr_stmt|;
name|regcmd
operator|->
name|aux_color
operator|>>=
literal|1
expr_stmt|;
block|}
block|}
break|break;
case|case
name|BLTTYPE
argument_list|(
name|BM_MEM
argument_list|,
name|BM_FB
argument_list|)
case|:
name|len
operator|=
name|cmd
operator|->
name|srcBitmap
operator|.
name|width
operator|*
name|cmd
operator|->
name|srcBitmap
operator|.
name|rect
operator|.
name|extent
operator|.
name|y
operator|<<
literal|1
expr_stmt|;
if|if
condition|(
name|len
operator|*
name|cmd
operator|->
name|srcBitmap
operator|.
name|depth
operator|<=
name|FB_MAX_IO
condition|)
block|{
name|error
operator|=
name|dobitblt
argument_list|(
name|fbp
argument_list|,
operator|&
name|regcmd
operator|->
name|srcBitmap
argument_list|,
operator|&
name|regcmd
operator|->
name|destBitmap
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
comment|/* bitblt each plane */
name|regcmd
operator|->
name|srcBitmap
operator|.
name|depth
operator|=
literal|1
expr_stmt|;
name|pmask
operator|=
name|regcmd
operator|->
name|planemask
expr_stmt|;
name|regcmd
operator|->
name|fore_color
operator|=
literal|0xff
expr_stmt|;
name|regcmd
operator|->
name|aux_color
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|mode
operator|==
literal|2
condition|)
block|{
comment|/* N to 1 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cmd
operator|->
name|srcBitmap
operator|.
name|depth
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|pmask
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
condition|)
break|break;
if|if
condition|(
name|i
operator|>=
name|cmd
operator|->
name|srcBitmap
operator|.
name|depth
condition|)
return|return
literal|0
return|;
name|regcmd
operator|->
name|srcBitmap
operator|.
name|base
operator|+=
operator|(
name|len
operator|>>
literal|1
operator|)
operator|*
name|i
expr_stmt|;
name|error
operator|=
name|dobitblt
argument_list|(
name|fbp
argument_list|,
operator|&
name|regcmd
operator|->
name|srcBitmap
argument_list|,
operator|&
name|regcmd
operator|->
name|destBitmap
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
comment|/* else (N to N) */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cmd
operator|->
name|srcBitmap
operator|.
name|depth
condition|;
name|i
operator|++
control|)
block|{
name|regcmd
operator|->
name|planemask
operator|=
name|pmask
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
expr_stmt|;
if|if
condition|(
name|error
operator|=
name|dobitblt
argument_list|(
name|fbp
argument_list|,
operator|&
name|regcmd
operator|->
name|srcBitmap
argument_list|,
operator|&
name|regcmd
operator|->
name|destBitmap
argument_list|)
condition|)
return|return
name|error
return|;
name|regcmd
operator|->
name|srcBitmap
operator|.
name|base
operator|+=
name|len
operator|>>
literal|1
expr_stmt|;
name|regcmd
operator|->
name|planemask
operator|>>=
literal|1
expr_stmt|;
block|}
return|return
literal|0
return|;
case|case
name|BLTTYPE
argument_list|(
name|BM_MEM
argument_list|,
name|BM_MEM
argument_list|)
case|:
name|lens
operator|=
name|cmd
operator|->
name|srcBitmap
operator|.
name|width
operator|*
name|cmd
operator|->
name|srcBitmap
operator|.
name|rect
operator|.
name|extent
operator|.
name|y
operator|<<
literal|1
expr_stmt|;
name|lend
operator|=
name|cmd
operator|->
name|destBitmap
operator|.
name|width
operator|*
name|cmd
operator|->
name|destBitmap
operator|.
name|rect
operator|.
name|extent
operator|.
name|y
operator|<<
literal|1
expr_stmt|;
if|if
condition|(
name|lens
operator|*
name|cmd
operator|->
name|srcBitmap
operator|.
name|depth
operator|<=
name|FB_MAX_IO
operator|&&
name|lend
operator|*
name|cmd
operator|->
name|destBitmap
operator|.
name|depth
operator|<=
name|FB_MAX_IO
condition|)
block|{
name|error
operator|=
name|dobitblt
argument_list|(
name|fbp
argument_list|,
operator|&
name|regcmd
operator|->
name|srcBitmap
argument_list|,
operator|&
name|regcmd
operator|->
name|destBitmap
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
name|regcmd
operator|->
name|srcBitmap
operator|.
name|depth
operator|=
literal|1
expr_stmt|;
name|regcmd
operator|->
name|destBitmap
operator|.
name|depth
operator|=
literal|1
expr_stmt|;
name|pmask
operator|=
name|regcmd
operator|->
name|planemask
expr_stmt|;
if|if
condition|(
name|mode
operator|==
literal|2
condition|)
block|{
comment|/* N to 1 */
name|regcmd
operator|->
name|fore_color
operator|=
literal|0xff
expr_stmt|;
name|regcmd
operator|->
name|aux_color
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cmd
operator|->
name|srcBitmap
operator|.
name|depth
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|pmask
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
condition|)
break|break;
if|if
condition|(
name|i
operator|>=
name|cmd
operator|->
name|srcBitmap
operator|.
name|depth
condition|)
return|return
literal|0
return|;
name|regcmd
operator|->
name|srcBitmap
operator|.
name|base
operator|+=
operator|(
name|lens
operator|>>
literal|1
operator|)
operator|*
name|i
expr_stmt|;
name|error
operator|=
name|dobitblt
argument_list|(
name|fbp
argument_list|,
operator|&
name|regcmd
operator|->
name|srcBitmap
argument_list|,
operator|&
name|regcmd
operator|->
name|destBitmap
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
elseif|else
if|if
condition|(
name|mode
operator|==
literal|1
condition|)
block|{
comment|/* 1 to N */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cmd
operator|->
name|srcBitmap
operator|.
name|depth
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|error
operator|=
name|dobitblt
argument_list|(
name|fbp
argument_list|,
operator|&
name|regcmd
operator|->
name|srcBitmap
argument_list|,
operator|&
name|regcmd
operator|->
name|destBitmap
argument_list|)
condition|)
return|return
name|error
return|;
name|regcmd
operator|->
name|planemask
operator|>>=
literal|1
expr_stmt|;
name|regcmd
operator|->
name|fore_color
operator|>>=
literal|1
expr_stmt|;
name|regcmd
operator|->
name|aux_color
operator|>>=
literal|1
expr_stmt|;
name|regcmd
operator|->
name|destBitmap
operator|.
name|base
operator|+=
name|lend
operator|>>
literal|1
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
else|else
block|{
comment|/* N to N */
name|regcmd
operator|->
name|fore_color
operator|=
literal|0xff
expr_stmt|;
name|regcmd
operator|->
name|aux_color
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cmd
operator|->
name|srcBitmap
operator|.
name|depth
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|error
operator|=
name|dobitblt
argument_list|(
name|fbp
argument_list|,
operator|&
name|regcmd
operator|->
name|srcBitmap
argument_list|,
operator|&
name|regcmd
operator|->
name|destBitmap
argument_list|)
condition|)
return|return
name|error
return|;
name|regcmd
operator|->
name|srcBitmap
operator|.
name|base
operator|+=
name|lens
operator|>>
literal|1
expr_stmt|;
name|regcmd
operator|->
name|destBitmap
operator|.
name|base
operator|+=
name|lend
operator|>>
literal|1
expr_stmt|;
name|regcmd
operator|->
name|planemask
operator|>>=
literal|1
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
break|break;
default|default:
return|return
name|EINVAL
return|;
block|}
return|return
name|error
return|;
block|}
end_block

begin_macro
name|fbbitblt
argument_list|(
argument|fbp
argument_list|,
argument|cmd
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|fbreg
modifier|*
name|fbp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|sBitblt
modifier|*
name|cmd
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|lBitblt
name|lcmd
decl_stmt|;
specifier|register
name|lBitblt
modifier|*
name|lcmdp
decl_stmt|;
name|lcmdp
operator|=
operator|&
name|lcmd
expr_stmt|;
name|lcmdp
operator|->
name|func
operator|=
name|cmd
operator|->
name|func
expr_stmt|;
name|lcmdp
operator|->
name|transp
operator|=
name|cmd
operator|->
name|transp
expr_stmt|;
name|lcmdp
operator|->
name|fore_color
operator|=
name|cmd
operator|->
name|fore_color
expr_stmt|;
name|lcmdp
operator|->
name|aux_color
operator|=
name|cmd
operator|->
name|aux_color
expr_stmt|;
name|lcmdp
operator|->
name|planemask
operator|=
name|cmd
operator|->
name|planemask
expr_stmt|;
name|lcmdp
operator|->
name|srcBitmap
operator|.
name|type
operator|=
name|cmd
operator|->
name|srcBitmap
operator|.
name|type
expr_stmt|;
name|lcmdp
operator|->
name|srcBitmap
operator|.
name|depth
operator|=
name|cmd
operator|->
name|srcBitmap
operator|.
name|depth
expr_stmt|;
name|lcmdp
operator|->
name|srcBitmap
operator|.
name|width
operator|=
name|cmd
operator|->
name|srcBitmap
operator|.
name|width
expr_stmt|;
name|lcmdp
operator|->
name|srcBitmap
operator|.
name|rect
operator|.
name|origin
operator|.
name|x
operator|=
name|cmd
operator|->
name|srcBitmap
operator|.
name|rect
operator|.
name|origin
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|srcBitmap
operator|.
name|rect
operator|.
name|origin
operator|.
name|y
operator|=
name|cmd
operator|->
name|srcBitmap
operator|.
name|rect
operator|.
name|origin
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|srcBitmap
operator|.
name|rect
operator|.
name|extent
operator|.
name|x
operator|=
name|cmd
operator|->
name|srcBitmap
operator|.
name|rect
operator|.
name|extent
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|srcBitmap
operator|.
name|rect
operator|.
name|extent
operator|.
name|y
operator|=
name|cmd
operator|->
name|srcBitmap
operator|.
name|rect
operator|.
name|extent
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|srcBitmap
operator|.
name|base
operator|=
name|cmd
operator|->
name|srcBitmap
operator|.
name|base
expr_stmt|;
name|lcmdp
operator|->
name|srcRect
operator|.
name|origin
operator|.
name|x
operator|=
name|cmd
operator|->
name|srcRect
operator|.
name|origin
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|srcRect
operator|.
name|origin
operator|.
name|y
operator|=
name|cmd
operator|->
name|srcRect
operator|.
name|origin
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|srcRect
operator|.
name|extent
operator|.
name|x
operator|=
name|cmd
operator|->
name|srcRect
operator|.
name|extent
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|srcRect
operator|.
name|extent
operator|.
name|y
operator|=
name|cmd
operator|->
name|srcRect
operator|.
name|extent
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|destBitmap
operator|.
name|type
operator|=
name|cmd
operator|->
name|destBitmap
operator|.
name|type
expr_stmt|;
name|lcmdp
operator|->
name|destBitmap
operator|.
name|depth
operator|=
name|cmd
operator|->
name|destBitmap
operator|.
name|depth
expr_stmt|;
name|lcmdp
operator|->
name|destBitmap
operator|.
name|width
operator|=
name|cmd
operator|->
name|destBitmap
operator|.
name|width
expr_stmt|;
name|lcmdp
operator|->
name|destBitmap
operator|.
name|rect
operator|.
name|origin
operator|.
name|x
operator|=
name|cmd
operator|->
name|destBitmap
operator|.
name|rect
operator|.
name|origin
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|destBitmap
operator|.
name|rect
operator|.
name|origin
operator|.
name|y
operator|=
name|cmd
operator|->
name|destBitmap
operator|.
name|rect
operator|.
name|origin
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|destBitmap
operator|.
name|rect
operator|.
name|extent
operator|.
name|x
operator|=
name|cmd
operator|->
name|destBitmap
operator|.
name|rect
operator|.
name|extent
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|destBitmap
operator|.
name|rect
operator|.
name|extent
operator|.
name|y
operator|=
name|cmd
operator|->
name|destBitmap
operator|.
name|rect
operator|.
name|extent
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|destBitmap
operator|.
name|base
operator|=
name|cmd
operator|->
name|destBitmap
operator|.
name|base
expr_stmt|;
name|lcmdp
operator|->
name|destClip
operator|.
name|origin
operator|.
name|x
operator|=
name|cmd
operator|->
name|destClip
operator|.
name|origin
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|destClip
operator|.
name|origin
operator|.
name|y
operator|=
name|cmd
operator|->
name|destClip
operator|.
name|origin
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|destClip
operator|.
name|extent
operator|.
name|x
operator|=
name|cmd
operator|->
name|destClip
operator|.
name|extent
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|destClip
operator|.
name|extent
operator|.
name|y
operator|=
name|cmd
operator|->
name|destClip
operator|.
name|extent
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|destPoint
operator|.
name|x
operator|=
name|cmd
operator|->
name|destPoint
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|destPoint
operator|.
name|y
operator|=
name|cmd
operator|->
name|destPoint
operator|.
name|y
expr_stmt|;
return|return
operator|(
name|fbnbitblt
argument_list|(
name|fbp
argument_list|,
name|lcmdp
argument_list|)
operator|)
return|;
block|}
end_block

begin_macro
name|procbatchbitblt
argument_list|(
argument|fbp
argument_list|,
argument|mode
argument_list|,
argument|cmd
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|fbreg
modifier|*
name|fbp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|mode
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|lBatchBitblt
modifier|*
name|cmd
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|lBatchBitblt
modifier|*
name|regcmd
decl_stmt|;
specifier|register
name|int
name|len
decl_stmt|,
name|lens
decl_stmt|,
name|lend
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
name|int
name|pmask
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|regcmd
operator|=
operator|&
name|fbp
operator|->
name|fb_batchbitblt
expr_stmt|;
comment|/* process batch bitblt command */
switch|switch
condition|(
name|BLTTYPE
argument_list|(
name|regcmd
operator|->
name|srcBitmap
operator|.
name|type
argument_list|,
name|regcmd
operator|->
name|destBitmap
operator|.
name|type
argument_list|)
condition|)
block|{
case|case
name|BLTTYPE
argument_list|(
name|BM_FB
argument_list|,
name|BM_FB
argument_list|)
case|:
case|case
name|BLTTYPE
argument_list|(
name|BM_0
argument_list|,
name|BM_FB
argument_list|)
case|:
case|case
name|BLTTYPE
argument_list|(
name|BM_1
argument_list|,
name|BM_FB
argument_list|)
case|:
name|fbdolock
argument_list|()
expr_stmt|;
name|fbstart
argument_list|(
name|fbp
argument_list|,
name|cmd
operator|->
name|nSrcDest
argument_list|)
expr_stmt|;
name|fbunlock
argument_list|()
expr_stmt|;
break|break;
case|case
name|BLTTYPE
argument_list|(
name|BM_FB
argument_list|,
name|BM_MEM
argument_list|)
case|:
case|case
name|BLTTYPE
argument_list|(
name|BM_0
argument_list|,
name|BM_MEM
argument_list|)
case|:
case|case
name|BLTTYPE
argument_list|(
name|BM_1
argument_list|,
name|BM_MEM
argument_list|)
case|:
name|len
operator|=
name|cmd
operator|->
name|destBitmap
operator|.
name|width
operator|*
name|cmd
operator|->
name|destBitmap
operator|.
name|rect
operator|.
name|extent
operator|.
name|y
operator|<<
literal|1
expr_stmt|;
if|if
condition|(
name|len
operator|*
name|cmd
operator|->
name|destBitmap
operator|.
name|depth
operator|<=
name|FB_MAX_IO
condition|)
block|{
name|error
operator|=
name|dobitblt
argument_list|(
name|fbp
argument_list|,
operator|&
name|regcmd
operator|->
name|srcBitmap
argument_list|,
operator|&
name|regcmd
operator|->
name|destBitmap
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
comment|/* bitblt each plane */
name|regcmd
operator|->
name|destBitmap
operator|.
name|depth
operator|=
literal|1
expr_stmt|;
name|pmask
operator|=
name|regcmd
operator|->
name|planemask
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cmd
operator|->
name|destBitmap
operator|.
name|depth
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|mode
operator|==
literal|3
condition|)
comment|/* N to N */
name|regcmd
operator|->
name|planemask
operator|=
name|pmask
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
expr_stmt|;
if|if
condition|(
name|error
operator|=
name|dobitblt
argument_list|(
name|fbp
argument_list|,
operator|&
name|regcmd
operator|->
name|srcBitmap
argument_list|,
operator|&
name|regcmd
operator|->
name|destBitmap
argument_list|)
condition|)
return|return
name|error
return|;
name|regcmd
operator|->
name|destBitmap
operator|.
name|base
operator|+=
name|len
operator|>>
literal|1
expr_stmt|;
if|if
condition|(
name|mode
operator|==
literal|1
condition|)
block|{
comment|/* N to N */
name|regcmd
operator|->
name|planemask
operator|>>=
literal|1
expr_stmt|;
name|regcmd
operator|->
name|fore_color
operator|>>=
literal|1
expr_stmt|;
name|regcmd
operator|->
name|aux_color
operator|>>=
literal|1
expr_stmt|;
block|}
block|}
break|break;
case|case
name|BLTTYPE
argument_list|(
name|BM_MEM
argument_list|,
name|BM_FB
argument_list|)
case|:
name|len
operator|=
name|cmd
operator|->
name|srcBitmap
operator|.
name|width
operator|*
name|cmd
operator|->
name|srcBitmap
operator|.
name|rect
operator|.
name|extent
operator|.
name|y
operator|<<
literal|1
expr_stmt|;
if|if
condition|(
name|len
operator|*
name|cmd
operator|->
name|srcBitmap
operator|.
name|depth
operator|<=
name|FB_MAX_IO
condition|)
block|{
name|error
operator|=
name|dobitblt
argument_list|(
name|fbp
argument_list|,
operator|&
name|regcmd
operator|->
name|srcBitmap
argument_list|,
operator|&
name|regcmd
operator|->
name|destBitmap
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
comment|/* bitblt each plane */
name|regcmd
operator|->
name|srcBitmap
operator|.
name|depth
operator|=
literal|1
expr_stmt|;
name|pmask
operator|=
name|regcmd
operator|->
name|planemask
expr_stmt|;
name|regcmd
operator|->
name|fore_color
operator|=
literal|0xff
expr_stmt|;
name|regcmd
operator|->
name|aux_color
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|mode
operator|==
literal|2
condition|)
block|{
comment|/* N to 1 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cmd
operator|->
name|srcBitmap
operator|.
name|depth
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|pmask
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
condition|)
break|break;
if|if
condition|(
name|i
operator|>=
name|cmd
operator|->
name|srcBitmap
operator|.
name|depth
condition|)
return|return
literal|0
return|;
name|regcmd
operator|->
name|srcBitmap
operator|.
name|base
operator|+=
operator|(
name|len
operator|>>
literal|1
operator|)
operator|*
name|i
expr_stmt|;
name|error
operator|=
name|dobitblt
argument_list|(
name|fbp
argument_list|,
operator|&
name|regcmd
operator|->
name|srcBitmap
argument_list|,
operator|&
name|regcmd
operator|->
name|destBitmap
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
comment|/* else (N to N) */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cmd
operator|->
name|srcBitmap
operator|.
name|depth
condition|;
name|i
operator|++
control|)
block|{
name|regcmd
operator|->
name|planemask
operator|=
name|pmask
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
expr_stmt|;
if|if
condition|(
name|error
operator|=
name|dobitblt
argument_list|(
name|fbp
argument_list|,
operator|&
name|regcmd
operator|->
name|srcBitmap
argument_list|,
operator|&
name|regcmd
operator|->
name|destBitmap
argument_list|)
condition|)
return|return
name|error
return|;
name|regcmd
operator|->
name|srcBitmap
operator|.
name|base
operator|+=
name|len
operator|>>
literal|1
expr_stmt|;
name|regcmd
operator|->
name|planemask
operator|>>=
literal|1
expr_stmt|;
block|}
return|return
literal|0
return|;
case|case
name|BLTTYPE
argument_list|(
name|BM_MEM
argument_list|,
name|BM_MEM
argument_list|)
case|:
name|lens
operator|=
name|cmd
operator|->
name|srcBitmap
operator|.
name|width
operator|*
name|cmd
operator|->
name|srcBitmap
operator|.
name|rect
operator|.
name|extent
operator|.
name|y
operator|<<
literal|1
expr_stmt|;
name|lend
operator|=
name|cmd
operator|->
name|destBitmap
operator|.
name|width
operator|*
name|cmd
operator|->
name|destBitmap
operator|.
name|rect
operator|.
name|extent
operator|.
name|y
operator|<<
literal|1
expr_stmt|;
if|if
condition|(
name|lens
operator|*
name|cmd
operator|->
name|srcBitmap
operator|.
name|depth
operator|<=
name|FB_MAX_IO
operator|&&
name|lend
operator|*
name|cmd
operator|->
name|destBitmap
operator|.
name|depth
operator|<=
name|FB_MAX_IO
condition|)
block|{
name|error
operator|=
name|dobitblt
argument_list|(
name|fbp
argument_list|,
operator|&
name|regcmd
operator|->
name|srcBitmap
argument_list|,
operator|&
name|regcmd
operator|->
name|destBitmap
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
name|regcmd
operator|->
name|srcBitmap
operator|.
name|depth
operator|=
literal|1
expr_stmt|;
name|regcmd
operator|->
name|destBitmap
operator|.
name|depth
operator|=
literal|1
expr_stmt|;
name|pmask
operator|=
name|regcmd
operator|->
name|planemask
expr_stmt|;
if|if
condition|(
name|mode
operator|==
literal|2
condition|)
block|{
comment|/* N to 1 */
name|regcmd
operator|->
name|fore_color
operator|=
literal|0xff
expr_stmt|;
name|regcmd
operator|->
name|aux_color
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cmd
operator|->
name|srcBitmap
operator|.
name|depth
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|pmask
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
condition|)
break|break;
if|if
condition|(
name|i
operator|>=
name|cmd
operator|->
name|srcBitmap
operator|.
name|depth
condition|)
return|return
literal|0
return|;
name|regcmd
operator|->
name|srcBitmap
operator|.
name|base
operator|+=
operator|(
name|lens
operator|>>
literal|1
operator|)
operator|*
name|i
expr_stmt|;
name|error
operator|=
name|dobitblt
argument_list|(
name|fbp
argument_list|,
operator|&
name|regcmd
operator|->
name|srcBitmap
argument_list|,
operator|&
name|regcmd
operator|->
name|destBitmap
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
elseif|else
if|if
condition|(
name|mode
operator|==
literal|1
condition|)
block|{
comment|/* 1 to N */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cmd
operator|->
name|srcBitmap
operator|.
name|depth
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|error
operator|=
name|dobitblt
argument_list|(
name|fbp
argument_list|,
operator|&
name|regcmd
operator|->
name|srcBitmap
argument_list|,
operator|&
name|regcmd
operator|->
name|destBitmap
argument_list|)
condition|)
return|return
name|error
return|;
name|regcmd
operator|->
name|planemask
operator|>>=
literal|1
expr_stmt|;
name|regcmd
operator|->
name|fore_color
operator|>>=
literal|1
expr_stmt|;
name|regcmd
operator|->
name|aux_color
operator|>>=
literal|1
expr_stmt|;
name|regcmd
operator|->
name|destBitmap
operator|.
name|base
operator|+=
name|lend
operator|>>
literal|1
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
else|else
block|{
comment|/* N to N */
name|regcmd
operator|->
name|fore_color
operator|=
literal|0xff
expr_stmt|;
name|regcmd
operator|->
name|aux_color
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cmd
operator|->
name|srcBitmap
operator|.
name|depth
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|error
operator|=
name|dobitblt
argument_list|(
name|fbp
argument_list|,
operator|&
name|regcmd
operator|->
name|srcBitmap
argument_list|,
operator|&
name|regcmd
operator|->
name|destBitmap
argument_list|)
condition|)
return|return
name|error
return|;
name|regcmd
operator|->
name|srcBitmap
operator|.
name|base
operator|+=
name|lens
operator|>>
literal|1
expr_stmt|;
name|regcmd
operator|->
name|destBitmap
operator|.
name|base
operator|+=
name|lend
operator|>>
literal|1
expr_stmt|;
name|regcmd
operator|->
name|planemask
operator|>>=
literal|1
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
break|break;
default|default:
return|return
name|EINVAL
return|;
block|}
return|return
name|error
return|;
block|}
end_block

begin_expr_stmt
name|fbnbatchbitblt
argument_list|(
name|fbp
argument_list|,
name|cmd
argument_list|,
name|seg
argument_list|)
specifier|register
expr|struct
name|fbreg
operator|*
name|fbp
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|lBatchBitblt
modifier|*
name|cmd
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|seg
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|error
decl_stmt|;
specifier|register
name|int
name|mode
decl_stmt|;
specifier|register
name|int
name|len
decl_stmt|;
ifdef|#
directive|ifdef
name|CPU_DOUBLE
name|int
name|blttype
init|=
name|BLTTYPE
argument_list|(
name|cmd
operator|->
name|srcBitmap
operator|.
name|type
argument_list|,
name|cmd
operator|->
name|destBitmap
operator|.
name|type
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|blttype
operator|==
name|BLTTYPE
argument_list|(
name|BM_MEM
argument_list|,
name|BM_MEM
argument_list|)
operator|)
operator|||
operator|(
name|blttype
operator|==
name|BLTTYPE
argument_list|(
name|BM_0
argument_list|,
name|BM_MEM
argument_list|)
operator|)
operator|||
operator|(
name|blttype
operator|==
name|BLTTYPE
argument_list|(
name|BM_1
argument_list|,
name|BM_MEM
argument_list|)
operator|)
condition|)
block|{
return|return
operator|(
name|mfbnbatchbitblt
argument_list|(
name|fbp
argument_list|,
name|cmd
argument_list|,
name|seg
argument_list|)
operator|)
return|;
comment|/* notreached */
block|}
endif|#
directive|endif
name|fbinitlock
argument_list|()
expr_stmt|;
name|fbp
operator|->
name|fb_command
operator|=
name|FB_CBATCHBITBLT
expr_stmt|;
name|fbp
operator|->
name|fb_batchbitblt
operator|=
operator|*
name|cmd
expr_stmt|;
if|if
condition|(
name|error
operator|=
name|checkbitmap
argument_list|(
operator|&
name|cmd
operator|->
name|srcBitmap
argument_list|)
condition|)
return|return
name|error
return|;
if|if
condition|(
name|error
operator|=
name|checkbitmap
argument_list|(
operator|&
name|cmd
operator|->
name|destBitmap
argument_list|)
condition|)
return|return
name|error
return|;
if|if
condition|(
operator|(
name|mode
operator|=
name|checkdepth
argument_list|(
operator|&
name|cmd
operator|->
name|srcBitmap
argument_list|,
operator|&
name|cmd
operator|->
name|destBitmap
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|EINVAL
return|;
ifdef|#
directive|ifdef
name|CPU_SINGLE
if|if
condition|(
operator|(
name|len
operator|=
name|cmd
operator|->
name|nSrcDest
operator|*
sizeof|sizeof
argument_list|(
name|lSrcDest
argument_list|)
operator|)
operator|<=
literal|0
condition|)
return|return
name|EINVAL
return|;
if|if
condition|(
name|error
operator|=
name|fblockmem
argument_list|(
operator|(
name|caddr_t
operator|)
name|cmd
operator|->
name|srcDestList
argument_list|,
name|len
argument_list|,
name|B_WRITE
argument_list|,
name|fbmap
operator|+
literal|2
argument_list|,
name|seg
argument_list|)
condition|)
return|return
name|error
return|;
name|fbp
operator|->
name|fb_batchbitblt
operator|.
name|srcDestList
operator|=
operator|(
name|lSrcDest
operator|*
operator|)
name|ipc_phys
argument_list|(
name|fbmap
operator|+
literal|2
argument_list|)
expr_stmt|;
name|error
operator|=
name|procbatchbitblt
argument_list|(
name|fbp
argument_list|,
name|mode
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
else|#
directive|else
name|fbp
operator|->
name|fb_batchbitblt
operator|.
name|srcDestList
operator|=
operator|(
name|lSrcDest
operator|*
operator|)
name|ipc_phys
argument_list|(
name|srcdestlist
argument_list|)
expr_stmt|;
while|while
condition|(
name|cmd
operator|->
name|nSrcDest
operator|>
literal|0
condition|)
block|{
name|len
operator|=
name|min
argument_list|(
name|cmd
operator|->
name|nSrcDest
argument_list|,
operator|(
name|MAX_SIZE
operator|/
sizeof|sizeof
argument_list|(
name|lSrcDest
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|COPYIN
argument_list|(
operator|(
name|caddr_t
operator|)
name|cmd
operator|->
name|srcDestList
argument_list|,
operator|(
name|caddr_t
operator|)
name|srcdestlist
argument_list|,
name|len
operator|*
sizeof|sizeof
argument_list|(
name|lSrcDest
argument_list|)
argument_list|,
name|seg
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
name|cmd
operator|->
name|nSrcDest
operator|-=
name|len
expr_stmt|;
name|cmd
operator|->
name|srcDestList
operator|+=
name|len
expr_stmt|;
name|fbp
operator|->
name|fb_batchbitblt
operator|.
name|nSrcDest
operator|=
name|len
expr_stmt|;
if|if
condition|(
name|error
operator|=
name|procbatchbitblt
argument_list|(
name|fbp
argument_list|,
name|mode
argument_list|,
name|cmd
argument_list|)
condition|)
return|return
name|error
return|;
block|}
endif|#
directive|endif
comment|/* CPU_DOUBLE */
return|return
name|error
return|;
block|}
end_block

begin_macro
name|fbbatchbitblt
argument_list|(
argument|fbp
argument_list|,
argument|cmd
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|fbreg
modifier|*
name|fbp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|sBatchBitblt
modifier|*
name|cmd
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|lBatchBitblt
name|lcmd
decl_stmt|;
specifier|register
name|lBatchBitblt
modifier|*
name|lcmdp
decl_stmt|;
specifier|static
name|lSrcDest
name|ls
index|[
literal|100
index|]
decl_stmt|;
specifier|register
name|lSrcDest
modifier|*
name|lp
decl_stmt|;
specifier|register
name|sSrcDest
modifier|*
name|sp
decl_stmt|;
specifier|register
name|int
name|ns
decl_stmt|;
name|lcmdp
operator|=
operator|&
name|lcmd
expr_stmt|;
name|lcmdp
operator|->
name|func
operator|=
name|cmd
operator|->
name|func
expr_stmt|;
name|lcmdp
operator|->
name|transp
operator|=
name|cmd
operator|->
name|transp
expr_stmt|;
name|lcmdp
operator|->
name|fore_color
operator|=
name|cmd
operator|->
name|fore_color
expr_stmt|;
name|lcmdp
operator|->
name|aux_color
operator|=
name|cmd
operator|->
name|aux_color
expr_stmt|;
name|lcmdp
operator|->
name|planemask
operator|=
name|cmd
operator|->
name|planemask
expr_stmt|;
name|lcmdp
operator|->
name|srcBitmap
operator|.
name|type
operator|=
name|cmd
operator|->
name|srcBitmap
operator|.
name|type
expr_stmt|;
name|lcmdp
operator|->
name|srcBitmap
operator|.
name|depth
operator|=
name|cmd
operator|->
name|srcBitmap
operator|.
name|depth
expr_stmt|;
name|lcmdp
operator|->
name|srcBitmap
operator|.
name|width
operator|=
name|cmd
operator|->
name|srcBitmap
operator|.
name|width
expr_stmt|;
name|lcmdp
operator|->
name|srcBitmap
operator|.
name|rect
operator|.
name|origin
operator|.
name|x
operator|=
name|cmd
operator|->
name|srcBitmap
operator|.
name|rect
operator|.
name|origin
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|srcBitmap
operator|.
name|rect
operator|.
name|origin
operator|.
name|y
operator|=
name|cmd
operator|->
name|srcBitmap
operator|.
name|rect
operator|.
name|origin
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|srcBitmap
operator|.
name|rect
operator|.
name|extent
operator|.
name|x
operator|=
name|cmd
operator|->
name|srcBitmap
operator|.
name|rect
operator|.
name|extent
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|srcBitmap
operator|.
name|rect
operator|.
name|extent
operator|.
name|y
operator|=
name|cmd
operator|->
name|srcBitmap
operator|.
name|rect
operator|.
name|extent
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|srcBitmap
operator|.
name|base
operator|=
name|cmd
operator|->
name|srcBitmap
operator|.
name|base
expr_stmt|;
name|lcmdp
operator|->
name|destBitmap
operator|.
name|type
operator|=
name|cmd
operator|->
name|destBitmap
operator|.
name|type
expr_stmt|;
name|lcmdp
operator|->
name|destBitmap
operator|.
name|depth
operator|=
name|cmd
operator|->
name|destBitmap
operator|.
name|depth
expr_stmt|;
name|lcmdp
operator|->
name|destBitmap
operator|.
name|width
operator|=
name|cmd
operator|->
name|destBitmap
operator|.
name|width
expr_stmt|;
name|lcmdp
operator|->
name|destBitmap
operator|.
name|rect
operator|.
name|origin
operator|.
name|x
operator|=
name|cmd
operator|->
name|destBitmap
operator|.
name|rect
operator|.
name|origin
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|destBitmap
operator|.
name|rect
operator|.
name|origin
operator|.
name|y
operator|=
name|cmd
operator|->
name|destBitmap
operator|.
name|rect
operator|.
name|origin
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|destBitmap
operator|.
name|rect
operator|.
name|extent
operator|.
name|x
operator|=
name|cmd
operator|->
name|destBitmap
operator|.
name|rect
operator|.
name|extent
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|destBitmap
operator|.
name|rect
operator|.
name|extent
operator|.
name|y
operator|=
name|cmd
operator|->
name|destBitmap
operator|.
name|rect
operator|.
name|extent
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|destBitmap
operator|.
name|base
operator|=
name|cmd
operator|->
name|destBitmap
operator|.
name|base
expr_stmt|;
name|lcmdp
operator|->
name|destClip
operator|.
name|origin
operator|.
name|x
operator|=
name|cmd
operator|->
name|destClip
operator|.
name|origin
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|destClip
operator|.
name|origin
operator|.
name|y
operator|=
name|cmd
operator|->
name|destClip
operator|.
name|origin
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|destClip
operator|.
name|extent
operator|.
name|x
operator|=
name|cmd
operator|->
name|destClip
operator|.
name|extent
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|destClip
operator|.
name|extent
operator|.
name|y
operator|=
name|cmd
operator|->
name|destClip
operator|.
name|extent
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|srcDestList
operator|=
name|ls
expr_stmt|;
name|sp
operator|=
operator|(
name|sSrcDest
operator|*
operator|)
name|cmd
operator|->
name|srcDestList
expr_stmt|;
while|while
condition|(
name|cmd
operator|->
name|nSrcDest
condition|)
block|{
name|lcmdp
operator|->
name|nSrcDest
operator|=
name|ns
operator|=
name|min
argument_list|(
name|cmd
operator|->
name|nSrcDest
argument_list|,
literal|100
argument_list|)
expr_stmt|;
name|cmd
operator|->
name|nSrcDest
operator|-=
name|ns
expr_stmt|;
name|lp
operator|=
name|ls
expr_stmt|;
while|while
condition|(
name|ns
operator|--
operator|>
literal|0
condition|)
block|{
name|int
name|error
decl_stmt|;
name|sSrcDest
name|tmp
decl_stmt|;
name|error
operator|=
name|copyin
argument_list|(
operator|(
name|caddr_t
operator|)
name|sp
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|tmp
argument_list|,
sizeof|sizeof
argument_list|(
name|tmp
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|lp
operator|->
name|srcRect
operator|.
name|origin
operator|.
name|x
operator|=
name|tmp
operator|.
name|srcRect
operator|.
name|origin
operator|.
name|x
expr_stmt|;
name|lp
operator|->
name|srcRect
operator|.
name|origin
operator|.
name|y
operator|=
name|tmp
operator|.
name|srcRect
operator|.
name|origin
operator|.
name|y
expr_stmt|;
name|lp
operator|->
name|srcRect
operator|.
name|extent
operator|.
name|x
operator|=
name|tmp
operator|.
name|srcRect
operator|.
name|extent
operator|.
name|x
expr_stmt|;
name|lp
operator|->
name|srcRect
operator|.
name|extent
operator|.
name|y
operator|=
name|tmp
operator|.
name|srcRect
operator|.
name|extent
operator|.
name|y
expr_stmt|;
name|lp
operator|->
name|destPoint
operator|.
name|x
operator|=
name|tmp
operator|.
name|destPoint
operator|.
name|x
expr_stmt|;
name|lp
operator|->
name|destPoint
operator|.
name|y
operator|=
name|tmp
operator|.
name|destPoint
operator|.
name|y
expr_stmt|;
name|lp
operator|++
expr_stmt|;
name|sp
operator|++
expr_stmt|;
block|}
name|fbnbatchbitblt
argument_list|(
name|fbp
argument_list|,
name|lcmdp
argument_list|,
name|UIO_SYSSPACE
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_expr_stmt
name|fbntilebitblt
argument_list|(
name|fbp
argument_list|,
name|cmd
argument_list|)
specifier|register
expr|struct
name|fbreg
operator|*
name|fbp
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|lTileBitblt
modifier|*
name|cmd
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|lTileBitblt
modifier|*
name|regcmd
decl_stmt|;
specifier|register
name|int
name|len
decl_stmt|,
name|lens
decl_stmt|,
name|lend
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
name|int
name|mode
decl_stmt|;
name|int
name|pmask
decl_stmt|;
name|int
name|error
decl_stmt|;
name|int
name|blttype
init|=
name|BLTTYPE
argument_list|(
name|cmd
operator|->
name|ptnBitmap
operator|.
name|type
argument_list|,
name|cmd
operator|->
name|destBitmap
operator|.
name|type
argument_list|)
decl_stmt|;
ifdef|#
directive|ifdef
name|CPU_DOUBLE
if|if
condition|(
operator|(
name|blttype
operator|==
name|BLTTYPE
argument_list|(
name|BM_MEM
argument_list|,
name|BM_MEM
argument_list|)
operator|)
operator|||
operator|(
name|blttype
operator|==
name|BLTTYPE
argument_list|(
name|BM_0
argument_list|,
name|BM_MEM
argument_list|)
operator|)
operator|||
operator|(
name|blttype
operator|==
name|BLTTYPE
argument_list|(
name|BM_1
argument_list|,
name|BM_MEM
argument_list|)
operator|)
condition|)
block|{
return|return
operator|(
name|mfbntilebitblt
argument_list|(
name|fbp
argument_list|,
name|cmd
argument_list|)
operator|)
return|;
comment|/* NOTREACHED */
block|}
endif|#
directive|endif
if|if
condition|(
name|error
operator|=
name|checkbitmap
argument_list|(
operator|&
name|cmd
operator|->
name|ptnBitmap
argument_list|)
condition|)
return|return
name|error
return|;
if|if
condition|(
name|error
operator|=
name|checkbitmap
argument_list|(
operator|&
name|cmd
operator|->
name|destBitmap
argument_list|)
condition|)
return|return
name|error
return|;
if|if
condition|(
operator|(
name|mode
operator|=
name|checkdepth
argument_list|(
operator|&
name|cmd
operator|->
name|ptnBitmap
argument_list|,
operator|&
name|cmd
operator|->
name|destBitmap
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|EINVAL
return|;
name|fbp
operator|->
name|fb_command
operator|=
name|FB_CTILEBITBLT
expr_stmt|;
name|fbp
operator|->
name|fb_tilebitblt
operator|=
operator|*
name|cmd
expr_stmt|;
name|regcmd
operator|=
operator|&
name|fbp
operator|->
name|fb_tilebitblt
expr_stmt|;
comment|/* process bitblt command */
switch|switch
condition|(
name|blttype
condition|)
block|{
case|case
name|BLTTYPE
argument_list|(
name|BM_FB
argument_list|,
name|BM_FB
argument_list|)
case|:
case|case
name|BLTTYPE
argument_list|(
name|BM_0
argument_list|,
name|BM_FB
argument_list|)
case|:
case|case
name|BLTTYPE
argument_list|(
name|BM_1
argument_list|,
name|BM_FB
argument_list|)
case|:
name|fbstart
argument_list|(
name|fbp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|BLTTYPE
argument_list|(
name|BM_FB
argument_list|,
name|BM_MEM
argument_list|)
case|:
case|case
name|BLTTYPE
argument_list|(
name|BM_0
argument_list|,
name|BM_MEM
argument_list|)
case|:
case|case
name|BLTTYPE
argument_list|(
name|BM_1
argument_list|,
name|BM_MEM
argument_list|)
case|:
name|len
operator|=
name|cmd
operator|->
name|destBitmap
operator|.
name|width
operator|*
name|cmd
operator|->
name|destBitmap
operator|.
name|rect
operator|.
name|extent
operator|.
name|y
operator|<<
literal|1
expr_stmt|;
if|if
condition|(
name|len
operator|*
name|cmd
operator|->
name|destBitmap
operator|.
name|depth
operator|<=
name|FB_MAX_IO
condition|)
block|{
name|error
operator|=
name|dobitblt
argument_list|(
name|fbp
argument_list|,
operator|&
name|regcmd
operator|->
name|ptnBitmap
argument_list|,
operator|&
name|regcmd
operator|->
name|destBitmap
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
comment|/* bitblt each plane */
name|regcmd
operator|->
name|destBitmap
operator|.
name|depth
operator|=
literal|1
expr_stmt|;
name|pmask
operator|=
name|regcmd
operator|->
name|planemask
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cmd
operator|->
name|destBitmap
operator|.
name|depth
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|mode
operator|==
literal|3
condition|)
comment|/* N to N */
name|regcmd
operator|->
name|planemask
operator|=
name|pmask
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
expr_stmt|;
if|if
condition|(
name|error
operator|=
name|dobitblt
argument_list|(
name|fbp
argument_list|,
operator|&
name|regcmd
operator|->
name|ptnBitmap
argument_list|,
operator|&
name|regcmd
operator|->
name|destBitmap
argument_list|)
condition|)
return|return
name|error
return|;
name|regcmd
operator|->
name|destBitmap
operator|.
name|base
operator|+=
name|len
operator|>>
literal|1
expr_stmt|;
if|if
condition|(
name|mode
operator|==
literal|1
condition|)
block|{
comment|/* N to N */
name|regcmd
operator|->
name|planemask
operator|>>=
literal|1
expr_stmt|;
name|regcmd
operator|->
name|fore_color
operator|>>=
literal|1
expr_stmt|;
name|regcmd
operator|->
name|aux_color
operator|>>=
literal|1
expr_stmt|;
block|}
block|}
break|break;
case|case
name|BLTTYPE
argument_list|(
name|BM_MEM
argument_list|,
name|BM_FB
argument_list|)
case|:
name|len
operator|=
name|cmd
operator|->
name|ptnBitmap
operator|.
name|width
operator|*
name|cmd
operator|->
name|ptnBitmap
operator|.
name|rect
operator|.
name|extent
operator|.
name|y
operator|<<
literal|1
expr_stmt|;
if|if
condition|(
name|len
operator|*
name|cmd
operator|->
name|ptnBitmap
operator|.
name|depth
operator|<=
name|FB_MAX_IO
condition|)
block|{
name|error
operator|=
name|dobitblt
argument_list|(
name|fbp
argument_list|,
operator|&
name|regcmd
operator|->
name|ptnBitmap
argument_list|,
operator|&
name|regcmd
operator|->
name|destBitmap
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
comment|/* bitblt each plane */
name|regcmd
operator|->
name|ptnBitmap
operator|.
name|depth
operator|=
literal|1
expr_stmt|;
name|pmask
operator|=
name|regcmd
operator|->
name|planemask
expr_stmt|;
name|regcmd
operator|->
name|fore_color
operator|=
literal|0xff
expr_stmt|;
name|regcmd
operator|->
name|aux_color
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|mode
operator|==
literal|2
condition|)
block|{
comment|/* N to 1 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cmd
operator|->
name|ptnBitmap
operator|.
name|depth
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|pmask
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
condition|)
break|break;
if|if
condition|(
name|i
operator|>=
name|cmd
operator|->
name|ptnBitmap
operator|.
name|depth
condition|)
return|return
literal|0
return|;
name|regcmd
operator|->
name|ptnBitmap
operator|.
name|base
operator|+=
operator|(
name|len
operator|>>
literal|1
operator|)
operator|*
name|i
expr_stmt|;
name|error
operator|=
name|dobitblt
argument_list|(
name|fbp
argument_list|,
operator|&
name|regcmd
operator|->
name|ptnBitmap
argument_list|,
operator|&
name|regcmd
operator|->
name|destBitmap
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
comment|/* else (N to N) */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cmd
operator|->
name|ptnBitmap
operator|.
name|depth
condition|;
name|i
operator|++
control|)
block|{
name|regcmd
operator|->
name|planemask
operator|=
name|pmask
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
expr_stmt|;
if|if
condition|(
name|error
operator|=
name|dobitblt
argument_list|(
name|fbp
argument_list|,
operator|&
name|regcmd
operator|->
name|ptnBitmap
argument_list|,
operator|&
name|regcmd
operator|->
name|destBitmap
argument_list|)
condition|)
return|return
name|error
return|;
name|regcmd
operator|->
name|ptnBitmap
operator|.
name|base
operator|+=
name|len
operator|>>
literal|1
expr_stmt|;
name|regcmd
operator|->
name|planemask
operator|>>=
literal|1
expr_stmt|;
block|}
return|return
literal|0
return|;
case|case
name|BLTTYPE
argument_list|(
name|BM_MEM
argument_list|,
name|BM_MEM
argument_list|)
case|:
name|lens
operator|=
name|cmd
operator|->
name|ptnBitmap
operator|.
name|width
operator|*
name|cmd
operator|->
name|ptnBitmap
operator|.
name|rect
operator|.
name|extent
operator|.
name|y
operator|<<
literal|1
expr_stmt|;
name|lend
operator|=
name|cmd
operator|->
name|destBitmap
operator|.
name|width
operator|*
name|cmd
operator|->
name|destBitmap
operator|.
name|rect
operator|.
name|extent
operator|.
name|y
operator|<<
literal|1
expr_stmt|;
if|if
condition|(
name|lens
operator|*
name|cmd
operator|->
name|ptnBitmap
operator|.
name|depth
operator|<=
name|FB_MAX_IO
operator|&&
name|lend
operator|*
name|cmd
operator|->
name|destBitmap
operator|.
name|depth
operator|<=
name|FB_MAX_IO
condition|)
block|{
name|error
operator|=
name|dobitblt
argument_list|(
name|fbp
argument_list|,
operator|&
name|regcmd
operator|->
name|ptnBitmap
argument_list|,
operator|&
name|regcmd
operator|->
name|destBitmap
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
name|regcmd
operator|->
name|ptnBitmap
operator|.
name|depth
operator|=
literal|1
expr_stmt|;
name|regcmd
operator|->
name|destBitmap
operator|.
name|depth
operator|=
literal|1
expr_stmt|;
name|pmask
operator|=
name|regcmd
operator|->
name|planemask
expr_stmt|;
if|if
condition|(
name|mode
operator|==
literal|2
condition|)
block|{
comment|/* N to 1 */
name|regcmd
operator|->
name|fore_color
operator|=
literal|0xff
expr_stmt|;
name|regcmd
operator|->
name|aux_color
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cmd
operator|->
name|ptnBitmap
operator|.
name|depth
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|pmask
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
condition|)
break|break;
if|if
condition|(
name|i
operator|>=
name|cmd
operator|->
name|ptnBitmap
operator|.
name|depth
condition|)
return|return
literal|0
return|;
name|regcmd
operator|->
name|ptnBitmap
operator|.
name|base
operator|+=
operator|(
name|lens
operator|>>
literal|1
operator|)
operator|*
name|i
expr_stmt|;
name|error
operator|=
name|dobitblt
argument_list|(
name|fbp
argument_list|,
operator|&
name|regcmd
operator|->
name|ptnBitmap
argument_list|,
operator|&
name|regcmd
operator|->
name|destBitmap
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
elseif|else
if|if
condition|(
name|mode
operator|==
literal|1
condition|)
block|{
comment|/* 1 to N */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cmd
operator|->
name|ptnBitmap
operator|.
name|depth
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|error
operator|=
name|dobitblt
argument_list|(
name|fbp
argument_list|,
operator|&
name|regcmd
operator|->
name|ptnBitmap
argument_list|,
operator|&
name|regcmd
operator|->
name|destBitmap
argument_list|)
condition|)
return|return
name|error
return|;
name|regcmd
operator|->
name|planemask
operator|>>=
literal|1
expr_stmt|;
name|regcmd
operator|->
name|fore_color
operator|>>=
literal|1
expr_stmt|;
name|regcmd
operator|->
name|aux_color
operator|>>=
literal|1
expr_stmt|;
name|regcmd
operator|->
name|destBitmap
operator|.
name|base
operator|+=
name|lend
operator|>>
literal|1
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
else|else
block|{
comment|/* N to N */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cmd
operator|->
name|ptnBitmap
operator|.
name|depth
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|error
operator|=
name|dobitblt
argument_list|(
name|fbp
argument_list|,
operator|&
name|regcmd
operator|->
name|ptnBitmap
argument_list|,
operator|&
name|regcmd
operator|->
name|destBitmap
argument_list|)
condition|)
return|return
name|error
return|;
name|regcmd
operator|->
name|ptnBitmap
operator|.
name|base
operator|+=
name|lens
operator|>>
literal|1
expr_stmt|;
name|regcmd
operator|->
name|destBitmap
operator|.
name|base
operator|+=
name|lend
operator|>>
literal|1
expr_stmt|;
name|regcmd
operator|->
name|planemask
operator|>>=
literal|1
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
break|break;
default|default:
return|return
name|EINVAL
return|;
block|}
return|return
name|error
return|;
block|}
end_block

begin_macro
name|fbtilebitblt
argument_list|(
argument|fbp
argument_list|,
argument|cmd
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|fbreg
modifier|*
name|fbp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|sTileBitblt
modifier|*
name|cmd
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|lTileBitblt
name|lcmd
decl_stmt|;
specifier|register
name|lTileBitblt
modifier|*
name|lcmdp
decl_stmt|;
name|lcmdp
operator|=
operator|&
name|lcmd
expr_stmt|;
name|lcmdp
operator|->
name|func
operator|=
name|cmd
operator|->
name|func
expr_stmt|;
name|lcmdp
operator|->
name|transp
operator|=
name|cmd
operator|->
name|transp
expr_stmt|;
name|lcmdp
operator|->
name|fore_color
operator|=
name|cmd
operator|->
name|fore_color
expr_stmt|;
name|lcmdp
operator|->
name|aux_color
operator|=
name|cmd
operator|->
name|aux_color
expr_stmt|;
name|lcmdp
operator|->
name|planemask
operator|=
name|cmd
operator|->
name|planemask
expr_stmt|;
name|lcmdp
operator|->
name|ptnBitmap
operator|.
name|type
operator|=
name|cmd
operator|->
name|ptnBitmap
operator|.
name|type
expr_stmt|;
name|lcmdp
operator|->
name|ptnBitmap
operator|.
name|depth
operator|=
name|cmd
operator|->
name|ptnBitmap
operator|.
name|depth
expr_stmt|;
name|lcmdp
operator|->
name|ptnBitmap
operator|.
name|width
operator|=
name|cmd
operator|->
name|ptnBitmap
operator|.
name|width
expr_stmt|;
name|lcmdp
operator|->
name|ptnBitmap
operator|.
name|rect
operator|.
name|origin
operator|.
name|x
operator|=
name|cmd
operator|->
name|ptnBitmap
operator|.
name|rect
operator|.
name|origin
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|ptnBitmap
operator|.
name|rect
operator|.
name|origin
operator|.
name|y
operator|=
name|cmd
operator|->
name|ptnBitmap
operator|.
name|rect
operator|.
name|origin
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|ptnBitmap
operator|.
name|rect
operator|.
name|extent
operator|.
name|x
operator|=
name|cmd
operator|->
name|ptnBitmap
operator|.
name|rect
operator|.
name|extent
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|ptnBitmap
operator|.
name|rect
operator|.
name|extent
operator|.
name|y
operator|=
name|cmd
operator|->
name|ptnBitmap
operator|.
name|rect
operator|.
name|extent
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|ptnBitmap
operator|.
name|base
operator|=
name|cmd
operator|->
name|ptnBitmap
operator|.
name|base
expr_stmt|;
name|lcmdp
operator|->
name|ptnRect
operator|.
name|origin
operator|.
name|x
operator|=
name|cmd
operator|->
name|ptnRect
operator|.
name|origin
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|ptnRect
operator|.
name|origin
operator|.
name|y
operator|=
name|cmd
operator|->
name|ptnRect
operator|.
name|origin
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|ptnRect
operator|.
name|extent
operator|.
name|x
operator|=
name|cmd
operator|->
name|ptnRect
operator|.
name|extent
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|ptnRect
operator|.
name|extent
operator|.
name|y
operator|=
name|cmd
operator|->
name|ptnRect
operator|.
name|extent
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|refPoint
operator|.
name|x
operator|=
name|cmd
operator|->
name|refPoint
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|refPoint
operator|.
name|y
operator|=
name|cmd
operator|->
name|refPoint
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|destBitmap
operator|.
name|type
operator|=
name|cmd
operator|->
name|destBitmap
operator|.
name|type
expr_stmt|;
name|lcmdp
operator|->
name|destBitmap
operator|.
name|depth
operator|=
name|cmd
operator|->
name|destBitmap
operator|.
name|depth
expr_stmt|;
name|lcmdp
operator|->
name|destBitmap
operator|.
name|width
operator|=
name|cmd
operator|->
name|destBitmap
operator|.
name|width
expr_stmt|;
name|lcmdp
operator|->
name|destBitmap
operator|.
name|rect
operator|.
name|origin
operator|.
name|x
operator|=
name|cmd
operator|->
name|destBitmap
operator|.
name|rect
operator|.
name|origin
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|destBitmap
operator|.
name|rect
operator|.
name|origin
operator|.
name|y
operator|=
name|cmd
operator|->
name|destBitmap
operator|.
name|rect
operator|.
name|origin
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|destBitmap
operator|.
name|rect
operator|.
name|extent
operator|.
name|x
operator|=
name|cmd
operator|->
name|destBitmap
operator|.
name|rect
operator|.
name|extent
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|destBitmap
operator|.
name|rect
operator|.
name|extent
operator|.
name|y
operator|=
name|cmd
operator|->
name|destBitmap
operator|.
name|rect
operator|.
name|extent
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|destBitmap
operator|.
name|base
operator|=
name|cmd
operator|->
name|destBitmap
operator|.
name|base
expr_stmt|;
name|lcmdp
operator|->
name|destClip
operator|.
name|origin
operator|.
name|x
operator|=
name|cmd
operator|->
name|destClip
operator|.
name|origin
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|destClip
operator|.
name|origin
operator|.
name|y
operator|=
name|cmd
operator|->
name|destClip
operator|.
name|origin
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|destClip
operator|.
name|extent
operator|.
name|x
operator|=
name|cmd
operator|->
name|destClip
operator|.
name|extent
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|destClip
operator|.
name|extent
operator|.
name|y
operator|=
name|cmd
operator|->
name|destClip
operator|.
name|extent
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|destRect
operator|.
name|origin
operator|.
name|x
operator|=
name|cmd
operator|->
name|destRect
operator|.
name|origin
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|destRect
operator|.
name|origin
operator|.
name|y
operator|=
name|cmd
operator|->
name|destRect
operator|.
name|origin
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|destRect
operator|.
name|extent
operator|.
name|x
operator|=
name|cmd
operator|->
name|destRect
operator|.
name|extent
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|destRect
operator|.
name|extent
operator|.
name|y
operator|=
name|cmd
operator|->
name|destRect
operator|.
name|extent
operator|.
name|y
expr_stmt|;
return|return
operator|(
name|fbntilebitblt
argument_list|(
name|fbp
argument_list|,
name|lcmdp
argument_list|)
operator|)
return|;
block|}
end_block

begin_comment
comment|/* ARGSUSED */
end_comment

begin_macro
name|fbbitblt3
argument_list|(
argument|fbp
argument_list|,
argument|cmd
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|fbreg
modifier|*
name|fbp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|sBitblt3
modifier|*
name|cmd
decl_stmt|;
end_decl_stmt

begin_block
block|{
return|return
name|ENXIO
return|;
block|}
end_block

begin_comment
comment|/* ARGSUSED */
end_comment

begin_macro
name|fbnbitblt3
argument_list|(
argument|fbp
argument_list|,
argument|cmd
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|fbreg
modifier|*
name|fbp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|lBitblt3
modifier|*
name|cmd
decl_stmt|;
end_decl_stmt

begin_block
block|{
return|return
name|ENXIO
return|;
block|}
end_block

begin_macro
name|fbnpolyline
argument_list|(
argument|fbp
argument_list|,
argument|cmd
argument_list|,
argument|dj
argument_list|,
argument|seg
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|fbreg
modifier|*
name|fbp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|lPrimLine
modifier|*
name|cmd
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|dj
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* if not zero, disjoint polyline */
end_comment

begin_decl_stmt
name|int
name|seg
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|error
init|=
literal|0
decl_stmt|;
specifier|register
name|int
name|len
decl_stmt|;
ifdef|#
directive|ifdef
name|CPU_DOUBLE
if|if
condition|(
name|cmd
operator|->
name|drawBM
operator|.
name|type
operator|==
name|BM_MEM
condition|)
block|{
return|return
operator|(
name|mfbnpolyline
argument_list|(
name|fbp
argument_list|,
name|cmd
argument_list|,
name|dj
argument_list|,
name|seg
argument_list|)
operator|)
return|;
comment|/* NOTREACHED */
block|}
endif|#
directive|endif
name|fbinitlock
argument_list|()
expr_stmt|;
name|fbp
operator|->
name|fb_command
operator|=
name|dj
condition|?
name|FB_CDJPOLYLINE
else|:
name|FB_CPOLYLINE
expr_stmt|;
name|fbp
operator|->
name|fb_polyline
operator|=
operator|*
name|cmd
expr_stmt|;
if|if
condition|(
operator|(
name|cmd
operator|->
name|np
operator|&
literal|1
operator|)
operator|&&
name|dj
condition|)
return|return
name|EINVAL
return|;
ifdef|#
directive|ifdef
name|CPU_SINGLE
if|if
condition|(
name|error
operator|=
name|fblocksbitmap
argument_list|(
operator|&
name|fbp
operator|->
name|fb_polyline
operator|.
name|drawBM
argument_list|,
name|B_READ
argument_list|,
name|fbmap
argument_list|)
condition|)
return|return
name|error
return|;
if|if
condition|(
operator|(
name|len
operator|=
name|cmd
operator|->
name|np
operator|*
sizeof|sizeof
argument_list|(
name|lPoint
argument_list|)
operator|)
operator|<=
literal|0
condition|)
return|return
name|EINVAL
return|;
name|error
operator|=
name|fblockmem
argument_list|(
operator|(
name|caddr_t
operator|)
name|cmd
operator|->
name|plist
argument_list|,
name|len
argument_list|,
name|B_WRITE
argument_list|,
name|fbmap
operator|+
literal|1
argument_list|,
name|seg
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
name|fbp
operator|->
name|fb_polyline
operator|.
name|plist
operator|=
operator|(
name|lPoint
operator|*
operator|)
name|ipc_phys
argument_list|(
name|fbmap
operator|+
literal|1
argument_list|)
expr_stmt|;
name|fbdolock
argument_list|()
expr_stmt|;
name|fbstart
argument_list|(
name|fbp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|fbunlock
argument_list|()
expr_stmt|;
else|#
directive|else
comment|/* CPU_SINGLE */
name|fbp
operator|->
name|fb_polyline
operator|.
name|plist
operator|=
operator|(
name|lPoint
operator|*
operator|)
name|ipc_phys
argument_list|(
name|srcdestlist
argument_list|)
expr_stmt|;
while|while
condition|(
name|cmd
operator|->
name|np
operator|>
literal|0
condition|)
block|{
name|len
operator|=
name|min
argument_list|(
name|cmd
operator|->
name|np
argument_list|,
operator|(
operator|(
name|MAX_SIZE
operator|/
sizeof|sizeof
argument_list|(
name|lPoint
argument_list|)
operator|)
operator|&
operator|~
literal|1
operator|)
argument_list|)
expr_stmt|;
name|fbp
operator|->
name|fb_polyline
operator|.
name|np
operator|=
name|len
expr_stmt|;
if|if
condition|(
name|error
operator|=
name|COPYIN
argument_list|(
operator|(
name|caddr_t
operator|)
name|cmd
operator|->
name|plist
argument_list|,
operator|(
name|caddr_t
operator|)
name|srcdestlist
argument_list|,
name|len
operator|*
sizeof|sizeof
argument_list|(
name|lPoint
argument_list|)
argument_list|,
name|seg
argument_list|)
condition|)
block|{
return|return
name|error
return|;
block|}
name|cmd
operator|->
name|np
operator|-=
name|len
expr_stmt|;
name|cmd
operator|->
name|plist
operator|+=
name|len
expr_stmt|;
if|if
condition|(
name|fbp
operator|->
name|fb_polyline
operator|.
name|drawBM
operator|.
name|type
operator|==
name|BM_MEM
condition|)
block|{
if|if
condition|(
name|error
operator|=
name|fblocksbitmap
argument_list|(
operator|&
name|fbp
operator|->
name|fb_polyline
operator|.
name|drawBM
argument_list|,
name|B_READ
argument_list|,
name|fbmap
argument_list|)
condition|)
block|{
return|return
name|error
return|;
block|}
name|fbdolock
argument_list|()
expr_stmt|;
name|fbstart
argument_list|(
name|fbp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|fbunlock
argument_list|()
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cmd
operator|->
name|np
condition|)
name|fbstart
argument_list|(
name|fbp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
else|else
name|fbstart
argument_list|(
name|fbp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dj
operator|&&
name|cmd
operator|->
name|np
condition|)
block|{
name|cmd
operator|->
name|np
operator|++
expr_stmt|;
name|cmd
operator|->
name|plist
operator|--
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* CPU_SINGLE */
return|return
name|error
return|;
block|}
end_block

begin_macro
name|fbpolyline
argument_list|(
argument|fbp
argument_list|,
argument|cmd
argument_list|,
argument|dj
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|fbreg
modifier|*
name|fbp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|sPrimLine
modifier|*
name|cmd
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|dj
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|lPrimLine
name|lcmd
decl_stmt|;
specifier|register
name|lPrimLine
modifier|*
name|lcmdp
decl_stmt|;
specifier|static
name|lPoint
name|pl
index|[
literal|100
index|]
decl_stmt|;
specifier|register
name|lPoint
modifier|*
name|lp
decl_stmt|;
specifier|register
name|sPoint
modifier|*
name|sp
decl_stmt|;
specifier|register
name|int
name|np
decl_stmt|;
name|lcmdp
operator|=
operator|&
name|lcmd
expr_stmt|;
name|lcmdp
operator|->
name|func
operator|=
name|cmd
operator|->
name|func
expr_stmt|;
name|lcmdp
operator|->
name|transp
operator|=
name|cmd
operator|->
name|transp
expr_stmt|;
name|lcmdp
operator|->
name|fore_color
operator|=
name|cmd
operator|->
name|fore_color
expr_stmt|;
name|lcmdp
operator|->
name|aux_color
operator|=
name|cmd
operator|->
name|aux_color
expr_stmt|;
name|lcmdp
operator|->
name|planemask
operator|=
name|cmd
operator|->
name|planemask
expr_stmt|;
name|lcmdp
operator|->
name|drawBM
operator|.
name|type
operator|=
name|cmd
operator|->
name|drawBM
operator|.
name|type
expr_stmt|;
name|lcmdp
operator|->
name|drawBM
operator|.
name|depth
operator|=
name|cmd
operator|->
name|drawBM
operator|.
name|depth
expr_stmt|;
name|lcmdp
operator|->
name|drawBM
operator|.
name|width
operator|=
name|cmd
operator|->
name|drawBM
operator|.
name|width
expr_stmt|;
name|lcmdp
operator|->
name|drawBM
operator|.
name|rect
operator|.
name|origin
operator|.
name|x
operator|=
name|cmd
operator|->
name|drawBM
operator|.
name|rect
operator|.
name|origin
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|drawBM
operator|.
name|rect
operator|.
name|origin
operator|.
name|y
operator|=
name|cmd
operator|->
name|drawBM
operator|.
name|rect
operator|.
name|origin
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|drawBM
operator|.
name|rect
operator|.
name|extent
operator|.
name|x
operator|=
name|cmd
operator|->
name|drawBM
operator|.
name|rect
operator|.
name|extent
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|drawBM
operator|.
name|rect
operator|.
name|extent
operator|.
name|y
operator|=
name|cmd
operator|->
name|drawBM
operator|.
name|rect
operator|.
name|extent
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|drawBM
operator|.
name|base
operator|=
name|cmd
operator|->
name|drawBM
operator|.
name|base
expr_stmt|;
name|lcmdp
operator|->
name|clip
operator|.
name|origin
operator|.
name|x
operator|=
name|cmd
operator|->
name|clip
operator|.
name|origin
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|clip
operator|.
name|origin
operator|.
name|y
operator|=
name|cmd
operator|->
name|clip
operator|.
name|origin
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|clip
operator|.
name|extent
operator|.
name|x
operator|=
name|cmd
operator|->
name|clip
operator|.
name|extent
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|clip
operator|.
name|extent
operator|.
name|y
operator|=
name|cmd
operator|->
name|clip
operator|.
name|extent
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|lptn
operator|=
name|cmd
operator|->
name|lptn
expr_stmt|;
name|lcmdp
operator|->
name|dlpf
operator|=
name|cmd
operator|->
name|dlpf
expr_stmt|;
name|lcmdp
operator|->
name|plist
operator|=
name|pl
expr_stmt|;
name|sp
operator|=
operator|(
name|sPoint
operator|*
operator|)
name|cmd
operator|->
name|plist
expr_stmt|;
while|while
condition|(
name|cmd
operator|->
name|np
condition|)
block|{
name|lcmdp
operator|->
name|np
operator|=
name|np
operator|=
name|min
argument_list|(
name|cmd
operator|->
name|np
argument_list|,
literal|100
argument_list|)
expr_stmt|;
name|cmd
operator|->
name|np
operator|-=
name|np
expr_stmt|;
name|lp
operator|=
name|pl
expr_stmt|;
while|while
condition|(
name|np
operator|--
operator|>
literal|0
condition|)
block|{
name|int
name|error
decl_stmt|;
name|sPoint
name|tmp
decl_stmt|;
if|if
condition|(
name|error
operator|=
name|copyin
argument_list|(
operator|(
name|caddr_t
operator|)
name|sp
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|tmp
argument_list|,
sizeof|sizeof
argument_list|(
name|tmp
argument_list|)
argument_list|)
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|lp
operator|->
name|x
operator|=
name|tmp
operator|.
name|x
expr_stmt|;
name|lp
operator|->
name|y
operator|=
name|tmp
operator|.
name|y
expr_stmt|;
name|lp
operator|++
expr_stmt|;
name|sp
operator|++
expr_stmt|;
block|}
name|fbnpolyline
argument_list|(
name|fbp
argument_list|,
name|lcmdp
argument_list|,
name|dj
argument_list|,
name|UIO_SYSSPACE
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|fbnfillscan
argument_list|(
argument|fbp
argument_list|,
argument|cmd
argument_list|,
argument|seg
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|fbreg
modifier|*
name|fbp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|lPrimFill
modifier|*
name|cmd
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|seg
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|error
decl_stmt|;
specifier|register
name|int
name|len
decl_stmt|;
ifdef|#
directive|ifdef
name|CPU_DOUBLE
name|int
name|blttype
init|=
name|BLTTYPE
argument_list|(
name|cmd
operator|->
name|ptnBM
operator|.
name|type
argument_list|,
name|cmd
operator|->
name|drawBM
operator|.
name|type
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|blttype
operator|==
name|BLTTYPE
argument_list|(
name|BM_MEM
argument_list|,
name|BM_MEM
argument_list|)
operator|)
operator|||
operator|(
name|blttype
operator|==
name|BLTTYPE
argument_list|(
name|BM_0
argument_list|,
name|BM_MEM
argument_list|)
operator|)
operator|||
operator|(
name|blttype
operator|==
name|BLTTYPE
argument_list|(
name|BM_1
argument_list|,
name|BM_MEM
argument_list|)
operator|)
condition|)
block|{
return|return
operator|(
name|mfbnfillscan
argument_list|(
name|fbp
argument_list|,
name|cmd
argument_list|,
name|seg
argument_list|)
operator|)
return|;
comment|/* NOTREACHED */
block|}
endif|#
directive|endif
name|fbinitlock
argument_list|()
expr_stmt|;
name|fbp
operator|->
name|fb_command
operator|=
name|FB_CFILLSCAN
expr_stmt|;
name|fbp
operator|->
name|fb_fillscan
operator|=
operator|*
name|cmd
expr_stmt|;
ifdef|#
directive|ifdef
name|CPU_SINGLE
if|if
condition|(
name|error
operator|=
name|fblocksbitmap
argument_list|(
operator|&
name|fbp
operator|->
name|fb_fillscan
operator|.
name|ptnBM
argument_list|,
name|B_WRITE
argument_list|,
name|fbmap
argument_list|)
condition|)
return|return
name|error
return|;
if|if
condition|(
name|error
operator|=
name|fblocksbitmap
argument_list|(
operator|&
name|fbp
operator|->
name|fb_fillscan
operator|.
name|drawBM
argument_list|,
name|B_READ
argument_list|,
name|fbmap
operator|+
literal|1
argument_list|)
condition|)
return|return
name|error
return|;
if|if
condition|(
operator|(
name|len
operator|=
name|cmd
operator|->
name|nscan
operator|*
sizeof|sizeof
argument_list|(
name|lScanl
argument_list|)
operator|)
operator|<=
literal|0
condition|)
return|return
name|EINVAL
return|;
if|if
condition|(
name|error
operator|=
name|fblockmem
argument_list|(
name|cmd
operator|->
name|scan
argument_list|,
name|len
argument_list|,
name|B_WRITE
argument_list|,
name|fbmap
operator|+
literal|2
argument_list|,
name|seg
argument_list|)
condition|)
return|return
name|error
return|;
name|fbp
operator|->
name|fb_fillscan
operator|.
name|scan
operator|=
operator|(
name|lScanl
operator|*
operator|)
name|ipc_phys
argument_list|(
name|fbmap
operator|+
literal|2
argument_list|)
expr_stmt|;
name|fbdolock
argument_list|()
expr_stmt|;
name|fbstart
argument_list|(
name|fbp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|fbunlock
argument_list|()
expr_stmt|;
else|#
directive|else
comment|/* CPU_SINGLE */
name|fbp
operator|->
name|fb_fillscan
operator|.
name|scan
operator|=
operator|(
name|lScanl
operator|*
operator|)
name|ipc_phys
argument_list|(
name|srcdestlist
argument_list|)
expr_stmt|;
while|while
condition|(
name|cmd
operator|->
name|nscan
operator|>
literal|0
condition|)
block|{
name|len
operator|=
name|min
argument_list|(
name|cmd
operator|->
name|nscan
argument_list|,
operator|(
name|MAX_SIZE
operator|/
sizeof|sizeof
argument_list|(
name|lScanl
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|fbp
operator|->
name|fb_fillscan
operator|.
name|nscan
operator|=
name|len
expr_stmt|;
if|if
condition|(
name|error
operator|=
name|COPYIN
argument_list|(
operator|(
name|caddr_t
operator|)
name|cmd
operator|->
name|scan
argument_list|,
operator|(
name|caddr_t
operator|)
name|srcdestlist
argument_list|,
name|len
operator|*
sizeof|sizeof
argument_list|(
name|lScanl
argument_list|)
argument_list|,
name|seg
argument_list|)
condition|)
block|{
return|return
name|error
return|;
block|}
name|cmd
operator|->
name|nscan
operator|-=
name|len
expr_stmt|;
name|cmd
operator|->
name|scan
operator|+=
name|len
expr_stmt|;
if|if
condition|(
name|fbp
operator|->
name|fb_fillscan
operator|.
name|ptnBM
operator|.
name|type
operator|==
name|BM_MEM
operator|||
name|fbp
operator|->
name|fb_fillscan
operator|.
name|drawBM
operator|.
name|type
operator|==
name|BM_MEM
condition|)
block|{
if|if
condition|(
name|error
operator|=
name|fblocksbitmap
argument_list|(
operator|&
name|fbp
operator|->
name|fb_fillscan
operator|.
name|ptnBM
argument_list|,
name|B_WRITE
argument_list|,
name|fbmap
argument_list|)
condition|)
block|{
return|return
name|error
return|;
block|}
if|if
condition|(
name|error
operator|=
name|fblocksbitmap
argument_list|(
operator|&
name|fbp
operator|->
name|fb_fillscan
operator|.
name|drawBM
argument_list|,
name|B_READ
argument_list|,
name|fbmap
operator|+
literal|1
argument_list|)
condition|)
block|{
return|return
name|error
return|;
block|}
name|fbdolock
argument_list|()
expr_stmt|;
name|fbstart
argument_list|(
name|fbp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|fbunlock
argument_list|()
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cmd
operator|->
name|nscan
condition|)
name|fbstart
argument_list|(
name|fbp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
else|else
name|fbstart
argument_list|(
name|fbp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CPU_SINGLE */
return|return
name|error
return|;
block|}
end_block

begin_macro
name|fbfillscan
argument_list|(
argument|fbp
argument_list|,
argument|cmd
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|fbreg
modifier|*
name|fbp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|sPrimFill
modifier|*
name|cmd
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|lPrimFill
name|lcmd
decl_stmt|;
specifier|register
name|lPrimFill
modifier|*
name|lcmdp
decl_stmt|;
specifier|static
name|lScanl
name|ls
index|[
literal|100
index|]
decl_stmt|;
specifier|register
name|lScanl
modifier|*
name|lp
decl_stmt|;
specifier|register
name|sScanl
modifier|*
name|sp
decl_stmt|;
specifier|register
name|int
name|ns
decl_stmt|;
name|lcmdp
operator|=
operator|&
name|lcmd
expr_stmt|;
name|lcmdp
operator|->
name|func
operator|=
name|cmd
operator|->
name|func
expr_stmt|;
name|lcmdp
operator|->
name|transp
operator|=
name|cmd
operator|->
name|transp
expr_stmt|;
name|lcmdp
operator|->
name|fore_color
operator|=
name|cmd
operator|->
name|fore_color
expr_stmt|;
name|lcmdp
operator|->
name|aux_color
operator|=
name|cmd
operator|->
name|aux_color
expr_stmt|;
name|lcmdp
operator|->
name|planemask
operator|=
name|cmd
operator|->
name|planemask
expr_stmt|;
name|lcmdp
operator|->
name|refPoint
operator|.
name|x
operator|=
name|cmd
operator|->
name|refPoint
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|refPoint
operator|.
name|y
operator|=
name|cmd
operator|->
name|refPoint
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|ptnRect
operator|.
name|origin
operator|.
name|x
operator|=
name|cmd
operator|->
name|ptnRect
operator|.
name|origin
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|ptnRect
operator|.
name|origin
operator|.
name|y
operator|=
name|cmd
operator|->
name|ptnRect
operator|.
name|origin
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|ptnRect
operator|.
name|extent
operator|.
name|x
operator|=
name|cmd
operator|->
name|ptnRect
operator|.
name|extent
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|ptnRect
operator|.
name|extent
operator|.
name|y
operator|=
name|cmd
operator|->
name|ptnRect
operator|.
name|extent
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|ptnBM
operator|.
name|type
operator|=
name|cmd
operator|->
name|ptnBM
operator|.
name|type
expr_stmt|;
name|lcmdp
operator|->
name|ptnBM
operator|.
name|depth
operator|=
name|cmd
operator|->
name|ptnBM
operator|.
name|depth
expr_stmt|;
name|lcmdp
operator|->
name|ptnBM
operator|.
name|width
operator|=
name|cmd
operator|->
name|ptnBM
operator|.
name|width
expr_stmt|;
name|lcmdp
operator|->
name|ptnBM
operator|.
name|rect
operator|.
name|origin
operator|.
name|x
operator|=
name|cmd
operator|->
name|ptnBM
operator|.
name|rect
operator|.
name|origin
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|ptnBM
operator|.
name|rect
operator|.
name|origin
operator|.
name|y
operator|=
name|cmd
operator|->
name|ptnBM
operator|.
name|rect
operator|.
name|origin
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|ptnBM
operator|.
name|rect
operator|.
name|extent
operator|.
name|x
operator|=
name|cmd
operator|->
name|ptnBM
operator|.
name|rect
operator|.
name|extent
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|ptnBM
operator|.
name|rect
operator|.
name|extent
operator|.
name|y
operator|=
name|cmd
operator|->
name|ptnBM
operator|.
name|rect
operator|.
name|extent
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|ptnBM
operator|.
name|base
operator|=
name|cmd
operator|->
name|ptnBM
operator|.
name|base
expr_stmt|;
name|lcmdp
operator|->
name|drawBM
operator|.
name|type
operator|=
name|cmd
operator|->
name|drawBM
operator|.
name|type
expr_stmt|;
name|lcmdp
operator|->
name|drawBM
operator|.
name|depth
operator|=
name|cmd
operator|->
name|drawBM
operator|.
name|depth
expr_stmt|;
name|lcmdp
operator|->
name|drawBM
operator|.
name|width
operator|=
name|cmd
operator|->
name|drawBM
operator|.
name|width
expr_stmt|;
name|lcmdp
operator|->
name|drawBM
operator|.
name|rect
operator|.
name|origin
operator|.
name|x
operator|=
name|cmd
operator|->
name|drawBM
operator|.
name|rect
operator|.
name|origin
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|drawBM
operator|.
name|rect
operator|.
name|origin
operator|.
name|y
operator|=
name|cmd
operator|->
name|drawBM
operator|.
name|rect
operator|.
name|origin
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|drawBM
operator|.
name|rect
operator|.
name|extent
operator|.
name|x
operator|=
name|cmd
operator|->
name|drawBM
operator|.
name|rect
operator|.
name|extent
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|drawBM
operator|.
name|rect
operator|.
name|extent
operator|.
name|y
operator|=
name|cmd
operator|->
name|drawBM
operator|.
name|rect
operator|.
name|extent
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|drawBM
operator|.
name|base
operator|=
name|cmd
operator|->
name|drawBM
operator|.
name|base
expr_stmt|;
name|lcmdp
operator|->
name|clip
operator|.
name|origin
operator|.
name|x
operator|=
name|cmd
operator|->
name|clip
operator|.
name|origin
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|clip
operator|.
name|origin
operator|.
name|y
operator|=
name|cmd
operator|->
name|clip
operator|.
name|origin
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|clip
operator|.
name|extent
operator|.
name|x
operator|=
name|cmd
operator|->
name|clip
operator|.
name|extent
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|clip
operator|.
name|extent
operator|.
name|y
operator|=
name|cmd
operator|->
name|clip
operator|.
name|extent
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|scan
operator|=
name|ls
expr_stmt|;
name|sp
operator|=
operator|(
name|sScanl
operator|*
operator|)
name|cmd
operator|->
name|scan
expr_stmt|;
while|while
condition|(
name|cmd
operator|->
name|nscan
condition|)
block|{
name|lcmdp
operator|->
name|nscan
operator|=
name|ns
operator|=
name|min
argument_list|(
name|cmd
operator|->
name|nscan
argument_list|,
literal|100
argument_list|)
expr_stmt|;
name|cmd
operator|->
name|nscan
operator|-=
name|ns
expr_stmt|;
name|lp
operator|=
name|ls
expr_stmt|;
while|while
condition|(
name|ns
operator|--
operator|>
literal|0
condition|)
block|{
name|int
name|error
decl_stmt|;
name|sScanl
name|tmp
decl_stmt|;
if|if
condition|(
name|error
operator|=
name|copyin
argument_list|(
operator|(
name|caddr_t
operator|)
name|sp
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|tmp
argument_list|,
sizeof|sizeof
argument_list|(
name|tmp
argument_list|)
argument_list|)
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|lp
operator|->
name|x0
operator|=
name|tmp
operator|.
name|x0
expr_stmt|;
name|lp
operator|->
name|x1
operator|=
name|tmp
operator|.
name|x1
expr_stmt|;
name|lp
operator|->
name|y
operator|=
name|tmp
operator|.
name|y
expr_stmt|;
name|lp
operator|++
expr_stmt|;
name|sp
operator|++
expr_stmt|;
block|}
name|fbnfillscan
argument_list|(
name|fbp
argument_list|,
name|lcmdp
argument_list|,
name|UIO_SYSSPACE
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|fbnrectangle
argument_list|(
argument|fbp
argument_list|,
argument|cmd
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|fbreg
modifier|*
name|fbp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|lPrimRect
modifier|*
name|cmd
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|error
init|=
literal|0
decl_stmt|;
ifdef|#
directive|ifdef
name|CPU_DOUBLE
name|int
name|blttype
init|=
name|BLTTYPE
argument_list|(
name|cmd
operator|->
name|ptnBM
operator|.
name|type
argument_list|,
name|cmd
operator|->
name|drawBM
operator|.
name|type
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|blttype
operator|==
name|BLTTYPE
argument_list|(
name|BM_MEM
argument_list|,
name|BM_MEM
argument_list|)
operator|)
operator|||
operator|(
name|blttype
operator|==
name|BLTTYPE
argument_list|(
name|BM_0
argument_list|,
name|BM_MEM
argument_list|)
operator|)
operator|||
operator|(
name|blttype
operator|==
name|BLTTYPE
argument_list|(
name|BM_1
argument_list|,
name|BM_MEM
argument_list|)
operator|)
condition|)
block|{
return|return
operator|(
name|mfbnrectangle
argument_list|(
name|fbp
argument_list|,
name|cmd
argument_list|)
operator|)
return|;
comment|/* NOTREACHED */
block|}
endif|#
directive|endif
comment|/* CPU_DOUBLE */
name|fbinitlock
argument_list|()
expr_stmt|;
name|fbp
operator|->
name|fb_command
operator|=
name|FB_CRECTANGLE
expr_stmt|;
name|fbp
operator|->
name|fb_rectangle
operator|=
operator|*
name|cmd
expr_stmt|;
if|if
condition|(
name|error
operator|=
name|fblocksbitmap
argument_list|(
operator|&
name|fbp
operator|->
name|fb_rectangle
operator|.
name|drawBM
argument_list|,
name|B_READ
argument_list|,
name|fbmap
argument_list|)
condition|)
return|return
name|error
return|;
if|if
condition|(
name|error
operator|=
name|fblocksbitmap
argument_list|(
operator|&
name|fbp
operator|->
name|fb_rectangle
operator|.
name|ptnBM
argument_list|,
name|B_WRITE
argument_list|,
name|fbmap
operator|+
literal|1
argument_list|)
condition|)
return|return
name|error
return|;
if|if
condition|(
name|fbp
operator|->
name|fb_rectangle
operator|.
name|drawBM
operator|.
name|type
operator|==
name|BM_MEM
operator|||
name|fbp
operator|->
name|fb_rectangle
operator|.
name|ptnBM
operator|.
name|type
operator|==
name|BM_MEM
condition|)
block|{
name|fbdolock
argument_list|()
expr_stmt|;
name|fbstart
argument_list|(
name|fbp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|fbunlock
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|fbstart
argument_list|(
name|fbp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
return|return
name|error
return|;
block|}
end_block

begin_macro
name|fbrectangle
argument_list|(
argument|fbp
argument_list|,
argument|cmd
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|fbreg
modifier|*
name|fbp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|sPrimRect
modifier|*
name|cmd
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|lPrimRect
name|lcmd
decl_stmt|;
specifier|register
name|lPrimRect
modifier|*
name|lcmdp
decl_stmt|;
name|lcmdp
operator|=
operator|&
name|lcmd
expr_stmt|;
name|lcmdp
operator|->
name|func
operator|=
name|cmd
operator|->
name|func
expr_stmt|;
name|lcmdp
operator|->
name|transp
operator|=
name|cmd
operator|->
name|transp
expr_stmt|;
name|lcmdp
operator|->
name|fore_color
operator|=
name|cmd
operator|->
name|fore_color
expr_stmt|;
name|lcmdp
operator|->
name|aux_color
operator|=
name|cmd
operator|->
name|aux_color
expr_stmt|;
name|lcmdp
operator|->
name|planemask
operator|=
name|cmd
operator|->
name|planemask
expr_stmt|;
name|lcmdp
operator|->
name|rect
operator|.
name|origin
operator|.
name|x
operator|=
name|cmd
operator|->
name|rect
operator|.
name|origin
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|rect
operator|.
name|origin
operator|.
name|y
operator|=
name|cmd
operator|->
name|rect
operator|.
name|origin
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|rect
operator|.
name|extent
operator|.
name|x
operator|=
name|cmd
operator|->
name|rect
operator|.
name|extent
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|rect
operator|.
name|extent
operator|.
name|y
operator|=
name|cmd
operator|->
name|rect
operator|.
name|extent
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|refPoint
operator|.
name|x
operator|=
name|cmd
operator|->
name|refPoint
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|refPoint
operator|.
name|y
operator|=
name|cmd
operator|->
name|refPoint
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|ptnRect
operator|.
name|origin
operator|.
name|x
operator|=
name|cmd
operator|->
name|ptnRect
operator|.
name|origin
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|ptnRect
operator|.
name|origin
operator|.
name|y
operator|=
name|cmd
operator|->
name|ptnRect
operator|.
name|origin
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|ptnRect
operator|.
name|extent
operator|.
name|x
operator|=
name|cmd
operator|->
name|ptnRect
operator|.
name|extent
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|ptnRect
operator|.
name|extent
operator|.
name|y
operator|=
name|cmd
operator|->
name|ptnRect
operator|.
name|extent
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|ptnBM
operator|.
name|type
operator|=
name|cmd
operator|->
name|ptnBM
operator|.
name|type
expr_stmt|;
name|lcmdp
operator|->
name|ptnBM
operator|.
name|depth
operator|=
name|cmd
operator|->
name|ptnBM
operator|.
name|depth
expr_stmt|;
name|lcmdp
operator|->
name|ptnBM
operator|.
name|width
operator|=
name|cmd
operator|->
name|ptnBM
operator|.
name|width
expr_stmt|;
name|lcmdp
operator|->
name|ptnBM
operator|.
name|rect
operator|.
name|origin
operator|.
name|x
operator|=
name|cmd
operator|->
name|ptnBM
operator|.
name|rect
operator|.
name|origin
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|ptnBM
operator|.
name|rect
operator|.
name|origin
operator|.
name|y
operator|=
name|cmd
operator|->
name|ptnBM
operator|.
name|rect
operator|.
name|origin
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|ptnBM
operator|.
name|rect
operator|.
name|extent
operator|.
name|x
operator|=
name|cmd
operator|->
name|ptnBM
operator|.
name|rect
operator|.
name|extent
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|ptnBM
operator|.
name|rect
operator|.
name|extent
operator|.
name|y
operator|=
name|cmd
operator|->
name|ptnBM
operator|.
name|rect
operator|.
name|extent
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|ptnBM
operator|.
name|base
operator|=
name|cmd
operator|->
name|ptnBM
operator|.
name|base
expr_stmt|;
name|lcmdp
operator|->
name|drawBM
operator|.
name|type
operator|=
name|cmd
operator|->
name|drawBM
operator|.
name|type
expr_stmt|;
name|lcmdp
operator|->
name|drawBM
operator|.
name|depth
operator|=
name|cmd
operator|->
name|drawBM
operator|.
name|depth
expr_stmt|;
name|lcmdp
operator|->
name|drawBM
operator|.
name|width
operator|=
name|cmd
operator|->
name|drawBM
operator|.
name|width
expr_stmt|;
name|lcmdp
operator|->
name|drawBM
operator|.
name|rect
operator|.
name|origin
operator|.
name|x
operator|=
name|cmd
operator|->
name|drawBM
operator|.
name|rect
operator|.
name|origin
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|drawBM
operator|.
name|rect
operator|.
name|origin
operator|.
name|y
operator|=
name|cmd
operator|->
name|drawBM
operator|.
name|rect
operator|.
name|origin
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|drawBM
operator|.
name|rect
operator|.
name|extent
operator|.
name|x
operator|=
name|cmd
operator|->
name|drawBM
operator|.
name|rect
operator|.
name|extent
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|drawBM
operator|.
name|rect
operator|.
name|extent
operator|.
name|y
operator|=
name|cmd
operator|->
name|drawBM
operator|.
name|rect
operator|.
name|extent
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|drawBM
operator|.
name|base
operator|=
name|cmd
operator|->
name|drawBM
operator|.
name|base
expr_stmt|;
name|lcmdp
operator|->
name|clip
operator|.
name|origin
operator|.
name|x
operator|=
name|cmd
operator|->
name|clip
operator|.
name|origin
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|clip
operator|.
name|origin
operator|.
name|y
operator|=
name|cmd
operator|->
name|clip
operator|.
name|origin
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|clip
operator|.
name|extent
operator|.
name|x
operator|=
name|cmd
operator|->
name|clip
operator|.
name|extent
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|clip
operator|.
name|extent
operator|.
name|y
operator|=
name|cmd
operator|->
name|clip
operator|.
name|extent
operator|.
name|y
expr_stmt|;
return|return
operator|(
name|fbnrectangle
argument_list|(
name|fbp
argument_list|,
name|lcmdp
argument_list|)
operator|)
return|;
block|}
end_block

begin_expr_stmt
name|fbnpolymarker
argument_list|(
name|fbp
argument_list|,
name|cmd
argument_list|,
name|seg
argument_list|)
specifier|register
expr|struct
name|fbreg
operator|*
name|fbp
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|lPrimMarker
modifier|*
name|cmd
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|seg
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|error
decl_stmt|;
specifier|register
name|int
name|len
decl_stmt|;
ifdef|#
directive|ifdef
name|CPU_DOUBLE
name|int
name|blttype
init|=
name|BLTTYPE
argument_list|(
name|cmd
operator|->
name|ptnBM
operator|.
name|type
argument_list|,
name|cmd
operator|->
name|drawBM
operator|.
name|type
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|blttype
operator|==
name|BLTTYPE
argument_list|(
name|BM_MEM
argument_list|,
name|BM_MEM
argument_list|)
operator|)
operator|||
operator|(
name|blttype
operator|==
name|BLTTYPE
argument_list|(
name|BM_0
argument_list|,
name|BM_MEM
argument_list|)
operator|)
operator|||
operator|(
name|blttype
operator|==
name|BLTTYPE
argument_list|(
name|BM_1
argument_list|,
name|BM_MEM
argument_list|)
operator|)
condition|)
block|{
return|return
operator|(
name|mfbnpolymarker
argument_list|(
name|fbp
argument_list|,
name|cmd
argument_list|,
name|seg
argument_list|)
operator|)
return|;
comment|/* NOTREACHED */
block|}
endif|#
directive|endif
comment|/* CPU_DOUBLE */
name|fbinitlock
argument_list|()
expr_stmt|;
name|fbp
operator|->
name|fb_command
operator|=
name|FB_CPOLYMARKER
expr_stmt|;
name|fbp
operator|->
name|fb_polymarker
operator|=
operator|*
name|cmd
expr_stmt|;
ifdef|#
directive|ifdef
name|CPU_SINGLE
if|if
condition|(
name|error
operator|=
name|fblocksbitmap
argument_list|(
operator|&
name|fbp
operator|->
name|fb_polymarker
operator|.
name|ptnBM
argument_list|,
name|B_WRITE
argument_list|,
name|fbmap
argument_list|)
condition|)
return|return
name|error
return|;
if|if
condition|(
name|error
operator|=
name|fblocksbitmap
argument_list|(
operator|&
name|fbp
operator|->
name|fb_polymarker
operator|.
name|drawBM
argument_list|,
name|B_READ
argument_list|,
name|fbmap
operator|+
literal|1
argument_list|)
condition|)
return|return
name|error
return|;
if|if
condition|(
operator|(
name|len
operator|=
name|cmd
operator|->
name|np
operator|*
sizeof|sizeof
argument_list|(
name|lPoint
argument_list|)
operator|)
operator|<=
literal|0
condition|)
return|return
name|EINVAL
return|;
if|if
condition|(
name|error
operator|=
name|fblockmem
argument_list|(
name|cmd
operator|->
name|plist
argument_list|,
name|len
argument_list|,
name|B_WRITE
argument_list|,
name|fbmap
operator|+
literal|2
argument_list|,
name|seg
argument_list|)
condition|)
return|return
name|error
return|;
name|fbp
operator|->
name|fb_polymarker
operator|.
name|plist
operator|=
operator|(
name|lPoint
operator|*
operator|)
name|ipc_phys
argument_list|(
name|fbmap
operator|+
literal|2
argument_list|)
expr_stmt|;
name|fbdolock
argument_list|()
expr_stmt|;
name|fbstart
argument_list|(
name|fbp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|fbunlock
argument_list|()
expr_stmt|;
else|#
directive|else
comment|/* CPU_SINGLE */
name|fbp
operator|->
name|fb_polymarker
operator|.
name|plist
operator|=
operator|(
name|lPoint
operator|*
operator|)
name|ipc_phys
argument_list|(
name|srcdestlist
argument_list|)
expr_stmt|;
while|while
condition|(
name|cmd
operator|->
name|np
operator|>
literal|0
condition|)
block|{
name|len
operator|=
name|min
argument_list|(
name|cmd
operator|->
name|np
argument_list|,
operator|(
name|MAX_SIZE
operator|/
sizeof|sizeof
argument_list|(
name|lPoint
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|fbp
operator|->
name|fb_polymarker
operator|.
name|np
operator|=
name|len
expr_stmt|;
if|if
condition|(
name|error
operator|=
name|COPYIN
argument_list|(
operator|(
name|caddr_t
operator|)
name|cmd
operator|->
name|plist
argument_list|,
operator|(
name|caddr_t
operator|)
name|srcdestlist
argument_list|,
name|len
operator|*
sizeof|sizeof
argument_list|(
name|lPoint
argument_list|)
argument_list|,
name|seg
argument_list|)
condition|)
block|{
return|return
name|error
return|;
block|}
name|cmd
operator|->
name|np
operator|-=
name|len
expr_stmt|;
name|cmd
operator|->
name|plist
operator|+=
name|len
expr_stmt|;
if|if
condition|(
name|fbp
operator|->
name|fb_polymarker
operator|.
name|ptnBM
operator|.
name|type
operator|==
name|BM_MEM
operator|||
name|fbp
operator|->
name|fb_polymarker
operator|.
name|drawBM
operator|.
name|type
operator|==
name|BM_MEM
condition|)
block|{
if|if
condition|(
name|error
operator|=
name|fblocksbitmap
argument_list|(
operator|&
name|fbp
operator|->
name|fb_polymarker
operator|.
name|ptnBM
argument_list|,
name|B_WRITE
argument_list|,
name|fbmap
argument_list|)
condition|)
block|{
return|return
name|error
return|;
block|}
if|if
condition|(
name|error
operator|=
name|fblocksbitmap
argument_list|(
operator|&
name|fbp
operator|->
name|fb_polymarker
operator|.
name|drawBM
argument_list|,
name|B_READ
argument_list|,
name|fbmap
operator|+
literal|1
argument_list|)
condition|)
block|{
return|return
name|error
return|;
block|}
name|fbdolock
argument_list|()
expr_stmt|;
name|fbstart
argument_list|(
name|fbp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|fbunlock
argument_list|()
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cmd
operator|->
name|np
condition|)
name|fbstart
argument_list|(
name|fbp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
else|else
name|fbstart
argument_list|(
name|fbp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CPU_SINGLE */
return|return
name|error
return|;
block|}
end_block

begin_macro
name|fbpolymarker
argument_list|(
argument|fbp
argument_list|,
argument|cmd
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|fbreg
modifier|*
name|fbp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|sPrimMarker
modifier|*
name|cmd
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|lPrimMarker
name|lcmd
decl_stmt|;
specifier|register
name|lPrimMarker
modifier|*
name|lcmdp
decl_stmt|;
specifier|static
name|lPoint
name|pl
index|[
literal|100
index|]
decl_stmt|;
specifier|register
name|lPoint
modifier|*
name|lp
decl_stmt|;
specifier|register
name|sPoint
modifier|*
name|sp
decl_stmt|;
specifier|register
name|int
name|np
decl_stmt|;
name|lcmdp
operator|=
operator|&
name|lcmd
expr_stmt|;
name|lcmdp
operator|->
name|func
operator|=
name|cmd
operator|->
name|func
expr_stmt|;
name|lcmdp
operator|->
name|transp
operator|=
name|cmd
operator|->
name|transp
expr_stmt|;
name|lcmdp
operator|->
name|fore_color
operator|=
name|cmd
operator|->
name|fore_color
expr_stmt|;
name|lcmdp
operator|->
name|aux_color
operator|=
name|cmd
operator|->
name|aux_color
expr_stmt|;
name|lcmdp
operator|->
name|planemask
operator|=
name|cmd
operator|->
name|planemask
expr_stmt|;
name|lcmdp
operator|->
name|ptnRect
operator|.
name|origin
operator|.
name|x
operator|=
name|cmd
operator|->
name|ptnRect
operator|.
name|origin
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|ptnRect
operator|.
name|origin
operator|.
name|y
operator|=
name|cmd
operator|->
name|ptnRect
operator|.
name|origin
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|ptnRect
operator|.
name|extent
operator|.
name|x
operator|=
name|cmd
operator|->
name|ptnRect
operator|.
name|extent
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|ptnRect
operator|.
name|extent
operator|.
name|y
operator|=
name|cmd
operator|->
name|ptnRect
operator|.
name|extent
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|ptnBM
operator|.
name|type
operator|=
name|cmd
operator|->
name|ptnBM
operator|.
name|type
expr_stmt|;
name|lcmdp
operator|->
name|ptnBM
operator|.
name|depth
operator|=
name|cmd
operator|->
name|ptnBM
operator|.
name|depth
expr_stmt|;
name|lcmdp
operator|->
name|ptnBM
operator|.
name|width
operator|=
name|cmd
operator|->
name|ptnBM
operator|.
name|width
expr_stmt|;
name|lcmdp
operator|->
name|ptnBM
operator|.
name|rect
operator|.
name|origin
operator|.
name|x
operator|=
name|cmd
operator|->
name|ptnBM
operator|.
name|rect
operator|.
name|origin
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|ptnBM
operator|.
name|rect
operator|.
name|origin
operator|.
name|y
operator|=
name|cmd
operator|->
name|ptnBM
operator|.
name|rect
operator|.
name|origin
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|ptnBM
operator|.
name|rect
operator|.
name|extent
operator|.
name|x
operator|=
name|cmd
operator|->
name|ptnBM
operator|.
name|rect
operator|.
name|extent
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|ptnBM
operator|.
name|rect
operator|.
name|extent
operator|.
name|y
operator|=
name|cmd
operator|->
name|ptnBM
operator|.
name|rect
operator|.
name|extent
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|ptnBM
operator|.
name|base
operator|=
name|cmd
operator|->
name|ptnBM
operator|.
name|base
expr_stmt|;
name|lcmdp
operator|->
name|drawBM
operator|.
name|type
operator|=
name|cmd
operator|->
name|drawBM
operator|.
name|type
expr_stmt|;
name|lcmdp
operator|->
name|drawBM
operator|.
name|depth
operator|=
name|cmd
operator|->
name|drawBM
operator|.
name|depth
expr_stmt|;
name|lcmdp
operator|->
name|drawBM
operator|.
name|width
operator|=
name|cmd
operator|->
name|drawBM
operator|.
name|width
expr_stmt|;
name|lcmdp
operator|->
name|drawBM
operator|.
name|rect
operator|.
name|origin
operator|.
name|x
operator|=
name|cmd
operator|->
name|drawBM
operator|.
name|rect
operator|.
name|origin
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|drawBM
operator|.
name|rect
operator|.
name|origin
operator|.
name|y
operator|=
name|cmd
operator|->
name|drawBM
operator|.
name|rect
operator|.
name|origin
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|drawBM
operator|.
name|rect
operator|.
name|extent
operator|.
name|x
operator|=
name|cmd
operator|->
name|drawBM
operator|.
name|rect
operator|.
name|extent
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|drawBM
operator|.
name|rect
operator|.
name|extent
operator|.
name|y
operator|=
name|cmd
operator|->
name|drawBM
operator|.
name|rect
operator|.
name|extent
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|drawBM
operator|.
name|base
operator|=
name|cmd
operator|->
name|drawBM
operator|.
name|base
expr_stmt|;
name|lcmdp
operator|->
name|clip
operator|.
name|origin
operator|.
name|x
operator|=
name|cmd
operator|->
name|clip
operator|.
name|origin
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|clip
operator|.
name|origin
operator|.
name|y
operator|=
name|cmd
operator|->
name|clip
operator|.
name|origin
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|clip
operator|.
name|extent
operator|.
name|x
operator|=
name|cmd
operator|->
name|clip
operator|.
name|extent
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|clip
operator|.
name|extent
operator|.
name|y
operator|=
name|cmd
operator|->
name|clip
operator|.
name|extent
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|plist
operator|=
name|pl
expr_stmt|;
name|sp
operator|=
operator|(
name|sPoint
operator|*
operator|)
name|cmd
operator|->
name|plist
expr_stmt|;
while|while
condition|(
name|cmd
operator|->
name|np
condition|)
block|{
name|lcmdp
operator|->
name|np
operator|=
name|np
operator|=
name|min
argument_list|(
name|cmd
operator|->
name|np
argument_list|,
literal|100
argument_list|)
expr_stmt|;
name|cmd
operator|->
name|np
operator|-=
name|np
expr_stmt|;
while|while
condition|(
name|np
operator|--
operator|>
literal|0
condition|)
block|{
name|int
name|error
decl_stmt|;
name|sPoint
name|tmp
decl_stmt|;
if|if
condition|(
name|error
operator|=
name|copyin
argument_list|(
operator|(
name|caddr_t
operator|)
name|sp
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|tmp
argument_list|,
sizeof|sizeof
argument_list|(
name|tmp
argument_list|)
argument_list|)
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|lp
operator|->
name|x
operator|=
name|tmp
operator|.
name|x
expr_stmt|;
name|lp
operator|->
name|y
operator|=
name|tmp
operator|.
name|y
expr_stmt|;
name|lp
operator|++
expr_stmt|;
name|sp
operator|++
expr_stmt|;
block|}
name|fbnpolymarker
argument_list|(
name|fbp
argument_list|,
name|lcmdp
argument_list|,
name|UIO_SYSSPACE
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_expr_stmt
name|fbnpolydot
argument_list|(
name|fbp
argument_list|,
name|cmd
argument_list|,
name|seg
argument_list|)
specifier|register
expr|struct
name|fbreg
operator|*
name|fbp
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|lPrimDot
modifier|*
name|cmd
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|seg
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|error
decl_stmt|;
specifier|register
name|int
name|len
decl_stmt|;
ifdef|#
directive|ifdef
name|CPU_DOUBLE
if|if
condition|(
name|cmd
operator|->
name|drawBM
operator|.
name|type
operator|==
name|BM_MEM
condition|)
return|return
operator|(
name|mfbnpolydot
argument_list|(
name|fbp
argument_list|,
name|cmd
argument_list|,
name|seg
argument_list|)
operator|)
return|;
endif|#
directive|endif
name|fbinitlock
argument_list|()
expr_stmt|;
name|fbp
operator|->
name|fb_command
operator|=
name|FB_CPOLYDOT
expr_stmt|;
name|fbp
operator|->
name|fb_polydot
operator|=
operator|*
name|cmd
expr_stmt|;
ifdef|#
directive|ifdef
name|CPU_SINGLE
if|if
condition|(
name|error
operator|=
name|fblocksbitmap
argument_list|(
operator|&
name|fbp
operator|->
name|fb_polydot
operator|.
name|drawBM
argument_list|,
name|B_READ
argument_list|,
name|fbmap
operator|+
literal|1
argument_list|)
condition|)
return|return
name|error
return|;
if|if
condition|(
operator|(
name|len
operator|=
name|cmd
operator|->
name|np
operator|*
sizeof|sizeof
argument_list|(
name|lPoint
argument_list|)
operator|)
operator|<=
literal|0
condition|)
return|return
name|EINVAL
return|;
if|if
condition|(
name|error
operator|=
name|fblockmem
argument_list|(
name|cmd
operator|->
name|plist
argument_list|,
name|len
argument_list|,
name|B_WRITE
argument_list|,
name|fbmap
operator|+
literal|2
argument_list|,
name|seg
argument_list|)
condition|)
return|return
name|error
return|;
name|fbp
operator|->
name|fb_polydot
operator|.
name|plist
operator|=
operator|(
name|lPoint
operator|*
operator|)
name|ipc_phys
argument_list|(
name|fbmap
operator|+
literal|2
argument_list|)
expr_stmt|;
name|fbdolock
argument_list|()
expr_stmt|;
name|fbstart
argument_list|(
name|fbp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|fbunlock
argument_list|()
expr_stmt|;
else|#
directive|else
comment|/* CPU_SINGLE */
name|fbp
operator|->
name|fb_polydot
operator|.
name|plist
operator|=
operator|(
name|lPoint
operator|*
operator|)
name|ipc_phys
argument_list|(
name|srcdestlist
argument_list|)
expr_stmt|;
while|while
condition|(
name|cmd
operator|->
name|np
operator|>
literal|0
condition|)
block|{
name|len
operator|=
name|min
argument_list|(
name|cmd
operator|->
name|np
argument_list|,
operator|(
name|MAX_SIZE
operator|/
sizeof|sizeof
argument_list|(
name|lPoint
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|fbp
operator|->
name|fb_polydot
operator|.
name|np
operator|=
name|len
expr_stmt|;
if|if
condition|(
name|error
operator|=
name|COPYIN
argument_list|(
operator|(
name|caddr_t
operator|)
name|cmd
operator|->
name|plist
argument_list|,
operator|(
name|caddr_t
operator|)
name|srcdestlist
argument_list|,
name|len
operator|*
sizeof|sizeof
argument_list|(
name|lPoint
argument_list|)
argument_list|,
name|seg
argument_list|)
condition|)
block|{
return|return
name|error
return|;
block|}
name|cmd
operator|->
name|np
operator|-=
name|len
expr_stmt|;
name|cmd
operator|->
name|plist
operator|+=
name|len
expr_stmt|;
if|if
condition|(
name|fbp
operator|->
name|fb_polydot
operator|.
name|drawBM
operator|.
name|type
operator|==
name|BM_MEM
condition|)
block|{
if|if
condition|(
name|error
operator|=
name|fblocksbitmap
argument_list|(
operator|&
name|fbp
operator|->
name|fb_polydot
operator|.
name|drawBM
argument_list|,
name|B_READ
argument_list|,
name|fbmap
operator|+
literal|1
argument_list|)
condition|)
block|{
return|return
name|error
return|;
block|}
name|fbdolock
argument_list|()
expr_stmt|;
name|fbstart
argument_list|(
name|fbp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|fbunlock
argument_list|()
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cmd
operator|->
name|np
condition|)
name|fbstart
argument_list|(
name|fbp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
else|else
name|fbstart
argument_list|(
name|fbp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CPU_SINGLE */
return|return
name|error
return|;
block|}
end_block

begin_macro
name|fbpolydot
argument_list|(
argument|fbp
argument_list|,
argument|cmd
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|fbreg
modifier|*
name|fbp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|sPrimDot
modifier|*
name|cmd
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|lPrimDot
name|lcmd
decl_stmt|;
specifier|register
name|lPrimDot
modifier|*
name|lcmdp
decl_stmt|;
specifier|static
name|lPoint
name|pl
index|[
literal|100
index|]
decl_stmt|;
specifier|register
name|lPoint
modifier|*
name|lp
decl_stmt|;
specifier|register
name|sPoint
modifier|*
name|sp
decl_stmt|;
specifier|register
name|int
name|np
decl_stmt|;
name|lcmdp
operator|=
operator|&
name|lcmd
expr_stmt|;
name|lcmdp
operator|->
name|func
operator|=
name|cmd
operator|->
name|func
expr_stmt|;
name|lcmdp
operator|->
name|transp
operator|=
name|cmd
operator|->
name|transp
expr_stmt|;
name|lcmdp
operator|->
name|fore_color
operator|=
name|cmd
operator|->
name|fore_color
expr_stmt|;
name|lcmdp
operator|->
name|aux_color
operator|=
name|cmd
operator|->
name|aux_color
expr_stmt|;
name|lcmdp
operator|->
name|planemask
operator|=
name|cmd
operator|->
name|planemask
expr_stmt|;
name|lcmdp
operator|->
name|drawBM
operator|.
name|type
operator|=
name|cmd
operator|->
name|drawBM
operator|.
name|type
expr_stmt|;
name|lcmdp
operator|->
name|drawBM
operator|.
name|depth
operator|=
name|cmd
operator|->
name|drawBM
operator|.
name|depth
expr_stmt|;
name|lcmdp
operator|->
name|drawBM
operator|.
name|width
operator|=
name|cmd
operator|->
name|drawBM
operator|.
name|width
expr_stmt|;
name|lcmdp
operator|->
name|drawBM
operator|.
name|rect
operator|.
name|origin
operator|.
name|x
operator|=
name|cmd
operator|->
name|drawBM
operator|.
name|rect
operator|.
name|origin
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|drawBM
operator|.
name|rect
operator|.
name|origin
operator|.
name|y
operator|=
name|cmd
operator|->
name|drawBM
operator|.
name|rect
operator|.
name|origin
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|drawBM
operator|.
name|rect
operator|.
name|extent
operator|.
name|x
operator|=
name|cmd
operator|->
name|drawBM
operator|.
name|rect
operator|.
name|extent
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|drawBM
operator|.
name|rect
operator|.
name|extent
operator|.
name|y
operator|=
name|cmd
operator|->
name|drawBM
operator|.
name|rect
operator|.
name|extent
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|drawBM
operator|.
name|base
operator|=
name|cmd
operator|->
name|drawBM
operator|.
name|base
expr_stmt|;
name|lcmdp
operator|->
name|clip
operator|.
name|origin
operator|.
name|x
operator|=
name|cmd
operator|->
name|clip
operator|.
name|origin
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|clip
operator|.
name|origin
operator|.
name|y
operator|=
name|cmd
operator|->
name|clip
operator|.
name|origin
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|clip
operator|.
name|extent
operator|.
name|x
operator|=
name|cmd
operator|->
name|clip
operator|.
name|extent
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|clip
operator|.
name|extent
operator|.
name|y
operator|=
name|cmd
operator|->
name|clip
operator|.
name|extent
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|plist
operator|=
name|pl
expr_stmt|;
name|sp
operator|=
operator|(
name|sPoint
operator|*
operator|)
name|cmd
operator|->
name|plist
expr_stmt|;
while|while
condition|(
name|cmd
operator|->
name|np
condition|)
block|{
name|lcmdp
operator|->
name|np
operator|=
name|np
operator|=
name|min
argument_list|(
name|cmd
operator|->
name|np
argument_list|,
literal|100
argument_list|)
expr_stmt|;
name|cmd
operator|->
name|np
operator|-=
name|np
expr_stmt|;
while|while
condition|(
name|np
operator|--
operator|>
literal|0
condition|)
block|{
name|int
name|error
decl_stmt|;
name|sPoint
name|tmp
decl_stmt|;
if|if
condition|(
name|error
operator|=
name|copyin
argument_list|(
operator|(
name|caddr_t
operator|)
name|sp
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|tmp
argument_list|,
sizeof|sizeof
argument_list|(
name|tmp
argument_list|)
argument_list|)
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|lp
operator|->
name|x
operator|=
name|tmp
operator|.
name|x
expr_stmt|;
name|lp
operator|->
name|y
operator|=
name|tmp
operator|.
name|y
expr_stmt|;
name|lp
operator|++
expr_stmt|;
name|sp
operator|++
expr_stmt|;
block|}
name|fbnpolydot
argument_list|(
name|fbp
argument_list|,
name|lcmdp
argument_list|,
name|UIO_SYSSPACE
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_expr_stmt
name|fbntext
argument_list|(
name|fbp
argument_list|,
name|cmd
argument_list|)
specifier|register
expr|struct
name|fbreg
operator|*
name|fbp
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|lPrimText
modifier|*
name|cmd
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|error
decl_stmt|;
ifdef|#
directive|ifdef
name|CPU_DOUBLE
name|int
name|blttype
init|=
name|BLTTYPE
argument_list|(
name|cmd
operator|->
name|fontBM
operator|.
name|type
argument_list|,
name|cmd
operator|->
name|drawBM
operator|.
name|type
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|cmd
operator|->
name|type
operator|==
name|ASCII
operator|)
operator|&&
operator|(
operator|(
name|blttype
operator|==
name|BLTTYPE
argument_list|(
name|BM_MEM
argument_list|,
name|BM_MEM
argument_list|)
operator|)
operator|||
operator|(
name|blttype
operator|==
name|BLTTYPE
argument_list|(
name|BM_0
argument_list|,
name|BM_MEM
argument_list|)
operator|)
operator|||
operator|(
name|blttype
operator|==
name|BLTTYPE
argument_list|(
name|BM_1
argument_list|,
name|BM_MEM
argument_list|)
operator|)
operator|)
condition|)
block|{
return|return
operator|(
name|mfbntext
argument_list|(
name|fbp
argument_list|,
name|cmd
argument_list|)
operator|)
return|;
comment|/* NOTREACHED */
block|}
endif|#
directive|endif
comment|/* CPU_DOUBLE */
name|fbinitlock
argument_list|()
expr_stmt|;
name|fbp
operator|->
name|fb_command
operator|=
name|FB_CTEXT
expr_stmt|;
name|fbp
operator|->
name|fb_text
operator|=
operator|*
name|cmd
expr_stmt|;
if|if
condition|(
name|error
operator|=
name|fblocksbitmap
argument_list|(
operator|&
name|fbp
operator|->
name|fb_text
operator|.
name|drawBM
argument_list|,
name|B_READ
argument_list|,
name|fbmap
argument_list|)
condition|)
return|return
name|error
return|;
if|if
condition|(
name|cmd
operator|->
name|type
operator|==
name|ASCII
condition|)
block|{
if|if
condition|(
name|error
operator|=
name|fblocksbitmap
argument_list|(
operator|&
name|fbp
operator|->
name|fb_text
operator|.
name|fontBM
argument_list|,
name|B_WRITE
argument_list|,
name|fbmap
operator|+
literal|1
argument_list|)
condition|)
block|{
return|return
name|error
return|;
block|}
block|}
ifdef|#
directive|ifdef
name|CPU_SINGLE
if|if
condition|(
name|error
operator|=
name|fblockmem
argument_list|(
name|cmd
operator|->
name|str
argument_list|,
name|cmd
operator|->
name|len
argument_list|,
name|B_WRITE
argument_list|,
name|fbmap
operator|+
literal|2
argument_list|,
name|UIO_USERSPACE
argument_list|)
condition|)
return|return
name|error
return|;
name|fbp
operator|->
name|fb_text
operator|.
name|str
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|ipc_phys
argument_list|(
name|fbmap
operator|+
literal|2
argument_list|)
expr_stmt|;
name|fbdolock
argument_list|()
expr_stmt|;
name|fbstart
argument_list|(
name|fbp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|fbunlock
argument_list|()
expr_stmt|;
else|#
directive|else
comment|/* CPU_SINGLE */
name|fbp
operator|->
name|fb_text
operator|.
name|str
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|ipc_phys
argument_list|(
name|srcdestlist
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|=
name|COPYIN
argument_list|(
operator|(
name|caddr_t
operator|)
name|cmd
operator|->
name|str
argument_list|,
operator|(
name|caddr_t
operator|)
name|srcdestlist
argument_list|,
name|cmd
operator|->
name|len
argument_list|,
name|UIO_USERSPACE
argument_list|)
condition|)
block|{
return|return
name|error
return|;
block|}
if|if
condition|(
name|fbp
operator|->
name|fb_text
operator|.
name|drawBM
operator|.
name|type
operator|==
name|BM_MEM
operator|||
operator|(
name|cmd
operator|->
name|type
operator|==
name|ASCII
operator|&&
name|fbp
operator|->
name|fb_text
operator|.
name|fontBM
operator|.
name|type
operator|==
name|BM_MEM
operator|)
condition|)
block|{
name|fbdolock
argument_list|()
expr_stmt|;
name|fbstart
argument_list|(
name|fbp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|fbunlock
argument_list|()
expr_stmt|;
block|}
else|else
name|fbstart
argument_list|(
name|fbp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CPU_SINGLE */
return|return
name|error
return|;
block|}
end_block

begin_macro
name|fbtext
argument_list|(
argument|fbp
argument_list|,
argument|cmd
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|fbreg
modifier|*
name|fbp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|sPrimText
modifier|*
name|cmd
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|lPrimText
name|lcmd
decl_stmt|;
specifier|register
name|lPrimText
modifier|*
name|lcmdp
decl_stmt|;
name|lcmdp
operator|=
operator|&
name|lcmd
expr_stmt|;
name|lcmdp
operator|->
name|func
operator|=
name|cmd
operator|->
name|func
expr_stmt|;
name|lcmdp
operator|->
name|transp
operator|=
name|cmd
operator|->
name|transp
expr_stmt|;
name|lcmdp
operator|->
name|fore_color
operator|=
name|cmd
operator|->
name|fore_color
expr_stmt|;
name|lcmdp
operator|->
name|aux_color
operator|=
name|cmd
operator|->
name|aux_color
expr_stmt|;
name|lcmdp
operator|->
name|planemask
operator|=
name|cmd
operator|->
name|planemask
expr_stmt|;
name|lcmdp
operator|->
name|type
operator|=
name|cmd
operator|->
name|type
expr_stmt|;
name|lcmdp
operator|->
name|p
operator|.
name|x
operator|=
name|cmd
operator|->
name|p
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|p
operator|.
name|y
operator|=
name|cmd
operator|->
name|p
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|dx
operator|=
name|cmd
operator|->
name|dx
expr_stmt|;
name|lcmdp
operator|->
name|dy
operator|=
name|cmd
operator|->
name|dy
expr_stmt|;
name|lcmdp
operator|->
name|ex_factor
operator|=
name|cmd
operator|->
name|ex_factor
expr_stmt|;
name|lcmdp
operator|->
name|fp
operator|.
name|x
operator|=
name|cmd
operator|->
name|fp
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|fp
operator|.
name|y
operator|=
name|cmd
operator|->
name|fp
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|width
operator|=
name|cmd
operator|->
name|width
expr_stmt|;
name|lcmdp
operator|->
name|height
operator|=
name|cmd
operator|->
name|height
expr_stmt|;
name|lcmdp
operator|->
name|column
operator|=
name|cmd
operator|->
name|column
expr_stmt|;
name|lcmdp
operator|->
name|first_chr
operator|=
name|cmd
operator|->
name|first_chr
expr_stmt|;
name|lcmdp
operator|->
name|last_chr
operator|=
name|cmd
operator|->
name|last_chr
expr_stmt|;
name|lcmdp
operator|->
name|fontBM
operator|.
name|type
operator|=
name|cmd
operator|->
name|fontBM
operator|.
name|type
expr_stmt|;
name|lcmdp
operator|->
name|fontBM
operator|.
name|depth
operator|=
name|cmd
operator|->
name|fontBM
operator|.
name|depth
expr_stmt|;
name|lcmdp
operator|->
name|fontBM
operator|.
name|width
operator|=
name|cmd
operator|->
name|fontBM
operator|.
name|width
expr_stmt|;
name|lcmdp
operator|->
name|fontBM
operator|.
name|rect
operator|.
name|origin
operator|.
name|x
operator|=
name|cmd
operator|->
name|fontBM
operator|.
name|rect
operator|.
name|origin
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|fontBM
operator|.
name|rect
operator|.
name|origin
operator|.
name|y
operator|=
name|cmd
operator|->
name|fontBM
operator|.
name|rect
operator|.
name|origin
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|fontBM
operator|.
name|rect
operator|.
name|extent
operator|.
name|x
operator|=
name|cmd
operator|->
name|fontBM
operator|.
name|rect
operator|.
name|extent
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|fontBM
operator|.
name|rect
operator|.
name|extent
operator|.
name|y
operator|=
name|cmd
operator|->
name|fontBM
operator|.
name|rect
operator|.
name|extent
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|fontBM
operator|.
name|base
operator|=
name|cmd
operator|->
name|fontBM
operator|.
name|base
expr_stmt|;
name|lcmdp
operator|->
name|drawBM
operator|.
name|type
operator|=
name|cmd
operator|->
name|drawBM
operator|.
name|type
expr_stmt|;
name|lcmdp
operator|->
name|drawBM
operator|.
name|depth
operator|=
name|cmd
operator|->
name|drawBM
operator|.
name|depth
expr_stmt|;
name|lcmdp
operator|->
name|drawBM
operator|.
name|width
operator|=
name|cmd
operator|->
name|drawBM
operator|.
name|width
expr_stmt|;
name|lcmdp
operator|->
name|drawBM
operator|.
name|rect
operator|.
name|origin
operator|.
name|x
operator|=
name|cmd
operator|->
name|drawBM
operator|.
name|rect
operator|.
name|origin
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|drawBM
operator|.
name|rect
operator|.
name|origin
operator|.
name|y
operator|=
name|cmd
operator|->
name|drawBM
operator|.
name|rect
operator|.
name|origin
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|drawBM
operator|.
name|rect
operator|.
name|extent
operator|.
name|x
operator|=
name|cmd
operator|->
name|drawBM
operator|.
name|rect
operator|.
name|extent
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|drawBM
operator|.
name|rect
operator|.
name|extent
operator|.
name|y
operator|=
name|cmd
operator|->
name|drawBM
operator|.
name|rect
operator|.
name|extent
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|drawBM
operator|.
name|base
operator|=
name|cmd
operator|->
name|drawBM
operator|.
name|base
expr_stmt|;
name|lcmdp
operator|->
name|clip
operator|.
name|origin
operator|.
name|x
operator|=
name|cmd
operator|->
name|clip
operator|.
name|origin
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|clip
operator|.
name|origin
operator|.
name|y
operator|=
name|cmd
operator|->
name|clip
operator|.
name|origin
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|clip
operator|.
name|extent
operator|.
name|x
operator|=
name|cmd
operator|->
name|clip
operator|.
name|extent
operator|.
name|x
expr_stmt|;
name|lcmdp
operator|->
name|clip
operator|.
name|extent
operator|.
name|y
operator|=
name|cmd
operator|->
name|clip
operator|.
name|extent
operator|.
name|y
expr_stmt|;
name|lcmdp
operator|->
name|len
operator|=
name|cmd
operator|->
name|len
expr_stmt|;
name|lcmdp
operator|->
name|str
operator|=
name|cmd
operator|->
name|str
expr_stmt|;
return|return
operator|(
name|fbntext
argument_list|(
name|fbp
argument_list|,
name|lcmdp
argument_list|)
operator|)
return|;
block|}
end_block

begin_macro
name|fbsetcursor
argument_list|(
argument|fbp
argument_list|,
argument|data
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|fbreg
modifier|*
name|fbp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|sCursor
modifier|*
name|data
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|struct
name|fbreg
modifier|*
name|fbregp
decl_stmt|;
name|fbregp
operator|=
name|fbp
expr_stmt|;
name|fbregp
operator|->
name|fb_command
operator|=
name|FB_CSETCURSOR
expr_stmt|;
name|fbregp
operator|->
name|fb_cursor
operator|.
name|func
operator|=
name|data
operator|->
name|func
expr_stmt|;
name|fbregp
operator|->
name|fb_cursor
operator|.
name|cursor_color
operator|=
name|data
operator|->
name|cursor_color
expr_stmt|;
name|fbregp
operator|->
name|fb_cursor
operator|.
name|mask_color
operator|=
name|data
operator|->
name|mask_color
expr_stmt|;
name|fbregp
operator|->
name|fb_cursor
operator|.
name|hot
operator|.
name|x
operator|=
name|data
operator|->
name|hot
operator|.
name|x
expr_stmt|;
name|fbregp
operator|->
name|fb_cursor
operator|.
name|hot
operator|.
name|y
operator|=
name|data
operator|->
name|hot
operator|.
name|y
expr_stmt|;
name|fbregp
operator|->
name|fb_cursor
operator|.
name|size
operator|.
name|x
operator|=
name|data
operator|->
name|size
operator|.
name|x
expr_stmt|;
name|fbregp
operator|->
name|fb_cursor
operator|.
name|size
operator|.
name|y
operator|=
name|data
operator|->
name|size
operator|.
name|y
expr_stmt|;
name|fbregp
operator|->
name|fb_cursor
operator|.
name|cursorRect
operator|.
name|origin
operator|.
name|x
operator|=
name|data
operator|->
name|cursorRect
operator|.
name|origin
operator|.
name|x
expr_stmt|;
name|fbregp
operator|->
name|fb_cursor
operator|.
name|cursorRect
operator|.
name|origin
operator|.
name|y
operator|=
name|data
operator|->
name|cursorRect
operator|.
name|origin
operator|.
name|y
expr_stmt|;
name|fbregp
operator|->
name|fb_cursor
operator|.
name|cursorRect
operator|.
name|extent
operator|.
name|x
operator|=
name|data
operator|->
name|cursorRect
operator|.
name|extent
operator|.
name|x
expr_stmt|;
name|fbregp
operator|->
name|fb_cursor
operator|.
name|cursorRect
operator|.
name|extent
operator|.
name|y
operator|=
name|data
operator|->
name|cursorRect
operator|.
name|extent
operator|.
name|y
expr_stmt|;
name|fbregp
operator|->
name|fb_cursor
operator|.
name|maskRect
operator|.
name|origin
operator|.
name|x
operator|=
name|data
operator|->
name|maskRect
operator|.
name|origin
operator|.
name|x
expr_stmt|;
name|fbregp
operator|->
name|fb_cursor
operator|.
name|maskRect
operator|.
name|origin
operator|.
name|y
operator|=
name|data
operator|->
name|maskRect
operator|.
name|origin
operator|.
name|y
expr_stmt|;
name|fbregp
operator|->
name|fb_cursor
operator|.
name|maskRect
operator|.
name|extent
operator|.
name|x
operator|=
name|data
operator|->
name|maskRect
operator|.
name|extent
operator|.
name|x
expr_stmt|;
name|fbregp
operator|->
name|fb_cursor
operator|.
name|maskRect
operator|.
name|extent
operator|.
name|y
operator|=
name|data
operator|->
name|maskRect
operator|.
name|extent
operator|.
name|y
expr_stmt|;
name|fbregp
operator|->
name|fb_cursor
operator|.
name|saveRect
operator|.
name|origin
operator|.
name|x
operator|=
name|data
operator|->
name|saveRect
operator|.
name|origin
operator|.
name|x
expr_stmt|;
name|fbregp
operator|->
name|fb_cursor
operator|.
name|saveRect
operator|.
name|origin
operator|.
name|y
operator|=
name|data
operator|->
name|saveRect
operator|.
name|origin
operator|.
name|y
expr_stmt|;
name|fbregp
operator|->
name|fb_cursor
operator|.
name|saveRect
operator|.
name|extent
operator|.
name|x
operator|=
name|data
operator|->
name|saveRect
operator|.
name|extent
operator|.
name|x
expr_stmt|;
name|fbregp
operator|->
name|fb_cursor
operator|.
name|saveRect
operator|.
name|extent
operator|.
name|y
operator|=
name|data
operator|->
name|saveRect
operator|.
name|extent
operator|.
name|y
expr_stmt|;
name|fbregp
operator|->
name|fb_cursor
operator|.
name|moveArea
operator|.
name|origin
operator|.
name|x
operator|=
name|data
operator|->
name|moveArea
operator|.
name|origin
operator|.
name|x
expr_stmt|;
name|fbregp
operator|->
name|fb_cursor
operator|.
name|moveArea
operator|.
name|origin
operator|.
name|y
operator|=
name|data
operator|->
name|moveArea
operator|.
name|origin
operator|.
name|y
expr_stmt|;
name|fbregp
operator|->
name|fb_cursor
operator|.
name|moveArea
operator|.
name|extent
operator|.
name|x
operator|=
name|data
operator|->
name|moveArea
operator|.
name|extent
operator|.
name|x
expr_stmt|;
name|fbregp
operator|->
name|fb_cursor
operator|.
name|moveArea
operator|.
name|extent
operator|.
name|y
operator|=
name|data
operator|->
name|moveArea
operator|.
name|extent
operator|.
name|y
expr_stmt|;
name|fbstart
argument_list|(
name|fbp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_block

begin_macro
name|fbnsetcursor
argument_list|(
argument|fbp
argument_list|,
argument|data
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|fbreg
modifier|*
name|fbp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|lCursor
modifier|*
name|data
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|struct
name|fbreg
modifier|*
name|fbregp
decl_stmt|;
name|fbregp
operator|=
name|fbp
expr_stmt|;
name|fbregp
operator|->
name|fb_command
operator|=
name|FB_CSETCURSOR
expr_stmt|;
name|fbregp
operator|->
name|fb_cursor
operator|.
name|func
operator|=
name|data
operator|->
name|func
expr_stmt|;
name|fbregp
operator|->
name|fb_cursor
operator|.
name|cursor_color
operator|=
name|data
operator|->
name|cursor_color
expr_stmt|;
name|fbregp
operator|->
name|fb_cursor
operator|.
name|mask_color
operator|=
name|data
operator|->
name|mask_color
expr_stmt|;
name|fbregp
operator|->
name|fb_cursor
operator|.
name|hot
operator|.
name|x
operator|=
name|data
operator|->
name|hot
operator|.
name|x
expr_stmt|;
name|fbregp
operator|->
name|fb_cursor
operator|.
name|hot
operator|.
name|y
operator|=
name|data
operator|->
name|hot
operator|.
name|y
expr_stmt|;
name|fbregp
operator|->
name|fb_cursor
operator|.
name|size
operator|.
name|x
operator|=
name|data
operator|->
name|size
operator|.
name|x
expr_stmt|;
name|fbregp
operator|->
name|fb_cursor
operator|.
name|size
operator|.
name|y
operator|=
name|data
operator|->
name|size
operator|.
name|y
expr_stmt|;
name|fbregp
operator|->
name|fb_cursor
operator|.
name|cursorRect
operator|.
name|origin
operator|.
name|x
operator|=
name|data
operator|->
name|cursorRect
operator|.
name|origin
operator|.
name|x
expr_stmt|;
name|fbregp
operator|->
name|fb_cursor
operator|.
name|cursorRect
operator|.
name|origin
operator|.
name|y
operator|=
name|data
operator|->
name|cursorRect
operator|.
name|origin
operator|.
name|y
expr_stmt|;
name|fbregp
operator|->
name|fb_cursor
operator|.
name|cursorRect
operator|.
name|extent
operator|.
name|x
operator|=
name|data
operator|->
name|cursorRect
operator|.
name|extent
operator|.
name|x
expr_stmt|;
name|fbregp
operator|->
name|fb_cursor
operator|.
name|cursorRect
operator|.
name|extent
operator|.
name|y
operator|=
name|data
operator|->
name|cursorRect
operator|.
name|extent
operator|.
name|y
expr_stmt|;
name|fbregp
operator|->
name|fb_cursor
operator|.
name|maskRect
operator|.
name|origin
operator|.
name|x
operator|=
name|data
operator|->
name|maskRect
operator|.
name|origin
operator|.
name|x
expr_stmt|;
name|fbregp
operator|->
name|fb_cursor
operator|.
name|maskRect
operator|.
name|origin
operator|.
name|y
operator|=
name|data
operator|->
name|maskRect
operator|.
name|origin
operator|.
name|y
expr_stmt|;
name|fbregp
operator|->
name|fb_cursor
operator|.
name|maskRect
operator|.
name|extent
operator|.
name|x
operator|=
name|data
operator|->
name|maskRect
operator|.
name|extent
operator|.
name|x
expr_stmt|;
name|fbregp
operator|->
name|fb_cursor
operator|.
name|maskRect
operator|.
name|extent
operator|.
name|y
operator|=
name|data
operator|->
name|maskRect
operator|.
name|extent
operator|.
name|y
expr_stmt|;
name|fbregp
operator|->
name|fb_cursor
operator|.
name|saveRect
operator|.
name|origin
operator|.
name|x
operator|=
name|data
operator|->
name|saveRect
operator|.
name|origin
operator|.
name|x
expr_stmt|;
name|fbregp
operator|->
name|fb_cursor
operator|.
name|saveRect
operator|.
name|origin
operator|.
name|y
operator|=
name|data
operator|->
name|saveRect
operator|.
name|origin
operator|.
name|y
expr_stmt|;
name|fbregp
operator|->
name|fb_cursor
operator|.
name|saveRect
operator|.
name|extent
operator|.
name|x
operator|=
name|data
operator|->
name|saveRect
operator|.
name|extent
operator|.
name|x
expr_stmt|;
name|fbregp
operator|->
name|fb_cursor
operator|.
name|saveRect
operator|.
name|extent
operator|.
name|y
operator|=
name|data
operator|->
name|saveRect
operator|.
name|extent
operator|.
name|y
expr_stmt|;
name|fbregp
operator|->
name|fb_cursor
operator|.
name|moveArea
operator|.
name|origin
operator|.
name|x
operator|=
name|data
operator|->
name|moveArea
operator|.
name|origin
operator|.
name|x
expr_stmt|;
name|fbregp
operator|->
name|fb_cursor
operator|.
name|moveArea
operator|.
name|origin
operator|.
name|y
operator|=
name|data
operator|->
name|moveArea
operator|.
name|origin
operator|.
name|y
expr_stmt|;
name|fbregp
operator|->
name|fb_cursor
operator|.
name|moveArea
operator|.
name|extent
operator|.
name|x
operator|=
name|data
operator|->
name|moveArea
operator|.
name|extent
operator|.
name|x
expr_stmt|;
name|fbregp
operator|->
name|fb_cursor
operator|.
name|moveArea
operator|.
name|extent
operator|.
name|y
operator|=
name|data
operator|->
name|moveArea
operator|.
name|extent
operator|.
name|y
expr_stmt|;
name|fbstart
argument_list|(
name|fbp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_block

begin_macro
name|fbgetscrtype
argument_list|(
argument|fbp
argument_list|,
argument|data
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|fbreg
modifier|*
name|fbp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|sScrType
modifier|*
name|data
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|fbp
operator|->
name|fb_command
operator|=
name|FB_CGETSCRTYPE
expr_stmt|;
name|fbstart
argument_list|(
name|fbp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|data
operator|->
name|colorwidth
operator|=
name|fbp
operator|->
name|fb_scrtype
operator|.
name|colorwidth
expr_stmt|;
name|data
operator|->
name|plane
operator|=
name|fbp
operator|->
name|fb_scrtype
operator|.
name|plane
expr_stmt|;
name|data
operator|->
name|bufferrect
operator|.
name|origin
operator|.
name|x
operator|=
name|fbp
operator|->
name|fb_scrtype
operator|.
name|bufferrect
operator|.
name|origin
operator|.
name|x
expr_stmt|;
name|data
operator|->
name|bufferrect
operator|.
name|origin
operator|.
name|y
operator|=
name|fbp
operator|->
name|fb_scrtype
operator|.
name|bufferrect
operator|.
name|origin
operator|.
name|y
expr_stmt|;
name|data
operator|->
name|bufferrect
operator|.
name|extent
operator|.
name|x
operator|=
name|fbp
operator|->
name|fb_scrtype
operator|.
name|bufferrect
operator|.
name|extent
operator|.
name|x
expr_stmt|;
name|data
operator|->
name|bufferrect
operator|.
name|extent
operator|.
name|y
operator|=
name|fbp
operator|->
name|fb_scrtype
operator|.
name|bufferrect
operator|.
name|extent
operator|.
name|y
expr_stmt|;
name|data
operator|->
name|visiblerect
operator|.
name|origin
operator|.
name|x
operator|=
name|fbp
operator|->
name|fb_scrtype
operator|.
name|visiblerect
operator|.
name|origin
operator|.
name|x
expr_stmt|;
name|data
operator|->
name|visiblerect
operator|.
name|origin
operator|.
name|y
operator|=
name|fbp
operator|->
name|fb_scrtype
operator|.
name|visiblerect
operator|.
name|origin
operator|.
name|y
expr_stmt|;
name|data
operator|->
name|visiblerect
operator|.
name|extent
operator|.
name|x
operator|=
name|fbp
operator|->
name|fb_scrtype
operator|.
name|visiblerect
operator|.
name|extent
operator|.
name|x
expr_stmt|;
name|data
operator|->
name|visiblerect
operator|.
name|extent
operator|.
name|y
operator|=
name|fbp
operator|->
name|fb_scrtype
operator|.
name|visiblerect
operator|.
name|extent
operator|.
name|y
expr_stmt|;
return|return
literal|0
return|;
block|}
end_block

begin_macro
name|fbsetxy
argument_list|(
argument|fbp
argument_list|,
argument|data
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|fbreg
modifier|*
name|fbp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|sPoint
modifier|*
name|data
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|fbp
operator|->
name|fb_command
operator|=
name|FB_CSETXY
expr_stmt|;
name|fbp
operator|->
name|fb_point
operator|.
name|x
operator|=
name|data
operator|->
name|x
expr_stmt|;
name|fbp
operator|->
name|fb_point
operator|.
name|y
operator|=
name|data
operator|->
name|y
expr_stmt|;
name|fbstart
argument_list|(
name|fbp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_block

begin_macro
name|fbsetpalette
argument_list|(
argument|fbp
argument_list|,
argument|data
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|fbreg
modifier|*
name|fbp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|sPalette
modifier|*
name|data
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|lPalette
name|pal
decl_stmt|;
name|fbp
operator|->
name|fb_command
operator|=
name|FB_CSETPALETTE
expr_stmt|;
name|fbp
operator|->
name|fb_palette
operator|.
name|count
operator|=
literal|1
expr_stmt|;
operator|*
operator|(
name|sPalette
operator|*
operator|)
name|srcdestlist
operator|=
operator|*
name|data
expr_stmt|;
ifdef|#
directive|ifdef
name|CPU_SINGLE
name|fbmap
index|[
literal|0
index|]
operator|.
name|fm_vaddr
operator|=
operator|(
name|caddr_t
operator|)
name|srcdestlist
expr_stmt|;
name|fbmap
index|[
literal|0
index|]
operator|.
name|fm_offset
operator|=
literal|0
expr_stmt|;
name|fbp
operator|->
name|fb_palette
operator|.
name|palette
operator|=
operator|(
name|sPalette
operator|*
operator|)
name|ipc_phys
argument_list|(
name|fbmap
argument_list|)
expr_stmt|;
else|#
directive|else
name|fbp
operator|->
name|fb_palette
operator|.
name|palette
operator|=
operator|(
name|sPalette
operator|*
operator|)
name|ipc_phys
argument_list|(
name|srcdestlist
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|fbstart
argument_list|(
name|fbp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_block

begin_macro
name|fbnsetpalette
argument_list|(
argument|fbp
argument_list|,
argument|cmd
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|fbreg
modifier|*
name|fbp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|lPalette
modifier|*
name|cmd
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|error
decl_stmt|;
specifier|register
name|int
name|count
decl_stmt|;
ifdef|#
directive|ifdef
name|CPU_SINGLE
specifier|register
name|int
name|len
decl_stmt|;
endif|#
directive|endif
name|fbinitlock
argument_list|()
expr_stmt|;
name|fbp
operator|->
name|fb_command
operator|=
name|FB_CSETPALETTE
expr_stmt|;
ifdef|#
directive|ifdef
name|CPU_SINGLE
name|fbp
operator|->
name|fb_palette
operator|.
name|count
operator|=
name|cmd
operator|->
name|count
expr_stmt|;
if|if
condition|(
operator|(
name|len
operator|=
name|cmd
operator|->
name|count
operator|*
sizeof|sizeof
argument_list|(
name|sPalette
argument_list|)
operator|)
operator|<=
literal|0
condition|)
return|return
name|EINVAL
return|;
if|if
condition|(
name|error
operator|=
name|fblockmem
argument_list|(
name|cmd
operator|->
name|palette
argument_list|,
name|len
argument_list|,
name|B_WRITE
argument_list|,
name|fbmap
argument_list|,
name|UIO_USERSPACE
argument_list|)
condition|)
return|return
name|error
return|;
name|fbp
operator|->
name|fb_palette
operator|.
name|palette
operator|=
operator|(
name|sPalette
operator|*
operator|)
name|ipc_phys
argument_list|(
name|fbmap
argument_list|)
expr_stmt|;
name|fbdolock
argument_list|()
expr_stmt|;
name|fbstart
argument_list|(
name|fbp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|fbunlock
argument_list|()
expr_stmt|;
else|#
directive|else
comment|/* CPU_SINGLE */
name|fbp
operator|->
name|fb_palette
operator|.
name|palette
operator|=
operator|(
name|sPalette
operator|*
operator|)
name|ipc_phys
argument_list|(
name|srcdestlist
argument_list|)
expr_stmt|;
while|while
condition|(
name|cmd
operator|->
name|count
operator|>
literal|0
condition|)
block|{
name|count
operator|=
name|min
argument_list|(
name|cmd
operator|->
name|count
argument_list|,
operator|(
name|MAX_SIZE
operator|/
sizeof|sizeof
argument_list|(
name|sPalette
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|fbp
operator|->
name|fb_palette
operator|.
name|count
operator|=
name|count
expr_stmt|;
if|if
condition|(
name|error
operator|=
name|COPYIN
argument_list|(
operator|(
name|caddr_t
operator|)
name|cmd
operator|->
name|palette
argument_list|,
operator|(
name|caddr_t
operator|)
name|srcdestlist
argument_list|,
name|count
operator|*
sizeof|sizeof
argument_list|(
name|sPalette
argument_list|)
argument_list|,
name|UIO_USERSPACE
argument_list|)
condition|)
block|{
break|break;
block|}
name|cmd
operator|->
name|count
operator|-=
name|count
expr_stmt|;
name|cmd
operator|->
name|palette
operator|+=
name|count
expr_stmt|;
name|fbstart
argument_list|(
name|fbp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CPU_SINGLE */
return|return
name|error
return|;
block|}
end_block

begin_macro
name|fbgetpalette
argument_list|(
argument|fbp
argument_list|,
argument|data
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|fbreg
modifier|*
name|fbp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|sPalette
modifier|*
name|data
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|lPalette
name|pal
decl_stmt|;
name|fbp
operator|->
name|fb_command
operator|=
name|FB_CGETPALETTE
expr_stmt|;
name|fbp
operator|->
name|fb_palette
operator|.
name|count
operator|=
literal|1
expr_stmt|;
operator|*
operator|(
name|sPalette
operator|*
operator|)
name|srcdestlist
operator|=
operator|*
name|data
expr_stmt|;
ifdef|#
directive|ifdef
name|CPU_SINGLE
name|fbmap
index|[
literal|0
index|]
operator|.
name|fm_vaddr
operator|=
operator|(
name|caddr_t
operator|)
name|srcdestlist
expr_stmt|;
name|fbmap
index|[
literal|0
index|]
operator|.
name|fm_offset
operator|=
literal|0
expr_stmt|;
name|fbp
operator|->
name|fb_palette
operator|.
name|palette
operator|=
operator|(
name|sPalette
operator|*
operator|)
name|ipc_phys
argument_list|(
name|fbmap
argument_list|)
expr_stmt|;
else|#
directive|else
name|fbp
operator|->
name|fb_palette
operator|.
name|palette
operator|=
operator|(
name|sPalette
operator|*
operator|)
name|ipc_phys
argument_list|(
name|srcdestlist
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|fbstart
argument_list|(
name|fbp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|mips
name|MachFlushDCache
argument_list|(
operator|(
name|caddr_t
operator|)
name|srcdestlist
argument_list|,
sizeof|sizeof
argument_list|(
name|sPalette
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|data
operator|=
operator|*
operator|(
name|sPalette
operator|*
operator|)
name|MACH_CACHED_TO_UNCACHED
argument_list|(
name|srcdestlist
argument_list|)
expr_stmt|;
else|#
directive|else
operator|*
name|data
operator|=
operator|*
operator|(
name|sPalette
operator|*
operator|)
name|srcdestlist
expr_stmt|;
endif|#
directive|endif
return|return
name|fbp
operator|->
name|fb_result
return|;
block|}
end_block

begin_macro
name|fbngetpalette
argument_list|(
argument|fbp
argument_list|,
argument|cmd
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|fbreg
modifier|*
name|fbp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|lPalette
modifier|*
name|cmd
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|error
decl_stmt|;
specifier|register
name|int
name|count
decl_stmt|;
ifdef|#
directive|ifdef
name|CPU_SINGLE
specifier|register
name|int
name|len
decl_stmt|;
else|#
directive|else
specifier|register
name|int
name|savecount
decl_stmt|;
specifier|register
name|sPalette
modifier|*
name|savep
decl_stmt|;
endif|#
directive|endif
name|fbinitlock
argument_list|()
expr_stmt|;
name|fbp
operator|->
name|fb_command
operator|=
name|FB_CGETPALETTE
expr_stmt|;
ifdef|#
directive|ifdef
name|CPU_SINGLE
name|fbp
operator|->
name|fb_palette
operator|.
name|count
operator|=
name|cmd
operator|->
name|count
expr_stmt|;
if|if
condition|(
operator|(
name|len
operator|=
name|cmd
operator|->
name|count
operator|*
sizeof|sizeof
argument_list|(
name|sPalette
argument_list|)
operator|)
operator|<=
literal|0
condition|)
return|return
name|EINVAL
return|;
if|if
condition|(
name|error
operator|=
name|fblockmem
argument_list|(
name|cmd
operator|->
name|palette
argument_list|,
name|len
argument_list|,
name|B_WRITE
argument_list|,
name|fbmap
argument_list|,
name|UIO_USERSPACE
argument_list|)
condition|)
return|return
name|error
return|;
name|fbp
operator|->
name|fb_palette
operator|.
name|palette
operator|=
operator|(
name|sPalette
operator|*
operator|)
name|ipc_phys
argument_list|(
name|fbmap
argument_list|)
expr_stmt|;
name|fbdolock
argument_list|()
expr_stmt|;
name|fbstart
argument_list|(
name|fbp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|fbunlock
argument_list|()
expr_stmt|;
else|#
directive|else
comment|/* CPU_SINGLE */
name|savecount
operator|=
name|cmd
operator|->
name|count
expr_stmt|;
name|savep
operator|=
name|cmd
operator|->
name|palette
expr_stmt|;
name|fbp
operator|->
name|fb_palette
operator|.
name|palette
operator|=
operator|(
name|sPalette
operator|*
operator|)
name|ipc_phys
argument_list|(
name|srcdestlist
argument_list|)
expr_stmt|;
while|while
condition|(
name|cmd
operator|->
name|count
operator|>
literal|0
condition|)
block|{
name|count
operator|=
name|min
argument_list|(
name|cmd
operator|->
name|count
argument_list|,
operator|(
name|MAX_SIZE
operator|/
sizeof|sizeof
argument_list|(
name|sPalette
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|fbp
operator|->
name|fb_palette
operator|.
name|count
operator|=
name|count
expr_stmt|;
if|if
condition|(
name|error
operator|=
name|COPYIN
argument_list|(
operator|(
name|caddr_t
operator|)
name|cmd
operator|->
name|palette
argument_list|,
operator|(
name|caddr_t
operator|)
name|srcdestlist
argument_list|,
name|count
operator|*
sizeof|sizeof
argument_list|(
name|sPalette
argument_list|)
argument_list|,
name|UIO_USERSPACE
argument_list|)
condition|)
block|{
break|break;
block|}
name|fbstart
argument_list|(
name|fbp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|mips
name|MachFlushDCache
argument_list|(
operator|(
name|caddr_t
operator|)
name|srcdestlist
argument_list|,
sizeof|sizeof
argument_list|(
name|sPalette
argument_list|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|copyout
argument_list|(
operator|(
name|caddr_t
operator|)
name|MACH_CACHED_TO_UNCACHED
argument_list|(
name|srcdestlist
argument_list|)
argument_list|,
operator|(
name|caddr_t
operator|)
name|cmd
operator|->
name|palette
argument_list|,
name|count
operator|*
sizeof|sizeof
argument_list|(
name|sPalette
argument_list|)
argument_list|)
expr_stmt|;
else|#
directive|else
name|error
operator|=
name|copyout
argument_list|(
operator|(
name|caddr_t
operator|)
name|srcdestlist
argument_list|,
operator|(
name|caddr_t
operator|)
name|cmd
operator|->
name|palette
argument_list|,
name|count
operator|*
sizeof|sizeof
argument_list|(
name|sPalette
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|error
condition|)
break|break;
name|cmd
operator|->
name|count
operator|-=
name|count
expr_stmt|;
name|cmd
operator|->
name|palette
operator|+=
name|count
expr_stmt|;
block|}
name|cmd
operator|->
name|count
operator|=
name|savecount
expr_stmt|;
name|cmd
operator|->
name|palette
operator|=
name|savep
expr_stmt|;
endif|#
directive|endif
comment|/* CPU_SINGLE */
return|return
name|fbp
operator|->
name|fb_result
return|;
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* NFB> 0 */
end_comment

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 1986, 1990 The Regents of the University of California.  * All rights reserved.  *  * %sccs.include.redist.c%  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
name|char
name|copyright
index|[]
init|=
literal|"@(#) Copyright (c) 1986, 1990 The Regents of the University of California.\n\  All rights reserved.\n"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* not lint */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|sccsid
index|[]
init|=
literal|"@(#)installboot.c	7.4 (Berkeley) %G%"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* not lint */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<ufs/ffs/fs.h>
end_include

begin_decl_stmt
name|char
name|block
index|[
literal|1024
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|maxbootsize
init|=
literal|16
operator|*
literal|7
operator|*
literal|512
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* XXX */
end_comment

begin_comment
comment|/*  * HPs are a kludge.  * The boot program won't fit in the boot area of a file system so we  * have to place it outside the file systems.  By convention, this means  * that if the 'a' partition is being used for '/', it is offset one  * cylinder into the disk and the boot program goes into that one cylinder.  * Also by convention, the 'c' partition is defined to be the entire disk  * including this boot cylinder.  If these conventions are not adhered to,  * the potential for disaster is enormous.  */
end_comment

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
name|argv
index|[]
decl_stmt|;
block|{
name|int
name|ifd
decl_stmt|,
name|ofd
decl_stmt|,
name|len
decl_stmt|;
name|char
modifier|*
name|dev
decl_stmt|,
modifier|*
name|standalonecode
decl_stmt|;
name|int
name|bsize
init|=
literal|1024
decl_stmt|;
if|if
condition|(
name|argc
operator|!=
literal|3
condition|)
name|usage
argument_list|()
expr_stmt|;
name|dev
operator|=
name|argv
index|[
literal|2
index|]
expr_stmt|;
name|len
operator|=
name|strlen
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev
index|[
name|len
operator|-
literal|1
index|]
operator|!=
literal|'c'
condition|)
name|usage
argument_list|()
expr_stmt|;
name|standalonecode
operator|=
name|argv
index|[
literal|1
index|]
expr_stmt|;
name|ifd
operator|=
name|open
argument_list|(
name|standalonecode
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifd
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
name|standalonecode
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|ofd
operator|=
name|open
argument_list|(
name|dev
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ofd
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
operator|(
name|len
operator|=
name|read
argument_list|(
name|ifd
argument_list|,
name|block
argument_list|,
name|bsize
argument_list|)
operator|)
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|maxbootsize
operator|-=
name|bsize
operator|)
operator|<
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s: too big\n"
argument_list|,
name|standalonecode
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|len
operator|<
name|bsize
condition|)
name|bzero
argument_list|(
operator|&
name|block
index|[
name|len
index|]
argument_list|,
name|bsize
operator|-
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|write
argument_list|(
name|ofd
argument_list|,
name|block
argument_list|,
name|bsize
argument_list|)
operator|!=
name|bsize
condition|)
block|{
name|perror
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|len
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
name|standalonecode
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_macro
name|usage
argument_list|()
end_macro

begin_block
block|{
name|printf
argument_list|(
literal|"Usage: installboot bootprog device\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"where:\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\"bootprog\" is a LIF format file< %d bytes long\n"
argument_list|,
name|maxbootsize
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\"device\" must be the 'c' partition of a bootable disk\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"WARNING!!  If the 'c' partition contains a file system, %s\n"
argument_list|,
literal|"DON'T RUN THIS!!"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2003, 2004 Silicon Graphics International Corp.  * Copyright (c) 1997-2007 Kenneth D. Merry  * Copyright (c) 2012 The FreeBSD Foundation  * All rights reserved.  *  * Portions of this software were developed by Edward Tomasz Napierala  * under sponsorship from the FreeBSD Foundation.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions, and the following disclaimer,  *    without modification.  * 2. Redistributions in binary form must reproduce at minimum a disclaimer  *    substantially similar to the "NO WARRANTY" disclaimer below  *    ("Disclaimer") and any redistribution must be conditioned upon  *    including a substantially similar Disclaimer requirement for further  *    binary redistribution.  *  * NO WARRANTY  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS  * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR  * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT  * HOLDERS OR CONTRIBUTORS BE LIABLE FOR SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,  * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING  * IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE  * POSSIBILITY OF SUCH DAMAGES.  *  * $Id: //depot/users/kenm/FreeBSD-test2/usr.sbin/ctladm/ctladm.c#4 $  */
end_comment

begin_comment
comment|/*  * CAM Target Layer exercise program.  *  * Author: Ken Merry<ken@FreeBSD.org>  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/callout.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/linker.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<sys/sbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<bsdxml.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<err.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<getopt.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<stdint.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<cam/scsi/scsi_all.h>
end_include

begin_include
include|#
directive|include
file|<cam/scsi/scsi_message.h>
end_include

begin_include
include|#
directive|include
file|<cam/ctl/ctl.h>
end_include

begin_include
include|#
directive|include
file|<cam/ctl/ctl_io.h>
end_include

begin_include
include|#
directive|include
file|<cam/ctl/ctl_backend.h>
end_include

begin_include
include|#
directive|include
file|<cam/ctl/ctl_ioctl.h>
end_include

begin_include
include|#
directive|include
file|<cam/ctl/ctl_util.h>
end_include

begin_include
include|#
directive|include
file|<cam/ctl/ctl_scsi_all.h>
end_include

begin_include
include|#
directive|include
file|<camlib.h>
end_include

begin_include
include|#
directive|include
file|<libutil.h>
end_include

begin_include
include|#
directive|include
file|"ctladm.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|min
end_ifdef

begin_undef
undef|#
directive|undef
name|min
end_undef

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|min
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|)
value|(x< y) ? x : y
end_define

begin_typedef
typedef|typedef
enum|enum
block|{
name|CTLADM_CMD_TUR
block|,
name|CTLADM_CMD_INQUIRY
block|,
name|CTLADM_CMD_REQ_SENSE
block|,
name|CTLADM_CMD_ARRAYLIST
block|,
name|CTLADM_CMD_REPORT_LUNS
block|,
name|CTLADM_CMD_HELP
block|,
name|CTLADM_CMD_DEVLIST
block|,
name|CTLADM_CMD_ADDDEV
block|,
name|CTLADM_CMD_RM
block|,
name|CTLADM_CMD_CREATE
block|,
name|CTLADM_CMD_READ
block|,
name|CTLADM_CMD_WRITE
block|,
name|CTLADM_CMD_PORT
block|,
name|CTLADM_CMD_PORTLIST
block|,
name|CTLADM_CMD_READCAPACITY
block|,
name|CTLADM_CMD_MODESENSE
block|,
name|CTLADM_CMD_DUMPOOA
block|,
name|CTLADM_CMD_DUMPSTRUCTS
block|,
name|CTLADM_CMD_START
block|,
name|CTLADM_CMD_STOP
block|,
name|CTLADM_CMD_SYNC_CACHE
block|,
name|CTLADM_CMD_LUNLIST
block|,
name|CTLADM_CMD_DELAY
block|,
name|CTLADM_CMD_ERR_INJECT
block|,
name|CTLADM_CMD_PRES_IN
block|,
name|CTLADM_CMD_PRES_OUT
block|,
name|CTLADM_CMD_INQ_VPD_DEVID
block|,
name|CTLADM_CMD_RTPG
block|,
name|CTLADM_CMD_MODIFY
block|,
name|CTLADM_CMD_ISLIST
block|,
name|CTLADM_CMD_ISLOGOUT
block|,
name|CTLADM_CMD_ISTERMINATE
block|,
name|CTLADM_CMD_LUNMAP
block|}
name|ctladm_cmdfunction
typedef|;
end_typedef

begin_typedef
typedef|typedef
enum|enum
block|{
name|CTLADM_ARG_NONE
init|=
literal|0x0000000
block|,
name|CTLADM_ARG_AUTOSENSE
init|=
literal|0x0000001
block|,
name|CTLADM_ARG_DEVICE
init|=
literal|0x0000002
block|,
name|CTLADM_ARG_ARRAYSIZE
init|=
literal|0x0000004
block|,
name|CTLADM_ARG_BACKEND
init|=
literal|0x0000008
block|,
name|CTLADM_ARG_CDBSIZE
init|=
literal|0x0000010
block|,
name|CTLADM_ARG_DATALEN
init|=
literal|0x0000020
block|,
name|CTLADM_ARG_FILENAME
init|=
literal|0x0000040
block|,
name|CTLADM_ARG_LBA
init|=
literal|0x0000080
block|,
name|CTLADM_ARG_PC
init|=
literal|0x0000100
block|,
name|CTLADM_ARG_PAGE_CODE
init|=
literal|0x0000200
block|,
name|CTLADM_ARG_PAGE_LIST
init|=
literal|0x0000400
block|,
name|CTLADM_ARG_SUBPAGE
init|=
literal|0x0000800
block|,
name|CTLADM_ARG_PAGELIST
init|=
literal|0x0001000
block|,
name|CTLADM_ARG_DBD
init|=
literal|0x0002000
block|,
name|CTLADM_ARG_TARG_LUN
init|=
literal|0x0004000
block|,
name|CTLADM_ARG_BLOCKSIZE
init|=
literal|0x0008000
block|,
name|CTLADM_ARG_IMMED
init|=
literal|0x0010000
block|,
name|CTLADM_ARG_RELADR
init|=
literal|0x0020000
block|,
name|CTLADM_ARG_RETRIES
init|=
literal|0x0040000
block|,
name|CTLADM_ARG_ONOFFLINE
init|=
literal|0x0080000
block|,
name|CTLADM_ARG_ONESHOT
init|=
literal|0x0100000
block|,
name|CTLADM_ARG_TIMEOUT
init|=
literal|0x0200000
block|,
name|CTLADM_ARG_INITIATOR
init|=
literal|0x0400000
block|,
name|CTLADM_ARG_NOCOPY
init|=
literal|0x0800000
block|,
name|CTLADM_ARG_NEED_TL
init|=
literal|0x1000000
block|}
name|ctladm_cmdargs
typedef|;
end_typedef

begin_struct
struct|struct
name|ctladm_opts
block|{
specifier|const
name|char
modifier|*
name|optname
decl_stmt|;
name|uint32_t
name|cmdnum
decl_stmt|;
name|ctladm_cmdargs
name|argnum
decl_stmt|;
specifier|const
name|char
modifier|*
name|subopt
decl_stmt|;
block|}
struct|;
end_struct

begin_typedef
typedef|typedef
enum|enum
block|{
name|CC_OR_NOT_FOUND
block|,
name|CC_OR_AMBIGUOUS
block|,
name|CC_OR_FOUND
block|}
name|ctladm_optret
typedef|;
end_typedef

begin_decl_stmt
specifier|static
specifier|const
name|char
name|rw_opts
index|[]
init|=
literal|"Nb:c:d:f:l:"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
name|startstop_opts
index|[]
init|=
literal|"i"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|ctladm_opts
name|option_table
index|[]
init|=
block|{
block|{
literal|"adddev"
block|,
name|CTLADM_CMD_ADDDEV
block|,
name|CTLADM_ARG_NONE
block|,
name|NULL
block|}
block|,
block|{
literal|"create"
block|,
name|CTLADM_CMD_CREATE
block|,
name|CTLADM_ARG_NONE
block|,
literal|"b:B:d:l:o:s:S:t:"
block|}
block|,
block|{
literal|"delay"
block|,
name|CTLADM_CMD_DELAY
block|,
name|CTLADM_ARG_NEED_TL
block|,
literal|"T:l:t:"
block|}
block|,
block|{
literal|"devid"
block|,
name|CTLADM_CMD_INQ_VPD_DEVID
block|,
name|CTLADM_ARG_NEED_TL
block|,
name|NULL
block|}
block|,
block|{
literal|"devlist"
block|,
name|CTLADM_CMD_DEVLIST
block|,
name|CTLADM_ARG_NONE
block|,
literal|"b:vx"
block|}
block|,
block|{
literal|"dumpooa"
block|,
name|CTLADM_CMD_DUMPOOA
block|,
name|CTLADM_ARG_NONE
block|,
name|NULL
block|}
block|,
block|{
literal|"dumpstructs"
block|,
name|CTLADM_CMD_DUMPSTRUCTS
block|,
name|CTLADM_ARG_NONE
block|,
name|NULL
block|}
block|,
block|{
literal|"help"
block|,
name|CTLADM_CMD_HELP
block|,
name|CTLADM_ARG_NONE
block|,
name|NULL
block|}
block|,
block|{
literal|"inject"
block|,
name|CTLADM_CMD_ERR_INJECT
block|,
name|CTLADM_ARG_NEED_TL
block|,
literal|"cd:i:p:r:s:"
block|}
block|,
block|{
literal|"inquiry"
block|,
name|CTLADM_CMD_INQUIRY
block|,
name|CTLADM_ARG_NEED_TL
block|,
name|NULL
block|}
block|,
block|{
literal|"islist"
block|,
name|CTLADM_CMD_ISLIST
block|,
name|CTLADM_ARG_NONE
block|,
literal|"vx"
block|}
block|,
block|{
literal|"islogout"
block|,
name|CTLADM_CMD_ISLOGOUT
block|,
name|CTLADM_ARG_NONE
block|,
literal|"ac:i:p:"
block|}
block|,
block|{
literal|"isterminate"
block|,
name|CTLADM_CMD_ISTERMINATE
block|,
name|CTLADM_ARG_NONE
block|,
literal|"ac:i:p:"
block|}
block|,
block|{
literal|"lunlist"
block|,
name|CTLADM_CMD_LUNLIST
block|,
name|CTLADM_ARG_NONE
block|,
name|NULL
block|}
block|,
block|{
literal|"lunmap"
block|,
name|CTLADM_CMD_LUNMAP
block|,
name|CTLADM_ARG_NONE
block|,
literal|"p:l:L:"
block|}
block|,
block|{
literal|"modesense"
block|,
name|CTLADM_CMD_MODESENSE
block|,
name|CTLADM_ARG_NEED_TL
block|,
literal|"P:S:dlm:c:"
block|}
block|,
block|{
literal|"modify"
block|,
name|CTLADM_CMD_MODIFY
block|,
name|CTLADM_ARG_NONE
block|,
literal|"b:l:o:s:"
block|}
block|,
block|{
literal|"port"
block|,
name|CTLADM_CMD_PORT
block|,
name|CTLADM_ARG_NONE
block|,
literal|"lo:p:qt:w:W:x"
block|}
block|,
block|{
literal|"portlist"
block|,
name|CTLADM_CMD_PORTLIST
block|,
name|CTLADM_ARG_NONE
block|,
literal|"f:ilp:qvx"
block|}
block|,
block|{
literal|"prin"
block|,
name|CTLADM_CMD_PRES_IN
block|,
name|CTLADM_ARG_NEED_TL
block|,
literal|"a:"
block|}
block|,
block|{
literal|"prout"
block|,
name|CTLADM_CMD_PRES_OUT
block|,
name|CTLADM_ARG_NEED_TL
block|,
literal|"a:k:r:s:"
block|}
block|,
block|{
literal|"read"
block|,
name|CTLADM_CMD_READ
block|,
name|CTLADM_ARG_NEED_TL
block|,
name|rw_opts
block|}
block|,
block|{
literal|"readcapacity"
block|,
name|CTLADM_CMD_READCAPACITY
block|,
name|CTLADM_ARG_NEED_TL
block|,
literal|"c:"
block|}
block|,
block|{
literal|"remove"
block|,
name|CTLADM_CMD_RM
block|,
name|CTLADM_ARG_NONE
block|,
literal|"b:l:o:"
block|}
block|,
block|{
literal|"reportluns"
block|,
name|CTLADM_CMD_REPORT_LUNS
block|,
name|CTLADM_ARG_NEED_TL
block|,
name|NULL
block|}
block|,
block|{
literal|"reqsense"
block|,
name|CTLADM_CMD_REQ_SENSE
block|,
name|CTLADM_ARG_NEED_TL
block|,
name|NULL
block|}
block|,
block|{
literal|"rtpg"
block|,
name|CTLADM_CMD_RTPG
block|,
name|CTLADM_ARG_NEED_TL
block|,
name|NULL
block|}
block|,
block|{
literal|"start"
block|,
name|CTLADM_CMD_START
block|,
name|CTLADM_ARG_NEED_TL
block|,
name|startstop_opts
block|}
block|,
block|{
literal|"stop"
block|,
name|CTLADM_CMD_STOP
block|,
name|CTLADM_ARG_NEED_TL
block|,
name|startstop_opts
block|}
block|,
block|{
literal|"synccache"
block|,
name|CTLADM_CMD_SYNC_CACHE
block|,
name|CTLADM_ARG_NEED_TL
block|,
literal|"b:c:il:r"
block|}
block|,
block|{
literal|"tur"
block|,
name|CTLADM_CMD_TUR
block|,
name|CTLADM_ARG_NEED_TL
block|,
name|NULL
block|}
block|,
block|{
literal|"write"
block|,
name|CTLADM_CMD_WRITE
block|,
name|CTLADM_ARG_NEED_TL
block|,
name|rw_opts
block|}
block|,
block|{
literal|"-?"
block|,
name|CTLADM_CMD_HELP
block|,
name|CTLADM_ARG_NONE
block|,
name|NULL
block|}
block|,
block|{
literal|"-h"
block|,
name|CTLADM_CMD_HELP
block|,
name|CTLADM_ARG_NONE
block|,
name|NULL
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|,
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function_decl
name|ctladm_optret
name|getoption
parameter_list|(
name|struct
name|ctladm_opts
modifier|*
name|table
parameter_list|,
name|char
modifier|*
name|arg
parameter_list|,
name|uint32_t
modifier|*
name|cmdnum
parameter_list|,
name|ctladm_cmdargs
modifier|*
name|argnum
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|subopt
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|cctl_dump_ooa
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|cctl_port
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|,
name|char
modifier|*
name|combinedopt
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|cctl_do_io
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|retries
parameter_list|,
name|union
name|ctl_io
modifier|*
name|io
parameter_list|,
specifier|const
name|char
modifier|*
name|func
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|cctl_delay
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|lun
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|,
name|char
modifier|*
name|combinedopt
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|cctl_lunlist
parameter_list|(
name|int
name|fd
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|cctl_sync_cache
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|lun
parameter_list|,
name|int
name|iid
parameter_list|,
name|int
name|retries
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|,
name|char
modifier|*
name|combinedopt
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|cctl_start_stop
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|lun
parameter_list|,
name|int
name|iid
parameter_list|,
name|int
name|retries
parameter_list|,
name|int
name|start
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|,
name|char
modifier|*
name|combinedopt
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|cctl_mode_sense
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|lun
parameter_list|,
name|int
name|iid
parameter_list|,
name|int
name|retries
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|,
name|char
modifier|*
name|combinedopt
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|cctl_read_capacity
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|lun
parameter_list|,
name|int
name|iid
parameter_list|,
name|int
name|retries
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|,
name|char
modifier|*
name|combinedopt
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|cctl_read_write
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|lun
parameter_list|,
name|int
name|iid
parameter_list|,
name|int
name|retries
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|,
name|char
modifier|*
name|combinedopt
parameter_list|,
name|ctladm_cmdfunction
name|command
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|cctl_get_luns
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|lun
parameter_list|,
name|int
name|iid
parameter_list|,
name|int
name|retries
parameter_list|,
name|struct
name|scsi_report_luns_data
modifier|*
modifier|*
name|lun_data
parameter_list|,
name|uint32_t
modifier|*
name|num_luns
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|cctl_report_luns
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|lun
parameter_list|,
name|int
name|iid
parameter_list|,
name|int
name|retries
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|cctl_tur
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|lun
parameter_list|,
name|int
name|iid
parameter_list|,
name|int
name|retries
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|cctl_get_inquiry
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|lun
parameter_list|,
name|int
name|iid
parameter_list|,
name|int
name|retries
parameter_list|,
name|char
modifier|*
name|path_str
parameter_list|,
name|int
name|path_len
parameter_list|,
name|struct
name|scsi_inquiry_data
modifier|*
name|inq_data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|cctl_inquiry
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|lun
parameter_list|,
name|int
name|iid
parameter_list|,
name|int
name|retries
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|cctl_req_sense
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|lun
parameter_list|,
name|int
name|iid
parameter_list|,
name|int
name|retries
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|cctl_persistent_reserve_in
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|lun
parameter_list|,
name|int
name|initiator
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|,
name|char
modifier|*
name|combinedopt
parameter_list|,
name|int
name|retry_count
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|cctl_persistent_reserve_out
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|lun
parameter_list|,
name|int
name|initiator
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|,
name|char
modifier|*
name|combinedopt
parameter_list|,
name|int
name|retry_count
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|cctl_create_lun
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|,
name|char
modifier|*
name|combinedopt
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|cctl_inquiry_vpd_devid
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|lun
parameter_list|,
name|int
name|initiator
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|cctl_report_target_port_group
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|lun
parameter_list|,
name|int
name|initiator
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|cctl_modify_lun
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|,
name|char
modifier|*
name|combinedopt
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|cctl_portlist
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|,
name|char
modifier|*
name|combinedopt
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|ctladm_optret
name|getoption
parameter_list|(
name|struct
name|ctladm_opts
modifier|*
name|table
parameter_list|,
name|char
modifier|*
name|arg
parameter_list|,
name|uint32_t
modifier|*
name|cmdnum
parameter_list|,
name|ctladm_cmdargs
modifier|*
name|argnum
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|subopt
parameter_list|)
block|{
name|struct
name|ctladm_opts
modifier|*
name|opts
decl_stmt|;
name|int
name|num_matches
init|=
literal|0
decl_stmt|;
for|for
control|(
name|opts
operator|=
name|table
init|;
operator|(
name|opts
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|opts
operator|->
name|optname
operator|!=
name|NULL
operator|)
condition|;
name|opts
operator|++
control|)
block|{
if|if
condition|(
name|strncmp
argument_list|(
name|opts
operator|->
name|optname
argument_list|,
name|arg
argument_list|,
name|strlen
argument_list|(
name|arg
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
operator|*
name|cmdnum
operator|=
name|opts
operator|->
name|cmdnum
expr_stmt|;
operator|*
name|argnum
operator|=
name|opts
operator|->
name|argnum
expr_stmt|;
operator|*
name|subopt
operator|=
name|opts
operator|->
name|subopt
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|opts
operator|->
name|optname
argument_list|,
name|arg
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|CC_OR_FOUND
operator|)
return|;
if|if
condition|(
operator|++
name|num_matches
operator|>
literal|1
condition|)
return|return
operator|(
name|CC_OR_AMBIGUOUS
operator|)
return|;
block|}
block|}
if|if
condition|(
name|num_matches
operator|>
literal|0
condition|)
return|return
operator|(
name|CC_OR_FOUND
operator|)
return|;
else|else
return|return
operator|(
name|CC_OR_NOT_FOUND
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cctl_dump_ooa
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|struct
name|ctl_ooa
name|ooa
decl_stmt|;
name|long
name|double
name|cmd_latency
decl_stmt|;
name|int
name|num_entries
decl_stmt|,
name|len
decl_stmt|,
name|lun
init|=
operator|-
literal|1
decl_stmt|,
name|retval
init|=
literal|0
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
name|num_entries
operator|=
literal|104
expr_stmt|;
if|if
condition|(
operator|(
name|argc
operator|>
literal|2
operator|)
operator|&&
operator|(
name|isdigit
argument_list|(
name|argv
index|[
literal|2
index|]
index|[
literal|0
index|]
argument_list|)
operator|)
condition|)
name|lun
operator|=
name|strtol
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|retry
label|:
name|len
operator|=
name|num_entries
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|ctl_ooa_entry
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|ooa
argument_list|,
sizeof|sizeof
argument_list|(
name|ooa
argument_list|)
argument_list|)
expr_stmt|;
name|ooa
operator|.
name|entries
operator|=
name|malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ooa
operator|.
name|entries
operator|==
name|NULL
condition|)
block|{
name|warn
argument_list|(
literal|"%s: error mallocing %d bytes"
argument_list|,
name|__func__
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|lun
operator|>=
literal|0
condition|)
block|{
name|ooa
operator|.
name|lun_num
operator|=
name|lun
expr_stmt|;
block|}
else|else
name|ooa
operator|.
name|flags
operator||=
name|CTL_OOA_FLAG_ALL_LUNS
expr_stmt|;
name|ooa
operator|.
name|alloc_len
operator|=
name|len
expr_stmt|;
name|ooa
operator|.
name|alloc_num
operator|=
name|num_entries
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|CTL_GET_OOA
argument_list|,
operator|&
name|ooa
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|warn
argument_list|(
literal|"%s: CTL_GET_OOA ioctl failed"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
if|if
condition|(
name|ooa
operator|.
name|status
operator|==
name|CTL_OOA_NEED_MORE_SPACE
condition|)
block|{
name|num_entries
operator|=
name|num_entries
operator|*
literal|2
expr_stmt|;
name|free
argument_list|(
name|ooa
operator|.
name|entries
argument_list|)
expr_stmt|;
name|ooa
operator|.
name|entries
operator|=
name|NULL
expr_stmt|;
goto|goto
name|retry
goto|;
block|}
if|if
condition|(
name|ooa
operator|.
name|status
operator|!=
name|CTL_OOA_OK
condition|)
block|{
name|warnx
argument_list|(
literal|"%s: CTL_GET_OOA ioctl returned error %d"
argument_list|,
name|__func__
argument_list|,
name|ooa
operator|.
name|status
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"Dumping OOA queues\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ooa
operator|.
name|fill_num
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|ctl_ooa_entry
modifier|*
name|entry
decl_stmt|;
name|char
name|cdb_str
index|[
operator|(
name|SCSI_MAX_CDBLEN
operator|*
literal|3
operator|)
operator|+
literal|1
index|]
decl_stmt|;
name|struct
name|bintime
name|delta_bt
decl_stmt|;
name|struct
name|timespec
name|ts
decl_stmt|;
name|entry
operator|=
operator|&
name|ooa
operator|.
name|entries
index|[
name|i
index|]
expr_stmt|;
name|delta_bt
operator|=
name|ooa
operator|.
name|cur_bt
expr_stmt|;
name|bintime_sub
argument_list|(
operator|&
name|delta_bt
argument_list|,
operator|&
name|entry
operator|->
name|start_bt
argument_list|)
expr_stmt|;
name|bintime2timespec
argument_list|(
operator|&
name|delta_bt
argument_list|,
operator|&
name|ts
argument_list|)
expr_stmt|;
name|cmd_latency
operator|=
name|ts
operator|.
name|tv_sec
operator|*
literal|1000
expr_stmt|;
if|if
condition|(
name|ts
operator|.
name|tv_nsec
operator|>
literal|0
condition|)
name|cmd_latency
operator|+=
name|ts
operator|.
name|tv_nsec
operator|/
literal|1000000
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"LUN %jd tag 0x%04x%s%s%s%s%s: %s. CDB: %s "
literal|"(%0.0Lf ms)\n"
argument_list|,
operator|(
name|intmax_t
operator|)
name|entry
operator|->
name|lun_num
argument_list|,
name|entry
operator|->
name|tag_num
argument_list|,
operator|(
name|entry
operator|->
name|cmd_flags
operator|&
name|CTL_OOACMD_FLAG_BLOCKED
operator|)
condition|?
literal|" BLOCKED"
else|:
literal|""
argument_list|,
operator|(
name|entry
operator|->
name|cmd_flags
operator|&
name|CTL_OOACMD_FLAG_DMA
operator|)
condition|?
literal|" DMA"
else|:
literal|""
argument_list|,
operator|(
name|entry
operator|->
name|cmd_flags
operator|&
name|CTL_OOACMD_FLAG_DMA_QUEUED
operator|)
condition|?
literal|" DMAQUEUED"
else|:
literal|""
argument_list|,
operator|(
name|entry
operator|->
name|cmd_flags
operator|&
name|CTL_OOACMD_FLAG_ABORT
operator|)
condition|?
literal|" ABORT"
else|:
literal|""
argument_list|,
operator|(
name|entry
operator|->
name|cmd_flags
operator|&
name|CTL_OOACMD_FLAG_RTR
operator|)
condition|?
literal|" RTR"
else|:
literal|""
argument_list|,
name|scsi_op_desc
argument_list|(
name|entry
operator|->
name|cdb
index|[
literal|0
index|]
argument_list|,
name|NULL
argument_list|)
argument_list|,
name|scsi_cdb_string
argument_list|(
name|entry
operator|->
name|cdb
argument_list|,
name|cdb_str
argument_list|,
sizeof|sizeof
argument_list|(
name|cdb_str
argument_list|)
argument_list|)
argument_list|,
name|cmd_latency
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"OOA queues dump done\n"
argument_list|)
expr_stmt|;
name|bailout
label|:
name|free
argument_list|(
name|ooa
operator|.
name|entries
argument_list|)
expr_stmt|;
return|return
operator|(
name|retval
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cctl_dump_structs
parameter_list|(
name|int
name|fd
parameter_list|,
name|ctladm_cmdargs
name|cmdargs
name|__unused
parameter_list|)
block|{
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|CTL_DUMP_STRUCTS
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|warn
argument_list|(
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_typedef
typedef|typedef
enum|enum
block|{
name|CCTL_PORT_MODE_NONE
block|,
name|CCTL_PORT_MODE_LIST
block|,
name|CCTL_PORT_MODE_SET
block|,
name|CCTL_PORT_MODE_ON
block|,
name|CCTL_PORT_MODE_OFF
block|}
name|cctl_port_mode
typedef|;
end_typedef

begin_decl_stmt
specifier|static
name|struct
name|ctladm_opts
name|cctl_fe_table
index|[]
init|=
block|{
block|{
literal|"fc"
block|,
name|CTL_PORT_FC
block|,
name|CTLADM_ARG_NONE
block|,
name|NULL
block|}
block|,
block|{
literal|"scsi"
block|,
name|CTL_PORT_SCSI
block|,
name|CTLADM_ARG_NONE
block|,
name|NULL
block|}
block|,
block|{
literal|"internal"
block|,
name|CTL_PORT_INTERNAL
block|,
name|CTLADM_ARG_NONE
block|,
name|NULL
block|}
block|,
block|{
literal|"iscsi"
block|,
name|CTL_PORT_ISCSI
block|,
name|CTLADM_ARG_NONE
block|,
name|NULL
block|}
block|,
block|{
literal|"sas"
block|,
name|CTL_PORT_SAS
block|,
name|CTLADM_ARG_NONE
block|,
name|NULL
block|}
block|,
block|{
literal|"all"
block|,
name|CTL_PORT_ALL
block|,
name|CTLADM_ARG_NONE
block|,
name|NULL
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|,
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|cctl_port
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|,
name|char
modifier|*
name|combinedopt
parameter_list|)
block|{
name|int
name|c
decl_stmt|;
name|int32_t
name|targ_port
init|=
operator|-
literal|1
decl_stmt|;
name|int
name|retval
init|=
literal|0
decl_stmt|;
name|int
name|wwnn_set
init|=
literal|0
decl_stmt|,
name|wwpn_set
init|=
literal|0
decl_stmt|;
name|uint64_t
name|wwnn
init|=
literal|0
decl_stmt|,
name|wwpn
init|=
literal|0
decl_stmt|;
name|cctl_port_mode
name|port_mode
init|=
name|CCTL_PORT_MODE_NONE
decl_stmt|;
name|struct
name|ctl_port_entry
name|entry
decl_stmt|;
name|ctl_port_type
name|port_type
init|=
name|CTL_PORT_NONE
decl_stmt|;
name|int
name|quiet
init|=
literal|0
decl_stmt|,
name|xml
init|=
literal|0
decl_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|combinedopt
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'l'
case|:
if|if
condition|(
name|port_mode
operator|!=
name|CCTL_PORT_MODE_NONE
condition|)
goto|goto
name|bailout_badarg
goto|;
name|port_mode
operator|=
name|CCTL_PORT_MODE_LIST
expr_stmt|;
break|break;
case|case
literal|'o'
case|:
if|if
condition|(
name|port_mode
operator|!=
name|CCTL_PORT_MODE_NONE
condition|)
goto|goto
name|bailout_badarg
goto|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|optarg
argument_list|,
literal|"on"
argument_list|)
operator|==
literal|0
condition|)
name|port_mode
operator|=
name|CCTL_PORT_MODE_ON
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|optarg
argument_list|,
literal|"off"
argument_list|)
operator|==
literal|0
condition|)
name|port_mode
operator|=
name|CCTL_PORT_MODE_OFF
expr_stmt|;
else|else
block|{
name|warnx
argument_list|(
literal|"Invalid -o argument %s, \"on\" or "
literal|"\"off\" are the only valid args"
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
break|break;
case|case
literal|'p'
case|:
name|targ_port
operator|=
name|strtol
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'q'
case|:
name|quiet
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
block|{
name|ctladm_optret
name|optret
decl_stmt|;
name|ctladm_cmdargs
name|argnum
decl_stmt|;
specifier|const
name|char
modifier|*
name|subopt
decl_stmt|;
name|ctl_port_type
name|tmp_port_type
decl_stmt|;
name|optret
operator|=
name|getoption
argument_list|(
name|cctl_fe_table
argument_list|,
name|optarg
argument_list|,
operator|&
name|tmp_port_type
argument_list|,
operator|&
name|argnum
argument_list|,
operator|&
name|subopt
argument_list|)
expr_stmt|;
if|if
condition|(
name|optret
operator|==
name|CC_OR_AMBIGUOUS
condition|)
block|{
name|warnx
argument_list|(
literal|"%s: ambiguous frontend type %s"
argument_list|,
name|__func__
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
elseif|else
if|if
condition|(
name|optret
operator|==
name|CC_OR_NOT_FOUND
condition|)
block|{
name|warnx
argument_list|(
literal|"%s: invalid frontend type %s"
argument_list|,
name|__func__
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
name|port_type
operator||=
name|tmp_port_type
expr_stmt|;
break|break;
block|}
case|case
literal|'w'
case|:
if|if
condition|(
operator|(
name|port_mode
operator|!=
name|CCTL_PORT_MODE_NONE
operator|)
operator|&&
operator|(
name|port_mode
operator|!=
name|CCTL_PORT_MODE_SET
operator|)
condition|)
goto|goto
name|bailout_badarg
goto|;
name|port_mode
operator|=
name|CCTL_PORT_MODE_SET
expr_stmt|;
name|wwnn
operator|=
name|strtoull
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wwnn_set
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'W'
case|:
if|if
condition|(
operator|(
name|port_mode
operator|!=
name|CCTL_PORT_MODE_NONE
operator|)
operator|&&
operator|(
name|port_mode
operator|!=
name|CCTL_PORT_MODE_SET
operator|)
condition|)
goto|goto
name|bailout_badarg
goto|;
name|port_mode
operator|=
name|CCTL_PORT_MODE_SET
expr_stmt|;
name|wwpn
operator|=
name|strtoull
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wwpn_set
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'x'
case|:
name|xml
operator|=
literal|1
expr_stmt|;
break|break;
block|}
block|}
comment|/* 	 * The user can specify either one or more frontend types (-t), or 	 * a specific frontend, but not both. 	 * 	 * If the user didn't specify a frontend type or number, set it to 	 * all.  This is primarily needed for the enable/disable ioctls. 	 * This will be a no-op for the listing code.  For the set ioctl, 	 * we'll throw an error, since that only works on one port at a time. 	 */
if|if
condition|(
operator|(
name|port_type
operator|!=
name|CTL_PORT_NONE
operator|)
operator|&&
operator|(
name|targ_port
operator|!=
operator|-
literal|1
operator|)
condition|)
block|{
name|warnx
argument_list|(
literal|"%s: can only specify one of -t or -n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
elseif|else
if|if
condition|(
operator|(
name|targ_port
operator|==
operator|-
literal|1
operator|)
operator|&&
operator|(
name|port_type
operator|==
name|CTL_PORT_NONE
operator|)
condition|)
name|port_type
operator|=
name|CTL_PORT_ALL
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|entry
argument_list|,
sizeof|sizeof
argument_list|(
name|entry
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * These are needed for all but list/dump mode. 	 */
name|entry
operator|.
name|port_type
operator|=
name|port_type
expr_stmt|;
name|entry
operator|.
name|targ_port
operator|=
name|targ_port
expr_stmt|;
switch|switch
condition|(
name|port_mode
condition|)
block|{
case|case
name|CCTL_PORT_MODE_LIST
case|:
block|{
name|char
name|opts
index|[]
init|=
literal|"xq"
decl_stmt|;
name|char
name|argx
index|[]
init|=
literal|"-x"
decl_stmt|;
name|char
name|argq
index|[]
init|=
literal|"-q"
decl_stmt|;
name|char
modifier|*
name|argvx
index|[
literal|2
index|]
decl_stmt|;
name|int
name|argcx
init|=
literal|0
decl_stmt|;
name|optind
operator|=
literal|0
expr_stmt|;
name|optreset
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|xml
condition|)
name|argvx
index|[
name|argcx
operator|++
index|]
operator|=
name|argx
expr_stmt|;
if|if
condition|(
name|quiet
condition|)
name|argvx
index|[
name|argcx
operator|++
index|]
operator|=
name|argq
expr_stmt|;
name|cctl_portlist
argument_list|(
name|fd
argument_list|,
name|argcx
argument_list|,
name|argvx
argument_list|,
name|opts
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|CCTL_PORT_MODE_SET
case|:
if|if
condition|(
name|targ_port
operator|==
operator|-
literal|1
condition|)
block|{
name|warnx
argument_list|(
literal|"%s: -w and -W require -n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
if|if
condition|(
name|wwnn_set
condition|)
block|{
name|entry
operator|.
name|flags
operator||=
name|CTL_PORT_WWNN_VALID
expr_stmt|;
name|entry
operator|.
name|wwnn
operator|=
name|wwnn
expr_stmt|;
block|}
if|if
condition|(
name|wwpn_set
condition|)
block|{
name|entry
operator|.
name|flags
operator||=
name|CTL_PORT_WWPN_VALID
expr_stmt|;
name|entry
operator|.
name|wwpn
operator|=
name|wwpn
expr_stmt|;
block|}
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|CTL_SET_PORT_WWNS
argument_list|,
operator|&
name|entry
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|warn
argument_list|(
literal|"%s: CTL_SET_PORT_WWNS ioctl failed"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
break|break;
case|case
name|CCTL_PORT_MODE_ON
case|:
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|CTL_ENABLE_PORT
argument_list|,
operator|&
name|entry
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|warn
argument_list|(
literal|"%s: CTL_ENABLE_PORT ioctl failed"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"Front End Ports enabled\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|CCTL_PORT_MODE_OFF
case|:
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|CTL_DISABLE_PORT
argument_list|,
operator|&
name|entry
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|warn
argument_list|(
literal|"%s: CTL_DISABLE_PORT ioctl failed"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"Front End Ports disabled\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|warnx
argument_list|(
literal|"%s: one of -l, -o or -w/-W must be specified"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
break|break;
block|}
name|bailout
label|:
return|return
operator|(
name|retval
operator|)
return|;
name|bailout_badarg
label|:
name|warnx
argument_list|(
literal|"%s: only one of -l, -o or -w/-W may be specified"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cctl_do_io
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|retries
parameter_list|,
name|union
name|ctl_io
modifier|*
name|io
parameter_list|,
specifier|const
name|char
modifier|*
name|func
parameter_list|)
block|{
do|do
block|{
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|CTL_IO
argument_list|,
name|io
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|warn
argument_list|(
literal|"%s: error sending CTL_IO ioctl"
argument_list|,
name|func
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
do|while
condition|(
operator|(
operator|(
name|io
operator|->
name|io_hdr
operator|.
name|status
operator|&
name|CTL_STATUS_MASK
operator|)
operator|!=
name|CTL_SUCCESS
operator|)
operator|&&
operator|(
name|retries
operator|--
operator|>
literal|0
operator|)
condition|)
do|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cctl_delay
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|lun
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|,
name|char
modifier|*
name|combinedopt
parameter_list|)
block|{
name|struct
name|ctl_io_delay_info
name|delay_info
decl_stmt|;
name|char
modifier|*
name|delayloc
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|delaytype
init|=
name|NULL
decl_stmt|;
name|int
name|delaytime
init|=
operator|-
literal|1
decl_stmt|;
name|int
name|retval
decl_stmt|;
name|int
name|c
decl_stmt|;
name|retval
operator|=
literal|0
expr_stmt|;
name|memset
argument_list|(
operator|&
name|delay_info
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|delay_info
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|combinedopt
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'T'
case|:
name|delaytype
operator|=
name|strdup
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
name|delayloc
operator|=
name|strdup
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
name|delaytime
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|delaytime
operator|==
operator|-
literal|1
condition|)
block|{
name|warnx
argument_list|(
literal|"%s: you must specify the delaytime with -t"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
if|if
condition|(
name|strcasecmp
argument_list|(
name|delayloc
argument_list|,
literal|"datamove"
argument_list|)
operator|==
literal|0
condition|)
name|delay_info
operator|.
name|delay_loc
operator|=
name|CTL_DELAY_LOC_DATAMOVE
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|delayloc
argument_list|,
literal|"done"
argument_list|)
operator|==
literal|0
condition|)
name|delay_info
operator|.
name|delay_loc
operator|=
name|CTL_DELAY_LOC_DONE
expr_stmt|;
else|else
block|{
name|warnx
argument_list|(
literal|"%s: invalid delay location %s"
argument_list|,
name|__func__
argument_list|,
name|delayloc
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
if|if
condition|(
operator|(
name|delaytype
operator|==
name|NULL
operator|)
operator|||
operator|(
name|strcmp
argument_list|(
name|delaytype
argument_list|,
literal|"oneshot"
argument_list|)
operator|==
literal|0
operator|)
condition|)
name|delay_info
operator|.
name|delay_type
operator|=
name|CTL_DELAY_TYPE_ONESHOT
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|delaytype
argument_list|,
literal|"cont"
argument_list|)
operator|==
literal|0
condition|)
name|delay_info
operator|.
name|delay_type
operator|=
name|CTL_DELAY_TYPE_CONT
expr_stmt|;
else|else
block|{
name|warnx
argument_list|(
literal|"%s: invalid delay type %s"
argument_list|,
name|__func__
argument_list|,
name|delaytype
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
name|delay_info
operator|.
name|lun_id
operator|=
name|lun
expr_stmt|;
name|delay_info
operator|.
name|delay_secs
operator|=
name|delaytime
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|CTL_DELAY_IO
argument_list|,
operator|&
name|delay_info
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|warn
argument_list|(
literal|"%s: CTL_DELAY_IO ioctl failed"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
switch|switch
condition|(
name|delay_info
operator|.
name|status
condition|)
block|{
case|case
name|CTL_DELAY_STATUS_NONE
case|:
name|warnx
argument_list|(
literal|"%s: no delay status??"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CTL_DELAY_STATUS_OK
case|:
break|break;
case|case
name|CTL_DELAY_STATUS_INVALID_LUN
case|:
name|warnx
argument_list|(
literal|"%s: invalid lun %d"
argument_list|,
name|__func__
argument_list|,
name|lun
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CTL_DELAY_STATUS_INVALID_TYPE
case|:
name|warnx
argument_list|(
literal|"%s: invalid delay type %d"
argument_list|,
name|__func__
argument_list|,
name|delay_info
operator|.
name|delay_type
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CTL_DELAY_STATUS_INVALID_LOC
case|:
name|warnx
argument_list|(
literal|"%s: delay location %s not implemented?"
argument_list|,
name|__func__
argument_list|,
name|delayloc
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CTL_DELAY_STATUS_NOT_IMPLEMENTED
case|:
name|warnx
argument_list|(
literal|"%s: delay not implemented in the kernel"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|warnx
argument_list|(
literal|"%s: recompile with the CTL_IO_DELAY flag set"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
break|break;
default|default:
name|warnx
argument_list|(
literal|"%s: unknown delay return status %d"
argument_list|,
name|__func__
argument_list|,
name|delay_info
operator|.
name|status
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
break|break;
block|}
name|bailout
label|:
name|free
argument_list|(
name|delayloc
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|delaytype
argument_list|)
expr_stmt|;
return|return
operator|(
name|retval
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|struct
name|ctladm_opts
name|cctl_err_types
index|[]
init|=
block|{
block|{
literal|"aborted"
block|,
name|CTL_LUN_INJ_ABORTED
block|,
name|CTLADM_ARG_NONE
block|,
name|NULL
block|}
block|,
block|{
literal|"mediumerr"
block|,
name|CTL_LUN_INJ_MEDIUM_ERR
block|,
name|CTLADM_ARG_NONE
block|,
name|NULL
block|}
block|,
block|{
literal|"ua"
block|,
name|CTL_LUN_INJ_UA
block|,
name|CTLADM_ARG_NONE
block|,
name|NULL
block|}
block|,
block|{
literal|"custom"
block|,
name|CTL_LUN_INJ_CUSTOM
block|,
name|CTLADM_ARG_NONE
block|,
name|NULL
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|,
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|ctladm_opts
name|cctl_err_patterns
index|[]
init|=
block|{
block|{
literal|"read"
block|,
name|CTL_LUN_PAT_READ
block|,
name|CTLADM_ARG_NONE
block|,
name|NULL
block|}
block|,
block|{
literal|"write"
block|,
name|CTL_LUN_PAT_WRITE
block|,
name|CTLADM_ARG_NONE
block|,
name|NULL
block|}
block|,
block|{
literal|"rw"
block|,
name|CTL_LUN_PAT_READWRITE
block|,
name|CTLADM_ARG_NONE
block|,
name|NULL
block|}
block|,
block|{
literal|"readwrite"
block|,
name|CTL_LUN_PAT_READWRITE
block|,
name|CTLADM_ARG_NONE
block|,
name|NULL
block|}
block|,
block|{
literal|"readcap"
block|,
name|CTL_LUN_PAT_READCAP
block|,
name|CTLADM_ARG_NONE
block|,
name|NULL
block|}
block|,
block|{
literal|"tur"
block|,
name|CTL_LUN_PAT_TUR
block|,
name|CTLADM_ARG_NONE
block|,
name|NULL
block|}
block|,
block|{
literal|"any"
block|,
name|CTL_LUN_PAT_ANY
block|,
name|CTLADM_ARG_NONE
block|,
name|NULL
block|}
block|,
if|#
directive|if
literal|0
block|{"cmd", CTL_LUN_PAT_CMD,  CTLADM_ARG_NONE, NULL},
endif|#
directive|endif
block|{
name|NULL
block|,
literal|0
block|,
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|cctl_error_inject
parameter_list|(
name|int
name|fd
parameter_list|,
name|uint32_t
name|lun
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|,
name|char
modifier|*
name|combinedopt
parameter_list|)
block|{
name|int
name|retval
init|=
literal|0
decl_stmt|;
name|struct
name|ctl_error_desc
name|err_desc
decl_stmt|;
name|uint64_t
name|lba
init|=
literal|0
decl_stmt|;
name|uint32_t
name|len
init|=
literal|0
decl_stmt|;
name|uint64_t
name|delete_id
init|=
literal|0
decl_stmt|;
name|int
name|delete_id_set
init|=
literal|0
decl_stmt|;
name|int
name|continuous
init|=
literal|0
decl_stmt|;
name|int
name|sense_len
init|=
literal|0
decl_stmt|;
name|int
name|fd_sense
init|=
literal|0
decl_stmt|;
name|int
name|c
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|err_desc
argument_list|,
sizeof|sizeof
argument_list|(
name|err_desc
argument_list|)
argument_list|)
expr_stmt|;
name|err_desc
operator|.
name|lun_id
operator|=
name|lun
expr_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|combinedopt
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'c'
case|:
name|continuous
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
name|delete_id
operator|=
name|strtoull
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|delete_id_set
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'i'
case|:
case|case
literal|'p'
case|:
block|{
name|ctladm_optret
name|optret
decl_stmt|;
name|ctladm_cmdargs
name|argnum
decl_stmt|;
specifier|const
name|char
modifier|*
name|subopt
decl_stmt|;
if|if
condition|(
name|c
operator|==
literal|'i'
condition|)
block|{
name|ctl_lun_error
name|err_type
decl_stmt|;
if|if
condition|(
name|err_desc
operator|.
name|lun_error
operator|!=
name|CTL_LUN_INJ_NONE
condition|)
block|{
name|warnx
argument_list|(
literal|"%s: can't specify multiple -i "
literal|"arguments"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
name|optret
operator|=
name|getoption
argument_list|(
name|cctl_err_types
argument_list|,
name|optarg
argument_list|,
operator|&
name|err_type
argument_list|,
operator|&
name|argnum
argument_list|,
operator|&
name|subopt
argument_list|)
expr_stmt|;
name|err_desc
operator|.
name|lun_error
operator|=
name|err_type
expr_stmt|;
block|}
else|else
block|{
name|ctl_lun_error_pattern
name|pattern
decl_stmt|;
name|optret
operator|=
name|getoption
argument_list|(
name|cctl_err_patterns
argument_list|,
name|optarg
argument_list|,
operator|&
name|pattern
argument_list|,
operator|&
name|argnum
argument_list|,
operator|&
name|subopt
argument_list|)
expr_stmt|;
name|err_desc
operator|.
name|error_pattern
operator||=
name|pattern
expr_stmt|;
block|}
if|if
condition|(
name|optret
operator|==
name|CC_OR_AMBIGUOUS
condition|)
block|{
name|warnx
argument_list|(
literal|"%s: ambiguous argument %s"
argument_list|,
name|__func__
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
elseif|else
if|if
condition|(
name|optret
operator|==
name|CC_OR_NOT_FOUND
condition|)
block|{
name|warnx
argument_list|(
literal|"%s: argument %s not found"
argument_list|,
name|__func__
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
break|break;
block|}
case|case
literal|'r'
case|:
block|{
name|char
modifier|*
name|tmpstr
decl_stmt|,
modifier|*
name|tmpstr2
decl_stmt|;
name|tmpstr
operator|=
name|strdup
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmpstr
operator|==
name|NULL
condition|)
block|{
name|warn
argument_list|(
literal|"%s: error duplicating string %s"
argument_list|,
name|__func__
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
name|tmpstr2
operator|=
name|strsep
argument_list|(
operator|&
name|tmpstr
argument_list|,
literal|","
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmpstr2
operator|==
name|NULL
condition|)
block|{
name|warnx
argument_list|(
literal|"%s: invalid -r argument %s"
argument_list|,
name|__func__
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
name|free
argument_list|(
name|tmpstr
argument_list|)
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
name|lba
operator|=
name|strtoull
argument_list|(
name|tmpstr2
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|tmpstr2
operator|=
name|strsep
argument_list|(
operator|&
name|tmpstr
argument_list|,
literal|","
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmpstr2
operator|==
name|NULL
condition|)
block|{
name|warnx
argument_list|(
literal|"%s: no len argument for -r lba,len, got"
literal|" %s"
argument_list|,
name|__func__
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
name|free
argument_list|(
name|tmpstr
argument_list|)
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
name|len
operator|=
name|strtoul
argument_list|(
name|tmpstr2
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|tmpstr
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|'s'
case|:
block|{
name|struct
name|get_hook
name|hook
decl_stmt|;
name|char
modifier|*
name|sensestr
decl_stmt|;
name|sense_len
operator|=
name|strtol
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|sense_len
operator|<=
literal|0
condition|)
block|{
name|warnx
argument_list|(
literal|"invalid number of sense bytes %d"
argument_list|,
name|sense_len
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
name|sense_len
operator|=
name|MIN
argument_list|(
name|sense_len
argument_list|,
name|SSD_FULL_SIZE
argument_list|)
expr_stmt|;
name|hook
operator|.
name|argc
operator|=
name|argc
operator|-
name|optind
expr_stmt|;
name|hook
operator|.
name|argv
operator|=
name|argv
operator|+
name|optind
expr_stmt|;
name|hook
operator|.
name|got
operator|=
literal|0
expr_stmt|;
name|sensestr
operator|=
name|cget
argument_list|(
operator|&
name|hook
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sensestr
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|sensestr
index|[
literal|0
index|]
operator|==
literal|'-'
operator|)
condition|)
block|{
name|fd_sense
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|buff_encode_visit
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|err_desc
operator|.
name|custom_sense
argument_list|,
name|sense_len
argument_list|,
name|sensestr
argument_list|,
name|iget
argument_list|,
operator|&
name|hook
argument_list|)
expr_stmt|;
block|}
name|optind
operator|+=
name|hook
operator|.
name|got
expr_stmt|;
break|break;
block|}
default|default:
break|break;
block|}
block|}
if|if
condition|(
name|delete_id_set
operator|!=
literal|0
condition|)
block|{
name|err_desc
operator|.
name|serial
operator|=
name|delete_id
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|CTL_ERROR_INJECT_DELETE
argument_list|,
operator|&
name|err_desc
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|warn
argument_list|(
literal|"%s: error issuing CTL_ERROR_INJECT_DELETE ioctl"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
block|}
goto|goto
name|bailout
goto|;
block|}
if|if
condition|(
name|err_desc
operator|.
name|lun_error
operator|==
name|CTL_LUN_INJ_NONE
condition|)
block|{
name|warnx
argument_list|(
literal|"%s: error injection command (-i) needed"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
elseif|else
if|if
condition|(
operator|(
name|err_desc
operator|.
name|lun_error
operator|==
name|CTL_LUN_INJ_CUSTOM
operator|)
operator|&&
operator|(
name|sense_len
operator|==
literal|0
operator|)
condition|)
block|{
name|warnx
argument_list|(
literal|"%s: custom error requires -s"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
if|if
condition|(
name|continuous
operator|!=
literal|0
condition|)
name|err_desc
operator|.
name|lun_error
operator||=
name|CTL_LUN_INJ_CONTINUOUS
expr_stmt|;
comment|/* 	 * If fd_sense is set, we need to read the sense data the user 	 * wants returned from stdin. 	 */
if|if
condition|(
name|fd_sense
operator|==
literal|1
condition|)
block|{
name|ssize_t
name|amt_read
decl_stmt|;
name|int
name|amt_to_read
init|=
name|sense_len
decl_stmt|;
name|u_int8_t
modifier|*
name|buf_ptr
init|=
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|err_desc
operator|.
name|custom_sense
decl_stmt|;
for|for
control|(
name|amt_read
operator|=
literal|0
init|;
name|amt_to_read
operator|>
literal|0
condition|;
name|amt_read
operator|=
name|read
argument_list|(
name|STDIN_FILENO
argument_list|,
name|buf_ptr
argument_list|,
name|amt_to_read
argument_list|)
control|)
block|{
if|if
condition|(
name|amt_read
operator|==
operator|-
literal|1
condition|)
block|{
name|warn
argument_list|(
literal|"error reading sense data from stdin"
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
name|amt_to_read
operator|-=
name|amt_read
expr_stmt|;
name|buf_ptr
operator|+=
name|amt_read
expr_stmt|;
block|}
block|}
if|if
condition|(
name|err_desc
operator|.
name|error_pattern
operator|==
name|CTL_LUN_PAT_NONE
condition|)
block|{
name|warnx
argument_list|(
literal|"%s: command pattern (-p) needed"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
if|if
condition|(
name|len
operator|!=
literal|0
condition|)
block|{
name|err_desc
operator|.
name|error_pattern
operator||=
name|CTL_LUN_PAT_RANGE
expr_stmt|;
comment|/* 		 * We could check here to see whether it's a read/write 		 * command, but that will be pointless once we allow 		 * custom patterns.  At that point, the user could specify 		 * a READ(6) CDB type, and we wouldn't have an easy way here 		 * to verify whether range checking is possible there.  The 		 * user will just figure it out when his error never gets 		 * executed. 		 */
if|#
directive|if
literal|0
block|if ((err_desc.pattern& CTL_LUN_PAT_READWRITE) == 0) { 			warnx("%s: need read and/or write pattern if range " 			      "is specified", __func__); 			retval = 1; 			goto bailout; 		}
endif|#
directive|endif
name|err_desc
operator|.
name|lba_range
operator|.
name|lba
operator|=
name|lba
expr_stmt|;
name|err_desc
operator|.
name|lba_range
operator|.
name|len
operator|=
name|len
expr_stmt|;
block|}
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|CTL_ERROR_INJECT
argument_list|,
operator|&
name|err_desc
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|warn
argument_list|(
literal|"%s: error issuing CTL_ERROR_INJECT ioctl"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"Error injection succeeded, serial number is %ju\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|err_desc
operator|.
name|serial
argument_list|)
expr_stmt|;
block|}
name|bailout
label|:
return|return
operator|(
name|retval
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cctl_lunlist
parameter_list|(
name|int
name|fd
parameter_list|)
block|{
name|struct
name|scsi_report_luns_data
modifier|*
name|lun_data
decl_stmt|;
name|struct
name|scsi_inquiry_data
modifier|*
name|inq_data
decl_stmt|;
name|uint32_t
name|num_luns
decl_stmt|;
name|int
name|initid
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
name|int
name|retval
decl_stmt|;
name|inq_data
operator|=
name|NULL
expr_stmt|;
name|initid
operator|=
literal|7
expr_stmt|;
comment|/* 	 * XXX KDM assuming LUN 0 is fine, but we may need to change this 	 * if we ever acquire the ability to have multiple targets. 	 */
if|if
condition|(
operator|(
name|retval
operator|=
name|cctl_get_luns
argument_list|(
name|fd
argument_list|,
comment|/*lun*/
literal|0
argument_list|,
name|initid
argument_list|,
comment|/*retries*/
literal|2
argument_list|,
operator|&
name|lun_data
argument_list|,
operator|&
name|num_luns
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|bailout
goto|;
name|inq_data
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|inq_data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|inq_data
operator|==
name|NULL
condition|)
block|{
name|warn
argument_list|(
literal|"%s: couldn't allocate memory for inquiry data\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_luns
condition|;
name|i
operator|++
control|)
block|{
name|char
name|scsi_path
index|[
literal|40
index|]
decl_stmt|;
name|int
name|lun_val
decl_stmt|;
switch|switch
condition|(
name|lun_data
operator|->
name|luns
index|[
name|i
index|]
operator|.
name|lundata
index|[
literal|0
index|]
operator|&
name|RPL_LUNDATA_ATYP_MASK
condition|)
block|{
case|case
name|RPL_LUNDATA_ATYP_PERIPH
case|:
name|lun_val
operator|=
name|lun_data
operator|->
name|luns
index|[
name|i
index|]
operator|.
name|lundata
index|[
literal|1
index|]
expr_stmt|;
break|break;
case|case
name|RPL_LUNDATA_ATYP_FLAT
case|:
name|lun_val
operator|=
operator|(
name|lun_data
operator|->
name|luns
index|[
name|i
index|]
operator|.
name|lundata
index|[
literal|0
index|]
operator|&
name|RPL_LUNDATA_FLAT_LUN_MASK
operator|)
operator||
operator|(
name|lun_data
operator|->
name|luns
index|[
name|i
index|]
operator|.
name|lundata
index|[
literal|1
index|]
operator|<<
name|RPL_LUNDATA_FLAT_LUN_BITS
operator|)
expr_stmt|;
break|break;
case|case
name|RPL_LUNDATA_ATYP_LUN
case|:
case|case
name|RPL_LUNDATA_ATYP_EXTLUN
case|:
default|default:
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"Unsupported LUN format %d\n"
argument_list|,
name|lun_data
operator|->
name|luns
index|[
name|i
index|]
operator|.
name|lundata
index|[
literal|0
index|]
operator|&
name|RPL_LUNDATA_ATYP_MASK
argument_list|)
expr_stmt|;
name|lun_val
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|lun_val
operator|==
operator|-
literal|1
condition|)
continue|continue;
if|if
condition|(
operator|(
name|retval
operator|=
name|cctl_get_inquiry
argument_list|(
name|fd
argument_list|,
name|lun_val
argument_list|,
name|initid
argument_list|,
comment|/*retries*/
literal|2
argument_list|,
name|scsi_path
argument_list|,
sizeof|sizeof
argument_list|(
name|scsi_path
argument_list|)
argument_list|,
name|inq_data
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
goto|goto
name|bailout
goto|;
block|}
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|scsi_path
argument_list|)
expr_stmt|;
name|scsi_print_inquiry
argument_list|(
name|inq_data
argument_list|)
expr_stmt|;
block|}
name|bailout
label|:
if|if
condition|(
name|lun_data
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|lun_data
argument_list|)
expr_stmt|;
if|if
condition|(
name|inq_data
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|inq_data
argument_list|)
expr_stmt|;
return|return
operator|(
name|retval
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cctl_sync_cache
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|lun
parameter_list|,
name|int
name|iid
parameter_list|,
name|int
name|retries
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|,
name|char
modifier|*
name|combinedopt
parameter_list|)
block|{
name|union
name|ctl_io
modifier|*
name|io
decl_stmt|;
name|int
name|cdb_size
init|=
operator|-
literal|1
decl_stmt|;
name|int
name|retval
decl_stmt|;
name|uint64_t
name|our_lba
init|=
literal|0
decl_stmt|;
name|uint32_t
name|our_block_count
init|=
literal|0
decl_stmt|;
name|int
name|reladr
init|=
literal|0
decl_stmt|,
name|immed
init|=
literal|0
decl_stmt|;
name|int
name|c
decl_stmt|;
name|retval
operator|=
literal|0
expr_stmt|;
name|io
operator|=
name|ctl_scsi_alloc_io
argument_list|(
name|iid
argument_list|)
expr_stmt|;
if|if
condition|(
name|io
operator|==
name|NULL
condition|)
block|{
name|warnx
argument_list|(
literal|"%s: can't allocate memory"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
while|while
condition|(
operator|(
name|c
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|combinedopt
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'b'
case|:
name|our_block_count
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
name|cdb_size
operator|=
name|strtol
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'i'
case|:
name|immed
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
name|our_lba
operator|=
name|strtoull
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'r'
case|:
name|reladr
operator|=
literal|1
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
if|if
condition|(
name|cdb_size
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|cdb_size
condition|)
block|{
case|case
literal|10
case|:
case|case
literal|16
case|:
break|break;
default|default:
name|warnx
argument_list|(
literal|"%s: invalid cdbsize %d, valid sizes are 10 "
literal|"and 16"
argument_list|,
name|__func__
argument_list|,
name|cdb_size
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
break|break;
comment|/* NOTREACHED */
block|}
block|}
else|else
name|cdb_size
operator|=
literal|10
expr_stmt|;
name|ctl_scsi_sync_cache
argument_list|(
comment|/*io*/
name|io
argument_list|,
comment|/*immed*/
name|immed
argument_list|,
comment|/*reladr*/
name|reladr
argument_list|,
comment|/*minimum_cdb_size*/
name|cdb_size
argument_list|,
comment|/*starting_lba*/
name|our_lba
argument_list|,
comment|/*block_count*/
name|our_block_count
argument_list|,
comment|/*tag_type*/
name|CTL_TAG_SIMPLE
argument_list|,
comment|/*control*/
literal|0
argument_list|)
expr_stmt|;
name|io
operator|->
name|io_hdr
operator|.
name|nexus
operator|.
name|targ_lun
operator|=
name|lun
expr_stmt|;
name|io
operator|->
name|io_hdr
operator|.
name|nexus
operator|.
name|initid
operator|=
name|iid
expr_stmt|;
if|if
condition|(
name|cctl_do_io
argument_list|(
name|fd
argument_list|,
name|retries
argument_list|,
name|io
argument_list|,
name|__func__
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
if|if
condition|(
operator|(
name|io
operator|->
name|io_hdr
operator|.
name|status
operator|&
name|CTL_STATUS_MASK
operator|)
operator|==
name|CTL_SUCCESS
condition|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"Cache synchronized successfully\n"
argument_list|)
expr_stmt|;
block|}
else|else
name|ctl_io_error_print
argument_list|(
name|io
argument_list|,
name|NULL
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
name|bailout
label|:
name|ctl_scsi_free_io
argument_list|(
name|io
argument_list|)
expr_stmt|;
return|return
operator|(
name|retval
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cctl_start_stop
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|lun
parameter_list|,
name|int
name|iid
parameter_list|,
name|int
name|retries
parameter_list|,
name|int
name|start
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|,
name|char
modifier|*
name|combinedopt
parameter_list|)
block|{
name|union
name|ctl_io
modifier|*
name|io
decl_stmt|;
name|char
name|scsi_path
index|[
literal|40
index|]
decl_stmt|;
name|int
name|immed
init|=
literal|0
decl_stmt|;
name|int
name|retval
decl_stmt|,
name|c
decl_stmt|;
name|retval
operator|=
literal|0
expr_stmt|;
name|io
operator|=
name|ctl_scsi_alloc_io
argument_list|(
name|iid
argument_list|)
expr_stmt|;
if|if
condition|(
name|io
operator|==
name|NULL
condition|)
block|{
name|warnx
argument_list|(
literal|"%s: can't allocate memory"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
while|while
condition|(
operator|(
name|c
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|combinedopt
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'i'
case|:
name|immed
operator|=
literal|1
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
comment|/* 	 * Use an ordered tag for the stop command, to guarantee that any 	 * pending I/O will finish before the stop command executes.  This 	 * would normally be the case anyway, since CTL will basically 	 * treat the start/stop command as an ordered command with respect 	 * to any other command except an INQUIRY.  (See ctl_ser_table.c.) 	 */
name|ctl_scsi_start_stop
argument_list|(
comment|/*io*/
name|io
argument_list|,
comment|/*start*/
name|start
argument_list|,
comment|/*load_eject*/
literal|0
argument_list|,
comment|/*immediate*/
name|immed
argument_list|,
comment|/*power_conditions*/
name|SSS_PC_START_VALID
argument_list|,
comment|/*ctl_tag_type*/
name|start
condition|?
name|CTL_TAG_SIMPLE
else|:
name|CTL_TAG_ORDERED
argument_list|,
comment|/*control*/
literal|0
argument_list|)
expr_stmt|;
name|io
operator|->
name|io_hdr
operator|.
name|nexus
operator|.
name|targ_lun
operator|=
name|lun
expr_stmt|;
name|io
operator|->
name|io_hdr
operator|.
name|nexus
operator|.
name|initid
operator|=
name|iid
expr_stmt|;
if|if
condition|(
name|cctl_do_io
argument_list|(
name|fd
argument_list|,
name|retries
argument_list|,
name|io
argument_list|,
name|__func__
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
name|ctl_scsi_path_string
argument_list|(
name|io
argument_list|,
name|scsi_path
argument_list|,
sizeof|sizeof
argument_list|(
name|scsi_path
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|io
operator|->
name|io_hdr
operator|.
name|status
operator|&
name|CTL_STATUS_MASK
operator|)
operator|==
name|CTL_SUCCESS
condition|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"%s LUN %s successfully\n"
argument_list|,
name|scsi_path
argument_list|,
operator|(
name|start
operator|)
condition|?
literal|"started"
else|:
literal|"stopped"
argument_list|)
expr_stmt|;
block|}
else|else
name|ctl_io_error_print
argument_list|(
name|io
argument_list|,
name|NULL
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
name|bailout
label|:
name|ctl_scsi_free_io
argument_list|(
name|io
argument_list|)
expr_stmt|;
return|return
operator|(
name|retval
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cctl_mode_sense
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|lun
parameter_list|,
name|int
name|iid
parameter_list|,
name|int
name|retries
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|,
name|char
modifier|*
name|combinedopt
parameter_list|)
block|{
name|union
name|ctl_io
modifier|*
name|io
decl_stmt|;
name|uint32_t
name|datalen
decl_stmt|;
name|uint8_t
modifier|*
name|dataptr
decl_stmt|;
name|int
name|pc
init|=
operator|-
literal|1
decl_stmt|,
name|cdbsize
decl_stmt|,
name|retval
decl_stmt|,
name|dbd
init|=
literal|0
decl_stmt|,
name|subpage
init|=
operator|-
literal|1
decl_stmt|;
name|int
name|list
init|=
literal|0
decl_stmt|;
name|int
name|page_code
init|=
operator|-
literal|1
decl_stmt|;
name|int
name|c
decl_stmt|;
name|cdbsize
operator|=
literal|0
expr_stmt|;
name|retval
operator|=
literal|0
expr_stmt|;
name|dataptr
operator|=
name|NULL
expr_stmt|;
name|io
operator|=
name|ctl_scsi_alloc_io
argument_list|(
name|iid
argument_list|)
expr_stmt|;
if|if
condition|(
name|io
operator|==
name|NULL
condition|)
block|{
name|warn
argument_list|(
literal|"%s: can't allocate memory"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
while|while
condition|(
operator|(
name|c
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|combinedopt
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'P'
case|:
name|pc
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'S'
case|:
name|subpage
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
name|dbd
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
name|list
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'m'
case|:
name|page_code
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
name|cdbsize
operator|=
name|strtol
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
if|if
condition|(
operator|(
operator|(
name|list
operator|==
literal|0
operator|)
operator|&&
operator|(
name|page_code
operator|==
operator|-
literal|1
operator|)
operator|)
operator|||
operator|(
operator|(
name|list
operator|!=
literal|0
operator|)
operator|&&
operator|(
name|page_code
operator|!=
operator|-
literal|1
operator|)
operator|)
condition|)
block|{
name|warnx
argument_list|(
literal|"%s: you must specify either a page code (-m) or -l"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
if|if
condition|(
operator|(
name|page_code
operator|!=
operator|-
literal|1
operator|)
operator|&&
operator|(
operator|(
name|page_code
operator|>
name|SMS_ALL_PAGES_PAGE
operator|)
operator|||
operator|(
name|page_code
operator|<
literal|0
operator|)
operator|)
condition|)
block|{
name|warnx
argument_list|(
literal|"%s: page code %d is out of range"
argument_list|,
name|__func__
argument_list|,
name|page_code
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
if|if
condition|(
name|list
operator|==
literal|1
condition|)
block|{
name|page_code
operator|=
name|SMS_ALL_PAGES_PAGE
expr_stmt|;
if|if
condition|(
name|pc
operator|!=
operator|-
literal|1
condition|)
block|{
name|warnx
argument_list|(
literal|"%s: arg -P makes no sense with -l"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
if|if
condition|(
name|subpage
operator|!=
operator|-
literal|1
condition|)
block|{
name|warnx
argument_list|(
literal|"%s: arg -S makes no sense with -l"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
block|}
if|if
condition|(
name|pc
operator|==
operator|-
literal|1
condition|)
name|pc
operator|=
name|SMS_PAGE_CTRL_CURRENT
expr_stmt|;
else|else
block|{
if|if
condition|(
operator|(
name|pc
operator|>
literal|3
operator|)
operator|||
operator|(
name|pc
operator|<
literal|0
operator|)
condition|)
block|{
name|warnx
argument_list|(
literal|"%s: page control value %d is out of range: 0-3"
argument_list|,
name|__func__
argument_list|,
name|pc
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
block|}
if|if
condition|(
operator|(
name|subpage
operator|!=
operator|-
literal|1
operator|)
operator|&&
operator|(
operator|(
name|subpage
operator|>
literal|255
operator|)
operator|||
operator|(
name|subpage
operator|<
literal|0
operator|)
operator|)
condition|)
block|{
name|warnx
argument_list|(
literal|"%s: subpage code %d is out of range: 0-255"
argument_list|,
name|__func__
argument_list|,
name|subpage
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
if|if
condition|(
name|cdbsize
operator|!=
literal|0
condition|)
block|{
switch|switch
condition|(
name|cdbsize
condition|)
block|{
case|case
literal|6
case|:
case|case
literal|10
case|:
break|break;
default|default:
name|warnx
argument_list|(
literal|"%s: invalid cdbsize %d, valid sizes are 6 "
literal|"and 10"
argument_list|,
name|__func__
argument_list|,
name|cdbsize
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
break|break;
block|}
block|}
else|else
name|cdbsize
operator|=
literal|6
expr_stmt|;
if|if
condition|(
name|subpage
operator|==
operator|-
literal|1
condition|)
name|subpage
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|cdbsize
operator|==
literal|6
condition|)
name|datalen
operator|=
literal|255
expr_stmt|;
else|else
name|datalen
operator|=
literal|65535
expr_stmt|;
name|dataptr
operator|=
operator|(
name|uint8_t
operator|*
operator|)
name|malloc
argument_list|(
name|datalen
argument_list|)
expr_stmt|;
if|if
condition|(
name|dataptr
operator|==
name|NULL
condition|)
block|{
name|warn
argument_list|(
literal|"%s: can't allocate %d bytes"
argument_list|,
name|__func__
argument_list|,
name|datalen
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
name|memset
argument_list|(
name|dataptr
argument_list|,
literal|0
argument_list|,
name|datalen
argument_list|)
expr_stmt|;
name|ctl_scsi_mode_sense
argument_list|(
name|io
argument_list|,
comment|/*data_ptr*/
name|dataptr
argument_list|,
comment|/*data_len*/
name|datalen
argument_list|,
comment|/*dbd*/
name|dbd
argument_list|,
comment|/*llbaa*/
literal|0
argument_list|,
comment|/*page_code*/
name|page_code
argument_list|,
comment|/*pc*/
name|pc
operator|<<
literal|6
argument_list|,
comment|/*subpage*/
name|subpage
argument_list|,
comment|/*minimum_cdb_size*/
name|cdbsize
argument_list|,
comment|/*tag_type*/
name|CTL_TAG_SIMPLE
argument_list|,
comment|/*control*/
literal|0
argument_list|)
expr_stmt|;
name|io
operator|->
name|io_hdr
operator|.
name|nexus
operator|.
name|targ_lun
operator|=
name|lun
expr_stmt|;
name|io
operator|->
name|io_hdr
operator|.
name|nexus
operator|.
name|initid
operator|=
name|iid
expr_stmt|;
if|if
condition|(
name|cctl_do_io
argument_list|(
name|fd
argument_list|,
name|retries
argument_list|,
name|io
argument_list|,
name|__func__
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
if|if
condition|(
operator|(
name|io
operator|->
name|io_hdr
operator|.
name|status
operator|&
name|CTL_STATUS_MASK
operator|)
operator|==
name|CTL_SUCCESS
condition|)
block|{
name|int
name|pages_len
decl_stmt|,
name|used_len
decl_stmt|;
name|uint32_t
name|returned_len
decl_stmt|;
name|uint8_t
modifier|*
name|ndataptr
decl_stmt|;
if|if
condition|(
name|io
operator|->
name|scsiio
operator|.
name|cdb
index|[
literal|0
index|]
operator|==
name|MODE_SENSE_6
condition|)
block|{
name|struct
name|scsi_mode_hdr_6
modifier|*
name|hdr6
decl_stmt|;
name|int
name|bdlen
decl_stmt|;
name|hdr6
operator|=
operator|(
expr|struct
name|scsi_mode_hdr_6
operator|*
operator|)
name|dataptr
expr_stmt|;
name|returned_len
operator|=
name|hdr6
operator|->
name|datalen
operator|+
literal|1
expr_stmt|;
name|bdlen
operator|=
name|hdr6
operator|->
name|block_descr_len
expr_stmt|;
name|ndataptr
operator|=
operator|(
name|uint8_t
operator|*
operator|)
operator|(
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|hdr6
index|[
literal|1
index|]
operator|+
name|bdlen
operator|)
expr_stmt|;
block|}
else|else
block|{
name|struct
name|scsi_mode_hdr_10
modifier|*
name|hdr10
decl_stmt|;
name|int
name|bdlen
decl_stmt|;
name|hdr10
operator|=
operator|(
expr|struct
name|scsi_mode_hdr_10
operator|*
operator|)
name|dataptr
expr_stmt|;
name|returned_len
operator|=
name|scsi_2btoul
argument_list|(
name|hdr10
operator|->
name|datalen
argument_list|)
operator|+
literal|2
expr_stmt|;
name|bdlen
operator|=
name|scsi_2btoul
argument_list|(
name|hdr10
operator|->
name|block_descr_len
argument_list|)
expr_stmt|;
name|ndataptr
operator|=
operator|(
name|uint8_t
operator|*
operator|)
operator|(
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|hdr10
index|[
literal|1
index|]
operator|+
name|bdlen
operator|)
expr_stmt|;
block|}
comment|/* just in case they can give us more than we allocated for */
name|returned_len
operator|=
name|min
argument_list|(
name|returned_len
argument_list|,
name|datalen
argument_list|)
expr_stmt|;
name|pages_len
operator|=
name|returned_len
operator|-
operator|(
name|ndataptr
operator|-
name|dataptr
operator|)
expr_stmt|;
if|#
directive|if
literal|0
block|fprintf(stdout, "returned_len = %d, pages_len = %d\n", 			returned_len, pages_len);
endif|#
directive|endif
if|if
condition|(
name|list
operator|==
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"Supported mode pages:\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|used_len
operator|=
literal|0
init|;
name|used_len
operator|<
name|pages_len
condition|;
control|)
block|{
name|struct
name|scsi_mode_page_header
modifier|*
name|header
decl_stmt|;
name|header
operator|=
operator|(
expr|struct
name|scsi_mode_page_header
operator|*
operator|)
operator|&
name|ndataptr
index|[
name|used_len
index|]
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"%d\n"
argument_list|,
name|header
operator|->
name|page_code
argument_list|)
expr_stmt|;
name|used_len
operator|+=
name|header
operator|->
name|page_length
operator|+
literal|2
expr_stmt|;
block|}
block|}
else|else
block|{
for|for
control|(
name|used_len
operator|=
literal|0
init|;
name|used_len
operator|<
name|pages_len
condition|;
name|used_len
operator|++
control|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"0x%x "
argument_list|,
name|ndataptr
index|[
name|used_len
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|used_len
operator|+
literal|1
operator|)
operator|%
literal|16
operator|)
operator|==
literal|0
condition|)
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
else|else
name|ctl_io_error_print
argument_list|(
name|io
argument_list|,
name|NULL
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
name|bailout
label|:
name|ctl_scsi_free_io
argument_list|(
name|io
argument_list|)
expr_stmt|;
if|if
condition|(
name|dataptr
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|dataptr
argument_list|)
expr_stmt|;
return|return
operator|(
name|retval
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cctl_read_capacity
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|lun
parameter_list|,
name|int
name|iid
parameter_list|,
name|int
name|retries
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|,
name|char
modifier|*
name|combinedopt
parameter_list|)
block|{
name|union
name|ctl_io
modifier|*
name|io
decl_stmt|;
name|struct
name|scsi_read_capacity_data
modifier|*
name|data
decl_stmt|;
name|struct
name|scsi_read_capacity_data_long
modifier|*
name|longdata
decl_stmt|;
name|int
name|cdbsize
init|=
operator|-
literal|1
decl_stmt|,
name|retval
decl_stmt|;
name|uint8_t
modifier|*
name|dataptr
decl_stmt|;
name|int
name|c
decl_stmt|;
name|cdbsize
operator|=
literal|10
expr_stmt|;
name|dataptr
operator|=
name|NULL
expr_stmt|;
name|retval
operator|=
literal|0
expr_stmt|;
name|io
operator|=
name|ctl_scsi_alloc_io
argument_list|(
name|iid
argument_list|)
expr_stmt|;
if|if
condition|(
name|io
operator|==
name|NULL
condition|)
block|{
name|warn
argument_list|(
literal|"%s: can't allocate memory\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
while|while
condition|(
operator|(
name|c
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|combinedopt
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'c'
case|:
name|cdbsize
operator|=
name|strtol
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
if|if
condition|(
name|cdbsize
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|cdbsize
condition|)
block|{
case|case
literal|10
case|:
case|case
literal|16
case|:
break|break;
default|default:
name|warnx
argument_list|(
literal|"%s: invalid cdbsize %d, valid sizes are 10 "
literal|"and 16"
argument_list|,
name|__func__
argument_list|,
name|cdbsize
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
break|break;
comment|/* NOTREACHED */
block|}
block|}
else|else
name|cdbsize
operator|=
literal|10
expr_stmt|;
name|dataptr
operator|=
operator|(
name|uint8_t
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|longdata
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dataptr
operator|==
name|NULL
condition|)
block|{
name|warn
argument_list|(
literal|"%s: can't allocate %zd bytes\n"
argument_list|,
name|__func__
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|longdata
argument_list|)
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
name|memset
argument_list|(
name|dataptr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|longdata
argument_list|)
argument_list|)
expr_stmt|;
name|retry
label|:
switch|switch
condition|(
name|cdbsize
condition|)
block|{
case|case
literal|10
case|:
name|ctl_scsi_read_capacity
argument_list|(
name|io
argument_list|,
comment|/*data_ptr*/
name|dataptr
argument_list|,
comment|/*data_len*/
sizeof|sizeof
argument_list|(
operator|*
name|longdata
argument_list|)
argument_list|,
comment|/*addr*/
literal|0
argument_list|,
comment|/*reladr*/
literal|0
argument_list|,
comment|/*pmi*/
literal|0
argument_list|,
comment|/*tag_type*/
name|CTL_TAG_SIMPLE
argument_list|,
comment|/*control*/
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|16
case|:
name|ctl_scsi_read_capacity_16
argument_list|(
name|io
argument_list|,
comment|/*data_ptr*/
name|dataptr
argument_list|,
comment|/*data_len*/
sizeof|sizeof
argument_list|(
operator|*
name|longdata
argument_list|)
argument_list|,
comment|/*addr*/
literal|0
argument_list|,
comment|/*reladr*/
literal|0
argument_list|,
comment|/*pmi*/
literal|0
argument_list|,
comment|/*tag_type*/
name|CTL_TAG_SIMPLE
argument_list|,
comment|/*control*/
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
name|io
operator|->
name|io_hdr
operator|.
name|nexus
operator|.
name|initid
operator|=
name|iid
expr_stmt|;
name|io
operator|->
name|io_hdr
operator|.
name|nexus
operator|.
name|targ_lun
operator|=
name|lun
expr_stmt|;
if|if
condition|(
name|cctl_do_io
argument_list|(
name|fd
argument_list|,
name|retries
argument_list|,
name|io
argument_list|,
name|__func__
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
if|if
condition|(
operator|(
name|io
operator|->
name|io_hdr
operator|.
name|status
operator|&
name|CTL_STATUS_MASK
operator|)
operator|==
name|CTL_SUCCESS
condition|)
block|{
name|uint64_t
name|maxlba
decl_stmt|;
name|uint32_t
name|blocksize
decl_stmt|;
if|if
condition|(
name|cdbsize
operator|==
literal|10
condition|)
block|{
name|data
operator|=
operator|(
expr|struct
name|scsi_read_capacity_data
operator|*
operator|)
name|dataptr
expr_stmt|;
name|maxlba
operator|=
name|scsi_4btoul
argument_list|(
name|data
operator|->
name|addr
argument_list|)
expr_stmt|;
name|blocksize
operator|=
name|scsi_4btoul
argument_list|(
name|data
operator|->
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|maxlba
operator|==
literal|0xffffffff
condition|)
block|{
name|cdbsize
operator|=
literal|16
expr_stmt|;
goto|goto
name|retry
goto|;
block|}
block|}
else|else
block|{
name|longdata
operator|=
operator|(
expr|struct
name|scsi_read_capacity_data_long
operator|*
operator|)
name|dataptr
expr_stmt|;
name|maxlba
operator|=
name|scsi_8btou64
argument_list|(
name|longdata
operator|->
name|addr
argument_list|)
expr_stmt|;
name|blocksize
operator|=
name|scsi_4btoul
argument_list|(
name|longdata
operator|->
name|length
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"Disk Capacity: %ju, Blocksize: %d\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|maxlba
argument_list|,
name|blocksize
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ctl_io_error_print
argument_list|(
name|io
argument_list|,
name|NULL
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
block|}
name|bailout
label|:
name|ctl_scsi_free_io
argument_list|(
name|io
argument_list|)
expr_stmt|;
if|if
condition|(
name|dataptr
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|dataptr
argument_list|)
expr_stmt|;
return|return
operator|(
name|retval
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cctl_read_write
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|lun
parameter_list|,
name|int
name|iid
parameter_list|,
name|int
name|retries
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|,
name|char
modifier|*
name|combinedopt
parameter_list|,
name|ctladm_cmdfunction
name|command
parameter_list|)
block|{
name|union
name|ctl_io
modifier|*
name|io
decl_stmt|;
name|int
name|file_fd
decl_stmt|,
name|do_stdio
decl_stmt|;
name|int
name|cdbsize
init|=
operator|-
literal|1
decl_stmt|,
name|databytes
decl_stmt|;
name|uint8_t
modifier|*
name|dataptr
decl_stmt|;
name|char
modifier|*
name|filename
init|=
name|NULL
decl_stmt|;
name|int
name|datalen
init|=
operator|-
literal|1
decl_stmt|,
name|blocksize
init|=
operator|-
literal|1
decl_stmt|;
name|uint64_t
name|lba
init|=
literal|0
decl_stmt|;
name|int
name|lba_set
init|=
literal|0
decl_stmt|;
name|int
name|retval
decl_stmt|;
name|int
name|c
decl_stmt|;
name|retval
operator|=
literal|0
expr_stmt|;
name|do_stdio
operator|=
literal|0
expr_stmt|;
name|dataptr
operator|=
name|NULL
expr_stmt|;
name|file_fd
operator|=
operator|-
literal|1
expr_stmt|;
name|io
operator|=
name|ctl_scsi_alloc_io
argument_list|(
name|iid
argument_list|)
expr_stmt|;
if|if
condition|(
name|io
operator|==
name|NULL
condition|)
block|{
name|warn
argument_list|(
literal|"%s: can't allocate memory\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
while|while
condition|(
operator|(
name|c
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|combinedopt
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'N'
case|:
name|io
operator|->
name|io_hdr
operator|.
name|flags
operator||=
name|CTL_FLAG_NO_DATAMOVE
expr_stmt|;
break|break;
case|case
literal|'b'
case|:
name|blocksize
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
name|cdbsize
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
name|datalen
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'f'
case|:
name|filename
operator|=
name|strdup
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
name|lba
operator|=
name|strtoull
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|lba_set
operator|=
literal|1
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
if|if
condition|(
name|filename
operator|==
name|NULL
condition|)
block|{
name|warnx
argument_list|(
literal|"%s: you must supply a filename using -f"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
if|if
condition|(
name|datalen
operator|==
operator|-
literal|1
condition|)
block|{
name|warnx
argument_list|(
literal|"%s: you must specify the data length with -d"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
if|if
condition|(
name|lba_set
operator|==
literal|0
condition|)
block|{
name|warnx
argument_list|(
literal|"%s: you must specify the LBA with -l"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
if|if
condition|(
name|blocksize
operator|==
operator|-
literal|1
condition|)
block|{
name|warnx
argument_list|(
literal|"%s: you must specify the blocksize with -b"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
if|if
condition|(
name|cdbsize
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|cdbsize
condition|)
block|{
case|case
literal|6
case|:
case|case
literal|10
case|:
case|case
literal|12
case|:
case|case
literal|16
case|:
break|break;
default|default:
name|warnx
argument_list|(
literal|"%s: invalid cdbsize %d, valid sizes are 6, "
literal|"10, 12 or 16"
argument_list|,
name|__func__
argument_list|,
name|cdbsize
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
break|break;
comment|/* NOTREACHED */
block|}
block|}
else|else
name|cdbsize
operator|=
literal|6
expr_stmt|;
name|databytes
operator|=
name|datalen
operator|*
name|blocksize
expr_stmt|;
name|dataptr
operator|=
operator|(
name|uint8_t
operator|*
operator|)
name|malloc
argument_list|(
name|databytes
argument_list|)
expr_stmt|;
if|if
condition|(
name|dataptr
operator|==
name|NULL
condition|)
block|{
name|warn
argument_list|(
literal|"%s: can't allocate %d bytes\n"
argument_list|,
name|__func__
argument_list|,
name|databytes
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|filename
argument_list|,
literal|"-"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|command
operator|==
name|CTLADM_CMD_READ
condition|)
name|file_fd
operator|=
name|STDOUT_FILENO
expr_stmt|;
else|else
name|file_fd
operator|=
name|STDIN_FILENO
expr_stmt|;
name|do_stdio
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|file_fd
operator|=
name|open
argument_list|(
name|filename
argument_list|,
name|O_RDWR
operator||
name|O_CREAT
argument_list|,
name|S_IRUSR
operator||
name|S_IWUSR
argument_list|)
expr_stmt|;
if|if
condition|(
name|file_fd
operator|==
operator|-
literal|1
condition|)
block|{
name|warn
argument_list|(
literal|"%s: can't open file %s"
argument_list|,
name|__func__
argument_list|,
name|filename
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
block|}
name|memset
argument_list|(
name|dataptr
argument_list|,
literal|0
argument_list|,
name|databytes
argument_list|)
expr_stmt|;
if|if
condition|(
name|command
operator|==
name|CTLADM_CMD_WRITE
condition|)
block|{
name|int
name|bytes_read
decl_stmt|;
name|bytes_read
operator|=
name|read
argument_list|(
name|file_fd
argument_list|,
name|dataptr
argument_list|,
name|databytes
argument_list|)
expr_stmt|;
if|if
condition|(
name|bytes_read
operator|==
operator|-
literal|1
condition|)
block|{
name|warn
argument_list|(
literal|"%s: error reading file %s"
argument_list|,
name|__func__
argument_list|,
name|filename
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
if|if
condition|(
name|bytes_read
operator|!=
name|databytes
condition|)
block|{
name|warnx
argument_list|(
literal|"%s: only read %d bytes from file %s"
argument_list|,
name|__func__
argument_list|,
name|bytes_read
argument_list|,
name|filename
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
block|}
name|ctl_scsi_read_write
argument_list|(
name|io
argument_list|,
comment|/*data_ptr*/
name|dataptr
argument_list|,
comment|/*data_len*/
name|databytes
argument_list|,
comment|/*read_op*/
operator|(
name|command
operator|==
name|CTLADM_CMD_READ
operator|)
condition|?
literal|1
else|:
literal|0
argument_list|,
comment|/*byte2*/
literal|0
argument_list|,
comment|/*minimum_cdb_size*/
name|cdbsize
argument_list|,
comment|/*lba*/
name|lba
argument_list|,
comment|/*num_blocks*/
name|datalen
argument_list|,
comment|/*tag_type*/
name|CTL_TAG_SIMPLE
argument_list|,
comment|/*control*/
literal|0
argument_list|)
expr_stmt|;
name|io
operator|->
name|io_hdr
operator|.
name|nexus
operator|.
name|targ_lun
operator|=
name|lun
expr_stmt|;
name|io
operator|->
name|io_hdr
operator|.
name|nexus
operator|.
name|initid
operator|=
name|iid
expr_stmt|;
if|if
condition|(
name|cctl_do_io
argument_list|(
name|fd
argument_list|,
name|retries
argument_list|,
name|io
argument_list|,
name|__func__
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
if|if
condition|(
operator|(
operator|(
name|io
operator|->
name|io_hdr
operator|.
name|status
operator|&
name|CTL_STATUS_MASK
operator|)
operator|==
name|CTL_SUCCESS
operator|)
operator|&&
operator|(
name|command
operator|==
name|CTLADM_CMD_READ
operator|)
condition|)
block|{
name|int
name|bytes_written
decl_stmt|;
name|bytes_written
operator|=
name|write
argument_list|(
name|file_fd
argument_list|,
name|dataptr
argument_list|,
name|databytes
argument_list|)
expr_stmt|;
if|if
condition|(
name|bytes_written
operator|==
operator|-
literal|1
condition|)
block|{
name|warn
argument_list|(
literal|"%s: can't write to %s"
argument_list|,
name|__func__
argument_list|,
name|filename
argument_list|)
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
block|}
elseif|else
if|if
condition|(
operator|(
name|io
operator|->
name|io_hdr
operator|.
name|status
operator|&
name|CTL_STATUS_MASK
operator|)
operator|!=
name|CTL_SUCCESS
condition|)
name|ctl_io_error_print
argument_list|(
name|io
argument_list|,
name|NULL
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
name|bailout
label|:
name|ctl_scsi_free_io
argument_list|(
name|io
argument_list|)
expr_stmt|;
if|if
condition|(
name|dataptr
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|dataptr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|do_stdio
operator|==
literal|0
operator|)
operator|&&
operator|(
name|file_fd
operator|!=
operator|-
literal|1
operator|)
condition|)
name|close
argument_list|(
name|file_fd
argument_list|)
expr_stmt|;
return|return
operator|(
name|retval
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cctl_get_luns
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|lun
parameter_list|,
name|int
name|iid
parameter_list|,
name|int
name|retries
parameter_list|,
name|struct
name|scsi_report_luns_data
modifier|*
modifier|*
name|lun_data
parameter_list|,
name|uint32_t
modifier|*
name|num_luns
parameter_list|)
block|{
name|union
name|ctl_io
modifier|*
name|io
decl_stmt|;
name|uint32_t
name|nluns
decl_stmt|;
name|int
name|lun_datalen
decl_stmt|;
name|int
name|retval
decl_stmt|;
name|retval
operator|=
literal|0
expr_stmt|;
name|io
operator|=
name|ctl_scsi_alloc_io
argument_list|(
name|iid
argument_list|)
expr_stmt|;
if|if
condition|(
name|io
operator|==
name|NULL
condition|)
block|{
name|warnx
argument_list|(
literal|"%s: can't allocate memory"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
comment|/* 	 * lun_data includes space for 1 lun, allocate space for 4 initially. 	 * If that isn't enough, we'll allocate more. 	 */
name|nluns
operator|=
literal|4
expr_stmt|;
name|retry
label|:
name|lun_datalen
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|lun_data
argument_list|)
operator|+
operator|(
name|nluns
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|scsi_report_luns_lundata
argument_list|)
operator|)
expr_stmt|;
operator|*
name|lun_data
operator|=
name|malloc
argument_list|(
name|lun_datalen
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|lun_data
operator|==
name|NULL
condition|)
block|{
name|warnx
argument_list|(
literal|"%s: can't allocate memory"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|ctl_scsi_free_io
argument_list|(
name|io
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|ctl_scsi_report_luns
argument_list|(
name|io
argument_list|,
comment|/*data_ptr*/
operator|(
name|uint8_t
operator|*
operator|)
operator|*
name|lun_data
argument_list|,
comment|/*data_len*/
name|lun_datalen
argument_list|,
comment|/*select_report*/
name|RPL_REPORT_ALL
argument_list|,
comment|/*tag_type*/
name|CTL_TAG_SIMPLE
argument_list|,
comment|/*control*/
literal|0
argument_list|)
expr_stmt|;
name|io
operator|->
name|io_hdr
operator|.
name|nexus
operator|.
name|initid
operator|=
name|iid
expr_stmt|;
name|io
operator|->
name|io_hdr
operator|.
name|nexus
operator|.
name|targ_lun
operator|=
name|lun
expr_stmt|;
if|if
condition|(
name|cctl_do_io
argument_list|(
name|fd
argument_list|,
name|retries
argument_list|,
name|io
argument_list|,
name|__func__
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
if|if
condition|(
operator|(
name|io
operator|->
name|io_hdr
operator|.
name|status
operator|&
name|CTL_STATUS_MASK
operator|)
operator|==
name|CTL_SUCCESS
condition|)
block|{
name|uint32_t
name|returned_len
decl_stmt|,
name|returned_luns
decl_stmt|;
name|returned_len
operator|=
name|scsi_4btoul
argument_list|(
operator|(
operator|*
name|lun_data
operator|)
operator|->
name|length
argument_list|)
expr_stmt|;
name|returned_luns
operator|=
name|returned_len
operator|/
literal|8
expr_stmt|;
if|if
condition|(
name|returned_luns
operator|>
name|nluns
condition|)
block|{
name|nluns
operator|=
name|returned_luns
expr_stmt|;
name|free
argument_list|(
operator|*
name|lun_data
argument_list|)
expr_stmt|;
goto|goto
name|retry
goto|;
block|}
comment|/* These should be the same */
operator|*
name|num_luns
operator|=
name|MIN
argument_list|(
name|returned_luns
argument_list|,
name|nluns
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ctl_io_error_print
argument_list|(
name|io
argument_list|,
name|NULL
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
block|}
name|bailout
label|:
name|ctl_scsi_free_io
argument_list|(
name|io
argument_list|)
expr_stmt|;
return|return
operator|(
name|retval
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cctl_report_luns
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|lun
parameter_list|,
name|int
name|iid
parameter_list|,
name|int
name|retries
parameter_list|)
block|{
name|struct
name|scsi_report_luns_data
modifier|*
name|lun_data
decl_stmt|;
name|uint32_t
name|num_luns
decl_stmt|,
name|i
decl_stmt|;
name|int
name|retval
decl_stmt|;
name|lun_data
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|(
name|retval
operator|=
name|cctl_get_luns
argument_list|(
name|fd
argument_list|,
name|lun
argument_list|,
name|iid
argument_list|,
name|retries
argument_list|,
operator|&
name|lun_data
argument_list|,
operator|&
name|num_luns
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|bailout
goto|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"%u LUNs returned\n"
argument_list|,
name|num_luns
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_luns
condition|;
name|i
operator|++
control|)
block|{
name|int
name|lun_val
decl_stmt|;
comment|/* 		 * XXX KDM figure out a way to share this code with 		 * cctl_lunlist()? 		 */
switch|switch
condition|(
name|lun_data
operator|->
name|luns
index|[
name|i
index|]
operator|.
name|lundata
index|[
literal|0
index|]
operator|&
name|RPL_LUNDATA_ATYP_MASK
condition|)
block|{
case|case
name|RPL_LUNDATA_ATYP_PERIPH
case|:
name|lun_val
operator|=
name|lun_data
operator|->
name|luns
index|[
name|i
index|]
operator|.
name|lundata
index|[
literal|1
index|]
expr_stmt|;
break|break;
case|case
name|RPL_LUNDATA_ATYP_FLAT
case|:
name|lun_val
operator|=
operator|(
name|lun_data
operator|->
name|luns
index|[
name|i
index|]
operator|.
name|lundata
index|[
literal|0
index|]
operator|&
name|RPL_LUNDATA_FLAT_LUN_MASK
operator|)
operator||
operator|(
name|lun_data
operator|->
name|luns
index|[
name|i
index|]
operator|.
name|lundata
index|[
literal|1
index|]
operator|<<
name|RPL_LUNDATA_FLAT_LUN_BITS
operator|)
expr_stmt|;
break|break;
case|case
name|RPL_LUNDATA_ATYP_LUN
case|:
case|case
name|RPL_LUNDATA_ATYP_EXTLUN
case|:
default|default:
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"Unsupported LUN format %d\n"
argument_list|,
name|lun_data
operator|->
name|luns
index|[
name|i
index|]
operator|.
name|lundata
index|[
literal|0
index|]
operator|&
name|RPL_LUNDATA_ATYP_MASK
argument_list|)
expr_stmt|;
name|lun_val
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|lun_val
operator|==
operator|-
literal|1
condition|)
continue|continue;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"%d\n"
argument_list|,
name|lun_val
argument_list|)
expr_stmt|;
block|}
name|bailout
label|:
if|if
condition|(
name|lun_data
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|lun_data
argument_list|)
expr_stmt|;
return|return
operator|(
name|retval
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cctl_tur
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|lun
parameter_list|,
name|int
name|iid
parameter_list|,
name|int
name|retries
parameter_list|)
block|{
name|union
name|ctl_io
modifier|*
name|io
decl_stmt|;
name|io
operator|=
name|ctl_scsi_alloc_io
argument_list|(
name|iid
argument_list|)
expr_stmt|;
if|if
condition|(
name|io
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"can't allocate memory\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|ctl_scsi_tur
argument_list|(
name|io
argument_list|,
comment|/* tag_type */
name|CTL_TAG_SIMPLE
argument_list|,
comment|/* control */
literal|0
argument_list|)
expr_stmt|;
name|io
operator|->
name|io_hdr
operator|.
name|nexus
operator|.
name|targ_lun
operator|=
name|lun
expr_stmt|;
name|io
operator|->
name|io_hdr
operator|.
name|nexus
operator|.
name|initid
operator|=
name|iid
expr_stmt|;
if|if
condition|(
name|cctl_do_io
argument_list|(
name|fd
argument_list|,
name|retries
argument_list|,
name|io
argument_list|,
name|__func__
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|ctl_scsi_free_io
argument_list|(
name|io
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|io
operator|->
name|io_hdr
operator|.
name|status
operator|&
name|CTL_STATUS_MASK
operator|)
operator|==
name|CTL_SUCCESS
condition|)
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"Unit is ready\n"
argument_list|)
expr_stmt|;
else|else
name|ctl_io_error_print
argument_list|(
name|io
argument_list|,
name|NULL
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cctl_get_inquiry
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|lun
parameter_list|,
name|int
name|iid
parameter_list|,
name|int
name|retries
parameter_list|,
name|char
modifier|*
name|path_str
parameter_list|,
name|int
name|path_len
parameter_list|,
name|struct
name|scsi_inquiry_data
modifier|*
name|inq_data
parameter_list|)
block|{
name|union
name|ctl_io
modifier|*
name|io
decl_stmt|;
name|int
name|retval
decl_stmt|;
name|retval
operator|=
literal|0
expr_stmt|;
name|io
operator|=
name|ctl_scsi_alloc_io
argument_list|(
name|iid
argument_list|)
expr_stmt|;
if|if
condition|(
name|io
operator|==
name|NULL
condition|)
block|{
name|warnx
argument_list|(
literal|"cctl_inquiry: can't allocate memory\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|ctl_scsi_inquiry
argument_list|(
comment|/*io*/
name|io
argument_list|,
comment|/*data_ptr*/
operator|(
name|uint8_t
operator|*
operator|)
name|inq_data
argument_list|,
comment|/*data_len*/
sizeof|sizeof
argument_list|(
operator|*
name|inq_data
argument_list|)
argument_list|,
comment|/*byte2*/
literal|0
argument_list|,
comment|/*page_code*/
literal|0
argument_list|,
comment|/*tag_type*/
name|CTL_TAG_SIMPLE
argument_list|,
comment|/*control*/
literal|0
argument_list|)
expr_stmt|;
name|io
operator|->
name|io_hdr
operator|.
name|nexus
operator|.
name|targ_lun
operator|=
name|lun
expr_stmt|;
name|io
operator|->
name|io_hdr
operator|.
name|nexus
operator|.
name|initid
operator|=
name|iid
expr_stmt|;
if|if
condition|(
name|cctl_do_io
argument_list|(
name|fd
argument_list|,
name|retries
argument_list|,
name|io
argument_list|,
name|__func__
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
if|if
condition|(
operator|(
name|io
operator|->
name|io_hdr
operator|.
name|status
operator|&
name|CTL_STATUS_MASK
operator|)
operator|!=
name|CTL_SUCCESS
condition|)
block|{
name|retval
operator|=
literal|1
expr_stmt|;
name|ctl_io_error_print
argument_list|(
name|io
argument_list|,
name|NULL
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|path_str
operator|!=
name|NULL
condition|)
name|ctl_scsi_path_string
argument_list|(
name|io
argument_list|,
name|path_str
argument_list|,
name|path_len
argument_list|)
expr_stmt|;
name|bailout
label|:
name|ctl_scsi_free_io
argument_list|(
name|io
argument_list|)
expr_stmt|;
return|return
operator|(
name|retval
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cctl_inquiry
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|lun
parameter_list|,
name|int
name|iid
parameter_list|,
name|int
name|retries
parameter_list|)
block|{
name|struct
name|scsi_inquiry_data
modifier|*
name|inq_data
decl_stmt|;
name|char
name|scsi_path
index|[
literal|40
index|]
decl_stmt|;
name|int
name|retval
decl_stmt|;
name|inq_data
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|inq_data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|inq_data
operator|==
name|NULL
condition|)
block|{
name|warnx
argument_list|(
literal|"%s: can't allocate inquiry data"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
if|if
condition|(
operator|(
name|retval
operator|=
name|cctl_get_inquiry
argument_list|(
name|fd
argument_list|,
name|lun
argument_list|,
name|iid
argument_list|,
name|retries
argument_list|,
name|scsi_path
argument_list|,
sizeof|sizeof
argument_list|(
name|scsi_path
argument_list|)
argument_list|,
name|inq_data
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|bailout
goto|;
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|scsi_path
argument_list|)
expr_stmt|;
name|scsi_print_inquiry
argument_list|(
name|inq_data
argument_list|)
expr_stmt|;
name|bailout
label|:
if|if
condition|(
name|inq_data
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|inq_data
argument_list|)
expr_stmt|;
return|return
operator|(
name|retval
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cctl_req_sense
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|lun
parameter_list|,
name|int
name|iid
parameter_list|,
name|int
name|retries
parameter_list|)
block|{
name|union
name|ctl_io
modifier|*
name|io
decl_stmt|;
name|struct
name|scsi_sense_data
modifier|*
name|sense_data
decl_stmt|;
name|int
name|retval
decl_stmt|;
name|retval
operator|=
literal|0
expr_stmt|;
name|io
operator|=
name|ctl_scsi_alloc_io
argument_list|(
name|iid
argument_list|)
expr_stmt|;
if|if
condition|(
name|io
operator|==
name|NULL
condition|)
block|{
name|warnx
argument_list|(
literal|"cctl_req_sense: can't allocate memory\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|sense_data
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|sense_data
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|sense_data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|sense_data
argument_list|)
argument_list|)
expr_stmt|;
name|ctl_scsi_request_sense
argument_list|(
comment|/*io*/
name|io
argument_list|,
comment|/*data_ptr*/
operator|(
name|uint8_t
operator|*
operator|)
name|sense_data
argument_list|,
comment|/*data_len*/
sizeof|sizeof
argument_list|(
operator|*
name|sense_data
argument_list|)
argument_list|,
comment|/*byte2*/
literal|0
argument_list|,
comment|/*tag_type*/
name|CTL_TAG_SIMPLE
argument_list|,
comment|/*control*/
literal|0
argument_list|)
expr_stmt|;
name|io
operator|->
name|io_hdr
operator|.
name|nexus
operator|.
name|targ_lun
operator|=
name|lun
expr_stmt|;
name|io
operator|->
name|io_hdr
operator|.
name|nexus
operator|.
name|initid
operator|=
name|iid
expr_stmt|;
if|if
condition|(
name|cctl_do_io
argument_list|(
name|fd
argument_list|,
name|retries
argument_list|,
name|io
argument_list|,
name|__func__
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
if|if
condition|(
operator|(
name|io
operator|->
name|io_hdr
operator|.
name|status
operator|&
name|CTL_STATUS_MASK
operator|)
operator|==
name|CTL_SUCCESS
condition|)
block|{
name|bcopy
argument_list|(
name|sense_data
argument_list|,
operator|&
name|io
operator|->
name|scsiio
operator|.
name|sense_data
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|sense_data
argument_list|)
argument_list|)
expr_stmt|;
name|io
operator|->
name|scsiio
operator|.
name|sense_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|sense_data
argument_list|)
expr_stmt|;
name|ctl_scsi_sense_print
argument_list|(
operator|&
name|io
operator|->
name|scsiio
argument_list|,
name|NULL
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
block|}
else|else
name|ctl_io_error_print
argument_list|(
name|io
argument_list|,
name|NULL
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
name|bailout
label|:
name|ctl_scsi_free_io
argument_list|(
name|io
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|sense_data
argument_list|)
expr_stmt|;
return|return
operator|(
name|retval
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cctl_report_target_port_group
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|lun
parameter_list|,
name|int
name|iid
parameter_list|)
block|{
name|union
name|ctl_io
modifier|*
name|io
decl_stmt|;
name|uint32_t
name|datalen
decl_stmt|;
name|uint8_t
modifier|*
name|dataptr
decl_stmt|;
name|int
name|retval
decl_stmt|;
name|dataptr
operator|=
name|NULL
expr_stmt|;
name|retval
operator|=
literal|0
expr_stmt|;
name|io
operator|=
name|ctl_scsi_alloc_io
argument_list|(
name|iid
argument_list|)
expr_stmt|;
if|if
condition|(
name|io
operator|==
name|NULL
condition|)
block|{
name|warn
argument_list|(
literal|"%s: can't allocate memory"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|datalen
operator|=
literal|64
expr_stmt|;
name|dataptr
operator|=
operator|(
name|uint8_t
operator|*
operator|)
name|malloc
argument_list|(
name|datalen
argument_list|)
expr_stmt|;
if|if
condition|(
name|dataptr
operator|==
name|NULL
condition|)
block|{
name|warn
argument_list|(
literal|"%s: can't allocate %d bytes"
argument_list|,
name|__func__
argument_list|,
name|datalen
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
name|memset
argument_list|(
name|dataptr
argument_list|,
literal|0
argument_list|,
name|datalen
argument_list|)
expr_stmt|;
name|ctl_scsi_maintenance_in
argument_list|(
comment|/*io*/
name|io
argument_list|,
comment|/*data_ptr*/
name|dataptr
argument_list|,
comment|/*data_len*/
name|datalen
argument_list|,
comment|/*action*/
name|SA_RPRT_TRGT_GRP
argument_list|,
comment|/*tag_type*/
name|CTL_TAG_SIMPLE
argument_list|,
comment|/*control*/
literal|0
argument_list|)
expr_stmt|;
name|io
operator|->
name|io_hdr
operator|.
name|nexus
operator|.
name|targ_lun
operator|=
name|lun
expr_stmt|;
name|io
operator|->
name|io_hdr
operator|.
name|nexus
operator|.
name|initid
operator|=
name|iid
expr_stmt|;
if|if
condition|(
name|cctl_do_io
argument_list|(
name|fd
argument_list|,
literal|0
argument_list|,
name|io
argument_list|,
name|__func__
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
if|if
condition|(
operator|(
name|io
operator|->
name|io_hdr
operator|.
name|status
operator|&
name|CTL_STATUS_MASK
operator|)
operator|==
name|CTL_SUCCESS
condition|)
block|{
name|int
name|returned_len
decl_stmt|,
name|used_len
decl_stmt|;
name|returned_len
operator|=
name|scsi_4btoul
argument_list|(
operator|&
name|dataptr
index|[
literal|0
index|]
argument_list|)
operator|+
literal|4
expr_stmt|;
for|for
control|(
name|used_len
operator|=
literal|0
init|;
name|used_len
operator|<
name|returned_len
condition|;
name|used_len
operator|++
control|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"0x%02x "
argument_list|,
name|dataptr
index|[
name|used_len
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|used_len
operator|+
literal|1
operator|)
operator|%
literal|8
operator|)
operator|==
literal|0
condition|)
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
else|else
name|ctl_io_error_print
argument_list|(
name|io
argument_list|,
name|NULL
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
name|bailout
label|:
name|ctl_scsi_free_io
argument_list|(
name|io
argument_list|)
expr_stmt|;
if|if
condition|(
name|dataptr
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|dataptr
argument_list|)
expr_stmt|;
return|return
operator|(
name|retval
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cctl_inquiry_vpd_devid
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|lun
parameter_list|,
name|int
name|iid
parameter_list|)
block|{
name|union
name|ctl_io
modifier|*
name|io
decl_stmt|;
name|uint32_t
name|datalen
decl_stmt|;
name|uint8_t
modifier|*
name|dataptr
decl_stmt|;
name|int
name|retval
decl_stmt|;
name|retval
operator|=
literal|0
expr_stmt|;
name|dataptr
operator|=
name|NULL
expr_stmt|;
name|io
operator|=
name|ctl_scsi_alloc_io
argument_list|(
name|iid
argument_list|)
expr_stmt|;
if|if
condition|(
name|io
operator|==
name|NULL
condition|)
block|{
name|warn
argument_list|(
literal|"%s: can't allocate memory"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|datalen
operator|=
literal|256
expr_stmt|;
name|dataptr
operator|=
operator|(
name|uint8_t
operator|*
operator|)
name|malloc
argument_list|(
name|datalen
argument_list|)
expr_stmt|;
if|if
condition|(
name|dataptr
operator|==
name|NULL
condition|)
block|{
name|warn
argument_list|(
literal|"%s: can't allocate %d bytes"
argument_list|,
name|__func__
argument_list|,
name|datalen
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
name|memset
argument_list|(
name|dataptr
argument_list|,
literal|0
argument_list|,
name|datalen
argument_list|)
expr_stmt|;
name|ctl_scsi_inquiry
argument_list|(
comment|/*io*/
name|io
argument_list|,
comment|/*data_ptr*/
name|dataptr
argument_list|,
comment|/*data_len*/
name|datalen
argument_list|,
comment|/*byte2*/
name|SI_EVPD
argument_list|,
comment|/*page_code*/
name|SVPD_DEVICE_ID
argument_list|,
comment|/*tag_type*/
name|CTL_TAG_SIMPLE
argument_list|,
comment|/*control*/
literal|0
argument_list|)
expr_stmt|;
name|io
operator|->
name|io_hdr
operator|.
name|nexus
operator|.
name|targ_lun
operator|=
name|lun
expr_stmt|;
name|io
operator|->
name|io_hdr
operator|.
name|nexus
operator|.
name|initid
operator|=
name|iid
expr_stmt|;
if|if
condition|(
name|cctl_do_io
argument_list|(
name|fd
argument_list|,
literal|0
argument_list|,
name|io
argument_list|,
name|__func__
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
if|if
condition|(
operator|(
name|io
operator|->
name|io_hdr
operator|.
name|status
operator|&
name|CTL_STATUS_MASK
operator|)
operator|==
name|CTL_SUCCESS
condition|)
block|{
name|int
name|returned_len
decl_stmt|,
name|used_len
decl_stmt|;
name|returned_len
operator|=
name|scsi_2btoul
argument_list|(
operator|&
name|dataptr
index|[
literal|2
index|]
argument_list|)
operator|+
literal|4
expr_stmt|;
for|for
control|(
name|used_len
operator|=
literal|0
init|;
name|used_len
operator|<
name|returned_len
condition|;
name|used_len
operator|++
control|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"0x%02x "
argument_list|,
name|dataptr
index|[
name|used_len
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|used_len
operator|+
literal|1
operator|)
operator|%
literal|8
operator|)
operator|==
literal|0
condition|)
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
else|else
name|ctl_io_error_print
argument_list|(
name|io
argument_list|,
name|NULL
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
name|bailout
label|:
name|ctl_scsi_free_io
argument_list|(
name|io
argument_list|)
expr_stmt|;
if|if
condition|(
name|dataptr
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|dataptr
argument_list|)
expr_stmt|;
return|return
operator|(
name|retval
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cctl_persistent_reserve_in
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|lun
parameter_list|,
name|int
name|iid
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|,
name|char
modifier|*
name|combinedopt
parameter_list|,
name|int
name|retry_count
parameter_list|)
block|{
name|union
name|ctl_io
modifier|*
name|io
decl_stmt|;
name|uint32_t
name|datalen
decl_stmt|;
name|uint8_t
modifier|*
name|dataptr
decl_stmt|;
name|int
name|action
init|=
operator|-
literal|1
decl_stmt|;
name|int
name|retval
decl_stmt|;
name|int
name|c
decl_stmt|;
name|retval
operator|=
literal|0
expr_stmt|;
name|dataptr
operator|=
name|NULL
expr_stmt|;
name|io
operator|=
name|ctl_scsi_alloc_io
argument_list|(
name|iid
argument_list|)
expr_stmt|;
if|if
condition|(
name|io
operator|==
name|NULL
condition|)
block|{
name|warn
argument_list|(
literal|"%s: can't allocate memory"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
while|while
condition|(
operator|(
name|c
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|combinedopt
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'a'
case|:
name|action
operator|=
name|strtol
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
if|if
condition|(
name|action
operator|<
literal|0
operator|||
name|action
operator|>
literal|2
condition|)
block|{
name|warn
argument_list|(
literal|"action must be specified and in the range: 0-2"
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
name|datalen
operator|=
literal|256
expr_stmt|;
name|dataptr
operator|=
operator|(
name|uint8_t
operator|*
operator|)
name|malloc
argument_list|(
name|datalen
argument_list|)
expr_stmt|;
if|if
condition|(
name|dataptr
operator|==
name|NULL
condition|)
block|{
name|warn
argument_list|(
literal|"%s: can't allocate %d bytes"
argument_list|,
name|__func__
argument_list|,
name|datalen
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
name|memset
argument_list|(
name|dataptr
argument_list|,
literal|0
argument_list|,
name|datalen
argument_list|)
expr_stmt|;
name|ctl_scsi_persistent_res_in
argument_list|(
name|io
argument_list|,
comment|/*data_ptr*/
name|dataptr
argument_list|,
comment|/*data_len*/
name|datalen
argument_list|,
comment|/*action*/
name|action
argument_list|,
comment|/*tag_type*/
name|CTL_TAG_SIMPLE
argument_list|,
comment|/*control*/
literal|0
argument_list|)
expr_stmt|;
name|io
operator|->
name|io_hdr
operator|.
name|nexus
operator|.
name|targ_lun
operator|=
name|lun
expr_stmt|;
name|io
operator|->
name|io_hdr
operator|.
name|nexus
operator|.
name|initid
operator|=
name|iid
expr_stmt|;
if|if
condition|(
name|cctl_do_io
argument_list|(
name|fd
argument_list|,
name|retry_count
argument_list|,
name|io
argument_list|,
name|__func__
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
if|if
condition|(
operator|(
name|io
operator|->
name|io_hdr
operator|.
name|status
operator|&
name|CTL_STATUS_MASK
operator|)
operator|==
name|CTL_SUCCESS
condition|)
block|{
name|int
name|returned_len
decl_stmt|,
name|used_len
decl_stmt|;
switch|switch
condition|(
name|action
condition|)
block|{
case|case
literal|0
case|:
name|returned_len
operator|=
name|scsi_4btoul
argument_list|(
operator|&
name|dataptr
index|[
literal|4
index|]
argument_list|)
operator|+
literal|8
expr_stmt|;
name|returned_len
operator|=
name|min
argument_list|(
name|returned_len
argument_list|,
literal|256
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|returned_len
operator|=
name|scsi_4btoul
argument_list|(
operator|&
name|dataptr
index|[
literal|4
index|]
argument_list|)
operator|+
literal|8
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|returned_len
operator|=
literal|8
expr_stmt|;
break|break;
default|default:
name|warnx
argument_list|(
literal|"%s: invalid action %d"
argument_list|,
name|__func__
argument_list|,
name|action
argument_list|)
expr_stmt|;
goto|goto
name|bailout
goto|;
break|break;
comment|/* NOTREACHED */
block|}
for|for
control|(
name|used_len
operator|=
literal|0
init|;
name|used_len
operator|<
name|returned_len
condition|;
name|used_len
operator|++
control|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"0x%02x "
argument_list|,
name|dataptr
index|[
name|used_len
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|used_len
operator|+
literal|1
operator|)
operator|%
literal|8
operator|)
operator|==
literal|0
condition|)
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
else|else
name|ctl_io_error_print
argument_list|(
name|io
argument_list|,
name|NULL
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
name|bailout
label|:
name|ctl_scsi_free_io
argument_list|(
name|io
argument_list|)
expr_stmt|;
if|if
condition|(
name|dataptr
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|dataptr
argument_list|)
expr_stmt|;
return|return
operator|(
name|retval
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cctl_persistent_reserve_out
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|lun
parameter_list|,
name|int
name|iid
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|,
name|char
modifier|*
name|combinedopt
parameter_list|,
name|int
name|retry_count
parameter_list|)
block|{
name|union
name|ctl_io
modifier|*
name|io
decl_stmt|;
name|uint32_t
name|datalen
decl_stmt|;
name|uint64_t
name|key
init|=
literal|0
decl_stmt|,
name|sa_key
init|=
literal|0
decl_stmt|;
name|int
name|action
init|=
operator|-
literal|1
decl_stmt|,
name|restype
init|=
operator|-
literal|1
decl_stmt|;
name|uint8_t
modifier|*
name|dataptr
decl_stmt|;
name|int
name|retval
decl_stmt|;
name|int
name|c
decl_stmt|;
name|retval
operator|=
literal|0
expr_stmt|;
name|dataptr
operator|=
name|NULL
expr_stmt|;
name|io
operator|=
name|ctl_scsi_alloc_io
argument_list|(
name|iid
argument_list|)
expr_stmt|;
if|if
condition|(
name|io
operator|==
name|NULL
condition|)
block|{
name|warn
argument_list|(
literal|"%s: can't allocate memory"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
while|while
condition|(
operator|(
name|c
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|combinedopt
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'a'
case|:
name|action
operator|=
name|strtol
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'k'
case|:
name|key
operator|=
name|strtoull
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'r'
case|:
name|restype
operator|=
name|strtol
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
name|sa_key
operator|=
name|strtoull
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
if|if
condition|(
name|action
operator|<
literal|0
operator|||
name|action
operator|>
literal|5
condition|)
block|{
name|warn
argument_list|(
literal|"action must be specified and in the range: 0-5"
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
if|if
condition|(
name|restype
operator|<
literal|0
operator|||
name|restype
operator|>
literal|5
condition|)
block|{
if|if
condition|(
name|action
operator|!=
literal|0
operator|&&
name|action
operator|!=
literal|5
operator|&&
name|action
operator|!=
literal|3
condition|)
block|{
name|warn
argument_list|(
literal|"'restype' must specified and in the range: 0-5"
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
block|}
name|datalen
operator|=
literal|24
expr_stmt|;
name|dataptr
operator|=
operator|(
name|uint8_t
operator|*
operator|)
name|malloc
argument_list|(
name|datalen
argument_list|)
expr_stmt|;
if|if
condition|(
name|dataptr
operator|==
name|NULL
condition|)
block|{
name|warn
argument_list|(
literal|"%s: can't allocate %d bytes"
argument_list|,
name|__func__
argument_list|,
name|datalen
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
name|memset
argument_list|(
name|dataptr
argument_list|,
literal|0
argument_list|,
name|datalen
argument_list|)
expr_stmt|;
name|ctl_scsi_persistent_res_out
argument_list|(
name|io
argument_list|,
comment|/*data_ptr*/
name|dataptr
argument_list|,
comment|/*data_len*/
name|datalen
argument_list|,
comment|/*action*/
name|action
argument_list|,
comment|/*type*/
name|restype
argument_list|,
comment|/*key*/
name|key
argument_list|,
comment|/*sa key*/
name|sa_key
argument_list|,
comment|/*tag_type*/
name|CTL_TAG_SIMPLE
argument_list|,
comment|/*control*/
literal|0
argument_list|)
expr_stmt|;
name|io
operator|->
name|io_hdr
operator|.
name|nexus
operator|.
name|targ_lun
operator|=
name|lun
expr_stmt|;
name|io
operator|->
name|io_hdr
operator|.
name|nexus
operator|.
name|initid
operator|=
name|iid
expr_stmt|;
if|if
condition|(
name|cctl_do_io
argument_list|(
name|fd
argument_list|,
name|retry_count
argument_list|,
name|io
argument_list|,
name|__func__
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
if|if
condition|(
operator|(
name|io
operator|->
name|io_hdr
operator|.
name|status
operator|&
name|CTL_STATUS_MASK
operator|)
operator|==
name|CTL_SUCCESS
condition|)
block|{
name|char
name|scsi_path
index|[
literal|40
index|]
decl_stmt|;
name|ctl_scsi_path_string
argument_list|(
name|io
argument_list|,
name|scsi_path
argument_list|,
sizeof|sizeof
argument_list|(
name|scsi_path
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"%sPERSISTENT RESERVE OUT executed "
literal|"successfully\n"
argument_list|,
name|scsi_path
argument_list|)
expr_stmt|;
block|}
else|else
name|ctl_io_error_print
argument_list|(
name|io
argument_list|,
name|NULL
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
name|bailout
label|:
name|ctl_scsi_free_io
argument_list|(
name|io
argument_list|)
expr_stmt|;
if|if
condition|(
name|dataptr
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|dataptr
argument_list|)
expr_stmt|;
return|return
operator|(
name|retval
operator|)
return|;
block|}
end_function

begin_struct
struct|struct
name|cctl_req_option
block|{
name|char
modifier|*
name|name
decl_stmt|;
name|int
name|namelen
decl_stmt|;
name|char
modifier|*
name|value
decl_stmt|;
name|int
name|vallen
decl_stmt|;
name|STAILQ_ENTRY
argument_list|(
argument|cctl_req_option
argument_list|)
name|links
expr_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|cctl_create_lun
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|,
name|char
modifier|*
name|combinedopt
parameter_list|)
block|{
name|struct
name|ctl_lun_req
name|req
decl_stmt|;
name|int
name|device_type
init|=
operator|-
literal|1
decl_stmt|;
name|uint64_t
name|lun_size
init|=
literal|0
decl_stmt|;
name|uint32_t
name|blocksize
init|=
literal|0
decl_stmt|,
name|req_lun_id
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|serial_num
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|device_id
init|=
name|NULL
decl_stmt|;
name|int
name|lun_size_set
init|=
literal|0
decl_stmt|,
name|blocksize_set
init|=
literal|0
decl_stmt|,
name|lun_id_set
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|backend_name
init|=
name|NULL
decl_stmt|;
name|STAILQ_HEAD
argument_list|(
argument_list|,
argument|cctl_req_option
argument_list|)
name|option_list
expr_stmt|;
name|int
name|num_options
init|=
literal|0
decl_stmt|;
name|int
name|retval
init|=
literal|0
decl_stmt|,
name|c
decl_stmt|;
name|STAILQ_INIT
argument_list|(
operator|&
name|option_list
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|combinedopt
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'b'
case|:
name|backend_name
operator|=
name|strdup
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'B'
case|:
name|blocksize
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|blocksize_set
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
name|device_id
operator|=
name|strdup
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
name|req_lun_id
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|lun_id_set
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'o'
case|:
block|{
name|struct
name|cctl_req_option
modifier|*
name|option
decl_stmt|;
name|char
modifier|*
name|tmpstr
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|,
modifier|*
name|value
decl_stmt|;
name|tmpstr
operator|=
name|strdup
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
name|name
operator|=
name|strsep
argument_list|(
operator|&
name|tmpstr
argument_list|,
literal|"="
argument_list|)
expr_stmt|;
if|if
condition|(
name|name
operator|==
name|NULL
condition|)
block|{
name|warnx
argument_list|(
literal|"%s: option -o takes \"name=value\""
literal|"argument"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
name|value
operator|=
name|strsep
argument_list|(
operator|&
name|tmpstr
argument_list|,
literal|"="
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|==
name|NULL
condition|)
block|{
name|warnx
argument_list|(
literal|"%s: option -o takes \"name=value\""
literal|"argument"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
name|option
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|option
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|option
operator|==
name|NULL
condition|)
block|{
name|warn
argument_list|(
literal|"%s: error allocating %zd bytes"
argument_list|,
name|__func__
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|option
argument_list|)
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
name|option
operator|->
name|name
operator|=
name|strdup
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|option
operator|->
name|namelen
operator|=
name|strlen
argument_list|(
name|name
argument_list|)
operator|+
literal|1
expr_stmt|;
name|option
operator|->
name|value
operator|=
name|strdup
argument_list|(
name|value
argument_list|)
expr_stmt|;
name|option
operator|->
name|vallen
operator|=
name|strlen
argument_list|(
name|value
argument_list|)
operator|+
literal|1
expr_stmt|;
name|free
argument_list|(
name|tmpstr
argument_list|)
expr_stmt|;
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|option_list
argument_list|,
name|option
argument_list|,
name|links
argument_list|)
expr_stmt|;
name|num_options
operator|++
expr_stmt|;
break|break;
block|}
case|case
literal|'s'
case|:
if|if
condition|(
name|strcasecmp
argument_list|(
name|optarg
argument_list|,
literal|"auto"
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|retval
operator|=
name|expand_number
argument_list|(
name|optarg
argument_list|,
operator|&
name|lun_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
operator|!=
literal|0
condition|)
block|{
name|warn
argument_list|(
literal|"%s: invalid -s argument"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
block|}
name|lun_size_set
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'S'
case|:
name|serial_num
operator|=
name|strdup
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
name|device_type
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
if|if
condition|(
name|backend_name
operator|==
name|NULL
condition|)
block|{
name|warnx
argument_list|(
literal|"%s: backend name (-b) must be specified"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
name|bzero
argument_list|(
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|req
operator|.
name|backend
argument_list|,
name|backend_name
argument_list|,
sizeof|sizeof
argument_list|(
name|req
operator|.
name|backend
argument_list|)
argument_list|)
expr_stmt|;
name|req
operator|.
name|reqtype
operator|=
name|CTL_LUNREQ_CREATE
expr_stmt|;
if|if
condition|(
name|blocksize_set
operator|!=
literal|0
condition|)
name|req
operator|.
name|reqdata
operator|.
name|create
operator|.
name|blocksize_bytes
operator|=
name|blocksize
expr_stmt|;
if|if
condition|(
name|lun_size_set
operator|!=
literal|0
condition|)
name|req
operator|.
name|reqdata
operator|.
name|create
operator|.
name|lun_size_bytes
operator|=
name|lun_size
expr_stmt|;
if|if
condition|(
name|lun_id_set
operator|!=
literal|0
condition|)
block|{
name|req
operator|.
name|reqdata
operator|.
name|create
operator|.
name|flags
operator||=
name|CTL_LUN_FLAG_ID_REQ
expr_stmt|;
name|req
operator|.
name|reqdata
operator|.
name|create
operator|.
name|req_lun_id
operator|=
name|req_lun_id
expr_stmt|;
block|}
name|req
operator|.
name|reqdata
operator|.
name|create
operator|.
name|flags
operator||=
name|CTL_LUN_FLAG_DEV_TYPE
expr_stmt|;
if|if
condition|(
name|device_type
operator|!=
operator|-
literal|1
condition|)
name|req
operator|.
name|reqdata
operator|.
name|create
operator|.
name|device_type
operator|=
name|device_type
expr_stmt|;
else|else
name|req
operator|.
name|reqdata
operator|.
name|create
operator|.
name|device_type
operator|=
name|T_DIRECT
expr_stmt|;
if|if
condition|(
name|serial_num
operator|!=
name|NULL
condition|)
block|{
name|strlcpy
argument_list|(
name|req
operator|.
name|reqdata
operator|.
name|create
operator|.
name|serial_num
argument_list|,
name|serial_num
argument_list|,
sizeof|sizeof
argument_list|(
name|req
operator|.
name|reqdata
operator|.
name|create
operator|.
name|serial_num
argument_list|)
argument_list|)
expr_stmt|;
name|req
operator|.
name|reqdata
operator|.
name|create
operator|.
name|flags
operator||=
name|CTL_LUN_FLAG_SERIAL_NUM
expr_stmt|;
block|}
if|if
condition|(
name|device_id
operator|!=
name|NULL
condition|)
block|{
name|strlcpy
argument_list|(
name|req
operator|.
name|reqdata
operator|.
name|create
operator|.
name|device_id
argument_list|,
name|device_id
argument_list|,
sizeof|sizeof
argument_list|(
name|req
operator|.
name|reqdata
operator|.
name|create
operator|.
name|device_id
argument_list|)
argument_list|)
expr_stmt|;
name|req
operator|.
name|reqdata
operator|.
name|create
operator|.
name|flags
operator||=
name|CTL_LUN_FLAG_DEVID
expr_stmt|;
block|}
name|req
operator|.
name|num_be_args
operator|=
name|num_options
expr_stmt|;
if|if
condition|(
name|num_options
operator|>
literal|0
condition|)
block|{
name|struct
name|cctl_req_option
modifier|*
name|option
decl_stmt|,
modifier|*
name|next_option
decl_stmt|;
name|int
name|i
decl_stmt|;
name|req
operator|.
name|be_args
operator|=
name|malloc
argument_list|(
name|num_options
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|req
operator|.
name|be_args
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|.
name|be_args
operator|==
name|NULL
condition|)
block|{
name|warn
argument_list|(
literal|"%s: error allocating %zd bytes"
argument_list|,
name|__func__
argument_list|,
name|num_options
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|req
operator|.
name|be_args
argument_list|)
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|option
operator|=
name|STAILQ_FIRST
argument_list|(
operator|&
name|option_list
argument_list|)
init|;
name|i
operator|<
name|num_options
condition|;
name|i
operator|++
operator|,
name|option
operator|=
name|next_option
control|)
block|{
name|next_option
operator|=
name|STAILQ_NEXT
argument_list|(
name|option
argument_list|,
name|links
argument_list|)
expr_stmt|;
name|req
operator|.
name|be_args
index|[
name|i
index|]
operator|.
name|namelen
operator|=
name|option
operator|->
name|namelen
expr_stmt|;
name|req
operator|.
name|be_args
index|[
name|i
index|]
operator|.
name|name
operator|=
name|strdup
argument_list|(
name|option
operator|->
name|name
argument_list|)
expr_stmt|;
name|req
operator|.
name|be_args
index|[
name|i
index|]
operator|.
name|vallen
operator|=
name|option
operator|->
name|vallen
expr_stmt|;
name|req
operator|.
name|be_args
index|[
name|i
index|]
operator|.
name|value
operator|=
name|strdup
argument_list|(
name|option
operator|->
name|value
argument_list|)
expr_stmt|;
comment|/* 			 * XXX KDM do we want a way to specify a writeable 			 * flag of some sort?  Do we want a way to specify 			 * binary data? 			 */
name|req
operator|.
name|be_args
index|[
name|i
index|]
operator|.
name|flags
operator|=
name|CTL_BEARG_ASCII
operator||
name|CTL_BEARG_RD
expr_stmt|;
name|STAILQ_REMOVE
argument_list|(
operator|&
name|option_list
argument_list|,
name|option
argument_list|,
name|cctl_req_option
argument_list|,
name|links
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|option
operator|->
name|name
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|option
operator|->
name|value
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|option
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|CTL_LUN_REQ
argument_list|,
operator|&
name|req
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|warn
argument_list|(
literal|"%s: error issuing CTL_LUN_REQ ioctl"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
switch|switch
condition|(
name|req
operator|.
name|status
condition|)
block|{
case|case
name|CTL_LUN_ERROR
case|:
name|warnx
argument_list|(
literal|"LUN creation error: %s"
argument_list|,
name|req
operator|.
name|error_str
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
case|case
name|CTL_LUN_WARNING
case|:
name|warnx
argument_list|(
literal|"LUN creation warning: %s"
argument_list|,
name|req
operator|.
name|error_str
argument_list|)
expr_stmt|;
break|break;
case|case
name|CTL_LUN_OK
case|:
break|break;
default|default:
name|warnx
argument_list|(
literal|"unknown LUN creation status: %d"
argument_list|,
name|req
operator|.
name|status
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"LUN created successfully\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"backend:       %s\n"
argument_list|,
name|req
operator|.
name|backend
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"device type:   %d\n"
argument_list|,
name|req
operator|.
name|reqdata
operator|.
name|create
operator|.
name|device_type
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"LUN size:      %ju bytes\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|req
operator|.
name|reqdata
operator|.
name|create
operator|.
name|lun_size_bytes
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"blocksize      %u bytes\n"
argument_list|,
name|req
operator|.
name|reqdata
operator|.
name|create
operator|.
name|blocksize_bytes
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"LUN ID:        %d\n"
argument_list|,
name|req
operator|.
name|reqdata
operator|.
name|create
operator|.
name|req_lun_id
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"Serial Number: %s\n"
argument_list|,
name|req
operator|.
name|reqdata
operator|.
name|create
operator|.
name|serial_num
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"Device ID;     %s\n"
argument_list|,
name|req
operator|.
name|reqdata
operator|.
name|create
operator|.
name|device_id
argument_list|)
expr_stmt|;
name|bailout
label|:
return|return
operator|(
name|retval
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cctl_rm_lun
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|,
name|char
modifier|*
name|combinedopt
parameter_list|)
block|{
name|struct
name|ctl_lun_req
name|req
decl_stmt|;
name|uint32_t
name|lun_id
init|=
literal|0
decl_stmt|;
name|int
name|lun_id_set
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|backend_name
init|=
name|NULL
decl_stmt|;
name|STAILQ_HEAD
argument_list|(
argument_list|,
argument|cctl_req_option
argument_list|)
name|option_list
expr_stmt|;
name|int
name|num_options
init|=
literal|0
decl_stmt|;
name|int
name|retval
init|=
literal|0
decl_stmt|,
name|c
decl_stmt|;
name|STAILQ_INIT
argument_list|(
operator|&
name|option_list
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|combinedopt
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'b'
case|:
name|backend_name
operator|=
name|strdup
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
name|lun_id
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|lun_id_set
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'o'
case|:
block|{
name|struct
name|cctl_req_option
modifier|*
name|option
decl_stmt|;
name|char
modifier|*
name|tmpstr
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|,
modifier|*
name|value
decl_stmt|;
name|tmpstr
operator|=
name|strdup
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
name|name
operator|=
name|strsep
argument_list|(
operator|&
name|tmpstr
argument_list|,
literal|"="
argument_list|)
expr_stmt|;
if|if
condition|(
name|name
operator|==
name|NULL
condition|)
block|{
name|warnx
argument_list|(
literal|"%s: option -o takes \"name=value\""
literal|"argument"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
name|value
operator|=
name|strsep
argument_list|(
operator|&
name|tmpstr
argument_list|,
literal|"="
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|==
name|NULL
condition|)
block|{
name|warnx
argument_list|(
literal|"%s: option -o takes \"name=value\""
literal|"argument"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
name|option
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|option
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|option
operator|==
name|NULL
condition|)
block|{
name|warn
argument_list|(
literal|"%s: error allocating %zd bytes"
argument_list|,
name|__func__
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|option
argument_list|)
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
name|option
operator|->
name|name
operator|=
name|strdup
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|option
operator|->
name|namelen
operator|=
name|strlen
argument_list|(
name|name
argument_list|)
operator|+
literal|1
expr_stmt|;
name|option
operator|->
name|value
operator|=
name|strdup
argument_list|(
name|value
argument_list|)
expr_stmt|;
name|option
operator|->
name|vallen
operator|=
name|strlen
argument_list|(
name|value
argument_list|)
operator|+
literal|1
expr_stmt|;
name|free
argument_list|(
name|tmpstr
argument_list|)
expr_stmt|;
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|option_list
argument_list|,
name|option
argument_list|,
name|links
argument_list|)
expr_stmt|;
name|num_options
operator|++
expr_stmt|;
break|break;
block|}
default|default:
break|break;
block|}
block|}
if|if
condition|(
name|backend_name
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s: backend name (-b) must be specified"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
name|lun_id_set
operator|==
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s: LUN id (-l) must be specified"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|req
operator|.
name|backend
argument_list|,
name|backend_name
argument_list|,
sizeof|sizeof
argument_list|(
name|req
operator|.
name|backend
argument_list|)
argument_list|)
expr_stmt|;
name|req
operator|.
name|reqtype
operator|=
name|CTL_LUNREQ_RM
expr_stmt|;
name|req
operator|.
name|reqdata
operator|.
name|rm
operator|.
name|lun_id
operator|=
name|lun_id
expr_stmt|;
name|req
operator|.
name|num_be_args
operator|=
name|num_options
expr_stmt|;
if|if
condition|(
name|num_options
operator|>
literal|0
condition|)
block|{
name|struct
name|cctl_req_option
modifier|*
name|option
decl_stmt|,
modifier|*
name|next_option
decl_stmt|;
name|int
name|i
decl_stmt|;
name|req
operator|.
name|be_args
operator|=
name|malloc
argument_list|(
name|num_options
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|req
operator|.
name|be_args
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|.
name|be_args
operator|==
name|NULL
condition|)
block|{
name|warn
argument_list|(
literal|"%s: error allocating %zd bytes"
argument_list|,
name|__func__
argument_list|,
name|num_options
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|req
operator|.
name|be_args
argument_list|)
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|option
operator|=
name|STAILQ_FIRST
argument_list|(
operator|&
name|option_list
argument_list|)
init|;
name|i
operator|<
name|num_options
condition|;
name|i
operator|++
operator|,
name|option
operator|=
name|next_option
control|)
block|{
name|next_option
operator|=
name|STAILQ_NEXT
argument_list|(
name|option
argument_list|,
name|links
argument_list|)
expr_stmt|;
name|req
operator|.
name|be_args
index|[
name|i
index|]
operator|.
name|namelen
operator|=
name|option
operator|->
name|namelen
expr_stmt|;
name|req
operator|.
name|be_args
index|[
name|i
index|]
operator|.
name|name
operator|=
name|strdup
argument_list|(
name|option
operator|->
name|name
argument_list|)
expr_stmt|;
name|req
operator|.
name|be_args
index|[
name|i
index|]
operator|.
name|vallen
operator|=
name|option
operator|->
name|vallen
expr_stmt|;
name|req
operator|.
name|be_args
index|[
name|i
index|]
operator|.
name|value
operator|=
name|strdup
argument_list|(
name|option
operator|->
name|value
argument_list|)
expr_stmt|;
comment|/* 			 * XXX KDM do we want a way to specify a writeable 			 * flag of some sort?  Do we want a way to specify 			 * binary data? 			 */
name|req
operator|.
name|be_args
index|[
name|i
index|]
operator|.
name|flags
operator|=
name|CTL_BEARG_ASCII
operator||
name|CTL_BEARG_RD
expr_stmt|;
name|STAILQ_REMOVE
argument_list|(
operator|&
name|option_list
argument_list|,
name|option
argument_list|,
name|cctl_req_option
argument_list|,
name|links
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|option
operator|->
name|name
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|option
operator|->
name|value
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|option
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|CTL_LUN_REQ
argument_list|,
operator|&
name|req
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|warn
argument_list|(
literal|"%s: error issuing CTL_LUN_REQ ioctl"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
switch|switch
condition|(
name|req
operator|.
name|status
condition|)
block|{
case|case
name|CTL_LUN_ERROR
case|:
name|warnx
argument_list|(
literal|"LUN removal error: %s"
argument_list|,
name|req
operator|.
name|error_str
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
case|case
name|CTL_LUN_WARNING
case|:
name|warnx
argument_list|(
literal|"LUN removal warning: %s"
argument_list|,
name|req
operator|.
name|error_str
argument_list|)
expr_stmt|;
break|break;
case|case
name|CTL_LUN_OK
case|:
break|break;
default|default:
name|warnx
argument_list|(
literal|"unknown LUN removal status: %d"
argument_list|,
name|req
operator|.
name|status
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
name|printf
argument_list|(
literal|"LUN %d removed successfully\n"
argument_list|,
name|lun_id
argument_list|)
expr_stmt|;
name|bailout
label|:
return|return
operator|(
name|retval
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cctl_modify_lun
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|,
name|char
modifier|*
name|combinedopt
parameter_list|)
block|{
name|struct
name|ctl_lun_req
name|req
decl_stmt|;
name|uint64_t
name|lun_size
init|=
literal|0
decl_stmt|;
name|uint32_t
name|lun_id
init|=
literal|0
decl_stmt|;
name|int
name|lun_id_set
init|=
literal|0
decl_stmt|,
name|lun_size_set
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|backend_name
init|=
name|NULL
decl_stmt|;
name|STAILQ_HEAD
argument_list|(
argument_list|,
argument|cctl_req_option
argument_list|)
name|option_list
expr_stmt|;
name|int
name|num_options
init|=
literal|0
decl_stmt|;
name|int
name|retval
init|=
literal|0
decl_stmt|,
name|c
decl_stmt|;
name|STAILQ_INIT
argument_list|(
operator|&
name|option_list
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|combinedopt
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'b'
case|:
name|backend_name
operator|=
name|strdup
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
name|lun_id
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|lun_id_set
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'o'
case|:
block|{
name|struct
name|cctl_req_option
modifier|*
name|option
decl_stmt|;
name|char
modifier|*
name|tmpstr
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|,
modifier|*
name|value
decl_stmt|;
name|tmpstr
operator|=
name|strdup
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
name|name
operator|=
name|strsep
argument_list|(
operator|&
name|tmpstr
argument_list|,
literal|"="
argument_list|)
expr_stmt|;
if|if
condition|(
name|name
operator|==
name|NULL
condition|)
block|{
name|warnx
argument_list|(
literal|"%s: option -o takes \"name=value\""
literal|"argument"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
name|value
operator|=
name|strsep
argument_list|(
operator|&
name|tmpstr
argument_list|,
literal|"="
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|==
name|NULL
condition|)
block|{
name|warnx
argument_list|(
literal|"%s: option -o takes \"name=value\""
literal|"argument"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
name|option
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|option
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|option
operator|==
name|NULL
condition|)
block|{
name|warn
argument_list|(
literal|"%s: error allocating %zd bytes"
argument_list|,
name|__func__
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|option
argument_list|)
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
name|option
operator|->
name|name
operator|=
name|strdup
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|option
operator|->
name|namelen
operator|=
name|strlen
argument_list|(
name|name
argument_list|)
operator|+
literal|1
expr_stmt|;
name|option
operator|->
name|value
operator|=
name|strdup
argument_list|(
name|value
argument_list|)
expr_stmt|;
name|option
operator|->
name|vallen
operator|=
name|strlen
argument_list|(
name|value
argument_list|)
operator|+
literal|1
expr_stmt|;
name|free
argument_list|(
name|tmpstr
argument_list|)
expr_stmt|;
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|option_list
argument_list|,
name|option
argument_list|,
name|links
argument_list|)
expr_stmt|;
name|num_options
operator|++
expr_stmt|;
break|break;
block|}
case|case
literal|'s'
case|:
if|if
condition|(
name|strcasecmp
argument_list|(
name|optarg
argument_list|,
literal|"auto"
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|retval
operator|=
name|expand_number
argument_list|(
name|optarg
argument_list|,
operator|&
name|lun_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
operator|!=
literal|0
condition|)
block|{
name|warn
argument_list|(
literal|"%s: invalid -s argument"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
block|}
name|lun_size_set
operator|=
literal|1
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
if|if
condition|(
name|backend_name
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s: backend name (-b) must be specified"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
name|lun_id_set
operator|==
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s: LUN id (-l) must be specified"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
name|lun_size_set
operator|==
literal|0
operator|&&
name|num_options
operator|==
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s: size (-s) or options (-o) must be specified"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|req
operator|.
name|backend
argument_list|,
name|backend_name
argument_list|,
sizeof|sizeof
argument_list|(
name|req
operator|.
name|backend
argument_list|)
argument_list|)
expr_stmt|;
name|req
operator|.
name|reqtype
operator|=
name|CTL_LUNREQ_MODIFY
expr_stmt|;
name|req
operator|.
name|reqdata
operator|.
name|modify
operator|.
name|lun_id
operator|=
name|lun_id
expr_stmt|;
name|req
operator|.
name|reqdata
operator|.
name|modify
operator|.
name|lun_size_bytes
operator|=
name|lun_size
expr_stmt|;
name|req
operator|.
name|num_be_args
operator|=
name|num_options
expr_stmt|;
if|if
condition|(
name|num_options
operator|>
literal|0
condition|)
block|{
name|struct
name|cctl_req_option
modifier|*
name|option
decl_stmt|,
modifier|*
name|next_option
decl_stmt|;
name|int
name|i
decl_stmt|;
name|req
operator|.
name|be_args
operator|=
name|malloc
argument_list|(
name|num_options
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|req
operator|.
name|be_args
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|.
name|be_args
operator|==
name|NULL
condition|)
block|{
name|warn
argument_list|(
literal|"%s: error allocating %zd bytes"
argument_list|,
name|__func__
argument_list|,
name|num_options
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|req
operator|.
name|be_args
argument_list|)
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|option
operator|=
name|STAILQ_FIRST
argument_list|(
operator|&
name|option_list
argument_list|)
init|;
name|i
operator|<
name|num_options
condition|;
name|i
operator|++
operator|,
name|option
operator|=
name|next_option
control|)
block|{
name|next_option
operator|=
name|STAILQ_NEXT
argument_list|(
name|option
argument_list|,
name|links
argument_list|)
expr_stmt|;
name|req
operator|.
name|be_args
index|[
name|i
index|]
operator|.
name|namelen
operator|=
name|option
operator|->
name|namelen
expr_stmt|;
name|req
operator|.
name|be_args
index|[
name|i
index|]
operator|.
name|name
operator|=
name|strdup
argument_list|(
name|option
operator|->
name|name
argument_list|)
expr_stmt|;
name|req
operator|.
name|be_args
index|[
name|i
index|]
operator|.
name|vallen
operator|=
name|option
operator|->
name|vallen
expr_stmt|;
name|req
operator|.
name|be_args
index|[
name|i
index|]
operator|.
name|value
operator|=
name|strdup
argument_list|(
name|option
operator|->
name|value
argument_list|)
expr_stmt|;
comment|/* 			 * XXX KDM do we want a way to specify a writeable 			 * flag of some sort?  Do we want a way to specify 			 * binary data? 			 */
name|req
operator|.
name|be_args
index|[
name|i
index|]
operator|.
name|flags
operator|=
name|CTL_BEARG_ASCII
operator||
name|CTL_BEARG_RD
expr_stmt|;
name|STAILQ_REMOVE
argument_list|(
operator|&
name|option_list
argument_list|,
name|option
argument_list|,
name|cctl_req_option
argument_list|,
name|links
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|option
operator|->
name|name
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|option
operator|->
name|value
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|option
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|CTL_LUN_REQ
argument_list|,
operator|&
name|req
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|warn
argument_list|(
literal|"%s: error issuing CTL_LUN_REQ ioctl"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
switch|switch
condition|(
name|req
operator|.
name|status
condition|)
block|{
case|case
name|CTL_LUN_ERROR
case|:
name|warnx
argument_list|(
literal|"LUN modification error: %s"
argument_list|,
name|req
operator|.
name|error_str
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
case|case
name|CTL_LUN_WARNING
case|:
name|warnx
argument_list|(
literal|"LUN modification warning: %s"
argument_list|,
name|req
operator|.
name|error_str
argument_list|)
expr_stmt|;
break|break;
case|case
name|CTL_LUN_OK
case|:
break|break;
default|default:
name|warnx
argument_list|(
literal|"unknown LUN modification status: %d"
argument_list|,
name|req
operator|.
name|status
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
name|printf
argument_list|(
literal|"LUN %d modified successfully\n"
argument_list|,
name|lun_id
argument_list|)
expr_stmt|;
name|bailout
label|:
return|return
operator|(
name|retval
operator|)
return|;
block|}
end_function

begin_struct
struct|struct
name|cctl_islist_conn
block|{
name|int
name|connection_id
decl_stmt|;
name|char
modifier|*
name|initiator
decl_stmt|;
name|char
modifier|*
name|initiator_addr
decl_stmt|;
name|char
modifier|*
name|initiator_alias
decl_stmt|;
name|char
modifier|*
name|target
decl_stmt|;
name|char
modifier|*
name|target_alias
decl_stmt|;
name|char
modifier|*
name|header_digest
decl_stmt|;
name|char
modifier|*
name|data_digest
decl_stmt|;
name|char
modifier|*
name|max_recv_data_segment_length
decl_stmt|;
name|char
modifier|*
name|max_send_data_segment_length
decl_stmt|;
name|char
modifier|*
name|max_burst_length
decl_stmt|;
name|char
modifier|*
name|first_burst_length
decl_stmt|;
name|char
modifier|*
name|offload
decl_stmt|;
name|int
name|immediate_data
decl_stmt|;
name|int
name|iser
decl_stmt|;
name|STAILQ_ENTRY
argument_list|(
argument|cctl_islist_conn
argument_list|)
name|links
expr_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|cctl_islist_data
block|{
name|int
name|num_conns
decl_stmt|;
name|STAILQ_HEAD
argument_list|(
argument_list|,
argument|cctl_islist_conn
argument_list|)
name|conn_list
expr_stmt|;
name|struct
name|cctl_islist_conn
modifier|*
name|cur_conn
decl_stmt|;
name|int
name|level
decl_stmt|;
name|struct
name|sbuf
modifier|*
name|cur_sb
index|[
literal|32
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
name|cctl_islist_start_element
parameter_list|(
name|void
modifier|*
name|user_data
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|attr
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|struct
name|cctl_islist_data
modifier|*
name|islist
decl_stmt|;
name|struct
name|cctl_islist_conn
modifier|*
name|cur_conn
decl_stmt|;
name|islist
operator|=
operator|(
expr|struct
name|cctl_islist_data
operator|*
operator|)
name|user_data
expr_stmt|;
name|cur_conn
operator|=
name|islist
operator|->
name|cur_conn
expr_stmt|;
name|islist
operator|->
name|level
operator|++
expr_stmt|;
if|if
condition|(
operator|(
name|u_int
operator|)
name|islist
operator|->
name|level
operator|>=
operator|(
sizeof|sizeof
argument_list|(
name|islist
operator|->
name|cur_sb
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|islist
operator|->
name|cur_sb
index|[
literal|0
index|]
argument_list|)
operator|)
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s: too many nesting levels, %zd max"
argument_list|,
name|__func__
argument_list|,
sizeof|sizeof
argument_list|(
name|islist
operator|->
name|cur_sb
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|islist
operator|->
name|cur_sb
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|islist
operator|->
name|cur_sb
index|[
name|islist
operator|->
name|level
index|]
operator|=
name|sbuf_new_auto
argument_list|()
expr_stmt|;
if|if
condition|(
name|islist
operator|->
name|cur_sb
index|[
name|islist
operator|->
name|level
index|]
operator|==
name|NULL
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"%s: Unable to allocate sbuf"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"connection"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|cur_conn
operator|!=
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s: improper connection element nesting"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|cur_conn
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|cur_conn
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cur_conn
operator|==
name|NULL
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"%s: cannot allocate %zd bytes"
argument_list|,
name|__func__
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|cur_conn
argument_list|)
argument_list|)
expr_stmt|;
name|islist
operator|->
name|num_conns
operator|++
expr_stmt|;
name|islist
operator|->
name|cur_conn
operator|=
name|cur_conn
expr_stmt|;
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|islist
operator|->
name|conn_list
argument_list|,
name|cur_conn
argument_list|,
name|links
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|attr
index|[
name|i
index|]
operator|!=
name|NULL
condition|;
name|i
operator|+=
literal|2
control|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|attr
index|[
name|i
index|]
argument_list|,
literal|"id"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|cur_conn
operator|->
name|connection_id
operator|=
name|strtoull
argument_list|(
name|attr
index|[
name|i
operator|+
literal|1
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s: invalid connection attribute %s = %s"
argument_list|,
name|__func__
argument_list|,
name|attr
index|[
name|i
index|]
argument_list|,
name|attr
index|[
name|i
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|cctl_islist_end_element
parameter_list|(
name|void
modifier|*
name|user_data
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
name|struct
name|cctl_islist_data
modifier|*
name|islist
decl_stmt|;
name|struct
name|cctl_islist_conn
modifier|*
name|cur_conn
decl_stmt|;
name|char
modifier|*
name|str
decl_stmt|;
name|islist
operator|=
operator|(
expr|struct
name|cctl_islist_data
operator|*
operator|)
name|user_data
expr_stmt|;
name|cur_conn
operator|=
name|islist
operator|->
name|cur_conn
expr_stmt|;
if|if
condition|(
operator|(
name|cur_conn
operator|==
name|NULL
operator|)
operator|&&
operator|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"ctlislist"
argument_list|)
operator|!=
literal|0
operator|)
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s: cur_conn == NULL! (name = %s)"
argument_list|,
name|__func__
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|islist
operator|->
name|cur_sb
index|[
name|islist
operator|->
name|level
index|]
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s: no valid sbuf at level %d (name %s)"
argument_list|,
name|__func__
argument_list|,
name|islist
operator|->
name|level
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|sbuf_finish
argument_list|(
name|islist
operator|->
name|cur_sb
index|[
name|islist
operator|->
name|level
index|]
argument_list|)
expr_stmt|;
name|str
operator|=
name|strdup
argument_list|(
name|sbuf_data
argument_list|(
name|islist
operator|->
name|cur_sb
index|[
name|islist
operator|->
name|level
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|str
operator|==
name|NULL
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"%s can't allocate %zd bytes for string"
argument_list|,
name|__func__
argument_list|,
name|sbuf_len
argument_list|(
name|islist
operator|->
name|cur_sb
index|[
name|islist
operator|->
name|level
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_delete
argument_list|(
name|islist
operator|->
name|cur_sb
index|[
name|islist
operator|->
name|level
index|]
argument_list|)
expr_stmt|;
name|islist
operator|->
name|cur_sb
index|[
name|islist
operator|->
name|level
index|]
operator|=
name|NULL
expr_stmt|;
name|islist
operator|->
name|level
operator|--
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"initiator"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|cur_conn
operator|->
name|initiator
operator|=
name|str
expr_stmt|;
name|str
operator|=
name|NULL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"initiator_addr"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|cur_conn
operator|->
name|initiator_addr
operator|=
name|str
expr_stmt|;
name|str
operator|=
name|NULL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"initiator_alias"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|cur_conn
operator|->
name|initiator_alias
operator|=
name|str
expr_stmt|;
name|str
operator|=
name|NULL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"target"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|cur_conn
operator|->
name|target
operator|=
name|str
expr_stmt|;
name|str
operator|=
name|NULL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"target_alias"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|cur_conn
operator|->
name|target_alias
operator|=
name|str
expr_stmt|;
name|str
operator|=
name|NULL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"target_portal_group_tag"
argument_list|)
operator|==
literal|0
condition|)
block|{ 	}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"header_digest"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|cur_conn
operator|->
name|header_digest
operator|=
name|str
expr_stmt|;
name|str
operator|=
name|NULL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"data_digest"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|cur_conn
operator|->
name|data_digest
operator|=
name|str
expr_stmt|;
name|str
operator|=
name|NULL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"max_recv_data_segment_length"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|cur_conn
operator|->
name|max_recv_data_segment_length
operator|=
name|str
expr_stmt|;
name|str
operator|=
name|NULL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"max_send_data_segment_length"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|cur_conn
operator|->
name|max_send_data_segment_length
operator|=
name|str
expr_stmt|;
name|str
operator|=
name|NULL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"max_burst_length"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|cur_conn
operator|->
name|max_burst_length
operator|=
name|str
expr_stmt|;
name|str
operator|=
name|NULL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"first_burst_length"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|cur_conn
operator|->
name|first_burst_length
operator|=
name|str
expr_stmt|;
name|str
operator|=
name|NULL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"offload"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|cur_conn
operator|->
name|offload
operator|=
name|str
expr_stmt|;
name|str
operator|=
name|NULL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"immediate_data"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|cur_conn
operator|->
name|immediate_data
operator|=
name|atoi
argument_list|(
name|str
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"iser"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|cur_conn
operator|->
name|iser
operator|=
name|atoi
argument_list|(
name|str
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"connection"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|islist
operator|->
name|cur_conn
operator|=
name|NULL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"ctlislist"
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* Nothing. */
block|}
else|else
block|{
comment|/* 		 * Unknown element; ignore it for forward compatibility. 		 */
block|}
name|free
argument_list|(
name|str
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|cctl_islist_char_handler
parameter_list|(
name|void
modifier|*
name|user_data
parameter_list|,
specifier|const
name|XML_Char
modifier|*
name|str
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|struct
name|cctl_islist_data
modifier|*
name|islist
decl_stmt|;
name|islist
operator|=
operator|(
expr|struct
name|cctl_islist_data
operator|*
operator|)
name|user_data
expr_stmt|;
name|sbuf_bcat
argument_list|(
name|islist
operator|->
name|cur_sb
index|[
name|islist
operator|->
name|level
index|]
argument_list|,
name|str
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|cctl_islist
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|,
name|char
modifier|*
name|combinedopt
parameter_list|)
block|{
name|struct
name|ctl_iscsi
name|req
decl_stmt|;
name|struct
name|cctl_islist_data
name|islist
decl_stmt|;
name|struct
name|cctl_islist_conn
modifier|*
name|conn
decl_stmt|;
name|XML_Parser
name|parser
decl_stmt|;
name|char
modifier|*
name|conn_str
decl_stmt|;
name|int
name|conn_len
decl_stmt|;
name|int
name|dump_xml
init|=
literal|0
decl_stmt|;
name|int
name|c
decl_stmt|,
name|retval
decl_stmt|,
name|verbose
init|=
literal|0
decl_stmt|;
name|retval
operator|=
literal|0
expr_stmt|;
name|conn_len
operator|=
literal|4096
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|islist
argument_list|,
sizeof|sizeof
argument_list|(
name|islist
argument_list|)
argument_list|)
expr_stmt|;
name|STAILQ_INIT
argument_list|(
operator|&
name|islist
operator|.
name|conn_list
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|combinedopt
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'v'
case|:
name|verbose
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'x'
case|:
name|dump_xml
operator|=
literal|1
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
name|retry
label|:
name|conn_str
operator|=
name|malloc
argument_list|(
name|conn_len
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|req
operator|.
name|type
operator|=
name|CTL_ISCSI_LIST
expr_stmt|;
name|req
operator|.
name|data
operator|.
name|list
operator|.
name|alloc_len
operator|=
name|conn_len
expr_stmt|;
name|req
operator|.
name|data
operator|.
name|list
operator|.
name|conn_xml
operator|=
name|conn_str
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|CTL_ISCSI
argument_list|,
operator|&
name|req
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|warn
argument_list|(
literal|"%s: error issuing CTL_ISCSI ioctl"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
if|if
condition|(
name|req
operator|.
name|status
operator|==
name|CTL_ISCSI_ERROR
condition|)
block|{
name|warnx
argument_list|(
literal|"%s: error returned from CTL_ISCSI ioctl:\n%s"
argument_list|,
name|__func__
argument_list|,
name|req
operator|.
name|error_str
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|req
operator|.
name|status
operator|==
name|CTL_ISCSI_LIST_NEED_MORE_SPACE
condition|)
block|{
name|conn_len
operator|=
name|conn_len
operator|<<
literal|1
expr_stmt|;
goto|goto
name|retry
goto|;
block|}
if|if
condition|(
name|dump_xml
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|conn_str
argument_list|)
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
name|parser
operator|=
name|XML_ParserCreate
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|parser
operator|==
name|NULL
condition|)
block|{
name|warn
argument_list|(
literal|"%s: Unable to create XML parser"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
name|XML_SetUserData
argument_list|(
name|parser
argument_list|,
operator|&
name|islist
argument_list|)
expr_stmt|;
name|XML_SetElementHandler
argument_list|(
name|parser
argument_list|,
name|cctl_islist_start_element
argument_list|,
name|cctl_islist_end_element
argument_list|)
expr_stmt|;
name|XML_SetCharacterDataHandler
argument_list|(
name|parser
argument_list|,
name|cctl_islist_char_handler
argument_list|)
expr_stmt|;
name|retval
operator|=
name|XML_Parse
argument_list|(
name|parser
argument_list|,
name|conn_str
argument_list|,
name|strlen
argument_list|(
name|conn_str
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
operator|!=
literal|1
condition|)
block|{
name|warnx
argument_list|(
literal|"%s: Unable to parse XML: Error %d"
argument_list|,
name|__func__
argument_list|,
name|XML_GetErrorCode
argument_list|(
name|parser
argument_list|)
argument_list|)
expr_stmt|;
name|XML_ParserFree
argument_list|(
name|parser
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
name|retval
operator|=
literal|0
expr_stmt|;
name|XML_ParserFree
argument_list|(
name|parser
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
operator|!=
literal|0
condition|)
block|{
name|STAILQ_FOREACH
argument_list|(
argument|conn
argument_list|,
argument|&islist.conn_list
argument_list|,
argument|links
argument_list|)
block|{
name|printf
argument_list|(
literal|"%-25s %d\n"
argument_list|,
literal|"Session ID:"
argument_list|,
name|conn
operator|->
name|connection_id
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%-25s %s\n"
argument_list|,
literal|"Initiator name:"
argument_list|,
name|conn
operator|->
name|initiator
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%-25s %s\n"
argument_list|,
literal|"Initiator portal:"
argument_list|,
name|conn
operator|->
name|initiator_addr
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%-25s %s\n"
argument_list|,
literal|"Initiator alias:"
argument_list|,
name|conn
operator|->
name|initiator_alias
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%-25s %s\n"
argument_list|,
literal|"Target name:"
argument_list|,
name|conn
operator|->
name|target
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%-25s %s\n"
argument_list|,
literal|"Target alias:"
argument_list|,
name|conn
operator|->
name|target_alias
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%-25s %s\n"
argument_list|,
literal|"Header digest:"
argument_list|,
name|conn
operator|->
name|header_digest
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%-25s %s\n"
argument_list|,
literal|"Data digest:"
argument_list|,
name|conn
operator|->
name|data_digest
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%-25s %s\n"
argument_list|,
literal|"MaxRecvDataSegmentLength:"
argument_list|,
name|conn
operator|->
name|max_recv_data_segment_length
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%-25s %s\n"
argument_list|,
literal|"MaxSendDataSegmentLength:"
argument_list|,
name|conn
operator|->
name|max_send_data_segment_length
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%-25s %s\n"
argument_list|,
literal|"MaxBurstLen:"
argument_list|,
name|conn
operator|->
name|max_burst_length
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%-25s %s\n"
argument_list|,
literal|"FirstBurstLen:"
argument_list|,
name|conn
operator|->
name|first_burst_length
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%-25s %s\n"
argument_list|,
literal|"ImmediateData:"
argument_list|,
name|conn
operator|->
name|immediate_data
condition|?
literal|"Yes"
else|:
literal|"No"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%-25s %s\n"
argument_list|,
literal|"iSER (RDMA):"
argument_list|,
name|conn
operator|->
name|iser
condition|?
literal|"Yes"
else|:
literal|"No"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%-25s %s\n"
argument_list|,
literal|"Offload driver:"
argument_list|,
name|conn
operator|->
name|offload
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|printf
argument_list|(
literal|"%4s %-16s %-36s %-36s\n"
argument_list|,
literal|"ID"
argument_list|,
literal|"Portal"
argument_list|,
literal|"Initiator name"
argument_list|,
literal|"Target name"
argument_list|)
expr_stmt|;
name|STAILQ_FOREACH
argument_list|(
argument|conn
argument_list|,
argument|&islist.conn_list
argument_list|,
argument|links
argument_list|)
block|{
name|printf
argument_list|(
literal|"%4u %-16s %-36s %-36s\n"
argument_list|,
name|conn
operator|->
name|connection_id
argument_list|,
name|conn
operator|->
name|initiator_addr
argument_list|,
name|conn
operator|->
name|initiator
argument_list|,
name|conn
operator|->
name|target
argument_list|)
expr_stmt|;
block|}
block|}
name|bailout
label|:
name|free
argument_list|(
name|conn_str
argument_list|)
expr_stmt|;
return|return
operator|(
name|retval
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cctl_islogout
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|,
name|char
modifier|*
name|combinedopt
parameter_list|)
block|{
name|struct
name|ctl_iscsi
name|req
decl_stmt|;
name|int
name|retval
init|=
literal|0
decl_stmt|,
name|c
decl_stmt|;
name|int
name|all
init|=
literal|0
decl_stmt|,
name|connection_id
init|=
operator|-
literal|1
decl_stmt|,
name|nargs
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|initiator_name
init|=
name|NULL
decl_stmt|,
modifier|*
name|initiator_addr
init|=
name|NULL
decl_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|combinedopt
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'a'
case|:
name|all
operator|=
literal|1
expr_stmt|;
name|nargs
operator|++
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
name|connection_id
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|nargs
operator|++
expr_stmt|;
break|break;
case|case
literal|'i'
case|:
name|initiator_name
operator|=
name|strdup
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
if|if
condition|(
name|initiator_name
operator|==
name|NULL
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"%s: strdup"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|nargs
operator|++
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
name|initiator_addr
operator|=
name|strdup
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
if|if
condition|(
name|initiator_addr
operator|==
name|NULL
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"%s: strdup"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|nargs
operator|++
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
if|if
condition|(
name|nargs
operator|==
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s: either -a, -c, -i, or -p must be specified"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
name|nargs
operator|>
literal|1
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s: only one of -a, -c, -i, or -p may be specified"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|req
operator|.
name|type
operator|=
name|CTL_ISCSI_LOGOUT
expr_stmt|;
name|req
operator|.
name|data
operator|.
name|logout
operator|.
name|connection_id
operator|=
name|connection_id
expr_stmt|;
if|if
condition|(
name|initiator_addr
operator|!=
name|NULL
condition|)
name|strlcpy
argument_list|(
name|req
operator|.
name|data
operator|.
name|logout
operator|.
name|initiator_addr
argument_list|,
name|initiator_addr
argument_list|,
sizeof|sizeof
argument_list|(
name|req
operator|.
name|data
operator|.
name|logout
operator|.
name|initiator_addr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|initiator_name
operator|!=
name|NULL
condition|)
name|strlcpy
argument_list|(
name|req
operator|.
name|data
operator|.
name|logout
operator|.
name|initiator_name
argument_list|,
name|initiator_name
argument_list|,
sizeof|sizeof
argument_list|(
name|req
operator|.
name|data
operator|.
name|logout
operator|.
name|initiator_name
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|all
operator|!=
literal|0
condition|)
name|req
operator|.
name|data
operator|.
name|logout
operator|.
name|all
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|CTL_ISCSI
argument_list|,
operator|&
name|req
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|warn
argument_list|(
literal|"%s: error issuing CTL_ISCSI ioctl"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
if|if
condition|(
name|req
operator|.
name|status
operator|!=
name|CTL_ISCSI_OK
condition|)
block|{
name|warnx
argument_list|(
literal|"%s: error returned from CTL iSCSI logout request:\n%s"
argument_list|,
name|__func__
argument_list|,
name|req
operator|.
name|error_str
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
name|printf
argument_list|(
literal|"iSCSI logout requests submitted\n"
argument_list|)
expr_stmt|;
name|bailout
label|:
return|return
operator|(
name|retval
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cctl_isterminate
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|,
name|char
modifier|*
name|combinedopt
parameter_list|)
block|{
name|struct
name|ctl_iscsi
name|req
decl_stmt|;
name|int
name|retval
init|=
literal|0
decl_stmt|,
name|c
decl_stmt|;
name|int
name|all
init|=
literal|0
decl_stmt|,
name|connection_id
init|=
operator|-
literal|1
decl_stmt|,
name|nargs
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|initiator_name
init|=
name|NULL
decl_stmt|,
modifier|*
name|initiator_addr
init|=
name|NULL
decl_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|combinedopt
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'a'
case|:
name|all
operator|=
literal|1
expr_stmt|;
name|nargs
operator|++
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
name|connection_id
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|nargs
operator|++
expr_stmt|;
break|break;
case|case
literal|'i'
case|:
name|initiator_name
operator|=
name|strdup
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
if|if
condition|(
name|initiator_name
operator|==
name|NULL
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"%s: strdup"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|nargs
operator|++
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
name|initiator_addr
operator|=
name|strdup
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
if|if
condition|(
name|initiator_addr
operator|==
name|NULL
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"%s: strdup"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|nargs
operator|++
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
if|if
condition|(
name|nargs
operator|==
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s: either -a, -c, -i, or -p must be specified"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
name|nargs
operator|>
literal|1
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s: only one of -a, -c, -i, or -p may be specified"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|req
operator|.
name|type
operator|=
name|CTL_ISCSI_TERMINATE
expr_stmt|;
name|req
operator|.
name|data
operator|.
name|terminate
operator|.
name|connection_id
operator|=
name|connection_id
expr_stmt|;
if|if
condition|(
name|initiator_addr
operator|!=
name|NULL
condition|)
name|strlcpy
argument_list|(
name|req
operator|.
name|data
operator|.
name|terminate
operator|.
name|initiator_addr
argument_list|,
name|initiator_addr
argument_list|,
sizeof|sizeof
argument_list|(
name|req
operator|.
name|data
operator|.
name|terminate
operator|.
name|initiator_addr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|initiator_name
operator|!=
name|NULL
condition|)
name|strlcpy
argument_list|(
name|req
operator|.
name|data
operator|.
name|terminate
operator|.
name|initiator_name
argument_list|,
name|initiator_name
argument_list|,
sizeof|sizeof
argument_list|(
name|req
operator|.
name|data
operator|.
name|terminate
operator|.
name|initiator_name
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|all
operator|!=
literal|0
condition|)
name|req
operator|.
name|data
operator|.
name|terminate
operator|.
name|all
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|CTL_ISCSI
argument_list|,
operator|&
name|req
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|warn
argument_list|(
literal|"%s: error issuing CTL_ISCSI ioctl"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
if|if
condition|(
name|req
operator|.
name|status
operator|!=
name|CTL_ISCSI_OK
condition|)
block|{
name|warnx
argument_list|(
literal|"%s: error returned from CTL iSCSI connection "
literal|"termination request:\n%s"
argument_list|,
name|__func__
argument_list|,
name|req
operator|.
name|error_str
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
name|printf
argument_list|(
literal|"iSCSI connections terminated\n"
argument_list|)
expr_stmt|;
name|bailout
label|:
return|return
operator|(
name|retval
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Name/value pair used for per-LUN attributes.  */
end_comment

begin_struct
struct|struct
name|cctl_lun_nv
block|{
name|char
modifier|*
name|name
decl_stmt|;
name|char
modifier|*
name|value
decl_stmt|;
name|STAILQ_ENTRY
argument_list|(
argument|cctl_lun_nv
argument_list|)
name|links
expr_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/*  * Backend LUN information.  */
end_comment

begin_struct
struct|struct
name|cctl_lun
block|{
name|uint64_t
name|lun_id
decl_stmt|;
name|char
modifier|*
name|backend_type
decl_stmt|;
name|uint64_t
name|size_blocks
decl_stmt|;
name|uint32_t
name|blocksize
decl_stmt|;
name|char
modifier|*
name|serial_number
decl_stmt|;
name|char
modifier|*
name|device_id
decl_stmt|;
name|STAILQ_HEAD
argument_list|(
argument_list|,
argument|cctl_lun_nv
argument_list|)
name|attr_list
expr_stmt|;
name|STAILQ_ENTRY
argument_list|(
argument|cctl_lun
argument_list|)
name|links
expr_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|cctl_devlist_data
block|{
name|int
name|num_luns
decl_stmt|;
name|STAILQ_HEAD
argument_list|(
argument_list|,
argument|cctl_lun
argument_list|)
name|lun_list
expr_stmt|;
name|struct
name|cctl_lun
modifier|*
name|cur_lun
decl_stmt|;
name|int
name|level
decl_stmt|;
name|struct
name|sbuf
modifier|*
name|cur_sb
index|[
literal|32
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
name|cctl_start_element
parameter_list|(
name|void
modifier|*
name|user_data
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|attr
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|struct
name|cctl_devlist_data
modifier|*
name|devlist
decl_stmt|;
name|struct
name|cctl_lun
modifier|*
name|cur_lun
decl_stmt|;
name|devlist
operator|=
operator|(
expr|struct
name|cctl_devlist_data
operator|*
operator|)
name|user_data
expr_stmt|;
name|cur_lun
operator|=
name|devlist
operator|->
name|cur_lun
expr_stmt|;
name|devlist
operator|->
name|level
operator|++
expr_stmt|;
if|if
condition|(
operator|(
name|u_int
operator|)
name|devlist
operator|->
name|level
operator|>=
operator|(
sizeof|sizeof
argument_list|(
name|devlist
operator|->
name|cur_sb
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|devlist
operator|->
name|cur_sb
index|[
literal|0
index|]
argument_list|)
operator|)
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s: too many nesting levels, %zd max"
argument_list|,
name|__func__
argument_list|,
sizeof|sizeof
argument_list|(
name|devlist
operator|->
name|cur_sb
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|devlist
operator|->
name|cur_sb
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|devlist
operator|->
name|cur_sb
index|[
name|devlist
operator|->
name|level
index|]
operator|=
name|sbuf_new_auto
argument_list|()
expr_stmt|;
if|if
condition|(
name|devlist
operator|->
name|cur_sb
index|[
name|devlist
operator|->
name|level
index|]
operator|==
name|NULL
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"%s: Unable to allocate sbuf"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"lun"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|cur_lun
operator|!=
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s: improper lun element nesting"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|cur_lun
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|cur_lun
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cur_lun
operator|==
name|NULL
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"%s: cannot allocate %zd bytes"
argument_list|,
name|__func__
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|cur_lun
argument_list|)
argument_list|)
expr_stmt|;
name|devlist
operator|->
name|num_luns
operator|++
expr_stmt|;
name|devlist
operator|->
name|cur_lun
operator|=
name|cur_lun
expr_stmt|;
name|STAILQ_INIT
argument_list|(
operator|&
name|cur_lun
operator|->
name|attr_list
argument_list|)
expr_stmt|;
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|devlist
operator|->
name|lun_list
argument_list|,
name|cur_lun
argument_list|,
name|links
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|attr
index|[
name|i
index|]
operator|!=
name|NULL
condition|;
name|i
operator|+=
literal|2
control|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|attr
index|[
name|i
index|]
argument_list|,
literal|"id"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|cur_lun
operator|->
name|lun_id
operator|=
name|strtoull
argument_list|(
name|attr
index|[
name|i
operator|+
literal|1
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s: invalid LUN attribute %s = %s"
argument_list|,
name|__func__
argument_list|,
name|attr
index|[
name|i
index|]
argument_list|,
name|attr
index|[
name|i
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|cctl_end_element
parameter_list|(
name|void
modifier|*
name|user_data
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
name|struct
name|cctl_devlist_data
modifier|*
name|devlist
decl_stmt|;
name|struct
name|cctl_lun
modifier|*
name|cur_lun
decl_stmt|;
name|char
modifier|*
name|str
decl_stmt|;
name|devlist
operator|=
operator|(
expr|struct
name|cctl_devlist_data
operator|*
operator|)
name|user_data
expr_stmt|;
name|cur_lun
operator|=
name|devlist
operator|->
name|cur_lun
expr_stmt|;
if|if
condition|(
operator|(
name|cur_lun
operator|==
name|NULL
operator|)
operator|&&
operator|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"ctllunlist"
argument_list|)
operator|!=
literal|0
operator|)
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s: cur_lun == NULL! (name = %s)"
argument_list|,
name|__func__
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|devlist
operator|->
name|cur_sb
index|[
name|devlist
operator|->
name|level
index|]
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s: no valid sbuf at level %d (name %s)"
argument_list|,
name|__func__
argument_list|,
name|devlist
operator|->
name|level
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|sbuf_finish
argument_list|(
name|devlist
operator|->
name|cur_sb
index|[
name|devlist
operator|->
name|level
index|]
argument_list|)
operator|!=
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"%s: sbuf_finish"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|str
operator|=
name|strdup
argument_list|(
name|sbuf_data
argument_list|(
name|devlist
operator|->
name|cur_sb
index|[
name|devlist
operator|->
name|level
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|str
operator|==
name|NULL
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"%s can't allocate %zd bytes for string"
argument_list|,
name|__func__
argument_list|,
name|sbuf_len
argument_list|(
name|devlist
operator|->
name|cur_sb
index|[
name|devlist
operator|->
name|level
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|str
argument_list|)
operator|==
literal|0
condition|)
block|{
name|free
argument_list|(
name|str
argument_list|)
expr_stmt|;
name|str
operator|=
name|NULL
expr_stmt|;
block|}
name|sbuf_delete
argument_list|(
name|devlist
operator|->
name|cur_sb
index|[
name|devlist
operator|->
name|level
index|]
argument_list|)
expr_stmt|;
name|devlist
operator|->
name|cur_sb
index|[
name|devlist
operator|->
name|level
index|]
operator|=
name|NULL
expr_stmt|;
name|devlist
operator|->
name|level
operator|--
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"backend_type"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|cur_lun
operator|->
name|backend_type
operator|=
name|str
expr_stmt|;
name|str
operator|=
name|NULL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"size"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|cur_lun
operator|->
name|size_blocks
operator|=
name|strtoull
argument_list|(
name|str
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"blocksize"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|cur_lun
operator|->
name|blocksize
operator|=
name|strtoul
argument_list|(
name|str
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"serial_number"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|cur_lun
operator|->
name|serial_number
operator|=
name|str
expr_stmt|;
name|str
operator|=
name|NULL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"device_id"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|cur_lun
operator|->
name|device_id
operator|=
name|str
expr_stmt|;
name|str
operator|=
name|NULL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"lun"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|devlist
operator|->
name|cur_lun
operator|=
name|NULL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"ctllunlist"
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* Nothing. */
block|}
else|else
block|{
name|struct
name|cctl_lun_nv
modifier|*
name|nv
decl_stmt|;
name|nv
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|nv
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|nv
operator|==
name|NULL
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"%s: can't allocate %zd bytes for nv pair"
argument_list|,
name|__func__
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|nv
argument_list|)
argument_list|)
expr_stmt|;
name|nv
operator|->
name|name
operator|=
name|strdup
argument_list|(
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|nv
operator|->
name|name
operator|==
name|NULL
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"%s: can't allocated %zd bytes for string"
argument_list|,
name|__func__
argument_list|,
name|strlen
argument_list|(
name|name
argument_list|)
argument_list|)
expr_stmt|;
name|nv
operator|->
name|value
operator|=
name|str
expr_stmt|;
name|str
operator|=
name|NULL
expr_stmt|;
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|cur_lun
operator|->
name|attr_list
argument_list|,
name|nv
argument_list|,
name|links
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|str
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|cctl_char_handler
parameter_list|(
name|void
modifier|*
name|user_data
parameter_list|,
specifier|const
name|XML_Char
modifier|*
name|str
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|struct
name|cctl_devlist_data
modifier|*
name|devlist
decl_stmt|;
name|devlist
operator|=
operator|(
expr|struct
name|cctl_devlist_data
operator|*
operator|)
name|user_data
expr_stmt|;
name|sbuf_bcat
argument_list|(
name|devlist
operator|->
name|cur_sb
index|[
name|devlist
operator|->
name|level
index|]
argument_list|,
name|str
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|cctl_devlist
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|,
name|char
modifier|*
name|combinedopt
parameter_list|)
block|{
name|struct
name|ctl_lun_list
name|list
decl_stmt|;
name|struct
name|cctl_devlist_data
name|devlist
decl_stmt|;
name|struct
name|cctl_lun
modifier|*
name|lun
decl_stmt|;
name|XML_Parser
name|parser
decl_stmt|;
name|char
modifier|*
name|lun_str
decl_stmt|;
name|int
name|lun_len
decl_stmt|;
name|int
name|dump_xml
init|=
literal|0
decl_stmt|;
name|int
name|retval
decl_stmt|,
name|c
decl_stmt|;
name|char
modifier|*
name|backend
init|=
name|NULL
decl_stmt|;
name|int
name|verbose
init|=
literal|0
decl_stmt|;
name|retval
operator|=
literal|0
expr_stmt|;
name|lun_len
operator|=
literal|4096
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|devlist
argument_list|,
sizeof|sizeof
argument_list|(
name|devlist
argument_list|)
argument_list|)
expr_stmt|;
name|STAILQ_INIT
argument_list|(
operator|&
name|devlist
operator|.
name|lun_list
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|combinedopt
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'b'
case|:
name|backend
operator|=
name|strdup
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'v'
case|:
name|verbose
operator|++
expr_stmt|;
break|break;
case|case
literal|'x'
case|:
name|dump_xml
operator|=
literal|1
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
name|retry
label|:
name|lun_str
operator|=
name|malloc
argument_list|(
name|lun_len
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|list
argument_list|,
sizeof|sizeof
argument_list|(
name|list
argument_list|)
argument_list|)
expr_stmt|;
name|list
operator|.
name|alloc_len
operator|=
name|lun_len
expr_stmt|;
name|list
operator|.
name|status
operator|=
name|CTL_LUN_LIST_NONE
expr_stmt|;
name|list
operator|.
name|lun_xml
operator|=
name|lun_str
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|CTL_LUN_LIST
argument_list|,
operator|&
name|list
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|warn
argument_list|(
literal|"%s: error issuing CTL_LUN_LIST ioctl"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
if|if
condition|(
name|list
operator|.
name|status
operator|==
name|CTL_LUN_LIST_ERROR
condition|)
block|{
name|warnx
argument_list|(
literal|"%s: error returned from CTL_LUN_LIST ioctl:\n%s"
argument_list|,
name|__func__
argument_list|,
name|list
operator|.
name|error_str
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|list
operator|.
name|status
operator|==
name|CTL_LUN_LIST_NEED_MORE_SPACE
condition|)
block|{
name|lun_len
operator|=
name|lun_len
operator|<<
literal|1
expr_stmt|;
goto|goto
name|retry
goto|;
block|}
if|if
condition|(
name|dump_xml
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|lun_str
argument_list|)
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
name|parser
operator|=
name|XML_ParserCreate
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|parser
operator|==
name|NULL
condition|)
block|{
name|warn
argument_list|(
literal|"%s: Unable to create XML parser"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
name|XML_SetUserData
argument_list|(
name|parser
argument_list|,
operator|&
name|devlist
argument_list|)
expr_stmt|;
name|XML_SetElementHandler
argument_list|(
name|parser
argument_list|,
name|cctl_start_element
argument_list|,
name|cctl_end_element
argument_list|)
expr_stmt|;
name|XML_SetCharacterDataHandler
argument_list|(
name|parser
argument_list|,
name|cctl_char_handler
argument_list|)
expr_stmt|;
name|retval
operator|=
name|XML_Parse
argument_list|(
name|parser
argument_list|,
name|lun_str
argument_list|,
name|strlen
argument_list|(
name|lun_str
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
operator|!=
literal|1
condition|)
block|{
name|warnx
argument_list|(
literal|"%s: Unable to parse XML: Error %d"
argument_list|,
name|__func__
argument_list|,
name|XML_GetErrorCode
argument_list|(
name|parser
argument_list|)
argument_list|)
expr_stmt|;
name|XML_ParserFree
argument_list|(
name|parser
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
name|retval
operator|=
literal|0
expr_stmt|;
name|XML_ParserFree
argument_list|(
name|parser
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"LUN Backend  %18s %4s %-16s %-16s\n"
argument_list|,
literal|"Size (Blocks)"
argument_list|,
literal|"BS"
argument_list|,
literal|"Serial Number"
argument_list|,
literal|"Device ID"
argument_list|)
expr_stmt|;
name|STAILQ_FOREACH
argument_list|(
argument|lun
argument_list|,
argument|&devlist.lun_list
argument_list|,
argument|links
argument_list|)
block|{
name|struct
name|cctl_lun_nv
modifier|*
name|nv
decl_stmt|;
if|if
condition|(
operator|(
name|backend
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|strcmp
argument_list|(
name|lun
operator|->
name|backend_type
argument_list|,
name|backend
argument_list|)
operator|!=
literal|0
operator|)
condition|)
continue|continue;
name|printf
argument_list|(
literal|"%3ju %-8s %18ju %4u %-16s %-16s\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|lun
operator|->
name|lun_id
argument_list|,
name|lun
operator|->
name|backend_type
argument_list|,
operator|(
name|uintmax_t
operator|)
name|lun
operator|->
name|size_blocks
argument_list|,
name|lun
operator|->
name|blocksize
argument_list|,
name|lun
operator|->
name|serial_number
argument_list|,
name|lun
operator|->
name|device_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
operator|==
literal|0
condition|)
continue|continue;
name|STAILQ_FOREACH
argument_list|(
argument|nv
argument_list|,
argument|&lun->attr_list
argument_list|,
argument|links
argument_list|)
block|{
name|printf
argument_list|(
literal|"      %s=%s\n"
argument_list|,
name|nv
operator|->
name|name
argument_list|,
name|nv
operator|->
name|value
argument_list|)
expr_stmt|;
block|}
block|}
name|bailout
label|:
name|free
argument_list|(
name|lun_str
argument_list|)
expr_stmt|;
return|return
operator|(
name|retval
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Port information.  */
end_comment

begin_struct
struct|struct
name|cctl_port
block|{
name|uint64_t
name|port_id
decl_stmt|;
name|char
modifier|*
name|online
decl_stmt|;
name|char
modifier|*
name|frontend_type
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
name|int
name|pp
decl_stmt|,
name|vp
decl_stmt|;
name|char
modifier|*
name|target
decl_stmt|,
modifier|*
name|port
decl_stmt|,
modifier|*
name|lun_map
decl_stmt|;
name|STAILQ_HEAD
argument_list|(
argument_list|,
argument|cctl_lun_nv
argument_list|)
name|init_list
expr_stmt|;
name|STAILQ_HEAD
argument_list|(
argument_list|,
argument|cctl_lun_nv
argument_list|)
name|lun_list
expr_stmt|;
name|STAILQ_HEAD
argument_list|(
argument_list|,
argument|cctl_lun_nv
argument_list|)
name|attr_list
expr_stmt|;
name|STAILQ_ENTRY
argument_list|(
argument|cctl_port
argument_list|)
name|links
expr_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|cctl_portlist_data
block|{
name|int
name|num_ports
decl_stmt|;
name|STAILQ_HEAD
argument_list|(
argument_list|,
argument|cctl_port
argument_list|)
name|port_list
expr_stmt|;
name|struct
name|cctl_port
modifier|*
name|cur_port
decl_stmt|;
name|int
name|level
decl_stmt|;
name|uint64_t
name|cur_id
decl_stmt|;
name|struct
name|sbuf
modifier|*
name|cur_sb
index|[
literal|32
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
name|cctl_start_pelement
parameter_list|(
name|void
modifier|*
name|user_data
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|attr
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|struct
name|cctl_portlist_data
modifier|*
name|portlist
decl_stmt|;
name|struct
name|cctl_port
modifier|*
name|cur_port
decl_stmt|;
name|portlist
operator|=
operator|(
expr|struct
name|cctl_portlist_data
operator|*
operator|)
name|user_data
expr_stmt|;
name|cur_port
operator|=
name|portlist
operator|->
name|cur_port
expr_stmt|;
name|portlist
operator|->
name|level
operator|++
expr_stmt|;
if|if
condition|(
operator|(
name|u_int
operator|)
name|portlist
operator|->
name|level
operator|>=
operator|(
sizeof|sizeof
argument_list|(
name|portlist
operator|->
name|cur_sb
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|portlist
operator|->
name|cur_sb
index|[
literal|0
index|]
argument_list|)
operator|)
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s: too many nesting levels, %zd max"
argument_list|,
name|__func__
argument_list|,
sizeof|sizeof
argument_list|(
name|portlist
operator|->
name|cur_sb
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|portlist
operator|->
name|cur_sb
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|portlist
operator|->
name|cur_sb
index|[
name|portlist
operator|->
name|level
index|]
operator|=
name|sbuf_new_auto
argument_list|()
expr_stmt|;
if|if
condition|(
name|portlist
operator|->
name|cur_sb
index|[
name|portlist
operator|->
name|level
index|]
operator|==
name|NULL
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"%s: Unable to allocate sbuf"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|portlist
operator|->
name|cur_id
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|attr
index|[
name|i
index|]
operator|!=
name|NULL
condition|;
name|i
operator|+=
literal|2
control|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|attr
index|[
name|i
index|]
argument_list|,
literal|"id"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|portlist
operator|->
name|cur_id
operator|=
name|strtoull
argument_list|(
name|attr
index|[
name|i
operator|+
literal|1
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"targ_port"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|cur_port
operator|!=
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s: improper port element nesting"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|cur_port
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|cur_port
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cur_port
operator|==
name|NULL
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"%s: cannot allocate %zd bytes"
argument_list|,
name|__func__
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|cur_port
argument_list|)
argument_list|)
expr_stmt|;
name|portlist
operator|->
name|num_ports
operator|++
expr_stmt|;
name|portlist
operator|->
name|cur_port
operator|=
name|cur_port
expr_stmt|;
name|STAILQ_INIT
argument_list|(
operator|&
name|cur_port
operator|->
name|init_list
argument_list|)
expr_stmt|;
name|STAILQ_INIT
argument_list|(
operator|&
name|cur_port
operator|->
name|lun_list
argument_list|)
expr_stmt|;
name|STAILQ_INIT
argument_list|(
operator|&
name|cur_port
operator|->
name|attr_list
argument_list|)
expr_stmt|;
name|cur_port
operator|->
name|port_id
operator|=
name|portlist
operator|->
name|cur_id
expr_stmt|;
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|portlist
operator|->
name|port_list
argument_list|,
name|cur_port
argument_list|,
name|links
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|cctl_end_pelement
parameter_list|(
name|void
modifier|*
name|user_data
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
name|struct
name|cctl_portlist_data
modifier|*
name|portlist
decl_stmt|;
name|struct
name|cctl_port
modifier|*
name|cur_port
decl_stmt|;
name|char
modifier|*
name|str
decl_stmt|;
name|portlist
operator|=
operator|(
expr|struct
name|cctl_portlist_data
operator|*
operator|)
name|user_data
expr_stmt|;
name|cur_port
operator|=
name|portlist
operator|->
name|cur_port
expr_stmt|;
if|if
condition|(
operator|(
name|cur_port
operator|==
name|NULL
operator|)
operator|&&
operator|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"ctlportlist"
argument_list|)
operator|!=
literal|0
operator|)
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s: cur_port == NULL! (name = %s)"
argument_list|,
name|__func__
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|portlist
operator|->
name|cur_sb
index|[
name|portlist
operator|->
name|level
index|]
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s: no valid sbuf at level %d (name %s)"
argument_list|,
name|__func__
argument_list|,
name|portlist
operator|->
name|level
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|sbuf_finish
argument_list|(
name|portlist
operator|->
name|cur_sb
index|[
name|portlist
operator|->
name|level
index|]
argument_list|)
operator|!=
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"%s: sbuf_finish"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|str
operator|=
name|strdup
argument_list|(
name|sbuf_data
argument_list|(
name|portlist
operator|->
name|cur_sb
index|[
name|portlist
operator|->
name|level
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|str
operator|==
name|NULL
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"%s can't allocate %zd bytes for string"
argument_list|,
name|__func__
argument_list|,
name|sbuf_len
argument_list|(
name|portlist
operator|->
name|cur_sb
index|[
name|portlist
operator|->
name|level
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|str
argument_list|)
operator|==
literal|0
condition|)
block|{
name|free
argument_list|(
name|str
argument_list|)
expr_stmt|;
name|str
operator|=
name|NULL
expr_stmt|;
block|}
name|sbuf_delete
argument_list|(
name|portlist
operator|->
name|cur_sb
index|[
name|portlist
operator|->
name|level
index|]
argument_list|)
expr_stmt|;
name|portlist
operator|->
name|cur_sb
index|[
name|portlist
operator|->
name|level
index|]
operator|=
name|NULL
expr_stmt|;
name|portlist
operator|->
name|level
operator|--
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"frontend_type"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|cur_port
operator|->
name|frontend_type
operator|=
name|str
expr_stmt|;
name|str
operator|=
name|NULL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"port_name"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|cur_port
operator|->
name|name
operator|=
name|str
expr_stmt|;
name|str
operator|=
name|NULL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"online"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|cur_port
operator|->
name|online
operator|=
name|str
expr_stmt|;
name|str
operator|=
name|NULL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"physical_port"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|cur_port
operator|->
name|pp
operator|=
name|strtoull
argument_list|(
name|str
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"virtual_port"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|cur_port
operator|->
name|vp
operator|=
name|strtoull
argument_list|(
name|str
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"target"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|cur_port
operator|->
name|target
operator|=
name|str
expr_stmt|;
name|str
operator|=
name|NULL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"port"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|cur_port
operator|->
name|port
operator|=
name|str
expr_stmt|;
name|str
operator|=
name|NULL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"lun_map"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|cur_port
operator|->
name|lun_map
operator|=
name|str
expr_stmt|;
name|str
operator|=
name|NULL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"targ_port"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|portlist
operator|->
name|cur_port
operator|=
name|NULL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"ctlportlist"
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* Nothing. */
block|}
else|else
block|{
name|struct
name|cctl_lun_nv
modifier|*
name|nv
decl_stmt|;
name|nv
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|nv
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|nv
operator|==
name|NULL
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"%s: can't allocate %zd bytes for nv pair"
argument_list|,
name|__func__
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|nv
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"initiator"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"lun"
argument_list|)
operator|==
literal|0
condition|)
name|asprintf
argument_list|(
operator|&
name|nv
operator|->
name|name
argument_list|,
literal|"%ju"
argument_list|,
name|portlist
operator|->
name|cur_id
argument_list|)
expr_stmt|;
else|else
name|nv
operator|->
name|name
operator|=
name|strdup
argument_list|(
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|nv
operator|->
name|name
operator|==
name|NULL
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"%s: can't allocated %zd bytes for string"
argument_list|,
name|__func__
argument_list|,
name|strlen
argument_list|(
name|name
argument_list|)
argument_list|)
expr_stmt|;
name|nv
operator|->
name|value
operator|=
name|str
expr_stmt|;
name|str
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"initiator"
argument_list|)
operator|==
literal|0
condition|)
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|cur_port
operator|->
name|init_list
argument_list|,
name|nv
argument_list|,
name|links
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"lun"
argument_list|)
operator|==
literal|0
condition|)
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|cur_port
operator|->
name|lun_list
argument_list|,
name|nv
argument_list|,
name|links
argument_list|)
expr_stmt|;
else|else
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|cur_port
operator|->
name|attr_list
argument_list|,
name|nv
argument_list|,
name|links
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|str
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|cctl_char_phandler
parameter_list|(
name|void
modifier|*
name|user_data
parameter_list|,
specifier|const
name|XML_Char
modifier|*
name|str
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|struct
name|cctl_portlist_data
modifier|*
name|portlist
decl_stmt|;
name|portlist
operator|=
operator|(
expr|struct
name|cctl_portlist_data
operator|*
operator|)
name|user_data
expr_stmt|;
name|sbuf_bcat
argument_list|(
name|portlist
operator|->
name|cur_sb
index|[
name|portlist
operator|->
name|level
index|]
argument_list|,
name|str
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|cctl_portlist
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|,
name|char
modifier|*
name|combinedopt
parameter_list|)
block|{
name|struct
name|ctl_lun_list
name|list
decl_stmt|;
name|struct
name|cctl_portlist_data
name|portlist
decl_stmt|;
name|struct
name|cctl_port
modifier|*
name|port
decl_stmt|;
name|XML_Parser
name|parser
decl_stmt|;
name|char
modifier|*
name|port_str
decl_stmt|;
name|int
name|port_len
decl_stmt|;
name|int
name|dump_xml
init|=
literal|0
decl_stmt|;
name|int
name|retval
decl_stmt|,
name|c
decl_stmt|;
name|char
modifier|*
name|frontend
init|=
name|NULL
decl_stmt|;
name|uint64_t
name|portarg
init|=
name|UINT64_MAX
decl_stmt|;
name|int
name|verbose
init|=
literal|0
decl_stmt|,
name|init
init|=
literal|0
decl_stmt|,
name|lun
init|=
literal|0
decl_stmt|,
name|quiet
init|=
literal|0
decl_stmt|;
name|retval
operator|=
literal|0
expr_stmt|;
name|port_len
operator|=
literal|4096
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|portlist
argument_list|,
sizeof|sizeof
argument_list|(
name|portlist
argument_list|)
argument_list|)
expr_stmt|;
name|STAILQ_INIT
argument_list|(
operator|&
name|portlist
operator|.
name|port_list
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|combinedopt
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'f'
case|:
name|frontend
operator|=
name|strdup
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'i'
case|:
name|init
operator|++
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
name|lun
operator|++
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
name|portarg
operator|=
name|strtoll
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'q'
case|:
name|quiet
operator|++
expr_stmt|;
break|break;
case|case
literal|'v'
case|:
name|verbose
operator|++
expr_stmt|;
break|break;
case|case
literal|'x'
case|:
name|dump_xml
operator|=
literal|1
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
name|retry
label|:
name|port_str
operator|=
name|malloc
argument_list|(
name|port_len
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|list
argument_list|,
sizeof|sizeof
argument_list|(
name|list
argument_list|)
argument_list|)
expr_stmt|;
name|list
operator|.
name|alloc_len
operator|=
name|port_len
expr_stmt|;
name|list
operator|.
name|status
operator|=
name|CTL_LUN_LIST_NONE
expr_stmt|;
name|list
operator|.
name|lun_xml
operator|=
name|port_str
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|CTL_PORT_LIST
argument_list|,
operator|&
name|list
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|warn
argument_list|(
literal|"%s: error issuing CTL_PORT_LIST ioctl"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
if|if
condition|(
name|list
operator|.
name|status
operator|==
name|CTL_LUN_LIST_ERROR
condition|)
block|{
name|warnx
argument_list|(
literal|"%s: error returned from CTL_PORT_LIST ioctl:\n%s"
argument_list|,
name|__func__
argument_list|,
name|list
operator|.
name|error_str
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|list
operator|.
name|status
operator|==
name|CTL_LUN_LIST_NEED_MORE_SPACE
condition|)
block|{
name|port_len
operator|=
name|port_len
operator|<<
literal|1
expr_stmt|;
goto|goto
name|retry
goto|;
block|}
if|if
condition|(
name|dump_xml
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|port_str
argument_list|)
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
name|parser
operator|=
name|XML_ParserCreate
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|parser
operator|==
name|NULL
condition|)
block|{
name|warn
argument_list|(
literal|"%s: Unable to create XML parser"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
name|XML_SetUserData
argument_list|(
name|parser
argument_list|,
operator|&
name|portlist
argument_list|)
expr_stmt|;
name|XML_SetElementHandler
argument_list|(
name|parser
argument_list|,
name|cctl_start_pelement
argument_list|,
name|cctl_end_pelement
argument_list|)
expr_stmt|;
name|XML_SetCharacterDataHandler
argument_list|(
name|parser
argument_list|,
name|cctl_char_phandler
argument_list|)
expr_stmt|;
name|retval
operator|=
name|XML_Parse
argument_list|(
name|parser
argument_list|,
name|port_str
argument_list|,
name|strlen
argument_list|(
name|port_str
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
operator|!=
literal|1
condition|)
block|{
name|warnx
argument_list|(
literal|"%s: Unable to parse XML: Error %d"
argument_list|,
name|__func__
argument_list|,
name|XML_GetErrorCode
argument_list|(
name|parser
argument_list|)
argument_list|)
expr_stmt|;
name|XML_ParserFree
argument_list|(
name|parser
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
name|retval
operator|=
literal|0
expr_stmt|;
name|XML_ParserFree
argument_list|(
name|parser
argument_list|)
expr_stmt|;
if|if
condition|(
name|quiet
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"Port Online Frontend Name     pp vp\n"
argument_list|)
expr_stmt|;
name|STAILQ_FOREACH
argument_list|(
argument|port
argument_list|,
argument|&portlist.port_list
argument_list|,
argument|links
argument_list|)
block|{
name|struct
name|cctl_lun_nv
modifier|*
name|nv
decl_stmt|;
if|if
condition|(
operator|(
name|frontend
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|strcmp
argument_list|(
name|port
operator|->
name|frontend_type
argument_list|,
name|frontend
argument_list|)
operator|!=
literal|0
operator|)
condition|)
continue|continue;
if|if
condition|(
operator|(
name|portarg
operator|!=
name|UINT64_MAX
operator|)
operator|&&
operator|(
name|portarg
operator|!=
name|port
operator|->
name|port_id
operator|)
condition|)
continue|continue;
name|printf
argument_list|(
literal|"%-4ju %-6s %-8s %-8s %-2d %-2d %s\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|port
operator|->
name|port_id
argument_list|,
name|port
operator|->
name|online
argument_list|,
name|port
operator|->
name|frontend_type
argument_list|,
name|port
operator|->
name|name
argument_list|,
name|port
operator|->
name|pp
argument_list|,
name|port
operator|->
name|vp
argument_list|,
name|port
operator|->
name|port
condition|?
name|port
operator|->
name|port
else|:
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|init
operator|||
name|verbose
condition|)
block|{
if|if
condition|(
name|port
operator|->
name|target
condition|)
name|printf
argument_list|(
literal|"  Target: %s\n"
argument_list|,
name|port
operator|->
name|target
argument_list|)
expr_stmt|;
name|STAILQ_FOREACH
argument_list|(
argument|nv
argument_list|,
argument|&port->init_list
argument_list|,
argument|links
argument_list|)
block|{
name|printf
argument_list|(
literal|"  Initiator %s: %s\n"
argument_list|,
name|nv
operator|->
name|name
argument_list|,
name|nv
operator|->
name|value
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|lun
operator|||
name|verbose
condition|)
block|{
if|if
condition|(
name|port
operator|->
name|lun_map
condition|)
block|{
name|STAILQ_FOREACH
argument_list|(
argument|nv
argument_list|,
argument|&port->lun_list
argument_list|,
argument|links
argument_list|)
name|printf
argument_list|(
literal|"  LUN %s: %s\n"
argument_list|,
name|nv
operator|->
name|name
argument_list|,
name|nv
operator|->
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
name|STAILQ_EMPTY
argument_list|(
operator|&
name|port
operator|->
name|lun_list
argument_list|)
condition|)
name|printf
argument_list|(
literal|"  No LUNs mapped\n"
argument_list|)
expr_stmt|;
block|}
else|else
name|printf
argument_list|(
literal|"  All LUNs mapped\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|verbose
condition|)
block|{
name|STAILQ_FOREACH
argument_list|(
argument|nv
argument_list|,
argument|&port->attr_list
argument_list|,
argument|links
argument_list|)
block|{
name|printf
argument_list|(
literal|"      %s=%s\n"
argument_list|,
name|nv
operator|->
name|name
argument_list|,
name|nv
operator|->
name|value
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|bailout
label|:
name|free
argument_list|(
name|port_str
argument_list|)
expr_stmt|;
return|return
operator|(
name|retval
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cctl_lunmap
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|,
name|char
modifier|*
name|combinedopt
parameter_list|)
block|{
name|struct
name|ctl_lun_map
name|lm
decl_stmt|;
name|int
name|retval
init|=
literal|0
decl_stmt|,
name|c
decl_stmt|;
name|retval
operator|=
literal|0
expr_stmt|;
name|lm
operator|.
name|port
operator|=
name|UINT32_MAX
expr_stmt|;
name|lm
operator|.
name|plun
operator|=
name|UINT32_MAX
expr_stmt|;
name|lm
operator|.
name|lun
operator|=
name|UINT32_MAX
expr_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|combinedopt
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'p'
case|:
name|lm
operator|.
name|port
operator|=
name|strtoll
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
name|lm
operator|.
name|plun
operator|=
name|strtoll
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'L'
case|:
name|lm
operator|.
name|lun
operator|=
name|strtoll
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|CTL_LUN_MAP
argument_list|,
operator|&
name|lm
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|warn
argument_list|(
literal|"%s: error issuing CTL_LUN_MAP ioctl"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
block|}
return|return
operator|(
name|retval
operator|)
return|;
block|}
end_function

begin_function
name|void
name|usage
parameter_list|(
name|int
name|error
parameter_list|)
block|{
name|fprintf
argument_list|(
name|error
condition|?
name|stderr
else|:
name|stdout
argument_list|,
literal|"Usage:\n"
literal|"Primary commands:\n"
literal|"         ctladm tur         [dev_id][general options]\n"
literal|"         ctladm inquiry     [dev_id][general options]\n"
literal|"         ctladm devid       [dev_id][general options]\n"
literal|"         ctladm reqsense    [dev_id][general options]\n"
literal|"         ctladm reportluns  [dev_id][general options]\n"
literal|"         ctladm read        [dev_id][general options]<-l lba><-d len>\n"
literal|"<-f file|-><-b blocksize> [-c cdbsize][-N]\n"
literal|"         ctladm write       [dev_id][general options]<-l lba><-d len>\n"
literal|"<-f file|-><-b blocksize> [-c cdbsize][-N]\n"
literal|"         ctladm readcap     [dev_id][general options] [-c cdbsize]\n"
literal|"         ctladm modesense   [dev_id][general options]<-m page|-l> [-P pc]\n"
literal|"                            [-d] [-S subpage] [-c cdbsize]\n"
literal|"         ctladm prin        [dev_id][general options]<-a action>\n"
literal|"         ctladm prout       [dev_id][general options]<-a action>\n"
literal|"<-r restype] [-k key] [-s sa_key]\n"
literal|"         ctladm rtpg        [dev_id][general options]\n"
literal|"         ctladm start       [dev_id][general options] [-i] [-o]\n"
literal|"         ctladm stop        [dev_id][general options] [-i] [-o]\n"
literal|"         ctladm synccache   [dev_id][general options] [-l lba]\n"
literal|"                            [-b blockcount] [-r] [-i] [-c cdbsize]\n"
literal|"         ctladm create<-b backend> [-B blocksize] [-d device_id]\n"
literal|"                            [-l lun_id] [-o name=value] [-s size_bytes]\n"
literal|"                            [-S serial_num] [-t dev_type]\n"
literal|"         ctladm remove<-b backend><-l lun_id> [-o name=value]\n"
literal|"         ctladm modify<-b backend><-l lun_id><-s size_bytes>\n"
literal|"         ctladm devlist     [-b backend] [-v] [-x]\n"
literal|"         ctladm lunlist\n"
literal|"         ctladm lunmap      -p targ_port [-l pLUN] [-L cLUN]\n"
literal|"         ctladm delay       [dev_id]<-l datamove|done> [-T oneshot|cont]\n"
literal|"                            [-t secs]\n"
literal|"         ctladm inject      [dev_id]<-i action><-p pattern> [-r lba,len]\n"
literal|"                            [-s len fmt [args]] [-c] [-d delete_id]\n"
literal|"         ctladm port<-o<on|off> | [-w wwnn][-W wwpn]>\n"
literal|"                            [-p targ_port] [-t port_type]\n"
literal|"         ctladm portlist    [-f frontend] [-i] [-p targ_port] [-q] [-v] [-x]\n"
literal|"         ctladm islist      [-v | -x]\n"
literal|"         ctladm islogout<-a | -c connection-id | -i name | -p portal>\n"
literal|"         ctladm isterminate<-a | -c connection-id | -i name | -p portal>\n"
literal|"         ctladm dumpooa\n"
literal|"         ctladm dumpstructs\n"
literal|"         ctladm help\n"
literal|"General Options:\n"
literal|"-I intiator_id           : defaults to 7, used to change the initiator id\n"
literal|"-C retries               : specify the number of times to retry this command\n"
literal|"-D devicename            : specify the device to operate on\n"
literal|"                         : (default is %s)\n"
literal|"read/write options:\n"
literal|"-l lba                   : logical block address\n"
literal|"-d len                   : read/write length, in blocks\n"
literal|"-f file|-                : write/read data to/from file or stdout/stdin\n"
literal|"-b blocksize             : block size, in bytes\n"
literal|"-c cdbsize               : specify minimum cdb size: 6, 10, 12 or 16\n"
literal|"-N                       : do not copy data to/from userland\n"
literal|"readcapacity options:\n"
literal|"-c cdbsize               : specify minimum cdb size: 10 or 16\n"
literal|"modesense options:\n"
literal|"-m page                  : specify the mode page to view\n"
literal|"-l                       : request a list of supported pages\n"
literal|"-P pc                    : specify the page control value: 0-3 (current,\n"
literal|"                           changeable, default, saved, respectively)\n"
literal|"-d                       : disable block descriptors for mode sense\n"
literal|"-S subpage               : specify a subpage\n"
literal|"-c cdbsize               : specify minimum cdb size: 6 or 10\n"
literal|"persistent reserve in options:\n"
literal|"-a action                : specify the action value: 0-2 (read key, read\n"
literal|"                           reservation, read capabilities, respectively)\n"
literal|"persistent reserve out options:\n"
literal|"-a action                : specify the action value: 0-5 (register, reserve,\n"
literal|"                           release, clear, preempt, register and ignore)\n"
literal|"-k key                   : key value\n"
literal|"-s sa_key                : service action value\n"
literal|"-r restype               : specify the reservation type: 0-5(wr ex, ex ac,\n"
literal|"                           wr ex ro, ex ac ro, wr ex ar, ex ac ar)\n"
literal|"start/stop options:\n"
literal|"-i                       : set the immediate bit (CTL does not support this)\n"
literal|"-o                       : set the on/offline bit\n"
literal|"synccache options:\n"
literal|"-l lba                   : set the starting LBA\n"
literal|"-b blockcount            : set the length to sync in blocks\n"
literal|"-r                       : set the relative addressing bit\n"
literal|"-i                       : set the immediate bit\n"
literal|"-c cdbsize               : specify minimum cdb size: 10 or 16\n"
literal|"create options:\n"
literal|"-b backend               : backend name (\"block\", \"ramdisk\", etc.)\n"
literal|"-B blocksize             : LUN blocksize in bytes (some backends)\n"
literal|"-d device_id             : SCSI VPD page 0x83 ID\n"
literal|"-l lun_id                : requested LUN number\n"
literal|"-o name=value            : backend-specific options, multiple allowed\n"
literal|"-s size_bytes            : LUN size in bytes (some backends)\n"
literal|"-S serial_num            : SCSI VPD page 0x80 serial number\n"
literal|"-t dev_type              : SCSI device type (0=disk, 3=processor)\n"
literal|"remove options:\n"
literal|"-b backend               : backend name (\"block\", \"ramdisk\", etc.)\n"
literal|"-l lun_id                : LUN number to delete\n"
literal|"-o name=value            : backend-specific options, multiple allowed\n"
literal|"devlist options:\n"
literal|"-b backend               : list devices from specified backend only\n"
literal|"-v                       : be verbose, show backend attributes\n"
literal|"-x                       : dump raw XML\n"
literal|"delay options:\n"
literal|"-l datamove|done         : delay command at datamove or done phase\n"
literal|"-T oneshot               : delay one command, then resume normal completion\n"
literal|"-T cont                  : delay all commands\n"
literal|"-t secs                  : number of seconds to delay\n"
literal|"inject options:\n"
literal|"-i error_action          : action to perform\n"
literal|"-p pattern               : command pattern to look for\n"
literal|"-r lba,len               : LBA range for pattern\n"
literal|"-s len fmt [args]        : sense data for custom sense action\n"
literal|"-c                       : continuous operation\n"
literal|"-d delete_id             : error id to delete\n"
literal|"port options:\n"
literal|"-l                       : list frontend ports\n"
literal|"-o on|off                : turn frontend ports on or off\n"
literal|"-w wwnn                  : set WWNN for one frontend\n"
literal|"-W wwpn                  : set WWPN for one frontend\n"
literal|"-t port_type             : specify fc, scsi, ioctl, internal frontend type\n"
literal|"-p targ_port             : specify target port number\n"
literal|"-q                       : omit header in list output\n"
literal|"-x                       : output port list in XML format\n"
literal|"portlist options:\n"
literal|"-f frontend              : specify frontend type\n"
literal|"-i                       : report target and initiators addresses\n"
literal|"-l                       : report LUN mapping\n"
literal|"-p targ_port             : specify target port number\n"
literal|"-q                       : omit header in list output\n"
literal|"-v                       : verbose output (report all port options)\n"
literal|"-x                       : output port list in XML format\n"
literal|"lunmap options:\n"
literal|"-p targ_port             : specify target port number\n"
literal|"-L pLUN                  : specify port-visible LUN\n"
literal|"-L cLUN                  : specify CTL LUN\n"
argument_list|,
name|CTL_DEFAULT_DEV
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|int
name|c
decl_stmt|;
name|ctladm_cmdfunction
name|command
decl_stmt|;
name|ctladm_cmdargs
name|cmdargs
decl_stmt|;
name|ctladm_optret
name|optreturn
decl_stmt|;
name|char
modifier|*
name|device
decl_stmt|;
specifier|const
name|char
modifier|*
name|mainopt
init|=
literal|"C:D:I:"
decl_stmt|;
specifier|const
name|char
modifier|*
name|subopt
init|=
name|NULL
decl_stmt|;
name|char
name|combinedopt
index|[
literal|256
index|]
decl_stmt|;
name|int
name|lun
decl_stmt|;
name|int
name|optstart
init|=
literal|2
decl_stmt|;
name|int
name|retval
decl_stmt|,
name|fd
decl_stmt|;
name|int
name|retries
decl_stmt|;
name|int
name|initid
decl_stmt|;
name|int
name|saved_errno
decl_stmt|;
name|retval
operator|=
literal|0
expr_stmt|;
name|cmdargs
operator|=
name|CTLADM_ARG_NONE
expr_stmt|;
name|command
operator|=
name|CTLADM_CMD_HELP
expr_stmt|;
name|device
operator|=
name|NULL
expr_stmt|;
name|fd
operator|=
operator|-
literal|1
expr_stmt|;
name|retries
operator|=
literal|0
expr_stmt|;
name|lun
operator|=
literal|0
expr_stmt|;
name|initid
operator|=
literal|7
expr_stmt|;
if|if
condition|(
name|argc
operator|<
literal|2
condition|)
block|{
name|usage
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
comment|/* 	 * Get the base option. 	 */
name|optreturn
operator|=
name|getoption
argument_list|(
name|option_table
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|,
operator|&
name|command
argument_list|,
operator|&
name|cmdargs
argument_list|,
operator|&
name|subopt
argument_list|)
expr_stmt|;
if|if
condition|(
name|optreturn
operator|==
name|CC_OR_AMBIGUOUS
condition|)
block|{
name|warnx
argument_list|(
literal|"ambiguous option %s"
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|usage
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|optreturn
operator|==
name|CC_OR_NOT_FOUND
condition|)
block|{
name|warnx
argument_list|(
literal|"option %s not found"
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|usage
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|cmdargs
operator|&
name|CTLADM_ARG_NEED_TL
condition|)
block|{
if|if
condition|(
operator|(
name|argc
operator|<
literal|3
operator|)
operator|||
operator|(
operator|!
name|isdigit
argument_list|(
name|argv
index|[
literal|2
index|]
index|[
literal|0
index|]
argument_list|)
operator|)
condition|)
block|{
name|warnx
argument_list|(
literal|"option %s requires a lun argument"
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|usage
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|lun
operator|=
name|strtol
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|cmdargs
operator||=
name|CTLADM_ARG_TARG_LUN
expr_stmt|;
name|optstart
operator|++
expr_stmt|;
block|}
comment|/* 	 * Ahh, getopt(3) is a pain. 	 * 	 * This is a gross hack.  There really aren't many other good 	 * options (excuse the pun) for parsing options in a situation like 	 * this.  getopt is kinda braindead, so you end up having to run 	 * through the options twice, and give each invocation of getopt 	 * the option string for the other invocation. 	 * 	 * You would think that you could just have two groups of options. 	 * The first group would get parsed by the first invocation of 	 * getopt, and the second group would get parsed by the second 	 * invocation of getopt.  It doesn't quite work out that way.  When 	 * the first invocation of getopt finishes, it leaves optind pointing 	 * to the argument _after_ the first argument in the second group. 	 * So when the second invocation of getopt comes around, it doesn't 	 * recognize the first argument it gets and then bails out. 	 * 	 * A nice alternative would be to have a flag for getopt that says 	 * "just keep parsing arguments even when you encounter an unknown 	 * argument", but there isn't one.  So there's no real clean way to 	 * easily parse two sets of arguments without having one invocation 	 * of getopt know about the other. 	 * 	 * Without this hack, the first invocation of getopt would work as 	 * long as the generic arguments are first, but the second invocation 	 * (in the subfunction) would fail in one of two ways.  In the case 	 * where you don't set optreset, it would fail because optind may be 	 * pointing to the argument after the one it should be pointing at. 	 * In the case where you do set optreset, and reset optind, it would 	 * fail because getopt would run into the first set of options, which 	 * it doesn't understand. 	 * 	 * All of this would "sort of" work if you could somehow figure out 	 * whether optind had been incremented one option too far.  The 	 * mechanics of that, however, are more daunting than just giving 	 * both invocations all of the expect options for either invocation. 	 * 	 * Needless to say, I wouldn't mind if someone invented a better 	 * (non-GPL!) command line parsing interface than getopt.  I 	 * wouldn't mind if someone added more knobs to getopt to make it 	 * work better.  Who knows, I may talk myself into doing it someday, 	 * if the standards weenies let me.  As it is, it just leads to 	 * hackery like this and causes people to avoid it in some cases. 	 * 	 * KDM, September 8th, 1998 	 */
if|if
condition|(
name|subopt
operator|!=
name|NULL
condition|)
name|sprintf
argument_list|(
name|combinedopt
argument_list|,
literal|"%s%s"
argument_list|,
name|mainopt
argument_list|,
name|subopt
argument_list|)
expr_stmt|;
else|else
name|sprintf
argument_list|(
name|combinedopt
argument_list|,
literal|"%s"
argument_list|,
name|mainopt
argument_list|)
expr_stmt|;
comment|/* 	 * Start getopt processing at argv[2/3], since we've already 	 * accepted argv[1..2] as the command name, and as a possible 	 * device name. 	 */
name|optind
operator|=
name|optstart
expr_stmt|;
comment|/* 	 * Now we run through the argument list looking for generic 	 * options, and ignoring options that possibly belong to 	 * subfunctions. 	 */
while|while
condition|(
operator|(
name|c
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|combinedopt
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'C'
case|:
name|cmdargs
operator||=
name|CTLADM_ARG_RETRIES
expr_stmt|;
name|retries
operator|=
name|strtol
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'D'
case|:
name|device
operator|=
name|strdup
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
name|cmdargs
operator||=
name|CTLADM_ARG_DEVICE
expr_stmt|;
break|break;
case|case
literal|'I'
case|:
name|cmdargs
operator||=
name|CTLADM_ARG_INITIATOR
expr_stmt|;
name|initid
operator|=
name|strtol
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
if|if
condition|(
operator|(
name|cmdargs
operator|&
name|CTLADM_ARG_INITIATOR
operator|)
operator|==
literal|0
condition|)
name|initid
operator|=
literal|7
expr_stmt|;
name|optind
operator|=
name|optstart
expr_stmt|;
name|optreset
operator|=
literal|1
expr_stmt|;
comment|/* 	 * Default to opening the CTL device for now. 	 */
if|if
condition|(
operator|(
operator|(
name|cmdargs
operator|&
name|CTLADM_ARG_DEVICE
operator|)
operator|==
literal|0
operator|)
operator|&&
operator|(
name|command
operator|!=
name|CTLADM_CMD_HELP
operator|)
condition|)
block|{
name|device
operator|=
name|strdup
argument_list|(
name|CTL_DEFAULT_DEV
argument_list|)
expr_stmt|;
name|cmdargs
operator||=
name|CTLADM_ARG_DEVICE
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|cmdargs
operator|&
name|CTLADM_ARG_DEVICE
operator|)
operator|&&
operator|(
name|command
operator|!=
name|CTLADM_CMD_HELP
operator|)
condition|)
block|{
name|fd
operator|=
name|open
argument_list|(
name|device
argument_list|,
name|O_RDWR
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|==
operator|-
literal|1
operator|&&
name|errno
operator|==
name|ENOENT
condition|)
block|{
name|saved_errno
operator|=
name|errno
expr_stmt|;
name|retval
operator|=
name|kldload
argument_list|(
literal|"ctl"
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
operator|!=
operator|-
literal|1
condition|)
name|fd
operator|=
name|open
argument_list|(
name|device
argument_list|,
name|O_RDWR
argument_list|)
expr_stmt|;
else|else
name|errno
operator|=
name|saved_errno
expr_stmt|;
block|}
if|if
condition|(
name|fd
operator|==
operator|-
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: error opening %s: %s\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
name|device
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
goto|goto
name|bailout
goto|;
block|}
ifdef|#
directive|ifdef
name|WANT_ISCSI
else|else
block|{
if|if
condition|(
name|modfind
argument_list|(
literal|"cfiscsi"
argument_list|)
operator|==
operator|-
literal|1
operator|&&
name|kldload
argument_list|(
literal|"cfiscsi"
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|warn
argument_list|(
literal|"couldn't load cfiscsi"
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
block|}
elseif|else
if|if
condition|(
operator|(
name|command
operator|!=
name|CTLADM_CMD_HELP
operator|)
operator|&&
operator|(
operator|(
name|cmdargs
operator|&
name|CTLADM_ARG_DEVICE
operator|)
operator|==
literal|0
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: you must specify a device with the "
literal|"--device argument for this command\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|command
operator|=
name|CTLADM_CMD_HELP
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
block|}
switch|switch
condition|(
name|command
condition|)
block|{
case|case
name|CTLADM_CMD_TUR
case|:
name|retval
operator|=
name|cctl_tur
argument_list|(
name|fd
argument_list|,
name|lun
argument_list|,
name|initid
argument_list|,
name|retries
argument_list|)
expr_stmt|;
break|break;
case|case
name|CTLADM_CMD_INQUIRY
case|:
name|retval
operator|=
name|cctl_inquiry
argument_list|(
name|fd
argument_list|,
name|lun
argument_list|,
name|initid
argument_list|,
name|retries
argument_list|)
expr_stmt|;
break|break;
case|case
name|CTLADM_CMD_REQ_SENSE
case|:
name|retval
operator|=
name|cctl_req_sense
argument_list|(
name|fd
argument_list|,
name|lun
argument_list|,
name|initid
argument_list|,
name|retries
argument_list|)
expr_stmt|;
break|break;
case|case
name|CTLADM_CMD_REPORT_LUNS
case|:
name|retval
operator|=
name|cctl_report_luns
argument_list|(
name|fd
argument_list|,
name|lun
argument_list|,
name|initid
argument_list|,
name|retries
argument_list|)
expr_stmt|;
break|break;
case|case
name|CTLADM_CMD_CREATE
case|:
name|retval
operator|=
name|cctl_create_lun
argument_list|(
name|fd
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|,
name|combinedopt
argument_list|)
expr_stmt|;
break|break;
case|case
name|CTLADM_CMD_RM
case|:
name|retval
operator|=
name|cctl_rm_lun
argument_list|(
name|fd
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|,
name|combinedopt
argument_list|)
expr_stmt|;
break|break;
case|case
name|CTLADM_CMD_DEVLIST
case|:
name|retval
operator|=
name|cctl_devlist
argument_list|(
name|fd
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|,
name|combinedopt
argument_list|)
expr_stmt|;
break|break;
case|case
name|CTLADM_CMD_READ
case|:
case|case
name|CTLADM_CMD_WRITE
case|:
name|retval
operator|=
name|cctl_read_write
argument_list|(
name|fd
argument_list|,
name|lun
argument_list|,
name|initid
argument_list|,
name|retries
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|,
name|combinedopt
argument_list|,
name|command
argument_list|)
expr_stmt|;
break|break;
case|case
name|CTLADM_CMD_PORT
case|:
name|retval
operator|=
name|cctl_port
argument_list|(
name|fd
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|,
name|combinedopt
argument_list|)
expr_stmt|;
break|break;
case|case
name|CTLADM_CMD_PORTLIST
case|:
name|retval
operator|=
name|cctl_portlist
argument_list|(
name|fd
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|,
name|combinedopt
argument_list|)
expr_stmt|;
break|break;
case|case
name|CTLADM_CMD_LUNMAP
case|:
name|retval
operator|=
name|cctl_lunmap
argument_list|(
name|fd
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|,
name|combinedopt
argument_list|)
expr_stmt|;
break|break;
case|case
name|CTLADM_CMD_READCAPACITY
case|:
name|retval
operator|=
name|cctl_read_capacity
argument_list|(
name|fd
argument_list|,
name|lun
argument_list|,
name|initid
argument_list|,
name|retries
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|,
name|combinedopt
argument_list|)
expr_stmt|;
break|break;
case|case
name|CTLADM_CMD_MODESENSE
case|:
name|retval
operator|=
name|cctl_mode_sense
argument_list|(
name|fd
argument_list|,
name|lun
argument_list|,
name|initid
argument_list|,
name|retries
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|,
name|combinedopt
argument_list|)
expr_stmt|;
break|break;
case|case
name|CTLADM_CMD_START
case|:
case|case
name|CTLADM_CMD_STOP
case|:
name|retval
operator|=
name|cctl_start_stop
argument_list|(
name|fd
argument_list|,
name|lun
argument_list|,
name|initid
argument_list|,
name|retries
argument_list|,
operator|(
name|command
operator|==
name|CTLADM_CMD_START
operator|)
condition|?
literal|1
else|:
literal|0
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|,
name|combinedopt
argument_list|)
expr_stmt|;
break|break;
case|case
name|CTLADM_CMD_SYNC_CACHE
case|:
name|retval
operator|=
name|cctl_sync_cache
argument_list|(
name|fd
argument_list|,
name|lun
argument_list|,
name|initid
argument_list|,
name|retries
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|,
name|combinedopt
argument_list|)
expr_stmt|;
break|break;
case|case
name|CTLADM_CMD_LUNLIST
case|:
name|retval
operator|=
name|cctl_lunlist
argument_list|(
name|fd
argument_list|)
expr_stmt|;
break|break;
case|case
name|CTLADM_CMD_DELAY
case|:
name|retval
operator|=
name|cctl_delay
argument_list|(
name|fd
argument_list|,
name|lun
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|,
name|combinedopt
argument_list|)
expr_stmt|;
break|break;
case|case
name|CTLADM_CMD_ERR_INJECT
case|:
name|retval
operator|=
name|cctl_error_inject
argument_list|(
name|fd
argument_list|,
name|lun
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|,
name|combinedopt
argument_list|)
expr_stmt|;
break|break;
case|case
name|CTLADM_CMD_DUMPOOA
case|:
name|retval
operator|=
name|cctl_dump_ooa
argument_list|(
name|fd
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|)
expr_stmt|;
break|break;
case|case
name|CTLADM_CMD_DUMPSTRUCTS
case|:
name|retval
operator|=
name|cctl_dump_structs
argument_list|(
name|fd
argument_list|,
name|cmdargs
argument_list|)
expr_stmt|;
break|break;
case|case
name|CTLADM_CMD_PRES_IN
case|:
name|retval
operator|=
name|cctl_persistent_reserve_in
argument_list|(
name|fd
argument_list|,
name|lun
argument_list|,
name|initid
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|,
name|combinedopt
argument_list|,
name|retries
argument_list|)
expr_stmt|;
break|break;
case|case
name|CTLADM_CMD_PRES_OUT
case|:
name|retval
operator|=
name|cctl_persistent_reserve_out
argument_list|(
name|fd
argument_list|,
name|lun
argument_list|,
name|initid
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|,
name|combinedopt
argument_list|,
name|retries
argument_list|)
expr_stmt|;
break|break;
case|case
name|CTLADM_CMD_INQ_VPD_DEVID
case|:
name|retval
operator|=
name|cctl_inquiry_vpd_devid
argument_list|(
name|fd
argument_list|,
name|lun
argument_list|,
name|initid
argument_list|)
expr_stmt|;
break|break;
case|case
name|CTLADM_CMD_RTPG
case|:
name|retval
operator|=
name|cctl_report_target_port_group
argument_list|(
name|fd
argument_list|,
name|lun
argument_list|,
name|initid
argument_list|)
expr_stmt|;
break|break;
case|case
name|CTLADM_CMD_MODIFY
case|:
name|retval
operator|=
name|cctl_modify_lun
argument_list|(
name|fd
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|,
name|combinedopt
argument_list|)
expr_stmt|;
break|break;
case|case
name|CTLADM_CMD_ISLIST
case|:
name|retval
operator|=
name|cctl_islist
argument_list|(
name|fd
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|,
name|combinedopt
argument_list|)
expr_stmt|;
break|break;
case|case
name|CTLADM_CMD_ISLOGOUT
case|:
name|retval
operator|=
name|cctl_islogout
argument_list|(
name|fd
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|,
name|combinedopt
argument_list|)
expr_stmt|;
break|break;
case|case
name|CTLADM_CMD_ISTERMINATE
case|:
name|retval
operator|=
name|cctl_isterminate
argument_list|(
name|fd
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|,
name|combinedopt
argument_list|)
expr_stmt|;
break|break;
case|case
name|CTLADM_CMD_HELP
case|:
default|default:
name|usage
argument_list|(
name|retval
argument_list|)
expr_stmt|;
break|break;
block|}
name|bailout
label|:
if|if
condition|(
name|fd
operator|!=
operator|-
literal|1
condition|)
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|retval
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * vim: ts=8  */
end_comment

end_unit


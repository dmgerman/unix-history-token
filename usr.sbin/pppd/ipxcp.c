begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * ipxcp.c - PPP IPX Control Protocol.  *  * Copyright (c) 1989 Carnegie Mellon University.  * All rights reserved.  *  * Redistribution and use in source and binary forms are permitted  * provided that the above copyright notice and this paragraph are  * duplicated in all such forms and that any documentation,  * advertising materials, and other materials related to such  * distribution and use acknowledge that the software was developed  * by Carnegie Mellon University.  The name of the  * University may not be used to endorse or promote products derived  * from this software without specific prior written permission.  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND WITHOUT ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED  * WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR A PARTICULAR PURPOSE.  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|IPX_CHANGE
end_ifdef

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|rcsid
index|[]
init|=
literal|"$FreeBSD$"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * TODO:  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<syslog.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|"pppd.h"
end_include

begin_include
include|#
directive|include
file|"fsm.h"
end_include

begin_include
include|#
directive|include
file|"ipxcp.h"
end_include

begin_include
include|#
directive|include
file|"pathnames.h"
end_include

begin_comment
comment|/* global vars */
end_comment

begin_decl_stmt
name|ipxcp_options
name|ipxcp_wantoptions
index|[
name|NUM_PPP
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Options that we want to request */
end_comment

begin_decl_stmt
name|ipxcp_options
name|ipxcp_gotoptions
index|[
name|NUM_PPP
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Options that peer ack'd */
end_comment

begin_decl_stmt
name|ipxcp_options
name|ipxcp_allowoptions
index|[
name|NUM_PPP
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Options we allow peer to request */
end_comment

begin_decl_stmt
name|ipxcp_options
name|ipxcp_hisoptions
index|[
name|NUM_PPP
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Options that we ack'd */
end_comment

begin_define
define|#
directive|define
name|wo
value|(&ipxcp_wantoptions[0])
end_define

begin_define
define|#
directive|define
name|ao
value|(&ipxcp_allowoptions[0])
end_define

begin_define
define|#
directive|define
name|go
value|(&ipxcp_gotoptions[0])
end_define

begin_define
define|#
directive|define
name|ho
value|(&ipxcp_hisoptions[0])
end_define

begin_comment
comment|/*  * Callbacks for fsm code.  (CI = Configuration Information)  */
end_comment

begin_decl_stmt
specifier|static
name|void
name|ipxcp_resetci
name|__P
argument_list|(
operator|(
name|fsm
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Reset our CI */
end_comment

begin_decl_stmt
specifier|static
name|int
name|ipxcp_cilen
name|__P
argument_list|(
operator|(
name|fsm
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Return length of our CI */
end_comment

begin_decl_stmt
specifier|static
name|void
name|ipxcp_addci
name|__P
argument_list|(
operator|(
name|fsm
operator|*
operator|,
name|u_char
operator|*
operator|,
name|int
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Add our CI */
end_comment

begin_decl_stmt
specifier|static
name|int
name|ipxcp_ackci
name|__P
argument_list|(
operator|(
name|fsm
operator|*
operator|,
name|u_char
operator|*
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Peer ack'd our CI */
end_comment

begin_decl_stmt
specifier|static
name|int
name|ipxcp_nakci
name|__P
argument_list|(
operator|(
name|fsm
operator|*
operator|,
name|u_char
operator|*
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Peer nak'd our CI */
end_comment

begin_decl_stmt
specifier|static
name|int
name|ipxcp_rejci
name|__P
argument_list|(
operator|(
name|fsm
operator|*
operator|,
name|u_char
operator|*
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Peer rej'd our CI */
end_comment

begin_decl_stmt
specifier|static
name|int
name|ipxcp_reqci
name|__P
argument_list|(
operator|(
name|fsm
operator|*
operator|,
name|u_char
operator|*
operator|,
name|int
operator|*
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Rcv CI */
end_comment

begin_decl_stmt
specifier|static
name|void
name|ipxcp_up
name|__P
argument_list|(
operator|(
name|fsm
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* We're UP */
end_comment

begin_decl_stmt
specifier|static
name|void
name|ipxcp_down
name|__P
argument_list|(
operator|(
name|fsm
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* We're DOWN */
end_comment

begin_decl_stmt
specifier|static
name|void
name|ipxcp_script
name|__P
argument_list|(
operator|(
name|fsm
operator|*
operator|,
name|char
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Run an up/down script */
end_comment

begin_decl_stmt
name|fsm
name|ipxcp_fsm
index|[
name|NUM_PPP
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* IPXCP fsm structure */
end_comment

begin_decl_stmt
specifier|static
name|fsm_callbacks
name|ipxcp_callbacks
init|=
block|{
comment|/* IPXCP callback routines */
name|ipxcp_resetci
block|,
comment|/* Reset our Configuration Information */
name|ipxcp_cilen
block|,
comment|/* Length of our Configuration Information */
name|ipxcp_addci
block|,
comment|/* Add our Configuration Information */
name|ipxcp_ackci
block|,
comment|/* ACK our Configuration Information */
name|ipxcp_nakci
block|,
comment|/* NAK our Configuration Information */
name|ipxcp_rejci
block|,
comment|/* Reject our Configuration Information */
name|ipxcp_reqci
block|,
comment|/* Request peer's Configuration Information */
name|ipxcp_up
block|,
comment|/* Called when fsm reaches OPENED state */
name|ipxcp_down
block|,
comment|/* Called when fsm leaves OPENED state */
name|NULL
block|,
comment|/* Called when we want the lower layer up */
name|NULL
block|,
comment|/* Called when we want the lower layer down */
name|NULL
block|,
comment|/* Called when Protocol-Reject received */
name|NULL
block|,
comment|/* Retransmission is necessary */
name|NULL
block|,
comment|/* Called to handle protocol-specific codes */
literal|"IPXCP"
comment|/* String name of protocol */
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Protocol entry points.  */
end_comment

begin_decl_stmt
specifier|static
name|void
name|ipxcp_init
name|__P
argument_list|(
operator|(
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|ipxcp_open
name|__P
argument_list|(
operator|(
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|ipxcp_close
name|__P
argument_list|(
operator|(
name|int
operator|,
name|char
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|ipxcp_lowerup
name|__P
argument_list|(
operator|(
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|ipxcp_lowerdown
name|__P
argument_list|(
operator|(
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|ipxcp_input
name|__P
argument_list|(
operator|(
name|int
operator|,
name|u_char
operator|*
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|ipxcp_protrej
name|__P
argument_list|(
operator|(
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|ipxcp_printpkt
name|__P
argument_list|(
operator|(
name|u_char
operator|*
operator|,
name|int
operator|,
name|void
argument_list|(
argument|*
argument_list|)
name|__P
argument_list|(
operator|(
name|void
operator|*
operator|,
name|char
operator|*
operator|,
operator|...
operator|)
argument_list|)
operator|,
name|void
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|protent
name|ipxcp_protent
init|=
block|{
name|PPP_IPXCP
block|,
name|ipxcp_init
block|,
name|ipxcp_input
block|,
name|ipxcp_protrej
block|,
name|ipxcp_lowerup
block|,
name|ipxcp_lowerdown
block|,
name|ipxcp_open
block|,
name|ipxcp_close
block|,
name|ipxcp_printpkt
block|,
name|NULL
block|,
literal|0
block|,
literal|"IPXCP"
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Lengths of configuration options.  */
end_comment

begin_define
define|#
directive|define
name|CILEN_VOID
value|2
end_define

begin_define
define|#
directive|define
name|CILEN_COMPLETE
value|2
end_define

begin_comment
comment|/* length of complete option */
end_comment

begin_define
define|#
directive|define
name|CILEN_NETN
value|6
end_define

begin_comment
comment|/* network number length option */
end_comment

begin_define
define|#
directive|define
name|CILEN_NODEN
value|8
end_define

begin_comment
comment|/* node number length option */
end_comment

begin_define
define|#
directive|define
name|CILEN_PROTOCOL
value|4
end_define

begin_comment
comment|/* Minimum length of routing protocol */
end_comment

begin_define
define|#
directive|define
name|CILEN_NAME
value|3
end_define

begin_comment
comment|/* Minimum length of router name */
end_comment

begin_define
define|#
directive|define
name|CILEN_COMPRESS
value|4
end_define

begin_comment
comment|/* Minimum length of compression protocol */
end_comment

begin_define
define|#
directive|define
name|CODENAME
parameter_list|(
name|x
parameter_list|)
value|((x) == CONFACK ? "ACK" : \ 			 (x) == CONFNAK ? "NAK" : "REJ")
end_define

begin_comment
comment|/* Used in printing the node number */
end_comment

begin_define
define|#
directive|define
name|NODE
parameter_list|(
name|base
parameter_list|)
value|base[0], base[1], base[2], base[3], base[4], base[5]
end_define

begin_comment
comment|/* Used to generate the proper bit mask */
end_comment

begin_define
define|#
directive|define
name|BIT
parameter_list|(
name|num
parameter_list|)
value|(1<< (num))
end_define

begin_comment
comment|/*  * Convert from internal to external notation  */
end_comment

begin_function
specifier|static
name|short
name|int
name|to_external
parameter_list|(
name|internal
parameter_list|)
name|short
name|int
name|internal
decl_stmt|;
block|{
name|short
name|int
name|external
decl_stmt|;
if|if
condition|(
name|internal
operator|&
name|IPX_NONE
condition|)
name|external
operator|=
name|IPX_NONE
expr_stmt|;
else|else
name|external
operator|=
name|RIP_SAP
expr_stmt|;
return|return
name|external
return|;
block|}
end_function

begin_comment
comment|/*  * Make a string representation of a network IP address.  */
end_comment

begin_function
name|char
modifier|*
name|ipx_ntoa
parameter_list|(
name|ipxaddr
parameter_list|)
name|u_int32_t
name|ipxaddr
decl_stmt|;
block|{
specifier|static
name|char
name|b
index|[
literal|64
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|b
argument_list|,
literal|"%x"
argument_list|,
name|ipxaddr
argument_list|)
expr_stmt|;
return|return
name|b
return|;
block|}
end_function

begin_comment
comment|/*  * ipxcp_init - Initialize IPXCP.  */
end_comment

begin_function
specifier|static
name|void
name|ipxcp_init
parameter_list|(
name|unit
parameter_list|)
name|int
name|unit
decl_stmt|;
block|{
name|fsm
modifier|*
name|f
init|=
operator|&
name|ipxcp_fsm
index|[
name|unit
index|]
decl_stmt|;
name|f
operator|->
name|unit
operator|=
name|unit
expr_stmt|;
name|f
operator|->
name|protocol
operator|=
name|PPP_IPXCP
expr_stmt|;
name|f
operator|->
name|callbacks
operator|=
operator|&
name|ipxcp_callbacks
expr_stmt|;
name|fsm_init
argument_list|(
operator|&
name|ipxcp_fsm
index|[
name|unit
index|]
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|wo
operator|->
name|name
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|wo
operator|->
name|name
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|wo
operator|->
name|our_node
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|wo
operator|->
name|our_node
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|wo
operator|->
name|his_node
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|wo
operator|->
name|his_node
argument_list|)
argument_list|)
expr_stmt|;
name|wo
operator|->
name|neg_nn
operator|=
literal|1
expr_stmt|;
name|wo
operator|->
name|neg_complete
operator|=
literal|1
expr_stmt|;
name|wo
operator|->
name|network
operator|=
literal|0
expr_stmt|;
name|ao
operator|->
name|neg_node
operator|=
literal|1
expr_stmt|;
name|ao
operator|->
name|neg_nn
operator|=
literal|1
expr_stmt|;
name|ao
operator|->
name|neg_name
operator|=
literal|1
expr_stmt|;
name|ao
operator|->
name|neg_complete
operator|=
literal|1
expr_stmt|;
name|ao
operator|->
name|neg_router
operator|=
literal|1
expr_stmt|;
name|ao
operator|->
name|accept_local
operator|=
literal|0
expr_stmt|;
name|ao
operator|->
name|accept_remote
operator|=
literal|0
expr_stmt|;
name|ao
operator|->
name|accept_network
operator|=
literal|0
expr_stmt|;
name|wo
operator|->
name|tried_rip
operator|=
literal|0
expr_stmt|;
name|wo
operator|->
name|tried_nlsp
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Copy the node number  */
end_comment

begin_function
specifier|static
name|void
name|copy_node
parameter_list|(
name|src
parameter_list|,
name|dst
parameter_list|)
name|u_char
modifier|*
name|src
decl_stmt|,
decl|*
name|dst
decl_stmt|;
end_function

begin_block
block|{
name|memcpy
argument_list|(
name|dst
argument_list|,
name|src
argument_list|,
sizeof|sizeof
argument_list|(
name|ipxcp_wantoptions
index|[
literal|0
index|]
operator|.
name|our_node
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * Compare node numbers  */
end_comment

begin_function
specifier|static
name|int
name|compare_node
parameter_list|(
name|src
parameter_list|,
name|dst
parameter_list|)
name|u_char
modifier|*
name|src
decl_stmt|,
decl|*
name|dst
decl_stmt|;
end_function

begin_block
block|{
return|return
name|memcmp
argument_list|(
name|dst
argument_list|,
name|src
argument_list|,
sizeof|sizeof
argument_list|(
name|ipxcp_wantoptions
index|[
literal|0
index|]
operator|.
name|our_node
argument_list|)
argument_list|)
operator|==
literal|0
return|;
block|}
end_block

begin_comment
comment|/*  * Is the node number zero?  */
end_comment

begin_function
specifier|static
name|int
name|zero_node
parameter_list|(
name|node
parameter_list|)
name|u_char
modifier|*
name|node
decl_stmt|;
block|{
name|int
name|indx
decl_stmt|;
for|for
control|(
name|indx
operator|=
literal|0
init|;
name|indx
operator|<
sizeof|sizeof
argument_list|(
name|ipxcp_wantoptions
index|[
literal|0
index|]
operator|.
name|our_node
argument_list|)
condition|;
operator|++
name|indx
control|)
if|if
condition|(
name|node
index|[
name|indx
index|]
operator|!=
literal|0
condition|)
return|return
literal|0
return|;
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/*  * Increment the node number  */
end_comment

begin_function
specifier|static
name|void
name|inc_node
parameter_list|(
name|node
parameter_list|)
name|u_char
modifier|*
name|node
decl_stmt|;
block|{
name|u_char
modifier|*
name|outp
decl_stmt|;
name|u_int32_t
name|magic_num
decl_stmt|;
name|outp
operator|=
name|node
expr_stmt|;
name|magic_num
operator|=
name|magic
argument_list|()
expr_stmt|;
operator|*
name|outp
operator|++
operator|=
literal|'\0'
expr_stmt|;
operator|*
name|outp
operator|++
operator|=
literal|'\0'
expr_stmt|;
name|PUTLONG
argument_list|(
name|magic_num
argument_list|,
name|outp
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * ipxcp_open - IPXCP is allowed to come up.  */
end_comment

begin_function
specifier|static
name|void
name|ipxcp_open
parameter_list|(
name|unit
parameter_list|)
name|int
name|unit
decl_stmt|;
block|{
name|fsm_open
argument_list|(
operator|&
name|ipxcp_fsm
index|[
name|unit
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * ipxcp_close - Take IPXCP down.  */
end_comment

begin_function
specifier|static
name|void
name|ipxcp_close
parameter_list|(
name|unit
parameter_list|,
name|reason
parameter_list|)
name|int
name|unit
decl_stmt|;
name|char
modifier|*
name|reason
decl_stmt|;
block|{
name|fsm_close
argument_list|(
operator|&
name|ipxcp_fsm
index|[
name|unit
index|]
argument_list|,
name|reason
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * ipxcp_lowerup - The lower layer is up.  */
end_comment

begin_function
specifier|static
name|void
name|ipxcp_lowerup
parameter_list|(
name|unit
parameter_list|)
name|int
name|unit
decl_stmt|;
block|{
name|fsm_lowerup
argument_list|(
operator|&
name|ipxcp_fsm
index|[
name|unit
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * ipxcp_lowerdown - The lower layer is down.  */
end_comment

begin_function
specifier|static
name|void
name|ipxcp_lowerdown
parameter_list|(
name|unit
parameter_list|)
name|int
name|unit
decl_stmt|;
block|{
name|fsm_lowerdown
argument_list|(
operator|&
name|ipxcp_fsm
index|[
name|unit
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * ipxcp_input - Input IPXCP packet.  */
end_comment

begin_function
specifier|static
name|void
name|ipxcp_input
parameter_list|(
name|unit
parameter_list|,
name|p
parameter_list|,
name|len
parameter_list|)
name|int
name|unit
decl_stmt|;
name|u_char
modifier|*
name|p
decl_stmt|;
name|int
name|len
decl_stmt|;
block|{
name|fsm_input
argument_list|(
operator|&
name|ipxcp_fsm
index|[
name|unit
index|]
argument_list|,
name|p
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * ipxcp_protrej - A Protocol-Reject was received for IPXCP.  *  * Pretend the lower layer went down, so we shut up.  */
end_comment

begin_function
specifier|static
name|void
name|ipxcp_protrej
parameter_list|(
name|unit
parameter_list|)
name|int
name|unit
decl_stmt|;
block|{
name|fsm_lowerdown
argument_list|(
operator|&
name|ipxcp_fsm
index|[
name|unit
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * ipxcp_resetci - Reset our CI.  */
end_comment

begin_function
specifier|static
name|void
name|ipxcp_resetci
parameter_list|(
name|f
parameter_list|)
name|fsm
modifier|*
name|f
decl_stmt|;
block|{
name|wo
operator|->
name|req_node
operator|=
name|wo
operator|->
name|neg_node
operator|&&
name|ao
operator|->
name|neg_node
expr_stmt|;
name|wo
operator|->
name|req_nn
operator|=
name|wo
operator|->
name|neg_nn
operator|&&
name|ao
operator|->
name|neg_nn
expr_stmt|;
if|if
condition|(
name|wo
operator|->
name|our_network
operator|==
literal|0
condition|)
block|{
name|wo
operator|->
name|neg_node
operator|=
literal|1
expr_stmt|;
name|ao
operator|->
name|accept_network
operator|=
literal|1
expr_stmt|;
block|}
comment|/*  * If our node number is zero then change it.  */
if|if
condition|(
name|zero_node
argument_list|(
name|wo
operator|->
name|our_node
argument_list|)
condition|)
block|{
name|inc_node
argument_list|(
name|wo
operator|->
name|our_node
argument_list|)
expr_stmt|;
name|ao
operator|->
name|accept_local
operator|=
literal|1
expr_stmt|;
name|wo
operator|->
name|neg_node
operator|=
literal|1
expr_stmt|;
block|}
comment|/*  * If his node number is zero then change it.  */
if|if
condition|(
name|zero_node
argument_list|(
name|wo
operator|->
name|his_node
argument_list|)
condition|)
block|{
name|inc_node
argument_list|(
name|wo
operator|->
name|his_node
argument_list|)
expr_stmt|;
name|ao
operator|->
name|accept_remote
operator|=
literal|1
expr_stmt|;
block|}
comment|/*  * If no routing agent was specified then we do RIP/SAP according to the  * RFC documents. If you have specified something then OK. Otherwise, we  * do RIP/SAP.  */
if|if
condition|(
name|ao
operator|->
name|router
operator|==
literal|0
condition|)
block|{
name|ao
operator|->
name|router
operator||=
name|BIT
argument_list|(
name|RIP_SAP
argument_list|)
expr_stmt|;
name|wo
operator|->
name|router
operator||=
name|BIT
argument_list|(
name|RIP_SAP
argument_list|)
expr_stmt|;
block|}
comment|/* Always specify a routing protocol unless it was REJected. */
name|wo
operator|->
name|neg_router
operator|=
literal|1
expr_stmt|;
comment|/*  * Start with these default values  */
operator|*
name|go
operator|=
operator|*
name|wo
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * ipxcp_cilen - Return length of our CI.  */
end_comment

begin_function
specifier|static
name|int
name|ipxcp_cilen
parameter_list|(
name|f
parameter_list|)
name|fsm
modifier|*
name|f
decl_stmt|;
block|{
name|int
name|len
decl_stmt|;
name|len
operator|=
name|go
operator|->
name|neg_nn
condition|?
name|CILEN_NETN
else|:
literal|0
expr_stmt|;
name|len
operator|+=
name|go
operator|->
name|neg_node
condition|?
name|CILEN_NODEN
else|:
literal|0
expr_stmt|;
name|len
operator|+=
name|go
operator|->
name|neg_name
condition|?
name|CILEN_NAME
operator|+
name|strlen
argument_list|(
name|go
operator|->
name|name
argument_list|)
operator|-
literal|1
else|:
literal|0
expr_stmt|;
comment|/* RFC says that defaults should not be included. */
if|if
condition|(
name|go
operator|->
name|neg_router
operator|&&
name|to_external
argument_list|(
name|go
operator|->
name|router
argument_list|)
operator|!=
name|RIP_SAP
condition|)
name|len
operator|+=
name|CILEN_PROTOCOL
expr_stmt|;
return|return
operator|(
name|len
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * ipxcp_addci - Add our desired CIs to a packet.  */
end_comment

begin_function
specifier|static
name|void
name|ipxcp_addci
parameter_list|(
name|f
parameter_list|,
name|ucp
parameter_list|,
name|lenp
parameter_list|)
name|fsm
modifier|*
name|f
decl_stmt|;
name|u_char
modifier|*
name|ucp
decl_stmt|;
name|int
modifier|*
name|lenp
decl_stmt|;
block|{
comment|/*  * Add the options to the record.  */
if|if
condition|(
name|go
operator|->
name|neg_nn
condition|)
block|{
name|PUTCHAR
argument_list|(
name|IPX_NETWORK_NUMBER
argument_list|,
name|ucp
argument_list|)
expr_stmt|;
name|PUTCHAR
argument_list|(
name|CILEN_NETN
argument_list|,
name|ucp
argument_list|)
expr_stmt|;
name|PUTLONG
argument_list|(
name|go
operator|->
name|our_network
argument_list|,
name|ucp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|go
operator|->
name|neg_node
condition|)
block|{
name|int
name|indx
decl_stmt|;
name|PUTCHAR
argument_list|(
name|IPX_NODE_NUMBER
argument_list|,
name|ucp
argument_list|)
expr_stmt|;
name|PUTCHAR
argument_list|(
name|CILEN_NODEN
argument_list|,
name|ucp
argument_list|)
expr_stmt|;
for|for
control|(
name|indx
operator|=
literal|0
init|;
name|indx
operator|<
sizeof|sizeof
argument_list|(
name|go
operator|->
name|our_node
argument_list|)
condition|;
operator|++
name|indx
control|)
name|PUTCHAR
argument_list|(
name|go
operator|->
name|our_node
index|[
name|indx
index|]
argument_list|,
name|ucp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|go
operator|->
name|neg_name
condition|)
block|{
name|int
name|cilen
init|=
name|strlen
argument_list|(
name|go
operator|->
name|name
argument_list|)
decl_stmt|;
name|int
name|indx
decl_stmt|;
name|PUTCHAR
argument_list|(
name|IPX_ROUTER_NAME
argument_list|,
name|ucp
argument_list|)
expr_stmt|;
name|PUTCHAR
argument_list|(
name|CILEN_NAME
operator|+
name|cilen
operator|-
literal|1
argument_list|,
name|ucp
argument_list|)
expr_stmt|;
for|for
control|(
name|indx
operator|=
literal|0
init|;
name|indx
operator|<
name|cilen
condition|;
operator|++
name|indx
control|)
name|PUTCHAR
argument_list|(
name|go
operator|->
name|name
index|[
name|indx
index|]
argument_list|,
name|ucp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|go
operator|->
name|neg_router
condition|)
block|{
name|short
name|external
init|=
name|to_external
argument_list|(
name|go
operator|->
name|router
argument_list|)
decl_stmt|;
if|if
condition|(
name|external
operator|!=
name|RIP_SAP
condition|)
block|{
name|PUTCHAR
argument_list|(
name|IPX_ROUTER_PROTOCOL
argument_list|,
name|ucp
argument_list|)
expr_stmt|;
name|PUTCHAR
argument_list|(
name|CILEN_PROTOCOL
argument_list|,
name|ucp
argument_list|)
expr_stmt|;
name|PUTSHORT
argument_list|(
name|external
argument_list|,
name|ucp
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*  * ipxcp_ackci - Ack our CIs.  *  * Returns:  *	0 - Ack was bad.  *	1 - Ack was good.  */
end_comment

begin_function
specifier|static
name|int
name|ipxcp_ackci
parameter_list|(
name|f
parameter_list|,
name|p
parameter_list|,
name|len
parameter_list|)
name|fsm
modifier|*
name|f
decl_stmt|;
name|u_char
modifier|*
name|p
decl_stmt|;
name|int
name|len
decl_stmt|;
block|{
name|u_short
name|cilen
decl_stmt|,
name|citype
decl_stmt|,
name|cishort
decl_stmt|;
name|u_char
name|cichar
decl_stmt|;
name|u_int32_t
name|cilong
decl_stmt|;
define|#
directive|define
name|ACKCIVOID
parameter_list|(
name|opt
parameter_list|,
name|neg
parameter_list|)
define|\
value|if (neg) { \ 	if ((len -= CILEN_VOID)< 0) \ 	    break; \ 	GETCHAR(citype, p); \ 	GETCHAR(cilen, p); \ 	if (cilen != CILEN_VOID || \ 	    citype != opt) \ 	    break; \     }
define|#
directive|define
name|ACKCICOMPLETE
parameter_list|(
name|opt
parameter_list|,
name|neg
parameter_list|)
value|ACKCIVOID(opt, neg)
define|#
directive|define
name|ACKCICHARS
parameter_list|(
name|opt
parameter_list|,
name|neg
parameter_list|,
name|val
parameter_list|,
name|cnt
parameter_list|)
define|\
value|if (neg) { \ 	int indx, count = cnt; \ 	len -= (count + 2); \ 	if (len< 0) \ 	    break; \ 	GETCHAR(citype, p); \ 	GETCHAR(cilen, p); \ 	if (cilen != (count + 2) || \ 	    citype != opt) \ 	    break; \ 	for (indx = 0; indx< count; ++indx) {\ 	    GETCHAR(cichar, p); \ 	    if (cichar != ((u_char *)&val)[indx]) \ 	       break; \ 	}\ 	if (indx != count) \ 	    break; \     }
define|#
directive|define
name|ACKCINODE
parameter_list|(
name|opt
parameter_list|,
name|neg
parameter_list|,
name|val
parameter_list|)
value|ACKCICHARS(opt,neg,val,sizeof(val))
define|#
directive|define
name|ACKCINAME
parameter_list|(
name|opt
parameter_list|,
name|neg
parameter_list|,
name|val
parameter_list|)
value|ACKCICHARS(opt,neg,val,strlen(val))
define|#
directive|define
name|ACKCINETWORK
parameter_list|(
name|opt
parameter_list|,
name|neg
parameter_list|,
name|val
parameter_list|)
define|\
value|if (neg) { \ 	if ((len -= CILEN_NETN)< 0) \ 	    break; \ 	GETCHAR(citype, p); \ 	GETCHAR(cilen, p); \ 	if (cilen != CILEN_NETN || \ 	    citype != opt) \ 	    break; \ 	GETLONG(cilong, p); \ 	if (cilong != val) \ 	    break; \     }
define|#
directive|define
name|ACKCIPROTO
parameter_list|(
name|opt
parameter_list|,
name|neg
parameter_list|,
name|val
parameter_list|)
define|\
value|if (neg) { \ 	if (len< 2) \ 	    break; \ 	GETCHAR(citype, p); \ 	GETCHAR(cilen, p); \ 	if (cilen != CILEN_PROTOCOL || citype != opt) \ 	    break; \ 	len -= cilen; \ 	if (len< 0) \ 	    break; \ 	GETSHORT(cishort, p); \ 	if (cishort != to_external (val) || cishort == RIP_SAP) \ 	    break; \       }
comment|/*  * Process the ACK frame in the order in which the frame was assembled  */
do|do
block|{
name|ACKCINETWORK
argument_list|(
name|IPX_NETWORK_NUMBER
argument_list|,
name|go
operator|->
name|neg_nn
argument_list|,
name|go
operator|->
name|our_network
argument_list|)
expr_stmt|;
name|ACKCINODE
argument_list|(
name|IPX_NODE_NUMBER
argument_list|,
name|go
operator|->
name|neg_node
argument_list|,
name|go
operator|->
name|our_node
argument_list|)
expr_stmt|;
name|ACKCINAME
argument_list|(
name|IPX_ROUTER_NAME
argument_list|,
name|go
operator|->
name|neg_name
argument_list|,
name|go
operator|->
name|name
argument_list|)
expr_stmt|;
name|ACKCIPROTO
argument_list|(
name|IPX_ROUTER_PROTOCOL
argument_list|,
name|go
operator|->
name|neg_router
argument_list|,
name|go
operator|->
name|router
argument_list|)
expr_stmt|;
name|ACKCIPROTO
argument_list|(
name|IPX_ROUTER_PROTOCOL
argument_list|,
name|go
operator|->
name|neg_router
argument_list|,
name|go
operator|->
name|router
argument_list|)
expr_stmt|;
name|ACKCIPROTO
argument_list|(
name|IPX_ROUTER_PROTOCOL
argument_list|,
name|go
operator|->
name|neg_router
argument_list|,
name|go
operator|->
name|router
argument_list|)
expr_stmt|;
comment|/*  * This is the end of the record.  */
if|if
condition|(
name|len
operator|==
literal|0
condition|)
return|return
operator|(
literal|1
operator|)
return|;
block|}
do|while
condition|(
literal|0
condition|)
do|;
comment|/*  * The frame is invalid  */
name|IPXCPDEBUG
argument_list|(
operator|(
name|LOG_INFO
operator|,
literal|"ipxcp_ackci: received bad Ack!"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * ipxcp_nakci - Peer has sent a NAK for some of our CIs.  * This should not modify any state if the Nak is bad  * or if IPXCP is in the OPENED state.  *  * Returns:  *	0 - Nak was bad.  *	1 - Nak was good.  */
end_comment

begin_function
specifier|static
name|int
name|ipxcp_nakci
parameter_list|(
name|f
parameter_list|,
name|p
parameter_list|,
name|len
parameter_list|)
name|fsm
modifier|*
name|f
decl_stmt|;
name|u_char
modifier|*
name|p
decl_stmt|;
name|int
name|len
decl_stmt|;
block|{
name|u_char
name|citype
decl_stmt|,
name|cilen
decl_stmt|,
modifier|*
name|next
decl_stmt|;
name|u_short
name|s
decl_stmt|;
name|u_int32_t
name|l
decl_stmt|;
name|ipxcp_options
name|no
decl_stmt|;
comment|/* options we've seen Naks for */
name|ipxcp_options
name|try
decl_stmt|;
comment|/* options to request next time */
name|BZERO
argument_list|(
operator|&
name|no
argument_list|,
sizeof|sizeof
argument_list|(
name|no
argument_list|)
argument_list|)
expr_stmt|;
name|try
operator|=
operator|*
name|go
expr_stmt|;
while|while
condition|(
name|len
operator|>
name|CILEN_VOID
condition|)
block|{
name|GETCHAR
argument_list|(
name|citype
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|GETCHAR
argument_list|(
name|cilen
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|len
operator|-=
name|cilen
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
condition|)
goto|goto
name|bad
goto|;
name|next
operator|=
operator|&
name|p
index|[
name|cilen
operator|-
name|CILEN_VOID
index|]
expr_stmt|;
switch|switch
condition|(
name|citype
condition|)
block|{
case|case
name|IPX_NETWORK_NUMBER
case|:
if|if
condition|(
operator|!
name|go
operator|->
name|neg_nn
operator|||
name|no
operator|.
name|neg_nn
operator|||
operator|(
name|cilen
operator|!=
name|CILEN_NETN
operator|)
condition|)
goto|goto
name|bad
goto|;
name|no
operator|.
name|neg_nn
operator|=
literal|1
expr_stmt|;
name|GETLONG
argument_list|(
name|l
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|IPXCPDEBUG
argument_list|(
operator|(
name|LOG_INFO
operator|,
literal|"local IP address %d"
operator|,
name|l
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|l
operator|&&
name|ao
operator|->
name|accept_network
condition|)
name|try
operator|.
name|our_network
operator|=
name|l
expr_stmt|;
break|break;
case|case
name|IPX_NODE_NUMBER
case|:
if|if
condition|(
operator|!
name|go
operator|->
name|neg_node
operator|||
name|no
operator|.
name|neg_node
operator|||
operator|(
name|cilen
operator|!=
name|CILEN_NODEN
operator|)
condition|)
goto|goto
name|bad
goto|;
name|no
operator|.
name|neg_node
operator|=
literal|1
expr_stmt|;
name|IPXCPDEBUG
argument_list|(
operator|(
name|LOG_INFO
operator|,
literal|"local node number %02X%02X%02X%02X%02X%02X"
operator|,
name|NODE
argument_list|(
name|p
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|zero_node
argument_list|(
name|p
argument_list|)
operator|&&
name|ao
operator|->
name|accept_local
operator|&&
operator|!
name|compare_node
argument_list|(
name|p
argument_list|,
name|ho
operator|->
name|his_node
argument_list|)
condition|)
name|copy_node
argument_list|(
name|p
argument_list|,
name|try
operator|.
name|our_node
argument_list|)
expr_stmt|;
break|break;
comment|/* This has never been sent. Ignore the NAK frame */
case|case
name|IPX_COMPRESSION_PROTOCOL
case|:
goto|goto
name|bad
goto|;
case|case
name|IPX_ROUTER_PROTOCOL
case|:
if|if
condition|(
operator|!
name|go
operator|->
name|neg_router
operator|||
operator|(
name|cilen
operator|<
name|CILEN_PROTOCOL
operator|)
condition|)
goto|goto
name|bad
goto|;
name|GETSHORT
argument_list|(
name|s
argument_list|,
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|>
literal|15
condition|)
comment|/* This is just bad, but ignore for now. */
break|break;
name|s
operator|=
name|BIT
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|no
operator|.
name|router
operator|&
name|s
condition|)
comment|/* duplicate NAKs are always bad */
goto|goto
name|bad
goto|;
if|if
condition|(
name|no
operator|.
name|router
operator|==
literal|0
condition|)
comment|/* Reset on first NAK only */
name|try
operator|.
name|router
operator|=
literal|0
expr_stmt|;
name|no
operator|.
name|router
operator||=
name|s
expr_stmt|;
name|try
operator|.
name|router
operator||=
name|s
expr_stmt|;
name|try
operator|.
name|neg_router
operator|=
literal|1
expr_stmt|;
name|IPXCPDEBUG
argument_list|(
operator|(
name|LOG_INFO
operator|,
literal|"Router protocol number %d"
operator|,
name|s
operator|)
argument_list|)
expr_stmt|;
break|break;
comment|/* These, according to the RFC, must never be NAKed. */
case|case
name|IPX_ROUTER_NAME
case|:
case|case
name|IPX_COMPLETE
case|:
goto|goto
name|bad
goto|;
comment|/* These are for options which we have not seen. */
default|default:
break|break;
block|}
name|p
operator|=
name|next
expr_stmt|;
block|}
comment|/* If there is still anything left, this packet is bad. */
if|if
condition|(
name|len
operator|!=
literal|0
condition|)
goto|goto
name|bad
goto|;
comment|/*      * Do not permit the peer to force a router protocol which we do not      * support. However, default to the condition that will accept "NONE".      */
name|try
operator|.
name|router
operator|&=
operator|(
name|ao
operator|->
name|router
operator||
name|BIT
argument_list|(
name|IPX_NONE
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
name|try
operator|.
name|router
operator|==
literal|0
operator|&&
name|ao
operator|->
name|router
operator|!=
literal|0
condition|)
name|try
operator|.
name|router
operator|=
name|BIT
argument_list|(
name|IPX_NONE
argument_list|)
expr_stmt|;
if|if
condition|(
name|try
operator|.
name|router
operator|!=
literal|0
condition|)
name|try
operator|.
name|neg_router
operator|=
literal|1
expr_stmt|;
comment|/*      * OK, the Nak is good.  Now we can update state.      */
if|if
condition|(
name|f
operator|->
name|state
operator|!=
name|OPENED
condition|)
operator|*
name|go
operator|=
name|try
expr_stmt|;
return|return
literal|1
return|;
name|bad
label|:
name|IPXCPDEBUG
argument_list|(
operator|(
name|LOG_INFO
operator|,
literal|"ipxcp_nakci: received bad Nak!"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * ipxcp_rejci - Reject some of our CIs.  */
end_comment

begin_function
specifier|static
name|int
name|ipxcp_rejci
parameter_list|(
name|f
parameter_list|,
name|p
parameter_list|,
name|len
parameter_list|)
name|fsm
modifier|*
name|f
decl_stmt|;
name|u_char
modifier|*
name|p
decl_stmt|;
name|int
name|len
decl_stmt|;
block|{
name|u_short
name|cilen
decl_stmt|,
name|citype
decl_stmt|,
name|cishort
decl_stmt|;
name|u_char
name|cichar
decl_stmt|;
name|u_int32_t
name|cilong
decl_stmt|;
name|ipxcp_options
name|try
decl_stmt|;
comment|/* options to request next time */
define|#
directive|define
name|REJCINETWORK
parameter_list|(
name|opt
parameter_list|,
name|neg
parameter_list|,
name|val
parameter_list|)
define|\
value|if (neg&& p[0] == opt) { \ 	if ((len -= CILEN_NETN)< 0) \ 	    break; \ 	GETCHAR(citype, p); \ 	GETCHAR(cilen, p); \ 	if (cilen != CILEN_NETN || \ 	    citype != opt) \ 	    break; \ 	GETLONG(cilong, p); \ 	if (cilong != val) \ 	    break; \ 	IPXCPDEBUG((LOG_INFO,"ipxcp_rejci rejected long opt %d", opt)); \ 	neg = 0; \     }
define|#
directive|define
name|REJCICHARS
parameter_list|(
name|opt
parameter_list|,
name|neg
parameter_list|,
name|val
parameter_list|,
name|cnt
parameter_list|)
define|\
value|if (neg&& p[0] == opt) { \ 	int indx, count = cnt; \ 	len -= (count + 2); \ 	if (len< 0) \ 	    break; \ 	GETCHAR(citype, p); \ 	GETCHAR(cilen, p); \ 	if (cilen != (count + 2) || \ 	    citype != opt) \ 	    break; \ 	for (indx = 0; indx< count; ++indx) {\ 	    GETCHAR(cichar, p); \ 	    if (cichar != ((u_char *)&val)[indx]) \ 	       break; \ 	}\ 	if (indx != count) \ 	    break; \ 	IPXCPDEBUG((LOG_INFO,"ipxcp_rejci rejected opt %d", opt)); \ 	neg = 0; \     }
define|#
directive|define
name|REJCINODE
parameter_list|(
name|opt
parameter_list|,
name|neg
parameter_list|,
name|val
parameter_list|)
value|REJCICHARS(opt,neg,val,sizeof(val))
define|#
directive|define
name|REJCINAME
parameter_list|(
name|opt
parameter_list|,
name|neg
parameter_list|,
name|val
parameter_list|)
value|REJCICHARS(opt,neg,val,strlen(val))
define|#
directive|define
name|REJCIVOID
parameter_list|(
name|opt
parameter_list|,
name|neg
parameter_list|)
define|\
value|if (neg&& p[0] == opt) { \ 	if ((len -= CILEN_VOID)< 0) \ 	    break; \ 	GETCHAR(citype, p); \ 	GETCHAR(cilen, p); \ 	if (cilen != CILEN_VOID || citype != opt) \ 	    break; \ 	IPXCPDEBUG((LOG_INFO, "ipxcp_rejci rejected void opt %d", opt)); \ 	neg = 0; \     }
comment|/* a reject for RIP/SAP is invalid since we don't send it and you can't    reject something which is not sent. (You can NAK, but you can't REJ.) */
define|#
directive|define
name|REJCIPROTO
parameter_list|(
name|opt
parameter_list|,
name|neg
parameter_list|,
name|val
parameter_list|,
name|bit
parameter_list|)
define|\
value|if (neg&& p[0] == opt) { \ 	if ((len -= CILEN_PROTOCOL)< 0) \ 	    break; \ 	GETCHAR(citype, p); \ 	GETCHAR(cilen, p); \ 	if (cilen != CILEN_PROTOCOL) \ 	    break; \ 	GETSHORT(cishort, p); \ 	if (cishort != to_external (val) || cishort == RIP_SAP) \ 	    break; \ 	IPXCPDEBUG((LOG_INFO, "ipxcp_rejci short opt %d", opt)); \ 	neg = 0; \     }
comment|/*  * Any Rejected CIs must be in exactly the same order that we sent.  * Check packet length and CI length at each step.  * If we find any deviations, then this packet is bad.  */
name|try
operator|=
operator|*
name|go
expr_stmt|;
do|do
block|{
name|REJCINETWORK
argument_list|(
name|IPX_NETWORK_NUMBER
argument_list|,
name|try
operator|.
name|neg_nn
argument_list|,
name|try
operator|.
name|our_network
argument_list|)
expr_stmt|;
name|REJCINODE
argument_list|(
name|IPX_NODE_NUMBER
argument_list|,
name|try
operator|.
name|neg_node
argument_list|,
name|try
operator|.
name|our_node
argument_list|)
expr_stmt|;
name|REJCINAME
argument_list|(
name|IPX_ROUTER_NAME
argument_list|,
name|try
operator|.
name|neg_name
argument_list|,
name|try
operator|.
name|name
argument_list|)
expr_stmt|;
name|REJCIPROTO
argument_list|(
name|IPX_ROUTER_PROTOCOL
argument_list|,
name|try
operator|.
name|neg_router
argument_list|,
name|try
operator|.
name|router
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/*  * This is the end of the record.  */
if|if
condition|(
name|len
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|f
operator|->
name|state
operator|!=
name|OPENED
condition|)
operator|*
name|go
operator|=
name|try
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
block|}
do|while
condition|(
literal|0
condition|)
do|;
comment|/*  * The frame is invalid at this point.  */
name|IPXCPDEBUG
argument_list|(
operator|(
name|LOG_INFO
operator|,
literal|"ipxcp_rejci: received bad Reject!"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * ipxcp_reqci - Check the peer's requested CIs and send appropriate response.  *  * Returns: CONFACK, CONFNAK or CONFREJ and input packet modified  * appropriately.  If reject_if_disagree is non-zero, doesn't return  * CONFNAK; returns CONFREJ if it can't return CONFACK.  */
end_comment

begin_function
specifier|static
name|int
name|ipxcp_reqci
parameter_list|(
name|f
parameter_list|,
name|inp
parameter_list|,
name|len
parameter_list|,
name|reject_if_disagree
parameter_list|)
name|fsm
modifier|*
name|f
decl_stmt|;
name|u_char
modifier|*
name|inp
decl_stmt|;
comment|/* Requested CIs */
name|int
modifier|*
name|len
decl_stmt|;
comment|/* Length of requested CIs */
name|int
name|reject_if_disagree
decl_stmt|;
block|{
name|u_char
modifier|*
name|cip
decl_stmt|,
modifier|*
name|next
decl_stmt|;
comment|/* Pointer to current and next CIs */
name|u_short
name|cilen
decl_stmt|,
name|citype
decl_stmt|;
comment|/* Parsed len, type */
name|u_short
name|cishort
decl_stmt|;
comment|/* Parsed short value */
name|u_int32_t
name|cinetwork
decl_stmt|;
comment|/* Parsed address values */
name|int
name|rc
init|=
name|CONFACK
decl_stmt|;
comment|/* Final packet return code */
name|int
name|orc
decl_stmt|;
comment|/* Individual option return code */
name|u_char
modifier|*
name|p
decl_stmt|;
comment|/* Pointer to next char to parse */
name|u_char
modifier|*
name|ucp
init|=
name|inp
decl_stmt|;
comment|/* Pointer to current output char */
name|int
name|l
init|=
operator|*
name|len
decl_stmt|;
comment|/* Length left */
comment|/*      * Reset all his options.      */
name|BZERO
argument_list|(
name|ho
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ho
argument_list|)
argument_list|)
expr_stmt|;
comment|/*      * Process all his options.      */
name|next
operator|=
name|inp
expr_stmt|;
while|while
condition|(
name|l
condition|)
block|{
name|orc
operator|=
name|CONFACK
expr_stmt|;
comment|/* Assume success */
name|cip
operator|=
name|p
operator|=
name|next
expr_stmt|;
comment|/* Remember begining of CI */
if|if
condition|(
name|l
operator|<
literal|2
operator|||
comment|/* Not enough data for CI header or */
name|p
index|[
literal|1
index|]
operator|<
literal|2
operator|||
comment|/*  CI length too small or */
name|p
index|[
literal|1
index|]
operator|>
name|l
condition|)
block|{
comment|/*  CI length too big? */
name|IPXCPDEBUG
argument_list|(
operator|(
name|LOG_INFO
operator|,
literal|"ipxcp_reqci: bad CI length!"
operator|)
argument_list|)
expr_stmt|;
name|orc
operator|=
name|CONFREJ
expr_stmt|;
comment|/* Reject bad CI */
name|cilen
operator|=
name|l
expr_stmt|;
comment|/* Reject till end of packet */
name|l
operator|=
literal|0
expr_stmt|;
comment|/* Don't loop again */
goto|goto
name|endswitch
goto|;
block|}
name|GETCHAR
argument_list|(
name|citype
argument_list|,
name|p
argument_list|)
expr_stmt|;
comment|/* Parse CI type */
name|GETCHAR
argument_list|(
name|cilen
argument_list|,
name|p
argument_list|)
expr_stmt|;
comment|/* Parse CI length */
name|l
operator|-=
name|cilen
expr_stmt|;
comment|/* Adjust remaining length */
name|next
operator|+=
name|cilen
expr_stmt|;
comment|/* Step to next CI */
switch|switch
condition|(
name|citype
condition|)
block|{
comment|/* Check CI type */
comment|/*  * The network number must match. Choose the larger of the two.  */
case|case
name|IPX_NETWORK_NUMBER
case|:
name|IPXCPDEBUG
argument_list|(
operator|(
name|LOG_INFO
operator|,
literal|"ipxcp: received Network Number request"
operator|)
argument_list|)
expr_stmt|;
comment|/* if we wont negotiate the network number or the length is wrong 	       then reject the option */
if|if
condition|(
operator|!
name|ao
operator|->
name|neg_nn
operator|||
name|cilen
operator|!=
name|CILEN_NETN
condition|)
block|{
name|orc
operator|=
name|CONFREJ
expr_stmt|;
break|break;
block|}
name|GETLONG
argument_list|(
name|cinetwork
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|IPXCPDEBUG
argument_list|(
operator|(
name|LOG_INFO
operator|,
literal|"Remote proposed IPX network number is %8Lx"
operator|,
name|tl
operator|)
argument_list|)
expr_stmt|;
comment|/* If the network numbers match then acknowledge them. */
if|if
condition|(
name|cinetwork
operator|!=
literal|0
condition|)
block|{
name|ho
operator|->
name|his_network
operator|=
name|cinetwork
expr_stmt|;
name|ho
operator|->
name|neg_nn
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|wo
operator|->
name|our_network
operator|==
name|cinetwork
condition|)
break|break;
comment|/*  * If the network number is not given or we don't accept their change or  * the network number is too small then NAK it.  */
if|if
condition|(
operator|!
name|ao
operator|->
name|accept_network
operator|||
name|cinetwork
operator|<
name|wo
operator|->
name|our_network
condition|)
block|{
name|DECPTR
argument_list|(
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|PUTLONG
argument_list|(
name|wo
operator|->
name|our_network
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|orc
operator|=
name|CONFNAK
expr_stmt|;
block|}
break|break;
block|}
comment|/*  * The peer sent '0' for the network. Give it ours if we have one.  */
if|if
condition|(
name|go
operator|->
name|our_network
operator|!=
literal|0
condition|)
block|{
name|DECPTR
argument_list|(
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|PUTLONG
argument_list|(
name|wo
operator|->
name|our_network
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|orc
operator|=
name|CONFNAK
expr_stmt|;
comment|/*  * We don't have one. Reject the value.  */
block|}
else|else
name|orc
operator|=
name|CONFREJ
expr_stmt|;
break|break;
comment|/*  * The node number is required  */
case|case
name|IPX_NODE_NUMBER
case|:
name|IPXCPDEBUG
argument_list|(
operator|(
name|LOG_INFO
operator|,
literal|"ipxcp: received Node Number request"
operator|)
argument_list|)
expr_stmt|;
comment|/* if we wont negotiate the node number or the length is wrong 	       then reject the option */
if|if
condition|(
name|cilen
operator|!=
name|CILEN_NODEN
condition|)
block|{
name|orc
operator|=
name|CONFREJ
expr_stmt|;
break|break;
block|}
name|copy_node
argument_list|(
name|p
argument_list|,
name|ho
operator|->
name|his_node
argument_list|)
expr_stmt|;
name|ho
operator|->
name|neg_node
operator|=
literal|1
expr_stmt|;
comment|/*  * If the remote does not have a number and we do then NAK it with the value  * which we have for it. (We never have a default value of zero.)  */
if|if
condition|(
name|zero_node
argument_list|(
name|ho
operator|->
name|his_node
argument_list|)
condition|)
block|{
name|orc
operator|=
name|CONFNAK
expr_stmt|;
name|copy_node
argument_list|(
name|wo
operator|->
name|his_node
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|INCPTR
argument_list|(
sizeof|sizeof
argument_list|(
name|wo
operator|->
name|his_node
argument_list|)
argument_list|,
name|p
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/*  * If you have given me the expected network node number then I'll accept  * it now.  */
if|if
condition|(
name|compare_node
argument_list|(
name|wo
operator|->
name|his_node
argument_list|,
name|ho
operator|->
name|his_node
argument_list|)
condition|)
block|{
name|orc
operator|=
name|CONFACK
expr_stmt|;
name|ho
operator|->
name|neg_node
operator|=
literal|1
expr_stmt|;
name|INCPTR
argument_list|(
sizeof|sizeof
argument_list|(
name|wo
operator|->
name|his_node
argument_list|)
argument_list|,
name|p
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/*  * If his node number is the same as ours then ask him to try the next  * value.  */
if|if
condition|(
name|compare_node
argument_list|(
name|ho
operator|->
name|his_node
argument_list|,
name|go
operator|->
name|our_node
argument_list|)
condition|)
block|{
name|inc_node
argument_list|(
name|ho
operator|->
name|his_node
argument_list|)
expr_stmt|;
name|orc
operator|=
name|CONFNAK
expr_stmt|;
name|copy_node
argument_list|(
name|ho
operator|->
name|his_node
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|INCPTR
argument_list|(
sizeof|sizeof
argument_list|(
name|wo
operator|->
name|his_node
argument_list|)
argument_list|,
name|p
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/*  * If we don't accept a new value then NAK it.  */
if|if
condition|(
operator|!
name|ao
operator|->
name|accept_remote
condition|)
block|{
name|copy_node
argument_list|(
name|wo
operator|->
name|his_node
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|INCPTR
argument_list|(
sizeof|sizeof
argument_list|(
name|wo
operator|->
name|his_node
argument_list|)
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|orc
operator|=
name|CONFNAK
expr_stmt|;
break|break;
block|}
name|orc
operator|=
name|CONFACK
expr_stmt|;
name|ho
operator|->
name|neg_node
operator|=
literal|1
expr_stmt|;
name|INCPTR
argument_list|(
sizeof|sizeof
argument_list|(
name|wo
operator|->
name|his_node
argument_list|)
argument_list|,
name|p
argument_list|)
expr_stmt|;
break|break;
comment|/*  * Compression is not desired at this time. It is always rejected.  */
case|case
name|IPX_COMPRESSION_PROTOCOL
case|:
name|IPXCPDEBUG
argument_list|(
operator|(
name|LOG_INFO
operator|,
literal|"ipxcp: received Compression Protocol request "
operator|)
argument_list|)
expr_stmt|;
name|orc
operator|=
name|CONFREJ
expr_stmt|;
break|break;
comment|/*  * The routing protocol is a bitmask of various types. Any combination  * of the values RIP_SAP and NLSP are permissible. 'IPX_NONE' for no  * routing protocol must be specified only once.  */
case|case
name|IPX_ROUTER_PROTOCOL
case|:
if|if
condition|(
operator|!
name|ao
operator|->
name|neg_router
operator|||
name|cilen
operator|<
name|CILEN_PROTOCOL
condition|)
block|{
name|orc
operator|=
name|CONFREJ
expr_stmt|;
break|break;
block|}
name|GETSHORT
argument_list|(
name|cishort
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|IPXCPDEBUG
argument_list|(
operator|(
name|LOG_INFO
operator|,
literal|"Remote router protocol number 0x%04x"
operator|,
name|cishort
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|wo
operator|->
name|neg_router
operator|==
literal|0
condition|)
block|{
name|wo
operator|->
name|neg_router
operator|=
literal|1
expr_stmt|;
name|wo
operator|->
name|router
operator|=
name|BIT
argument_list|(
name|IPX_NONE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|cishort
operator|==
name|IPX_NONE
operator|&&
name|ho
operator|->
name|router
operator|!=
literal|0
operator|)
operator|||
operator|(
name|ho
operator|->
name|router
operator|&
name|BIT
argument_list|(
name|IPX_NONE
argument_list|)
operator|)
condition|)
block|{
name|orc
operator|=
name|CONFREJ
expr_stmt|;
break|break;
block|}
name|cishort
operator|=
name|BIT
argument_list|(
name|cishort
argument_list|)
expr_stmt|;
if|if
condition|(
name|ho
operator|->
name|router
operator|&
name|cishort
condition|)
block|{
name|orc
operator|=
name|CONFREJ
expr_stmt|;
break|break;
block|}
name|ho
operator|->
name|router
operator||=
name|cishort
expr_stmt|;
name|ho
operator|->
name|neg_router
operator|=
literal|1
expr_stmt|;
comment|/* Finally do not allow a router protocol which we do not 	       support. */
if|if
condition|(
operator|(
name|cishort
operator|&
operator|(
name|ao
operator|->
name|router
operator||
name|BIT
argument_list|(
name|IPX_NONE
argument_list|)
operator|)
operator|)
operator|==
literal|0
condition|)
block|{
name|int
name|protocol
decl_stmt|;
if|if
condition|(
name|cishort
operator|==
name|BIT
argument_list|(
name|NLSP
argument_list|)
operator|&&
operator|(
name|ao
operator|->
name|router
operator|&
name|BIT
argument_list|(
name|RIP_SAP
argument_list|)
operator|)
operator|&&
operator|!
name|wo
operator|->
name|tried_rip
condition|)
block|{
name|protocol
operator|=
name|RIP_SAP
expr_stmt|;
name|wo
operator|->
name|tried_rip
operator|=
literal|1
expr_stmt|;
block|}
else|else
name|protocol
operator|=
name|IPX_NONE
expr_stmt|;
name|DECPTR
argument_list|(
sizeof|sizeof
argument_list|(
name|u_int16_t
argument_list|)
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|PUTSHORT
argument_list|(
name|protocol
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|orc
operator|=
name|CONFNAK
expr_stmt|;
block|}
break|break;
comment|/*  * The router name is advisorary. Just accept it if it is not too large.  */
case|case
name|IPX_ROUTER_NAME
case|:
name|IPXCPDEBUG
argument_list|(
operator|(
name|LOG_INFO
operator|,
literal|"ipxcp: received Router Name request"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cilen
operator|>=
name|CILEN_NAME
condition|)
block|{
name|int
name|name_size
init|=
name|cilen
operator|-
name|CILEN_NAME
decl_stmt|;
if|if
condition|(
name|name_size
operator|>
sizeof|sizeof
argument_list|(
name|ho
operator|->
name|name
argument_list|)
condition|)
name|name_size
operator|=
sizeof|sizeof
argument_list|(
name|ho
operator|->
name|name
argument_list|)
operator|-
literal|1
expr_stmt|;
name|memset
argument_list|(
name|ho
operator|->
name|name
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ho
operator|->
name|name
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|ho
operator|->
name|name
argument_list|,
name|p
argument_list|,
name|name_size
argument_list|)
expr_stmt|;
name|ho
operator|->
name|name
index|[
name|name_size
index|]
operator|=
literal|'\0'
expr_stmt|;
name|ho
operator|->
name|neg_name
operator|=
literal|1
expr_stmt|;
name|orc
operator|=
name|CONFACK
expr_stmt|;
break|break;
block|}
name|orc
operator|=
name|CONFREJ
expr_stmt|;
break|break;
comment|/*  * This is advisorary.  */
case|case
name|IPX_COMPLETE
case|:
name|IPXCPDEBUG
argument_list|(
operator|(
name|LOG_INFO
operator|,
literal|"ipxcp: received Complete request"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cilen
operator|!=
name|CILEN_COMPLETE
condition|)
name|orc
operator|=
name|CONFREJ
expr_stmt|;
else|else
block|{
name|ho
operator|->
name|neg_complete
operator|=
literal|1
expr_stmt|;
name|orc
operator|=
name|CONFACK
expr_stmt|;
block|}
break|break;
comment|/*  * All other entries are not known at this time.  */
default|default:
name|IPXCPDEBUG
argument_list|(
operator|(
name|LOG_INFO
operator|,
literal|"ipxcp: received Complete request"
operator|)
argument_list|)
expr_stmt|;
name|orc
operator|=
name|CONFREJ
expr_stmt|;
break|break;
block|}
name|endswitch
label|:
name|IPXCPDEBUG
argument_list|(
operator|(
name|LOG_INFO
operator|,
literal|" (%s)\n"
operator|,
name|CODENAME
argument_list|(
name|orc
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|orc
operator|==
name|CONFACK
operator|&&
comment|/* Good CI */
name|rc
operator|!=
name|CONFACK
condition|)
comment|/*  but prior CI wasnt? */
continue|continue;
comment|/* Don't send this one */
if|if
condition|(
name|orc
operator|==
name|CONFNAK
condition|)
block|{
comment|/* Nak this CI? */
if|if
condition|(
name|reject_if_disagree
condition|)
comment|/* Getting fed up with sending NAKs? */
name|orc
operator|=
name|CONFREJ
expr_stmt|;
comment|/* Get tough if so */
if|if
condition|(
name|rc
operator|==
name|CONFREJ
condition|)
comment|/* Rejecting prior CI? */
continue|continue;
comment|/* Don't send this one */
if|if
condition|(
name|rc
operator|==
name|CONFACK
condition|)
block|{
comment|/* Ack'd all prior CIs? */
name|rc
operator|=
name|CONFNAK
expr_stmt|;
comment|/* Not anymore... */
name|ucp
operator|=
name|inp
expr_stmt|;
comment|/* Backup */
block|}
block|}
if|if
condition|(
name|orc
operator|==
name|CONFREJ
operator|&&
comment|/* Reject this CI */
name|rc
operator|!=
name|CONFREJ
condition|)
block|{
comment|/*  but no prior ones? */
name|rc
operator|=
name|CONFREJ
expr_stmt|;
name|ucp
operator|=
name|inp
expr_stmt|;
comment|/* Backup */
block|}
comment|/* Need to move CI? */
if|if
condition|(
name|ucp
operator|!=
name|cip
condition|)
name|BCOPY
argument_list|(
name|cip
argument_list|,
name|ucp
argument_list|,
name|cilen
argument_list|)
expr_stmt|;
comment|/* Move it */
comment|/* Update output pointer */
name|INCPTR
argument_list|(
name|cilen
argument_list|,
name|ucp
argument_list|)
expr_stmt|;
block|}
comment|/*      * If we aren't rejecting this packet, and we want to negotiate      * their address, and they didn't send their address, then we      * send a NAK with a IPX_NODE_NUMBER option appended. We assume the      * input buffer is long enough that we can append the extra      * option safely.      */
if|if
condition|(
name|rc
operator|!=
name|CONFREJ
operator|&&
operator|!
name|ho
operator|->
name|neg_node
operator|&&
name|wo
operator|->
name|req_nn
operator|&&
operator|!
name|reject_if_disagree
condition|)
block|{
if|if
condition|(
name|rc
operator|==
name|CONFACK
condition|)
block|{
name|rc
operator|=
name|CONFNAK
expr_stmt|;
name|wo
operator|->
name|req_nn
operator|=
literal|0
expr_stmt|;
comment|/* don't ask again */
name|ucp
operator|=
name|inp
expr_stmt|;
comment|/* reset pointer */
block|}
if|if
condition|(
name|zero_node
argument_list|(
name|wo
operator|->
name|his_node
argument_list|)
condition|)
name|inc_node
argument_list|(
name|wo
operator|->
name|his_node
argument_list|)
expr_stmt|;
name|PUTCHAR
argument_list|(
name|IPX_NODE_NUMBER
argument_list|,
name|ucp
argument_list|)
expr_stmt|;
name|PUTCHAR
argument_list|(
name|CILEN_NODEN
argument_list|,
name|ucp
argument_list|)
expr_stmt|;
name|copy_node
argument_list|(
name|wo
operator|->
name|his_node
argument_list|,
name|ucp
argument_list|)
expr_stmt|;
name|INCPTR
argument_list|(
sizeof|sizeof
argument_list|(
name|wo
operator|->
name|his_node
argument_list|)
argument_list|,
name|ucp
argument_list|)
expr_stmt|;
block|}
operator|*
name|len
operator|=
name|ucp
operator|-
name|inp
expr_stmt|;
comment|/* Compute output length */
name|IPXCPDEBUG
argument_list|(
operator|(
name|LOG_INFO
operator|,
literal|"ipxcp: returning Configure-%s"
operator|,
name|CODENAME
argument_list|(
name|rc
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
comment|/* Return final code */
block|}
end_function

begin_comment
comment|/*  * ipxcp_up - IPXCP has come UP.  *  * Configure the IP network interface appropriately and bring it up.  */
end_comment

begin_function
specifier|static
name|void
name|ipxcp_up
parameter_list|(
name|f
parameter_list|)
name|fsm
modifier|*
name|f
decl_stmt|;
block|{
name|int
name|unit
init|=
name|f
operator|->
name|unit
decl_stmt|;
name|IPXCPDEBUG
argument_list|(
operator|(
name|LOG_INFO
operator|,
literal|"ipxcp: up"
operator|)
argument_list|)
expr_stmt|;
comment|/* The default router protocol is RIP/SAP. */
if|if
condition|(
name|ho
operator|->
name|router
operator|==
literal|0
condition|)
name|ho
operator|->
name|router
operator|=
name|BIT
argument_list|(
name|RIP_SAP
argument_list|)
expr_stmt|;
if|if
condition|(
name|go
operator|->
name|router
operator|==
literal|0
condition|)
name|go
operator|->
name|router
operator|=
name|BIT
argument_list|(
name|RIP_SAP
argument_list|)
expr_stmt|;
comment|/* Fetch the network number */
if|if
condition|(
operator|!
name|ho
operator|->
name|neg_nn
condition|)
name|ho
operator|->
name|his_network
operator|=
name|wo
operator|->
name|his_network
expr_stmt|;
if|if
condition|(
operator|!
name|ho
operator|->
name|neg_node
condition|)
name|copy_node
argument_list|(
name|wo
operator|->
name|his_node
argument_list|,
name|ho
operator|->
name|his_node
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wo
operator|->
name|neg_node
operator|&&
operator|!
name|go
operator|->
name|neg_node
condition|)
name|copy_node
argument_list|(
name|wo
operator|->
name|our_node
argument_list|,
name|go
operator|->
name|our_node
argument_list|)
expr_stmt|;
if|if
condition|(
name|zero_node
argument_list|(
name|go
operator|->
name|our_node
argument_list|)
condition|)
block|{
specifier|static
name|char
name|errmsg
index|[]
init|=
literal|"Could not determine local IPX node address"
decl_stmt|;
name|IPXCPDEBUG
argument_list|(
operator|(
name|LOG_ERR
operator|,
name|errmsg
operator|)
argument_list|)
expr_stmt|;
name|ipxcp_close
argument_list|(
name|f
operator|->
name|unit
argument_list|,
name|errmsg
argument_list|)
expr_stmt|;
return|return;
block|}
name|go
operator|->
name|network
operator|=
name|go
operator|->
name|our_network
expr_stmt|;
if|if
condition|(
name|ho
operator|->
name|his_network
operator|!=
literal|0
operator|&&
name|ho
operator|->
name|his_network
operator|>
name|go
operator|->
name|network
condition|)
name|go
operator|->
name|network
operator|=
name|ho
operator|->
name|his_network
expr_stmt|;
if|if
condition|(
name|go
operator|->
name|network
operator|==
literal|0
condition|)
block|{
specifier|static
name|char
name|errmsg
index|[]
init|=
literal|"Can not determine network number"
decl_stmt|;
name|IPXCPDEBUG
argument_list|(
operator|(
name|LOG_ERR
operator|,
name|errmsg
operator|)
argument_list|)
expr_stmt|;
name|ipxcp_close
argument_list|(
name|unit
argument_list|,
name|errmsg
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* bring the interface up */
if|if
condition|(
operator|!
name|sifup
argument_list|(
name|unit
argument_list|)
condition|)
block|{
name|IPXCPDEBUG
argument_list|(
operator|(
name|LOG_WARNING
operator|,
literal|"sifup failed"
operator|)
argument_list|)
expr_stmt|;
name|ipxcp_close
argument_list|(
name|unit
argument_list|,
literal|"Interface configuration failed"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* set the network number for IPX */
if|if
condition|(
operator|!
name|sipxfaddr
argument_list|(
name|unit
argument_list|,
name|go
operator|->
name|network
argument_list|,
name|go
operator|->
name|our_node
argument_list|)
condition|)
block|{
name|IPXCPDEBUG
argument_list|(
operator|(
name|LOG_WARNING
operator|,
literal|"sipxfaddr failed"
operator|)
argument_list|)
expr_stmt|;
name|ipxcp_close
argument_list|(
name|unit
argument_list|,
literal|"Interface configuration failed"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/*      * Execute the ipx-up script, like this:      *	/etc/ppp/ipx-up interface tty speed local-IPX remote-IPX      */
name|ipxcp_script
argument_list|(
name|f
argument_list|,
name|_PATH_IPXUP
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * ipxcp_down - IPXCP has gone DOWN.  *  * Take the IP network interface down, clear its addresses  * and delete routes through it.  */
end_comment

begin_function
specifier|static
name|void
name|ipxcp_down
parameter_list|(
name|f
parameter_list|)
name|fsm
modifier|*
name|f
decl_stmt|;
block|{
name|IPXCPDEBUG
argument_list|(
operator|(
name|LOG_INFO
operator|,
literal|"ipxcp: down"
operator|)
argument_list|)
expr_stmt|;
name|cipxfaddr
argument_list|(
name|f
operator|->
name|unit
argument_list|)
expr_stmt|;
name|sifdown
argument_list|(
name|f
operator|->
name|unit
argument_list|)
expr_stmt|;
name|ipxcp_script
argument_list|(
name|f
argument_list|,
name|_PATH_IPXDOWN
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * ipxcp_script - Execute a script with arguments  * interface-name tty-name speed local-IPX remote-IPX networks.  */
end_comment

begin_function
specifier|static
name|void
name|ipxcp_script
parameter_list|(
name|f
parameter_list|,
name|script
parameter_list|)
name|fsm
modifier|*
name|f
decl_stmt|;
name|char
modifier|*
name|script
decl_stmt|;
block|{
name|char
name|strspeed
index|[
literal|32
index|]
decl_stmt|,
name|strlocal
index|[
literal|32
index|]
decl_stmt|,
name|strremote
index|[
literal|32
index|]
decl_stmt|;
name|char
name|strnetwork
index|[
literal|32
index|]
decl_stmt|,
name|strpid
index|[
literal|32
index|]
decl_stmt|;
name|char
modifier|*
name|argv
index|[
literal|14
index|]
decl_stmt|,
name|strproto_lcl
index|[
literal|32
index|]
decl_stmt|,
name|strproto_rmt
index|[
literal|32
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|strpid
argument_list|,
literal|"%d"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|strspeed
argument_list|,
literal|"%d"
argument_list|,
name|baud_rate
argument_list|)
expr_stmt|;
name|strproto_lcl
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|go
operator|->
name|neg_router
operator|&&
operator|(
operator|(
name|go
operator|->
name|router
operator|&
name|BIT
argument_list|(
name|IPX_NONE
argument_list|)
operator|)
operator|==
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|go
operator|->
name|router
operator|&
name|BIT
argument_list|(
name|RIP_SAP
argument_list|)
condition|)
name|strcpy
argument_list|(
name|strproto_lcl
argument_list|,
literal|"RIP "
argument_list|)
expr_stmt|;
if|if
condition|(
name|go
operator|->
name|router
operator|&
name|BIT
argument_list|(
name|NLSP
argument_list|)
condition|)
name|strcat
argument_list|(
name|strproto_lcl
argument_list|,
literal|"NLSP "
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|strproto_lcl
index|[
literal|0
index|]
operator|==
literal|'\0'
condition|)
name|strcpy
argument_list|(
name|strproto_lcl
argument_list|,
literal|"NONE "
argument_list|)
expr_stmt|;
name|strproto_lcl
index|[
name|strlen
argument_list|(
name|strproto_lcl
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|strproto_rmt
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|ho
operator|->
name|neg_router
operator|&&
operator|(
operator|(
name|ho
operator|->
name|router
operator|&
name|BIT
argument_list|(
name|IPX_NONE
argument_list|)
operator|)
operator|==
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|ho
operator|->
name|router
operator|&
name|BIT
argument_list|(
name|RIP_SAP
argument_list|)
condition|)
name|strcpy
argument_list|(
name|strproto_rmt
argument_list|,
literal|"RIP "
argument_list|)
expr_stmt|;
if|if
condition|(
name|ho
operator|->
name|router
operator|&
name|BIT
argument_list|(
name|NLSP
argument_list|)
condition|)
name|strcat
argument_list|(
name|strproto_rmt
argument_list|,
literal|"NLSP "
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|strproto_rmt
index|[
literal|0
index|]
operator|==
literal|'\0'
condition|)
name|strcpy
argument_list|(
name|strproto_rmt
argument_list|,
literal|"NONE "
argument_list|)
expr_stmt|;
name|strproto_rmt
index|[
name|strlen
argument_list|(
name|strproto_rmt
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|strcpy
argument_list|(
name|strnetwork
argument_list|,
name|ipx_ntoa
argument_list|(
name|go
operator|->
name|network
argument_list|)
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|strlocal
argument_list|,
literal|"%02X%02X%02X%02X%02X%02X"
argument_list|,
name|NODE
argument_list|(
name|go
operator|->
name|our_node
argument_list|)
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|strremote
argument_list|,
literal|"%02X%02X%02X%02X%02X%02X"
argument_list|,
name|NODE
argument_list|(
name|ho
operator|->
name|his_node
argument_list|)
argument_list|)
expr_stmt|;
name|argv
index|[
literal|0
index|]
operator|=
name|script
expr_stmt|;
name|argv
index|[
literal|1
index|]
operator|=
name|ifname
expr_stmt|;
name|argv
index|[
literal|2
index|]
operator|=
name|devnam
expr_stmt|;
name|argv
index|[
literal|3
index|]
operator|=
name|strspeed
expr_stmt|;
name|argv
index|[
literal|4
index|]
operator|=
name|strnetwork
expr_stmt|;
name|argv
index|[
literal|5
index|]
operator|=
name|strlocal
expr_stmt|;
name|argv
index|[
literal|6
index|]
operator|=
name|strremote
expr_stmt|;
name|argv
index|[
literal|7
index|]
operator|=
name|strproto_lcl
expr_stmt|;
name|argv
index|[
literal|8
index|]
operator|=
name|strproto_rmt
expr_stmt|;
name|argv
index|[
literal|9
index|]
operator|=
name|go
operator|->
name|name
expr_stmt|;
name|argv
index|[
literal|10
index|]
operator|=
name|ho
operator|->
name|name
expr_stmt|;
name|argv
index|[
literal|11
index|]
operator|=
name|ipparam
expr_stmt|;
name|argv
index|[
literal|12
index|]
operator|=
name|strpid
expr_stmt|;
name|argv
index|[
literal|13
index|]
operator|=
name|NULL
expr_stmt|;
name|run_program
argument_list|(
name|script
argument_list|,
name|argv
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * ipxcp_printpkt - print the contents of an IPXCP packet.  */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|ipxcp_codenames
index|[]
init|=
block|{
literal|"ConfReq"
block|,
literal|"ConfAck"
block|,
literal|"ConfNak"
block|,
literal|"ConfRej"
block|,
literal|"TermReq"
block|,
literal|"TermAck"
block|,
literal|"CodeRej"
block|}
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|int
name|ipxcp_printpkt
parameter_list|(
name|p
parameter_list|,
name|plen
parameter_list|,
name|printer
parameter_list|,
name|arg
parameter_list|)
name|u_char
modifier|*
name|p
decl_stmt|;
name|int
name|plen
decl_stmt|;
function_decl|void
parameter_list|(
function_decl|*printer
end_function_decl

begin_expr_stmt
unit|)
name|__P
argument_list|(
operator|(
name|void
operator|*
operator|,
name|char
operator|*
operator|,
operator|...
operator|)
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|void
modifier|*
name|arg
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|code
decl_stmt|,
name|id
decl_stmt|,
name|len
decl_stmt|,
name|olen
decl_stmt|;
name|u_char
modifier|*
name|pstart
decl_stmt|,
modifier|*
name|optend
decl_stmt|;
name|u_short
name|cishort
decl_stmt|;
name|u_int32_t
name|cilong
decl_stmt|;
if|if
condition|(
name|plen
operator|<
name|HEADERLEN
condition|)
return|return
literal|0
return|;
name|pstart
operator|=
name|p
expr_stmt|;
name|GETCHAR
argument_list|(
name|code
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|GETCHAR
argument_list|(
name|id
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|GETSHORT
argument_list|(
name|len
argument_list|,
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
name|HEADERLEN
operator|||
name|len
operator|>
name|plen
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|code
operator|>=
literal|1
operator|&&
name|code
operator|<=
sizeof|sizeof
argument_list|(
name|ipxcp_codenames
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
condition|)
name|printer
argument_list|(
name|arg
argument_list|,
literal|" %s"
argument_list|,
name|ipxcp_codenames
index|[
name|code
operator|-
literal|1
index|]
argument_list|)
expr_stmt|;
else|else
name|printer
argument_list|(
name|arg
argument_list|,
literal|" code=0x%x"
argument_list|,
name|code
argument_list|)
expr_stmt|;
name|printer
argument_list|(
name|arg
argument_list|,
literal|" id=0x%x"
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|len
operator|-=
name|HEADERLEN
expr_stmt|;
switch|switch
condition|(
name|code
condition|)
block|{
case|case
name|CONFREQ
case|:
case|case
name|CONFACK
case|:
case|case
name|CONFNAK
case|:
case|case
name|CONFREJ
case|:
comment|/* print option list */
while|while
condition|(
name|len
operator|>=
literal|2
condition|)
block|{
name|GETCHAR
argument_list|(
name|code
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|GETCHAR
argument_list|(
name|olen
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|p
operator|-=
literal|2
expr_stmt|;
if|if
condition|(
name|olen
operator|<
name|CILEN_VOID
operator|||
name|olen
operator|>
name|len
condition|)
block|{
break|break;
block|}
name|printer
argument_list|(
name|arg
argument_list|,
literal|"<"
argument_list|)
expr_stmt|;
name|len
operator|-=
name|olen
expr_stmt|;
name|optend
operator|=
name|p
operator|+
name|olen
expr_stmt|;
switch|switch
condition|(
name|code
condition|)
block|{
case|case
name|IPX_NETWORK_NUMBER
case|:
if|if
condition|(
name|olen
operator|==
name|CILEN_NETN
condition|)
block|{
name|p
operator|+=
literal|2
expr_stmt|;
name|GETLONG
argument_list|(
name|cilong
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|printer
argument_list|(
name|arg
argument_list|,
literal|"network %s"
argument_list|,
name|ipx_ntoa
argument_list|(
name|cilong
argument_list|)
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|IPX_NODE_NUMBER
case|:
if|if
condition|(
name|olen
operator|==
name|CILEN_NODEN
condition|)
block|{
name|p
operator|+=
literal|2
expr_stmt|;
name|printer
argument_list|(
name|arg
argument_list|,
literal|"node "
argument_list|)
expr_stmt|;
while|while
condition|(
name|p
operator|<
name|optend
condition|)
block|{
name|GETCHAR
argument_list|(
name|code
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|printer
argument_list|(
name|arg
argument_list|,
literal|"%.2x"
argument_list|,
operator|(
name|int
operator|)
operator|(
name|unsigned
name|int
operator|)
operator|(
name|unsigned
name|char
operator|)
name|code
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
case|case
name|IPX_COMPRESSION_PROTOCOL
case|:
if|if
condition|(
name|olen
operator|==
name|CILEN_COMPRESS
condition|)
block|{
name|p
operator|+=
literal|2
expr_stmt|;
name|GETSHORT
argument_list|(
name|cishort
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|printer
argument_list|(
name|arg
argument_list|,
literal|"compression %d"
argument_list|,
operator|(
name|int
operator|)
name|cishort
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|IPX_ROUTER_PROTOCOL
case|:
if|if
condition|(
name|olen
operator|==
name|CILEN_PROTOCOL
condition|)
block|{
name|p
operator|+=
literal|2
expr_stmt|;
name|GETSHORT
argument_list|(
name|cishort
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|printer
argument_list|(
name|arg
argument_list|,
literal|"router proto %d"
argument_list|,
operator|(
name|int
operator|)
name|cishort
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|IPX_ROUTER_NAME
case|:
if|if
condition|(
name|olen
operator|>=
name|CILEN_NAME
condition|)
block|{
name|p
operator|+=
literal|2
expr_stmt|;
name|printer
argument_list|(
name|arg
argument_list|,
literal|"router name \""
argument_list|)
expr_stmt|;
while|while
condition|(
name|p
operator|<
name|optend
condition|)
block|{
name|GETCHAR
argument_list|(
name|code
argument_list|,
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|code
operator|>=
literal|0x20
operator|&&
name|code
operator|<=
literal|0x7E
condition|)
name|printer
argument_list|(
name|arg
argument_list|,
literal|"%c"
argument_list|,
operator|(
name|int
operator|)
operator|(
name|unsigned
name|int
operator|)
operator|(
name|unsigned
name|char
operator|)
name|code
argument_list|)
expr_stmt|;
else|else
name|printer
argument_list|(
name|arg
argument_list|,
literal|" \\%.2x"
argument_list|,
operator|(
name|int
operator|)
operator|(
name|unsigned
name|int
operator|)
operator|(
name|unsigned
name|char
operator|)
name|code
argument_list|)
expr_stmt|;
block|}
name|printer
argument_list|(
name|arg
argument_list|,
literal|"\""
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|IPX_COMPLETE
case|:
if|if
condition|(
name|olen
operator|==
name|CILEN_COMPLETE
condition|)
block|{
name|p
operator|+=
literal|2
expr_stmt|;
name|printer
argument_list|(
name|arg
argument_list|,
literal|"complete"
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
break|break;
block|}
while|while
condition|(
name|p
operator|<
name|optend
condition|)
block|{
name|GETCHAR
argument_list|(
name|code
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|printer
argument_list|(
name|arg
argument_list|,
literal|" %.2x"
argument_list|,
operator|(
name|int
operator|)
operator|(
name|unsigned
name|int
operator|)
operator|(
name|unsigned
name|char
operator|)
name|code
argument_list|)
expr_stmt|;
block|}
name|printer
argument_list|(
name|arg
argument_list|,
literal|">"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|TERMACK
case|:
case|case
name|TERMREQ
case|:
if|if
condition|(
name|len
operator|>
literal|0
operator|&&
operator|*
name|p
operator|>=
literal|' '
operator|&&
operator|*
name|p
operator|<
literal|0x7f
condition|)
block|{
name|printer
argument_list|(
name|arg
argument_list|,
literal|" "
argument_list|)
expr_stmt|;
name|print_string
argument_list|(
name|p
argument_list|,
name|len
argument_list|,
name|printer
argument_list|,
name|arg
argument_list|)
expr_stmt|;
name|p
operator|+=
name|len
expr_stmt|;
name|len
operator|=
literal|0
expr_stmt|;
block|}
break|break;
block|}
comment|/* print the rest of the bytes in the packet */
for|for
control|(
init|;
name|len
operator|>
literal|0
condition|;
operator|--
name|len
control|)
block|{
name|GETCHAR
argument_list|(
name|code
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|printer
argument_list|(
name|arg
argument_list|,
literal|" %.2x"
argument_list|,
operator|(
name|int
operator|)
operator|(
name|unsigned
name|int
operator|)
operator|(
name|unsigned
name|char
operator|)
name|code
argument_list|)
expr_stmt|;
block|}
return|return
name|p
operator|-
name|pstart
return|;
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* ifdef IPX_CHANGE */
end_comment

end_unit


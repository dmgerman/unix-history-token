begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * fsm.c - {Link, IP} Control Protocol Finite State Machine.  *  * Copyright (c) 1989 Carnegie Mellon University.  * All rights reserved.  *  * Redistribution and use in source and binary forms are permitted  * provided that the above copyright notice and this paragraph are  * duplicated in all such forms and that any documentation,  * advertising materials, and other materials related to such  * distribution and use acknowledge that the software was developed  * by Carnegie Mellon University.  The name of the  * University may not be used to endorse or promote products derived  * from this software without specific prior written permission.  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND WITHOUT ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED  * WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR A PARTICULAR PURPOSE.  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|rcsid
index|[]
init|=
literal|"$Id: fsm.c,v 1.8 1994/11/10 01:52:05 paulus Exp $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * TODO:  * Randomize fsm id on link/init.  * Deal with variable outgoing MTU.  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<syslog.h>
end_include

begin_include
include|#
directive|include
file|"pppd.h"
end_include

begin_include
include|#
directive|include
file|"fsm.h"
end_include

begin_function_decl
specifier|extern
name|char
modifier|*
name|proto_name
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|void
name|fsm_timeout
name|__P
argument_list|(
operator|(
name|caddr_t
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|fsm_rconfreq
name|__P
argument_list|(
operator|(
name|fsm
operator|*
operator|,
name|int
operator|,
name|u_char
operator|*
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|fsm_rconfack
name|__P
argument_list|(
operator|(
name|fsm
operator|*
operator|,
name|int
operator|,
name|u_char
operator|*
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|fsm_rconfnakrej
name|__P
argument_list|(
operator|(
name|fsm
operator|*
operator|,
name|int
operator|,
name|int
operator|,
name|u_char
operator|*
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|fsm_rtermreq
name|__P
argument_list|(
operator|(
name|fsm
operator|*
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|fsm_rtermack
name|__P
argument_list|(
operator|(
name|fsm
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|fsm_rcoderej
name|__P
argument_list|(
operator|(
name|fsm
operator|*
operator|,
name|u_char
operator|*
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|fsm_sconfreq
name|__P
argument_list|(
operator|(
name|fsm
operator|*
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|PROTO_NAME
parameter_list|(
name|f
parameter_list|)
value|((f)->callbacks->proto_name)
end_define

begin_decl_stmt
name|int
name|peer_mru
index|[
name|NUM_PPP
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * fsm_init - Initialize fsm.  *  * Initialize fsm state.  */
end_comment

begin_function
name|void
name|fsm_init
parameter_list|(
name|f
parameter_list|)
name|fsm
modifier|*
name|f
decl_stmt|;
block|{
name|f
operator|->
name|state
operator|=
name|INITIAL
expr_stmt|;
name|f
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
name|f
operator|->
name|id
operator|=
literal|0
expr_stmt|;
comment|/* XXX Start with random id? */
name|f
operator|->
name|timeouttime
operator|=
name|DEFTIMEOUT
expr_stmt|;
name|f
operator|->
name|maxconfreqtransmits
operator|=
name|DEFMAXCONFREQS
expr_stmt|;
name|f
operator|->
name|maxtermtransmits
operator|=
name|DEFMAXTERMREQS
expr_stmt|;
name|f
operator|->
name|maxnakloops
operator|=
name|DEFMAXNAKLOOPS
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * fsm_lowerup - The lower layer is up.  */
end_comment

begin_function
name|void
name|fsm_lowerup
parameter_list|(
name|f
parameter_list|)
name|fsm
modifier|*
name|f
decl_stmt|;
block|{
switch|switch
condition|(
name|f
operator|->
name|state
condition|)
block|{
case|case
name|INITIAL
case|:
name|f
operator|->
name|state
operator|=
name|CLOSED
expr_stmt|;
break|break;
case|case
name|STARTING
case|:
if|if
condition|(
name|f
operator|->
name|flags
operator|&
name|OPT_SILENT
condition|)
name|f
operator|->
name|state
operator|=
name|STOPPED
expr_stmt|;
else|else
block|{
comment|/* Send an initial configure-request */
name|fsm_sconfreq
argument_list|(
name|f
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|f
operator|->
name|state
operator|=
name|REQSENT
expr_stmt|;
block|}
break|break;
default|default:
name|FSMDEBUG
argument_list|(
operator|(
name|LOG_INFO
operator|,
literal|"%s: Up event in state %d!"
operator|,
name|PROTO_NAME
argument_list|(
name|f
argument_list|)
operator|,
name|f
operator|->
name|state
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * fsm_lowerdown - The lower layer is down.  *  * Cancel all timeouts and inform upper layers.  */
end_comment

begin_function
name|void
name|fsm_lowerdown
parameter_list|(
name|f
parameter_list|)
name|fsm
modifier|*
name|f
decl_stmt|;
block|{
switch|switch
condition|(
name|f
operator|->
name|state
condition|)
block|{
case|case
name|CLOSED
case|:
name|f
operator|->
name|state
operator|=
name|INITIAL
expr_stmt|;
break|break;
case|case
name|STOPPED
case|:
name|f
operator|->
name|state
operator|=
name|STARTING
expr_stmt|;
if|if
condition|(
name|f
operator|->
name|callbacks
operator|->
name|starting
condition|)
call|(
modifier|*
name|f
operator|->
name|callbacks
operator|->
name|starting
call|)
argument_list|(
name|f
argument_list|)
expr_stmt|;
break|break;
case|case
name|CLOSING
case|:
name|f
operator|->
name|state
operator|=
name|INITIAL
expr_stmt|;
name|UNTIMEOUT
argument_list|(
name|fsm_timeout
argument_list|,
operator|(
name|caddr_t
operator|)
name|f
argument_list|)
expr_stmt|;
comment|/* Cancel timeout */
break|break;
case|case
name|STOPPING
case|:
case|case
name|REQSENT
case|:
case|case
name|ACKRCVD
case|:
case|case
name|ACKSENT
case|:
name|f
operator|->
name|state
operator|=
name|STARTING
expr_stmt|;
name|UNTIMEOUT
argument_list|(
name|fsm_timeout
argument_list|,
operator|(
name|caddr_t
operator|)
name|f
argument_list|)
expr_stmt|;
comment|/* Cancel timeout */
break|break;
case|case
name|OPENED
case|:
if|if
condition|(
name|f
operator|->
name|callbacks
operator|->
name|down
condition|)
call|(
modifier|*
name|f
operator|->
name|callbacks
operator|->
name|down
call|)
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|f
operator|->
name|state
operator|=
name|STARTING
expr_stmt|;
break|break;
default|default:
name|FSMDEBUG
argument_list|(
operator|(
name|LOG_INFO
operator|,
literal|"%s: Down event in state %d!"
operator|,
name|PROTO_NAME
argument_list|(
name|f
argument_list|)
operator|,
name|f
operator|->
name|state
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * fsm_open - Link is allowed to come up.  */
end_comment

begin_function
name|void
name|fsm_open
parameter_list|(
name|f
parameter_list|)
name|fsm
modifier|*
name|f
decl_stmt|;
block|{
switch|switch
condition|(
name|f
operator|->
name|state
condition|)
block|{
case|case
name|INITIAL
case|:
name|f
operator|->
name|state
operator|=
name|STARTING
expr_stmt|;
if|if
condition|(
name|f
operator|->
name|callbacks
operator|->
name|starting
condition|)
call|(
modifier|*
name|f
operator|->
name|callbacks
operator|->
name|starting
call|)
argument_list|(
name|f
argument_list|)
expr_stmt|;
break|break;
case|case
name|CLOSED
case|:
if|if
condition|(
name|f
operator|->
name|flags
operator|&
name|OPT_SILENT
condition|)
name|f
operator|->
name|state
operator|=
name|STOPPED
expr_stmt|;
else|else
block|{
comment|/* Send an initial configure-request */
name|fsm_sconfreq
argument_list|(
name|f
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|f
operator|->
name|state
operator|=
name|REQSENT
expr_stmt|;
block|}
break|break;
case|case
name|CLOSING
case|:
name|f
operator|->
name|state
operator|=
name|STOPPING
expr_stmt|;
comment|/* fall through */
case|case
name|STOPPED
case|:
case|case
name|OPENED
case|:
if|if
condition|(
name|f
operator|->
name|flags
operator|&
name|OPT_RESTART
condition|)
block|{
name|fsm_lowerdown
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|fsm_lowerup
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
block|}
end_function

begin_comment
comment|/*  * fsm_close - Start closing connection.  *  * Cancel timeouts and either initiate close or possibly go directly to  * the CLOSED state.  */
end_comment

begin_function
name|void
name|fsm_close
parameter_list|(
name|f
parameter_list|)
name|fsm
modifier|*
name|f
decl_stmt|;
block|{
switch|switch
condition|(
name|f
operator|->
name|state
condition|)
block|{
case|case
name|STARTING
case|:
name|f
operator|->
name|state
operator|=
name|INITIAL
expr_stmt|;
break|break;
case|case
name|STOPPED
case|:
name|f
operator|->
name|state
operator|=
name|CLOSED
expr_stmt|;
break|break;
case|case
name|STOPPING
case|:
name|f
operator|->
name|state
operator|=
name|CLOSING
expr_stmt|;
break|break;
case|case
name|REQSENT
case|:
case|case
name|ACKRCVD
case|:
case|case
name|ACKSENT
case|:
case|case
name|OPENED
case|:
if|if
condition|(
name|f
operator|->
name|state
operator|!=
name|OPENED
condition|)
name|UNTIMEOUT
argument_list|(
name|fsm_timeout
argument_list|,
operator|(
name|caddr_t
operator|)
name|f
argument_list|)
expr_stmt|;
comment|/* Cancel timeout */
elseif|else
if|if
condition|(
name|f
operator|->
name|callbacks
operator|->
name|down
condition|)
call|(
modifier|*
name|f
operator|->
name|callbacks
operator|->
name|down
call|)
argument_list|(
name|f
argument_list|)
expr_stmt|;
comment|/* Inform upper layers we're down */
comment|/* Init restart counter, send Terminate-Request */
name|f
operator|->
name|retransmits
operator|=
name|f
operator|->
name|maxtermtransmits
expr_stmt|;
name|fsm_sdata
argument_list|(
name|f
argument_list|,
name|TERMREQ
argument_list|,
name|f
operator|->
name|reqid
operator|=
operator|++
name|f
operator|->
name|id
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|TIMEOUT
argument_list|(
name|fsm_timeout
argument_list|,
operator|(
name|caddr_t
operator|)
name|f
argument_list|,
name|f
operator|->
name|timeouttime
argument_list|)
expr_stmt|;
operator|--
name|f
operator|->
name|retransmits
expr_stmt|;
name|f
operator|->
name|state
operator|=
name|CLOSING
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/*  * fsm_timeout - Timeout expired.  */
end_comment

begin_function
specifier|static
name|void
name|fsm_timeout
parameter_list|(
name|arg
parameter_list|)
name|caddr_t
name|arg
decl_stmt|;
block|{
name|fsm
modifier|*
name|f
init|=
operator|(
name|fsm
operator|*
operator|)
name|arg
decl_stmt|;
switch|switch
condition|(
name|f
operator|->
name|state
condition|)
block|{
case|case
name|CLOSING
case|:
case|case
name|STOPPING
case|:
if|if
condition|(
name|f
operator|->
name|retransmits
operator|<=
literal|0
condition|)
block|{
comment|/* 	     * We've waited for an ack long enough.  Peer probably heard us. 	     */
name|f
operator|->
name|state
operator|=
operator|(
name|f
operator|->
name|state
operator|==
name|CLOSING
operator|)
condition|?
name|CLOSED
else|:
name|STOPPED
expr_stmt|;
if|if
condition|(
name|f
operator|->
name|callbacks
operator|->
name|finished
condition|)
call|(
modifier|*
name|f
operator|->
name|callbacks
operator|->
name|finished
call|)
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Send Terminate-Request */
name|fsm_sdata
argument_list|(
name|f
argument_list|,
name|TERMREQ
argument_list|,
name|f
operator|->
name|reqid
operator|=
operator|++
name|f
operator|->
name|id
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|TIMEOUT
argument_list|(
name|fsm_timeout
argument_list|,
operator|(
name|caddr_t
operator|)
name|f
argument_list|,
name|f
operator|->
name|timeouttime
argument_list|)
expr_stmt|;
operator|--
name|f
operator|->
name|retransmits
expr_stmt|;
block|}
break|break;
case|case
name|REQSENT
case|:
case|case
name|ACKRCVD
case|:
case|case
name|ACKSENT
case|:
if|if
condition|(
name|f
operator|->
name|retransmits
operator|<=
literal|0
condition|)
block|{
name|syslog
argument_list|(
name|LOG_WARNING
argument_list|,
literal|"%s: timeout sending Config-Requests"
argument_list|,
name|PROTO_NAME
argument_list|(
name|f
argument_list|)
argument_list|)
expr_stmt|;
name|f
operator|->
name|state
operator|=
name|STOPPED
expr_stmt|;
if|if
condition|(
operator|(
name|f
operator|->
name|flags
operator|&
name|OPT_PASSIVE
operator|)
operator|==
literal|0
operator|&&
name|f
operator|->
name|callbacks
operator|->
name|finished
condition|)
call|(
modifier|*
name|f
operator|->
name|callbacks
operator|->
name|finished
call|)
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Retransmit the configure-request */
if|if
condition|(
name|f
operator|->
name|callbacks
operator|->
name|retransmit
condition|)
call|(
modifier|*
name|f
operator|->
name|callbacks
operator|->
name|retransmit
call|)
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|fsm_sconfreq
argument_list|(
name|f
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* Re-send Configure-Request */
if|if
condition|(
name|f
operator|->
name|state
operator|==
name|ACKRCVD
condition|)
name|f
operator|->
name|state
operator|=
name|REQSENT
expr_stmt|;
block|}
break|break;
default|default:
name|FSMDEBUG
argument_list|(
operator|(
name|LOG_INFO
operator|,
literal|"%s: Timeout event in state %d!"
operator|,
name|PROTO_NAME
argument_list|(
name|f
argument_list|)
operator|,
name|f
operator|->
name|state
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * fsm_input - Input packet.  */
end_comment

begin_function
name|void
name|fsm_input
parameter_list|(
name|f
parameter_list|,
name|inpacket
parameter_list|,
name|l
parameter_list|)
name|fsm
modifier|*
name|f
decl_stmt|;
name|u_char
modifier|*
name|inpacket
decl_stmt|;
name|int
name|l
decl_stmt|;
block|{
name|u_char
modifier|*
name|inp
decl_stmt|,
modifier|*
name|outp
decl_stmt|;
name|u_char
name|code
decl_stmt|,
name|id
decl_stmt|;
name|int
name|len
decl_stmt|;
comment|/*      * Parse header (code, id and length).      * If packet too short, drop it.      */
name|inp
operator|=
name|inpacket
expr_stmt|;
if|if
condition|(
name|l
operator|<
name|HEADERLEN
condition|)
block|{
name|FSMDEBUG
argument_list|(
operator|(
name|LOG_WARNING
operator|,
literal|"fsm_input(%x): Rcvd short header."
operator|,
name|f
operator|->
name|protocol
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|GETCHAR
argument_list|(
name|code
argument_list|,
name|inp
argument_list|)
expr_stmt|;
name|GETCHAR
argument_list|(
name|id
argument_list|,
name|inp
argument_list|)
expr_stmt|;
name|GETSHORT
argument_list|(
name|len
argument_list|,
name|inp
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
name|HEADERLEN
condition|)
block|{
name|FSMDEBUG
argument_list|(
operator|(
name|LOG_INFO
operator|,
literal|"fsm_input(%x): Rcvd illegal length."
operator|,
name|f
operator|->
name|protocol
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|len
operator|>
name|l
condition|)
block|{
name|FSMDEBUG
argument_list|(
operator|(
name|LOG_INFO
operator|,
literal|"fsm_input(%x): Rcvd short packet."
operator|,
name|f
operator|->
name|protocol
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|len
operator|-=
name|HEADERLEN
expr_stmt|;
comment|/* subtract header length */
if|if
condition|(
name|f
operator|->
name|state
operator|==
name|INITIAL
operator|||
name|f
operator|->
name|state
operator|==
name|STARTING
condition|)
block|{
name|FSMDEBUG
argument_list|(
operator|(
name|LOG_INFO
operator|,
literal|"fsm_input(%x): Rcvd packet in state %d."
operator|,
name|f
operator|->
name|protocol
operator|,
name|f
operator|->
name|state
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/*      * Action depends on code.      */
switch|switch
condition|(
name|code
condition|)
block|{
case|case
name|CONFREQ
case|:
name|fsm_rconfreq
argument_list|(
name|f
argument_list|,
name|id
argument_list|,
name|inp
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|CONFACK
case|:
name|fsm_rconfack
argument_list|(
name|f
argument_list|,
name|id
argument_list|,
name|inp
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|CONFNAK
case|:
case|case
name|CONFREJ
case|:
name|fsm_rconfnakrej
argument_list|(
name|f
argument_list|,
name|code
argument_list|,
name|id
argument_list|,
name|inp
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|TERMREQ
case|:
name|fsm_rtermreq
argument_list|(
name|f
argument_list|,
name|id
argument_list|)
expr_stmt|;
break|break;
case|case
name|TERMACK
case|:
name|fsm_rtermack
argument_list|(
name|f
argument_list|)
expr_stmt|;
break|break;
case|case
name|CODEREJ
case|:
name|fsm_rcoderej
argument_list|(
name|f
argument_list|,
name|inp
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
default|default:
if|if
condition|(
operator|!
name|f
operator|->
name|callbacks
operator|->
name|extcode
operator|||
operator|!
call|(
modifier|*
name|f
operator|->
name|callbacks
operator|->
name|extcode
call|)
argument_list|(
name|f
argument_list|,
name|code
argument_list|,
name|id
argument_list|,
name|inp
argument_list|,
name|len
argument_list|)
condition|)
name|fsm_sdata
argument_list|(
name|f
argument_list|,
name|CODEREJ
argument_list|,
operator|++
name|f
operator|->
name|id
argument_list|,
name|inpacket
argument_list|,
name|len
operator|+
name|HEADERLEN
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/*  * fsm_rconfreq - Receive Configure-Request.  */
end_comment

begin_function
specifier|static
name|void
name|fsm_rconfreq
parameter_list|(
name|f
parameter_list|,
name|id
parameter_list|,
name|inp
parameter_list|,
name|len
parameter_list|)
name|fsm
modifier|*
name|f
decl_stmt|;
name|u_char
name|id
decl_stmt|;
name|u_char
modifier|*
name|inp
decl_stmt|;
name|int
name|len
decl_stmt|;
block|{
name|u_char
modifier|*
name|outp
decl_stmt|;
name|int
name|code
decl_stmt|,
name|reject_if_disagree
decl_stmt|;
name|FSMDEBUG
argument_list|(
operator|(
name|LOG_INFO
operator|,
literal|"fsm_rconfreq(%s): Rcvd id %d."
operator|,
name|PROTO_NAME
argument_list|(
name|f
argument_list|)
operator|,
name|id
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|f
operator|->
name|state
condition|)
block|{
case|case
name|CLOSED
case|:
comment|/* Go away, we're closed */
name|fsm_sdata
argument_list|(
name|f
argument_list|,
name|TERMACK
argument_list|,
name|id
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
case|case
name|CLOSING
case|:
case|case
name|STOPPING
case|:
return|return;
case|case
name|OPENED
case|:
comment|/* Go down and restart negotiation */
if|if
condition|(
name|f
operator|->
name|callbacks
operator|->
name|down
condition|)
call|(
modifier|*
name|f
operator|->
name|callbacks
operator|->
name|down
call|)
argument_list|(
name|f
argument_list|)
expr_stmt|;
comment|/* Inform upper layers */
name|fsm_sconfreq
argument_list|(
name|f
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Send initial Configure-Request */
break|break;
case|case
name|STOPPED
case|:
comment|/* Negotiation started by our peer */
name|fsm_sconfreq
argument_list|(
name|f
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Send initial Configure-Request */
name|f
operator|->
name|state
operator|=
name|REQSENT
expr_stmt|;
break|break;
block|}
comment|/*      * Pass the requested configuration options      * to protocol-specific code for checking.      */
if|if
condition|(
name|f
operator|->
name|callbacks
operator|->
name|reqci
condition|)
block|{
comment|/* Check CI */
name|reject_if_disagree
operator|=
operator|(
name|f
operator|->
name|nakloops
operator|>=
name|f
operator|->
name|maxnakloops
operator|)
expr_stmt|;
name|code
operator|=
call|(
modifier|*
name|f
operator|->
name|callbacks
operator|->
name|reqci
call|)
argument_list|(
name|f
argument_list|,
name|inp
argument_list|,
operator|&
name|len
argument_list|,
name|reject_if_disagree
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|len
condition|)
name|code
operator|=
name|CONFREJ
expr_stmt|;
comment|/* Reject all CI */
else|else
name|code
operator|=
name|CONFACK
expr_stmt|;
comment|/* send the Ack, Nak or Rej to the peer */
name|fsm_sdata
argument_list|(
name|f
argument_list|,
name|code
argument_list|,
name|id
argument_list|,
name|inp
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|code
operator|==
name|CONFACK
condition|)
block|{
if|if
condition|(
name|f
operator|->
name|state
operator|==
name|ACKRCVD
condition|)
block|{
name|UNTIMEOUT
argument_list|(
name|fsm_timeout
argument_list|,
operator|(
name|caddr_t
operator|)
name|f
argument_list|)
expr_stmt|;
comment|/* Cancel timeout */
name|f
operator|->
name|state
operator|=
name|OPENED
expr_stmt|;
if|if
condition|(
name|f
operator|->
name|callbacks
operator|->
name|up
condition|)
call|(
modifier|*
name|f
operator|->
name|callbacks
operator|->
name|up
call|)
argument_list|(
name|f
argument_list|)
expr_stmt|;
comment|/* Inform upper layers */
block|}
else|else
name|f
operator|->
name|state
operator|=
name|ACKSENT
expr_stmt|;
name|f
operator|->
name|nakloops
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
comment|/* we sent CONFACK or CONFREJ */
if|if
condition|(
name|f
operator|->
name|state
operator|!=
name|ACKRCVD
condition|)
name|f
operator|->
name|state
operator|=
name|REQSENT
expr_stmt|;
if|if
condition|(
name|code
operator|==
name|CONFNAK
condition|)
operator|++
name|f
operator|->
name|nakloops
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * fsm_rconfack - Receive Configure-Ack.  */
end_comment

begin_function
specifier|static
name|void
name|fsm_rconfack
parameter_list|(
name|f
parameter_list|,
name|id
parameter_list|,
name|inp
parameter_list|,
name|len
parameter_list|)
name|fsm
modifier|*
name|f
decl_stmt|;
name|int
name|id
decl_stmt|;
name|u_char
modifier|*
name|inp
decl_stmt|;
name|int
name|len
decl_stmt|;
block|{
name|FSMDEBUG
argument_list|(
operator|(
name|LOG_INFO
operator|,
literal|"fsm_rconfack(%s): Rcvd id %d."
operator|,
name|PROTO_NAME
argument_list|(
name|f
argument_list|)
operator|,
name|id
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|id
operator|!=
name|f
operator|->
name|reqid
operator|||
name|f
operator|->
name|seen_ack
condition|)
comment|/* Expected id? */
return|return;
comment|/* Nope, toss... */
if|if
condition|(
operator|!
operator|(
name|f
operator|->
name|callbacks
operator|->
name|ackci
condition|?
call|(
modifier|*
name|f
operator|->
name|callbacks
operator|->
name|ackci
call|)
argument_list|(
name|f
argument_list|,
name|inp
argument_list|,
name|len
argument_list|)
else|:
operator|(
name|len
operator|==
literal|0
operator|)
operator|)
condition|)
block|{
comment|/* Ack is bad - ignore it */
name|FSMDEBUG
argument_list|(
operator|(
name|LOG_INFO
operator|,
literal|"%s: received bad Ack (length %d)"
operator|,
name|PROTO_NAME
argument_list|(
name|f
argument_list|)
operator|,
name|len
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|f
operator|->
name|seen_ack
operator|=
literal|1
expr_stmt|;
switch|switch
condition|(
name|f
operator|->
name|state
condition|)
block|{
case|case
name|CLOSED
case|:
case|case
name|STOPPED
case|:
name|fsm_sdata
argument_list|(
name|f
argument_list|,
name|TERMACK
argument_list|,
name|id
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|REQSENT
case|:
name|f
operator|->
name|state
operator|=
name|ACKRCVD
expr_stmt|;
name|f
operator|->
name|retransmits
operator|=
name|f
operator|->
name|maxconfreqtransmits
expr_stmt|;
break|break;
case|case
name|ACKRCVD
case|:
comment|/* Huh? an extra valid Ack? oh well... */
name|UNTIMEOUT
argument_list|(
name|fsm_timeout
argument_list|,
operator|(
name|caddr_t
operator|)
name|f
argument_list|)
expr_stmt|;
comment|/* Cancel timeout */
name|fsm_sconfreq
argument_list|(
name|f
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|f
operator|->
name|state
operator|=
name|REQSENT
expr_stmt|;
break|break;
case|case
name|ACKSENT
case|:
name|UNTIMEOUT
argument_list|(
name|fsm_timeout
argument_list|,
operator|(
name|caddr_t
operator|)
name|f
argument_list|)
expr_stmt|;
comment|/* Cancel timeout */
name|f
operator|->
name|state
operator|=
name|OPENED
expr_stmt|;
name|f
operator|->
name|retransmits
operator|=
name|f
operator|->
name|maxconfreqtransmits
expr_stmt|;
if|if
condition|(
name|f
operator|->
name|callbacks
operator|->
name|up
condition|)
call|(
modifier|*
name|f
operator|->
name|callbacks
operator|->
name|up
call|)
argument_list|(
name|f
argument_list|)
expr_stmt|;
comment|/* Inform upper layers */
break|break;
case|case
name|OPENED
case|:
comment|/* Go down and restart negotiation */
if|if
condition|(
name|f
operator|->
name|callbacks
operator|->
name|down
condition|)
call|(
modifier|*
name|f
operator|->
name|callbacks
operator|->
name|down
call|)
argument_list|(
name|f
argument_list|)
expr_stmt|;
comment|/* Inform upper layers */
name|fsm_sconfreq
argument_list|(
name|f
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Send initial Configure-Request */
name|f
operator|->
name|state
operator|=
name|REQSENT
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/*  * fsm_rconfnakrej - Receive Configure-Nak or Configure-Reject.  */
end_comment

begin_function
specifier|static
name|void
name|fsm_rconfnakrej
parameter_list|(
name|f
parameter_list|,
name|code
parameter_list|,
name|id
parameter_list|,
name|inp
parameter_list|,
name|len
parameter_list|)
name|fsm
modifier|*
name|f
decl_stmt|;
name|int
name|code
decl_stmt|,
name|id
decl_stmt|;
name|u_char
modifier|*
name|inp
decl_stmt|;
name|int
name|len
decl_stmt|;
block|{
name|int
function_decl|(
modifier|*
name|proc
function_decl|)
parameter_list|()
function_decl|;
name|FSMDEBUG
argument_list|(
operator|(
name|LOG_INFO
operator|,
literal|"fsm_rconfnakrej(%s): Rcvd id %d."
operator|,
name|PROTO_NAME
argument_list|(
name|f
argument_list|)
operator|,
name|id
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|id
operator|!=
name|f
operator|->
name|reqid
operator|||
name|f
operator|->
name|seen_ack
condition|)
comment|/* Expected id? */
return|return;
comment|/* Nope, toss... */
name|proc
operator|=
operator|(
name|code
operator|==
name|CONFNAK
operator|)
condition|?
name|f
operator|->
name|callbacks
operator|->
name|nakci
else|:
name|f
operator|->
name|callbacks
operator|->
name|rejci
expr_stmt|;
if|if
condition|(
operator|!
name|proc
operator|||
operator|!
name|proc
argument_list|(
name|f
argument_list|,
name|inp
argument_list|,
name|len
argument_list|)
condition|)
block|{
comment|/* Nak/reject is bad - ignore it */
name|FSMDEBUG
argument_list|(
operator|(
name|LOG_INFO
operator|,
literal|"%s: received bad %s (length %d)"
operator|,
name|PROTO_NAME
argument_list|(
name|f
argument_list|)
operator|,
operator|(
name|code
operator|==
name|CONFNAK
condition|?
literal|"Nak"
else|:
literal|"reject"
operator|)
operator|,
name|len
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|f
operator|->
name|seen_ack
operator|=
literal|1
expr_stmt|;
switch|switch
condition|(
name|f
operator|->
name|state
condition|)
block|{
case|case
name|CLOSED
case|:
case|case
name|STOPPED
case|:
name|fsm_sdata
argument_list|(
name|f
argument_list|,
name|TERMACK
argument_list|,
name|id
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|REQSENT
case|:
case|case
name|ACKSENT
case|:
comment|/* They didn't agree to what we wanted - try another request */
name|UNTIMEOUT
argument_list|(
name|fsm_timeout
argument_list|,
operator|(
name|caddr_t
operator|)
name|f
argument_list|)
expr_stmt|;
comment|/* Cancel timeout */
name|fsm_sconfreq
argument_list|(
name|f
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Send Configure-Request */
break|break;
case|case
name|ACKRCVD
case|:
comment|/* Got a Nak/reject when we had already had an Ack?? oh well... */
name|UNTIMEOUT
argument_list|(
name|fsm_timeout
argument_list|,
operator|(
name|caddr_t
operator|)
name|f
argument_list|)
expr_stmt|;
comment|/* Cancel timeout */
name|fsm_sconfreq
argument_list|(
name|f
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|f
operator|->
name|state
operator|=
name|REQSENT
expr_stmt|;
break|break;
case|case
name|OPENED
case|:
comment|/* Go down and restart negotiation */
if|if
condition|(
name|f
operator|->
name|callbacks
operator|->
name|down
condition|)
call|(
modifier|*
name|f
operator|->
name|callbacks
operator|->
name|down
call|)
argument_list|(
name|f
argument_list|)
expr_stmt|;
comment|/* Inform upper layers */
name|fsm_sconfreq
argument_list|(
name|f
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Send initial Configure-Request */
name|f
operator|->
name|state
operator|=
name|REQSENT
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/*  * fsm_rtermreq - Receive Terminate-Req.  */
end_comment

begin_function
specifier|static
name|void
name|fsm_rtermreq
parameter_list|(
name|f
parameter_list|,
name|id
parameter_list|)
name|fsm
modifier|*
name|f
decl_stmt|;
name|int
name|id
decl_stmt|;
block|{
name|FSMDEBUG
argument_list|(
operator|(
name|LOG_INFO
operator|,
literal|"fsm_rtermreq(%s): Rcvd id %d."
operator|,
name|PROTO_NAME
argument_list|(
name|f
argument_list|)
operator|,
name|id
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|f
operator|->
name|state
condition|)
block|{
case|case
name|ACKRCVD
case|:
case|case
name|ACKSENT
case|:
name|f
operator|->
name|state
operator|=
name|REQSENT
expr_stmt|;
comment|/* Start over but keep trying */
break|break;
case|case
name|OPENED
case|:
name|syslog
argument_list|(
name|LOG_INFO
argument_list|,
literal|"%s terminated at peer's request"
argument_list|,
name|PROTO_NAME
argument_list|(
name|f
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|->
name|callbacks
operator|->
name|down
condition|)
call|(
modifier|*
name|f
operator|->
name|callbacks
operator|->
name|down
call|)
argument_list|(
name|f
argument_list|)
expr_stmt|;
comment|/* Inform upper layers */
name|f
operator|->
name|retransmits
operator|=
literal|0
expr_stmt|;
name|f
operator|->
name|state
operator|=
name|STOPPING
expr_stmt|;
name|TIMEOUT
argument_list|(
name|fsm_timeout
argument_list|,
operator|(
name|caddr_t
operator|)
name|f
argument_list|,
name|f
operator|->
name|timeouttime
argument_list|)
expr_stmt|;
break|break;
block|}
name|fsm_sdata
argument_list|(
name|f
argument_list|,
name|TERMACK
argument_list|,
name|id
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * fsm_rtermack - Receive Terminate-Ack.  */
end_comment

begin_function
specifier|static
name|void
name|fsm_rtermack
parameter_list|(
name|f
parameter_list|)
name|fsm
modifier|*
name|f
decl_stmt|;
block|{
name|FSMDEBUG
argument_list|(
operator|(
name|LOG_INFO
operator|,
literal|"fsm_rtermack(%s)."
operator|,
name|PROTO_NAME
argument_list|(
name|f
argument_list|)
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|f
operator|->
name|state
condition|)
block|{
case|case
name|CLOSING
case|:
name|UNTIMEOUT
argument_list|(
name|fsm_timeout
argument_list|,
operator|(
name|caddr_t
operator|)
name|f
argument_list|)
expr_stmt|;
name|f
operator|->
name|state
operator|=
name|CLOSED
expr_stmt|;
if|if
condition|(
name|f
operator|->
name|callbacks
operator|->
name|finished
condition|)
call|(
modifier|*
name|f
operator|->
name|callbacks
operator|->
name|finished
call|)
argument_list|(
name|f
argument_list|)
expr_stmt|;
break|break;
case|case
name|STOPPING
case|:
name|UNTIMEOUT
argument_list|(
name|fsm_timeout
argument_list|,
operator|(
name|caddr_t
operator|)
name|f
argument_list|)
expr_stmt|;
name|f
operator|->
name|state
operator|=
name|STOPPED
expr_stmt|;
if|if
condition|(
name|f
operator|->
name|callbacks
operator|->
name|finished
condition|)
call|(
modifier|*
name|f
operator|->
name|callbacks
operator|->
name|finished
call|)
argument_list|(
name|f
argument_list|)
expr_stmt|;
break|break;
case|case
name|ACKRCVD
case|:
name|f
operator|->
name|state
operator|=
name|REQSENT
expr_stmt|;
break|break;
case|case
name|OPENED
case|:
if|if
condition|(
name|f
operator|->
name|callbacks
operator|->
name|down
condition|)
call|(
modifier|*
name|f
operator|->
name|callbacks
operator|->
name|down
call|)
argument_list|(
name|f
argument_list|)
expr_stmt|;
comment|/* Inform upper layers */
name|fsm_sconfreq
argument_list|(
name|f
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/*  * fsm_rcoderej - Receive an Code-Reject.  */
end_comment

begin_function
specifier|static
name|void
name|fsm_rcoderej
parameter_list|(
name|f
parameter_list|,
name|inp
parameter_list|,
name|len
parameter_list|)
name|fsm
modifier|*
name|f
decl_stmt|;
name|u_char
modifier|*
name|inp
decl_stmt|;
name|int
name|len
decl_stmt|;
block|{
name|u_char
name|code
decl_stmt|,
name|id
decl_stmt|;
name|FSMDEBUG
argument_list|(
operator|(
name|LOG_INFO
operator|,
literal|"fsm_rcoderej(%s)."
operator|,
name|PROTO_NAME
argument_list|(
name|f
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
name|HEADERLEN
condition|)
block|{
name|FSMDEBUG
argument_list|(
operator|(
name|LOG_INFO
operator|,
literal|"fsm_rcoderej: Rcvd short Code-Reject packet!"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|GETCHAR
argument_list|(
name|code
argument_list|,
name|inp
argument_list|)
expr_stmt|;
name|GETCHAR
argument_list|(
name|id
argument_list|,
name|inp
argument_list|)
expr_stmt|;
name|syslog
argument_list|(
name|LOG_WARNING
argument_list|,
literal|"%s: Rcvd Code-Reject for code %d, id %d"
argument_list|,
name|PROTO_NAME
argument_list|(
name|f
argument_list|)
argument_list|,
name|code
argument_list|,
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|->
name|state
operator|==
name|ACKRCVD
condition|)
name|f
operator|->
name|state
operator|=
name|REQSENT
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * fsm_protreject - Peer doesn't speak this protocol.  *  * Treat this as a catastrophic error (RXJ-).  */
end_comment

begin_function
name|void
name|fsm_protreject
parameter_list|(
name|f
parameter_list|)
name|fsm
modifier|*
name|f
decl_stmt|;
block|{
switch|switch
condition|(
name|f
operator|->
name|state
condition|)
block|{
case|case
name|CLOSING
case|:
name|UNTIMEOUT
argument_list|(
name|fsm_timeout
argument_list|,
operator|(
name|caddr_t
operator|)
name|f
argument_list|)
expr_stmt|;
comment|/* Cancel timeout */
comment|/* fall through */
case|case
name|CLOSED
case|:
name|f
operator|->
name|state
operator|=
name|CLOSED
expr_stmt|;
if|if
condition|(
name|f
operator|->
name|callbacks
operator|->
name|finished
condition|)
call|(
modifier|*
name|f
operator|->
name|callbacks
operator|->
name|finished
call|)
argument_list|(
name|f
argument_list|)
expr_stmt|;
break|break;
case|case
name|STOPPING
case|:
case|case
name|REQSENT
case|:
case|case
name|ACKRCVD
case|:
case|case
name|ACKSENT
case|:
name|UNTIMEOUT
argument_list|(
name|fsm_timeout
argument_list|,
operator|(
name|caddr_t
operator|)
name|f
argument_list|)
expr_stmt|;
comment|/* Cancel timeout */
comment|/* fall through */
case|case
name|STOPPED
case|:
name|f
operator|->
name|state
operator|=
name|STOPPED
expr_stmt|;
if|if
condition|(
name|f
operator|->
name|callbacks
operator|->
name|finished
condition|)
call|(
modifier|*
name|f
operator|->
name|callbacks
operator|->
name|finished
call|)
argument_list|(
name|f
argument_list|)
expr_stmt|;
break|break;
case|case
name|OPENED
case|:
if|if
condition|(
name|f
operator|->
name|callbacks
operator|->
name|down
condition|)
call|(
modifier|*
name|f
operator|->
name|callbacks
operator|->
name|down
call|)
argument_list|(
name|f
argument_list|)
expr_stmt|;
comment|/* Init restart counter, send Terminate-Request */
name|f
operator|->
name|retransmits
operator|=
name|f
operator|->
name|maxtermtransmits
expr_stmt|;
name|fsm_sdata
argument_list|(
name|f
argument_list|,
name|TERMREQ
argument_list|,
name|f
operator|->
name|reqid
operator|=
operator|++
name|f
operator|->
name|id
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|TIMEOUT
argument_list|(
name|fsm_timeout
argument_list|,
operator|(
name|caddr_t
operator|)
name|f
argument_list|,
name|f
operator|->
name|timeouttime
argument_list|)
expr_stmt|;
operator|--
name|f
operator|->
name|retransmits
expr_stmt|;
name|f
operator|->
name|state
operator|=
name|STOPPING
expr_stmt|;
break|break;
default|default:
name|FSMDEBUG
argument_list|(
operator|(
name|LOG_INFO
operator|,
literal|"%s: Protocol-reject event in state %d!"
operator|,
name|PROTO_NAME
argument_list|(
name|f
argument_list|)
operator|,
name|f
operator|->
name|state
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * fsm_sconfreq - Send a Configure-Request.  */
end_comment

begin_function
specifier|static
name|void
name|fsm_sconfreq
parameter_list|(
name|f
parameter_list|,
name|retransmit
parameter_list|)
name|fsm
modifier|*
name|f
decl_stmt|;
name|int
name|retransmit
decl_stmt|;
block|{
name|u_char
modifier|*
name|outp
decl_stmt|;
name|int
name|outlen
decl_stmt|,
name|cilen
decl_stmt|;
if|if
condition|(
name|f
operator|->
name|state
operator|!=
name|REQSENT
operator|&&
name|f
operator|->
name|state
operator|!=
name|ACKRCVD
operator|&&
name|f
operator|->
name|state
operator|!=
name|ACKSENT
condition|)
block|{
comment|/* Not currently negotiating - reset options */
if|if
condition|(
name|f
operator|->
name|callbacks
operator|->
name|resetci
condition|)
call|(
modifier|*
name|f
operator|->
name|callbacks
operator|->
name|resetci
call|)
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|f
operator|->
name|nakloops
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|retransmit
condition|)
block|{
comment|/* New request - reset retransmission counter, use new ID */
name|f
operator|->
name|retransmits
operator|=
name|f
operator|->
name|maxconfreqtransmits
expr_stmt|;
name|f
operator|->
name|reqid
operator|=
operator|++
name|f
operator|->
name|id
expr_stmt|;
block|}
name|f
operator|->
name|seen_ack
operator|=
literal|0
expr_stmt|;
comment|/*      * Make up the request packet      */
name|outp
operator|=
name|outpacket_buf
operator|+
name|PPP_HDRLEN
operator|+
name|HEADERLEN
expr_stmt|;
if|if
condition|(
name|f
operator|->
name|callbacks
operator|->
name|cilen
operator|&&
name|f
operator|->
name|callbacks
operator|->
name|addci
condition|)
block|{
name|cilen
operator|=
call|(
modifier|*
name|f
operator|->
name|callbacks
operator|->
name|cilen
call|)
argument_list|(
name|f
argument_list|)
expr_stmt|;
if|if
condition|(
name|cilen
operator|>
name|peer_mru
index|[
name|f
operator|->
name|unit
index|]
operator|-
name|HEADERLEN
condition|)
name|cilen
operator|=
name|peer_mru
index|[
name|f
operator|->
name|unit
index|]
operator|-
name|HEADERLEN
expr_stmt|;
if|if
condition|(
name|f
operator|->
name|callbacks
operator|->
name|addci
condition|)
call|(
modifier|*
name|f
operator|->
name|callbacks
operator|->
name|addci
call|)
argument_list|(
name|f
argument_list|,
name|outp
argument_list|,
operator|&
name|cilen
argument_list|)
expr_stmt|;
block|}
else|else
name|cilen
operator|=
literal|0
expr_stmt|;
comment|/* send the request to our peer */
name|fsm_sdata
argument_list|(
name|f
argument_list|,
name|CONFREQ
argument_list|,
name|f
operator|->
name|reqid
argument_list|,
name|outp
argument_list|,
name|cilen
argument_list|)
expr_stmt|;
comment|/* start the retransmit timer */
operator|--
name|f
operator|->
name|retransmits
expr_stmt|;
name|TIMEOUT
argument_list|(
name|fsm_timeout
argument_list|,
operator|(
name|caddr_t
operator|)
name|f
argument_list|,
name|f
operator|->
name|timeouttime
argument_list|)
expr_stmt|;
name|FSMDEBUG
argument_list|(
operator|(
name|LOG_INFO
operator|,
literal|"%s: sending Configure-Request, id %d"
operator|,
name|PROTO_NAME
argument_list|(
name|f
argument_list|)
operator|,
name|f
operator|->
name|reqid
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * fsm_sdata - Send some data.  *  * Used for all packets sent to our peer by this module.  */
end_comment

begin_function
name|void
name|fsm_sdata
parameter_list|(
name|f
parameter_list|,
name|code
parameter_list|,
name|id
parameter_list|,
name|data
parameter_list|,
name|datalen
parameter_list|)
name|fsm
modifier|*
name|f
decl_stmt|;
name|u_char
name|code
decl_stmt|,
name|id
decl_stmt|;
name|u_char
modifier|*
name|data
decl_stmt|;
name|int
name|datalen
decl_stmt|;
block|{
name|u_char
modifier|*
name|outp
decl_stmt|;
name|int
name|outlen
decl_stmt|;
comment|/* Adjust length to be smaller than MTU */
name|outp
operator|=
name|outpacket_buf
expr_stmt|;
if|if
condition|(
name|datalen
operator|>
name|peer_mru
index|[
name|f
operator|->
name|unit
index|]
operator|-
name|HEADERLEN
condition|)
name|datalen
operator|=
name|peer_mru
index|[
name|f
operator|->
name|unit
index|]
operator|-
name|HEADERLEN
expr_stmt|;
if|if
condition|(
name|datalen
operator|&&
name|data
operator|!=
name|outp
operator|+
name|PPP_HDRLEN
operator|+
name|HEADERLEN
condition|)
name|BCOPY
argument_list|(
name|data
argument_list|,
name|outp
operator|+
name|PPP_HDRLEN
operator|+
name|HEADERLEN
argument_list|,
name|datalen
argument_list|)
expr_stmt|;
name|outlen
operator|=
name|datalen
operator|+
name|HEADERLEN
expr_stmt|;
name|MAKEHEADER
argument_list|(
name|outp
argument_list|,
name|f
operator|->
name|protocol
argument_list|)
expr_stmt|;
name|PUTCHAR
argument_list|(
name|code
argument_list|,
name|outp
argument_list|)
expr_stmt|;
name|PUTCHAR
argument_list|(
name|id
argument_list|,
name|outp
argument_list|)
expr_stmt|;
name|PUTSHORT
argument_list|(
name|outlen
argument_list|,
name|outp
argument_list|)
expr_stmt|;
name|output
argument_list|(
name|f
operator|->
name|unit
argument_list|,
name|outpacket_buf
argument_list|,
name|outlen
operator|+
name|PPP_HDRLEN
argument_list|)
expr_stmt|;
name|FSMDEBUG
argument_list|(
operator|(
name|LOG_INFO
operator|,
literal|"fsm_sdata(%s): Sent code %d, id %d."
operator|,
name|PROTO_NAME
argument_list|(
name|f
argument_list|)
operator|,
name|code
operator|,
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


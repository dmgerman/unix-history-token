begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1995 Andrew McRae.  All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. The name of the author may not be used to endorse or promote products  *    derived from this software without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
specifier|const
name|char
name|rcsid
index|[]
init|=
literal|"$FreeBSD$"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* not lint */
end_comment

begin_comment
comment|/*   * Code cleanup, bug-fix and extension  * by Tatsumi Hosokawa<hosokawa@mt.cs.keio.ac.jp>                     */
end_comment

begin_include
include|#
directive|include
file|<err.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<pccard/cardinfo.h>
end_include

begin_include
include|#
directive|include
file|<pccard/cis.h>
end_include

begin_include
include|#
directive|include
file|"readcis.h"
end_include

begin_function_decl
specifier|static
name|void
name|dump_config_map
parameter_list|(
name|struct
name|tuple
modifier|*
name|tp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dump_cis_config
parameter_list|(
name|struct
name|tuple
modifier|*
name|tp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dump_other_cond
parameter_list|(
name|u_char
modifier|*
name|p
parameter_list|,
name|int
name|len
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dump_device_desc
parameter_list|(
name|u_char
modifier|*
name|p
parameter_list|,
name|int
name|len
parameter_list|,
name|char
modifier|*
name|type
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dump_info_v1
parameter_list|(
name|u_char
modifier|*
name|p
parameter_list|,
name|int
name|len
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dump_longlink_mfc
parameter_list|(
name|u_char
modifier|*
name|p
parameter_list|,
name|int
name|len
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dump_bar
parameter_list|(
name|u_char
modifier|*
name|p
parameter_list|,
name|int
name|len
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dump_device_geo
parameter_list|(
name|u_char
modifier|*
name|p
parameter_list|,
name|int
name|len
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dump_func_id
parameter_list|(
name|u_char
modifier|*
name|p
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dump_serial_ext
parameter_list|(
name|u_char
modifier|*
name|p
parameter_list|,
name|int
name|len
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dump_disk_ext
parameter_list|(
name|u_char
modifier|*
name|p
parameter_list|,
name|int
name|len
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dump_network_ext
parameter_list|(
name|u_char
modifier|*
name|p
parameter_list|,
name|int
name|len
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dump_info_v2
parameter_list|(
name|u_char
modifier|*
name|p
parameter_list|,
name|int
name|len
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dump_org
parameter_list|(
name|u_char
modifier|*
name|p
parameter_list|,
name|int
name|len
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|void
name|dumpcis
parameter_list|(
name|struct
name|cis
modifier|*
name|cp
parameter_list|)
block|{
name|struct
name|tuple
modifier|*
name|tp
decl_stmt|;
name|struct
name|tuple_list
modifier|*
name|tl
decl_stmt|;
name|int
name|count
init|=
literal|0
decl_stmt|,
name|sz
decl_stmt|,
name|ad
decl_stmt|,
name|i
decl_stmt|;
name|u_char
modifier|*
name|p
decl_stmt|;
name|int
name|func
init|=
literal|0
decl_stmt|;
for|for
control|(
name|tl
operator|=
name|cp
operator|->
name|tlist
init|;
name|tl
condition|;
name|tl
operator|=
name|tl
operator|->
name|next
control|)
for|for
control|(
name|tp
operator|=
name|tl
operator|->
name|tuples
init|;
name|tp
condition|;
name|tp
operator|=
name|tp
operator|->
name|next
control|)
block|{
name|printf
argument_list|(
literal|"Tuple #%d, code = 0x%x (%s), length = %d\n"
argument_list|,
operator|++
name|count
argument_list|,
name|tp
operator|->
name|code
argument_list|,
name|tuple_name
argument_list|(
name|tp
operator|->
name|code
argument_list|)
argument_list|,
name|tp
operator|->
name|length
argument_list|)
expr_stmt|;
name|p
operator|=
name|tp
operator|->
name|data
expr_stmt|;
name|sz
operator|=
name|tp
operator|->
name|length
expr_stmt|;
name|ad
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|sz
operator|>
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"    %03x: "
argument_list|,
name|ad
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
operator|(
name|sz
operator|<
literal|16
operator|)
condition|?
name|sz
else|:
literal|16
operator|)
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|" %02x"
argument_list|,
name|p
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|sz
operator|-=
literal|16
expr_stmt|;
name|p
operator|+=
literal|16
expr_stmt|;
name|ad
operator|+=
literal|16
expr_stmt|;
block|}
switch|switch
condition|(
name|tp
operator|->
name|code
condition|)
block|{
default|default:
break|break;
case|case
name|CIS_MEM_COMMON
case|:
comment|/* 0x01 */
name|dump_device_desc
argument_list|(
name|tp
operator|->
name|data
argument_list|,
name|tp
operator|->
name|length
argument_list|,
literal|"Common"
argument_list|)
expr_stmt|;
break|break;
case|case
name|CIS_CONF_MAP_CB
case|:
comment|/* 0x04 */
name|dump_config_map
argument_list|(
name|tp
argument_list|)
expr_stmt|;
break|break;
case|case
name|CIS_CONFIG_CB
case|:
comment|/* 0x05 */
name|dump_cis_config
argument_list|(
name|tp
argument_list|)
expr_stmt|;
break|break;
case|case
name|CIS_LONGLINK_MFC
case|:
comment|/* 0x06 */
name|dump_longlink_mfc
argument_list|(
name|tp
operator|->
name|data
argument_list|,
name|tp
operator|->
name|length
argument_list|)
expr_stmt|;
break|break;
case|case
name|CIS_BAR
case|:
comment|/* 0x07 */
name|dump_bar
argument_list|(
name|tp
operator|->
name|data
argument_list|,
name|tp
operator|->
name|length
argument_list|)
expr_stmt|;
break|break;
case|case
name|CIS_CHECKSUM
case|:
comment|/* 0x10 */
name|printf
argument_list|(
literal|"\tChecksum from offset %d, length %d, value is 0x%x\n"
argument_list|,
name|tpl16
argument_list|(
name|tp
operator|->
name|data
argument_list|)
argument_list|,
name|tpl16
argument_list|(
name|tp
operator|->
name|data
operator|+
literal|2
argument_list|)
argument_list|,
name|tp
operator|->
name|data
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|CIS_LONGLINK_A
case|:
comment|/* 0x11 */
name|printf
argument_list|(
literal|"\tLong link to attribute memory, address 0x%x\n"
argument_list|,
name|tpl32
argument_list|(
name|tp
operator|->
name|data
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|CIS_LONGLINK_C
case|:
comment|/* 0x12 */
name|printf
argument_list|(
literal|"\tLong link to common memory, address 0x%x\n"
argument_list|,
name|tpl32
argument_list|(
name|tp
operator|->
name|data
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|CIS_INFO_V1
case|:
comment|/* 0x15 */
name|dump_info_v1
argument_list|(
name|tp
operator|->
name|data
argument_list|,
name|tp
operator|->
name|length
argument_list|)
expr_stmt|;
break|break;
case|case
name|CIS_ALTSTR
case|:
comment|/* 0x16 */
break|break;
case|case
name|CIS_MEM_ATTR
case|:
comment|/* 0x17 */
name|dump_device_desc
argument_list|(
name|tp
operator|->
name|data
argument_list|,
name|tp
operator|->
name|length
argument_list|,
literal|"Attribute"
argument_list|)
expr_stmt|;
break|break;
case|case
name|CIS_JEDEC_C
case|:
comment|/* 0x18 */
case|case
name|CIS_JEDEC_A
case|:
comment|/* 0x19 */
break|break;
case|case
name|CIS_CONF_MAP
case|:
comment|/* 0x1A */
name|dump_config_map
argument_list|(
name|tp
argument_list|)
expr_stmt|;
break|break;
case|case
name|CIS_CONFIG
case|:
comment|/* 0x1B */
name|dump_cis_config
argument_list|(
name|tp
argument_list|)
expr_stmt|;
break|break;
case|case
name|CIS_DEVICE_OC
case|:
comment|/* 0x1C */
case|case
name|CIS_DEVICE_OA
case|:
comment|/* 0x1D */
name|dump_other_cond
argument_list|(
name|tp
operator|->
name|data
argument_list|,
name|tp
operator|->
name|length
argument_list|)
expr_stmt|;
break|break;
case|case
name|CIS_DEVICEGEO
case|:
comment|/* 0x1E */
case|case
name|CIS_DEVICEGEO_A
case|:
comment|/* 0x1F */
name|dump_device_geo
argument_list|(
name|tp
operator|->
name|data
argument_list|,
name|tp
operator|->
name|length
argument_list|)
expr_stmt|;
break|break;
case|case
name|CIS_MANUF_ID
case|:
comment|/* 0x20 */
name|printf
argument_list|(
literal|"\tPCMCIA ID = 0x%x, OEM ID = 0x%x\n"
argument_list|,
name|tpl16
argument_list|(
name|tp
operator|->
name|data
argument_list|)
argument_list|,
name|tpl16
argument_list|(
name|tp
operator|->
name|data
operator|+
literal|2
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|CIS_FUNC_ID
case|:
comment|/* 0x21 */
name|func
operator|=
name|tp
operator|->
name|data
index|[
literal|0
index|]
expr_stmt|;
name|dump_func_id
argument_list|(
name|tp
operator|->
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|CIS_FUNC_EXT
case|:
comment|/* 0x22 */
switch|switch
condition|(
name|func
condition|)
block|{
case|case
literal|2
case|:
name|dump_serial_ext
argument_list|(
name|tp
operator|->
name|data
argument_list|,
name|tp
operator|->
name|length
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|dump_disk_ext
argument_list|(
name|tp
operator|->
name|data
argument_list|,
name|tp
operator|->
name|length
argument_list|)
expr_stmt|;
break|break;
case|case
literal|6
case|:
name|dump_network_ext
argument_list|(
name|tp
operator|->
name|data
argument_list|,
name|tp
operator|->
name|length
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|CIS_VERS_2
case|:
comment|/* 0x40 */
name|dump_info_v2
argument_list|(
name|tp
operator|->
name|data
argument_list|,
name|tp
operator|->
name|length
argument_list|)
expr_stmt|;
break|break;
case|case
name|CIS_ORG
case|:
comment|/* 0x46 */
name|dump_org
argument_list|(
name|tp
operator|->
name|data
argument_list|,
name|tp
operator|->
name|length
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
end_function

begin_comment
comment|/*  *	CIS_CONF_MAP   : Dump configuration map tuple.  *	CIS_CONF_MAP_CB: Dump configuration map for CardBus  */
end_comment

begin_function
specifier|static
name|void
name|dump_config_map
parameter_list|(
name|struct
name|tuple
modifier|*
name|tp
parameter_list|)
block|{
name|u_char
modifier|*
name|p
init|=
name|tp
operator|->
name|data
decl_stmt|,
name|x
decl_stmt|;
name|int
name|rlen
decl_stmt|,
name|mlen
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
name|rlen
operator|=
operator|(
name|p
index|[
literal|0
index|]
operator|&
literal|3
operator|)
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|tp
operator|->
name|code
operator|==
name|CIS_CONF_MAP
condition|)
name|mlen
operator|=
operator|(
operator|(
name|p
index|[
literal|0
index|]
operator|>>
literal|2
operator|)
operator|&
literal|3
operator|)
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|tp
operator|->
name|length
operator|<
name|rlen
operator|+
name|mlen
operator|+
literal|2
condition|)
block|{
name|printf
argument_list|(
literal|"\tWrong length for configuration map tuple\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|printf
argument_list|(
literal|"\tReg len = %d, config register addr = 0x%x, last config = 0x%x\n"
argument_list|,
name|rlen
argument_list|,
name|parse_num
argument_list|(
name|rlen
operator||
literal|0x10
argument_list|,
name|p
operator|+
literal|2
argument_list|,
operator|&
name|p
argument_list|,
literal|0
argument_list|)
argument_list|,
name|p
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|mlen
condition|)
block|{
name|printf
argument_list|(
literal|"\tRegisters: "
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|mlen
condition|;
name|i
operator|++
operator|,
name|p
operator|++
control|)
block|{
for|for
control|(
name|x
operator|=
literal|0x1
init|;
name|x
condition|;
name|x
operator|<<=
literal|1
control|)
name|printf
argument_list|(
literal|"%c"
argument_list|,
name|x
operator|&
operator|*
name|p
condition|?
literal|'X'
else|:
literal|'-'
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|' '
argument_list|)
expr_stmt|;
block|}
block|}
name|i
operator|=
name|tp
operator|->
name|length
operator|-
operator|(
name|rlen
operator|+
name|mlen
operator|+
literal|2
operator|)
expr_stmt|;
if|if
condition|(
name|i
condition|)
block|{
if|if
condition|(
operator|!
name|mlen
condition|)
name|putchar
argument_list|(
literal|'\t'
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%d bytes in subtuples"
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mlen
operator|||
name|i
condition|)
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  *	Dump power descriptor.  *	call from dump_cis_config()  */
end_comment

begin_function
specifier|static
name|int
name|print_pwr_desc
parameter_list|(
name|u_char
modifier|*
name|p
parameter_list|)
block|{
name|int
name|len
init|=
literal|1
decl_stmt|,
name|i
decl_stmt|;
name|u_char
name|mask
decl_stmt|;
name|char
modifier|*
modifier|*
name|expp
decl_stmt|;
specifier|static
name|char
modifier|*
name|pname
index|[]
init|=
block|{
literal|"Nominal operating supply voltage"
block|,
literal|"Minimum operating supply voltage"
block|,
literal|"Maximum operating supply voltage"
block|,
literal|"Continuous supply current"
block|,
literal|"Max current average over 1 second"
block|,
literal|"Max current average over 10 ms"
block|,
literal|"Power down supply current"
block|,
literal|"Reserved"
block|}
decl_stmt|;
specifier|static
name|char
modifier|*
name|vexp
index|[]
init|=
block|{
literal|"10uV"
block|,
literal|"100uV"
block|,
literal|"1mV"
block|,
literal|"10mV"
block|,
literal|"100mV"
block|,
literal|"1V"
block|,
literal|"10V"
block|,
literal|"100V"
block|}
decl_stmt|;
specifier|static
name|char
modifier|*
name|cexp
index|[]
init|=
block|{
literal|"10nA"
block|,
literal|"1uA"
block|,
literal|"10uA"
block|,
literal|"100uA"
block|,
literal|"1mA"
block|,
literal|"10mA"
block|,
literal|"100mA"
block|,
literal|"1A"
block|}
decl_stmt|;
specifier|static
name|char
modifier|*
name|mant
index|[]
init|=
block|{
literal|"1"
block|,
literal|"1.2"
block|,
literal|"1.3"
block|,
literal|"1.5"
block|,
literal|"2"
block|,
literal|"2.5"
block|,
literal|"3"
block|,
literal|"3.5"
block|,
literal|"4"
block|,
literal|"4.5"
block|,
literal|"5"
block|,
literal|"5.5"
block|,
literal|"6"
block|,
literal|"7"
block|,
literal|"8"
block|,
literal|"9"
block|}
decl_stmt|;
name|mask
operator|=
operator|*
name|p
operator|++
expr_stmt|;
name|expp
operator|=
name|vexp
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|mask
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
condition|)
block|{
name|len
operator|++
expr_stmt|;
if|if
condition|(
name|i
operator|>=
literal|3
condition|)
name|expp
operator|=
name|cexp
expr_stmt|;
name|printf
argument_list|(
literal|"\t\t%s: "
argument_list|,
name|pname
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s x %s"
argument_list|,
name|mant
index|[
operator|(
operator|*
name|p
operator|>>
literal|3
operator|)
operator|&
literal|0xF
index|]
argument_list|,
name|expp
index|[
operator|*
name|p
operator|&
literal|7
index|]
argument_list|)
expr_stmt|;
while|while
condition|(
operator|*
name|p
operator|&
literal|0x80
condition|)
block|{
name|len
operator|++
expr_stmt|;
name|p
operator|++
expr_stmt|;
name|printf
argument_list|(
literal|", ext = 0x%x"
argument_list|,
operator|*
name|p
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|p
operator|++
expr_stmt|;
block|}
return|return
operator|(
name|len
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  *	print_ext_speed - Print extended speed.  *	call from dump_cis_config(), dump_device_desc()  */
end_comment

begin_function
specifier|static
name|void
name|print_ext_speed
parameter_list|(
name|u_char
name|x
parameter_list|,
name|int
name|scale
parameter_list|)
block|{
specifier|static
name|char
modifier|*
name|mant
index|[]
init|=
block|{
literal|"Reserved"
block|,
literal|"1.0"
block|,
literal|"1.2"
block|,
literal|"1.3"
block|,
literal|"1.5"
block|,
literal|"2.0"
block|,
literal|"2.5"
block|,
literal|"3.0"
block|,
literal|"3.5"
block|,
literal|"4.0"
block|,
literal|"4.5"
block|,
literal|"5.0"
block|,
literal|"5.5"
block|,
literal|"6.0"
block|,
literal|"7.0"
block|,
literal|"8.0"
block|}
decl_stmt|;
specifier|static
name|char
modifier|*
name|exp
index|[]
init|=
block|{
literal|"1 ns"
block|,
literal|"10 ns"
block|,
literal|"100 ns"
block|,
literal|"1 us"
block|,
literal|"10 us"
block|,
literal|"100 us"
block|,
literal|"1 ms"
block|,
literal|"10 ms"
block|}
decl_stmt|;
specifier|static
name|char
modifier|*
name|scale_name
index|[]
init|=
block|{
literal|"None"
block|,
literal|"10"
block|,
literal|"100"
block|,
literal|"1,000"
block|,
literal|"10,000"
block|,
literal|"100,000"
block|,
literal|"1,000,000"
block|,
literal|"10,000,000"
block|}
decl_stmt|;
name|printf
argument_list|(
literal|"Speed = %s x %s"
argument_list|,
name|mant
index|[
operator|(
name|x
operator|>>
literal|3
operator|)
operator|&
literal|0xF
index|]
argument_list|,
name|exp
index|[
name|x
operator|&
literal|7
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|scale
condition|)
name|printf
argument_list|(
literal|", scaled by %s"
argument_list|,
name|scale_name
index|[
name|scale
operator|&
literal|7
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  *	Print variable length value.  *	call from print_io_map(), print_mem_map()  */
end_comment

begin_function
specifier|static
name|int
name|print_num
parameter_list|(
name|int
name|sz
parameter_list|,
name|char
modifier|*
name|fmt
parameter_list|,
name|u_char
modifier|*
name|p
parameter_list|,
name|int
name|ofs
parameter_list|)
block|{
switch|switch
condition|(
name|sz
condition|)
block|{
case|case
literal|0
case|:
case|case
literal|0x10
case|:
return|return
literal|0
return|;
case|case
literal|1
case|:
case|case
literal|0x11
case|:
name|printf
argument_list|(
name|fmt
argument_list|,
operator|*
name|p
operator|+
name|ofs
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
case|case
literal|2
case|:
case|case
literal|0x12
case|:
name|printf
argument_list|(
name|fmt
argument_list|,
name|tpl16
argument_list|(
name|p
argument_list|)
operator|+
name|ofs
argument_list|)
expr_stmt|;
return|return
literal|2
return|;
case|case
literal|0x13
case|:
name|printf
argument_list|(
name|fmt
argument_list|,
name|tpl24
argument_list|(
name|p
argument_list|)
operator|+
name|ofs
argument_list|)
expr_stmt|;
return|return
literal|3
return|;
case|case
literal|3
case|:
case|case
literal|0x14
case|:
name|printf
argument_list|(
name|fmt
argument_list|,
name|tpl32
argument_list|(
name|p
argument_list|)
operator|+
name|ofs
argument_list|)
expr_stmt|;
return|return
literal|4
return|;
block|}
name|errx
argument_list|(
literal|1
argument_list|,
literal|"print_num(0x%x): Illegal arguments"
argument_list|,
name|sz
argument_list|)
expr_stmt|;
comment|/*NOTREACHED*/
block|}
end_function

begin_comment
comment|/*  *	Print I/O mapping sub-tuple.  *	call from dump_cis_config()  */
end_comment

begin_function
specifier|static
name|u_char
modifier|*
name|print_io_map
parameter_list|(
name|u_char
modifier|*
name|p
parameter_list|,
name|u_char
modifier|*
name|q
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|u_char
name|c
decl_stmt|;
if|if
condition|(
name|q
operator|<=
name|p
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
name|CIS_IO_ADDR
argument_list|(
operator|*
name|p
argument_list|)
condition|)
comment|/* I/O address line */
name|printf
argument_list|(
literal|"\tCard decodes %d address lines"
argument_list|,
name|CIS_IO_ADDR
argument_list|(
operator|*
name|p
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"\tCard provides address decode"
argument_list|)
expr_stmt|;
comment|/* 8/16 bit I/O */
switch|switch
condition|(
operator|*
name|p
operator|&
operator|(
name|CIS_IO_8BIT
operator||
name|CIS_IO_16BIT
operator|)
condition|)
block|{
case|case
name|CIS_IO_8BIT
case|:
name|printf
argument_list|(
literal|", 8 Bit I/O only"
argument_list|)
expr_stmt|;
break|break;
case|case
name|CIS_IO_16BIT
case|:
name|printf
argument_list|(
literal|", limited 8/16 Bit I/O"
argument_list|)
expr_stmt|;
break|break;
case|case
operator|(
name|CIS_IO_8BIT
operator||
name|CIS_IO_16BIT
operator|)
case|:
name|printf
argument_list|(
literal|", full 8/16 Bit I/O"
argument_list|)
expr_stmt|;
break|break;
block|}
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
comment|/* I/O block sub-tuple exist */
if|if
condition|(
operator|*
name|p
operator|++
operator|&
name|CIS_IO_RANGE
condition|)
block|{
if|if
condition|(
name|q
operator|<=
name|p
condition|)
goto|goto
name|err
goto|;
name|c
operator|=
operator|*
name|p
operator|++
expr_stmt|;
comment|/* calculate byte length */
name|j
operator|=
name|CIS_IO_ADSZ
argument_list|(
name|c
argument_list|)
operator|+
name|CIS_IO_BLKSZ
argument_list|(
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
name|CIS_IO_ADSZ
argument_list|(
name|c
argument_list|)
operator|==
literal|3
condition|)
name|j
operator|++
expr_stmt|;
if|if
condition|(
name|CIS_IO_BLKSZ
argument_list|(
name|c
argument_list|)
operator|==
literal|3
condition|)
name|j
operator|++
expr_stmt|;
comment|/* number of I/O block sub-tuples */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
name|CIS_IO_BLKS
argument_list|(
name|c
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|q
operator|-
name|p
operator|<
name|j
condition|)
goto|goto
name|err
goto|;
name|printf
argument_list|(
literal|"\t\tI/O address # %d: "
argument_list|,
name|i
operator|+
literal|1
argument_list|)
expr_stmt|;
comment|/* start block address */
name|p
operator|+=
name|print_num
argument_list|(
name|CIS_IO_ADSZ
argument_list|(
name|c
argument_list|)
argument_list|,
literal|"block start = 0x%x"
argument_list|,
name|p
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* block size */
name|p
operator|+=
name|print_num
argument_list|(
name|CIS_IO_BLKSZ
argument_list|(
name|c
argument_list|)
argument_list|,
literal|" block length = 0x%x"
argument_list|,
name|p
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|p
return|;
name|err
label|:
comment|/* warning */
name|printf
argument_list|(
literal|"\tWrong length for I/O mapping sub-tuple\n"
argument_list|)
expr_stmt|;
return|return
name|p
return|;
block|}
end_function

begin_comment
comment|/*  *	Print IRQ sub-tuple.  *	call from dump_cis_config()  */
end_comment

begin_function
specifier|static
name|u_char
modifier|*
name|print_irq_map
parameter_list|(
name|u_char
modifier|*
name|p
parameter_list|,
name|u_char
modifier|*
name|q
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|u_char
name|c
decl_stmt|;
if|if
condition|(
name|q
operator|<=
name|p
condition|)
goto|goto
name|err
goto|;
name|printf
argument_list|(
literal|"\t\tIRQ modes:"
argument_list|)
expr_stmt|;
name|c
operator|=
literal|' '
expr_stmt|;
if|if
condition|(
operator|*
name|p
operator|&
name|CIS_IRQ_LEVEL
condition|)
block|{
comment|/* Level triggered interrupts */
name|printf
argument_list|(
literal|" Level"
argument_list|)
expr_stmt|;
name|c
operator|=
literal|','
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|p
operator|&
name|CIS_IRQ_PULSE
condition|)
block|{
comment|/* Pulse triggered requests */
name|printf
argument_list|(
literal|"%c Pulse"
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|c
operator|=
literal|','
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|p
operator|&
name|CIS_IRQ_SHARING
condition|)
comment|/* Interrupt sharing */
name|printf
argument_list|(
literal|"%c Shared"
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
comment|/* IRQ mask values exist */
if|if
condition|(
operator|*
name|p
operator|&
name|CIS_IRQ_MASK
condition|)
block|{
if|if
condition|(
name|q
operator|-
name|p
operator|<
literal|3
condition|)
goto|goto
name|err
goto|;
name|i
operator|=
name|tpl16
argument_list|(
name|p
operator|+
literal|1
argument_list|)
expr_stmt|;
comment|/* IRQ mask */
name|printf
argument_list|(
literal|"\t\tIRQs: "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|p
operator|&
literal|1
condition|)
name|printf
argument_list|(
literal|" NMI"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|p
operator|&
literal|0x2
condition|)
name|printf
argument_list|(
literal|" IOCK"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|p
operator|&
literal|0x4
condition|)
name|printf
argument_list|(
literal|" BERR"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|p
operator|&
literal|0x8
condition|)
name|printf
argument_list|(
literal|" VEND"
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|16
condition|;
name|j
operator|++
control|)
if|if
condition|(
name|i
operator|&
operator|(
literal|1
operator|<<
name|j
operator|)
condition|)
name|printf
argument_list|(
literal|" %d"
argument_list|,
name|j
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
name|p
operator|+=
literal|3
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"\t\tIRQ level = %d\n"
argument_list|,
name|CIS_IRQ_IRQN
argument_list|(
operator|*
name|p
argument_list|)
argument_list|)
expr_stmt|;
name|p
operator|++
expr_stmt|;
block|}
return|return
name|p
return|;
name|err
label|:
comment|/* warning */
name|printf
argument_list|(
literal|"\tWrong length for IRQ sub-tuple\n"
argument_list|)
expr_stmt|;
return|return
name|p
return|;
block|}
end_function

begin_comment
comment|/*  *	Print memory map sub-tuple.  *	call from dump_cis_config()  */
end_comment

begin_function
specifier|static
name|u_char
modifier|*
name|print_mem_map
parameter_list|(
name|u_char
name|feat
parameter_list|,
name|u_char
modifier|*
name|p
parameter_list|,
name|u_char
modifier|*
name|q
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|u_char
name|c
decl_stmt|;
switch|switch
condition|(
name|CIS_FEAT_MEMORY
argument_list|(
name|feat
argument_list|)
condition|)
block|{
case|case
name|CIS_FEAT_MEM_NONE
case|:
comment|/* No memory block */
break|break;
case|case
name|CIS_FEAT_MEM_LEN
case|:
comment|/* Specify memory length */
if|if
condition|(
name|q
operator|-
name|p
operator|<
literal|2
condition|)
goto|goto
name|err
goto|;
name|printf
argument_list|(
literal|"\tMemory space length = 0x%x\n"
argument_list|,
name|tpl16
argument_list|(
name|p
argument_list|)
argument_list|)
expr_stmt|;
name|p
operator|+=
literal|2
expr_stmt|;
break|break;
case|case
name|CIS_FEAT_MEM_ADDR
case|:
comment|/* Memory address and length */
if|if
condition|(
name|q
operator|-
name|p
operator|<
literal|4
condition|)
goto|goto
name|err
goto|;
name|printf
argument_list|(
literal|"\tMemory space address = 0x%x, length = 0x%x\n"
argument_list|,
name|tpl16
argument_list|(
name|p
operator|+
literal|2
argument_list|)
argument_list|,
name|tpl16
argument_list|(
name|p
argument_list|)
argument_list|)
expr_stmt|;
name|p
operator|+=
literal|4
expr_stmt|;
break|break;
case|case
name|CIS_FEAT_MEM_WIN
case|:
comment|/* Memory descriptors. */
if|if
condition|(
name|q
operator|<=
name|p
condition|)
goto|goto
name|err
goto|;
name|c
operator|=
operator|*
name|p
operator|++
expr_stmt|;
comment|/* calculate byte length */
name|j
operator|=
name|CIS_MEM_LENSZ
argument_list|(
name|c
argument_list|)
operator|+
name|CIS_MEM_ADDRSZ
argument_list|(
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|&
name|CIS_MEM_HOST
condition|)
name|j
operator|+=
name|CIS_MEM_ADDRSZ
argument_list|(
name|c
argument_list|)
expr_stmt|;
comment|/* number of memory block */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|CIS_MEM_WINS
argument_list|(
name|c
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|q
operator|-
name|p
operator|<
name|j
condition|)
goto|goto
name|err
goto|;
name|printf
argument_list|(
literal|"\tMemory descriptor %d\n\t\t"
argument_list|,
name|i
operator|+
literal|1
argument_list|)
expr_stmt|;
comment|/* memory length */
name|p
operator|+=
name|print_num
argument_list|(
name|CIS_MEM_LENSZ
argument_list|(
name|c
argument_list|)
operator||
literal|0x10
argument_list|,
literal|" blk length = 0x%x00"
argument_list|,
name|p
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* card address */
name|p
operator|+=
name|print_num
argument_list|(
name|CIS_MEM_ADDRSZ
argument_list|(
name|c
argument_list|)
operator||
literal|0x10
argument_list|,
literal|" card addr = 0x%x00"
argument_list|,
name|p
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|&
name|CIS_MEM_HOST
condition|)
comment|/* Host address value exist */
name|p
operator|+=
name|print_num
argument_list|(
name|CIS_MEM_ADDRSZ
argument_list|(
name|c
argument_list|)
operator||
literal|0x10
argument_list|,
literal|" host addr = 0x%x00"
argument_list|,
name|p
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
return|return
name|p
return|;
name|err
label|:
comment|/* warning */
name|printf
argument_list|(
literal|"\tWrong length for memory mapping sub-tuple\n"
argument_list|)
expr_stmt|;
return|return
name|p
return|;
block|}
end_function

begin_comment
comment|/*  *	CIS_CONFIG   : Dump a config entry.  *	CIS_CONFIG_CB: Dump a configuration entry for CardBus  */
end_comment

begin_function
specifier|static
name|void
name|dump_cis_config
parameter_list|(
name|struct
name|tuple
modifier|*
name|tp
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|,
modifier|*
name|q
decl_stmt|,
name|feat
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|char
name|c
decl_stmt|;
name|p
operator|=
name|tp
operator|->
name|data
expr_stmt|;
name|q
operator|=
name|p
operator|+
name|tp
operator|->
name|length
expr_stmt|;
name|printf
argument_list|(
literal|"\tConfig index = 0x%x%s\n"
argument_list|,
operator|*
name|p
operator|&
literal|0x3F
argument_list|,
operator|*
name|p
operator|&
literal|0x40
condition|?
literal|"(default)"
else|:
literal|""
argument_list|)
expr_stmt|;
comment|/* Interface byte exists */
if|if
condition|(
name|tp
operator|->
name|code
operator|==
name|CIS_CONFIG
operator|&&
operator|(
operator|*
name|p
operator|&
literal|0x80
operator|)
condition|)
block|{
name|p
operator|++
expr_stmt|;
name|printf
argument_list|(
literal|"\tInterface byte = 0x%x "
argument_list|,
operator|*
name|p
argument_list|)
expr_stmt|;
switch|switch
condition|(
operator|*
name|p
operator|&
literal|0xF
condition|)
block|{
comment|/* Interface type */
default|default:
name|printf
argument_list|(
literal|"(reserved)"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0
case|:
name|printf
argument_list|(
literal|"(memory)"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|printf
argument_list|(
literal|"(I/O)"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
case|case
literal|5
case|:
case|case
literal|6
case|:
case|case
literal|7
case|:
case|case
literal|8
case|:
name|printf
argument_list|(
literal|"(custom)"
argument_list|)
expr_stmt|;
break|break;
block|}
name|c
operator|=
literal|' '
expr_stmt|;
if|if
condition|(
operator|*
name|p
operator|&
literal|0x10
condition|)
block|{
comment|/* Battery voltage detect */
name|printf
argument_list|(
literal|" BVD1/2 active"
argument_list|)
expr_stmt|;
name|c
operator|=
literal|','
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|p
operator|&
literal|0x20
condition|)
block|{
comment|/* Write protect active */
name|printf
argument_list|(
literal|"%c card WP active"
argument_list|,
name|c
argument_list|)
expr_stmt|;
comment|/* Write protect */
name|c
operator|=
literal|','
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|p
operator|&
literal|0x40
condition|)
block|{
comment|/* RdyBsy active bit */
name|printf
argument_list|(
literal|"%c +RDY/-BSY active"
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|c
operator|=
literal|','
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|p
operator|&
literal|0x80
condition|)
comment|/* Wait signal required */
name|printf
argument_list|(
literal|"%c wait signal supported"
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
comment|/* features byte */
name|p
operator|++
expr_stmt|;
name|feat
operator|=
operator|*
name|p
operator|++
expr_stmt|;
comment|/* Power structure sub-tuple */
switch|switch
condition|(
name|CIS_FEAT_POWER
argument_list|(
name|feat
argument_list|)
condition|)
block|{
comment|/* Power sub-tuple(s) exists */
case|case
literal|0
case|:
break|break;
case|case
literal|1
case|:
name|printf
argument_list|(
literal|"\tVcc pwr:\n"
argument_list|)
expr_stmt|;
name|p
operator|+=
name|print_pwr_desc
argument_list|(
name|p
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|printf
argument_list|(
literal|"\tVcc pwr:\n"
argument_list|)
expr_stmt|;
name|p
operator|+=
name|print_pwr_desc
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tVpp pwr:\n"
argument_list|)
expr_stmt|;
name|p
operator|+=
name|print_pwr_desc
argument_list|(
name|p
argument_list|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|printf
argument_list|(
literal|"\tVcc pwr:\n"
argument_list|)
expr_stmt|;
name|p
operator|+=
name|print_pwr_desc
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tVpp1 pwr:\n"
argument_list|)
expr_stmt|;
name|p
operator|+=
name|print_pwr_desc
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tVpp2 pwr:\n"
argument_list|)
expr_stmt|;
name|p
operator|+=
name|print_pwr_desc
argument_list|(
name|p
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* Timing sub-tuple */
if|if
condition|(
name|tp
operator|->
name|code
operator|==
name|CIS_CONFIG
operator|&&
operator|(
name|feat
operator|&
name|CIS_FEAT_TIMING
operator|)
condition|)
block|{
comment|/* Timing sub-tuple exists */
name|i
operator|=
operator|*
name|p
operator|++
expr_stmt|;
name|j
operator|=
name|CIS_WAIT_SCALE
argument_list|(
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|j
operator|!=
literal|3
condition|)
block|{
name|printf
argument_list|(
literal|"\tWait scale "
argument_list|)
expr_stmt|;
name|print_ext_speed
argument_list|(
operator|*
name|p
operator|++
argument_list|,
name|j
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|j
operator|=
name|CIS_READY_SCALE
argument_list|(
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|j
operator|!=
literal|7
condition|)
block|{
name|printf
argument_list|(
literal|"\tRDY/BSY scale "
argument_list|)
expr_stmt|;
name|print_ext_speed
argument_list|(
operator|*
name|p
operator|++
argument_list|,
name|j
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|j
operator|=
name|CIS_RESERVED_SCALE
argument_list|(
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|j
operator|!=
literal|7
condition|)
block|{
name|printf
argument_list|(
literal|"\tExternal scale "
argument_list|)
expr_stmt|;
name|print_ext_speed
argument_list|(
operator|*
name|p
operator|++
argument_list|,
name|j
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* I/O mapping sub-tuple */
if|if
condition|(
name|feat
operator|&
name|CIS_FEAT_I_O
condition|)
block|{
comment|/* I/O space sub-tuple exists */
if|if
condition|(
name|tp
operator|->
name|code
operator|==
name|CIS_CONFIG
condition|)
name|p
operator|=
name|print_io_map
argument_list|(
name|p
argument_list|,
name|q
argument_list|)
expr_stmt|;
else|else
block|{
comment|/* CIS_CONFIG_CB */
name|printf
argument_list|(
literal|"\tI/O base:"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
if|if
condition|(
operator|*
name|p
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
condition|)
name|printf
argument_list|(
literal|" %d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
name|p
operator|++
expr_stmt|;
block|}
block|}
comment|/* IRQ descriptor sub-tuple */
if|if
condition|(
name|feat
operator|&
name|CIS_FEAT_IRQ
condition|)
comment|/* IRQ sub-tuple exists */
name|p
operator|=
name|print_irq_map
argument_list|(
name|p
argument_list|,
name|q
argument_list|)
expr_stmt|;
comment|/* Memory map sub-tuple */
if|if
condition|(
name|CIS_FEAT_MEMORY
argument_list|(
name|feat
argument_list|)
condition|)
block|{
comment|/* Memory space sub-tuple(s) exists */
if|if
condition|(
name|tp
operator|->
name|code
operator|==
name|CIS_CONFIG
condition|)
name|p
operator|=
name|print_mem_map
argument_list|(
name|feat
argument_list|,
name|p
argument_list|,
name|q
argument_list|)
expr_stmt|;
else|else
block|{
comment|/* CIS_CONFIG_CB */
name|printf
argument_list|(
literal|"\tMemory base:"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
if|if
condition|(
operator|*
name|p
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
condition|)
name|printf
argument_list|(
literal|" %d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
name|p
operator|++
expr_stmt|;
block|}
block|}
comment|/* Misc sub-tuple */
if|if
condition|(
name|feat
operator|&
name|CIS_FEAT_MISC
condition|)
block|{
comment|/* Miscellaneous sub-tuple exists */
if|if
condition|(
name|tp
operator|->
name|code
operator|==
name|CIS_CONFIG
condition|)
block|{
name|printf
argument_list|(
literal|"\tMax twin cards = %d\n"
argument_list|,
operator|*
name|p
operator|&
literal|7
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tMisc attr:%s%s%s"
argument_list|,
operator|(
operator|*
name|p
operator|&
literal|8
operator|)
condition|?
literal|" (Audio-BVD2)"
else|:
literal|""
argument_list|,
operator|(
operator|*
name|p
operator|&
literal|0x10
operator|)
condition|?
literal|" (Read-only)"
else|:
literal|""
argument_list|,
operator|(
operator|*
name|p
operator|&
literal|0x20
operator|)
condition|?
literal|" (Power down supported)"
else|:
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|p
operator|++
operator|&
literal|0x80
condition|)
block|{
name|printf
argument_list|(
literal|" (Ext byte = 0x%x)"
argument_list|,
operator|*
name|p
argument_list|)
expr_stmt|;
name|p
operator|++
expr_stmt|;
block|}
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* CIS_CONFIG_CB */
name|printf
argument_list|(
literal|"\tMisc attr:"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s%s%s%s%s%s%s"
argument_list|,
operator|(
operator|*
name|p
operator|&
literal|1
operator|)
condition|?
literal|" (Master)"
else|:
literal|""
argument_list|,
operator|(
operator|*
name|p
operator|&
literal|2
operator|)
condition|?
literal|" (Invalidate)"
else|:
literal|""
argument_list|,
operator|(
operator|*
name|p
operator|&
literal|4
operator|)
condition|?
literal|" (VGA palette)"
else|:
literal|""
argument_list|,
operator|(
operator|*
name|p
operator|&
literal|8
operator|)
condition|?
literal|" (Parity)"
else|:
literal|""
argument_list|,
operator|(
operator|*
name|p
operator|&
literal|0x10
operator|)
condition|?
literal|" (Wait)"
else|:
literal|""
argument_list|,
operator|(
operator|*
name|p
operator|&
literal|0x20
operator|)
condition|?
literal|" (Serr)"
else|:
literal|""
argument_list|,
operator|(
operator|*
name|p
operator|&
literal|0x40
operator|)
condition|?
literal|" (Fast back)"
else|:
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|p
operator|++
operator|&
literal|0x80
condition|)
block|{
name|printf
argument_list|(
literal|"%s%s"
argument_list|,
operator|(
operator|*
name|p
operator|&
literal|1
operator|)
condition|?
literal|" (Binary audio)"
else|:
literal|""
argument_list|,
operator|(
operator|*
name|p
operator|&
literal|2
operator|)
condition|?
literal|" (pwm audio)"
else|:
literal|""
argument_list|)
expr_stmt|;
name|p
operator|++
expr_stmt|;
block|}
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*  *	CIS_DEVICE_OC, CIS_DEVICE_OA:  *		Dump other conditions for common/attribute memory  */
end_comment

begin_function
specifier|static
name|void
name|dump_other_cond
parameter_list|(
name|u_char
modifier|*
name|p
parameter_list|,
name|int
name|len
parameter_list|)
block|{
if|if
condition|(
name|p
index|[
literal|0
index|]
operator|&&
name|len
operator|>
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"\t"
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
index|[
literal|0
index|]
operator|&
literal|1
condition|)
name|printf
argument_list|(
literal|"(MWAIT)"
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
index|[
literal|0
index|]
operator|&
literal|2
condition|)
name|printf
argument_list|(
literal|" (3V card)"
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
index|[
literal|0
index|]
operator|&
literal|0x80
condition|)
name|printf
argument_list|(
literal|" (Extension bytes follow)"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  *	CIS_MEM_COMMON, CIS_MEM_ATTR:  *		Common / Attribute memory descripter  */
end_comment

begin_function
specifier|static
name|void
name|dump_device_desc
parameter_list|(
name|u_char
modifier|*
name|p
parameter_list|,
name|int
name|len
parameter_list|,
name|char
modifier|*
name|type
parameter_list|)
block|{
specifier|static
name|char
modifier|*
name|un_name
index|[]
init|=
block|{
literal|"512b"
block|,
literal|"2Kb"
block|,
literal|"8Kb"
block|,
literal|"32Kb"
block|,
literal|"128Kb"
block|,
literal|"512Kb"
block|,
literal|"2Mb"
block|,
literal|"reserved"
block|}
decl_stmt|;
specifier|static
name|char
modifier|*
name|speed
index|[]
init|=
block|{
literal|"No speed"
block|,
literal|"250nS"
block|,
literal|"200nS"
block|,
literal|"150nS"
block|,
literal|"100nS"
block|,
literal|"Reserved"
block|,
literal|"Reserved"
block|}
decl_stmt|;
specifier|static
name|char
modifier|*
name|dev
index|[]
init|=
block|{
literal|"No device"
block|,
literal|"Mask ROM"
block|,
literal|"OTPROM"
block|,
literal|"UV EPROM"
block|,
literal|"EEPROM"
block|,
literal|"FLASH EEPROM"
block|,
literal|"SRAM"
block|,
literal|"DRAM"
block|,
literal|"Reserved"
block|,
literal|"Reserved"
block|,
literal|"Reserved"
block|,
literal|"Reserved"
block|,
literal|"Reserved"
block|,
literal|"Function specific"
block|,
literal|"Extended"
block|,
literal|"Reserved"
block|}
decl_stmt|;
name|int
name|count
init|=
literal|0
decl_stmt|;
while|while
condition|(
operator|*
name|p
operator|!=
literal|0xFF
operator|&&
name|len
operator|>
literal|0
condition|)
block|{
name|u_char
name|x
decl_stmt|;
name|x
operator|=
operator|*
name|p
operator|++
expr_stmt|;
name|len
operator|-=
literal|2
expr_stmt|;
if|if
condition|(
name|count
operator|++
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"\t%s memory device information:\n"
argument_list|,
name|type
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\tDevice number %d, type %s, WPS = %s\n"
argument_list|,
name|count
argument_list|,
name|dev
index|[
name|x
operator|>>
literal|4
index|]
argument_list|,
operator|(
name|x
operator|&
literal|0x8
operator|)
condition|?
literal|"ON"
else|:
literal|"OFF"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|x
operator|&
literal|7
operator|)
operator|==
literal|7
condition|)
block|{
name|len
operator|--
expr_stmt|;
if|if
condition|(
operator|*
name|p
condition|)
block|{
name|printf
argument_list|(
literal|"\t\t"
argument_list|)
expr_stmt|;
name|print_ext_speed
argument_list|(
operator|*
name|p
argument_list|,
literal|0
argument_list|)
expr_stmt|;
while|while
condition|(
operator|*
name|p
operator|&
literal|0x80
condition|)
block|{
name|p
operator|++
expr_stmt|;
name|len
operator|--
expr_stmt|;
block|}
block|}
name|p
operator|++
expr_stmt|;
block|}
else|else
name|printf
argument_list|(
literal|"\t\tSpeed = %s"
argument_list|,
name|speed
index|[
name|x
operator|&
literal|7
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|", Memory block size = %s, %d units\n"
argument_list|,
name|un_name
index|[
operator|*
name|p
operator|&
literal|7
index|]
argument_list|,
operator|(
operator|*
name|p
operator|>>
literal|3
operator|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|p
operator|++
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  *	CIS_INFO_V1: Print version-1 info  */
end_comment

begin_function
specifier|static
name|void
name|dump_info_v1
parameter_list|(
name|u_char
modifier|*
name|p
parameter_list|,
name|int
name|len
parameter_list|)
block|{
if|if
condition|(
name|len
operator|<
literal|2
condition|)
block|{
name|printf
argument_list|(
literal|"\tWrong length for version-1 info tuple\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|printf
argument_list|(
literal|"\tVersion = %d.%d"
argument_list|,
name|p
index|[
literal|0
index|]
argument_list|,
name|p
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|p
operator|+=
literal|2
expr_stmt|;
name|len
operator|-=
literal|2
expr_stmt|;
if|if
condition|(
name|len
operator|>
literal|1
operator|&&
operator|*
name|p
operator|!=
literal|0xff
condition|)
block|{
name|printf
argument_list|(
literal|", Manuf = [%s]"
argument_list|,
name|p
argument_list|)
expr_stmt|;
while|while
condition|(
operator|*
name|p
operator|++
operator|&&
operator|--
name|len
operator|>
literal|0
condition|)
empty_stmt|;
block|}
if|if
condition|(
name|len
operator|>
literal|1
operator|&&
operator|*
name|p
operator|!=
literal|0xff
condition|)
block|{
name|printf
argument_list|(
literal|", card vers = [%s]"
argument_list|,
name|p
argument_list|)
expr_stmt|;
while|while
condition|(
operator|*
name|p
operator|++
operator|&&
operator|--
name|len
operator|>
literal|0
condition|)
empty_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"\n\tWrong length for version-1 info tuple\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
literal|1
operator|&&
operator|*
name|p
operator|!=
literal|0xff
condition|)
block|{
name|printf
argument_list|(
literal|"\tAddit. info = [%.*s]"
argument_list|,
name|len
argument_list|,
name|p
argument_list|)
expr_stmt|;
while|while
condition|(
operator|*
name|p
operator|++
operator|&&
operator|--
name|len
operator|>
literal|0
condition|)
empty_stmt|;
if|if
condition|(
name|len
operator|>
literal|1
operator|&&
operator|*
name|p
operator|!=
literal|0xff
condition|)
name|printf
argument_list|(
literal|",[%.*s]"
argument_list|,
name|len
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  *	CIS_FUNC_ID: Functional ID  */
end_comment

begin_function
specifier|static
name|void
name|dump_func_id
parameter_list|(
name|u_char
modifier|*
name|p
parameter_list|)
block|{
specifier|static
name|char
modifier|*
name|id
index|[]
init|=
block|{
literal|"Multifunction card"
block|,
literal|"Memory card"
block|,
literal|"Serial port/modem"
block|,
literal|"Parallel port"
block|,
literal|"Fixed disk card"
block|,
literal|"Video adapter"
block|,
literal|"Network/LAN adapter"
block|,
literal|"AIMS"
block|,
literal|"SCSI card"
block|,
literal|"Security"
block|}
decl_stmt|;
name|printf
argument_list|(
literal|"\t%s%s%s\n"
argument_list|,
operator|(
operator|*
name|p
operator|<=
literal|9
operator|)
condition|?
name|id
index|[
operator|*
name|p
index|]
else|:
literal|"Unknown function"
argument_list|,
operator|(
name|p
index|[
literal|1
index|]
operator|&
literal|1
operator|)
condition|?
literal|" - POST initialize"
else|:
literal|""
argument_list|,
operator|(
name|p
index|[
literal|1
index|]
operator|&
literal|2
operator|)
condition|?
literal|" - Card has ROM"
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  *	CIS_FUNC_EXT: Dump functional extension tuple.  *		(Serial port/modem)  */
end_comment

begin_function
specifier|static
name|void
name|dump_serial_ext
parameter_list|(
name|u_char
modifier|*
name|p
parameter_list|,
name|int
name|len
parameter_list|)
block|{
specifier|static
name|char
modifier|*
name|type
index|[]
init|=
block|{
literal|""
block|,
literal|"Modem"
block|,
literal|"Data"
block|,
literal|"Fax"
block|,
literal|"Voice"
block|,
literal|"Data modem"
block|,
literal|"Fax/modem"
block|,
literal|"Voice"
block|,
literal|" (Data)"
block|,
literal|" (Fax)"
block|,
literal|" (Voice)"
block|}
decl_stmt|;
if|if
condition|(
name|len
operator|<
literal|1
condition|)
return|return;
switch|switch
condition|(
name|p
index|[
literal|0
index|]
condition|)
block|{
case|case
literal|0
case|:
comment|/* Serial */
case|case
literal|8
case|:
comment|/* Data */
case|case
literal|9
case|:
comment|/* Fax */
case|case
literal|10
case|:
comment|/* Voice */
name|printf
argument_list|(
literal|"\tSerial interface extension:%s\n"
argument_list|,
name|type
index|[
operator|*
name|p
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|4
condition|)
goto|goto
name|err
goto|;
switch|switch
condition|(
name|p
index|[
literal|1
index|]
operator|&
literal|0x1F
condition|)
block|{
default|default:
name|printf
argument_list|(
literal|"\t\tUnkn device"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0
case|:
name|printf
argument_list|(
literal|"\t\t8250 UART"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|printf
argument_list|(
literal|"\t\t16450 UART"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|printf
argument_list|(
literal|"\t\t16550 UART"
argument_list|)
expr_stmt|;
break|break;
block|}
name|printf
argument_list|(
literal|", Parity - %s%s%s%s\n"
argument_list|,
operator|(
name|p
index|[
literal|2
index|]
operator|&
literal|1
operator|)
condition|?
literal|"Space,"
else|:
literal|""
argument_list|,
operator|(
name|p
index|[
literal|2
index|]
operator|&
literal|2
operator|)
condition|?
literal|"Mark,"
else|:
literal|""
argument_list|,
operator|(
name|p
index|[
literal|2
index|]
operator|&
literal|4
operator|)
condition|?
literal|"Odd,"
else|:
literal|""
argument_list|,
operator|(
name|p
index|[
literal|2
index|]
operator|&
literal|8
operator|)
condition|?
literal|"Even"
else|:
literal|""
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\tData bit - %s%s%s%s Stop bit - %s%s%s\n"
argument_list|,
operator|(
name|p
index|[
literal|3
index|]
operator|&
literal|1
operator|)
condition|?
literal|"5bit,"
else|:
literal|""
argument_list|,
operator|(
name|p
index|[
literal|3
index|]
operator|&
literal|2
operator|)
condition|?
literal|"6bit,"
else|:
literal|""
argument_list|,
operator|(
name|p
index|[
literal|3
index|]
operator|&
literal|4
operator|)
condition|?
literal|"7bit,"
else|:
literal|""
argument_list|,
operator|(
name|p
index|[
literal|3
index|]
operator|&
literal|8
operator|)
condition|?
literal|"8bit,"
else|:
literal|""
argument_list|,
operator|(
name|p
index|[
literal|3
index|]
operator|&
literal|0x10
operator|)
condition|?
literal|"1bit,"
else|:
literal|""
argument_list|,
operator|(
name|p
index|[
literal|3
index|]
operator|&
literal|0x20
operator|)
condition|?
literal|"1.5bit,"
else|:
literal|""
argument_list|,
operator|(
name|p
index|[
literal|3
index|]
operator|&
literal|0x40
operator|)
condition|?
literal|"2bit"
else|:
literal|""
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
comment|/* Serial */
case|case
literal|5
case|:
comment|/* Data */
case|case
literal|6
case|:
comment|/* Fax */
case|case
literal|7
case|:
comment|/* Voice */
name|printf
argument_list|(
literal|"\t%s interface capabilities:\n"
argument_list|,
name|type
index|[
operator|*
name|p
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|9
condition|)
goto|goto
name|err
goto|;
break|break;
case|case
literal|2
case|:
comment|/* Data */
name|printf
argument_list|(
literal|"\tData modem services available:\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x13
case|:
comment|/* Fax1 */
case|case
literal|0x23
case|:
comment|/* Fax2 */
case|case
literal|0x33
case|:
comment|/* Fax3 */
name|printf
argument_list|(
literal|"\tFax%d/modem services available:\n"
argument_list|,
operator|*
name|p
operator|>>
literal|4
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x84
case|:
comment|/* Voice */
name|printf
argument_list|(
literal|"\tVoice services available:\n"
argument_list|)
expr_stmt|;
break|break;
name|err
label|:
comment|/* warning */
name|printf
argument_list|(
literal|"\tWrong length for serial extension tuple\n"
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
end_function

begin_comment
comment|/*  *	CIS_FUNC_EXT: Dump functional extension tuple.  *		(Fixed disk card)  */
end_comment

begin_function
specifier|static
name|void
name|dump_disk_ext
parameter_list|(
name|u_char
modifier|*
name|p
parameter_list|,
name|int
name|len
parameter_list|)
block|{
if|if
condition|(
name|len
operator|<
literal|1
condition|)
return|return;
switch|switch
condition|(
name|p
index|[
literal|0
index|]
condition|)
block|{
case|case
literal|1
case|:
comment|/* IDE interface */
if|if
condition|(
name|len
operator|<
literal|2
condition|)
goto|goto
name|err
goto|;
name|printf
argument_list|(
literal|"\tDisk interface: %s\n"
argument_list|,
operator|(
name|p
index|[
literal|1
index|]
operator|&
literal|1
operator|)
condition|?
literal|"IDE"
else|:
literal|"Undefined"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
comment|/* Master */
case|case
literal|3
case|:
comment|/* Slave */
if|if
condition|(
name|len
operator|<
literal|3
condition|)
goto|goto
name|err
goto|;
name|printf
argument_list|(
literal|"\tDisk features: %s, %s%s\n"
argument_list|,
operator|(
name|p
index|[
literal|1
index|]
operator|&
literal|0x04
operator|)
condition|?
literal|"Silicon"
else|:
literal|"Rotating"
argument_list|,
operator|(
name|p
index|[
literal|1
index|]
operator|&
literal|0x08
operator|)
condition|?
literal|"Unique, "
else|:
literal|""
argument_list|,
operator|(
name|p
index|[
literal|1
index|]
operator|&
literal|0x10
operator|)
condition|?
literal|"Dual"
else|:
literal|"Single"
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
index|[
literal|2
index|]
operator|&
literal|0x7f
condition|)
name|printf
argument_list|(
literal|"\t\t%s%s%s%s%s%s%s\n"
argument_list|,
operator|(
name|p
index|[
literal|2
index|]
operator|&
literal|0x01
operator|)
condition|?
literal|"Sleep, "
else|:
literal|""
argument_list|,
operator|(
name|p
index|[
literal|2
index|]
operator|&
literal|0x02
operator|)
condition|?
literal|"Standby, "
else|:
literal|""
argument_list|,
operator|(
name|p
index|[
literal|2
index|]
operator|&
literal|0x04
operator|)
condition|?
literal|"Idle, "
else|:
literal|""
argument_list|,
operator|(
name|p
index|[
literal|2
index|]
operator|&
literal|0x08
operator|)
condition|?
literal|"Low power, "
else|:
literal|""
argument_list|,
operator|(
name|p
index|[
literal|2
index|]
operator|&
literal|0x10
operator|)
condition|?
literal|"Reg inhibit, "
else|:
literal|""
argument_list|,
operator|(
name|p
index|[
literal|2
index|]
operator|&
literal|0x20
operator|)
condition|?
literal|"Index, "
else|:
literal|""
argument_list|,
operator|(
name|p
index|[
literal|2
index|]
operator|&
literal|0x40
operator|)
condition|?
literal|"Iois16"
else|:
literal|""
argument_list|)
expr_stmt|;
break|break;
name|err
label|:
comment|/* warning */
name|printf
argument_list|(
literal|"\tWrong length for fixed disk extension tuple\n"
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|print_speed
parameter_list|(
name|u_int
name|i
parameter_list|)
block|{
if|if
condition|(
name|i
operator|<
literal|1000
condition|)
name|printf
argument_list|(
literal|"%u bits/sec"
argument_list|,
name|i
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|i
operator|<
literal|1000000
condition|)
name|printf
argument_list|(
literal|"%u kb/sec"
argument_list|,
name|i
operator|/
literal|1000
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%u Mb/sec"
argument_list|,
name|i
operator|/
literal|1000000
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  *	CIS_FUNC_EXT: Dump functional extension tuple.  *		(Network/LAN adapter)  */
end_comment

begin_function
specifier|static
name|void
name|dump_network_ext
parameter_list|(
name|u_char
modifier|*
name|p
parameter_list|,
name|int
name|len
parameter_list|)
block|{
specifier|static
specifier|const
name|char
modifier|*
name|tech
index|[]
init|=
block|{
literal|"Undefined"
block|,
literal|"ARCnet"
block|,
literal|"Ethernet"
block|,
literal|"Token ring"
block|,
literal|"Localtalk"
block|,
literal|"FDDI/CDDI"
block|,
literal|"ATM"
block|,
literal|"Wireless"
block|}
decl_stmt|;
specifier|static
specifier|const
name|char
modifier|*
name|media
index|[]
init|=
block|{
literal|"Undefined"
block|,
literal|"UTP"
block|,
literal|"STP"
block|,
literal|"Thin coax"
block|,
literal|"THICK coax"
block|,
literal|"Fiber"
block|,
literal|"900 MHz"
block|,
literal|"2.4 GHz"
block|,
literal|"5.4 GHz"
block|,
literal|"Diffuse Infrared"
block|,
literal|"Point to point Infrared"
block|}
decl_stmt|;
name|u_int
name|i
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|len
operator|<
literal|1
condition|)
return|return;
switch|switch
condition|(
name|p
index|[
literal|0
index|]
condition|)
block|{
case|case
literal|1
case|:
comment|/* Network technology */
if|if
condition|(
name|len
operator|<
literal|2
condition|)
goto|goto
name|err
goto|;
name|printf
argument_list|(
literal|"\tNetwork technology: %s\n"
argument_list|,
name|tech
index|[
name|p
index|[
literal|1
index|]
operator|&
literal|7
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
comment|/* Network speed */
if|if
condition|(
name|len
operator|<
literal|5
condition|)
goto|goto
name|err
goto|;
name|printf
argument_list|(
literal|"\tNetwork speed: "
argument_list|)
expr_stmt|;
name|print_speed
argument_list|(
name|tpl32
argument_list|(
name|p
operator|+
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
comment|/* Network media */
if|if
condition|(
name|len
operator|<
literal|2
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
name|p
index|[
literal|1
index|]
operator|<=
literal|10
condition|)
name|i
operator|=
name|p
index|[
literal|1
index|]
expr_stmt|;
name|printf
argument_list|(
literal|"\tNetwork media: %s\n"
argument_list|,
name|media
index|[
name|i
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
comment|/* Node ID */
if|if
condition|(
name|len
operator|<=
literal|2
operator|||
name|len
operator|<
name|p
index|[
literal|1
index|]
operator|+
literal|2
condition|)
goto|goto
name|err
goto|;
name|printf
argument_list|(
literal|"\tNetwork node ID:"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|p
index|[
literal|1
index|]
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|" %02x"
argument_list|,
name|p
index|[
name|i
operator|+
literal|2
index|]
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
break|break;
case|case
literal|5
case|:
comment|/* Connecter type */
if|if
condition|(
name|len
operator|<
literal|2
condition|)
goto|goto
name|err
goto|;
name|printf
argument_list|(
literal|"\tNetwork connector: %s connector standard\n"
argument_list|,
operator|(
name|p
index|[
literal|1
index|]
operator|==
literal|0
operator|)
condition|?
literal|"open"
else|:
literal|"closed"
argument_list|)
expr_stmt|;
break|break;
name|err
label|:
comment|/* warning */
name|printf
argument_list|(
literal|"\tWrong length for network extension tuple\n"
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
end_function

begin_comment
comment|/*  *	CIS_LONGLINK_MFC: Long link to next chain for Multi function card  */
end_comment

begin_function
specifier|static
name|void
name|dump_longlink_mfc
parameter_list|(
name|u_char
modifier|*
name|p
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|u_int
name|i
decl_stmt|,
name|n
init|=
operator|*
name|p
operator|++
decl_stmt|;
operator|--
name|len
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|len
operator|<
literal|5
condition|)
block|{
name|printf
argument_list|(
literal|"\tWrong length for long link MFC tuple\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|printf
argument_list|(
literal|"\tFunction %d: %s memory, address 0x%x\n"
argument_list|,
name|i
argument_list|,
operator|(
operator|*
name|p
condition|?
literal|"common"
else|:
literal|"attribute"
operator|)
argument_list|,
name|tpl32
argument_list|(
name|p
operator|+
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|p
operator|+=
literal|5
expr_stmt|;
name|len
operator|-=
literal|5
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  *	CIS_DEVICEGEO, CIS_DEVICEGEO_A:  *		Geometry info for common/attribute memory  */
end_comment

begin_function
specifier|static
name|void
name|dump_device_geo
parameter_list|(
name|u_char
modifier|*
name|p
parameter_list|,
name|int
name|len
parameter_list|)
block|{
while|while
condition|(
name|len
operator|>=
literal|6
condition|)
block|{
name|printf
argument_list|(
literal|"\twidth = %d, erase = 0x%x, read = 0x%x, write = 0x%x\n"
literal|"\t\tpartition = 0x%x, interleave = 0x%x\n"
argument_list|,
name|p
index|[
literal|0
index|]
argument_list|,
literal|1
operator|<<
operator|(
name|p
index|[
literal|1
index|]
operator|-
literal|1
operator|)
argument_list|,
literal|1
operator|<<
operator|(
name|p
index|[
literal|2
index|]
operator|-
literal|1
operator|)
argument_list|,
literal|1
operator|<<
operator|(
name|p
index|[
literal|3
index|]
operator|-
literal|1
operator|)
argument_list|,
literal|1
operator|<<
operator|(
name|p
index|[
literal|4
index|]
operator|-
literal|1
operator|)
argument_list|,
literal|1
operator|<<
operator|(
name|p
index|[
literal|5
index|]
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
name|len
operator|-=
literal|6
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  *	CIS_INFO_V2: Print version-2 info  */
end_comment

begin_function
specifier|static
name|void
name|dump_info_v2
parameter_list|(
name|u_char
modifier|*
name|p
parameter_list|,
name|int
name|len
parameter_list|)
block|{
if|if
condition|(
name|len
operator|<
literal|9
condition|)
block|{
name|printf
argument_list|(
literal|"\tWrong length for version-2 info tuple\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|printf
argument_list|(
literal|"\tVersion = 0x%x, compliance = 0x%x, dindex = 0x%x\n"
argument_list|,
name|p
index|[
literal|0
index|]
argument_list|,
name|p
index|[
literal|1
index|]
argument_list|,
name|tpl16
argument_list|(
name|p
operator|+
literal|2
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tVspec8 = 0x%x, vspec9 = 0x%x, nhdr = %d\n"
argument_list|,
name|p
index|[
literal|6
index|]
argument_list|,
name|p
index|[
literal|7
index|]
argument_list|,
name|p
index|[
literal|8
index|]
argument_list|)
expr_stmt|;
name|p
operator|+=
literal|9
expr_stmt|;
name|len
operator|-=
literal|9
expr_stmt|;
if|if
condition|(
name|len
operator|<=
literal|1
operator|||
operator|*
name|p
operator|==
literal|0xff
condition|)
return|return;
name|printf
argument_list|(
literal|"\tVendor = [%.*s]"
argument_list|,
name|len
argument_list|,
name|p
argument_list|)
expr_stmt|;
while|while
condition|(
operator|*
name|p
operator|++
operator|&&
operator|--
name|len
operator|>
literal|0
condition|)
empty_stmt|;
if|if
condition|(
name|len
operator|>
literal|1
operator|&&
operator|*
name|p
operator|!=
literal|0xff
condition|)
name|printf
argument_list|(
literal|", info = [%.*s]"
argument_list|,
name|len
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  *	CIS_ORG: Organization  */
end_comment

begin_function
specifier|static
name|void
name|dump_org
parameter_list|(
name|u_char
modifier|*
name|p
parameter_list|,
name|int
name|len
parameter_list|)
block|{
if|if
condition|(
name|len
operator|<
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"\tWrong length for organization tuple\n"
argument_list|)
expr_stmt|;
return|return;
block|}
switch|switch
condition|(
operator|*
name|p
condition|)
block|{
case|case
literal|0
case|:
name|printf
argument_list|(
literal|"\tFilesystem"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|printf
argument_list|(
literal|"\tApp specific"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|printf
argument_list|(
literal|"\tCode"
argument_list|)
expr_stmt|;
break|break;
default|default:
if|if
condition|(
operator|*
name|p
operator|<
literal|0x80
condition|)
name|printf
argument_list|(
literal|"\tReserved"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"\tVendor specific"
argument_list|)
expr_stmt|;
break|break;
block|}
name|printf
argument_list|(
literal|" [%.*s]\n"
argument_list|,
name|len
operator|-
literal|1
argument_list|,
name|p
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_size
parameter_list|(
name|u_int
name|i
parameter_list|)
block|{
if|if
condition|(
name|i
operator|<
literal|1024
condition|)
name|printf
argument_list|(
literal|"%ubits"
argument_list|,
name|i
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|i
operator|<
literal|1024
operator|*
literal|1024
condition|)
name|printf
argument_list|(
literal|"%ukb"
argument_list|,
name|i
operator|/
literal|1024
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%uMb"
argument_list|,
name|i
operator|/
operator|(
literal|1024
operator|*
literal|1024
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  *	CIS_BAR: Base address register for CardBus  */
end_comment

begin_function
specifier|static
name|void
name|dump_bar
parameter_list|(
name|u_char
modifier|*
name|p
parameter_list|,
name|int
name|len
parameter_list|)
block|{
if|if
condition|(
name|len
operator|<
literal|6
condition|)
block|{
name|printf
argument_list|(
literal|"\tWrong length for BAR tuple\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|printf
argument_list|(
literal|"\tBAR %d: size = "
argument_list|,
operator|*
name|p
operator|&
literal|7
argument_list|)
expr_stmt|;
name|print_size
argument_list|(
name|tpl32
argument_list|(
name|p
operator|+
literal|2
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|", %s%s%s%s\n"
argument_list|,
operator|(
operator|*
name|p
operator|&
literal|0x10
operator|)
condition|?
literal|"I/O"
else|:
literal|"Memory"
argument_list|,
operator|(
operator|*
name|p
operator|&
literal|0x20
operator|)
condition|?
literal|", Prefetch"
else|:
literal|""
argument_list|,
operator|(
operator|*
name|p
operator|&
literal|0x40
operator|)
condition|?
literal|", Cacheable"
else|:
literal|""
argument_list|,
operator|(
operator|*
name|p
operator|&
literal|0x80
operator|)
condition|?
literal|",<1Mb"
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	$FreeBSD$	*/
end_comment

begin_comment
comment|/*	$KAME: rrenum.c,v 1.12 2002/06/10 19:59:47 itojun Exp $	*/
end_comment

begin_comment
comment|/*  * Copyright (C) 1995, 1996, 1997, and 1998 WIDE Project.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. Neither the name of the project nor the names of its contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE PROJECT AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE PROJECT OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_var.h>
end_include

begin_include
include|#
directive|include
file|<net/route.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_var.h>
end_include

begin_include
include|#
directive|include
file|<netinet/icmp6.h>
end_include

begin_include
include|#
directive|include
file|<arpa/inet.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<syslog.h>
end_include

begin_include
include|#
directive|include
file|"rtadvd.h"
end_include

begin_include
include|#
directive|include
file|"rrenum.h"
end_include

begin_include
include|#
directive|include
file|"if.h"
end_include

begin_define
define|#
directive|define
name|RR_ISSET_SEGNUM
parameter_list|(
name|segnum_bits
parameter_list|,
name|segnum
parameter_list|)
define|\
value|((((segnum_bits)[(segnum)>> 5])& (1<< ((segnum)& 31))) != 0)
end_define

begin_define
define|#
directive|define
name|RR_SET_SEGNUM
parameter_list|(
name|segnum_bits
parameter_list|,
name|segnum
parameter_list|)
define|\
value|(((segnum_bits)[(segnum)>> 5]) |= (1<< ((segnum)& 31)))
end_define

begin_struct
struct|struct
name|rr_operation
block|{
name|u_long
name|rro_seqnum
decl_stmt|;
name|u_long
name|rro_segnum_bits
index|[
literal|8
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|struct
name|rr_operation
name|rro
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|rr_rcvifindex
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|rrcmd2pco
index|[
name|RPM_PCO_MAX
index|]
init|=
block|{
literal|0
block|,
name|SIOCAIFPREFIX_IN6
block|,
name|SIOCCIFPREFIX_IN6
block|,
name|SIOCSGIFPREFIX_IN6
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|s
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Check validity of a Prefix Control Operation(PCO).  * return 0 on success, 1 on failure.  */
end_comment

begin_function
specifier|static
name|int
name|rr_pco_check
parameter_list|(
name|int
name|len
parameter_list|,
name|struct
name|rr_pco_match
modifier|*
name|rpm
parameter_list|)
block|{
name|struct
name|rr_pco_use
modifier|*
name|rpu
decl_stmt|,
modifier|*
name|rpulim
decl_stmt|;
name|int
name|checklen
decl_stmt|;
comment|/* rpm->rpm_len must be (4N * 3) as router-renum-05.txt */
if|if
condition|(
operator|(
name|rpm
operator|->
name|rpm_len
operator|-
literal|3
operator|)
operator|<
literal|0
operator|||
comment|/* must be at least 3 */
operator|(
name|rpm
operator|->
name|rpm_len
operator|-
literal|3
operator|)
operator|&
literal|0x3
condition|)
block|{
comment|/* must be multiple of 4 */
name|syslog
argument_list|(
name|LOG_WARNING
argument_list|,
literal|"<%s> rpm_len %d is not 4N * 3"
argument_list|,
name|__func__
argument_list|,
name|rpm
operator|->
name|rpm_len
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
comment|/* rpm->rpm_code must be valid value */
switch|switch
condition|(
name|rpm
operator|->
name|rpm_code
condition|)
block|{
case|case
name|RPM_PCO_ADD
case|:
case|case
name|RPM_PCO_CHANGE
case|:
case|case
name|RPM_PCO_SETGLOBAL
case|:
break|break;
default|default:
name|syslog
argument_list|(
name|LOG_WARNING
argument_list|,
literal|"<%s> unknown rpm_code %d"
argument_list|,
name|__func__
argument_list|,
name|rpm
operator|->
name|rpm_code
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
comment|/* rpm->rpm_matchlen must be 0 to 128 inclusive */
if|if
condition|(
name|rpm
operator|->
name|rpm_matchlen
operator|>
literal|128
condition|)
block|{
name|syslog
argument_list|(
name|LOG_WARNING
argument_list|,
literal|"<%s> rpm_matchlen %d is over 128"
argument_list|,
name|__func__
argument_list|,
name|rpm
operator|->
name|rpm_matchlen
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
comment|/* 	 * rpu->rpu_uselen, rpu->rpu_keeplen, and sum of them must be 	 * between 0 and 128 inclusive 	 */
for|for
control|(
name|rpu
operator|=
operator|(
expr|struct
name|rr_pco_use
operator|*
operator|)
operator|(
name|rpm
operator|+
literal|1
operator|)
operator|,
name|rpulim
operator|=
operator|(
expr|struct
name|rr_pco_use
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|rpm
operator|+
name|len
operator|)
init|;
name|rpu
operator|<
name|rpulim
condition|;
name|rpu
operator|+=
literal|1
control|)
block|{
name|checklen
operator|=
name|rpu
operator|->
name|rpu_uselen
expr_stmt|;
name|checklen
operator|+=
name|rpu
operator|->
name|rpu_keeplen
expr_stmt|;
comment|/* 		 * omit these check, because either of rpu_uselen 		 * and rpu_keeplen is unsigned char 		 *  (128> rpu_uselen> 0) 		 *  (128> rpu_keeplen> 0) 		 *  (rpu_uselen + rpu_keeplen> 0) 		 */
if|if
condition|(
name|checklen
operator|>
literal|128
condition|)
block|{
name|syslog
argument_list|(
name|LOG_WARNING
argument_list|,
literal|"<%s> sum of rpu_uselen %d and"
literal|" rpu_keeplen %d is %d(over 128)"
argument_list|,
name|__func__
argument_list|,
name|rpu
operator|->
name|rpu_uselen
argument_list|,
name|rpu
operator|->
name|rpu_keeplen
argument_list|,
name|rpu
operator|->
name|rpu_uselen
operator|+
name|rpu
operator|->
name|rpu_keeplen
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|do_use_prefix
parameter_list|(
name|int
name|len
parameter_list|,
name|struct
name|rr_pco_match
modifier|*
name|rpm
parameter_list|,
name|struct
name|in6_rrenumreq
modifier|*
name|irr
parameter_list|,
name|int
name|ifindex
parameter_list|)
block|{
name|struct
name|rr_pco_use
modifier|*
name|rpu
decl_stmt|,
modifier|*
name|rpulim
decl_stmt|;
name|struct
name|rainfo
modifier|*
name|rai
decl_stmt|;
name|struct
name|prefix
modifier|*
name|pfx
decl_stmt|;
name|rpu
operator|=
operator|(
expr|struct
name|rr_pco_use
operator|*
operator|)
operator|(
name|rpm
operator|+
literal|1
operator|)
expr_stmt|;
name|rpulim
operator|=
operator|(
expr|struct
name|rr_pco_use
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|rpm
operator|+
name|len
operator|)
expr_stmt|;
if|if
condition|(
name|rpu
operator|==
name|rpulim
condition|)
block|{
comment|/* no use prefix */
if|if
condition|(
name|rpm
operator|->
name|rpm_code
operator|==
name|RPM_PCO_ADD
condition|)
return|return;
name|irr
operator|->
name|irr_u_uselen
operator|=
literal|0
expr_stmt|;
name|irr
operator|->
name|irr_u_keeplen
operator|=
literal|0
expr_stmt|;
name|irr
operator|->
name|irr_raf_mask_onlink
operator|=
literal|0
expr_stmt|;
name|irr
operator|->
name|irr_raf_mask_auto
operator|=
literal|0
expr_stmt|;
name|irr
operator|->
name|irr_vltime
operator|=
literal|0
expr_stmt|;
name|irr
operator|->
name|irr_pltime
operator|=
literal|0
expr_stmt|;
name|memset
argument_list|(
operator|&
name|irr
operator|->
name|irr_flags
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|irr
operator|->
name|irr_flags
argument_list|)
argument_list|)
expr_stmt|;
name|irr
operator|->
name|irr_useprefix
operator|.
name|sin6_len
operator|=
literal|0
expr_stmt|;
comment|/* let it mean, no addition */
name|irr
operator|->
name|irr_useprefix
operator|.
name|sin6_family
operator|=
literal|0
expr_stmt|;
name|irr
operator|->
name|irr_useprefix
operator|.
name|sin6_addr
operator|=
name|in6addr_any
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|rrcmd2pco
index|[
name|rpm
operator|->
name|rpm_code
index|]
argument_list|,
operator|(
name|caddr_t
operator|)
name|irr
argument_list|)
operator|<
literal|0
operator|&&
name|errno
operator|!=
name|EADDRNOTAVAIL
condition|)
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"<%s> ioctl: %s"
argument_list|,
name|__func__
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
for|for
control|(
name|rpu
operator|=
operator|(
expr|struct
name|rr_pco_use
operator|*
operator|)
operator|(
name|rpm
operator|+
literal|1
operator|)
operator|,
name|rpulim
operator|=
operator|(
expr|struct
name|rr_pco_use
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|rpm
operator|+
name|len
operator|)
init|;
name|rpu
operator|<
name|rpulim
condition|;
name|rpu
operator|+=
literal|1
control|)
block|{
comment|/* init in6_rrenumreq fields */
name|irr
operator|->
name|irr_u_uselen
operator|=
name|rpu
operator|->
name|rpu_uselen
expr_stmt|;
name|irr
operator|->
name|irr_u_keeplen
operator|=
name|rpu
operator|->
name|rpu_keeplen
expr_stmt|;
name|irr
operator|->
name|irr_raf_mask_onlink
operator|=
operator|!
operator|!
operator|(
name|rpu
operator|->
name|rpu_ramask
operator|&
name|ICMP6_RR_PCOUSE_RAFLAGS_ONLINK
operator|)
expr_stmt|;
name|irr
operator|->
name|irr_raf_mask_auto
operator|=
operator|!
operator|!
operator|(
name|rpu
operator|->
name|rpu_ramask
operator|&
name|ICMP6_RR_PCOUSE_RAFLAGS_AUTO
operator|)
expr_stmt|;
name|irr
operator|->
name|irr_vltime
operator|=
name|ntohl
argument_list|(
name|rpu
operator|->
name|rpu_vltime
argument_list|)
expr_stmt|;
name|irr
operator|->
name|irr_pltime
operator|=
name|ntohl
argument_list|(
name|rpu
operator|->
name|rpu_pltime
argument_list|)
expr_stmt|;
name|irr
operator|->
name|irr_raf_onlink
operator|=
operator|(
name|rpu
operator|->
name|rpu_raflags
operator|&
name|ICMP6_RR_PCOUSE_RAFLAGS_ONLINK
operator|)
operator|==
literal|0
condition|?
literal|0
else|:
literal|1
expr_stmt|;
name|irr
operator|->
name|irr_raf_auto
operator|=
operator|(
name|rpu
operator|->
name|rpu_raflags
operator|&
name|ICMP6_RR_PCOUSE_RAFLAGS_AUTO
operator|)
operator|==
literal|0
condition|?
literal|0
else|:
literal|1
expr_stmt|;
name|irr
operator|->
name|irr_rrf_decrvalid
operator|=
operator|(
name|rpu
operator|->
name|rpu_flags
operator|&
name|ICMP6_RR_PCOUSE_FLAGS_DECRVLTIME
operator|)
operator|==
literal|0
condition|?
literal|0
else|:
literal|1
expr_stmt|;
name|irr
operator|->
name|irr_rrf_decrprefd
operator|=
operator|(
name|rpu
operator|->
name|rpu_flags
operator|&
name|ICMP6_RR_PCOUSE_FLAGS_DECRPLTIME
operator|)
operator|==
literal|0
condition|?
literal|0
else|:
literal|1
expr_stmt|;
name|irr
operator|->
name|irr_useprefix
operator|.
name|sin6_len
operator|=
sizeof|sizeof
argument_list|(
name|irr
operator|->
name|irr_useprefix
argument_list|)
expr_stmt|;
name|irr
operator|->
name|irr_useprefix
operator|.
name|sin6_family
operator|=
name|AF_INET6
expr_stmt|;
name|irr
operator|->
name|irr_useprefix
operator|.
name|sin6_addr
operator|=
name|rpu
operator|->
name|rpu_prefix
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|rrcmd2pco
index|[
name|rpm
operator|->
name|rpm_code
index|]
argument_list|,
operator|(
name|caddr_t
operator|)
name|irr
argument_list|)
operator|<
literal|0
operator|&&
name|errno
operator|!=
name|EADDRNOTAVAIL
condition|)
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"<%s> ioctl: %s"
argument_list|,
name|__func__
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
comment|/* very adhoc: should be rewritten */
if|if
condition|(
name|rpm
operator|->
name|rpm_code
operator|==
name|RPM_PCO_CHANGE
operator|&&
name|IN6_ARE_ADDR_EQUAL
argument_list|(
operator|&
name|rpm
operator|->
name|rpm_prefix
argument_list|,
operator|&
name|rpu
operator|->
name|rpu_prefix
argument_list|)
operator|&&
name|rpm
operator|->
name|rpm_matchlen
operator|==
name|rpu
operator|->
name|rpu_uselen
operator|&&
name|rpu
operator|->
name|rpu_uselen
operator|==
name|rpu
operator|->
name|rpu_keeplen
condition|)
block|{
if|if
condition|(
operator|(
name|rai
operator|=
name|if_indextorainfo
argument_list|(
name|ifindex
argument_list|)
operator|)
operator|==
name|NULL
condition|)
continue|continue;
comment|/* non-advertising IF */
name|TAILQ_FOREACH
argument_list|(
argument|pfx
argument_list|,
argument|&rai->rai_prefix
argument_list|,
argument|pfx_next
argument_list|)
block|{
name|struct
name|timeval
name|now
decl_stmt|;
if|if
condition|(
name|prefix_match
argument_list|(
operator|&
name|pfx
operator|->
name|pfx_prefix
argument_list|,
name|pfx
operator|->
name|pfx_prefixlen
argument_list|,
operator|&
name|rpm
operator|->
name|rpm_prefix
argument_list|,
name|rpm
operator|->
name|rpm_matchlen
argument_list|)
condition|)
block|{
comment|/* change parameters */
name|pfx
operator|->
name|pfx_validlifetime
operator|=
name|ntohl
argument_list|(
name|rpu
operator|->
name|rpu_vltime
argument_list|)
expr_stmt|;
name|pfx
operator|->
name|pfx_preflifetime
operator|=
name|ntohl
argument_list|(
name|rpu
operator|->
name|rpu_pltime
argument_list|)
expr_stmt|;
if|if
condition|(
name|irr
operator|->
name|irr_rrf_decrvalid
condition|)
block|{
name|gettimeofday
argument_list|(
operator|&
name|now
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|pfx
operator|->
name|pfx_vltimeexpire
operator|=
name|now
operator|.
name|tv_sec
operator|+
name|pfx
operator|->
name|pfx_validlifetime
expr_stmt|;
block|}
else|else
name|pfx
operator|->
name|pfx_vltimeexpire
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|irr
operator|->
name|irr_rrf_decrprefd
condition|)
block|{
name|gettimeofday
argument_list|(
operator|&
name|now
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|pfx
operator|->
name|pfx_pltimeexpire
operator|=
name|now
operator|.
name|tv_sec
operator|+
name|pfx
operator|->
name|pfx_preflifetime
expr_stmt|;
block|}
else|else
name|pfx
operator|->
name|pfx_pltimeexpire
operator|=
literal|0
expr_stmt|;
block|}
block|}
block|}
block|}
block|}
end_function

begin_comment
comment|/*  * process a Prefix Control Operation(PCO).  * return 0 on success, 1 on failure  */
end_comment

begin_function
specifier|static
name|int
name|do_pco
parameter_list|(
name|struct
name|icmp6_router_renum
modifier|*
name|rr
parameter_list|,
name|int
name|len
parameter_list|,
name|struct
name|rr_pco_match
modifier|*
name|rpm
parameter_list|)
block|{
name|int
name|ifindex
init|=
literal|0
decl_stmt|;
name|struct
name|in6_rrenumreq
name|irr
decl_stmt|;
if|if
condition|(
operator|(
name|rr_pco_check
argument_list|(
name|len
argument_list|,
name|rpm
argument_list|)
operator|!=
literal|0
operator|)
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
name|s
operator|==
operator|-
literal|1
operator|&&
operator|(
name|s
operator|=
name|socket
argument_list|(
name|AF_INET6
argument_list|,
name|SOCK_DGRAM
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"<%s> socket: %s"
argument_list|,
name|__func__
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|memset
argument_list|(
operator|&
name|irr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|irr
argument_list|)
argument_list|)
expr_stmt|;
name|irr
operator|.
name|irr_origin
operator|=
name|PR_ORIG_RR
expr_stmt|;
name|irr
operator|.
name|irr_m_len
operator|=
name|rpm
operator|->
name|rpm_matchlen
expr_stmt|;
name|irr
operator|.
name|irr_m_minlen
operator|=
name|rpm
operator|->
name|rpm_minlen
expr_stmt|;
name|irr
operator|.
name|irr_m_maxlen
operator|=
name|rpm
operator|->
name|rpm_maxlen
expr_stmt|;
name|irr
operator|.
name|irr_matchprefix
operator|.
name|sin6_len
operator|=
sizeof|sizeof
argument_list|(
name|irr
operator|.
name|irr_matchprefix
argument_list|)
expr_stmt|;
name|irr
operator|.
name|irr_matchprefix
operator|.
name|sin6_family
operator|=
name|AF_INET6
expr_stmt|;
name|irr
operator|.
name|irr_matchprefix
operator|.
name|sin6_addr
operator|=
name|rpm
operator|->
name|rpm_prefix
expr_stmt|;
while|while
condition|(
name|if_indextoname
argument_list|(
operator|++
name|ifindex
argument_list|,
name|irr
operator|.
name|irr_name
argument_list|)
condition|)
block|{
comment|/* 		 * if ICMP6_RR_FLAGS_FORCEAPPLY(A flag) is 0 and 		 * IFF_UP is off, the interface is not applied 		 */
if|if
condition|(
operator|(
name|rr
operator|->
name|rr_flags
operator|&
name|ICMP6_RR_FLAGS_FORCEAPPLY
operator|)
operator|==
literal|0
operator|&&
operator|(
name|iflist
index|[
name|ifindex
index|]
operator|->
name|ifm_flags
operator|&
name|IFF_UP
operator|)
operator|==
literal|0
condition|)
continue|continue;
comment|/* TODO: interface scope check */
name|do_use_prefix
argument_list|(
name|len
argument_list|,
name|rpm
argument_list|,
operator|&
name|irr
argument_list|,
name|ifindex
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|errno
operator|==
name|ENXIO
condition|)
return|return
operator|(
literal|0
operator|)
return|;
elseif|else
if|if
condition|(
name|errno
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"<%s> if_indextoname: %s"
argument_list|,
name|__func__
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * call do_pco() for each Prefix Control Operations(PCOs) in a received  * Router Renumbering Command packet.  * return 0 on success, 1 on failure  */
end_comment

begin_function
specifier|static
name|int
name|do_rr
parameter_list|(
name|int
name|len
parameter_list|,
name|struct
name|icmp6_router_renum
modifier|*
name|rr
parameter_list|)
block|{
name|struct
name|rr_pco_match
modifier|*
name|rpm
decl_stmt|;
name|char
modifier|*
name|cp
decl_stmt|,
modifier|*
name|lim
decl_stmt|;
name|lim
operator|=
operator|(
name|char
operator|*
operator|)
name|rr
operator|+
name|len
expr_stmt|;
name|cp
operator|=
operator|(
name|char
operator|*
operator|)
operator|(
name|rr
operator|+
literal|1
operator|)
expr_stmt|;
name|len
operator|-=
sizeof|sizeof
argument_list|(
expr|struct
name|icmp6_router_renum
argument_list|)
expr_stmt|;
comment|/* get iflist block from kernel again, to get up-to-date information */
name|init_iflist
argument_list|()
expr_stmt|;
while|while
condition|(
name|cp
operator|<
name|lim
condition|)
block|{
name|int
name|rpmlen
decl_stmt|;
name|rpm
operator|=
operator|(
expr|struct
name|rr_pco_match
operator|*
operator|)
name|cp
expr_stmt|;
if|if
condition|(
operator|(
name|size_t
operator|)
name|len
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|rr_pco_match
argument_list|)
condition|)
block|{
name|tooshort
label|:
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"<%s> pkt too short. left len = %d. "
literal|"gabage at end of pkt?"
argument_list|,
name|__func__
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|rpmlen
operator|=
name|rpm
operator|->
name|rpm_len
operator|<<
literal|3
expr_stmt|;
if|if
condition|(
name|len
operator|<
name|rpmlen
condition|)
goto|goto
name|tooshort
goto|;
if|if
condition|(
name|do_pco
argument_list|(
name|rr
argument_list|,
name|rpmlen
argument_list|,
name|rpm
argument_list|)
condition|)
block|{
name|syslog
argument_list|(
name|LOG_WARNING
argument_list|,
literal|"<%s> invalid PCO"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
goto|goto
name|next
goto|;
block|}
name|next
label|:
name|cp
operator|+=
name|rpmlen
expr_stmt|;
name|len
operator|-=
name|rpmlen
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * check validity of a router renumbering command packet  * return 0 on success, 1 on failure  */
end_comment

begin_function
specifier|static
name|int
name|rr_command_check
parameter_list|(
name|int
name|len
parameter_list|,
name|struct
name|icmp6_router_renum
modifier|*
name|rr
parameter_list|,
name|struct
name|in6_addr
modifier|*
name|from
parameter_list|,
name|struct
name|in6_addr
modifier|*
name|dst
parameter_list|)
block|{
name|u_char
name|ntopbuf
index|[
name|INET6_ADDRSTRLEN
index|]
decl_stmt|;
comment|/* omit rr minimal length check. hope kernel have done it. */
comment|/* rr_command length check */
if|if
condition|(
operator|(
name|size_t
operator|)
name|len
operator|<
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|icmp6_router_renum
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|rr_pco_match
argument_list|)
operator|)
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"<%s> rr_command len %d is too short"
argument_list|,
name|__func__
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
comment|/* destination check. only for multicast. omit unicast check. */
if|if
condition|(
name|IN6_IS_ADDR_MULTICAST
argument_list|(
name|dst
argument_list|)
operator|&&
operator|!
name|IN6_IS_ADDR_MC_LINKLOCAL
argument_list|(
name|dst
argument_list|)
operator|&&
operator|!
name|IN6_IS_ADDR_MC_SITELOCAL
argument_list|(
name|dst
argument_list|)
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"<%s> dst mcast addr %s is illegal"
argument_list|,
name|__func__
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|dst
argument_list|,
name|ntopbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|ntopbuf
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
comment|/* seqnum and segnum check */
if|if
condition|(
name|rro
operator|.
name|rro_seqnum
operator|>
name|rr
operator|->
name|rr_seqnum
condition|)
block|{
name|syslog
argument_list|(
name|LOG_WARNING
argument_list|,
literal|"<%s> rcvd old seqnum %d from %s"
argument_list|,
name|__func__
argument_list|,
operator|(
name|u_int32_t
operator|)
name|ntohl
argument_list|(
name|rr
operator|->
name|rr_seqnum
argument_list|)
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|from
argument_list|,
name|ntopbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|ntopbuf
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|rro
operator|.
name|rro_seqnum
operator|==
name|rr
operator|->
name|rr_seqnum
operator|&&
operator|(
name|rr
operator|->
name|rr_flags
operator|&
name|ICMP6_RR_FLAGS_TEST
operator|)
operator|==
literal|0
operator|&&
name|RR_ISSET_SEGNUM
argument_list|(
name|rro
operator|.
name|rro_segnum_bits
argument_list|,
name|rr
operator|->
name|rr_segnum
argument_list|)
condition|)
block|{
if|if
condition|(
operator|(
name|rr
operator|->
name|rr_flags
operator|&
name|ICMP6_RR_FLAGS_REQRESULT
operator|)
operator|!=
literal|0
condition|)
name|syslog
argument_list|(
name|LOG_WARNING
argument_list|,
literal|"<%s> rcvd duped segnum %d from %s"
argument_list|,
name|__func__
argument_list|,
name|rr
operator|->
name|rr_segnum
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|from
argument_list|,
name|ntopbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|ntopbuf
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
comment|/* update seqnum */
if|if
condition|(
name|rro
operator|.
name|rro_seqnum
operator|!=
name|rr
operator|->
name|rr_seqnum
condition|)
block|{
comment|/* then must be "<" */
comment|/* init rro_segnum_bits */
name|memset
argument_list|(
name|rro
operator|.
name|rro_segnum_bits
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|rro
operator|.
name|rro_segnum_bits
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|rro
operator|.
name|rro_seqnum
operator|=
name|rr
operator|->
name|rr_seqnum
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|rr_command_input
parameter_list|(
name|int
name|len
parameter_list|,
name|struct
name|icmp6_router_renum
modifier|*
name|rr
parameter_list|,
name|struct
name|in6_addr
modifier|*
name|from
parameter_list|,
name|struct
name|in6_addr
modifier|*
name|dst
parameter_list|)
block|{
comment|/* rr_command validity check */
if|if
condition|(
name|rr_command_check
argument_list|(
name|len
argument_list|,
name|rr
argument_list|,
name|from
argument_list|,
name|dst
argument_list|)
condition|)
goto|goto
name|failed
goto|;
if|if
condition|(
operator|(
name|rr
operator|->
name|rr_flags
operator|&
operator|(
name|ICMP6_RR_FLAGS_TEST
operator||
name|ICMP6_RR_FLAGS_REQRESULT
operator|)
operator|)
operator|==
name|ICMP6_RR_FLAGS_TEST
condition|)
return|return;
comment|/* do router renumbering */
if|if
condition|(
name|do_rr
argument_list|(
name|len
argument_list|,
name|rr
argument_list|)
condition|)
goto|goto
name|failed
goto|;
comment|/* update segnum */
name|RR_SET_SEGNUM
argument_list|(
name|rro
operator|.
name|rro_segnum_bits
argument_list|,
name|rr
operator|->
name|rr_segnum
argument_list|)
expr_stmt|;
return|return;
name|failed
label|:
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"<%s> received RR was invalid"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|void
name|rr_input
parameter_list|(
name|int
name|len
parameter_list|,
name|struct
name|icmp6_router_renum
modifier|*
name|rr
parameter_list|,
name|struct
name|in6_pktinfo
modifier|*
name|pi
parameter_list|,
name|struct
name|sockaddr_in6
modifier|*
name|from
parameter_list|,
name|struct
name|in6_addr
modifier|*
name|dst
parameter_list|)
block|{
name|u_char
name|ntopbuf
index|[
literal|2
index|]
index|[
name|INET6_ADDRSTRLEN
index|]
decl_stmt|,
name|ifnamebuf
index|[
name|IFNAMSIZ
index|]
decl_stmt|;
name|syslog
argument_list|(
name|LOG_DEBUG
argument_list|,
literal|"<%s> RR received from %s to %s on %s"
argument_list|,
name|__func__
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
operator|&
name|from
operator|->
name|sin6_addr
argument_list|,
name|ntopbuf
index|[
literal|0
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|ntopbuf
index|[
literal|0
index|]
argument_list|)
argument_list|)
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
operator|&
name|dst
argument_list|,
name|ntopbuf
index|[
literal|1
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|ntopbuf
index|[
literal|1
index|]
argument_list|)
argument_list|)
argument_list|,
name|if_indextoname
argument_list|(
name|pi
operator|->
name|ipi6_ifindex
argument_list|,
name|ifnamebuf
argument_list|)
argument_list|)
expr_stmt|;
comment|/* packet validation based on Section 4.1 of RFC2894 */
if|if
condition|(
operator|(
name|size_t
operator|)
name|len
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|icmp6_router_renum
argument_list|)
condition|)
block|{
name|syslog
argument_list|(
name|LOG_NOTICE
argument_list|,
literal|"<%s>: RR short message (size %d) from %s to %s on %s"
argument_list|,
name|__func__
argument_list|,
name|len
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
operator|&
name|from
operator|->
name|sin6_addr
argument_list|,
name|ntopbuf
index|[
literal|0
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|ntopbuf
index|[
literal|0
index|]
argument_list|)
argument_list|)
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
operator|&
name|dst
argument_list|,
name|ntopbuf
index|[
literal|1
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|ntopbuf
index|[
literal|1
index|]
argument_list|)
argument_list|)
argument_list|,
name|if_indextoname
argument_list|(
name|pi
operator|->
name|ipi6_ifindex
argument_list|,
name|ifnamebuf
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 	 * If the IPv6 destination address is neither an All Routers multicast 	 * address [AARCH] nor one of the receiving router's unicast addresses, 	 * the message MUST be discarded and SHOULD be logged to network 	 * management. 	 * We rely on the kernel input routine for unicast addresses, and thus 	 * check multicast destinations only. 	 */
if|if
condition|(
name|IN6_IS_ADDR_MULTICAST
argument_list|(
operator|&
name|pi
operator|->
name|ipi6_addr
argument_list|)
operator|&&
operator|!
name|IN6_ARE_ADDR_EQUAL
argument_list|(
operator|&
name|sin6_sitelocal_allrouters
operator|.
name|sin6_addr
argument_list|,
operator|&
name|pi
operator|->
name|ipi6_addr
argument_list|)
condition|)
block|{
name|syslog
argument_list|(
name|LOG_NOTICE
argument_list|,
literal|"<%s>: RR message with invalid destination (%s) "
literal|"from %s on %s"
argument_list|,
name|__func__
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
operator|&
name|dst
argument_list|,
name|ntopbuf
index|[
literal|0
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|ntopbuf
index|[
literal|0
index|]
argument_list|)
argument_list|)
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
operator|&
name|from
operator|->
name|sin6_addr
argument_list|,
name|ntopbuf
index|[
literal|1
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|ntopbuf
index|[
literal|1
index|]
argument_list|)
argument_list|)
argument_list|,
name|if_indextoname
argument_list|(
name|pi
operator|->
name|ipi6_ifindex
argument_list|,
name|ifnamebuf
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|rr_rcvifindex
operator|=
name|pi
operator|->
name|ipi6_ifindex
expr_stmt|;
switch|switch
condition|(
name|rr
operator|->
name|rr_code
condition|)
block|{
case|case
name|ICMP6_ROUTER_RENUMBERING_COMMAND
case|:
name|rr_command_input
argument_list|(
name|len
argument_list|,
name|rr
argument_list|,
operator|&
name|from
operator|->
name|sin6_addr
argument_list|,
name|dst
argument_list|)
expr_stmt|;
comment|/* TODO: send reply msg */
break|break;
case|case
name|ICMP6_ROUTER_RENUMBERING_RESULT
case|:
comment|/* RESULT will be processed by rrenumd */
break|break;
case|case
name|ICMP6_ROUTER_RENUMBERING_SEQNUM_RESET
case|:
comment|/* TODO: sequence number reset */
break|break;
default|default:
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"<%s> received unknown code %d"
argument_list|,
name|__func__
argument_list|,
name|rr
operator|->
name|rr_code
argument_list|)
expr_stmt|;
break|break;
block|}
return|return;
block|}
end_function

end_unit


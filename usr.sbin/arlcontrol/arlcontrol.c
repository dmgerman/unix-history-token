begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * $RISS: if_arl/arlconfig/arlconfig.c,v 1.5 2004/03/16 05:00:21 count Exp $  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/ethernet.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/if_ether.h>
end_include

begin_include
include|#
directive|include
file|<err.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<limits.h>
end_include

begin_include
include|#
directive|include
file|<dev/arl/if_arlreg.h>
end_include

begin_struct
struct|struct
name|freq_list
block|{
name|short
name|fr_no
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
name|struct
name|freq_list
name|freq_list_1
index|[]
init|=
block|{
block|{
literal|0
block|,
literal|"908.50"
block|}
block|,
block|{
literal|1
block|,
literal|"910.06"
block|}
block|,
block|{
literal|2
block|,
literal|"915.52"
block|}
block|,
block|{
literal|3
block|,
literal|"915.00"
block|}
block|,
block|{
literal|4
block|,
literal|"917.83"
block|}
block|,
block|{
literal|5
block|,
literal|"919.22"
block|}
block|,
block|{
literal|6
block|,
literal|"922.26"
block|}
block|,
block|{
literal|7
block|,
literal|"911.45"
block|}
block|,
block|{
literal|8
block|,
literal|"915.00"
block|}
block|,
block|{
literal|9
block|,
literal|"918.55"
block|}
block|,
block|{
literal|10
block|,
literal|"915.00"
block|}
block|,
block|{
literal|11
block|,
literal|"915.00"
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|freq_list
name|freq_list_6
index|[]
init|=
block|{
block|{
literal|0
block|,
literal|"920.31"
block|}
block|,
block|{
literal|1
block|,
literal|"920.33"
block|}
block|,
block|{
literal|2
block|,
literal|"921.55"
block|}
block|,
block|{
literal|3
block|,
literal|"922.17"
block|}
block|,
block|{
literal|4
block|,
literal|"922.79"
block|}
block|,
block|{
literal|5
block|,
literal|"921.46"
block|}
block|,
block|{
literal|6
block|,
literal|"921.55"
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|freq_list
name|freq_list_9
index|[]
init|=
block|{
block|{
literal|0
block|,
literal|"Bad"
block|}
block|,
block|{
literal|1
block|,
literal|"2412"
block|}
block|,
block|{
literal|2
block|,
literal|"2427"
block|}
block|,
block|{
literal|3
block|,
literal|"2442"
block|}
block|,
block|{
literal|4
block|,
literal|"2457"
block|}
block|,
block|{
literal|5
block|,
literal|"2465"
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|freq_list
name|freq_list_10
index|[]
init|=
block|{
block|{
literal|0
block|,
literal|"Bad"
block|}
block|,
block|{
literal|1
block|,
literal|"2412"
block|}
block|,
block|{
literal|2
block|,
literal|"2427"
block|}
block|,
block|{
literal|3
block|,
literal|"2442"
block|}
block|,
block|{
literal|4
block|,
literal|"2457"
block|}
block|,
block|{
literal|5
block|,
literal|"2472"
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|freq_list
name|freq_list_11
index|[]
init|=
block|{
block|{
literal|0
block|,
literal|"Bad"
block|}
block|,
block|{
literal|1
block|,
literal|"2484"
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|freq_list
name|freq_list_12
index|[]
init|=
block|{
block|{
literal|0
block|,
literal|"Bad"
block|}
block|,
block|{
literal|1
block|,
literal|"2457"
block|}
block|,
block|{
literal|2
block|,
literal|"2465"
block|}
block|,
block|{
literal|3
block|,
literal|"2472"
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|freq_list
name|freq_list_13
index|[]
init|=
block|{
block|{
literal|0
block|,
literal|"Bad"
block|}
block|,
block|{
literal|1
block|,
literal|"2411"
block|}
block|,
block|{
literal|2
block|,
literal|"2425"
block|}
block|,
block|{
literal|3
block|,
literal|"2439"
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|freq_list
name|freq_list_14
index|[]
init|=
block|{
block|{
literal|0
block|,
literal|"Bad"
block|}
block|,
block|{
literal|1
block|,
literal|"2427"
block|}
block|,
block|{
literal|2
block|,
literal|"2442"
block|}
block|,
block|{
literal|3
block|,
literal|"2457"
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|freq_list
name|freq_list_15
index|[]
init|=
block|{
block|{
literal|0
block|,
literal|"Bad"
block|}
block|,
block|{
literal|1
block|,
literal|"2460"
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|MAXFREQ
parameter_list|(
name|a
parameter_list|)
value|sizeof(a)/sizeof(struct freq_list)
end_define

begin_struct
struct|struct
name|rate_list
block|{
name|short
name|rate_no
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
name|struct
name|rate_list
name|rate_list_2400
index|[]
init|=
block|{
block|{
literal|0
block|,
literal|"Bad"
block|}
block|,
block|{
literal|1
block|,
literal|"354"
block|}
block|,
block|{
literal|2
block|,
literal|"512"
block|}
block|,
block|{
literal|3
block|,
literal|"1000"
block|}
block|,
block|{
literal|4
block|,
literal|"2000"
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|radio_type
block|{
name|int
name|id
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
block|}
name|radio_type_list
index|[]
init|=
block|{
block|{
literal|0
block|,
literal|"No EPROM"
block|}
block|,
block|{
literal|1
block|,
literal|"092/094"
block|}
block|,
block|{
literal|2
block|,
literal|"020"
block|}
block|,
block|{
literal|3
block|,
literal|"092A"
block|}
block|,
block|{
literal|4
block|,
literal|"020B"
block|}
block|,
block|{
literal|5
block|,
literal|"095"
block|}
block|,
block|{
literal|6
block|,
literal|"024"
block|}
block|,
block|{
literal|7
block|,
literal|"025B"
block|}
block|,
block|{
literal|8
block|,
literal|"024B"
block|}
block|,
block|{
literal|9
block|,
literal|"024C"
block|}
block|,
block|{
literal|10
block|,
literal|"025C"
block|}
block|,
block|{
literal|11
block|,
literal|"024-1A"
block|}
block|,
block|{
literal|12
block|,
literal|"025-1A"
block|}
block|,
block|{
literal|13
block|,
literal|"Other"
block|}
block|}
struct|;
end_struct

begin_struct
specifier|static
struct|struct
name|ch_list
block|{
name|short
name|chan
decl_stmt|;
name|char
modifier|*
name|fr
decl_stmt|;
name|char
modifier|*
name|country
decl_stmt|;
name|struct
name|rate_list
modifier|*
name|rate
decl_stmt|;
name|struct
name|freq_list
modifier|*
name|freq
decl_stmt|;
name|int
name|max_freq
decl_stmt|;
block|}
name|CHSET
index|[]
init|=
block|{
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|1
block|,
literal|"900 Mhz"
block|,
literal|"Canada, U.S.A., Mexico"
block|,
literal|0
block|,
name|freq_list_1
block|,
name|MAXFREQ
argument_list|(
argument|freq_list_1
argument_list|)
block|}
block|,
block|{
literal|2
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|3
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|4
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|5
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|6
block|,
literal|"900 Mhz"
block|,
literal|"Australia"
block|,
literal|0
block|,
name|freq_list_6
block|,
name|MAXFREQ
argument_list|(
argument|freq_list_6
argument_list|)
block|}
block|,
block|{
literal|7
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|8
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|9
block|,
literal|"2400 Mhz"
block|,
literal|"North America"
block|,
name|rate_list_2400
block|,
name|freq_list_9
block|,
name|MAXFREQ
argument_list|(
argument|freq_list_9
argument_list|)
block|}
block|,
block|{
literal|10
block|,
literal|"2400 Mhz"
block|,
literal|"E.T.S.I"
block|,
name|rate_list_2400
block|,
name|freq_list_10
block|,
name|MAXFREQ
argument_list|(
argument|freq_list_10
argument_list|)
block|}
block|,
block|{
literal|11
block|,
literal|"2400 Mhz"
block|,
literal|"Japan"
block|,
name|rate_list_2400
block|,
name|freq_list_11
block|,
name|MAXFREQ
argument_list|(
argument|freq_list_11
argument_list|)
block|}
block|,
block|{
literal|12
block|,
literal|"2400 Mhz"
block|,
literal|"France"
block|,
name|rate_list_2400
block|,
name|freq_list_12
block|,
name|MAXFREQ
argument_list|(
argument|freq_list_12
argument_list|)
block|}
block|,
block|{
literal|13
block|,
literal|"2400 Mhz"
block|,
literal|"Australia"
block|,
name|rate_list_2400
block|,
name|freq_list_13
block|,
name|MAXFREQ
argument_list|(
argument|freq_list_13
argument_list|)
block|}
block|,
block|{
literal|14
block|,
literal|"2400 Mhz"
block|,
literal|"Germany"
block|,
name|rate_list_2400
block|,
name|freq_list_14
block|,
name|MAXFREQ
argument_list|(
argument|freq_list_14
argument_list|)
block|}
block|,
block|{
literal|15
block|,
literal|"2400 Mhz"
block|,
literal|"U.K.(MPT1349),Spain"
block|,
name|rate_list_2400
block|,
name|freq_list_15
block|,
name|MAXFREQ
argument_list|(
argument|freq_list_15
argument_list|)
block|}
block|}
struct|;
end_struct

begin_decl_stmt
name|char
modifier|*
name|registrationMode
index|[]
init|=
block|{
literal|"NON-TMA"
block|,
literal|"TMA"
block|,
literal|"PSP"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|priorityList
index|[]
init|=
block|{
literal|"normal"
block|,
literal|"high"
block|,
literal|"highest"
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|usage
parameter_list|()
block|{
specifier|const
name|char
modifier|*
name|progname
init|=
name|getprogname
argument_list|()
decl_stmt|;
if|#
directive|if
literal|0
block|fprintf(stderr, "\nArlan configuration utility.\n\n");
endif|#
directive|endif
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Usage: %s<ifname> [<param><value> ...]\n"
argument_list|,
name|progname
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t<ifname>\tArlan interface name.\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t<param>\t\tParameter name (see below).\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t<value>\t\tNew value for parameter.\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Parameter name:\t\tValue:\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\tcountry\t\tset Country (9-15)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\tpriority\tset Priority (normal, high, highest)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\ttxretry\t\tset Arlan Tx retry.\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"or: %s<ifname> stat\n"
argument_list|,
name|progname
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\tprint internal arlan statistics block\n"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|ARLCACHE
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"or: %s<ifname> quality\n"
argument_list|,
name|progname
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\tprint receive packet level and quality\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|print_al
parameter_list|(
name|struct
name|arl_cfg_param
modifier|*
name|arl_io
parameter_list|)
block|{
name|printf
argument_list|(
literal|"Arlan-655(IC2000) type 0x%x v%d.%d, radio module type %s\n"
argument_list|,
name|arl_io
operator|->
name|hardwareType
argument_list|,
name|arl_io
operator|->
name|majorHardwareVersion
argument_list|,
name|arl_io
operator|->
name|minorHardwareVersion
argument_list|,
operator|(
name|arl_io
operator|->
name|radioModule
operator|<
literal|13
operator|)
condition|?
name|radio_type_list
index|[
name|arl_io
operator|->
name|radioModule
index|]
operator|.
name|name
else|:
literal|"Unknown"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tname %s, sid 0x%06x, mode %s, num tx retry %d\n"
argument_list|,
name|arl_io
operator|->
name|name
argument_list|,
operator|*
operator|(
name|int
operator|*
operator|)
name|arl_io
operator|->
name|sid
argument_list|,
operator|(
name|arl_io
operator|->
name|registrationMode
operator|<
literal|3
operator|)
condition|?
name|registrationMode
index|[
name|arl_io
operator|->
name|registrationMode
index|]
else|:
literal|"Unknown"
argument_list|,
name|arl_io
operator|->
name|txRetry
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tchannel set %d, %s, %s\n"
argument_list|,
name|arl_io
operator|->
name|channelSet
argument_list|,
name|CHSET
index|[
name|arl_io
operator|->
name|channelSet
index|]
operator|.
name|fr
argument_list|,
name|CHSET
index|[
name|arl_io
operator|->
name|channelSet
index|]
operator|.
name|country
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tfrequency %s Mhz, bitrate %s kb/s, priority %s, receive mode %d\n"
argument_list|,
operator|(
name|CHSET
index|[
name|arl_io
operator|->
name|channelSet
index|]
operator|.
name|freq
operator|&&
name|CHSET
index|[
name|arl_io
operator|->
name|channelSet
index|]
operator|.
name|max_freq
operator|>
name|arl_io
operator|->
name|channelNumber
operator|)
condition|?
name|CHSET
index|[
name|arl_io
operator|->
name|channelSet
index|]
operator|.
name|freq
index|[
name|arl_io
operator|->
name|channelNumber
index|]
operator|.
name|name
else|:
literal|"unknown"
argument_list|,
operator|(
name|CHSET
index|[
name|arl_io
operator|->
name|channelSet
index|]
operator|.
name|rate
operator|)
condition|?
name|CHSET
index|[
name|arl_io
operator|->
name|channelSet
index|]
operator|.
name|rate
index|[
name|arl_io
operator|->
name|spreadingCode
index|]
operator|.
name|name
else|:
literal|"unknown"
argument_list|,
name|arl_io
operator|->
name|priority
operator|<=
literal|2
condition|?
name|priorityList
index|[
name|arl_io
operator|->
name|priority
index|]
else|:
literal|"unknown"
argument_list|,
name|arl_io
operator|->
name|receiveMode
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tether %s"
argument_list|,
operator|(
name|char
operator|*
operator|)
name|ether_ntoa
argument_list|(
operator|(
expr|struct
name|ether_addr
operator|*
operator|)
name|arl_io
operator|->
name|lanCardNodeId
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" registered to %s\n"
argument_list|,
operator|(
name|char
operator|*
operator|)
name|ether_ntoa
argument_list|(
operator|(
expr|struct
name|ether_addr
operator|*
operator|)
name|arl_io
operator|->
name|specifiedRouter
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|print_stb
parameter_list|(
name|struct
name|arl_stats
name|stb
parameter_list|)
block|{
name|printf
argument_list|(
literal|"Arlan internal statistics block\n\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%8u\tdatagrams transmitted\n"
argument_list|,
name|stb
operator|.
name|numDatagramsTransmitted
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%8u\tre-transmitted\n"
argument_list|,
name|stb
operator|.
name|numReTransmissions
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%8u\tframes discarded internally in a router\n"
argument_list|,
name|stb
operator|.
name|numFramesDiscarded
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%8u\tdatagrams received\n"
argument_list|,
name|stb
operator|.
name|numDatagramsReceived
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%8u\tduplicate received frame\n"
argument_list|,
name|stb
operator|.
name|numDuplicateReceivedFrames
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%8u\tdatagrams discarded due to unavailable mail box buffer\n"
argument_list|,
name|stb
operator|.
name|numDatagramsDiscarded
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%8d\tmaximum of re-transmissions datagram\n"
argument_list|,
name|stb
operator|.
name|maxNumReTransmitDatagram
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%8d\tmaximum of re-transmissions frame\n"
argument_list|,
name|stb
operator|.
name|maxNumReTransmitFrames
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%8d\tmaximum of consecutive duplicate received frames\n"
argument_list|,
name|stb
operator|.
name|maxNumConsecutiveDuplicateFrames
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%8u\tbytes transmitted\n"
argument_list|,
name|stb
operator|.
name|numBytesTransmitted
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%8u\tbytes received\n"
argument_list|,
name|stb
operator|.
name|numBytesReceived
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%8u\tCRC errors\n"
argument_list|,
name|stb
operator|.
name|numCRCErrors
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%8u\tlength errors\n"
argument_list|,
name|stb
operator|.
name|numLengthErrors
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%8u\tabort errors\n"
argument_list|,
name|stb
operator|.
name|numAbortErrors
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%8u\tTX underuns\n"
argument_list|,
name|stb
operator|.
name|numTXUnderruns
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%8u\tRX overruns\n"
argument_list|,
name|stb
operator|.
name|numRXOverruns
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%8u\tHold Offs (channel tested busy, tx delayed)\n"
argument_list|,
name|stb
operator|.
name|numHoldOffs
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%8u\tframes transmitted\n"
argument_list|,
name|stb
operator|.
name|numFramesTransmitted
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%8u\tframes received\n"
argument_list|,
name|stb
operator|.
name|numFramesReceived
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%8u\treceive frames lost due unavailable buffer\n"
argument_list|,
name|stb
operator|.
name|numReceiveFramesLost
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%8u\tRX buffer overflows \n"
argument_list|,
name|stb
operator|.
name|numRXBufferOverflows
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%8u\tframes discarded due to Address mismatch\n"
argument_list|,
name|stb
operator|.
name|numFramesDiscardedAddrMismatch
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%8u\tframes discarded due to SID mismatch\n"
argument_list|,
name|stb
operator|.
name|numFramesDiscardedSIDMismatch
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%8u\tpolls transmitted\n"
argument_list|,
name|stb
operator|.
name|numPollsTransmistted
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%8u\tpoll acknowledges received\n"
argument_list|,
name|stb
operator|.
name|numPollAcknowledges
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%8u\tstatus vector timeout\n"
argument_list|,
name|stb
operator|.
name|numStatusVectorTimeouts
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%8u\tNACK packets received\n"
argument_list|,
name|stb
operator|.
name|numNACKReceived
argument_list|)
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|ARLCACHE
end_ifdef

begin_function
name|void
name|print_qlt
parameter_list|(
name|struct
name|arl_sigcache
modifier|*
name|qlt
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|u_int8_t
name|zero
index|[
literal|6
index|]
init|=
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAXARLCACHE
operator|&&
name|bcmp
argument_list|(
name|qlt
operator|->
name|macsrc
argument_list|,
name|zero
argument_list|,
literal|6
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"[%d]:"
argument_list|,
name|i
operator|+
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" %02x:%02x:%02x:%02x:%02x:%02x,"
argument_list|,
name|qlt
operator|->
name|macsrc
index|[
literal|0
index|]
operator|&
literal|0xff
argument_list|,
name|qlt
operator|->
name|macsrc
index|[
literal|1
index|]
operator|&
literal|0xff
argument_list|,
name|qlt
operator|->
name|macsrc
index|[
literal|2
index|]
operator|&
literal|0xff
argument_list|,
name|qlt
operator|->
name|macsrc
index|[
literal|3
index|]
operator|&
literal|0xff
argument_list|,
name|qlt
operator|->
name|macsrc
index|[
literal|4
index|]
operator|&
literal|0xff
argument_list|,
name|qlt
operator|->
name|macsrc
index|[
literal|5
index|]
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" rx lvl/qlty: %d/%d,"
argument_list|,
name|qlt
operator|->
name|level
index|[
name|ARLCACHE_RX
index|]
argument_list|,
name|qlt
operator|->
name|quality
index|[
name|ARLCACHE_RX
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" tx lvl/qlty: %d/%d"
argument_list|,
name|qlt
operator|->
name|level
index|[
name|ARLCACHE_TX
index|]
argument_list|,
name|qlt
operator|->
name|quality
index|[
name|ARLCACHE_TX
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|qlt
operator|++
expr_stmt|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|struct
name|ifreq
name|ifr
decl_stmt|;
name|struct
name|arl_req
name|arl_io
decl_stmt|;
name|struct
name|ether_addr
modifier|*
name|ea
decl_stmt|;
name|struct
name|arl_stats
name|stb
decl_stmt|;
name|struct
name|arl_sigcache
name|qlt
index|[
name|MAXARLCACHE
index|]
decl_stmt|;
name|int
name|sd
decl_stmt|,
name|argind
decl_stmt|,
name|val
init|=
operator|-
literal|1
decl_stmt|;
name|char
modifier|*
name|param
decl_stmt|,
modifier|*
name|value
decl_stmt|;
if|if
condition|(
name|argc
operator|<
literal|2
condition|)
name|usage
argument_list|()
expr_stmt|;
name|sd
operator|=
name|socket
argument_list|(
name|AF_INET
argument_list|,
name|SOCK_DGRAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|sd
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"socket"
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|)
argument_list|)
expr_stmt|;
name|ifr
operator|.
name|ifr_addr
operator|.
name|sa_family
operator|=
name|AF_INET
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|arl_io
argument_list|,
sizeof|sizeof
argument_list|(
name|arl_io
argument_list|)
argument_list|)
expr_stmt|;
name|ifr
operator|.
name|ifr_data
operator|=
operator|(
name|caddr_t
operator|)
operator|&
name|arl_io
expr_stmt|;
if|if
condition|(
name|argc
operator|==
literal|2
condition|)
block|{
if|if
condition|(
name|ioctl
argument_list|(
name|sd
argument_list|,
name|SIOCGARLALL
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|ifr
argument_list|)
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"Get ALL"
argument_list|)
expr_stmt|;
name|print_al
argument_list|(
operator|&
name|arl_io
operator|.
name|cfg
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|argc
operator|==
literal|3
condition|)
block|{
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|,
literal|"stat"
argument_list|)
condition|)
block|{
name|strncpy
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|)
argument_list|)
expr_stmt|;
name|ifr
operator|.
name|ifr_addr
operator|.
name|sa_family
operator|=
name|AF_INET
expr_stmt|;
name|ifr
operator|.
name|ifr_data
operator|=
operator|(
name|caddr_t
operator|)
operator|&
name|stb
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|sd
argument_list|,
name|SIOCGARLSTB
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|ifr
argument_list|)
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"Get STB"
argument_list|)
expr_stmt|;
name|print_stb
argument_list|(
name|stb
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|ARLCACHE
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|,
literal|"quality"
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|)
argument_list|)
expr_stmt|;
name|ifr
operator|.
name|ifr_addr
operator|.
name|sa_family
operator|=
name|AF_INET
expr_stmt|;
name|ifr
operator|.
name|ifr_data
operator|=
operator|(
name|caddr_t
operator|)
name|qlt
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|sd
argument_list|,
name|SIOCGARLQLT
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|ifr
argument_list|)
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"Get QLT"
argument_list|)
expr_stmt|;
name|print_qlt
argument_list|(
name|qlt
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
block|}
name|arl_io
operator|.
name|what_set
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|argind
operator|=
literal|2
init|;
name|argind
operator|<
name|argc
condition|;
name|argind
operator|+=
literal|2
control|)
block|{
name|param
operator|=
name|argv
index|[
name|argind
index|]
expr_stmt|;
name|value
operator|=
name|argv
index|[
name|argind
operator|+
literal|1
index|]
expr_stmt|;
name|val
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
name|param
argument_list|,
literal|"priority"
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
name|value
argument_list|,
literal|"normal"
argument_list|)
condition|)
name|val
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
name|value
argument_list|,
literal|"high"
argument_list|)
condition|)
name|val
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
name|value
argument_list|,
literal|"highest"
argument_list|)
condition|)
name|val
operator|=
literal|2
expr_stmt|;
if|if
condition|(
name|val
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"Bad priority - %s"
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|arl_io
operator|.
name|cfg
operator|.
name|priority
operator|=
name|val
expr_stmt|;
name|arl_io
operator|.
name|what_set
operator||=
name|ARLAN_SET_priority
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
name|param
argument_list|,
literal|"parent"
argument_list|)
condition|)
block|{
if|if
condition|(
operator|(
name|ea
operator|=
operator|(
expr|struct
name|ether_addr
operator|*
operator|)
name|ether_aton
argument_list|(
name|value
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"Bad parent's MAC - %s"
argument_list|,
name|value
argument_list|)
expr_stmt|;
for|for
control|(
name|val
operator|=
literal|0
init|;
name|val
operator|<
literal|6
condition|;
name|val
operator|++
control|)
block|{
name|arl_io
operator|.
name|cfg
operator|.
name|specifiedRouter
index|[
name|val
index|]
operator|=
operator|(
name|int
operator|)
name|ea
operator|->
name|octet
index|[
name|val
index|]
expr_stmt|;
block|}
name|arl_io
operator|.
name|what_set
operator||=
name|ARLAN_SET_specifiedRouter
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
name|param
argument_list|,
literal|"country"
argument_list|)
condition|)
block|{
name|arl_io
operator|.
name|cfg
operator|.
name|channelSet
operator|=
name|atoi
argument_list|(
name|value
argument_list|)
expr_stmt|;
name|arl_io
operator|.
name|what_set
operator||=
name|ARLAN_SET_channelSet
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
name|param
argument_list|,
literal|"txretry"
argument_list|)
condition|)
block|{
name|arl_io
operator|.
name|cfg
operator|.
name|txRetry
operator|=
name|atoi
argument_list|(
name|value
argument_list|)
expr_stmt|;
name|arl_io
operator|.
name|what_set
operator||=
name|ARLAN_SET_txRetry
expr_stmt|;
block|}
block|}
if|if
condition|(
name|arl_io
operator|.
name|what_set
condition|)
block|{
if|if
condition|(
name|ioctl
argument_list|(
name|sd
argument_list|,
name|SIOCSARLALL
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|ifr
argument_list|)
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"Set ALL"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|sd
argument_list|,
name|SIOCGARLALL
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|ifr
argument_list|)
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"Get ALL"
argument_list|)
expr_stmt|;
name|print_al
argument_list|(
operator|&
name|arl_io
operator|.
name|cfg
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

end_unit


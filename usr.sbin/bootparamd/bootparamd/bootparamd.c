begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  This code is not copyright, and is placed in the public domain. Feel free to use and modify. Please send modifications and/or suggestions + bug fixes to          Klas Heggemann<klas@nada.kth.se>  	$Id: bootparamd.c,v 1.2 1995/05/30 03:46:27 rgrimes Exp $  */
end_comment

begin_include
include|#
directive|include
file|<rpc/rpc.h>
end_include

begin_include
include|#
directive|include
file|<rpcsvc/yp_prot.h>
end_include

begin_include
include|#
directive|include
file|<rpcsvc/ypclnt.h>
end_include

begin_include
include|#
directive|include
file|"bootparam_prot.h"
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<syslog.h>
end_include

begin_decl_stmt
specifier|extern
name|int
name|debug
decl_stmt|,
name|dolog
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|unsigned
name|long
name|route_addr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|bootpfile
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|MAXLEN
value|800
end_define

begin_decl_stmt
name|struct
name|hostent
modifier|*
name|he
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|buffer
index|[
name|MAXLEN
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|hostname
index|[
name|MAX_MACHINE_NAME
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|askname
index|[
name|MAX_MACHINE_NAME
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|path
index|[
name|MAX_PATH_LEN
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|domain_name
index|[
name|MAX_MACHINE_NAME
index|]
decl_stmt|;
end_decl_stmt

begin_function
name|bp_whoami_res
modifier|*
name|bootparamproc_whoami_1
parameter_list|(
name|whoami
parameter_list|)
name|bp_whoami_arg
modifier|*
name|whoami
decl_stmt|;
block|{
name|long
name|haddr
decl_stmt|;
specifier|static
name|bp_whoami_res
name|res
decl_stmt|;
if|if
condition|(
name|debug
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"whoami got question for %d.%d.%d.%d\n"
argument_list|,
literal|255
operator|&
name|whoami
operator|->
name|client_address
operator|.
name|bp_address_u
operator|.
name|ip_addr
operator|.
name|net
argument_list|,
literal|255
operator|&
name|whoami
operator|->
name|client_address
operator|.
name|bp_address_u
operator|.
name|ip_addr
operator|.
name|host
argument_list|,
literal|255
operator|&
name|whoami
operator|->
name|client_address
operator|.
name|bp_address_u
operator|.
name|ip_addr
operator|.
name|lh
argument_list|,
literal|255
operator|&
name|whoami
operator|->
name|client_address
operator|.
name|bp_address_u
operator|.
name|ip_addr
operator|.
name|impno
argument_list|)
expr_stmt|;
if|if
condition|(
name|dolog
condition|)
name|syslog
argument_list|(
name|LOG_NOTICE
argument_list|,
literal|"whoami got question for %d.%d.%d.%d\n"
argument_list|,
literal|255
operator|&
name|whoami
operator|->
name|client_address
operator|.
name|bp_address_u
operator|.
name|ip_addr
operator|.
name|net
argument_list|,
literal|255
operator|&
name|whoami
operator|->
name|client_address
operator|.
name|bp_address_u
operator|.
name|ip_addr
operator|.
name|host
argument_list|,
literal|255
operator|&
name|whoami
operator|->
name|client_address
operator|.
name|bp_address_u
operator|.
name|ip_addr
operator|.
name|lh
argument_list|,
literal|255
operator|&
name|whoami
operator|->
name|client_address
operator|.
name|bp_address_u
operator|.
name|ip_addr
operator|.
name|impno
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|whoami
operator|->
name|client_address
operator|.
name|bp_address_u
operator|.
name|ip_addr
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|haddr
argument_list|,
sizeof|sizeof
argument_list|(
name|haddr
argument_list|)
argument_list|)
expr_stmt|;
name|he
operator|=
name|gethostbyaddr
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|haddr
argument_list|,
sizeof|sizeof
argument_list|(
name|haddr
argument_list|)
argument_list|,
name|AF_INET
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|he
condition|)
goto|goto
name|failed
goto|;
if|if
condition|(
name|debug
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"This is host %s\n"
argument_list|,
name|he
operator|->
name|h_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|dolog
condition|)
name|syslog
argument_list|(
name|LOG_NOTICE
argument_list|,
literal|"This is host %s\n"
argument_list|,
name|he
operator|->
name|h_name
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|askname
argument_list|,
name|he
operator|->
name|h_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|checkhost
argument_list|(
name|askname
argument_list|,
name|hostname
argument_list|)
condition|)
block|{
name|res
operator|.
name|client_name
operator|=
name|hostname
expr_stmt|;
name|getdomainname
argument_list|(
name|domain_name
argument_list|,
name|MAX_MACHINE_NAME
argument_list|)
expr_stmt|;
name|res
operator|.
name|domain_name
operator|=
name|domain_name
expr_stmt|;
if|if
condition|(
name|res
operator|.
name|router_address
operator|.
name|address_type
operator|!=
name|IP_ADDR_TYPE
condition|)
block|{
name|res
operator|.
name|router_address
operator|.
name|address_type
operator|=
name|IP_ADDR_TYPE
expr_stmt|;
name|bcopy
argument_list|(
operator|&
name|route_addr
argument_list|,
operator|&
name|res
operator|.
name|router_address
operator|.
name|bp_address_u
operator|.
name|ip_addr
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|debug
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Returning %s   %s    %d.%d.%d.%d\n"
argument_list|,
name|res
operator|.
name|client_name
argument_list|,
name|res
operator|.
name|domain_name
argument_list|,
literal|255
operator|&
name|res
operator|.
name|router_address
operator|.
name|bp_address_u
operator|.
name|ip_addr
operator|.
name|net
argument_list|,
literal|255
operator|&
name|res
operator|.
name|router_address
operator|.
name|bp_address_u
operator|.
name|ip_addr
operator|.
name|host
argument_list|,
literal|255
operator|&
name|res
operator|.
name|router_address
operator|.
name|bp_address_u
operator|.
name|ip_addr
operator|.
name|lh
argument_list|,
literal|255
operator|&
name|res
operator|.
name|router_address
operator|.
name|bp_address_u
operator|.
name|ip_addr
operator|.
name|impno
argument_list|)
expr_stmt|;
if|if
condition|(
name|dolog
condition|)
name|syslog
argument_list|(
name|LOG_NOTICE
argument_list|,
literal|"Returning %s   %s    %d.%d.%d.%d\n"
argument_list|,
name|res
operator|.
name|client_name
argument_list|,
name|res
operator|.
name|domain_name
argument_list|,
literal|255
operator|&
name|res
operator|.
name|router_address
operator|.
name|bp_address_u
operator|.
name|ip_addr
operator|.
name|net
argument_list|,
literal|255
operator|&
name|res
operator|.
name|router_address
operator|.
name|bp_address_u
operator|.
name|ip_addr
operator|.
name|host
argument_list|,
literal|255
operator|&
name|res
operator|.
name|router_address
operator|.
name|bp_address_u
operator|.
name|ip_addr
operator|.
name|lh
argument_list|,
literal|255
operator|&
name|res
operator|.
name|router_address
operator|.
name|bp_address_u
operator|.
name|ip_addr
operator|.
name|impno
argument_list|)
expr_stmt|;
return|return
operator|(
operator|&
name|res
operator|)
return|;
block|}
name|failed
label|:
if|if
condition|(
name|debug
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"whoami failed\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|dolog
condition|)
name|syslog
argument_list|(
name|LOG_NOTICE
argument_list|,
literal|"whoami failed\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_function
name|bp_getfile_res
modifier|*
name|bootparamproc_getfile_1
parameter_list|(
name|getfile
parameter_list|)
name|bp_getfile_arg
modifier|*
name|getfile
decl_stmt|;
block|{
name|char
modifier|*
name|where
decl_stmt|,
modifier|*
name|index
argument_list|()
decl_stmt|;
specifier|static
name|bp_getfile_res
name|res
decl_stmt|;
if|if
condition|(
name|debug
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"getfile got question for \"%s\" and file \"%s\"\n"
argument_list|,
name|getfile
operator|->
name|client_name
argument_list|,
name|getfile
operator|->
name|file_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|dolog
condition|)
name|syslog
argument_list|(
name|LOG_NOTICE
argument_list|,
literal|"getfile got question for \"%s\" and file \"%s\"\n"
argument_list|,
name|getfile
operator|->
name|client_name
argument_list|,
name|getfile
operator|->
name|file_id
argument_list|)
expr_stmt|;
name|he
operator|=
name|NULL
expr_stmt|;
name|he
operator|=
name|gethostbyname
argument_list|(
name|getfile
operator|->
name|client_name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|he
condition|)
goto|goto
name|failed
goto|;
name|strcpy
argument_list|(
name|askname
argument_list|,
name|he
operator|->
name|h_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|getthefile
argument_list|(
name|askname
argument_list|,
name|getfile
operator|->
name|file_id
argument_list|,
name|buffer
argument_list|)
condition|)
block|{
if|if
condition|(
name|where
operator|=
name|index
argument_list|(
name|buffer
argument_list|,
literal|':'
argument_list|)
condition|)
block|{
comment|/* buffer is re-written to contain the name of the info of file */
name|strncpy
argument_list|(
name|hostname
argument_list|,
name|buffer
argument_list|,
name|where
operator|-
name|buffer
argument_list|)
expr_stmt|;
name|hostname
index|[
name|where
operator|-
name|buffer
index|]
operator|=
literal|'\0'
expr_stmt|;
name|where
operator|++
expr_stmt|;
name|strcpy
argument_list|(
name|path
argument_list|,
name|where
argument_list|)
expr_stmt|;
name|he
operator|=
name|gethostbyname
argument_list|(
name|hostname
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|he
condition|)
goto|goto
name|failed
goto|;
name|bcopy
argument_list|(
name|he
operator|->
name|h_addr
argument_list|,
operator|&
name|res
operator|.
name|server_address
operator|.
name|bp_address_u
operator|.
name|ip_addr
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|res
operator|.
name|server_name
operator|=
name|hostname
expr_stmt|;
name|res
operator|.
name|server_path
operator|=
name|path
expr_stmt|;
name|res
operator|.
name|server_address
operator|.
name|address_type
operator|=
name|IP_ADDR_TYPE
expr_stmt|;
block|}
else|else
block|{
comment|/* special for dump, answer with null strings */
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|getfile
operator|->
name|file_id
argument_list|,
literal|"dump"
argument_list|)
condition|)
block|{
name|res
operator|.
name|server_name
operator|=
literal|""
expr_stmt|;
name|res
operator|.
name|server_path
operator|=
literal|""
expr_stmt|;
name|res
operator|.
name|server_address
operator|.
name|address_type
operator|=
name|IP_ADDR_TYPE
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|res
operator|.
name|server_address
operator|.
name|bp_address_u
operator|.
name|ip_addr
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
else|else
goto|goto
name|failed
goto|;
block|}
if|if
condition|(
name|debug
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"returning server:%s path:%s address: %d.%d.%d.%d\n"
argument_list|,
name|res
operator|.
name|server_name
argument_list|,
name|res
operator|.
name|server_path
argument_list|,
literal|255
operator|&
name|res
operator|.
name|server_address
operator|.
name|bp_address_u
operator|.
name|ip_addr
operator|.
name|net
argument_list|,
literal|255
operator|&
name|res
operator|.
name|server_address
operator|.
name|bp_address_u
operator|.
name|ip_addr
operator|.
name|host
argument_list|,
literal|255
operator|&
name|res
operator|.
name|server_address
operator|.
name|bp_address_u
operator|.
name|ip_addr
operator|.
name|lh
argument_list|,
literal|255
operator|&
name|res
operator|.
name|server_address
operator|.
name|bp_address_u
operator|.
name|ip_addr
operator|.
name|impno
argument_list|)
expr_stmt|;
if|if
condition|(
name|dolog
condition|)
name|syslog
argument_list|(
name|LOG_NOTICE
argument_list|,
literal|"returning server:%s path:%s address: %d.%d.%d.%d\n"
argument_list|,
name|res
operator|.
name|server_name
argument_list|,
name|res
operator|.
name|server_path
argument_list|,
literal|255
operator|&
name|res
operator|.
name|server_address
operator|.
name|bp_address_u
operator|.
name|ip_addr
operator|.
name|net
argument_list|,
literal|255
operator|&
name|res
operator|.
name|server_address
operator|.
name|bp_address_u
operator|.
name|ip_addr
operator|.
name|host
argument_list|,
literal|255
operator|&
name|res
operator|.
name|server_address
operator|.
name|bp_address_u
operator|.
name|ip_addr
operator|.
name|lh
argument_list|,
literal|255
operator|&
name|res
operator|.
name|server_address
operator|.
name|bp_address_u
operator|.
name|ip_addr
operator|.
name|impno
argument_list|)
expr_stmt|;
return|return
operator|(
operator|&
name|res
operator|)
return|;
block|}
name|failed
label|:
if|if
condition|(
name|debug
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"getfile failed for %s\n"
argument_list|,
name|getfile
operator|->
name|client_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|dolog
condition|)
name|syslog
argument_list|(
name|LOG_NOTICE
argument_list|,
literal|"getfile failed for %s\n"
argument_list|,
name|getfile
operator|->
name|client_name
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_comment
comment|/*    getthefile return 1 and fills the buffer with the information       of the file, e g "host:/export/root/client" if it can be found.       If the host is in the database, but the file is not, the buffer       will be empty. (This makes it possible to give the special       empty answer for the file "dump")   */
end_comment

begin_macro
name|getthefile
argument_list|(
argument|askname
argument_list|,
argument|fileid
argument_list|,
argument|buffer
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|askname
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|fileid
decl_stmt|,
modifier|*
name|buffer
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|FILE
modifier|*
name|bpf
decl_stmt|;
name|char
modifier|*
name|where
decl_stmt|;
specifier|static
name|char
modifier|*
name|result
decl_stmt|;
name|int
name|resultlen
decl_stmt|;
specifier|static
name|char
modifier|*
name|yp_domain
decl_stmt|;
name|int
name|ch
decl_stmt|,
name|pch
decl_stmt|,
name|fid_len
decl_stmt|,
name|res
init|=
literal|0
decl_stmt|;
name|int
name|match
init|=
literal|0
decl_stmt|;
name|char
name|info
index|[
name|MAX_FILEID
operator|+
name|MAX_PATH_LEN
operator|+
name|MAX_MACHINE_NAME
operator|+
literal|3
index|]
decl_stmt|;
name|bpf
operator|=
name|fopen
argument_list|(
name|bootpfile
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bpf
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"No %s\n"
argument_list|,
name|bootpfile
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
name|fscanf
argument_list|(
name|bpf
argument_list|,
literal|"%s"
argument_list|,
name|hostname
argument_list|)
operator|>
literal|0
operator|&&
operator|!
name|match
condition|)
block|{
if|if
condition|(
operator|*
name|hostname
operator|!=
literal|'#'
condition|)
block|{
comment|/* comment */
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|hostname
argument_list|,
name|askname
argument_list|)
condition|)
block|{
name|match
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|he
operator|=
name|gethostbyname
argument_list|(
name|hostname
argument_list|)
expr_stmt|;
if|if
condition|(
name|he
operator|&&
operator|!
name|strcmp
argument_list|(
name|he
operator|->
name|h_name
argument_list|,
name|askname
argument_list|)
condition|)
name|match
operator|=
literal|1
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|*
name|hostname
operator|==
literal|'+'
condition|)
block|{
comment|/* NIS */
if|if
condition|(
name|yp_get_default_domain
argument_list|(
operator|&
name|yp_domain
argument_list|)
condition|)
block|{
if|if
condition|(
name|debug
condition|)
name|perror
argument_list|(
literal|"NIS"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|yp_match
argument_list|(
name|yp_domain
argument_list|,
literal|"bootparams"
argument_list|,
name|askname
argument_list|,
name|strlen
argument_list|(
name|askname
argument_list|)
argument_list|,
operator|&
name|result
argument_list|,
operator|&
name|resultlen
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|strstr
argument_list|(
name|result
argument_list|,
name|fileid
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|buffer
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
else|else
block|{
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"%s"
argument_list|,
name|strchr
argument_list|(
name|strstr
argument_list|(
name|result
argument_list|,
name|fileid
argument_list|)
argument_list|,
literal|'='
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|strchr
argument_list|(
name|buffer
argument_list|,
literal|' '
argument_list|)
operator|!=
name|NULL
condition|)
operator|*
operator|(
name|char
operator|*
operator|)
operator|(
name|strchr
argument_list|(
name|buffer
argument_list|,
literal|' '
argument_list|)
operator|)
operator|=
literal|'\0'
expr_stmt|;
block|}
if|if
condition|(
name|fclose
argument_list|(
name|bpf
argument_list|)
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Could not close %s\n"
argument_list|,
name|bootpfile
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
comment|/* skip to next entry */
if|if
condition|(
name|match
condition|)
break|break;
name|pch
operator|=
name|ch
operator|=
name|getc
argument_list|(
name|bpf
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
operator|(
name|ch
operator|==
literal|'\n'
operator|&&
name|pch
operator|!=
literal|'\\'
operator|)
operator|&&
name|ch
operator|!=
name|EOF
condition|)
block|{
name|pch
operator|=
name|ch
expr_stmt|;
name|ch
operator|=
name|getc
argument_list|(
name|bpf
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* if match is true we read the rest of the line to get the      info of the file */
if|if
condition|(
name|match
condition|)
block|{
name|fid_len
operator|=
name|strlen
argument_list|(
name|fileid
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
name|res
operator|&&
operator|(
name|fscanf
argument_list|(
name|bpf
argument_list|,
literal|"%s"
argument_list|,
name|info
argument_list|)
operator|)
operator|>
literal|0
condition|)
block|{
comment|/* read a string */
name|ch
operator|=
name|getc
argument_list|(
name|bpf
argument_list|)
expr_stmt|;
comment|/* and a character */
if|if
condition|(
operator|*
name|info
operator|!=
literal|'#'
condition|)
block|{
comment|/* Comment ? */
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|info
argument_list|,
name|fileid
argument_list|,
name|fid_len
argument_list|)
operator|&&
operator|*
operator|(
name|info
operator|+
name|fid_len
operator|)
operator|==
literal|'='
condition|)
block|{
name|where
operator|=
name|info
operator|+
name|fid_len
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|isprint
argument_list|(
operator|*
name|where
argument_list|)
condition|)
block|{
name|strcpy
argument_list|(
name|buffer
argument_list|,
name|where
argument_list|)
expr_stmt|;
comment|/* found file */
name|res
operator|=
literal|1
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
while|while
condition|(
name|isspace
argument_list|(
name|ch
argument_list|)
operator|&&
name|ch
operator|!=
literal|'\n'
condition|)
name|ch
operator|=
name|getc
argument_list|(
name|bpf
argument_list|)
expr_stmt|;
comment|/* read to end of line */
if|if
condition|(
name|ch
operator|==
literal|'\n'
condition|)
block|{
comment|/* didn't find it */
name|res
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
comment|/* but host is there */
block|}
if|if
condition|(
name|ch
operator|==
literal|'\\'
condition|)
block|{
comment|/* more info */
name|ch
operator|=
name|getc
argument_list|(
name|bpf
argument_list|)
expr_stmt|;
comment|/* maybe on next line */
if|if
condition|(
name|ch
operator|==
literal|'\n'
condition|)
continue|continue;
comment|/* read it in next loop */
name|ungetc
argument_list|(
name|ch
argument_list|,
name|bpf
argument_list|)
expr_stmt|;
name|ungetc
argument_list|(
literal|'\\'
argument_list|,
name|bpf
argument_list|)
expr_stmt|;
comment|/* push the character(s) back */
block|}
else|else
name|ungetc
argument_list|(
name|ch
argument_list|,
name|bpf
argument_list|)
expr_stmt|;
comment|/* but who know what a `\` is */
block|}
comment|/* needed for. */
block|}
else|else
break|break;
comment|/* a commented rest-of-line */
block|}
block|}
if|if
condition|(
name|fclose
argument_list|(
name|bpf
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Could not close %s\n"
argument_list|,
name|bootpfile
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|res
operator|==
operator|-
literal|1
condition|)
name|buffer
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
comment|/* host found, file not */
return|return
operator|(
name|match
operator|)
return|;
block|}
end_block

begin_comment
comment|/* checkhost puts the hostname found in the database file in    the hostname-variable and returns 1, if askname is a valid    name for a host in the database */
end_comment

begin_macro
name|checkhost
argument_list|(
argument|askname
argument_list|,
argument|hostname
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|askname
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|hostname
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|ch
decl_stmt|,
name|pch
decl_stmt|;
name|FILE
modifier|*
name|bpf
decl_stmt|;
name|int
name|res
init|=
literal|0
decl_stmt|;
specifier|static
name|char
modifier|*
name|result
decl_stmt|;
name|int
name|resultlen
decl_stmt|;
specifier|static
name|char
modifier|*
name|yp_domain
decl_stmt|;
comment|/*  struct hostent *cmp_he;*/
name|bpf
operator|=
name|fopen
argument_list|(
name|bootpfile
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bpf
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"No %s\n"
argument_list|,
name|bootpfile
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
name|fscanf
argument_list|(
name|bpf
argument_list|,
literal|"%s"
argument_list|,
name|hostname
argument_list|)
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|*
name|hostname
operator|!=
literal|'#'
condition|)
block|{
comment|/* comment */
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|hostname
argument_list|,
name|askname
argument_list|)
condition|)
block|{
comment|/* return true for match of hostname */
name|res
operator|=
literal|1
expr_stmt|;
break|break;
block|}
else|else
block|{
comment|/* check the alias list */
name|he
operator|=
name|NULL
expr_stmt|;
name|he
operator|=
name|gethostbyname
argument_list|(
name|hostname
argument_list|)
expr_stmt|;
if|if
condition|(
name|he
operator|&&
operator|!
name|strcmp
argument_list|(
name|askname
argument_list|,
name|he
operator|->
name|h_name
argument_list|)
condition|)
block|{
name|res
operator|=
literal|1
expr_stmt|;
break|break;
block|}
block|}
block|}
if|if
condition|(
operator|*
name|hostname
operator|==
literal|'+'
condition|)
block|{
comment|/* NIS */
if|if
condition|(
name|yp_get_default_domain
argument_list|(
operator|&
name|yp_domain
argument_list|)
condition|)
block|{
if|if
condition|(
name|debug
condition|)
name|perror
argument_list|(
literal|"NIS"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
operator|!
name|yp_match
argument_list|(
name|yp_domain
argument_list|,
literal|"bootparams"
argument_list|,
name|askname
argument_list|,
name|strlen
argument_list|(
name|askname
argument_list|)
argument_list|,
operator|&
name|result
argument_list|,
operator|&
name|resultlen
argument_list|)
condition|)
block|{
comment|/* return true for match of hostname */
name|he
operator|=
name|NULL
expr_stmt|;
name|he
operator|=
name|gethostbyname
argument_list|(
name|askname
argument_list|)
expr_stmt|;
if|if
condition|(
name|he
operator|&&
operator|!
name|strcmp
argument_list|(
name|askname
argument_list|,
name|he
operator|->
name|h_name
argument_list|)
condition|)
block|{
name|res
operator|=
literal|1
expr_stmt|;
name|sprintf
argument_list|(
name|hostname
argument_list|,
literal|"%s"
argument_list|,
name|he
operator|->
name|h_name
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|fclose
argument_list|(
name|bpf
argument_list|)
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Could not close %s\n"
argument_list|,
name|bootpfile
argument_list|)
expr_stmt|;
return|return
operator|(
name|res
operator|)
return|;
block|}
comment|/* skip to next entry */
name|pch
operator|=
name|ch
operator|=
name|getc
argument_list|(
name|bpf
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
operator|(
name|ch
operator|==
literal|'\n'
operator|&&
name|pch
operator|!=
literal|'\\'
operator|)
operator|&&
name|ch
operator|!=
name|EOF
condition|)
block|{
name|pch
operator|=
name|ch
expr_stmt|;
name|ch
operator|=
name|getc
argument_list|(
name|bpf
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|fclose
argument_list|(
name|bpf
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Could not close %s\n"
argument_list|,
name|bootpfile
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|res
operator|)
return|;
block|}
end_block

end_unit


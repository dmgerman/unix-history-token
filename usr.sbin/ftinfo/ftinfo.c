begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  *  Copyright (c) 1993 Steve Gerakines  *  *  This is freely redistributable software.  You may do anything you  *  wish with it, so long as the above notice stays intact.  *  *  THIS SOFTWARE IS PROVIDED BY THE AUTHOR(S) ``AS IS'' AND ANY EXPRESS  *  OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED  *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE  *  DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR(S) BE LIABLE FOR ANY DIRECT,  *  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES  *  (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR  *  SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  *  HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,  *  STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING  *  IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE  *  POSSIBILITY OF SUCH DAMAGE.  *  *  ftinfo.c - display tape drive status  *  10/30/93 v0.3  *  Initial revision.  *  *  usage: ftinfo [ -f tape ]  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<sys/ftape.h>
end_include

begin_define
define|#
directive|define
name|DEFQIC
value|"/dev/rft0"
end_define

begin_define
define|#
directive|define
name|equal
parameter_list|(
name|s1
parameter_list|,
name|s2
parameter_list|)
value|(strcmp(s1, s2) == 0)
end_define

begin_decl_stmt
name|QIC_HWInfo
name|hw
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|QIC_Geom
name|g
decl_stmt|;
end_decl_stmt

begin_function
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|int
name|ft
decl_stmt|;
name|int
name|gotgeom
decl_stmt|;
name|int
name|s
decl_stmt|;
name|char
modifier|*
name|tape
decl_stmt|,
modifier|*
name|getenv
argument_list|()
decl_stmt|;
if|if
condition|(
name|argc
operator|>
literal|2
operator|&&
operator|(
name|equal
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
literal|"-t"
argument_list|)
operator|||
name|equal
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
literal|"-f"
argument_list|)
operator|)
condition|)
block|{
name|argc
operator|-=
literal|2
expr_stmt|;
name|tape
operator|=
name|argv
index|[
literal|2
index|]
expr_stmt|;
name|argv
operator|+=
literal|2
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|tape
operator|=
name|getenv
argument_list|(
literal|"TAPE"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|tape
operator|=
name|DEFQIC
expr_stmt|;
if|if
condition|(
name|argc
operator|>
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"usage: ftinfo [ -f tape ]\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|ft
operator|=
name|open
argument_list|(
name|tape
argument_list|,
literal|2
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ftinfo: couldn't open tape device %s\n"
argument_list|,
name|tape
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ioctl
argument_list|(
name|ft
argument_list|,
name|QIOSTATUS
argument_list|,
operator|&
name|s
argument_list|)
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ftinfo: couldn't get tape drive status\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|s
operator|&
name|QS_CART
operator|)
operator|&&
operator|(
name|s
operator|&
name|QS_FMTOK
operator|)
condition|)
block|{
if|if
condition|(
name|ioctl
argument_list|(
name|ft
argument_list|,
name|QIOGEOM
argument_list|,
operator|&
name|g
argument_list|)
operator|<
literal|0
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ftinfo: warning: get tape geometry failed\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ioctl
argument_list|(
name|ft
argument_list|,
name|QIOHWINFO
argument_list|,
operator|&
name|hw
argument_list|)
operator|<
literal|0
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ftinfo: warning: get hardware info failed\n"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|ft
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"drive status:      %s\n"
argument_list|,
operator|(
name|s
operator|&
name|QS_READY
operator|)
condition|?
literal|"Ready"
else|:
literal|"Not Ready"
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|&
name|QS_CART
condition|)
block|{
if|if
condition|(
name|s
operator|&
name|QS_FMTOK
condition|)
block|{
name|printf
argument_list|(
literal|"tape type:         %s %s\n"
argument_list|,
name|g
operator|.
name|g_fmtdesc
argument_list|,
operator|(
name|s
operator|&
name|QS_RDONLY
operator|)
condition|?
literal|"(Write-Protect)"
else|:
literal|""
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"tape length:       %s\n"
argument_list|,
name|g
operator|.
name|g_lendesc
argument_list|)
expr_stmt|;
block|}
else|else
name|printf
argument_list|(
literal|"tape type:         Unformatted %s\n"
argument_list|,
operator|(
name|s
operator|&
name|QS_RDONLY
operator|)
condition|?
literal|"(Write-Protect)"
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
else|else
name|printf
argument_list|(
literal|"tape type:         No tape in drive\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"drive make:        0x%04x\n"
argument_list|,
name|hw
operator|.
name|hw_make
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"drive model:       0x%02x\n"
argument_list|,
name|hw
operator|.
name|hw_model
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"drive rom-id:      0x%02x\n"
argument_list|,
name|hw
operator|.
name|hw_romid
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"beta roms:         %s\n"
argument_list|,
name|hw
operator|.
name|hw_rombeta
condition|?
literal|"Yes"
else|:
literal|"No"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


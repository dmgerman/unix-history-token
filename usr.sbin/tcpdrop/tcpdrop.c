begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* $OpenBSD: tcpdrop.c,v 1.4 2004/05/22 23:55:22 deraadt Exp $ */
end_comment

begin_comment
comment|/*-  * Copyright (c) 2009 Juli Mallett<jmallett@FreeBSD.org>  * Copyright (c) 2004 Markus Friedl<markus@openbsd.org>  *  * Permission to use, copy, modify, and distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES  * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF  * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR  * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES  * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN  * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF  * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/socketvar.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_pcb.h>
end_include

begin_define
define|#
directive|define
name|TCPSTATES
end_define

begin_include
include|#
directive|include
file|<netinet/tcp_fsm.h>
end_include

begin_include
include|#
directive|include
file|<netinet/tcp_var.h>
end_include

begin_include
include|#
directive|include
file|<err.h>
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_include
include|#
directive|include
file|<stdbool.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_define
define|#
directive|define
name|TCPDROP_FOREIGN
value|0
end_define

begin_define
define|#
directive|define
name|TCPDROP_LOCAL
value|1
end_define

begin_struct
struct|struct
name|host_service
block|{
name|char
name|hs_host
index|[
name|NI_MAXHOST
index|]
decl_stmt|;
name|char
name|hs_service
index|[
name|NI_MAXSERV
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|bool
name|tcpdrop_list_commands
init|=
name|false
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|char
modifier|*
name|findport
parameter_list|(
specifier|const
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|xinpgen
modifier|*
name|getxpcblist
parameter_list|(
specifier|const
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|sockinfo
parameter_list|(
specifier|const
name|struct
name|sockaddr
modifier|*
parameter_list|,
name|struct
name|host_service
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|bool
name|tcpdrop
parameter_list|(
specifier|const
name|struct
name|sockaddr
modifier|*
parameter_list|,
specifier|const
name|struct
name|sockaddr
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|bool
name|tcpdropall
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|bool
name|tcpdropbyname
parameter_list|(
specifier|const
name|char
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|bool
name|tcpdropconn
parameter_list|(
specifier|const
name|struct
name|in_conninfo
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|usage
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * Drop a tcp connection.  */
end_comment

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|char
modifier|*
name|lport
decl_stmt|,
modifier|*
name|fport
decl_stmt|;
name|bool
name|dropall
decl_stmt|;
name|int
name|ch
decl_stmt|;
name|dropall
operator|=
name|false
expr_stmt|;
while|while
condition|(
operator|(
name|ch
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"al"
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'a'
case|:
name|dropall
operator|=
name|true
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
name|tcpdrop_list_commands
operator|=
name|true
expr_stmt|;
break|break;
default|default:
name|usage
argument_list|()
expr_stmt|;
block|}
block|}
name|argc
operator|-=
name|optind
expr_stmt|;
name|argv
operator|+=
name|optind
expr_stmt|;
if|if
condition|(
name|dropall
condition|)
block|{
if|if
condition|(
name|argc
operator|!=
literal|0
condition|)
name|usage
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|tcpdropall
argument_list|()
condition|)
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|argc
operator|!=
literal|2
operator|&&
name|argc
operator|!=
literal|4
operator|)
operator|||
name|tcpdrop_list_commands
condition|)
name|usage
argument_list|()
expr_stmt|;
if|if
condition|(
name|argc
operator|==
literal|2
condition|)
block|{
name|lport
operator|=
name|findport
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|fport
operator|=
name|findport
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|lport
operator|==
name|NULL
operator|||
name|lport
index|[
literal|1
index|]
operator|==
literal|'\0'
operator|||
name|fport
operator|==
name|NULL
operator|||
name|fport
index|[
literal|1
index|]
operator|==
literal|'\0'
condition|)
name|usage
argument_list|()
expr_stmt|;
operator|*
name|lport
operator|++
operator|=
literal|'\0'
expr_stmt|;
operator|*
name|fport
operator|++
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|!
name|tcpdropbyname
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
name|lport
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|,
name|fport
argument_list|)
condition|)
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|tcpdropbyname
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|,
name|argv
index|[
literal|2
index|]
argument_list|,
name|argv
index|[
literal|3
index|]
argument_list|)
condition|)
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|findport
parameter_list|(
specifier|const
name|char
modifier|*
name|arg
parameter_list|)
block|{
name|char
modifier|*
name|dot
decl_stmt|,
modifier|*
name|colon
decl_stmt|;
comment|/* A strrspn() or strrpbrk() would be nice. */
name|dot
operator|=
name|strrchr
argument_list|(
name|arg
argument_list|,
literal|'.'
argument_list|)
expr_stmt|;
name|colon
operator|=
name|strrchr
argument_list|(
name|arg
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
name|dot
operator|==
name|NULL
condition|)
return|return
operator|(
name|colon
operator|)
return|;
if|if
condition|(
name|colon
operator|==
name|NULL
condition|)
return|return
operator|(
name|dot
operator|)
return|;
if|if
condition|(
name|dot
operator|<
name|colon
condition|)
return|return
operator|(
name|colon
operator|)
return|;
else|else
return|return
operator|(
name|dot
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|xinpgen
modifier|*
name|getxpcblist
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
name|struct
name|xinpgen
modifier|*
name|xinp
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|int
name|rv
decl_stmt|;
name|len
operator|=
literal|0
expr_stmt|;
name|rv
operator|=
name|sysctlbyname
argument_list|(
name|name
argument_list|,
name|NULL
argument_list|,
operator|&
name|len
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"sysctlbyname %s"
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|==
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s is empty"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|xinp
operator|=
name|malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|xinp
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"malloc failed"
argument_list|)
expr_stmt|;
name|rv
operator|=
name|sysctlbyname
argument_list|(
name|name
argument_list|,
name|xinp
argument_list|,
operator|&
name|len
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"sysctlbyname %s"
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return
operator|(
name|xinp
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|sockinfo
parameter_list|(
specifier|const
name|struct
name|sockaddr
modifier|*
name|sa
parameter_list|,
name|struct
name|host_service
modifier|*
name|hs
parameter_list|)
block|{
specifier|static
specifier|const
name|int
name|flags
init|=
name|NI_NUMERICHOST
operator||
name|NI_NUMERICSERV
decl_stmt|;
name|int
name|rv
decl_stmt|;
name|rv
operator|=
name|getnameinfo
argument_list|(
name|sa
argument_list|,
name|sa
operator|->
name|sa_len
argument_list|,
name|hs
operator|->
name|hs_host
argument_list|,
sizeof|sizeof
name|hs
operator|->
name|hs_host
argument_list|,
name|hs
operator|->
name|hs_service
argument_list|,
sizeof|sizeof
name|hs
operator|->
name|hs_service
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"getnameinfo"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|bool
name|tcpdrop
parameter_list|(
specifier|const
name|struct
name|sockaddr
modifier|*
name|lsa
parameter_list|,
specifier|const
name|struct
name|sockaddr
modifier|*
name|fsa
parameter_list|)
block|{
name|struct
name|host_service
name|local
decl_stmt|,
name|foreign
decl_stmt|;
name|struct
name|sockaddr_storage
name|addrs
index|[
literal|2
index|]
decl_stmt|;
name|int
name|rv
decl_stmt|;
name|memcpy
argument_list|(
operator|&
name|addrs
index|[
name|TCPDROP_FOREIGN
index|]
argument_list|,
name|fsa
argument_list|,
name|fsa
operator|->
name|sa_len
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|addrs
index|[
name|TCPDROP_LOCAL
index|]
argument_list|,
name|lsa
argument_list|,
name|lsa
operator|->
name|sa_len
argument_list|)
expr_stmt|;
name|sockinfo
argument_list|(
name|lsa
argument_list|,
operator|&
name|local
argument_list|)
expr_stmt|;
name|sockinfo
argument_list|(
name|fsa
argument_list|,
operator|&
name|foreign
argument_list|)
expr_stmt|;
if|if
condition|(
name|tcpdrop_list_commands
condition|)
block|{
name|printf
argument_list|(
literal|"tcpdrop %s %s %s %s\n"
argument_list|,
name|local
operator|.
name|hs_host
argument_list|,
name|local
operator|.
name|hs_service
argument_list|,
name|foreign
operator|.
name|hs_host
argument_list|,
name|foreign
operator|.
name|hs_service
argument_list|)
expr_stmt|;
return|return
operator|(
name|true
operator|)
return|;
block|}
name|rv
operator|=
name|sysctlbyname
argument_list|(
literal|"net.inet.tcp.drop"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|addrs
argument_list|,
sizeof|sizeof
name|addrs
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|==
operator|-
literal|1
condition|)
block|{
name|warn
argument_list|(
literal|"%s %s %s %s"
argument_list|,
name|local
operator|.
name|hs_host
argument_list|,
name|local
operator|.
name|hs_service
argument_list|,
name|foreign
operator|.
name|hs_host
argument_list|,
name|foreign
operator|.
name|hs_service
argument_list|)
expr_stmt|;
return|return
operator|(
name|false
operator|)
return|;
block|}
name|printf
argument_list|(
literal|"%s %s %s %s: dropped\n"
argument_list|,
name|local
operator|.
name|hs_host
argument_list|,
name|local
operator|.
name|hs_service
argument_list|,
name|foreign
operator|.
name|hs_host
argument_list|,
name|foreign
operator|.
name|hs_service
argument_list|)
expr_stmt|;
return|return
operator|(
name|true
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|bool
name|tcpdropall
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|xinpgen
modifier|*
name|head
decl_stmt|,
modifier|*
name|xinp
decl_stmt|;
name|struct
name|xtcpcb
modifier|*
name|xpcb
decl_stmt|;
name|struct
name|tcpcb
modifier|*
name|tp
decl_stmt|;
name|struct
name|inpcb
modifier|*
name|inp
decl_stmt|;
name|bool
name|ok
decl_stmt|;
name|ok
operator|=
name|true
expr_stmt|;
name|head
operator|=
name|getxpcblist
argument_list|(
literal|"net.inet.tcp.pcblist"
argument_list|)
expr_stmt|;
define|#
directive|define
name|XINP_NEXT
parameter_list|(
name|xinp
parameter_list|)
define|\
value|((struct xinpgen *)((uintptr_t)(xinp) + (xinp)->xig_len))
for|for
control|(
name|xinp
operator|=
name|XINP_NEXT
argument_list|(
name|head
argument_list|)
init|;
name|xinp
operator|->
name|xig_len
operator|>
sizeof|sizeof
expr|*
name|xinp
condition|;
name|xinp
operator|=
name|XINP_NEXT
argument_list|(
name|xinp
argument_list|)
control|)
block|{
name|xpcb
operator|=
operator|(
expr|struct
name|xtcpcb
operator|*
operator|)
name|xinp
expr_stmt|;
name|tp
operator|=
operator|&
name|xpcb
operator|->
name|xt_tp
expr_stmt|;
name|inp
operator|=
operator|&
name|xpcb
operator|->
name|xt_inp
expr_stmt|;
comment|/* 		 * XXX 		 * Check protocol, support just v4 or v6, etc. 		 */
comment|/* Ignore PCBs which were freed during copyout.  */
if|if
condition|(
name|inp
operator|->
name|inp_gencnt
operator|>
name|head
operator|->
name|xig_gen
condition|)
continue|continue;
comment|/* Skip listening sockets.  */
if|if
condition|(
name|tp
operator|->
name|t_state
operator|==
name|TCPS_LISTEN
condition|)
continue|continue;
if|if
condition|(
operator|!
name|tcpdropconn
argument_list|(
operator|&
name|inp
operator|->
name|inp_inc
argument_list|)
condition|)
name|ok
operator|=
name|false
expr_stmt|;
block|}
name|free
argument_list|(
name|head
argument_list|)
expr_stmt|;
return|return
operator|(
name|ok
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|bool
name|tcpdropbyname
parameter_list|(
specifier|const
name|char
modifier|*
name|lhost
parameter_list|,
specifier|const
name|char
modifier|*
name|lport
parameter_list|,
specifier|const
name|char
modifier|*
name|fhost
parameter_list|,
specifier|const
name|char
modifier|*
name|fport
parameter_list|)
block|{
specifier|static
specifier|const
name|struct
name|addrinfo
name|hints
init|=
block|{
comment|/* 		 * Look for streams in all domains. 		 */
operator|.
name|ai_family
operator|=
name|AF_UNSPEC
block|,
operator|.
name|ai_socktype
operator|=
name|SOCK_STREAM
block|, 	}
decl_stmt|;
name|struct
name|addrinfo
modifier|*
name|ail
decl_stmt|,
modifier|*
name|local
decl_stmt|,
modifier|*
name|aif
decl_stmt|,
modifier|*
name|foreign
decl_stmt|;
name|int
name|error
decl_stmt|;
name|bool
name|ok
decl_stmt|,
name|infamily
decl_stmt|;
name|error
operator|=
name|getaddrinfo
argument_list|(
name|lhost
argument_list|,
name|lport
argument_list|,
operator|&
name|hints
argument_list|,
operator|&
name|local
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"getaddrinfo: %s port %s: %s"
argument_list|,
name|lhost
argument_list|,
name|lport
argument_list|,
name|gai_strerror
argument_list|(
name|error
argument_list|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|getaddrinfo
argument_list|(
name|fhost
argument_list|,
name|fport
argument_list|,
operator|&
name|hints
argument_list|,
operator|&
name|foreign
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|freeaddrinfo
argument_list|(
name|local
argument_list|)
expr_stmt|;
comment|/* XXX gratuitous */
name|errx
argument_list|(
literal|1
argument_list|,
literal|"getaddrinfo: %s port %s: %s"
argument_list|,
name|fhost
argument_list|,
name|fport
argument_list|,
name|gai_strerror
argument_list|(
name|error
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|ok
operator|=
name|true
expr_stmt|;
name|infamily
operator|=
name|false
expr_stmt|;
comment|/* 	 * Try every combination of local and foreign address pairs. 	 */
for|for
control|(
name|ail
operator|=
name|local
init|;
name|ail
operator|!=
name|NULL
condition|;
name|ail
operator|=
name|ail
operator|->
name|ai_next
control|)
block|{
for|for
control|(
name|aif
operator|=
name|foreign
init|;
name|aif
operator|!=
name|NULL
condition|;
name|aif
operator|=
name|aif
operator|->
name|ai_next
control|)
block|{
if|if
condition|(
name|ail
operator|->
name|ai_family
operator|!=
name|aif
operator|->
name|ai_family
condition|)
continue|continue;
name|infamily
operator|=
name|true
expr_stmt|;
if|if
condition|(
operator|!
name|tcpdrop
argument_list|(
name|ail
operator|->
name|ai_addr
argument_list|,
name|aif
operator|->
name|ai_addr
argument_list|)
condition|)
name|ok
operator|=
name|false
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|infamily
condition|)
block|{
name|warnx
argument_list|(
literal|"%s %s %s %s: different address families"
argument_list|,
name|lhost
argument_list|,
name|lport
argument_list|,
name|fhost
argument_list|,
name|fport
argument_list|)
expr_stmt|;
name|ok
operator|=
name|false
expr_stmt|;
block|}
name|freeaddrinfo
argument_list|(
name|local
argument_list|)
expr_stmt|;
name|freeaddrinfo
argument_list|(
name|foreign
argument_list|)
expr_stmt|;
return|return
operator|(
name|ok
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|bool
name|tcpdropconn
parameter_list|(
specifier|const
name|struct
name|in_conninfo
modifier|*
name|inc
parameter_list|)
block|{
name|struct
name|sockaddr
modifier|*
name|local
decl_stmt|,
modifier|*
name|foreign
decl_stmt|;
name|struct
name|sockaddr_in6
name|sin6
index|[
literal|2
index|]
decl_stmt|;
name|struct
name|sockaddr_in
name|sin4
index|[
literal|2
index|]
decl_stmt|;
if|if
condition|(
operator|(
name|inc
operator|->
name|inc_flags
operator|&
name|INC_ISIPV6
operator|)
operator|!=
literal|0
condition|)
block|{
name|memset
argument_list|(
name|sin6
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|sin6
argument_list|)
expr_stmt|;
name|sin6
index|[
name|TCPDROP_LOCAL
index|]
operator|.
name|sin6_len
operator|=
sizeof|sizeof
name|sin6
index|[
name|TCPDROP_LOCAL
index|]
expr_stmt|;
name|sin6
index|[
name|TCPDROP_LOCAL
index|]
operator|.
name|sin6_family
operator|=
name|AF_INET6
expr_stmt|;
name|sin6
index|[
name|TCPDROP_LOCAL
index|]
operator|.
name|sin6_port
operator|=
name|inc
operator|->
name|inc_lport
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|sin6
index|[
name|TCPDROP_LOCAL
index|]
operator|.
name|sin6_addr
argument_list|,
operator|&
name|inc
operator|->
name|inc6_laddr
argument_list|,
sizeof|sizeof
name|inc
operator|->
name|inc6_laddr
argument_list|)
expr_stmt|;
name|local
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|sin6
index|[
name|TCPDROP_LOCAL
index|]
expr_stmt|;
name|sin6
index|[
name|TCPDROP_FOREIGN
index|]
operator|.
name|sin6_len
operator|=
sizeof|sizeof
name|sin6
index|[
name|TCPDROP_FOREIGN
index|]
expr_stmt|;
name|sin6
index|[
name|TCPDROP_FOREIGN
index|]
operator|.
name|sin6_family
operator|=
name|AF_INET6
expr_stmt|;
name|sin6
index|[
name|TCPDROP_FOREIGN
index|]
operator|.
name|sin6_port
operator|=
name|inc
operator|->
name|inc_fport
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|sin6
index|[
name|TCPDROP_FOREIGN
index|]
operator|.
name|sin6_addr
argument_list|,
operator|&
name|inc
operator|->
name|inc6_faddr
argument_list|,
sizeof|sizeof
name|inc
operator|->
name|inc6_faddr
argument_list|)
expr_stmt|;
name|foreign
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|sin6
index|[
name|TCPDROP_FOREIGN
index|]
expr_stmt|;
block|}
else|else
block|{
name|memset
argument_list|(
operator|&
name|sin4
index|[
name|TCPDROP_LOCAL
index|]
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|sin4
index|[
name|TCPDROP_LOCAL
index|]
argument_list|)
expr_stmt|;
name|sin4
index|[
name|TCPDROP_LOCAL
index|]
operator|.
name|sin_len
operator|=
sizeof|sizeof
name|sin4
index|[
name|TCPDROP_LOCAL
index|]
expr_stmt|;
name|sin4
index|[
name|TCPDROP_LOCAL
index|]
operator|.
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|sin4
index|[
name|TCPDROP_LOCAL
index|]
operator|.
name|sin_port
operator|=
name|inc
operator|->
name|inc_lport
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|sin4
index|[
name|TCPDROP_LOCAL
index|]
operator|.
name|sin_addr
argument_list|,
operator|&
name|inc
operator|->
name|inc_laddr
argument_list|,
sizeof|sizeof
name|inc
operator|->
name|inc_laddr
argument_list|)
expr_stmt|;
name|local
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|sin4
index|[
name|TCPDROP_LOCAL
index|]
expr_stmt|;
name|sin4
index|[
name|TCPDROP_FOREIGN
index|]
operator|.
name|sin_len
operator|=
sizeof|sizeof
name|sin4
index|[
name|TCPDROP_FOREIGN
index|]
expr_stmt|;
name|sin4
index|[
name|TCPDROP_FOREIGN
index|]
operator|.
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|sin4
index|[
name|TCPDROP_FOREIGN
index|]
operator|.
name|sin_port
operator|=
name|inc
operator|->
name|inc_fport
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|sin4
index|[
name|TCPDROP_FOREIGN
index|]
operator|.
name|sin_addr
argument_list|,
operator|&
name|inc
operator|->
name|inc_faddr
argument_list|,
sizeof|sizeof
name|inc
operator|->
name|inc_faddr
argument_list|)
expr_stmt|;
name|foreign
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|sin4
index|[
name|TCPDROP_FOREIGN
index|]
expr_stmt|;
block|}
return|return
operator|(
name|tcpdrop
argument_list|(
name|local
argument_list|,
name|foreign
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|usage
parameter_list|(
name|void
parameter_list|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"usage: tcpdrop local-address local-port foreign-address foreign-port\n"
literal|"       tcpdrop local-address:local-port foreign-address:foreign-port\n"
literal|"       tcpdrop local-address.local-port foreign-address.foreign-port\n"
literal|"       tcpdrop [-l] -a\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


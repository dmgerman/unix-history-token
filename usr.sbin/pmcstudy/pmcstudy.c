begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2014, 2015 Netflix Inc.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer,  *    in this position and unchanged.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. The name of the author may not be used to endorse or promote products  *    derived from this software without specific prior written permission  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<strings.h>
end_include

begin_include
include|#
directive|include
file|<sys/errno.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<sys/wait.h>
end_include

begin_include
include|#
directive|include
file|<getopt.h>
end_include

begin_include
include|#
directive|include
file|"eval_expr.h"
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_define
define|#
directive|define
name|MAX_COUNTER_SLOTS
value|1024
end_define

begin_define
define|#
directive|define
name|MAX_NLEN
value|64
end_define

begin_define
define|#
directive|define
name|MAX_CPU
value|64
end_define

begin_decl_stmt
specifier|static
name|int
name|verbose
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
modifier|*
modifier|*
name|environ
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|struct
name|expression
modifier|*
name|master_exp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|expression
modifier|*
name|master_exp
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|PMC_INITIAL_ALLOC
value|512
end_define

begin_decl_stmt
specifier|extern
name|char
modifier|*
modifier|*
name|valid_pmcs
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
modifier|*
name|valid_pmcs
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|valid_pmc_cnt
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|valid_pmc_cnt
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|pmc_allocated_cnt
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|pmc_allocated_cnt
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * The following two varients on popen and pclose with  * the cavet that they get you the PID so that you  * can supply it to pclose so it can send a SIGTERM   *  to the process.  */
end_comment

begin_function
specifier|static
name|FILE
modifier|*
name|my_popen
parameter_list|(
specifier|const
name|char
modifier|*
name|command
parameter_list|,
specifier|const
name|char
modifier|*
name|dir
parameter_list|,
name|pid_t
modifier|*
name|p_pid
parameter_list|)
block|{
name|FILE
modifier|*
name|io_out
decl_stmt|,
modifier|*
name|io_in
decl_stmt|;
name|int
name|pdesin
index|[
literal|2
index|]
decl_stmt|,
name|pdesout
index|[
literal|2
index|]
decl_stmt|;
name|char
modifier|*
name|argv
index|[
literal|4
index|]
decl_stmt|;
name|pid_t
name|pid
decl_stmt|;
name|char
name|cmd
index|[
literal|4
index|]
decl_stmt|;
name|char
name|cmd2
index|[
literal|1024
index|]
decl_stmt|;
name|char
name|arg1
index|[
literal|4
index|]
decl_stmt|;
if|if
condition|(
operator|(
name|strcmp
argument_list|(
name|dir
argument_list|,
literal|"r"
argument_list|)
operator|!=
literal|0
operator|)
operator|&&
operator|(
name|strcmp
argument_list|(
name|dir
argument_list|,
literal|"w"
argument_list|)
operator|!=
literal|0
operator|)
condition|)
block|{
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
if|if
condition|(
name|pipe
argument_list|(
name|pdesin
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
if|if
condition|(
name|pipe
argument_list|(
name|pdesout
argument_list|)
operator|<
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|close
argument_list|(
name|pdesin
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|pdesin
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|strcpy
argument_list|(
name|cmd
argument_list|,
literal|"sh"
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|arg1
argument_list|,
literal|"-c"
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|cmd2
argument_list|,
name|command
argument_list|)
expr_stmt|;
name|argv
index|[
literal|0
index|]
operator|=
name|cmd
expr_stmt|;
name|argv
index|[
literal|1
index|]
operator|=
name|arg1
expr_stmt|;
name|argv
index|[
literal|2
index|]
operator|=
name|cmd2
expr_stmt|;
name|argv
index|[
literal|3
index|]
operator|=
name|NULL
expr_stmt|;
switch|switch
condition|(
name|pid
operator|=
name|fork
argument_list|()
condition|)
block|{
case|case
operator|-
literal|1
case|:
comment|/* Error. */
operator|(
name|void
operator|)
name|close
argument_list|(
name|pdesin
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|pdesin
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|pdesout
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|pdesout
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
comment|/* NOTREACHED */
case|case
literal|0
case|:
comment|/* Child. */
comment|/* Close out un-used sides */
operator|(
name|void
operator|)
name|close
argument_list|(
name|pdesin
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|pdesout
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
comment|/* Now prepare the stdin of the process */
name|close
argument_list|(
literal|0
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|dup
argument_list|(
name|pdesin
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|pdesin
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
comment|/* Now prepare the stdout of the process */
name|close
argument_list|(
literal|1
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|dup
argument_list|(
name|pdesout
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
comment|/* And lets do stderr just in case */
name|close
argument_list|(
literal|2
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|dup
argument_list|(
name|pdesout
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|pdesout
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
comment|/* Now run it */
name|execve
argument_list|(
literal|"/bin/sh"
argument_list|,
name|argv
argument_list|,
name|environ
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|127
argument_list|)
expr_stmt|;
comment|/* NOTREACHED */
block|}
comment|/* Parent; assume fdopen can't fail. */
comment|/* Store the pid */
operator|*
name|p_pid
operator|=
name|pid
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|dir
argument_list|,
literal|"r"
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|io_out
operator|=
name|fdopen
argument_list|(
name|pdesin
index|[
literal|1
index|]
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|pdesin
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|pdesout
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|pdesout
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
return|return
operator|(
name|io_out
operator|)
return|;
block|}
else|else
block|{
comment|/* Prepare the input stream */
name|io_in
operator|=
name|fdopen
argument_list|(
name|pdesout
index|[
literal|0
index|]
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|pdesout
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|pdesin
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|pdesin
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
return|return
operator|(
name|io_in
operator|)
return|;
block|}
block|}
end_function

begin_comment
comment|/*  * pclose --  *	Pclose returns -1 if stream is not associated with a `popened' command,  *	if already `pclosed', or waitpid returns an error.  */
end_comment

begin_function
specifier|static
name|void
name|my_pclose
parameter_list|(
name|FILE
modifier|*
name|io
parameter_list|,
name|pid_t
name|the_pid
parameter_list|)
block|{
name|int
name|pstat
decl_stmt|;
name|pid_t
name|pid
decl_stmt|;
comment|/* 	 * Find the appropriate file pointer and remove it from the list. 	 */
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|io
argument_list|)
expr_stmt|;
comment|/* Die if you are not dead! */
name|kill
argument_list|(
name|the_pid
argument_list|,
name|SIGTERM
argument_list|)
expr_stmt|;
do|do
block|{
name|pid
operator|=
name|wait4
argument_list|(
name|the_pid
argument_list|,
operator|&
name|pstat
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|rusage
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|pid
operator|==
operator|-
literal|1
operator|&&
name|errno
operator|==
name|EINTR
condition|)
do|;
block|}
end_function

begin_struct
struct|struct
name|counters
block|{
name|struct
name|counters
modifier|*
name|next_cpu
decl_stmt|;
name|char
name|counter_name
index|[
name|MAX_NLEN
index|]
decl_stmt|;
comment|/* Name of counter */
name|int
name|cpu
decl_stmt|;
comment|/* CPU we are on */
name|int
name|pos
decl_stmt|;
comment|/* Index we are filling to. */
name|uint64_t
name|vals
index|[
name|MAX_COUNTER_SLOTS
index|]
decl_stmt|;
comment|/* Last 64 entries */
name|uint64_t
name|sum
decl_stmt|;
comment|/* Summary of entries */
block|}
struct|;
end_struct

begin_decl_stmt
specifier|extern
name|struct
name|counters
modifier|*
name|glob_cpu
index|[
name|MAX_CPU
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|counters
modifier|*
name|glob_cpu
index|[
name|MAX_CPU
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|struct
name|counters
modifier|*
name|cnts
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|counters
modifier|*
name|cnts
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|ncnts
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|ncnts
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|extern
name|int
function_decl|(
modifier|*
name|expression
function_decl|)
parameter_list|(
name|struct
name|counters
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
function_decl|(
modifier|*
name|expression
function_decl|)
parameter_list|(
name|struct
name|counters
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|threshold
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|command
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|cpu_entry
block|{
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
specifier|const
name|char
modifier|*
name|thresh
decl_stmt|;
specifier|const
name|char
modifier|*
name|command
decl_stmt|;
name|int
function_decl|(
modifier|*
name|func
function_decl|)
parameter_list|(
name|struct
name|counters
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|cpu_type
block|{
name|char
name|cputype
index|[
literal|32
index|]
decl_stmt|;
name|int
name|number
decl_stmt|;
name|struct
name|cpu_entry
modifier|*
name|ents
decl_stmt|;
name|void
function_decl|(
modifier|*
name|explain
function_decl|)
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|)
function_decl|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|extern
name|struct
name|cpu_type
name|the_cpu
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|cpu_type
name|the_cpu
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|explain_name_sb
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|mythresh
decl_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"allocstall1"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine PARTIAL_RAT_STALLS.SLOW_LEA_WINDOW / CPU_CLK_UNHALTED.THREAD_P\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"thresh> .05"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"allocstall2"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine PARTIAL_RAT_STALLS.FLAGS_MERGE_UOP_CYCLES/CPU_CLK_UNHALTED.THREAD_P\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"thresh> .05"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"br_miss"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine (20 * BR_MISP_RETIRED.ALL_BRANCHES)/CPU_CLK_UNHALTED.THREAD_P\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"thresh>= .2"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"splitload"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine MEM_UOP_RETIRED.SPLIT_LOADS * 5) / CPU_CLK_UNHALTED.THREAD_P\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"thresh>= .1"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"splitstore"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine MEM_UOP_RETIRED.SPLIT_STORES / MEM_UOP_RETIRED.ALL_STORES\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"thresh>= .01"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"contested"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine (MEM_LOAD_UOPS_LLC_HIT_RETIRED.XSNP_HITM * 60) / CPU_CLK_UNHALTED.THREAD_P\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"thresh>= .05"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"blockstorefwd"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine (LD_BLOCKS_STORE_FORWARD * 13) / CPU_CLK_UNHALTED.THREAD_P\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"thresh>= .05"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"cache2"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine ((MEM_LOAD_RETIRED.L3_HIT * 26) + \n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"         (MEM_LOAD_UOPS_LLC_HIT_RETIRED.XSNP_HIT * 43) + \n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"         (MEM_LOAD_UOPS_LLC_HIT_RETIRED.XSNP_HITM * 60)) / CPU_CLK_UNHALTED.THREAD_P\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"**Note we have it labeled MEM_LOAD_UOPS_RETIRED.LLC_HIT not MEM_LOAD_RETIRED.L3_HIT\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"thresh>= .2"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"cache1"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine (MEM_LOAD_UOPS_MISC_RETIRED.LLC_MISS * 180) / CPU_CLK_UNHALTED.THREAD_P\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"thresh>= .2"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"dtlbmissload"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine (((DTLB_LOAD_MISSES.STLB_HIT * 7) + DTLB_LOAD_MISSES.WALK_DURATION)\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"         / CPU_CLK_UNHALTED.THREAD_P)\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"thresh>= .1"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"frontendstall"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine IDQ_UOPS_NOT_DELIVERED.CORE / (CPU_CLK_UNHALTED.THREAD_P * 4)\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"thresh>= .15"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"clears"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine ((MACHINE_CLEARS.MEMORY_ORDERING + \n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"          MACHINE_CLEARS.SMC + \n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"          MACHINE_CLEARS.MASKMOV ) * 100 ) / CPU_CLK_UNHALTED.THREAD_P\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"thresh>= .02"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"microassist"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine IDQ.MS_CYCLES / (CPU_CLK_UNHALTED.THREAD_P * 4)\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"***We use IDQ.MS_UOPS,cmask=1 to get cycles\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"thresh>= .05"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"aliasing_4k"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine (LD_BLOCKS_PARTIAL.ADDRESS_ALIAS * 5) / CPU_CLK_UNHALTED.THREAD_P\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"thresh>= .1"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"fpassist"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine FP_ASSIST.ANY/INST_RETIRED.ANY_P\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"look for a excessive value"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"otherassistavx"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine (OTHER_ASSISTS.AVX_TO_SSE * 75)/CPU_CLK_UNHALTED.THREAD_P\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"look for a excessive value"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"otherassistsse"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine (OTHER_ASSISTS.SSE_TO_AVX * 75)/CPU_CLK_UNHALTED.THREAD_P\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"look for a excessive value"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"eff1"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine (UOPS_RETIRED.RETIRE_SLOTS)/(4 *CPU_CLK_UNHALTED.THREAD_P)\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"thresh< .9"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"eff2"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine CPU_CLK_UNHALTED.THREAD_P/INST_RETIRED.ANY_P\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"thresh> 1.0"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"dtlbmissstore"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine (((DTLB_STORE_MISSES.STLB_HIT * 7) + DTLB_STORE_MISSES.WALK_DURATION)\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"         / CPU_CLK_UNHALTED.THREAD_P)\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"thresh>= .05"
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"Unknown name:%s\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"unknown entry"
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"If the value printed is %s we may have the ability to improve performance\n"
argument_list|,
name|mythresh
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|explain_name_ib
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|mythresh
decl_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"br_miss"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine ((BR_MISP_RETIRED.ALL_BRANCHES /(BR_MISP_RETIRED.ALL_BRANCHES +\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"         MACHINE_CLEAR.COUNT) * ((UOPS_ISSUED.ANY - UOPS_RETIRED.RETIRE_SLOTS + 4 * INT_MISC.RECOVERY_CYCLES)\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"/ (4 * CPU_CLK_UNHALTED.THREAD))))\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"thresh>= .2"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"eff1"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine (UOPS_RETIRED.RETIRE_SLOTS)/(4 *CPU_CLK_UNHALTED.THREAD_P)\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"thresh< .9"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"eff2"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine CPU_CLK_UNHALTED.THREAD_P/INST_RETIRED.ANY_P\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"thresh> 1.0"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"cache1"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine (MEM_LOAD_UOPS_LLC_MISS_RETIRED.LOCAL_DRAM * 180) / CPU_CLK_UNHALTED.THREAD_P\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"thresh>= .2"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"cache2"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine (MEM_LOAD_UOPS_RETIRED.LLC_HIT / CPU_CLK_UNHALTED.THREAD_P\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"thresh>= .2"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"itlbmiss"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine ITLB_MISSES.WALK_DURATION / CPU_CLK_UNHALTED.THREAD_P\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"thresh> .05"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"icachemiss"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine (ICACHE.IFETCH_STALL - ITLB_MISSES.WALK_DURATION)/ CPU_CLK_UNHALTED.THREAD_P\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"thresh> .05"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"lcpstall"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine ILD_STALL.LCP/CPU_CLK_UNHALTED.THREAD_P\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"thresh> .05"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"datashare"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine (MEM_LOAD_UOPS_L3_HIT_RETIRED.XSNP_HIT * 43)/CPU_CLK_UNHALTED.THREAD_P\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"thresh> .05"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"blockstorefwd"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine (LD_BLOCKS_STORE_FORWARD * 13) / CPU_CLK_UNHALTED.THREAD_P\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"thresh>= .05"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"splitload"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine  ((L1D_PEND_MISS.PENDING / MEM_LOAD_UOPS_RETIRED.L1_MISS) *\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"         LD_BLOCKS.NO_SR)/CPU_CLK_UNHALTED.THREAD_P\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"thresh>= .1"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"splitstore"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine MEM_UOP_RETIRED.SPLIT_STORES / MEM_UOP_RETIRED.ALL_STORES\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"thresh>= .01"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"aliasing_4k"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine (LD_BLOCKS_PARTIAL.ADDRESS_ALIAS * 5) / CPU_CLK_UNHALTED.THREAD_P\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"thresh>= .1"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"dtlbmissload"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine (((DTLB_LOAD_MISSES.STLB_HIT * 7) + DTLB_LOAD_MISSES.WALK_DURATION)\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"         / CPU_CLK_UNHALTED.THREAD_P)\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"thresh>= .1"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"dtlbmissstore"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine (((DTLB_STORE_MISSES.STLB_HIT * 7) + DTLB_STORE_MISSES.WALK_DURATION)\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"         / CPU_CLK_UNHALTED.THREAD_P)\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"thresh>= .05"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"contested"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine (MEM_LOAD_UOPS_LLC_HIT_RETIRED.XSNP_HITM * 60) / CPU_CLK_UNHALTED.THREAD_P\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"thresh>= .05"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"clears"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine ((MACHINE_CLEARS.MEMORY_ORDERING + \n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"          MACHINE_CLEARS.SMC + \n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"          MACHINE_CLEARS.MASKMOV ) * 100 ) / CPU_CLK_UNHALTED.THREAD_P\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"thresh>= .02"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"microassist"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine IDQ.MS_CYCLES / (4 * CPU_CLK_UNHALTED.THREAD_P)\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"***We use IDQ.MS_UOPS,cmask=1 to get cycles\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"thresh>= .05"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"fpassist"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine FP_ASSIST.ANY/INST_RETIRED.ANY_P\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"look for a excessive value"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"otherassistavx"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine (OTHER_ASSISTS.AVX_TO_SSE * 75)/CPU_CLK_UNHALTED.THREAD_P\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"look for a excessive value"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"otherassistsse"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine (OTHER_ASSISTS.SSE_TO_AVX * 75)/CPU_CLK_UNHALTED.THREAD_P\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"look for a excessive value"
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"Unknown name:%s\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"unknown entry"
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"If the value printed is %s we may have the ability to improve performance\n"
argument_list|,
name|mythresh
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|explain_name_has
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|mythresh
decl_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"eff1"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine (UOPS_RETIRED.RETIRE_SLOTS)/(4 *CPU_CLK_UNHALTED.THREAD_P)\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"thresh< .75"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"eff2"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine CPU_CLK_UNHALTED.THREAD_P/INST_RETIRED.ANY_P\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"thresh> 1.0"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"itlbmiss"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine ITLB_MISSES.WALK_DURATION / CPU_CLK_UNHALTED.THREAD_P\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"thresh> .05"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"icachemiss"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine (36 * ICACHE.MISSES)/ CPU_CLK_UNHALTED.THREAD_P\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"thresh> .05"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"lcpstall"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine ILD_STALL.LCP/CPU_CLK_UNHALTED.THREAD_P\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"thresh> .05"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"cache1"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine (MEM_LOAD_UOPS_LLC_MISS_RETIRED.LOCAL_DRAM * 180) / CPU_CLK_UNHALTED.THREAD_P\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"thresh>= .2"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"cache2"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine ((MEM_LOAD_UOPS_RETIRED.LLC_HIT * 36) + \n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"         (MEM_LOAD_UOPS_LLC_HIT_RETIRED.XSNP_HIT * 72) + \n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"         (MEM_LOAD_UOPS_LLC_HIT_RETIRED.XSNP_HITM * 84))\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"          / CPU_CLK_UNHALTED.THREAD_P\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"thresh>= .2"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"contested"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine (MEM_LOAD_UOPS_LLC_HIT_RETIRED.XSNP_HITM * 84) / CPU_CLK_UNHALTED.THREAD_P\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"thresh>= .05"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"datashare"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine (MEM_LOAD_UOPS_L3_HIT_RETIRED.XSNP_HIT * 72)/CPU_CLK_UNHALTED.THREAD_P\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"thresh> .05"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"blockstorefwd"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine (LD_BLOCKS_STORE_FORWARD * 13) / CPU_CLK_UNHALTED.THREAD_P\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"thresh>= .05"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"splitload"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine  (MEM_UOP_RETIRED.SPLIT_LOADS * 5) / CPU_CLK_UNHALTED.THREAD_P\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"thresh>= .1"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"splitstore"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine MEM_UOP_RETIRED.SPLIT_STORES / MEM_UOP_RETIRED.ALL_STORES\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"thresh>= .01"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"aliasing_4k"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine (LD_BLOCKS_PARTIAL.ADDRESS_ALIAS * 5) / CPU_CLK_UNHALTED.THREAD_P\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"thresh>= .1"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"dtlbmissload"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine (((DTLB_LOAD_MISSES.STLB_HIT * 7) + DTLB_LOAD_MISSES.WALK_DURATION)\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"         / CPU_CLK_UNHALTED.THREAD_P)\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"thresh>= .1"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"br_miss"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine (20 * BR_MISP_RETIRED.ALL_BRANCHES)/CPU_CLK_UNHALTED.THREAD\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"thresh>= .2"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"clears"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine ((MACHINE_CLEARS.MEMORY_ORDERING + \n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"          MACHINE_CLEARS.SMC + \n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"          MACHINE_CLEARS.MASKMOV ) * 100 ) / CPU_CLK_UNHALTED.THREAD_P\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"thresh>= .02"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"microassist"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine IDQ.MS_CYCLES / (4 * CPU_CLK_UNHALTED.THREAD_P)\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"***We use IDQ.MS_UOPS,cmask=1 to get cycles\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"thresh>= .05"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"fpassist"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine FP_ASSIST.ANY/INST_RETIRED.ANY_P\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"look for a excessive value"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"otherassistavx"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine (OTHER_ASSISTS.AVX_TO_SSE * 75)/CPU_CLK_UNHALTED.THREAD_P\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"look for a excessive value"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"otherassistsse"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Examine (OTHER_ASSISTS.SSE_TO_AVX * 75)/CPU_CLK_UNHALTED.THREAD_P\n"
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"look for a excessive value"
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"Unknown name:%s\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|mythresh
operator|=
literal|"unknown entry"
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"If the value printed is %s we may have the ability to improve performance\n"
argument_list|,
name|mythresh
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|counters
modifier|*
name|find_counter
parameter_list|(
name|struct
name|counters
modifier|*
name|base
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
name|struct
name|counters
modifier|*
name|at
decl_stmt|;
name|int
name|len
decl_stmt|;
name|at
operator|=
name|base
expr_stmt|;
name|len
operator|=
name|strlen
argument_list|(
name|name
argument_list|)
expr_stmt|;
while|while
condition|(
name|at
condition|)
block|{
if|if
condition|(
name|strncmp
argument_list|(
name|at
operator|->
name|counter_name
argument_list|,
name|name
argument_list|,
name|len
argument_list|)
operator|==
literal|0
condition|)
block|{
return|return
operator|(
name|at
operator|)
return|;
block|}
name|at
operator|=
name|at
operator|->
name|next_cpu
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Can't find counter %s\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"We have:\n"
argument_list|)
expr_stmt|;
name|at
operator|=
name|base
expr_stmt|;
while|while
condition|(
name|at
condition|)
block|{
name|printf
argument_list|(
literal|"- %s\n"
argument_list|,
name|at
operator|->
name|counter_name
argument_list|)
expr_stmt|;
name|at
operator|=
name|at
operator|->
name|next_cpu
expr_stmt|;
block|}
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|allocstall1
parameter_list|(
name|struct
name|counters
modifier|*
name|cpu
parameter_list|,
name|int
name|pos
parameter_list|)
block|{
comment|/*  1  - PARTIAL_RAT_STALLS.SLOW_LEA_WINDOW/CPU_CLK_UNHALTED.THREAD_P (thresh> .05)*/
name|int
name|ret
decl_stmt|;
name|struct
name|counters
modifier|*
name|partial
decl_stmt|;
name|struct
name|counters
modifier|*
name|unhalt
decl_stmt|;
name|double
name|un
decl_stmt|,
name|par
decl_stmt|,
name|res
decl_stmt|;
name|unhalt
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"CPU_CLK_UNHALTED.THREAD_P"
argument_list|)
expr_stmt|;
name|partial
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"PARTIAL_RAT_STALLS.SLOW_LEA_WINDOW"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|!=
operator|-
literal|1
condition|)
block|{
name|par
operator|=
name|partial
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
block|}
else|else
block|{
name|par
operator|=
name|partial
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
block|}
name|res
operator|=
name|par
operator|/
name|un
expr_stmt|;
name|ret
operator|=
name|printf
argument_list|(
literal|"%1.3f"
argument_list|,
name|res
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|allocstall2
parameter_list|(
name|struct
name|counters
modifier|*
name|cpu
parameter_list|,
name|int
name|pos
parameter_list|)
block|{
comment|/*  2  - PARTIAL_RAT_STALLS.FLAGS_MERGE_UOP_CYCLES/CPU_CLK_UNHALTED.THREAD_P (thresh>.05) */
name|int
name|ret
decl_stmt|;
name|struct
name|counters
modifier|*
name|partial
decl_stmt|;
name|struct
name|counters
modifier|*
name|unhalt
decl_stmt|;
name|double
name|un
decl_stmt|,
name|par
decl_stmt|,
name|res
decl_stmt|;
name|unhalt
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"CPU_CLK_UNHALTED.THREAD_P"
argument_list|)
expr_stmt|;
name|partial
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"PARTIAL_RAT_STALLS.FLAGS_MERGE_UOP"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|!=
operator|-
literal|1
condition|)
block|{
name|par
operator|=
name|partial
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
block|}
else|else
block|{
name|par
operator|=
name|partial
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
block|}
name|res
operator|=
name|par
operator|/
name|un
expr_stmt|;
name|ret
operator|=
name|printf
argument_list|(
literal|"%1.3f"
argument_list|,
name|res
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|br_mispredict
parameter_list|(
name|struct
name|counters
modifier|*
name|cpu
parameter_list|,
name|int
name|pos
parameter_list|)
block|{
name|struct
name|counters
modifier|*
name|brctr
decl_stmt|;
name|struct
name|counters
modifier|*
name|unhalt
decl_stmt|;
name|int
name|ret
decl_stmt|;
comment|/*  3  - (20 * BR_MISP_RETIRED.ALL_BRANCHES)/CPU_CLK_UNHALTED.THREAD_P (thresh>= .2) */
name|double
name|br
decl_stmt|,
name|un
decl_stmt|,
name|con
decl_stmt|,
name|res
decl_stmt|;
name|con
operator|=
literal|20.0
expr_stmt|;
name|unhalt
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"CPU_CLK_UNHALTED.THREAD_P"
argument_list|)
expr_stmt|;
name|brctr
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"BR_MISP_RETIRED.ALL_BRANCHES"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|!=
operator|-
literal|1
condition|)
block|{
name|br
operator|=
name|brctr
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
block|}
else|else
block|{
name|br
operator|=
name|brctr
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
block|}
name|res
operator|=
operator|(
name|con
operator|*
name|br
operator|)
operator|/
name|un
expr_stmt|;
name|ret
operator|=
name|printf
argument_list|(
literal|"%1.3f"
argument_list|,
name|res
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|br_mispredictib
parameter_list|(
name|struct
name|counters
modifier|*
name|cpu
parameter_list|,
name|int
name|pos
parameter_list|)
block|{
name|struct
name|counters
modifier|*
name|brctr
decl_stmt|;
name|struct
name|counters
modifier|*
name|unhalt
decl_stmt|;
name|struct
name|counters
modifier|*
name|clear
decl_stmt|,
modifier|*
name|clear2
decl_stmt|,
modifier|*
name|clear3
decl_stmt|;
name|struct
name|counters
modifier|*
name|uops
decl_stmt|;
name|struct
name|counters
modifier|*
name|recv
decl_stmt|;
name|struct
name|counters
modifier|*
name|iss
decl_stmt|;
comment|/*	  "pmcstat -s CPU_CLK_UNHALTED.THREAD_P -s BR_MISP_RETIRED.ALL_BRANCHES -s MACHINE_CLEARS.MEMORY_ORDERING -s MACHINE_CLEARS.SMC -s MACHINE_CLEARS.MASKMOV -s UOPS_ISSUED.ANY -s UOPS_RETIRED.RETIRE_SLOTS -s INT_MISC.RECOVERY_CYCLES -w 1",*/
name|int
name|ret
decl_stmt|;
comment|/*   	 * (BR_MISP_RETIRED.ALL_BRANCHES /  	 *         (BR_MISP_RETIRED.ALL_BRANCHES + 	 *          MACHINE_CLEAR.COUNT) *  	 *	   ((UOPS_ISSUED.ANY - UOPS_RETIRED.RETIRE_SLOTS + 4 * INT_MISC.RECOVERY_CYCLES) / (4 * CPU_CLK_UNHALTED.THREAD))) 	 * 	 */
name|double
name|br
decl_stmt|,
name|cl
decl_stmt|,
name|cl2
decl_stmt|,
name|cl3
decl_stmt|,
name|uo
decl_stmt|,
name|re
decl_stmt|,
name|un
decl_stmt|,
name|con
decl_stmt|,
name|res
decl_stmt|,
name|is
decl_stmt|;
name|con
operator|=
literal|4.0
expr_stmt|;
name|unhalt
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"CPU_CLK_UNHALTED.THREAD_P"
argument_list|)
expr_stmt|;
name|brctr
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"BR_MISP_RETIRED.ALL_BRANCHES"
argument_list|)
expr_stmt|;
name|clear
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"MACHINE_CLEARS.MEMORY_ORDERING"
argument_list|)
expr_stmt|;
name|clear2
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"MACHINE_CLEARS.SMC"
argument_list|)
expr_stmt|;
name|clear3
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"MACHINE_CLEARS.MASKMOV"
argument_list|)
expr_stmt|;
name|uops
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"UOPS_RETIRED.RETIRE_SLOTS"
argument_list|)
expr_stmt|;
name|iss
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"UOPS_ISSUED.ANY"
argument_list|)
expr_stmt|;
name|recv
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"INT_MISC.RECOVERY_CYCLES"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|!=
operator|-
literal|1
condition|)
block|{
name|br
operator|=
name|brctr
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
name|cl
operator|=
name|clear
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
name|cl2
operator|=
name|clear2
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
name|cl3
operator|=
name|clear3
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
name|uo
operator|=
name|uops
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
name|re
operator|=
name|recv
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
name|is
operator|=
name|iss
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
block|}
else|else
block|{
name|br
operator|=
name|brctr
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
name|cl
operator|=
name|clear
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
name|cl2
operator|=
name|clear2
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
name|cl3
operator|=
name|clear3
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
name|uo
operator|=
name|uops
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
name|re
operator|=
name|recv
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
name|is
operator|=
name|iss
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
block|}
name|res
operator|=
operator|(
name|br
operator|/
operator|(
name|br
operator|+
name|cl
operator|+
name|cl2
operator|+
name|cl3
operator|)
operator|*
operator|(
operator|(
name|is
operator|-
name|uo
operator|+
name|con
operator|*
name|re
operator|)
operator|/
operator|(
name|con
operator|*
name|un
operator|)
operator|)
operator|)
expr_stmt|;
name|ret
operator|=
name|printf
argument_list|(
literal|"%1.3f"
argument_list|,
name|res
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|splitloadib
parameter_list|(
name|struct
name|counters
modifier|*
name|cpu
parameter_list|,
name|int
name|pos
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|struct
name|counters
modifier|*
name|mem
decl_stmt|;
name|struct
name|counters
modifier|*
name|l1d
decl_stmt|,
modifier|*
name|ldblock
decl_stmt|;
name|struct
name|counters
modifier|*
name|unhalt
decl_stmt|;
name|double
name|un
decl_stmt|,
name|memd
decl_stmt|,
name|res
decl_stmt|,
name|l1
decl_stmt|,
name|ldb
decl_stmt|;
comment|/*   	 * ((L1D_PEND_MISS.PENDING / MEM_LOAD_UOPS_RETIRED.L1_MISS) * LD_BLOCKS.NO_SR) / CPU_CLK_UNHALTED.THREAD_P 	 * "pmcstat -s CPU_CLK_UNHALTED.THREAD_P -s L1D_PEND_MISS.PENDING -s MEM_LOAD_UOPS_RETIRED.L1_MISS -s LD_BLOCKS.NO_SR -w 1", 	 */
name|unhalt
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"CPU_CLK_UNHALTED.THREAD_P"
argument_list|)
expr_stmt|;
name|mem
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"MEM_LOAD_UOPS_RETIRED.L1_MISS"
argument_list|)
expr_stmt|;
name|l1d
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"L1D_PEND_MISS.PENDING"
argument_list|)
expr_stmt|;
name|ldblock
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"LD_BLOCKS.NO_SR"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|!=
operator|-
literal|1
condition|)
block|{
name|memd
operator|=
name|mem
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
name|l1
operator|=
name|l1d
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
name|ldb
operator|=
name|ldblock
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
block|}
else|else
block|{
name|memd
operator|=
name|mem
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
name|l1
operator|=
name|l1d
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
name|ldb
operator|=
name|ldblock
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
block|}
name|res
operator|=
operator|(
operator|(
name|l1
operator|/
name|memd
operator|)
operator|*
name|ldb
operator|)
operator|/
name|un
expr_stmt|;
name|ret
operator|=
name|printf
argument_list|(
literal|"%1.3f"
argument_list|,
name|res
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|splitload
parameter_list|(
name|struct
name|counters
modifier|*
name|cpu
parameter_list|,
name|int
name|pos
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|struct
name|counters
modifier|*
name|mem
decl_stmt|;
name|struct
name|counters
modifier|*
name|unhalt
decl_stmt|;
name|double
name|con
decl_stmt|,
name|un
decl_stmt|,
name|memd
decl_stmt|,
name|res
decl_stmt|;
comment|/*  4  - (MEM_UOP_RETIRED.SPLIT_LOADS * 5) / CPU_CLK_UNHALTED.THREAD_P (thresh>= .1)*/
name|con
operator|=
literal|5.0
expr_stmt|;
name|unhalt
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"CPU_CLK_UNHALTED.THREAD_P"
argument_list|)
expr_stmt|;
name|mem
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"MEM_UOP_RETIRED.SPLIT_LOADS"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|!=
operator|-
literal|1
condition|)
block|{
name|memd
operator|=
name|mem
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
block|}
else|else
block|{
name|memd
operator|=
name|mem
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
block|}
name|res
operator|=
operator|(
name|memd
operator|*
name|con
operator|)
operator|/
name|un
expr_stmt|;
name|ret
operator|=
name|printf
argument_list|(
literal|"%1.3f"
argument_list|,
name|res
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|splitstore
parameter_list|(
name|struct
name|counters
modifier|*
name|cpu
parameter_list|,
name|int
name|pos
parameter_list|)
block|{
comment|/*  5  - MEM_UOP_RETIRED.SPLIT_STORES / MEM_UOP_RETIRED.ALL_STORES (thresh> 0.01) */
name|int
name|ret
decl_stmt|;
name|struct
name|counters
modifier|*
name|mem_split
decl_stmt|;
name|struct
name|counters
modifier|*
name|mem_stores
decl_stmt|;
name|double
name|memsplit
decl_stmt|,
name|memstore
decl_stmt|,
name|res
decl_stmt|;
name|mem_split
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"MEM_UOP_RETIRED.SPLIT_STORES"
argument_list|)
expr_stmt|;
name|mem_stores
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"MEM_UOP_RETIRED.ALL_STORES"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|!=
operator|-
literal|1
condition|)
block|{
name|memsplit
operator|=
name|mem_split
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
name|memstore
operator|=
name|mem_stores
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
block|}
else|else
block|{
name|memsplit
operator|=
name|mem_split
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
name|memstore
operator|=
name|mem_stores
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
block|}
name|res
operator|=
name|memsplit
operator|/
name|memstore
expr_stmt|;
name|ret
operator|=
name|printf
argument_list|(
literal|"%1.3f"
argument_list|,
name|res
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|contested
parameter_list|(
name|struct
name|counters
modifier|*
name|cpu
parameter_list|,
name|int
name|pos
parameter_list|)
block|{
comment|/*  6  - (MEM_LOAD_UOPS_LLC_HIT_RETIRED.XSNP_HITM * 60) / CPU_CLK_UNHALTED.THREAD_P (thresh>.05) */
name|int
name|ret
decl_stmt|;
name|struct
name|counters
modifier|*
name|mem
decl_stmt|;
name|struct
name|counters
modifier|*
name|unhalt
decl_stmt|;
name|double
name|con
decl_stmt|,
name|un
decl_stmt|,
name|memd
decl_stmt|,
name|res
decl_stmt|;
name|con
operator|=
literal|60.0
expr_stmt|;
name|unhalt
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"CPU_CLK_UNHALTED.THREAD_P"
argument_list|)
expr_stmt|;
name|mem
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"MEM_LOAD_UOPS_LLC_HIT_RETIRED.XSNP_HITM"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|!=
operator|-
literal|1
condition|)
block|{
name|memd
operator|=
name|mem
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
block|}
else|else
block|{
name|memd
operator|=
name|mem
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
block|}
name|res
operator|=
operator|(
name|memd
operator|*
name|con
operator|)
operator|/
name|un
expr_stmt|;
name|ret
operator|=
name|printf
argument_list|(
literal|"%1.3f"
argument_list|,
name|res
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|contested_has
parameter_list|(
name|struct
name|counters
modifier|*
name|cpu
parameter_list|,
name|int
name|pos
parameter_list|)
block|{
comment|/*  6  - (MEM_LOAD_UOPS_LLC_HIT_RETIRED.XSNP_HITM * 84) / CPU_CLK_UNHALTED.THREAD_P (thresh>.05) */
name|int
name|ret
decl_stmt|;
name|struct
name|counters
modifier|*
name|mem
decl_stmt|;
name|struct
name|counters
modifier|*
name|unhalt
decl_stmt|;
name|double
name|con
decl_stmt|,
name|un
decl_stmt|,
name|memd
decl_stmt|,
name|res
decl_stmt|;
name|con
operator|=
literal|84.0
expr_stmt|;
name|unhalt
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"CPU_CLK_UNHALTED.THREAD_P"
argument_list|)
expr_stmt|;
name|mem
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"MEM_LOAD_UOPS_LLC_HIT_RETIRED.XSNP_HITM"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|!=
operator|-
literal|1
condition|)
block|{
name|memd
operator|=
name|mem
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
block|}
else|else
block|{
name|memd
operator|=
name|mem
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
block|}
name|res
operator|=
operator|(
name|memd
operator|*
name|con
operator|)
operator|/
name|un
expr_stmt|;
name|ret
operator|=
name|printf
argument_list|(
literal|"%1.3f"
argument_list|,
name|res
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|blockstoreforward
parameter_list|(
name|struct
name|counters
modifier|*
name|cpu
parameter_list|,
name|int
name|pos
parameter_list|)
block|{
comment|/*  7  - (LD_BLOCKS_STORE_FORWARD * 13) / CPU_CLK_UNHALTED.THREAD_P (thresh>= .05)*/
name|int
name|ret
decl_stmt|;
name|struct
name|counters
modifier|*
name|ldb
decl_stmt|;
name|struct
name|counters
modifier|*
name|unhalt
decl_stmt|;
name|double
name|con
decl_stmt|,
name|un
decl_stmt|,
name|ld
decl_stmt|,
name|res
decl_stmt|;
name|con
operator|=
literal|13.0
expr_stmt|;
name|unhalt
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"CPU_CLK_UNHALTED.THREAD_P"
argument_list|)
expr_stmt|;
name|ldb
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"LD_BLOCKS_STORE_FORWARD"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|!=
operator|-
literal|1
condition|)
block|{
name|ld
operator|=
name|ldb
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
block|}
else|else
block|{
name|ld
operator|=
name|ldb
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
block|}
name|res
operator|=
operator|(
name|ld
operator|*
name|con
operator|)
operator|/
name|un
expr_stmt|;
name|ret
operator|=
name|printf
argument_list|(
literal|"%1.3f"
argument_list|,
name|res
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cache2
parameter_list|(
name|struct
name|counters
modifier|*
name|cpu
parameter_list|,
name|int
name|pos
parameter_list|)
block|{
comment|/* ** Suspect *** 	 *  8  - ((MEM_LOAD_RETIRED.L3_HIT * 26) + (MEM_LOAD_UOPS_LLC_HIT_RETIRED.XSNP_HIT * 43) + 	 *        (MEM_LOAD_UOPS_LLC_HIT_RETIRED.XSNP_HITM * 60)) / CPU_CLK_UNHALTED.THREAD_P (thresh>.2) 	 */
name|int
name|ret
decl_stmt|;
name|struct
name|counters
modifier|*
name|mem1
decl_stmt|,
modifier|*
name|mem2
decl_stmt|,
modifier|*
name|mem3
decl_stmt|;
name|struct
name|counters
modifier|*
name|unhalt
decl_stmt|;
name|double
name|con1
decl_stmt|,
name|con2
decl_stmt|,
name|con3
decl_stmt|,
name|un
decl_stmt|,
name|me_1
decl_stmt|,
name|me_2
decl_stmt|,
name|me_3
decl_stmt|,
name|res
decl_stmt|;
name|con1
operator|=
literal|26.0
expr_stmt|;
name|con2
operator|=
literal|43.0
expr_stmt|;
name|con3
operator|=
literal|60.0
expr_stmt|;
name|unhalt
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"CPU_CLK_UNHALTED.THREAD_P"
argument_list|)
expr_stmt|;
comment|/* Call for MEM_LOAD_RETIRED.L3_HIT possibly MEM_LOAD_UOPS_RETIRED.LLC_HIT ?*/
name|mem1
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"MEM_LOAD_UOPS_RETIRED.LLC_HIT"
argument_list|)
expr_stmt|;
name|mem2
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"MEM_LOAD_UOPS_LLC_HIT_RETIRED.XSNP_HIT"
argument_list|)
expr_stmt|;
name|mem3
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"MEM_LOAD_UOPS_LLC_HIT_RETIRED.XSNP_HITM"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|!=
operator|-
literal|1
condition|)
block|{
name|me_1
operator|=
name|mem1
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
name|me_2
operator|=
name|mem2
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
name|me_3
operator|=
name|mem3
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
block|}
else|else
block|{
name|me_1
operator|=
name|mem1
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
name|me_2
operator|=
name|mem2
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
name|me_3
operator|=
name|mem3
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
block|}
name|res
operator|=
operator|(
operator|(
name|me_1
operator|*
name|con1
operator|)
operator|+
operator|(
name|me_2
operator|*
name|con2
operator|)
operator|+
operator|(
name|me_3
operator|*
name|con3
operator|)
operator|)
operator|/
name|un
expr_stmt|;
name|ret
operator|=
name|printf
argument_list|(
literal|"%1.3f"
argument_list|,
name|res
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|datasharing
parameter_list|(
name|struct
name|counters
modifier|*
name|cpu
parameter_list|,
name|int
name|pos
parameter_list|)
block|{
comment|/*  	 * (MEM_LOAD_UOPS_L3_HIT_RETIRED.XSNP_HIT * 43)/ CPU_CLK_UNHALTED.THREAD_P (thresh>.2) 	 */
name|int
name|ret
decl_stmt|;
name|struct
name|counters
modifier|*
name|mem
decl_stmt|;
name|struct
name|counters
modifier|*
name|unhalt
decl_stmt|;
name|double
name|con
decl_stmt|,
name|res
decl_stmt|,
name|me
decl_stmt|,
name|un
decl_stmt|;
name|con
operator|=
literal|43.0
expr_stmt|;
name|unhalt
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"CPU_CLK_UNHALTED.THREAD_P"
argument_list|)
expr_stmt|;
name|mem
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"MEM_LOAD_UOPS_LLC_HIT_RETIRED.XSNP_HIT"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|!=
operator|-
literal|1
condition|)
block|{
name|me
operator|=
name|mem
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
block|}
else|else
block|{
name|me
operator|=
name|mem
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
block|}
name|res
operator|=
operator|(
name|me
operator|*
name|con
operator|)
operator|/
name|un
expr_stmt|;
name|ret
operator|=
name|printf
argument_list|(
literal|"%1.3f"
argument_list|,
name|res
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|datasharing_has
parameter_list|(
name|struct
name|counters
modifier|*
name|cpu
parameter_list|,
name|int
name|pos
parameter_list|)
block|{
comment|/*  	 * (MEM_LOAD_UOPS_L3_HIT_RETIRED.XSNP_HIT * 43)/ CPU_CLK_UNHALTED.THREAD_P (thresh>.2) 	 */
name|int
name|ret
decl_stmt|;
name|struct
name|counters
modifier|*
name|mem
decl_stmt|;
name|struct
name|counters
modifier|*
name|unhalt
decl_stmt|;
name|double
name|con
decl_stmt|,
name|res
decl_stmt|,
name|me
decl_stmt|,
name|un
decl_stmt|;
name|con
operator|=
literal|72.0
expr_stmt|;
name|unhalt
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"CPU_CLK_UNHALTED.THREAD_P"
argument_list|)
expr_stmt|;
name|mem
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"MEM_LOAD_UOPS_LLC_HIT_RETIRED.XSNP_HIT"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|!=
operator|-
literal|1
condition|)
block|{
name|me
operator|=
name|mem
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
block|}
else|else
block|{
name|me
operator|=
name|mem
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
block|}
name|res
operator|=
operator|(
name|me
operator|*
name|con
operator|)
operator|/
name|un
expr_stmt|;
name|ret
operator|=
name|printf
argument_list|(
literal|"%1.3f"
argument_list|,
name|res
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cache2ib
parameter_list|(
name|struct
name|counters
modifier|*
name|cpu
parameter_list|,
name|int
name|pos
parameter_list|)
block|{
comment|/* 	 *  (29 * MEM_LOAD_UOPS_RETIRED.LLC_HIT / CPU_CLK_UNHALTED.THREAD_P (thresh>.2) 	 */
name|int
name|ret
decl_stmt|;
name|struct
name|counters
modifier|*
name|mem
decl_stmt|;
name|struct
name|counters
modifier|*
name|unhalt
decl_stmt|;
name|double
name|con
decl_stmt|,
name|un
decl_stmt|,
name|me
decl_stmt|,
name|res
decl_stmt|;
name|con
operator|=
literal|29.0
expr_stmt|;
name|unhalt
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"CPU_CLK_UNHALTED.THREAD_P"
argument_list|)
expr_stmt|;
name|mem
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"MEM_LOAD_UOPS_RETIRED.LLC_HIT"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|!=
operator|-
literal|1
condition|)
block|{
name|me
operator|=
name|mem
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
block|}
else|else
block|{
name|me
operator|=
name|mem
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
block|}
name|res
operator|=
operator|(
name|con
operator|*
name|me
operator|)
operator|/
name|un
expr_stmt|;
name|ret
operator|=
name|printf
argument_list|(
literal|"%1.3f"
argument_list|,
name|res
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cache2has
parameter_list|(
name|struct
name|counters
modifier|*
name|cpu
parameter_list|,
name|int
name|pos
parameter_list|)
block|{
comment|/* 	 * Examine ((MEM_LOAD_UOPS_RETIRED.LLC_HIT * 36) + \ 	 *          (MEM_LOAD_UOPS_LLC_HIT_RETIRED.XSNP_HIT * 72) + 	 *          (MEM_LOAD_UOPS_LLC_HIT_RETIRED.XSNP_HITM * 84)) 	 *           / CPU_CLK_UNHALTED.THREAD_P 	 */
name|int
name|ret
decl_stmt|;
name|struct
name|counters
modifier|*
name|mem1
decl_stmt|,
modifier|*
name|mem2
decl_stmt|,
modifier|*
name|mem3
decl_stmt|;
name|struct
name|counters
modifier|*
name|unhalt
decl_stmt|;
name|double
name|con1
decl_stmt|,
name|con2
decl_stmt|,
name|con3
decl_stmt|,
name|un
decl_stmt|,
name|me1
decl_stmt|,
name|me2
decl_stmt|,
name|me3
decl_stmt|,
name|res
decl_stmt|;
name|con1
operator|=
literal|36.0
expr_stmt|;
name|con2
operator|=
literal|72.0
expr_stmt|;
name|con3
operator|=
literal|84.0
expr_stmt|;
name|unhalt
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"CPU_CLK_UNHALTED.THREAD_P"
argument_list|)
expr_stmt|;
name|mem1
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"MEM_LOAD_UOPS_RETIRED.LLC_HIT"
argument_list|)
expr_stmt|;
name|mem2
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"MEM_LOAD_UOPS_LLC_HIT_RETIRED.XSNP_HIT"
argument_list|)
expr_stmt|;
name|mem3
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"MEM_LOAD_UOPS_LLC_HIT_RETIRED.XSNP_HITM"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|!=
operator|-
literal|1
condition|)
block|{
name|me1
operator|=
name|mem1
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
name|me2
operator|=
name|mem2
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
name|me3
operator|=
name|mem3
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
block|}
else|else
block|{
name|me1
operator|=
name|mem1
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
name|me2
operator|=
name|mem2
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
name|me3
operator|=
name|mem3
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
block|}
name|res
operator|=
operator|(
operator|(
name|me1
operator|*
name|con1
operator|)
operator|+
operator|(
name|me2
operator|*
name|con2
operator|)
operator|+
operator|(
name|me3
operator|*
name|con3
operator|)
operator|)
operator|/
name|un
expr_stmt|;
name|ret
operator|=
name|printf
argument_list|(
literal|"%1.3f"
argument_list|,
name|res
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cache1
parameter_list|(
name|struct
name|counters
modifier|*
name|cpu
parameter_list|,
name|int
name|pos
parameter_list|)
block|{
comment|/*  9  - (MEM_LOAD_UOPS_MISC_RETIRED.LLC_MISS * 180) / CPU_CLK_UNHALTED.THREAD_P (thresh>= .2) */
name|int
name|ret
decl_stmt|;
name|struct
name|counters
modifier|*
name|mem
decl_stmt|;
name|struct
name|counters
modifier|*
name|unhalt
decl_stmt|;
name|double
name|con
decl_stmt|,
name|un
decl_stmt|,
name|me
decl_stmt|,
name|res
decl_stmt|;
name|con
operator|=
literal|180.0
expr_stmt|;
name|unhalt
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"CPU_CLK_UNHALTED.THREAD_P"
argument_list|)
expr_stmt|;
name|mem
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"MEM_LOAD_UOPS_MISC_RETIRED.LLC_MISS"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|!=
operator|-
literal|1
condition|)
block|{
name|me
operator|=
name|mem
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
block|}
else|else
block|{
name|me
operator|=
name|mem
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
block|}
name|res
operator|=
operator|(
name|me
operator|*
name|con
operator|)
operator|/
name|un
expr_stmt|;
name|ret
operator|=
name|printf
argument_list|(
literal|"%1.3f"
argument_list|,
name|res
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cache1ib
parameter_list|(
name|struct
name|counters
modifier|*
name|cpu
parameter_list|,
name|int
name|pos
parameter_list|)
block|{
comment|/*  9  - (MEM_LOAD_UOPS_L3_MISS_RETIRED.LCOAL_DRAM * 180) / CPU_CLK_UNHALTED.THREAD_P (thresh>= .2) */
name|int
name|ret
decl_stmt|;
name|struct
name|counters
modifier|*
name|mem
decl_stmt|;
name|struct
name|counters
modifier|*
name|unhalt
decl_stmt|;
name|double
name|con
decl_stmt|,
name|un
decl_stmt|,
name|me
decl_stmt|,
name|res
decl_stmt|;
name|con
operator|=
literal|180.0
expr_stmt|;
name|unhalt
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"CPU_CLK_UNHALTED.THREAD_P"
argument_list|)
expr_stmt|;
name|mem
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"MEM_LOAD_UOPS_LLC_MISS_RETIRED.LOCAL_DRAM"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|!=
operator|-
literal|1
condition|)
block|{
name|me
operator|=
name|mem
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
block|}
else|else
block|{
name|me
operator|=
name|mem
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
block|}
name|res
operator|=
operator|(
name|me
operator|*
name|con
operator|)
operator|/
name|un
expr_stmt|;
name|ret
operator|=
name|printf
argument_list|(
literal|"%1.3f"
argument_list|,
name|res
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dtlb_missload
parameter_list|(
name|struct
name|counters
modifier|*
name|cpu
parameter_list|,
name|int
name|pos
parameter_list|)
block|{
comment|/* 10  - ((DTLB_LOAD_MISSES.STLB_HIT * 7) + DTLB_LOAD_MISSES.WALK_DURATION) / CPU_CLK_UNHALTED.THREAD_P (t>=.1) */
name|int
name|ret
decl_stmt|;
name|struct
name|counters
modifier|*
name|dtlb_m
decl_stmt|,
modifier|*
name|dtlb_d
decl_stmt|;
name|struct
name|counters
modifier|*
name|unhalt
decl_stmt|;
name|double
name|con
decl_stmt|,
name|un
decl_stmt|,
name|d1
decl_stmt|,
name|d2
decl_stmt|,
name|res
decl_stmt|;
name|con
operator|=
literal|7.0
expr_stmt|;
name|unhalt
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"CPU_CLK_UNHALTED.THREAD_P"
argument_list|)
expr_stmt|;
name|dtlb_m
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"DTLB_LOAD_MISSES.STLB_HIT"
argument_list|)
expr_stmt|;
name|dtlb_d
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"DTLB_LOAD_MISSES.WALK_DURATION"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|!=
operator|-
literal|1
condition|)
block|{
name|d1
operator|=
name|dtlb_m
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
name|d2
operator|=
name|dtlb_d
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
block|}
else|else
block|{
name|d1
operator|=
name|dtlb_m
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
name|d2
operator|=
name|dtlb_d
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
block|}
name|res
operator|=
operator|(
operator|(
name|d1
operator|*
name|con
operator|)
operator|+
name|d2
operator|)
operator|/
name|un
expr_stmt|;
name|ret
operator|=
name|printf
argument_list|(
literal|"%1.3f"
argument_list|,
name|res
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dtlb_missstore
parameter_list|(
name|struct
name|counters
modifier|*
name|cpu
parameter_list|,
name|int
name|pos
parameter_list|)
block|{
comment|/*  	 * ((DTLB_STORE_MISSES.STLB_HIT * 7) + DTLB_STORE_MISSES.WALK_DURATION) /  	 * CPU_CLK_UNHALTED.THREAD_P (t>= .1)  	 */
name|int
name|ret
decl_stmt|;
name|struct
name|counters
modifier|*
name|dtsb_m
decl_stmt|,
modifier|*
name|dtsb_d
decl_stmt|;
name|struct
name|counters
modifier|*
name|unhalt
decl_stmt|;
name|double
name|con
decl_stmt|,
name|un
decl_stmt|,
name|d1
decl_stmt|,
name|d2
decl_stmt|,
name|res
decl_stmt|;
name|con
operator|=
literal|7.0
expr_stmt|;
name|unhalt
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"CPU_CLK_UNHALTED.THREAD_P"
argument_list|)
expr_stmt|;
name|dtsb_m
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"DTLB_STORE_MISSES.STLB_HIT"
argument_list|)
expr_stmt|;
name|dtsb_d
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"DTLB_STORE_MISSES.WALK_DURATION"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|!=
operator|-
literal|1
condition|)
block|{
name|d1
operator|=
name|dtsb_m
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
name|d2
operator|=
name|dtsb_d
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
block|}
else|else
block|{
name|d1
operator|=
name|dtsb_m
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
name|d2
operator|=
name|dtsb_d
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
block|}
name|res
operator|=
operator|(
operator|(
name|d1
operator|*
name|con
operator|)
operator|+
name|d2
operator|)
operator|/
name|un
expr_stmt|;
name|ret
operator|=
name|printf
argument_list|(
literal|"%1.3f"
argument_list|,
name|res
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|itlb_miss
parameter_list|(
name|struct
name|counters
modifier|*
name|cpu
parameter_list|,
name|int
name|pos
parameter_list|)
block|{
comment|/* ITLB_MISSES.WALK_DURATION / CPU_CLK_UNTHREAD_P  IB */
name|int
name|ret
decl_stmt|;
name|struct
name|counters
modifier|*
name|itlb
decl_stmt|;
name|struct
name|counters
modifier|*
name|unhalt
decl_stmt|;
name|double
name|un
decl_stmt|,
name|d1
decl_stmt|,
name|res
decl_stmt|;
name|unhalt
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"CPU_CLK_UNHALTED.THREAD_P"
argument_list|)
expr_stmt|;
name|itlb
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"ITLB_MISSES.WALK_DURATION"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|!=
operator|-
literal|1
condition|)
block|{
name|d1
operator|=
name|itlb
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
block|}
else|else
block|{
name|d1
operator|=
name|itlb
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
block|}
name|res
operator|=
name|d1
operator|/
name|un
expr_stmt|;
name|ret
operator|=
name|printf
argument_list|(
literal|"%1.3f"
argument_list|,
name|res
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|icache_miss
parameter_list|(
name|struct
name|counters
modifier|*
name|cpu
parameter_list|,
name|int
name|pos
parameter_list|)
block|{
comment|/* (ICACHE.IFETCH_STALL - ITLB_MISSES.WALK_DURATION) / CPU_CLK_UNHALTED.THREAD_P IB */
name|int
name|ret
decl_stmt|;
name|struct
name|counters
modifier|*
name|itlb
decl_stmt|,
modifier|*
name|icache
decl_stmt|;
name|struct
name|counters
modifier|*
name|unhalt
decl_stmt|;
name|double
name|un
decl_stmt|,
name|d1
decl_stmt|,
name|ic
decl_stmt|,
name|res
decl_stmt|;
name|unhalt
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"CPU_CLK_UNHALTED.THREAD_P"
argument_list|)
expr_stmt|;
name|itlb
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"ITLB_MISSES.WALK_DURATION"
argument_list|)
expr_stmt|;
name|icache
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"ICACHE.IFETCH_STALL"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|!=
operator|-
literal|1
condition|)
block|{
name|d1
operator|=
name|itlb
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
name|ic
operator|=
name|icache
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
block|}
else|else
block|{
name|d1
operator|=
name|itlb
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
name|ic
operator|=
name|icache
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
block|}
name|res
operator|=
operator|(
name|ic
operator|-
name|d1
operator|)
operator|/
name|un
expr_stmt|;
name|ret
operator|=
name|printf
argument_list|(
literal|"%1.3f"
argument_list|,
name|res
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|icache_miss_has
parameter_list|(
name|struct
name|counters
modifier|*
name|cpu
parameter_list|,
name|int
name|pos
parameter_list|)
block|{
comment|/* (36 * ICACHE.MISSES) / CPU_CLK_UNHALTED.THREAD_P */
name|int
name|ret
decl_stmt|;
name|struct
name|counters
modifier|*
name|icache
decl_stmt|;
name|struct
name|counters
modifier|*
name|unhalt
decl_stmt|;
name|double
name|un
decl_stmt|,
name|con
decl_stmt|,
name|ic
decl_stmt|,
name|res
decl_stmt|;
name|unhalt
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"CPU_CLK_UNHALTED.THREAD_P"
argument_list|)
expr_stmt|;
name|icache
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"ICACHE.MISSES"
argument_list|)
expr_stmt|;
name|con
operator|=
literal|36.0
expr_stmt|;
if|if
condition|(
name|pos
operator|!=
operator|-
literal|1
condition|)
block|{
name|ic
operator|=
name|icache
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
block|}
else|else
block|{
name|ic
operator|=
name|icache
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
block|}
name|res
operator|=
operator|(
name|con
operator|*
name|ic
operator|)
operator|/
name|un
expr_stmt|;
name|ret
operator|=
name|printf
argument_list|(
literal|"%1.3f"
argument_list|,
name|res
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|lcp_stall
parameter_list|(
name|struct
name|counters
modifier|*
name|cpu
parameter_list|,
name|int
name|pos
parameter_list|)
block|{
comment|/* ILD_STALL.LCP/CPU_CLK_UNHALTED.THREAD_P IB */
name|int
name|ret
decl_stmt|;
name|struct
name|counters
modifier|*
name|ild
decl_stmt|;
name|struct
name|counters
modifier|*
name|unhalt
decl_stmt|;
name|double
name|un
decl_stmt|,
name|d1
decl_stmt|,
name|res
decl_stmt|;
name|unhalt
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"CPU_CLK_UNHALTED.THREAD_P"
argument_list|)
expr_stmt|;
name|ild
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"ILD_STALL.LCP"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|!=
operator|-
literal|1
condition|)
block|{
name|d1
operator|=
name|ild
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
block|}
else|else
block|{
name|d1
operator|=
name|ild
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
block|}
name|res
operator|=
name|d1
operator|/
name|un
expr_stmt|;
name|ret
operator|=
name|printf
argument_list|(
literal|"%1.3f"
argument_list|,
name|res
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|frontendstall
parameter_list|(
name|struct
name|counters
modifier|*
name|cpu
parameter_list|,
name|int
name|pos
parameter_list|)
block|{
comment|/* 12  -  IDQ_UOPS_NOT_DELIVERED.CORE / (CPU_CLK_UNHALTED.THREAD_P * 4) (thresh>= .15) */
name|int
name|ret
decl_stmt|;
name|struct
name|counters
modifier|*
name|idq
decl_stmt|;
name|struct
name|counters
modifier|*
name|unhalt
decl_stmt|;
name|double
name|con
decl_stmt|,
name|un
decl_stmt|,
name|id
decl_stmt|,
name|res
decl_stmt|;
name|con
operator|=
literal|4.0
expr_stmt|;
name|unhalt
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"CPU_CLK_UNHALTED.THREAD_P"
argument_list|)
expr_stmt|;
name|idq
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"IDQ_UOPS_NOT_DELIVERED.CORE"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|!=
operator|-
literal|1
condition|)
block|{
name|id
operator|=
name|idq
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
block|}
else|else
block|{
name|id
operator|=
name|idq
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
block|}
name|res
operator|=
name|id
operator|/
operator|(
name|un
operator|*
name|con
operator|)
expr_stmt|;
name|ret
operator|=
name|printf
argument_list|(
literal|"%1.3f"
argument_list|,
name|res
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|clears
parameter_list|(
name|struct
name|counters
modifier|*
name|cpu
parameter_list|,
name|int
name|pos
parameter_list|)
block|{
comment|/* 13  - ((MACHINE_CLEARS.MEMORY_ORDERING + MACHINE_CLEARS.SMC + MACHINE_CLEARS.MASKMOV ) * 100 )   	 *         / CPU_CLK_UNHALTED.THREAD_P (thresh>= .02)*/
name|int
name|ret
decl_stmt|;
name|struct
name|counters
modifier|*
name|clr1
decl_stmt|,
modifier|*
name|clr2
decl_stmt|,
modifier|*
name|clr3
decl_stmt|;
name|struct
name|counters
modifier|*
name|unhalt
decl_stmt|;
name|double
name|con
decl_stmt|,
name|un
decl_stmt|,
name|cl1
decl_stmt|,
name|cl2
decl_stmt|,
name|cl3
decl_stmt|,
name|res
decl_stmt|;
name|con
operator|=
literal|100.0
expr_stmt|;
name|unhalt
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"CPU_CLK_UNHALTED.THREAD_P"
argument_list|)
expr_stmt|;
name|clr1
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"MACHINE_CLEARS.MEMORY_ORDERING"
argument_list|)
expr_stmt|;
name|clr2
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"MACHINE_CLEARS.SMC"
argument_list|)
expr_stmt|;
name|clr3
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"MACHINE_CLEARS.MASKMOV"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|!=
operator|-
literal|1
condition|)
block|{
name|cl1
operator|=
name|clr1
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
name|cl2
operator|=
name|clr2
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
name|cl3
operator|=
name|clr3
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
block|}
else|else
block|{
name|cl1
operator|=
name|clr1
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
name|cl2
operator|=
name|clr2
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
name|cl3
operator|=
name|clr3
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
block|}
name|res
operator|=
operator|(
operator|(
name|cl1
operator|+
name|cl2
operator|+
name|cl3
operator|)
operator|*
name|con
operator|)
operator|/
name|un
expr_stmt|;
name|ret
operator|=
name|printf
argument_list|(
literal|"%1.3f"
argument_list|,
name|res
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|microassist
parameter_list|(
name|struct
name|counters
modifier|*
name|cpu
parameter_list|,
name|int
name|pos
parameter_list|)
block|{
comment|/* 14  - IDQ.MS_CYCLES / CPU_CLK_UNHALTED.THREAD_P (thresh> .05) */
name|int
name|ret
decl_stmt|;
name|struct
name|counters
modifier|*
name|idq
decl_stmt|;
name|struct
name|counters
modifier|*
name|unhalt
decl_stmt|;
name|double
name|un
decl_stmt|,
name|id
decl_stmt|,
name|res
decl_stmt|,
name|con
decl_stmt|;
name|con
operator|=
literal|4.0
expr_stmt|;
name|unhalt
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"CPU_CLK_UNHALTED.THREAD_P"
argument_list|)
expr_stmt|;
name|idq
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"IDQ.MS_UOPS"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|!=
operator|-
literal|1
condition|)
block|{
name|id
operator|=
name|idq
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
block|}
else|else
block|{
name|id
operator|=
name|idq
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
block|}
name|res
operator|=
name|id
operator|/
operator|(
name|un
operator|*
name|con
operator|)
expr_stmt|;
name|ret
operator|=
name|printf
argument_list|(
literal|"%1.3f"
argument_list|,
name|res
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|aliasing
parameter_list|(
name|struct
name|counters
modifier|*
name|cpu
parameter_list|,
name|int
name|pos
parameter_list|)
block|{
comment|/* 15  - (LD_BLOCKS_PARTIAL.ADDRESS_ALIAS * 5) / CPU_CLK_UNHALTED.THREAD_P (thresh> .1) */
name|int
name|ret
decl_stmt|;
name|struct
name|counters
modifier|*
name|ld
decl_stmt|;
name|struct
name|counters
modifier|*
name|unhalt
decl_stmt|;
name|double
name|un
decl_stmt|,
name|lds
decl_stmt|,
name|con
decl_stmt|,
name|res
decl_stmt|;
name|con
operator|=
literal|5.0
expr_stmt|;
name|unhalt
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"CPU_CLK_UNHALTED.THREAD_P"
argument_list|)
expr_stmt|;
name|ld
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"LD_BLOCKS_PARTIAL.ADDRESS_ALIAS"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|!=
operator|-
literal|1
condition|)
block|{
name|lds
operator|=
name|ld
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
block|}
else|else
block|{
name|lds
operator|=
name|ld
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
block|}
name|res
operator|=
operator|(
name|lds
operator|*
name|con
operator|)
operator|/
name|un
expr_stmt|;
name|ret
operator|=
name|printf
argument_list|(
literal|"%1.3f"
argument_list|,
name|res
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|fpassists
parameter_list|(
name|struct
name|counters
modifier|*
name|cpu
parameter_list|,
name|int
name|pos
parameter_list|)
block|{
comment|/* 16  - FP_ASSIST.ANY/INST_RETIRED.ANY_P */
name|int
name|ret
decl_stmt|;
name|struct
name|counters
modifier|*
name|fp
decl_stmt|;
name|struct
name|counters
modifier|*
name|inst
decl_stmt|;
name|double
name|un
decl_stmt|,
name|fpd
decl_stmt|,
name|res
decl_stmt|;
name|inst
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"INST_RETIRED.ANY_P"
argument_list|)
expr_stmt|;
name|fp
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"FP_ASSIST.ANY"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|!=
operator|-
literal|1
condition|)
block|{
name|fpd
operator|=
name|fp
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|inst
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
block|}
else|else
block|{
name|fpd
operator|=
name|fp
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|inst
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
block|}
name|res
operator|=
name|fpd
operator|/
name|un
expr_stmt|;
name|ret
operator|=
name|printf
argument_list|(
literal|"%1.3f"
argument_list|,
name|res
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|otherassistavx
parameter_list|(
name|struct
name|counters
modifier|*
name|cpu
parameter_list|,
name|int
name|pos
parameter_list|)
block|{
comment|/* 17  - (OTHER_ASSISTS.AVX_TO_SSE * 75)/CPU_CLK_UNHALTED.THREAD_P thresh  .1*/
name|int
name|ret
decl_stmt|;
name|struct
name|counters
modifier|*
name|oth
decl_stmt|;
name|struct
name|counters
modifier|*
name|unhalt
decl_stmt|;
name|double
name|un
decl_stmt|,
name|ot
decl_stmt|,
name|con
decl_stmt|,
name|res
decl_stmt|;
name|con
operator|=
literal|75.0
expr_stmt|;
name|unhalt
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"CPU_CLK_UNHALTED.THREAD_P"
argument_list|)
expr_stmt|;
name|oth
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"OTHER_ASSISTS.AVX_TO_SSE"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|!=
operator|-
literal|1
condition|)
block|{
name|ot
operator|=
name|oth
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
block|}
else|else
block|{
name|ot
operator|=
name|oth
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
block|}
name|res
operator|=
operator|(
name|ot
operator|*
name|con
operator|)
operator|/
name|un
expr_stmt|;
name|ret
operator|=
name|printf
argument_list|(
literal|"%1.3f"
argument_list|,
name|res
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|otherassistsse
parameter_list|(
name|struct
name|counters
modifier|*
name|cpu
parameter_list|,
name|int
name|pos
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|struct
name|counters
modifier|*
name|oth
decl_stmt|;
name|struct
name|counters
modifier|*
name|unhalt
decl_stmt|;
name|double
name|un
decl_stmt|,
name|ot
decl_stmt|,
name|con
decl_stmt|,
name|res
decl_stmt|;
comment|/* 18     (OTHER_ASSISTS.SSE_TO_AVX * 75)/CPU_CLK_UNHALTED.THREAD_P  thresh .1*/
name|con
operator|=
literal|75.0
expr_stmt|;
name|unhalt
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"CPU_CLK_UNHALTED.THREAD_P"
argument_list|)
expr_stmt|;
name|oth
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"OTHER_ASSISTS.SSE_TO_AVX"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|!=
operator|-
literal|1
condition|)
block|{
name|ot
operator|=
name|oth
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
block|}
else|else
block|{
name|ot
operator|=
name|oth
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
block|}
name|res
operator|=
operator|(
name|ot
operator|*
name|con
operator|)
operator|/
name|un
expr_stmt|;
name|ret
operator|=
name|printf
argument_list|(
literal|"%1.3f"
argument_list|,
name|res
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|efficiency1
parameter_list|(
name|struct
name|counters
modifier|*
name|cpu
parameter_list|,
name|int
name|pos
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|struct
name|counters
modifier|*
name|uops
decl_stmt|;
name|struct
name|counters
modifier|*
name|unhalt
decl_stmt|;
name|double
name|un
decl_stmt|,
name|ot
decl_stmt|,
name|con
decl_stmt|,
name|res
decl_stmt|;
comment|/* 19 (UOPS_RETIRED.RETIRE_SLOTS/(4*CPU_CLK_UNHALTED.THREAD_P) look if thresh< .9*/
name|con
operator|=
literal|4.0
expr_stmt|;
name|unhalt
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"CPU_CLK_UNHALTED.THREAD_P"
argument_list|)
expr_stmt|;
name|uops
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"UOPS_RETIRED.RETIRE_SLOTS"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|!=
operator|-
literal|1
condition|)
block|{
name|ot
operator|=
name|uops
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
block|}
else|else
block|{
name|ot
operator|=
name|uops
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
block|}
name|res
operator|=
name|ot
operator|/
operator|(
name|con
operator|*
name|un
operator|)
expr_stmt|;
name|ret
operator|=
name|printf
argument_list|(
literal|"%1.3f"
argument_list|,
name|res
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|efficiency2
parameter_list|(
name|struct
name|counters
modifier|*
name|cpu
parameter_list|,
name|int
name|pos
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|struct
name|counters
modifier|*
name|uops
decl_stmt|;
name|struct
name|counters
modifier|*
name|unhalt
decl_stmt|;
name|double
name|un
decl_stmt|,
name|ot
decl_stmt|,
name|res
decl_stmt|;
comment|/* 20  - CPU_CLK_UNHALTED.THREAD_P/INST_RETIRED.ANY_P good if> 1. (comp factor)*/
name|unhalt
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"CPU_CLK_UNHALTED.THREAD_P"
argument_list|)
expr_stmt|;
name|uops
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
literal|"INST_RETIRED.ANY_P"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|!=
operator|-
literal|1
condition|)
block|{
name|ot
operator|=
name|uops
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
block|}
else|else
block|{
name|ot
operator|=
name|uops
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
name|un
operator|=
name|unhalt
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
block|}
name|res
operator|=
name|un
operator|/
name|ot
expr_stmt|;
name|ret
operator|=
name|printf
argument_list|(
literal|"%1.3f"
argument_list|,
name|res
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_define
define|#
directive|define
name|SANDY_BRIDGE_COUNT
value|20
end_define

begin_decl_stmt
specifier|static
name|struct
name|cpu_entry
name|sandy_bridge
index|[
name|SANDY_BRIDGE_COUNT
index|]
init|=
block|{
comment|/*01*/
block|{
literal|"allocstall1"
block|,
literal|"thresh> .05"
block|,
literal|"pmcstat -s CPU_CLK_UNHALTED.THREAD_P -s PARTIAL_RAT_STALLS.SLOW_LEA_WINDOW -w 1"
block|,
name|allocstall1
block|}
block|,
comment|/*02*/
block|{
literal|"allocstall2"
block|,
literal|"thresh> .05"
block|,
literal|"pmcstat -s CPU_CLK_UNHALTED.THREAD_P -s PARTIAL_RAT_STALLS.FLAGS_MERGE_UOP_CYCLES -w 1"
block|,
name|allocstall2
block|}
block|,
comment|/*03*/
block|{
literal|"br_miss"
block|,
literal|"thresh>= .2"
block|,
literal|"pmcstat -s CPU_CLK_UNHALTED.THREAD_P -s BR_MISP_RETIRED.ALL_BRANCHES -w 1"
block|,
name|br_mispredict
block|}
block|,
comment|/*04*/
block|{
literal|"splitload"
block|,
literal|"thresh>= .1"
block|,
literal|"pmcstat -s CPU_CLK_UNHALTED.THREAD_P -s MEM_UOP_RETIRED.SPLIT_LOADS -w 1"
block|,
name|splitload
block|}
block|,
comment|/*05*/
block|{
literal|"splitstore"
block|,
literal|"thresh>= .01"
block|,
literal|"pmcstat -s MEM_UOP_RETIRED.SPLIT_STORES -s MEM_UOP_RETIRED.ALL_STORES -w 1"
block|,
name|splitstore
block|}
block|,
comment|/*06*/
block|{
literal|"contested"
block|,
literal|"thresh>= .05"
block|,
literal|"pmcstat -s MEM_LOAD_UOPS_LLC_HIT_RETIRED.XSNP_HITM  -s CPU_CLK_UNHALTED.THREAD_P -w 1"
block|,
name|contested
block|}
block|,
comment|/*07*/
block|{
literal|"blockstorefwd"
block|,
literal|"thresh>= .05"
block|,
literal|"pmcstat -s LD_BLOCKS_STORE_FORWARD -s CPU_CLK_UNHALTED.THREAD_P -w 1"
block|,
name|blockstoreforward
block|}
block|,
comment|/*08*/
block|{
literal|"cache2"
block|,
literal|"thresh>= .2"
block|,
literal|"pmcstat -s MEM_LOAD_UOPS_RETIRED.LLC_HIT -s MEM_LOAD_UOPS_LLC_HIT_RETIRED.XSNP_HIT -s MEM_LOAD_UOPS_LLC_HIT_RETIRED.XSNP_HITM -s CPU_CLK_UNHALTED.THREAD_P -w 1"
block|,
name|cache2
block|}
block|,
comment|/*09*/
block|{
literal|"cache1"
block|,
literal|"thresh>= .2"
block|,
literal|"pmcstat -s MEM_LOAD_UOPS_MISC_RETIRED.LLC_MISS -s CPU_CLK_UNHALTED.THREAD_P -w 1"
block|,
name|cache1
block|}
block|,
comment|/*10*/
block|{
literal|"dtlbmissload"
block|,
literal|"thresh>= .1"
block|,
literal|"pmcstat -s DTLB_LOAD_MISSES.STLB_HIT -s DTLB_LOAD_MISSES.WALK_DURATION -s CPU_CLK_UNHALTED.THREAD_P -w 1"
block|,
name|dtlb_missload
block|}
block|,
comment|/*11*/
block|{
literal|"dtlbmissstore"
block|,
literal|"thresh>= .05"
block|,
literal|"pmcstat -s DTLB_STORE_MISSES.STLB_HIT -s DTLB_STORE_MISSES.WALK_DURATION -s CPU_CLK_UNHALTED.THREAD_P -w 1"
block|,
name|dtlb_missstore
block|}
block|,
comment|/*12*/
block|{
literal|"frontendstall"
block|,
literal|"thresh>= .15"
block|,
literal|"pmcstat -s IDQ_UOPS_NOT_DELIVERED.CORE -s CPU_CLK_UNHALTED.THREAD_P -w 1"
block|,
name|frontendstall
block|}
block|,
comment|/*13*/
block|{
literal|"clears"
block|,
literal|"thresh>= .02"
block|,
literal|"pmcstat -s MACHINE_CLEARS.MEMORY_ORDERING -s MACHINE_CLEARS.SMC -s MACHINE_CLEARS.MASKMOV -s CPU_CLK_UNHALTED.THREAD_P -w 1"
block|,
name|clears
block|}
block|,
comment|/*14*/
block|{
literal|"microassist"
block|,
literal|"thresh>= .05"
block|,
literal|"pmcstat -s IDQ.MS_UOPS,cmask=1 -s CPU_CLK_UNHALTED.THREAD_P -w 1"
block|,
name|microassist
block|}
block|,
comment|/*15*/
block|{
literal|"aliasing_4k"
block|,
literal|"thresh>= .1"
block|,
literal|"pmcstat -s LD_BLOCKS_PARTIAL.ADDRESS_ALIAS -s CPU_CLK_UNHALTED.THREAD_P -w 1"
block|,
name|aliasing
block|}
block|,
comment|/*16*/
block|{
literal|"fpassist"
block|,
literal|"look for a excessive value"
block|,
literal|"pmcstat -s FP_ASSIST.ANY -s INST_RETIRED.ANY_P -w 1"
block|,
name|fpassists
block|}
block|,
comment|/*17*/
block|{
literal|"otherassistavx"
block|,
literal|"look for a excessive value"
block|,
literal|"pmcstat -s OTHER_ASSISTS.AVX_TO_SSE -s CPU_CLK_UNHALTED.THREAD_P -w 1"
block|,
name|otherassistavx
block|}
block|,
comment|/*18*/
block|{
literal|"otherassistsse"
block|,
literal|"look for a excessive value"
block|,
literal|"pmcstat -s OTHER_ASSISTS.SSE_TO_AVX -s CPU_CLK_UNHALTED.THREAD_P -w 1"
block|,
name|otherassistsse
block|}
block|,
comment|/*19*/
block|{
literal|"eff1"
block|,
literal|"thresh< .9"
block|,
literal|"pmcstat -s UOPS_RETIRED.RETIRE_SLOTS -s CPU_CLK_UNHALTED.THREAD_P -w 1"
block|,
name|efficiency1
block|}
block|,
comment|/*20*/
block|{
literal|"eff2"
block|,
literal|"thresh> 1.0"
block|,
literal|"pmcstat -s INST_RETIRED.ANY_P -s CPU_CLK_UNHALTED.THREAD_P -w 1"
block|,
name|efficiency2
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|IVY_BRIDGE_COUNT
value|21
end_define

begin_decl_stmt
specifier|static
name|struct
name|cpu_entry
name|ivy_bridge
index|[
name|IVY_BRIDGE_COUNT
index|]
init|=
block|{
comment|/*1*/
block|{
literal|"eff1"
block|,
literal|"thresh< .75"
block|,
literal|"pmcstat -s UOPS_RETIRED.RETIRE_SLOTS -s CPU_CLK_UNHALTED.THREAD_P -w 1"
block|,
name|efficiency1
block|}
block|,
comment|/*2*/
block|{
literal|"eff2"
block|,
literal|"thresh> 1.0"
block|,
literal|"pmcstat -s INST_RETIRED.ANY_P -s CPU_CLK_UNHALTED.THREAD_P -w 1"
block|,
name|efficiency2
block|}
block|,
comment|/*3*/
block|{
literal|"itlbmiss"
block|,
literal|"thresh> .05"
block|,
literal|"pmcstat -s ITLB_MISSES.WALK_DURATION -s CPU_CLK_UNHALTED.THREAD_P -w 1"
block|,
name|itlb_miss
block|}
block|,
comment|/*4*/
block|{
literal|"icachemiss"
block|,
literal|"thresh> .05"
block|,
literal|"pmcstat -s ICACHE.IFETCH_STALL -s ITLB_MISSES.WALK_DURATION -s CPU_CLK_UNHALTED.THREAD_P -w 1"
block|,
name|icache_miss
block|}
block|,
comment|/*5*/
block|{
literal|"lcpstall"
block|,
literal|"thresh> .05"
block|,
literal|"pmcstat -s ILD_STALL.LCP -s CPU_CLK_UNHALTED.THREAD_P -w 1"
block|,
name|lcp_stall
block|}
block|,
comment|/*6*/
block|{
literal|"cache1"
block|,
literal|"thresh>= .2"
block|,
literal|"pmcstat -s MEM_LOAD_UOPS_LLC_MISS_RETIRED.LOCAL_DRAM -s CPU_CLK_UNHALTED.THREAD_P -w 1"
block|,
name|cache1ib
block|}
block|,
comment|/*7*/
block|{
literal|"cache2"
block|,
literal|"thresh>= .2"
block|,
literal|"pmcstat -s MEM_LOAD_UOPS_RETIRED.LLC_HIT -s CPU_CLK_UNHALTED.THREAD_P -w 1"
block|,
name|cache2ib
block|}
block|,
comment|/*8*/
block|{
literal|"contested"
block|,
literal|"thresh>= .05"
block|,
literal|"pmcstat -s MEM_LOAD_UOPS_LLC_HIT_RETIRED.XSNP_HITM  -s CPU_CLK_UNHALTED.THREAD_P -w 1"
block|,
name|contested
block|}
block|,
comment|/*9*/
block|{
literal|"datashare"
block|,
literal|"thresh>= .05"
block|,
literal|"pmcstat -s MEM_LOAD_UOPS_LLC_HIT_RETIRED.XSNP_HIT -s CPU_CLK_UNHALTED.THREAD_P -w 1"
block|,
name|datasharing
block|}
block|,
comment|/*10*/
block|{
literal|"blockstorefwd"
block|,
literal|"thresh>= .05"
block|,
literal|"pmcstat -s LD_BLOCKS_STORE_FORWARD -s CPU_CLK_UNHALTED.THREAD_P -w 1"
block|,
name|blockstoreforward
block|}
block|,
comment|/*11*/
block|{
literal|"splitload"
block|,
literal|"thresh>= .1"
block|,
literal|"pmcstat -s CPU_CLK_UNHALTED.THREAD_P -s L1D_PEND_MISS.PENDING -s MEM_LOAD_UOPS_RETIRED.L1_MISS -s LD_BLOCKS.NO_SR -w 1"
block|,
name|splitloadib
block|}
block|,
comment|/*12*/
block|{
literal|"splitstore"
block|,
literal|"thresh>= .01"
block|,
literal|"pmcstat -s MEM_UOP_RETIRED.SPLIT_STORES -s MEM_UOP_RETIRED.ALL_STORES -w 1"
block|,
name|splitstore
block|}
block|,
comment|/*13*/
block|{
literal|"aliasing_4k"
block|,
literal|"thresh>= .1"
block|,
literal|"pmcstat -s LD_BLOCKS_PARTIAL.ADDRESS_ALIAS -s CPU_CLK_UNHALTED.THREAD_P -w 1"
block|,
name|aliasing
block|}
block|,
comment|/*14*/
block|{
literal|"dtlbmissload"
block|,
literal|"thresh>= .1"
block|,
literal|"pmcstat -s DTLB_LOAD_MISSES.STLB_HIT -s DTLB_LOAD_MISSES.WALK_DURATION -s CPU_CLK_UNHALTED.THREAD_P -w 1"
block|,
name|dtlb_missload
block|}
block|,
comment|/*15*/
block|{
literal|"dtlbmissstore"
block|,
literal|"thresh>= .05"
block|,
literal|"pmcstat -s DTLB_STORE_MISSES.STLB_HIT -s DTLB_STORE_MISSES.WALK_DURATION -s CPU_CLK_UNHALTED.THREAD_P -w 1"
block|,
name|dtlb_missstore
block|}
block|,
comment|/*16*/
block|{
literal|"br_miss"
block|,
literal|"thresh>= .2"
block|,
literal|"pmcstat -s CPU_CLK_UNHALTED.THREAD_P -s BR_MISP_RETIRED.ALL_BRANCHES -s MACHINE_CLEARS.MEMORY_ORDERING -s MACHINE_CLEARS.SMC -s MACHINE_CLEARS.MASKMOV -s UOPS_ISSUED.ANY -s UOPS_RETIRED.RETIRE_SLOTS -s INT_MISC.RECOVERY_CYCLES -w 1"
block|,
name|br_mispredictib
block|}
block|,
comment|/*17*/
block|{
literal|"clears"
block|,
literal|"thresh>= .02"
block|,
literal|"pmcstat -s MACHINE_CLEARS.MEMORY_ORDERING -s MACHINE_CLEARS.SMC -s MACHINE_CLEARS.MASKMOV -s CPU_CLK_UNHALTED.THREAD_P -w 1"
block|,
name|clears
block|}
block|,
comment|/*18*/
block|{
literal|"microassist"
block|,
literal|"thresh>= .05"
block|,
literal|"pmcstat -s IDQ.MS_UOPS,cmask=1 -s CPU_CLK_UNHALTED.THREAD_P -w 1"
block|,
name|microassist
block|}
block|,
comment|/*19*/
block|{
literal|"fpassist"
block|,
literal|"look for a excessive value"
block|,
literal|"pmcstat -s FP_ASSIST.ANY -s INST_RETIRED.ANY_P -w 1"
block|,
name|fpassists
block|}
block|,
comment|/*20*/
block|{
literal|"otherassistavx"
block|,
literal|"look for a excessive value"
block|,
literal|"pmcstat -s OTHER_ASSISTS.AVX_TO_SSE -s CPU_CLK_UNHALTED.THREAD_P -w 1"
block|,
name|otherassistavx
block|}
block|,
comment|/*21*/
block|{
literal|"otherassistsse"
block|,
literal|"look for a excessive value"
block|,
literal|"pmcstat -s OTHER_ASSISTS.SSE_TO_AVX -s CPU_CLK_UNHALTED.THREAD_P -w 1"
block|,
name|otherassistsse
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|HASWELL_COUNT
value|20
end_define

begin_decl_stmt
specifier|static
name|struct
name|cpu_entry
name|haswell
index|[
name|HASWELL_COUNT
index|]
init|=
block|{
comment|/*1*/
block|{
literal|"eff1"
block|,
literal|"thresh< .75"
block|,
literal|"pmcstat -s UOPS_RETIRED.RETIRE_SLOTS -s CPU_CLK_UNHALTED.THREAD_P -w 1"
block|,
name|efficiency1
block|}
block|,
comment|/*2*/
block|{
literal|"eff2"
block|,
literal|"thresh> 1.0"
block|,
literal|"pmcstat -s INST_RETIRED.ANY_P -s CPU_CLK_UNHALTED.THREAD_P -w 1"
block|,
name|efficiency2
block|}
block|,
comment|/*3*/
block|{
literal|"itlbmiss"
block|,
literal|"thresh> .05"
block|,
literal|"pmcstat -s ITLB_MISSES.WALK_DURATION -s CPU_CLK_UNHALTED.THREAD_P -w 1"
block|,
name|itlb_miss
block|}
block|,
comment|/*4*/
block|{
literal|"icachemiss"
block|,
literal|"thresh> .05"
block|,
literal|"pmcstat -s ICACHE.MISSES --s CPU_CLK_UNHALTED.THREAD_P -w 1"
block|,
name|icache_miss_has
block|}
block|,
comment|/*5*/
block|{
literal|"lcpstall"
block|,
literal|"thresh> .05"
block|,
literal|"pmcstat -s ILD_STALL.LCP -s CPU_CLK_UNHALTED.THREAD_P -w 1"
block|,
name|lcp_stall
block|}
block|,
comment|/*6*/
block|{
literal|"cache1"
block|,
literal|"thresh>= .2"
block|,
literal|"pmcstat -s MEM_LOAD_UOPS_LLC_MISS_RETIRED.LOCAL_DRAM -s CPU_CLK_UNHALTED.THREAD_P -w 1"
block|,
name|cache1ib
block|}
block|,
comment|/*7*/
block|{
literal|"cache2"
block|,
literal|"thresh>= .2"
block|,
literal|"pmcstat -s MEM_LOAD_UOPS_RETIRED.LLC_HIT  -s MEM_LOAD_UOPS_LLC_HIT_RETIRED.XSNP_HIT -s MEM_LOAD_UOPS_LLC_HIT_RETIRED.XSNP_HITM -s CPU_CLK_UNHALTED.THREAD_P -w 1"
block|,
name|cache2has
block|}
block|,
comment|/*8*/
block|{
literal|"contested"
block|,
literal|"thresh>= .05"
block|,
literal|"pmcstat -s MEM_LOAD_UOPS_LLC_HIT_RETIRED.XSNP_HITM  -s CPU_CLK_UNHALTED.THREAD_P -w 1"
block|,
name|contested_has
block|}
block|,
comment|/*9*/
block|{
literal|"datashare"
block|,
literal|"thresh>= .05"
block|,
literal|"pmcstat -s MEM_LOAD_UOPS_LLC_HIT_RETIRED.XSNP_HIT -s CPU_CLK_UNHALTED.THREAD_P -w 1"
block|,
name|datasharing_has
block|}
block|,
comment|/*10*/
block|{
literal|"blockstorefwd"
block|,
literal|"thresh>= .05"
block|,
literal|"pmcstat -s LD_BLOCKS_STORE_FORWARD -s CPU_CLK_UNHALTED.THREAD_P -w 1"
block|,
name|blockstoreforward
block|}
block|,
comment|/*11*/
block|{
literal|"splitload"
block|,
literal|"thresh>= .1"
block|,
literal|"pmcstat -s CPU_CLK_UNHALTED.THREAD_P -s MEM_UOP_RETIRED.SPLIT_LOADS -w 1"
block|,
name|splitload
block|}
block|,
comment|/*12*/
block|{
literal|"splitstore"
block|,
literal|"thresh>= .01"
block|,
literal|"pmcstat -s MEM_UOP_RETIRED.SPLIT_STORES -s MEM_UOP_RETIRED.ALL_STORES -w 1"
block|,
name|splitstore
block|}
block|,
comment|/*13*/
block|{
literal|"aliasing_4k"
block|,
literal|"thresh>= .1"
block|,
literal|"pmcstat -s LD_BLOCKS_PARTIAL.ADDRESS_ALIAS -s CPU_CLK_UNHALTED.THREAD_P -w 1"
block|,
name|aliasing
block|}
block|,
comment|/*14*/
block|{
literal|"dtlbmissload"
block|,
literal|"thresh>= .1"
block|,
literal|"pmcstat -s DTLB_LOAD_MISSES.STLB_HIT -s DTLB_LOAD_MISSES.WALK_DURATION -s CPU_CLK_UNHALTED.THREAD_P -w 1"
block|,
name|dtlb_missload
block|}
block|,
comment|/*15*/
block|{
literal|"br_miss"
block|,
literal|"thresh>= .2"
block|,
literal|"pmcstat -s CPU_CLK_UNHALTED.THREAD_P -s BR_MISP_RETIRED.ALL_BRANCHES -w 1"
block|,
name|br_mispredict
block|}
block|,
comment|/*16*/
block|{
literal|"clears"
block|,
literal|"thresh>= .02"
block|,
literal|"pmcstat -s MACHINE_CLEARS.MEMORY_ORDERING -s MACHINE_CLEARS.SMC -s MACHINE_CLEARS.MASKMOV -s CPU_CLK_UNHALTED.THREAD_P -w 1"
block|,
name|clears
block|}
block|,
comment|/*17*/
block|{
literal|"microassist"
block|,
literal|"thresh>= .05"
block|,
literal|"pmcstat -s IDQ.MS_UOPS,cmask=1 -s CPU_CLK_UNHALTED.THREAD_P -w 1"
block|,
name|microassist
block|}
block|,
comment|/*18*/
block|{
literal|"fpassist"
block|,
literal|"look for a excessive value"
block|,
literal|"pmcstat -s FP_ASSIST.ANY -s INST_RETIRED.ANY_P -w 1"
block|,
name|fpassists
block|}
block|,
comment|/*19*/
block|{
literal|"otherassistavx"
block|,
literal|"look for a excessive value"
block|,
literal|"pmcstat -s OTHER_ASSISTS.AVX_TO_SSE -s CPU_CLK_UNHALTED.THREAD_P -w 1"
block|,
name|otherassistavx
block|}
block|,
comment|/*20*/
block|{
literal|"otherassistsse"
block|,
literal|"look for a excessive value"
block|,
literal|"pmcstat -s OTHER_ASSISTS.SSE_TO_AVX -s CPU_CLK_UNHALTED.THREAD_P -w 1"
block|,
name|otherassistsse
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|set_sandybridge
parameter_list|(
name|void
parameter_list|)
block|{
name|strcpy
argument_list|(
name|the_cpu
operator|.
name|cputype
argument_list|,
literal|"SandyBridge PMC"
argument_list|)
expr_stmt|;
name|the_cpu
operator|.
name|number
operator|=
name|SANDY_BRIDGE_COUNT
expr_stmt|;
name|the_cpu
operator|.
name|ents
operator|=
name|sandy_bridge
expr_stmt|;
name|the_cpu
operator|.
name|explain
operator|=
name|explain_name_sb
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|set_ivybridge
parameter_list|(
name|void
parameter_list|)
block|{
name|strcpy
argument_list|(
name|the_cpu
operator|.
name|cputype
argument_list|,
literal|"IvyBridge PMC"
argument_list|)
expr_stmt|;
name|the_cpu
operator|.
name|number
operator|=
name|IVY_BRIDGE_COUNT
expr_stmt|;
name|the_cpu
operator|.
name|ents
operator|=
name|ivy_bridge
expr_stmt|;
name|the_cpu
operator|.
name|explain
operator|=
name|explain_name_ib
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|set_haswell
parameter_list|(
name|void
parameter_list|)
block|{
name|strcpy
argument_list|(
name|the_cpu
operator|.
name|cputype
argument_list|,
literal|"HASWELL PMC"
argument_list|)
expr_stmt|;
name|the_cpu
operator|.
name|number
operator|=
name|HASWELL_COUNT
expr_stmt|;
name|the_cpu
operator|.
name|ents
operator|=
name|haswell
expr_stmt|;
name|the_cpu
operator|.
name|explain
operator|=
name|explain_name_has
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|set_expression
parameter_list|(
name|char
modifier|*
name|name
parameter_list|)
block|{
name|int
name|found
init|=
literal|0
decl_stmt|,
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|the_cpu
operator|.
name|number
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
name|the_cpu
operator|.
name|ents
index|[
name|i
index|]
operator|.
name|name
argument_list|)
operator|==
literal|0
condition|)
block|{
name|found
operator|=
literal|1
expr_stmt|;
name|expression
operator|=
name|the_cpu
operator|.
name|ents
index|[
name|i
index|]
operator|.
name|func
expr_stmt|;
name|command
operator|=
name|the_cpu
operator|.
name|ents
index|[
name|i
index|]
operator|.
name|command
expr_stmt|;
name|threshold
operator|=
name|the_cpu
operator|.
name|ents
index|[
name|i
index|]
operator|.
name|thresh
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
operator|!
name|found
condition|)
block|{
name|printf
argument_list|(
literal|"For CPU type %s we have no expression:%s\n"
argument_list|,
name|the_cpu
operator|.
name|cputype
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|validate_expression
parameter_list|(
name|char
modifier|*
name|name
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|found
decl_stmt|;
name|found
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|the_cpu
operator|.
name|number
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
name|the_cpu
operator|.
name|ents
index|[
name|i
index|]
operator|.
name|name
argument_list|)
operator|==
literal|0
condition|)
block|{
name|found
operator|=
literal|1
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
operator|!
name|found
condition|)
block|{
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|do_expression
parameter_list|(
name|struct
name|counters
modifier|*
name|cpu
parameter_list|,
name|int
name|pos
parameter_list|)
block|{
if|if
condition|(
name|expression
operator|==
name|NULL
condition|)
return|return;
call|(
modifier|*
name|expression
call|)
argument_list|(
name|cpu
argument_list|,
name|pos
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|process_header
parameter_list|(
name|int
name|idx
parameter_list|,
name|char
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|counters
modifier|*
name|up
decl_stmt|;
name|int
name|i
decl_stmt|,
name|len
decl_stmt|,
name|nlen
decl_stmt|;
comment|/*  	 * Given header element idx, at p in 	 * form 's/NN/nameof' 	 * process the entry to pull out the name and 	 * the CPU number. 	 */
if|if
condition|(
name|strncmp
argument_list|(
name|p
argument_list|,
literal|"s/"
argument_list|,
literal|2
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Check -- invalid header no s/ in %s\n"
argument_list|,
name|p
argument_list|)
expr_stmt|;
return|return;
block|}
name|up
operator|=
operator|&
name|cnts
index|[
name|idx
index|]
expr_stmt|;
name|up
operator|->
name|cpu
operator|=
name|strtol
argument_list|(
operator|&
name|p
index|[
literal|2
index|]
argument_list|,
name|NULL
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|len
operator|=
name|strlen
argument_list|(
name|p
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|2
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|p
index|[
name|i
index|]
operator|==
literal|'/'
condition|)
block|{
name|nlen
operator|=
name|strlen
argument_list|(
operator|&
name|p
index|[
operator|(
name|i
operator|+
literal|1
operator|)
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|nlen
operator|<
operator|(
name|MAX_NLEN
operator|-
literal|1
operator|)
condition|)
block|{
name|strcpy
argument_list|(
name|up
operator|->
name|counter_name
argument_list|,
operator|&
name|p
index|[
operator|(
name|i
operator|+
literal|1
operator|)
index|]
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|strncpy
argument_list|(
name|up
operator|->
name|counter_name
argument_list|,
operator|&
name|p
index|[
operator|(
name|i
operator|+
literal|1
operator|)
index|]
argument_list|,
operator|(
name|MAX_NLEN
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|build_counters_from_header
parameter_list|(
name|FILE
modifier|*
name|io
parameter_list|)
block|{
name|char
name|buffer
index|[
literal|8192
index|]
decl_stmt|,
modifier|*
name|p
decl_stmt|;
name|int
name|i
decl_stmt|,
name|len
decl_stmt|,
name|cnt
decl_stmt|;
name|size_t
name|mlen
decl_stmt|;
comment|/* We have a new start, lets  	 * setup our headers and cpus. 	 */
if|if
condition|(
name|fgets
argument_list|(
name|buffer
argument_list|,
sizeof|sizeof
argument_list|(
name|buffer
argument_list|)
argument_list|,
name|io
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"First line can't be read from file err:%d\n"
argument_list|,
name|errno
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 	 * Ok output is an array of counters. Once 	 * we start to read the values in we must 	 * put them in there slot to match there CPU and  	 * counter being updated. We create a mass array 	 * of the counters, filling in the CPU and  	 * counter name.  	 */
comment|/* How many do we get? */
name|len
operator|=
name|strlen
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|cnt
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|strncmp
argument_list|(
operator|&
name|buffer
index|[
name|i
index|]
argument_list|,
literal|"s/"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|cnt
operator|++
expr_stmt|;
for|for
control|(
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|buffer
index|[
name|i
index|]
operator|==
literal|' '
condition|)
break|break;
block|}
block|}
block|}
name|mlen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|counters
argument_list|)
operator|*
name|cnt
expr_stmt|;
name|cnts
operator|=
name|malloc
argument_list|(
name|mlen
argument_list|)
expr_stmt|;
name|ncnts
operator|=
name|cnt
expr_stmt|;
if|if
condition|(
name|cnts
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"No memory err:%d\n"
argument_list|,
name|errno
argument_list|)
expr_stmt|;
return|return;
block|}
name|memset
argument_list|(
name|cnts
argument_list|,
literal|0
argument_list|,
name|mlen
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|cnt
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|strncmp
argument_list|(
operator|&
name|buffer
index|[
name|i
index|]
argument_list|,
literal|"s/"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|p
operator|=
operator|&
name|buffer
index|[
name|i
index|]
expr_stmt|;
for|for
control|(
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|buffer
index|[
name|i
index|]
operator|==
literal|' '
condition|)
block|{
name|buffer
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
break|break;
block|}
block|}
name|process_header
argument_list|(
name|cnt
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|cnt
operator|++
expr_stmt|;
block|}
block|}
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"We have %d entries\n"
argument_list|,
name|cnt
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|extern
name|int
name|max_to_collect
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|max_to_collect
init|=
name|MAX_COUNTER_SLOTS
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|read_a_line
parameter_list|(
name|FILE
modifier|*
name|io
parameter_list|)
block|{
name|char
name|buffer
index|[
literal|8192
index|]
decl_stmt|,
modifier|*
name|p
decl_stmt|,
modifier|*
name|stop
decl_stmt|;
name|int
name|pos
decl_stmt|,
name|i
decl_stmt|;
if|if
condition|(
name|fgets
argument_list|(
name|buffer
argument_list|,
sizeof|sizeof
argument_list|(
name|buffer
argument_list|)
argument_list|,
name|io
argument_list|)
operator|==
name|NULL
condition|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|p
operator|=
name|buffer
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ncnts
condition|;
name|i
operator|++
control|)
block|{
name|pos
operator|=
name|cnts
index|[
name|i
index|]
operator|.
name|pos
expr_stmt|;
name|cnts
index|[
name|i
index|]
operator|.
name|vals
index|[
name|pos
index|]
operator|=
name|strtol
argument_list|(
name|p
argument_list|,
operator|&
name|stop
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|cnts
index|[
name|i
index|]
operator|.
name|pos
operator|++
expr_stmt|;
name|cnts
index|[
name|i
index|]
operator|.
name|sum
operator|+=
name|cnts
index|[
name|i
index|]
operator|.
name|vals
index|[
name|pos
index|]
expr_stmt|;
name|p
operator|=
name|stop
expr_stmt|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|extern
name|int
name|cpu_count_out
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|cpu_count_out
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|print_header
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|cnt
decl_stmt|,
name|printed_cnt
decl_stmt|;
name|printf
argument_list|(
literal|"*********************************\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|cnt
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_CPU
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|glob_cpu
index|[
name|i
index|]
condition|)
block|{
name|cnt
operator|++
expr_stmt|;
block|}
block|}
name|cpu_count_out
operator|=
name|cnt
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|printed_cnt
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_CPU
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|glob_cpu
index|[
name|i
index|]
condition|)
block|{
name|printf
argument_list|(
literal|"CPU%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|printed_cnt
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|printed_cnt
operator|==
name|cnt
condition|)
block|{
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
break|break;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"\t"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|lace_cpus_together
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|lace_cpu
decl_stmt|;
name|struct
name|counters
modifier|*
name|cpat
decl_stmt|,
modifier|*
name|at
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ncnts
condition|;
name|i
operator|++
control|)
block|{
name|cpat
operator|=
operator|&
name|cnts
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|cpat
operator|->
name|next_cpu
condition|)
block|{
comment|/* Already laced in */
continue|continue;
block|}
name|lace_cpu
operator|=
name|cpat
operator|->
name|cpu
expr_stmt|;
if|if
condition|(
name|lace_cpu
operator|>=
name|MAX_CPU
condition|)
block|{
name|printf
argument_list|(
literal|"CPU %d to big\n"
argument_list|,
name|lace_cpu
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|glob_cpu
index|[
name|lace_cpu
index|]
operator|==
name|NULL
condition|)
block|{
name|glob_cpu
index|[
name|lace_cpu
index|]
operator|=
name|cpat
expr_stmt|;
block|}
else|else
block|{
comment|/* Already processed this cpu */
continue|continue;
block|}
comment|/* Ok look forward for cpu->cpu and link in */
for|for
control|(
name|j
operator|=
operator|(
name|i
operator|+
literal|1
operator|)
init|;
name|j
operator|<
name|ncnts
condition|;
name|j
operator|++
control|)
block|{
name|at
operator|=
operator|&
name|cnts
index|[
name|j
index|]
expr_stmt|;
if|if
condition|(
name|at
operator|->
name|next_cpu
condition|)
block|{
continue|continue;
block|}
if|if
condition|(
name|at
operator|->
name|cpu
operator|==
name|lace_cpu
condition|)
block|{
comment|/* Found one */
name|cpat
operator|->
name|next_cpu
operator|=
name|at
expr_stmt|;
name|cpat
operator|=
name|at
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|process_file
parameter_list|(
name|char
modifier|*
name|filename
parameter_list|)
block|{
name|FILE
modifier|*
name|io
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|line_at
decl_stmt|,
name|not_done
decl_stmt|;
name|pid_t
name|pid_of_command
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|filename
operator|==
name|NULL
condition|)
block|{
name|io
operator|=
name|my_popen
argument_list|(
name|command
argument_list|,
literal|"r"
argument_list|,
operator|&
name|pid_of_command
argument_list|)
expr_stmt|;
if|if
condition|(
name|io
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"Can't popen the command %s\n"
argument_list|,
name|command
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
else|else
block|{
name|io
operator|=
name|fopen
argument_list|(
name|filename
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|io
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"Can't process file %s err:%d\n"
argument_list|,
name|filename
argument_list|,
name|errno
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|build_counters_from_header
argument_list|(
name|io
argument_list|)
expr_stmt|;
if|if
condition|(
name|cnts
operator|==
name|NULL
condition|)
block|{
comment|/* Nothing we can do */
name|printf
argument_list|(
literal|"Nothing to do -- no counters built\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|filename
condition|)
block|{
name|fclose
argument_list|(
name|io
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|my_pclose
argument_list|(
name|io
argument_list|,
name|pid_of_command
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
name|lace_cpus_together
argument_list|()
expr_stmt|;
name|print_header
argument_list|()
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ncnts
condition|;
name|i
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"Counter:%s cpu:%d index:%d\n"
argument_list|,
name|cnts
index|[
name|i
index|]
operator|.
name|counter_name
argument_list|,
name|cnts
index|[
name|i
index|]
operator|.
name|cpu
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
block|}
name|line_at
operator|=
literal|0
expr_stmt|;
name|not_done
operator|=
literal|1
expr_stmt|;
while|while
condition|(
name|not_done
condition|)
block|{
if|if
condition|(
name|read_a_line
argument_list|(
name|io
argument_list|)
condition|)
block|{
name|line_at
operator|++
expr_stmt|;
block|}
else|else
block|{
break|break;
block|}
if|if
condition|(
name|line_at
operator|>=
name|max_to_collect
condition|)
block|{
name|not_done
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|filename
operator|==
name|NULL
condition|)
block|{
name|int
name|cnt
decl_stmt|;
comment|/* For the ones we dynamically open we print now */
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|cnt
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_CPU
condition|;
name|i
operator|++
control|)
block|{
name|do_expression
argument_list|(
name|glob_cpu
index|[
name|i
index|]
argument_list|,
operator|(
name|line_at
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
name|cnt
operator|++
expr_stmt|;
if|if
condition|(
name|cnt
operator|==
name|cpu_count_out
condition|)
block|{
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
break|break;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"\t"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
if|if
condition|(
name|filename
condition|)
block|{
name|fclose
argument_list|(
name|io
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|my_pclose
argument_list|(
name|io
argument_list|,
name|pid_of_command
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__amd64__
argument_list|)
end_if

begin_define
define|#
directive|define
name|cpuid
parameter_list|(
name|in
parameter_list|,
name|a
parameter_list|,
name|b
parameter_list|,
name|c
parameter_list|,
name|d
parameter_list|)
define|\
value|asm("cpuid": "=a" (a), "=b" (b), "=c" (c), "=d" (d) : "a" (in));
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|cpuid
parameter_list|(
name|in
parameter_list|,
name|a
parameter_list|,
name|b
parameter_list|,
name|c
parameter_list|,
name|d
parameter_list|)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|void
name|get_cpuid_set
parameter_list|(
name|void
parameter_list|)
block|{
name|unsigned
name|long
name|eax
decl_stmt|,
name|ebx
decl_stmt|,
name|ecx
decl_stmt|,
name|edx
decl_stmt|;
name|int
name|model
decl_stmt|;
name|pid_t
name|pid_of_command
init|=
literal|0
decl_stmt|;
name|size_t
name|sz
decl_stmt|,
name|len
decl_stmt|;
name|FILE
modifier|*
name|io
decl_stmt|;
name|char
name|linebuf
index|[
literal|1024
index|]
decl_stmt|,
modifier|*
name|str
decl_stmt|;
name|eax
operator|=
name|ebx
operator|=
name|ecx
operator|=
name|edx
operator|=
literal|0
expr_stmt|;
name|cpuid
argument_list|(
literal|0
argument_list|,
name|eax
argument_list|,
name|ebx
argument_list|,
name|ecx
argument_list|,
name|edx
argument_list|)
expr_stmt|;
if|if
condition|(
name|ebx
operator|==
literal|0x68747541
condition|)
block|{
name|printf
argument_list|(
literal|"AMD processors are not supported by this program\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Sorry\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ebx
operator|==
literal|0x6972794
condition|)
block|{
name|printf
argument_list|(
literal|"Cyrix processors are not supported by this program\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Sorry\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ebx
operator|==
literal|0x756e6547
condition|)
block|{
name|printf
argument_list|(
literal|"Genuine Intel\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"Unknown processor type 0x%lx Only Intel AMD64 types are supported by this routine!\n"
argument_list|,
name|ebx
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|cpuid
argument_list|(
literal|1
argument_list|,
name|eax
argument_list|,
name|ebx
argument_list|,
name|ecx
argument_list|,
name|edx
argument_list|)
expr_stmt|;
name|model
operator|=
operator|(
operator|(
operator|(
name|eax
operator|&
literal|0xF0000
operator|)
operator|>>
literal|12
operator|)
operator||
operator|(
operator|(
name|eax
operator|&
literal|0xF0
operator|)
operator|>>
literal|4
operator|)
operator|)
expr_stmt|;
name|printf
argument_list|(
literal|"CPU model is 0x%x id:0x%lx\n"
argument_list|,
name|model
argument_list|,
name|eax
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|eax
operator|&
literal|0xF00
condition|)
block|{
case|case
literal|0x500
case|:
comment|/* Pentium family processors */
name|printf
argument_list|(
literal|"Intel Pentium P5\n"
argument_list|)
expr_stmt|;
goto|goto
name|not_supported
goto|;
break|break;
case|case
literal|0x600
case|:
comment|/* Pentium Pro, Celeron, Pentium II& III */
switch|switch
condition|(
name|model
condition|)
block|{
case|case
literal|0x1
case|:
name|printf
argument_list|(
literal|"Intel Pentium P6\n"
argument_list|)
expr_stmt|;
goto|goto
name|not_supported
goto|;
break|break;
case|case
literal|0x3
case|:
case|case
literal|0x5
case|:
name|printf
argument_list|(
literal|"Intel PII\n"
argument_list|)
expr_stmt|;
goto|goto
name|not_supported
goto|;
break|break;
case|case
literal|0x6
case|:
case|case
literal|0x16
case|:
name|printf
argument_list|(
literal|"Intel CL\n"
argument_list|)
expr_stmt|;
goto|goto
name|not_supported
goto|;
break|break;
case|case
literal|0x7
case|:
case|case
literal|0x8
case|:
case|case
literal|0xA
case|:
case|case
literal|0xB
case|:
name|printf
argument_list|(
literal|"Intel PIII\n"
argument_list|)
expr_stmt|;
goto|goto
name|not_supported
goto|;
break|break;
case|case
literal|0x9
case|:
case|case
literal|0xD
case|:
name|printf
argument_list|(
literal|"Intel PM\n"
argument_list|)
expr_stmt|;
goto|goto
name|not_supported
goto|;
break|break;
case|case
literal|0xE
case|:
name|printf
argument_list|(
literal|"Intel CORE\n"
argument_list|)
expr_stmt|;
goto|goto
name|not_supported
goto|;
break|break;
case|case
literal|0xF
case|:
name|printf
argument_list|(
literal|"Intel CORE2\n"
argument_list|)
expr_stmt|;
goto|goto
name|not_supported
goto|;
break|break;
case|case
literal|0x17
case|:
name|printf
argument_list|(
literal|"Intel CORE2EXTREME\n"
argument_list|)
expr_stmt|;
goto|goto
name|not_supported
goto|;
break|break;
case|case
literal|0x1C
case|:
comment|/* Per Intel document 320047-002. */
name|printf
argument_list|(
literal|"Intel ATOM\n"
argument_list|)
expr_stmt|;
goto|goto
name|not_supported
goto|;
break|break;
case|case
literal|0x1A
case|:
case|case
literal|0x1E
case|:
comment|/* 				 * Per Intel document 253669-032 9/2009, 				 * pages A-2 and A-57 				 */
case|case
literal|0x1F
case|:
comment|/* 				 * Per Intel document 253669-032 9/2009, 				 * pages A-2 and A-57 				 */
name|printf
argument_list|(
literal|"Intel COREI7\n"
argument_list|)
expr_stmt|;
goto|goto
name|not_supported
goto|;
break|break;
case|case
literal|0x2E
case|:
name|printf
argument_list|(
literal|"Intel NEHALEM\n"
argument_list|)
expr_stmt|;
goto|goto
name|not_supported
goto|;
break|break;
case|case
literal|0x25
case|:
comment|/* Per Intel document 253669-033US 12/2009. */
case|case
literal|0x2C
case|:
comment|/* Per Intel document 253669-033US 12/2009. */
name|printf
argument_list|(
literal|"Intel WESTMERE\n"
argument_list|)
expr_stmt|;
goto|goto
name|not_supported
goto|;
break|break;
case|case
literal|0x2F
case|:
comment|/* Westmere-EX, seen in wild */
name|printf
argument_list|(
literal|"Intel WESTMERE\n"
argument_list|)
expr_stmt|;
goto|goto
name|not_supported
goto|;
break|break;
case|case
literal|0x2A
case|:
comment|/* Per Intel document 253669-039US 05/2011. */
name|printf
argument_list|(
literal|"Intel SANDYBRIDGE\n"
argument_list|)
expr_stmt|;
name|set_sandybridge
argument_list|()
expr_stmt|;
break|break;
case|case
literal|0x2D
case|:
comment|/* Per Intel document 253669-044US 08/2012. */
name|printf
argument_list|(
literal|"Intel SANDYBRIDGE_XEON\n"
argument_list|)
expr_stmt|;
name|set_sandybridge
argument_list|()
expr_stmt|;
break|break;
case|case
literal|0x3A
case|:
comment|/* Per Intel document 253669-043US 05/2012. */
name|printf
argument_list|(
literal|"Intel IVYBRIDGE\n"
argument_list|)
expr_stmt|;
name|set_ivybridge
argument_list|()
expr_stmt|;
break|break;
case|case
literal|0x3E
case|:
comment|/* Per Intel document 325462-045US 01/2013. */
name|printf
argument_list|(
literal|"Intel IVYBRIDGE_XEON\n"
argument_list|)
expr_stmt|;
name|set_ivybridge
argument_list|()
expr_stmt|;
break|break;
case|case
literal|0x3F
case|:
comment|/* Per Intel document 325462-045US 09/2014. */
name|printf
argument_list|(
literal|"Intel HASWELL (Xeon)\n"
argument_list|)
expr_stmt|;
name|set_haswell
argument_list|()
expr_stmt|;
break|break;
case|case
literal|0x3C
case|:
comment|/* Per Intel document 325462-045US 01/2013. */
case|case
literal|0x45
case|:
case|case
literal|0x46
case|:
name|printf
argument_list|(
literal|"Intel HASWELL\n"
argument_list|)
expr_stmt|;
name|set_haswell
argument_list|()
expr_stmt|;
break|break;
case|case
literal|0x4D
case|:
comment|/* Per Intel document 330061-001 01/2014. */
name|printf
argument_list|(
literal|"Intel ATOM_SILVERMONT\n"
argument_list|)
expr_stmt|;
goto|goto
name|not_supported
goto|;
break|break;
default|default:
name|printf
argument_list|(
literal|"Intel model 0x%x is not known -- sorry\n"
argument_list|,
name|model
argument_list|)
expr_stmt|;
goto|goto
name|not_supported
goto|;
break|break;
block|}
break|break;
case|case
literal|0xF00
case|:
comment|/* P4 */
name|printf
argument_list|(
literal|"Intel unknown model %d\n"
argument_list|,
name|model
argument_list|)
expr_stmt|;
goto|goto
name|not_supported
goto|;
break|break;
block|}
comment|/* Ok lets load the list of all known PMC's */
name|io
operator|=
name|my_popen
argument_list|(
literal|"/usr/sbin/pmccontrol -L"
argument_list|,
literal|"r"
argument_list|,
operator|&
name|pid_of_command
argument_list|)
expr_stmt|;
if|if
condition|(
name|valid_pmcs
operator|==
name|NULL
condition|)
block|{
comment|/* Likely */
name|pmc_allocated_cnt
operator|=
name|PMC_INITIAL_ALLOC
expr_stmt|;
name|sz
operator|=
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
operator|*
name|pmc_allocated_cnt
expr_stmt|;
name|valid_pmcs
operator|=
name|malloc
argument_list|(
name|sz
argument_list|)
expr_stmt|;
if|if
condition|(
name|valid_pmcs
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"No memory allocation fails at startup?\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
name|memset
argument_list|(
name|valid_pmcs
argument_list|,
literal|0
argument_list|,
name|sz
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
name|fgets
argument_list|(
name|linebuf
argument_list|,
sizeof|sizeof
argument_list|(
name|linebuf
argument_list|)
argument_list|,
name|io
argument_list|)
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|linebuf
index|[
literal|0
index|]
operator|!=
literal|'\t'
condition|)
block|{
comment|/* sometimes headers ;-) */
continue|continue;
block|}
name|len
operator|=
name|strlen
argument_list|(
name|linebuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|linebuf
index|[
operator|(
name|len
operator|-
literal|1
operator|)
index|]
operator|==
literal|'\n'
condition|)
block|{
comment|/* Likely */
name|linebuf
index|[
operator|(
name|len
operator|-
literal|1
operator|)
index|]
operator|=
literal|0
expr_stmt|;
block|}
name|str
operator|=
operator|&
name|linebuf
index|[
literal|1
index|]
expr_stmt|;
name|len
operator|=
name|strlen
argument_list|(
name|str
argument_list|)
operator|+
literal|1
expr_stmt|;
name|valid_pmcs
index|[
name|valid_pmc_cnt
index|]
operator|=
name|malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|valid_pmcs
index|[
name|valid_pmc_cnt
index|]
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"No memory2 allocation fails at startup?\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
name|memset
argument_list|(
name|valid_pmcs
index|[
name|valid_pmc_cnt
index|]
argument_list|,
literal|0
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|valid_pmcs
index|[
name|valid_pmc_cnt
index|]
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|valid_pmc_cnt
operator|++
expr_stmt|;
if|if
condition|(
name|valid_pmc_cnt
operator|>=
name|pmc_allocated_cnt
condition|)
block|{
comment|/* Got to expand -- unlikely */
name|char
modifier|*
modifier|*
name|more
decl_stmt|;
name|sz
operator|=
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
operator|*
operator|(
name|pmc_allocated_cnt
operator|*
literal|2
operator|)
expr_stmt|;
name|more
operator|=
name|malloc
argument_list|(
name|sz
argument_list|)
expr_stmt|;
if|if
condition|(
name|more
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"No memory3 allocation fails at startup?\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
name|memset
argument_list|(
name|more
argument_list|,
literal|0
argument_list|,
name|sz
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|more
argument_list|,
name|valid_pmcs
argument_list|,
name|sz
argument_list|)
expr_stmt|;
name|pmc_allocated_cnt
operator|*=
literal|2
expr_stmt|;
name|free
argument_list|(
name|valid_pmcs
argument_list|)
expr_stmt|;
name|valid_pmcs
operator|=
name|more
expr_stmt|;
block|}
block|}
name|my_pclose
argument_list|(
name|io
argument_list|,
name|pid_of_command
argument_list|)
expr_stmt|;
return|return;
name|not_supported
label|:
name|printf
argument_list|(
literal|"Not supported\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|explain_all
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"For CPU's of type %s the following expressions are available:\n"
argument_list|,
name|the_cpu
operator|.
name|cputype
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"-------------------------------------------------------------\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|the_cpu
operator|.
name|number
condition|;
name|i
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"For -e %s "
argument_list|,
name|the_cpu
operator|.
name|ents
index|[
name|i
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
call|(
modifier|*
name|the_cpu
operator|.
name|explain
call|)
argument_list|(
name|the_cpu
operator|.
name|ents
index|[
name|i
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"----------------------------\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|test_for_a_pmc
parameter_list|(
specifier|const
name|char
modifier|*
name|pmc
parameter_list|,
name|int
name|out_so_far
parameter_list|)
block|{
name|FILE
modifier|*
name|io
decl_stmt|;
name|pid_t
name|pid_of_command
init|=
literal|0
decl_stmt|;
name|char
name|my_command
index|[
literal|1024
index|]
decl_stmt|;
name|char
name|line
index|[
literal|1024
index|]
decl_stmt|;
name|char
name|resp
index|[
literal|1024
index|]
decl_stmt|;
name|int
name|len
decl_stmt|,
name|llen
decl_stmt|,
name|i
decl_stmt|;
if|if
condition|(
name|out_so_far
operator|<
literal|50
condition|)
block|{
name|len
operator|=
literal|50
operator|-
name|out_so_far
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
block|{
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
block|}
block|}
name|sprintf
argument_list|(
name|my_command
argument_list|,
literal|"/usr/sbin/pmcstat -w .25 -c 0 -s %s"
argument_list|,
name|pmc
argument_list|)
expr_stmt|;
name|io
operator|=
name|my_popen
argument_list|(
name|my_command
argument_list|,
literal|"r"
argument_list|,
operator|&
name|pid_of_command
argument_list|)
expr_stmt|;
if|if
condition|(
name|io
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"Failed -- popen fails\n"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Setup what we expect */
name|len
operator|=
name|sprintf
argument_list|(
name|resp
argument_list|,
literal|"%s"
argument_list|,
name|pmc
argument_list|)
expr_stmt|;
if|if
condition|(
name|fgets
argument_list|(
name|line
argument_list|,
sizeof|sizeof
argument_list|(
name|line
argument_list|)
argument_list|,
name|io
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"Failed -- no output from pmstat\n"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|llen
operator|=
name|strlen
argument_list|(
name|line
argument_list|)
expr_stmt|;
if|if
condition|(
name|line
index|[
operator|(
name|llen
operator|-
literal|1
operator|)
index|]
operator|==
literal|'\n'
condition|)
block|{
name|line
index|[
operator|(
name|llen
operator|-
literal|1
operator|)
index|]
operator|=
literal|0
expr_stmt|;
name|llen
operator|--
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|2
init|;
name|i
operator|<
operator|(
name|llen
operator|-
name|len
operator|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|strncmp
argument_list|(
operator|&
name|line
index|[
name|i
index|]
argument_list|,
literal|"ERROR"
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Failed %s\n"
argument_list|,
name|line
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
operator|&
name|line
index|[
name|i
index|]
argument_list|,
name|resp
argument_list|,
name|len
argument_list|)
operator|==
literal|0
condition|)
block|{
name|int
name|j
decl_stmt|,
name|k
decl_stmt|;
if|if
condition|(
name|fgets
argument_list|(
name|line
argument_list|,
sizeof|sizeof
argument_list|(
name|line
argument_list|)
argument_list|,
name|io
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"Failed -- no second output from pmstat\n"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|len
operator|=
name|strlen
argument_list|(
name|line
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|len
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|line
index|[
name|j
index|]
operator|==
literal|' '
condition|)
block|{
name|j
operator|++
expr_stmt|;
block|}
else|else
block|{
break|break;
block|}
block|}
name|printf
argument_list|(
literal|"Pass"
argument_list|)
expr_stmt|;
name|len
operator|=
name|strlen
argument_list|(
operator|&
name|line
index|[
name|j
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|20
condition|)
block|{
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
operator|(
literal|20
operator|-
name|len
operator|)
condition|;
name|k
operator|++
control|)
block|{
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
block|}
block|}
name|printf
argument_list|(
literal|"%s"
argument_list|,
operator|&
name|line
index|[
name|j
index|]
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
name|printf
argument_list|(
literal|"Failed -- '%s' not '%s'\n"
argument_list|,
name|line
argument_list|,
name|resp
argument_list|)
expr_stmt|;
name|out
label|:
name|my_pclose
argument_list|(
name|io
argument_list|,
name|pid_of_command
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|add_it_to
parameter_list|(
name|char
modifier|*
modifier|*
name|vars
parameter_list|,
name|int
name|cur_cnt
parameter_list|,
name|char
modifier|*
name|name
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|size_t
name|len
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cur_cnt
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|vars
index|[
name|i
index|]
argument_list|,
name|name
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* Already have */
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
if|if
condition|(
name|vars
index|[
name|cur_cnt
index|]
operator|!=
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"Cur_cnt:%d filled with %s??\n"
argument_list|,
name|cur_cnt
argument_list|,
name|vars
index|[
name|cur_cnt
index|]
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* Ok its new */
name|len
operator|=
name|strlen
argument_list|(
name|name
argument_list|)
operator|+
literal|1
expr_stmt|;
name|vars
index|[
name|cur_cnt
index|]
operator|=
name|malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|vars
index|[
name|cur_cnt
index|]
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"No memory %s\n"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
name|memset
argument_list|(
name|vars
index|[
name|cur_cnt
index|]
argument_list|,
literal|0
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|vars
index|[
name|cur_cnt
index|]
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|build_command_for_exp
parameter_list|(
name|struct
name|expression
modifier|*
name|exp
parameter_list|)
block|{
comment|/* 	 * Build the pmcstat command to handle 	 * the passed in expression. 	 * /usr/sbin/pmcstat -w 1 -s NNN -s QQQ 	 * where NNN and QQQ represent the PMC's in the expression 	 * uniquely.. 	 */
name|char
name|forming
index|[
literal|1024
index|]
decl_stmt|;
name|int
name|cnt_pmc
decl_stmt|,
name|alloced_pmcs
decl_stmt|,
name|i
decl_stmt|;
name|struct
name|expression
modifier|*
name|at
decl_stmt|;
name|char
modifier|*
modifier|*
name|vars
decl_stmt|,
modifier|*
name|cmd
decl_stmt|;
name|size_t
name|mal
decl_stmt|;
name|alloced_pmcs
operator|=
name|cnt_pmc
operator|=
literal|0
expr_stmt|;
comment|/* first how many do we have */
name|at
operator|=
name|exp
expr_stmt|;
while|while
condition|(
name|at
condition|)
block|{
if|if
condition|(
name|at
operator|->
name|type
operator|==
name|TYPE_VALUE_PMC
condition|)
block|{
name|cnt_pmc
operator|++
expr_stmt|;
block|}
name|at
operator|=
name|at
operator|->
name|next
expr_stmt|;
block|}
if|if
condition|(
name|cnt_pmc
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"No PMC's in your expression -- nothing to do!!\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|mal
operator|=
name|cnt_pmc
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
expr_stmt|;
name|vars
operator|=
name|malloc
argument_list|(
name|mal
argument_list|)
expr_stmt|;
if|if
condition|(
name|vars
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"No memory\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
name|memset
argument_list|(
name|vars
argument_list|,
literal|0
argument_list|,
name|mal
argument_list|)
expr_stmt|;
name|at
operator|=
name|exp
expr_stmt|;
while|while
condition|(
name|at
condition|)
block|{
if|if
condition|(
name|at
operator|->
name|type
operator|==
name|TYPE_VALUE_PMC
condition|)
block|{
if|if
condition|(
name|add_it_to
argument_list|(
name|vars
argument_list|,
name|alloced_pmcs
argument_list|,
name|at
operator|->
name|name
argument_list|)
condition|)
block|{
name|alloced_pmcs
operator|++
expr_stmt|;
block|}
block|}
name|at
operator|=
name|at
operator|->
name|next
expr_stmt|;
block|}
comment|/* Now we have a unique list in vars so create our command */
name|mal
operator|=
literal|23
expr_stmt|;
comment|/*	"/usr/sbin/pmcstat -w 1"  + \0 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|alloced_pmcs
condition|;
name|i
operator|++
control|)
block|{
name|mal
operator|+=
name|strlen
argument_list|(
name|vars
index|[
name|i
index|]
argument_list|)
operator|+
literal|4
expr_stmt|;
comment|/* var + " -s " */
block|}
name|cmd
operator|=
name|malloc
argument_list|(
operator|(
name|mal
operator|+
literal|2
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"%s out of mem\n"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
name|memset
argument_list|(
name|cmd
argument_list|,
literal|0
argument_list|,
operator|(
name|mal
operator|+
literal|2
operator|)
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|cmd
argument_list|,
literal|"/usr/sbin/pmcstat -w 1"
argument_list|)
expr_stmt|;
name|at
operator|=
name|exp
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|alloced_pmcs
condition|;
name|i
operator|++
control|)
block|{
name|sprintf
argument_list|(
name|forming
argument_list|,
literal|" -s %s"
argument_list|,
name|vars
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|cmd
argument_list|,
name|forming
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|vars
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|vars
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
block|}
name|free
argument_list|(
name|vars
argument_list|)
expr_stmt|;
return|return
operator|(
name|cmd
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|user_expr
parameter_list|(
name|struct
name|counters
modifier|*
name|cpu
parameter_list|,
name|int
name|pos
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|double
name|res
decl_stmt|;
name|struct
name|counters
modifier|*
name|var
decl_stmt|;
name|struct
name|expression
modifier|*
name|at
decl_stmt|;
name|at
operator|=
name|master_exp
expr_stmt|;
while|while
condition|(
name|at
condition|)
block|{
if|if
condition|(
name|at
operator|->
name|type
operator|==
name|TYPE_VALUE_PMC
condition|)
block|{
name|var
operator|=
name|find_counter
argument_list|(
name|cpu
argument_list|,
name|at
operator|->
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|var
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"%s:Can't find counter %s?\n"
argument_list|,
name|__FUNCTION__
argument_list|,
name|at
operator|->
name|name
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pos
operator|!=
operator|-
literal|1
condition|)
block|{
name|at
operator|->
name|value
operator|=
name|var
operator|->
name|vals
index|[
name|pos
index|]
operator|*
literal|1.0
expr_stmt|;
block|}
else|else
block|{
name|at
operator|->
name|value
operator|=
name|var
operator|->
name|sum
operator|*
literal|1.0
expr_stmt|;
block|}
block|}
name|at
operator|=
name|at
operator|->
name|next
expr_stmt|;
block|}
name|res
operator|=
name|run_expr
argument_list|(
name|master_exp
argument_list|,
literal|1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ret
operator|=
name|printf
argument_list|(
literal|"%1.3f"
argument_list|,
name|res
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|set_manual_exp
parameter_list|(
name|struct
name|expression
modifier|*
name|exp
parameter_list|)
block|{
name|expression
operator|=
name|user_expr
expr_stmt|;
name|command
operator|=
name|build_command_for_exp
argument_list|(
name|exp
argument_list|)
expr_stmt|;
name|threshold
operator|=
literal|"User defined threshold"
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|run_tests
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|lenout
decl_stmt|;
name|printf
argument_list|(
literal|"Running tests on %d PMC's this may take some time\n"
argument_list|,
name|valid_pmc_cnt
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"------------------------------------------------------------------------\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|valid_pmc_cnt
condition|;
name|i
operator|++
control|)
block|{
name|lenout
operator|=
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|valid_pmcs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|test_for_a_pmc
argument_list|(
name|valid_pmcs
index|[
name|i
index|]
argument_list|,
name|lenout
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|list_all
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|cnt
decl_stmt|,
name|j
decl_stmt|;
name|printf
argument_list|(
literal|"PMC                                               Abbreviation\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"--------------------------------------------------------------\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|valid_pmc_cnt
condition|;
name|i
operator|++
control|)
block|{
name|cnt
operator|=
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|valid_pmcs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
name|cnt
init|;
name|j
operator|<
literal|52
condition|;
name|j
operator|++
control|)
block|{
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"%%%d\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|cnt
decl_stmt|;
name|char
modifier|*
name|filename
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|name
init|=
name|NULL
decl_stmt|;
name|int
name|help_only
init|=
literal|0
decl_stmt|;
name|int
name|test_mode
init|=
literal|0
decl_stmt|;
name|get_cpuid_set
argument_list|()
expr_stmt|;
name|memset
argument_list|(
name|glob_cpu
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|glob_cpu
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|i
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"LHhvm:i:?e:TE:"
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|i
condition|)
block|{
case|case
literal|'L'
case|:
name|list_all
argument_list|()
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
case|case
literal|'H'
case|:
name|printf
argument_list|(
literal|"**********************************\n"
argument_list|)
expr_stmt|;
name|explain_all
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"**********************************\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
break|break;
case|case
literal|'T'
case|:
name|test_mode
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'E'
case|:
name|master_exp
operator|=
name|parse_expression
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
if|if
condition|(
name|master_exp
condition|)
block|{
name|set_manual_exp
argument_list|(
name|master_exp
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|'e'
case|:
if|if
condition|(
name|validate_expression
argument_list|(
name|optarg
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Unknown expression %s\n"
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|name
operator|=
name|optarg
expr_stmt|;
name|set_expression
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'m'
case|:
name|max_to_collect
operator|=
name|strtol
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|max_to_collect
operator|>
name|MAX_COUNTER_SLOTS
condition|)
block|{
comment|/* You can't collect more than max in array */
name|max_to_collect
operator|=
name|MAX_COUNTER_SLOTS
expr_stmt|;
block|}
break|break;
case|case
literal|'v'
case|:
name|verbose
operator|++
expr_stmt|;
break|break;
case|case
literal|'h'
case|:
name|help_only
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'i'
case|:
name|filename
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'?'
case|:
default|default:
name|use
label|:
name|printf
argument_list|(
literal|"Use %s [ -i inputfile -v -m max_to_collect -e expr -E -h -? -H]\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"-i inputfile -- use source as inputfile not stdin (if stdin collect)\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"-v -- verbose dump debug type things -- you don't want this\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"-m N -- maximum to collect is N measurments\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"-e expr-name -- Do expression expr-name\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"-E 'your expression' -- Do your expression\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"-h -- Don't do the expression I put in -e xxx just explain what it does and exit\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"-H -- Don't run anything, just explain all canned expressions\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"-T -- Test all PMC's defined by this processor\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
break|break;
block|}
empty_stmt|;
block|}
if|if
condition|(
operator|(
name|name
operator|==
name|NULL
operator|)
operator|&&
operator|(
name|filename
operator|==
name|NULL
operator|)
operator|&&
operator|(
name|test_mode
operator|==
literal|0
operator|)
operator|&&
operator|(
name|master_exp
operator|==
name|NULL
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"Without setting an expression we cannot dynamically gather information\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"you must supply a filename (and you probably want verbosity)\n"
argument_list|)
expr_stmt|;
goto|goto
name|use
goto|;
block|}
if|if
condition|(
name|test_mode
condition|)
block|{
name|run_tests
argument_list|()
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|printf
argument_list|(
literal|"*********************************\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|master_exp
operator|==
name|NULL
condition|)
block|{
call|(
modifier|*
name|the_cpu
operator|.
name|explain
call|)
argument_list|(
name|name
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"Examine your expression "
argument_list|)
expr_stmt|;
name|print_exp
argument_list|(
name|master_exp
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"User defined threshold\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|help_only
condition|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|process_file
argument_list|(
name|filename
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
operator|>=
literal|2
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ncnts
condition|;
name|i
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"Counter:%s cpu:%d index:%d\n"
argument_list|,
name|cnts
index|[
name|i
index|]
operator|.
name|counter_name
argument_list|,
name|cnts
index|[
name|i
index|]
operator|.
name|cpu
argument_list|,
name|i
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|cnts
index|[
name|i
index|]
operator|.
name|pos
condition|;
name|j
operator|++
control|)
block|{
name|printf
argument_list|(
literal|" val - %ld\n"
argument_list|,
operator|(
name|long
name|int
operator|)
name|cnts
index|[
name|i
index|]
operator|.
name|vals
index|[
name|j
index|]
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|" sum - %ld\n"
argument_list|,
operator|(
name|long
name|int
operator|)
name|cnts
index|[
name|i
index|]
operator|.
name|sum
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|expression
operator|==
name|NULL
condition|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|cnt
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_CPU
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|glob_cpu
index|[
name|i
index|]
condition|)
block|{
name|do_expression
argument_list|(
name|glob_cpu
index|[
name|i
index|]
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|cnt
operator|++
expr_stmt|;
if|if
condition|(
name|cnt
operator|==
name|cpu_count_out
condition|)
block|{
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
break|break;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"\t"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


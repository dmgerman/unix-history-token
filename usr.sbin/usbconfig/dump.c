begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* $FreeBSD$ */
end_comment

begin_comment
comment|/*-  * Copyright (c) 2008 Hans Petter Selasky. All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<stdint.h>
end_include

begin_include
include|#
directive|include
file|<err.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<pwd.h>
end_include

begin_include
include|#
directive|include
file|<grp.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<libusb20.h>
end_include

begin_include
include|#
directive|include
file|<libusb20_desc.h>
end_include

begin_include
include|#
directive|include
file|"dump.h"
end_include

begin_define
define|#
directive|define
name|DUMP0
parameter_list|(
name|n
parameter_list|,
name|type
parameter_list|,
name|field
parameter_list|,
modifier|...
parameter_list|)
value|dump_field(pdev, "  ", #field, n->field);
end_define

begin_define
define|#
directive|define
name|DUMP1
parameter_list|(
name|n
parameter_list|,
name|type
parameter_list|,
name|field
parameter_list|,
modifier|...
parameter_list|)
value|dump_field(pdev, "    ", #field, n->field);
end_define

begin_define
define|#
directive|define
name|DUMP2
parameter_list|(
name|n
parameter_list|,
name|type
parameter_list|,
name|field
parameter_list|,
modifier|...
parameter_list|)
value|dump_field(pdev, "      ", #field, n->field);
end_define

begin_define
define|#
directive|define
name|DUMP3
parameter_list|(
name|n
parameter_list|,
name|type
parameter_list|,
name|field
parameter_list|,
modifier|...
parameter_list|)
value|dump_field(pdev, "        ", #field, n->field);
end_define

begin_function
specifier|const
name|char
modifier|*
name|dump_mode
parameter_list|(
name|uint8_t
name|value
parameter_list|)
block|{
if|if
condition|(
name|value
operator|==
name|LIBUSB20_MODE_HOST
condition|)
return|return
operator|(
literal|"HOST"
operator|)
return|;
return|return
operator|(
literal|"DEVICE"
operator|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|dump_speed
parameter_list|(
name|uint8_t
name|value
parameter_list|)
block|{
empty_stmt|;
comment|/* style fix */
switch|switch
condition|(
name|value
condition|)
block|{
case|case
name|LIBUSB20_SPEED_LOW
case|:
return|return
operator|(
literal|"LOW (1.5Mbps)"
operator|)
return|;
case|case
name|LIBUSB20_SPEED_FULL
case|:
return|return
operator|(
literal|"FULL (12Mbps)"
operator|)
return|;
case|case
name|LIBUSB20_SPEED_HIGH
case|:
return|return
operator|(
literal|"HIGH (480Mbps)"
operator|)
return|;
case|case
name|LIBUSB20_SPEED_VARIABLE
case|:
return|return
operator|(
literal|"VARIABLE (52-480Mbps)"
operator|)
return|;
case|case
name|LIBUSB20_SPEED_SUPER
case|:
return|return
operator|(
literal|"SUPER (4.8Gbps)"
operator|)
return|;
default|default:
break|break;
block|}
return|return
operator|(
literal|"unknown"
operator|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|dump_power_mode
parameter_list|(
name|uint8_t
name|value
parameter_list|)
block|{
empty_stmt|;
comment|/* style fix */
switch|switch
condition|(
name|value
condition|)
block|{
case|case
name|LIBUSB20_POWER_OFF
case|:
return|return
operator|(
literal|"OFF"
operator|)
return|;
case|case
name|LIBUSB20_POWER_ON
case|:
return|return
operator|(
literal|"ON"
operator|)
return|;
case|case
name|LIBUSB20_POWER_SAVE
case|:
return|return
operator|(
literal|"SAVE"
operator|)
return|;
case|case
name|LIBUSB20_POWER_SUSPEND
case|:
return|return
operator|(
literal|"SUSPEND"
operator|)
return|;
case|case
name|LIBUSB20_POWER_RESUME
case|:
return|return
operator|(
literal|"RESUME"
operator|)
return|;
default|default:
return|return
operator|(
literal|"UNKNOWN"
operator|)
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|dump_field
parameter_list|(
name|struct
name|libusb20_device
modifier|*
name|pdev
parameter_list|,
specifier|const
name|char
modifier|*
name|plevel
parameter_list|,
specifier|const
name|char
modifier|*
name|field
parameter_list|,
name|uint32_t
name|value
parameter_list|)
block|{
name|uint8_t
name|temp_string
index|[
literal|256
index|]
decl_stmt|;
name|printf
argument_list|(
literal|"%s%s = 0x%04x "
argument_list|,
name|plevel
argument_list|,
name|field
argument_list|,
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|plevel
argument_list|)
operator|==
literal|8
condition|)
block|{
comment|/* Endpoint Descriptor */
if|if
condition|(
name|strcmp
argument_list|(
name|field
argument_list|,
literal|"bEndpointAddress"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|value
operator|&
literal|0x80
condition|)
name|printf
argument_list|(
literal|"<IN>\n"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"<OUT>\n"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|field
argument_list|,
literal|"bmAttributes"
argument_list|)
operator|==
literal|0
condition|)
block|{
switch|switch
condition|(
name|value
operator|&
literal|0x03
condition|)
block|{
case|case
literal|0
case|:
name|printf
argument_list|(
literal|"<CONTROL>\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
switch|switch
condition|(
name|value
operator|&
literal|0x0C
condition|)
block|{
case|case
literal|0x00
case|:
name|printf
argument_list|(
literal|"<ISOCHRONOUS>\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x04
case|:
name|printf
argument_list|(
literal|"<ASYNC-ISOCHRONOUS>\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x08
case|:
name|printf
argument_list|(
literal|"<ADAPT-ISOCHRONOUS>\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"<SYNC-ISOCHRONOUS>\n"
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|2
case|:
name|printf
argument_list|(
literal|"<BULK>\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"<INTERRUPT>\n"
argument_list|)
expr_stmt|;
break|break;
block|}
return|return;
block|}
block|}
if|if
condition|(
operator|(
name|field
index|[
literal|0
index|]
operator|==
literal|'i'
operator|)
operator|&&
operator|(
name|field
index|[
literal|1
index|]
operator|!=
literal|'d'
operator|)
condition|)
block|{
comment|/* Indirect String Descriptor */
if|if
condition|(
name|value
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"<no string>\n"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|libusb20_dev_req_string_simple_sync
argument_list|(
name|pdev
argument_list|,
name|value
argument_list|,
name|temp_string
argument_list|,
sizeof|sizeof
argument_list|(
name|temp_string
argument_list|)
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"<retrieving string failed>\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|printf
argument_list|(
literal|"<%s>\n"
argument_list|,
name|temp_string
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* No additional information */
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_extra
parameter_list|(
name|struct
name|libusb20_me_struct
modifier|*
name|str
parameter_list|,
specifier|const
name|char
modifier|*
name|plevel
parameter_list|)
block|{
specifier|const
name|uint8_t
modifier|*
name|ptr
decl_stmt|;
name|uint8_t
name|x
decl_stmt|;
name|ptr
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
operator|(
name|ptr
operator|=
name|libusb20_desc_foreach
argument_list|(
name|str
argument_list|,
name|ptr
argument_list|)
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"\n"
literal|"%sAdditional Descriptor\n\n"
argument_list|,
name|plevel
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%sbLength = 0x%02x\n"
argument_list|,
name|plevel
argument_list|,
name|ptr
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%sbDescriptorType = 0x%02x\n"
argument_list|,
name|plevel
argument_list|,
name|ptr
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ptr
index|[
literal|0
index|]
operator|>
literal|1
condition|)
name|printf
argument_list|(
literal|"%sbDescriptorSubType = 0x%02x\n"
argument_list|,
name|plevel
argument_list|,
name|ptr
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s RAW dump: "
argument_list|,
name|plevel
argument_list|)
expr_stmt|;
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|!=
name|ptr
index|[
literal|0
index|]
condition|;
name|x
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|x
operator|%
literal|8
operator|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"\n%s 0x%02x | "
argument_list|,
name|plevel
argument_list|,
name|x
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"0x%02x%s"
argument_list|,
name|ptr
index|[
name|x
index|]
argument_list|,
operator|(
name|x
operator|!=
operator|(
name|ptr
index|[
literal|0
index|]
operator|-
literal|1
operator|)
operator|)
condition|?
literal|", "
else|:
operator|(
name|x
operator|%
literal|8
operator|)
condition|?
literal|"\n"
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_endpoint
parameter_list|(
name|struct
name|libusb20_device
modifier|*
name|pdev
parameter_list|,
name|struct
name|libusb20_endpoint
modifier|*
name|ep
parameter_list|)
block|{
name|struct
name|LIBUSB20_ENDPOINT_DESC_DECODED
modifier|*
name|edesc
decl_stmt|;
name|edesc
operator|=
operator|&
name|ep
operator|->
name|desc
expr_stmt|;
name|LIBUSB20_ENDPOINT_DESC
argument_list|(
name|DUMP3
argument_list|,
name|edesc
argument_list|)
expr_stmt|;
name|dump_extra
argument_list|(
operator|&
name|ep
operator|->
name|extra
argument_list|,
literal|"  "
literal|"  "
literal|"  "
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_iface
parameter_list|(
name|struct
name|libusb20_device
modifier|*
name|pdev
parameter_list|,
name|struct
name|libusb20_interface
modifier|*
name|iface
parameter_list|)
block|{
name|struct
name|LIBUSB20_INTERFACE_DESC_DECODED
modifier|*
name|idesc
decl_stmt|;
name|uint8_t
name|z
decl_stmt|;
name|idesc
operator|=
operator|&
name|iface
operator|->
name|desc
expr_stmt|;
name|LIBUSB20_INTERFACE_DESC
argument_list|(
name|DUMP2
argument_list|,
name|idesc
argument_list|)
expr_stmt|;
name|dump_extra
argument_list|(
operator|&
name|iface
operator|->
name|extra
argument_list|,
literal|"  "
literal|"  "
literal|"  "
argument_list|)
expr_stmt|;
for|for
control|(
name|z
operator|=
literal|0
init|;
name|z
operator|!=
name|iface
operator|->
name|num_endpoints
condition|;
name|z
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"\n     Endpoint %u\n"
argument_list|,
name|z
argument_list|)
expr_stmt|;
name|dump_endpoint
argument_list|(
name|pdev
argument_list|,
name|iface
operator|->
name|endpoints
operator|+
name|z
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
name|void
name|dump_device_info
parameter_list|(
name|struct
name|libusb20_device
modifier|*
name|pdev
parameter_list|,
name|uint8_t
name|show_ifdrv
parameter_list|)
block|{
name|char
name|buf
index|[
literal|128
index|]
decl_stmt|;
name|uint8_t
name|n
decl_stmt|;
name|printf
argument_list|(
literal|"%s, cfg=%u md=%s spd=%s pwr=%s\n"
argument_list|,
name|libusb20_dev_get_desc
argument_list|(
name|pdev
argument_list|)
argument_list|,
name|libusb20_dev_get_config_index
argument_list|(
name|pdev
argument_list|)
argument_list|,
name|dump_mode
argument_list|(
name|libusb20_dev_get_mode
argument_list|(
name|pdev
argument_list|)
argument_list|)
argument_list|,
name|dump_speed
argument_list|(
name|libusb20_dev_get_speed
argument_list|(
name|pdev
argument_list|)
argument_list|)
argument_list|,
name|dump_power_mode
argument_list|(
name|libusb20_dev_get_power_mode
argument_list|(
name|pdev
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|show_ifdrv
condition|)
return|return;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|!=
literal|255
condition|;
name|n
operator|++
control|)
block|{
if|if
condition|(
name|libusb20_dev_get_iface_desc
argument_list|(
name|pdev
argument_list|,
name|n
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
condition|)
break|break;
if|if
condition|(
name|buf
index|[
literal|0
index|]
operator|==
literal|0
condition|)
continue|continue;
name|printf
argument_list|(
literal|"ugen%u.%u.%u: %s\n"
argument_list|,
name|libusb20_dev_get_bus_number
argument_list|(
name|pdev
argument_list|)
argument_list|,
name|libusb20_dev_get_address
argument_list|(
name|pdev
argument_list|)
argument_list|,
name|n
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|dump_be_quirk_names
parameter_list|(
name|struct
name|libusb20_backend
modifier|*
name|pbe
parameter_list|)
block|{
name|struct
name|libusb20_quirk
name|q
decl_stmt|;
name|uint16_t
name|x
decl_stmt|;
name|int
name|error
decl_stmt|;
name|memset
argument_list|(
operator|&
name|q
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|q
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\nDumping list of supported quirks:\n\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|!=
literal|0xFFFF
condition|;
name|x
operator|++
control|)
block|{
name|error
operator|=
name|libusb20_be_get_quirk_name
argument_list|(
name|pbe
argument_list|,
name|x
argument_list|,
operator|&
name|q
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
if|if
condition|(
name|x
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"No quirk names - maybe the USB quirk "
literal|"module has not been loaded.\n"
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|q
operator|.
name|quirkname
argument_list|,
literal|"UQ_NONE"
argument_list|)
condition|)
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|q
operator|.
name|quirkname
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|void
name|dump_be_dev_quirks
parameter_list|(
name|struct
name|libusb20_backend
modifier|*
name|pbe
parameter_list|)
block|{
name|struct
name|libusb20_quirk
name|q
decl_stmt|;
name|uint16_t
name|x
decl_stmt|;
name|int
name|error
decl_stmt|;
name|memset
argument_list|(
operator|&
name|q
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|q
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\nDumping current device quirks:\n\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|!=
literal|0xFFFF
condition|;
name|x
operator|++
control|)
block|{
name|error
operator|=
name|libusb20_be_get_dev_quirk
argument_list|(
name|pbe
argument_list|,
name|x
argument_list|,
operator|&
name|q
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
if|if
condition|(
name|x
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"No device quirks - maybe the USB quirk "
literal|"module has not been loaded.\n"
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|q
operator|.
name|quirkname
argument_list|,
literal|"UQ_NONE"
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"VID=0x%04x PID=0x%04x REVLO=0x%04x "
literal|"REVHI=0x%04x QUIRK=%s\n"
argument_list|,
name|q
operator|.
name|vid
argument_list|,
name|q
operator|.
name|pid
argument_list|,
name|q
operator|.
name|bcdDeviceLow
argument_list|,
name|q
operator|.
name|bcdDeviceHigh
argument_list|,
name|q
operator|.
name|quirkname
argument_list|)
expr_stmt|;
block|}
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|void
name|dump_device_desc
parameter_list|(
name|struct
name|libusb20_device
modifier|*
name|pdev
parameter_list|)
block|{
name|struct
name|LIBUSB20_DEVICE_DESC_DECODED
modifier|*
name|ddesc
decl_stmt|;
name|ddesc
operator|=
name|libusb20_dev_get_device_desc
argument_list|(
name|pdev
argument_list|)
expr_stmt|;
name|LIBUSB20_DEVICE_DESC
argument_list|(
name|DUMP0
argument_list|,
name|ddesc
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|void
name|dump_config
parameter_list|(
name|struct
name|libusb20_device
modifier|*
name|pdev
parameter_list|,
name|uint8_t
name|all_cfg
parameter_list|)
block|{
name|struct
name|LIBUSB20_CONFIG_DESC_DECODED
modifier|*
name|cdesc
decl_stmt|;
name|struct
name|LIBUSB20_DEVICE_DESC_DECODED
modifier|*
name|ddesc
decl_stmt|;
name|struct
name|libusb20_config
modifier|*
name|pcfg
init|=
name|NULL
decl_stmt|;
name|uint8_t
name|cfg_index
decl_stmt|;
name|uint8_t
name|cfg_index_end
decl_stmt|;
name|uint8_t
name|x
decl_stmt|;
name|uint8_t
name|y
decl_stmt|;
name|ddesc
operator|=
name|libusb20_dev_get_device_desc
argument_list|(
name|pdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|all_cfg
condition|)
block|{
name|cfg_index
operator|=
literal|0
expr_stmt|;
name|cfg_index_end
operator|=
name|ddesc
operator|->
name|bNumConfigurations
expr_stmt|;
block|}
else|else
block|{
name|cfg_index
operator|=
name|libusb20_dev_get_config_index
argument_list|(
name|pdev
argument_list|)
expr_stmt|;
name|cfg_index_end
operator|=
name|cfg_index
operator|+
literal|1
expr_stmt|;
block|}
for|for
control|(
init|;
name|cfg_index
operator|!=
name|cfg_index_end
condition|;
name|cfg_index
operator|++
control|)
block|{
name|pcfg
operator|=
name|libusb20_dev_alloc_config
argument_list|(
name|pdev
argument_list|,
name|cfg_index
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pcfg
condition|)
block|{
continue|continue;
block|}
name|printf
argument_list|(
literal|"\n Configuration index %u\n\n"
argument_list|,
name|cfg_index
argument_list|)
expr_stmt|;
name|cdesc
operator|=
operator|&
operator|(
name|pcfg
operator|->
name|desc
operator|)
expr_stmt|;
name|LIBUSB20_CONFIG_DESC
argument_list|(
name|DUMP1
argument_list|,
name|cdesc
argument_list|)
expr_stmt|;
name|dump_extra
argument_list|(
operator|&
operator|(
name|pcfg
operator|->
name|extra
operator|)
argument_list|,
literal|"  "
literal|"  "
argument_list|)
expr_stmt|;
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|!=
name|pcfg
operator|->
name|num_interface
condition|;
name|x
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"\n    Interface %u\n"
argument_list|,
name|x
argument_list|)
expr_stmt|;
name|dump_iface
argument_list|(
name|pdev
argument_list|,
name|pcfg
operator|->
name|interface
operator|+
name|x
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|y
operator|=
literal|0
init|;
name|y
operator|!=
operator|(
name|pcfg
operator|->
name|interface
operator|+
name|x
operator|)
operator|->
name|num_altsetting
condition|;
name|y
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"\n    Interface %u Alt %u\n"
argument_list|,
name|x
argument_list|,
name|y
operator|+
literal|1
argument_list|)
expr_stmt|;
name|dump_iface
argument_list|(
name|pdev
argument_list|,
operator|(
name|pcfg
operator|->
name|interface
operator|+
name|x
operator|)
operator|->
name|altsetting
operator|+
name|y
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|pcfg
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
name|void
name|dump_string_by_index
parameter_list|(
name|struct
name|libusb20_device
modifier|*
name|pdev
parameter_list|,
name|uint8_t
name|str_index
parameter_list|)
block|{
name|char
modifier|*
name|pbuf
decl_stmt|;
name|uint8_t
name|n
decl_stmt|;
name|uint8_t
name|len
decl_stmt|;
name|pbuf
operator|=
name|malloc
argument_list|(
literal|256
argument_list|)
expr_stmt|;
if|if
condition|(
name|pbuf
operator|==
name|NULL
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"out of memory"
argument_list|)
expr_stmt|;
if|if
condition|(
name|str_index
operator|==
literal|0
condition|)
block|{
comment|/* language table */
if|if
condition|(
name|libusb20_dev_req_string_sync
argument_list|(
name|pdev
argument_list|,
name|str_index
argument_list|,
literal|0
argument_list|,
name|pbuf
argument_list|,
literal|256
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"STRING_0x%02x =<read error>\n"
argument_list|,
name|str_index
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"STRING_0x%02x = "
argument_list|,
name|str_index
argument_list|)
expr_stmt|;
name|len
operator|=
operator|(
name|uint8_t
operator|)
name|pbuf
index|[
literal|0
index|]
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|!=
name|len
condition|;
name|n
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"0x%02x%s"
argument_list|,
operator|(
name|uint8_t
operator|)
name|pbuf
index|[
name|n
index|]
argument_list|,
operator|(
name|n
operator|!=
operator|(
name|len
operator|-
literal|1
operator|)
operator|)
condition|?
literal|", "
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* ordinary string */
if|if
condition|(
name|libusb20_dev_req_string_simple_sync
argument_list|(
name|pdev
argument_list|,
name|str_index
argument_list|,
name|pbuf
argument_list|,
literal|256
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"STRING_0x%02x =<read error>\n"
argument_list|,
name|str_index
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"STRING_0x%02x =<%s>\n"
argument_list|,
name|str_index
argument_list|,
name|pbuf
argument_list|)
expr_stmt|;
block|}
block|}
name|free
argument_list|(
name|pbuf
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


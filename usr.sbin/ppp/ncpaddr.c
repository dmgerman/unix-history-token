begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2001 Brian Somers<brian@Awfulhak.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|__OpenBSD__
end_ifdef

begin_include
include|#
directive|include
file|<net/if_types.h>
end_include

begin_include
include|#
directive|include
file|<net/route.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_systm.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip.h>
end_include

begin_include
include|#
directive|include
file|<arpa/inet.h>
end_include

begin_include
include|#
directive|include
file|<sys/un.h>
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<termios.h>
end_include

begin_include
include|#
directive|include
file|"log.h"
end_include

begin_include
include|#
directive|include
file|"ncpaddr.h"
end_include

begin_include
include|#
directive|include
file|"timer.h"
end_include

begin_include
include|#
directive|include
file|"fsm.h"
end_include

begin_include
include|#
directive|include
file|"defs.h"
end_include

begin_include
include|#
directive|include
file|"slcompress.h"
end_include

begin_include
include|#
directive|include
file|"iplist.h"
end_include

begin_include
include|#
directive|include
file|"throughput.h"
end_include

begin_include
include|#
directive|include
file|"mbuf.h"
end_include

begin_include
include|#
directive|include
file|"ipcp.h"
end_include

begin_include
include|#
directive|include
file|"descriptor.h"
end_include

begin_include
include|#
directive|include
file|"layer.h"
end_include

begin_include
include|#
directive|include
file|"lqr.h"
end_include

begin_include
include|#
directive|include
file|"hdlc.h"
end_include

begin_include
include|#
directive|include
file|"lcp.h"
end_include

begin_include
include|#
directive|include
file|"ccp.h"
end_include

begin_include
include|#
directive|include
file|"link.h"
end_include

begin_include
include|#
directive|include
file|"mp.h"
end_include

begin_include
include|#
directive|include
file|"ipv6cp.h"
end_include

begin_include
include|#
directive|include
file|"ncp.h"
end_include

begin_define
define|#
directive|define
name|ncprange_ip4addr
value|u.ip4.ipaddr
end_define

begin_define
define|#
directive|define
name|ncprange_ip4mask
value|u.ip4.mask
end_define

begin_define
define|#
directive|define
name|ncprange_ip4width
value|u.ip4.width
end_define

begin_define
define|#
directive|define
name|ncpaddr_ip4addr
value|u.ip4addr
end_define

begin_ifndef
ifndef|#
directive|ifndef
name|NOINET6
end_ifndef

begin_define
define|#
directive|define
name|ncprange_ip6addr
value|u.ip6.ipaddr
end_define

begin_define
define|#
directive|define
name|ncprange_ip6width
value|u.ip6.width
end_define

begin_define
define|#
directive|define
name|ncpaddr_ip6addr
value|u.ip6addr
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|NCP_ASCIIBUFFERSIZE
value|52
end_define

begin_function
specifier|static
name|struct
name|in_addr
name|bits2mask4
parameter_list|(
name|int
name|bits
parameter_list|)
block|{
name|struct
name|in_addr
name|result
decl_stmt|;
name|u_int32_t
name|bit
init|=
literal|0x80000000
decl_stmt|;
name|result
operator|.
name|s_addr
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|bits
condition|)
block|{
name|result
operator|.
name|s_addr
operator||=
name|bit
expr_stmt|;
name|bit
operator|>>=
literal|1
expr_stmt|;
name|bits
operator|--
expr_stmt|;
block|}
name|result
operator|.
name|s_addr
operator|=
name|htonl
argument_list|(
name|result
operator|.
name|s_addr
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mask42bits
parameter_list|(
name|struct
name|in_addr
name|mask
parameter_list|)
block|{
name|u_int32_t
name|msk
init|=
name|ntohl
argument_list|(
name|mask
operator|.
name|s_addr
argument_list|)
decl_stmt|;
name|u_int32_t
name|tst
decl_stmt|;
name|int
name|ret
decl_stmt|;
for|for
control|(
name|ret
operator|=
literal|32
operator|,
name|tst
operator|=
literal|1
init|;
name|tst
condition|;
name|ret
operator|--
operator|,
name|tst
operator|<<=
literal|1
control|)
if|if
condition|(
name|msk
operator|&
name|tst
condition|)
break|break;
for|for
control|(
name|tst
operator|<<=
literal|1
init|;
name|tst
condition|;
name|tst
operator|<<=
literal|1
control|)
if|if
condition|(
operator|!
operator|(
name|msk
operator|&
name|tst
operator|)
condition|)
break|break;
return|return
name|tst
condition|?
operator|-
literal|1
else|:
name|ret
return|;
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|NOINET6
end_ifndef

begin_function
specifier|static
name|struct
name|in6_addr
name|bits2mask6
parameter_list|(
name|int
name|bits
parameter_list|)
block|{
name|struct
name|in6_addr
name|result
decl_stmt|;
name|u_int32_t
name|bit
init|=
literal|0x80
decl_stmt|;
name|u_char
modifier|*
name|c
init|=
name|result
operator|.
name|s6_addr
decl_stmt|;
name|memset
argument_list|(
operator|&
name|result
argument_list|,
literal|'\0'
argument_list|,
sizeof|sizeof
name|result
argument_list|)
expr_stmt|;
while|while
condition|(
name|bits
condition|)
block|{
if|if
condition|(
name|bit
operator|==
literal|0
condition|)
block|{
name|bit
operator|=
literal|0x80
expr_stmt|;
name|c
operator|++
expr_stmt|;
block|}
operator|*
name|c
operator||=
name|bit
expr_stmt|;
name|bit
operator|>>=
literal|1
expr_stmt|;
name|bits
operator|--
expr_stmt|;
block|}
return|return
name|result
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mask62bits
parameter_list|(
specifier|const
name|struct
name|in6_addr
modifier|*
name|mask
parameter_list|)
block|{
specifier|const
name|u_char
name|masks
index|[]
init|=
block|{
literal|0x00
block|,
literal|0x80
block|,
literal|0xc0
block|,
literal|0xe0
block|,
literal|0xf0
block|,
literal|0xf8
block|,
literal|0xfc
block|,
literal|0xfe
block|}
decl_stmt|;
specifier|const
name|u_char
modifier|*
name|c
decl_stmt|,
modifier|*
name|p
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|int
name|masklen
decl_stmt|;
name|p
operator|=
operator|(
specifier|const
name|u_char
operator|*
operator|)
name|mask
expr_stmt|;
for|for
control|(
name|masklen
operator|=
literal|0
operator|,
name|end
operator|=
name|p
operator|+
literal|16
init|;
name|p
operator|<
name|end
operator|&&
operator|*
name|p
operator|==
literal|0xff
condition|;
name|p
operator|++
control|)
name|masklen
operator|+=
literal|8
expr_stmt|;
if|if
condition|(
name|p
operator|<
name|end
condition|)
block|{
for|for
control|(
name|c
operator|=
name|masks
init|;
name|c
operator|<
name|masks
operator|+
sizeof|sizeof
name|masks
condition|;
name|c
operator|++
control|)
if|if
condition|(
operator|*
name|c
operator|==
operator|*
name|p
condition|)
block|{
name|masklen
operator|+=
name|c
operator|-
name|masks
expr_stmt|;
break|break;
block|}
block|}
return|return
name|masklen
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|adjust_linklocal
parameter_list|(
name|struct
name|sockaddr_in6
modifier|*
name|sin6
parameter_list|)
block|{
comment|/* XXX: ?????!?!?!!!!!  This is horrible ! */
if|#
directive|if
literal|0
comment|/*      * The kernel does not understand sin6_scope_id for routing at this moment.      * We should rather keep the embedded ID.      * jinmei@kame.net, 20011026      */
block|if (IN6_IS_ADDR_LINKLOCAL(&sin6->sin6_addr) ||         IN6_IS_ADDR_MC_LINKLOCAL(&sin6->sin6_addr)) {       sin6->sin6_scope_id =         ntohs(*(u_short *)&sin6->sin6_addr.s6_addr[2]);       *(u_short *)&sin6->sin6_addr.s6_addr[2] = 0;     }
endif|#
directive|endif
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|void
name|ncpaddr_init
parameter_list|(
name|struct
name|ncpaddr
modifier|*
name|addr
parameter_list|)
block|{
name|addr
operator|->
name|ncpaddr_family
operator|=
name|AF_UNSPEC
expr_stmt|;
block|}
end_function

begin_function
name|int
name|ncpaddr_isset
parameter_list|(
specifier|const
name|struct
name|ncpaddr
modifier|*
name|addr
parameter_list|)
block|{
return|return
name|addr
operator|->
name|ncpaddr_family
operator|!=
name|AF_UNSPEC
return|;
block|}
end_function

begin_function
name|int
name|ncpaddr_isdefault
parameter_list|(
specifier|const
name|struct
name|ncpaddr
modifier|*
name|addr
parameter_list|)
block|{
switch|switch
condition|(
name|addr
operator|->
name|ncpaddr_family
condition|)
block|{
case|case
name|AF_INET
case|:
if|if
condition|(
name|addr
operator|->
name|ncpaddr_ip4addr
operator|.
name|s_addr
operator|==
name|INADDR_ANY
condition|)
return|return
literal|1
return|;
break|break;
ifndef|#
directive|ifndef
name|NOINET6
case|case
name|AF_INET6
case|:
if|if
condition|(
name|IN6_IS_ADDR_UNSPECIFIED
argument_list|(
operator|&
name|addr
operator|->
name|ncpaddr_ip6addr
argument_list|)
condition|)
return|return
literal|1
return|;
break|break;
endif|#
directive|endif
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|ncpaddr_equal
parameter_list|(
specifier|const
name|struct
name|ncpaddr
modifier|*
name|addr
parameter_list|,
specifier|const
name|struct
name|ncpaddr
modifier|*
name|cmp
parameter_list|)
block|{
if|if
condition|(
name|addr
operator|->
name|ncpaddr_family
operator|!=
name|cmp
operator|->
name|ncpaddr_family
condition|)
return|return
literal|0
return|;
switch|switch
condition|(
name|addr
operator|->
name|ncpaddr_family
condition|)
block|{
case|case
name|AF_INET
case|:
return|return
name|addr
operator|->
name|ncpaddr_ip4addr
operator|.
name|s_addr
operator|==
name|cmp
operator|->
name|ncpaddr_ip4addr
operator|.
name|s_addr
return|;
ifndef|#
directive|ifndef
name|NOINET6
case|case
name|AF_INET6
case|:
return|return
operator|!
name|memcmp
argument_list|(
operator|&
name|addr
operator|->
name|ncpaddr_ip6addr
argument_list|,
operator|&
name|cmp
operator|->
name|ncpaddr_ip6addr
argument_list|,
sizeof|sizeof
name|addr
operator|->
name|ncpaddr_ip6addr
argument_list|)
return|;
endif|#
directive|endif
case|case
name|AF_UNSPEC
case|:
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|ncpaddr_copy
parameter_list|(
name|struct
name|ncpaddr
modifier|*
name|addr
parameter_list|,
specifier|const
name|struct
name|ncpaddr
modifier|*
name|from
parameter_list|)
block|{
switch|switch
condition|(
name|from
operator|->
name|ncpaddr_family
condition|)
block|{
case|case
name|AF_INET
case|:
name|addr
operator|->
name|ncpaddr_family
operator|=
name|AF_INET
expr_stmt|;
name|addr
operator|->
name|ncpaddr_ip4addr
operator|=
name|from
operator|->
name|ncpaddr_ip4addr
expr_stmt|;
break|break;
ifndef|#
directive|ifndef
name|NOINET6
case|case
name|AF_INET6
case|:
name|addr
operator|->
name|ncpaddr_family
operator|=
name|AF_INET6
expr_stmt|;
name|addr
operator|->
name|ncpaddr_ip6addr
operator|=
name|from
operator|->
name|ncpaddr_ip6addr
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
name|addr
operator|->
name|ncpaddr_family
operator|=
name|AF_UNSPEC
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|ncpaddr_setip4addr
parameter_list|(
name|struct
name|ncpaddr
modifier|*
name|addr
parameter_list|,
name|u_int32_t
name|ip
parameter_list|)
block|{
name|addr
operator|->
name|ncpaddr_family
operator|=
name|AF_INET
expr_stmt|;
name|addr
operator|->
name|ncpaddr_ip4addr
operator|.
name|s_addr
operator|=
name|ip
expr_stmt|;
block|}
end_function

begin_function
name|int
name|ncpaddr_getip4addr
parameter_list|(
specifier|const
name|struct
name|ncpaddr
modifier|*
name|addr
parameter_list|,
name|u_int32_t
modifier|*
name|ip
parameter_list|)
block|{
if|if
condition|(
name|addr
operator|->
name|ncpaddr_family
operator|!=
name|AF_INET
condition|)
return|return
literal|0
return|;
operator|*
name|ip
operator|=
name|addr
operator|->
name|ncpaddr_ip4addr
operator|.
name|s_addr
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
name|void
name|ncpaddr_setip4
parameter_list|(
name|struct
name|ncpaddr
modifier|*
name|addr
parameter_list|,
name|struct
name|in_addr
name|ip
parameter_list|)
block|{
name|addr
operator|->
name|ncpaddr_family
operator|=
name|AF_INET
expr_stmt|;
name|addr
operator|->
name|ncpaddr_ip4addr
operator|=
name|ip
expr_stmt|;
block|}
end_function

begin_function
name|int
name|ncpaddr_getip4
parameter_list|(
specifier|const
name|struct
name|ncpaddr
modifier|*
name|addr
parameter_list|,
name|struct
name|in_addr
modifier|*
name|ip
parameter_list|)
block|{
if|if
condition|(
name|addr
operator|->
name|ncpaddr_family
operator|!=
name|AF_INET
condition|)
return|return
literal|0
return|;
operator|*
name|ip
operator|=
name|addr
operator|->
name|ncpaddr_ip4addr
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|NOINET6
end_ifndef

begin_function
name|void
name|ncpaddr_setip6
parameter_list|(
name|struct
name|ncpaddr
modifier|*
name|addr
parameter_list|,
specifier|const
name|struct
name|in6_addr
modifier|*
name|ip6
parameter_list|)
block|{
name|addr
operator|->
name|ncpaddr_family
operator|=
name|AF_INET6
expr_stmt|;
name|addr
operator|->
name|ncpaddr_ip6addr
operator|=
operator|*
name|ip6
expr_stmt|;
block|}
end_function

begin_function
name|int
name|ncpaddr_getip6
parameter_list|(
specifier|const
name|struct
name|ncpaddr
modifier|*
name|addr
parameter_list|,
name|struct
name|in6_addr
modifier|*
name|ip6
parameter_list|)
block|{
if|if
condition|(
name|addr
operator|->
name|ncpaddr_family
operator|!=
name|AF_INET6
condition|)
return|return
literal|0
return|;
operator|*
name|ip6
operator|=
name|addr
operator|->
name|ncpaddr_ip6addr
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|void
name|ncpaddr_getsa
parameter_list|(
specifier|const
name|struct
name|ncpaddr
modifier|*
name|addr
parameter_list|,
name|struct
name|sockaddr_storage
modifier|*
name|host
parameter_list|)
block|{
name|struct
name|sockaddr_in
modifier|*
name|host4
init|=
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
name|host
decl_stmt|;
ifndef|#
directive|ifndef
name|NOINET6
name|struct
name|sockaddr_in6
modifier|*
name|host6
init|=
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
name|host
decl_stmt|;
endif|#
directive|endif
name|memset
argument_list|(
name|host
argument_list|,
literal|'\0'
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|host
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|addr
operator|->
name|ncpaddr_family
condition|)
block|{
case|case
name|AF_INET
case|:
name|host4
operator|->
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|host4
operator|->
name|sin_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|host4
argument_list|)
expr_stmt|;
name|host4
operator|->
name|sin_addr
operator|=
name|addr
operator|->
name|ncpaddr_ip4addr
expr_stmt|;
break|break;
ifndef|#
directive|ifndef
name|NOINET6
case|case
name|AF_INET6
case|:
name|host6
operator|->
name|sin6_family
operator|=
name|AF_INET6
expr_stmt|;
name|host6
operator|->
name|sin6_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|host6
argument_list|)
expr_stmt|;
name|host6
operator|->
name|sin6_addr
operator|=
name|addr
operator|->
name|ncpaddr_ip6addr
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
name|host
operator|->
name|ss_family
operator|=
name|AF_UNSPEC
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
name|void
name|ncpaddr_setsa
parameter_list|(
name|struct
name|ncpaddr
modifier|*
name|addr
parameter_list|,
specifier|const
name|struct
name|sockaddr
modifier|*
name|host
parameter_list|)
block|{
specifier|const
name|struct
name|sockaddr_in
modifier|*
name|host4
init|=
operator|(
specifier|const
expr|struct
name|sockaddr_in
operator|*
operator|)
name|host
decl_stmt|;
ifndef|#
directive|ifndef
name|NOINET6
specifier|const
name|struct
name|sockaddr_in6
modifier|*
name|host6
init|=
operator|(
specifier|const
expr|struct
name|sockaddr_in6
operator|*
operator|)
name|host
decl_stmt|;
endif|#
directive|endif
switch|switch
condition|(
name|host
operator|->
name|sa_family
condition|)
block|{
case|case
name|AF_INET
case|:
name|addr
operator|->
name|ncpaddr_family
operator|=
name|AF_INET
expr_stmt|;
name|addr
operator|->
name|ncpaddr_ip4addr
operator|=
name|host4
operator|->
name|sin_addr
expr_stmt|;
break|break;
ifndef|#
directive|ifndef
name|NOINET6
case|case
name|AF_INET6
case|:
if|if
condition|(
name|IN6_IS_ADDR_V4MAPPED
argument_list|(
operator|&
name|host6
operator|->
name|sin6_addr
argument_list|)
condition|)
block|{
name|addr
operator|->
name|ncpaddr_family
operator|=
name|AF_INET
expr_stmt|;
name|addr
operator|->
name|ncpaddr_ip4addr
operator|.
name|s_addr
operator|=
operator|*
operator|(
specifier|const
name|u_int32_t
operator|*
operator|)
operator|(
name|host6
operator|->
name|sin6_addr
operator|.
name|s6_addr
operator|+
literal|12
operator|)
expr_stmt|;
block|}
else|else
block|{
name|addr
operator|->
name|ncpaddr_family
operator|=
name|AF_INET6
expr_stmt|;
name|addr
operator|->
name|ncpaddr_ip6addr
operator|=
name|host6
operator|->
name|sin6_addr
expr_stmt|;
block|}
break|break;
endif|#
directive|endif
default|default:
name|addr
operator|->
name|ncpaddr_family
operator|=
name|AF_UNSPEC
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|ncpaddr_ntowa
parameter_list|(
specifier|const
name|struct
name|ncpaddr
modifier|*
name|addr
parameter_list|)
block|{
specifier|static
name|char
name|res
index|[
name|NCP_ASCIIBUFFERSIZE
index|]
decl_stmt|;
ifndef|#
directive|ifndef
name|NOINET6
name|struct
name|sockaddr_in6
name|sin6
decl_stmt|;
endif|#
directive|endif
switch|switch
condition|(
name|addr
operator|->
name|ncpaddr_family
condition|)
block|{
case|case
name|AF_INET
case|:
name|snprintf
argument_list|(
name|res
argument_list|,
sizeof|sizeof
name|res
argument_list|,
literal|"%s"
argument_list|,
name|inet_ntoa
argument_list|(
name|addr
operator|->
name|ncpaddr_ip4addr
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|res
return|;
ifndef|#
directive|ifndef
name|NOINET6
case|case
name|AF_INET6
case|:
name|memset
argument_list|(
operator|&
name|sin6
argument_list|,
literal|'\0'
argument_list|,
sizeof|sizeof
argument_list|(
name|sin6
argument_list|)
argument_list|)
expr_stmt|;
name|sin6
operator|.
name|sin6_len
operator|=
sizeof|sizeof
argument_list|(
name|sin6
argument_list|)
expr_stmt|;
name|sin6
operator|.
name|sin6_family
operator|=
name|AF_INET6
expr_stmt|;
name|sin6
operator|.
name|sin6_addr
operator|=
name|addr
operator|->
name|ncpaddr_ip6addr
expr_stmt|;
name|adjust_linklocal
argument_list|(
operator|&
name|sin6
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|NI_WITHSCOPEID
if|if
condition|(
name|getnameinfo
argument_list|(
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|sin6
argument_list|,
sizeof|sizeof
name|sin6
argument_list|,
name|res
argument_list|,
sizeof|sizeof
argument_list|(
name|res
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NI_WITHSCOPEID
operator||
name|NI_NUMERICHOST
argument_list|)
operator|!=
literal|0
condition|)
else|#
directive|else
if|if
condition|(
name|getnameinfo
argument_list|(
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|sin6
argument_list|,
sizeof|sizeof
name|sin6
argument_list|,
name|res
argument_list|,
sizeof|sizeof
argument_list|(
name|res
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NI_NUMERICHOST
argument_list|)
operator|!=
literal|0
condition|)
endif|#
directive|endif
break|break;
return|return
name|res
return|;
endif|#
directive|endif
block|}
name|snprintf
argument_list|(
name|res
argument_list|,
sizeof|sizeof
name|res
argument_list|,
literal|"<AF_UNSPEC>"
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|ncpaddr_ntoa
parameter_list|(
specifier|const
name|struct
name|ncpaddr
modifier|*
name|addr
parameter_list|)
block|{
return|return
name|ncpaddr_ntowa
argument_list|(
name|addr
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|ncpaddr_aton
parameter_list|(
name|struct
name|ncpaddr
modifier|*
name|addr
parameter_list|,
name|struct
name|ncp
modifier|*
name|ncp
parameter_list|,
specifier|const
name|char
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|ncprange
name|range
decl_stmt|;
if|if
condition|(
operator|!
name|ncprange_aton
argument_list|(
operator|&
name|range
argument_list|,
name|ncp
argument_list|,
name|data
argument_list|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|range
operator|.
name|ncprange_family
operator|==
name|AF_INET
operator|&&
name|range
operator|.
name|ncprange_ip4width
operator|!=
literal|32
operator|&&
name|range
operator|.
name|ncprange_ip4addr
operator|.
name|s_addr
operator|!=
name|INADDR_ANY
condition|)
block|{
name|log_Printf
argument_list|(
name|LogWARN
argument_list|,
literal|"ncpaddr_aton: %s: Only 32 bits allowed\n"
argument_list|,
name|data
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
ifndef|#
directive|ifndef
name|NOINET6
if|if
condition|(
name|range
operator|.
name|ncprange_family
operator|==
name|AF_INET6
operator|&&
name|range
operator|.
name|ncprange_ip6width
operator|!=
literal|128
operator|&&
operator|!
name|IN6_IS_ADDR_UNSPECIFIED
argument_list|(
operator|&
name|range
operator|.
name|ncprange_ip6addr
argument_list|)
condition|)
block|{
name|log_Printf
argument_list|(
name|LogWARN
argument_list|,
literal|"ncpaddr_aton: %s: Only 128 bits allowed\n"
argument_list|,
name|data
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
endif|#
directive|endif
switch|switch
condition|(
name|range
operator|.
name|ncprange_family
condition|)
block|{
case|case
name|AF_INET
case|:
name|addr
operator|->
name|ncpaddr_family
operator|=
name|range
operator|.
name|ncprange_family
expr_stmt|;
name|addr
operator|->
name|ncpaddr_ip4addr
operator|=
name|range
operator|.
name|ncprange_ip4addr
expr_stmt|;
return|return
literal|1
return|;
ifndef|#
directive|ifndef
name|NOINET6
case|case
name|AF_INET6
case|:
name|addr
operator|->
name|ncpaddr_family
operator|=
name|range
operator|.
name|ncprange_family
expr_stmt|;
name|addr
operator|->
name|ncpaddr_ip6addr
operator|=
name|range
operator|.
name|ncprange_ip6addr
expr_stmt|;
return|return
literal|1
return|;
endif|#
directive|endif
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|ncprange_init
parameter_list|(
name|struct
name|ncprange
modifier|*
name|range
parameter_list|)
block|{
name|range
operator|->
name|ncprange_family
operator|=
name|AF_UNSPEC
expr_stmt|;
block|}
end_function

begin_function
name|int
name|ncprange_isset
parameter_list|(
specifier|const
name|struct
name|ncprange
modifier|*
name|range
parameter_list|)
block|{
return|return
name|range
operator|->
name|ncprange_family
operator|!=
name|AF_UNSPEC
return|;
block|}
end_function

begin_function
name|int
name|ncprange_equal
parameter_list|(
specifier|const
name|struct
name|ncprange
modifier|*
name|range
parameter_list|,
specifier|const
name|struct
name|ncprange
modifier|*
name|cmp
parameter_list|)
block|{
if|if
condition|(
name|range
operator|->
name|ncprange_family
operator|!=
name|cmp
operator|->
name|ncprange_family
condition|)
return|return
literal|0
return|;
switch|switch
condition|(
name|range
operator|->
name|ncprange_family
condition|)
block|{
case|case
name|AF_INET
case|:
if|if
condition|(
name|range
operator|->
name|ncprange_ip4addr
operator|.
name|s_addr
operator|!=
name|cmp
operator|->
name|ncprange_ip4addr
operator|.
name|s_addr
condition|)
return|return
literal|0
return|;
return|return
name|range
operator|->
name|ncprange_ip4mask
operator|.
name|s_addr
operator|==
name|cmp
operator|->
name|ncprange_ip4mask
operator|.
name|s_addr
return|;
ifndef|#
directive|ifndef
name|NOINET6
case|case
name|AF_INET6
case|:
if|if
condition|(
name|range
operator|->
name|ncprange_ip6width
operator|!=
name|cmp
operator|->
name|ncprange_ip6width
condition|)
return|return
literal|0
return|;
return|return
operator|!
name|memcmp
argument_list|(
operator|&
name|range
operator|->
name|ncprange_ip6addr
argument_list|,
operator|&
name|cmp
operator|->
name|ncprange_ip6addr
argument_list|,
sizeof|sizeof
name|range
operator|->
name|ncprange_ip6addr
argument_list|)
return|;
endif|#
directive|endif
case|case
name|AF_UNSPEC
case|:
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|ncprange_isdefault
parameter_list|(
specifier|const
name|struct
name|ncprange
modifier|*
name|range
parameter_list|)
block|{
switch|switch
condition|(
name|range
operator|->
name|ncprange_family
condition|)
block|{
case|case
name|AF_INET
case|:
if|if
condition|(
name|range
operator|->
name|ncprange_ip4addr
operator|.
name|s_addr
operator|==
name|INADDR_ANY
condition|)
return|return
literal|1
return|;
break|break;
ifndef|#
directive|ifndef
name|NOINET6
case|case
name|AF_INET6
case|:
if|if
condition|(
name|range
operator|->
name|ncprange_ip6width
operator|==
literal|0
operator|&&
name|IN6_IS_ADDR_UNSPECIFIED
argument_list|(
operator|&
name|range
operator|->
name|ncprange_ip6addr
argument_list|)
condition|)
return|return
literal|1
return|;
break|break;
endif|#
directive|endif
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|ncprange_setdefault
parameter_list|(
name|struct
name|ncprange
modifier|*
name|range
parameter_list|,
name|int
name|af
parameter_list|)
block|{
name|memset
argument_list|(
name|range
argument_list|,
literal|'\0'
argument_list|,
sizeof|sizeof
expr|*
name|range
argument_list|)
expr_stmt|;
name|range
operator|->
name|ncprange_family
operator|=
name|af
expr_stmt|;
block|}
end_function

begin_function
name|int
name|ncprange_contains
parameter_list|(
specifier|const
name|struct
name|ncprange
modifier|*
name|range
parameter_list|,
specifier|const
name|struct
name|ncpaddr
modifier|*
name|addr
parameter_list|)
block|{
ifndef|#
directive|ifndef
name|NOINET6
specifier|const
name|u_char
name|masks
index|[]
init|=
block|{
literal|0x80
block|,
literal|0xc0
block|,
literal|0xe0
block|,
literal|0xf0
block|,
literal|0xf8
block|,
literal|0xfc
block|,
literal|0xfe
block|,
literal|0xff
block|}
decl_stmt|;
specifier|const
name|u_char
modifier|*
name|addrp
decl_stmt|,
modifier|*
name|rangep
decl_stmt|;
name|int
name|bits
decl_stmt|;
endif|#
directive|endif
if|if
condition|(
name|range
operator|->
name|ncprange_family
operator|!=
name|addr
operator|->
name|ncpaddr_family
condition|)
return|return
literal|0
return|;
switch|switch
condition|(
name|range
operator|->
name|ncprange_family
condition|)
block|{
case|case
name|AF_INET
case|:
return|return
operator|!
operator|(
operator|(
name|addr
operator|->
name|ncpaddr_ip4addr
operator|.
name|s_addr
operator|^
name|range
operator|->
name|ncprange_ip4addr
operator|.
name|s_addr
operator|)
operator|&
name|range
operator|->
name|ncprange_ip4mask
operator|.
name|s_addr
operator|)
return|;
ifndef|#
directive|ifndef
name|NOINET6
case|case
name|AF_INET6
case|:
name|rangep
operator|=
operator|(
specifier|const
name|u_char
operator|*
operator|)
name|range
operator|->
name|ncprange_ip6addr
operator|.
name|s6_addr
expr_stmt|;
name|addrp
operator|=
operator|(
specifier|const
name|u_char
operator|*
operator|)
name|addr
operator|->
name|ncpaddr_ip6addr
operator|.
name|s6_addr
expr_stmt|;
for|for
control|(
name|bits
operator|=
name|range
operator|->
name|ncprange_ip6width
init|;
name|bits
operator|>
literal|0
condition|;
name|bits
operator|-=
literal|8
control|)
if|if
condition|(
operator|(
operator|*
name|addrp
operator|++
operator|^
operator|*
name|rangep
operator|++
operator|)
operator|&
name|masks
index|[
name|bits
operator|>
literal|7
condition|?
literal|7
else|:
name|bits
operator|-
literal|1
index|]
condition|)
return|return
literal|0
return|;
return|return
literal|1
return|;
endif|#
directive|endif
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|ncprange_containsip4
parameter_list|(
specifier|const
name|struct
name|ncprange
modifier|*
name|range
parameter_list|,
name|struct
name|in_addr
name|addr
parameter_list|)
block|{
switch|switch
condition|(
name|range
operator|->
name|ncprange_family
condition|)
block|{
case|case
name|AF_INET
case|:
return|return
operator|!
operator|(
operator|(
name|addr
operator|.
name|s_addr
operator|^
name|range
operator|->
name|ncprange_ip4addr
operator|.
name|s_addr
operator|)
operator|&
name|range
operator|->
name|ncprange_ip4mask
operator|.
name|s_addr
operator|)
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|ncprange_copy
parameter_list|(
name|struct
name|ncprange
modifier|*
name|range
parameter_list|,
specifier|const
name|struct
name|ncprange
modifier|*
name|from
parameter_list|)
block|{
switch|switch
condition|(
name|from
operator|->
name|ncprange_family
condition|)
block|{
case|case
name|AF_INET
case|:
name|range
operator|->
name|ncprange_family
operator|=
name|AF_INET
expr_stmt|;
name|range
operator|->
name|ncprange_ip4addr
operator|=
name|from
operator|->
name|ncprange_ip4addr
expr_stmt|;
name|range
operator|->
name|ncprange_ip4mask
operator|=
name|from
operator|->
name|ncprange_ip4mask
expr_stmt|;
name|range
operator|->
name|ncprange_ip4width
operator|=
name|from
operator|->
name|ncprange_ip4width
expr_stmt|;
break|break;
ifndef|#
directive|ifndef
name|NOINET6
case|case
name|AF_INET6
case|:
name|range
operator|->
name|ncprange_family
operator|=
name|AF_INET6
expr_stmt|;
name|range
operator|->
name|ncprange_ip6addr
operator|=
name|from
operator|->
name|ncprange_ip6addr
expr_stmt|;
name|range
operator|->
name|ncprange_ip6width
operator|=
name|from
operator|->
name|ncprange_ip6width
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
name|range
operator|->
name|ncprange_family
operator|=
name|AF_UNSPEC
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|ncprange_set
parameter_list|(
name|struct
name|ncprange
modifier|*
name|range
parameter_list|,
specifier|const
name|struct
name|ncpaddr
modifier|*
name|addr
parameter_list|,
name|int
name|width
parameter_list|)
block|{
name|ncprange_sethost
argument_list|(
name|range
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|ncprange_setwidth
argument_list|(
name|range
argument_list|,
name|width
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ncprange_sethost
parameter_list|(
name|struct
name|ncprange
modifier|*
name|range
parameter_list|,
specifier|const
name|struct
name|ncpaddr
modifier|*
name|from
parameter_list|)
block|{
switch|switch
condition|(
name|from
operator|->
name|ncpaddr_family
condition|)
block|{
case|case
name|AF_INET
case|:
name|range
operator|->
name|ncprange_family
operator|=
name|AF_INET
expr_stmt|;
name|range
operator|->
name|ncprange_ip4addr
operator|=
name|from
operator|->
name|ncpaddr_ip4addr
expr_stmt|;
if|if
condition|(
name|from
operator|->
name|ncpaddr_ip4addr
operator|.
name|s_addr
operator|==
name|INADDR_ANY
condition|)
block|{
name|range
operator|->
name|ncprange_ip4mask
operator|.
name|s_addr
operator|=
name|INADDR_ANY
expr_stmt|;
name|range
operator|->
name|ncprange_ip4width
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|range
operator|->
name|ncprange_ip4mask
operator|.
name|s_addr
operator|=
name|INADDR_BROADCAST
expr_stmt|;
name|range
operator|->
name|ncprange_ip4width
operator|=
literal|32
expr_stmt|;
block|}
break|break;
ifndef|#
directive|ifndef
name|NOINET6
case|case
name|AF_INET6
case|:
name|range
operator|->
name|ncprange_family
operator|=
name|AF_INET6
expr_stmt|;
name|range
operator|->
name|ncprange_ip6addr
operator|=
name|from
operator|->
name|ncpaddr_ip6addr
expr_stmt|;
name|range
operator|->
name|ncprange_ip6width
operator|=
literal|128
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
name|range
operator|->
name|ncprange_family
operator|=
name|AF_UNSPEC
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|ncprange_ishost
parameter_list|(
specifier|const
name|struct
name|ncprange
modifier|*
name|range
parameter_list|)
block|{
switch|switch
condition|(
name|range
operator|->
name|ncprange_family
condition|)
block|{
case|case
name|AF_INET
case|:
return|return
name|range
operator|->
name|ncprange_ip4width
operator|==
literal|32
return|;
ifndef|#
directive|ifndef
name|NOINET6
case|case
name|AF_INET6
case|:
return|return
name|range
operator|->
name|ncprange_ip6width
operator|==
literal|128
return|;
endif|#
directive|endif
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ncprange_setwidth
parameter_list|(
name|struct
name|ncprange
modifier|*
name|range
parameter_list|,
name|int
name|width
parameter_list|)
block|{
switch|switch
condition|(
name|range
operator|->
name|ncprange_family
condition|)
block|{
case|case
name|AF_INET
case|:
if|if
condition|(
name|width
operator|<
literal|0
operator|||
name|width
operator|>
literal|32
condition|)
break|break;
name|range
operator|->
name|ncprange_ip4width
operator|=
name|width
expr_stmt|;
name|range
operator|->
name|ncprange_ip4mask
operator|=
name|bits2mask4
argument_list|(
name|width
argument_list|)
expr_stmt|;
break|break;
ifndef|#
directive|ifndef
name|NOINET6
case|case
name|AF_INET6
case|:
if|if
condition|(
name|width
operator|<
literal|0
operator|||
name|width
operator|>
literal|128
condition|)
break|break;
name|range
operator|->
name|ncprange_ip6width
operator|=
name|width
expr_stmt|;
break|break;
endif|#
directive|endif
case|case
name|AF_UNSPEC
case|:
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|ncprange_setip4host
parameter_list|(
name|struct
name|ncprange
modifier|*
name|range
parameter_list|,
name|struct
name|in_addr
name|from
parameter_list|)
block|{
name|range
operator|->
name|ncprange_family
operator|=
name|AF_INET
expr_stmt|;
name|range
operator|->
name|ncprange_ip4addr
operator|=
name|from
expr_stmt|;
if|if
condition|(
name|from
operator|.
name|s_addr
operator|==
name|INADDR_ANY
condition|)
block|{
name|range
operator|->
name|ncprange_ip4mask
operator|.
name|s_addr
operator|=
name|INADDR_ANY
expr_stmt|;
name|range
operator|->
name|ncprange_ip4width
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|range
operator|->
name|ncprange_ip4mask
operator|.
name|s_addr
operator|=
name|INADDR_BROADCAST
expr_stmt|;
name|range
operator|->
name|ncprange_ip4width
operator|=
literal|32
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|ncprange_setip4
parameter_list|(
name|struct
name|ncprange
modifier|*
name|range
parameter_list|,
name|struct
name|in_addr
name|from
parameter_list|,
name|struct
name|in_addr
name|msk
parameter_list|)
block|{
name|range
operator|->
name|ncprange_family
operator|=
name|AF_INET
expr_stmt|;
name|range
operator|->
name|ncprange_ip4addr
operator|=
name|from
expr_stmt|;
name|range
operator|->
name|ncprange_ip4mask
operator|=
name|msk
expr_stmt|;
name|range
operator|->
name|ncprange_ip4width
operator|=
name|mask42bits
argument_list|(
name|msk
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|ncprange_setip4mask
parameter_list|(
name|struct
name|ncprange
modifier|*
name|range
parameter_list|,
name|struct
name|in_addr
name|mask
parameter_list|)
block|{
if|if
condition|(
name|range
operator|->
name|ncprange_family
operator|!=
name|AF_INET
condition|)
return|return
literal|0
return|;
name|range
operator|->
name|ncprange_ip4mask
operator|=
name|mask
expr_stmt|;
name|range
operator|->
name|ncprange_ip4width
operator|=
name|mask42bits
argument_list|(
name|mask
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
name|void
name|ncprange_setsa
parameter_list|(
name|struct
name|ncprange
modifier|*
name|range
parameter_list|,
specifier|const
name|struct
name|sockaddr
modifier|*
name|host
parameter_list|,
specifier|const
name|struct
name|sockaddr
modifier|*
name|mask
parameter_list|)
block|{
specifier|const
name|struct
name|sockaddr_in
modifier|*
name|host4
init|=
operator|(
specifier|const
expr|struct
name|sockaddr_in
operator|*
operator|)
name|host
decl_stmt|;
specifier|const
name|struct
name|sockaddr_in
modifier|*
name|mask4
init|=
operator|(
specifier|const
expr|struct
name|sockaddr_in
operator|*
operator|)
name|mask
decl_stmt|;
ifndef|#
directive|ifndef
name|NOINET6
specifier|const
name|struct
name|sockaddr_in6
modifier|*
name|host6
init|=
operator|(
specifier|const
expr|struct
name|sockaddr_in6
operator|*
operator|)
name|host
decl_stmt|;
specifier|const
name|struct
name|sockaddr_in6
modifier|*
name|mask6
init|=
operator|(
specifier|const
expr|struct
name|sockaddr_in6
operator|*
operator|)
name|mask
decl_stmt|;
endif|#
directive|endif
switch|switch
condition|(
name|host
operator|->
name|sa_family
condition|)
block|{
case|case
name|AF_INET
case|:
name|range
operator|->
name|ncprange_family
operator|=
name|AF_INET
expr_stmt|;
name|range
operator|->
name|ncprange_ip4addr
operator|=
name|host4
operator|->
name|sin_addr
expr_stmt|;
if|if
condition|(
name|host4
operator|->
name|sin_addr
operator|.
name|s_addr
operator|==
name|INADDR_ANY
condition|)
block|{
name|range
operator|->
name|ncprange_ip4mask
operator|.
name|s_addr
operator|=
name|INADDR_ANY
expr_stmt|;
name|range
operator|->
name|ncprange_ip4width
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|mask4
operator|&&
name|mask4
operator|->
name|sin_family
operator|==
name|AF_INET
condition|)
block|{
name|range
operator|->
name|ncprange_ip4mask
operator|.
name|s_addr
operator|=
name|mask4
operator|->
name|sin_addr
operator|.
name|s_addr
expr_stmt|;
name|range
operator|->
name|ncprange_ip4width
operator|=
name|mask42bits
argument_list|(
name|mask4
operator|->
name|sin_addr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|range
operator|->
name|ncprange_ip4mask
operator|.
name|s_addr
operator|=
name|INADDR_BROADCAST
expr_stmt|;
name|range
operator|->
name|ncprange_ip4width
operator|=
literal|32
expr_stmt|;
block|}
break|break;
ifndef|#
directive|ifndef
name|NOINET6
case|case
name|AF_INET6
case|:
name|range
operator|->
name|ncprange_family
operator|=
name|AF_INET6
expr_stmt|;
name|range
operator|->
name|ncprange_ip6addr
operator|=
name|host6
operator|->
name|sin6_addr
expr_stmt|;
if|if
condition|(
name|IN6_IS_ADDR_UNSPECIFIED
argument_list|(
operator|&
name|host6
operator|->
name|sin6_addr
argument_list|)
condition|)
name|range
operator|->
name|ncprange_ip6width
operator|=
literal|0
expr_stmt|;
else|else
name|range
operator|->
name|ncprange_ip6width
operator|=
name|mask6
condition|?
name|mask62bits
argument_list|(
operator|&
name|mask6
operator|->
name|sin6_addr
argument_list|)
else|:
literal|128
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
name|range
operator|->
name|ncprange_family
operator|=
name|AF_UNSPEC
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|ncprange_getsa
parameter_list|(
specifier|const
name|struct
name|ncprange
modifier|*
name|range
parameter_list|,
name|struct
name|sockaddr_storage
modifier|*
name|host
parameter_list|,
name|struct
name|sockaddr_storage
modifier|*
name|mask
parameter_list|)
block|{
name|struct
name|sockaddr_in
modifier|*
name|host4
init|=
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
name|host
decl_stmt|;
name|struct
name|sockaddr_in
modifier|*
name|mask4
init|=
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
name|mask
decl_stmt|;
ifndef|#
directive|ifndef
name|NOINET6
name|struct
name|sockaddr_in6
modifier|*
name|host6
init|=
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
name|host
decl_stmt|;
name|struct
name|sockaddr_in6
modifier|*
name|mask6
init|=
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
name|mask
decl_stmt|;
endif|#
directive|endif
name|memset
argument_list|(
name|host
argument_list|,
literal|'\0'
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|host
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|mask
condition|)
name|memset
argument_list|(
name|mask
argument_list|,
literal|'\0'
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|mask
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|range
operator|->
name|ncprange_family
condition|)
block|{
case|case
name|AF_INET
case|:
name|host4
operator|->
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|host4
operator|->
name|sin_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|host4
argument_list|)
expr_stmt|;
name|host4
operator|->
name|sin_addr
operator|=
name|range
operator|->
name|ncprange_ip4addr
expr_stmt|;
if|if
condition|(
name|mask4
condition|)
block|{
name|mask4
operator|->
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|mask4
operator|->
name|sin_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|host4
argument_list|)
expr_stmt|;
name|mask4
operator|->
name|sin_addr
operator|=
name|range
operator|->
name|ncprange_ip4mask
expr_stmt|;
block|}
break|break;
ifndef|#
directive|ifndef
name|NOINET6
case|case
name|AF_INET6
case|:
name|host6
operator|->
name|sin6_family
operator|=
name|AF_INET6
expr_stmt|;
name|host6
operator|->
name|sin6_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|host6
argument_list|)
expr_stmt|;
name|host6
operator|->
name|sin6_addr
operator|=
name|range
operator|->
name|ncprange_ip6addr
expr_stmt|;
if|if
condition|(
name|mask6
condition|)
block|{
name|mask6
operator|->
name|sin6_family
operator|=
name|AF_INET6
expr_stmt|;
name|mask6
operator|->
name|sin6_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|host6
argument_list|)
expr_stmt|;
name|mask6
operator|->
name|sin6_addr
operator|=
name|bits2mask6
argument_list|(
name|range
operator|->
name|ncprange_ip6width
argument_list|)
expr_stmt|;
block|}
break|break;
endif|#
directive|endif
default|default:
name|host
operator|->
name|ss_family
operator|=
name|AF_UNSPEC
expr_stmt|;
if|if
condition|(
name|mask
condition|)
name|mask
operator|->
name|ss_family
operator|=
name|AF_UNSPEC
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
name|int
name|ncprange_getaddr
parameter_list|(
specifier|const
name|struct
name|ncprange
modifier|*
name|range
parameter_list|,
name|struct
name|ncpaddr
modifier|*
name|addr
parameter_list|)
block|{
switch|switch
condition|(
name|range
operator|->
name|ncprange_family
condition|)
block|{
case|case
name|AF_INET
case|:
name|addr
operator|->
name|ncpaddr_family
operator|=
name|AF_INET
expr_stmt|;
name|addr
operator|->
name|ncpaddr_ip4addr
operator|=
name|range
operator|->
name|ncprange_ip4addr
expr_stmt|;
return|return
literal|1
return|;
ifndef|#
directive|ifndef
name|NOINET6
case|case
name|AF_INET6
case|:
name|addr
operator|->
name|ncpaddr_family
operator|=
name|AF_INET6
expr_stmt|;
name|addr
operator|->
name|ncpaddr_ip6addr
operator|=
name|range
operator|->
name|ncprange_ip6addr
expr_stmt|;
return|return
literal|1
return|;
endif|#
directive|endif
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|ncprange_getip4addr
parameter_list|(
specifier|const
name|struct
name|ncprange
modifier|*
name|range
parameter_list|,
name|struct
name|in_addr
modifier|*
name|addr
parameter_list|)
block|{
if|if
condition|(
name|range
operator|->
name|ncprange_family
operator|!=
name|AF_INET
condition|)
return|return
literal|0
return|;
operator|*
name|addr
operator|=
name|range
operator|->
name|ncprange_ip4addr
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
name|int
name|ncprange_getip4mask
parameter_list|(
specifier|const
name|struct
name|ncprange
modifier|*
name|range
parameter_list|,
name|struct
name|in_addr
modifier|*
name|mask
parameter_list|)
block|{
switch|switch
condition|(
name|range
operator|->
name|ncprange_family
condition|)
block|{
case|case
name|AF_INET
case|:
operator|*
name|mask
operator|=
name|range
operator|->
name|ncprange_ip4mask
expr_stmt|;
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|ncprange_getwidth
parameter_list|(
specifier|const
name|struct
name|ncprange
modifier|*
name|range
parameter_list|,
name|int
modifier|*
name|width
parameter_list|)
block|{
switch|switch
condition|(
name|range
operator|->
name|ncprange_family
condition|)
block|{
case|case
name|AF_INET
case|:
operator|*
name|width
operator|=
name|range
operator|->
name|ncprange_ip4width
expr_stmt|;
return|return
literal|1
return|;
ifndef|#
directive|ifndef
name|NOINET6
case|case
name|AF_INET6
case|:
operator|*
name|width
operator|=
name|range
operator|->
name|ncprange_ip6width
expr_stmt|;
return|return
literal|1
return|;
endif|#
directive|endif
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|ncprange_ntoa
parameter_list|(
specifier|const
name|struct
name|ncprange
modifier|*
name|range
parameter_list|)
block|{
name|char
modifier|*
name|res
decl_stmt|;
name|struct
name|ncpaddr
name|addr
decl_stmt|;
name|int
name|len
decl_stmt|;
if|if
condition|(
operator|!
name|ncprange_getaddr
argument_list|(
name|range
argument_list|,
operator|&
name|addr
argument_list|)
condition|)
return|return
literal|"<AF_UNSPEC>"
return|;
name|res
operator|=
name|ncpaddr_ntowa
argument_list|(
operator|&
name|addr
argument_list|)
expr_stmt|;
name|len
operator|=
name|strlen
argument_list|(
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>=
name|NCP_ASCIIBUFFERSIZE
operator|-
literal|1
condition|)
return|return
name|res
return|;
switch|switch
condition|(
name|range
operator|->
name|ncprange_family
condition|)
block|{
case|case
name|AF_INET
case|:
if|if
condition|(
name|range
operator|->
name|ncprange_ip4width
operator|==
operator|-
literal|1
condition|)
block|{
comment|/* A non-contiguous mask */
for|for
control|(
init|;
name|len
operator|>=
literal|3
condition|;
name|res
index|[
name|len
operator|-=
literal|2
index|]
operator|=
literal|'\0'
control|)
if|if
condition|(
name|strcmp
argument_list|(
name|res
operator|+
name|len
operator|-
literal|2
argument_list|,
literal|".0"
argument_list|)
condition|)
break|break;
name|snprintf
argument_list|(
name|res
operator|+
name|len
argument_list|,
sizeof|sizeof
name|res
operator|-
name|len
argument_list|,
literal|"&0x%08lx"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|ntohl
argument_list|(
name|range
operator|->
name|ncprange_ip4mask
operator|.
name|s_addr
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|range
operator|->
name|ncprange_ip4width
operator|<
literal|32
condition|)
name|snprintf
argument_list|(
name|res
operator|+
name|len
argument_list|,
sizeof|sizeof
name|res
operator|-
name|len
argument_list|,
literal|"/%d"
argument_list|,
name|range
operator|->
name|ncprange_ip4width
argument_list|)
expr_stmt|;
return|return
name|res
return|;
ifndef|#
directive|ifndef
name|NOINET6
case|case
name|AF_INET6
case|:
if|if
condition|(
name|range
operator|->
name|ncprange_ip6width
operator|!=
literal|128
condition|)
name|snprintf
argument_list|(
name|res
operator|+
name|len
argument_list|,
sizeof|sizeof
name|res
operator|-
name|len
argument_list|,
literal|"/%d"
argument_list|,
name|range
operator|->
name|ncprange_ip6width
argument_list|)
expr_stmt|;
return|return
name|res
return|;
endif|#
directive|endif
block|}
return|return
literal|"<AF_UNSPEC>"
return|;
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|NOINET6
end_ifndef

begin_function
name|int
name|ncprange_scopeid
parameter_list|(
specifier|const
name|struct
name|ncprange
modifier|*
name|range
parameter_list|)
block|{
specifier|const
name|struct
name|in6_addr
modifier|*
name|sin6
decl_stmt|;
name|int
name|scopeid
init|=
operator|-
literal|1
decl_stmt|;
if|if
condition|(
name|range
operator|->
name|ncprange_family
operator|==
name|AF_INET6
condition|)
block|{
name|sin6
operator|=
operator|&
name|range
operator|->
name|ncprange_ip6addr
expr_stmt|;
if|if
condition|(
name|IN6_IS_ADDR_LINKLOCAL
argument_list|(
name|sin6
argument_list|)
operator|||
name|IN6_IS_ADDR_MC_LINKLOCAL
argument_list|(
name|sin6
argument_list|)
condition|)
if|if
condition|(
operator|(
name|scopeid
operator|=
name|ntohs
argument_list|(
operator|*
operator|(
specifier|const
name|u_short
operator|*
operator|)
operator|&
name|sin6
operator|->
name|s6_addr
index|[
literal|2
index|]
argument_list|)
operator|)
operator|==
literal|0
condition|)
name|scopeid
operator|=
operator|-
literal|1
expr_stmt|;
block|}
return|return
name|scopeid
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|int
name|ncprange_aton
parameter_list|(
name|struct
name|ncprange
modifier|*
name|range
parameter_list|,
name|struct
name|ncp
modifier|*
name|ncp
parameter_list|,
specifier|const
name|char
modifier|*
name|data
parameter_list|)
block|{
name|int
name|bits
decl_stmt|,
name|len
decl_stmt|;
name|char
modifier|*
name|wp
decl_stmt|;
specifier|const
name|char
modifier|*
name|cp
decl_stmt|;
name|char
modifier|*
name|s
decl_stmt|;
name|len
operator|=
name|strcspn
argument_list|(
name|data
argument_list|,
literal|"/"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ncp
operator|&&
name|strncasecmp
argument_list|(
name|data
argument_list|,
literal|"HISADDR"
argument_list|,
name|len
argument_list|)
operator|==
literal|0
condition|)
block|{
name|range
operator|->
name|ncprange_family
operator|=
name|AF_INET
expr_stmt|;
name|range
operator|->
name|ncprange_ip4addr
operator|=
name|ncp
operator|->
name|ipcp
operator|.
name|peer_ip
expr_stmt|;
name|range
operator|->
name|ncprange_ip4mask
operator|.
name|s_addr
operator|=
name|INADDR_BROADCAST
expr_stmt|;
name|range
operator|->
name|ncprange_ip4width
operator|=
literal|32
expr_stmt|;
return|return
literal|1
return|;
ifndef|#
directive|ifndef
name|NOINET6
block|}
elseif|else
if|if
condition|(
name|ncp
operator|&&
name|strncasecmp
argument_list|(
name|data
argument_list|,
literal|"HISADDR6"
argument_list|,
name|len
argument_list|)
operator|==
literal|0
condition|)
block|{
name|range
operator|->
name|ncprange_family
operator|=
name|AF_INET6
expr_stmt|;
name|range
operator|->
name|ncprange_ip6addr
operator|=
name|ncp
operator|->
name|ipv6cp
operator|.
name|hisaddr
operator|.
name|ncpaddr_ip6addr
expr_stmt|;
name|range
operator|->
name|ncprange_ip6width
operator|=
literal|128
expr_stmt|;
return|return
literal|1
return|;
endif|#
directive|endif
block|}
elseif|else
if|if
condition|(
name|ncp
operator|&&
name|strncasecmp
argument_list|(
name|data
argument_list|,
literal|"MYADDR"
argument_list|,
name|len
argument_list|)
operator|==
literal|0
condition|)
block|{
name|range
operator|->
name|ncprange_family
operator|=
name|AF_INET
expr_stmt|;
name|range
operator|->
name|ncprange_ip4addr
operator|=
name|ncp
operator|->
name|ipcp
operator|.
name|my_ip
expr_stmt|;
name|range
operator|->
name|ncprange_ip4mask
operator|.
name|s_addr
operator|=
name|INADDR_BROADCAST
expr_stmt|;
name|range
operator|->
name|ncprange_ip4width
operator|=
literal|32
expr_stmt|;
return|return
literal|1
return|;
ifndef|#
directive|ifndef
name|NOINET6
block|}
elseif|else
if|if
condition|(
name|ncp
operator|&&
name|strncasecmp
argument_list|(
name|data
argument_list|,
literal|"MYADDR6"
argument_list|,
name|len
argument_list|)
operator|==
literal|0
condition|)
block|{
name|range
operator|->
name|ncprange_family
operator|=
name|AF_INET6
expr_stmt|;
name|range
operator|->
name|ncprange_ip6addr
operator|=
name|ncp
operator|->
name|ipv6cp
operator|.
name|myaddr
operator|.
name|ncpaddr_ip6addr
expr_stmt|;
name|range
operator|->
name|ncprange_ip6width
operator|=
literal|128
expr_stmt|;
return|return
literal|1
return|;
endif|#
directive|endif
block|}
elseif|else
if|if
condition|(
name|ncp
operator|&&
name|strncasecmp
argument_list|(
name|data
argument_list|,
literal|"DNS0"
argument_list|,
name|len
argument_list|)
operator|==
literal|0
condition|)
block|{
name|range
operator|->
name|ncprange_family
operator|=
name|AF_INET
expr_stmt|;
name|range
operator|->
name|ncprange_ip4addr
operator|=
name|ncp
operator|->
name|ipcp
operator|.
name|ns
operator|.
name|dns
index|[
literal|0
index|]
expr_stmt|;
name|range
operator|->
name|ncprange_ip4mask
operator|.
name|s_addr
operator|=
name|INADDR_BROADCAST
expr_stmt|;
name|range
operator|->
name|ncprange_ip4width
operator|=
literal|32
expr_stmt|;
return|return
literal|1
return|;
block|}
elseif|else
if|if
condition|(
name|ncp
operator|&&
name|strncasecmp
argument_list|(
name|data
argument_list|,
literal|"DNS1"
argument_list|,
name|len
argument_list|)
operator|==
literal|0
condition|)
block|{
name|range
operator|->
name|ncprange_family
operator|=
name|AF_INET
expr_stmt|;
name|range
operator|->
name|ncprange_ip4addr
operator|=
name|ncp
operator|->
name|ipcp
operator|.
name|ns
operator|.
name|dns
index|[
literal|1
index|]
expr_stmt|;
name|range
operator|->
name|ncprange_ip4mask
operator|.
name|s_addr
operator|=
name|INADDR_BROADCAST
expr_stmt|;
name|range
operator|->
name|ncprange_ip4width
operator|=
literal|32
expr_stmt|;
return|return
literal|1
return|;
block|}
name|s
operator|=
operator|(
name|char
operator|*
operator|)
name|alloca
argument_list|(
name|len
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|s
argument_list|,
name|data
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|s
index|[
name|len
index|]
operator|=
literal|'\0'
expr_stmt|;
name|bits
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|data
index|[
name|len
index|]
operator|!=
literal|'\0'
condition|)
block|{
name|bits
operator|=
name|strtol
argument_list|(
name|data
operator|+
name|len
operator|+
literal|1
argument_list|,
operator|&
name|wp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|wp
operator|||
name|wp
operator|==
name|data
operator|+
name|len
operator|+
literal|1
operator|||
name|bits
operator|<
literal|0
operator|||
name|bits
operator|>
literal|128
condition|)
block|{
name|log_Printf
argument_list|(
name|LogWARN
argument_list|,
literal|"ncprange_aton: bad mask width.\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
if|if
condition|(
operator|(
name|cp
operator|=
name|strchr
argument_list|(
name|data
argument_list|,
literal|':'
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|range
operator|->
name|ncprange_family
operator|=
name|AF_INET
expr_stmt|;
name|range
operator|->
name|ncprange_ip4addr
operator|=
name|GetIpAddr
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|range
operator|->
name|ncprange_ip4addr
operator|.
name|s_addr
operator|==
name|INADDR_NONE
condition|)
block|{
name|log_Printf
argument_list|(
name|LogWARN
argument_list|,
literal|"ncprange_aton: %s: Bad address\n"
argument_list|,
name|s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|range
operator|->
name|ncprange_ip4addr
operator|.
name|s_addr
operator|==
name|INADDR_ANY
condition|)
block|{
name|range
operator|->
name|ncprange_ip4mask
operator|.
name|s_addr
operator|=
name|INADDR_ANY
expr_stmt|;
name|range
operator|->
name|ncprange_ip4width
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|bits
operator|==
operator|-
literal|1
condition|)
block|{
name|range
operator|->
name|ncprange_ip4mask
operator|.
name|s_addr
operator|=
name|INADDR_BROADCAST
expr_stmt|;
name|range
operator|->
name|ncprange_ip4width
operator|=
literal|32
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|bits
operator|>
literal|32
condition|)
block|{
name|log_Printf
argument_list|(
name|LogWARN
argument_list|,
literal|"ncprange_aton: bad mask width.\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
else|else
block|{
name|range
operator|->
name|ncprange_ip4mask
operator|=
name|bits2mask4
argument_list|(
name|bits
argument_list|)
expr_stmt|;
name|range
operator|->
name|ncprange_ip4width
operator|=
name|bits
expr_stmt|;
block|}
return|return
literal|1
return|;
ifndef|#
directive|ifndef
name|NOINET6
block|}
elseif|else
if|if
condition|(
name|strchr
argument_list|(
name|cp
operator|+
literal|1
argument_list|,
literal|':'
argument_list|)
operator|!=
name|NULL
condition|)
block|{
name|range
operator|->
name|ncprange_family
operator|=
name|AF_INET6
expr_stmt|;
if|if
condition|(
name|inet_pton
argument_list|(
name|AF_INET6
argument_list|,
name|s
argument_list|,
operator|&
name|range
operator|->
name|ncprange_ip6addr
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|log_Printf
argument_list|(
name|LogWARN
argument_list|,
literal|"ncprange_aton: %s: Bad address\n"
argument_list|,
name|s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|IN6_IS_ADDR_UNSPECIFIED
argument_list|(
operator|&
name|range
operator|->
name|ncprange_ip6addr
argument_list|)
condition|)
name|range
operator|->
name|ncprange_ip6width
operator|=
literal|0
expr_stmt|;
else|else
name|range
operator|->
name|ncprange_ip6width
operator|=
operator|(
name|bits
operator|==
operator|-
literal|1
operator|)
condition|?
literal|128
else|:
name|bits
expr_stmt|;
return|return
literal|1
return|;
endif|#
directive|endif
block|}
return|return
literal|0
return|;
block|}
end_function

end_unit


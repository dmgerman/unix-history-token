begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*     Alias.c provides supervisory control for the functions of the     packet aliasing software.  It consists of routines to monitor     TCP connection state, protocol-specific aliasing routines,     limited fragment handling and the two primary outside world     functional interfaces: PacketAliasIn and PacketAliasOut.      The other C program files are briefly described. The data     structure framework which holds information needed to translate     packets is encapsulated in alias_db.c.  Data is accessed by     function calls, so other segments of the program need not     know about the underlying data structures.  Alias_ftp.c contains     special code for modifying the ftp PORT command used to establish     data connections.  Alias_util.c contains a few utility routines.      This software is placed into the public domain with no restrictions     on its distribution.      Version 1.0 August, 1996  (cjm)      Version 1.1 August 20, 1996  (cjm)         PPP host accepts incoming connections for ports 0 to 1023.      Version 1.2 September 7, 1996 (cjm)         Fragment handling error in alias_db.c corrected.      Version 1.4 September 16, 1996 (cjm)         - A more generalized method for handling incoming           connections, without the 0-1023 restriction, is           implemented in alias_db.c         - Improved ICMP support in alias.c.  Traceroute           packet streams can now be correctly aliased.         - TCP connection closing logic simplified in           alias.c and now allows for additional 1 minute           "grace period" after FIN or RST is observed.     Version 1.5 September 17, 1996 (cjm)         Corrected error in handling incoming UDP packets with 0 checksum.     Version 1.6 September 18, 1996 (cjm)         Simplified ICMP aliasing scheme.  Should now support         traceroute from Win95 as well as FreeBSD.           */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_systm.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip_icmp.h>
end_include

begin_include
include|#
directive|include
file|<netinet/tcp.h>
end_include

begin_include
include|#
directive|include
file|<netinet/udp.h>
end_include

begin_include
include|#
directive|include
file|<arpa/inet.h>
end_include

begin_include
include|#
directive|include
file|"alias.p"
end_include

begin_define
define|#
directive|define
name|FTP_CONTROL_PORT_NUMBER
value|21
end_define

begin_comment
comment|/* TCP Handling Routines      TcpMonitorIn()  -- These routines monitor TCP connections, and     TcpMonitorOut() -- delete a link node when a connection is closed.  These routines look for SYN, ACK and RST flags to determine when TCP connections open and close.  When a TCP connection closes, the data structure containing packet aliasing information is deleted after a timeout period. */
end_comment

begin_function
name|void
name|TcpMonitorIn
parameter_list|(
name|pip
parameter_list|,
name|link
parameter_list|)
name|struct
name|ip
modifier|*
name|pip
decl_stmt|;
name|char
modifier|*
name|link
decl_stmt|;
block|{
name|struct
name|tcphdr
modifier|*
name|tc
decl_stmt|;
name|tc
operator|=
operator|(
expr|struct
name|tcphdr
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|pip
operator|+
operator|(
name|pip
operator|->
name|ip_hl
operator|<<
literal|2
operator|)
operator|)
expr_stmt|;
switch|switch
condition|(
name|GetStateIn
argument_list|(
name|link
argument_list|)
condition|)
block|{
case|case
literal|0
case|:
if|if
condition|(
name|tc
operator|->
name|th_flags
operator|&
name|TH_SYN
condition|)
name|SetStateIn
argument_list|(
name|link
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
if|if
condition|(
name|tc
operator|->
name|th_flags
operator|&
name|TH_FIN
operator|||
name|tc
operator|->
name|th_flags
operator|&
name|TH_RST
condition|)
name|SetStateIn
argument_list|(
name|link
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|TcpMonitorOut
parameter_list|(
name|pip
parameter_list|,
name|link
parameter_list|)
name|struct
name|ip
modifier|*
name|pip
decl_stmt|;
name|char
modifier|*
name|link
decl_stmt|;
block|{
name|struct
name|tcphdr
modifier|*
name|tc
decl_stmt|;
name|tc
operator|=
operator|(
expr|struct
name|tcphdr
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|pip
operator|+
operator|(
name|pip
operator|->
name|ip_hl
operator|<<
literal|2
operator|)
operator|)
expr_stmt|;
switch|switch
condition|(
name|GetStateOut
argument_list|(
name|link
argument_list|)
condition|)
block|{
case|case
literal|0
case|:
if|if
condition|(
name|tc
operator|->
name|th_flags
operator|&
name|TH_SYN
condition|)
name|SetStateOut
argument_list|(
name|link
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
if|if
condition|(
name|tc
operator|->
name|th_flags
operator|&
name|TH_FIN
operator|||
name|tc
operator|->
name|th_flags
operator|&
name|TH_RST
condition|)
name|SetStateOut
argument_list|(
name|link
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* Protocol Specific Packet Aliasing Routines       IcmpAliasIn(), IcmpAliasIn1(), IcmpAliasIn2     IcmpAliasOut(), IcmpAliasOut1()     UdpAliasIn(), UdpAliasOut()     TcpAliasIn(), TcpAliasOut()  These routines handle protocol specific details of packet aliasing. One may observe a certain amount of repetitive arithmetic in these functions, the purpose of which is to compute a revised checksum without actually summing over the entire data packet, which could be unnecessarily time consuming.  The purpose of the packet aliasing routines is to replace the source address of the outgoing packet and then correctly put it back for any incoming packets.  For TCP and UDP, ports are also re-mapped.  For ICMP echo/timestamp requests and replies, the following scheme is used: the sequence number is replaced by an alias for the outgoing packet and this sequence number, plus the id and remote address are used to find the packet on the return path.  ICMP error messages are handled by looking at the IP fragment in the data section of the message.  For TCP and UDP protocols, a port number is chosen for an outgoing packet, and then incoming packets are identified by IP address and port number.  For TCP packets, there is additional logic in the event that sequence and ack numbers have been altered (as is the case for FTP data port commands).  The port numbers used by the packet aliasing module are not true ports in the Unix sense.  No sockets are actually bound to ports. They are more correctly placeholders.  All packets are aliased, whether they come from the gateway machine or other machines on a local area network. */
end_comment

begin_function
name|void
name|IcmpAliasIn1
parameter_list|(
name|pip
parameter_list|)
name|struct
name|ip
modifier|*
name|pip
decl_stmt|;
block|{
comment|/*     Un-alias incoming echo and timestamp replies */
name|char
modifier|*
name|link
decl_stmt|;
name|struct
name|icmp
modifier|*
name|ic
decl_stmt|;
name|ic
operator|=
operator|(
expr|struct
name|icmp
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|pip
operator|+
operator|(
name|pip
operator|->
name|ip_hl
operator|<<
literal|2
operator|)
operator|)
expr_stmt|;
comment|/* Get source address from ICMP data field and restore original data */
name|link
operator|=
name|FindIcmpIn
argument_list|(
name|pip
operator|->
name|ip_src
argument_list|,
name|ic
operator|->
name|icmp_id
argument_list|,
name|ic
operator|->
name|icmp_seq
argument_list|)
expr_stmt|;
if|if
condition|(
name|link
operator|!=
name|NULL_PTR
condition|)
block|{
name|u_short
name|original_seq
decl_stmt|;
name|int
name|accumulate
decl_stmt|;
name|original_seq
operator|=
name|GetOriginalPort
argument_list|(
name|link
argument_list|)
expr_stmt|;
comment|/* Adjust ICMP checksum */
name|accumulate
operator|=
name|ic
operator|->
name|icmp_cksum
expr_stmt|;
name|accumulate
operator|+=
name|ic
operator|->
name|icmp_seq
expr_stmt|;
name|accumulate
operator|-=
name|original_seq
expr_stmt|;
if|if
condition|(
name|accumulate
operator|<
literal|0
condition|)
block|{
name|accumulate
operator|=
operator|-
name|accumulate
expr_stmt|;
name|accumulate
operator|=
operator|(
name|accumulate
operator|>>
literal|16
operator|)
operator|+
operator|(
name|accumulate
operator|&
literal|0xffff
operator|)
expr_stmt|;
name|accumulate
operator|+=
name|accumulate
operator|>>
literal|16
expr_stmt|;
name|ic
operator|->
name|icmp_cksum
operator|=
operator|(
name|u_short
operator|)
operator|~
name|accumulate
expr_stmt|;
block|}
else|else
block|{
name|accumulate
operator|=
operator|(
name|accumulate
operator|>>
literal|16
operator|)
operator|+
operator|(
name|accumulate
operator|&
literal|0xffff
operator|)
expr_stmt|;
name|accumulate
operator|+=
name|accumulate
operator|>>
literal|16
expr_stmt|;
name|ic
operator|->
name|icmp_cksum
operator|=
operator|(
name|u_short
operator|)
name|accumulate
expr_stmt|;
block|}
comment|/* Put original sequence number back in */
name|ic
operator|->
name|icmp_seq
operator|=
name|original_seq
expr_stmt|;
comment|/* Put original address back into IP header */
name|pip
operator|->
name|ip_dst
operator|=
name|GetOriginalAddress
argument_list|(
name|link
argument_list|)
expr_stmt|;
comment|/* Delete unneeded data structure */
name|DeleteLink
argument_list|(
name|link
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|IcmpAliasIn2
parameter_list|(
name|pip
parameter_list|)
name|struct
name|ip
modifier|*
name|pip
decl_stmt|;
block|{
comment|/*     Alias incoming ICMP error messages containing     IP header and first 64 bits of datagram. */
name|struct
name|ip
modifier|*
name|ip
decl_stmt|;
name|struct
name|icmp
modifier|*
name|ic
decl_stmt|,
modifier|*
name|ic2
decl_stmt|;
name|struct
name|udphdr
modifier|*
name|ud
decl_stmt|;
name|struct
name|tcphdr
modifier|*
name|tc
decl_stmt|;
name|char
modifier|*
name|link
decl_stmt|;
name|ic
operator|=
operator|(
expr|struct
name|icmp
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|pip
operator|+
operator|(
name|pip
operator|->
name|ip_hl
operator|<<
literal|2
operator|)
operator|)
expr_stmt|;
name|ip
operator|=
operator|(
expr|struct
name|ip
operator|*
operator|)
name|ic
operator|->
name|icmp_data
expr_stmt|;
name|ud
operator|=
operator|(
expr|struct
name|udphdr
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|ip
operator|+
operator|(
name|ip
operator|->
name|ip_hl
operator|<<
literal|2
operator|)
operator|)
expr_stmt|;
name|tc
operator|=
operator|(
expr|struct
name|tcphdr
operator|*
operator|)
name|ud
expr_stmt|;
name|ic2
operator|=
operator|(
expr|struct
name|icmp
operator|*
operator|)
name|ud
expr_stmt|;
if|if
condition|(
name|ip
operator|->
name|ip_p
operator|==
name|IPPROTO_UDP
condition|)
name|link
operator|=
name|FindUdpIn
argument_list|(
name|ip
operator|->
name|ip_dst
argument_list|,
name|ud
operator|->
name|uh_dport
argument_list|,
name|ud
operator|->
name|uh_sport
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|ip
operator|->
name|ip_p
operator|==
name|IPPROTO_TCP
condition|)
name|link
operator|=
name|FindTcpIn
argument_list|(
name|ip
operator|->
name|ip_dst
argument_list|,
name|tc
operator|->
name|th_dport
argument_list|,
name|tc
operator|->
name|th_sport
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|ip
operator|->
name|ip_p
operator|==
name|IPPROTO_ICMP
condition|)
if|if
condition|(
name|ic2
operator|->
name|icmp_type
operator|==
name|ICMP_ECHO
operator|||
name|ic2
operator|->
name|icmp_type
operator|==
name|ICMP_TSTAMP
condition|)
name|link
operator|=
name|FindIcmpIn
argument_list|(
name|ip
operator|->
name|ip_dst
argument_list|,
name|ic2
operator|->
name|icmp_id
argument_list|,
name|ic2
operator|->
name|icmp_seq
argument_list|)
expr_stmt|;
else|else
name|link
operator|=
name|NULL_PTR
expr_stmt|;
else|else
name|link
operator|=
name|NULL_PTR
expr_stmt|;
if|if
condition|(
name|link
operator|!=
name|NULL_PTR
condition|)
block|{
if|if
condition|(
name|ip
operator|->
name|ip_p
operator|==
name|IPPROTO_UDP
operator|||
name|ip
operator|->
name|ip_p
operator|==
name|IPPROTO_TCP
condition|)
block|{
name|u_short
modifier|*
name|sptr
decl_stmt|;
name|int
name|accumulate
decl_stmt|;
name|struct
name|in_addr
name|original_address
decl_stmt|;
name|u_short
name|original_port
decl_stmt|;
name|original_address
operator|=
name|GetOriginalAddress
argument_list|(
name|link
argument_list|)
expr_stmt|;
name|original_port
operator|=
name|GetOriginalPort
argument_list|(
name|link
argument_list|)
expr_stmt|;
comment|/* Adjust ICMP checksum */
name|accumulate
operator|=
name|ic
operator|->
name|icmp_cksum
expr_stmt|;
name|sptr
operator|=
operator|(
name|u_short
operator|*
operator|)
operator|&
operator|(
name|ip
operator|->
name|ip_src
operator|)
expr_stmt|;
name|accumulate
operator|+=
operator|*
name|sptr
operator|++
expr_stmt|;
name|accumulate
operator|+=
operator|*
name|sptr
expr_stmt|;
name|sptr
operator|=
operator|(
name|u_short
operator|*
operator|)
operator|&
name|original_address
expr_stmt|;
name|accumulate
operator|-=
operator|*
name|sptr
operator|++
expr_stmt|;
name|accumulate
operator|-=
operator|*
name|sptr
expr_stmt|;
name|accumulate
operator|+=
name|ud
operator|->
name|uh_sport
expr_stmt|;
name|accumulate
operator|-=
name|original_port
expr_stmt|;
if|if
condition|(
name|accumulate
operator|<
literal|0
condition|)
block|{
name|accumulate
operator|=
operator|-
name|accumulate
expr_stmt|;
name|accumulate
operator|=
operator|(
name|accumulate
operator|>>
literal|16
operator|)
operator|+
operator|(
name|accumulate
operator|&
literal|0xffff
operator|)
expr_stmt|;
name|accumulate
operator|+=
name|accumulate
operator|>>
literal|16
expr_stmt|;
name|ic
operator|->
name|icmp_cksum
operator|=
operator|(
name|u_short
operator|)
operator|~
name|accumulate
expr_stmt|;
block|}
else|else
block|{
name|accumulate
operator|=
operator|(
name|accumulate
operator|>>
literal|16
operator|)
operator|+
operator|(
name|accumulate
operator|&
literal|0xffff
operator|)
expr_stmt|;
name|accumulate
operator|+=
name|accumulate
operator|>>
literal|16
expr_stmt|;
name|ic
operator|->
name|icmp_cksum
operator|=
operator|(
name|u_short
operator|)
name|accumulate
expr_stmt|;
block|}
comment|/* Un-alias address in IP header */
name|pip
operator|->
name|ip_dst
operator|=
name|original_address
expr_stmt|;
comment|/* Un-alias address and port number of original IP packet fragment contained in ICMP data section */
name|ip
operator|->
name|ip_src
operator|=
name|original_address
expr_stmt|;
name|ud
operator|->
name|uh_sport
operator|=
name|original_port
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pip
operator|->
name|ip_p
operator|==
name|IPPROTO_ICMP
condition|)
block|{
name|u_short
modifier|*
name|sptr
decl_stmt|;
name|int
name|accumulate
decl_stmt|;
name|struct
name|in_addr
name|original_address
decl_stmt|;
name|u_short
name|original_seq
decl_stmt|;
name|original_address
operator|=
name|GetOriginalAddress
argument_list|(
name|link
argument_list|)
expr_stmt|;
name|original_seq
operator|=
name|GetOriginalPort
argument_list|(
name|link
argument_list|)
expr_stmt|;
comment|/* Adjust ICMP checksum */
name|accumulate
operator|=
name|ic
operator|->
name|icmp_cksum
expr_stmt|;
name|sptr
operator|=
operator|(
name|u_short
operator|*
operator|)
operator|&
operator|(
name|ip
operator|->
name|ip_src
operator|)
expr_stmt|;
name|accumulate
operator|+=
operator|*
name|sptr
operator|++
expr_stmt|;
name|accumulate
operator|+=
operator|*
name|sptr
expr_stmt|;
name|sptr
operator|=
operator|(
name|u_short
operator|*
operator|)
operator|&
name|original_address
expr_stmt|;
name|accumulate
operator|-=
operator|*
name|sptr
operator|++
expr_stmt|;
name|accumulate
operator|-=
operator|*
name|sptr
expr_stmt|;
name|accumulate
operator|+=
name|ic2
operator|->
name|icmp_seq
expr_stmt|;
name|accumulate
operator|-=
name|original_seq
expr_stmt|;
if|if
condition|(
name|accumulate
operator|<
literal|0
condition|)
block|{
name|accumulate
operator|=
operator|-
name|accumulate
expr_stmt|;
name|accumulate
operator|=
operator|(
name|accumulate
operator|>>
literal|16
operator|)
operator|+
operator|(
name|accumulate
operator|&
literal|0xffff
operator|)
expr_stmt|;
name|accumulate
operator|+=
name|accumulate
operator|>>
literal|16
expr_stmt|;
name|ic
operator|->
name|icmp_cksum
operator|=
operator|(
name|u_short
operator|)
operator|~
name|accumulate
expr_stmt|;
block|}
else|else
block|{
name|accumulate
operator|=
operator|(
name|accumulate
operator|>>
literal|16
operator|)
operator|+
operator|(
name|accumulate
operator|&
literal|0xffff
operator|)
expr_stmt|;
name|accumulate
operator|+=
name|accumulate
operator|>>
literal|16
expr_stmt|;
name|ic
operator|->
name|icmp_cksum
operator|=
operator|(
name|u_short
operator|)
name|accumulate
expr_stmt|;
block|}
comment|/* Un-alias address in IP header */
name|pip
operator|->
name|ip_dst
operator|=
name|original_address
expr_stmt|;
comment|/* Un-alias address of original IP packet and seqence number of     embedded icmp datagram */
name|ip
operator|->
name|ip_src
operator|=
name|original_address
expr_stmt|;
name|ic2
operator|->
name|icmp_seq
operator|=
name|original_seq
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|void
name|IcmpAliasIn
parameter_list|(
name|pip
parameter_list|)
name|struct
name|ip
modifier|*
name|pip
decl_stmt|;
block|{
name|struct
name|icmp
modifier|*
name|ic
decl_stmt|;
name|ic
operator|=
operator|(
expr|struct
name|icmp
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|pip
operator|+
operator|(
name|pip
operator|->
name|ip_hl
operator|<<
literal|2
operator|)
operator|)
expr_stmt|;
switch|switch
condition|(
name|ic
operator|->
name|icmp_type
condition|)
block|{
case|case
name|ICMP_ECHOREPLY
case|:
case|case
name|ICMP_TSTAMPREPLY
case|:
if|if
condition|(
name|ic
operator|->
name|icmp_code
operator|==
literal|0
condition|)
block|{
name|IcmpAliasIn1
argument_list|(
name|pip
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|ICMP_UNREACH
case|:
case|case
name|ICMP_SOURCEQUENCH
case|:
case|case
name|ICMP_TIMXCEED
case|:
case|case
name|ICMP_PARAMPROB
case|:
name|IcmpAliasIn2
argument_list|(
name|pip
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
name|void
name|IcmpAliasOut1
parameter_list|(
name|pip
parameter_list|)
name|struct
name|ip
modifier|*
name|pip
decl_stmt|;
block|{
comment|/*     Alias ICMP echo and timestamp packets */
name|char
modifier|*
name|link
decl_stmt|;
name|struct
name|icmp
modifier|*
name|ic
decl_stmt|;
name|ic
operator|=
operator|(
expr|struct
name|icmp
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|pip
operator|+
operator|(
name|pip
operator|->
name|ip_hl
operator|<<
literal|2
operator|)
operator|)
expr_stmt|;
comment|/* Save overwritten data for when echo packet returns */
name|link
operator|=
name|FindIcmpOut
argument_list|(
name|pip
operator|->
name|ip_src
argument_list|,
name|pip
operator|->
name|ip_dst
argument_list|,
name|ic
operator|->
name|icmp_id
argument_list|,
name|ic
operator|->
name|icmp_seq
argument_list|)
expr_stmt|;
if|if
condition|(
name|link
operator|!=
name|NULL_PTR
condition|)
block|{
name|u_short
name|alias_seq
decl_stmt|;
name|int
name|accumulate
decl_stmt|;
name|alias_seq
operator|=
name|GetAliasPort
argument_list|(
name|link
argument_list|)
expr_stmt|;
comment|/* Since data field is being modified, adjust ICMP checksum */
name|accumulate
operator|=
name|ic
operator|->
name|icmp_cksum
expr_stmt|;
name|accumulate
operator|+=
name|ic
operator|->
name|icmp_seq
expr_stmt|;
name|accumulate
operator|-=
name|alias_seq
expr_stmt|;
if|if
condition|(
name|accumulate
operator|<
literal|0
condition|)
block|{
name|accumulate
operator|=
operator|-
name|accumulate
expr_stmt|;
name|accumulate
operator|=
operator|(
name|accumulate
operator|>>
literal|16
operator|)
operator|+
operator|(
name|accumulate
operator|&
literal|0xffff
operator|)
expr_stmt|;
name|accumulate
operator|+=
name|accumulate
operator|>>
literal|16
expr_stmt|;
name|ic
operator|->
name|icmp_cksum
operator|=
operator|(
name|u_short
operator|)
operator|~
name|accumulate
expr_stmt|;
block|}
else|else
block|{
name|accumulate
operator|=
operator|(
name|accumulate
operator|>>
literal|16
operator|)
operator|+
operator|(
name|accumulate
operator|&
literal|0xffff
operator|)
expr_stmt|;
name|accumulate
operator|+=
name|accumulate
operator|>>
literal|16
expr_stmt|;
name|ic
operator|->
name|icmp_cksum
operator|=
operator|(
name|u_short
operator|)
name|accumulate
expr_stmt|;
block|}
comment|/* Alias sequence number */
name|ic
operator|->
name|icmp_seq
operator|=
name|alias_seq
expr_stmt|;
comment|/* Change source address */
name|pip
operator|->
name|ip_src
operator|=
name|GetAliasAddress
argument_list|()
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|IcmpAliasOut
parameter_list|(
name|pip
parameter_list|)
name|struct
name|ip
modifier|*
name|pip
decl_stmt|;
block|{
name|struct
name|icmp
modifier|*
name|ic
decl_stmt|;
name|ic
operator|=
operator|(
expr|struct
name|icmp
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|pip
operator|+
operator|(
name|pip
operator|->
name|ip_hl
operator|<<
literal|2
operator|)
operator|)
expr_stmt|;
switch|switch
condition|(
name|ic
operator|->
name|icmp_type
condition|)
block|{
case|case
name|ICMP_ECHO
case|:
case|case
name|ICMP_TSTAMP
case|:
if|if
condition|(
name|ic
operator|->
name|icmp_code
operator|==
literal|0
condition|)
block|{
name|IcmpAliasOut1
argument_list|(
name|pip
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
block|}
end_function

begin_function
name|void
name|UdpAliasIn
parameter_list|(
name|pip
parameter_list|)
name|struct
name|ip
modifier|*
name|pip
decl_stmt|;
block|{
name|struct
name|udphdr
modifier|*
name|ud
decl_stmt|;
name|char
modifier|*
name|link
decl_stmt|;
name|ud
operator|=
operator|(
expr|struct
name|udphdr
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|pip
operator|+
operator|(
name|pip
operator|->
name|ip_hl
operator|<<
literal|2
operator|)
operator|)
expr_stmt|;
name|link
operator|=
name|FindUdpIn
argument_list|(
name|pip
operator|->
name|ip_src
argument_list|,
name|ud
operator|->
name|uh_sport
argument_list|,
name|ud
operator|->
name|uh_dport
argument_list|)
expr_stmt|;
if|if
condition|(
name|link
operator|!=
name|NULL_PTR
condition|)
block|{
name|struct
name|in_addr
name|alias_address
decl_stmt|;
name|u_short
name|alias_port
decl_stmt|;
name|int
name|accumulate
decl_stmt|;
name|u_short
modifier|*
name|sptr
decl_stmt|;
name|alias_address
operator|=
name|GetAliasAddress
argument_list|()
expr_stmt|;
name|pip
operator|->
name|ip_dst
operator|=
name|GetOriginalAddress
argument_list|(
name|link
argument_list|)
expr_stmt|;
name|alias_port
operator|=
name|ud
operator|->
name|uh_dport
expr_stmt|;
name|ud
operator|->
name|uh_dport
operator|=
name|GetOriginalPort
argument_list|(
name|link
argument_list|)
expr_stmt|;
comment|/* If UDP checksum is not zero, then adjust since destination port */
comment|/* is being unaliased and destination port is being altered.       */
if|if
condition|(
name|ud
operator|->
name|uh_sum
operator|!=
literal|0
condition|)
block|{
name|accumulate
operator|=
name|ud
operator|->
name|uh_sum
expr_stmt|;
name|accumulate
operator|+=
name|alias_port
expr_stmt|;
name|accumulate
operator|-=
name|ud
operator|->
name|uh_dport
expr_stmt|;
name|sptr
operator|=
operator|(
name|u_short
operator|*
operator|)
operator|&
name|alias_address
expr_stmt|;
name|accumulate
operator|+=
operator|*
name|sptr
operator|++
expr_stmt|;
name|accumulate
operator|+=
operator|*
name|sptr
expr_stmt|;
name|sptr
operator|=
operator|(
name|u_short
operator|*
operator|)
operator|&
operator|(
name|pip
operator|->
name|ip_dst
operator|)
expr_stmt|;
name|accumulate
operator|-=
operator|*
name|sptr
operator|++
expr_stmt|;
name|accumulate
operator|-=
operator|*
name|sptr
expr_stmt|;
if|if
condition|(
name|accumulate
operator|<
literal|0
condition|)
block|{
name|accumulate
operator|=
operator|-
name|accumulate
expr_stmt|;
name|accumulate
operator|=
operator|(
name|accumulate
operator|>>
literal|16
operator|)
operator|+
operator|(
name|accumulate
operator|&
literal|0xffff
operator|)
expr_stmt|;
name|accumulate
operator|+=
name|accumulate
operator|>>
literal|16
expr_stmt|;
name|ud
operator|->
name|uh_sum
operator|=
operator|(
name|u_short
operator|)
operator|~
name|accumulate
expr_stmt|;
block|}
else|else
block|{
name|accumulate
operator|=
operator|(
name|accumulate
operator|>>
literal|16
operator|)
operator|+
operator|(
name|accumulate
operator|&
literal|0xffff
operator|)
expr_stmt|;
name|accumulate
operator|+=
name|accumulate
operator|>>
literal|16
expr_stmt|;
name|ud
operator|->
name|uh_sum
operator|=
operator|(
name|u_short
operator|)
name|accumulate
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_function
name|void
name|UdpAliasOut
parameter_list|(
name|pip
parameter_list|)
name|struct
name|ip
modifier|*
name|pip
decl_stmt|;
block|{
name|struct
name|udphdr
modifier|*
name|ud
decl_stmt|;
name|char
modifier|*
name|link
decl_stmt|;
name|ud
operator|=
operator|(
expr|struct
name|udphdr
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|pip
operator|+
operator|(
name|pip
operator|->
name|ip_hl
operator|<<
literal|2
operator|)
operator|)
expr_stmt|;
name|link
operator|=
name|FindUdpOut
argument_list|(
name|pip
operator|->
name|ip_src
argument_list|,
name|pip
operator|->
name|ip_dst
argument_list|,
name|ud
operator|->
name|uh_sport
argument_list|,
name|ud
operator|->
name|uh_dport
argument_list|)
expr_stmt|;
if|if
condition|(
name|link
operator|!=
name|NULL_PTR
condition|)
block|{
name|u_short
name|alias_port
decl_stmt|;
name|alias_port
operator|=
name|GetAliasPort
argument_list|(
name|link
argument_list|)
expr_stmt|;
comment|/* If UDP checksum is not zero, adjust since source port is */
comment|/* being aliased and source address is being altered        */
if|if
condition|(
name|ud
operator|->
name|uh_sum
operator|!=
literal|0
condition|)
block|{
name|struct
name|in_addr
name|alias_address
decl_stmt|;
name|int
name|accumulate
decl_stmt|;
name|u_short
modifier|*
name|sptr
decl_stmt|;
name|alias_address
operator|=
name|GetAliasAddress
argument_list|()
expr_stmt|;
name|accumulate
operator|=
name|ud
operator|->
name|uh_sum
expr_stmt|;
name|accumulate
operator|+=
name|ud
operator|->
name|uh_sport
expr_stmt|;
name|accumulate
operator|-=
name|alias_port
expr_stmt|;
name|sptr
operator|=
operator|(
name|u_short
operator|*
operator|)
operator|&
operator|(
name|pip
operator|->
name|ip_src
operator|)
expr_stmt|;
name|accumulate
operator|+=
operator|*
name|sptr
operator|++
expr_stmt|;
name|accumulate
operator|+=
operator|*
name|sptr
expr_stmt|;
name|sptr
operator|=
operator|(
name|u_short
operator|*
operator|)
operator|&
name|alias_address
expr_stmt|;
name|accumulate
operator|-=
operator|*
name|sptr
operator|++
expr_stmt|;
name|accumulate
operator|-=
operator|*
name|sptr
expr_stmt|;
if|if
condition|(
name|accumulate
operator|<
literal|0
condition|)
block|{
name|accumulate
operator|=
operator|-
name|accumulate
expr_stmt|;
name|accumulate
operator|=
operator|(
name|accumulate
operator|>>
literal|16
operator|)
operator|+
operator|(
name|accumulate
operator|&
literal|0xffff
operator|)
expr_stmt|;
name|accumulate
operator|+=
name|accumulate
operator|>>
literal|16
expr_stmt|;
name|ud
operator|->
name|uh_sum
operator|=
operator|(
name|u_short
operator|)
operator|~
name|accumulate
expr_stmt|;
block|}
else|else
block|{
name|accumulate
operator|=
operator|(
name|accumulate
operator|>>
literal|16
operator|)
operator|+
operator|(
name|accumulate
operator|&
literal|0xffff
operator|)
expr_stmt|;
name|accumulate
operator|+=
name|accumulate
operator|>>
literal|16
expr_stmt|;
name|ud
operator|->
name|uh_sum
operator|=
operator|(
name|u_short
operator|)
name|accumulate
expr_stmt|;
block|}
block|}
comment|/* Put alias port in TCP header */
name|ud
operator|->
name|uh_sport
operator|=
name|alias_port
expr_stmt|;
comment|/* Change source address */
name|pip
operator|->
name|ip_src
operator|=
name|GetAliasAddress
argument_list|()
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|TcpAliasIn
parameter_list|(
name|pip
parameter_list|)
name|struct
name|ip
modifier|*
name|pip
decl_stmt|;
block|{
name|struct
name|tcphdr
modifier|*
name|tc
decl_stmt|;
name|char
modifier|*
name|link
decl_stmt|;
name|tc
operator|=
operator|(
expr|struct
name|tcphdr
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|pip
operator|+
operator|(
name|pip
operator|->
name|ip_hl
operator|<<
literal|2
operator|)
operator|)
expr_stmt|;
name|link
operator|=
name|FindTcpIn
argument_list|(
name|pip
operator|->
name|ip_src
argument_list|,
name|tc
operator|->
name|th_sport
argument_list|,
name|tc
operator|->
name|th_dport
argument_list|)
expr_stmt|;
if|if
condition|(
name|link
operator|!=
name|NULL_PTR
condition|)
block|{
name|struct
name|in_addr
name|alias_address
decl_stmt|;
name|u_short
name|alias_port
decl_stmt|;
name|int
name|accumulate
decl_stmt|;
name|u_short
modifier|*
name|sptr
decl_stmt|;
name|alias_address
operator|=
name|GetAliasAddress
argument_list|()
expr_stmt|;
name|pip
operator|->
name|ip_dst
operator|=
name|GetOriginalAddress
argument_list|(
name|link
argument_list|)
expr_stmt|;
name|alias_port
operator|=
name|tc
operator|->
name|th_dport
expr_stmt|;
name|tc
operator|->
name|th_dport
operator|=
name|GetOriginalPort
argument_list|(
name|link
argument_list|)
expr_stmt|;
comment|/* Adjust TCP checksum since destination port is being unaliased */
comment|/* and destination port is being altered.                        */
name|accumulate
operator|=
name|tc
operator|->
name|th_sum
expr_stmt|;
name|accumulate
operator|+=
name|alias_port
expr_stmt|;
name|accumulate
operator|-=
name|tc
operator|->
name|th_dport
expr_stmt|;
name|sptr
operator|=
operator|(
name|u_short
operator|*
operator|)
operator|&
name|alias_address
expr_stmt|;
name|accumulate
operator|+=
operator|*
name|sptr
operator|++
expr_stmt|;
name|accumulate
operator|+=
operator|*
name|sptr
expr_stmt|;
name|sptr
operator|=
operator|(
name|u_short
operator|*
operator|)
operator|&
operator|(
name|pip
operator|->
name|ip_dst
operator|)
expr_stmt|;
name|accumulate
operator|-=
operator|*
name|sptr
operator|++
expr_stmt|;
name|accumulate
operator|-=
operator|*
name|sptr
expr_stmt|;
comment|/* See if ack number needs to be modified */
if|if
condition|(
name|GetAckModified
argument_list|(
name|link
argument_list|)
operator|==
literal|1
condition|)
block|{
name|int
name|delta
decl_stmt|;
name|delta
operator|=
name|GetDeltaAckIn
argument_list|(
name|pip
argument_list|,
name|link
argument_list|)
expr_stmt|;
if|if
condition|(
name|delta
operator|!=
literal|0
condition|)
block|{
name|sptr
operator|=
operator|(
name|u_short
operator|*
operator|)
operator|&
name|tc
operator|->
name|th_ack
expr_stmt|;
name|accumulate
operator|+=
operator|*
name|sptr
operator|++
expr_stmt|;
name|accumulate
operator|+=
operator|*
name|sptr
expr_stmt|;
name|tc
operator|->
name|th_ack
operator|=
name|htonl
argument_list|(
name|ntohl
argument_list|(
name|tc
operator|->
name|th_ack
argument_list|)
operator|-
name|delta
argument_list|)
expr_stmt|;
name|sptr
operator|=
operator|(
name|u_short
operator|*
operator|)
operator|&
name|tc
operator|->
name|th_ack
expr_stmt|;
name|accumulate
operator|-=
operator|*
name|sptr
operator|++
expr_stmt|;
name|accumulate
operator|-=
operator|*
name|sptr
expr_stmt|;
block|}
block|}
comment|/* Finish checksum modification */
if|if
condition|(
name|accumulate
operator|<
literal|0
condition|)
block|{
name|accumulate
operator|=
operator|-
name|accumulate
expr_stmt|;
name|accumulate
operator|=
operator|(
name|accumulate
operator|>>
literal|16
operator|)
operator|+
operator|(
name|accumulate
operator|&
literal|0xffff
operator|)
expr_stmt|;
name|accumulate
operator|+=
name|accumulate
operator|>>
literal|16
expr_stmt|;
name|tc
operator|->
name|th_sum
operator|=
operator|(
name|u_short
operator|)
operator|~
name|accumulate
expr_stmt|;
block|}
else|else
block|{
name|accumulate
operator|=
operator|(
name|accumulate
operator|>>
literal|16
operator|)
operator|+
operator|(
name|accumulate
operator|&
literal|0xffff
operator|)
expr_stmt|;
name|accumulate
operator|+=
name|accumulate
operator|>>
literal|16
expr_stmt|;
name|tc
operator|->
name|th_sum
operator|=
operator|(
name|u_short
operator|)
name|accumulate
expr_stmt|;
block|}
comment|/* Monitor TCP connection state */
name|TcpMonitorIn
argument_list|(
name|pip
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|TcpAliasOut
parameter_list|(
name|pip
parameter_list|)
name|struct
name|ip
modifier|*
name|pip
decl_stmt|;
block|{
name|struct
name|tcphdr
modifier|*
name|tc
decl_stmt|;
name|char
modifier|*
name|link
decl_stmt|;
name|tc
operator|=
operator|(
expr|struct
name|tcphdr
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|pip
operator|+
operator|(
name|pip
operator|->
name|ip_hl
operator|<<
literal|2
operator|)
operator|)
expr_stmt|;
name|link
operator|=
name|FindTcpOut
argument_list|(
name|pip
operator|->
name|ip_src
argument_list|,
name|pip
operator|->
name|ip_dst
argument_list|,
name|tc
operator|->
name|th_sport
argument_list|,
name|tc
operator|->
name|th_dport
argument_list|)
expr_stmt|;
if|if
condition|(
name|link
operator|!=
name|NULL_PTR
condition|)
block|{
name|struct
name|in_addr
name|alias_address
decl_stmt|;
name|u_short
name|alias_port
decl_stmt|;
name|int
name|accumulate
decl_stmt|;
name|u_short
modifier|*
name|sptr
decl_stmt|;
name|alias_address
operator|=
name|GetAliasAddress
argument_list|()
expr_stmt|;
name|alias_port
operator|=
name|GetAliasPort
argument_list|(
name|link
argument_list|)
expr_stmt|;
comment|/* Monitor tcp connection state */
name|TcpMonitorOut
argument_list|(
name|pip
argument_list|,
name|link
argument_list|)
expr_stmt|;
comment|/* Special processing for ftp connection */
if|if
condition|(
name|ntohs
argument_list|(
name|tc
operator|->
name|th_dport
argument_list|)
operator|==
name|FTP_CONTROL_PORT_NUMBER
operator|||
name|ntohs
argument_list|(
name|tc
operator|->
name|th_sport
argument_list|)
operator|==
name|FTP_CONTROL_PORT_NUMBER
condition|)
name|HandleFtpOut
argument_list|(
name|pip
argument_list|,
name|link
argument_list|)
expr_stmt|;
comment|/* Adjust TCP checksum since source port is being aliased */
comment|/* and source address is being altered                    */
name|accumulate
operator|=
name|tc
operator|->
name|th_sum
expr_stmt|;
name|accumulate
operator|+=
name|tc
operator|->
name|th_sport
expr_stmt|;
name|accumulate
operator|-=
name|alias_port
expr_stmt|;
name|sptr
operator|=
operator|(
name|u_short
operator|*
operator|)
operator|&
operator|(
name|pip
operator|->
name|ip_src
operator|)
expr_stmt|;
name|accumulate
operator|+=
operator|*
name|sptr
operator|++
expr_stmt|;
name|accumulate
operator|+=
operator|*
name|sptr
expr_stmt|;
name|sptr
operator|=
operator|(
name|u_short
operator|*
operator|)
operator|&
name|alias_address
expr_stmt|;
name|accumulate
operator|-=
operator|*
name|sptr
operator|++
expr_stmt|;
name|accumulate
operator|-=
operator|*
name|sptr
expr_stmt|;
comment|/* Modify sequence number if necessary */
if|if
condition|(
name|GetAckModified
argument_list|(
name|link
argument_list|)
operator|==
literal|1
condition|)
block|{
name|int
name|delta
decl_stmt|;
name|delta
operator|=
name|GetDeltaSeqOut
argument_list|(
name|pip
argument_list|,
name|link
argument_list|)
expr_stmt|;
if|if
condition|(
name|delta
operator|!=
literal|0
condition|)
block|{
name|sptr
operator|=
operator|(
name|u_short
operator|*
operator|)
operator|&
name|tc
operator|->
name|th_seq
expr_stmt|;
name|accumulate
operator|+=
operator|*
name|sptr
operator|++
expr_stmt|;
name|accumulate
operator|+=
operator|*
name|sptr
expr_stmt|;
name|tc
operator|->
name|th_seq
operator|=
name|htonl
argument_list|(
name|ntohl
argument_list|(
name|tc
operator|->
name|th_seq
argument_list|)
operator|+
name|delta
argument_list|)
expr_stmt|;
name|sptr
operator|=
operator|(
name|u_short
operator|*
operator|)
operator|&
name|tc
operator|->
name|th_seq
expr_stmt|;
name|accumulate
operator|-=
operator|*
name|sptr
operator|++
expr_stmt|;
name|accumulate
operator|-=
operator|*
name|sptr
expr_stmt|;
block|}
block|}
comment|/* Finish up checksum calculation */
if|if
condition|(
name|accumulate
operator|<
literal|0
condition|)
block|{
name|accumulate
operator|=
operator|-
name|accumulate
expr_stmt|;
name|accumulate
operator|=
operator|(
name|accumulate
operator|>>
literal|16
operator|)
operator|+
operator|(
name|accumulate
operator|&
literal|0xffff
operator|)
expr_stmt|;
name|accumulate
operator|+=
name|accumulate
operator|>>
literal|16
expr_stmt|;
name|tc
operator|->
name|th_sum
operator|=
operator|(
name|u_short
operator|)
operator|~
name|accumulate
expr_stmt|;
block|}
else|else
block|{
name|accumulate
operator|=
operator|(
name|accumulate
operator|>>
literal|16
operator|)
operator|+
operator|(
name|accumulate
operator|&
literal|0xffff
operator|)
expr_stmt|;
name|accumulate
operator|+=
name|accumulate
operator|>>
literal|16
expr_stmt|;
name|tc
operator|->
name|th_sum
operator|=
operator|(
name|u_short
operator|)
name|accumulate
expr_stmt|;
block|}
comment|/* Put alias address in TCP header */
name|tc
operator|->
name|th_sport
operator|=
name|alias_port
expr_stmt|;
comment|/* Change source address */
name|pip
operator|->
name|ip_src
operator|=
name|GetAliasAddress
argument_list|()
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* Fragment Handling      FragmentIn()     FragmentOut()  The packet aliasing module has a limited ability for handling IP fragments.  If the ICMP, TCP or UDP header is in the first fragment received, then the id number of the IP packet is saved, and other fragments are identified according to their ID number and IP address they were sent from.  In general, fragments seem few and far between these days.  One way to generate them is with a ping request specifying a large data segment. This is how the software here was tested.  In principle, out-of-order IP fragments could also be handled by saving fragments until the header fragment came in and then sending them on their way.  However, this violates a basic interface rule of the aliasing module in which individual packets are sent for remapping, and nothing is actually known about how to write these packets to a device interface. */
end_comment

begin_function
name|void
name|FragmentIn
parameter_list|(
name|pip
parameter_list|)
name|struct
name|ip
modifier|*
name|pip
decl_stmt|;
block|{
name|char
modifier|*
name|link
decl_stmt|;
name|link
operator|=
name|FindFragmentIn2
argument_list|(
name|pip
operator|->
name|ip_src
argument_list|)
expr_stmt|;
if|if
condition|(
name|link
operator|!=
name|NULL_PTR
condition|)
name|GetFragmentAddr
argument_list|(
name|link
argument_list|,
name|pip
operator|->
name|ip_id
argument_list|,
name|pip
operator|->
name|ip_p
argument_list|,
operator|&
operator|(
name|pip
operator|->
name|ip_dst
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|FragmentOut
parameter_list|(
name|pip
parameter_list|)
name|struct
name|ip
modifier|*
name|pip
decl_stmt|;
block|{
name|pip
operator|->
name|ip_src
operator|=
name|GetAliasAddress
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Outside World Access          PacketAliasIn()         PacketAliasOut() */
end_comment

begin_function
name|void
name|PacketAliasIn
parameter_list|(
name|pip
parameter_list|)
name|struct
name|ip
modifier|*
name|pip
decl_stmt|;
block|{
name|int
name|checksum_ok
decl_stmt|;
comment|/* Verify initial checksum */
if|if
condition|(
name|IpChecksum
argument_list|(
name|pip
argument_list|)
operator|==
literal|0
condition|)
name|checksum_ok
operator|=
literal|1
expr_stmt|;
else|else
name|checksum_ok
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|ntohs
argument_list|(
name|pip
operator|->
name|ip_off
argument_list|)
operator|&
name|IP_OFFMASK
operator|)
operator|==
literal|0
condition|)
block|{
switch|switch
condition|(
name|pip
operator|->
name|ip_p
condition|)
block|{
case|case
name|IPPROTO_ICMP
case|:
name|IcmpAliasIn
argument_list|(
name|pip
argument_list|)
expr_stmt|;
break|break;
case|case
name|IPPROTO_UDP
case|:
name|UdpAliasIn
argument_list|(
name|pip
argument_list|)
expr_stmt|;
break|break;
case|case
name|IPPROTO_TCP
case|:
name|TcpAliasIn
argument_list|(
name|pip
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ntohs
argument_list|(
name|pip
operator|->
name|ip_off
argument_list|)
operator|&
name|IP_MF
condition|)
block|{
name|char
modifier|*
name|link
decl_stmt|;
name|link
operator|=
name|FindFragmentIn1
argument_list|(
name|pip
operator|->
name|ip_src
argument_list|)
expr_stmt|;
if|if
condition|(
name|link
operator|!=
name|NULL_PTR
condition|)
name|SetFragmentData
argument_list|(
name|link
argument_list|,
name|pip
operator|->
name|ip_id
argument_list|,
name|pip
operator|->
name|ip_p
argument_list|,
name|pip
operator|->
name|ip_dst
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|FragmentIn
argument_list|(
name|pip
argument_list|)
expr_stmt|;
block|}
comment|/*  adjust IP checksum, if original is correct */
if|if
condition|(
name|checksum_ok
operator|==
literal|1
condition|)
block|{
name|pip
operator|->
name|ip_sum
operator|=
literal|0
expr_stmt|;
name|pip
operator|->
name|ip_sum
operator|=
name|IpChecksum
argument_list|(
name|pip
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|PacketAliasOut
parameter_list|(
name|pip
parameter_list|)
name|struct
name|ip
modifier|*
name|pip
decl_stmt|;
block|{
name|int
name|checksum_ok
decl_stmt|;
if|if
condition|(
name|IpChecksum
argument_list|(
name|pip
argument_list|)
operator|==
literal|0
condition|)
name|checksum_ok
operator|=
literal|1
expr_stmt|;
else|else
name|checksum_ok
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|ntohs
argument_list|(
name|pip
operator|->
name|ip_off
argument_list|)
operator|&
name|IP_OFFMASK
operator|)
operator|==
literal|0
condition|)
block|{
switch|switch
condition|(
name|pip
operator|->
name|ip_p
condition|)
block|{
case|case
name|IPPROTO_ICMP
case|:
name|IcmpAliasOut
argument_list|(
name|pip
argument_list|)
expr_stmt|;
break|break;
case|case
name|IPPROTO_UDP
case|:
name|UdpAliasOut
argument_list|(
name|pip
argument_list|)
expr_stmt|;
break|break;
case|case
name|IPPROTO_TCP
case|:
name|TcpAliasOut
argument_list|(
name|pip
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
name|FragmentOut
argument_list|(
name|pip
argument_list|)
expr_stmt|;
block|}
comment|/* Adjust IP checksum, if original is correct */
if|if
condition|(
name|checksum_ok
operator|==
literal|1
condition|)
block|{
name|pip
operator|->
name|ip_sum
operator|=
literal|0
expr_stmt|;
name|pip
operator|->
name|ip_sum
operator|=
name|IpChecksum
argument_list|(
name|pip
argument_list|)
expr_stmt|;
block|}
block|}
end_function

end_unit


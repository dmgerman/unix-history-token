begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  *		PPP User command processing module  *  *	    Written by Toshiharu OHNO (tony-o@iij.ad.jp)  *  *   Copyright (C) 1993, Internet Initiative Japan, Inc. All rights reserverd.  *  * Redistribution and use in source and binary forms are permitted  * provided that the above copyright notice and this paragraph are  * duplicated in all such forms and that any documentation,  * advertising materials, and other materials related to such  * distribution and use acknowledge that the software was developed  * by the Internet Initiative Japan, Inc.  The name of the  * IIJ may not be used to endorse or promote products derived  * from this software without specific prior written permission.  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND WITHOUT ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED  * WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR A PARTICULAR PURPOSE.  *  * $Id: command.c,v 1.117 1997/12/23 22:38:52 brian Exp $  *  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_systm.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip.h>
end_include

begin_include
include|#
directive|include
file|<arpa/inet.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<net/route.h>
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|NOALIAS
end_ifndef

begin_include
include|#
directive|include
file|<alias.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<paths.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<sys/wait.h>
end_include

begin_include
include|#
directive|include
file|<termios.h>
end_include

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|"command.h"
end_include

begin_include
include|#
directive|include
file|"mbuf.h"
end_include

begin_include
include|#
directive|include
file|"log.h"
end_include

begin_include
include|#
directive|include
file|"defs.h"
end_include

begin_include
include|#
directive|include
file|"timer.h"
end_include

begin_include
include|#
directive|include
file|"fsm.h"
end_include

begin_include
include|#
directive|include
file|"phase.h"
end_include

begin_include
include|#
directive|include
file|"lcp.h"
end_include

begin_include
include|#
directive|include
file|"iplist.h"
end_include

begin_include
include|#
directive|include
file|"ipcp.h"
end_include

begin_include
include|#
directive|include
file|"modem.h"
end_include

begin_include
include|#
directive|include
file|"filter.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|NOALIAS
end_ifndef

begin_include
include|#
directive|include
file|"alias_cmd.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"hdlc.h"
end_include

begin_include
include|#
directive|include
file|"loadalias.h"
end_include

begin_include
include|#
directive|include
file|"vars.h"
end_include

begin_include
include|#
directive|include
file|"systems.h"
end_include

begin_include
include|#
directive|include
file|"chat.h"
end_include

begin_include
include|#
directive|include
file|"os.h"
end_include

begin_include
include|#
directive|include
file|"server.h"
end_include

begin_include
include|#
directive|include
file|"main.h"
end_include

begin_include
include|#
directive|include
file|"route.h"
end_include

begin_include
include|#
directive|include
file|"ccp.h"
end_include

begin_include
include|#
directive|include
file|"ip.h"
end_include

begin_include
include|#
directive|include
file|"slcompress.h"
end_include

begin_include
include|#
directive|include
file|"auth.h"
end_include

begin_decl_stmt
name|struct
name|in_addr
name|ifnetmask
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|HIDDEN
init|=
literal|"********"
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|int
name|ShowCommand
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|TerminalCommand
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|QuitCommand
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|CloseCommand
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|DialCommand
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|DownCommand
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|AllowCommand
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|SetCommand
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|AddCommand
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|DeleteCommand
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|BgShellCommand
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|FgShellCommand
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_ifndef
ifndef|#
directive|ifndef
name|NOALIAS
end_ifndef

begin_function_decl
specifier|static
name|int
name|AliasCommand
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|AliasEnable
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|AliasOption
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|int
name|HelpCommand
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|cmdtab
specifier|const
modifier|*
name|cmd
decl_stmt|;
name|int
name|n
decl_stmt|,
name|cmax
decl_stmt|,
name|dmax
decl_stmt|,
name|cols
decl_stmt|;
if|if
condition|(
operator|!
name|VarTerm
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|arg
operator|->
name|argc
operator|>
literal|0
condition|)
block|{
for|for
control|(
name|cmd
operator|=
name|arg
operator|->
name|cmd
init|;
name|cmd
operator|->
name|name
condition|;
name|cmd
operator|++
control|)
if|if
condition|(
name|strcasecmp
argument_list|(
name|cmd
operator|->
name|name
argument_list|,
operator|*
name|arg
operator|->
name|argv
argument_list|)
operator|==
literal|0
operator|&&
operator|(
name|cmd
operator|->
name|lauth
operator|&
name|VarLocalAuth
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"%s\n"
argument_list|,
name|cmd
operator|->
name|syntax
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
operator|-
literal|1
return|;
block|}
name|cmax
operator|=
name|dmax
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|cmd
operator|=
name|arg
operator|->
name|cmd
init|;
name|cmd
operator|->
name|func
condition|;
name|cmd
operator|++
control|)
if|if
condition|(
name|cmd
operator|->
name|name
operator|&&
operator|(
name|cmd
operator|->
name|lauth
operator|&
name|VarLocalAuth
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|n
operator|=
name|strlen
argument_list|(
name|cmd
operator|->
name|name
argument_list|)
operator|)
operator|>
name|cmax
condition|)
name|cmax
operator|=
name|n
expr_stmt|;
if|if
condition|(
operator|(
name|n
operator|=
name|strlen
argument_list|(
name|cmd
operator|->
name|helpmes
argument_list|)
operator|)
operator|>
name|dmax
condition|)
name|dmax
operator|=
name|n
expr_stmt|;
block|}
name|cols
operator|=
literal|80
operator|/
operator|(
name|dmax
operator|+
name|cmax
operator|+
literal|3
operator|)
expr_stmt|;
name|n
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|cmd
operator|=
name|arg
operator|->
name|cmd
init|;
name|cmd
operator|->
name|func
condition|;
name|cmd
operator|++
control|)
if|if
condition|(
name|cmd
operator|->
name|name
operator|&&
operator|(
name|cmd
operator|->
name|lauth
operator|&
name|VarLocalAuth
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|" %-*.*s: %-*.*s"
argument_list|,
name|cmax
argument_list|,
name|cmax
argument_list|,
name|cmd
operator|->
name|name
argument_list|,
name|dmax
argument_list|,
name|dmax
argument_list|,
name|cmd
operator|->
name|helpmes
argument_list|)
expr_stmt|;
if|if
condition|(
operator|++
name|n
operator|%
name|cols
operator|==
literal|0
condition|)
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|n
operator|%
name|cols
operator|!=
literal|0
condition|)
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|IsInteractive
parameter_list|(
name|int
name|Display
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|mes
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|mode
operator|&
name|MODE_DDIAL
condition|)
name|mes
operator|=
literal|"Working in dedicated dial mode."
expr_stmt|;
elseif|else
if|if
condition|(
name|mode
operator|&
name|MODE_BACKGROUND
condition|)
name|mes
operator|=
literal|"Working in background mode."
expr_stmt|;
elseif|else
if|if
condition|(
name|mode
operator|&
name|MODE_AUTO
condition|)
name|mes
operator|=
literal|"Working in auto mode."
expr_stmt|;
elseif|else
if|if
condition|(
name|mode
operator|&
name|MODE_DIRECT
condition|)
name|mes
operator|=
literal|"Working in direct mode."
expr_stmt|;
elseif|else
if|if
condition|(
name|mode
operator|&
name|MODE_DEDICATED
condition|)
name|mes
operator|=
literal|"Working in dedicated mode."
expr_stmt|;
if|if
condition|(
name|mes
condition|)
block|{
if|if
condition|(
name|Display
operator|&&
name|VarTerm
condition|)
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"%s\n"
argument_list|,
name|mes
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|DialCommand
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
block|{
name|int
name|tries
decl_stmt|;
name|int
name|res
decl_stmt|;
if|if
condition|(
name|LcpFsm
operator|.
name|state
operator|>
name|ST_CLOSED
condition|)
block|{
if|if
condition|(
name|VarTerm
condition|)
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"LCP state is [%s]\n"
argument_list|,
name|StateNames
index|[
name|LcpFsm
operator|.
name|state
index|]
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|arg
operator|->
name|argc
operator|>
literal|0
operator|&&
operator|(
name|res
operator|=
name|LoadCommand
argument_list|(
name|arg
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|res
return|;
name|tries
operator|=
literal|0
expr_stmt|;
do|do
block|{
if|if
condition|(
name|VarTerm
condition|)
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"Dial attempt %u of %d\n"
argument_list|,
operator|++
name|tries
argument_list|,
name|VarDialTries
argument_list|)
expr_stmt|;
if|if
condition|(
name|OpenModem
argument_list|()
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|VarTerm
condition|)
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"Failed to open modem.\n"
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|(
name|res
operator|=
name|DialModem
argument_list|()
operator|)
operator|==
name|EX_DONE
condition|)
block|{
name|nointr_sleep
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|ModemTimeout
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|PacketMode
argument_list|()
expr_stmt|;
break|break;
block|}
elseif|else
if|if
condition|(
name|res
operator|==
name|EX_SIG
condition|)
return|return
literal|1
return|;
block|}
do|while
condition|(
name|VarDialTries
operator|==
literal|0
operator|||
name|tries
operator|<
name|VarDialTries
condition|)
do|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|SetLoopback
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
block|{
if|if
condition|(
name|arg
operator|->
name|argc
operator|==
literal|1
condition|)
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
operator|*
name|arg
operator|->
name|argv
argument_list|,
literal|"on"
argument_list|)
condition|)
block|{
name|VarLoopback
operator|=
literal|1
expr_stmt|;
return|return
literal|0
return|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
operator|*
name|arg
operator|->
name|argv
argument_list|,
literal|"off"
argument_list|)
condition|)
block|{
name|VarLoopback
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ShellCommand
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|,
name|int
name|bg
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|shell
decl_stmt|;
name|pid_t
name|shpid
decl_stmt|;
name|FILE
modifier|*
name|oVarTerm
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
name|argv
index|[
name|MAXARGS
index|]
decl_stmt|;
ifdef|#
directive|ifdef
name|SHELL_ONLY_INTERACTIVELY
comment|/* we're only allowed to shell when we run ppp interactively */
if|if
condition|(
name|mode
operator|!=
name|MODE_INTER
condition|)
block|{
name|LogPrintf
argument_list|(
name|LogWARN
argument_list|,
literal|"Can only start a shell in interactive mode\n"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
endif|#
directive|endif
ifdef|#
directive|ifdef
name|NO_SHELL_IN_AUTO_INTERACTIVE
comment|/*    * we want to stop shell commands when we've got a telnet connection to an    * auto mode ppp    */
if|if
condition|(
name|VarTerm
operator|&&
operator|!
operator|(
name|mode
operator|&
name|MODE_INTER
operator|)
condition|)
block|{
name|LogPrintf
argument_list|(
name|LogWARN
argument_list|,
literal|"Shell is not allowed interactively in auto mode\n"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
endif|#
directive|endif
if|if
condition|(
name|arg
operator|->
name|argc
operator|==
literal|0
condition|)
if|if
condition|(
operator|!
operator|(
name|mode
operator|&
name|MODE_INTER
operator|)
condition|)
block|{
if|if
condition|(
name|VarTerm
condition|)
name|LogPrintf
argument_list|(
name|LogWARN
argument_list|,
literal|"Can't start an interactive shell from"
literal|" a telnet session\n"
argument_list|)
expr_stmt|;
else|else
name|LogPrintf
argument_list|(
name|LogWARN
argument_list|,
literal|"Can only start an interactive shell in"
literal|" interactive mode\n"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
elseif|else
if|if
condition|(
name|bg
condition|)
block|{
name|LogPrintf
argument_list|(
name|LogWARN
argument_list|,
literal|"Can only start an interactive shell in"
literal|" the foreground mode\n"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
if|if
condition|(
operator|(
name|shell
operator|=
name|getenv
argument_list|(
literal|"SHELL"
argument_list|)
operator|)
operator|==
literal|0
condition|)
name|shell
operator|=
name|_PATH_BSHELL
expr_stmt|;
if|if
condition|(
operator|(
name|shpid
operator|=
name|fork
argument_list|()
operator|)
operator|==
literal|0
condition|)
block|{
name|int
name|dtablesize
decl_stmt|,
name|i
decl_stmt|,
name|fd
decl_stmt|;
if|if
condition|(
name|VarTerm
condition|)
name|fd
operator|=
name|fileno
argument_list|(
name|VarTerm
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|fd
operator|=
name|open
argument_list|(
literal|"/dev/null"
argument_list|,
name|O_RDWR
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
block|{
name|LogPrintf
argument_list|(
name|LogALERT
argument_list|,
literal|"Failed to open /dev/null: %s\n"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|3
condition|;
name|i
operator|++
control|)
name|dup2
argument_list|(
name|fd
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|>
literal|2
condition|)
if|if
condition|(
name|VarTerm
condition|)
block|{
name|oVarTerm
operator|=
name|VarTerm
expr_stmt|;
name|VarTerm
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|oVarTerm
operator|&&
name|oVarTerm
operator|!=
name|stdout
condition|)
name|fclose
argument_list|(
name|oVarTerm
argument_list|)
expr_stmt|;
block|}
else|else
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
for|for
control|(
name|dtablesize
operator|=
name|getdtablesize
argument_list|()
operator|,
name|i
operator|=
literal|3
init|;
name|i
operator|<
name|dtablesize
condition|;
name|i
operator|++
control|)
name|close
argument_list|(
name|i
argument_list|)
expr_stmt|;
name|TtyOldMode
argument_list|()
expr_stmt|;
name|setuid
argument_list|(
name|geteuid
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|arg
operator|->
name|argc
operator|>
literal|0
condition|)
block|{
comment|/* substitute pseudo args */
name|argv
index|[
literal|0
index|]
operator|=
name|strdup
argument_list|(
name|arg
operator|->
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|argc
operator|=
literal|1
init|;
name|argc
operator|<
name|arg
operator|->
name|argc
condition|;
name|argc
operator|++
control|)
block|{
if|if
condition|(
name|strcasecmp
argument_list|(
name|arg
operator|->
name|argv
index|[
name|argc
index|]
argument_list|,
literal|"HISADDR"
argument_list|)
operator|==
literal|0
condition|)
name|argv
index|[
name|argc
index|]
operator|=
name|strdup
argument_list|(
name|inet_ntoa
argument_list|(
name|IpcpInfo
operator|.
name|his_ipaddr
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|arg
operator|->
name|argv
index|[
name|argc
index|]
argument_list|,
literal|"INTERFACE"
argument_list|)
operator|==
literal|0
condition|)
name|argv
index|[
name|argc
index|]
operator|=
name|strdup
argument_list|(
name|IfDevName
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|arg
operator|->
name|argv
index|[
name|argc
index|]
argument_list|,
literal|"MYADDR"
argument_list|)
operator|==
literal|0
condition|)
name|argv
index|[
name|argc
index|]
operator|=
name|strdup
argument_list|(
name|inet_ntoa
argument_list|(
name|IpcpInfo
operator|.
name|want_ipaddr
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|argv
index|[
name|argc
index|]
operator|=
name|strdup
argument_list|(
name|arg
operator|->
name|argv
index|[
name|argc
index|]
argument_list|)
expr_stmt|;
block|}
name|argv
index|[
name|argc
index|]
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|bg
condition|)
block|{
name|pid_t
name|p
decl_stmt|;
name|p
operator|=
name|getpid
argument_list|()
expr_stmt|;
if|if
condition|(
name|daemon
argument_list|(
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|LogPrintf
argument_list|(
name|LogERROR
argument_list|,
literal|"%d: daemon: %s\n"
argument_list|,
name|p
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|VarTerm
condition|)
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"ppp: Pausing until %s finishes\n"
argument_list|,
name|arg
operator|->
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|execvp
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
name|argv
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|VarTerm
condition|)
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"ppp: Pausing until %s finishes\n"
argument_list|,
name|shell
argument_list|)
expr_stmt|;
name|execl
argument_list|(
name|shell
argument_list|,
name|shell
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
name|LogPrintf
argument_list|(
name|LogWARN
argument_list|,
literal|"exec() of %s failed\n"
argument_list|,
name|arg
operator|->
name|argc
operator|>
literal|0
condition|?
name|arg
operator|->
name|argv
index|[
literal|0
index|]
else|:
name|shell
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|255
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|shpid
operator|==
operator|(
name|pid_t
operator|)
operator|-
literal|1
condition|)
block|{
name|LogPrintf
argument_list|(
name|LogERROR
argument_list|,
literal|"Fork failed: %s\n"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|int
name|status
decl_stmt|;
name|waitpid
argument_list|(
name|shpid
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|TtyCommandMode
argument_list|(
literal|1
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|BgShellCommand
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
block|{
if|if
condition|(
name|arg
operator|->
name|argc
operator|==
literal|0
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|ShellCommand
argument_list|(
name|arg
argument_list|,
literal|1
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|FgShellCommand
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
block|{
return|return
name|ShellCommand
argument_list|(
name|arg
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|struct
name|cmdtab
specifier|const
name|Commands
index|[]
init|=
block|{
block|{
literal|"accept"
block|,
name|NULL
block|,
name|AcceptCommand
block|,
name|LOCAL_AUTH
block|,
literal|"accept option request"
block|,
literal|"accept option .."
block|}
block|,
block|{
literal|"add"
block|,
name|NULL
block|,
name|AddCommand
block|,
name|LOCAL_AUTH
block|,
literal|"add route"
block|,
literal|"add dest mask gateway"
block|}
block|,
block|{
literal|"allow"
block|,
literal|"auth"
block|,
name|AllowCommand
block|,
name|LOCAL_AUTH
block|,
literal|"Allow ppp access"
block|,
literal|"allow users|modes ...."
block|}
block|,
block|{
literal|"bg"
block|,
literal|"!bg"
block|,
name|BgShellCommand
block|,
name|LOCAL_AUTH
block|,
literal|"Run a background command"
block|,
literal|"[!]bg command"
block|}
block|,
block|{
literal|"close"
block|,
name|NULL
block|,
name|CloseCommand
block|,
name|LOCAL_AUTH
block|,
literal|"Close connection"
block|,
literal|"close"
block|}
block|,
block|{
literal|"delete"
block|,
name|NULL
block|,
name|DeleteCommand
block|,
name|LOCAL_AUTH
block|,
literal|"delete route"
block|,
literal|"delete dest"
block|}
block|,
block|{
literal|"deny"
block|,
name|NULL
block|,
name|DenyCommand
block|,
name|LOCAL_AUTH
block|,
literal|"Deny option request"
block|,
literal|"deny option .."
block|}
block|,
block|{
literal|"dial"
block|,
literal|"call"
block|,
name|DialCommand
block|,
name|LOCAL_AUTH
block|,
literal|"Dial and login"
block|,
literal|"dial|call [remote]"
block|}
block|,
block|{
literal|"disable"
block|,
name|NULL
block|,
name|DisableCommand
block|,
name|LOCAL_AUTH
block|,
literal|"Disable option"
block|,
literal|"disable option .."
block|}
block|,
block|{
literal|"display"
block|,
name|NULL
block|,
name|DisplayCommand
block|,
name|LOCAL_AUTH
block|,
literal|"Display option configs"
block|,
literal|"display"
block|}
block|,
block|{
literal|"enable"
block|,
name|NULL
block|,
name|EnableCommand
block|,
name|LOCAL_AUTH
block|,
literal|"Enable option"
block|,
literal|"enable option .."
block|}
block|,
block|{
literal|"passwd"
block|,
name|NULL
block|,
name|LocalAuthCommand
block|,
name|LOCAL_NO_AUTH
block|,
literal|"Password for manipulation"
block|,
literal|"passwd LocalPassword"
block|}
block|,
block|{
literal|"load"
block|,
name|NULL
block|,
name|LoadCommand
block|,
name|LOCAL_AUTH
block|,
literal|"Load settings"
block|,
literal|"load [remote]"
block|}
block|,
block|{
literal|"save"
block|,
name|NULL
block|,
name|SaveCommand
block|,
name|LOCAL_AUTH
block|,
literal|"Save settings"
block|,
literal|"save"
block|}
block|,
block|{
literal|"set"
block|,
literal|"setup"
block|,
name|SetCommand
block|,
name|LOCAL_AUTH
block|,
literal|"Set parameters"
block|,
literal|"set[up] var value"
block|}
block|,
block|{
literal|"shell"
block|,
literal|"!"
block|,
name|FgShellCommand
block|,
name|LOCAL_AUTH
block|,
literal|"Run a subshell"
block|,
literal|"shell|! [sh command]"
block|}
block|,
block|{
literal|"show"
block|,
name|NULL
block|,
name|ShowCommand
block|,
name|LOCAL_AUTH
block|,
literal|"Show status and stats"
block|,
literal|"show var"
block|}
block|,
block|{
literal|"term"
block|,
name|NULL
block|,
name|TerminalCommand
block|,
name|LOCAL_AUTH
block|,
literal|"Enter terminal mode"
block|,
literal|"term"
block|}
block|,
ifndef|#
directive|ifndef
name|NOALIAS
block|{
literal|"alias"
block|,
name|NULL
block|,
name|AliasCommand
block|,
name|LOCAL_AUTH
block|,
literal|"alias control"
block|,
literal|"alias option [yes|no]"
block|}
block|,
endif|#
directive|endif
block|{
literal|"quit"
block|,
literal|"bye"
block|,
name|QuitCommand
block|,
name|LOCAL_AUTH
operator||
name|LOCAL_NO_AUTH
block|,
literal|"Quit PPP program"
block|,
literal|"quit|bye [all]"
block|}
block|,
block|{
literal|"help"
block|,
literal|"?"
block|,
name|HelpCommand
block|,
name|LOCAL_AUTH
operator||
name|LOCAL_NO_AUTH
block|,
literal|"Display this message"
block|,
literal|"help|? [command]"
block|,
name|Commands
block|}
block|,
block|{
name|NULL
block|,
literal|"down"
block|,
name|DownCommand
block|,
name|LOCAL_AUTH
block|,
literal|"Generate down event"
block|,
literal|"down"
block|}
block|,
block|{
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|ShowLoopback
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
block|{
if|if
condition|(
name|VarTerm
condition|)
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"Local loopback is %s\n"
argument_list|,
name|VarLoopback
condition|?
literal|"on"
else|:
literal|"off"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ShowLogLevel
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|VarTerm
condition|)
return|return
literal|0
return|;
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"Log:  "
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|LogMIN
init|;
name|i
operator|<=
name|LogMAX
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|LogIsKept
argument_list|(
name|i
argument_list|)
operator|&
name|LOG_KEPT_SYSLOG
condition|)
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|" %s"
argument_list|,
name|LogName
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"\nLocal:"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|LogMIN
init|;
name|i
operator|<=
name|LogMAX
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|LogIsKept
argument_list|(
name|i
argument_list|)
operator|&
name|LOG_KEPT_LOCAL
condition|)
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|" %s"
argument_list|,
name|LogName
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ShowEscape
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
block|{
name|int
name|code
decl_stmt|,
name|bit
decl_stmt|;
if|if
condition|(
operator|!
name|VarTerm
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|EscMap
index|[
literal|32
index|]
condition|)
block|{
for|for
control|(
name|code
operator|=
literal|0
init|;
name|code
operator|<
literal|32
condition|;
name|code
operator|++
control|)
if|if
condition|(
name|EscMap
index|[
name|code
index|]
condition|)
for|for
control|(
name|bit
operator|=
literal|0
init|;
name|bit
operator|<
literal|8
condition|;
name|bit
operator|++
control|)
if|if
condition|(
name|EscMap
index|[
name|code
index|]
operator|&
operator|(
literal|1
operator|<<
name|bit
operator|)
condition|)
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|" 0x%02x"
argument_list|,
operator|(
name|code
operator|<<
literal|3
operator|)
operator|+
name|bit
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ShowTimeout
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
block|{
if|if
condition|(
name|VarTerm
condition|)
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|" Idle Timer: %d secs   LQR Timer: %d secs"
literal|"   Retry Timer: %d secs\n"
argument_list|,
name|VarIdleTimeout
argument_list|,
name|VarLqrTimeout
argument_list|,
name|VarRetryTimeout
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ShowStopped
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
block|{
if|if
condition|(
operator|!
name|VarTerm
condition|)
return|return
literal|0
return|;
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|" Stopped Timer:  LCP: "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|LcpFsm
operator|.
name|StoppedTimer
operator|.
name|load
condition|)
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"Disabled"
argument_list|)
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"%ld secs"
argument_list|,
name|LcpFsm
operator|.
name|StoppedTimer
operator|.
name|load
operator|/
name|SECTICKS
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|", IPCP: "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|IpcpFsm
operator|.
name|StoppedTimer
operator|.
name|load
condition|)
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"Disabled"
argument_list|)
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"%ld secs"
argument_list|,
name|IpcpFsm
operator|.
name|StoppedTimer
operator|.
name|load
operator|/
name|SECTICKS
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|", CCP: "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|CcpFsm
operator|.
name|StoppedTimer
operator|.
name|load
condition|)
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"Disabled"
argument_list|)
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"%ld secs"
argument_list|,
name|CcpFsm
operator|.
name|StoppedTimer
operator|.
name|load
operator|/
name|SECTICKS
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ShowAuthKey
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
block|{
if|if
condition|(
operator|!
name|VarTerm
condition|)
return|return
literal|0
return|;
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"AuthName = %s\n"
argument_list|,
name|VarAuthName
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"AuthKey  = %s\n"
argument_list|,
name|HIDDEN
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|HAVE_DES
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"Encrypt  = %s\n"
argument_list|,
name|VarMSChap
condition|?
literal|"MSChap"
else|:
literal|"MD5"
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ShowVersion
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
block|{
if|if
condition|(
name|VarTerm
condition|)
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"%s - %s \n"
argument_list|,
name|VarVersion
argument_list|,
name|VarLocalVersion
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ShowInitialMRU
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
block|{
if|if
condition|(
name|VarTerm
condition|)
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|" Initial MRU: %ld\n"
argument_list|,
name|VarMRU
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ShowPreferredMTU
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
block|{
if|if
condition|(
name|VarTerm
condition|)
if|if
condition|(
name|VarPrefMTU
condition|)
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|" Preferred MTU: %ld\n"
argument_list|,
name|VarPrefMTU
argument_list|)
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|" Preferred MTU: unspecified\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ShowReconnect
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
block|{
if|if
condition|(
name|VarTerm
condition|)
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|" Reconnect Timer:  %d,  %d tries\n"
argument_list|,
name|VarReconnectTimer
argument_list|,
name|VarReconnectTries
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ShowRedial
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
block|{
if|if
condition|(
operator|!
name|VarTerm
condition|)
return|return
literal|0
return|;
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|" Redial Timer: "
argument_list|)
expr_stmt|;
if|if
condition|(
name|VarRedialTimeout
operator|>=
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|" %d seconds, "
argument_list|,
name|VarRedialTimeout
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|" Random 0 - %d seconds, "
argument_list|,
name|REDIAL_PERIOD
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|" Redial Next Timer: "
argument_list|)
expr_stmt|;
if|if
condition|(
name|VarRedialNextTimeout
operator|>=
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|" %d seconds, "
argument_list|,
name|VarRedialNextTimeout
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|" Random 0 - %d seconds, "
argument_list|,
name|REDIAL_PERIOD
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|VarDialTries
condition|)
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"%d dial tries"
argument_list|,
name|VarDialTries
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|NOMSEXT
end_ifndef

begin_function
specifier|static
name|int
name|ShowMSExt
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
block|{
if|if
condition|(
name|VarTerm
condition|)
block|{
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|" MS PPP extention values \n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"   Primary NS     : %s\n"
argument_list|,
name|inet_ntoa
argument_list|(
name|ns_entries
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"   Secondary NS   : %s\n"
argument_list|,
name|inet_ntoa
argument_list|(
name|ns_entries
index|[
literal|1
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"   Primary NBNS   : %s\n"
argument_list|,
name|inet_ntoa
argument_list|(
name|nbns_entries
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"   Secondary NBNS : %s\n"
argument_list|,
name|inet_ntoa
argument_list|(
name|nbns_entries
index|[
literal|1
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|static
name|struct
name|cmdtab
specifier|const
name|ShowCommands
index|[]
init|=
block|{
block|{
literal|"afilter"
block|,
name|NULL
block|,
name|ShowAfilter
block|,
name|LOCAL_AUTH
block|,
literal|"Show keep-alive filters"
block|,
literal|"show afilter option .."
block|}
block|,
block|{
literal|"auth"
block|,
name|NULL
block|,
name|ShowAuthKey
block|,
name|LOCAL_AUTH
block|,
literal|"Show auth details"
block|,
literal|"show auth"
block|}
block|,
block|{
literal|"ccp"
block|,
name|NULL
block|,
name|ReportCcpStatus
block|,
name|LOCAL_AUTH
block|,
literal|"Show CCP status"
block|,
literal|"show cpp"
block|}
block|,
block|{
literal|"compress"
block|,
name|NULL
block|,
name|ReportCompress
block|,
name|LOCAL_AUTH
block|,
literal|"Show compression stats"
block|,
literal|"show compress"
block|}
block|,
block|{
literal|"dfilter"
block|,
name|NULL
block|,
name|ShowDfilter
block|,
name|LOCAL_AUTH
block|,
literal|"Show Demand filters"
block|,
literal|"show dfilteroption .."
block|}
block|,
block|{
literal|"escape"
block|,
name|NULL
block|,
name|ShowEscape
block|,
name|LOCAL_AUTH
block|,
literal|"Show escape characters"
block|,
literal|"show escape"
block|}
block|,
block|{
literal|"hdlc"
block|,
name|NULL
block|,
name|ReportHdlcStatus
block|,
name|LOCAL_AUTH
block|,
literal|"Show HDLC errors"
block|,
literal|"show hdlc"
block|}
block|,
block|{
literal|"ifilter"
block|,
name|NULL
block|,
name|ShowIfilter
block|,
name|LOCAL_AUTH
block|,
literal|"Show Input filters"
block|,
literal|"show ifilter option .."
block|}
block|,
block|{
literal|"ipcp"
block|,
name|NULL
block|,
name|ReportIpcpStatus
block|,
name|LOCAL_AUTH
block|,
literal|"Show IPCP status"
block|,
literal|"show ipcp"
block|}
block|,
block|{
literal|"lcp"
block|,
name|NULL
block|,
name|ReportLcpStatus
block|,
name|LOCAL_AUTH
block|,
literal|"Show LCP status"
block|,
literal|"show lcp"
block|}
block|,
block|{
literal|"loopback"
block|,
name|NULL
block|,
name|ShowLoopback
block|,
name|LOCAL_AUTH
block|,
literal|"Show loopback setting"
block|,
literal|"show loopback"
block|}
block|,
block|{
literal|"log"
block|,
name|NULL
block|,
name|ShowLogLevel
block|,
name|LOCAL_AUTH
block|,
literal|"Show log levels"
block|,
literal|"show log"
block|}
block|,
block|{
literal|"mem"
block|,
name|NULL
block|,
name|ShowMemMap
block|,
name|LOCAL_AUTH
block|,
literal|"Show memory map"
block|,
literal|"show mem"
block|}
block|,
block|{
literal|"modem"
block|,
name|NULL
block|,
name|ShowModemStatus
block|,
name|LOCAL_AUTH
block|,
literal|"Show modem setups"
block|,
literal|"show modem"
block|}
block|,
block|{
literal|"mru"
block|,
name|NULL
block|,
name|ShowInitialMRU
block|,
name|LOCAL_AUTH
block|,
literal|"Show Initial MRU"
block|,
literal|"show mru"
block|}
block|,
block|{
literal|"mtu"
block|,
name|NULL
block|,
name|ShowPreferredMTU
block|,
name|LOCAL_AUTH
block|,
literal|"Show Preferred MTU"
block|,
literal|"show mtu"
block|}
block|,
block|{
literal|"ofilter"
block|,
name|NULL
block|,
name|ShowOfilter
block|,
name|LOCAL_AUTH
block|,
literal|"Show Output filters"
block|,
literal|"show ofilter option .."
block|}
block|,
block|{
literal|"proto"
block|,
name|NULL
block|,
name|ReportProtStatus
block|,
name|LOCAL_AUTH
block|,
literal|"Show protocol summary"
block|,
literal|"show proto"
block|}
block|,
block|{
literal|"reconnect"
block|,
name|NULL
block|,
name|ShowReconnect
block|,
name|LOCAL_AUTH
block|,
literal|"Show reconnect timer"
block|,
literal|"show reconnect"
block|}
block|,
block|{
literal|"redial"
block|,
name|NULL
block|,
name|ShowRedial
block|,
name|LOCAL_AUTH
block|,
literal|"Show Redial timeout"
block|,
literal|"show redial"
block|}
block|,
block|{
literal|"route"
block|,
name|NULL
block|,
name|ShowRoute
block|,
name|LOCAL_AUTH
block|,
literal|"Show routing table"
block|,
literal|"show route"
block|}
block|,
block|{
literal|"timeout"
block|,
name|NULL
block|,
name|ShowTimeout
block|,
name|LOCAL_AUTH
block|,
literal|"Show Idle timeout"
block|,
literal|"show timeout"
block|}
block|,
block|{
literal|"stopped"
block|,
name|NULL
block|,
name|ShowStopped
block|,
name|LOCAL_AUTH
block|,
literal|"Show STOPPED timeout"
block|,
literal|"show stopped"
block|}
block|,
ifndef|#
directive|ifndef
name|NOMSEXT
block|{
literal|"msext"
block|,
name|NULL
block|,
name|ShowMSExt
block|,
name|LOCAL_AUTH
block|,
literal|"Show MS PPP extentions"
block|,
literal|"show msext"
block|}
block|,
endif|#
directive|endif
block|{
literal|"version"
block|,
name|NULL
block|,
name|ShowVersion
block|,
name|LOCAL_NO_AUTH
operator||
name|LOCAL_AUTH
block|,
literal|"Show version string"
block|,
literal|"show version"
block|}
block|,
block|{
literal|"help"
block|,
literal|"?"
block|,
name|HelpCommand
block|,
name|LOCAL_NO_AUTH
operator||
name|LOCAL_AUTH
block|,
literal|"Display this message"
block|,
literal|"show help|? [command]"
block|,
name|ShowCommands
block|}
block|,
block|{
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|struct
name|cmdtab
specifier|const
modifier|*
name|FindCommand
parameter_list|(
name|struct
name|cmdtab
specifier|const
modifier|*
name|cmds
parameter_list|,
specifier|const
name|char
modifier|*
name|str
parameter_list|,
name|int
modifier|*
name|pmatch
parameter_list|)
block|{
name|int
name|nmatch
decl_stmt|;
name|int
name|len
decl_stmt|;
name|struct
name|cmdtab
specifier|const
modifier|*
name|found
decl_stmt|;
name|found
operator|=
name|NULL
expr_stmt|;
name|len
operator|=
name|strlen
argument_list|(
name|str
argument_list|)
expr_stmt|;
name|nmatch
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|cmds
operator|->
name|func
condition|)
block|{
if|if
condition|(
name|cmds
operator|->
name|name
operator|&&
name|strncasecmp
argument_list|(
name|str
argument_list|,
name|cmds
operator|->
name|name
argument_list|,
name|len
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|cmds
operator|->
name|name
index|[
name|len
index|]
operator|==
literal|'\0'
condition|)
block|{
operator|*
name|pmatch
operator|=
literal|1
expr_stmt|;
return|return
name|cmds
return|;
block|}
name|nmatch
operator|++
expr_stmt|;
name|found
operator|=
name|cmds
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cmds
operator|->
name|alias
operator|&&
name|strncasecmp
argument_list|(
name|str
argument_list|,
name|cmds
operator|->
name|alias
argument_list|,
name|len
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|cmds
operator|->
name|alias
index|[
name|len
index|]
operator|==
literal|'\0'
condition|)
block|{
operator|*
name|pmatch
operator|=
literal|1
expr_stmt|;
return|return
name|cmds
return|;
block|}
name|nmatch
operator|++
expr_stmt|;
name|found
operator|=
name|cmds
expr_stmt|;
block|}
name|cmds
operator|++
expr_stmt|;
block|}
operator|*
name|pmatch
operator|=
name|nmatch
expr_stmt|;
return|return
name|found
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|FindExec
parameter_list|(
name|struct
name|cmdtab
specifier|const
modifier|*
name|cmds
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
specifier|const
modifier|*
specifier|const
modifier|*
name|argv
parameter_list|,
specifier|const
name|char
modifier|*
name|prefix
parameter_list|)
block|{
name|struct
name|cmdtab
specifier|const
modifier|*
name|cmd
decl_stmt|;
name|int
name|val
init|=
literal|1
decl_stmt|;
name|int
name|nmatch
decl_stmt|;
name|struct
name|cmdargs
name|arg
decl_stmt|;
name|cmd
operator|=
name|FindCommand
argument_list|(
name|cmds
argument_list|,
operator|*
name|argv
argument_list|,
operator|&
name|nmatch
argument_list|)
expr_stmt|;
if|if
condition|(
name|nmatch
operator|>
literal|1
condition|)
name|LogPrintf
argument_list|(
name|LogWARN
argument_list|,
literal|"%s%s: Ambiguous command\n"
argument_list|,
name|prefix
argument_list|,
operator|*
name|argv
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|cmd
operator|&&
operator|(
name|cmd
operator|->
name|lauth
operator|&
name|VarLocalAuth
operator|)
condition|)
block|{
name|arg
operator|.
name|cmd
operator|=
name|cmds
expr_stmt|;
name|arg
operator|.
name|argc
operator|=
name|argc
operator|-
literal|1
expr_stmt|;
name|arg
operator|.
name|argv
operator|=
name|argv
operator|+
literal|1
expr_stmt|;
name|arg
operator|.
name|data
operator|=
name|cmd
operator|->
name|args
expr_stmt|;
name|val
operator|=
call|(
name|cmd
operator|->
name|func
call|)
argument_list|(
operator|&
name|arg
argument_list|)
expr_stmt|;
block|}
else|else
name|LogPrintf
argument_list|(
name|LogWARN
argument_list|,
literal|"%s%s: Invalid command\n"
argument_list|,
name|prefix
argument_list|,
operator|*
name|argv
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|==
operator|-
literal|1
condition|)
name|LogPrintf
argument_list|(
name|LogWARN
argument_list|,
literal|"Usage: %s\n"
argument_list|,
name|cmd
operator|->
name|syntax
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|val
condition|)
name|LogPrintf
argument_list|(
name|LogWARN
argument_list|,
literal|"%s%s: Failed %d\n"
argument_list|,
name|prefix
argument_list|,
operator|*
name|argv
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
name|val
return|;
block|}
end_function

begin_decl_stmt
name|int
name|aft_cmd
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|Prompt
parameter_list|()
block|{
specifier|const
name|char
modifier|*
name|pconnect
decl_stmt|,
modifier|*
name|pauth
decl_stmt|;
if|if
condition|(
operator|!
name|VarTerm
operator|||
name|TermMode
condition|)
return|return;
if|if
condition|(
operator|!
name|aft_cmd
condition|)
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
else|else
name|aft_cmd
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|VarLocalAuth
operator|==
name|LOCAL_AUTH
condition|)
name|pauth
operator|=
literal|" ON "
expr_stmt|;
else|else
name|pauth
operator|=
literal|" on "
expr_stmt|;
if|if
condition|(
name|IpcpFsm
operator|.
name|state
operator|==
name|ST_OPENED
operator|&&
name|phase
operator|==
name|PHASE_NETWORK
condition|)
name|pconnect
operator|=
literal|"PPP"
expr_stmt|;
else|else
name|pconnect
operator|=
literal|"ppp"
expr_stmt|;
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"%s%s%s> "
argument_list|,
name|pconnect
argument_list|,
name|pauth
argument_list|,
name|VarShortHost
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|VarTerm
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|InterpretCommand
parameter_list|(
name|char
modifier|*
name|buff
parameter_list|,
name|int
name|nb
parameter_list|,
name|int
modifier|*
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
specifier|static
name|char
modifier|*
name|vector
index|[
name|MAXARGS
index|]
decl_stmt|;
name|char
modifier|*
name|cp
decl_stmt|;
if|if
condition|(
name|nb
operator|>
literal|0
condition|)
block|{
name|cp
operator|=
name|buff
operator|+
name|strcspn
argument_list|(
name|buff
argument_list|,
literal|"\r\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|cp
condition|)
operator|*
name|cp
operator|=
literal|'\0'
expr_stmt|;
operator|*
name|argc
operator|=
name|MakeArgs
argument_list|(
name|buff
argument_list|,
name|vector
argument_list|,
name|VECSIZE
argument_list|(
name|vector
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|argv
operator|=
name|vector
expr_stmt|;
block|}
else|else
operator|*
name|argc
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|arghidden
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
specifier|const
modifier|*
specifier|const
modifier|*
name|argv
parameter_list|,
name|int
name|n
parameter_list|)
block|{
comment|/* Is arg n of the given command to be hidden from the log ? */
comment|/* set authkey xxxxx */
comment|/* set key xxxxx */
if|if
condition|(
name|n
operator|==
literal|2
operator|&&
operator|!
name|strncasecmp
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"se"
argument_list|,
literal|2
argument_list|)
operator|&&
operator|(
operator|!
name|strncasecmp
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
literal|"authk"
argument_list|,
literal|5
argument_list|)
operator|||
operator|!
name|strncasecmp
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
literal|"ke"
argument_list|,
literal|2
argument_list|)
operator|)
condition|)
return|return
literal|1
return|;
comment|/* passwd xxxxx */
if|if
condition|(
name|n
operator|==
literal|1
operator|&&
operator|!
name|strncasecmp
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"p"
argument_list|,
literal|1
argument_list|)
condition|)
return|return
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|RunCommand
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
specifier|const
modifier|*
specifier|const
modifier|*
name|argv
parameter_list|,
specifier|const
name|char
modifier|*
name|label
parameter_list|)
block|{
if|if
condition|(
name|argc
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|LogIsKept
argument_list|(
name|LogCOMMAND
argument_list|)
condition|)
block|{
specifier|static
name|char
name|buf
index|[
name|LINE_LEN
index|]
decl_stmt|;
name|int
name|f
decl_stmt|,
name|n
decl_stmt|;
operator|*
name|buf
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|label
condition|)
block|{
name|strncpy
argument_list|(
name|buf
argument_list|,
name|label
argument_list|,
sizeof|sizeof
name|buf
operator|-
literal|3
argument_list|)
expr_stmt|;
name|buf
index|[
sizeof|sizeof
name|buf
operator|-
literal|3
index|]
operator|=
literal|'\0'
expr_stmt|;
name|strcat
argument_list|(
name|buf
argument_list|,
literal|": "
argument_list|)
expr_stmt|;
block|}
name|n
operator|=
name|strlen
argument_list|(
name|buf
argument_list|)
expr_stmt|;
for|for
control|(
name|f
operator|=
literal|0
init|;
name|f
operator|<
name|argc
condition|;
name|f
operator|++
control|)
block|{
if|if
condition|(
name|n
operator|<
sizeof|sizeof
name|buf
operator|-
literal|1
operator|&&
name|f
condition|)
name|buf
index|[
name|n
operator|++
index|]
operator|=
literal|' '
expr_stmt|;
if|if
condition|(
name|arghidden
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|f
argument_list|)
condition|)
name|strncpy
argument_list|(
name|buf
operator|+
name|n
argument_list|,
name|HIDDEN
argument_list|,
sizeof|sizeof
name|buf
operator|-
name|n
operator|-
literal|1
argument_list|)
expr_stmt|;
else|else
name|strncpy
argument_list|(
name|buf
operator|+
name|n
argument_list|,
name|argv
index|[
name|f
index|]
argument_list|,
sizeof|sizeof
name|buf
operator|-
name|n
operator|-
literal|1
argument_list|)
expr_stmt|;
name|n
operator|+=
name|strlen
argument_list|(
name|buf
operator|+
name|n
argument_list|)
expr_stmt|;
block|}
name|LogPrintf
argument_list|(
name|LogCOMMAND
argument_list|,
literal|"%s\n"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
name|FindExec
argument_list|(
name|Commands
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|,
literal|""
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|DecodeCommand
parameter_list|(
name|char
modifier|*
name|buff
parameter_list|,
name|int
name|nb
parameter_list|,
specifier|const
name|char
modifier|*
name|label
parameter_list|)
block|{
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|InterpretCommand
argument_list|(
name|buff
argument_list|,
name|nb
argument_list|,
operator|&
name|argc
argument_list|,
operator|&
name|argv
argument_list|)
expr_stmt|;
name|RunCommand
argument_list|(
name|argc
argument_list|,
operator|(
name|char
specifier|const
operator|*
specifier|const
operator|*
operator|)
name|argv
argument_list|,
name|label
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|ShowCommand
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
block|{
if|if
condition|(
name|arg
operator|->
name|argc
operator|>
literal|0
condition|)
name|FindExec
argument_list|(
name|ShowCommands
argument_list|,
name|arg
operator|->
name|argc
argument_list|,
name|arg
operator|->
name|argv
argument_list|,
literal|"show "
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|VarTerm
condition|)
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"Use ``show ?'' to get a arg->cmd.\n"
argument_list|)
expr_stmt|;
else|else
name|LogPrintf
argument_list|(
name|LogWARN
argument_list|,
literal|"show command must have arguments\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|TerminalCommand
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
block|{
if|if
condition|(
name|LcpFsm
operator|.
name|state
operator|>
name|ST_CLOSED
condition|)
block|{
if|if
condition|(
name|VarTerm
condition|)
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"LCP state is [%s]\n"
argument_list|,
name|StateNames
index|[
name|LcpFsm
operator|.
name|state
index|]
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
if|if
condition|(
operator|!
name|IsInteractive
argument_list|(
literal|1
argument_list|)
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
name|OpenModem
argument_list|()
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|VarTerm
condition|)
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"Failed to open modem.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|VarTerm
condition|)
block|{
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"Enter to terminal mode.\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"Type `~?' for help.\n"
argument_list|)
expr_stmt|;
block|}
name|TtyTermMode
argument_list|()
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|QuitCommand
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
block|{
if|if
condition|(
name|VarTerm
condition|)
block|{
name|DropClient
argument_list|()
expr_stmt|;
if|if
condition|(
name|mode
operator|&
name|MODE_INTER
condition|)
name|Cleanup
argument_list|(
name|EX_NORMAL
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|arg
operator|->
name|argc
operator|>
literal|0
operator|&&
operator|!
name|strcasecmp
argument_list|(
operator|*
name|arg
operator|->
name|argv
argument_list|,
literal|"all"
argument_list|)
operator|&&
name|VarLocalAuth
operator|&
name|LOCAL_AUTH
condition|)
name|Cleanup
argument_list|(
name|EX_NORMAL
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|CloseCommand
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
block|{
name|reconnect
argument_list|(
name|RECON_FALSE
argument_list|)
expr_stmt|;
name|LcpClose
argument_list|()
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|DownCommand
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
block|{
name|LcpDown
argument_list|()
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|SetModemSpeed
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
block|{
name|int
name|speed
decl_stmt|;
if|if
condition|(
name|arg
operator|->
name|argc
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|strcasecmp
argument_list|(
operator|*
name|arg
operator|->
name|argv
argument_list|,
literal|"sync"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|VarSpeed
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
name|speed
operator|=
name|atoi
argument_list|(
operator|*
name|arg
operator|->
name|argv
argument_list|)
expr_stmt|;
if|if
condition|(
name|IntToSpeed
argument_list|(
name|speed
argument_list|)
operator|!=
name|B0
condition|)
block|{
name|VarSpeed
operator|=
name|speed
expr_stmt|;
return|return
literal|0
return|;
block|}
name|LogPrintf
argument_list|(
name|LogWARN
argument_list|,
literal|"%s: Invalid speed\n"
argument_list|,
operator|*
name|arg
operator|->
name|argv
argument_list|)
expr_stmt|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|SetReconnect
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
block|{
if|if
condition|(
name|arg
operator|->
name|argc
operator|==
literal|2
condition|)
block|{
name|VarReconnectTimer
operator|=
name|atoi
argument_list|(
name|arg
operator|->
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|VarReconnectTries
operator|=
name|atoi
argument_list|(
name|arg
operator|->
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|SetRedialTimeout
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
block|{
name|int
name|timeout
decl_stmt|;
name|int
name|tries
decl_stmt|;
name|char
modifier|*
name|dot
decl_stmt|;
if|if
condition|(
name|arg
operator|->
name|argc
operator|==
literal|1
operator|||
name|arg
operator|->
name|argc
operator|==
literal|2
condition|)
block|{
if|if
condition|(
name|strncasecmp
argument_list|(
name|arg
operator|->
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"random"
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
operator|&&
operator|(
name|arg
operator|->
name|argv
index|[
literal|0
index|]
index|[
literal|6
index|]
operator|==
literal|'\0'
operator|||
name|arg
operator|->
name|argv
index|[
literal|0
index|]
index|[
literal|6
index|]
operator|==
literal|'.'
operator|)
condition|)
block|{
name|VarRedialTimeout
operator|=
operator|-
literal|1
expr_stmt|;
name|randinit
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|timeout
operator|=
name|atoi
argument_list|(
name|arg
operator|->
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|timeout
operator|>=
literal|0
condition|)
name|VarRedialTimeout
operator|=
name|timeout
expr_stmt|;
else|else
block|{
name|LogPrintf
argument_list|(
name|LogWARN
argument_list|,
literal|"Invalid redial timeout\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
name|dot
operator|=
name|strchr
argument_list|(
name|arg
operator|->
name|argv
index|[
literal|0
index|]
argument_list|,
literal|'.'
argument_list|)
expr_stmt|;
if|if
condition|(
name|dot
condition|)
block|{
if|if
condition|(
name|strcasecmp
argument_list|(
operator|++
name|dot
argument_list|,
literal|"random"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|VarRedialNextTimeout
operator|=
operator|-
literal|1
expr_stmt|;
name|randinit
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|timeout
operator|=
name|atoi
argument_list|(
name|dot
argument_list|)
expr_stmt|;
if|if
condition|(
name|timeout
operator|>=
literal|0
condition|)
name|VarRedialNextTimeout
operator|=
name|timeout
expr_stmt|;
else|else
block|{
name|LogPrintf
argument_list|(
name|LogWARN
argument_list|,
literal|"Invalid next redial timeout\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
block|}
else|else
name|VarRedialNextTimeout
operator|=
name|NEXT_REDIAL_PERIOD
expr_stmt|;
comment|/* Default next timeout */
if|if
condition|(
name|arg
operator|->
name|argc
operator|==
literal|2
condition|)
block|{
name|tries
operator|=
name|atoi
argument_list|(
name|arg
operator|->
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|tries
operator|>=
literal|0
condition|)
block|{
name|VarDialTries
operator|=
name|tries
expr_stmt|;
block|}
else|else
block|{
name|LogPrintf
argument_list|(
name|LogWARN
argument_list|,
literal|"Invalid retry value\n"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|SetStoppedTimeout
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
block|{
name|LcpFsm
operator|.
name|StoppedTimer
operator|.
name|load
operator|=
literal|0
expr_stmt|;
name|IpcpFsm
operator|.
name|StoppedTimer
operator|.
name|load
operator|=
literal|0
expr_stmt|;
name|CcpFsm
operator|.
name|StoppedTimer
operator|.
name|load
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|arg
operator|->
name|argc
operator|<=
literal|3
condition|)
block|{
if|if
condition|(
name|arg
operator|->
name|argc
operator|>
literal|0
condition|)
block|{
name|LcpFsm
operator|.
name|StoppedTimer
operator|.
name|load
operator|=
name|atoi
argument_list|(
name|arg
operator|->
name|argv
index|[
literal|0
index|]
argument_list|)
operator|*
name|SECTICKS
expr_stmt|;
if|if
condition|(
name|arg
operator|->
name|argc
operator|>
literal|1
condition|)
block|{
name|IpcpFsm
operator|.
name|StoppedTimer
operator|.
name|load
operator|=
name|atoi
argument_list|(
name|arg
operator|->
name|argv
index|[
literal|1
index|]
argument_list|)
operator|*
name|SECTICKS
expr_stmt|;
if|if
condition|(
name|arg
operator|->
name|argc
operator|>
literal|2
condition|)
name|CcpFsm
operator|.
name|StoppedTimer
operator|.
name|load
operator|=
name|atoi
argument_list|(
name|arg
operator|->
name|argv
index|[
literal|2
index|]
argument_list|)
operator|*
name|SECTICKS
expr_stmt|;
block|}
block|}
return|return
literal|0
return|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_define
define|#
directive|define
name|ismask
parameter_list|(
name|x
parameter_list|)
define|\
value|(*x == '0'&& strlen(x) == 4&& strspn(x+1, "0123456789.") == 3)
end_define

begin_function
specifier|static
name|int
name|SetServer
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
block|{
name|int
name|res
init|=
operator|-
literal|1
decl_stmt|;
if|if
condition|(
name|arg
operator|->
name|argc
operator|>
literal|0
operator|&&
name|arg
operator|->
name|argc
operator|<
literal|4
condition|)
block|{
specifier|const
name|char
modifier|*
name|port
decl_stmt|,
modifier|*
name|passwd
decl_stmt|,
modifier|*
name|mask
decl_stmt|;
comment|/* What's what ? */
name|port
operator|=
name|arg
operator|->
name|argv
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|arg
operator|->
name|argc
operator|==
literal|2
condition|)
if|if
condition|(
name|ismask
argument_list|(
name|arg
operator|->
name|argv
index|[
literal|1
index|]
argument_list|)
condition|)
block|{
name|passwd
operator|=
name|NULL
expr_stmt|;
name|mask
operator|=
name|arg
operator|->
name|argv
index|[
literal|1
index|]
expr_stmt|;
block|}
else|else
block|{
name|passwd
operator|=
name|arg
operator|->
name|argv
index|[
literal|1
index|]
expr_stmt|;
name|mask
operator|=
name|NULL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|arg
operator|->
name|argc
operator|==
literal|3
condition|)
block|{
name|passwd
operator|=
name|arg
operator|->
name|argv
index|[
literal|1
index|]
expr_stmt|;
name|mask
operator|=
name|arg
operator|->
name|argv
index|[
literal|2
index|]
expr_stmt|;
if|if
condition|(
operator|!
name|ismask
argument_list|(
name|mask
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
block|}
else|else
name|passwd
operator|=
name|mask
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|passwd
operator|==
name|NULL
condition|)
name|VarHaveLocalAuthKey
operator|=
literal|0
expr_stmt|;
else|else
block|{
name|strncpy
argument_list|(
name|VarLocalAuthKey
argument_list|,
name|passwd
argument_list|,
sizeof|sizeof
name|VarLocalAuthKey
operator|-
literal|1
argument_list|)
expr_stmt|;
name|VarLocalAuthKey
index|[
sizeof|sizeof
name|VarLocalAuthKey
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|VarHaveLocalAuthKey
operator|=
literal|1
expr_stmt|;
block|}
name|LocalAuthInit
argument_list|()
expr_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|port
argument_list|,
literal|"none"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|int
name|oserver
decl_stmt|;
if|if
condition|(
name|mask
operator|!=
name|NULL
operator|||
name|passwd
operator|!=
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|oserver
operator|=
name|server
expr_stmt|;
name|ServerClose
argument_list|()
expr_stmt|;
if|if
condition|(
name|oserver
operator|!=
operator|-
literal|1
condition|)
name|LogPrintf
argument_list|(
name|LogPHASE
argument_list|,
literal|"Disabling server port.\n"
argument_list|)
expr_stmt|;
name|res
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|*
name|port
operator|==
literal|'/'
condition|)
block|{
name|mode_t
name|imask
decl_stmt|;
if|if
condition|(
name|mask
operator|!=
name|NULL
condition|)
block|{
name|unsigned
name|m
decl_stmt|;
if|if
condition|(
name|sscanf
argument_list|(
name|mask
argument_list|,
literal|"%o"
argument_list|,
operator|&
name|m
argument_list|)
operator|==
literal|1
condition|)
name|imask
operator|=
name|m
expr_stmt|;
else|else
return|return
operator|-
literal|1
return|;
block|}
else|else
name|imask
operator|=
operator|(
name|mode_t
operator|)
operator|-
literal|1
expr_stmt|;
name|res
operator|=
name|ServerLocalOpen
argument_list|(
name|port
argument_list|,
name|imask
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|int
name|iport
decl_stmt|;
if|if
condition|(
name|mask
operator|!=
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|strspn
argument_list|(
name|port
argument_list|,
literal|"0123456789"
argument_list|)
operator|!=
name|strlen
argument_list|(
name|port
argument_list|)
condition|)
block|{
name|struct
name|servent
modifier|*
name|s
decl_stmt|;
if|if
condition|(
operator|(
name|s
operator|=
name|getservbyname
argument_list|(
name|port
argument_list|,
literal|"tcp"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|iport
operator|=
literal|0
expr_stmt|;
name|LogPrintf
argument_list|(
name|LogWARN
argument_list|,
literal|"%s: Invalid port or service\n"
argument_list|,
name|port
argument_list|)
expr_stmt|;
block|}
else|else
name|iport
operator|=
name|ntohs
argument_list|(
name|s
operator|->
name|s_port
argument_list|)
expr_stmt|;
block|}
else|else
name|iport
operator|=
name|atoi
argument_list|(
name|port
argument_list|)
expr_stmt|;
name|res
operator|=
name|iport
condition|?
name|ServerTcpOpen
argument_list|(
name|iport
argument_list|)
else|:
operator|-
literal|1
expr_stmt|;
block|}
block|}
return|return
name|res
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|SetModemParity
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
block|{
return|return
name|arg
operator|->
name|argc
operator|>
literal|0
condition|?
name|ChangeParity
argument_list|(
operator|*
name|arg
operator|->
name|argv
argument_list|)
else|:
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|SetLogLevel
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|res
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
specifier|const
modifier|*
specifier|const
modifier|*
name|argv
decl_stmt|,
modifier|*
name|argp
decl_stmt|;
name|void
argument_list|(
operator|*
name|Discard
argument_list|)
argument_list|(
name|int
argument_list|)
decl_stmt|,
argument_list|(
operator|*
name|Keep
argument_list|)
argument_list|(
name|int
argument_list|)
decl_stmt|;
name|void
function_decl|(
modifier|*
name|DiscardAll
function_decl|)
parameter_list|(
name|void
parameter_list|)
function_decl|;
name|argc
operator|=
name|arg
operator|->
name|argc
expr_stmt|;
name|argv
operator|=
name|arg
operator|->
name|argv
expr_stmt|;
name|res
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|argc
operator|==
literal|0
operator|||
name|strcasecmp
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"local"
argument_list|)
condition|)
block|{
name|Discard
operator|=
name|LogDiscard
expr_stmt|;
name|Keep
operator|=
name|LogKeep
expr_stmt|;
name|DiscardAll
operator|=
name|LogDiscardAll
expr_stmt|;
block|}
else|else
block|{
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
name|Discard
operator|=
name|LogDiscardLocal
expr_stmt|;
name|Keep
operator|=
name|LogKeepLocal
expr_stmt|;
name|DiscardAll
operator|=
name|LogDiscardAllLocal
expr_stmt|;
block|}
if|if
condition|(
name|argc
operator|==
literal|0
operator|||
operator|(
name|argv
index|[
literal|0
index|]
index|[
literal|0
index|]
operator|!=
literal|'+'
operator|&&
name|argv
index|[
literal|0
index|]
index|[
literal|0
index|]
operator|!=
literal|'-'
operator|)
condition|)
name|DiscardAll
argument_list|()
expr_stmt|;
while|while
condition|(
name|argc
operator|--
condition|)
block|{
name|argp
operator|=
operator|*
operator|*
name|argv
operator|==
literal|'+'
operator|||
operator|*
operator|*
name|argv
operator|==
literal|'-'
condition|?
operator|*
name|argv
operator|+
literal|1
else|:
operator|*
name|argv
expr_stmt|;
for|for
control|(
name|i
operator|=
name|LogMIN
init|;
name|i
operator|<=
name|LogMAX
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|strcasecmp
argument_list|(
name|argp
argument_list|,
name|LogName
argument_list|(
name|i
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|*
operator|*
name|argv
operator|==
literal|'-'
condition|)
call|(
modifier|*
name|Discard
call|)
argument_list|(
name|i
argument_list|)
expr_stmt|;
else|else
call|(
modifier|*
name|Keep
call|)
argument_list|(
name|i
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|i
operator|>
name|LogMAX
condition|)
block|{
name|LogPrintf
argument_list|(
name|LogWARN
argument_list|,
literal|"%s: Invalid log value\n"
argument_list|,
name|argp
argument_list|)
expr_stmt|;
name|res
operator|=
operator|-
literal|1
expr_stmt|;
block|}
name|argv
operator|++
expr_stmt|;
block|}
return|return
name|res
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|SetEscape
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
block|{
name|int
name|code
decl_stmt|;
name|int
name|argc
init|=
name|arg
operator|->
name|argc
decl_stmt|;
name|char
specifier|const
modifier|*
specifier|const
modifier|*
name|argv
init|=
name|arg
operator|->
name|argv
decl_stmt|;
for|for
control|(
name|code
operator|=
literal|0
init|;
name|code
operator|<
literal|33
condition|;
name|code
operator|++
control|)
name|EscMap
index|[
name|code
index|]
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|argc
operator|--
operator|>
literal|0
condition|)
block|{
name|sscanf
argument_list|(
operator|*
name|argv
operator|++
argument_list|,
literal|"%x"
argument_list|,
operator|&
name|code
argument_list|)
expr_stmt|;
name|code
operator|&=
literal|0xff
expr_stmt|;
name|EscMap
index|[
name|code
operator|>>
literal|3
index|]
operator||=
operator|(
literal|1
operator|<<
operator|(
name|code
operator|&
literal|7
operator|)
operator|)
expr_stmt|;
name|EscMap
index|[
literal|32
index|]
operator|=
literal|1
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|SetInitialMRU
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
block|{
name|long
name|mru
decl_stmt|;
specifier|const
name|char
modifier|*
name|err
decl_stmt|;
if|if
condition|(
name|arg
operator|->
name|argc
operator|>
literal|0
condition|)
block|{
name|mru
operator|=
name|atol
argument_list|(
operator|*
name|arg
operator|->
name|argv
argument_list|)
expr_stmt|;
if|if
condition|(
name|mru
operator|<
name|MIN_MRU
condition|)
name|err
operator|=
literal|"Given MRU value (%ld) is too small.\n"
expr_stmt|;
elseif|else
if|if
condition|(
name|mru
operator|>
name|MAX_MRU
condition|)
name|err
operator|=
literal|"Given MRU value (%ld) is too big.\n"
expr_stmt|;
else|else
block|{
name|VarMRU
operator|=
name|mru
expr_stmt|;
return|return
literal|0
return|;
block|}
name|LogPrintf
argument_list|(
name|LogWARN
argument_list|,
name|err
argument_list|,
name|mru
argument_list|)
expr_stmt|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|SetPreferredMTU
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
block|{
name|long
name|mtu
decl_stmt|;
specifier|const
name|char
modifier|*
name|err
decl_stmt|;
if|if
condition|(
name|arg
operator|->
name|argc
operator|>
literal|0
condition|)
block|{
name|mtu
operator|=
name|atol
argument_list|(
operator|*
name|arg
operator|->
name|argv
argument_list|)
expr_stmt|;
if|if
condition|(
name|mtu
operator|==
literal|0
condition|)
block|{
name|VarPrefMTU
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
elseif|else
if|if
condition|(
name|mtu
operator|<
name|MIN_MTU
condition|)
name|err
operator|=
literal|"Given MTU value (%ld) is too small.\n"
expr_stmt|;
elseif|else
if|if
condition|(
name|mtu
operator|>
name|MAX_MTU
condition|)
name|err
operator|=
literal|"Given MTU value (%ld) is too big.\n"
expr_stmt|;
else|else
block|{
name|VarPrefMTU
operator|=
name|mtu
expr_stmt|;
return|return
literal|0
return|;
block|}
name|LogPrintf
argument_list|(
name|LogWARN
argument_list|,
name|err
argument_list|,
name|mtu
argument_list|)
expr_stmt|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|SetIdleTimeout
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
block|{
if|if
condition|(
name|arg
operator|->
name|argc
operator|>
literal|0
condition|)
block|{
name|VarIdleTimeout
operator|=
name|atoi
argument_list|(
name|arg
operator|->
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|UpdateIdleTimer
argument_list|()
expr_stmt|;
comment|/* If we're connected, restart the idle timer */
if|if
condition|(
name|arg
operator|->
name|argc
operator|>
literal|1
condition|)
block|{
name|VarLqrTimeout
operator|=
name|atoi
argument_list|(
name|arg
operator|->
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|VarLqrTimeout
operator|<
literal|1
condition|)
name|VarLqrTimeout
operator|=
literal|30
expr_stmt|;
if|if
condition|(
name|arg
operator|->
name|argc
operator|>
literal|2
condition|)
block|{
name|VarRetryTimeout
operator|=
name|atoi
argument_list|(
name|arg
operator|->
name|argv
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|VarRetryTimeout
operator|<
literal|1
operator|||
name|VarRetryTimeout
operator|>
literal|10
condition|)
name|VarRetryTimeout
operator|=
literal|3
expr_stmt|;
block|}
block|}
return|return
literal|0
return|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|in_addr
name|GetIpAddr
parameter_list|(
specifier|const
name|char
modifier|*
name|cp
parameter_list|)
block|{
name|struct
name|hostent
modifier|*
name|hp
decl_stmt|;
name|struct
name|in_addr
name|ipaddr
decl_stmt|;
name|hp
operator|=
name|gethostbyname
argument_list|(
name|cp
argument_list|)
expr_stmt|;
if|if
condition|(
name|hp
operator|&&
name|hp
operator|->
name|h_addrtype
operator|==
name|AF_INET
condition|)
name|memcpy
argument_list|(
operator|&
name|ipaddr
argument_list|,
name|hp
operator|->
name|h_addr
argument_list|,
name|hp
operator|->
name|h_length
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|inet_aton
argument_list|(
name|cp
argument_list|,
operator|&
name|ipaddr
argument_list|)
operator|==
literal|0
condition|)
name|ipaddr
operator|.
name|s_addr
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|ipaddr
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|SetInterfaceAddr
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
block|{
name|DefMyAddress
operator|.
name|ipaddr
operator|.
name|s_addr
operator|=
name|DefHisAddress
operator|.
name|ipaddr
operator|.
name|s_addr
operator|=
literal|0L
expr_stmt|;
if|if
condition|(
name|arg
operator|->
name|argc
operator|>
literal|4
condition|)
return|return
operator|-
literal|1
return|;
name|HaveTriggerAddress
operator|=
literal|0
expr_stmt|;
name|ifnetmask
operator|.
name|s_addr
operator|=
literal|0
expr_stmt|;
name|iplist_reset
argument_list|(
operator|&
name|DefHisChoice
argument_list|)
expr_stmt|;
if|if
condition|(
name|arg
operator|->
name|argc
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|ParseAddr
argument_list|(
name|arg
operator|->
name|argc
argument_list|,
name|arg
operator|->
name|argv
argument_list|,
operator|&
name|DefMyAddress
operator|.
name|ipaddr
argument_list|,
operator|&
name|DefMyAddress
operator|.
name|mask
argument_list|,
operator|&
name|DefMyAddress
operator|.
name|width
argument_list|)
condition|)
return|return
literal|1
return|;
if|if
condition|(
name|arg
operator|->
name|argc
operator|>
literal|1
condition|)
block|{
if|if
condition|(
name|strpbrk
argument_list|(
name|arg
operator|->
name|argv
index|[
literal|1
index|]
argument_list|,
literal|",-"
argument_list|)
condition|)
name|iplist_setsrc
argument_list|(
operator|&
name|DefHisChoice
argument_list|,
name|arg
operator|->
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|ParseAddr
argument_list|(
name|arg
operator|->
name|argc
argument_list|,
name|arg
operator|->
name|argv
operator|+
literal|1
argument_list|,
operator|&
name|DefHisAddress
operator|.
name|ipaddr
argument_list|,
operator|&
name|DefHisAddress
operator|.
name|mask
argument_list|,
operator|&
name|DefHisAddress
operator|.
name|width
argument_list|)
condition|)
return|return
literal|2
return|;
if|if
condition|(
name|arg
operator|->
name|argc
operator|>
literal|2
condition|)
block|{
name|ifnetmask
operator|=
name|GetIpAddr
argument_list|(
name|arg
operator|->
name|argv
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|arg
operator|->
name|argc
operator|>
literal|3
condition|)
block|{
name|TriggerAddress
operator|=
name|GetIpAddr
argument_list|(
name|arg
operator|->
name|argv
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|HaveTriggerAddress
operator|=
literal|1
expr_stmt|;
block|}
block|}
block|}
block|}
comment|/*    * For backwards compatibility, 0.0.0.0 means any address.    */
if|if
condition|(
name|DefMyAddress
operator|.
name|ipaddr
operator|.
name|s_addr
operator|==
literal|0
condition|)
block|{
name|DefMyAddress
operator|.
name|mask
operator|.
name|s_addr
operator|=
literal|0
expr_stmt|;
name|DefMyAddress
operator|.
name|width
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|DefHisAddress
operator|.
name|ipaddr
operator|.
name|s_addr
operator|==
literal|0
condition|)
block|{
name|DefHisAddress
operator|.
name|mask
operator|.
name|s_addr
operator|=
literal|0
expr_stmt|;
name|DefHisAddress
operator|.
name|width
operator|=
literal|0
expr_stmt|;
block|}
name|IpcpInfo
operator|.
name|want_ipaddr
operator|.
name|s_addr
operator|=
name|DefMyAddress
operator|.
name|ipaddr
operator|.
name|s_addr
expr_stmt|;
if|if
condition|(
name|iplist_isvalid
argument_list|(
operator|&
name|DefHisChoice
argument_list|)
condition|)
block|{
name|iplist_setrandpos
argument_list|(
operator|&
name|DefHisChoice
argument_list|)
expr_stmt|;
name|IpcpInfo
operator|.
name|his_ipaddr
operator|=
name|ChooseHisAddr
argument_list|(
name|IpcpInfo
operator|.
name|want_ipaddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|IpcpInfo
operator|.
name|his_ipaddr
operator|.
name|s_addr
operator|==
name|INADDR_ANY
condition|)
block|{
name|LogPrintf
argument_list|(
name|LogWARN
argument_list|,
literal|"%s: None available !\n"
argument_list|,
name|DefHisChoice
operator|.
name|src
argument_list|)
expr_stmt|;
return|return
literal|3
return|;
block|}
name|DefHisAddress
operator|.
name|ipaddr
operator|.
name|s_addr
operator|=
name|IpcpInfo
operator|.
name|his_ipaddr
operator|.
name|s_addr
expr_stmt|;
name|DefHisAddress
operator|.
name|mask
operator|.
name|s_addr
operator|=
literal|0xffffffff
expr_stmt|;
name|DefHisAddress
operator|.
name|width
operator|=
literal|32
expr_stmt|;
block|}
else|else
block|{
name|IpcpInfo
operator|.
name|his_ipaddr
operator|.
name|s_addr
operator|=
name|DefHisAddress
operator|.
name|ipaddr
operator|.
name|s_addr
expr_stmt|;
if|if
condition|(
operator|(
name|mode
operator|&
name|MODE_AUTO
operator|)
operator|&&
name|OsSetIpaddress
argument_list|(
name|DefMyAddress
operator|.
name|ipaddr
argument_list|,
name|DefHisAddress
operator|.
name|ipaddr
argument_list|)
operator|<
literal|0
condition|)
block|{
name|DefMyAddress
operator|.
name|ipaddr
operator|.
name|s_addr
operator|=
name|DefHisAddress
operator|.
name|ipaddr
operator|.
name|s_addr
operator|=
literal|0L
expr_stmt|;
return|return
literal|4
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|NOMSEXT
end_ifndef

begin_function
specifier|static
name|void
name|SetMSEXT
parameter_list|(
name|struct
name|in_addr
modifier|*
name|pri_addr
parameter_list|,
name|struct
name|in_addr
modifier|*
name|sec_addr
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
specifier|const
modifier|*
specifier|const
modifier|*
name|argv
parameter_list|)
block|{
name|int
name|dummyint
decl_stmt|;
name|struct
name|in_addr
name|dummyaddr
decl_stmt|;
name|pri_addr
operator|->
name|s_addr
operator|=
name|sec_addr
operator|->
name|s_addr
operator|=
literal|0L
expr_stmt|;
if|if
condition|(
name|argc
operator|>
literal|0
condition|)
block|{
name|ParseAddr
argument_list|(
name|argc
argument_list|,
name|argv
operator|++
argument_list|,
name|pri_addr
argument_list|,
operator|&
name|dummyaddr
argument_list|,
operator|&
name|dummyint
argument_list|)
expr_stmt|;
if|if
condition|(
operator|--
name|argc
operator|>
literal|0
condition|)
name|ParseAddr
argument_list|(
name|argc
argument_list|,
name|argv
operator|++
argument_list|,
name|sec_addr
argument_list|,
operator|&
name|dummyaddr
argument_list|,
operator|&
name|dummyint
argument_list|)
expr_stmt|;
else|else
name|sec_addr
operator|->
name|s_addr
operator|=
name|pri_addr
operator|->
name|s_addr
expr_stmt|;
block|}
comment|/*    * if the primary/secondary ns entries are 0.0.0.0 we should set them to    * either the localhost's ip, or the values in /etc/resolv.conf ??    *     * up to you if you want to implement this...    */
block|}
end_function

begin_function
specifier|static
name|int
name|SetNS
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
block|{
name|SetMSEXT
argument_list|(
operator|&
name|ns_entries
index|[
literal|0
index|]
argument_list|,
operator|&
name|ns_entries
index|[
literal|1
index|]
argument_list|,
name|arg
operator|->
name|argc
argument_list|,
name|arg
operator|->
name|argv
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|SetNBNS
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
block|{
name|SetMSEXT
argument_list|(
operator|&
name|nbns_entries
index|[
literal|0
index|]
argument_list|,
operator|&
name|nbns_entries
index|[
literal|1
index|]
argument_list|,
name|arg
operator|->
name|argc
argument_list|,
name|arg
operator|->
name|argv
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* MS_EXT */
end_comment

begin_function
name|int
name|SetVariable
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
block|{
name|u_long
name|map
decl_stmt|;
specifier|const
name|char
modifier|*
name|argp
decl_stmt|;
name|int
name|param
init|=
operator|(
name|int
operator|)
name|arg
operator|->
name|data
decl_stmt|;
if|if
condition|(
name|arg
operator|->
name|argc
operator|>
literal|0
condition|)
name|argp
operator|=
operator|*
name|arg
operator|->
name|argv
expr_stmt|;
else|else
name|argp
operator|=
literal|""
expr_stmt|;
switch|switch
condition|(
name|param
condition|)
block|{
case|case
name|VAR_AUTHKEY
case|:
name|strncpy
argument_list|(
name|VarAuthKey
argument_list|,
name|argp
argument_list|,
sizeof|sizeof
name|VarAuthKey
operator|-
literal|1
argument_list|)
expr_stmt|;
name|VarAuthKey
index|[
sizeof|sizeof
name|VarAuthKey
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
break|break;
case|case
name|VAR_AUTHNAME
case|:
name|strncpy
argument_list|(
name|VarAuthName
argument_list|,
name|argp
argument_list|,
sizeof|sizeof
name|VarAuthName
operator|-
literal|1
argument_list|)
expr_stmt|;
name|VarAuthName
index|[
sizeof|sizeof
name|VarAuthName
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
break|break;
case|case
name|VAR_DIAL
case|:
name|strncpy
argument_list|(
name|VarDialScript
argument_list|,
name|argp
argument_list|,
sizeof|sizeof
name|VarDialScript
operator|-
literal|1
argument_list|)
expr_stmt|;
name|VarDialScript
index|[
sizeof|sizeof
name|VarDialScript
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
break|break;
case|case
name|VAR_LOGIN
case|:
name|strncpy
argument_list|(
name|VarLoginScript
argument_list|,
name|argp
argument_list|,
sizeof|sizeof
name|VarLoginScript
operator|-
literal|1
argument_list|)
expr_stmt|;
name|VarLoginScript
index|[
sizeof|sizeof
name|VarLoginScript
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
break|break;
case|case
name|VAR_DEVICE
case|:
if|if
condition|(
name|modem
operator|!=
operator|-
literal|1
condition|)
name|LogPrintf
argument_list|(
name|LogWARN
argument_list|,
literal|"Cannot change device to \"%s\" when \"%s\" is open\n"
argument_list|,
name|argp
argument_list|,
name|VarDevice
argument_list|)
expr_stmt|;
else|else
block|{
name|strncpy
argument_list|(
name|VarDeviceList
argument_list|,
name|argp
argument_list|,
sizeof|sizeof
name|VarDeviceList
operator|-
literal|1
argument_list|)
expr_stmt|;
name|VarDeviceList
index|[
sizeof|sizeof
name|VarDeviceList
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
break|break;
case|case
name|VAR_ACCMAP
case|:
name|sscanf
argument_list|(
name|argp
argument_list|,
literal|"%lx"
argument_list|,
operator|&
name|map
argument_list|)
expr_stmt|;
name|VarAccmap
operator|=
name|map
expr_stmt|;
break|break;
case|case
name|VAR_PHONE
case|:
name|strncpy
argument_list|(
name|VarPhoneList
argument_list|,
name|argp
argument_list|,
sizeof|sizeof
name|VarPhoneList
operator|-
literal|1
argument_list|)
expr_stmt|;
name|VarPhoneList
index|[
sizeof|sizeof
name|VarPhoneList
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|strncpy
argument_list|(
name|VarPhoneCopy
argument_list|,
name|VarPhoneList
argument_list|,
sizeof|sizeof
name|VarPhoneCopy
operator|-
literal|1
argument_list|)
expr_stmt|;
name|VarPhoneCopy
index|[
sizeof|sizeof
name|VarPhoneCopy
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|VarNextPhone
operator|=
name|VarPhoneCopy
expr_stmt|;
name|VarAltPhone
operator|=
name|NULL
expr_stmt|;
break|break;
case|case
name|VAR_HANGUP
case|:
name|strncpy
argument_list|(
name|VarHangupScript
argument_list|,
name|argp
argument_list|,
sizeof|sizeof
name|VarHangupScript
operator|-
literal|1
argument_list|)
expr_stmt|;
name|VarHangupScript
index|[
sizeof|sizeof
name|VarHangupScript
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|HAVE_DES
case|case
name|VAR_ENC
case|:
name|VarMSChap
operator|=
operator|!
name|strcasecmp
argument_list|(
name|argp
argument_list|,
literal|"mschap"
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|SetCtsRts
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
block|{
if|if
condition|(
name|arg
operator|->
name|argc
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|arg
operator|->
name|argv
argument_list|,
literal|"on"
argument_list|)
operator|==
literal|0
condition|)
name|VarCtsRts
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|arg
operator|->
name|argv
argument_list|,
literal|"off"
argument_list|)
operator|==
literal|0
condition|)
name|VarCtsRts
operator|=
literal|0
expr_stmt|;
else|else
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|SetOpenMode
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
block|{
if|if
condition|(
name|arg
operator|->
name|argc
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|arg
operator|->
name|argv
argument_list|,
literal|"active"
argument_list|)
operator|==
literal|0
condition|)
name|VarOpenMode
operator|=
name|OPEN_ACTIVE
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|arg
operator|->
name|argv
argument_list|,
literal|"passive"
argument_list|)
operator|==
literal|0
condition|)
name|VarOpenMode
operator|=
name|OPEN_PASSIVE
expr_stmt|;
else|else
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|struct
name|cmdtab
specifier|const
name|SetCommands
index|[]
init|=
block|{
block|{
literal|"accmap"
block|,
name|NULL
block|,
name|SetVariable
block|,
name|LOCAL_AUTH
block|,
literal|"Set accmap value"
block|,
literal|"set accmap hex-value"
block|,
operator|(
specifier|const
name|void
operator|*
operator|)
name|VAR_ACCMAP
block|}
block|,
block|{
literal|"afilter"
block|,
name|NULL
block|,
name|SetAfilter
block|,
name|LOCAL_AUTH
block|,
literal|"Set keep Alive filter"
block|,
literal|"set afilter ..."
block|}
block|,
block|{
literal|"authkey"
block|,
literal|"key"
block|,
name|SetVariable
block|,
name|LOCAL_AUTH
block|,
literal|"Set authentication key"
block|,
literal|"set authkey|key key"
block|,
operator|(
specifier|const
name|void
operator|*
operator|)
name|VAR_AUTHKEY
block|}
block|,
block|{
literal|"authname"
block|,
name|NULL
block|,
name|SetVariable
block|,
name|LOCAL_AUTH
block|,
literal|"Set authentication name"
block|,
literal|"set authname name"
block|,
operator|(
specifier|const
name|void
operator|*
operator|)
name|VAR_AUTHNAME
block|}
block|,
block|{
literal|"ctsrts"
block|,
name|NULL
block|,
name|SetCtsRts
block|,
name|LOCAL_AUTH
block|,
literal|"Use CTS/RTS modem signalling"
block|,
literal|"set ctsrts [on|off]"
block|}
block|,
block|{
literal|"device"
block|,
literal|"line"
block|,
name|SetVariable
block|,
name|LOCAL_AUTH
block|,
literal|"Set modem device name"
block|,
literal|"set device|line device-name[,device-name]"
block|,
operator|(
specifier|const
name|void
operator|*
operator|)
name|VAR_DEVICE
block|}
block|,
block|{
literal|"dfilter"
block|,
name|NULL
block|,
name|SetDfilter
block|,
name|LOCAL_AUTH
block|,
literal|"Set demand filter"
block|,
literal|"set dfilter ..."
block|}
block|,
block|{
literal|"dial"
block|,
name|NULL
block|,
name|SetVariable
block|,
name|LOCAL_AUTH
block|,
literal|"Set dialing script"
block|,
literal|"set dial chat-script"
block|,
operator|(
specifier|const
name|void
operator|*
operator|)
name|VAR_DIAL
block|}
block|,
ifdef|#
directive|ifdef
name|HAVE_DES
block|{
literal|"encrypt"
block|,
name|NULL
block|,
name|SetVariable
block|,
name|LOCAL_AUTH
block|,
literal|"Set CHAP encryption algorithm"
block|,
literal|"set encrypt MSChap|MD5"
block|,
operator|(
specifier|const
name|void
operator|*
operator|)
name|VAR_ENC
block|}
block|,
endif|#
directive|endif
block|{
literal|"escape"
block|,
name|NULL
block|,
name|SetEscape
block|,
name|LOCAL_AUTH
block|,
literal|"Set escape characters"
block|,
literal|"set escape hex-digit ..."
block|}
block|,
block|{
literal|"hangup"
block|,
name|NULL
block|,
name|SetVariable
block|,
name|LOCAL_AUTH
block|,
literal|"Set hangup script"
block|,
literal|"set hangup chat-script"
block|,
operator|(
specifier|const
name|void
operator|*
operator|)
name|VAR_HANGUP
block|}
block|,
block|{
literal|"ifaddr"
block|,
name|NULL
block|,
name|SetInterfaceAddr
block|,
name|LOCAL_AUTH
block|,
literal|"Set destination address"
block|,
literal|"set ifaddr [src-addr [dst-addr [netmask [trg-addr]]]]"
block|}
block|,
block|{
literal|"ifilter"
block|,
name|NULL
block|,
name|SetIfilter
block|,
name|LOCAL_AUTH
block|,
literal|"Set input filter"
block|,
literal|"set ifilter ..."
block|}
block|,
block|{
literal|"loopback"
block|,
name|NULL
block|,
name|SetLoopback
block|,
name|LOCAL_AUTH
block|,
literal|"Set loopback facility"
block|,
literal|"set loopback on|off"
block|}
block|,
block|{
literal|"log"
block|,
name|NULL
block|,
name|SetLogLevel
block|,
name|LOCAL_AUTH
block|,
literal|"Set log level"
block|,
literal|"set log [local] [+|-]value..."
block|}
block|,
block|{
literal|"login"
block|,
name|NULL
block|,
name|SetVariable
block|,
name|LOCAL_AUTH
block|,
literal|"Set login script"
block|,
literal|"set login chat-script"
block|,
operator|(
specifier|const
name|void
operator|*
operator|)
name|VAR_LOGIN
block|}
block|,
block|{
literal|"mru"
block|,
name|NULL
block|,
name|SetInitialMRU
block|,
name|LOCAL_AUTH
block|,
literal|"Set Initial MRU value"
block|,
literal|"set mru value"
block|}
block|,
block|{
literal|"mtu"
block|,
name|NULL
block|,
name|SetPreferredMTU
block|,
name|LOCAL_AUTH
block|,
literal|"Set Preferred MTU value"
block|,
literal|"set mtu value"
block|}
block|,
block|{
literal|"ofilter"
block|,
name|NULL
block|,
name|SetOfilter
block|,
name|LOCAL_AUTH
block|,
literal|"Set output filter"
block|,
literal|"set ofilter ..."
block|}
block|,
block|{
literal|"openmode"
block|,
name|NULL
block|,
name|SetOpenMode
block|,
name|LOCAL_AUTH
block|,
literal|"Set open mode"
block|,
literal|"set openmode [active|passive]"
block|}
block|,
block|{
literal|"parity"
block|,
name|NULL
block|,
name|SetModemParity
block|,
name|LOCAL_AUTH
block|,
literal|"Set modem parity"
block|,
literal|"set parity [odd|even|none]"
block|}
block|,
block|{
literal|"phone"
block|,
name|NULL
block|,
name|SetVariable
block|,
name|LOCAL_AUTH
block|,
literal|"Set telephone number(s)"
block|,
literal|"set phone phone1[:phone2[...]]"
block|,
operator|(
specifier|const
name|void
operator|*
operator|)
name|VAR_PHONE
block|}
block|,
block|{
literal|"reconnect"
block|,
name|NULL
block|,
name|SetReconnect
block|,
name|LOCAL_AUTH
block|,
literal|"Set Reconnect timeout"
block|,
literal|"set reconnect value ntries"
block|}
block|,
block|{
literal|"redial"
block|,
name|NULL
block|,
name|SetRedialTimeout
block|,
name|LOCAL_AUTH
block|,
literal|"Set Redial timeout"
block|,
literal|"set redial value|random[.value|random] [dial_attempts]"
block|}
block|,
block|{
literal|"stopped"
block|,
name|NULL
block|,
name|SetStoppedTimeout
block|,
name|LOCAL_AUTH
block|,
literal|"Set STOPPED timeouts"
block|,
literal|"set stopped [LCPseconds [IPCPseconds [CCPseconds]]]"
block|}
block|,
block|{
literal|"server"
block|,
literal|"socket"
block|,
name|SetServer
block|,
name|LOCAL_AUTH
block|,
literal|"Set server port"
block|,
literal|"set server|socket TcpPort|LocalName|none [mask]"
block|}
block|,
block|{
literal|"speed"
block|,
name|NULL
block|,
name|SetModemSpeed
block|,
name|LOCAL_AUTH
block|,
literal|"Set modem speed"
block|,
literal|"set speed value"
block|}
block|,
block|{
literal|"timeout"
block|,
name|NULL
block|,
name|SetIdleTimeout
block|,
name|LOCAL_AUTH
block|,
literal|"Set Idle timeout"
block|,
literal|"set timeout value"
block|}
block|,
ifndef|#
directive|ifndef
name|NOMSEXT
block|{
literal|"ns"
block|,
name|NULL
block|,
name|SetNS
block|,
name|LOCAL_AUTH
block|,
literal|"Set NameServer"
block|,
literal|"set ns pri-addr [sec-addr]"
block|}
block|,
block|{
literal|"nbns"
block|,
name|NULL
block|,
name|SetNBNS
block|,
name|LOCAL_AUTH
block|,
literal|"Set NetBIOS NameServer"
block|,
literal|"set nbns pri-addr [sec-addr]"
block|}
block|,
endif|#
directive|endif
block|{
literal|"help"
block|,
literal|"?"
block|,
name|HelpCommand
block|,
name|LOCAL_AUTH
operator||
name|LOCAL_NO_AUTH
block|,
literal|"Display this message"
block|,
literal|"set help|? [command]"
block|,
name|SetCommands
block|}
block|,
block|{
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|SetCommand
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
block|{
if|if
condition|(
name|arg
operator|->
name|argc
operator|>
literal|0
condition|)
name|FindExec
argument_list|(
name|SetCommands
argument_list|,
name|arg
operator|->
name|argc
argument_list|,
name|arg
operator|->
name|argv
argument_list|,
literal|"set "
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|VarTerm
condition|)
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"Use `set ?' to get a arg->cmd or `set ?<var>' for"
literal|" syntax help.\n"
argument_list|)
expr_stmt|;
else|else
name|LogPrintf
argument_list|(
name|LogWARN
argument_list|,
literal|"set command must have arguments\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|AddCommand
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|in_addr
name|dest
decl_stmt|,
name|gateway
decl_stmt|,
name|netmask
decl_stmt|;
name|int
name|gw
decl_stmt|;
if|if
condition|(
name|arg
operator|->
name|argc
operator|!=
literal|3
operator|&&
name|arg
operator|->
name|argc
operator|!=
literal|2
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|arg
operator|->
name|argc
operator|==
literal|2
condition|)
if|if
condition|(
name|strcasecmp
argument_list|(
name|arg
operator|->
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"default"
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
else|else
block|{
name|dest
operator|.
name|s_addr
operator|=
name|netmask
operator|.
name|s_addr
operator|=
name|INADDR_ANY
expr_stmt|;
name|gw
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|strcasecmp
argument_list|(
name|arg
operator|->
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"MYADDR"
argument_list|)
operator|==
literal|0
condition|)
name|dest
operator|=
name|IpcpInfo
operator|.
name|want_ipaddr
expr_stmt|;
else|else
name|dest
operator|=
name|GetIpAddr
argument_list|(
name|arg
operator|->
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|netmask
operator|=
name|GetIpAddr
argument_list|(
name|arg
operator|->
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|gw
operator|=
literal|2
expr_stmt|;
block|}
if|if
condition|(
name|strcasecmp
argument_list|(
name|arg
operator|->
name|argv
index|[
name|gw
index|]
argument_list|,
literal|"HISADDR"
argument_list|)
operator|==
literal|0
condition|)
name|gateway
operator|=
name|IpcpInfo
operator|.
name|his_ipaddr
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|arg
operator|->
name|argv
index|[
name|gw
index|]
argument_list|,
literal|"INTERFACE"
argument_list|)
operator|==
literal|0
condition|)
name|gateway
operator|.
name|s_addr
operator|=
name|INADDR_ANY
expr_stmt|;
else|else
name|gateway
operator|=
name|GetIpAddr
argument_list|(
name|arg
operator|->
name|argv
index|[
name|gw
index|]
argument_list|)
expr_stmt|;
name|OsSetRoute
argument_list|(
name|RTM_ADD
argument_list|,
name|dest
argument_list|,
name|gateway
argument_list|,
name|netmask
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|DeleteCommand
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|in_addr
name|dest
decl_stmt|,
name|none
decl_stmt|;
if|if
condition|(
name|arg
operator|->
name|argc
operator|==
literal|1
condition|)
if|if
condition|(
name|strcasecmp
argument_list|(
name|arg
operator|->
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"all"
argument_list|)
operator|==
literal|0
condition|)
name|DeleteIfRoutes
argument_list|(
literal|0
argument_list|)
expr_stmt|;
else|else
block|{
if|if
condition|(
name|strcasecmp
argument_list|(
name|arg
operator|->
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"MYADDR"
argument_list|)
operator|==
literal|0
condition|)
name|dest
operator|=
name|IpcpInfo
operator|.
name|want_ipaddr
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|arg
operator|->
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"default"
argument_list|)
operator|==
literal|0
condition|)
name|dest
operator|.
name|s_addr
operator|=
name|INADDR_ANY
expr_stmt|;
else|else
name|dest
operator|=
name|GetIpAddr
argument_list|(
name|arg
operator|->
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|none
operator|.
name|s_addr
operator|=
name|INADDR_ANY
expr_stmt|;
name|OsSetRoute
argument_list|(
name|RTM_DELETE
argument_list|,
name|dest
argument_list|,
name|none
argument_list|,
name|none
argument_list|)
expr_stmt|;
block|}
else|else
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|NOALIAS
end_ifndef

begin_decl_stmt
specifier|static
name|struct
name|cmdtab
specifier|const
name|AliasCommands
index|[]
init|=
block|{
block|{
literal|"enable"
block|,
name|NULL
block|,
name|AliasEnable
block|,
name|LOCAL_AUTH
block|,
literal|"enable IP aliasing"
block|,
literal|"alias enable [yes|no]"
block|}
block|,
block|{
literal|"port"
block|,
name|NULL
block|,
name|AliasRedirectPort
block|,
name|LOCAL_AUTH
block|,
literal|"port redirection"
block|,
literal|"alias port [proto addr_local:port_local  port_alias]"
block|}
block|,
block|{
literal|"addr"
block|,
name|NULL
block|,
name|AliasRedirectAddr
block|,
name|LOCAL_AUTH
block|,
literal|"static address translation"
block|,
literal|"alias addr [addr_local addr_alias]"
block|}
block|,
block|{
literal|"deny_incoming"
block|,
name|NULL
block|,
name|AliasOption
block|,
name|LOCAL_AUTH
block|,
literal|"stop incoming connections"
block|,
literal|"alias deny_incoming [yes|no]"
block|,
operator|(
specifier|const
name|void
operator|*
operator|)
name|PKT_ALIAS_DENY_INCOMING
block|}
block|,
block|{
literal|"log"
block|,
name|NULL
block|,
name|AliasOption
block|,
name|LOCAL_AUTH
block|,
literal|"log aliasing link creation"
block|,
literal|"alias log [yes|no]"
block|,
operator|(
specifier|const
name|void
operator|*
operator|)
name|PKT_ALIAS_LOG
block|}
block|,
block|{
literal|"same_ports"
block|,
name|NULL
block|,
name|AliasOption
block|,
name|LOCAL_AUTH
block|,
literal|"try to leave port numbers unchanged"
block|,
literal|"alias same_ports [yes|no]"
block|,
operator|(
specifier|const
name|void
operator|*
operator|)
name|PKT_ALIAS_SAME_PORTS
block|}
block|,
block|{
literal|"use_sockets"
block|,
name|NULL
block|,
name|AliasOption
block|,
name|LOCAL_AUTH
block|,
literal|"allocate host sockets"
block|,
literal|"alias use_sockets [yes|no]"
block|,
operator|(
specifier|const
name|void
operator|*
operator|)
name|PKT_ALIAS_USE_SOCKETS
block|}
block|,
block|{
literal|"unregistered_only"
block|,
name|NULL
block|,
name|AliasOption
block|,
name|LOCAL_AUTH
block|,
literal|"alias unregistered (private) IP address space only"
block|,
literal|"alias unregistered_only [yes|no]"
block|,
operator|(
specifier|const
name|void
operator|*
operator|)
name|PKT_ALIAS_UNREGISTERED_ONLY
block|}
block|,
block|{
literal|"help"
block|,
literal|"?"
block|,
name|HelpCommand
block|,
name|LOCAL_AUTH
operator||
name|LOCAL_NO_AUTH
block|,
literal|"Display this message"
block|,
literal|"alias help|? [command]"
block|,
name|AliasCommands
block|}
block|,
block|{
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|AliasCommand
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
block|{
if|if
condition|(
name|arg
operator|->
name|argc
operator|>
literal|0
condition|)
name|FindExec
argument_list|(
name|AliasCommands
argument_list|,
name|arg
operator|->
name|argc
argument_list|,
name|arg
operator|->
name|argv
argument_list|,
literal|"alias "
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|VarTerm
condition|)
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"Use `alias help' to get a arg->cmd or `alias help<option>'"
literal|" for syntax help.\n"
argument_list|)
expr_stmt|;
else|else
name|LogPrintf
argument_list|(
name|LogWARN
argument_list|,
literal|"alias command must have arguments\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|AliasEnable
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
block|{
if|if
condition|(
name|arg
operator|->
name|argc
operator|==
literal|1
condition|)
if|if
condition|(
name|strcasecmp
argument_list|(
name|arg
operator|->
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"yes"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|mode
operator|&
name|MODE_ALIAS
operator|)
condition|)
block|{
if|if
condition|(
name|loadAliasHandlers
argument_list|(
operator|&
name|VarAliasHandlers
argument_list|)
operator|==
literal|0
condition|)
block|{
name|mode
operator||=
name|MODE_ALIAS
expr_stmt|;
return|return
literal|0
return|;
block|}
name|LogPrintf
argument_list|(
name|LogWARN
argument_list|,
literal|"Cannot load alias library\n"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|arg
operator|->
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"no"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|mode
operator|&
name|MODE_ALIAS
condition|)
block|{
name|unloadAliasHandlers
argument_list|()
expr_stmt|;
name|mode
operator|&=
operator|~
name|MODE_ALIAS
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|AliasOption
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
block|{
name|unsigned
name|param
init|=
operator|(
name|unsigned
operator|)
name|arg
operator|->
name|data
decl_stmt|;
if|if
condition|(
name|arg
operator|->
name|argc
operator|==
literal|1
condition|)
if|if
condition|(
name|strcasecmp
argument_list|(
name|arg
operator|->
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"yes"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|mode
operator|&
name|MODE_ALIAS
condition|)
block|{
name|VarPacketAliasSetMode
argument_list|(
name|param
argument_list|,
name|param
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|LogPrintf
argument_list|(
name|LogWARN
argument_list|,
literal|"alias not enabled\n"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|arg
operator|->
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"no"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|mode
operator|&
name|MODE_ALIAS
condition|)
block|{
name|VarPacketAliasSetMode
argument_list|(
literal|0
argument_list|,
name|param
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|LogPrintf
argument_list|(
name|LogWARN
argument_list|,
literal|"alias not enabled\n"
argument_list|)
expr_stmt|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* #ifndef NOALIAS */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|cmdtab
specifier|const
name|AllowCommands
index|[]
init|=
block|{
block|{
literal|"users"
block|,
literal|"user"
block|,
name|AllowUsers
block|,
name|LOCAL_AUTH
block|,
literal|"Allow users access to ppp"
block|,
literal|"allow users logname..."
block|}
block|,
block|{
literal|"modes"
block|,
literal|"mode"
block|,
name|AllowModes
block|,
name|LOCAL_AUTH
block|,
literal|"Only allow certain ppp modes"
block|,
literal|"allow modes mode..."
block|}
block|,
block|{
literal|"help"
block|,
literal|"?"
block|,
name|HelpCommand
block|,
name|LOCAL_AUTH
operator||
name|LOCAL_NO_AUTH
block|,
literal|"Display this message"
block|,
literal|"allow help|? [command]"
block|,
name|AllowCommands
block|}
block|,
block|{
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|AllowCommand
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
block|{
if|if
condition|(
name|arg
operator|->
name|argc
operator|>
literal|0
condition|)
name|FindExec
argument_list|(
name|AllowCommands
argument_list|,
name|arg
operator|->
name|argc
argument_list|,
name|arg
operator|->
name|argv
argument_list|,
literal|"allow "
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|VarTerm
condition|)
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"Use `allow ?' to get a arg->cmd or `allow ?<cmd>' for"
literal|" syntax help.\n"
argument_list|)
expr_stmt|;
else|else
name|LogPrintf
argument_list|(
name|LogWARN
argument_list|,
literal|"allow command must have arguments\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


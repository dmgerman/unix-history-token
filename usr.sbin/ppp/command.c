begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  *		PPP User command processing module  *  *	    Written by Toshiharu OHNO (tony-o@iij.ad.jp)  *  *   Copyright (C) 1993, Internet Initiative Japan, Inc. All rights reserverd.  *  * Redistribution and use in source and binary forms are permitted  * provided that the above copyright notice and this paragraph are  * duplicated in all such forms and that any documentation,  * advertising materials, and other materials related to such  * distribution and use acknowledge that the software was developed  * by the Internet Initiative Japan, Inc.  The name of the  * IIJ may not be used to endorse or promote products derived  * from this software without specific prior written permission.  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND WITHOUT ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED  * WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR A PARTICULAR PURPOSE.  *  * $Id:$  *  */
end_comment

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|"fsm.h"
end_include

begin_include
include|#
directive|include
file|"phase.h"
end_include

begin_include
include|#
directive|include
file|"lcp.h"
end_include

begin_include
include|#
directive|include
file|"ipcp.h"
end_include

begin_include
include|#
directive|include
file|"modem.h"
end_include

begin_include
include|#
directive|include
file|"command.h"
end_include

begin_include
include|#
directive|include
file|"hdlc.h"
end_include

begin_include
include|#
directive|include
file|"vars.h"
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<arpa/inet.h>
end_include

begin_include
include|#
directive|include
file|<net/route.h>
end_include

begin_include
include|#
directive|include
file|"os.h"
end_include

begin_function_decl
specifier|extern
name|int
name|MakeArgs
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
specifier|extern
name|void
name|Cleanup
argument_list|()
decl_stmt|,
name|TtyTermMode
argument_list|()
decl_stmt|,
name|PacketMode
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|EnableCommand
argument_list|()
decl_stmt|,
name|DisableCommand
argument_list|()
decl_stmt|,
name|DisplayCommand
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|AcceptCommand
argument_list|()
decl_stmt|,
name|DenyCommand
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|LoadCommand
argument_list|()
decl_stmt|,
name|SaveCommand
argument_list|()
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|extern
name|int
name|ChangeParity
parameter_list|(
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|int
name|SelectSystem
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|int
name|ShowRoute
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|struct
name|in_addr
name|ifnetmask
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|ShowCommand
argument_list|()
decl_stmt|,
name|TerminalCommand
argument_list|()
decl_stmt|,
name|QuitCommand
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|CloseCommand
argument_list|()
decl_stmt|,
name|DialCommand
argument_list|()
decl_stmt|,
name|DownCommand
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|SetCommand
argument_list|()
decl_stmt|,
name|AddCommand
argument_list|()
decl_stmt|,
name|DeleteCommand
argument_list|()
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|HelpCommand
parameter_list|(
name|list
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|,
name|plist
parameter_list|)
name|struct
name|cmdtab
modifier|*
name|list
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|struct
name|cmdtab
modifier|*
name|plist
decl_stmt|;
block|{
name|struct
name|cmdtab
modifier|*
name|cmd
decl_stmt|;
name|int
name|n
decl_stmt|;
name|char
name|c
decl_stmt|;
if|if
condition|(
name|argc
operator|>
literal|0
condition|)
block|{
for|for
control|(
name|cmd
operator|=
name|plist
init|;
name|cmd
operator|->
name|name
condition|;
name|cmd
operator|++
control|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|cmd
operator|->
name|name
argument_list|,
operator|*
name|argv
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s %s\n"
argument_list|,
name|cmd
operator|->
name|name
argument_list|,
name|cmd
operator|->
name|syntax
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|n
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|cmd
operator|=
name|plist
init|;
name|cmd
operator|->
name|func
condition|;
name|cmd
operator|++
control|)
block|{
name|c
operator|=
operator|(
name|n
operator|&
literal|1
operator|)
condition|?
literal|'\n'
else|:
literal|'\t'
expr_stmt|;
if|if
condition|(
name|cmd
operator|->
name|name
condition|)
block|{
name|printf
argument_list|(
literal|"  %-8s: %-20s%c"
argument_list|,
name|cmd
operator|->
name|name
argument_list|,
name|cmd
operator|->
name|helpmes
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|n
operator|++
expr_stmt|;
block|}
block|}
if|if
condition|(
name|n
operator|&
literal|1
condition|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
name|int
name|IsInteractive
parameter_list|()
block|{
name|char
modifier|*
name|mes
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|mode
operator|&
name|MODE_AUTO
condition|)
name|mes
operator|=
literal|"Working as auto mode."
expr_stmt|;
elseif|else
if|if
condition|(
name|mode
operator|&
name|MODE_DIRECT
condition|)
name|mes
operator|=
literal|"Working as direct mode."
expr_stmt|;
elseif|else
if|if
condition|(
name|mode
operator|&
name|MODE_DEDICATED
condition|)
name|mes
operator|=
literal|"Workring as dedicated mode."
expr_stmt|;
if|if
condition|(
name|mes
condition|)
block|{
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|mes
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|DialCommand
parameter_list|(
name|cmdlist
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|)
name|struct
name|cmdtab
modifier|*
name|cmdlist
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
if|if
condition|(
name|LcpFsm
operator|.
name|state
operator|>
name|ST_CLOSED
condition|)
block|{
name|printf
argument_list|(
literal|"LCP state is [%s]\n"
argument_list|,
name|StateNames
index|[
name|LcpFsm
operator|.
name|state
index|]
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
if|if
condition|(
operator|!
name|IsInteractive
argument_list|()
condition|)
return|return
operator|(
literal|1
operator|)
return|;
name|modem
operator|=
name|OpenModem
argument_list|(
name|mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|modem
operator|<
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"failed to open modem.\n"
argument_list|)
expr_stmt|;
name|modem
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|argc
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|SelectSystem
argument_list|(
operator|*
name|argv
argument_list|,
name|CONFFILE
argument_list|)
operator|<
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s: not found.\n"
argument_list|,
operator|*
name|argv
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
block|}
if|if
condition|(
name|DialModem
argument_list|()
condition|)
block|{
name|sleep
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|ModemTimeout
argument_list|()
expr_stmt|;
name|PacketMode
argument_list|()
expr_stmt|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|char
name|StrOption
index|[]
init|=
literal|"option .."
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|StrRemote
index|[]
init|=
literal|"[remote]"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|StrNull
index|[]
init|=
literal|""
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|cmdtab
name|Commands
index|[]
init|=
block|{
block|{
literal|"accept"
block|,
name|NULL
block|,
name|AcceptCommand
block|,
literal|"accept option request"
block|,
name|StrOption
block|}
block|,
block|{
literal|"add"
block|,
name|NULL
block|,
name|AddCommand
block|,
literal|"add route"
block|,
literal|"dest mask gateway"
block|}
block|,
block|{
literal|"close"
block|,
name|NULL
block|,
name|CloseCommand
block|,
literal|"Close connection"
block|,
name|StrNull
block|}
block|,
block|{
literal|"delete"
block|,
name|NULL
block|,
name|DeleteCommand
block|,
literal|"delete route"
block|,
literal|"dest gateway"
block|}
block|,
block|{
literal|"deny"
block|,
name|NULL
block|,
name|DenyCommand
block|,
literal|"Deny option request"
block|,
name|StrOption
block|}
block|,
block|{
literal|"dial"
block|,
literal|"call"
block|,
name|DialCommand
block|,
literal|"Dial and login"
block|,
name|StrRemote
block|}
block|,
block|{
literal|"disable"
block|,
name|NULL
block|,
name|DisableCommand
block|,
literal|"Disable option"
block|,
name|StrOption
block|}
block|,
block|{
literal|"display"
block|,
name|NULL
block|,
name|DisplayCommand
block|,
literal|"Display option configs"
block|,
name|StrNull
block|}
block|,
block|{
literal|"enable"
block|,
name|NULL
block|,
name|EnableCommand
block|,
literal|"Enable option"
block|,
name|StrOption
block|}
block|,
block|{
literal|"load"
block|,
name|NULL
block|,
name|LoadCommand
block|,
literal|"Load settings"
block|,
name|StrRemote
block|}
block|,
block|{
literal|"save"
block|,
name|NULL
block|,
name|SaveCommand
block|,
literal|"Save settings"
block|,
name|StrNull
block|}
block|,
block|{
literal|"set"
block|,
literal|"setup"
block|,
name|SetCommand
block|,
literal|"Set parameters"
block|,
literal|"var value"
block|}
block|,
block|{
literal|"show"
block|,
name|NULL
block|,
name|ShowCommand
block|,
literal|"Show status and statictics"
block|,
literal|"var"
block|}
block|,
block|{
literal|"term"
block|,
name|NULL
block|,
name|TerminalCommand
block|,
literal|"Enter to terminal mode"
block|,
name|StrNull
block|}
block|,
block|{
literal|"quit"
block|,
literal|"bye"
block|,
name|QuitCommand
block|,
literal|"Quit PPP program"
block|,
name|StrNull
block|}
block|,
block|{
literal|"help"
block|,
literal|"?"
block|,
name|HelpCommand
block|,
literal|"Display this message"
block|,
literal|"[command]"
block|,
operator|(
name|void
operator|*
operator|)
name|Commands
block|}
block|,
block|{
name|NULL
block|,
literal|"down"
block|,
name|DownCommand
block|,
literal|"Generate down event"
block|,
name|StrNull
block|}
block|,
block|{
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|extern
name|int
name|ReportCcpStatus
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|int
name|ReportLcpStatus
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|int
name|ReportIpcpStatus
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|int
name|ReportProtStatus
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|int
name|ReportCompress
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|int
name|ShowModemStatus
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|int
name|ReportHdlcStatus
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|int
name|ShowMemMap
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|char
modifier|*
name|LogLevelName
index|[]
init|=
block|{
name|LM_PHASE
block|,
name|LM_CHAT
block|,
name|LM_LQM
block|,
name|LM_LCP
block|,
name|LM_TCPIP
block|,
name|LM_HDLC
block|,
name|LM_ASYNC
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|ShowDebugLevel
parameter_list|()
block|{
name|int
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"%02x: "
argument_list|,
name|loglevel
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|LOG_PHASE
init|;
name|i
operator|<
name|MAXLOGLEVEL
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|loglevel
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
condition|)
name|printf
argument_list|(
literal|"%s "
argument_list|,
name|LogLevelName
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ShowEscape
parameter_list|()
block|{
name|int
name|code
decl_stmt|,
name|bit
decl_stmt|;
if|if
condition|(
name|EscMap
index|[
literal|32
index|]
condition|)
block|{
for|for
control|(
name|code
operator|=
literal|0
init|;
name|code
operator|<
literal|32
condition|;
name|code
operator|++
control|)
block|{
if|if
condition|(
name|EscMap
index|[
name|code
index|]
condition|)
block|{
for|for
control|(
name|bit
operator|=
literal|0
init|;
name|bit
operator|<
literal|8
condition|;
name|bit
operator|++
control|)
block|{
if|if
condition|(
name|EscMap
index|[
name|code
index|]
operator|&
operator|(
literal|1
operator|<<
name|bit
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|" 0x%02x"
argument_list|,
operator|(
name|code
operator|<<
literal|3
operator|)
operator|+
name|bit
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ShowTimeout
parameter_list|()
block|{
name|printf
argument_list|(
literal|" Idle Timer: %d secs   LQR Timer: %d secs\n"
argument_list|,
name|VarIdleTimeout
argument_list|,
name|VarLqrTimeout
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ShowAuthKey
parameter_list|()
block|{
name|printf
argument_list|(
literal|"AuthName = %s\n"
argument_list|,
name|VarAuthName
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"AuthKey  = %s\n"
argument_list|,
name|VarAuthKey
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ShowVersion
parameter_list|()
block|{
specifier|extern
name|char
modifier|*
name|VarVersion
index|[]
decl_stmt|;
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|VarVersion
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ShowLogList
parameter_list|()
block|{
name|ListLog
argument_list|()
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|extern
name|int
name|ShowIfilter
argument_list|()
decl_stmt|,
name|ShowOfilter
argument_list|()
decl_stmt|,
name|ShowDfilter
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|cmdtab
name|ShowCommands
index|[]
init|=
block|{
block|{
literal|"auth"
block|,
name|NULL
block|,
name|ShowAuthKey
block|,
literal|"Show auth name/key"
block|,
name|StrNull
block|, }
block|,
block|{
literal|"ccp"
block|,
name|NULL
block|,
name|ReportCcpStatus
block|,
literal|"Show CCP status"
block|,
name|StrNull
block|, }
block|,
block|{
literal|"compress"
block|,
name|NULL
block|,
name|ReportCompress
block|,
literal|"Show compression statictics"
block|,
name|StrNull
block|}
block|,
block|{
literal|"debug"
block|,
name|NULL
block|,
name|ShowDebugLevel
block|,
literal|"Show current debug level"
block|,
name|StrNull
block|}
block|,
block|{
literal|"dfilter"
block|,
name|NULL
block|,
name|ShowDfilter
block|,
literal|"Show Demand filters"
block|,
name|StrOption
block|}
block|,
block|{
literal|"escape"
block|,
name|NULL
block|,
name|ShowEscape
block|,
literal|"Show escape characters"
block|,
name|StrNull
block|}
block|,
block|{
literal|"hdlc"
block|,
name|NULL
block|,
name|ReportHdlcStatus
block|,
literal|"Show HDLC error summary"
block|,
name|StrNull
block|}
block|,
block|{
literal|"ifilter"
block|,
name|NULL
block|,
name|ShowIfilter
block|,
literal|"Show Input filters"
block|,
name|StrOption
block|}
block|,
block|{
literal|"ipcp"
block|,
name|NULL
block|,
name|ReportIpcpStatus
block|,
literal|"Show IPCP status"
block|,
name|StrNull
block|, }
block|,
block|{
literal|"lcp"
block|,
name|NULL
block|,
name|ReportLcpStatus
block|,
literal|"Show LCP status"
block|,
name|StrNull
block|, }
block|,
block|{
literal|"log"
block|,
name|NULL
block|,
name|ShowLogList
block|,
literal|"Show log records"
block|,
name|StrNull
block|, }
block|,
block|{
literal|"mem"
block|,
name|NULL
block|,
name|ShowMemMap
block|,
literal|"Show memory map"
block|,
name|StrNull
block|, }
block|,
block|{
literal|"modem"
block|,
name|NULL
block|,
name|ShowModemStatus
block|,
literal|"Show modem setups"
block|,
name|StrNull
block|, }
block|,
block|{
literal|"ofilter"
block|,
name|NULL
block|,
name|ShowOfilter
block|,
literal|"Show Output filters"
block|,
name|StrOption
block|}
block|,
block|{
literal|"proto"
block|,
name|NULL
block|,
name|ReportProtStatus
block|,
literal|"Show protocol summary"
block|,
name|StrNull
block|, }
block|,
block|{
literal|"route"
block|,
name|NULL
block|,
name|ShowRoute
block|,
literal|"Show routing table"
block|,
name|StrNull
block|, }
block|,
block|{
literal|"timeout"
block|,
name|NULL
block|,
name|ShowTimeout
block|,
literal|"Show Idle timeout value"
block|,
name|StrNull
block|, }
block|,
block|{
literal|"version"
block|,
name|NULL
block|,
name|ShowVersion
block|,
literal|"Show version string"
block|,
name|StrNull
block|, }
block|,
block|{
literal|"help"
block|,
literal|"?"
block|,
name|HelpCommand
block|,
literal|"Display this message"
block|,
name|StrNull
block|,
operator|(
name|void
operator|*
operator|)
name|ShowCommands
block|}
block|,
block|{
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_function
name|struct
name|cmdtab
modifier|*
name|FindCommand
parameter_list|(
name|cmds
parameter_list|,
name|str
parameter_list|,
name|pmatch
parameter_list|)
name|struct
name|cmdtab
modifier|*
name|cmds
decl_stmt|;
name|char
modifier|*
name|str
decl_stmt|;
name|int
modifier|*
name|pmatch
decl_stmt|;
block|{
name|int
name|nmatch
init|=
literal|0
decl_stmt|;
name|int
name|len
init|=
name|strlen
argument_list|(
name|str
argument_list|)
decl_stmt|;
name|struct
name|cmdtab
modifier|*
name|found
init|=
name|NULL
decl_stmt|;
while|while
condition|(
name|cmds
operator|->
name|func
condition|)
block|{
if|if
condition|(
name|cmds
operator|->
name|name
operator|&&
name|strncmp
argument_list|(
name|str
argument_list|,
name|cmds
operator|->
name|name
argument_list|,
name|len
argument_list|)
operator|==
literal|0
condition|)
block|{
name|nmatch
operator|++
expr_stmt|;
name|found
operator|=
name|cmds
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cmds
operator|->
name|alias
operator|&&
name|strncmp
argument_list|(
name|str
argument_list|,
name|cmds
operator|->
name|alias
argument_list|,
name|len
argument_list|)
operator|==
literal|0
condition|)
block|{
name|nmatch
operator|++
expr_stmt|;
name|found
operator|=
name|cmds
expr_stmt|;
block|}
name|cmds
operator|++
expr_stmt|;
block|}
operator|*
name|pmatch
operator|=
name|nmatch
expr_stmt|;
return|return
operator|(
name|found
operator|)
return|;
block|}
end_function

begin_function
name|int
name|FindExec
parameter_list|(
name|cmdlist
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|)
name|struct
name|cmdtab
modifier|*
name|cmdlist
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|struct
name|cmdtab
modifier|*
name|cmd
decl_stmt|;
name|int
name|val
init|=
literal|1
decl_stmt|;
name|int
name|nmatch
decl_stmt|;
name|cmd
operator|=
name|FindCommand
argument_list|(
name|cmdlist
argument_list|,
operator|*
name|argv
argument_list|,
operator|&
name|nmatch
argument_list|)
expr_stmt|;
if|if
condition|(
name|nmatch
operator|>
literal|1
condition|)
name|printf
argument_list|(
literal|"Anbiguous.\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|cmd
condition|)
name|val
operator|=
call|(
name|cmd
operator|->
name|func
call|)
argument_list|(
name|cmd
argument_list|,
operator|--
name|argc
argument_list|,
operator|++
name|argv
argument_list|,
name|cmd
operator|->
name|args
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"what?\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|val
operator|)
return|;
block|}
end_function

begin_function
name|void
name|Prompt
parameter_list|(
name|flag
parameter_list|)
name|int
name|flag
decl_stmt|;
block|{
if|if
condition|(
operator|!
operator|(
name|mode
operator|&
name|MODE_INTER
operator|)
condition|)
return|return;
if|if
condition|(
name|flag
condition|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|IpcpFsm
operator|.
name|state
operator|==
name|ST_OPENED
operator|&&
name|phase
operator|==
name|PHASE_NETWORK
condition|)
name|printf
argument_list|(
literal|"PPP> "
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"ppp> "
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|DecodeCommand
parameter_list|(
name|buff
parameter_list|,
name|nb
parameter_list|,
name|prompt
parameter_list|)
name|char
modifier|*
name|buff
decl_stmt|;
name|int
name|nb
decl_stmt|;
name|int
name|prompt
decl_stmt|;
block|{
name|char
modifier|*
name|vector
index|[
literal|20
index|]
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|int
name|argc
decl_stmt|,
name|val
decl_stmt|;
name|char
modifier|*
name|cp
decl_stmt|;
name|val
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|nb
operator|>
literal|0
condition|)
block|{
name|cp
operator|=
name|buff
operator|+
name|strcspn
argument_list|(
name|buff
argument_list|,
literal|"\r\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|cp
condition|)
operator|*
name|cp
operator|=
literal|'\0'
expr_stmt|;
block|{
name|argc
operator|=
name|MakeArgs
argument_list|(
name|buff
argument_list|,
operator|&
name|vector
argument_list|)
expr_stmt|;
name|argv
operator|=
name|vector
expr_stmt|;
if|if
condition|(
name|argc
operator|>
literal|0
condition|)
name|val
operator|=
name|FindExec
argument_list|(
name|Commands
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|val
operator|&&
name|prompt
condition|)
name|Prompt
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|ShowCommand
parameter_list|(
name|list
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|)
name|struct
name|cmdtab
modifier|*
name|list
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|int
name|val
init|=
literal|1
decl_stmt|;
if|if
condition|(
name|argc
operator|>
literal|0
condition|)
name|val
operator|=
name|FindExec
argument_list|(
name|ShowCommands
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"Use ``show ?'' to get a list.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|val
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|TerminalCommand
parameter_list|()
block|{
if|if
condition|(
name|LcpFsm
operator|.
name|state
operator|>
name|ST_CLOSED
condition|)
block|{
name|printf
argument_list|(
literal|"LCP state is [%s]\n"
argument_list|,
name|StateNames
index|[
name|LcpFsm
operator|.
name|state
index|]
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
if|if
condition|(
operator|!
name|IsInteractive
argument_list|()
condition|)
return|return
operator|(
literal|1
operator|)
return|;
name|modem
operator|=
name|OpenModem
argument_list|(
name|mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|modem
operator|<
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"failed to open modem.\n"
argument_list|)
expr_stmt|;
name|modem
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|printf
argument_list|(
literal|"Enter to terminal mode.\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Type `~?' for help.\n"
argument_list|)
expr_stmt|;
name|TtyTermMode
argument_list|()
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|QuitCommand
parameter_list|(
name|list
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|)
name|struct
name|cmdtab
modifier|*
name|list
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
if|if
condition|(
name|mode
operator|&
operator|(
name|MODE_DIRECT
operator||
name|MODE_DEDICATED
operator||
name|MODE_AUTO
operator|)
condition|)
block|{
if|if
condition|(
name|argc
operator|>
literal|0
condition|)
block|{
name|Cleanup
argument_list|(
name|EX_NORMAL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|close
argument_list|(
name|netfd
argument_list|)
expr_stmt|;
name|close
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|netfd
operator|=
operator|-
literal|1
expr_stmt|;
name|mode
operator|&=
operator|~
name|MODE_INTER
expr_stmt|;
block|}
block|}
else|else
name|Cleanup
argument_list|(
name|EX_NORMAL
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|CloseCommand
parameter_list|()
block|{
name|LcpClose
argument_list|()
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|DownCommand
parameter_list|()
block|{
name|LcpDown
argument_list|()
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|int
name|validspeed
index|[]
init|=
block|{
literal|1200
block|,
literal|2400
block|,
literal|4800
block|,
literal|9600
block|,
literal|19200
block|,
literal|38400
block|,
literal|57600
block|,
literal|115200
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|SetModemSpeed
parameter_list|(
name|list
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|)
name|struct
name|cmdtab
modifier|*
name|list
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|int
name|speed
decl_stmt|;
name|int
modifier|*
name|sp
decl_stmt|;
if|if
condition|(
name|argc
operator|>
literal|0
condition|)
block|{
name|speed
operator|=
name|atoi
argument_list|(
operator|*
name|argv
argument_list|)
expr_stmt|;
for|for
control|(
name|sp
operator|=
name|validspeed
init|;
operator|*
name|sp
condition|;
name|sp
operator|++
control|)
block|{
if|if
condition|(
operator|*
name|sp
operator|==
name|speed
condition|)
block|{
name|VarSpeed
operator|=
name|speed
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
block|}
name|printf
argument_list|(
literal|"invalid speed.\n"
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|SetModemParity
parameter_list|(
name|list
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|)
name|struct
name|cmdtab
modifier|*
name|list
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|int
name|parity
decl_stmt|;
if|if
condition|(
name|argc
operator|>
literal|0
condition|)
block|{
name|parity
operator|=
name|ChangeParity
argument_list|(
operator|*
name|argv
argument_list|)
expr_stmt|;
if|if
condition|(
name|parity
operator|<
literal|0
condition|)
name|printf
argument_list|(
literal|"Invalid parity.\n"
argument_list|)
expr_stmt|;
else|else
name|VarParity
operator|=
name|parity
expr_stmt|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|SetDebugLevel
parameter_list|(
name|list
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|)
name|struct
name|cmdtab
modifier|*
name|list
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|int
name|level
decl_stmt|,
name|w
decl_stmt|;
for|for
control|(
name|level
operator|=
literal|0
init|;
name|argc
operator|--
operator|>
literal|0
condition|;
name|argv
operator|++
control|)
block|{
if|if
condition|(
name|isdigit
argument_list|(
operator|*
operator|*
name|argv
argument_list|)
condition|)
block|{
name|w
operator|=
name|atoi
argument_list|(
operator|*
name|argv
argument_list|)
expr_stmt|;
if|if
condition|(
name|w
operator|<
literal|0
operator|||
name|w
operator|>=
name|MAXLOGLEVEL
condition|)
block|{
name|printf
argument_list|(
literal|"invalid log level.\n"
argument_list|)
expr_stmt|;
break|break;
block|}
else|else
name|level
operator||=
operator|(
literal|1
operator|<<
name|w
operator|)
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
name|w
operator|=
literal|0
init|;
name|w
operator|<
name|MAXLOGLEVEL
condition|;
name|w
operator|++
control|)
block|{
if|if
condition|(
name|strcasecmp
argument_list|(
operator|*
name|argv
argument_list|,
name|LogLevelName
index|[
name|w
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
name|level
operator||=
operator|(
literal|1
operator|<<
name|w
operator|)
expr_stmt|;
continue|continue;
block|}
block|}
block|}
block|}
name|loglevel
operator|=
name|level
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|SetEscape
parameter_list|(
name|list
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|)
name|struct
name|cmdtab
modifier|*
name|list
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|int
name|code
decl_stmt|;
for|for
control|(
name|code
operator|=
literal|0
init|;
name|code
operator|<
literal|33
condition|;
name|code
operator|++
control|)
name|EscMap
index|[
name|code
index|]
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|argc
operator|--
operator|>
literal|0
condition|)
block|{
name|sscanf
argument_list|(
operator|*
name|argv
operator|++
argument_list|,
literal|"%x"
argument_list|,
operator|&
name|code
argument_list|)
expr_stmt|;
name|code
operator|&=
literal|0xff
expr_stmt|;
name|EscMap
index|[
name|code
operator|>>
literal|3
index|]
operator||=
operator|(
literal|1
operator|<<
operator|(
name|code
operator|&
literal|7
operator|)
operator|)
expr_stmt|;
name|EscMap
index|[
literal|32
index|]
operator|=
literal|1
expr_stmt|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|SetInitialMRU
parameter_list|(
name|list
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|)
name|struct
name|cmdtab
modifier|*
name|list
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|int
name|mru
decl_stmt|;
if|if
condition|(
name|argc
operator|>
literal|0
condition|)
block|{
name|mru
operator|=
name|atoi
argument_list|(
operator|*
name|argv
argument_list|)
expr_stmt|;
if|if
condition|(
name|mru
operator|<
literal|100
condition|)
name|printf
argument_list|(
literal|"given value is too small.\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|mru
operator|>
name|MAX_MRU
condition|)
name|printf
argument_list|(
literal|"given value is too big.\n"
argument_list|)
expr_stmt|;
else|else
name|VarMRU
operator|=
name|mru
expr_stmt|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|SetIdleTimeout
parameter_list|(
name|list
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|)
name|struct
name|cmdtab
modifier|*
name|list
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
if|if
condition|(
name|argc
operator|--
operator|>
literal|0
condition|)
block|{
name|VarIdleTimeout
operator|=
name|atoi
argument_list|(
operator|*
name|argv
operator|++
argument_list|)
expr_stmt|;
if|if
condition|(
name|argc
operator|>
literal|0
condition|)
name|VarLqrTimeout
operator|=
name|atoi
argument_list|(
operator|*
name|argv
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
name|struct
name|in_addr
name|GetIpAddr
parameter_list|(
name|cp
parameter_list|)
name|char
modifier|*
name|cp
decl_stmt|;
block|{
name|struct
name|hostent
modifier|*
name|hp
decl_stmt|;
name|struct
name|in_addr
name|ipaddr
decl_stmt|;
name|hp
operator|=
name|gethostbyname
argument_list|(
name|cp
argument_list|)
expr_stmt|;
if|if
condition|(
name|hp
operator|&&
name|hp
operator|->
name|h_addrtype
operator|==
name|AF_INET
condition|)
name|bcopy
argument_list|(
name|hp
operator|->
name|h_addr
argument_list|,
operator|&
name|ipaddr
argument_list|,
name|hp
operator|->
name|h_length
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|inet_aton
argument_list|(
name|cp
argument_list|,
operator|&
name|ipaddr
argument_list|)
operator|==
literal|0
condition|)
name|ipaddr
operator|.
name|s_addr
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|ipaddr
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|SetInterfaceAddr
parameter_list|(
name|list
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|)
name|struct
name|cmdtab
modifier|*
name|list
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|int
name|width
decl_stmt|;
name|DefMyAddress
operator|.
name|ipaddr
operator|.
name|s_addr
operator|=
name|DefHisAddress
operator|.
name|ipaddr
operator|.
name|s_addr
operator|=
literal|0L
expr_stmt|;
if|if
condition|(
name|argc
operator|>
literal|0
condition|)
block|{
name|ParseAddr
argument_list|(
name|argc
argument_list|,
name|argv
operator|++
argument_list|,
operator|&
name|DefMyAddress
operator|.
name|ipaddr
argument_list|,
operator|&
name|DefMyAddress
operator|.
name|mask
argument_list|,
operator|&
name|DefMyAddress
operator|.
name|width
argument_list|)
expr_stmt|;
if|if
condition|(
operator|--
name|argc
operator|>
literal|0
condition|)
block|{
name|ParseAddr
argument_list|(
name|argc
argument_list|,
name|argv
operator|++
argument_list|,
operator|&
name|DefHisAddress
operator|.
name|ipaddr
argument_list|,
operator|&
name|DefHisAddress
operator|.
name|mask
argument_list|,
operator|&
name|DefHisAddress
operator|.
name|width
argument_list|)
expr_stmt|;
if|if
condition|(
operator|--
name|argc
operator|>
literal|0
condition|)
block|{
name|ifnetmask
operator|=
name|GetIpAddr
argument_list|(
operator|*
name|argv
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/*    * For backwards compatibility, 0.0.0.0 means any address.    */
if|if
condition|(
name|DefMyAddress
operator|.
name|ipaddr
operator|.
name|s_addr
operator|==
literal|0
condition|)
block|{
name|DefMyAddress
operator|.
name|mask
operator|.
name|s_addr
operator|=
literal|0
expr_stmt|;
name|DefMyAddress
operator|.
name|width
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|DefHisAddress
operator|.
name|ipaddr
operator|.
name|s_addr
operator|==
literal|0
condition|)
block|{
name|DefHisAddress
operator|.
name|mask
operator|.
name|s_addr
operator|=
literal|0
expr_stmt|;
name|DefHisAddress
operator|.
name|width
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|mode
operator|&
name|MODE_AUTO
operator|)
operator||
operator|(
operator|(
name|mode
operator|&
name|MODE_DEDICATED
operator|)
operator|&&
name|dstsystem
operator|)
condition|)
block|{
name|OsSetIpaddress
argument_list|(
name|DefMyAddress
operator|.
name|ipaddr
argument_list|,
name|DefHisAddress
operator|.
name|ipaddr
argument_list|,
name|ifnetmask
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_define
define|#
directive|define
name|VAR_AUTHKEY
value|0
end_define

begin_define
define|#
directive|define
name|VAR_DIAL
value|1
end_define

begin_define
define|#
directive|define
name|VAR_LOGIN
value|2
end_define

begin_define
define|#
directive|define
name|VAR_AUTHNAME
value|3
end_define

begin_define
define|#
directive|define
name|VAR_DEVICE
value|4
end_define

begin_define
define|#
directive|define
name|VAR_ACCMAP
value|5
end_define

begin_define
define|#
directive|define
name|VAR_PHONE
value|6
end_define

begin_function
specifier|static
name|int
name|SetVariable
parameter_list|(
name|list
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|,
name|param
parameter_list|)
name|struct
name|cmdtab
modifier|*
name|list
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|int
name|param
decl_stmt|;
block|{
name|u_long
name|map
decl_stmt|;
if|if
condition|(
name|argc
operator|>
literal|0
condition|)
block|{
switch|switch
condition|(
name|param
condition|)
block|{
case|case
name|VAR_AUTHKEY
case|:
name|strncpy
argument_list|(
name|VarAuthKey
argument_list|,
operator|*
name|argv
argument_list|,
sizeof|sizeof
argument_list|(
name|VarAuthKey
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|VAR_AUTHNAME
case|:
name|strncpy
argument_list|(
name|VarAuthName
argument_list|,
operator|*
name|argv
argument_list|,
sizeof|sizeof
argument_list|(
name|VarAuthName
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|VAR_DIAL
case|:
name|strncpy
argument_list|(
name|VarDialScript
argument_list|,
operator|*
name|argv
argument_list|,
sizeof|sizeof
argument_list|(
name|VarDialScript
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|VAR_LOGIN
case|:
name|strncpy
argument_list|(
name|VarLoginScript
argument_list|,
operator|*
name|argv
argument_list|,
sizeof|sizeof
argument_list|(
name|VarDialScript
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|VAR_DEVICE
case|:
name|strncpy
argument_list|(
name|VarDevice
argument_list|,
operator|*
name|argv
argument_list|,
sizeof|sizeof
argument_list|(
name|VarDevice
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|VAR_ACCMAP
case|:
name|sscanf
argument_list|(
operator|*
name|argv
argument_list|,
literal|"%x"
argument_list|,
operator|&
name|map
argument_list|)
expr_stmt|;
name|VarAccmap
operator|=
name|map
expr_stmt|;
break|break;
case|case
name|VAR_PHONE
case|:
name|strncpy
argument_list|(
name|VarPhone
argument_list|,
operator|*
name|argv
argument_list|,
sizeof|sizeof
argument_list|(
name|VarPhone
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|SetOpenMode
parameter_list|(
name|list
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|)
name|struct
name|cmdtab
modifier|*
name|list
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
if|if
condition|(
name|argc
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"active"
argument_list|)
operator|==
literal|0
condition|)
name|VarOpenMode
operator|=
name|OPEN_ACTIVE
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"passive"
argument_list|)
operator|==
literal|0
condition|)
name|VarOpenMode
operator|=
name|OPEN_PASSIVE
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"Invalid mode.\n"
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|char
name|StrChatStr
index|[]
init|=
literal|"chat-script"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|StrValue
index|[]
init|=
literal|"value"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|SetIfilter
argument_list|()
decl_stmt|,
name|SetOfilter
argument_list|()
decl_stmt|,
name|SetDfilter
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|cmdtab
name|SetCommands
index|[]
init|=
block|{
block|{
literal|"accmap"
block|,
name|NULL
block|,
name|SetVariable
block|,
literal|"Set accmap value"
block|,
literal|"hex-value"
block|,
operator|(
name|void
operator|*
operator|)
name|VAR_ACCMAP
block|}
block|,
block|{
literal|"authkey"
block|,
literal|"key"
block|,
name|SetVariable
block|,
literal|"Set authentication key"
block|,
literal|"key"
block|,
operator|(
name|void
operator|*
operator|)
name|VAR_AUTHKEY
block|}
block|,
block|{
literal|"authname"
block|,
name|NULL
block|,
name|SetVariable
block|,
literal|"Set authentication name"
block|,
literal|"name"
block|,
operator|(
name|void
operator|*
operator|)
name|VAR_AUTHNAME
block|}
block|,
block|{
literal|"debug"
block|,
name|NULL
block|,
name|SetDebugLevel
block|,
literal|"Set debug level"
block|,
name|StrValue
block|}
block|,
block|{
literal|"device"
block|,
literal|"line"
block|,
name|SetVariable
block|,
literal|"Set modem device name"
block|,
literal|"device-name"
block|,
operator|(
name|void
operator|*
operator|)
name|VAR_DEVICE
block|}
block|,
block|{
literal|"dfilter"
block|,
name|NULL
block|,
name|SetDfilter
block|,
literal|"Set demand filter"
block|,
literal|"..."
block|}
block|,
block|{
literal|"dial"
block|,
name|NULL
block|,
name|SetVariable
block|,
literal|"Set dialing script"
block|,
name|StrChatStr
block|,
operator|(
name|void
operator|*
operator|)
name|VAR_DIAL
block|}
block|,
block|{
literal|"escape"
block|,
name|NULL
block|,
name|SetEscape
block|,
literal|"Set escape characters"
block|,
literal|"hex-digit ..."
block|}
block|,
block|{
literal|"ifaddr"
block|,
name|NULL
block|,
name|SetInterfaceAddr
block|,
literal|"Set destination address"
block|,
literal|"src-addr dst-addr netmask"
block|}
block|,
block|{
literal|"ifilter"
block|,
name|NULL
block|,
name|SetIfilter
block|,
literal|"Set input filter"
block|,
literal|"..."
block|}
block|,
block|{
literal|"login"
block|,
name|NULL
block|,
name|SetVariable
block|,
literal|"Set login script"
block|,
name|StrChatStr
block|,
operator|(
name|void
operator|*
operator|)
name|VAR_LOGIN
block|}
block|,
block|{
literal|"mru"
block|,
literal|"mtu"
block|,
name|SetInitialMRU
block|,
literal|"Set Initial MRU value"
block|,
name|StrValue
block|}
block|,
block|{
literal|"ofilter"
block|,
name|NULL
block|,
name|SetOfilter
block|,
literal|"Set output filter"
block|,
literal|"..."
block|}
block|,
block|{
literal|"openmode"
block|,
name|NULL
block|,
name|SetOpenMode
block|,
literal|"Set open mode"
block|,
literal|"[active|passive]"
block|}
block|,
block|{
literal|"parity"
block|,
name|NULL
block|,
name|SetModemParity
block|,
literal|"Set modem parity"
block|,
literal|"[odd|even|none]"
block|}
block|,
block|{
literal|"phone"
block|,
name|NULL
block|,
name|SetVariable
block|,
literal|"Set telephone number"
block|,
literal|"phone-number"
block|,
operator|(
name|void
operator|*
operator|)
name|VAR_PHONE
block|}
block|,
block|{
literal|"speed"
block|,
name|NULL
block|,
name|SetModemSpeed
block|,
literal|"Set modem speed"
block|,
literal|"speed"
block|}
block|,
block|{
literal|"timeout"
block|,
name|NULL
block|,
name|SetIdleTimeout
block|,
literal|"Set Idle timeout"
block|,
name|StrValue
block|}
block|,
block|{
literal|"help"
block|,
literal|"?"
block|,
name|HelpCommand
block|,
literal|"Display this message"
block|,
name|StrNull
block|,
operator|(
name|void
operator|*
operator|)
name|SetCommands
block|}
block|,
block|{
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|SetCommand
parameter_list|(
name|list
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|)
name|struct
name|cmdtab
modifier|*
name|list
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|int
name|val
init|=
literal|1
decl_stmt|;
if|if
condition|(
name|argc
operator|>
literal|0
condition|)
name|val
operator|=
name|FindExec
argument_list|(
name|SetCommands
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"Use ``set ?'' to get a list.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|val
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|AddCommand
parameter_list|(
name|list
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|)
name|struct
name|cmdtab
modifier|*
name|list
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|struct
name|in_addr
name|dest
decl_stmt|,
name|gateway
decl_stmt|,
name|netmask
decl_stmt|;
if|if
condition|(
name|argc
operator|==
literal|3
condition|)
block|{
name|dest
operator|=
name|GetIpAddr
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|netmask
operator|=
name|GetIpAddr
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|,
literal|"HISADDR"
argument_list|)
operator|==
literal|0
condition|)
name|gateway
operator|=
name|IpcpInfo
operator|.
name|his_ipaddr
expr_stmt|;
else|else
name|gateway
operator|=
name|GetIpAddr
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|OsSetRoute
argument_list|(
name|RTM_ADD
argument_list|,
name|dest
argument_list|,
name|gateway
argument_list|,
name|netmask
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"Usage: %s %s\n"
argument_list|,
name|list
operator|->
name|name
argument_list|,
name|list
operator|->
name|syntax
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|DeleteCommand
parameter_list|(
name|list
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|)
name|struct
name|cmdtab
modifier|*
name|list
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|struct
name|in_addr
name|dest
decl_stmt|,
name|gateway
decl_stmt|,
name|netmask
decl_stmt|;
if|if
condition|(
name|argc
operator|>=
literal|2
condition|)
block|{
name|dest
operator|=
name|GetIpAddr
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
literal|"HISADDR"
argument_list|)
operator|==
literal|0
condition|)
name|gateway
operator|=
name|IpcpInfo
operator|.
name|his_ipaddr
expr_stmt|;
else|else
name|gateway
operator|=
name|GetIpAddr
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|netmask
operator|.
name|s_addr
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|argc
operator|==
literal|3
condition|)
block|{
if|if
condition|(
name|inet_aton
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
operator|&
name|netmask
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"bad netmask value.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
block|}
name|OsSetRoute
argument_list|(
name|RTM_DELETE
argument_list|,
name|dest
argument_list|,
name|gateway
argument_list|,
name|netmask
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|argc
operator|==
literal|1
operator|&&
name|strcmp
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"ALL"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|DeleteIfRoutes
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"Usage: %s %s\n"
argument_list|,
name|list
operator|->
name|name
argument_list|,
name|list
operator|->
name|syntax
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

end_unit


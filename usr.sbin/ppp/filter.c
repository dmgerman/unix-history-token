begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  *		PPP Filter command Interface  *  *	    Written by Toshiharu OHNO (tony-o@iij.ad.jp)  *  *   Copyright (C) 1993, Internet Initiative Japan, Inc. All rights reserverd.  *  * Redistribution and use in source and binary forms are permitted  * provided that the above copyright notice and this paragraph are  * duplicated in all such forms and that any documentation,  * advertising materials, and other materials related to such  * distribution and use acknowledge that the software was developed  * by the Internet Initiative Japan.  The name of the  * IIJ may not be used to endorse or promote products derived  * from this software without specific prior written permission.  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND WITHOUT ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED  * WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR A PARTICULAR PURPOSE.  *  * $Id: filter.c,v 1.5 1995/09/17 16:14:45 amurai Exp $  *  *	TODO: Shoud send ICMP error message when we discard packets.  */
end_comment

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<arpa/inet.h>
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<strings.h>
end_include

begin_include
include|#
directive|include
file|"command.h"
end_include

begin_include
include|#
directive|include
file|"filter.h"
end_include

begin_decl_stmt
specifier|static
name|struct
name|filterent
name|filterdata
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|u_long
name|netmasks
index|[
literal|33
index|]
init|=
block|{
literal|0x00000000
block|,
literal|0x80000000
block|,
literal|0xC0000000
block|,
literal|0xE0000000
block|,
literal|0xF0000000
block|,
literal|0xF8000000
block|,
literal|0xFC000000
block|,
literal|0xFE000000
block|,
literal|0xFF000000
block|,
literal|0xFF800000
block|,
literal|0xFFC00000
block|,
literal|0xFFE00000
block|,
literal|0xFFF00000
block|,
literal|0xFFF80000
block|,
literal|0xFFFC0000
block|,
literal|0xFFFE0000
block|,
literal|0xFFFF0000
block|,
literal|0xFFFF8000
block|,
literal|0xFFFFC000
block|,
literal|0xFFFFE000
block|,
literal|0xFFFFF000
block|,
literal|0xFFFFF800
block|,
literal|0xFFFFFC00
block|,
literal|0xFFFFFE00
block|,
literal|0xFFFFFF00
block|,
literal|0xFFFFFF80
block|,
literal|0xFFFFFFC0
block|,
literal|0xFFFFFFE0
block|,
literal|0xFFFFFFF0
block|,
literal|0xFFFFFFF8
block|,
literal|0xFFFFFFFC
block|,
literal|0xFFFFFFFE
block|,
literal|0xFFFFFFFF
block|, }
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|ParseAddr
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|,
name|paddr
parameter_list|,
name|pmask
parameter_list|,
name|pwidth
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|struct
name|in_addr
modifier|*
name|paddr
decl_stmt|;
name|struct
name|in_addr
modifier|*
name|pmask
decl_stmt|;
name|int
modifier|*
name|pwidth
decl_stmt|;
block|{
name|u_long
name|addr
decl_stmt|;
name|int
name|bits
decl_stmt|;
name|char
modifier|*
name|cp
decl_stmt|,
modifier|*
name|wp
decl_stmt|;
if|if
condition|(
name|argc
operator|<
literal|1
condition|)
block|{
ifdef|#
directive|ifdef
name|notdef
name|printf
argument_list|(
literal|"address/mask is expected.\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|pmask
operator|->
name|s_addr
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* Assume 255.255.255.255 as default */
name|cp
operator|=
name|index
argument_list|(
operator|*
name|argv
argument_list|,
literal|'/'
argument_list|)
expr_stmt|;
if|if
condition|(
name|cp
condition|)
operator|*
name|cp
operator|++
operator|=
literal|'\0'
expr_stmt|;
name|addr
operator|=
name|inet_addr
argument_list|(
operator|*
name|argv
argument_list|)
expr_stmt|;
name|paddr
operator|->
name|s_addr
operator|=
name|addr
expr_stmt|;
if|if
condition|(
name|cp
operator|&&
operator|*
name|cp
condition|)
block|{
name|bits
operator|=
name|strtol
argument_list|(
name|cp
argument_list|,
operator|&
name|wp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|cp
operator|==
name|wp
operator|||
name|bits
operator|<
literal|0
operator|||
name|bits
operator|>
literal|32
condition|)
block|{
name|printf
argument_list|(
literal|"bad mask width.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
else|else
block|{
comment|/* if width is not given, assume whole 32 bits are meaningfull */
name|bits
operator|=
literal|32
expr_stmt|;
block|}
operator|*
name|pwidth
operator|=
name|bits
expr_stmt|;
name|pmask
operator|->
name|s_addr
operator|=
name|htonl
argument_list|(
name|netmasks
index|[
name|bits
index|]
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ParseProto
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|int
name|proto
decl_stmt|;
if|if
condition|(
name|argc
operator|<
literal|1
condition|)
return|return
operator|(
name|P_NONE
operator|)
return|;
if|if
condition|(
name|STREQ
argument_list|(
operator|*
name|argv
argument_list|,
literal|"tcp"
argument_list|)
condition|)
name|proto
operator|=
name|P_TCP
expr_stmt|;
elseif|else
if|if
condition|(
name|STREQ
argument_list|(
operator|*
name|argv
argument_list|,
literal|"udp"
argument_list|)
condition|)
name|proto
operator|=
name|P_UDP
expr_stmt|;
elseif|else
if|if
condition|(
name|STREQ
argument_list|(
operator|*
name|argv
argument_list|,
literal|"icmp"
argument_list|)
condition|)
name|proto
operator|=
name|P_ICMP
expr_stmt|;
else|else
name|proto
operator|=
name|P_NONE
expr_stmt|;
return|return
operator|(
name|proto
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ParsePort
parameter_list|(
name|service
parameter_list|,
name|proto
parameter_list|)
name|char
modifier|*
name|service
decl_stmt|;
name|int
name|proto
decl_stmt|;
block|{
name|char
modifier|*
name|protocol_name
decl_stmt|,
modifier|*
name|cp
decl_stmt|;
name|struct
name|servent
modifier|*
name|servent
decl_stmt|;
name|int
name|port
decl_stmt|;
switch|switch
condition|(
name|proto
condition|)
block|{
case|case
name|P_UDP
case|:
name|protocol_name
operator|=
literal|"udp"
expr_stmt|;
break|break;
case|case
name|P_TCP
case|:
name|protocol_name
operator|=
literal|"tcp"
expr_stmt|;
break|break;
default|default:
name|protocol_name
operator|=
literal|0
expr_stmt|;
block|}
name|servent
operator|=
name|getservbyname
argument_list|(
name|service
argument_list|,
name|protocol_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|servent
operator|!=
literal|0
condition|)
return|return
operator|(
name|ntohs
argument_list|(
name|servent
operator|->
name|s_port
argument_list|)
operator|)
return|;
name|port
operator|=
name|strtol
argument_list|(
name|service
argument_list|,
operator|&
name|cp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|cp
operator|==
name|service
condition|)
block|{
name|printf
argument_list|(
literal|"%s is not a port name or number.\n"
argument_list|,
name|service
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
return|return
operator|(
name|port
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  *	ICMP Syntax:	src eq icmp_message_type  */
end_comment

begin_function
specifier|static
name|int
name|ParseIcmp
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|int
name|type
decl_stmt|;
name|char
modifier|*
name|cp
decl_stmt|;
switch|switch
condition|(
name|argc
condition|)
block|{
case|case
literal|0
case|:
comment|/* permit/deny all ICMP types */
name|filterdata
operator|.
name|opt
operator|.
name|srcop
operator|=
name|OP_NONE
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"bad icmp syntax.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
case|case
literal|3
case|:
if|if
condition|(
name|STREQ
argument_list|(
operator|*
name|argv
argument_list|,
literal|"src"
argument_list|)
operator|&&
name|STREQ
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
literal|"eq"
argument_list|)
condition|)
block|{
name|type
operator|=
name|strtol
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|,
operator|&
name|cp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|cp
operator|==
name|argv
index|[
literal|2
index|]
condition|)
block|{
name|printf
argument_list|(
literal|"type is expected.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|filterdata
operator|.
name|opt
operator|.
name|srcop
operator|=
name|OP_EQ
expr_stmt|;
name|filterdata
operator|.
name|opt
operator|.
name|srcport
operator|=
name|type
expr_stmt|;
block|}
break|break;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ParseOp
parameter_list|(
name|cp
parameter_list|)
name|char
modifier|*
name|cp
decl_stmt|;
block|{
name|int
name|op
init|=
name|OP_NONE
decl_stmt|;
if|if
condition|(
name|STREQ
argument_list|(
name|cp
argument_list|,
literal|"eq"
argument_list|)
condition|)
name|op
operator|=
name|OP_EQ
expr_stmt|;
elseif|else
if|if
condition|(
name|STREQ
argument_list|(
name|cp
argument_list|,
literal|"gt"
argument_list|)
condition|)
name|op
operator|=
name|OP_GT
expr_stmt|;
elseif|else
if|if
condition|(
name|STREQ
argument_list|(
name|cp
argument_list|,
literal|"lt"
argument_list|)
condition|)
name|op
operator|=
name|OP_LT
expr_stmt|;
return|return
operator|(
name|op
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  *	UDP Syntax: [src op port] [dst op port]  */
end_comment

begin_function
specifier|static
name|int
name|ParseUdpOrTcp
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|,
name|proto
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|int
name|proto
decl_stmt|;
block|{
name|int
name|port
decl_stmt|;
name|char
modifier|*
name|cp
decl_stmt|;
if|if
condition|(
name|argc
operator|==
literal|0
condition|)
block|{
comment|/* permit/deny all tcp traffic */
name|filterdata
operator|.
name|opt
operator|.
name|srcop
operator|=
name|filterdata
operator|.
name|opt
operator|.
name|dstop
operator|=
name|A_NONE
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|argc
operator|<
literal|3
condition|)
block|{
ifdef|#
directive|ifdef
name|notdef
name|printf
argument_list|(
literal|"bad udp syntax.\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|argc
operator|>=
literal|3
operator|&&
name|STREQ
argument_list|(
operator|*
name|argv
argument_list|,
literal|"src"
argument_list|)
condition|)
block|{
name|filterdata
operator|.
name|opt
operator|.
name|srcop
operator|=
name|ParseOp
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|filterdata
operator|.
name|opt
operator|.
name|srcop
operator|==
name|OP_NONE
condition|)
block|{
name|printf
argument_list|(
literal|"bad operation\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|filterdata
operator|.
name|opt
operator|.
name|srcport
operator|=
name|ParsePort
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|,
name|proto
argument_list|)
expr_stmt|;
if|if
condition|(
name|filterdata
operator|.
name|opt
operator|.
name|srcport
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|argc
operator|-=
literal|3
expr_stmt|;
name|argv
operator|+=
literal|3
expr_stmt|;
if|if
condition|(
name|argc
operator|==
literal|0
condition|)
return|return
operator|(
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|argc
operator|>=
literal|3
operator|&&
name|STREQ
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"dst"
argument_list|)
condition|)
block|{
name|filterdata
operator|.
name|opt
operator|.
name|dstop
operator|=
name|ParseOp
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|filterdata
operator|.
name|opt
operator|.
name|dstop
operator|==
name|OP_NONE
condition|)
block|{
name|printf
argument_list|(
literal|"bad operation\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|filterdata
operator|.
name|opt
operator|.
name|dstport
operator|=
name|ParsePort
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|,
name|proto
argument_list|)
expr_stmt|;
if|if
condition|(
name|filterdata
operator|.
name|opt
operator|.
name|dstport
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|argc
operator|-=
literal|3
expr_stmt|;
name|argv
operator|+=
literal|3
expr_stmt|;
if|if
condition|(
name|argc
operator|==
literal|0
condition|)
return|return
operator|(
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|argc
operator|==
literal|1
condition|)
block|{
if|if
condition|(
name|STREQ
argument_list|(
operator|*
name|argv
argument_list|,
literal|"estab"
argument_list|)
condition|)
block|{
name|filterdata
operator|.
name|opt
operator|.
name|estab
operator|=
literal|1
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|printf
argument_list|(
literal|"estab is expected: %s\n"
argument_list|,
operator|*
name|argv
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|argc
operator|>
literal|0
condition|)
name|printf
argument_list|(
literal|"bad %s src/dst port syntax: %s\n"
argument_list|,
operator|*
name|argv
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_decl_stmt
name|char
modifier|*
name|opname
index|[]
init|=
block|{
literal|"none"
block|,
literal|"eq"
block|,
literal|"gt"
block|,
literal|"lt"
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|Parse
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|,
name|ofp
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|struct
name|filterent
modifier|*
name|ofp
decl_stmt|;
block|{
name|int
name|action
decl_stmt|,
name|proto
decl_stmt|;
name|int
name|val
decl_stmt|;
name|char
modifier|*
name|wp
decl_stmt|;
name|struct
name|filterent
modifier|*
name|fp
init|=
operator|&
name|filterdata
decl_stmt|;
name|val
operator|=
name|strtol
argument_list|(
operator|*
name|argv
argument_list|,
operator|&
name|wp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|argv
operator|==
name|wp
operator|||
name|val
operator|>
name|MAXFILTERS
condition|)
block|{
name|printf
argument_list|(
literal|"invalid filter number.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|val
operator|<
literal|0
condition|)
block|{
for|for
control|(
name|val
operator|=
literal|0
init|;
name|val
operator|<
name|MAXFILTERS
condition|;
name|val
operator|++
control|)
block|{
name|ofp
operator|->
name|action
operator|=
name|A_NONE
expr_stmt|;
name|ofp
operator|++
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"filter cleard.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|ofp
operator|+=
name|val
expr_stmt|;
if|if
condition|(
operator|--
name|argc
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"missing action.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|argv
operator|++
expr_stmt|;
name|proto
operator|=
name|P_NONE
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|filterdata
argument_list|,
sizeof|sizeof
argument_list|(
name|filterdata
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|STREQ
argument_list|(
operator|*
name|argv
argument_list|,
literal|"permit"
argument_list|)
condition|)
block|{
name|action
operator|=
name|A_PERMIT
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|STREQ
argument_list|(
operator|*
name|argv
argument_list|,
literal|"deny"
argument_list|)
condition|)
block|{
name|action
operator|=
name|A_DENY
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|STREQ
argument_list|(
operator|*
name|argv
argument_list|,
literal|"clear"
argument_list|)
condition|)
block|{
name|ofp
operator|->
name|action
operator|=
name|A_NONE
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"bad action: %s\n"
argument_list|,
operator|*
name|argv
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|fp
operator|->
name|action
operator|=
name|action
expr_stmt|;
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
if|if
condition|(
name|ofp
operator|->
name|action
operator|==
name|A_DENY
condition|)
block|{
if|if
condition|(
name|STREQ
argument_list|(
operator|*
name|argv
argument_list|,
literal|"host"
argument_list|)
condition|)
block|{
name|fp
operator|->
name|action
operator||=
name|A_UHOST
expr_stmt|;
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|STREQ
argument_list|(
operator|*
name|argv
argument_list|,
literal|"port"
argument_list|)
condition|)
block|{
name|fp
operator|->
name|action
operator||=
name|A_UPORT
expr_stmt|;
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
block|}
block|}
name|proto
operator|=
name|ParseProto
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|)
expr_stmt|;
if|if
condition|(
name|proto
operator|==
name|P_NONE
condition|)
block|{
if|if
condition|(
name|ParseAddr
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
operator|&
name|fp
operator|->
name|saddr
argument_list|,
operator|&
name|fp
operator|->
name|smask
argument_list|,
operator|&
name|fp
operator|->
name|swidth
argument_list|)
condition|)
block|{
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
name|proto
operator|=
name|ParseProto
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|)
expr_stmt|;
if|if
condition|(
name|proto
operator|==
name|P_NONE
condition|)
block|{
if|if
condition|(
name|ParseAddr
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
operator|&
name|fp
operator|->
name|daddr
argument_list|,
operator|&
name|fp
operator|->
name|dmask
argument_list|,
operator|&
name|fp
operator|->
name|dwidth
argument_list|)
condition|)
block|{
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
block|}
name|proto
operator|=
name|ParseProto
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|)
expr_stmt|;
if|if
condition|(
name|proto
condition|)
block|{
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|printf
argument_list|(
literal|"Address/protocol expected.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
else|else
block|{
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
block|}
name|val
operator|=
literal|1
expr_stmt|;
name|fp
operator|->
name|proto
operator|=
name|proto
expr_stmt|;
switch|switch
condition|(
name|proto
condition|)
block|{
case|case
name|P_TCP
case|:
name|val
operator|=
name|ParseUdpOrTcp
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|P_TCP
argument_list|)
expr_stmt|;
break|break;
case|case
name|P_UDP
case|:
name|val
operator|=
name|ParseUdpOrTcp
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|P_UDP
argument_list|)
expr_stmt|;
break|break;
case|case
name|P_ICMP
case|:
name|val
operator|=
name|ParseIcmp
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|)
expr_stmt|;
break|break;
block|}
ifdef|#
directive|ifdef
name|DEBUG
name|printf
argument_list|(
literal|"src: %s/"
argument_list|,
name|inet_ntoa
argument_list|(
name|fp
operator|->
name|saddr
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s "
argument_list|,
name|inet_ntoa
argument_list|(
name|fp
operator|->
name|smask
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"dst: %s/"
argument_list|,
name|inet_ntoa
argument_list|(
name|fp
operator|->
name|daddr
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s proto = %d\n"
argument_list|,
name|inet_ntoa
argument_list|(
name|fp
operator|->
name|dmask
argument_list|)
argument_list|,
name|proto
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"src:  %s (%d)\n"
argument_list|,
name|opname
index|[
name|fp
operator|->
name|opt
operator|.
name|srcop
index|]
argument_list|,
name|fp
operator|->
name|opt
operator|.
name|srcport
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"dst:  %s (%d)\n"
argument_list|,
name|opname
index|[
name|fp
operator|->
name|opt
operator|.
name|dstop
index|]
argument_list|,
name|fp
operator|->
name|opt
operator|.
name|dstport
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"estab: %d\n"
argument_list|,
name|fp
operator|->
name|opt
operator|.
name|estab
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|val
condition|)
operator|*
name|ofp
operator|=
operator|*
name|fp
expr_stmt|;
return|return
operator|(
name|val
operator|)
return|;
block|}
end_function

begin_function
name|int
name|SetIfilter
parameter_list|(
name|list
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|)
name|struct
name|cmdtab
modifier|*
name|list
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
if|if
condition|(
name|argc
operator|>
literal|0
condition|)
operator|(
name|void
operator|)
name|Parse
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|ifilters
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"syntax error.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
name|int
name|SetOfilter
parameter_list|(
name|list
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|)
name|struct
name|cmdtab
modifier|*
name|list
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
if|if
condition|(
name|argc
operator|>
literal|0
condition|)
operator|(
name|void
operator|)
name|Parse
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|ofilters
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"syntax error.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
name|int
name|SetDfilter
parameter_list|(
name|list
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|)
name|struct
name|cmdtab
modifier|*
name|list
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
if|if
condition|(
name|argc
operator|>
literal|0
condition|)
operator|(
name|void
operator|)
name|Parse
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|dfilters
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"syntax error.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
name|int
name|SetAfilter
parameter_list|(
name|list
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|)
name|struct
name|cmdtab
modifier|*
name|list
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
if|if
condition|(
name|argc
operator|>
literal|0
condition|)
operator|(
name|void
operator|)
name|Parse
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|afilters
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"syntax error.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|char
modifier|*
name|protoname
index|[]
init|=
block|{
literal|"none"
block|,
literal|"tcp"
block|,
literal|"udp"
block|,
literal|"icmp"
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|actname
index|[]
init|=
block|{
literal|"none   "
block|,
literal|"permit "
block|,
literal|"deny   "
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|ShowFilter
parameter_list|(
name|fp
parameter_list|)
name|struct
name|filterent
modifier|*
name|fp
decl_stmt|;
block|{
name|int
name|n
decl_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|MAXFILTERS
condition|;
name|n
operator|++
operator|,
name|fp
operator|++
control|)
block|{
if|if
condition|(
name|fp
operator|->
name|action
operator|!=
name|A_NONE
condition|)
block|{
name|printf
argument_list|(
literal|"%2d %s"
argument_list|,
name|n
argument_list|,
name|actname
index|[
name|fp
operator|->
name|action
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s/%d "
argument_list|,
name|inet_ntoa
argument_list|(
name|fp
operator|->
name|saddr
argument_list|)
argument_list|,
name|fp
operator|->
name|swidth
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s/%d "
argument_list|,
name|inet_ntoa
argument_list|(
name|fp
operator|->
name|daddr
argument_list|)
argument_list|,
name|fp
operator|->
name|dwidth
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|proto
condition|)
block|{
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|protoname
index|[
name|fp
operator|->
name|proto
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|opt
operator|.
name|srcop
condition|)
name|printf
argument_list|(
literal|" src %s %d"
argument_list|,
name|opname
index|[
name|fp
operator|->
name|opt
operator|.
name|srcop
index|]
argument_list|,
name|fp
operator|->
name|opt
operator|.
name|srcport
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|opt
operator|.
name|dstop
condition|)
name|printf
argument_list|(
literal|" dst %s %d"
argument_list|,
name|opname
index|[
name|fp
operator|->
name|opt
operator|.
name|dstop
index|]
argument_list|,
name|fp
operator|->
name|opt
operator|.
name|dstport
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|opt
operator|.
name|estab
condition|)
name|printf
argument_list|(
literal|" estab"
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|int
name|ShowIfilter
parameter_list|(
name|list
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|)
name|struct
name|cmdtab
modifier|*
name|list
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|ShowFilter
argument_list|(
name|ifilters
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ShowOfilter
parameter_list|(
name|list
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|)
name|struct
name|cmdtab
modifier|*
name|list
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|ShowFilter
argument_list|(
name|ofilters
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ShowDfilter
parameter_list|(
name|list
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|)
name|struct
name|cmdtab
modifier|*
name|list
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|ShowFilter
argument_list|(
name|dfilters
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ShowAfilter
parameter_list|(
name|list
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|)
name|struct
name|cmdtab
modifier|*
name|list
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|ShowFilter
argument_list|(
name|afilters
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

end_unit


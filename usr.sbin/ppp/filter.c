begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  *		PPP Filter command Interface  *  *	    Written by Toshiharu OHNO (tony-o@iij.ad.jp)  *  *   Copyright (C) 1993, Internet Initiative Japan, Inc. All rights reserverd.  *  * Redistribution and use in source and binary forms are permitted  * provided that the above copyright notice and this paragraph are  * duplicated in all such forms and that any documentation,  * advertising materials, and other materials related to such  * distribution and use acknowledge that the software was developed  * by the Internet Initiative Japan.  The name of the  * IIJ may not be used to endorse or promote products derived  * from this software without specific prior written permission.  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND WITHOUT ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED  * WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR A PARTICULAR PURPOSE.  *  * $Id: filter.c,v 1.25 1998/06/27 12:03:48 brian Exp $  *  *	TODO: Shoud send ICMP error message when we discard packets.  */
end_comment

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<arpa/inet.h>
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_systm.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip.h>
end_include

begin_include
include|#
directive|include
file|<sys/un.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<strings.h>
end_include

begin_include
include|#
directive|include
file|<termios.h>
end_include

begin_include
include|#
directive|include
file|"defs.h"
end_include

begin_include
include|#
directive|include
file|"command.h"
end_include

begin_include
include|#
directive|include
file|"mbuf.h"
end_include

begin_include
include|#
directive|include
file|"log.h"
end_include

begin_include
include|#
directive|include
file|"iplist.h"
end_include

begin_include
include|#
directive|include
file|"timer.h"
end_include

begin_include
include|#
directive|include
file|"throughput.h"
end_include

begin_include
include|#
directive|include
file|"lqr.h"
end_include

begin_include
include|#
directive|include
file|"hdlc.h"
end_include

begin_include
include|#
directive|include
file|"fsm.h"
end_include

begin_include
include|#
directive|include
file|"lcp.h"
end_include

begin_include
include|#
directive|include
file|"ccp.h"
end_include

begin_include
include|#
directive|include
file|"link.h"
end_include

begin_include
include|#
directive|include
file|"slcompress.h"
end_include

begin_include
include|#
directive|include
file|"ipcp.h"
end_include

begin_include
include|#
directive|include
file|"filter.h"
end_include

begin_include
include|#
directive|include
file|"descriptor.h"
end_include

begin_include
include|#
directive|include
file|"prompt.h"
end_include

begin_include
include|#
directive|include
file|"mp.h"
end_include

begin_include
include|#
directive|include
file|"bundle.h"
end_include

begin_function_decl
specifier|static
name|int
name|filter_Nam2Proto
parameter_list|(
name|int
parameter_list|,
name|char
specifier|const
modifier|*
specifier|const
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|filter_Nam2Op
parameter_list|(
specifier|const
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
specifier|const
name|u_int32_t
name|netmasks
index|[
literal|33
index|]
init|=
block|{
literal|0x00000000
block|,
literal|0x80000000
block|,
literal|0xC0000000
block|,
literal|0xE0000000
block|,
literal|0xF0000000
block|,
literal|0xF8000000
block|,
literal|0xFC000000
block|,
literal|0xFE000000
block|,
literal|0xFF000000
block|,
literal|0xFF800000
block|,
literal|0xFFC00000
block|,
literal|0xFFE00000
block|,
literal|0xFFF00000
block|,
literal|0xFFF80000
block|,
literal|0xFFFC0000
block|,
literal|0xFFFE0000
block|,
literal|0xFFFF0000
block|,
literal|0xFFFF8000
block|,
literal|0xFFFFC000
block|,
literal|0xFFFFE000
block|,
literal|0xFFFFF000
block|,
literal|0xFFFFF800
block|,
literal|0xFFFFFC00
block|,
literal|0xFFFFFE00
block|,
literal|0xFFFFFF00
block|,
literal|0xFFFFFF80
block|,
literal|0xFFFFFFC0
block|,
literal|0xFFFFFFE0
block|,
literal|0xFFFFFFF0
block|,
literal|0xFFFFFFF8
block|,
literal|0xFFFFFFFC
block|,
literal|0xFFFFFFFE
block|,
literal|0xFFFFFFFF
block|, }
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|ParseAddr
parameter_list|(
name|struct
name|ipcp
modifier|*
name|ipcp
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
specifier|const
modifier|*
specifier|const
modifier|*
name|argv
parameter_list|,
name|struct
name|in_addr
modifier|*
name|paddr
parameter_list|,
name|struct
name|in_addr
modifier|*
name|pmask
parameter_list|,
name|int
modifier|*
name|pwidth
parameter_list|)
block|{
name|int
name|bits
decl_stmt|,
name|len
decl_stmt|;
name|char
modifier|*
name|wp
decl_stmt|;
specifier|const
name|char
modifier|*
name|cp
decl_stmt|;
if|if
condition|(
name|argc
operator|<
literal|1
condition|)
block|{
name|log_Printf
argument_list|(
name|LogWARN
argument_list|,
literal|"ParseAddr: address/mask is expected.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|pmask
condition|)
name|pmask
operator|->
name|s_addr
operator|=
name|INADDR_BROADCAST
expr_stmt|;
comment|/* Assume 255.255.255.255 as default */
name|cp
operator|=
name|pmask
operator|||
name|pwidth
condition|?
name|strchr
argument_list|(
operator|*
name|argv
argument_list|,
literal|'/'
argument_list|)
else|:
name|NULL
expr_stmt|;
name|len
operator|=
name|cp
condition|?
name|cp
operator|-
operator|*
name|argv
else|:
name|strlen
argument_list|(
operator|*
name|argv
argument_list|)
expr_stmt|;
if|if
condition|(
name|ipcp
operator|&&
name|strncasecmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"HISADDR"
argument_list|,
name|len
argument_list|)
operator|==
literal|0
condition|)
operator|*
name|paddr
operator|=
name|ipcp
operator|->
name|peer_ip
expr_stmt|;
elseif|else
if|if
condition|(
name|ipcp
operator|&&
name|strncasecmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"MYADDR"
argument_list|,
name|len
argument_list|)
operator|==
literal|0
condition|)
operator|*
name|paddr
operator|=
name|ipcp
operator|->
name|my_ip
expr_stmt|;
elseif|else
if|if
condition|(
name|len
operator|>
literal|15
condition|)
name|log_Printf
argument_list|(
name|LogWARN
argument_list|,
literal|"ParseAddr: %s: Bad address\n"
argument_list|,
operator|*
name|argv
argument_list|)
expr_stmt|;
else|else
block|{
name|char
name|s
index|[
literal|16
index|]
decl_stmt|;
name|strncpy
argument_list|(
name|s
argument_list|,
operator|*
name|argv
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|s
index|[
name|len
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|inet_aton
argument_list|(
name|s
argument_list|,
name|paddr
argument_list|)
operator|==
literal|0
condition|)
block|{
name|log_Printf
argument_list|(
name|LogWARN
argument_list|,
literal|"ParseAddr: %s: Bad address\n"
argument_list|,
name|s
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
if|if
condition|(
name|cp
operator|&&
operator|*
operator|++
name|cp
condition|)
block|{
name|bits
operator|=
name|strtol
argument_list|(
name|cp
argument_list|,
operator|&
name|wp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|cp
operator|==
name|wp
operator|||
name|bits
operator|<
literal|0
operator|||
name|bits
operator|>
literal|32
condition|)
block|{
name|log_Printf
argument_list|(
name|LogWARN
argument_list|,
literal|"ParseAddr: bad mask width.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|paddr
operator|->
name|s_addr
operator|==
name|INADDR_ANY
condition|)
comment|/* An IP of 0.0.0.0 without a width is anything */
name|bits
operator|=
literal|0
expr_stmt|;
else|else
comment|/* If a valid IP is given without a width, assume 32 bits */
name|bits
operator|=
literal|32
expr_stmt|;
if|if
condition|(
name|pwidth
condition|)
operator|*
name|pwidth
operator|=
name|bits
expr_stmt|;
if|if
condition|(
name|pmask
condition|)
block|{
if|if
condition|(
name|paddr
operator|->
name|s_addr
operator|==
name|INADDR_ANY
condition|)
name|pmask
operator|->
name|s_addr
operator|=
name|INADDR_ANY
expr_stmt|;
else|else
name|pmask
operator|->
name|s_addr
operator|=
name|htonl
argument_list|(
name|netmasks
index|[
name|bits
index|]
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ParsePort
parameter_list|(
specifier|const
name|char
modifier|*
name|service
parameter_list|,
name|int
name|proto
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|protocol_name
decl_stmt|;
name|char
modifier|*
name|cp
decl_stmt|;
name|struct
name|servent
modifier|*
name|servent
decl_stmt|;
name|int
name|port
decl_stmt|;
switch|switch
condition|(
name|proto
condition|)
block|{
case|case
name|P_UDP
case|:
name|protocol_name
operator|=
literal|"udp"
expr_stmt|;
break|break;
case|case
name|P_TCP
case|:
name|protocol_name
operator|=
literal|"tcp"
expr_stmt|;
break|break;
default|default:
name|protocol_name
operator|=
literal|0
expr_stmt|;
block|}
name|servent
operator|=
name|getservbyname
argument_list|(
name|service
argument_list|,
name|protocol_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|servent
operator|!=
literal|0
condition|)
return|return
operator|(
name|ntohs
argument_list|(
name|servent
operator|->
name|s_port
argument_list|)
operator|)
return|;
name|port
operator|=
name|strtol
argument_list|(
name|service
argument_list|,
operator|&
name|cp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|cp
operator|==
name|service
condition|)
block|{
name|log_Printf
argument_list|(
name|LogWARN
argument_list|,
literal|"ParsePort: %s is not a port name or number.\n"
argument_list|,
name|service
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
return|return
operator|(
name|port
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  *	ICMP Syntax:	src eq icmp_message_type  */
end_comment

begin_function
specifier|static
name|int
name|ParseIcmp
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
specifier|const
modifier|*
specifier|const
modifier|*
name|argv
parameter_list|,
name|struct
name|filterent
modifier|*
name|tgt
parameter_list|)
block|{
name|int
name|type
decl_stmt|;
name|char
modifier|*
name|cp
decl_stmt|;
switch|switch
condition|(
name|argc
condition|)
block|{
case|case
literal|0
case|:
comment|/* permit/deny all ICMP types */
name|tgt
operator|->
name|opt
operator|.
name|srcop
operator|=
name|OP_NONE
expr_stmt|;
break|break;
case|case
literal|3
case|:
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"src"
argument_list|)
operator|&&
operator|!
name|strcmp
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
literal|"eq"
argument_list|)
condition|)
block|{
name|type
operator|=
name|strtol
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|,
operator|&
name|cp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|cp
operator|==
name|argv
index|[
literal|2
index|]
condition|)
block|{
name|log_Printf
argument_list|(
name|LogWARN
argument_list|,
literal|"ParseIcmp: type is expected.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|tgt
operator|->
name|opt
operator|.
name|srcop
operator|=
name|OP_EQ
expr_stmt|;
name|tgt
operator|->
name|opt
operator|.
name|srcport
operator|=
name|type
expr_stmt|;
block|}
break|break;
default|default:
name|log_Printf
argument_list|(
name|LogWARN
argument_list|,
literal|"ParseIcmp: bad icmp syntax.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  *	UDP Syntax: [src op port] [dst op port]  */
end_comment

begin_function
specifier|static
name|int
name|ParseUdpOrTcp
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
specifier|const
modifier|*
specifier|const
modifier|*
name|argv
parameter_list|,
name|int
name|proto
parameter_list|,
name|struct
name|filterent
modifier|*
name|tgt
parameter_list|)
block|{
name|tgt
operator|->
name|opt
operator|.
name|srcop
operator|=
name|tgt
operator|->
name|opt
operator|.
name|dstop
operator|=
name|OP_NONE
expr_stmt|;
name|tgt
operator|->
name|opt
operator|.
name|estab
operator|=
name|tgt
operator|->
name|opt
operator|.
name|syn
operator|=
name|tgt
operator|->
name|opt
operator|.
name|finrst
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|argc
operator|>=
literal|3
operator|&&
operator|!
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"src"
argument_list|)
condition|)
block|{
name|tgt
operator|->
name|opt
operator|.
name|srcop
operator|=
name|filter_Nam2Op
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|tgt
operator|->
name|opt
operator|.
name|srcop
operator|==
name|OP_NONE
condition|)
block|{
name|log_Printf
argument_list|(
name|LogWARN
argument_list|,
literal|"ParseUdpOrTcp: bad operation\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|tgt
operator|->
name|opt
operator|.
name|srcport
operator|=
name|ParsePort
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|,
name|proto
argument_list|)
expr_stmt|;
if|if
condition|(
name|tgt
operator|->
name|opt
operator|.
name|srcport
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|argc
operator|-=
literal|3
expr_stmt|;
name|argv
operator|+=
literal|3
expr_stmt|;
block|}
if|if
condition|(
name|argc
operator|>=
literal|3
operator|&&
operator|!
name|strcmp
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"dst"
argument_list|)
condition|)
block|{
name|tgt
operator|->
name|opt
operator|.
name|dstop
operator|=
name|filter_Nam2Op
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|tgt
operator|->
name|opt
operator|.
name|dstop
operator|==
name|OP_NONE
condition|)
block|{
name|log_Printf
argument_list|(
name|LogWARN
argument_list|,
literal|"ParseUdpOrTcp: bad operation\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|tgt
operator|->
name|opt
operator|.
name|dstport
operator|=
name|ParsePort
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|,
name|proto
argument_list|)
expr_stmt|;
if|if
condition|(
name|tgt
operator|->
name|opt
operator|.
name|dstport
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|argc
operator|-=
literal|3
expr_stmt|;
name|argv
operator|+=
literal|3
expr_stmt|;
block|}
if|if
condition|(
name|proto
operator|==
name|P_TCP
condition|)
block|{
for|for
control|(
init|;
name|argc
operator|>
literal|0
condition|;
name|argc
operator|--
operator|,
name|argv
operator|++
control|)
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"estab"
argument_list|)
condition|)
name|tgt
operator|->
name|opt
operator|.
name|estab
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"syn"
argument_list|)
condition|)
name|tgt
operator|->
name|opt
operator|.
name|syn
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"finrst"
argument_list|)
condition|)
name|tgt
operator|->
name|opt
operator|.
name|finrst
operator|=
literal|1
expr_stmt|;
else|else
break|break;
block|}
if|if
condition|(
name|argc
operator|>
literal|0
condition|)
block|{
name|log_Printf
argument_list|(
name|LogWARN
argument_list|,
literal|"ParseUdpOrTcp: bad src/dst port syntax: %s\n"
argument_list|,
operator|*
name|argv
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|Parse
parameter_list|(
name|struct
name|ipcp
modifier|*
name|ipcp
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
specifier|const
modifier|*
specifier|const
modifier|*
name|argv
parameter_list|,
name|struct
name|filterent
modifier|*
name|ofp
parameter_list|)
block|{
name|int
name|action
decl_stmt|,
name|proto
decl_stmt|;
name|int
name|val
decl_stmt|;
name|char
modifier|*
name|wp
decl_stmt|;
name|struct
name|filterent
name|filterdata
decl_stmt|;
name|val
operator|=
name|strtol
argument_list|(
operator|*
name|argv
argument_list|,
operator|&
name|wp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|argv
operator|==
name|wp
operator|||
name|val
operator|>
name|MAXFILTERS
condition|)
block|{
name|log_Printf
argument_list|(
name|LogWARN
argument_list|,
literal|"Parse: invalid filter number.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|val
operator|<
literal|0
condition|)
block|{
for|for
control|(
name|val
operator|=
literal|0
init|;
name|val
operator|<
name|MAXFILTERS
condition|;
name|val
operator|++
control|)
block|{
name|ofp
operator|->
name|action
operator|=
name|A_NONE
expr_stmt|;
name|ofp
operator|++
expr_stmt|;
block|}
name|log_Printf
argument_list|(
name|LogWARN
argument_list|,
literal|"Parse: filter cleared.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|ofp
operator|+=
name|val
expr_stmt|;
if|if
condition|(
operator|--
name|argc
operator|==
literal|0
condition|)
block|{
name|log_Printf
argument_list|(
name|LogWARN
argument_list|,
literal|"Parse: missing action.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|argv
operator|++
expr_stmt|;
name|proto
operator|=
name|P_NONE
expr_stmt|;
name|memset
argument_list|(
operator|&
name|filterdata
argument_list|,
literal|'\0'
argument_list|,
sizeof|sizeof
name|filterdata
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"permit"
argument_list|)
condition|)
block|{
name|action
operator|=
name|A_PERMIT
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"deny"
argument_list|)
condition|)
block|{
name|action
operator|=
name|A_DENY
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"clear"
argument_list|)
condition|)
block|{
name|ofp
operator|->
name|action
operator|=
name|A_NONE
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
else|else
block|{
name|log_Printf
argument_list|(
name|LogWARN
argument_list|,
literal|"Parse: bad action: %s\n"
argument_list|,
operator|*
name|argv
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|filterdata
operator|.
name|action
operator|=
name|action
expr_stmt|;
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
if|if
condition|(
name|filterdata
operator|.
name|action
operator|==
name|A_DENY
condition|)
block|{
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"host"
argument_list|)
condition|)
block|{
name|filterdata
operator|.
name|action
operator||=
name|A_UHOST
expr_stmt|;
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"port"
argument_list|)
condition|)
block|{
name|filterdata
operator|.
name|action
operator||=
name|A_UPORT
expr_stmt|;
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
block|}
block|}
name|proto
operator|=
name|filter_Nam2Proto
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|)
expr_stmt|;
if|if
condition|(
name|proto
operator|==
name|P_NONE
condition|)
block|{
if|if
condition|(
name|ParseAddr
argument_list|(
name|ipcp
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|,
operator|&
name|filterdata
operator|.
name|saddr
argument_list|,
operator|&
name|filterdata
operator|.
name|smask
argument_list|,
operator|&
name|filterdata
operator|.
name|swidth
argument_list|)
condition|)
block|{
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
name|proto
operator|=
name|filter_Nam2Proto
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|)
expr_stmt|;
if|if
condition|(
name|proto
operator|==
name|P_NONE
condition|)
block|{
if|if
condition|(
name|ParseAddr
argument_list|(
name|ipcp
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|,
operator|&
name|filterdata
operator|.
name|daddr
argument_list|,
operator|&
name|filterdata
operator|.
name|dmask
argument_list|,
operator|&
name|filterdata
operator|.
name|dwidth
argument_list|)
condition|)
block|{
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
block|}
name|proto
operator|=
name|filter_Nam2Proto
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|)
expr_stmt|;
if|if
condition|(
name|proto
operator|!=
name|P_NONE
condition|)
block|{
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
block|}
block|}
else|else
block|{
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
block|}
block|}
else|else
block|{
name|log_Printf
argument_list|(
name|LogWARN
argument_list|,
literal|"Parse: Address/protocol expected.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
else|else
block|{
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
block|}
name|val
operator|=
literal|1
expr_stmt|;
name|filterdata
operator|.
name|proto
operator|=
name|proto
expr_stmt|;
switch|switch
condition|(
name|proto
condition|)
block|{
case|case
name|P_TCP
case|:
name|val
operator|=
name|ParseUdpOrTcp
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|P_TCP
argument_list|,
operator|&
name|filterdata
argument_list|)
expr_stmt|;
break|break;
case|case
name|P_UDP
case|:
name|val
operator|=
name|ParseUdpOrTcp
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|P_UDP
argument_list|,
operator|&
name|filterdata
argument_list|)
expr_stmt|;
break|break;
case|case
name|P_ICMP
case|:
name|val
operator|=
name|ParseIcmp
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
operator|&
name|filterdata
argument_list|)
expr_stmt|;
break|break;
block|}
name|log_Printf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"Parse: Src: %s\n"
argument_list|,
name|inet_ntoa
argument_list|(
name|filterdata
operator|.
name|saddr
argument_list|)
argument_list|)
expr_stmt|;
name|log_Printf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"Parse: Src mask: %s\n"
argument_list|,
name|inet_ntoa
argument_list|(
name|filterdata
operator|.
name|smask
argument_list|)
argument_list|)
expr_stmt|;
name|log_Printf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"Parse: Dst: %s\n"
argument_list|,
name|inet_ntoa
argument_list|(
name|filterdata
operator|.
name|daddr
argument_list|)
argument_list|)
expr_stmt|;
name|log_Printf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"Parse: Dst mask: %s\n"
argument_list|,
name|inet_ntoa
argument_list|(
name|filterdata
operator|.
name|dmask
argument_list|)
argument_list|)
expr_stmt|;
name|log_Printf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"Parse: Proto = %d\n"
argument_list|,
name|proto
argument_list|)
expr_stmt|;
name|log_Printf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"Parse: src:  %s (%d)\n"
argument_list|,
name|filter_Op2Nam
argument_list|(
name|filterdata
operator|.
name|opt
operator|.
name|srcop
argument_list|)
argument_list|,
name|filterdata
operator|.
name|opt
operator|.
name|srcport
argument_list|)
expr_stmt|;
name|log_Printf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"Parse: dst:  %s (%d)\n"
argument_list|,
name|filter_Op2Nam
argument_list|(
name|filterdata
operator|.
name|opt
operator|.
name|dstop
argument_list|)
argument_list|,
name|filterdata
operator|.
name|opt
operator|.
name|dstport
argument_list|)
expr_stmt|;
name|log_Printf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"Parse: estab: %u\n"
argument_list|,
name|filterdata
operator|.
name|opt
operator|.
name|estab
argument_list|)
expr_stmt|;
name|log_Printf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"Parse: syn: %u\n"
argument_list|,
name|filterdata
operator|.
name|opt
operator|.
name|syn
argument_list|)
expr_stmt|;
name|log_Printf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"Parse: finrst: %u\n"
argument_list|,
name|filterdata
operator|.
name|opt
operator|.
name|finrst
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
condition|)
operator|*
name|ofp
operator|=
name|filterdata
expr_stmt|;
return|return
operator|(
name|val
operator|)
return|;
block|}
end_function

begin_function
name|int
name|filter_Set
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|filter
modifier|*
name|filter
decl_stmt|;
if|if
condition|(
name|arg
operator|->
name|argc
operator|<
name|arg
operator|->
name|argn
operator|+
literal|2
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|arg
operator|->
name|argv
index|[
name|arg
operator|->
name|argn
index|]
argument_list|,
literal|"in"
argument_list|)
condition|)
name|filter
operator|=
operator|&
name|arg
operator|->
name|bundle
operator|->
name|filter
operator|.
name|in
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|arg
operator|->
name|argv
index|[
name|arg
operator|->
name|argn
index|]
argument_list|,
literal|"out"
argument_list|)
condition|)
name|filter
operator|=
operator|&
name|arg
operator|->
name|bundle
operator|->
name|filter
operator|.
name|out
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|arg
operator|->
name|argv
index|[
name|arg
operator|->
name|argn
index|]
argument_list|,
literal|"dial"
argument_list|)
condition|)
name|filter
operator|=
operator|&
name|arg
operator|->
name|bundle
operator|->
name|filter
operator|.
name|dial
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|arg
operator|->
name|argv
index|[
name|arg
operator|->
name|argn
index|]
argument_list|,
literal|"alive"
argument_list|)
condition|)
name|filter
operator|=
operator|&
name|arg
operator|->
name|bundle
operator|->
name|filter
operator|.
name|alive
expr_stmt|;
else|else
block|{
name|log_Printf
argument_list|(
name|LogWARN
argument_list|,
literal|"filter_Set: %s: Invalid filter name.\n"
argument_list|,
name|arg
operator|->
name|argv
index|[
name|arg
operator|->
name|argn
index|]
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|Parse
argument_list|(
operator|&
name|arg
operator|->
name|bundle
operator|->
name|ncp
operator|.
name|ipcp
argument_list|,
name|arg
operator|->
name|argc
operator|-
name|arg
operator|->
name|argn
operator|-
literal|1
argument_list|,
name|arg
operator|->
name|argv
operator|+
name|arg
operator|->
name|argn
operator|+
literal|1
argument_list|,
name|filter
operator|->
name|rule
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|filter_Action2Nam
parameter_list|(
name|int
name|act
parameter_list|)
block|{
specifier|static
specifier|const
name|char
modifier|*
name|actname
index|[]
init|=
block|{
literal|"none   "
block|,
literal|"permit "
block|,
literal|"deny   "
block|}
decl_stmt|;
return|return
name|actname
index|[
name|act
operator|&
operator|(
name|A_PERMIT
operator||
name|A_DENY
operator|)
index|]
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|doShowFilter
parameter_list|(
name|struct
name|filterent
modifier|*
name|fp
parameter_list|,
name|struct
name|prompt
modifier|*
name|prompt
parameter_list|)
block|{
name|int
name|n
decl_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|MAXFILTERS
condition|;
name|n
operator|++
operator|,
name|fp
operator|++
control|)
block|{
if|if
condition|(
name|fp
operator|->
name|action
operator|!=
name|A_NONE
condition|)
block|{
name|prompt_Printf
argument_list|(
name|prompt
argument_list|,
literal|"  %2d %s"
argument_list|,
name|n
argument_list|,
name|filter_Action2Nam
argument_list|(
name|fp
operator|->
name|action
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|action
operator|&
name|A_UHOST
condition|)
name|prompt_Printf
argument_list|(
name|prompt
argument_list|,
literal|"host "
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|fp
operator|->
name|action
operator|&
name|A_UPORT
condition|)
name|prompt_Printf
argument_list|(
name|prompt
argument_list|,
literal|"port "
argument_list|)
expr_stmt|;
else|else
name|prompt_Printf
argument_list|(
name|prompt
argument_list|,
literal|"     "
argument_list|)
expr_stmt|;
name|prompt_Printf
argument_list|(
name|prompt
argument_list|,
literal|"%s/%d "
argument_list|,
name|inet_ntoa
argument_list|(
name|fp
operator|->
name|saddr
argument_list|)
argument_list|,
name|fp
operator|->
name|swidth
argument_list|)
expr_stmt|;
name|prompt_Printf
argument_list|(
name|prompt
argument_list|,
literal|"%s/%d "
argument_list|,
name|inet_ntoa
argument_list|(
name|fp
operator|->
name|daddr
argument_list|)
argument_list|,
name|fp
operator|->
name|dwidth
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|proto
condition|)
block|{
name|prompt_Printf
argument_list|(
name|prompt
argument_list|,
literal|"%s"
argument_list|,
name|filter_Proto2Nam
argument_list|(
name|fp
operator|->
name|proto
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|opt
operator|.
name|srcop
condition|)
name|prompt_Printf
argument_list|(
name|prompt
argument_list|,
literal|" src %s %d"
argument_list|,
name|filter_Op2Nam
argument_list|(
name|fp
operator|->
name|opt
operator|.
name|srcop
argument_list|)
argument_list|,
name|fp
operator|->
name|opt
operator|.
name|srcport
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|opt
operator|.
name|dstop
condition|)
name|prompt_Printf
argument_list|(
name|prompt
argument_list|,
literal|" dst %s %d"
argument_list|,
name|filter_Op2Nam
argument_list|(
name|fp
operator|->
name|opt
operator|.
name|dstop
argument_list|)
argument_list|,
name|fp
operator|->
name|opt
operator|.
name|dstport
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|opt
operator|.
name|estab
condition|)
name|prompt_Printf
argument_list|(
name|prompt
argument_list|,
literal|" estab"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|opt
operator|.
name|syn
condition|)
name|prompt_Printf
argument_list|(
name|prompt
argument_list|,
literal|" syn"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|opt
operator|.
name|finrst
condition|)
name|prompt_Printf
argument_list|(
name|prompt
argument_list|,
literal|" finrst"
argument_list|)
expr_stmt|;
block|}
name|prompt_Printf
argument_list|(
name|prompt
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|int
name|filter_Show
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
block|{
if|if
condition|(
name|arg
operator|->
name|argc
operator|>
name|arg
operator|->
name|argn
operator|+
literal|1
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|arg
operator|->
name|argc
operator|==
name|arg
operator|->
name|argn
operator|+
literal|1
condition|)
block|{
name|struct
name|filter
modifier|*
name|filter
decl_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|arg
operator|->
name|argv
index|[
name|arg
operator|->
name|argn
index|]
argument_list|,
literal|"in"
argument_list|)
condition|)
name|filter
operator|=
operator|&
name|arg
operator|->
name|bundle
operator|->
name|filter
operator|.
name|in
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|arg
operator|->
name|argv
index|[
name|arg
operator|->
name|argn
index|]
argument_list|,
literal|"out"
argument_list|)
condition|)
name|filter
operator|=
operator|&
name|arg
operator|->
name|bundle
operator|->
name|filter
operator|.
name|out
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|arg
operator|->
name|argv
index|[
name|arg
operator|->
name|argn
index|]
argument_list|,
literal|"dial"
argument_list|)
condition|)
name|filter
operator|=
operator|&
name|arg
operator|->
name|bundle
operator|->
name|filter
operator|.
name|dial
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|arg
operator|->
name|argv
index|[
name|arg
operator|->
name|argn
index|]
argument_list|,
literal|"alive"
argument_list|)
condition|)
name|filter
operator|=
operator|&
name|arg
operator|->
name|bundle
operator|->
name|filter
operator|.
name|alive
expr_stmt|;
else|else
return|return
operator|-
literal|1
return|;
name|doShowFilter
argument_list|(
name|filter
operator|->
name|rule
argument_list|,
name|arg
operator|->
name|prompt
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|struct
name|filter
modifier|*
name|filter
index|[
literal|4
index|]
decl_stmt|;
name|int
name|f
decl_stmt|;
name|filter
index|[
literal|0
index|]
operator|=
operator|&
name|arg
operator|->
name|bundle
operator|->
name|filter
operator|.
name|in
expr_stmt|;
name|filter
index|[
literal|1
index|]
operator|=
operator|&
name|arg
operator|->
name|bundle
operator|->
name|filter
operator|.
name|out
expr_stmt|;
name|filter
index|[
literal|2
index|]
operator|=
operator|&
name|arg
operator|->
name|bundle
operator|->
name|filter
operator|.
name|dial
expr_stmt|;
name|filter
index|[
literal|3
index|]
operator|=
operator|&
name|arg
operator|->
name|bundle
operator|->
name|filter
operator|.
name|alive
expr_stmt|;
for|for
control|(
name|f
operator|=
literal|0
init|;
name|f
operator|<
literal|4
condition|;
name|f
operator|++
control|)
block|{
if|if
condition|(
name|f
condition|)
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|"%s:\n"
argument_list|,
name|filter
index|[
name|f
index|]
operator|->
name|name
argument_list|)
expr_stmt|;
name|doShowFilter
argument_list|(
name|filter
index|[
name|f
index|]
operator|->
name|rule
argument_list|,
name|arg
operator|->
name|prompt
argument_list|)
expr_stmt|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|protoname
index|[]
init|=
block|{
literal|"none"
block|,
literal|"tcp"
block|,
literal|"udp"
block|,
literal|"icmp"
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|const
name|char
modifier|*
name|filter_Proto2Nam
parameter_list|(
name|int
name|proto
parameter_list|)
block|{
if|if
condition|(
name|proto
operator|>=
sizeof|sizeof
name|protoname
operator|/
sizeof|sizeof
name|protoname
index|[
literal|0
index|]
condition|)
return|return
literal|"unknown"
return|;
return|return
name|protoname
index|[
name|proto
index|]
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|filter_Nam2Proto
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
specifier|const
modifier|*
specifier|const
modifier|*
name|argv
parameter_list|)
block|{
name|int
name|proto
decl_stmt|;
if|if
condition|(
name|argc
operator|==
literal|0
condition|)
name|proto
operator|=
literal|0
expr_stmt|;
else|else
for|for
control|(
name|proto
operator|=
sizeof|sizeof
name|protoname
operator|/
sizeof|sizeof
name|protoname
index|[
literal|0
index|]
operator|-
literal|1
init|;
name|proto
condition|;
name|proto
operator|--
control|)
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
operator|*
name|argv
argument_list|,
name|protoname
index|[
name|proto
index|]
argument_list|)
condition|)
break|break;
return|return
name|proto
return|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|opname
index|[]
init|=
block|{
literal|"none"
block|,
literal|"eq"
block|,
literal|"gt"
block|,
literal|"unknown"
block|,
literal|"lt"
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|const
name|char
modifier|*
name|filter_Op2Nam
parameter_list|(
name|int
name|op
parameter_list|)
block|{
if|if
condition|(
name|op
operator|>=
sizeof|sizeof
name|opname
operator|/
sizeof|sizeof
name|opname
index|[
literal|0
index|]
condition|)
return|return
literal|"unknown"
return|;
return|return
name|opname
index|[
name|op
index|]
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|filter_Nam2Op
parameter_list|(
specifier|const
name|char
modifier|*
name|cp
parameter_list|)
block|{
name|int
name|op
decl_stmt|;
for|for
control|(
name|op
operator|=
sizeof|sizeof
name|opname
operator|/
sizeof|sizeof
name|opname
index|[
literal|0
index|]
operator|-
literal|1
init|;
name|op
condition|;
name|op
operator|--
control|)
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
name|cp
argument_list|,
name|opname
index|[
name|op
index|]
argument_list|)
condition|)
break|break;
return|return
name|op
return|;
block|}
end_function

end_unit


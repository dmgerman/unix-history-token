begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  *	     PPP High Level Link Control (HDLC) Module  *  *	    Written by Toshiharu OHNO (tony-o@iij.ad.jp)  *  *   Copyright (C) 1993, Internet Initiative Japan, Inc. All rights reserverd.  *  * Redistribution and use in source and binary forms are permitted  * provided that the above copyright notice and this paragraph are  * duplicated in all such forms and that any documentation,  * advertising materials, and other materials related to such  * distribution and use acknowledge that the software was developed  * by the Internet Initiative Japan, Inc.  The name of the  * IIJ may not be used to endorse or promote products derived  * from this software without specific prior written permission.  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND WITHOUT ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED  * WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR A PARTICULAR PURPOSE.  *  * $Id: hdlc.c,v 1.11 1997/02/22 16:10:16 peter Exp $  *  *	TODO:  */
end_comment

begin_include
include|#
directive|include
file|"fsm.h"
end_include

begin_include
include|#
directive|include
file|"hdlc.h"
end_include

begin_include
include|#
directive|include
file|"lcpproto.h"
end_include

begin_include
include|#
directive|include
file|"lcp.h"
end_include

begin_include
include|#
directive|include
file|"lqr.h"
end_include

begin_include
include|#
directive|include
file|"vars.h"
end_include

begin_include
include|#
directive|include
file|"pred.h"
end_include

begin_include
include|#
directive|include
file|"modem.h"
end_include

begin_include
include|#
directive|include
file|"ccp.h"
end_include

begin_struct
struct|struct
name|hdlcstat
block|{
name|int
name|badfcs
decl_stmt|;
name|int
name|badaddr
decl_stmt|;
name|int
name|badcommand
decl_stmt|;
name|int
name|unknownproto
decl_stmt|;
block|}
name|HdlcStat
struct|;
end_struct

begin_decl_stmt
specifier|static
name|int
name|ifOutPackets
decl_stmt|,
name|ifOutOctets
decl_stmt|,
name|ifOutLQRs
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|ifInPackets
decl_stmt|,
name|ifInOctets
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|protostat
block|{
name|u_short
name|number
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
name|u_long
name|in_count
decl_stmt|;
name|u_long
name|out_count
decl_stmt|;
block|}
name|ProtocolStat
index|[]
init|=
block|{
block|{
name|PROTO_IP
block|,
literal|"IP"
block|}
block|,
block|{
name|PROTO_VJUNCOMP
block|,
literal|"VJ_UNCOMP"
block|}
block|,
block|{
name|PROTO_VJCOMP
block|,
literal|"VJ_COMP"
block|}
block|,
block|{
name|PROTO_COMPD
block|,
literal|"COMPD"
block|}
block|,
block|{
name|PROTO_LCP
block|,
literal|"LCP"
block|}
block|,
block|{
name|PROTO_IPCP
block|,
literal|"IPCP"
block|}
block|,
block|{
name|PROTO_CCP
block|,
literal|"CCP"
block|}
block|,
block|{
name|PROTO_PAP
block|,
literal|"PAP"
block|}
block|,
block|{
name|PROTO_LQR
block|,
literal|"LQR"
block|}
block|,
block|{
name|PROTO_CHAP
block|,
literal|"CHAP"
block|}
block|,
block|{
literal|0
block|,
literal|"Others"
block|}
block|, }
struct|;
end_struct

begin_decl_stmt
specifier|static
name|u_short
specifier|const
name|fcstab
index|[
literal|256
index|]
init|=
block|{
comment|/* 00 */
literal|0x0000
block|,
literal|0x1189
block|,
literal|0x2312
block|,
literal|0x329b
block|,
literal|0x4624
block|,
literal|0x57ad
block|,
literal|0x6536
block|,
literal|0x74bf
block|,
comment|/* 08 */
literal|0x8c48
block|,
literal|0x9dc1
block|,
literal|0xaf5a
block|,
literal|0xbed3
block|,
literal|0xca6c
block|,
literal|0xdbe5
block|,
literal|0xe97e
block|,
literal|0xf8f7
block|,
comment|/* 10 */
literal|0x1081
block|,
literal|0x0108
block|,
literal|0x3393
block|,
literal|0x221a
block|,
literal|0x56a5
block|,
literal|0x472c
block|,
literal|0x75b7
block|,
literal|0x643e
block|,
comment|/* 18 */
literal|0x9cc9
block|,
literal|0x8d40
block|,
literal|0xbfdb
block|,
literal|0xae52
block|,
literal|0xdaed
block|,
literal|0xcb64
block|,
literal|0xf9ff
block|,
literal|0xe876
block|,
comment|/* 20 */
literal|0x2102
block|,
literal|0x308b
block|,
literal|0x0210
block|,
literal|0x1399
block|,
literal|0x6726
block|,
literal|0x76af
block|,
literal|0x4434
block|,
literal|0x55bd
block|,
comment|/* 28 */
literal|0xad4a
block|,
literal|0xbcc3
block|,
literal|0x8e58
block|,
literal|0x9fd1
block|,
literal|0xeb6e
block|,
literal|0xfae7
block|,
literal|0xc87c
block|,
literal|0xd9f5
block|,
comment|/* 30 */
literal|0x3183
block|,
literal|0x200a
block|,
literal|0x1291
block|,
literal|0x0318
block|,
literal|0x77a7
block|,
literal|0x662e
block|,
literal|0x54b5
block|,
literal|0x453c
block|,
comment|/* 38 */
literal|0xbdcb
block|,
literal|0xac42
block|,
literal|0x9ed9
block|,
literal|0x8f50
block|,
literal|0xfbef
block|,
literal|0xea66
block|,
literal|0xd8fd
block|,
literal|0xc974
block|,
comment|/* 40 */
literal|0x4204
block|,
literal|0x538d
block|,
literal|0x6116
block|,
literal|0x709f
block|,
literal|0x0420
block|,
literal|0x15a9
block|,
literal|0x2732
block|,
literal|0x36bb
block|,
comment|/* 48 */
literal|0xce4c
block|,
literal|0xdfc5
block|,
literal|0xed5e
block|,
literal|0xfcd7
block|,
literal|0x8868
block|,
literal|0x99e1
block|,
literal|0xab7a
block|,
literal|0xbaf3
block|,
comment|/* 50 */
literal|0x5285
block|,
literal|0x430c
block|,
literal|0x7197
block|,
literal|0x601e
block|,
literal|0x14a1
block|,
literal|0x0528
block|,
literal|0x37b3
block|,
literal|0x263a
block|,
comment|/* 58 */
literal|0xdecd
block|,
literal|0xcf44
block|,
literal|0xfddf
block|,
literal|0xec56
block|,
literal|0x98e9
block|,
literal|0x8960
block|,
literal|0xbbfb
block|,
literal|0xaa72
block|,
comment|/* 60 */
literal|0x6306
block|,
literal|0x728f
block|,
literal|0x4014
block|,
literal|0x519d
block|,
literal|0x2522
block|,
literal|0x34ab
block|,
literal|0x0630
block|,
literal|0x17b9
block|,
comment|/* 68 */
literal|0xef4e
block|,
literal|0xfec7
block|,
literal|0xcc5c
block|,
literal|0xddd5
block|,
literal|0xa96a
block|,
literal|0xb8e3
block|,
literal|0x8a78
block|,
literal|0x9bf1
block|,
comment|/* 70 */
literal|0x7387
block|,
literal|0x620e
block|,
literal|0x5095
block|,
literal|0x411c
block|,
literal|0x35a3
block|,
literal|0x242a
block|,
literal|0x16b1
block|,
literal|0x0738
block|,
comment|/* 78 */
literal|0xffcf
block|,
literal|0xee46
block|,
literal|0xdcdd
block|,
literal|0xcd54
block|,
literal|0xb9eb
block|,
literal|0xa862
block|,
literal|0x9af9
block|,
literal|0x8b70
block|,
comment|/* 80 */
literal|0x8408
block|,
literal|0x9581
block|,
literal|0xa71a
block|,
literal|0xb693
block|,
literal|0xc22c
block|,
literal|0xd3a5
block|,
literal|0xe13e
block|,
literal|0xf0b7
block|,
comment|/* 88 */
literal|0x0840
block|,
literal|0x19c9
block|,
literal|0x2b52
block|,
literal|0x3adb
block|,
literal|0x4e64
block|,
literal|0x5fed
block|,
literal|0x6d76
block|,
literal|0x7cff
block|,
comment|/* 90 */
literal|0x9489
block|,
literal|0x8500
block|,
literal|0xb79b
block|,
literal|0xa612
block|,
literal|0xd2ad
block|,
literal|0xc324
block|,
literal|0xf1bf
block|,
literal|0xe036
block|,
comment|/* 98 */
literal|0x18c1
block|,
literal|0x0948
block|,
literal|0x3bd3
block|,
literal|0x2a5a
block|,
literal|0x5ee5
block|,
literal|0x4f6c
block|,
literal|0x7df7
block|,
literal|0x6c7e
block|,
comment|/* a0 */
literal|0xa50a
block|,
literal|0xb483
block|,
literal|0x8618
block|,
literal|0x9791
block|,
literal|0xe32e
block|,
literal|0xf2a7
block|,
literal|0xc03c
block|,
literal|0xd1b5
block|,
comment|/* a8 */
literal|0x2942
block|,
literal|0x38cb
block|,
literal|0x0a50
block|,
literal|0x1bd9
block|,
literal|0x6f66
block|,
literal|0x7eef
block|,
literal|0x4c74
block|,
literal|0x5dfd
block|,
comment|/* b0 */
literal|0xb58b
block|,
literal|0xa402
block|,
literal|0x9699
block|,
literal|0x8710
block|,
literal|0xf3af
block|,
literal|0xe226
block|,
literal|0xd0bd
block|,
literal|0xc134
block|,
comment|/* b8 */
literal|0x39c3
block|,
literal|0x284a
block|,
literal|0x1ad1
block|,
literal|0x0b58
block|,
literal|0x7fe7
block|,
literal|0x6e6e
block|,
literal|0x5cf5
block|,
literal|0x4d7c
block|,
comment|/* c0 */
literal|0xc60c
block|,
literal|0xd785
block|,
literal|0xe51e
block|,
literal|0xf497
block|,
literal|0x8028
block|,
literal|0x91a1
block|,
literal|0xa33a
block|,
literal|0xb2b3
block|,
comment|/* c8 */
literal|0x4a44
block|,
literal|0x5bcd
block|,
literal|0x6956
block|,
literal|0x78df
block|,
literal|0x0c60
block|,
literal|0x1de9
block|,
literal|0x2f72
block|,
literal|0x3efb
block|,
comment|/* d0 */
literal|0xd68d
block|,
literal|0xc704
block|,
literal|0xf59f
block|,
literal|0xe416
block|,
literal|0x90a9
block|,
literal|0x8120
block|,
literal|0xb3bb
block|,
literal|0xa232
block|,
comment|/* d8 */
literal|0x5ac5
block|,
literal|0x4b4c
block|,
literal|0x79d7
block|,
literal|0x685e
block|,
literal|0x1ce1
block|,
literal|0x0d68
block|,
literal|0x3ff3
block|,
literal|0x2e7a
block|,
comment|/* e0 */
literal|0xe70e
block|,
literal|0xf687
block|,
literal|0xc41c
block|,
literal|0xd595
block|,
literal|0xa12a
block|,
literal|0xb0a3
block|,
literal|0x8238
block|,
literal|0x93b1
block|,
comment|/* e8 */
literal|0x6b46
block|,
literal|0x7acf
block|,
literal|0x4854
block|,
literal|0x59dd
block|,
literal|0x2d62
block|,
literal|0x3ceb
block|,
literal|0x0e70
block|,
literal|0x1ff9
block|,
comment|/* f0 */
literal|0xf78f
block|,
literal|0xe606
block|,
literal|0xd49d
block|,
literal|0xc514
block|,
literal|0xb1ab
block|,
literal|0xa022
block|,
literal|0x92b9
block|,
literal|0x8330
block|,
comment|/* f8 */
literal|0x7bc7
block|,
literal|0x6a4e
block|,
literal|0x58d5
block|,
literal|0x495c
block|,
literal|0x3de3
block|,
literal|0x2c6a
block|,
literal|0x1ef1
block|,
literal|0x0f78
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|HdlcInit
parameter_list|()
block|{
name|ifInOctets
operator|=
name|ifOutOctets
operator|=
literal|0
expr_stmt|;
name|ifInPackets
operator|=
name|ifOutPackets
operator|=
literal|0
expr_stmt|;
name|ifOutLQRs
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  *  HDLC FCS computation. Read RFC 1171 Appendix B and CCITT X.25 section  *  2.27 for further details.  */
end_comment

begin_function
specifier|inline
name|u_short
name|HdlcFcs
parameter_list|(
name|fcs
parameter_list|,
name|cp
parameter_list|,
name|len
parameter_list|)
name|u_short
name|fcs
decl_stmt|;
name|u_char
modifier|*
name|cp
decl_stmt|;
name|int
name|len
decl_stmt|;
block|{
while|while
condition|(
name|len
operator|--
condition|)
name|fcs
operator|=
operator|(
name|fcs
operator|>>
literal|8
operator|)
operator|^
name|fcstab
index|[
operator|(
name|fcs
operator|^
operator|*
name|cp
operator|++
operator|)
operator|&
literal|0xff
index|]
expr_stmt|;
return|return
operator|(
name|fcs
operator|)
return|;
block|}
end_function

begin_function
name|void
name|HdlcOutput
parameter_list|(
name|int
name|pri
parameter_list|,
name|u_short
name|proto
parameter_list|,
name|struct
name|mbuf
modifier|*
name|bp
parameter_list|)
block|{
name|struct
name|mbuf
modifier|*
name|mhp
decl_stmt|,
modifier|*
name|mfcs
decl_stmt|;
name|struct
name|protostat
modifier|*
name|statp
decl_stmt|;
name|struct
name|lqrdata
modifier|*
name|lqr
decl_stmt|;
name|u_char
modifier|*
name|cp
decl_stmt|;
name|u_short
name|fcs
decl_stmt|;
if|if
condition|(
operator|(
name|proto
operator|&
literal|0xfff1
operator|)
operator|==
literal|0x21
condition|)
block|{
comment|/* Network Layer protocol */
if|if
condition|(
name|CcpFsm
operator|.
name|state
operator|==
name|ST_OPENED
condition|)
block|{
name|Pred1Output
argument_list|(
name|pri
argument_list|,
name|proto
argument_list|,
name|bp
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
if|if
condition|(
name|DEV_IS_SYNC
condition|)
name|mfcs
operator|=
name|NULLBUFF
expr_stmt|;
else|else
name|mfcs
operator|=
name|mballoc
argument_list|(
literal|2
argument_list|,
name|MB_HDLCOUT
argument_list|)
expr_stmt|;
name|mhp
operator|=
name|mballoc
argument_list|(
literal|4
argument_list|,
name|MB_HDLCOUT
argument_list|)
expr_stmt|;
name|mhp
operator|->
name|cnt
operator|=
literal|0
expr_stmt|;
name|cp
operator|=
name|MBUF_CTOP
argument_list|(
name|mhp
argument_list|)
expr_stmt|;
if|if
condition|(
name|proto
operator|==
name|PROTO_LCP
operator|||
name|LcpInfo
operator|.
name|his_acfcomp
operator|==
literal|0
condition|)
block|{
operator|*
name|cp
operator|++
operator|=
name|HDLC_ADDR
expr_stmt|;
operator|*
name|cp
operator|++
operator|=
name|HDLC_UI
expr_stmt|;
name|mhp
operator|->
name|cnt
operator|+=
literal|2
expr_stmt|;
block|}
comment|/*    *  If possible, compress protocol field.    */
if|if
condition|(
name|LcpInfo
operator|.
name|his_protocomp
operator|&&
operator|(
name|proto
operator|&
literal|0xff00
operator|)
operator|==
literal|0
condition|)
block|{
operator|*
name|cp
operator|++
operator|=
name|proto
expr_stmt|;
name|mhp
operator|->
name|cnt
operator|++
expr_stmt|;
block|}
else|else
block|{
operator|*
name|cp
operator|++
operator|=
name|proto
operator|>>
literal|8
expr_stmt|;
operator|*
name|cp
operator|=
name|proto
operator|&
literal|0377
expr_stmt|;
name|mhp
operator|->
name|cnt
operator|+=
literal|2
expr_stmt|;
block|}
name|mhp
operator|->
name|next
operator|=
name|bp
expr_stmt|;
name|bp
operator|->
name|next
operator|=
name|mfcs
expr_stmt|;
name|lqr
operator|=
operator|&
name|MyLqrData
expr_stmt|;
name|lqr
operator|->
name|PeerOutPackets
operator|=
name|ifOutPackets
operator|++
expr_stmt|;
name|ifOutOctets
operator|+=
name|plength
argument_list|(
name|mhp
argument_list|)
operator|+
literal|1
expr_stmt|;
name|lqr
operator|->
name|PeerOutOctets
operator|=
name|ifOutOctets
expr_stmt|;
if|if
condition|(
name|proto
operator|==
name|PROTO_LQR
condition|)
block|{
name|lqr
operator|->
name|MagicNumber
operator|=
name|LcpInfo
operator|.
name|want_magic
expr_stmt|;
name|lqr
operator|->
name|LastOutLQRs
operator|=
name|HisLqrData
operator|.
name|PeerOutLQRs
expr_stmt|;
name|lqr
operator|->
name|LastOutPackets
operator|=
name|HisLqrData
operator|.
name|PeerOutPackets
expr_stmt|;
name|lqr
operator|->
name|LastOutOctets
operator|=
name|HisLqrData
operator|.
name|PeerOutOctets
expr_stmt|;
name|lqr
operator|->
name|PeerInLQRs
operator|=
name|HisLqrSave
operator|.
name|SaveInLQRs
expr_stmt|;
name|lqr
operator|->
name|PeerInPackets
operator|=
name|HisLqrSave
operator|.
name|SaveInPackets
expr_stmt|;
name|lqr
operator|->
name|PeerInDiscards
operator|=
name|HisLqrSave
operator|.
name|SaveInDiscards
expr_stmt|;
name|lqr
operator|->
name|PeerInErrors
operator|=
name|HisLqrSave
operator|.
name|SaveInErrors
expr_stmt|;
name|lqr
operator|->
name|PeerInOctets
operator|=
name|HisLqrSave
operator|.
name|SaveInOctets
expr_stmt|;
name|lqr
operator|->
name|PeerOutLQRs
operator|=
operator|++
name|ifOutLQRs
expr_stmt|;
name|LqrDump
argument_list|(
literal|"LqrOutput"
argument_list|,
name|lqr
argument_list|)
expr_stmt|;
name|LqrChangeOrder
argument_list|(
name|lqr
argument_list|,
operator|(
expr|struct
name|lqrdata
operator|*
operator|)
operator|(
name|MBUF_CTOP
argument_list|(
name|bp
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|DEV_IS_SYNC
condition|)
block|{
name|fcs
operator|=
name|HdlcFcs
argument_list|(
name|INITFCS
argument_list|,
name|MBUF_CTOP
argument_list|(
name|mhp
argument_list|)
argument_list|,
name|mhp
operator|->
name|cnt
argument_list|)
expr_stmt|;
name|fcs
operator|=
name|HdlcFcs
argument_list|(
name|fcs
argument_list|,
name|MBUF_CTOP
argument_list|(
name|bp
argument_list|)
argument_list|,
name|bp
operator|->
name|cnt
argument_list|)
expr_stmt|;
name|fcs
operator|=
operator|~
name|fcs
expr_stmt|;
name|cp
operator|=
name|MBUF_CTOP
argument_list|(
name|mfcs
argument_list|)
expr_stmt|;
operator|*
name|cp
operator|++
operator|=
name|fcs
operator|&
literal|0377
expr_stmt|;
comment|/* Low byte first!! */
operator|*
name|cp
operator|++
operator|=
name|fcs
operator|>>
literal|8
expr_stmt|;
block|}
name|LogDumpBp
argument_list|(
name|LOG_HDLC
argument_list|,
literal|"HdlcOutput"
argument_list|,
name|mhp
argument_list|)
expr_stmt|;
for|for
control|(
name|statp
operator|=
name|ProtocolStat
init|;
name|statp
operator|->
name|number
condition|;
name|statp
operator|++
control|)
if|if
condition|(
name|statp
operator|->
name|number
operator|==
name|proto
condition|)
break|break;
name|statp
operator|->
name|out_count
operator|++
expr_stmt|;
if|if
condition|(
name|DEV_IS_SYNC
condition|)
name|ModemOutput
argument_list|(
name|pri
argument_list|,
name|mhp
argument_list|)
expr_stmt|;
else|else
name|AsyncOutput
argument_list|(
name|pri
argument_list|,
name|mhp
argument_list|,
name|proto
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|DecodePacket
parameter_list|(
name|proto
parameter_list|,
name|bp
parameter_list|)
name|u_short
name|proto
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|bp
decl_stmt|;
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|logprintf
argument_list|(
literal|"proto = %04x\n"
argument_list|,
name|proto
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|u_char
modifier|*
name|cp
decl_stmt|;
switch|switch
condition|(
name|proto
condition|)
block|{
case|case
name|PROTO_LCP
case|:
name|LcpInput
argument_list|(
name|bp
argument_list|)
expr_stmt|;
break|break;
case|case
name|PROTO_PAP
case|:
name|PapInput
argument_list|(
name|bp
argument_list|)
expr_stmt|;
break|break;
case|case
name|PROTO_LQR
case|:
name|HisLqrSave
operator|.
name|SaveInLQRs
operator|++
expr_stmt|;
name|LqrInput
argument_list|(
name|bp
argument_list|)
expr_stmt|;
break|break;
case|case
name|PROTO_CHAP
case|:
name|ChapInput
argument_list|(
name|bp
argument_list|)
expr_stmt|;
break|break;
case|case
name|PROTO_VJUNCOMP
case|:
case|case
name|PROTO_VJCOMP
case|:
name|bp
operator|=
name|VjCompInput
argument_list|(
name|bp
argument_list|,
name|proto
argument_list|)
expr_stmt|;
if|if
condition|(
name|bp
operator|==
name|NULLBUFF
condition|)
block|{
break|break;
block|}
comment|/* fall down */
case|case
name|PROTO_IP
case|:
name|IpInput
argument_list|(
name|bp
argument_list|)
expr_stmt|;
break|break;
case|case
name|PROTO_IPCP
case|:
name|IpcpInput
argument_list|(
name|bp
argument_list|)
expr_stmt|;
break|break;
case|case
name|PROTO_CCP
case|:
name|CcpInput
argument_list|(
name|bp
argument_list|)
expr_stmt|;
break|break;
case|case
name|PROTO_COMPD
case|:
name|Pred1Input
argument_list|(
name|bp
argument_list|)
expr_stmt|;
break|break;
default|default:
name|LogPrintf
argument_list|(
name|LOG_PHASE_BIT
argument_list|,
literal|"Unknown protocol 0x%04x\n"
argument_list|,
name|proto
argument_list|)
expr_stmt|;
name|bp
operator|->
name|offset
operator|-=
literal|2
expr_stmt|;
name|bp
operator|->
name|cnt
operator|+=
literal|2
expr_stmt|;
name|cp
operator|=
name|MBUF_CTOP
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|LcpSendProtoRej
argument_list|(
name|cp
argument_list|,
name|bp
operator|->
name|cnt
argument_list|)
expr_stmt|;
name|HisLqrSave
operator|.
name|SaveInDiscards
operator|++
expr_stmt|;
name|HdlcStat
operator|.
name|unknownproto
operator|++
expr_stmt|;
name|pfree
argument_list|(
name|bp
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
name|int
name|ReportProtStatus
parameter_list|()
block|{
name|struct
name|protostat
modifier|*
name|statp
decl_stmt|;
name|int
name|cnt
decl_stmt|;
name|statp
operator|=
name|ProtocolStat
expr_stmt|;
name|statp
operator|--
expr_stmt|;
name|cnt
operator|=
literal|0
expr_stmt|;
name|printf
argument_list|(
literal|"    Protocol     in        out      Protocol      in       out\n"
argument_list|)
expr_stmt|;
do|do
block|{
name|statp
operator|++
expr_stmt|;
name|printf
argument_list|(
literal|"   %-9s: %8lu, %8lu"
argument_list|,
name|statp
operator|->
name|name
argument_list|,
name|statp
operator|->
name|in_count
argument_list|,
name|statp
operator|->
name|out_count
argument_list|)
expr_stmt|;
if|if
condition|(
operator|++
name|cnt
operator|==
literal|2
condition|)
block|{
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|cnt
operator|=
literal|0
expr_stmt|;
block|}
block|}
do|while
condition|(
name|statp
operator|->
name|number
condition|)
do|;
if|if
condition|(
name|cnt
condition|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ReportHdlcStatus
parameter_list|()
block|{
name|struct
name|hdlcstat
modifier|*
name|hp
init|=
operator|&
name|HdlcStat
decl_stmt|;
name|printf
argument_list|(
literal|"HDLC level errors\n\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"FCS: %u  ADDR: %u  COMMAND: %u  PROTO: %u\n"
argument_list|,
name|hp
operator|->
name|badfcs
argument_list|,
name|hp
operator|->
name|badaddr
argument_list|,
name|hp
operator|->
name|badcommand
argument_list|,
name|hp
operator|->
name|unknownproto
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|struct
name|hdlcstat
name|laststat
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|HdlcErrorCheck
parameter_list|()
block|{
name|struct
name|hdlcstat
modifier|*
name|hp
init|=
operator|&
name|HdlcStat
decl_stmt|;
name|struct
name|hdlcstat
modifier|*
name|op
init|=
operator|&
name|laststat
decl_stmt|;
if|if
condition|(
name|bcmp
argument_list|(
name|hp
argument_list|,
name|op
argument_list|,
sizeof|sizeof
argument_list|(
name|laststat
argument_list|)
argument_list|)
condition|)
block|{
name|LogPrintf
argument_list|(
name|LOG_PHASE_BIT
argument_list|,
literal|"HDLC errors -> FCS: %u ADDR: %u COMD: %u PROTO: %u\n"
argument_list|,
name|hp
operator|->
name|badfcs
operator|-
name|op
operator|->
name|badfcs
argument_list|,
name|hp
operator|->
name|badaddr
operator|-
name|op
operator|->
name|badaddr
argument_list|,
name|hp
operator|->
name|badcommand
operator|-
name|op
operator|->
name|badcommand
argument_list|,
name|hp
operator|->
name|unknownproto
operator|-
name|op
operator|->
name|unknownproto
argument_list|)
expr_stmt|;
block|}
name|laststat
operator|=
name|HdlcStat
expr_stmt|;
block|}
end_function

begin_function
name|void
name|HdlcInput
parameter_list|(
name|struct
name|mbuf
modifier|*
name|bp
parameter_list|)
block|{
name|u_short
name|fcs
decl_stmt|,
name|proto
decl_stmt|;
name|u_char
modifier|*
name|cp
decl_stmt|,
name|addr
decl_stmt|,
name|ctrl
decl_stmt|;
name|struct
name|protostat
modifier|*
name|statp
decl_stmt|;
name|LogDumpBp
argument_list|(
name|LOG_HDLC
argument_list|,
literal|"HdlcInput:"
argument_list|,
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
name|DEV_IS_SYNC
condition|)
name|fcs
operator|=
name|GOODFCS
expr_stmt|;
else|else
name|fcs
operator|=
name|HdlcFcs
argument_list|(
name|INITFCS
argument_list|,
name|MBUF_CTOP
argument_list|(
name|bp
argument_list|)
argument_list|,
name|bp
operator|->
name|cnt
argument_list|)
expr_stmt|;
name|HisLqrSave
operator|.
name|SaveInOctets
operator|+=
name|bp
operator|->
name|cnt
operator|+
literal|1
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|logprintf
argument_list|(
literal|"fcs = %04x (%s)\n"
argument_list|,
name|fcs
argument_list|,
operator|(
name|fcs
operator|==
name|GOODFCS
operator|)
condition|?
literal|"good"
else|:
literal|"bad"
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|fcs
operator|!=
name|GOODFCS
condition|)
block|{
name|HisLqrSave
operator|.
name|SaveInErrors
operator|++
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|logprintf
argument_list|(
literal|"Bad FCS\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|HdlcStat
operator|.
name|badfcs
operator|++
expr_stmt|;
name|pfree
argument_list|(
name|bp
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|!
name|DEV_IS_SYNC
condition|)
name|bp
operator|->
name|cnt
operator|-=
literal|2
expr_stmt|;
comment|/* discard FCS part */
if|if
condition|(
name|bp
operator|->
name|cnt
operator|<
literal|2
condition|)
block|{
comment|/* XXX: raise this bar ? */
name|bfree
argument_list|(
name|bp
argument_list|)
expr_stmt|;
return|return;
block|}
name|cp
operator|=
name|MBUF_CTOP
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|ifInPackets
operator|++
expr_stmt|;
name|ifInOctets
operator|+=
name|bp
operator|->
name|cnt
expr_stmt|;
if|if
condition|(
operator|!
name|LcpInfo
operator|.
name|want_acfcomp
condition|)
block|{
comment|/*      *  We expect that packet is not compressed.      */
name|addr
operator|=
operator|*
name|cp
operator|++
expr_stmt|;
if|if
condition|(
name|addr
operator|!=
name|HDLC_ADDR
condition|)
block|{
name|HisLqrSave
operator|.
name|SaveInErrors
operator|++
expr_stmt|;
name|HdlcStat
operator|.
name|badaddr
operator|++
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|logprintf
argument_list|(
literal|"addr %02x\n"
argument_list|,
operator|*
name|cp
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pfree
argument_list|(
name|bp
argument_list|)
expr_stmt|;
return|return;
block|}
name|ctrl
operator|=
operator|*
name|cp
operator|++
expr_stmt|;
if|if
condition|(
name|ctrl
operator|!=
name|HDLC_UI
condition|)
block|{
name|HisLqrSave
operator|.
name|SaveInErrors
operator|++
expr_stmt|;
name|HdlcStat
operator|.
name|badcommand
operator|++
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|logprintf
argument_list|(
literal|"command %02x\n"
argument_list|,
operator|*
name|cp
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pfree
argument_list|(
name|bp
argument_list|)
expr_stmt|;
return|return;
block|}
name|bp
operator|->
name|offset
operator|+=
literal|2
expr_stmt|;
name|bp
operator|->
name|cnt
operator|-=
literal|2
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cp
index|[
literal|0
index|]
operator|==
name|HDLC_ADDR
operator|&&
name|cp
index|[
literal|1
index|]
operator|==
name|HDLC_UI
condition|)
block|{
comment|/*      *  We can receive compressed packet, but peer still send      *  uncompressed packet to me.      */
name|cp
operator|+=
literal|2
expr_stmt|;
name|bp
operator|->
name|offset
operator|+=
literal|2
expr_stmt|;
name|bp
operator|->
name|cnt
operator|-=
literal|2
expr_stmt|;
block|}
if|if
condition|(
name|LcpInfo
operator|.
name|want_protocomp
condition|)
block|{
name|proto
operator|=
literal|0
expr_stmt|;
name|cp
operator|--
expr_stmt|;
do|do
block|{
name|cp
operator|++
expr_stmt|;
name|bp
operator|->
name|offset
operator|++
expr_stmt|;
name|bp
operator|->
name|cnt
operator|--
expr_stmt|;
name|proto
operator|=
name|proto
operator|<<
literal|8
expr_stmt|;
name|proto
operator|+=
operator|*
name|cp
expr_stmt|;
block|}
do|while
condition|(
operator|!
operator|(
name|proto
operator|&
literal|1
operator|)
condition|)
do|;
block|}
else|else
block|{
name|proto
operator|=
operator|*
name|cp
operator|++
operator|<<
literal|8
expr_stmt|;
name|proto
operator||=
operator|*
name|cp
operator|++
expr_stmt|;
name|bp
operator|->
name|offset
operator|+=
literal|2
expr_stmt|;
name|bp
operator|->
name|cnt
operator|-=
literal|2
expr_stmt|;
block|}
for|for
control|(
name|statp
operator|=
name|ProtocolStat
init|;
name|statp
operator|->
name|number
condition|;
name|statp
operator|++
control|)
if|if
condition|(
name|statp
operator|->
name|number
operator|==
name|proto
condition|)
break|break;
name|statp
operator|->
name|in_count
operator|++
expr_stmt|;
name|HisLqrSave
operator|.
name|SaveInPackets
operator|++
expr_stmt|;
name|DecodePacket
argument_list|(
name|proto
argument_list|,
name|bp
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


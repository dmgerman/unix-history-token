begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  *	     PPP High Level Link Control (HDLC) Module  *  *	    Written by Toshiharu OHNO (tony-o@iij.ad.jp)  *  *   Copyright (C) 1993, Internet Initiative Japan, Inc. All rights reserverd.  *  * Redistribution and use in source and binary forms are permitted  * provided that the above copyright notice and this paragraph are  * duplicated in all such forms and that any documentation,  * advertising materials, and other materials related to such  * distribution and use acknowledge that the software was developed  * by the Internet Initiative Japan, Inc.  The name of the  * IIJ may not be used to endorse or promote products derived  * from this software without specific prior written permission.  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND WITHOUT ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED  * WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR A PARTICULAR PURPOSE.  *  * $Id: hdlc.c,v 1.28.2.37 1998/05/21 01:26:07 brian Exp $  *  *	TODO:  */
end_comment

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_systm.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip.h>
end_include

begin_include
include|#
directive|include
file|<sys/un.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<termios.h>
end_include

begin_include
include|#
directive|include
file|"command.h"
end_include

begin_include
include|#
directive|include
file|"mbuf.h"
end_include

begin_include
include|#
directive|include
file|"log.h"
end_include

begin_include
include|#
directive|include
file|"defs.h"
end_include

begin_include
include|#
directive|include
file|"timer.h"
end_include

begin_include
include|#
directive|include
file|"fsm.h"
end_include

begin_include
include|#
directive|include
file|"lqr.h"
end_include

begin_include
include|#
directive|include
file|"hdlc.h"
end_include

begin_include
include|#
directive|include
file|"lcpproto.h"
end_include

begin_include
include|#
directive|include
file|"iplist.h"
end_include

begin_include
include|#
directive|include
file|"throughput.h"
end_include

begin_include
include|#
directive|include
file|"slcompress.h"
end_include

begin_include
include|#
directive|include
file|"ipcp.h"
end_include

begin_include
include|#
directive|include
file|"ip.h"
end_include

begin_include
include|#
directive|include
file|"vjcomp.h"
end_include

begin_include
include|#
directive|include
file|"auth.h"
end_include

begin_include
include|#
directive|include
file|"pap.h"
end_include

begin_include
include|#
directive|include
file|"chap.h"
end_include

begin_include
include|#
directive|include
file|"lcp.h"
end_include

begin_include
include|#
directive|include
file|"async.h"
end_include

begin_include
include|#
directive|include
file|"ccp.h"
end_include

begin_include
include|#
directive|include
file|"link.h"
end_include

begin_include
include|#
directive|include
file|"descriptor.h"
end_include

begin_include
include|#
directive|include
file|"physical.h"
end_include

begin_include
include|#
directive|include
file|"prompt.h"
end_include

begin_include
include|#
directive|include
file|"chat.h"
end_include

begin_include
include|#
directive|include
file|"mp.h"
end_include

begin_include
include|#
directive|include
file|"datalink.h"
end_include

begin_include
include|#
directive|include
file|"filter.h"
end_include

begin_include
include|#
directive|include
file|"bundle.h"
end_include

begin_decl_stmt
specifier|static
name|u_short
specifier|const
name|fcstab
index|[
literal|256
index|]
init|=
block|{
comment|/* 00 */
literal|0x0000
block|,
literal|0x1189
block|,
literal|0x2312
block|,
literal|0x329b
block|,
literal|0x4624
block|,
literal|0x57ad
block|,
literal|0x6536
block|,
literal|0x74bf
block|,
comment|/* 08 */
literal|0x8c48
block|,
literal|0x9dc1
block|,
literal|0xaf5a
block|,
literal|0xbed3
block|,
literal|0xca6c
block|,
literal|0xdbe5
block|,
literal|0xe97e
block|,
literal|0xf8f7
block|,
comment|/* 10 */
literal|0x1081
block|,
literal|0x0108
block|,
literal|0x3393
block|,
literal|0x221a
block|,
literal|0x56a5
block|,
literal|0x472c
block|,
literal|0x75b7
block|,
literal|0x643e
block|,
comment|/* 18 */
literal|0x9cc9
block|,
literal|0x8d40
block|,
literal|0xbfdb
block|,
literal|0xae52
block|,
literal|0xdaed
block|,
literal|0xcb64
block|,
literal|0xf9ff
block|,
literal|0xe876
block|,
comment|/* 20 */
literal|0x2102
block|,
literal|0x308b
block|,
literal|0x0210
block|,
literal|0x1399
block|,
literal|0x6726
block|,
literal|0x76af
block|,
literal|0x4434
block|,
literal|0x55bd
block|,
comment|/* 28 */
literal|0xad4a
block|,
literal|0xbcc3
block|,
literal|0x8e58
block|,
literal|0x9fd1
block|,
literal|0xeb6e
block|,
literal|0xfae7
block|,
literal|0xc87c
block|,
literal|0xd9f5
block|,
comment|/* 30 */
literal|0x3183
block|,
literal|0x200a
block|,
literal|0x1291
block|,
literal|0x0318
block|,
literal|0x77a7
block|,
literal|0x662e
block|,
literal|0x54b5
block|,
literal|0x453c
block|,
comment|/* 38 */
literal|0xbdcb
block|,
literal|0xac42
block|,
literal|0x9ed9
block|,
literal|0x8f50
block|,
literal|0xfbef
block|,
literal|0xea66
block|,
literal|0xd8fd
block|,
literal|0xc974
block|,
comment|/* 40 */
literal|0x4204
block|,
literal|0x538d
block|,
literal|0x6116
block|,
literal|0x709f
block|,
literal|0x0420
block|,
literal|0x15a9
block|,
literal|0x2732
block|,
literal|0x36bb
block|,
comment|/* 48 */
literal|0xce4c
block|,
literal|0xdfc5
block|,
literal|0xed5e
block|,
literal|0xfcd7
block|,
literal|0x8868
block|,
literal|0x99e1
block|,
literal|0xab7a
block|,
literal|0xbaf3
block|,
comment|/* 50 */
literal|0x5285
block|,
literal|0x430c
block|,
literal|0x7197
block|,
literal|0x601e
block|,
literal|0x14a1
block|,
literal|0x0528
block|,
literal|0x37b3
block|,
literal|0x263a
block|,
comment|/* 58 */
literal|0xdecd
block|,
literal|0xcf44
block|,
literal|0xfddf
block|,
literal|0xec56
block|,
literal|0x98e9
block|,
literal|0x8960
block|,
literal|0xbbfb
block|,
literal|0xaa72
block|,
comment|/* 60 */
literal|0x6306
block|,
literal|0x728f
block|,
literal|0x4014
block|,
literal|0x519d
block|,
literal|0x2522
block|,
literal|0x34ab
block|,
literal|0x0630
block|,
literal|0x17b9
block|,
comment|/* 68 */
literal|0xef4e
block|,
literal|0xfec7
block|,
literal|0xcc5c
block|,
literal|0xddd5
block|,
literal|0xa96a
block|,
literal|0xb8e3
block|,
literal|0x8a78
block|,
literal|0x9bf1
block|,
comment|/* 70 */
literal|0x7387
block|,
literal|0x620e
block|,
literal|0x5095
block|,
literal|0x411c
block|,
literal|0x35a3
block|,
literal|0x242a
block|,
literal|0x16b1
block|,
literal|0x0738
block|,
comment|/* 78 */
literal|0xffcf
block|,
literal|0xee46
block|,
literal|0xdcdd
block|,
literal|0xcd54
block|,
literal|0xb9eb
block|,
literal|0xa862
block|,
literal|0x9af9
block|,
literal|0x8b70
block|,
comment|/* 80 */
literal|0x8408
block|,
literal|0x9581
block|,
literal|0xa71a
block|,
literal|0xb693
block|,
literal|0xc22c
block|,
literal|0xd3a5
block|,
literal|0xe13e
block|,
literal|0xf0b7
block|,
comment|/* 88 */
literal|0x0840
block|,
literal|0x19c9
block|,
literal|0x2b52
block|,
literal|0x3adb
block|,
literal|0x4e64
block|,
literal|0x5fed
block|,
literal|0x6d76
block|,
literal|0x7cff
block|,
comment|/* 90 */
literal|0x9489
block|,
literal|0x8500
block|,
literal|0xb79b
block|,
literal|0xa612
block|,
literal|0xd2ad
block|,
literal|0xc324
block|,
literal|0xf1bf
block|,
literal|0xe036
block|,
comment|/* 98 */
literal|0x18c1
block|,
literal|0x0948
block|,
literal|0x3bd3
block|,
literal|0x2a5a
block|,
literal|0x5ee5
block|,
literal|0x4f6c
block|,
literal|0x7df7
block|,
literal|0x6c7e
block|,
comment|/* a0 */
literal|0xa50a
block|,
literal|0xb483
block|,
literal|0x8618
block|,
literal|0x9791
block|,
literal|0xe32e
block|,
literal|0xf2a7
block|,
literal|0xc03c
block|,
literal|0xd1b5
block|,
comment|/* a8 */
literal|0x2942
block|,
literal|0x38cb
block|,
literal|0x0a50
block|,
literal|0x1bd9
block|,
literal|0x6f66
block|,
literal|0x7eef
block|,
literal|0x4c74
block|,
literal|0x5dfd
block|,
comment|/* b0 */
literal|0xb58b
block|,
literal|0xa402
block|,
literal|0x9699
block|,
literal|0x8710
block|,
literal|0xf3af
block|,
literal|0xe226
block|,
literal|0xd0bd
block|,
literal|0xc134
block|,
comment|/* b8 */
literal|0x39c3
block|,
literal|0x284a
block|,
literal|0x1ad1
block|,
literal|0x0b58
block|,
literal|0x7fe7
block|,
literal|0x6e6e
block|,
literal|0x5cf5
block|,
literal|0x4d7c
block|,
comment|/* c0 */
literal|0xc60c
block|,
literal|0xd785
block|,
literal|0xe51e
block|,
literal|0xf497
block|,
literal|0x8028
block|,
literal|0x91a1
block|,
literal|0xa33a
block|,
literal|0xb2b3
block|,
comment|/* c8 */
literal|0x4a44
block|,
literal|0x5bcd
block|,
literal|0x6956
block|,
literal|0x78df
block|,
literal|0x0c60
block|,
literal|0x1de9
block|,
literal|0x2f72
block|,
literal|0x3efb
block|,
comment|/* d0 */
literal|0xd68d
block|,
literal|0xc704
block|,
literal|0xf59f
block|,
literal|0xe416
block|,
literal|0x90a9
block|,
literal|0x8120
block|,
literal|0xb3bb
block|,
literal|0xa232
block|,
comment|/* d8 */
literal|0x5ac5
block|,
literal|0x4b4c
block|,
literal|0x79d7
block|,
literal|0x685e
block|,
literal|0x1ce1
block|,
literal|0x0d68
block|,
literal|0x3ff3
block|,
literal|0x2e7a
block|,
comment|/* e0 */
literal|0xe70e
block|,
literal|0xf687
block|,
literal|0xc41c
block|,
literal|0xd595
block|,
literal|0xa12a
block|,
literal|0xb0a3
block|,
literal|0x8238
block|,
literal|0x93b1
block|,
comment|/* e8 */
literal|0x6b46
block|,
literal|0x7acf
block|,
literal|0x4854
block|,
literal|0x59dd
block|,
literal|0x2d62
block|,
literal|0x3ceb
block|,
literal|0x0e70
block|,
literal|0x1ff9
block|,
comment|/* f0 */
literal|0xf78f
block|,
literal|0xe606
block|,
literal|0xd49d
block|,
literal|0xc514
block|,
literal|0xb1ab
block|,
literal|0xa022
block|,
literal|0x92b9
block|,
literal|0x8330
block|,
comment|/* f8 */
literal|0x7bc7
block|,
literal|0x6a4e
block|,
literal|0x58d5
block|,
literal|0x495c
block|,
literal|0x3de3
block|,
literal|0x2c6a
block|,
literal|0x1ef1
block|,
literal|0x0f78
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|hdlc_Init
parameter_list|(
name|struct
name|hdlc
modifier|*
name|hdlc
parameter_list|,
name|struct
name|lcp
modifier|*
name|lcp
parameter_list|)
block|{
name|memset
argument_list|(
name|hdlc
argument_list|,
literal|'\0'
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|hdlc
argument_list|)
argument_list|)
expr_stmt|;
name|hdlc
operator|->
name|lqm
operator|.
name|owner
operator|=
name|lcp
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  *  HDLC FCS computation. Read RFC 1171 Appendix B and CCITT X.25 section  *  2.27 for further details.  */
end_comment

begin_function
specifier|inline
name|u_short
name|hdlc_Fcs
parameter_list|(
name|u_short
name|fcs
parameter_list|,
name|u_char
modifier|*
name|cp
parameter_list|,
name|int
name|len
parameter_list|)
block|{
while|while
condition|(
name|len
operator|--
condition|)
name|fcs
operator|=
operator|(
name|fcs
operator|>>
literal|8
operator|)
operator|^
name|fcstab
index|[
operator|(
name|fcs
operator|^
operator|*
name|cp
operator|++
operator|)
operator|&
literal|0xff
index|]
expr_stmt|;
return|return
operator|(
name|fcs
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|u_short
name|HdlcFcsBuf
parameter_list|(
name|u_short
name|fcs
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|)
block|{
name|int
name|len
decl_stmt|;
name|u_char
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|len
operator|=
name|mbuf_Length
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|pos
operator|=
name|MBUF_CTOP
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|end
operator|=
name|pos
operator|+
name|m
operator|->
name|cnt
expr_stmt|;
while|while
condition|(
name|len
operator|--
condition|)
block|{
name|fcs
operator|=
operator|(
name|fcs
operator|>>
literal|8
operator|)
operator|^
name|fcstab
index|[
operator|(
name|fcs
operator|^
operator|*
name|pos
operator|++
operator|)
operator|&
literal|0xff
index|]
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|end
operator|&&
name|len
condition|)
block|{
name|m
operator|=
name|m
operator|->
name|next
expr_stmt|;
name|pos
operator|=
name|MBUF_CTOP
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|end
operator|=
name|pos
operator|+
name|m
operator|->
name|cnt
expr_stmt|;
block|}
block|}
return|return
operator|(
name|fcs
operator|)
return|;
block|}
end_function

begin_function
name|void
name|hdlc_Output
parameter_list|(
name|struct
name|link
modifier|*
name|l
parameter_list|,
name|int
name|pri
parameter_list|,
name|u_short
name|proto
parameter_list|,
name|struct
name|mbuf
modifier|*
name|bp
parameter_list|)
block|{
name|struct
name|physical
modifier|*
name|p
init|=
name|link2physical
argument_list|(
name|l
argument_list|)
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|mhp
decl_stmt|,
modifier|*
name|mfcs
decl_stmt|;
name|u_char
modifier|*
name|cp
decl_stmt|;
name|u_short
name|fcs
decl_stmt|;
if|if
condition|(
operator|!
name|p
operator|||
name|physical_IsSync
argument_list|(
name|p
argument_list|)
condition|)
name|mfcs
operator|=
name|NULL
expr_stmt|;
else|else
name|mfcs
operator|=
name|mbuf_Alloc
argument_list|(
literal|2
argument_list|,
name|MB_HDLCOUT
argument_list|)
expr_stmt|;
name|mhp
operator|=
name|mbuf_Alloc
argument_list|(
literal|4
argument_list|,
name|MB_HDLCOUT
argument_list|)
expr_stmt|;
name|mhp
operator|->
name|cnt
operator|=
literal|0
expr_stmt|;
name|cp
operator|=
name|MBUF_CTOP
argument_list|(
name|mhp
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|&&
operator|(
name|proto
operator|==
name|PROTO_LCP
operator|||
name|l
operator|->
name|lcp
operator|.
name|his_acfcomp
operator|==
literal|0
operator|)
condition|)
block|{
operator|*
name|cp
operator|++
operator|=
name|HDLC_ADDR
expr_stmt|;
operator|*
name|cp
operator|++
operator|=
name|HDLC_UI
expr_stmt|;
name|mhp
operator|->
name|cnt
operator|+=
literal|2
expr_stmt|;
block|}
comment|/*    * If possible, compress protocol field.    */
if|if
condition|(
name|l
operator|->
name|lcp
operator|.
name|his_protocomp
operator|&&
operator|(
name|proto
operator|&
literal|0xff00
operator|)
operator|==
literal|0
condition|)
block|{
operator|*
name|cp
operator|++
operator|=
name|proto
expr_stmt|;
name|mhp
operator|->
name|cnt
operator|++
expr_stmt|;
block|}
else|else
block|{
operator|*
name|cp
operator|++
operator|=
name|proto
operator|>>
literal|8
expr_stmt|;
operator|*
name|cp
operator|=
name|proto
operator|&
literal|0377
expr_stmt|;
name|mhp
operator|->
name|cnt
operator|+=
literal|2
expr_stmt|;
block|}
name|mhp
operator|->
name|next
operator|=
name|bp
expr_stmt|;
if|if
condition|(
operator|!
name|p
condition|)
block|{
comment|/*      * This is where we multiplex the data over our available physical      * links.  We don't frame our logical link data.  Instead we wait      * for the logical link implementation to chop our data up and pile      * it into the physical links by re-calling this function with the      * encapsulated fragments.      */
name|link_Output
argument_list|(
name|l
argument_list|,
name|pri
argument_list|,
name|mhp
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Tack mfcs onto the end, then set bp back to the start of the data */
while|while
condition|(
name|bp
operator|->
name|next
operator|!=
name|NULL
condition|)
name|bp
operator|=
name|bp
operator|->
name|next
expr_stmt|;
name|bp
operator|->
name|next
operator|=
name|mfcs
expr_stmt|;
name|bp
operator|=
name|mhp
operator|->
name|next
expr_stmt|;
name|p
operator|->
name|hdlc
operator|.
name|lqm
operator|.
name|OutOctets
operator|+=
name|mbuf_Length
argument_list|(
name|mhp
argument_list|)
operator|+
literal|1
expr_stmt|;
name|p
operator|->
name|hdlc
operator|.
name|lqm
operator|.
name|OutPackets
operator|++
expr_stmt|;
if|if
condition|(
name|proto
operator|==
name|PROTO_LQR
condition|)
block|{
comment|/* Overwrite the entire packet */
name|struct
name|lqrdata
name|lqr
decl_stmt|;
name|lqr
operator|.
name|MagicNumber
operator|=
name|p
operator|->
name|link
operator|.
name|lcp
operator|.
name|want_magic
expr_stmt|;
name|lqr
operator|.
name|LastOutLQRs
operator|=
name|p
operator|->
name|hdlc
operator|.
name|lqm
operator|.
name|lqr
operator|.
name|peer
operator|.
name|PeerOutLQRs
expr_stmt|;
name|lqr
operator|.
name|LastOutPackets
operator|=
name|p
operator|->
name|hdlc
operator|.
name|lqm
operator|.
name|lqr
operator|.
name|peer
operator|.
name|PeerOutPackets
expr_stmt|;
name|lqr
operator|.
name|LastOutOctets
operator|=
name|p
operator|->
name|hdlc
operator|.
name|lqm
operator|.
name|lqr
operator|.
name|peer
operator|.
name|PeerOutOctets
expr_stmt|;
name|lqr
operator|.
name|PeerInLQRs
operator|=
name|p
operator|->
name|hdlc
operator|.
name|lqm
operator|.
name|lqr
operator|.
name|SaveInLQRs
expr_stmt|;
name|lqr
operator|.
name|PeerInPackets
operator|=
name|p
operator|->
name|hdlc
operator|.
name|lqm
operator|.
name|SaveInPackets
expr_stmt|;
name|lqr
operator|.
name|PeerInDiscards
operator|=
name|p
operator|->
name|hdlc
operator|.
name|lqm
operator|.
name|SaveInDiscards
expr_stmt|;
name|lqr
operator|.
name|PeerInErrors
operator|=
name|p
operator|->
name|hdlc
operator|.
name|lqm
operator|.
name|SaveInErrors
expr_stmt|;
name|lqr
operator|.
name|PeerInOctets
operator|=
name|p
operator|->
name|hdlc
operator|.
name|lqm
operator|.
name|SaveInOctets
expr_stmt|;
name|lqr
operator|.
name|PeerOutPackets
operator|=
name|p
operator|->
name|hdlc
operator|.
name|lqm
operator|.
name|OutPackets
expr_stmt|;
name|lqr
operator|.
name|PeerOutOctets
operator|=
name|p
operator|->
name|hdlc
operator|.
name|lqm
operator|.
name|OutOctets
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|hdlc
operator|.
name|lqm
operator|.
name|lqr
operator|.
name|peer
operator|.
name|LastOutLQRs
operator|==
name|p
operator|->
name|hdlc
operator|.
name|lqm
operator|.
name|lqr
operator|.
name|OutLQRs
condition|)
block|{
comment|/*        * only increment if it's the first time or we've got a reply        * from the last one        */
name|lqr
operator|.
name|PeerOutLQRs
operator|=
operator|++
name|p
operator|->
name|hdlc
operator|.
name|lqm
operator|.
name|lqr
operator|.
name|OutLQRs
expr_stmt|;
name|lqr_Dump
argument_list|(
name|l
operator|->
name|name
argument_list|,
literal|"Output"
argument_list|,
operator|&
name|lqr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|lqr
operator|.
name|PeerOutLQRs
operator|=
name|p
operator|->
name|hdlc
operator|.
name|lqm
operator|.
name|lqr
operator|.
name|OutLQRs
expr_stmt|;
name|lqr_Dump
argument_list|(
name|l
operator|->
name|name
argument_list|,
literal|"Output (again)"
argument_list|,
operator|&
name|lqr
argument_list|)
expr_stmt|;
block|}
name|lqr_ChangeOrder
argument_list|(
operator|&
name|lqr
argument_list|,
operator|(
expr|struct
name|lqrdata
operator|*
operator|)
name|MBUF_CTOP
argument_list|(
name|bp
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mfcs
condition|)
block|{
name|mfcs
operator|->
name|cnt
operator|=
literal|0
expr_stmt|;
name|fcs
operator|=
name|HdlcFcsBuf
argument_list|(
name|INITFCS
argument_list|,
name|mhp
argument_list|)
expr_stmt|;
name|fcs
operator|=
operator|~
name|fcs
expr_stmt|;
name|cp
operator|=
name|MBUF_CTOP
argument_list|(
name|mfcs
argument_list|)
expr_stmt|;
operator|*
name|cp
operator|++
operator|=
name|fcs
operator|&
literal|0377
expr_stmt|;
comment|/* Low byte first!! */
operator|*
name|cp
operator|++
operator|=
name|fcs
operator|>>
literal|8
expr_stmt|;
name|mfcs
operator|->
name|cnt
operator|=
literal|2
expr_stmt|;
block|}
name|log_DumpBp
argument_list|(
name|LogHDLC
argument_list|,
literal|"hdlc_Output"
argument_list|,
name|mhp
argument_list|)
expr_stmt|;
name|link_ProtocolRecord
argument_list|(
name|l
argument_list|,
name|proto
argument_list|,
name|PROTO_OUT
argument_list|)
expr_stmt|;
name|log_Printf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"hdlc_Output: proto = 0x%04x\n"
argument_list|,
name|proto
argument_list|)
expr_stmt|;
if|if
condition|(
name|physical_IsSync
argument_list|(
name|p
argument_list|)
condition|)
name|link_Output
argument_list|(
name|l
argument_list|,
name|pri
argument_list|,
name|mhp
argument_list|)
expr_stmt|;
comment|/* Send it raw */
else|else
name|async_Output
argument_list|(
name|pri
argument_list|,
name|mhp
argument_list|,
name|proto
argument_list|,
name|p
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Check out the latest ``Assigned numbers'' rfc (rfc1700.txt) */
end_comment

begin_struct
specifier|static
struct|struct
block|{
name|u_short
name|from
decl_stmt|;
name|u_short
name|to
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
block|}
name|protocols
index|[]
init|=
block|{
block|{
literal|0x0001
block|,
literal|0x0001
block|,
literal|"Padding Protocol"
block|}
block|,
block|{
literal|0x0003
block|,
literal|0x001f
block|,
literal|"reserved (transparency inefficient)"
block|}
block|,
block|{
literal|0x0021
block|,
literal|0x0021
block|,
literal|"Internet Protocol"
block|}
block|,
block|{
literal|0x0023
block|,
literal|0x0023
block|,
literal|"OSI Network Layer"
block|}
block|,
block|{
literal|0x0025
block|,
literal|0x0025
block|,
literal|"Xerox NS IDP"
block|}
block|,
block|{
literal|0x0027
block|,
literal|0x0027
block|,
literal|"DECnet Phase IV"
block|}
block|,
block|{
literal|0x0029
block|,
literal|0x0029
block|,
literal|"Appletalk"
block|}
block|,
block|{
literal|0x002b
block|,
literal|0x002b
block|,
literal|"Novell IPX"
block|}
block|,
block|{
literal|0x002d
block|,
literal|0x002d
block|,
literal|"Van Jacobson Compressed TCP/IP"
block|}
block|,
block|{
literal|0x002f
block|,
literal|0x002f
block|,
literal|"Van Jacobson Uncompressed TCP/IP"
block|}
block|,
block|{
literal|0x0031
block|,
literal|0x0031
block|,
literal|"Bridging PDU"
block|}
block|,
block|{
literal|0x0033
block|,
literal|0x0033
block|,
literal|"Stream Protocol (ST-II)"
block|}
block|,
block|{
literal|0x0035
block|,
literal|0x0035
block|,
literal|"Banyan Vines"
block|}
block|,
block|{
literal|0x0037
block|,
literal|0x0037
block|,
literal|"reserved (until 1993)"
block|}
block|,
block|{
literal|0x0039
block|,
literal|0x0039
block|,
literal|"AppleTalk EDDP"
block|}
block|,
block|{
literal|0x003b
block|,
literal|0x003b
block|,
literal|"AppleTalk SmartBuffered"
block|}
block|,
block|{
literal|0x003d
block|,
literal|0x003d
block|,
literal|"Multi-Link"
block|}
block|,
block|{
literal|0x003f
block|,
literal|0x003f
block|,
literal|"NETBIOS Framing"
block|}
block|,
block|{
literal|0x0041
block|,
literal|0x0041
block|,
literal|"Cisco Systems"
block|}
block|,
block|{
literal|0x0043
block|,
literal|0x0043
block|,
literal|"Ascom Timeplex"
block|}
block|,
block|{
literal|0x0045
block|,
literal|0x0045
block|,
literal|"Fujitsu Link Backup and Load Balancing (LBLB)"
block|}
block|,
block|{
literal|0x0047
block|,
literal|0x0047
block|,
literal|"DCA Remote Lan"
block|}
block|,
block|{
literal|0x0049
block|,
literal|0x0049
block|,
literal|"Serial Data Transport Protocol (PPP-SDTP)"
block|}
block|,
block|{
literal|0x004b
block|,
literal|0x004b
block|,
literal|"SNA over 802.2"
block|}
block|,
block|{
literal|0x004d
block|,
literal|0x004d
block|,
literal|"SNA"
block|}
block|,
block|{
literal|0x004f
block|,
literal|0x004f
block|,
literal|"IP6 Header Compression"
block|}
block|,
block|{
literal|0x0051
block|,
literal|0x0051
block|,
literal|"KNX Bridging Data"
block|}
block|,
block|{
literal|0x0053
block|,
literal|0x0053
block|,
literal|"Encryption"
block|}
block|,
block|{
literal|0x0055
block|,
literal|0x0055
block|,
literal|"Individual Link Encryption"
block|}
block|,
block|{
literal|0x006f
block|,
literal|0x006f
block|,
literal|"Stampede Bridging"
block|}
block|,
block|{
literal|0x0071
block|,
literal|0x0071
block|,
literal|"BAP Bandwidth Allocation Protocol"
block|}
block|,
block|{
literal|0x0073
block|,
literal|0x0073
block|,
literal|"MP+ Protocol"
block|}
block|,
block|{
literal|0x007d
block|,
literal|0x007d
block|,
literal|"reserved (Control Escape)"
block|}
block|,
block|{
literal|0x007f
block|,
literal|0x007f
block|,
literal|"reserved (compression inefficient)"
block|}
block|,
block|{
literal|0x00cf
block|,
literal|0x00cf
block|,
literal|"reserved (PPP NLPID)"
block|}
block|,
block|{
literal|0x00fb
block|,
literal|0x00fb
block|,
literal|"compression on single link in multilink group"
block|}
block|,
block|{
literal|0x00fd
block|,
literal|0x00fd
block|,
literal|"1st choice compression"
block|}
block|,
block|{
literal|0x00ff
block|,
literal|0x00ff
block|,
literal|"reserved (compression inefficient)"
block|}
block|,
block|{
literal|0x0200
block|,
literal|0x02ff
block|,
literal|"(compression inefficient)"
block|}
block|,
block|{
literal|0x0201
block|,
literal|0x0201
block|,
literal|"802.1d Hello Packets"
block|}
block|,
block|{
literal|0x0203
block|,
literal|0x0203
block|,
literal|"IBM Source Routing BPDU"
block|}
block|,
block|{
literal|0x0205
block|,
literal|0x0205
block|,
literal|"DEC LANBridge100 Spanning Tree"
block|}
block|,
block|{
literal|0x0207
block|,
literal|0x0207
block|,
literal|"Cisco Discovery Protocol"
block|}
block|,
block|{
literal|0x0209
block|,
literal|0x0209
block|,
literal|"Netcs Twin Routing"
block|}
block|,
block|{
literal|0x0231
block|,
literal|0x0231
block|,
literal|"Luxcom"
block|}
block|,
block|{
literal|0x0233
block|,
literal|0x0233
block|,
literal|"Sigma Network Systems"
block|}
block|,
block|{
literal|0x0235
block|,
literal|0x0235
block|,
literal|"Apple Client Server Protocol"
block|}
block|,
block|{
literal|0x1e00
block|,
literal|0x1eff
block|,
literal|"(compression inefficient)"
block|}
block|,
block|{
literal|0x4001
block|,
literal|0x4001
block|,
literal|"Cray Communications Control Protocol"
block|}
block|,
block|{
literal|0x4003
block|,
literal|0x4003
block|,
literal|"CDPD Mobile Network Registration Protocol"
block|}
block|,
block|{
literal|0x4021
block|,
literal|0x4021
block|,
literal|"Stacker LZS"
block|}
block|,
block|{
literal|0x8001
block|,
literal|0x801f
block|,
literal|"Not Used - reserved"
block|}
block|,
block|{
literal|0x8021
block|,
literal|0x8021
block|,
literal|"Internet Protocol Control Protocol"
block|}
block|,
block|{
literal|0x8023
block|,
literal|0x8023
block|,
literal|"OSI Network Layer Control Protocol"
block|}
block|,
block|{
literal|0x8025
block|,
literal|0x8025
block|,
literal|"Xerox NS IDP Control Protocol"
block|}
block|,
block|{
literal|0x8027
block|,
literal|0x8027
block|,
literal|"DECnet Phase IV Control Protocol"
block|}
block|,
block|{
literal|0x8029
block|,
literal|0x8029
block|,
literal|"Appletalk Control Protocol"
block|}
block|,
block|{
literal|0x802b
block|,
literal|0x802b
block|,
literal|"Novell IPX Control Protocol"
block|}
block|,
block|{
literal|0x802d
block|,
literal|0x802d
block|,
literal|"reserved"
block|}
block|,
block|{
literal|0x802f
block|,
literal|0x802f
block|,
literal|"reserved"
block|}
block|,
block|{
literal|0x8031
block|,
literal|0x8031
block|,
literal|"Bridging NCP"
block|}
block|,
block|{
literal|0x8033
block|,
literal|0x8033
block|,
literal|"Stream Protocol Control Protocol"
block|}
block|,
block|{
literal|0x8035
block|,
literal|0x8035
block|,
literal|"Banyan Vines Control Protocol"
block|}
block|,
block|{
literal|0x8037
block|,
literal|0x8037
block|,
literal|"reserved till 1993"
block|}
block|,
block|{
literal|0x8039
block|,
literal|0x8039
block|,
literal|"reserved"
block|}
block|,
block|{
literal|0x803b
block|,
literal|0x803b
block|,
literal|"reserved"
block|}
block|,
block|{
literal|0x803d
block|,
literal|0x803d
block|,
literal|"Multi-Link Control Protocol"
block|}
block|,
block|{
literal|0x803f
block|,
literal|0x803f
block|,
literal|"NETBIOS Framing Control Protocol"
block|}
block|,
block|{
literal|0x8041
block|,
literal|0x8041
block|,
literal|"Cisco Systems Control Protocol"
block|}
block|,
block|{
literal|0x8043
block|,
literal|0x8043
block|,
literal|"Ascom Timeplex"
block|}
block|,
block|{
literal|0x8045
block|,
literal|0x8045
block|,
literal|"Fujitsu LBLB Control Protocol"
block|}
block|,
block|{
literal|0x8047
block|,
literal|0x8047
block|,
literal|"DCA Remote Lan Network Control Protocol (RLNCP)"
block|}
block|,
block|{
literal|0x8049
block|,
literal|0x8049
block|,
literal|"Serial Data Control Protocol (PPP-SDCP)"
block|}
block|,
block|{
literal|0x804b
block|,
literal|0x804b
block|,
literal|"SNA over 802.2 Control Protocol"
block|}
block|,
block|{
literal|0x804d
block|,
literal|0x804d
block|,
literal|"SNA Control Protocol"
block|}
block|,
block|{
literal|0x804f
block|,
literal|0x804f
block|,
literal|"IP6 Header Compression Control Protocol"
block|}
block|,
block|{
literal|0x8051
block|,
literal|0x8051
block|,
literal|"KNX Bridging Control Protocol"
block|}
block|,
block|{
literal|0x8053
block|,
literal|0x8053
block|,
literal|"Encryption Control Protocol"
block|}
block|,
block|{
literal|0x8055
block|,
literal|0x8055
block|,
literal|"Individual Link Encryption Control Protocol"
block|}
block|,
block|{
literal|0x806f
block|,
literal|0x806f
block|,
literal|"Stampede Bridging Control Protocol"
block|}
block|,
block|{
literal|0x8073
block|,
literal|0x8073
block|,
literal|"MP+ Control Protocol"
block|}
block|,
block|{
literal|0x8071
block|,
literal|0x8071
block|,
literal|"BACP Bandwidth Allocation Control Protocol"
block|}
block|,
block|{
literal|0x807d
block|,
literal|0x807d
block|,
literal|"Not Used - reserved"
block|}
block|,
block|{
literal|0x80cf
block|,
literal|0x80cf
block|,
literal|"Not Used - reserved"
block|}
block|,
block|{
literal|0x80fb
block|,
literal|0x80fb
block|,
literal|"compression on single link in multilink group control"
block|}
block|,
block|{
literal|0x80fd
block|,
literal|0x80fd
block|,
literal|"Compression Control Protocol"
block|}
block|,
block|{
literal|0x80ff
block|,
literal|0x80ff
block|,
literal|"Not Used - reserved"
block|}
block|,
block|{
literal|0x8207
block|,
literal|0x8207
block|,
literal|"Cisco Discovery Protocol Control"
block|}
block|,
block|{
literal|0x8209
block|,
literal|0x8209
block|,
literal|"Netcs Twin Routing"
block|}
block|,
block|{
literal|0x8235
block|,
literal|0x8235
block|,
literal|"Apple Client Server Protocol Control"
block|}
block|,
block|{
literal|0xc021
block|,
literal|0xc021
block|,
literal|"Link Control Protocol"
block|}
block|,
block|{
literal|0xc023
block|,
literal|0xc023
block|,
literal|"Password Authentication Protocol"
block|}
block|,
block|{
literal|0xc025
block|,
literal|0xc025
block|,
literal|"Link Quality Report"
block|}
block|,
block|{
literal|0xc027
block|,
literal|0xc027
block|,
literal|"Shiva Password Authentication Protocol"
block|}
block|,
block|{
literal|0xc029
block|,
literal|0xc029
block|,
literal|"CallBack Control Protocol (CBCP)"
block|}
block|,
block|{
literal|0xc081
block|,
literal|0xc081
block|,
literal|"Container Control Protocol"
block|}
block|,
block|{
literal|0xc223
block|,
literal|0xc223
block|,
literal|"Challenge Handshake Authentication Protocol"
block|}
block|,
block|{
literal|0xc225
block|,
literal|0xc225
block|,
literal|"RSA Authentication Protocol"
block|}
block|,
block|{
literal|0xc227
block|,
literal|0xc227
block|,
literal|"Extensible Authentication Protocol"
block|}
block|,
block|{
literal|0xc26f
block|,
literal|0xc26f
block|,
literal|"Stampede Bridging Authorization Protocol"
block|}
block|,
block|{
literal|0xc281
block|,
literal|0xc281
block|,
literal|"Proprietary Authentication Protocol"
block|}
block|,
block|{
literal|0xc283
block|,
literal|0xc283
block|,
literal|"Proprietary Authentication Protocol"
block|}
block|,
block|{
literal|0xc481
block|,
literal|0xc481
block|,
literal|"Proprietary Node ID Authentication Protocol"
block|}
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|NPROTOCOLS
value|(sizeof protocols/sizeof protocols[0])
end_define

begin_function
specifier|const
name|char
modifier|*
name|hdlc_Protocol2Nam
parameter_list|(
name|u_short
name|proto
parameter_list|)
block|{
name|int
name|f
decl_stmt|;
for|for
control|(
name|f
operator|=
literal|0
init|;
name|f
operator|<
name|NPROTOCOLS
condition|;
name|f
operator|++
control|)
if|if
condition|(
name|proto
operator|>=
name|protocols
index|[
name|f
index|]
operator|.
name|from
operator|&&
name|proto
operator|<=
name|protocols
index|[
name|f
index|]
operator|.
name|to
condition|)
return|return
name|protocols
index|[
name|f
index|]
operator|.
name|name
return|;
elseif|else
if|if
condition|(
name|proto
operator|<
name|protocols
index|[
name|f
index|]
operator|.
name|from
condition|)
break|break;
return|return
literal|"unrecognised protocol"
return|;
block|}
end_function

begin_function
name|void
name|hdlc_DecodePacket
parameter_list|(
name|struct
name|bundle
modifier|*
name|bundle
parameter_list|,
name|u_short
name|proto
parameter_list|,
name|struct
name|mbuf
modifier|*
name|bp
parameter_list|,
name|struct
name|link
modifier|*
name|l
parameter_list|)
block|{
name|struct
name|physical
modifier|*
name|p
init|=
name|link2physical
argument_list|(
name|l
argument_list|)
decl_stmt|;
name|u_char
modifier|*
name|cp
decl_stmt|;
name|log_Printf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"DecodePacket: proto = 0x%04x\n"
argument_list|,
name|proto
argument_list|)
expr_stmt|;
comment|/* decompress everything.  CCP needs uncompressed data too */
if|if
condition|(
operator|(
name|bp
operator|=
name|ccp_Decompress
argument_list|(
operator|&
name|l
operator|->
name|ccp
argument_list|,
operator|&
name|proto
argument_list|,
name|bp
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return;
switch|switch
condition|(
name|proto
condition|)
block|{
case|case
name|PROTO_LCP
case|:
name|lcp_Input
argument_list|(
operator|&
name|l
operator|->
name|lcp
argument_list|,
name|bp
argument_list|)
expr_stmt|;
break|break;
case|case
name|PROTO_PAP
case|:
if|if
condition|(
name|p
condition|)
name|pap_Input
argument_list|(
name|bundle
argument_list|,
name|bp
argument_list|,
name|p
argument_list|)
expr_stmt|;
else|else
block|{
name|log_Printf
argument_list|(
name|LogERROR
argument_list|,
literal|"DecodePacket: PAP: Not a physical link !\n"
argument_list|)
expr_stmt|;
name|mbuf_Free
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|PROTO_LQR
case|:
if|if
condition|(
name|p
condition|)
block|{
name|p
operator|->
name|hdlc
operator|.
name|lqm
operator|.
name|lqr
operator|.
name|SaveInLQRs
operator|++
expr_stmt|;
name|lqr_Input
argument_list|(
name|p
argument_list|,
name|bp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|log_Printf
argument_list|(
name|LogERROR
argument_list|,
literal|"DecodePacket: LQR: Not a physical link !\n"
argument_list|)
expr_stmt|;
name|mbuf_Free
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|PROTO_CHAP
case|:
if|if
condition|(
name|p
condition|)
name|chap_Input
argument_list|(
name|bundle
argument_list|,
name|bp
argument_list|,
name|p
argument_list|)
expr_stmt|;
else|else
block|{
name|log_Printf
argument_list|(
name|LogERROR
argument_list|,
literal|"DecodePacket: CHAP: Not a physical link !\n"
argument_list|)
expr_stmt|;
name|mbuf_Free
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|PROTO_VJUNCOMP
case|:
case|case
name|PROTO_VJCOMP
case|:
name|bp
operator|=
name|vj_Input
argument_list|(
operator|&
name|bundle
operator|->
name|ncp
operator|.
name|ipcp
argument_list|,
name|bp
argument_list|,
name|proto
argument_list|)
expr_stmt|;
if|if
condition|(
name|bp
operator|==
name|NULL
condition|)
break|break;
comment|/* fall down */
case|case
name|PROTO_IP
case|:
name|ip_Input
argument_list|(
name|bundle
argument_list|,
name|bp
argument_list|)
expr_stmt|;
break|break;
case|case
name|PROTO_IPCP
case|:
name|ipcp_Input
argument_list|(
operator|&
name|bundle
operator|->
name|ncp
operator|.
name|ipcp
argument_list|,
name|bundle
argument_list|,
name|bp
argument_list|)
expr_stmt|;
break|break;
case|case
name|PROTO_CCP
case|:
name|ccp_Input
argument_list|(
operator|&
name|l
operator|->
name|ccp
argument_list|,
name|bundle
argument_list|,
name|bp
argument_list|)
expr_stmt|;
break|break;
case|case
name|PROTO_MP
case|:
if|if
condition|(
name|bundle
operator|->
name|ncp
operator|.
name|mp
operator|.
name|active
condition|)
block|{
if|if
condition|(
name|p
condition|)
name|mp_Input
argument_list|(
operator|&
name|bundle
operator|->
name|ncp
operator|.
name|mp
argument_list|,
name|bp
argument_list|,
name|p
argument_list|)
expr_stmt|;
else|else
block|{
name|log_Printf
argument_list|(
name|LogERROR
argument_list|,
literal|"DecodePacket: MP inside MP ?!\n"
argument_list|)
expr_stmt|;
name|mbuf_Free
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
comment|/* Fall through */
default|default:
name|log_Printf
argument_list|(
name|LogPHASE
argument_list|,
literal|"%s protocol 0x%04x (%s)\n"
argument_list|,
name|proto
operator|==
name|PROTO_MP
condition|?
literal|"Unexpected"
else|:
literal|"Unknown"
argument_list|,
name|proto
argument_list|,
name|hdlc_Protocol2Nam
argument_list|(
name|proto
argument_list|)
argument_list|)
expr_stmt|;
name|bp
operator|->
name|offset
operator|-=
literal|2
expr_stmt|;
name|bp
operator|->
name|cnt
operator|+=
literal|2
expr_stmt|;
name|cp
operator|=
name|MBUF_CTOP
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|lcp_SendProtoRej
argument_list|(
operator|&
name|l
operator|->
name|lcp
argument_list|,
name|cp
argument_list|,
name|bp
operator|->
name|cnt
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
condition|)
block|{
name|p
operator|->
name|hdlc
operator|.
name|lqm
operator|.
name|SaveInDiscards
operator|++
expr_stmt|;
name|p
operator|->
name|hdlc
operator|.
name|stats
operator|.
name|unknownproto
operator|++
expr_stmt|;
block|}
name|mbuf_Free
argument_list|(
name|bp
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|hdlc_GetProto
parameter_list|(
specifier|const
name|u_char
modifier|*
name|cp
parameter_list|,
name|u_short
modifier|*
name|proto
parameter_list|)
block|{
operator|*
name|proto
operator|=
operator|*
name|cp
expr_stmt|;
if|if
condition|(
operator|!
operator|(
operator|*
name|proto
operator|&
literal|1
operator|)
condition|)
block|{
operator|*
name|proto
operator|=
operator|(
operator|*
name|proto
operator|<<
literal|8
operator|)
operator||
name|cp
index|[
literal|1
index|]
expr_stmt|;
return|return
literal|2
return|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_function
name|void
name|hdlc_Input
parameter_list|(
name|struct
name|bundle
modifier|*
name|bundle
parameter_list|,
name|struct
name|mbuf
modifier|*
name|bp
parameter_list|,
name|struct
name|physical
modifier|*
name|physical
parameter_list|)
block|{
name|u_short
name|fcs
decl_stmt|,
name|proto
decl_stmt|;
name|u_char
modifier|*
name|cp
decl_stmt|,
name|addr
decl_stmt|,
name|ctrl
decl_stmt|;
name|int
name|n
decl_stmt|;
name|log_DumpBp
argument_list|(
name|LogHDLC
argument_list|,
literal|"hdlc_Input:"
argument_list|,
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
name|physical_IsSync
argument_list|(
name|physical
argument_list|)
condition|)
name|fcs
operator|=
name|GOODFCS
expr_stmt|;
else|else
name|fcs
operator|=
name|hdlc_Fcs
argument_list|(
name|INITFCS
argument_list|,
name|MBUF_CTOP
argument_list|(
name|bp
argument_list|)
argument_list|,
name|bp
operator|->
name|cnt
argument_list|)
expr_stmt|;
name|physical
operator|->
name|hdlc
operator|.
name|lqm
operator|.
name|SaveInOctets
operator|+=
name|bp
operator|->
name|cnt
operator|+
literal|1
expr_stmt|;
name|log_Printf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"%s: hdlc_Input: fcs = %04x (%s)\n"
argument_list|,
name|physical
operator|->
name|link
operator|.
name|name
argument_list|,
name|fcs
argument_list|,
operator|(
name|fcs
operator|==
name|GOODFCS
operator|)
condition|?
literal|"good"
else|:
literal|"BAD!"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fcs
operator|!=
name|GOODFCS
condition|)
block|{
name|physical
operator|->
name|hdlc
operator|.
name|lqm
operator|.
name|SaveInErrors
operator|++
expr_stmt|;
name|physical
operator|->
name|hdlc
operator|.
name|stats
operator|.
name|badfcs
operator|++
expr_stmt|;
name|mbuf_Free
argument_list|(
name|bp
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|!
name|physical_IsSync
argument_list|(
name|physical
argument_list|)
condition|)
name|bp
operator|->
name|cnt
operator|-=
literal|2
expr_stmt|;
comment|/* discard FCS part */
if|if
condition|(
name|bp
operator|->
name|cnt
operator|<
literal|2
condition|)
block|{
comment|/* XXX: raise this bar ? */
name|mbuf_Free
argument_list|(
name|bp
argument_list|)
expr_stmt|;
return|return;
block|}
name|cp
operator|=
name|MBUF_CTOP
argument_list|(
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|physical
operator|->
name|link
operator|.
name|lcp
operator|.
name|want_acfcomp
condition|)
block|{
comment|/* We expect the packet not to be compressed */
name|addr
operator|=
operator|*
name|cp
operator|++
expr_stmt|;
if|if
condition|(
name|addr
operator|!=
name|HDLC_ADDR
condition|)
block|{
name|physical
operator|->
name|hdlc
operator|.
name|lqm
operator|.
name|SaveInErrors
operator|++
expr_stmt|;
name|physical
operator|->
name|hdlc
operator|.
name|stats
operator|.
name|badaddr
operator|++
expr_stmt|;
name|log_Printf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"hdlc_Input: addr %02x\n"
argument_list|,
operator|*
name|cp
argument_list|)
expr_stmt|;
name|mbuf_Free
argument_list|(
name|bp
argument_list|)
expr_stmt|;
return|return;
block|}
name|ctrl
operator|=
operator|*
name|cp
operator|++
expr_stmt|;
if|if
condition|(
name|ctrl
operator|!=
name|HDLC_UI
condition|)
block|{
name|physical
operator|->
name|hdlc
operator|.
name|lqm
operator|.
name|SaveInErrors
operator|++
expr_stmt|;
name|physical
operator|->
name|hdlc
operator|.
name|stats
operator|.
name|badcommand
operator|++
expr_stmt|;
name|log_Printf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"hdlc_Input: %02x\n"
argument_list|,
operator|*
name|cp
argument_list|)
expr_stmt|;
name|mbuf_Free
argument_list|(
name|bp
argument_list|)
expr_stmt|;
return|return;
block|}
name|bp
operator|->
name|offset
operator|+=
literal|2
expr_stmt|;
name|bp
operator|->
name|cnt
operator|-=
literal|2
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cp
index|[
literal|0
index|]
operator|==
name|HDLC_ADDR
operator|&&
name|cp
index|[
literal|1
index|]
operator|==
name|HDLC_UI
condition|)
block|{
comment|/*      * We can receive compressed packets, but the peer still sends      * uncompressed packets !      */
name|cp
operator|+=
literal|2
expr_stmt|;
name|bp
operator|->
name|offset
operator|+=
literal|2
expr_stmt|;
name|bp
operator|->
name|cnt
operator|-=
literal|2
expr_stmt|;
block|}
name|n
operator|=
name|hdlc_GetProto
argument_list|(
name|cp
argument_list|,
operator|&
name|proto
argument_list|)
expr_stmt|;
name|bp
operator|->
name|offset
operator|+=
name|n
expr_stmt|;
name|bp
operator|->
name|cnt
operator|-=
name|n
expr_stmt|;
if|if
condition|(
operator|!
name|physical
operator|->
name|link
operator|.
name|lcp
operator|.
name|want_protocomp
operator|&&
name|n
operator|==
literal|1
condition|)
name|log_Printf
argument_list|(
name|LogHDLC
argument_list|,
literal|"%s: Warning: received a proto-compressed packet !\n"
argument_list|,
name|physical
operator|->
name|link
operator|.
name|name
argument_list|)
expr_stmt|;
name|link_ProtocolRecord
argument_list|(
operator|&
name|physical
operator|->
name|link
argument_list|,
name|proto
argument_list|,
name|PROTO_IN
argument_list|)
expr_stmt|;
name|physical
operator|->
name|hdlc
operator|.
name|lqm
operator|.
name|SaveInPackets
operator|++
expr_stmt|;
name|hdlc_DecodePacket
argument_list|(
name|bundle
argument_list|,
name|proto
argument_list|,
name|bp
argument_list|,
operator|&
name|physical
operator|->
name|link
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  *  Detect a HDLC frame  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|FrameHeaders
index|[]
init|=
block|{
literal|"\176\377\003\300\041"
block|,
literal|"\176\377\175\043\300\041"
block|,
literal|"\176\177\175\043\100\041"
block|,
literal|"\176\175\337\175\043\300\041"
block|,
literal|"\176\175\137\175\043\100\041"
block|,
name|NULL
block|, }
decl_stmt|;
end_decl_stmt

begin_function
name|u_char
modifier|*
name|hdlc_Detect
parameter_list|(
name|struct
name|physical
modifier|*
name|physical
parameter_list|,
name|u_char
modifier|*
name|cp
parameter_list|,
name|int
name|n
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|fp
decl_stmt|,
modifier|*
modifier|*
name|hp
decl_stmt|;
name|char
modifier|*
name|ptr
decl_stmt|;
name|cp
index|[
name|n
index|]
operator|=
literal|'\0'
expr_stmt|;
comment|/* be sure to null terminate */
name|ptr
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|hp
operator|=
name|FrameHeaders
init|;
operator|*
name|hp
condition|;
name|hp
operator|++
control|)
block|{
name|fp
operator|=
operator|*
name|hp
expr_stmt|;
if|if
condition|(
name|physical_IsSync
argument_list|(
name|physical
argument_list|)
condition|)
name|fp
operator|++
expr_stmt|;
name|ptr
operator|=
name|strstr
argument_list|(
operator|(
name|char
operator|*
operator|)
name|cp
argument_list|,
name|fp
argument_list|)
expr_stmt|;
comment|/* XXX: cp may have embedded NULs */
if|if
condition|(
name|ptr
condition|)
break|break;
block|}
return|return
operator|(
name|u_char
operator|*
operator|)
name|ptr
return|;
block|}
end_function

begin_function
name|int
name|hdlc_ReportStatus
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|hdlc
modifier|*
name|hdlc
init|=
operator|&
name|arg
operator|->
name|cx
operator|->
name|physical
operator|->
name|hdlc
decl_stmt|;
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|"%s HDLC level errors:\n"
argument_list|,
name|arg
operator|->
name|cx
operator|->
name|name
argument_list|)
expr_stmt|;
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|" Bad Frame Check Sequence fields: %u\n"
argument_list|,
name|hdlc
operator|->
name|stats
operator|.
name|badfcs
argument_list|)
expr_stmt|;
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|" Bad address (!= 0x%02x) fields:    %u\n"
argument_list|,
name|HDLC_ADDR
argument_list|,
name|hdlc
operator|->
name|stats
operator|.
name|badaddr
argument_list|)
expr_stmt|;
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|" Bad command (!= 0x%02x) fields:    %u\n"
argument_list|,
name|HDLC_UI
argument_list|,
name|hdlc
operator|->
name|stats
operator|.
name|badcommand
argument_list|)
expr_stmt|;
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|" Unrecognised protocol fields:    %u\n"
argument_list|,
name|hdlc
operator|->
name|stats
operator|.
name|unknownproto
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|hdlc_ReportTime
parameter_list|(
name|void
modifier|*
name|v
parameter_list|)
block|{
comment|/* Moan about HDLC errors */
name|struct
name|hdlc
modifier|*
name|hdlc
init|=
operator|(
expr|struct
name|hdlc
operator|*
operator|)
name|v
decl_stmt|;
name|timer_Stop
argument_list|(
operator|&
name|hdlc
operator|->
name|ReportTimer
argument_list|)
expr_stmt|;
if|if
condition|(
name|memcmp
argument_list|(
operator|&
name|hdlc
operator|->
name|laststats
argument_list|,
operator|&
name|hdlc
operator|->
name|stats
argument_list|,
sizeof|sizeof
name|hdlc
operator|->
name|stats
argument_list|)
condition|)
block|{
name|log_Printf
argument_list|(
name|LogPHASE
argument_list|,
literal|"%s: HDLC errors -> FCS: %u, ADDR: %u, COMD: %u, PROTO: %u\n"
argument_list|,
name|hdlc
operator|->
name|lqm
operator|.
name|owner
operator|->
name|fsm
operator|.
name|link
operator|->
name|name
argument_list|,
name|hdlc
operator|->
name|stats
operator|.
name|badfcs
operator|-
name|hdlc
operator|->
name|laststats
operator|.
name|badfcs
argument_list|,
name|hdlc
operator|->
name|stats
operator|.
name|badaddr
operator|-
name|hdlc
operator|->
name|laststats
operator|.
name|badaddr
argument_list|,
name|hdlc
operator|->
name|stats
operator|.
name|badcommand
operator|-
name|hdlc
operator|->
name|laststats
operator|.
name|badcommand
argument_list|,
name|hdlc
operator|->
name|stats
operator|.
name|unknownproto
operator|-
name|hdlc
operator|->
name|laststats
operator|.
name|unknownproto
argument_list|)
expr_stmt|;
name|hdlc
operator|->
name|laststats
operator|=
name|hdlc
operator|->
name|stats
expr_stmt|;
block|}
name|timer_Start
argument_list|(
operator|&
name|hdlc
operator|->
name|ReportTimer
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|hdlc_StartTimer
parameter_list|(
name|struct
name|hdlc
modifier|*
name|hdlc
parameter_list|)
block|{
name|timer_Stop
argument_list|(
operator|&
name|hdlc
operator|->
name|ReportTimer
argument_list|)
expr_stmt|;
name|hdlc
operator|->
name|ReportTimer
operator|.
name|load
operator|=
literal|60
operator|*
name|SECTICKS
expr_stmt|;
name|hdlc
operator|->
name|ReportTimer
operator|.
name|arg
operator|=
name|hdlc
expr_stmt|;
name|hdlc
operator|->
name|ReportTimer
operator|.
name|func
operator|=
name|hdlc_ReportTime
expr_stmt|;
name|hdlc
operator|->
name|ReportTimer
operator|.
name|name
operator|=
literal|"hdlc"
expr_stmt|;
name|timer_Start
argument_list|(
operator|&
name|hdlc
operator|->
name|ReportTimer
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|hdlc_StopTimer
parameter_list|(
name|struct
name|hdlc
modifier|*
name|hdlc
parameter_list|)
block|{
name|timer_Stop
argument_list|(
operator|&
name|hdlc
operator|->
name|ReportTimer
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


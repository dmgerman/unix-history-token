begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  *		PPP Finite State Machine for LCP/IPCP  *  *	    Written by Toshiharu OHNO (tony-o@iij.ad.jp)  *  *   Copyright (C) 1993, Internet Initiative Japan, Inc. All rights reserverd.  *  * Redistribution and use in source and binary forms are permitted  * provided that the above copyright notice and this paragraph are  * duplicated in all such forms and that any documentation,  * advertising materials, and other materials related to such  * distribution and use acknowledge that the software was developed  * by the Internet Initiative Japan, Inc.  The name of the  * IIJ may not be used to endorse or promote products derived  * from this software without specific prior written permission.  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND WITHOUT ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED  * WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR A PARTICULAR PURPOSE.  *  * $FreeBSD$  *  *  TODO:  *		o Refer loglevel for log output  *		o Better option log display  */
end_comment

begin_include
include|#
directive|include
file|"fsm.h"
end_include

begin_include
include|#
directive|include
file|"hdlc.h"
end_include

begin_include
include|#
directive|include
file|"lqr.h"
end_include

begin_include
include|#
directive|include
file|"lcpproto.h"
end_include

begin_include
include|#
directive|include
file|"lcp.h"
end_include

begin_include
include|#
directive|include
file|"ccp.h"
end_include

begin_function_decl
name|void
name|FsmSendConfigReq
parameter_list|(
name|struct
name|fsm
modifier|*
name|fp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|FsmSendTerminateReq
parameter_list|(
name|struct
name|fsm
modifier|*
name|fp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|FsmInitRestartCounter
parameter_list|(
name|struct
name|fsm
modifier|*
name|fp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|FsmTimeout
parameter_list|(
name|struct
name|fsm
modifier|*
name|fp
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
name|char
specifier|const
modifier|*
name|StateNames
index|[]
init|=
block|{
literal|"Initial"
block|,
literal|"Starting"
block|,
literal|"Closed"
block|,
literal|"Stopped"
block|,
literal|"Closing"
block|,
literal|"Stopping"
block|,
literal|"Req-Sent"
block|,
literal|"Ack-Rcvd"
block|,
literal|"Ack-Sent"
block|,
literal|"Opend"
block|, }
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|FsmInit
parameter_list|(
name|fp
parameter_list|)
name|struct
name|fsm
modifier|*
name|fp
decl_stmt|;
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|logprintf
argument_list|(
literal|"FsmInit\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|fp
operator|->
name|state
operator|=
name|ST_INITIAL
expr_stmt|;
name|fp
operator|->
name|reqid
operator|=
literal|1
expr_stmt|;
name|fp
operator|->
name|restart
operator|=
literal|1
expr_stmt|;
name|fp
operator|->
name|maxconfig
operator|=
literal|3
expr_stmt|;
block|}
end_function

begin_function
name|void
name|NewState
parameter_list|(
name|fp
parameter_list|,
name|new
parameter_list|)
name|struct
name|fsm
modifier|*
name|fp
decl_stmt|;
name|int
name|new
decl_stmt|;
block|{
name|LogPrintf
argument_list|(
name|LOG_LCP
argument_list|,
literal|"%s: state change %s --> %s\n"
argument_list|,
name|fp
operator|->
name|name
argument_list|,
name|StateNames
index|[
name|fp
operator|->
name|state
index|]
argument_list|,
name|StateNames
index|[
name|new
index|]
argument_list|)
expr_stmt|;
name|fp
operator|->
name|state
operator|=
name|new
expr_stmt|;
if|if
condition|(
operator|(
name|new
operator|>=
name|ST_INITIAL
operator|&&
name|new
operator|<=
name|ST_STOPPED
operator|)
operator|||
operator|(
name|new
operator|==
name|ST_OPENED
operator|)
condition|)
name|StopTimer
argument_list|(
operator|&
name|fp
operator|->
name|FsmTimer
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|FsmOutput
parameter_list|(
name|fp
parameter_list|,
name|code
parameter_list|,
name|id
parameter_list|,
name|ptr
parameter_list|,
name|count
parameter_list|)
name|struct
name|fsm
modifier|*
name|fp
decl_stmt|;
name|u_int
name|code
decl_stmt|,
name|id
decl_stmt|;
name|u_char
modifier|*
name|ptr
decl_stmt|;
name|int
name|count
decl_stmt|;
block|{
name|int
name|plen
decl_stmt|;
name|struct
name|fsmheader
name|lh
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|bp
decl_stmt|;
name|plen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|fsmheader
argument_list|)
operator|+
name|count
expr_stmt|;
name|lh
operator|.
name|code
operator|=
name|code
expr_stmt|;
name|lh
operator|.
name|id
operator|=
name|id
expr_stmt|;
name|lh
operator|.
name|length
operator|=
name|htons
argument_list|(
name|plen
argument_list|)
expr_stmt|;
name|bp
operator|=
name|mballoc
argument_list|(
name|plen
argument_list|,
name|MB_FSM
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|&
name|lh
argument_list|,
name|MBUF_CTOP
argument_list|(
name|bp
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|fsmheader
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|count
condition|)
name|bcopy
argument_list|(
name|ptr
argument_list|,
name|MBUF_CTOP
argument_list|(
name|bp
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|fsmheader
argument_list|)
argument_list|,
name|count
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|DumpBp
argument_list|(
name|bp
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|HdlcOutput
argument_list|(
name|PRI_LINK
argument_list|,
name|fp
operator|->
name|proto
argument_list|,
name|bp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|FsmOpen
parameter_list|(
name|fp
parameter_list|)
name|struct
name|fsm
modifier|*
name|fp
decl_stmt|;
block|{
switch|switch
condition|(
name|fp
operator|->
name|state
condition|)
block|{
case|case
name|ST_INITIAL
case|:
call|(
name|fp
operator|->
name|LayerStart
call|)
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|NewState
argument_list|(
name|fp
argument_list|,
name|ST_STARTING
argument_list|)
expr_stmt|;
break|break;
case|case
name|ST_STARTING
case|:
break|break;
case|case
name|ST_CLOSED
case|:
if|if
condition|(
name|fp
operator|->
name|open_mode
operator|==
name|OPEN_PASSIVE
condition|)
block|{
name|NewState
argument_list|(
name|fp
argument_list|,
name|ST_STOPPED
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|FsmInitRestartCounter
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|FsmSendConfigReq
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|NewState
argument_list|(
name|fp
argument_list|,
name|ST_REQSENT
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|ST_STOPPED
case|:
comment|/* XXX: restart option */
case|case
name|ST_REQSENT
case|:
case|case
name|ST_ACKRCVD
case|:
case|case
name|ST_ACKSENT
case|:
case|case
name|ST_OPENED
case|:
comment|/* XXX: restart option */
break|break;
case|case
name|ST_CLOSING
case|:
comment|/* XXX: restart option */
case|case
name|ST_STOPPING
case|:
comment|/* XXX: restart option */
name|NewState
argument_list|(
name|fp
argument_list|,
name|ST_STOPPING
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
name|void
name|FsmUp
parameter_list|(
name|fp
parameter_list|)
name|struct
name|fsm
modifier|*
name|fp
decl_stmt|;
block|{
switch|switch
condition|(
name|fp
operator|->
name|state
condition|)
block|{
case|case
name|ST_INITIAL
case|:
name|NewState
argument_list|(
name|fp
argument_list|,
name|ST_CLOSED
argument_list|)
expr_stmt|;
break|break;
case|case
name|ST_STARTING
case|:
name|FsmInitRestartCounter
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|FsmSendConfigReq
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|NewState
argument_list|(
name|fp
argument_list|,
name|ST_REQSENT
argument_list|)
expr_stmt|;
break|break;
default|default:
name|LogPrintf
argument_list|(
name|LOG_LCP
argument_list|,
literal|"%s: Oops, Up at %s\n"
argument_list|,
name|fp
operator|->
name|name
argument_list|,
name|StateNames
index|[
name|fp
operator|->
name|state
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
name|void
name|FsmDown
parameter_list|(
name|fp
parameter_list|)
name|struct
name|fsm
modifier|*
name|fp
decl_stmt|;
block|{
switch|switch
condition|(
name|fp
operator|->
name|state
condition|)
block|{
case|case
name|ST_CLOSED
case|:
case|case
name|ST_CLOSING
case|:
name|NewState
argument_list|(
name|fp
argument_list|,
name|ST_INITIAL
argument_list|)
expr_stmt|;
break|break;
case|case
name|ST_STOPPED
case|:
call|(
name|fp
operator|->
name|LayerStart
call|)
argument_list|(
name|fp
argument_list|)
expr_stmt|;
comment|/* Fall into.. */
case|case
name|ST_STOPPING
case|:
case|case
name|ST_REQSENT
case|:
case|case
name|ST_ACKRCVD
case|:
case|case
name|ST_ACKSENT
case|:
name|NewState
argument_list|(
name|fp
argument_list|,
name|ST_STARTING
argument_list|)
expr_stmt|;
break|break;
case|case
name|ST_OPENED
case|:
call|(
name|fp
operator|->
name|LayerDown
call|)
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|NewState
argument_list|(
name|fp
argument_list|,
name|ST_STARTING
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
name|void
name|FsmClose
parameter_list|(
name|fp
parameter_list|)
name|struct
name|fsm
modifier|*
name|fp
decl_stmt|;
block|{
switch|switch
condition|(
name|fp
operator|->
name|state
condition|)
block|{
case|case
name|ST_STARTING
case|:
name|NewState
argument_list|(
name|fp
argument_list|,
name|ST_INITIAL
argument_list|)
expr_stmt|;
break|break;
case|case
name|ST_STOPPED
case|:
name|NewState
argument_list|(
name|fp
argument_list|,
name|ST_CLOSED
argument_list|)
expr_stmt|;
break|break;
case|case
name|ST_STOPPING
case|:
name|NewState
argument_list|(
name|fp
argument_list|,
name|ST_CLOSING
argument_list|)
expr_stmt|;
break|break;
case|case
name|ST_OPENED
case|:
call|(
name|fp
operator|->
name|LayerDown
call|)
argument_list|(
name|fp
argument_list|)
expr_stmt|;
comment|/* Fall down */
case|case
name|ST_REQSENT
case|:
case|case
name|ST_ACKRCVD
case|:
case|case
name|ST_ACKSENT
case|:
name|FsmInitRestartCounter
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|FsmSendTerminateReq
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|NewState
argument_list|(
name|fp
argument_list|,
name|ST_CLOSING
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/*  *	Send functions  */
end_comment

begin_function
name|void
name|FsmSendConfigReq
parameter_list|(
name|fp
parameter_list|)
name|struct
name|fsm
modifier|*
name|fp
decl_stmt|;
block|{
if|if
condition|(
operator|--
name|fp
operator|->
name|maxconfig
operator|>
literal|0
condition|)
block|{
call|(
name|fp
operator|->
name|SendConfigReq
call|)
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|StartTimer
argument_list|(
operator|&
name|fp
operator|->
name|FsmTimer
argument_list|)
expr_stmt|;
comment|/* Start restart timer */
name|fp
operator|->
name|restart
operator|--
expr_stmt|;
comment|/* Decrement restart counter */
block|}
else|else
block|{
name|FsmClose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|FsmSendTerminateReq
parameter_list|(
name|fp
parameter_list|)
name|struct
name|fsm
modifier|*
name|fp
decl_stmt|;
block|{
name|LogPrintf
argument_list|(
name|LOG_LCP
argument_list|,
literal|"%s: SendTerminateReq.\n"
argument_list|,
name|fp
operator|->
name|name
argument_list|)
expr_stmt|;
name|FsmOutput
argument_list|(
name|fp
argument_list|,
name|CODE_TERMREQ
argument_list|,
name|fp
operator|->
name|reqid
operator|++
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
call|(
name|fp
operator|->
name|SendTerminateReq
call|)
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|StartTimer
argument_list|(
operator|&
name|fp
operator|->
name|FsmTimer
argument_list|)
expr_stmt|;
comment|/* Start restart timer */
name|fp
operator|->
name|restart
operator|--
expr_stmt|;
comment|/* Decrement restart counter */
block|}
end_function

begin_function
specifier|static
name|void
name|FsmSendConfigAck
parameter_list|(
name|fp
parameter_list|,
name|lhp
parameter_list|,
name|option
parameter_list|,
name|count
parameter_list|)
name|struct
name|fsm
modifier|*
name|fp
decl_stmt|;
name|struct
name|fsmheader
modifier|*
name|lhp
decl_stmt|;
name|u_char
modifier|*
name|option
decl_stmt|;
name|int
name|count
decl_stmt|;
block|{
name|LogPrintf
argument_list|(
name|LOG_LCP
argument_list|,
literal|"%s:  SendConfigAck(%s)\n"
argument_list|,
name|fp
operator|->
name|name
argument_list|,
name|StateNames
index|[
name|fp
operator|->
name|state
index|]
argument_list|)
expr_stmt|;
call|(
name|fp
operator|->
name|DecodeConfig
call|)
argument_list|(
name|option
argument_list|,
name|count
argument_list|,
name|MODE_NOP
argument_list|)
expr_stmt|;
name|FsmOutput
argument_list|(
name|fp
argument_list|,
name|CODE_CONFIGACK
argument_list|,
name|lhp
operator|->
name|id
argument_list|,
name|option
argument_list|,
name|count
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|FsmSendConfigRej
parameter_list|(
name|fp
parameter_list|,
name|lhp
parameter_list|,
name|option
parameter_list|,
name|count
parameter_list|)
name|struct
name|fsm
modifier|*
name|fp
decl_stmt|;
name|struct
name|fsmheader
modifier|*
name|lhp
decl_stmt|;
name|u_char
modifier|*
name|option
decl_stmt|;
name|int
name|count
decl_stmt|;
block|{
name|LogPrintf
argument_list|(
name|LOG_LCP
argument_list|,
literal|"%s:  SendConfigRej(%s)\n"
argument_list|,
name|fp
operator|->
name|name
argument_list|,
name|StateNames
index|[
name|fp
operator|->
name|state
index|]
argument_list|)
expr_stmt|;
call|(
name|fp
operator|->
name|DecodeConfig
call|)
argument_list|(
name|option
argument_list|,
name|count
argument_list|,
name|MODE_NOP
argument_list|)
expr_stmt|;
name|FsmOutput
argument_list|(
name|fp
argument_list|,
name|CODE_CONFIGREJ
argument_list|,
name|lhp
operator|->
name|id
argument_list|,
name|option
argument_list|,
name|count
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|FsmSendConfigNak
parameter_list|(
name|fp
parameter_list|,
name|lhp
parameter_list|,
name|option
parameter_list|,
name|count
parameter_list|)
name|struct
name|fsm
modifier|*
name|fp
decl_stmt|;
name|struct
name|fsmheader
modifier|*
name|lhp
decl_stmt|;
name|u_char
modifier|*
name|option
decl_stmt|;
name|int
name|count
decl_stmt|;
block|{
name|LogPrintf
argument_list|(
name|LOG_LCP
argument_list|,
literal|"%s:  SendConfigNak(%s)\n"
argument_list|,
name|fp
operator|->
name|name
argument_list|,
name|StateNames
index|[
name|fp
operator|->
name|state
index|]
argument_list|)
expr_stmt|;
call|(
name|fp
operator|->
name|DecodeConfig
call|)
argument_list|(
name|option
argument_list|,
name|count
argument_list|,
name|MODE_NOP
argument_list|)
expr_stmt|;
name|FsmOutput
argument_list|(
name|fp
argument_list|,
name|CODE_CONFIGNAK
argument_list|,
name|lhp
operator|->
name|id
argument_list|,
name|option
argument_list|,
name|count
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  *	Timeout actions  */
end_comment

begin_function
name|void
name|FsmTimeout
parameter_list|(
name|fp
parameter_list|)
name|struct
name|fsm
modifier|*
name|fp
decl_stmt|;
block|{
if|if
condition|(
name|fp
operator|->
name|restart
condition|)
block|{
switch|switch
condition|(
name|fp
operator|->
name|state
condition|)
block|{
case|case
name|ST_CLOSING
case|:
case|case
name|ST_STOPPING
case|:
name|FsmSendTerminateReq
argument_list|(
name|fp
argument_list|)
expr_stmt|;
break|break;
case|case
name|ST_REQSENT
case|:
case|case
name|ST_ACKSENT
case|:
name|FsmSendConfigReq
argument_list|(
name|fp
argument_list|)
expr_stmt|;
break|break;
case|case
name|ST_ACKRCVD
case|:
name|FsmSendConfigReq
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|NewState
argument_list|(
name|fp
argument_list|,
name|ST_REQSENT
argument_list|)
expr_stmt|;
break|break;
block|}
name|StartTimer
argument_list|(
operator|&
name|fp
operator|->
name|FsmTimer
argument_list|)
expr_stmt|;
block|}
else|else
block|{
switch|switch
condition|(
name|fp
operator|->
name|state
condition|)
block|{
case|case
name|ST_CLOSING
case|:
name|NewState
argument_list|(
name|fp
argument_list|,
name|ST_CLOSED
argument_list|)
expr_stmt|;
call|(
name|fp
operator|->
name|LayerFinish
call|)
argument_list|(
name|fp
argument_list|)
expr_stmt|;
break|break;
case|case
name|ST_STOPPING
case|:
name|NewState
argument_list|(
name|fp
argument_list|,
name|ST_STOPPED
argument_list|)
expr_stmt|;
call|(
name|fp
operator|->
name|LayerFinish
call|)
argument_list|(
name|fp
argument_list|)
expr_stmt|;
break|break;
case|case
name|ST_REQSENT
case|:
comment|/* XXX: 3p */
case|case
name|ST_ACKSENT
case|:
case|case
name|ST_ACKRCVD
case|:
name|NewState
argument_list|(
name|fp
argument_list|,
name|ST_STOPPED
argument_list|)
expr_stmt|;
call|(
name|fp
operator|->
name|LayerFinish
call|)
argument_list|(
name|fp
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
end_function

begin_function
name|void
name|FsmInitRestartCounter
parameter_list|(
name|fp
parameter_list|)
name|struct
name|fsm
modifier|*
name|fp
decl_stmt|;
block|{
name|StopTimer
argument_list|(
operator|&
name|fp
operator|->
name|FsmTimer
argument_list|)
expr_stmt|;
name|fp
operator|->
name|FsmTimer
operator|.
name|state
operator|=
name|TIMER_STOPPED
expr_stmt|;
name|fp
operator|->
name|FsmTimer
operator|.
name|func
operator|=
name|FsmTimeout
expr_stmt|;
name|fp
operator|->
name|FsmTimer
operator|.
name|arg
operator|=
operator|(
name|void
operator|*
operator|)
name|fp
expr_stmt|;
call|(
name|fp
operator|->
name|InitRestartCounter
call|)
argument_list|(
name|fp
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  *   Actions when receive packets  */
end_comment

begin_function
name|void
name|FsmRecvConfigReq
parameter_list|(
name|fp
parameter_list|,
name|lhp
parameter_list|,
name|bp
parameter_list|)
comment|/* RCR */
name|struct
name|fsm
modifier|*
name|fp
decl_stmt|;
name|struct
name|fsmheader
modifier|*
name|lhp
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|bp
decl_stmt|;
block|{
name|int
name|plen
decl_stmt|,
name|flen
decl_stmt|;
name|int
name|ackaction
init|=
literal|0
decl_stmt|;
name|plen
operator|=
name|plength
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|flen
operator|=
name|ntohs
argument_list|(
name|lhp
operator|->
name|length
argument_list|)
operator|-
sizeof|sizeof
argument_list|(
operator|*
name|lhp
argument_list|)
expr_stmt|;
if|if
condition|(
name|plen
operator|<
name|flen
condition|)
block|{
name|logprintf
argument_list|(
literal|"** plen (%d)< flen (%d)\n"
argument_list|,
name|plen
argument_list|,
name|flen
argument_list|)
expr_stmt|;
name|pfree
argument_list|(
name|bp
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/*    *  Check and process easy case    */
switch|switch
condition|(
name|fp
operator|->
name|state
condition|)
block|{
case|case
name|ST_INITIAL
case|:
case|case
name|ST_STARTING
case|:
name|LogPrintf
argument_list|(
name|LOG_LCP
argument_list|,
literal|"%s: Oops, RCR in %s.\n"
argument_list|,
name|fp
operator|->
name|name
argument_list|,
name|StateNames
index|[
name|fp
operator|->
name|state
index|]
argument_list|)
expr_stmt|;
name|pfree
argument_list|(
name|bp
argument_list|)
expr_stmt|;
return|return;
case|case
name|ST_CLOSED
case|:
call|(
name|fp
operator|->
name|SendTerminateAck
call|)
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|pfree
argument_list|(
name|bp
argument_list|)
expr_stmt|;
return|return;
case|case
name|ST_CLOSING
case|:
case|case
name|ST_STOPPING
case|:
name|logprintf
argument_list|(
literal|"## state = %d\n"
argument_list|,
name|fp
operator|->
name|state
argument_list|)
expr_stmt|;
name|pfree
argument_list|(
name|bp
argument_list|)
expr_stmt|;
return|return;
block|}
call|(
name|fp
operator|->
name|DecodeConfig
call|)
argument_list|(
name|MBUF_CTOP
argument_list|(
name|bp
argument_list|)
argument_list|,
name|flen
argument_list|,
name|MODE_REQ
argument_list|)
expr_stmt|;
if|if
condition|(
name|nakp
operator|==
name|NakBuff
operator|&&
name|rejp
operator|==
name|RejBuff
condition|)
name|ackaction
operator|=
literal|1
expr_stmt|;
switch|switch
condition|(
name|fp
operator|->
name|state
condition|)
block|{
case|case
name|ST_OPENED
case|:
call|(
name|fp
operator|->
name|LayerDown
call|)
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|FsmSendConfigReq
argument_list|(
name|fp
argument_list|)
expr_stmt|;
break|break;
case|case
name|ST_STOPPED
case|:
name|FsmInitRestartCounter
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|FsmSendConfigReq
argument_list|(
name|fp
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|rejp
operator|!=
name|RejBuff
condition|)
name|FsmSendConfigRej
argument_list|(
name|fp
argument_list|,
name|lhp
argument_list|,
name|RejBuff
argument_list|,
name|rejp
operator|-
name|RejBuff
argument_list|)
expr_stmt|;
if|if
condition|(
name|nakp
operator|!=
name|NakBuff
condition|)
name|FsmSendConfigNak
argument_list|(
name|fp
argument_list|,
name|lhp
argument_list|,
name|NakBuff
argument_list|,
name|nakp
operator|-
name|NakBuff
argument_list|)
expr_stmt|;
if|if
condition|(
name|ackaction
condition|)
name|FsmSendConfigAck
argument_list|(
name|fp
argument_list|,
name|lhp
argument_list|,
name|AckBuff
argument_list|,
name|ackp
operator|-
name|AckBuff
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|fp
operator|->
name|state
condition|)
block|{
case|case
name|ST_STOPPED
case|:
case|case
name|ST_OPENED
case|:
if|if
condition|(
name|ackaction
condition|)
name|NewState
argument_list|(
name|fp
argument_list|,
name|ST_ACKSENT
argument_list|)
expr_stmt|;
else|else
name|NewState
argument_list|(
name|fp
argument_list|,
name|ST_REQSENT
argument_list|)
expr_stmt|;
break|break;
case|case
name|ST_REQSENT
case|:
if|if
condition|(
name|ackaction
condition|)
name|NewState
argument_list|(
name|fp
argument_list|,
name|ST_ACKSENT
argument_list|)
expr_stmt|;
break|break;
case|case
name|ST_ACKRCVD
case|:
if|if
condition|(
name|ackaction
condition|)
block|{
name|NewState
argument_list|(
name|fp
argument_list|,
name|ST_OPENED
argument_list|)
expr_stmt|;
call|(
name|fp
operator|->
name|LayerUp
call|)
argument_list|(
name|fp
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|ST_ACKSENT
case|:
if|if
condition|(
operator|!
name|ackaction
condition|)
name|NewState
argument_list|(
name|fp
argument_list|,
name|ST_REQSENT
argument_list|)
expr_stmt|;
break|break;
block|}
name|pfree
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|FsmRecvConfigAck
parameter_list|(
name|fp
parameter_list|,
name|lhp
parameter_list|,
name|bp
parameter_list|)
comment|/* RCA */
name|struct
name|fsm
modifier|*
name|fp
decl_stmt|;
name|struct
name|fsmheader
modifier|*
name|lhp
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|bp
decl_stmt|;
block|{
switch|switch
condition|(
name|fp
operator|->
name|state
condition|)
block|{
case|case
name|ST_CLOSED
case|:
case|case
name|ST_STOPPED
case|:
call|(
name|fp
operator|->
name|SendTerminateAck
call|)
argument_list|(
name|fp
argument_list|)
expr_stmt|;
break|break;
case|case
name|ST_CLOSING
case|:
case|case
name|ST_STOPPING
case|:
break|break;
case|case
name|ST_REQSENT
case|:
name|FsmInitRestartCounter
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|NewState
argument_list|(
name|fp
argument_list|,
name|ST_ACKRCVD
argument_list|)
expr_stmt|;
break|break;
case|case
name|ST_ACKRCVD
case|:
name|FsmSendConfigReq
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|NewState
argument_list|(
name|fp
argument_list|,
name|ST_REQSENT
argument_list|)
expr_stmt|;
break|break;
case|case
name|ST_ACKSENT
case|:
name|FsmInitRestartCounter
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|NewState
argument_list|(
name|fp
argument_list|,
name|ST_OPENED
argument_list|)
expr_stmt|;
call|(
name|fp
operator|->
name|LayerUp
call|)
argument_list|(
name|fp
argument_list|)
expr_stmt|;
break|break;
case|case
name|ST_OPENED
case|:
call|(
name|fp
operator|->
name|LayerDown
call|)
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|FsmSendConfigReq
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|NewState
argument_list|(
name|fp
argument_list|,
name|ST_REQSENT
argument_list|)
expr_stmt|;
break|break;
block|}
name|pfree
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|FsmRecvConfigNak
parameter_list|(
name|fp
parameter_list|,
name|lhp
parameter_list|,
name|bp
parameter_list|)
comment|/* RCN */
name|struct
name|fsm
modifier|*
name|fp
decl_stmt|;
name|struct
name|fsmheader
modifier|*
name|lhp
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|bp
decl_stmt|;
block|{
name|int
name|plen
decl_stmt|,
name|flen
decl_stmt|;
name|plen
operator|=
name|plength
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|flen
operator|=
name|ntohs
argument_list|(
name|lhp
operator|->
name|length
argument_list|)
operator|-
sizeof|sizeof
argument_list|(
operator|*
name|lhp
argument_list|)
expr_stmt|;
if|if
condition|(
name|plen
operator|<
name|flen
condition|)
block|{
name|pfree
argument_list|(
name|bp
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/*    *  Check and process easy case    */
switch|switch
condition|(
name|fp
operator|->
name|state
condition|)
block|{
case|case
name|ST_INITIAL
case|:
case|case
name|ST_STARTING
case|:
name|LogPrintf
argument_list|(
name|LOG_LCP
argument_list|,
literal|"%s: Oops, RCN in %s.\n"
argument_list|,
name|fp
operator|->
name|name
argument_list|,
name|StateNames
index|[
name|fp
operator|->
name|state
index|]
argument_list|)
expr_stmt|;
name|pfree
argument_list|(
name|bp
argument_list|)
expr_stmt|;
return|return;
case|case
name|ST_CLOSED
case|:
case|case
name|ST_STOPPED
case|:
call|(
name|fp
operator|->
name|SendTerminateAck
call|)
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|pfree
argument_list|(
name|bp
argument_list|)
expr_stmt|;
return|return;
case|case
name|ST_CLOSING
case|:
case|case
name|ST_STOPPING
case|:
name|pfree
argument_list|(
name|bp
argument_list|)
expr_stmt|;
return|return;
block|}
call|(
name|fp
operator|->
name|DecodeConfig
call|)
argument_list|(
name|MBUF_CTOP
argument_list|(
name|bp
argument_list|)
argument_list|,
name|flen
argument_list|,
name|MODE_NAK
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|fp
operator|->
name|state
condition|)
block|{
case|case
name|ST_REQSENT
case|:
case|case
name|ST_ACKSENT
case|:
name|FsmInitRestartCounter
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|FsmSendConfigReq
argument_list|(
name|fp
argument_list|)
expr_stmt|;
break|break;
case|case
name|ST_OPENED
case|:
call|(
name|fp
operator|->
name|LayerDown
call|)
argument_list|(
name|fp
argument_list|)
expr_stmt|;
comment|/* Fall down */
case|case
name|ST_ACKRCVD
case|:
name|FsmSendConfigReq
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|NewState
argument_list|(
name|fp
argument_list|,
name|ST_REQSENT
argument_list|)
expr_stmt|;
break|break;
block|}
name|pfree
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|FsmRecvTermReq
parameter_list|(
name|fp
parameter_list|,
name|lhp
parameter_list|,
name|bp
parameter_list|)
comment|/* RTR */
name|struct
name|fsm
modifier|*
name|fp
decl_stmt|;
name|struct
name|fsmheader
modifier|*
name|lhp
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|bp
decl_stmt|;
block|{
switch|switch
condition|(
name|fp
operator|->
name|state
condition|)
block|{
case|case
name|ST_INITIAL
case|:
case|case
name|ST_STARTING
case|:
name|LogPrintf
argument_list|(
name|LOG_LCP
argument_list|,
literal|"%s: Oops, RTR in %s\n"
argument_list|,
name|fp
operator|->
name|name
argument_list|,
name|StateNames
index|[
name|fp
operator|->
name|state
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|ST_CLOSED
case|:
case|case
name|ST_STOPPED
case|:
case|case
name|ST_CLOSING
case|:
case|case
name|ST_STOPPING
case|:
case|case
name|ST_REQSENT
case|:
call|(
name|fp
operator|->
name|SendTerminateAck
call|)
argument_list|(
name|fp
argument_list|)
expr_stmt|;
break|break;
case|case
name|ST_ACKRCVD
case|:
case|case
name|ST_ACKSENT
case|:
call|(
name|fp
operator|->
name|SendTerminateAck
call|)
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|NewState
argument_list|(
name|fp
argument_list|,
name|ST_REQSENT
argument_list|)
expr_stmt|;
break|break;
case|case
name|ST_OPENED
case|:
call|(
name|fp
operator|->
name|LayerDown
call|)
argument_list|(
name|fp
argument_list|)
expr_stmt|;
comment|/* Zero Restart counter */
call|(
name|fp
operator|->
name|SendTerminateAck
call|)
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|NewState
argument_list|(
name|fp
argument_list|,
name|ST_STOPPING
argument_list|)
expr_stmt|;
break|break;
block|}
name|pfree
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|FsmRecvTermAck
parameter_list|(
name|fp
parameter_list|,
name|lhp
parameter_list|,
name|bp
parameter_list|)
comment|/* RTA */
name|struct
name|fsm
modifier|*
name|fp
decl_stmt|;
name|struct
name|fsmheader
modifier|*
name|lhp
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|bp
decl_stmt|;
block|{
switch|switch
condition|(
name|fp
operator|->
name|state
condition|)
block|{
case|case
name|ST_CLOSING
case|:
name|NewState
argument_list|(
name|fp
argument_list|,
name|ST_CLOSED
argument_list|)
expr_stmt|;
call|(
name|fp
operator|->
name|LayerFinish
call|)
argument_list|(
name|fp
argument_list|)
expr_stmt|;
break|break;
case|case
name|ST_STOPPING
case|:
name|NewState
argument_list|(
name|fp
argument_list|,
name|ST_STOPPED
argument_list|)
expr_stmt|;
call|(
name|fp
operator|->
name|LayerFinish
call|)
argument_list|(
name|fp
argument_list|)
expr_stmt|;
break|break;
case|case
name|ST_ACKRCVD
case|:
name|NewState
argument_list|(
name|fp
argument_list|,
name|ST_REQSENT
argument_list|)
expr_stmt|;
break|break;
case|case
name|ST_OPENED
case|:
call|(
name|fp
operator|->
name|LayerDown
call|)
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|FsmSendConfigReq
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|NewState
argument_list|(
name|fp
argument_list|,
name|ST_REQSENT
argument_list|)
expr_stmt|;
break|break;
block|}
name|pfree
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|FsmRecvConfigRej
parameter_list|(
name|fp
parameter_list|,
name|lhp
parameter_list|,
name|bp
parameter_list|)
comment|/* RCJ */
name|struct
name|fsm
modifier|*
name|fp
decl_stmt|;
name|struct
name|fsmheader
modifier|*
name|lhp
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|bp
decl_stmt|;
block|{
name|int
name|plen
decl_stmt|,
name|flen
decl_stmt|;
name|plen
operator|=
name|plength
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|flen
operator|=
name|ntohs
argument_list|(
name|lhp
operator|->
name|length
argument_list|)
operator|-
sizeof|sizeof
argument_list|(
operator|*
name|lhp
argument_list|)
expr_stmt|;
if|if
condition|(
name|plen
operator|<
name|flen
condition|)
block|{
name|pfree
argument_list|(
name|bp
argument_list|)
expr_stmt|;
return|return;
block|}
name|LogPrintf
argument_list|(
name|LOG_LCP
argument_list|,
literal|"%s: RecvConfigRej.\n"
argument_list|,
name|fp
operator|->
name|name
argument_list|)
expr_stmt|;
comment|/*    *  Check and process easy case    */
switch|switch
condition|(
name|fp
operator|->
name|state
condition|)
block|{
case|case
name|ST_INITIAL
case|:
case|case
name|ST_STARTING
case|:
name|LogPrintf
argument_list|(
name|LOG_LCP
argument_list|,
literal|"%s: Oops, RCJ in %s.\n"
argument_list|,
name|fp
operator|->
name|name
argument_list|,
name|StateNames
index|[
name|fp
operator|->
name|state
index|]
argument_list|)
expr_stmt|;
name|pfree
argument_list|(
name|bp
argument_list|)
expr_stmt|;
return|return;
case|case
name|ST_CLOSED
case|:
case|case
name|ST_STOPPED
case|:
call|(
name|fp
operator|->
name|SendTerminateAck
call|)
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|pfree
argument_list|(
name|bp
argument_list|)
expr_stmt|;
return|return;
case|case
name|ST_CLOSING
case|:
case|case
name|ST_STOPPING
case|:
name|pfree
argument_list|(
name|bp
argument_list|)
expr_stmt|;
return|return;
block|}
call|(
name|fp
operator|->
name|DecodeConfig
call|)
argument_list|(
name|MBUF_CTOP
argument_list|(
name|bp
argument_list|)
argument_list|,
name|flen
argument_list|,
name|MODE_REJ
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|fp
operator|->
name|state
condition|)
block|{
case|case
name|ST_REQSENT
case|:
case|case
name|ST_ACKSENT
case|:
name|FsmInitRestartCounter
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|FsmSendConfigReq
argument_list|(
name|fp
argument_list|)
expr_stmt|;
break|break;
case|case
name|ST_OPENED
case|:
call|(
name|fp
operator|->
name|LayerDown
call|)
argument_list|(
name|fp
argument_list|)
expr_stmt|;
comment|/* Fall down */
case|case
name|ST_ACKRCVD
case|:
name|FsmSendConfigReq
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|NewState
argument_list|(
name|fp
argument_list|,
name|ST_REQSENT
argument_list|)
expr_stmt|;
break|break;
block|}
name|pfree
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|FsmRecvCodeRej
parameter_list|(
name|fp
parameter_list|,
name|lhp
parameter_list|,
name|bp
parameter_list|)
name|struct
name|fsm
modifier|*
name|fp
decl_stmt|;
name|struct
name|fsmheader
modifier|*
name|lhp
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|bp
decl_stmt|;
block|{
name|LogPrintf
argument_list|(
name|LOG_LCP
argument_list|,
literal|"%s: RecvCodeRej\n"
argument_list|,
name|fp
operator|->
name|name
argument_list|)
expr_stmt|;
name|pfree
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|FsmRecvProtoRej
parameter_list|(
name|fp
parameter_list|,
name|lhp
parameter_list|,
name|bp
parameter_list|)
name|struct
name|fsm
modifier|*
name|fp
decl_stmt|;
name|struct
name|fsmheader
modifier|*
name|lhp
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|bp
decl_stmt|;
block|{
name|u_short
modifier|*
name|sp
decl_stmt|,
name|proto
decl_stmt|;
name|sp
operator|=
operator|(
name|u_short
operator|*
operator|)
name|MBUF_CTOP
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|proto
operator|=
name|ntohs
argument_list|(
operator|*
name|sp
argument_list|)
expr_stmt|;
name|LogPrintf
argument_list|(
name|LOG_LCP
argument_list|,
literal|"-- Protocol (%04x) was rejected.\n"
argument_list|,
name|proto
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|proto
condition|)
block|{
case|case
name|PROTO_LQR
case|:
name|StopLqr
argument_list|(
name|LQM_LQR
argument_list|)
expr_stmt|;
break|break;
case|case
name|PROTO_CCP
case|:
name|fp
operator|=
operator|&
name|CcpFsm
expr_stmt|;
call|(
name|fp
operator|->
name|LayerFinish
call|)
argument_list|(
name|fp
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|fp
operator|->
name|state
condition|)
block|{
case|case
name|ST_CLOSED
case|:
case|case
name|ST_CLOSING
case|:
name|NewState
argument_list|(
name|fp
argument_list|,
name|ST_CLOSED
argument_list|)
expr_stmt|;
default|default:
name|NewState
argument_list|(
name|fp
argument_list|,
name|ST_STOPPED
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
block|}
name|pfree
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|FsmRecvEchoReq
parameter_list|(
name|fp
parameter_list|,
name|lhp
parameter_list|,
name|bp
parameter_list|)
name|struct
name|fsm
modifier|*
name|fp
decl_stmt|;
name|struct
name|fsmheader
modifier|*
name|lhp
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|bp
decl_stmt|;
block|{
name|u_char
modifier|*
name|cp
decl_stmt|;
name|u_long
modifier|*
name|lp
decl_stmt|,
name|magic
decl_stmt|;
name|cp
operator|=
name|MBUF_CTOP
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|lp
operator|=
operator|(
name|u_long
operator|*
operator|)
name|cp
expr_stmt|;
name|magic
operator|=
name|ntohl
argument_list|(
operator|*
name|lp
argument_list|)
expr_stmt|;
if|if
condition|(
name|magic
operator|!=
name|LcpInfo
operator|.
name|his_magic
condition|)
block|{
name|logprintf
argument_list|(
literal|"RecvEchoReq: his magic is bad!!\n"
argument_list|)
expr_stmt|;
comment|/* XXX: We should send terminate request */
block|}
if|if
condition|(
name|fp
operator|->
name|state
operator|==
name|ST_OPENED
condition|)
block|{
operator|*
name|lp
operator|=
name|htonl
argument_list|(
name|LcpInfo
operator|.
name|want_magic
argument_list|)
expr_stmt|;
comment|/* Insert local magic number */
name|LogPrintf
argument_list|(
name|LOG_LCP
argument_list|,
literal|"%s:  SendEchoRep(%s)\n"
argument_list|,
name|fp
operator|->
name|name
argument_list|,
name|StateNames
index|[
name|fp
operator|->
name|state
index|]
argument_list|)
expr_stmt|;
name|FsmOutput
argument_list|(
name|fp
argument_list|,
name|CODE_ECHOREP
argument_list|,
name|lhp
operator|->
name|id
argument_list|,
name|cp
argument_list|,
name|plength
argument_list|(
name|bp
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|pfree
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|FsmRecvEchoRep
parameter_list|(
name|fp
parameter_list|,
name|lhp
parameter_list|,
name|bp
parameter_list|)
name|struct
name|fsm
modifier|*
name|fp
decl_stmt|;
name|struct
name|fsmheader
modifier|*
name|lhp
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|bp
decl_stmt|;
block|{
name|u_long
modifier|*
name|lp
decl_stmt|,
name|magic
decl_stmt|;
name|lp
operator|=
operator|(
name|u_long
operator|*
operator|)
name|MBUF_CTOP
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|magic
operator|=
name|ntohl
argument_list|(
operator|*
name|lp
argument_list|)
expr_stmt|;
comment|/*  * Tolerate echo replies with either magic number  */
if|if
condition|(
name|magic
operator|!=
literal|0
operator|&&
name|magic
operator|!=
name|LcpInfo
operator|.
name|his_magic
operator|&&
name|magic
operator|!=
name|LcpInfo
operator|.
name|want_magic
condition|)
block|{
name|logprintf
argument_list|(
literal|"RecvEchoRep: his magic is wrong! expect: %x got: %x\n"
argument_list|,
name|LcpInfo
operator|.
name|his_magic
argument_list|,
name|magic
argument_list|)
expr_stmt|;
comment|/*      *  XXX: We should send terminate request. But poor implementation      *       may die as a result.      */
block|}
name|RecvEchoLqr
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|pfree
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|FsmRecvDiscReq
parameter_list|(
name|fp
parameter_list|,
name|lhp
parameter_list|,
name|bp
parameter_list|)
name|struct
name|fsm
modifier|*
name|fp
decl_stmt|;
name|struct
name|fsmheader
modifier|*
name|lhp
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|bp
decl_stmt|;
block|{
name|LogPrintf
argument_list|(
name|LOG_LCP
argument_list|,
literal|"%s: RecvDiscReq\n"
argument_list|,
name|fp
operator|->
name|name
argument_list|)
expr_stmt|;
name|pfree
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|FsmRecvIdent
parameter_list|(
name|fp
parameter_list|,
name|lhp
parameter_list|,
name|bp
parameter_list|)
name|struct
name|fsm
modifier|*
name|fp
decl_stmt|;
name|struct
name|fsmheader
modifier|*
name|lhp
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|bp
decl_stmt|;
block|{
name|LogPrintf
argument_list|(
name|LOG_LCP
argument_list|,
literal|"%s: RecvIdent\n"
argument_list|,
name|fp
operator|->
name|name
argument_list|)
expr_stmt|;
name|pfree
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|FsmRecvTimeRemain
parameter_list|(
name|fp
parameter_list|,
name|lhp
parameter_list|,
name|bp
parameter_list|)
name|struct
name|fsm
modifier|*
name|fp
decl_stmt|;
name|struct
name|fsmheader
modifier|*
name|lhp
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|bp
decl_stmt|;
block|{
name|LogPrintf
argument_list|(
name|LOG_LCP
argument_list|,
literal|"%s: RecvTimeRemain\n"
argument_list|,
name|fp
operator|->
name|name
argument_list|)
expr_stmt|;
name|pfree
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|FsmRecvResetReq
parameter_list|(
name|fp
parameter_list|,
name|lhp
parameter_list|,
name|bp
parameter_list|)
name|struct
name|fsm
modifier|*
name|fp
decl_stmt|;
name|struct
name|fsmheader
modifier|*
name|lhp
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|bp
decl_stmt|;
block|{
name|LogPrintf
argument_list|(
name|LOG_LCP
argument_list|,
literal|"%s: RecvResetReq\n"
argument_list|,
name|fp
operator|->
name|name
argument_list|)
expr_stmt|;
name|CcpRecvResetReq
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|LogPrintf
argument_list|(
name|LOG_LCP
argument_list|,
literal|"%s: SendResetAck\n"
argument_list|,
name|fp
operator|->
name|name
argument_list|)
expr_stmt|;
name|FsmOutput
argument_list|(
name|fp
argument_list|,
name|CODE_RESETACK
argument_list|,
name|fp
operator|->
name|reqid
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|pfree
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|FsmRecvResetAck
parameter_list|(
name|fp
parameter_list|,
name|lhp
parameter_list|,
name|bp
parameter_list|)
name|struct
name|fsm
modifier|*
name|fp
decl_stmt|;
name|struct
name|fsmheader
modifier|*
name|lhp
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|bp
decl_stmt|;
block|{
name|LogPrintf
argument_list|(
name|LOG_LCP
argument_list|,
literal|"%s: RecvResetAck\n"
argument_list|,
name|fp
operator|->
name|name
argument_list|)
expr_stmt|;
name|fp
operator|->
name|reqid
operator|++
expr_stmt|;
name|pfree
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
name|struct
name|fsmcodedesc
name|FsmCodes
index|[]
init|=
block|{
block|{
name|FsmRecvConfigReq
block|,
literal|"Configure Request"
block|, }
block|,
block|{
name|FsmRecvConfigAck
block|,
literal|"Configure Ack"
block|, }
block|,
block|{
name|FsmRecvConfigNak
block|,
literal|"Configure Nak"
block|, }
block|,
block|{
name|FsmRecvConfigRej
block|,
literal|"Configure Reject"
block|, }
block|,
block|{
name|FsmRecvTermReq
block|,
literal|"Terminate Request"
block|, }
block|,
block|{
name|FsmRecvTermAck
block|,
literal|"Terminate Ack"
block|, }
block|,
block|{
name|FsmRecvCodeRej
block|,
literal|"Code Reject"
block|, }
block|,
block|{
name|FsmRecvProtoRej
block|,
literal|"Protocol Reject"
block|, }
block|,
block|{
name|FsmRecvEchoReq
block|,
literal|"Echo Request"
block|, }
block|,
block|{
name|FsmRecvEchoRep
block|,
literal|"Echo Reply"
block|, }
block|,
block|{
name|FsmRecvDiscReq
block|,
literal|"Discard Request"
block|, }
block|,
block|{
name|FsmRecvIdent
block|,
literal|"Ident"
block|, }
block|,
block|{
name|FsmRecvTimeRemain
block|,
literal|"Time Remain"
block|, }
block|,
block|{
name|FsmRecvResetReq
block|,
literal|"Reset Request"
block|, }
block|,
block|{
name|FsmRecvResetAck
block|,
literal|"Reset Ack"
block|, }
block|, }
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|FsmInput
parameter_list|(
name|fp
parameter_list|,
name|bp
parameter_list|)
name|struct
name|fsm
modifier|*
name|fp
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|bp
decl_stmt|;
block|{
name|int
name|len
decl_stmt|;
name|struct
name|fsmheader
modifier|*
name|lhp
decl_stmt|;
name|struct
name|fsmcodedesc
modifier|*
name|codep
decl_stmt|;
name|len
operator|=
name|plength
argument_list|(
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|fsmheader
argument_list|)
condition|)
block|{
name|pfree
argument_list|(
name|bp
argument_list|)
expr_stmt|;
return|return;
block|}
name|lhp
operator|=
operator|(
expr|struct
name|fsmheader
operator|*
operator|)
name|MBUF_CTOP
argument_list|(
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
name|lhp
operator|->
name|code
operator|==
literal|0
operator|||
name|lhp
operator|->
name|code
operator|>
name|fp
operator|->
name|max_code
condition|)
block|{
name|pfree
argument_list|(
name|bp
argument_list|)
expr_stmt|;
comment|/* XXX: Should send code reject */
return|return;
block|}
name|bp
operator|->
name|offset
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|fsmheader
argument_list|)
expr_stmt|;
name|bp
operator|->
name|cnt
operator|-=
sizeof|sizeof
argument_list|(
expr|struct
name|fsmheader
argument_list|)
expr_stmt|;
name|codep
operator|=
name|FsmCodes
operator|+
name|lhp
operator|->
name|code
operator|-
literal|1
expr_stmt|;
name|LogPrintf
argument_list|(
name|LOG_LCP
argument_list|,
literal|"%s: Received %s (%d) state = %s (%d)\n"
argument_list|,
name|fp
operator|->
name|name
argument_list|,
name|codep
operator|->
name|name
argument_list|,
name|lhp
operator|->
name|id
argument_list|,
name|StateNames
index|[
name|fp
operator|->
name|state
index|]
argument_list|,
name|fp
operator|->
name|state
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|LogMemory
argument_list|()
expr_stmt|;
endif|#
directive|endif
call|(
name|codep
operator|->
name|action
call|)
argument_list|(
name|fp
argument_list|,
name|lhp
argument_list|,
name|bp
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|LogMemory
argument_list|()
expr_stmt|;
endif|#
directive|endif
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*     Alias_util.h contains general utilities used by other functions     in the packet aliasing module.  At the moment, there are functions     for computing IP header and TCP packet checksums.      The checksum routines are based upon example code in a Unix networking     text written by Stevens (sorry, I can't remember the title -- but     at least this is a good author).      Initial Version:  August, 1996  (cjm) */
end_comment

begin_comment
comment|/* Note: the checksum routines assume that the actual checksum word has been zeroed out.  If the checksum workd is filled with the proper value, then these routines will give a result of zero (useful for testing purposes); */
end_comment

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_systm.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip.h>
end_include

begin_include
include|#
directive|include
file|<netinet/tcp.h>
end_include

begin_function
name|u_short
name|InternetChecksum
parameter_list|(
name|ptr
parameter_list|,
name|nbytes
parameter_list|)
name|u_short
modifier|*
name|ptr
decl_stmt|;
name|int
name|nbytes
decl_stmt|;
block|{
name|int
name|sum
decl_stmt|,
name|oddbyte
decl_stmt|;
name|sum
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|nbytes
operator|>
literal|1
condition|)
block|{
name|sum
operator|+=
operator|*
name|ptr
operator|++
expr_stmt|;
name|nbytes
operator|-=
literal|2
expr_stmt|;
block|}
if|if
condition|(
name|nbytes
operator|==
literal|1
condition|)
block|{
name|oddbyte
operator|=
literal|0
expr_stmt|;
operator|*
operator|(
operator|(
name|u_char
operator|*
operator|)
operator|&
name|oddbyte
operator|)
operator|=
operator|*
operator|(
name|u_char
operator|*
operator|)
name|ptr
expr_stmt|;
name|sum
operator|+=
name|oddbyte
expr_stmt|;
block|}
name|sum
operator|=
operator|(
name|sum
operator|>>
literal|16
operator|)
operator|+
operator|(
name|sum
operator|&
literal|0xffff
operator|)
expr_stmt|;
name|sum
operator|+=
operator|(
name|sum
operator|>>
literal|16
operator|)
expr_stmt|;
return|return
operator|(
operator|~
name|sum
operator|)
return|;
block|}
end_function

begin_function
name|u_short
name|IpChecksum
parameter_list|(
name|pip
parameter_list|)
name|struct
name|ip
modifier|*
name|pip
decl_stmt|;
block|{
return|return
operator|(
name|InternetChecksum
argument_list|(
operator|(
name|u_short
operator|*
operator|)
name|pip
argument_list|,
operator|(
name|pip
operator|->
name|ip_hl
operator|<<
literal|2
operator|)
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|u_short
name|TcpChecksum
parameter_list|(
name|pip
parameter_list|)
name|struct
name|ip
modifier|*
name|pip
decl_stmt|;
block|{
name|u_short
modifier|*
name|ptr
decl_stmt|;
name|struct
name|tcphdr
modifier|*
name|tc
decl_stmt|;
name|int
name|nhdr
decl_stmt|,
name|ntcp
decl_stmt|,
name|nbytes
decl_stmt|;
name|int
name|sum
decl_stmt|,
name|oddbyte
decl_stmt|;
name|nhdr
operator|=
name|pip
operator|->
name|ip_hl
operator|<<
literal|2
expr_stmt|;
name|ntcp
operator|=
name|ntohs
argument_list|(
name|pip
operator|->
name|ip_len
argument_list|)
operator|-
name|nhdr
expr_stmt|;
name|tc
operator|=
operator|(
expr|struct
name|tcphdr
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|pip
operator|+
name|nhdr
operator|)
expr_stmt|;
name|ptr
operator|=
operator|(
name|u_short
operator|*
operator|)
name|tc
expr_stmt|;
comment|/* Add up TCP header and data */
name|nbytes
operator|=
name|ntcp
expr_stmt|;
name|sum
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|nbytes
operator|>
literal|1
condition|)
block|{
name|sum
operator|+=
operator|*
name|ptr
operator|++
expr_stmt|;
name|nbytes
operator|-=
literal|2
expr_stmt|;
block|}
if|if
condition|(
name|nbytes
operator|==
literal|1
condition|)
block|{
name|oddbyte
operator|=
literal|0
expr_stmt|;
operator|*
operator|(
operator|(
name|u_char
operator|*
operator|)
operator|&
name|oddbyte
operator|)
operator|=
operator|*
operator|(
name|u_char
operator|*
operator|)
name|ptr
expr_stmt|;
name|sum
operator|+=
name|oddbyte
expr_stmt|;
block|}
comment|/* "Pseudo-header" data */
name|ptr
operator|=
operator|(
name|u_short
operator|*
operator|)
operator|&
operator|(
name|pip
operator|->
name|ip_dst
operator|)
expr_stmt|;
name|sum
operator|+=
operator|*
name|ptr
operator|++
expr_stmt|;
name|sum
operator|+=
operator|*
name|ptr
expr_stmt|;
name|ptr
operator|=
operator|(
name|u_short
operator|*
operator|)
operator|&
operator|(
name|pip
operator|->
name|ip_src
operator|)
expr_stmt|;
name|sum
operator|+=
operator|*
name|ptr
operator|++
expr_stmt|;
name|sum
operator|+=
operator|*
name|ptr
expr_stmt|;
name|sum
operator|+=
name|htons
argument_list|(
operator|(
name|u_short
operator|)
name|ntcp
argument_list|)
expr_stmt|;
name|sum
operator|+=
name|htons
argument_list|(
operator|(
name|u_short
operator|)
name|pip
operator|->
name|ip_p
argument_list|)
expr_stmt|;
comment|/* Roll over carry bits */
name|sum
operator|=
operator|(
name|sum
operator|>>
literal|16
operator|)
operator|+
operator|(
name|sum
operator|&
literal|0xffff
operator|)
expr_stmt|;
name|sum
operator|+=
operator|(
name|sum
operator|>>
literal|16
operator|)
expr_stmt|;
comment|/* Return checksum */
return|return
operator|(
operator|(
name|u_short
operator|)
operator|~
name|sum
operator|)
return|;
block|}
end_function

end_unit


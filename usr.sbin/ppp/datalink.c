begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 1998 Brian Somers<brian@Awfulhak.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  *	$Id: datalink.c,v 1.39 1999/05/12 09:48:47 brian Exp $  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_systm.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip.h>
end_include

begin_include
include|#
directive|include
file|<sys/un.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<sys/uio.h>
end_include

begin_include
include|#
directive|include
file|<termios.h>
end_include

begin_include
include|#
directive|include
file|"layer.h"
end_include

begin_include
include|#
directive|include
file|"mbuf.h"
end_include

begin_include
include|#
directive|include
file|"log.h"
end_include

begin_include
include|#
directive|include
file|"defs.h"
end_include

begin_include
include|#
directive|include
file|"timer.h"
end_include

begin_include
include|#
directive|include
file|"fsm.h"
end_include

begin_include
include|#
directive|include
file|"lcp.h"
end_include

begin_include
include|#
directive|include
file|"descriptor.h"
end_include

begin_include
include|#
directive|include
file|"lqr.h"
end_include

begin_include
include|#
directive|include
file|"hdlc.h"
end_include

begin_include
include|#
directive|include
file|"async.h"
end_include

begin_include
include|#
directive|include
file|"throughput.h"
end_include

begin_include
include|#
directive|include
file|"ccp.h"
end_include

begin_include
include|#
directive|include
file|"link.h"
end_include

begin_include
include|#
directive|include
file|"physical.h"
end_include

begin_include
include|#
directive|include
file|"iplist.h"
end_include

begin_include
include|#
directive|include
file|"slcompress.h"
end_include

begin_include
include|#
directive|include
file|"ipcp.h"
end_include

begin_include
include|#
directive|include
file|"filter.h"
end_include

begin_include
include|#
directive|include
file|"mp.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|NORADIUS
end_ifndef

begin_include
include|#
directive|include
file|"radius.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"bundle.h"
end_include

begin_include
include|#
directive|include
file|"chat.h"
end_include

begin_include
include|#
directive|include
file|"auth.h"
end_include

begin_include
include|#
directive|include
file|"prompt.h"
end_include

begin_include
include|#
directive|include
file|"proto.h"
end_include

begin_include
include|#
directive|include
file|"pap.h"
end_include

begin_include
include|#
directive|include
file|"chap.h"
end_include

begin_include
include|#
directive|include
file|"command.h"
end_include

begin_include
include|#
directive|include
file|"cbcp.h"
end_include

begin_include
include|#
directive|include
file|"datalink.h"
end_include

begin_function_decl
specifier|static
name|void
name|datalink_LoginDone
parameter_list|(
name|struct
name|datalink
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|datalink_NewState
parameter_list|(
name|struct
name|datalink
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|void
name|datalink_OpenTimeout
parameter_list|(
name|void
modifier|*
name|v
parameter_list|)
block|{
name|struct
name|datalink
modifier|*
name|dl
init|=
operator|(
expr|struct
name|datalink
operator|*
operator|)
name|v
decl_stmt|;
name|timer_Stop
argument_list|(
operator|&
name|dl
operator|->
name|dial
operator|.
name|timer
argument_list|)
expr_stmt|;
if|if
condition|(
name|dl
operator|->
name|state
operator|==
name|DATALINK_OPENING
condition|)
name|log_Printf
argument_list|(
name|LogPHASE
argument_list|,
literal|"%s: Redial timer expired.\n"
argument_list|,
name|dl
operator|->
name|name
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|datalink_StartDialTimer
parameter_list|(
name|struct
name|datalink
modifier|*
name|dl
parameter_list|,
name|int
name|Timeout
parameter_list|)
block|{
name|int
name|result
init|=
name|Timeout
decl_stmt|;
name|timer_Stop
argument_list|(
operator|&
name|dl
operator|->
name|dial
operator|.
name|timer
argument_list|)
expr_stmt|;
if|if
condition|(
name|Timeout
condition|)
block|{
if|if
condition|(
name|Timeout
operator|>
literal|0
condition|)
name|dl
operator|->
name|dial
operator|.
name|timer
operator|.
name|load
operator|=
name|Timeout
operator|*
name|SECTICKS
expr_stmt|;
else|else
block|{
name|result
operator|=
operator|(
name|random
argument_list|()
operator|%
name|DIAL_TIMEOUT
operator|)
operator|+
literal|1
expr_stmt|;
name|dl
operator|->
name|dial
operator|.
name|timer
operator|.
name|load
operator|=
name|result
operator|*
name|SECTICKS
expr_stmt|;
block|}
name|dl
operator|->
name|dial
operator|.
name|timer
operator|.
name|func
operator|=
name|datalink_OpenTimeout
expr_stmt|;
name|dl
operator|->
name|dial
operator|.
name|timer
operator|.
name|name
operator|=
literal|"dial"
expr_stmt|;
name|dl
operator|->
name|dial
operator|.
name|timer
operator|.
name|arg
operator|=
name|dl
expr_stmt|;
name|timer_Start
argument_list|(
operator|&
name|dl
operator|->
name|dial
operator|.
name|timer
argument_list|)
expr_stmt|;
if|if
condition|(
name|dl
operator|->
name|state
operator|==
name|DATALINK_OPENING
condition|)
name|log_Printf
argument_list|(
name|LogPHASE
argument_list|,
literal|"%s: Enter pause (%d) for redialing.\n"
argument_list|,
name|dl
operator|->
name|name
argument_list|,
name|Timeout
argument_list|)
expr_stmt|;
block|}
return|return
name|result
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|datalink_HangupDone
parameter_list|(
name|struct
name|datalink
modifier|*
name|dl
parameter_list|)
block|{
if|if
condition|(
name|dl
operator|->
name|physical
operator|->
name|type
operator|==
name|PHYS_DEDICATED
operator|&&
operator|!
name|dl
operator|->
name|bundle
operator|->
name|CleaningUp
operator|&&
name|dl
operator|->
name|physical
operator|->
name|fd
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* Don't close our device if the link is dedicated */
name|datalink_LoginDone
argument_list|(
name|dl
argument_list|)
expr_stmt|;
return|return;
block|}
name|physical_Close
argument_list|(
name|dl
operator|->
name|physical
argument_list|)
expr_stmt|;
name|dl
operator|->
name|phone
operator|.
name|chosen
operator|=
literal|"N/A"
expr_stmt|;
if|if
condition|(
name|dl
operator|->
name|cbcp
operator|.
name|required
condition|)
block|{
name|log_Printf
argument_list|(
name|LogPHASE
argument_list|,
literal|"Call peer back on %s\n"
argument_list|,
name|dl
operator|->
name|cbcp
operator|.
name|fsm
operator|.
name|phone
argument_list|)
expr_stmt|;
name|dl
operator|->
name|cfg
operator|.
name|callback
operator|.
name|opmask
operator|=
literal|0
expr_stmt|;
name|strncpy
argument_list|(
name|dl
operator|->
name|cfg
operator|.
name|phone
operator|.
name|list
argument_list|,
name|dl
operator|->
name|cbcp
operator|.
name|fsm
operator|.
name|phone
argument_list|,
sizeof|sizeof
name|dl
operator|->
name|cfg
operator|.
name|phone
operator|.
name|list
operator|-
literal|1
argument_list|)
expr_stmt|;
name|dl
operator|->
name|cfg
operator|.
name|phone
operator|.
name|list
index|[
sizeof|sizeof
name|dl
operator|->
name|cfg
operator|.
name|phone
operator|.
name|list
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|dl
operator|->
name|phone
operator|.
name|alt
operator|=
name|dl
operator|->
name|phone
operator|.
name|next
operator|=
name|NULL
expr_stmt|;
name|dl
operator|->
name|reconnect_tries
operator|=
name|dl
operator|->
name|cfg
operator|.
name|reconnect
operator|.
name|max
expr_stmt|;
name|dl
operator|->
name|dial
operator|.
name|tries
operator|=
name|dl
operator|->
name|cfg
operator|.
name|dial
operator|.
name|max
expr_stmt|;
name|dl
operator|->
name|dial
operator|.
name|incs
operator|=
literal|0
expr_stmt|;
name|dl
operator|->
name|script
operator|.
name|run
operator|=
literal|1
expr_stmt|;
name|dl
operator|->
name|script
operator|.
name|packetmode
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|physical_SetMode
argument_list|(
name|dl
operator|->
name|physical
argument_list|,
name|PHYS_BACKGROUND
argument_list|)
condition|)
name|log_Printf
argument_list|(
name|LogERROR
argument_list|,
literal|"Oops - can't change mode to BACKGROUND (gulp) !\n"
argument_list|)
expr_stmt|;
name|bundle_LinksRemoved
argument_list|(
name|dl
operator|->
name|bundle
argument_list|)
expr_stmt|;
comment|/* if dial.timeout is< 0 (random), we don't override fsm.delay */
if|if
condition|(
name|dl
operator|->
name|cbcp
operator|.
name|fsm
operator|.
name|delay
operator|<
name|dl
operator|->
name|cfg
operator|.
name|dial
operator|.
name|timeout
condition|)
name|dl
operator|->
name|cbcp
operator|.
name|fsm
operator|.
name|delay
operator|=
name|dl
operator|->
name|cfg
operator|.
name|dial
operator|.
name|timeout
expr_stmt|;
name|datalink_StartDialTimer
argument_list|(
name|dl
argument_list|,
name|dl
operator|->
name|cbcp
operator|.
name|fsm
operator|.
name|delay
argument_list|)
expr_stmt|;
name|cbcp_Down
argument_list|(
operator|&
name|dl
operator|->
name|cbcp
argument_list|)
expr_stmt|;
name|datalink_NewState
argument_list|(
name|dl
argument_list|,
name|DATALINK_OPENING
argument_list|)
expr_stmt|;
if|if
condition|(
name|bundle_Phase
argument_list|(
name|dl
operator|->
name|bundle
argument_list|)
operator|!=
name|PHASE_TERMINATE
condition|)
name|bundle_NewPhase
argument_list|(
name|dl
operator|->
name|bundle
argument_list|,
name|PHASE_ESTABLISH
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|dl
operator|->
name|bundle
operator|->
name|CleaningUp
operator|||
operator|(
name|dl
operator|->
name|physical
operator|->
name|type
operator|==
name|PHYS_DIRECT
operator|)
operator|||
operator|(
operator|(
operator|!
name|dl
operator|->
name|dial
operator|.
name|tries
operator|||
operator|(
name|dl
operator|->
name|dial
operator|.
name|tries
operator|<
literal|0
operator|&&
operator|!
name|dl
operator|->
name|reconnect_tries
operator|)
operator|)
operator|&&
operator|!
operator|(
name|dl
operator|->
name|physical
operator|->
name|type
operator|&
operator|(
name|PHYS_DDIAL
operator||
name|PHYS_DEDICATED
operator|)
operator|)
operator|)
condition|)
block|{
name|datalink_NewState
argument_list|(
name|dl
argument_list|,
name|DATALINK_CLOSED
argument_list|)
expr_stmt|;
name|dl
operator|->
name|dial
operator|.
name|tries
operator|=
operator|-
literal|1
expr_stmt|;
name|dl
operator|->
name|dial
operator|.
name|incs
operator|=
literal|0
expr_stmt|;
name|dl
operator|->
name|reconnect_tries
operator|=
literal|0
expr_stmt|;
name|bundle_LinkClosed
argument_list|(
name|dl
operator|->
name|bundle
argument_list|,
name|dl
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dl
operator|->
name|bundle
operator|->
name|CleaningUp
condition|)
name|datalink_StartDialTimer
argument_list|(
name|dl
argument_list|,
name|datalink_GetDialTimeout
argument_list|(
name|dl
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|datalink_NewState
argument_list|(
name|dl
argument_list|,
name|DATALINK_OPENING
argument_list|)
expr_stmt|;
if|if
condition|(
name|bundle_Phase
argument_list|(
name|dl
operator|->
name|bundle
argument_list|)
operator|!=
name|PHASE_TERMINATE
condition|)
name|bundle_NewPhase
argument_list|(
name|dl
operator|->
name|bundle
argument_list|,
name|PHASE_ESTABLISH
argument_list|)
expr_stmt|;
if|if
condition|(
name|dl
operator|->
name|dial
operator|.
name|tries
operator|<
literal|0
condition|)
block|{
name|datalink_StartDialTimer
argument_list|(
name|dl
argument_list|,
name|dl
operator|->
name|cfg
operator|.
name|reconnect
operator|.
name|timeout
argument_list|)
expr_stmt|;
name|dl
operator|->
name|dial
operator|.
name|tries
operator|=
name|dl
operator|->
name|cfg
operator|.
name|dial
operator|.
name|max
expr_stmt|;
name|dl
operator|->
name|dial
operator|.
name|incs
operator|=
literal|0
expr_stmt|;
name|dl
operator|->
name|reconnect_tries
operator|--
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|dl
operator|->
name|phone
operator|.
name|next
operator|==
name|NULL
condition|)
name|datalink_StartDialTimer
argument_list|(
name|dl
argument_list|,
name|datalink_GetDialTimeout
argument_list|(
name|dl
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|datalink_StartDialTimer
argument_list|(
name|dl
argument_list|,
name|dl
operator|->
name|cfg
operator|.
name|dial
operator|.
name|next_timeout
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|datalink_ChoosePhoneNumber
parameter_list|(
name|struct
name|datalink
modifier|*
name|dl
parameter_list|)
block|{
name|char
modifier|*
name|phone
decl_stmt|;
if|if
condition|(
name|dl
operator|->
name|phone
operator|.
name|alt
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|dl
operator|->
name|phone
operator|.
name|next
operator|==
name|NULL
condition|)
block|{
name|strncpy
argument_list|(
name|dl
operator|->
name|phone
operator|.
name|list
argument_list|,
name|dl
operator|->
name|cfg
operator|.
name|phone
operator|.
name|list
argument_list|,
sizeof|sizeof
name|dl
operator|->
name|phone
operator|.
name|list
operator|-
literal|1
argument_list|)
expr_stmt|;
name|dl
operator|->
name|phone
operator|.
name|list
index|[
sizeof|sizeof
name|dl
operator|->
name|phone
operator|.
name|list
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|dl
operator|->
name|phone
operator|.
name|next
operator|=
name|dl
operator|->
name|phone
operator|.
name|list
expr_stmt|;
block|}
name|dl
operator|->
name|phone
operator|.
name|alt
operator|=
name|strsep
argument_list|(
operator|&
name|dl
operator|->
name|phone
operator|.
name|next
argument_list|,
literal|":"
argument_list|)
expr_stmt|;
block|}
name|phone
operator|=
name|strsep
argument_list|(
operator|&
name|dl
operator|->
name|phone
operator|.
name|alt
argument_list|,
literal|"|"
argument_list|)
expr_stmt|;
name|dl
operator|->
name|phone
operator|.
name|chosen
operator|=
operator|*
name|phone
condition|?
name|phone
else|:
literal|"[NONE]"
expr_stmt|;
if|if
condition|(
operator|*
name|phone
condition|)
name|log_Printf
argument_list|(
name|LogPHASE
argument_list|,
literal|"Phone: %s\n"
argument_list|,
name|phone
argument_list|)
expr_stmt|;
return|return
name|phone
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|datalink_LoginDone
parameter_list|(
name|struct
name|datalink
modifier|*
name|dl
parameter_list|)
block|{
if|if
condition|(
operator|!
name|dl
operator|->
name|script
operator|.
name|packetmode
condition|)
block|{
name|dl
operator|->
name|dial
operator|.
name|tries
operator|=
operator|-
literal|1
expr_stmt|;
name|dl
operator|->
name|dial
operator|.
name|incs
operator|=
literal|0
expr_stmt|;
name|datalink_NewState
argument_list|(
name|dl
argument_list|,
name|DATALINK_READY
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|physical_Raw
argument_list|(
name|dl
operator|->
name|physical
argument_list|)
condition|)
block|{
name|dl
operator|->
name|dial
operator|.
name|tries
operator|=
literal|0
expr_stmt|;
name|log_Printf
argument_list|(
name|LogWARN
argument_list|,
literal|"datalink_LoginDone: Not connected.\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|dl
operator|->
name|script
operator|.
name|run
condition|)
block|{
name|datalink_NewState
argument_list|(
name|dl
argument_list|,
name|DATALINK_HANGUP
argument_list|)
expr_stmt|;
name|physical_Offline
argument_list|(
name|dl
operator|->
name|physical
argument_list|)
expr_stmt|;
name|chat_Init
argument_list|(
operator|&
name|dl
operator|->
name|chat
argument_list|,
name|dl
operator|->
name|physical
argument_list|,
name|dl
operator|->
name|cfg
operator|.
name|script
operator|.
name|hangup
argument_list|,
literal|1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|physical_StopDeviceTimer
argument_list|(
name|dl
operator|->
name|physical
argument_list|)
expr_stmt|;
if|if
condition|(
name|dl
operator|->
name|physical
operator|->
name|type
operator|==
name|PHYS_DEDICATED
condition|)
comment|/* force a redial timeout */
name|physical_Close
argument_list|(
name|dl
operator|->
name|physical
argument_list|)
expr_stmt|;
name|datalink_HangupDone
argument_list|(
name|dl
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|dl
operator|->
name|dial
operator|.
name|tries
operator|=
operator|-
literal|1
expr_stmt|;
name|dl
operator|->
name|dial
operator|.
name|incs
operator|=
literal|0
expr_stmt|;
name|hdlc_Init
argument_list|(
operator|&
name|dl
operator|->
name|physical
operator|->
name|hdlc
argument_list|,
operator|&
name|dl
operator|->
name|physical
operator|->
name|link
operator|.
name|lcp
argument_list|)
expr_stmt|;
name|async_Init
argument_list|(
operator|&
name|dl
operator|->
name|physical
operator|->
name|async
argument_list|)
expr_stmt|;
name|lcp_Setup
argument_list|(
operator|&
name|dl
operator|->
name|physical
operator|->
name|link
operator|.
name|lcp
argument_list|,
name|dl
operator|->
name|state
operator|==
name|DATALINK_READY
condition|?
literal|0
else|:
name|dl
operator|->
name|physical
operator|->
name|link
operator|.
name|lcp
operator|.
name|cfg
operator|.
name|openmode
argument_list|)
expr_stmt|;
name|ccp_Setup
argument_list|(
operator|&
name|dl
operator|->
name|physical
operator|->
name|link
operator|.
name|ccp
argument_list|)
expr_stmt|;
name|datalink_NewState
argument_list|(
name|dl
argument_list|,
name|DATALINK_LCP
argument_list|)
expr_stmt|;
name|fsm_Up
argument_list|(
operator|&
name|dl
operator|->
name|physical
operator|->
name|link
operator|.
name|lcp
operator|.
name|fsm
argument_list|)
expr_stmt|;
name|fsm_Open
argument_list|(
operator|&
name|dl
operator|->
name|physical
operator|->
name|link
operator|.
name|lcp
operator|.
name|fsm
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|datalink_UpdateSet
parameter_list|(
name|struct
name|descriptor
modifier|*
name|d
parameter_list|,
name|fd_set
modifier|*
name|r
parameter_list|,
name|fd_set
modifier|*
name|w
parameter_list|,
name|fd_set
modifier|*
name|e
parameter_list|,
name|int
modifier|*
name|n
parameter_list|)
block|{
name|struct
name|datalink
modifier|*
name|dl
init|=
name|descriptor2datalink
argument_list|(
name|d
argument_list|)
decl_stmt|;
name|int
name|result
decl_stmt|;
name|result
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|dl
operator|->
name|state
condition|)
block|{
case|case
name|DATALINK_CLOSED
case|:
if|if
condition|(
operator|(
name|dl
operator|->
name|physical
operator|->
name|type
operator|&
operator|(
name|PHYS_DIRECT
operator||
name|PHYS_DEDICATED
operator||
name|PHYS_BACKGROUND
operator||
name|PHYS_DDIAL
operator|)
operator|)
operator|&&
operator|!
name|dl
operator|->
name|bundle
operator|->
name|CleaningUp
condition|)
comment|/*          * Our first time in - DEDICATED& DDIAL never come down, and          * DIRECT& BACKGROUND get deleted when they enter DATALINK_CLOSED.          * Go to DATALINK_OPENING via datalink_Up() and fall through.          */
name|datalink_Up
argument_list|(
name|dl
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
else|else
break|break;
comment|/* fall through */
case|case
name|DATALINK_OPENING
case|:
if|if
condition|(
name|dl
operator|->
name|dial
operator|.
name|timer
operator|.
name|state
operator|!=
name|TIMER_RUNNING
condition|)
block|{
if|if
condition|(
operator|--
name|dl
operator|->
name|dial
operator|.
name|tries
operator|<
literal|0
condition|)
name|dl
operator|->
name|dial
operator|.
name|tries
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|physical_Open
argument_list|(
name|dl
operator|->
name|physical
argument_list|,
name|dl
operator|->
name|bundle
argument_list|)
operator|>=
literal|0
condition|)
block|{
name|log_WritePrompts
argument_list|(
name|dl
argument_list|,
literal|"%s: Entering terminal mode on %s\r\n"
literal|"Type `~?' for help\r\n"
argument_list|,
name|dl
operator|->
name|name
argument_list|,
name|dl
operator|->
name|physical
operator|->
name|name
operator|.
name|full
argument_list|)
expr_stmt|;
if|if
condition|(
name|dl
operator|->
name|script
operator|.
name|run
condition|)
block|{
name|datalink_NewState
argument_list|(
name|dl
argument_list|,
name|DATALINK_DIAL
argument_list|)
expr_stmt|;
name|chat_Init
argument_list|(
operator|&
name|dl
operator|->
name|chat
argument_list|,
name|dl
operator|->
name|physical
argument_list|,
name|dl
operator|->
name|cfg
operator|.
name|script
operator|.
name|dial
argument_list|,
literal|1
argument_list|,
name|datalink_ChoosePhoneNumber
argument_list|(
name|dl
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|dl
operator|->
name|physical
operator|->
name|type
operator|&
operator|(
name|PHYS_DDIAL
operator||
name|PHYS_DEDICATED
operator|)
operator|)
operator|&&
name|dl
operator|->
name|cfg
operator|.
name|dial
operator|.
name|max
condition|)
name|log_Printf
argument_list|(
name|LogCHAT
argument_list|,
literal|"%s: Dial attempt %u of %d\n"
argument_list|,
name|dl
operator|->
name|name
argument_list|,
name|dl
operator|->
name|cfg
operator|.
name|dial
operator|.
name|max
operator|-
name|dl
operator|->
name|dial
operator|.
name|tries
argument_list|,
name|dl
operator|->
name|cfg
operator|.
name|dial
operator|.
name|max
argument_list|)
expr_stmt|;
block|}
else|else
name|datalink_LoginDone
argument_list|(
name|dl
argument_list|)
expr_stmt|;
return|return
name|datalink_UpdateSet
argument_list|(
name|d
argument_list|,
name|r
argument_list|,
name|w
argument_list|,
name|e
argument_list|,
name|n
argument_list|)
return|;
block|}
else|else
block|{
if|if
condition|(
operator|!
operator|(
name|dl
operator|->
name|physical
operator|->
name|type
operator|&
operator|(
name|PHYS_DDIAL
operator||
name|PHYS_DEDICATED
operator|)
operator|)
operator|&&
name|dl
operator|->
name|cfg
operator|.
name|dial
operator|.
name|max
condition|)
name|log_Printf
argument_list|(
name|LogCHAT
argument_list|,
literal|"Failed to open device (attempt %u of %d)\n"
argument_list|,
name|dl
operator|->
name|cfg
operator|.
name|dial
operator|.
name|max
operator|-
name|dl
operator|->
name|dial
operator|.
name|tries
argument_list|,
name|dl
operator|->
name|cfg
operator|.
name|dial
operator|.
name|max
argument_list|)
expr_stmt|;
else|else
name|log_Printf
argument_list|(
name|LogCHAT
argument_list|,
literal|"Failed to open device\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|dl
operator|->
name|bundle
operator|->
name|CleaningUp
operator|||
operator|(
operator|!
operator|(
name|dl
operator|->
name|physical
operator|->
name|type
operator|&
operator|(
name|PHYS_DDIAL
operator||
name|PHYS_DEDICATED
operator|)
operator|)
operator|&&
name|dl
operator|->
name|cfg
operator|.
name|dial
operator|.
name|max
operator|&&
name|dl
operator|->
name|dial
operator|.
name|tries
operator|==
literal|0
operator|)
condition|)
block|{
name|datalink_NewState
argument_list|(
name|dl
argument_list|,
name|DATALINK_CLOSED
argument_list|)
expr_stmt|;
name|dl
operator|->
name|reconnect_tries
operator|=
literal|0
expr_stmt|;
name|dl
operator|->
name|dial
operator|.
name|tries
operator|=
operator|-
literal|1
expr_stmt|;
name|log_WritePrompts
argument_list|(
name|dl
argument_list|,
literal|"Failed to open %s\n"
argument_list|,
name|dl
operator|->
name|physical
operator|->
name|name
operator|.
name|full
argument_list|)
expr_stmt|;
name|bundle_LinkClosed
argument_list|(
name|dl
operator|->
name|bundle
argument_list|,
name|dl
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|dl
operator|->
name|bundle
operator|->
name|CleaningUp
condition|)
block|{
name|int
name|timeout
decl_stmt|;
name|timeout
operator|=
name|datalink_StartDialTimer
argument_list|(
name|dl
argument_list|,
name|datalink_GetDialTimeout
argument_list|(
name|dl
argument_list|)
argument_list|)
expr_stmt|;
name|log_WritePrompts
argument_list|(
name|dl
argument_list|,
literal|"Failed to open %s, pause %d seconds\n"
argument_list|,
name|dl
operator|->
name|physical
operator|->
name|name
operator|.
name|full
argument_list|,
name|timeout
argument_list|)
expr_stmt|;
block|}
block|}
block|}
break|break;
case|case
name|DATALINK_HANGUP
case|:
case|case
name|DATALINK_DIAL
case|:
case|case
name|DATALINK_LOGIN
case|:
name|result
operator|=
name|descriptor_UpdateSet
argument_list|(
operator|&
name|dl
operator|->
name|chat
operator|.
name|desc
argument_list|,
name|r
argument_list|,
name|w
argument_list|,
name|e
argument_list|,
name|n
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|dl
operator|->
name|chat
operator|.
name|state
condition|)
block|{
case|case
name|CHAT_DONE
case|:
comment|/* script succeeded */
name|chat_Destroy
argument_list|(
operator|&
name|dl
operator|->
name|chat
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|dl
operator|->
name|state
condition|)
block|{
case|case
name|DATALINK_HANGUP
case|:
name|datalink_HangupDone
argument_list|(
name|dl
argument_list|)
expr_stmt|;
break|break;
case|case
name|DATALINK_DIAL
case|:
name|datalink_NewState
argument_list|(
name|dl
argument_list|,
name|DATALINK_LOGIN
argument_list|)
expr_stmt|;
name|chat_Init
argument_list|(
operator|&
name|dl
operator|->
name|chat
argument_list|,
name|dl
operator|->
name|physical
argument_list|,
name|dl
operator|->
name|cfg
operator|.
name|script
operator|.
name|login
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
name|datalink_UpdateSet
argument_list|(
name|d
argument_list|,
name|r
argument_list|,
name|w
argument_list|,
name|e
argument_list|,
name|n
argument_list|)
return|;
case|case
name|DATALINK_LOGIN
case|:
name|dl
operator|->
name|phone
operator|.
name|alt
operator|=
name|NULL
expr_stmt|;
name|datalink_LoginDone
argument_list|(
name|dl
argument_list|)
expr_stmt|;
return|return
name|datalink_UpdateSet
argument_list|(
name|d
argument_list|,
name|r
argument_list|,
name|w
argument_list|,
name|e
argument_list|,
name|n
argument_list|)
return|;
block|}
break|break;
case|case
name|CHAT_FAILED
case|:
comment|/* Going down - script failed */
name|log_Printf
argument_list|(
name|LogWARN
argument_list|,
literal|"Chat script failed\n"
argument_list|)
expr_stmt|;
name|chat_Destroy
argument_list|(
operator|&
name|dl
operator|->
name|chat
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|dl
operator|->
name|state
condition|)
block|{
case|case
name|DATALINK_HANGUP
case|:
name|datalink_HangupDone
argument_list|(
name|dl
argument_list|)
expr_stmt|;
break|break;
case|case
name|DATALINK_DIAL
case|:
case|case
name|DATALINK_LOGIN
case|:
name|datalink_NewState
argument_list|(
name|dl
argument_list|,
name|DATALINK_HANGUP
argument_list|)
expr_stmt|;
name|physical_Offline
argument_list|(
name|dl
operator|->
name|physical
argument_list|)
expr_stmt|;
comment|/* Is this required ? */
name|chat_Init
argument_list|(
operator|&
name|dl
operator|->
name|chat
argument_list|,
name|dl
operator|->
name|physical
argument_list|,
name|dl
operator|->
name|cfg
operator|.
name|script
operator|.
name|hangup
argument_list|,
literal|1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
name|datalink_UpdateSet
argument_list|(
name|d
argument_list|,
name|r
argument_list|,
name|w
argument_list|,
name|e
argument_list|,
name|n
argument_list|)
return|;
block|}
break|break;
block|}
break|break;
case|case
name|DATALINK_READY
case|:
case|case
name|DATALINK_LCP
case|:
case|case
name|DATALINK_AUTH
case|:
case|case
name|DATALINK_CBCP
case|:
case|case
name|DATALINK_OPEN
case|:
name|result
operator|=
name|descriptor_UpdateSet
argument_list|(
operator|&
name|dl
operator|->
name|chap
operator|.
name|desc
argument_list|,
name|r
argument_list|,
name|w
argument_list|,
name|e
argument_list|,
name|n
argument_list|)
operator|+
name|descriptor_UpdateSet
argument_list|(
operator|&
name|dl
operator|->
name|physical
operator|->
name|desc
argument_list|,
name|r
argument_list|,
name|w
argument_list|,
name|e
argument_list|,
name|n
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
name|result
return|;
block|}
end_function

begin_function
name|int
name|datalink_RemoveFromSet
parameter_list|(
name|struct
name|datalink
modifier|*
name|dl
parameter_list|,
name|fd_set
modifier|*
name|r
parameter_list|,
name|fd_set
modifier|*
name|w
parameter_list|,
name|fd_set
modifier|*
name|e
parameter_list|)
block|{
return|return
name|physical_RemoveFromSet
argument_list|(
name|dl
operator|->
name|physical
argument_list|,
name|r
argument_list|,
name|w
argument_list|,
name|e
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|datalink_IsSet
parameter_list|(
name|struct
name|descriptor
modifier|*
name|d
parameter_list|,
specifier|const
name|fd_set
modifier|*
name|fdset
parameter_list|)
block|{
name|struct
name|datalink
modifier|*
name|dl
init|=
name|descriptor2datalink
argument_list|(
name|d
argument_list|)
decl_stmt|;
switch|switch
condition|(
name|dl
operator|->
name|state
condition|)
block|{
case|case
name|DATALINK_CLOSED
case|:
case|case
name|DATALINK_OPENING
case|:
break|break;
case|case
name|DATALINK_HANGUP
case|:
case|case
name|DATALINK_DIAL
case|:
case|case
name|DATALINK_LOGIN
case|:
return|return
name|descriptor_IsSet
argument_list|(
operator|&
name|dl
operator|->
name|chat
operator|.
name|desc
argument_list|,
name|fdset
argument_list|)
return|;
case|case
name|DATALINK_READY
case|:
case|case
name|DATALINK_LCP
case|:
case|case
name|DATALINK_AUTH
case|:
case|case
name|DATALINK_CBCP
case|:
case|case
name|DATALINK_OPEN
case|:
return|return
name|descriptor_IsSet
argument_list|(
operator|&
name|dl
operator|->
name|chap
operator|.
name|desc
argument_list|,
name|fdset
argument_list|)
condition|?
literal|1
else|:
name|descriptor_IsSet
argument_list|(
operator|&
name|dl
operator|->
name|physical
operator|->
name|desc
argument_list|,
name|fdset
argument_list|)
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|datalink_Read
parameter_list|(
name|struct
name|descriptor
modifier|*
name|d
parameter_list|,
name|struct
name|bundle
modifier|*
name|bundle
parameter_list|,
specifier|const
name|fd_set
modifier|*
name|fdset
parameter_list|)
block|{
name|struct
name|datalink
modifier|*
name|dl
init|=
name|descriptor2datalink
argument_list|(
name|d
argument_list|)
decl_stmt|;
switch|switch
condition|(
name|dl
operator|->
name|state
condition|)
block|{
case|case
name|DATALINK_CLOSED
case|:
case|case
name|DATALINK_OPENING
case|:
break|break;
case|case
name|DATALINK_HANGUP
case|:
case|case
name|DATALINK_DIAL
case|:
case|case
name|DATALINK_LOGIN
case|:
name|descriptor_Read
argument_list|(
operator|&
name|dl
operator|->
name|chat
operator|.
name|desc
argument_list|,
name|bundle
argument_list|,
name|fdset
argument_list|)
expr_stmt|;
break|break;
case|case
name|DATALINK_READY
case|:
case|case
name|DATALINK_LCP
case|:
case|case
name|DATALINK_AUTH
case|:
case|case
name|DATALINK_CBCP
case|:
case|case
name|DATALINK_OPEN
case|:
if|if
condition|(
name|descriptor_IsSet
argument_list|(
operator|&
name|dl
operator|->
name|chap
operator|.
name|desc
argument_list|,
name|fdset
argument_list|)
condition|)
name|descriptor_Read
argument_list|(
operator|&
name|dl
operator|->
name|chap
operator|.
name|desc
argument_list|,
name|bundle
argument_list|,
name|fdset
argument_list|)
expr_stmt|;
if|if
condition|(
name|descriptor_IsSet
argument_list|(
operator|&
name|dl
operator|->
name|physical
operator|->
name|desc
argument_list|,
name|fdset
argument_list|)
condition|)
name|descriptor_Read
argument_list|(
operator|&
name|dl
operator|->
name|physical
operator|->
name|desc
argument_list|,
name|bundle
argument_list|,
name|fdset
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|datalink_Write
parameter_list|(
name|struct
name|descriptor
modifier|*
name|d
parameter_list|,
name|struct
name|bundle
modifier|*
name|bundle
parameter_list|,
specifier|const
name|fd_set
modifier|*
name|fdset
parameter_list|)
block|{
name|struct
name|datalink
modifier|*
name|dl
init|=
name|descriptor2datalink
argument_list|(
name|d
argument_list|)
decl_stmt|;
name|int
name|result
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|dl
operator|->
name|state
condition|)
block|{
case|case
name|DATALINK_CLOSED
case|:
case|case
name|DATALINK_OPENING
case|:
break|break;
case|case
name|DATALINK_HANGUP
case|:
case|case
name|DATALINK_DIAL
case|:
case|case
name|DATALINK_LOGIN
case|:
name|result
operator|=
name|descriptor_Write
argument_list|(
operator|&
name|dl
operator|->
name|chat
operator|.
name|desc
argument_list|,
name|bundle
argument_list|,
name|fdset
argument_list|)
expr_stmt|;
break|break;
case|case
name|DATALINK_READY
case|:
case|case
name|DATALINK_LCP
case|:
case|case
name|DATALINK_AUTH
case|:
case|case
name|DATALINK_CBCP
case|:
case|case
name|DATALINK_OPEN
case|:
if|if
condition|(
name|descriptor_IsSet
argument_list|(
operator|&
name|dl
operator|->
name|chap
operator|.
name|desc
argument_list|,
name|fdset
argument_list|)
condition|)
name|result
operator|+=
name|descriptor_Write
argument_list|(
operator|&
name|dl
operator|->
name|chap
operator|.
name|desc
argument_list|,
name|bundle
argument_list|,
name|fdset
argument_list|)
expr_stmt|;
if|if
condition|(
name|descriptor_IsSet
argument_list|(
operator|&
name|dl
operator|->
name|physical
operator|->
name|desc
argument_list|,
name|fdset
argument_list|)
condition|)
name|result
operator|+=
name|descriptor_Write
argument_list|(
operator|&
name|dl
operator|->
name|physical
operator|->
name|desc
argument_list|,
name|bundle
argument_list|,
name|fdset
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
name|result
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|datalink_ComeDown
parameter_list|(
name|struct
name|datalink
modifier|*
name|dl
parameter_list|,
name|int
name|how
parameter_list|)
block|{
if|if
condition|(
name|how
operator|!=
name|CLOSE_NORMAL
condition|)
block|{
name|dl
operator|->
name|dial
operator|.
name|tries
operator|=
operator|-
literal|1
expr_stmt|;
name|dl
operator|->
name|reconnect_tries
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|dl
operator|->
name|state
operator|>=
name|DATALINK_READY
operator|&&
name|how
operator|==
name|CLOSE_LCP
condition|)
name|dl
operator|->
name|stayonline
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|dl
operator|->
name|state
operator|>=
name|DATALINK_READY
operator|&&
name|dl
operator|->
name|stayonline
condition|)
block|{
name|dl
operator|->
name|stayonline
operator|=
literal|0
expr_stmt|;
name|physical_StopDeviceTimer
argument_list|(
name|dl
operator|->
name|physical
argument_list|)
expr_stmt|;
name|datalink_NewState
argument_list|(
name|dl
argument_list|,
name|DATALINK_READY
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|dl
operator|->
name|state
operator|!=
name|DATALINK_CLOSED
operator|&&
name|dl
operator|->
name|state
operator|!=
name|DATALINK_HANGUP
condition|)
block|{
name|physical_Offline
argument_list|(
name|dl
operator|->
name|physical
argument_list|)
expr_stmt|;
name|chat_Destroy
argument_list|(
operator|&
name|dl
operator|->
name|chat
argument_list|)
expr_stmt|;
if|if
condition|(
name|dl
operator|->
name|script
operator|.
name|run
operator|&&
name|dl
operator|->
name|state
operator|!=
name|DATALINK_OPENING
condition|)
block|{
name|datalink_NewState
argument_list|(
name|dl
argument_list|,
name|DATALINK_HANGUP
argument_list|)
expr_stmt|;
name|chat_Init
argument_list|(
operator|&
name|dl
operator|->
name|chat
argument_list|,
name|dl
operator|->
name|physical
argument_list|,
name|dl
operator|->
name|cfg
operator|.
name|script
operator|.
name|hangup
argument_list|,
literal|1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
else|else
name|datalink_HangupDone
argument_list|(
name|dl
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|datalink_LayerStart
parameter_list|(
name|void
modifier|*
name|v
parameter_list|,
name|struct
name|fsm
modifier|*
name|fp
parameter_list|)
block|{
comment|/* The given FSM is about to start up ! */
name|struct
name|datalink
modifier|*
name|dl
init|=
operator|(
expr|struct
name|datalink
operator|*
operator|)
name|v
decl_stmt|;
if|if
condition|(
name|fp
operator|->
name|proto
operator|==
name|PROTO_LCP
condition|)
call|(
modifier|*
name|dl
operator|->
name|parent
operator|->
name|LayerStart
call|)
argument_list|(
name|dl
operator|->
name|parent
operator|->
name|object
argument_list|,
name|fp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|datalink_LayerUp
parameter_list|(
name|void
modifier|*
name|v
parameter_list|,
name|struct
name|fsm
modifier|*
name|fp
parameter_list|)
block|{
comment|/* The given fsm is now up */
name|struct
name|datalink
modifier|*
name|dl
init|=
operator|(
expr|struct
name|datalink
operator|*
operator|)
name|v
decl_stmt|;
name|struct
name|lcp
modifier|*
name|lcp
init|=
operator|&
name|dl
operator|->
name|physical
operator|->
name|link
operator|.
name|lcp
decl_stmt|;
if|if
condition|(
name|fp
operator|->
name|proto
operator|==
name|PROTO_LCP
condition|)
block|{
name|datalink_GotAuthname
argument_list|(
name|dl
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|lcp
operator|->
name|auth_ineed
operator|=
name|lcp
operator|->
name|want_auth
expr_stmt|;
name|lcp
operator|->
name|auth_iwait
operator|=
name|lcp
operator|->
name|his_auth
expr_stmt|;
if|if
condition|(
name|lcp
operator|->
name|his_auth
operator|||
name|lcp
operator|->
name|want_auth
condition|)
block|{
if|if
condition|(
name|bundle_Phase
argument_list|(
name|dl
operator|->
name|bundle
argument_list|)
operator|!=
name|PHASE_NETWORK
condition|)
name|bundle_NewPhase
argument_list|(
name|dl
operator|->
name|bundle
argument_list|,
name|PHASE_AUTHENTICATE
argument_list|)
expr_stmt|;
name|log_Printf
argument_list|(
name|LogPHASE
argument_list|,
literal|"%s: his = %s, mine = %s\n"
argument_list|,
name|dl
operator|->
name|name
argument_list|,
name|Auth2Nam
argument_list|(
name|lcp
operator|->
name|his_auth
argument_list|,
name|lcp
operator|->
name|his_authtype
argument_list|)
argument_list|,
name|Auth2Nam
argument_list|(
name|lcp
operator|->
name|want_auth
argument_list|,
name|lcp
operator|->
name|want_authtype
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|lcp
operator|->
name|his_auth
operator|==
name|PROTO_PAP
condition|)
name|auth_StartReq
argument_list|(
operator|&
name|dl
operator|->
name|pap
argument_list|)
expr_stmt|;
if|if
condition|(
name|lcp
operator|->
name|want_auth
operator|==
name|PROTO_CHAP
condition|)
name|auth_StartReq
argument_list|(
operator|&
name|dl
operator|->
name|chap
operator|.
name|auth
argument_list|)
expr_stmt|;
block|}
else|else
name|datalink_AuthOk
argument_list|(
name|dl
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|datalink_AuthReInit
parameter_list|(
name|struct
name|datalink
modifier|*
name|dl
parameter_list|)
block|{
name|auth_StopTimer
argument_list|(
operator|&
name|dl
operator|->
name|pap
argument_list|)
expr_stmt|;
name|auth_StopTimer
argument_list|(
operator|&
name|dl
operator|->
name|chap
operator|.
name|auth
argument_list|)
expr_stmt|;
name|chap_ReInit
argument_list|(
operator|&
name|dl
operator|->
name|chap
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|datalink_GotAuthname
parameter_list|(
name|struct
name|datalink
modifier|*
name|dl
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
name|strncpy
argument_list|(
name|dl
operator|->
name|peer
operator|.
name|authname
argument_list|,
name|name
argument_list|,
sizeof|sizeof
name|dl
operator|->
name|peer
operator|.
name|authname
operator|-
literal|1
argument_list|)
expr_stmt|;
name|dl
operator|->
name|peer
operator|.
name|authname
index|[
sizeof|sizeof
name|dl
operator|->
name|peer
operator|.
name|authname
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
end_function

begin_function
name|void
name|datalink_NCPUp
parameter_list|(
name|struct
name|datalink
modifier|*
name|dl
parameter_list|)
block|{
name|int
name|ccpok
init|=
name|ccp_SetOpenMode
argument_list|(
operator|&
name|dl
operator|->
name|physical
operator|->
name|link
operator|.
name|ccp
argument_list|)
decl_stmt|;
if|if
condition|(
name|dl
operator|->
name|physical
operator|->
name|link
operator|.
name|lcp
operator|.
name|want_mrru
operator|&&
name|dl
operator|->
name|physical
operator|->
name|link
operator|.
name|lcp
operator|.
name|his_mrru
condition|)
block|{
comment|/* we've authenticated in multilink mode ! */
switch|switch
condition|(
name|mp_Up
argument_list|(
operator|&
name|dl
operator|->
name|bundle
operator|->
name|ncp
operator|.
name|mp
argument_list|,
name|dl
argument_list|)
condition|)
block|{
case|case
name|MP_LINKSENT
case|:
comment|/* We've handed the link off to another ppp (well, we will soon) ! */
return|return;
case|case
name|MP_UP
case|:
comment|/* First link in the bundle */
name|auth_Select
argument_list|(
name|dl
operator|->
name|bundle
argument_list|,
name|dl
operator|->
name|peer
operator|.
name|authname
argument_list|)
expr_stmt|;
comment|/* fall through */
case|case
name|MP_ADDED
case|:
comment|/* We're in multilink mode ! */
name|dl
operator|->
name|physical
operator|->
name|link
operator|.
name|ccp
operator|.
name|fsm
operator|.
name|open_mode
operator|=
name|OPEN_PASSIVE
expr_stmt|;
comment|/* override */
break|break;
case|case
name|MP_FAILED
case|:
name|datalink_AuthNotOk
argument_list|(
name|dl
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
elseif|else
if|if
condition|(
name|bundle_Phase
argument_list|(
name|dl
operator|->
name|bundle
argument_list|)
operator|==
name|PHASE_NETWORK
condition|)
block|{
name|log_Printf
argument_list|(
name|LogPHASE
argument_list|,
literal|"%s: Already in NETWORK phase\n"
argument_list|,
name|dl
operator|->
name|name
argument_list|)
expr_stmt|;
name|datalink_NewState
argument_list|(
name|dl
argument_list|,
name|DATALINK_OPEN
argument_list|)
expr_stmt|;
call|(
modifier|*
name|dl
operator|->
name|parent
operator|->
name|LayerUp
call|)
argument_list|(
name|dl
operator|->
name|parent
operator|->
name|object
argument_list|,
operator|&
name|dl
operator|->
name|physical
operator|->
name|link
operator|.
name|lcp
operator|.
name|fsm
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|dl
operator|->
name|bundle
operator|->
name|ncp
operator|.
name|mp
operator|.
name|peer
operator|=
name|dl
operator|->
name|peer
expr_stmt|;
name|ipcp_SetLink
argument_list|(
operator|&
name|dl
operator|->
name|bundle
operator|->
name|ncp
operator|.
name|ipcp
argument_list|,
operator|&
name|dl
operator|->
name|physical
operator|->
name|link
argument_list|)
expr_stmt|;
name|auth_Select
argument_list|(
name|dl
operator|->
name|bundle
argument_list|,
name|dl
operator|->
name|peer
operator|.
name|authname
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ccpok
condition|)
block|{
name|fsm_Up
argument_list|(
operator|&
name|dl
operator|->
name|physical
operator|->
name|link
operator|.
name|ccp
operator|.
name|fsm
argument_list|)
expr_stmt|;
name|fsm_Open
argument_list|(
operator|&
name|dl
operator|->
name|physical
operator|->
name|link
operator|.
name|ccp
operator|.
name|fsm
argument_list|)
expr_stmt|;
block|}
name|datalink_NewState
argument_list|(
name|dl
argument_list|,
name|DATALINK_OPEN
argument_list|)
expr_stmt|;
name|bundle_NewPhase
argument_list|(
name|dl
operator|->
name|bundle
argument_list|,
name|PHASE_NETWORK
argument_list|)
expr_stmt|;
call|(
modifier|*
name|dl
operator|->
name|parent
operator|->
name|LayerUp
call|)
argument_list|(
name|dl
operator|->
name|parent
operator|->
name|object
argument_list|,
operator|&
name|dl
operator|->
name|physical
operator|->
name|link
operator|.
name|lcp
operator|.
name|fsm
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|datalink_CBCPComplete
parameter_list|(
name|struct
name|datalink
modifier|*
name|dl
parameter_list|)
block|{
name|datalink_NewState
argument_list|(
name|dl
argument_list|,
name|DATALINK_LCP
argument_list|)
expr_stmt|;
name|datalink_AuthReInit
argument_list|(
name|dl
argument_list|)
expr_stmt|;
name|fsm_Close
argument_list|(
operator|&
name|dl
operator|->
name|physical
operator|->
name|link
operator|.
name|lcp
operator|.
name|fsm
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|datalink_CBCPFailed
parameter_list|(
name|struct
name|datalink
modifier|*
name|dl
parameter_list|)
block|{
name|cbcp_Down
argument_list|(
operator|&
name|dl
operator|->
name|cbcp
argument_list|)
expr_stmt|;
name|datalink_CBCPComplete
argument_list|(
name|dl
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|datalink_AuthOk
parameter_list|(
name|struct
name|datalink
modifier|*
name|dl
parameter_list|)
block|{
if|if
condition|(
operator|(
name|dl
operator|->
name|physical
operator|->
name|link
operator|.
name|lcp
operator|.
name|his_callback
operator|.
name|opmask
operator|&
name|CALLBACK_BIT
argument_list|(
name|CALLBACK_CBCP
argument_list|)
operator|||
name|dl
operator|->
name|physical
operator|->
name|link
operator|.
name|lcp
operator|.
name|want_callback
operator|.
name|opmask
operator|&
name|CALLBACK_BIT
argument_list|(
name|CALLBACK_CBCP
argument_list|)
operator|)
operator|&&
operator|!
operator|(
name|dl
operator|->
name|physical
operator|->
name|link
operator|.
name|lcp
operator|.
name|want_callback
operator|.
name|opmask
operator|&
name|CALLBACK_BIT
argument_list|(
name|CALLBACK_AUTH
argument_list|)
operator|)
condition|)
block|{
comment|/* We must have agreed CBCP if AUTH isn't there any more */
name|datalink_NewState
argument_list|(
name|dl
argument_list|,
name|DATALINK_CBCP
argument_list|)
expr_stmt|;
name|cbcp_Up
argument_list|(
operator|&
name|dl
operator|->
name|cbcp
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|dl
operator|->
name|physical
operator|->
name|link
operator|.
name|lcp
operator|.
name|want_callback
operator|.
name|opmask
condition|)
block|{
comment|/* It's not CBCP */
name|log_Printf
argument_list|(
name|LogPHASE
argument_list|,
literal|"%s: Shutdown and await peer callback\n"
argument_list|,
name|dl
operator|->
name|name
argument_list|)
expr_stmt|;
name|datalink_NewState
argument_list|(
name|dl
argument_list|,
name|DATALINK_LCP
argument_list|)
expr_stmt|;
name|datalink_AuthReInit
argument_list|(
name|dl
argument_list|)
expr_stmt|;
name|fsm_Close
argument_list|(
operator|&
name|dl
operator|->
name|physical
operator|->
name|link
operator|.
name|lcp
operator|.
name|fsm
argument_list|)
expr_stmt|;
block|}
else|else
switch|switch
condition|(
name|dl
operator|->
name|physical
operator|->
name|link
operator|.
name|lcp
operator|.
name|his_callback
operator|.
name|opmask
condition|)
block|{
case|case
literal|0
case|:
name|datalink_NCPUp
argument_list|(
name|dl
argument_list|)
expr_stmt|;
break|break;
case|case
name|CALLBACK_BIT
argument_list|(
name|CALLBACK_AUTH
argument_list|)
case|:
name|auth_SetPhoneList
argument_list|(
name|dl
operator|->
name|peer
operator|.
name|authname
argument_list|,
name|dl
operator|->
name|cbcp
operator|.
name|fsm
operator|.
name|phone
argument_list|,
sizeof|sizeof
name|dl
operator|->
name|cbcp
operator|.
name|fsm
operator|.
name|phone
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|dl
operator|->
name|cbcp
operator|.
name|fsm
operator|.
name|phone
operator|==
literal|'\0'
operator|||
operator|!
name|strcmp
argument_list|(
name|dl
operator|->
name|cbcp
operator|.
name|fsm
operator|.
name|phone
argument_list|,
literal|"*"
argument_list|)
condition|)
block|{
name|log_Printf
argument_list|(
name|LogPHASE
argument_list|,
literal|"%s: %s cannot be called back\n"
argument_list|,
name|dl
operator|->
name|name
argument_list|,
name|dl
operator|->
name|peer
operator|.
name|authname
argument_list|)
expr_stmt|;
operator|*
name|dl
operator|->
name|cbcp
operator|.
name|fsm
operator|.
name|phone
operator|=
literal|'\0'
expr_stmt|;
block|}
else|else
block|{
name|char
modifier|*
name|ptr
init|=
name|strchr
argument_list|(
name|dl
operator|->
name|cbcp
operator|.
name|fsm
operator|.
name|phone
argument_list|,
literal|','
argument_list|)
decl_stmt|;
if|if
condition|(
name|ptr
condition|)
operator|*
name|ptr
operator|=
literal|'\0'
expr_stmt|;
comment|/* Call back on the first number */
name|log_Printf
argument_list|(
name|LogPHASE
argument_list|,
literal|"%s: Calling peer back on %s\n"
argument_list|,
name|dl
operator|->
name|name
argument_list|,
name|dl
operator|->
name|cbcp
operator|.
name|fsm
operator|.
name|phone
argument_list|)
expr_stmt|;
name|dl
operator|->
name|cbcp
operator|.
name|required
operator|=
literal|1
expr_stmt|;
block|}
name|dl
operator|->
name|cbcp
operator|.
name|fsm
operator|.
name|delay
operator|=
literal|0
expr_stmt|;
name|datalink_NewState
argument_list|(
name|dl
argument_list|,
name|DATALINK_LCP
argument_list|)
expr_stmt|;
name|datalink_AuthReInit
argument_list|(
name|dl
argument_list|)
expr_stmt|;
name|fsm_Close
argument_list|(
operator|&
name|dl
operator|->
name|physical
operator|->
name|link
operator|.
name|lcp
operator|.
name|fsm
argument_list|)
expr_stmt|;
break|break;
case|case
name|CALLBACK_BIT
argument_list|(
name|CALLBACK_E164
argument_list|)
case|:
name|strncpy
argument_list|(
name|dl
operator|->
name|cbcp
operator|.
name|fsm
operator|.
name|phone
argument_list|,
name|dl
operator|->
name|physical
operator|->
name|link
operator|.
name|lcp
operator|.
name|his_callback
operator|.
name|msg
argument_list|,
sizeof|sizeof
name|dl
operator|->
name|cbcp
operator|.
name|fsm
operator|.
name|phone
operator|-
literal|1
argument_list|)
expr_stmt|;
name|dl
operator|->
name|cbcp
operator|.
name|fsm
operator|.
name|phone
index|[
sizeof|sizeof
name|dl
operator|->
name|cbcp
operator|.
name|fsm
operator|.
name|phone
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|log_Printf
argument_list|(
name|LogPHASE
argument_list|,
literal|"%s: Calling peer back on %s\n"
argument_list|,
name|dl
operator|->
name|name
argument_list|,
name|dl
operator|->
name|cbcp
operator|.
name|fsm
operator|.
name|phone
argument_list|)
expr_stmt|;
name|dl
operator|->
name|cbcp
operator|.
name|required
operator|=
literal|1
expr_stmt|;
name|dl
operator|->
name|cbcp
operator|.
name|fsm
operator|.
name|delay
operator|=
literal|0
expr_stmt|;
name|datalink_NewState
argument_list|(
name|dl
argument_list|,
name|DATALINK_LCP
argument_list|)
expr_stmt|;
name|datalink_AuthReInit
argument_list|(
name|dl
argument_list|)
expr_stmt|;
name|fsm_Close
argument_list|(
operator|&
name|dl
operator|->
name|physical
operator|->
name|link
operator|.
name|lcp
operator|.
name|fsm
argument_list|)
expr_stmt|;
break|break;
default|default:
name|log_Printf
argument_list|(
name|LogPHASE
argument_list|,
literal|"%s: Oops - Should have NAK'd peer callback !\n"
argument_list|,
name|dl
operator|->
name|name
argument_list|)
expr_stmt|;
name|datalink_NewState
argument_list|(
name|dl
argument_list|,
name|DATALINK_LCP
argument_list|)
expr_stmt|;
name|datalink_AuthReInit
argument_list|(
name|dl
argument_list|)
expr_stmt|;
name|fsm_Close
argument_list|(
operator|&
name|dl
operator|->
name|physical
operator|->
name|link
operator|.
name|lcp
operator|.
name|fsm
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
name|void
name|datalink_AuthNotOk
parameter_list|(
name|struct
name|datalink
modifier|*
name|dl
parameter_list|)
block|{
name|datalink_NewState
argument_list|(
name|dl
argument_list|,
name|DATALINK_LCP
argument_list|)
expr_stmt|;
name|datalink_AuthReInit
argument_list|(
name|dl
argument_list|)
expr_stmt|;
name|fsm_Close
argument_list|(
operator|&
name|dl
operator|->
name|physical
operator|->
name|link
operator|.
name|lcp
operator|.
name|fsm
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|datalink_LayerDown
parameter_list|(
name|void
modifier|*
name|v
parameter_list|,
name|struct
name|fsm
modifier|*
name|fp
parameter_list|)
block|{
comment|/* The given FSM has been told to come down */
name|struct
name|datalink
modifier|*
name|dl
init|=
operator|(
expr|struct
name|datalink
operator|*
operator|)
name|v
decl_stmt|;
if|if
condition|(
name|fp
operator|->
name|proto
operator|==
name|PROTO_LCP
condition|)
block|{
switch|switch
condition|(
name|dl
operator|->
name|state
condition|)
block|{
case|case
name|DATALINK_OPEN
case|:
name|peerid_Init
argument_list|(
operator|&
name|dl
operator|->
name|peer
argument_list|)
expr_stmt|;
name|fsm2initial
argument_list|(
operator|&
name|dl
operator|->
name|physical
operator|->
name|link
operator|.
name|ccp
operator|.
name|fsm
argument_list|)
expr_stmt|;
name|datalink_NewState
argument_list|(
name|dl
argument_list|,
name|DATALINK_LCP
argument_list|)
expr_stmt|;
comment|/* before parent TLD */
call|(
modifier|*
name|dl
operator|->
name|parent
operator|->
name|LayerDown
call|)
argument_list|(
name|dl
operator|->
name|parent
operator|->
name|object
argument_list|,
name|fp
argument_list|)
expr_stmt|;
comment|/* fall through (just in case) */
case|case
name|DATALINK_CBCP
case|:
if|if
condition|(
operator|!
name|dl
operator|->
name|cbcp
operator|.
name|required
condition|)
name|cbcp_Down
argument_list|(
operator|&
name|dl
operator|->
name|cbcp
argument_list|)
expr_stmt|;
comment|/* fall through (just in case) */
case|case
name|DATALINK_AUTH
case|:
name|timer_Stop
argument_list|(
operator|&
name|dl
operator|->
name|pap
operator|.
name|authtimer
argument_list|)
expr_stmt|;
name|timer_Stop
argument_list|(
operator|&
name|dl
operator|->
name|chap
operator|.
name|auth
operator|.
name|authtimer
argument_list|)
expr_stmt|;
block|}
name|datalink_NewState
argument_list|(
name|dl
argument_list|,
name|DATALINK_LCP
argument_list|)
expr_stmt|;
name|datalink_AuthReInit
argument_list|(
name|dl
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|datalink_LayerFinish
parameter_list|(
name|void
modifier|*
name|v
parameter_list|,
name|struct
name|fsm
modifier|*
name|fp
parameter_list|)
block|{
comment|/* The given fsm is now down */
name|struct
name|datalink
modifier|*
name|dl
init|=
operator|(
expr|struct
name|datalink
operator|*
operator|)
name|v
decl_stmt|;
if|if
condition|(
name|fp
operator|->
name|proto
operator|==
name|PROTO_LCP
condition|)
block|{
name|fsm2initial
argument_list|(
name|fp
argument_list|)
expr_stmt|;
call|(
modifier|*
name|dl
operator|->
name|parent
operator|->
name|LayerFinish
call|)
argument_list|(
name|dl
operator|->
name|parent
operator|->
name|object
argument_list|,
name|fp
argument_list|)
expr_stmt|;
name|datalink_ComeDown
argument_list|(
name|dl
argument_list|,
name|CLOSE_NORMAL
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fp
operator|->
name|state
operator|==
name|ST_CLOSED
operator|&&
name|fp
operator|->
name|open_mode
operator|==
name|OPEN_PASSIVE
condition|)
name|fsm_Open
argument_list|(
name|fp
argument_list|)
expr_stmt|;
comment|/* CCP goes to ST_STOPPED */
block|}
end_function

begin_function
name|struct
name|datalink
modifier|*
name|datalink_Create
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|struct
name|bundle
modifier|*
name|bundle
parameter_list|,
name|int
name|type
parameter_list|)
block|{
name|struct
name|datalink
modifier|*
name|dl
decl_stmt|;
name|dl
operator|=
operator|(
expr|struct
name|datalink
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|datalink
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dl
operator|==
name|NULL
condition|)
return|return
name|dl
return|;
name|dl
operator|->
name|desc
operator|.
name|type
operator|=
name|DATALINK_DESCRIPTOR
expr_stmt|;
name|dl
operator|->
name|desc
operator|.
name|UpdateSet
operator|=
name|datalink_UpdateSet
expr_stmt|;
name|dl
operator|->
name|desc
operator|.
name|IsSet
operator|=
name|datalink_IsSet
expr_stmt|;
name|dl
operator|->
name|desc
operator|.
name|Read
operator|=
name|datalink_Read
expr_stmt|;
name|dl
operator|->
name|desc
operator|.
name|Write
operator|=
name|datalink_Write
expr_stmt|;
name|dl
operator|->
name|state
operator|=
name|DATALINK_CLOSED
expr_stmt|;
operator|*
name|dl
operator|->
name|cfg
operator|.
name|script
operator|.
name|dial
operator|=
literal|'\0'
expr_stmt|;
operator|*
name|dl
operator|->
name|cfg
operator|.
name|script
operator|.
name|login
operator|=
literal|'\0'
expr_stmt|;
operator|*
name|dl
operator|->
name|cfg
operator|.
name|script
operator|.
name|hangup
operator|=
literal|'\0'
expr_stmt|;
operator|*
name|dl
operator|->
name|cfg
operator|.
name|phone
operator|.
name|list
operator|=
literal|'\0'
expr_stmt|;
operator|*
name|dl
operator|->
name|phone
operator|.
name|list
operator|=
literal|'\0'
expr_stmt|;
name|dl
operator|->
name|phone
operator|.
name|next
operator|=
name|NULL
expr_stmt|;
name|dl
operator|->
name|phone
operator|.
name|alt
operator|=
name|NULL
expr_stmt|;
name|dl
operator|->
name|phone
operator|.
name|chosen
operator|=
literal|"N/A"
expr_stmt|;
name|dl
operator|->
name|stayonline
operator|=
literal|0
expr_stmt|;
name|dl
operator|->
name|script
operator|.
name|run
operator|=
literal|1
expr_stmt|;
name|dl
operator|->
name|script
operator|.
name|packetmode
operator|=
literal|1
expr_stmt|;
name|mp_linkInit
argument_list|(
operator|&
name|dl
operator|->
name|mp
argument_list|)
expr_stmt|;
name|dl
operator|->
name|bundle
operator|=
name|bundle
expr_stmt|;
name|dl
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
name|memset
argument_list|(
operator|&
name|dl
operator|->
name|dial
operator|.
name|timer
argument_list|,
literal|'\0'
argument_list|,
sizeof|sizeof
name|dl
operator|->
name|dial
operator|.
name|timer
argument_list|)
expr_stmt|;
name|dl
operator|->
name|dial
operator|.
name|tries
operator|=
literal|0
expr_stmt|;
name|dl
operator|->
name|cfg
operator|.
name|dial
operator|.
name|max
operator|=
literal|1
expr_stmt|;
name|dl
operator|->
name|cfg
operator|.
name|dial
operator|.
name|next_timeout
operator|=
name|DIAL_NEXT_TIMEOUT
expr_stmt|;
name|dl
operator|->
name|cfg
operator|.
name|dial
operator|.
name|timeout
operator|=
name|DIAL_TIMEOUT
expr_stmt|;
name|dl
operator|->
name|cfg
operator|.
name|dial
operator|.
name|inc
operator|=
literal|0
expr_stmt|;
name|dl
operator|->
name|cfg
operator|.
name|dial
operator|.
name|maxinc
operator|=
literal|10
expr_stmt|;
name|dl
operator|->
name|reconnect_tries
operator|=
literal|0
expr_stmt|;
name|dl
operator|->
name|cfg
operator|.
name|reconnect
operator|.
name|max
operator|=
literal|0
expr_stmt|;
name|dl
operator|->
name|cfg
operator|.
name|reconnect
operator|.
name|timeout
operator|=
name|RECONNECT_TIMEOUT
expr_stmt|;
name|dl
operator|->
name|cfg
operator|.
name|callback
operator|.
name|opmask
operator|=
literal|0
expr_stmt|;
name|dl
operator|->
name|cfg
operator|.
name|cbcp
operator|.
name|delay
operator|=
literal|0
expr_stmt|;
operator|*
name|dl
operator|->
name|cfg
operator|.
name|cbcp
operator|.
name|phone
operator|=
literal|'\0'
expr_stmt|;
name|dl
operator|->
name|cfg
operator|.
name|cbcp
operator|.
name|fsmretry
operator|=
name|DEF_FSMRETRY
expr_stmt|;
name|dl
operator|->
name|name
operator|=
name|strdup
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|peerid_Init
argument_list|(
operator|&
name|dl
operator|->
name|peer
argument_list|)
expr_stmt|;
name|dl
operator|->
name|parent
operator|=
operator|&
name|bundle
operator|->
name|fsm
expr_stmt|;
name|dl
operator|->
name|fsmp
operator|.
name|LayerStart
operator|=
name|datalink_LayerStart
expr_stmt|;
name|dl
operator|->
name|fsmp
operator|.
name|LayerUp
operator|=
name|datalink_LayerUp
expr_stmt|;
name|dl
operator|->
name|fsmp
operator|.
name|LayerDown
operator|=
name|datalink_LayerDown
expr_stmt|;
name|dl
operator|->
name|fsmp
operator|.
name|LayerFinish
operator|=
name|datalink_LayerFinish
expr_stmt|;
name|dl
operator|->
name|fsmp
operator|.
name|object
operator|=
name|dl
expr_stmt|;
if|if
condition|(
operator|(
name|dl
operator|->
name|physical
operator|=
name|physical_Create
argument_list|(
name|dl
argument_list|,
name|type
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
name|dl
operator|->
name|name
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|dl
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|pap_Init
argument_list|(
operator|&
name|dl
operator|->
name|pap
argument_list|,
name|dl
operator|->
name|physical
argument_list|)
expr_stmt|;
name|chap_Init
argument_list|(
operator|&
name|dl
operator|->
name|chap
argument_list|,
name|dl
operator|->
name|physical
argument_list|)
expr_stmt|;
name|cbcp_Init
argument_list|(
operator|&
name|dl
operator|->
name|cbcp
argument_list|,
name|dl
operator|->
name|physical
argument_list|)
expr_stmt|;
name|chat_Init
argument_list|(
operator|&
name|dl
operator|->
name|chat
argument_list|,
name|dl
operator|->
name|physical
argument_list|,
name|NULL
argument_list|,
literal|1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|log_Printf
argument_list|(
name|LogPHASE
argument_list|,
literal|"%s: Created in %s state\n"
argument_list|,
name|dl
operator|->
name|name
argument_list|,
name|datalink_State
argument_list|(
name|dl
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|dl
return|;
block|}
end_function

begin_function
name|struct
name|datalink
modifier|*
name|datalink_Clone
parameter_list|(
name|struct
name|datalink
modifier|*
name|odl
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
name|struct
name|datalink
modifier|*
name|dl
decl_stmt|;
name|dl
operator|=
operator|(
expr|struct
name|datalink
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|datalink
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dl
operator|==
name|NULL
condition|)
return|return
name|dl
return|;
name|dl
operator|->
name|desc
operator|.
name|type
operator|=
name|DATALINK_DESCRIPTOR
expr_stmt|;
name|dl
operator|->
name|desc
operator|.
name|UpdateSet
operator|=
name|datalink_UpdateSet
expr_stmt|;
name|dl
operator|->
name|desc
operator|.
name|IsSet
operator|=
name|datalink_IsSet
expr_stmt|;
name|dl
operator|->
name|desc
operator|.
name|Read
operator|=
name|datalink_Read
expr_stmt|;
name|dl
operator|->
name|desc
operator|.
name|Write
operator|=
name|datalink_Write
expr_stmt|;
name|dl
operator|->
name|state
operator|=
name|DATALINK_CLOSED
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|dl
operator|->
name|cfg
argument_list|,
operator|&
name|odl
operator|->
name|cfg
argument_list|,
sizeof|sizeof
name|dl
operator|->
name|cfg
argument_list|)
expr_stmt|;
name|mp_linkInit
argument_list|(
operator|&
name|dl
operator|->
name|mp
argument_list|)
expr_stmt|;
operator|*
name|dl
operator|->
name|phone
operator|.
name|list
operator|=
literal|'\0'
expr_stmt|;
name|dl
operator|->
name|phone
operator|.
name|next
operator|=
name|NULL
expr_stmt|;
name|dl
operator|->
name|phone
operator|.
name|alt
operator|=
name|NULL
expr_stmt|;
name|dl
operator|->
name|phone
operator|.
name|chosen
operator|=
literal|"N/A"
expr_stmt|;
name|dl
operator|->
name|bundle
operator|=
name|odl
operator|->
name|bundle
expr_stmt|;
name|dl
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
name|memset
argument_list|(
operator|&
name|dl
operator|->
name|dial
operator|.
name|timer
argument_list|,
literal|'\0'
argument_list|,
sizeof|sizeof
name|dl
operator|->
name|dial
operator|.
name|timer
argument_list|)
expr_stmt|;
name|dl
operator|->
name|dial
operator|.
name|tries
operator|=
literal|0
expr_stmt|;
name|dl
operator|->
name|reconnect_tries
operator|=
literal|0
expr_stmt|;
name|dl
operator|->
name|name
operator|=
name|strdup
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|peerid_Init
argument_list|(
operator|&
name|dl
operator|->
name|peer
argument_list|)
expr_stmt|;
name|dl
operator|->
name|parent
operator|=
name|odl
operator|->
name|parent
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|dl
operator|->
name|fsmp
argument_list|,
operator|&
name|odl
operator|->
name|fsmp
argument_list|,
sizeof|sizeof
name|dl
operator|->
name|fsmp
argument_list|)
expr_stmt|;
name|dl
operator|->
name|fsmp
operator|.
name|object
operator|=
name|dl
expr_stmt|;
if|if
condition|(
operator|(
name|dl
operator|->
name|physical
operator|=
name|physical_Create
argument_list|(
name|dl
argument_list|,
name|PHYS_INTERACTIVE
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
name|dl
operator|->
name|name
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|dl
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|pap_Init
argument_list|(
operator|&
name|dl
operator|->
name|pap
argument_list|,
name|dl
operator|->
name|physical
argument_list|)
expr_stmt|;
name|dl
operator|->
name|pap
operator|.
name|cfg
operator|=
name|odl
operator|->
name|pap
operator|.
name|cfg
expr_stmt|;
name|chap_Init
argument_list|(
operator|&
name|dl
operator|->
name|chap
argument_list|,
name|dl
operator|->
name|physical
argument_list|)
expr_stmt|;
name|dl
operator|->
name|chap
operator|.
name|auth
operator|.
name|cfg
operator|=
name|odl
operator|->
name|chap
operator|.
name|auth
operator|.
name|cfg
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|dl
operator|->
name|physical
operator|->
name|cfg
argument_list|,
operator|&
name|odl
operator|->
name|physical
operator|->
name|cfg
argument_list|,
sizeof|sizeof
name|dl
operator|->
name|physical
operator|->
name|cfg
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|dl
operator|->
name|physical
operator|->
name|link
operator|.
name|lcp
operator|.
name|cfg
argument_list|,
operator|&
name|odl
operator|->
name|physical
operator|->
name|link
operator|.
name|lcp
operator|.
name|cfg
argument_list|,
sizeof|sizeof
name|dl
operator|->
name|physical
operator|->
name|link
operator|.
name|lcp
operator|.
name|cfg
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|dl
operator|->
name|physical
operator|->
name|link
operator|.
name|ccp
operator|.
name|cfg
argument_list|,
operator|&
name|odl
operator|->
name|physical
operator|->
name|link
operator|.
name|ccp
operator|.
name|cfg
argument_list|,
sizeof|sizeof
name|dl
operator|->
name|physical
operator|->
name|link
operator|.
name|ccp
operator|.
name|cfg
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|dl
operator|->
name|physical
operator|->
name|async
operator|.
name|cfg
argument_list|,
operator|&
name|odl
operator|->
name|physical
operator|->
name|async
operator|.
name|cfg
argument_list|,
sizeof|sizeof
name|dl
operator|->
name|physical
operator|->
name|async
operator|.
name|cfg
argument_list|)
expr_stmt|;
name|cbcp_Init
argument_list|(
operator|&
name|dl
operator|->
name|cbcp
argument_list|,
name|dl
operator|->
name|physical
argument_list|)
expr_stmt|;
name|chat_Init
argument_list|(
operator|&
name|dl
operator|->
name|chat
argument_list|,
name|dl
operator|->
name|physical
argument_list|,
name|NULL
argument_list|,
literal|1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|log_Printf
argument_list|(
name|LogPHASE
argument_list|,
literal|"%s: Cloned in %s state\n"
argument_list|,
name|dl
operator|->
name|name
argument_list|,
name|datalink_State
argument_list|(
name|dl
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|dl
return|;
block|}
end_function

begin_function
name|struct
name|datalink
modifier|*
name|datalink_Destroy
parameter_list|(
name|struct
name|datalink
modifier|*
name|dl
parameter_list|)
block|{
name|struct
name|datalink
modifier|*
name|result
decl_stmt|;
if|if
condition|(
name|dl
operator|->
name|state
operator|!=
name|DATALINK_CLOSED
condition|)
block|{
name|log_Printf
argument_list|(
name|LogERROR
argument_list|,
literal|"Oops, destroying a datalink in state %s\n"
argument_list|,
name|datalink_State
argument_list|(
name|dl
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|dl
operator|->
name|state
condition|)
block|{
case|case
name|DATALINK_HANGUP
case|:
case|case
name|DATALINK_DIAL
case|:
case|case
name|DATALINK_LOGIN
case|:
name|chat_Destroy
argument_list|(
operator|&
name|dl
operator|->
name|chat
argument_list|)
expr_stmt|;
comment|/* Gotta blat the timers ! */
break|break;
block|}
block|}
name|timer_Stop
argument_list|(
operator|&
name|dl
operator|->
name|dial
operator|.
name|timer
argument_list|)
expr_stmt|;
name|result
operator|=
name|dl
operator|->
name|next
expr_stmt|;
name|physical_Destroy
argument_list|(
name|dl
operator|->
name|physical
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|dl
operator|->
name|name
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|dl
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
end_function

begin_function
name|void
name|datalink_Up
parameter_list|(
name|struct
name|datalink
modifier|*
name|dl
parameter_list|,
name|int
name|runscripts
parameter_list|,
name|int
name|packetmode
parameter_list|)
block|{
if|if
condition|(
name|dl
operator|->
name|physical
operator|->
name|type
operator|&
operator|(
name|PHYS_DIRECT
operator||
name|PHYS_DEDICATED
operator|)
condition|)
comment|/* Ignore scripts */
name|runscripts
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|dl
operator|->
name|state
condition|)
block|{
case|case
name|DATALINK_CLOSED
case|:
if|if
condition|(
name|bundle_Phase
argument_list|(
name|dl
operator|->
name|bundle
argument_list|)
operator|==
name|PHASE_DEAD
operator|||
name|bundle_Phase
argument_list|(
name|dl
operator|->
name|bundle
argument_list|)
operator|==
name|PHASE_TERMINATE
condition|)
name|bundle_NewPhase
argument_list|(
name|dl
operator|->
name|bundle
argument_list|,
name|PHASE_ESTABLISH
argument_list|)
expr_stmt|;
name|datalink_NewState
argument_list|(
name|dl
argument_list|,
name|DATALINK_OPENING
argument_list|)
expr_stmt|;
name|dl
operator|->
name|reconnect_tries
operator|=
name|dl
operator|->
name|physical
operator|->
name|type
operator|==
name|PHYS_DIRECT
condition|?
literal|0
else|:
name|dl
operator|->
name|cfg
operator|.
name|reconnect
operator|.
name|max
expr_stmt|;
name|dl
operator|->
name|dial
operator|.
name|tries
operator|=
name|dl
operator|->
name|cfg
operator|.
name|dial
operator|.
name|max
expr_stmt|;
name|dl
operator|->
name|script
operator|.
name|run
operator|=
name|runscripts
expr_stmt|;
name|dl
operator|->
name|script
operator|.
name|packetmode
operator|=
name|packetmode
expr_stmt|;
break|break;
case|case
name|DATALINK_OPENING
case|:
if|if
condition|(
operator|!
name|dl
operator|->
name|script
operator|.
name|run
operator|&&
name|runscripts
condition|)
name|dl
operator|->
name|script
operator|.
name|run
operator|=
literal|1
expr_stmt|;
comment|/* fall through */
case|case
name|DATALINK_DIAL
case|:
case|case
name|DATALINK_LOGIN
case|:
case|case
name|DATALINK_READY
case|:
if|if
condition|(
operator|!
name|dl
operator|->
name|script
operator|.
name|packetmode
operator|&&
name|packetmode
condition|)
block|{
name|dl
operator|->
name|script
operator|.
name|packetmode
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|dl
operator|->
name|state
operator|==
name|DATALINK_READY
condition|)
name|datalink_LoginDone
argument_list|(
name|dl
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
block|}
end_function

begin_function
name|void
name|datalink_Close
parameter_list|(
name|struct
name|datalink
modifier|*
name|dl
parameter_list|,
name|int
name|how
parameter_list|)
block|{
comment|/* Please close */
switch|switch
condition|(
name|dl
operator|->
name|state
condition|)
block|{
case|case
name|DATALINK_OPEN
case|:
name|peerid_Init
argument_list|(
operator|&
name|dl
operator|->
name|peer
argument_list|)
expr_stmt|;
name|fsm2initial
argument_list|(
operator|&
name|dl
operator|->
name|physical
operator|->
name|link
operator|.
name|ccp
operator|.
name|fsm
argument_list|)
expr_stmt|;
comment|/* fall through */
case|case
name|DATALINK_CBCP
case|:
case|case
name|DATALINK_AUTH
case|:
case|case
name|DATALINK_LCP
case|:
name|datalink_AuthReInit
argument_list|(
name|dl
argument_list|)
expr_stmt|;
name|fsm_Close
argument_list|(
operator|&
name|dl
operator|->
name|physical
operator|->
name|link
operator|.
name|lcp
operator|.
name|fsm
argument_list|)
expr_stmt|;
if|if
condition|(
name|how
operator|!=
name|CLOSE_NORMAL
condition|)
block|{
name|dl
operator|->
name|dial
operator|.
name|tries
operator|=
operator|-
literal|1
expr_stmt|;
name|dl
operator|->
name|reconnect_tries
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|how
operator|==
name|CLOSE_LCP
condition|)
name|dl
operator|->
name|stayonline
operator|=
literal|1
expr_stmt|;
block|}
break|break;
default|default:
name|datalink_ComeDown
argument_list|(
name|dl
argument_list|,
name|how
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|datalink_Down
parameter_list|(
name|struct
name|datalink
modifier|*
name|dl
parameter_list|,
name|int
name|how
parameter_list|)
block|{
comment|/* Carrier is lost */
switch|switch
condition|(
name|dl
operator|->
name|state
condition|)
block|{
case|case
name|DATALINK_OPEN
case|:
name|peerid_Init
argument_list|(
operator|&
name|dl
operator|->
name|peer
argument_list|)
expr_stmt|;
name|fsm2initial
argument_list|(
operator|&
name|dl
operator|->
name|physical
operator|->
name|link
operator|.
name|ccp
operator|.
name|fsm
argument_list|)
expr_stmt|;
comment|/* fall through */
case|case
name|DATALINK_CBCP
case|:
case|case
name|DATALINK_AUTH
case|:
case|case
name|DATALINK_LCP
case|:
name|fsm2initial
argument_list|(
operator|&
name|dl
operator|->
name|physical
operator|->
name|link
operator|.
name|lcp
operator|.
name|fsm
argument_list|)
expr_stmt|;
comment|/* fall through */
default|default:
name|datalink_ComeDown
argument_list|(
name|dl
argument_list|,
name|how
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|datalink_StayDown
parameter_list|(
name|struct
name|datalink
modifier|*
name|dl
parameter_list|)
block|{
name|dl
operator|->
name|reconnect_tries
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
name|void
name|datalink_DontHangup
parameter_list|(
name|struct
name|datalink
modifier|*
name|dl
parameter_list|)
block|{
if|if
condition|(
name|dl
operator|->
name|state
operator|>=
name|DATALINK_LCP
condition|)
name|dl
operator|->
name|stayonline
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_function
name|int
name|datalink_Show
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
block|{
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|"Name: %s\n"
argument_list|,
name|arg
operator|->
name|cx
operator|->
name|name
argument_list|)
expr_stmt|;
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|" State:              %s\n"
argument_list|,
name|datalink_State
argument_list|(
name|arg
operator|->
name|cx
argument_list|)
argument_list|)
expr_stmt|;
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|" Peer name:          "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|arg
operator|->
name|cx
operator|->
name|peer
operator|.
name|authname
condition|)
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|"%s\n"
argument_list|,
name|arg
operator|->
name|cx
operator|->
name|peer
operator|.
name|authname
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|arg
operator|->
name|cx
operator|->
name|state
operator|==
name|DATALINK_OPEN
condition|)
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|"None requested\n"
argument_list|)
expr_stmt|;
else|else
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|"N/A\n"
argument_list|)
expr_stmt|;
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|" Discriminator:      %s\n"
argument_list|,
name|mp_Enddisc
argument_list|(
name|arg
operator|->
name|cx
operator|->
name|peer
operator|.
name|enddisc
operator|.
name|class
argument_list|,
name|arg
operator|->
name|cx
operator|->
name|peer
operator|.
name|enddisc
operator|.
name|address
argument_list|,
name|arg
operator|->
name|cx
operator|->
name|peer
operator|.
name|enddisc
operator|.
name|len
argument_list|)
argument_list|)
expr_stmt|;
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|"\nDefaults:\n"
argument_list|)
expr_stmt|;
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|" Phone List:         %s\n"
argument_list|,
name|arg
operator|->
name|cx
operator|->
name|cfg
operator|.
name|phone
operator|.
name|list
argument_list|)
expr_stmt|;
if|if
condition|(
name|arg
operator|->
name|cx
operator|->
name|cfg
operator|.
name|dial
operator|.
name|max
condition|)
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|" Dial tries:         %d, delay "
argument_list|,
name|arg
operator|->
name|cx
operator|->
name|cfg
operator|.
name|dial
operator|.
name|max
argument_list|)
expr_stmt|;
else|else
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|" Dial tries:         infinite, delay "
argument_list|)
expr_stmt|;
if|if
condition|(
name|arg
operator|->
name|cx
operator|->
name|cfg
operator|.
name|dial
operator|.
name|next_timeout
operator|>=
literal|0
condition|)
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|"%ds/"
argument_list|,
name|arg
operator|->
name|cx
operator|->
name|cfg
operator|.
name|dial
operator|.
name|next_timeout
argument_list|)
expr_stmt|;
else|else
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|"random/"
argument_list|)
expr_stmt|;
if|if
condition|(
name|arg
operator|->
name|cx
operator|->
name|cfg
operator|.
name|dial
operator|.
name|timeout
operator|>=
literal|0
condition|)
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|"%ds\n"
argument_list|,
name|arg
operator|->
name|cx
operator|->
name|cfg
operator|.
name|dial
operator|.
name|timeout
argument_list|)
expr_stmt|;
else|else
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|"random\n"
argument_list|)
expr_stmt|;
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|" Reconnect tries:    %d, delay "
argument_list|,
name|arg
operator|->
name|cx
operator|->
name|cfg
operator|.
name|reconnect
operator|.
name|max
argument_list|)
expr_stmt|;
if|if
condition|(
name|arg
operator|->
name|cx
operator|->
name|cfg
operator|.
name|reconnect
operator|.
name|timeout
operator|>
literal|0
condition|)
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|"%ds\n"
argument_list|,
name|arg
operator|->
name|cx
operator|->
name|cfg
operator|.
name|reconnect
operator|.
name|timeout
argument_list|)
expr_stmt|;
else|else
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|"random\n"
argument_list|)
expr_stmt|;
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|" Callback %s "
argument_list|,
name|arg
operator|->
name|cx
operator|->
name|physical
operator|->
name|type
operator|==
name|PHYS_DIRECT
condition|?
literal|"accepted: "
else|:
literal|"requested:"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|arg
operator|->
name|cx
operator|->
name|cfg
operator|.
name|callback
operator|.
name|opmask
condition|)
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|"none\n"
argument_list|)
expr_stmt|;
else|else
block|{
name|int
name|comma
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|arg
operator|->
name|cx
operator|->
name|cfg
operator|.
name|callback
operator|.
name|opmask
operator|&
name|CALLBACK_BIT
argument_list|(
name|CALLBACK_NONE
argument_list|)
condition|)
block|{
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|"none"
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|arg
operator|->
name|cx
operator|->
name|cfg
operator|.
name|callback
operator|.
name|opmask
operator|&
name|CALLBACK_BIT
argument_list|(
name|CALLBACK_AUTH
argument_list|)
condition|)
block|{
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|"%sauth"
argument_list|,
name|comma
condition|?
literal|", "
else|:
literal|""
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|arg
operator|->
name|cx
operator|->
name|cfg
operator|.
name|callback
operator|.
name|opmask
operator|&
name|CALLBACK_BIT
argument_list|(
name|CALLBACK_E164
argument_list|)
condition|)
block|{
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|"%sE.164"
argument_list|,
name|comma
condition|?
literal|", "
else|:
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|arg
operator|->
name|cx
operator|->
name|physical
operator|->
name|type
operator|!=
name|PHYS_DIRECT
condition|)
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|" (%s)"
argument_list|,
name|arg
operator|->
name|cx
operator|->
name|cfg
operator|.
name|callback
operator|.
name|msg
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|arg
operator|->
name|cx
operator|->
name|cfg
operator|.
name|callback
operator|.
name|opmask
operator|&
name|CALLBACK_BIT
argument_list|(
name|CALLBACK_CBCP
argument_list|)
condition|)
block|{
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|"%scbcp\n"
argument_list|,
name|comma
condition|?
literal|", "
else|:
literal|""
argument_list|)
expr_stmt|;
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|" CBCP:               delay: %ds\n"
argument_list|,
name|arg
operator|->
name|cx
operator|->
name|cfg
operator|.
name|cbcp
operator|.
name|delay
argument_list|)
expr_stmt|;
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|"                     phone: "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|arg
operator|->
name|cx
operator|->
name|cfg
operator|.
name|cbcp
operator|.
name|phone
argument_list|,
literal|"*"
argument_list|)
condition|)
block|{
if|if
condition|(
name|arg
operator|->
name|cx
operator|->
name|physical
operator|->
name|type
operator|&
name|PHYS_DIRECT
condition|)
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|"Caller decides\n"
argument_list|)
expr_stmt|;
else|else
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|"Dialback server decides\n"
argument_list|)
expr_stmt|;
block|}
else|else
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|"%s\n"
argument_list|,
name|arg
operator|->
name|cx
operator|->
name|cfg
operator|.
name|cbcp
operator|.
name|phone
argument_list|)
expr_stmt|;
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|"                     timeout: %lds\n"
argument_list|,
name|arg
operator|->
name|cx
operator|->
name|cfg
operator|.
name|cbcp
operator|.
name|fsmretry
argument_list|)
expr_stmt|;
block|}
else|else
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|" Dial Script:        %s\n"
argument_list|,
name|arg
operator|->
name|cx
operator|->
name|cfg
operator|.
name|script
operator|.
name|dial
argument_list|)
expr_stmt|;
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|" Login Script:       %s\n"
argument_list|,
name|arg
operator|->
name|cx
operator|->
name|cfg
operator|.
name|script
operator|.
name|login
argument_list|)
expr_stmt|;
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|" Hangup Script:      %s\n"
argument_list|,
name|arg
operator|->
name|cx
operator|->
name|cfg
operator|.
name|script
operator|.
name|hangup
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|datalink_SetReconnect
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
block|{
if|if
condition|(
name|arg
operator|->
name|argc
operator|==
name|arg
operator|->
name|argn
operator|+
literal|2
condition|)
block|{
name|arg
operator|->
name|cx
operator|->
name|cfg
operator|.
name|reconnect
operator|.
name|timeout
operator|=
name|atoi
argument_list|(
name|arg
operator|->
name|argv
index|[
name|arg
operator|->
name|argn
index|]
argument_list|)
expr_stmt|;
name|arg
operator|->
name|cx
operator|->
name|cfg
operator|.
name|reconnect
operator|.
name|max
operator|=
name|atoi
argument_list|(
name|arg
operator|->
name|argv
index|[
name|arg
operator|->
name|argn
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|int
name|datalink_SetRedial
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|sep
decl_stmt|,
modifier|*
name|osep
decl_stmt|;
name|int
name|timeout
decl_stmt|,
name|inc
decl_stmt|,
name|maxinc
decl_stmt|,
name|tries
decl_stmt|;
if|if
condition|(
name|arg
operator|->
name|argc
operator|==
name|arg
operator|->
name|argn
operator|+
literal|1
operator|||
name|arg
operator|->
name|argc
operator|==
name|arg
operator|->
name|argn
operator|+
literal|2
condition|)
block|{
if|if
condition|(
name|strncasecmp
argument_list|(
name|arg
operator|->
name|argv
index|[
name|arg
operator|->
name|argn
index|]
argument_list|,
literal|"random"
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
operator|&&
operator|(
name|arg
operator|->
name|argv
index|[
name|arg
operator|->
name|argn
index|]
index|[
literal|6
index|]
operator|==
literal|'\0'
operator|||
name|arg
operator|->
name|argv
index|[
name|arg
operator|->
name|argn
index|]
index|[
literal|6
index|]
operator|==
literal|'.'
operator|)
condition|)
block|{
name|arg
operator|->
name|cx
operator|->
name|cfg
operator|.
name|dial
operator|.
name|timeout
operator|=
operator|-
literal|1
expr_stmt|;
name|randinit
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|timeout
operator|=
name|atoi
argument_list|(
name|arg
operator|->
name|argv
index|[
name|arg
operator|->
name|argn
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|timeout
operator|>=
literal|0
condition|)
name|arg
operator|->
name|cx
operator|->
name|cfg
operator|.
name|dial
operator|.
name|timeout
operator|=
name|timeout
expr_stmt|;
else|else
block|{
name|log_Printf
argument_list|(
name|LogWARN
argument_list|,
literal|"Invalid redial timeout\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
name|sep
operator|=
name|strchr
argument_list|(
name|arg
operator|->
name|argv
index|[
name|arg
operator|->
name|argn
index|]
argument_list|,
literal|'+'
argument_list|)
expr_stmt|;
if|if
condition|(
name|sep
condition|)
block|{
name|inc
operator|=
name|atoi
argument_list|(
operator|++
name|sep
argument_list|)
expr_stmt|;
name|osep
operator|=
name|sep
expr_stmt|;
if|if
condition|(
name|inc
operator|>=
literal|0
condition|)
name|arg
operator|->
name|cx
operator|->
name|cfg
operator|.
name|dial
operator|.
name|inc
operator|=
name|inc
expr_stmt|;
else|else
block|{
name|log_Printf
argument_list|(
name|LogWARN
argument_list|,
literal|"Invalid timeout increment\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|sep
operator|=
name|strchr
argument_list|(
name|sep
argument_list|,
literal|'-'
argument_list|)
expr_stmt|;
if|if
condition|(
name|sep
condition|)
block|{
name|maxinc
operator|=
name|atoi
argument_list|(
operator|++
name|sep
argument_list|)
expr_stmt|;
if|if
condition|(
name|maxinc
operator|>=
literal|0
condition|)
name|arg
operator|->
name|cx
operator|->
name|cfg
operator|.
name|dial
operator|.
name|maxinc
operator|=
name|maxinc
expr_stmt|;
else|else
block|{
name|log_Printf
argument_list|(
name|LogWARN
argument_list|,
literal|"Invalid maximum timeout increments\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
else|else
block|{
comment|/* Default timeout increment */
name|arg
operator|->
name|cx
operator|->
name|cfg
operator|.
name|dial
operator|.
name|maxinc
operator|=
literal|10
expr_stmt|;
name|sep
operator|=
name|osep
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* Default timeout increment& max increment */
name|arg
operator|->
name|cx
operator|->
name|cfg
operator|.
name|dial
operator|.
name|inc
operator|=
literal|0
expr_stmt|;
name|arg
operator|->
name|cx
operator|->
name|cfg
operator|.
name|dial
operator|.
name|maxinc
operator|=
literal|10
expr_stmt|;
name|sep
operator|=
name|arg
operator|->
name|argv
index|[
name|arg
operator|->
name|argn
index|]
expr_stmt|;
block|}
name|sep
operator|=
name|strchr
argument_list|(
name|sep
argument_list|,
literal|'.'
argument_list|)
expr_stmt|;
if|if
condition|(
name|sep
condition|)
block|{
if|if
condition|(
name|strcasecmp
argument_list|(
operator|++
name|sep
argument_list|,
literal|"random"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|arg
operator|->
name|cx
operator|->
name|cfg
operator|.
name|dial
operator|.
name|next_timeout
operator|=
operator|-
literal|1
expr_stmt|;
name|randinit
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|timeout
operator|=
name|atoi
argument_list|(
name|sep
argument_list|)
expr_stmt|;
if|if
condition|(
name|timeout
operator|>=
literal|0
condition|)
name|arg
operator|->
name|cx
operator|->
name|cfg
operator|.
name|dial
operator|.
name|next_timeout
operator|=
name|timeout
expr_stmt|;
else|else
block|{
name|log_Printf
argument_list|(
name|LogWARN
argument_list|,
literal|"Invalid next redial timeout\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
block|}
else|else
comment|/* Default next timeout */
name|arg
operator|->
name|cx
operator|->
name|cfg
operator|.
name|dial
operator|.
name|next_timeout
operator|=
name|DIAL_NEXT_TIMEOUT
expr_stmt|;
if|if
condition|(
name|arg
operator|->
name|argc
operator|==
name|arg
operator|->
name|argn
operator|+
literal|2
condition|)
block|{
name|tries
operator|=
name|atoi
argument_list|(
name|arg
operator|->
name|argv
index|[
name|arg
operator|->
name|argn
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|tries
operator|>=
literal|0
condition|)
block|{
name|arg
operator|->
name|cx
operator|->
name|cfg
operator|.
name|dial
operator|.
name|max
operator|=
name|tries
expr_stmt|;
block|}
else|else
block|{
name|log_Printf
argument_list|(
name|LogWARN
argument_list|,
literal|"Invalid retry value\n"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|states
index|[]
init|=
block|{
literal|"closed"
block|,
literal|"opening"
block|,
literal|"hangup"
block|,
literal|"dial"
block|,
literal|"login"
block|,
literal|"ready"
block|,
literal|"lcp"
block|,
literal|"auth"
block|,
literal|"cbcp"
block|,
literal|"open"
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|const
name|char
modifier|*
name|datalink_State
parameter_list|(
name|struct
name|datalink
modifier|*
name|dl
parameter_list|)
block|{
if|if
condition|(
name|dl
operator|->
name|state
operator|<
literal|0
operator|||
name|dl
operator|->
name|state
operator|>=
sizeof|sizeof
name|states
operator|/
sizeof|sizeof
name|states
index|[
literal|0
index|]
condition|)
return|return
literal|"unknown"
return|;
return|return
name|states
index|[
name|dl
operator|->
name|state
index|]
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|datalink_NewState
parameter_list|(
name|struct
name|datalink
modifier|*
name|dl
parameter_list|,
name|int
name|state
parameter_list|)
block|{
if|if
condition|(
name|state
operator|!=
name|dl
operator|->
name|state
condition|)
block|{
if|if
condition|(
name|state
operator|>=
literal|0
operator|&&
name|state
operator|<
sizeof|sizeof
name|states
operator|/
sizeof|sizeof
name|states
index|[
literal|0
index|]
condition|)
block|{
name|log_Printf
argument_list|(
name|LogPHASE
argument_list|,
literal|"%s: %s -> %s\n"
argument_list|,
name|dl
operator|->
name|name
argument_list|,
name|datalink_State
argument_list|(
name|dl
argument_list|)
argument_list|,
name|states
index|[
name|state
index|]
argument_list|)
expr_stmt|;
name|dl
operator|->
name|state
operator|=
name|state
expr_stmt|;
block|}
else|else
name|log_Printf
argument_list|(
name|LogERROR
argument_list|,
literal|"%s: Can't enter state %d !\n"
argument_list|,
name|dl
operator|->
name|name
argument_list|,
name|state
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|struct
name|datalink
modifier|*
name|iov2datalink
parameter_list|(
name|struct
name|bundle
modifier|*
name|bundle
parameter_list|,
name|struct
name|iovec
modifier|*
name|iov
parameter_list|,
name|int
modifier|*
name|niov
parameter_list|,
name|int
name|maxiov
parameter_list|,
name|int
name|fd
parameter_list|)
block|{
name|struct
name|datalink
modifier|*
name|dl
decl_stmt|,
modifier|*
name|cdl
decl_stmt|;
name|struct
name|fsm_retry
name|copy
decl_stmt|;
name|char
modifier|*
name|oname
decl_stmt|;
name|dl
operator|=
operator|(
expr|struct
name|datalink
operator|*
operator|)
name|iov
index|[
operator|(
operator|*
name|niov
operator|)
operator|++
index|]
operator|.
name|iov_base
expr_stmt|;
name|dl
operator|->
name|name
operator|=
name|iov
index|[
operator|*
name|niov
index|]
operator|.
name|iov_base
expr_stmt|;
if|if
condition|(
name|dl
operator|->
name|name
index|[
name|DATALINK_MAXNAME
operator|-
literal|1
index|]
condition|)
block|{
name|dl
operator|->
name|name
index|[
name|DATALINK_MAXNAME
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|dl
operator|->
name|name
argument_list|)
operator|==
name|DATALINK_MAXNAME
operator|-
literal|1
condition|)
name|log_Printf
argument_list|(
name|LogWARN
argument_list|,
literal|"Datalink name truncated to \"%s\"\n"
argument_list|,
name|dl
operator|->
name|name
argument_list|)
expr_stmt|;
block|}
comment|/* Make sure the name is unique ! */
name|oname
operator|=
name|NULL
expr_stmt|;
do|do
block|{
for|for
control|(
name|cdl
operator|=
name|bundle
operator|->
name|links
init|;
name|cdl
condition|;
name|cdl
operator|=
name|cdl
operator|->
name|next
control|)
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
name|dl
operator|->
name|name
argument_list|,
name|cdl
operator|->
name|name
argument_list|)
condition|)
block|{
if|if
condition|(
name|oname
condition|)
name|free
argument_list|(
name|datalink_NextName
argument_list|(
name|dl
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|oname
operator|=
name|datalink_NextName
argument_list|(
name|dl
argument_list|)
expr_stmt|;
break|break;
comment|/* Keep renaming 'till we have no conflicts */
block|}
block|}
do|while
condition|(
name|cdl
condition|)
do|;
if|if
condition|(
name|oname
condition|)
block|{
name|log_Printf
argument_list|(
name|LogPHASE
argument_list|,
literal|"Rename link %s to %s\n"
argument_list|,
name|oname
argument_list|,
name|dl
operator|->
name|name
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|oname
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|dl
operator|->
name|name
operator|=
name|strdup
argument_list|(
name|dl
operator|->
name|name
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|iov
index|[
operator|*
name|niov
index|]
operator|.
name|iov_base
argument_list|)
expr_stmt|;
block|}
operator|(
operator|*
name|niov
operator|)
operator|++
expr_stmt|;
name|dl
operator|->
name|desc
operator|.
name|type
operator|=
name|DATALINK_DESCRIPTOR
expr_stmt|;
name|dl
operator|->
name|desc
operator|.
name|UpdateSet
operator|=
name|datalink_UpdateSet
expr_stmt|;
name|dl
operator|->
name|desc
operator|.
name|IsSet
operator|=
name|datalink_IsSet
expr_stmt|;
name|dl
operator|->
name|desc
operator|.
name|Read
operator|=
name|datalink_Read
expr_stmt|;
name|dl
operator|->
name|desc
operator|.
name|Write
operator|=
name|datalink_Write
expr_stmt|;
name|mp_linkInit
argument_list|(
operator|&
name|dl
operator|->
name|mp
argument_list|)
expr_stmt|;
operator|*
name|dl
operator|->
name|phone
operator|.
name|list
operator|=
literal|'\0'
expr_stmt|;
name|dl
operator|->
name|phone
operator|.
name|next
operator|=
name|NULL
expr_stmt|;
name|dl
operator|->
name|phone
operator|.
name|alt
operator|=
name|NULL
expr_stmt|;
name|dl
operator|->
name|phone
operator|.
name|chosen
operator|=
literal|"N/A"
expr_stmt|;
name|dl
operator|->
name|bundle
operator|=
name|bundle
expr_stmt|;
name|dl
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
name|memset
argument_list|(
operator|&
name|dl
operator|->
name|dial
operator|.
name|timer
argument_list|,
literal|'\0'
argument_list|,
sizeof|sizeof
name|dl
operator|->
name|dial
operator|.
name|timer
argument_list|)
expr_stmt|;
name|dl
operator|->
name|dial
operator|.
name|tries
operator|=
literal|0
expr_stmt|;
name|dl
operator|->
name|reconnect_tries
operator|=
literal|0
expr_stmt|;
name|dl
operator|->
name|parent
operator|=
operator|&
name|bundle
operator|->
name|fsm
expr_stmt|;
name|dl
operator|->
name|fsmp
operator|.
name|LayerStart
operator|=
name|datalink_LayerStart
expr_stmt|;
name|dl
operator|->
name|fsmp
operator|.
name|LayerUp
operator|=
name|datalink_LayerUp
expr_stmt|;
name|dl
operator|->
name|fsmp
operator|.
name|LayerDown
operator|=
name|datalink_LayerDown
expr_stmt|;
name|dl
operator|->
name|fsmp
operator|.
name|LayerFinish
operator|=
name|datalink_LayerFinish
expr_stmt|;
name|dl
operator|->
name|fsmp
operator|.
name|object
operator|=
name|dl
expr_stmt|;
name|dl
operator|->
name|physical
operator|=
name|iov2physical
argument_list|(
name|dl
argument_list|,
name|iov
argument_list|,
name|niov
argument_list|,
name|maxiov
argument_list|,
name|fd
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dl
operator|->
name|physical
condition|)
block|{
name|free
argument_list|(
name|dl
operator|->
name|name
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|dl
argument_list|)
expr_stmt|;
name|dl
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|copy
operator|=
name|dl
operator|->
name|pap
operator|.
name|cfg
operator|.
name|fsm
expr_stmt|;
name|pap_Init
argument_list|(
operator|&
name|dl
operator|->
name|pap
argument_list|,
name|dl
operator|->
name|physical
argument_list|)
expr_stmt|;
name|dl
operator|->
name|pap
operator|.
name|cfg
operator|.
name|fsm
operator|=
name|copy
expr_stmt|;
name|copy
operator|=
name|dl
operator|->
name|chap
operator|.
name|auth
operator|.
name|cfg
operator|.
name|fsm
expr_stmt|;
name|chap_Init
argument_list|(
operator|&
name|dl
operator|->
name|chap
argument_list|,
name|dl
operator|->
name|physical
argument_list|)
expr_stmt|;
name|dl
operator|->
name|chap
operator|.
name|auth
operator|.
name|cfg
operator|.
name|fsm
operator|=
name|copy
expr_stmt|;
name|cbcp_Init
argument_list|(
operator|&
name|dl
operator|->
name|cbcp
argument_list|,
name|dl
operator|->
name|physical
argument_list|)
expr_stmt|;
name|chat_Init
argument_list|(
operator|&
name|dl
operator|->
name|chat
argument_list|,
name|dl
operator|->
name|physical
argument_list|,
name|NULL
argument_list|,
literal|1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|log_Printf
argument_list|(
name|LogPHASE
argument_list|,
literal|"%s: Transferred in %s state\n"
argument_list|,
name|dl
operator|->
name|name
argument_list|,
name|datalink_State
argument_list|(
name|dl
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|dl
return|;
block|}
end_function

begin_function
name|int
name|datalink2iov
parameter_list|(
name|struct
name|datalink
modifier|*
name|dl
parameter_list|,
name|struct
name|iovec
modifier|*
name|iov
parameter_list|,
name|int
modifier|*
name|niov
parameter_list|,
name|int
name|maxiov
parameter_list|,
name|pid_t
name|newpid
parameter_list|)
block|{
comment|/* If `dl' is NULL, we're allocating before a Fromiov() */
name|int
name|link_fd
decl_stmt|;
if|if
condition|(
name|dl
condition|)
block|{
name|timer_Stop
argument_list|(
operator|&
name|dl
operator|->
name|dial
operator|.
name|timer
argument_list|)
expr_stmt|;
comment|/* The following is purely for the sake of paranoia */
name|cbcp_Down
argument_list|(
operator|&
name|dl
operator|->
name|cbcp
argument_list|)
expr_stmt|;
name|timer_Stop
argument_list|(
operator|&
name|dl
operator|->
name|pap
operator|.
name|authtimer
argument_list|)
expr_stmt|;
name|timer_Stop
argument_list|(
operator|&
name|dl
operator|->
name|chap
operator|.
name|auth
operator|.
name|authtimer
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|niov
operator|>=
name|maxiov
operator|-
literal|1
condition|)
block|{
name|log_Printf
argument_list|(
name|LogERROR
argument_list|,
literal|"Toiov: No room for datalink !\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|dl
condition|)
block|{
name|free
argument_list|(
name|dl
operator|->
name|name
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|dl
argument_list|)
expr_stmt|;
block|}
return|return
operator|-
literal|1
return|;
block|}
name|iov
index|[
operator|*
name|niov
index|]
operator|.
name|iov_base
operator|=
name|dl
condition|?
name|dl
else|:
name|malloc
argument_list|(
sizeof|sizeof
expr|*
name|dl
argument_list|)
expr_stmt|;
name|iov
index|[
operator|(
operator|*
name|niov
operator|)
operator|++
index|]
operator|.
name|iov_len
operator|=
sizeof|sizeof
expr|*
name|dl
expr_stmt|;
name|iov
index|[
operator|*
name|niov
index|]
operator|.
name|iov_base
operator|=
name|dl
condition|?
name|realloc
argument_list|(
name|dl
operator|->
name|name
argument_list|,
name|DATALINK_MAXNAME
argument_list|)
else|:
name|malloc
argument_list|(
name|DATALINK_MAXNAME
argument_list|)
expr_stmt|;
name|iov
index|[
operator|(
operator|*
name|niov
operator|)
operator|++
index|]
operator|.
name|iov_len
operator|=
name|DATALINK_MAXNAME
expr_stmt|;
name|link_fd
operator|=
name|physical2iov
argument_list|(
name|dl
condition|?
name|dl
operator|->
name|physical
else|:
name|NULL
argument_list|,
name|iov
argument_list|,
name|niov
argument_list|,
name|maxiov
argument_list|,
name|newpid
argument_list|)
expr_stmt|;
if|if
condition|(
name|link_fd
operator|==
operator|-
literal|1
operator|&&
name|dl
condition|)
block|{
name|free
argument_list|(
name|dl
operator|->
name|name
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|dl
argument_list|)
expr_stmt|;
block|}
return|return
name|link_fd
return|;
block|}
end_function

begin_function
name|void
name|datalink_Rename
parameter_list|(
name|struct
name|datalink
modifier|*
name|dl
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
name|free
argument_list|(
name|dl
operator|->
name|name
argument_list|)
expr_stmt|;
name|dl
operator|->
name|physical
operator|->
name|link
operator|.
name|name
operator|=
name|dl
operator|->
name|name
operator|=
name|strdup
argument_list|(
name|name
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|char
modifier|*
name|datalink_NextName
parameter_list|(
name|struct
name|datalink
modifier|*
name|dl
parameter_list|)
block|{
name|int
name|f
decl_stmt|,
name|n
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|,
modifier|*
name|oname
decl_stmt|;
name|n
operator|=
name|strlen
argument_list|(
name|dl
operator|->
name|name
argument_list|)
expr_stmt|;
name|name
operator|=
operator|(
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|n
operator|+
literal|3
argument_list|)
expr_stmt|;
for|for
control|(
name|f
operator|=
name|n
operator|-
literal|1
init|;
name|f
operator|>=
literal|0
condition|;
name|f
operator|--
control|)
if|if
condition|(
operator|!
name|isdigit
argument_list|(
name|dl
operator|->
name|name
index|[
name|f
index|]
argument_list|)
condition|)
break|break;
name|n
operator|=
name|sprintf
argument_list|(
name|name
argument_list|,
literal|"%.*s-"
argument_list|,
name|dl
operator|->
name|name
index|[
name|f
index|]
operator|==
literal|'-'
condition|?
name|f
else|:
name|f
operator|+
literal|1
argument_list|,
name|dl
operator|->
name|name
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|name
operator|+
name|n
argument_list|,
literal|"%d"
argument_list|,
name|atoi
argument_list|(
name|dl
operator|->
name|name
operator|+
name|f
operator|+
literal|1
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|oname
operator|=
name|dl
operator|->
name|name
expr_stmt|;
name|dl
operator|->
name|name
operator|=
name|name
expr_stmt|;
comment|/* our physical link name isn't updated (it probably isn't created yet) */
return|return
name|oname
return|;
block|}
end_function

begin_function
name|int
name|datalink_SetMode
parameter_list|(
name|struct
name|datalink
modifier|*
name|dl
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
if|if
condition|(
operator|!
name|physical_SetMode
argument_list|(
name|dl
operator|->
name|physical
argument_list|,
name|mode
argument_list|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|dl
operator|->
name|physical
operator|->
name|type
operator|&
operator|(
name|PHYS_DIRECT
operator||
name|PHYS_DEDICATED
operator|)
condition|)
name|dl
operator|->
name|script
operator|.
name|run
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|dl
operator|->
name|physical
operator|->
name|type
operator|==
name|PHYS_DIRECT
condition|)
name|dl
operator|->
name|reconnect_tries
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|mode
operator|&
operator|(
name|PHYS_DDIAL
operator||
name|PHYS_BACKGROUND
operator|)
operator|&&
name|dl
operator|->
name|state
operator|<=
name|DATALINK_READY
condition|)
name|datalink_Up
argument_list|(
name|dl
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
name|int
name|datalink_GetDialTimeout
parameter_list|(
name|struct
name|datalink
modifier|*
name|dl
parameter_list|)
block|{
name|int
name|result
init|=
name|dl
operator|->
name|cfg
operator|.
name|dial
operator|.
name|timeout
operator|+
name|dl
operator|->
name|dial
operator|.
name|incs
operator|*
name|dl
operator|->
name|cfg
operator|.
name|dial
operator|.
name|inc
decl_stmt|;
if|if
condition|(
name|dl
operator|->
name|dial
operator|.
name|incs
operator|<
name|dl
operator|->
name|cfg
operator|.
name|dial
operator|.
name|maxinc
condition|)
name|dl
operator|->
name|dial
operator|.
name|incs
operator|++
expr_stmt|;
return|return
name|result
return|;
block|}
end_function

end_unit


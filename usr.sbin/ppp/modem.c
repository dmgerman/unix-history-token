begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  *		PPP Modem handling module  *  *	    Written by Toshiharu OHNO (tony-o@iij.ad.jp)  *  *   Copyright (C) 1993, Internet Initiative Japan, Inc. All rights reserverd.  *  * Redistribution and use in source and binary forms are permitted  * provided that the above copyright notice and this paragraph are  * duplicated in all such forms and that any documentation,  * advertising materials, and other materials related to such  * distribution and use acknowledge that the software was developed  * by the Internet Initiative Japan, Inc.  The name of the  * IIJ may not be used to endorse or promote products derived  * from this software without specific prior written permission.  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND WITHOUT ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED  * WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR A PARTICULAR PURPOSE.  *  * $Id: modem.c,v 1.101 1999/01/28 01:56:33 brian Exp $  *  *  TODO:  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<arpa/inet.h>
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_systm.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip.h>
end_include

begin_include
include|#
directive|include
file|<sys/un.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<paths.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<sys/tty.h>
end_include

begin_include
include|#
directive|include
file|<sys/uio.h>
end_include

begin_include
include|#
directive|include
file|<sys/wait.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|__OpenBSD__
end_ifdef

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<util.h>
end_include

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<libutil.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"defs.h"
end_include

begin_include
include|#
directive|include
file|"command.h"
end_include

begin_include
include|#
directive|include
file|"mbuf.h"
end_include

begin_include
include|#
directive|include
file|"log.h"
end_include

begin_include
include|#
directive|include
file|"id.h"
end_include

begin_include
include|#
directive|include
file|"timer.h"
end_include

begin_include
include|#
directive|include
file|"fsm.h"
end_include

begin_include
include|#
directive|include
file|"lqr.h"
end_include

begin_include
include|#
directive|include
file|"hdlc.h"
end_include

begin_include
include|#
directive|include
file|"lcp.h"
end_include

begin_include
include|#
directive|include
file|"modem.h"
end_include

begin_include
include|#
directive|include
file|"throughput.h"
end_include

begin_include
include|#
directive|include
file|"async.h"
end_include

begin_include
include|#
directive|include
file|"iplist.h"
end_include

begin_include
include|#
directive|include
file|"slcompress.h"
end_include

begin_include
include|#
directive|include
file|"ipcp.h"
end_include

begin_include
include|#
directive|include
file|"filter.h"
end_include

begin_include
include|#
directive|include
file|"descriptor.h"
end_include

begin_include
include|#
directive|include
file|"ccp.h"
end_include

begin_include
include|#
directive|include
file|"link.h"
end_include

begin_include
include|#
directive|include
file|"physical.h"
end_include

begin_include
include|#
directive|include
file|"mp.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|NORADIUS
end_ifndef

begin_include
include|#
directive|include
file|"radius.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"bundle.h"
end_include

begin_include
include|#
directive|include
file|"prompt.h"
end_include

begin_include
include|#
directive|include
file|"chat.h"
end_include

begin_include
include|#
directive|include
file|"auth.h"
end_include

begin_include
include|#
directive|include
file|"chap.h"
end_include

begin_include
include|#
directive|include
file|"cbcp.h"
end_include

begin_include
include|#
directive|include
file|"datalink.h"
end_include

begin_function_decl
specifier|static
name|int
name|modem_DescriptorWrite
parameter_list|(
name|struct
name|descriptor
modifier|*
parameter_list|,
name|struct
name|bundle
modifier|*
parameter_list|,
specifier|const
name|fd_set
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|modem_DescriptorRead
parameter_list|(
name|struct
name|descriptor
modifier|*
parameter_list|,
name|struct
name|bundle
modifier|*
parameter_list|,
specifier|const
name|fd_set
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|modem_UpdateSet
parameter_list|(
name|struct
name|descriptor
modifier|*
parameter_list|,
name|fd_set
modifier|*
parameter_list|,
name|fd_set
modifier|*
parameter_list|,
name|fd_set
modifier|*
parameter_list|,
name|int
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|struct
name|physical
modifier|*
name|modem_Create
parameter_list|(
name|struct
name|datalink
modifier|*
name|dl
parameter_list|,
name|int
name|type
parameter_list|)
block|{
name|struct
name|physical
modifier|*
name|p
decl_stmt|;
name|p
operator|=
operator|(
expr|struct
name|physical
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|physical
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p
condition|)
return|return
name|NULL
return|;
name|p
operator|->
name|link
operator|.
name|type
operator|=
name|PHYSICAL_LINK
expr_stmt|;
name|p
operator|->
name|link
operator|.
name|name
operator|=
name|dl
operator|->
name|name
expr_stmt|;
name|p
operator|->
name|link
operator|.
name|len
operator|=
sizeof|sizeof
expr|*
name|p
expr_stmt|;
name|throughput_init
argument_list|(
operator|&
name|p
operator|->
name|link
operator|.
name|throughput
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|p
operator|->
name|Timer
argument_list|,
literal|'\0'
argument_list|,
sizeof|sizeof
name|p
operator|->
name|Timer
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|p
operator|->
name|link
operator|.
name|Queue
argument_list|,
literal|'\0'
argument_list|,
sizeof|sizeof
name|p
operator|->
name|link
operator|.
name|Queue
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|p
operator|->
name|link
operator|.
name|proto_in
argument_list|,
literal|'\0'
argument_list|,
sizeof|sizeof
name|p
operator|->
name|link
operator|.
name|proto_in
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|p
operator|->
name|link
operator|.
name|proto_out
argument_list|,
literal|'\0'
argument_list|,
sizeof|sizeof
name|p
operator|->
name|link
operator|.
name|proto_out
argument_list|)
expr_stmt|;
name|p
operator|->
name|desc
operator|.
name|type
operator|=
name|PHYSICAL_DESCRIPTOR
expr_stmt|;
name|p
operator|->
name|desc
operator|.
name|UpdateSet
operator|=
name|modem_UpdateSet
expr_stmt|;
name|p
operator|->
name|desc
operator|.
name|IsSet
operator|=
name|physical_IsSet
expr_stmt|;
name|p
operator|->
name|desc
operator|.
name|Read
operator|=
name|modem_DescriptorRead
expr_stmt|;
name|p
operator|->
name|desc
operator|.
name|Write
operator|=
name|modem_DescriptorWrite
expr_stmt|;
name|p
operator|->
name|type
operator|=
name|type
expr_stmt|;
name|hdlc_Init
argument_list|(
operator|&
name|p
operator|->
name|hdlc
argument_list|,
operator|&
name|p
operator|->
name|link
operator|.
name|lcp
argument_list|)
expr_stmt|;
name|async_Init
argument_list|(
operator|&
name|p
operator|->
name|async
argument_list|)
expr_stmt|;
name|p
operator|->
name|fd
operator|=
operator|-
literal|1
expr_stmt|;
name|p
operator|->
name|mbits
operator|=
literal|0
expr_stmt|;
name|p
operator|->
name|isatty
operator|=
literal|0
expr_stmt|;
name|p
operator|->
name|out
operator|=
name|NULL
expr_stmt|;
name|p
operator|->
name|connect_count
operator|=
literal|0
expr_stmt|;
name|p
operator|->
name|dl
operator|=
name|dl
expr_stmt|;
operator|*
name|p
operator|->
name|name
operator|.
name|full
operator|=
literal|'\0'
expr_stmt|;
name|p
operator|->
name|name
operator|.
name|base
operator|=
name|p
operator|->
name|name
operator|.
name|full
expr_stmt|;
name|p
operator|->
name|Utmp
operator|=
literal|0
expr_stmt|;
name|p
operator|->
name|session_owner
operator|=
operator|(
name|pid_t
operator|)
operator|-
literal|1
expr_stmt|;
name|p
operator|->
name|cfg
operator|.
name|rts_cts
operator|=
name|MODEM_CTSRTS
expr_stmt|;
name|p
operator|->
name|cfg
operator|.
name|speed
operator|=
name|MODEM_SPEED
expr_stmt|;
name|p
operator|->
name|cfg
operator|.
name|parity
operator|=
name|CS8
expr_stmt|;
name|strncpy
argument_list|(
name|p
operator|->
name|cfg
operator|.
name|devlist
argument_list|,
name|MODEM_LIST
argument_list|,
sizeof|sizeof
name|p
operator|->
name|cfg
operator|.
name|devlist
operator|-
literal|1
argument_list|)
expr_stmt|;
name|p
operator|->
name|cfg
operator|.
name|devlist
index|[
sizeof|sizeof
name|p
operator|->
name|cfg
operator|.
name|devlist
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|p
operator|->
name|cfg
operator|.
name|cd
operator|.
name|required
operator|=
literal|0
expr_stmt|;
name|p
operator|->
name|cfg
operator|.
name|cd
operator|.
name|delay
operator|=
name|DEF_CDDELAY
expr_stmt|;
name|lcp_Init
argument_list|(
operator|&
name|p
operator|->
name|link
operator|.
name|lcp
argument_list|,
name|dl
operator|->
name|bundle
argument_list|,
operator|&
name|p
operator|->
name|link
argument_list|,
operator|&
name|dl
operator|->
name|fsmp
argument_list|)
expr_stmt|;
name|ccp_Init
argument_list|(
operator|&
name|p
operator|->
name|link
operator|.
name|ccp
argument_list|,
name|dl
operator|->
name|bundle
argument_list|,
operator|&
name|p
operator|->
name|link
argument_list|,
operator|&
name|dl
operator|->
name|fsmp
argument_list|)
expr_stmt|;
return|return
name|p
return|;
block|}
end_function

begin_comment
comment|/* XXX-ML this should probably change when we add support for other    types of devices */
end_comment

begin_define
define|#
directive|define
name|Online
parameter_list|(
name|modem
parameter_list|)
value|((modem)->mbits& TIOCM_CD)
end_define

begin_function_decl
specifier|static
name|void
name|modem_LogicalClose
parameter_list|(
name|struct
name|physical
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_struct
specifier|static
specifier|const
struct|struct
name|speeds
block|{
name|int
name|nspeed
decl_stmt|;
name|speed_t
name|speed
decl_stmt|;
block|}
name|speeds
index|[]
init|=
block|{
ifdef|#
directive|ifdef
name|B50
block|{
literal|50
block|,
name|B50
block|, }
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|B75
block|{
literal|75
block|,
name|B75
block|, }
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|B110
block|{
literal|110
block|,
name|B110
block|, }
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|B134
block|{
literal|134
block|,
name|B134
block|, }
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|B150
block|{
literal|150
block|,
name|B150
block|, }
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|B200
block|{
literal|200
block|,
name|B200
block|, }
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|B300
block|{
literal|300
block|,
name|B300
block|, }
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|B600
block|{
literal|600
block|,
name|B600
block|, }
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|B1200
block|{
literal|1200
block|,
name|B1200
block|, }
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|B1800
block|{
literal|1800
block|,
name|B1800
block|, }
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|B2400
block|{
literal|2400
block|,
name|B2400
block|, }
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|B4800
block|{
literal|4800
block|,
name|B4800
block|, }
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|B9600
block|{
literal|9600
block|,
name|B9600
block|, }
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|B19200
block|{
literal|19200
block|,
name|B19200
block|, }
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|B38400
block|{
literal|38400
block|,
name|B38400
block|, }
block|,
endif|#
directive|endif
ifndef|#
directive|ifndef
name|_POSIX_SOURCE
ifdef|#
directive|ifdef
name|B7200
block|{
literal|7200
block|,
name|B7200
block|, }
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|B14400
block|{
literal|14400
block|,
name|B14400
block|, }
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|B28800
block|{
literal|28800
block|,
name|B28800
block|, }
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|B57600
block|{
literal|57600
block|,
name|B57600
block|, }
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|B76800
block|{
literal|76800
block|,
name|B76800
block|, }
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|B115200
block|{
literal|115200
block|,
name|B115200
block|, }
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|B230400
block|{
literal|230400
block|,
name|B230400
block|, }
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|EXTA
block|{
literal|19200
block|,
name|EXTA
block|, }
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|EXTB
block|{
literal|38400
block|,
name|EXTB
block|, }
block|,
endif|#
directive|endif
endif|#
directive|endif
comment|/* _POSIX_SOURCE */
block|{
literal|0
block|,
literal|0
block|}
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|SpeedToInt
parameter_list|(
name|speed_t
name|speed
parameter_list|)
block|{
specifier|const
name|struct
name|speeds
modifier|*
name|sp
decl_stmt|;
for|for
control|(
name|sp
operator|=
name|speeds
init|;
name|sp
operator|->
name|nspeed
condition|;
name|sp
operator|++
control|)
block|{
if|if
condition|(
name|sp
operator|->
name|speed
operator|==
name|speed
condition|)
block|{
return|return
operator|(
name|sp
operator|->
name|nspeed
operator|)
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|speed_t
name|IntToSpeed
parameter_list|(
name|int
name|nspeed
parameter_list|)
block|{
specifier|const
name|struct
name|speeds
modifier|*
name|sp
decl_stmt|;
for|for
control|(
name|sp
operator|=
name|speeds
init|;
name|sp
operator|->
name|nspeed
condition|;
name|sp
operator|++
control|)
block|{
if|if
condition|(
name|sp
operator|->
name|nspeed
operator|==
name|nspeed
condition|)
block|{
return|return
operator|(
name|sp
operator|->
name|speed
operator|)
return|;
block|}
block|}
return|return
name|B0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|modem_SetDevice
parameter_list|(
name|struct
name|physical
modifier|*
name|physical
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
name|int
name|len
init|=
name|strlen
argument_list|(
name|_PATH_DEV
argument_list|)
decl_stmt|;
name|strncpy
argument_list|(
name|physical
operator|->
name|name
operator|.
name|full
argument_list|,
name|name
argument_list|,
sizeof|sizeof
name|physical
operator|->
name|name
operator|.
name|full
operator|-
literal|1
argument_list|)
expr_stmt|;
name|physical
operator|->
name|name
operator|.
name|full
index|[
sizeof|sizeof
name|physical
operator|->
name|name
operator|.
name|full
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|physical
operator|->
name|name
operator|.
name|base
operator|=
name|strncmp
argument_list|(
name|physical
operator|->
name|name
operator|.
name|full
argument_list|,
name|_PATH_DEV
argument_list|,
name|len
argument_list|)
condition|?
name|physical
operator|->
name|name
operator|.
name|full
else|:
name|physical
operator|->
name|name
operator|.
name|full
operator|+
name|len
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  *  modem_Timeout() watches DCD signal and notifies if it's status is changed.  *  */
end_comment

begin_function
specifier|static
name|void
name|modem_Timeout
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|physical
modifier|*
name|modem
init|=
name|data
decl_stmt|;
name|int
name|ombits
init|=
name|modem
operator|->
name|mbits
decl_stmt|;
name|int
name|change
decl_stmt|;
name|timer_Stop
argument_list|(
operator|&
name|modem
operator|->
name|Timer
argument_list|)
expr_stmt|;
name|modem
operator|->
name|Timer
operator|.
name|load
operator|=
name|SECTICKS
expr_stmt|;
comment|/* Once a second please */
name|timer_Start
argument_list|(
operator|&
name|modem
operator|->
name|Timer
argument_list|)
expr_stmt|;
if|if
condition|(
name|modem
operator|->
name|isatty
operator|||
name|physical_IsSync
argument_list|(
name|modem
argument_list|)
condition|)
block|{
name|ombits
operator|=
name|modem
operator|->
name|mbits
expr_stmt|;
if|if
condition|(
name|modem
operator|->
name|fd
operator|>=
literal|0
condition|)
block|{
if|if
condition|(
name|ioctl
argument_list|(
name|modem
operator|->
name|fd
argument_list|,
name|TIOCMGET
argument_list|,
operator|&
name|modem
operator|->
name|mbits
argument_list|)
operator|<
literal|0
condition|)
block|{
name|log_Printf
argument_list|(
name|LogPHASE
argument_list|,
literal|"%s: ioctl error (%s)!\n"
argument_list|,
name|modem
operator|->
name|link
operator|.
name|name
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|datalink_Down
argument_list|(
name|modem
operator|->
name|dl
argument_list|,
name|CLOSE_NORMAL
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
else|else
name|modem
operator|->
name|mbits
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ombits
operator|==
operator|-
literal|1
condition|)
block|{
comment|/* First time looking for carrier */
if|if
condition|(
name|Online
argument_list|(
name|modem
argument_list|)
condition|)
name|log_Printf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"%s: %s: CD detected\n"
argument_list|,
name|modem
operator|->
name|link
operator|.
name|name
argument_list|,
name|modem
operator|->
name|name
operator|.
name|full
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|modem
operator|->
name|cfg
operator|.
name|cd
operator|.
name|required
condition|)
block|{
name|log_Printf
argument_list|(
name|LogPHASE
argument_list|,
literal|"%s: %s: Required CD not detected\n"
argument_list|,
name|modem
operator|->
name|link
operator|.
name|name
argument_list|,
name|modem
operator|->
name|name
operator|.
name|full
argument_list|)
expr_stmt|;
name|datalink_Down
argument_list|(
name|modem
operator|->
name|dl
argument_list|,
name|CLOSE_NORMAL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|log_Printf
argument_list|(
name|LogPHASE
argument_list|,
literal|"%s: %s doesn't support CD\n"
argument_list|,
name|modem
operator|->
name|link
operator|.
name|name
argument_list|,
name|modem
operator|->
name|name
operator|.
name|full
argument_list|)
expr_stmt|;
name|timer_Stop
argument_list|(
operator|&
name|modem
operator|->
name|Timer
argument_list|)
expr_stmt|;
name|modem
operator|->
name|mbits
operator|=
name|TIOCM_CD
expr_stmt|;
block|}
block|}
else|else
block|{
name|change
operator|=
name|ombits
operator|^
name|modem
operator|->
name|mbits
expr_stmt|;
if|if
condition|(
name|change
operator|&
name|TIOCM_CD
condition|)
block|{
if|if
condition|(
name|modem
operator|->
name|mbits
operator|&
name|TIOCM_CD
condition|)
name|log_Printf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"%s: offline -> online\n"
argument_list|,
name|modem
operator|->
name|link
operator|.
name|name
argument_list|)
expr_stmt|;
else|else
block|{
name|log_Printf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"%s: online -> offline\n"
argument_list|,
name|modem
operator|->
name|link
operator|.
name|name
argument_list|)
expr_stmt|;
name|log_Printf
argument_list|(
name|LogPHASE
argument_list|,
literal|"%s: Carrier lost\n"
argument_list|,
name|modem
operator|->
name|link
operator|.
name|name
argument_list|)
expr_stmt|;
name|datalink_Down
argument_list|(
name|modem
operator|->
name|dl
argument_list|,
name|CLOSE_NORMAL
argument_list|)
expr_stmt|;
block|}
block|}
else|else
name|log_Printf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"%s: Still %sline\n"
argument_list|,
name|modem
operator|->
name|link
operator|.
name|name
argument_list|,
name|Online
argument_list|(
name|modem
argument_list|)
condition|?
literal|"on"
else|:
literal|"off"
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
operator|!
name|Online
argument_list|(
name|modem
argument_list|)
condition|)
block|{
comment|/* mbits was set to zero in modem_Open() */
name|modem
operator|->
name|mbits
operator|=
name|TIOCM_CD
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|modem_StartTimer
parameter_list|(
name|struct
name|bundle
modifier|*
name|bundle
parameter_list|,
name|struct
name|physical
modifier|*
name|modem
parameter_list|)
block|{
name|timer_Stop
argument_list|(
operator|&
name|modem
operator|->
name|Timer
argument_list|)
expr_stmt|;
name|modem
operator|->
name|Timer
operator|.
name|load
operator|=
name|SECTICKS
operator|*
name|modem
operator|->
name|cfg
operator|.
name|cd
operator|.
name|delay
expr_stmt|;
name|modem
operator|->
name|Timer
operator|.
name|func
operator|=
name|modem_Timeout
expr_stmt|;
name|modem
operator|->
name|Timer
operator|.
name|name
operator|=
literal|"modem CD"
expr_stmt|;
name|modem
operator|->
name|Timer
operator|.
name|arg
operator|=
name|modem
expr_stmt|;
name|log_Printf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"%s: Using modem_Timeout [%p]\n"
argument_list|,
name|modem
operator|->
name|link
operator|.
name|name
argument_list|,
name|modem_Timeout
argument_list|)
expr_stmt|;
name|modem
operator|->
name|mbits
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* So we know it's the first time */
name|timer_Start
argument_list|(
operator|&
name|modem
operator|->
name|Timer
argument_list|)
expr_stmt|;
block|}
end_function

begin_struct
specifier|static
specifier|const
struct|struct
name|parity
block|{
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
specifier|const
name|char
modifier|*
name|name1
decl_stmt|;
name|int
name|set
decl_stmt|;
block|}
name|validparity
index|[]
init|=
block|{
block|{
literal|"even"
block|,
literal|"P_EVEN"
block|,
name|CS7
operator||
name|PARENB
block|}
block|,
block|{
literal|"odd"
block|,
literal|"P_ODD"
block|,
name|CS7
operator||
name|PARENB
operator||
name|PARODD
block|}
block|,
block|{
literal|"none"
block|,
literal|"P_ZERO"
block|,
name|CS8
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|}
block|, }
struct|;
end_struct

begin_function
specifier|static
name|int
name|GetParityValue
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|)
block|{
specifier|const
name|struct
name|parity
modifier|*
name|pp
decl_stmt|;
for|for
control|(
name|pp
operator|=
name|validparity
init|;
name|pp
operator|->
name|name
condition|;
name|pp
operator|++
control|)
block|{
if|if
condition|(
name|strcasecmp
argument_list|(
name|pp
operator|->
name|name
argument_list|,
name|str
argument_list|)
operator|==
literal|0
operator|||
name|strcasecmp
argument_list|(
name|pp
operator|->
name|name1
argument_list|,
name|str
argument_list|)
operator|==
literal|0
condition|)
block|{
return|return
name|pp
operator|->
name|set
return|;
block|}
block|}
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_function

begin_function
name|int
name|modem_SetParity
parameter_list|(
name|struct
name|physical
modifier|*
name|modem
parameter_list|,
specifier|const
name|char
modifier|*
name|str
parameter_list|)
block|{
name|struct
name|termios
name|rstio
decl_stmt|;
name|int
name|val
decl_stmt|;
name|val
operator|=
name|GetParityValue
argument_list|(
name|str
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|>
literal|0
condition|)
block|{
name|modem
operator|->
name|cfg
operator|.
name|parity
operator|=
name|val
expr_stmt|;
name|tcgetattr
argument_list|(
name|modem
operator|->
name|fd
argument_list|,
operator|&
name|rstio
argument_list|)
expr_stmt|;
name|rstio
operator|.
name|c_cflag
operator|&=
operator|~
operator|(
name|CSIZE
operator||
name|PARODD
operator||
name|PARENB
operator|)
expr_stmt|;
name|rstio
operator|.
name|c_cflag
operator||=
name|val
expr_stmt|;
name|tcsetattr
argument_list|(
name|modem
operator|->
name|fd
argument_list|,
name|TCSADRAIN
argument_list|,
operator|&
name|rstio
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|log_Printf
argument_list|(
name|LogWARN
argument_list|,
literal|"%s: %s: Invalid parity\n"
argument_list|,
name|modem
operator|->
name|link
operator|.
name|name
argument_list|,
name|str
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|OpenConnection
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|char
modifier|*
name|host
parameter_list|,
name|char
modifier|*
name|port
parameter_list|)
block|{
name|struct
name|sockaddr_in
name|dest
decl_stmt|;
name|int
name|sock
decl_stmt|;
name|struct
name|hostent
modifier|*
name|hp
decl_stmt|;
name|struct
name|servent
modifier|*
name|sp
decl_stmt|;
name|dest
operator|.
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|dest
operator|.
name|sin_addr
operator|.
name|s_addr
operator|=
name|inet_addr
argument_list|(
name|host
argument_list|)
expr_stmt|;
if|if
condition|(
name|dest
operator|.
name|sin_addr
operator|.
name|s_addr
operator|==
name|INADDR_NONE
condition|)
block|{
name|hp
operator|=
name|gethostbyname
argument_list|(
name|host
argument_list|)
expr_stmt|;
if|if
condition|(
name|hp
condition|)
block|{
name|memcpy
argument_list|(
operator|&
name|dest
operator|.
name|sin_addr
operator|.
name|s_addr
argument_list|,
name|hp
operator|->
name|h_addr_list
index|[
literal|0
index|]
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|log_Printf
argument_list|(
name|LogWARN
argument_list|,
literal|"%s: %s: unknown host\n"
argument_list|,
name|name
argument_list|,
name|host
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
name|dest
operator|.
name|sin_port
operator|=
name|htons
argument_list|(
name|atoi
argument_list|(
name|port
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dest
operator|.
name|sin_port
operator|==
literal|0
condition|)
block|{
name|sp
operator|=
name|getservbyname
argument_list|(
name|port
argument_list|,
literal|"tcp"
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
condition|)
block|{
name|dest
operator|.
name|sin_port
operator|=
name|sp
operator|->
name|s_port
expr_stmt|;
block|}
else|else
block|{
name|log_Printf
argument_list|(
name|LogWARN
argument_list|,
literal|"%s: %s: unknown service\n"
argument_list|,
name|name
argument_list|,
name|port
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
name|log_Printf
argument_list|(
name|LogPHASE
argument_list|,
literal|"%s: Connecting to %s:%s\n"
argument_list|,
name|name
argument_list|,
name|host
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|sock
operator|=
name|socket
argument_list|(
name|PF_INET
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|sock
operator|<
literal|0
condition|)
block|{
return|return
operator|(
name|sock
operator|)
return|;
block|}
if|if
condition|(
name|connect
argument_list|(
name|sock
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|dest
argument_list|,
sizeof|sizeof
name|dest
argument_list|)
operator|<
literal|0
condition|)
block|{
name|log_Printf
argument_list|(
name|LogWARN
argument_list|,
literal|"%s: connect: %s\n"
argument_list|,
name|name
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|sock
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
name|sock
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|modem_lock
parameter_list|(
name|struct
name|physical
modifier|*
name|modem
parameter_list|,
name|int
name|tunno
parameter_list|)
block|{
name|int
name|res
decl_stmt|;
name|FILE
modifier|*
name|lockfile
decl_stmt|;
name|char
name|fn
index|[
name|MAXPATHLEN
index|]
decl_stmt|;
if|if
condition|(
operator|*
name|modem
operator|->
name|name
operator|.
name|full
operator|!=
literal|'/'
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|modem
operator|->
name|type
operator|!=
name|PHYS_DIRECT
operator|&&
operator|(
name|res
operator|=
name|ID0uu_lock
argument_list|(
name|modem
operator|->
name|name
operator|.
name|base
argument_list|)
operator|)
operator|!=
name|UU_LOCK_OK
condition|)
block|{
if|if
condition|(
name|res
operator|==
name|UU_LOCK_INUSE
condition|)
name|log_Printf
argument_list|(
name|LogPHASE
argument_list|,
literal|"%s: %s is in use\n"
argument_list|,
name|modem
operator|->
name|link
operator|.
name|name
argument_list|,
name|modem
operator|->
name|name
operator|.
name|full
argument_list|)
expr_stmt|;
else|else
name|log_Printf
argument_list|(
name|LogPHASE
argument_list|,
literal|"%s: %s is in use: uu_lock: %s\n"
argument_list|,
name|modem
operator|->
name|link
operator|.
name|name
argument_list|,
name|modem
operator|->
name|name
operator|.
name|full
argument_list|,
name|uu_lockerr
argument_list|(
name|res
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|snprintf
argument_list|(
name|fn
argument_list|,
sizeof|sizeof
name|fn
argument_list|,
literal|"%s%s.if"
argument_list|,
name|_PATH_VARRUN
argument_list|,
name|modem
operator|->
name|name
operator|.
name|base
argument_list|)
expr_stmt|;
name|lockfile
operator|=
name|ID0fopen
argument_list|(
name|fn
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
if|if
condition|(
name|lockfile
operator|!=
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|lockfile
argument_list|,
literal|"%s%d\n"
argument_list|,
name|TUN_NAME
argument_list|,
name|tunno
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|lockfile
argument_list|)
expr_stmt|;
block|}
ifndef|#
directive|ifndef
name|RELEASE_CRUNCH
else|else
name|log_Printf
argument_list|(
name|LogALERT
argument_list|,
literal|"%s: Can't create %s: %s\n"
argument_list|,
name|modem
operator|->
name|link
operator|.
name|name
argument_list|,
name|fn
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|modem_Unlock
parameter_list|(
name|struct
name|physical
modifier|*
name|modem
parameter_list|)
block|{
name|char
name|fn
index|[
name|MAXPATHLEN
index|]
decl_stmt|;
if|if
condition|(
operator|*
name|modem
operator|->
name|name
operator|.
name|full
operator|!=
literal|'/'
condition|)
return|return;
name|snprintf
argument_list|(
name|fn
argument_list|,
sizeof|sizeof
name|fn
argument_list|,
literal|"%s%s.if"
argument_list|,
name|_PATH_VARRUN
argument_list|,
name|modem
operator|->
name|name
operator|.
name|base
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|RELEASE_CRUNCH
if|if
condition|(
name|ID0unlink
argument_list|(
name|fn
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|log_Printf
argument_list|(
name|LogALERT
argument_list|,
literal|"%s: Can't remove %s: %s\n"
argument_list|,
name|modem
operator|->
name|link
operator|.
name|name
argument_list|,
name|fn
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
else|#
directive|else
name|ID0unlink
argument_list|(
name|fn
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|modem
operator|->
name|type
operator|!=
name|PHYS_DIRECT
operator|&&
name|ID0uu_unlock
argument_list|(
name|modem
operator|->
name|name
operator|.
name|base
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|log_Printf
argument_list|(
name|LogALERT
argument_list|,
literal|"%s: Can't uu_unlock %s\n"
argument_list|,
name|modem
operator|->
name|link
operator|.
name|name
argument_list|,
name|fn
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|modem_Found
parameter_list|(
name|struct
name|physical
modifier|*
name|modem
parameter_list|,
name|struct
name|bundle
modifier|*
name|bundle
parameter_list|)
block|{
name|throughput_start
argument_list|(
operator|&
name|modem
operator|->
name|link
operator|.
name|throughput
argument_list|,
literal|"modem throughput"
argument_list|,
name|Enabled
argument_list|(
name|bundle
argument_list|,
name|OPT_THROUGHPUT
argument_list|)
argument_list|)
expr_stmt|;
name|modem
operator|->
name|connect_count
operator|++
expr_stmt|;
name|log_Printf
argument_list|(
name|LogPHASE
argument_list|,
literal|"%s: Connected!\n"
argument_list|,
name|modem
operator|->
name|link
operator|.
name|name
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|modem_Open
parameter_list|(
name|struct
name|physical
modifier|*
name|modem
parameter_list|,
name|struct
name|bundle
modifier|*
name|bundle
parameter_list|)
block|{
name|struct
name|termios
name|rstio
decl_stmt|;
name|int
name|oldflag
decl_stmt|;
name|char
modifier|*
name|host
decl_stmt|,
modifier|*
name|port
decl_stmt|;
name|char
modifier|*
name|cp
decl_stmt|;
name|char
name|tmpDeviceList
index|[
sizeof|sizeof
name|modem
operator|->
name|cfg
operator|.
name|devlist
index|]
decl_stmt|;
name|char
modifier|*
name|tmpDevice
decl_stmt|;
if|if
condition|(
name|modem
operator|->
name|fd
operator|>=
literal|0
condition|)
name|log_Printf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"%s: Open: Modem is already open!\n"
argument_list|,
name|modem
operator|->
name|link
operator|.
name|name
argument_list|)
expr_stmt|;
comment|/* We're going back into "term" mode */
elseif|else
if|if
condition|(
name|modem
operator|->
name|type
operator|==
name|PHYS_DIRECT
condition|)
block|{
if|if
condition|(
name|isatty
argument_list|(
name|STDIN_FILENO
argument_list|)
condition|)
block|{
name|log_Printf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"%s: Open(direct): Modem is a tty\n"
argument_list|,
name|modem
operator|->
name|link
operator|.
name|name
argument_list|)
expr_stmt|;
name|modem_SetDevice
argument_list|(
name|modem
argument_list|,
name|ttyname
argument_list|(
name|STDIN_FILENO
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|modem_lock
argument_list|(
name|modem
argument_list|,
name|bundle
operator|->
name|unit
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|close
argument_list|(
name|STDIN_FILENO
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|modem
operator|->
name|fd
operator|=
name|STDIN_FILENO
expr_stmt|;
name|modem_Found
argument_list|(
name|modem
argument_list|,
name|bundle
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|log_Printf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"%s: Open(direct): Modem is not a tty\n"
argument_list|,
name|modem
operator|->
name|link
operator|.
name|name
argument_list|)
expr_stmt|;
name|modem_SetDevice
argument_list|(
name|modem
argument_list|,
literal|""
argument_list|)
expr_stmt|;
comment|/* We don't call modem_Timeout() with this type of connection */
name|modem_Found
argument_list|(
name|modem
argument_list|,
name|bundle
argument_list|)
expr_stmt|;
return|return
name|modem
operator|->
name|fd
operator|=
name|STDIN_FILENO
return|;
block|}
block|}
else|else
block|{
name|strncpy
argument_list|(
name|tmpDeviceList
argument_list|,
name|modem
operator|->
name|cfg
operator|.
name|devlist
argument_list|,
sizeof|sizeof
name|tmpDeviceList
operator|-
literal|1
argument_list|)
expr_stmt|;
name|tmpDeviceList
index|[
sizeof|sizeof
name|tmpDeviceList
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
for|for
control|(
name|tmpDevice
operator|=
name|strtok
argument_list|(
name|tmpDeviceList
argument_list|,
literal|", "
argument_list|)
init|;
name|tmpDevice
operator|&&
name|modem
operator|->
name|fd
operator|<
literal|0
condition|;
name|tmpDevice
operator|=
name|strtok
argument_list|(
name|NULL
argument_list|,
literal|", "
argument_list|)
control|)
block|{
name|modem_SetDevice
argument_list|(
name|modem
argument_list|,
name|tmpDevice
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|modem
operator|->
name|name
operator|.
name|full
operator|==
literal|'/'
condition|)
block|{
if|if
condition|(
name|modem_lock
argument_list|(
name|modem
argument_list|,
name|bundle
operator|->
name|unit
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
name|modem
operator|->
name|fd
operator|=
name|ID0open
argument_list|(
name|modem
operator|->
name|name
operator|.
name|full
argument_list|,
name|O_RDWR
operator||
name|O_NONBLOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|modem
operator|->
name|fd
operator|<
literal|0
condition|)
block|{
name|log_Printf
argument_list|(
name|LogPHASE
argument_list|,
literal|"%s: Open(\"%s\"): %s\n"
argument_list|,
name|modem
operator|->
name|link
operator|.
name|name
argument_list|,
name|modem
operator|->
name|name
operator|.
name|full
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|modem_Unlock
argument_list|(
name|modem
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|modem_Found
argument_list|(
name|modem
argument_list|,
name|bundle
argument_list|)
expr_stmt|;
name|log_Printf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"%s: Opened %s\n"
argument_list|,
name|modem
operator|->
name|link
operator|.
name|name
argument_list|,
name|modem
operator|->
name|name
operator|.
name|full
argument_list|)
expr_stmt|;
block|}
block|}
block|}
elseif|else
if|if
condition|(
operator|*
name|modem
operator|->
name|name
operator|.
name|full
operator|==
literal|'!'
condition|)
block|{
comment|/* PPP via an external program */
comment|/*          * XXX: Fix me - this should be another sort of link (similar to a          * physical          */
name|int
name|fids
index|[
literal|2
index|]
decl_stmt|;
name|modem
operator|->
name|name
operator|.
name|base
operator|=
name|modem
operator|->
name|name
operator|.
name|full
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|pipe
argument_list|(
name|fids
argument_list|)
operator|<
literal|0
condition|)
name|log_Printf
argument_list|(
name|LogPHASE
argument_list|,
literal|"Unable to create pipe for line exec: %s\n"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
else|else
block|{
name|int
name|stat
decl_stmt|;
name|pid_t
name|pid
decl_stmt|;
name|stat
operator|=
name|fcntl
argument_list|(
name|fids
index|[
literal|0
index|]
argument_list|,
name|F_GETFL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|stat
operator|>
literal|0
condition|)
block|{
name|stat
operator||=
name|O_NONBLOCK
expr_stmt|;
name|fcntl
argument_list|(
name|fids
index|[
literal|0
index|]
argument_list|,
name|F_SETFL
argument_list|,
name|stat
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
operator|(
name|pid
operator|=
name|fork
argument_list|()
operator|)
condition|)
block|{
case|case
operator|-
literal|1
case|:
name|log_Printf
argument_list|(
name|LogPHASE
argument_list|,
literal|"Unable to create pipe for line exec: %s\n"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0
case|:
name|close
argument_list|(
name|fids
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|timer_TermService
argument_list|()
expr_stmt|;
name|fids
index|[
literal|1
index|]
operator|=
name|fcntl
argument_list|(
name|fids
index|[
literal|1
index|]
argument_list|,
name|F_DUPFD
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|dup2
argument_list|(
name|fids
index|[
literal|1
index|]
argument_list|,
name|STDIN_FILENO
argument_list|)
expr_stmt|;
name|dup2
argument_list|(
name|fids
index|[
literal|1
index|]
argument_list|,
name|STDOUT_FILENO
argument_list|)
expr_stmt|;
name|dup2
argument_list|(
name|fids
index|[
literal|1
index|]
argument_list|,
name|STDERR_FILENO
argument_list|)
expr_stmt|;
name|setuid
argument_list|(
name|geteuid
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|fork
argument_list|()
condition|)
name|exit
argument_list|(
literal|127
argument_list|)
expr_stmt|;
name|execlp
argument_list|(
name|modem
operator|->
name|name
operator|.
name|base
argument_list|,
name|modem
operator|->
name|name
operator|.
name|base
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"execvp failed: %s: %s\n"
argument_list|,
name|modem
operator|->
name|name
operator|.
name|base
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|127
argument_list|)
expr_stmt|;
break|break;
default|default:
name|close
argument_list|(
name|fids
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|modem
operator|->
name|fd
operator|=
name|fids
index|[
literal|0
index|]
expr_stmt|;
name|waitpid
argument_list|(
name|pid
argument_list|,
operator|&
name|stat
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
else|else
block|{
comment|/* PPP over TCP */
comment|/*          * XXX: Fix me - this should be another sort of link (similar to a          * physical          */
name|cp
operator|=
name|strchr
argument_list|(
name|modem
operator|->
name|name
operator|.
name|full
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
name|cp
condition|)
block|{
operator|*
name|cp
operator|=
literal|'\0'
expr_stmt|;
name|host
operator|=
name|modem
operator|->
name|name
operator|.
name|full
expr_stmt|;
name|port
operator|=
name|cp
operator|+
literal|1
expr_stmt|;
if|if
condition|(
operator|*
name|host
operator|&&
operator|*
name|port
condition|)
block|{
name|modem
operator|->
name|fd
operator|=
name|OpenConnection
argument_list|(
name|modem
operator|->
name|link
operator|.
name|name
argument_list|,
name|host
argument_list|,
name|port
argument_list|)
expr_stmt|;
operator|*
name|cp
operator|=
literal|':'
expr_stmt|;
comment|/* Don't destroy name.full */
if|if
condition|(
name|modem
operator|->
name|fd
operator|>=
literal|0
condition|)
block|{
name|modem_Found
argument_list|(
name|modem
argument_list|,
name|bundle
argument_list|)
expr_stmt|;
name|log_Printf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"%s: Opened socket %s\n"
argument_list|,
name|modem
operator|->
name|link
operator|.
name|name
argument_list|,
name|modem
operator|->
name|name
operator|.
name|full
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
operator|*
name|cp
operator|=
literal|':'
expr_stmt|;
comment|/* Don't destroy name.full */
name|log_Printf
argument_list|(
name|LogWARN
argument_list|,
literal|"%s: Invalid host:port: \"%s\"\n"
argument_list|,
name|modem
operator|->
name|link
operator|.
name|name
argument_list|,
name|modem
operator|->
name|name
operator|.
name|full
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|log_Printf
argument_list|(
name|LogWARN
argument_list|,
literal|"%s: Device (%s) must begin with a '/',"
literal|" a '!' or be a host:port pair\n"
argument_list|,
name|modem
operator|->
name|link
operator|.
name|name
argument_list|,
name|modem
operator|->
name|name
operator|.
name|full
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|modem
operator|->
name|fd
operator|<
literal|0
condition|)
return|return
name|modem
operator|->
name|fd
return|;
block|}
comment|/*    * If we are working on tty device, change it's mode into the one desired    * for further operation.    */
name|modem
operator|->
name|mbits
operator|=
literal|0
expr_stmt|;
name|modem
operator|->
name|isatty
operator|=
name|isatty
argument_list|(
name|modem
operator|->
name|fd
argument_list|)
expr_stmt|;
if|if
condition|(
name|modem
operator|->
name|isatty
condition|)
block|{
name|tcgetattr
argument_list|(
name|modem
operator|->
name|fd
argument_list|,
operator|&
name|rstio
argument_list|)
expr_stmt|;
name|modem
operator|->
name|ios
operator|=
name|rstio
expr_stmt|;
name|log_Printf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"%s: Open: modem (get): fd = %d, iflag = %lx, "
literal|"oflag = %lx, cflag = %lx\n"
argument_list|,
name|modem
operator|->
name|link
operator|.
name|name
argument_list|,
name|modem
operator|->
name|fd
argument_list|,
operator|(
name|u_long
operator|)
name|rstio
operator|.
name|c_iflag
argument_list|,
operator|(
name|u_long
operator|)
name|rstio
operator|.
name|c_oflag
argument_list|,
operator|(
name|u_long
operator|)
name|rstio
operator|.
name|c_cflag
argument_list|)
expr_stmt|;
name|cfmakeraw
argument_list|(
operator|&
name|rstio
argument_list|)
expr_stmt|;
if|if
condition|(
name|modem
operator|->
name|cfg
operator|.
name|rts_cts
condition|)
name|rstio
operator|.
name|c_cflag
operator||=
name|CLOCAL
operator||
name|CCTS_OFLOW
operator||
name|CRTS_IFLOW
expr_stmt|;
else|else
block|{
name|rstio
operator|.
name|c_cflag
operator||=
name|CLOCAL
expr_stmt|;
name|rstio
operator|.
name|c_iflag
operator||=
name|IXOFF
expr_stmt|;
block|}
name|rstio
operator|.
name|c_iflag
operator||=
name|IXON
expr_stmt|;
if|if
condition|(
name|modem
operator|->
name|type
operator|!=
name|PHYS_DEDICATED
condition|)
name|rstio
operator|.
name|c_cflag
operator||=
name|HUPCL
expr_stmt|;
if|if
condition|(
name|modem
operator|->
name|type
operator|!=
name|PHYS_DIRECT
condition|)
block|{
comment|/* Change tty speed when we're not in -direct mode */
name|rstio
operator|.
name|c_cflag
operator|&=
operator|~
operator|(
name|CSIZE
operator||
name|PARODD
operator||
name|PARENB
operator|)
expr_stmt|;
name|rstio
operator|.
name|c_cflag
operator||=
name|modem
operator|->
name|cfg
operator|.
name|parity
expr_stmt|;
if|if
condition|(
name|cfsetspeed
argument_list|(
operator|&
name|rstio
argument_list|,
name|IntToSpeed
argument_list|(
name|modem
operator|->
name|cfg
operator|.
name|speed
argument_list|)
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|log_Printf
argument_list|(
name|LogWARN
argument_list|,
literal|"%s: %s: Unable to set speed to %d\n"
argument_list|,
name|modem
operator|->
name|link
operator|.
name|name
argument_list|,
name|modem
operator|->
name|name
operator|.
name|full
argument_list|,
name|modem
operator|->
name|cfg
operator|.
name|speed
argument_list|)
expr_stmt|;
block|}
name|tcsetattr
argument_list|(
name|modem
operator|->
name|fd
argument_list|,
name|TCSADRAIN
argument_list|,
operator|&
name|rstio
argument_list|)
expr_stmt|;
name|log_Printf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"%s: modem (put): iflag = %lx, oflag = %lx, "
literal|"cflag = %lx\n"
argument_list|,
name|modem
operator|->
name|link
operator|.
name|name
argument_list|,
operator|(
name|u_long
operator|)
name|rstio
operator|.
name|c_iflag
argument_list|,
operator|(
name|u_long
operator|)
name|rstio
operator|.
name|c_oflag
argument_list|,
operator|(
name|u_long
operator|)
name|rstio
operator|.
name|c_cflag
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|modem
operator|->
name|fd
argument_list|,
name|TIOCMGET
argument_list|,
operator|&
name|modem
operator|->
name|mbits
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|modem
operator|->
name|type
operator|!=
name|PHYS_DIRECT
condition|)
block|{
name|log_Printf
argument_list|(
name|LogWARN
argument_list|,
literal|"%s: Open: Cannot get modem status: %s\n"
argument_list|,
name|modem
operator|->
name|link
operator|.
name|name
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|modem_LogicalClose
argument_list|(
name|modem
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
else|else
name|modem
operator|->
name|mbits
operator|=
name|TIOCM_CD
expr_stmt|;
block|}
name|log_Printf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"%s: Open: modem control = %o\n"
argument_list|,
name|modem
operator|->
name|link
operator|.
name|name
argument_list|,
name|modem
operator|->
name|mbits
argument_list|)
expr_stmt|;
name|oldflag
operator|=
name|fcntl
argument_list|(
name|modem
operator|->
name|fd
argument_list|,
name|F_GETFL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|oldflag
operator|<
literal|0
condition|)
block|{
name|log_Printf
argument_list|(
name|LogWARN
argument_list|,
literal|"%s: Open: Cannot get modem flags: %s\n"
argument_list|,
name|modem
operator|->
name|link
operator|.
name|name
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|modem_LogicalClose
argument_list|(
name|modem
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|fcntl
argument_list|(
name|modem
operator|->
name|fd
argument_list|,
name|F_SETFL
argument_list|,
name|oldflag
operator|&
operator|~
name|O_NONBLOCK
argument_list|)
expr_stmt|;
block|}
return|return
name|modem
operator|->
name|fd
return|;
block|}
end_function

begin_function
name|int
name|modem_Speed
parameter_list|(
name|struct
name|physical
modifier|*
name|modem
parameter_list|)
block|{
name|struct
name|termios
name|rstio
decl_stmt|;
if|if
condition|(
operator|!
name|modem
operator|->
name|isatty
condition|)
return|return
literal|115200
return|;
name|tcgetattr
argument_list|(
name|modem
operator|->
name|fd
argument_list|,
operator|&
name|rstio
argument_list|)
expr_stmt|;
return|return
operator|(
name|SpeedToInt
argument_list|(
name|cfgetispeed
argument_list|(
operator|&
name|rstio
argument_list|)
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Put modem tty line into raw mode which is necessary in packet mode operation  */
end_comment

begin_function
name|int
name|modem_Raw
parameter_list|(
name|struct
name|physical
modifier|*
name|modem
parameter_list|,
name|struct
name|bundle
modifier|*
name|bundle
parameter_list|)
block|{
name|struct
name|termios
name|rstio
decl_stmt|;
name|int
name|oldflag
decl_stmt|;
name|log_Printf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"%s: Entering modem_Raw\n"
argument_list|,
name|modem
operator|->
name|link
operator|.
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|modem
operator|->
name|isatty
operator|||
name|physical_IsSync
argument_list|(
name|modem
argument_list|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|modem
operator|->
name|type
operator|!=
name|PHYS_DIRECT
operator|&&
name|modem
operator|->
name|fd
operator|>=
literal|0
operator|&&
operator|!
name|Online
argument_list|(
name|modem
argument_list|)
condition|)
name|log_Printf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"%s: Raw: modem = %d, mbits = %x\n"
argument_list|,
name|modem
operator|->
name|link
operator|.
name|name
argument_list|,
name|modem
operator|->
name|fd
argument_list|,
name|modem
operator|->
name|mbits
argument_list|)
expr_stmt|;
name|tcgetattr
argument_list|(
name|modem
operator|->
name|fd
argument_list|,
operator|&
name|rstio
argument_list|)
expr_stmt|;
name|cfmakeraw
argument_list|(
operator|&
name|rstio
argument_list|)
expr_stmt|;
if|if
condition|(
name|modem
operator|->
name|cfg
operator|.
name|rts_cts
condition|)
name|rstio
operator|.
name|c_cflag
operator||=
name|CLOCAL
operator||
name|CCTS_OFLOW
operator||
name|CRTS_IFLOW
expr_stmt|;
else|else
name|rstio
operator|.
name|c_cflag
operator||=
name|CLOCAL
expr_stmt|;
if|if
condition|(
name|modem
operator|->
name|type
operator|!=
name|PHYS_DEDICATED
condition|)
name|rstio
operator|.
name|c_cflag
operator||=
name|HUPCL
expr_stmt|;
name|tcsetattr
argument_list|(
name|modem
operator|->
name|fd
argument_list|,
name|TCSANOW
argument_list|,
operator|&
name|rstio
argument_list|)
expr_stmt|;
name|oldflag
operator|=
name|fcntl
argument_list|(
name|modem
operator|->
name|fd
argument_list|,
name|F_GETFL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|oldflag
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|fcntl
argument_list|(
name|modem
operator|->
name|fd
argument_list|,
name|F_SETFL
argument_list|,
name|oldflag
operator||
name|O_NONBLOCK
argument_list|)
expr_stmt|;
name|modem_StartTimer
argument_list|(
name|bundle
argument_list|,
name|modem
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|modem_Unraw
parameter_list|(
name|struct
name|physical
modifier|*
name|modem
parameter_list|)
block|{
name|int
name|oldflag
decl_stmt|;
if|if
condition|(
name|modem
operator|->
name|isatty
operator|&&
operator|!
name|physical_IsSync
argument_list|(
name|modem
argument_list|)
condition|)
block|{
name|tcsetattr
argument_list|(
name|modem
operator|->
name|fd
argument_list|,
name|TCSAFLUSH
argument_list|,
operator|&
name|modem
operator|->
name|ios
argument_list|)
expr_stmt|;
name|oldflag
operator|=
name|fcntl
argument_list|(
name|modem
operator|->
name|fd
argument_list|,
name|F_GETFL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|oldflag
operator|<
literal|0
condition|)
return|return;
operator|(
name|void
operator|)
name|fcntl
argument_list|(
name|modem
operator|->
name|fd
argument_list|,
name|F_SETFL
argument_list|,
name|oldflag
operator|&
operator|~
name|O_NONBLOCK
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|modem_PhysicalClose
parameter_list|(
name|struct
name|physical
modifier|*
name|modem
parameter_list|)
block|{
name|int
name|newsid
decl_stmt|;
name|log_Printf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"%s: Physical Close\n"
argument_list|,
name|modem
operator|->
name|link
operator|.
name|name
argument_list|)
expr_stmt|;
name|timer_Stop
argument_list|(
operator|&
name|modem
operator|->
name|Timer
argument_list|)
expr_stmt|;
name|newsid
operator|=
name|tcgetpgrp
argument_list|(
name|modem
operator|->
name|fd
argument_list|)
operator|==
name|getpgrp
argument_list|()
expr_stmt|;
name|close
argument_list|(
name|modem
operator|->
name|fd
argument_list|)
expr_stmt|;
name|modem
operator|->
name|fd
operator|=
operator|-
literal|1
expr_stmt|;
name|log_SetTtyCommandMode
argument_list|(
name|modem
operator|->
name|dl
argument_list|)
expr_stmt|;
name|throughput_stop
argument_list|(
operator|&
name|modem
operator|->
name|link
operator|.
name|throughput
argument_list|)
expr_stmt|;
name|throughput_log
argument_list|(
operator|&
name|modem
operator|->
name|link
operator|.
name|throughput
argument_list|,
name|LogPHASE
argument_list|,
name|modem
operator|->
name|link
operator|.
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|modem
operator|->
name|session_owner
operator|!=
operator|(
name|pid_t
operator|)
operator|-
literal|1
condition|)
block|{
name|ID0kill
argument_list|(
name|modem
operator|->
name|session_owner
argument_list|,
name|SIGHUP
argument_list|)
expr_stmt|;
name|modem
operator|->
name|session_owner
operator|=
operator|(
name|pid_t
operator|)
operator|-
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|newsid
condition|)
name|bundle_setsid
argument_list|(
name|modem
operator|->
name|dl
operator|->
name|bundle
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|modem_Offline
parameter_list|(
name|struct
name|physical
modifier|*
name|modem
parameter_list|)
block|{
if|if
condition|(
name|modem
operator|->
name|fd
operator|>=
literal|0
condition|)
block|{
name|struct
name|termios
name|tio
decl_stmt|;
name|timer_Stop
argument_list|(
operator|&
name|modem
operator|->
name|Timer
argument_list|)
expr_stmt|;
name|modem
operator|->
name|mbits
operator|&=
operator|~
name|TIOCM_DTR
expr_stmt|;
if|if
condition|(
name|modem
operator|->
name|isatty
operator|&&
name|Online
argument_list|(
name|modem
argument_list|)
condition|)
block|{
name|tcgetattr
argument_list|(
name|modem
operator|->
name|fd
argument_list|,
operator|&
name|tio
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfsetspeed
argument_list|(
operator|&
name|tio
argument_list|,
name|B0
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|log_Printf
argument_list|(
name|LogWARN
argument_list|,
literal|"%s: Unable to set modem to speed 0\n"
argument_list|,
name|modem
operator|->
name|link
operator|.
name|name
argument_list|)
expr_stmt|;
else|else
name|tcsetattr
argument_list|(
name|modem
operator|->
name|fd
argument_list|,
name|TCSANOW
argument_list|,
operator|&
name|tio
argument_list|)
expr_stmt|;
comment|/* nointr_sleep(1); */
block|}
name|log_Printf
argument_list|(
name|LogPHASE
argument_list|,
literal|"%s: Disconnected!\n"
argument_list|,
name|modem
operator|->
name|link
operator|.
name|name
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|modem_Close
parameter_list|(
name|struct
name|physical
modifier|*
name|modem
parameter_list|)
block|{
if|if
condition|(
name|modem
operator|->
name|fd
operator|<
literal|0
condition|)
return|return;
name|log_Printf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"%s: Close\n"
argument_list|,
name|modem
operator|->
name|link
operator|.
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|modem
operator|->
name|isatty
condition|)
block|{
name|modem_PhysicalClose
argument_list|(
name|modem
argument_list|)
expr_stmt|;
operator|*
name|modem
operator|->
name|name
operator|.
name|full
operator|=
literal|'\0'
expr_stmt|;
name|modem
operator|->
name|name
operator|.
name|base
operator|=
name|modem
operator|->
name|name
operator|.
name|full
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|modem
operator|->
name|fd
operator|>=
literal|0
condition|)
block|{
name|tcflush
argument_list|(
name|modem
operator|->
name|fd
argument_list|,
name|TCIOFLUSH
argument_list|)
expr_stmt|;
name|modem_Unraw
argument_list|(
name|modem
argument_list|)
expr_stmt|;
name|modem_LogicalClose
argument_list|(
name|modem
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|modem_Destroy
parameter_list|(
name|struct
name|physical
modifier|*
name|modem
parameter_list|)
block|{
name|modem_Close
argument_list|(
name|modem
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|modem
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|modem_LogicalClose
parameter_list|(
name|struct
name|physical
modifier|*
name|modem
parameter_list|)
block|{
name|log_Printf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"%s: Logical Close\n"
argument_list|,
name|modem
operator|->
name|link
operator|.
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|modem
operator|->
name|fd
operator|>=
literal|0
condition|)
block|{
name|physical_Logout
argument_list|(
name|modem
argument_list|)
expr_stmt|;
name|modem_PhysicalClose
argument_list|(
name|modem
argument_list|)
expr_stmt|;
name|modem_Unlock
argument_list|(
name|modem
argument_list|)
expr_stmt|;
block|}
operator|*
name|modem
operator|->
name|name
operator|.
name|full
operator|=
literal|'\0'
expr_stmt|;
name|modem
operator|->
name|name
operator|.
name|base
operator|=
name|modem
operator|->
name|name
operator|.
name|full
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|modem_DescriptorWrite
parameter_list|(
name|struct
name|descriptor
modifier|*
name|d
parameter_list|,
name|struct
name|bundle
modifier|*
name|bundle
parameter_list|,
specifier|const
name|fd_set
modifier|*
name|fdset
parameter_list|)
block|{
name|struct
name|physical
modifier|*
name|modem
init|=
name|descriptor2physical
argument_list|(
name|d
argument_list|)
decl_stmt|;
name|int
name|nb
decl_stmt|,
name|nw
decl_stmt|,
name|result
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|modem
operator|->
name|out
operator|==
name|NULL
condition|)
name|modem
operator|->
name|out
operator|=
name|link_Dequeue
argument_list|(
operator|&
name|modem
operator|->
name|link
argument_list|)
expr_stmt|;
if|if
condition|(
name|modem
operator|->
name|out
condition|)
block|{
name|nb
operator|=
name|modem
operator|->
name|out
operator|->
name|cnt
expr_stmt|;
name|nw
operator|=
name|physical_Write
argument_list|(
name|modem
argument_list|,
name|MBUF_CTOP
argument_list|(
name|modem
operator|->
name|out
argument_list|)
argument_list|,
name|nb
argument_list|)
expr_stmt|;
name|log_Printf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"%s: DescriptorWrite: wrote %d(%d) to %d\n"
argument_list|,
name|modem
operator|->
name|link
operator|.
name|name
argument_list|,
name|nw
argument_list|,
name|nb
argument_list|,
name|modem
operator|->
name|fd
argument_list|)
expr_stmt|;
if|if
condition|(
name|nw
operator|>
literal|0
condition|)
block|{
name|modem
operator|->
name|out
operator|->
name|cnt
operator|-=
name|nw
expr_stmt|;
name|modem
operator|->
name|out
operator|->
name|offset
operator|+=
name|nw
expr_stmt|;
if|if
condition|(
name|modem
operator|->
name|out
operator|->
name|cnt
operator|==
literal|0
condition|)
name|modem
operator|->
name|out
operator|=
name|mbuf_FreeSeg
argument_list|(
name|modem
operator|->
name|out
argument_list|)
expr_stmt|;
name|result
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|nw
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|errno
operator|!=
name|EAGAIN
condition|)
block|{
name|log_Printf
argument_list|(
name|LogPHASE
argument_list|,
literal|"%s: write (%d): %s\n"
argument_list|,
name|modem
operator|->
name|link
operator|.
name|name
argument_list|,
name|modem
operator|->
name|fd
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|datalink_Down
argument_list|(
name|modem
operator|->
name|dl
argument_list|,
name|CLOSE_NORMAL
argument_list|)
expr_stmt|;
block|}
name|result
operator|=
literal|1
expr_stmt|;
block|}
comment|/* else we shouldn't really have been called !  select() is broken ! */
block|}
return|return
name|result
return|;
block|}
end_function

begin_function
name|int
name|modem_ShowStatus
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|physical
modifier|*
name|modem
init|=
name|arg
operator|->
name|cx
operator|->
name|physical
decl_stmt|;
ifdef|#
directive|ifdef
name|TIOCOUTQ
name|int
name|nb
decl_stmt|;
endif|#
directive|endif
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|"Name: %s\n"
argument_list|,
name|modem
operator|->
name|link
operator|.
name|name
argument_list|)
expr_stmt|;
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|" State:           "
argument_list|)
expr_stmt|;
if|if
condition|(
name|modem
operator|->
name|fd
operator|>=
literal|0
condition|)
block|{
if|if
condition|(
name|modem
operator|->
name|isatty
condition|)
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|"open, %s carrier\n"
argument_list|,
name|Online
argument_list|(
name|modem
argument_list|)
condition|?
literal|"with"
else|:
literal|"no"
argument_list|)
expr_stmt|;
else|else
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|"open\n"
argument_list|)
expr_stmt|;
block|}
else|else
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|"closed\n"
argument_list|)
expr_stmt|;
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|" Device:          %s"
argument_list|,
operator|*
name|modem
operator|->
name|name
operator|.
name|full
condition|?
name|modem
operator|->
name|name
operator|.
name|full
else|:
name|modem
operator|->
name|type
operator|==
name|PHYS_DIRECT
condition|?
literal|"unknown"
else|:
literal|"N/A"
argument_list|)
expr_stmt|;
if|if
condition|(
name|modem
operator|->
name|session_owner
operator|!=
operator|(
name|pid_t
operator|)
operator|-
literal|1
condition|)
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|" (session owner: %d)"
argument_list|,
operator|(
name|int
operator|)
name|modem
operator|->
name|session_owner
argument_list|)
expr_stmt|;
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|"\n Link Type:       %s\n"
argument_list|,
name|mode2Nam
argument_list|(
name|modem
operator|->
name|type
argument_list|)
argument_list|)
expr_stmt|;
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|" Connect Count:   %d\n"
argument_list|,
name|modem
operator|->
name|connect_count
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|TIOCOUTQ
if|if
condition|(
name|modem
operator|->
name|fd
operator|>=
literal|0
operator|&&
name|ioctl
argument_list|(
name|modem
operator|->
name|fd
argument_list|,
name|TIOCOUTQ
argument_list|,
operator|&
name|nb
argument_list|)
operator|>=
literal|0
condition|)
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|" Physical outq:   %d\n"
argument_list|,
name|nb
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|" Queued Packets:  %d\n"
argument_list|,
name|link_QueueLen
argument_list|(
operator|&
name|modem
operator|->
name|link
argument_list|)
argument_list|)
expr_stmt|;
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|" Phone Number:    %s\n"
argument_list|,
name|arg
operator|->
name|cx
operator|->
name|phone
operator|.
name|chosen
argument_list|)
expr_stmt|;
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|"\nDefaults:\n"
argument_list|)
expr_stmt|;
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|" Device List:     %s\n"
argument_list|,
name|modem
operator|->
name|cfg
operator|.
name|devlist
argument_list|)
expr_stmt|;
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|" Characteristics: "
argument_list|)
expr_stmt|;
if|if
condition|(
name|physical_IsSync
argument_list|(
name|arg
operator|->
name|cx
operator|->
name|physical
argument_list|)
condition|)
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|"sync"
argument_list|)
expr_stmt|;
else|else
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|"%dbps"
argument_list|,
name|modem
operator|->
name|cfg
operator|.
name|speed
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|modem
operator|->
name|cfg
operator|.
name|parity
operator|&
name|CSIZE
condition|)
block|{
case|case
name|CS7
case|:
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|", cs7"
argument_list|)
expr_stmt|;
break|break;
case|case
name|CS8
case|:
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|", cs8"
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|modem
operator|->
name|cfg
operator|.
name|parity
operator|&
name|PARENB
condition|)
block|{
if|if
condition|(
name|modem
operator|->
name|cfg
operator|.
name|parity
operator|&
name|PARODD
condition|)
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|", odd parity"
argument_list|)
expr_stmt|;
else|else
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|", even parity"
argument_list|)
expr_stmt|;
block|}
else|else
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|", no parity"
argument_list|)
expr_stmt|;
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|", CTS/RTS %s\n"
argument_list|,
operator|(
name|modem
operator|->
name|cfg
operator|.
name|rts_cts
condition|?
literal|"on"
else|:
literal|"off"
operator|)
argument_list|)
expr_stmt|;
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|" CD check delay:  %d second%s"
argument_list|,
name|modem
operator|->
name|cfg
operator|.
name|cd
operator|.
name|delay
argument_list|,
name|modem
operator|->
name|cfg
operator|.
name|cd
operator|.
name|delay
operator|==
literal|1
condition|?
literal|""
else|:
literal|"s"
argument_list|)
expr_stmt|;
if|if
condition|(
name|modem
operator|->
name|cfg
operator|.
name|cd
operator|.
name|required
condition|)
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|" (required!)\n\n"
argument_list|)
expr_stmt|;
else|else
name|prompt_Printf
argument_list|(
name|arg
operator|->
name|prompt
argument_list|,
literal|"\n\n"
argument_list|)
expr_stmt|;
name|throughput_disp
argument_list|(
operator|&
name|modem
operator|->
name|link
operator|.
name|throughput
argument_list|,
name|arg
operator|->
name|prompt
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|modem_DescriptorRead
parameter_list|(
name|struct
name|descriptor
modifier|*
name|d
parameter_list|,
name|struct
name|bundle
modifier|*
name|bundle
parameter_list|,
specifier|const
name|fd_set
modifier|*
name|fdset
parameter_list|)
block|{
name|struct
name|physical
modifier|*
name|p
init|=
name|descriptor2physical
argument_list|(
name|d
argument_list|)
decl_stmt|;
name|u_char
name|rbuff
index|[
name|MAX_MRU
index|]
decl_stmt|,
modifier|*
name|cp
decl_stmt|;
name|int
name|n
decl_stmt|;
comment|/* something to read from modem */
name|n
operator|=
name|physical_Read
argument_list|(
name|p
argument_list|,
name|rbuff
argument_list|,
sizeof|sizeof
name|rbuff
argument_list|)
expr_stmt|;
name|log_Printf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"%s: DescriptorRead: read %d from %d\n"
argument_list|,
name|p
operator|->
name|link
operator|.
name|name
argument_list|,
name|n
argument_list|,
name|p
operator|->
name|fd
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|<=
literal|0
condition|)
block|{
if|if
condition|(
name|n
operator|<
literal|0
condition|)
name|log_Printf
argument_list|(
name|LogPHASE
argument_list|,
literal|"%s: read (%d): %s\n"
argument_list|,
name|p
operator|->
name|link
operator|.
name|name
argument_list|,
name|p
operator|->
name|fd
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|log_Printf
argument_list|(
name|LogPHASE
argument_list|,
literal|"%s: read (%d): Got zero bytes\n"
argument_list|,
name|p
operator|->
name|link
operator|.
name|name
argument_list|,
name|p
operator|->
name|fd
argument_list|)
expr_stmt|;
name|datalink_Down
argument_list|(
name|p
operator|->
name|dl
argument_list|,
name|CLOSE_NORMAL
argument_list|)
expr_stmt|;
return|return;
block|}
name|log_DumpBuff
argument_list|(
name|LogASYNC
argument_list|,
literal|"ReadFromModem"
argument_list|,
name|rbuff
argument_list|,
name|n
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|link
operator|.
name|lcp
operator|.
name|fsm
operator|.
name|state
operator|<=
name|ST_CLOSED
condition|)
block|{
comment|/* In -dedicated mode, we just discard input until LCP is started */
if|if
condition|(
name|p
operator|->
name|type
operator|!=
name|PHYS_DEDICATED
condition|)
block|{
name|cp
operator|=
name|hdlc_Detect
argument_list|(
name|p
argument_list|,
name|rbuff
argument_list|,
name|n
argument_list|)
expr_stmt|;
if|if
condition|(
name|cp
condition|)
block|{
comment|/* LCP packet is detected. Turn ourselves into packet mode */
if|if
condition|(
name|cp
operator|!=
name|rbuff
condition|)
comment|/* Get rid of the bit before the HDLC header */
name|log_WritePrompts
argument_list|(
name|p
operator|->
name|dl
argument_list|,
literal|"%.*s\r\n"
argument_list|,
call|(
name|int
call|)
argument_list|(
name|cp
operator|-
name|rbuff
argument_list|)
argument_list|,
name|rbuff
argument_list|)
expr_stmt|;
name|log_Printf
argument_list|(
name|LogPHASE
argument_list|,
literal|"%s: PPP packet detected, coming up\n"
argument_list|,
name|p
operator|->
name|link
operator|.
name|name
argument_list|)
expr_stmt|;
name|datalink_Up
argument_list|(
name|p
operator|->
name|dl
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
name|log_WritePrompts
argument_list|(
name|p
operator|->
name|dl
argument_list|,
literal|"%.*s"
argument_list|,
name|n
argument_list|,
name|rbuff
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|n
operator|>
literal|0
condition|)
name|async_Input
argument_list|(
name|bundle
argument_list|,
name|rbuff
argument_list|,
name|n
argument_list|,
name|p
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|modem_UpdateSet
parameter_list|(
name|struct
name|descriptor
modifier|*
name|d
parameter_list|,
name|fd_set
modifier|*
name|r
parameter_list|,
name|fd_set
modifier|*
name|w
parameter_list|,
name|fd_set
modifier|*
name|e
parameter_list|,
name|int
modifier|*
name|n
parameter_list|)
block|{
return|return
name|physical_UpdateSet
argument_list|(
name|d
argument_list|,
name|r
argument_list|,
name|w
argument_list|,
name|e
argument_list|,
name|n
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
name|struct
name|physical
modifier|*
name|iov2modem
parameter_list|(
name|struct
name|datalink
modifier|*
name|dl
parameter_list|,
name|struct
name|iovec
modifier|*
name|iov
parameter_list|,
name|int
modifier|*
name|niov
parameter_list|,
name|int
name|maxiov
parameter_list|,
name|int
name|fd
parameter_list|)
block|{
name|struct
name|physical
modifier|*
name|p
decl_stmt|;
name|int
name|len
decl_stmt|;
name|p
operator|=
operator|(
expr|struct
name|physical
operator|*
operator|)
name|iov
index|[
operator|(
operator|*
name|niov
operator|)
operator|++
index|]
operator|.
name|iov_base
expr_stmt|;
name|p
operator|->
name|link
operator|.
name|name
operator|=
name|dl
operator|->
name|name
expr_stmt|;
name|throughput_init
argument_list|(
operator|&
name|p
operator|->
name|link
operator|.
name|throughput
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|p
operator|->
name|Timer
argument_list|,
literal|'\0'
argument_list|,
sizeof|sizeof
name|p
operator|->
name|Timer
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|p
operator|->
name|link
operator|.
name|Queue
argument_list|,
literal|'\0'
argument_list|,
sizeof|sizeof
name|p
operator|->
name|link
operator|.
name|Queue
argument_list|)
expr_stmt|;
name|p
operator|->
name|desc
operator|.
name|UpdateSet
operator|=
name|modem_UpdateSet
expr_stmt|;
name|p
operator|->
name|desc
operator|.
name|IsSet
operator|=
name|physical_IsSet
expr_stmt|;
name|p
operator|->
name|desc
operator|.
name|Read
operator|=
name|modem_DescriptorRead
expr_stmt|;
name|p
operator|->
name|desc
operator|.
name|Write
operator|=
name|modem_DescriptorWrite
expr_stmt|;
name|p
operator|->
name|type
operator|=
name|PHYS_DIRECT
expr_stmt|;
name|p
operator|->
name|dl
operator|=
name|dl
expr_stmt|;
name|len
operator|=
name|strlen
argument_list|(
name|_PATH_DEV
argument_list|)
expr_stmt|;
name|p
operator|->
name|name
operator|.
name|base
operator|=
name|strncmp
argument_list|(
name|p
operator|->
name|name
operator|.
name|full
argument_list|,
name|_PATH_DEV
argument_list|,
name|len
argument_list|)
condition|?
name|p
operator|->
name|name
operator|.
name|full
else|:
name|p
operator|->
name|name
operator|.
name|full
operator|+
name|len
expr_stmt|;
name|p
operator|->
name|out
operator|=
name|NULL
expr_stmt|;
name|p
operator|->
name|connect_count
operator|=
literal|1
expr_stmt|;
name|p
operator|->
name|link
operator|.
name|lcp
operator|.
name|fsm
operator|.
name|bundle
operator|=
name|dl
operator|->
name|bundle
expr_stmt|;
name|p
operator|->
name|link
operator|.
name|lcp
operator|.
name|fsm
operator|.
name|link
operator|=
operator|&
name|p
operator|->
name|link
expr_stmt|;
name|memset
argument_list|(
operator|&
name|p
operator|->
name|link
operator|.
name|lcp
operator|.
name|fsm
operator|.
name|FsmTimer
argument_list|,
literal|'\0'
argument_list|,
sizeof|sizeof
name|p
operator|->
name|link
operator|.
name|lcp
operator|.
name|fsm
operator|.
name|FsmTimer
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|p
operator|->
name|link
operator|.
name|lcp
operator|.
name|fsm
operator|.
name|OpenTimer
argument_list|,
literal|'\0'
argument_list|,
sizeof|sizeof
name|p
operator|->
name|link
operator|.
name|lcp
operator|.
name|fsm
operator|.
name|OpenTimer
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|p
operator|->
name|link
operator|.
name|lcp
operator|.
name|fsm
operator|.
name|StoppedTimer
argument_list|,
literal|'\0'
argument_list|,
sizeof|sizeof
name|p
operator|->
name|link
operator|.
name|lcp
operator|.
name|fsm
operator|.
name|StoppedTimer
argument_list|)
expr_stmt|;
name|p
operator|->
name|link
operator|.
name|lcp
operator|.
name|fsm
operator|.
name|parent
operator|=
operator|&
name|dl
operator|->
name|fsmp
expr_stmt|;
name|lcp_SetupCallbacks
argument_list|(
operator|&
name|p
operator|->
name|link
operator|.
name|lcp
argument_list|)
expr_stmt|;
name|p
operator|->
name|link
operator|.
name|ccp
operator|.
name|fsm
operator|.
name|bundle
operator|=
name|dl
operator|->
name|bundle
expr_stmt|;
name|p
operator|->
name|link
operator|.
name|ccp
operator|.
name|fsm
operator|.
name|link
operator|=
operator|&
name|p
operator|->
name|link
expr_stmt|;
comment|/* Our in.state& out.state are NULL (no link-level ccp yet) */
name|memset
argument_list|(
operator|&
name|p
operator|->
name|link
operator|.
name|ccp
operator|.
name|fsm
operator|.
name|FsmTimer
argument_list|,
literal|'\0'
argument_list|,
sizeof|sizeof
name|p
operator|->
name|link
operator|.
name|ccp
operator|.
name|fsm
operator|.
name|FsmTimer
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|p
operator|->
name|link
operator|.
name|ccp
operator|.
name|fsm
operator|.
name|OpenTimer
argument_list|,
literal|'\0'
argument_list|,
sizeof|sizeof
name|p
operator|->
name|link
operator|.
name|ccp
operator|.
name|fsm
operator|.
name|OpenTimer
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|p
operator|->
name|link
operator|.
name|ccp
operator|.
name|fsm
operator|.
name|StoppedTimer
argument_list|,
literal|'\0'
argument_list|,
sizeof|sizeof
name|p
operator|->
name|link
operator|.
name|ccp
operator|.
name|fsm
operator|.
name|StoppedTimer
argument_list|)
expr_stmt|;
name|p
operator|->
name|link
operator|.
name|ccp
operator|.
name|fsm
operator|.
name|parent
operator|=
operator|&
name|dl
operator|->
name|fsmp
expr_stmt|;
name|ccp_SetupCallbacks
argument_list|(
operator|&
name|p
operator|->
name|link
operator|.
name|ccp
argument_list|)
expr_stmt|;
name|p
operator|->
name|hdlc
operator|.
name|lqm
operator|.
name|owner
operator|=
operator|&
name|p
operator|->
name|link
operator|.
name|lcp
expr_stmt|;
name|p
operator|->
name|hdlc
operator|.
name|ReportTimer
operator|.
name|state
operator|=
name|TIMER_STOPPED
expr_stmt|;
name|p
operator|->
name|hdlc
operator|.
name|lqm
operator|.
name|timer
operator|.
name|state
operator|=
name|TIMER_STOPPED
expr_stmt|;
name|p
operator|->
name|fd
operator|=
name|fd
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|hdlc
operator|.
name|lqm
operator|.
name|method
operator|&&
name|p
operator|->
name|hdlc
operator|.
name|lqm
operator|.
name|timer
operator|.
name|load
condition|)
name|lqr_reStart
argument_list|(
operator|&
name|p
operator|->
name|link
operator|.
name|lcp
argument_list|)
expr_stmt|;
name|hdlc_StartTimer
argument_list|(
operator|&
name|p
operator|->
name|hdlc
argument_list|)
expr_stmt|;
name|throughput_start
argument_list|(
operator|&
name|p
operator|->
name|link
operator|.
name|throughput
argument_list|,
literal|"modem throughput"
argument_list|,
name|Enabled
argument_list|(
name|dl
operator|->
name|bundle
argument_list|,
name|OPT_THROUGHPUT
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|Timer
operator|.
name|state
operator|!=
name|TIMER_STOPPED
condition|)
block|{
name|p
operator|->
name|Timer
operator|.
name|state
operator|=
name|TIMER_STOPPED
expr_stmt|;
comment|/* Special - see modem2iov() */
name|modem_StartTimer
argument_list|(
name|dl
operator|->
name|bundle
argument_list|,
name|p
argument_list|)
expr_stmt|;
comment|/* XXX: Should we set cd.required ? */
block|}
return|return
name|p
return|;
block|}
end_function

begin_function
name|int
name|modem2iov
parameter_list|(
name|struct
name|physical
modifier|*
name|p
parameter_list|,
name|struct
name|iovec
modifier|*
name|iov
parameter_list|,
name|int
modifier|*
name|niov
parameter_list|,
name|int
name|maxiov
parameter_list|,
name|pid_t
name|newpid
parameter_list|)
block|{
if|if
condition|(
name|p
condition|)
block|{
name|hdlc_StopTimer
argument_list|(
operator|&
name|p
operator|->
name|hdlc
argument_list|)
expr_stmt|;
name|lqr_StopTimer
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|timer_Stop
argument_list|(
operator|&
name|p
operator|->
name|link
operator|.
name|lcp
operator|.
name|fsm
operator|.
name|FsmTimer
argument_list|)
expr_stmt|;
name|timer_Stop
argument_list|(
operator|&
name|p
operator|->
name|link
operator|.
name|ccp
operator|.
name|fsm
operator|.
name|FsmTimer
argument_list|)
expr_stmt|;
name|timer_Stop
argument_list|(
operator|&
name|p
operator|->
name|link
operator|.
name|lcp
operator|.
name|fsm
operator|.
name|OpenTimer
argument_list|)
expr_stmt|;
name|timer_Stop
argument_list|(
operator|&
name|p
operator|->
name|link
operator|.
name|ccp
operator|.
name|fsm
operator|.
name|OpenTimer
argument_list|)
expr_stmt|;
name|timer_Stop
argument_list|(
operator|&
name|p
operator|->
name|link
operator|.
name|lcp
operator|.
name|fsm
operator|.
name|StoppedTimer
argument_list|)
expr_stmt|;
name|timer_Stop
argument_list|(
operator|&
name|p
operator|->
name|link
operator|.
name|ccp
operator|.
name|fsm
operator|.
name|StoppedTimer
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|Timer
operator|.
name|state
operator|!=
name|TIMER_STOPPED
condition|)
block|{
name|timer_Stop
argument_list|(
operator|&
name|p
operator|->
name|Timer
argument_list|)
expr_stmt|;
name|p
operator|->
name|Timer
operator|.
name|state
operator|=
name|TIMER_RUNNING
expr_stmt|;
comment|/* Special - see iov2modem() */
block|}
if|if
condition|(
name|tcgetpgrp
argument_list|(
name|p
operator|->
name|fd
argument_list|)
operator|==
name|getpgrp
argument_list|()
condition|)
name|p
operator|->
name|session_owner
operator|=
name|getpid
argument_list|()
expr_stmt|;
comment|/* So I'll eventually get HUP'd */
name|timer_Stop
argument_list|(
operator|&
name|p
operator|->
name|link
operator|.
name|throughput
operator|.
name|Timer
argument_list|)
expr_stmt|;
name|modem_ChangedPid
argument_list|(
name|p
argument_list|,
name|newpid
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|niov
operator|>=
name|maxiov
condition|)
block|{
name|log_Printf
argument_list|(
name|LogERROR
argument_list|,
literal|"modem2iov: No room for physical !\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
condition|)
name|free
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|iov
index|[
operator|*
name|niov
index|]
operator|.
name|iov_base
operator|=
name|p
condition|?
name|p
else|:
name|malloc
argument_list|(
sizeof|sizeof
expr|*
name|p
argument_list|)
expr_stmt|;
name|iov
index|[
operator|*
name|niov
index|]
operator|.
name|iov_len
operator|=
sizeof|sizeof
expr|*
name|p
expr_stmt|;
operator|(
operator|*
name|niov
operator|)
operator|++
expr_stmt|;
return|return
name|p
condition|?
name|p
operator|->
name|fd
else|:
literal|0
return|;
block|}
end_function

begin_function
name|void
name|modem_ChangedPid
parameter_list|(
name|struct
name|physical
modifier|*
name|p
parameter_list|,
name|pid_t
name|newpid
parameter_list|)
block|{
if|if
condition|(
name|p
operator|->
name|fd
operator|>=
literal|0
operator|&&
name|p
operator|->
name|type
operator|!=
name|PHYS_DIRECT
condition|)
block|{
name|int
name|res
decl_stmt|;
if|if
condition|(
operator|(
name|res
operator|=
name|ID0uu_lock_txfr
argument_list|(
name|p
operator|->
name|name
operator|.
name|base
argument_list|,
name|newpid
argument_list|)
operator|)
operator|!=
name|UU_LOCK_OK
condition|)
name|log_Printf
argument_list|(
name|LogPHASE
argument_list|,
literal|"uu_lock_txfr: %s\n"
argument_list|,
name|uu_lockerr
argument_list|(
name|res
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

end_unit


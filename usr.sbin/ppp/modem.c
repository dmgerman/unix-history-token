begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  *		PPP Modem handling module  *  *	    Written by Toshiharu OHNO (tony-o@iij.ad.jp)  *  *   Copyright (C) 1993, Internet Initiative Japan, Inc. All rights reserverd.  *  * Redistribution and use in source and binary forms are permitted  * provided that the above copyright notice and this paragraph are  * duplicated in all such forms and that any documentation,  * advertising materials, and other materials related to such  * distribution and use acknowledge that the software was developed  * by the Internet Initiative Japan, Inc.  The name of the  * IIJ may not be used to endorse or promote products derived  * from this software without specific prior written permission.  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND WITHOUT ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED  * WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR A PARTICULAR PURPOSE.  *  * $Id: modem.c,v 1.72 1997/12/28 02:56:43 brian Exp $  *  *  TODO:  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<arpa/inet.h>
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<paths.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/tty.h>
end_include

begin_include
include|#
directive|include
file|<termios.h>
end_include

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<utmp.h>
end_include

begin_include
include|#
directive|include
file|"command.h"
end_include

begin_include
include|#
directive|include
file|"mbuf.h"
end_include

begin_include
include|#
directive|include
file|"log.h"
end_include

begin_include
include|#
directive|include
file|"defs.h"
end_include

begin_include
include|#
directive|include
file|"id.h"
end_include

begin_include
include|#
directive|include
file|"timer.h"
end_include

begin_include
include|#
directive|include
file|"fsm.h"
end_include

begin_include
include|#
directive|include
file|"hdlc.h"
end_include

begin_include
include|#
directive|include
file|"lcp.h"
end_include

begin_include
include|#
directive|include
file|"ip.h"
end_include

begin_include
include|#
directive|include
file|"modem.h"
end_include

begin_include
include|#
directive|include
file|"loadalias.h"
end_include

begin_include
include|#
directive|include
file|"vars.h"
end_include

begin_include
include|#
directive|include
file|"main.h"
end_include

begin_include
include|#
directive|include
file|"chat.h"
end_include

begin_include
include|#
directive|include
file|"throughput.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|__OpenBSD__
end_ifdef

begin_include
include|#
directive|include
file|<util.h>
end_include

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<libutil.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|O_NONBLOCK
end_ifndef

begin_ifdef
ifdef|#
directive|ifdef
name|O_NDELAY
end_ifdef

begin_define
define|#
directive|define
name|O_NONBLOCK
value|O_NDELAY
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|static
name|int
name|mbits
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Current DCD status */
end_comment

begin_decl_stmt
specifier|static
name|int
name|connect_count
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|pppTimer
name|ModemTimer
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|Online
value|(mbits& TIOCM_CD)
end_define

begin_decl_stmt
specifier|static
name|struct
name|mbuf
modifier|*
name|modemout
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|mqueue
name|OutputQueues
index|[
name|PRI_LINK
operator|+
literal|1
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|dev_is_modem
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|pppThroughput
name|throughput
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|CloseLogicalModem
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|void
name|Enqueue
parameter_list|(
name|struct
name|mqueue
modifier|*
name|queue
parameter_list|,
name|struct
name|mbuf
modifier|*
name|bp
parameter_list|)
block|{
if|if
condition|(
name|queue
operator|->
name|last
condition|)
block|{
name|queue
operator|->
name|last
operator|->
name|pnext
operator|=
name|bp
expr_stmt|;
name|queue
operator|->
name|last
operator|=
name|bp
expr_stmt|;
block|}
else|else
name|queue
operator|->
name|last
operator|=
name|queue
operator|->
name|top
operator|=
name|bp
expr_stmt|;
name|queue
operator|->
name|qlen
operator|++
expr_stmt|;
name|LogPrintf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"Enqueue: len = %d\n"
argument_list|,
name|queue
operator|->
name|qlen
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|struct
name|mbuf
modifier|*
name|Dequeue
parameter_list|(
name|struct
name|mqueue
modifier|*
name|queue
parameter_list|)
block|{
name|struct
name|mbuf
modifier|*
name|bp
decl_stmt|;
name|LogPrintf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"Dequeue: len = %d\n"
argument_list|,
name|queue
operator|->
name|qlen
argument_list|)
expr_stmt|;
name|bp
operator|=
name|queue
operator|->
name|top
expr_stmt|;
if|if
condition|(
name|bp
condition|)
block|{
name|queue
operator|->
name|top
operator|=
name|queue
operator|->
name|top
operator|->
name|pnext
expr_stmt|;
name|queue
operator|->
name|qlen
operator|--
expr_stmt|;
if|if
condition|(
name|queue
operator|->
name|top
operator|==
name|NULL
condition|)
block|{
name|queue
operator|->
name|last
operator|=
name|queue
operator|->
name|top
expr_stmt|;
if|if
condition|(
name|queue
operator|->
name|qlen
condition|)
name|LogPrintf
argument_list|(
name|LogERROR
argument_list|,
literal|"Dequeue: Not zero (%d)!!!\n"
argument_list|,
name|queue
operator|->
name|qlen
argument_list|)
expr_stmt|;
block|}
block|}
return|return
operator|(
name|bp
operator|)
return|;
block|}
end_function

begin_struct
specifier|static
struct|struct
name|speeds
block|{
name|int
name|nspeed
decl_stmt|;
name|speed_t
name|speed
decl_stmt|;
block|}
name|speeds
index|[]
init|=
block|{
ifdef|#
directive|ifdef
name|B50
block|{
literal|50
block|,
name|B50
block|, }
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|B75
block|{
literal|75
block|,
name|B75
block|, }
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|B110
block|{
literal|110
block|,
name|B110
block|, }
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|B134
block|{
literal|134
block|,
name|B134
block|, }
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|B150
block|{
literal|150
block|,
name|B150
block|, }
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|B200
block|{
literal|200
block|,
name|B200
block|, }
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|B300
block|{
literal|300
block|,
name|B300
block|, }
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|B600
block|{
literal|600
block|,
name|B600
block|, }
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|B1200
block|{
literal|1200
block|,
name|B1200
block|, }
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|B1800
block|{
literal|1800
block|,
name|B1800
block|, }
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|B2400
block|{
literal|2400
block|,
name|B2400
block|, }
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|B4800
block|{
literal|4800
block|,
name|B4800
block|, }
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|B9600
block|{
literal|9600
block|,
name|B9600
block|, }
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|B19200
block|{
literal|19200
block|,
name|B19200
block|, }
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|B38400
block|{
literal|38400
block|,
name|B38400
block|, }
block|,
endif|#
directive|endif
ifndef|#
directive|ifndef
name|_POSIX_SOURCE
ifdef|#
directive|ifdef
name|B7200
block|{
literal|7200
block|,
name|B7200
block|, }
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|B14400
block|{
literal|14400
block|,
name|B14400
block|, }
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|B28800
block|{
literal|28800
block|,
name|B28800
block|, }
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|B57600
block|{
literal|57600
block|,
name|B57600
block|, }
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|B76800
block|{
literal|76800
block|,
name|B76800
block|, }
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|B115200
block|{
literal|115200
block|,
name|B115200
block|, }
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|B230400
block|{
literal|230400
block|,
name|B230400
block|, }
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|EXTA
block|{
literal|19200
block|,
name|EXTA
block|, }
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|EXTB
block|{
literal|38400
block|,
name|EXTB
block|, }
block|,
endif|#
directive|endif
endif|#
directive|endif
comment|/* _POSIX_SOURCE */
block|{
literal|0
block|,
literal|0
block|}
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|SpeedToInt
parameter_list|(
name|speed_t
name|speed
parameter_list|)
block|{
name|struct
name|speeds
modifier|*
name|sp
decl_stmt|;
for|for
control|(
name|sp
operator|=
name|speeds
init|;
name|sp
operator|->
name|nspeed
condition|;
name|sp
operator|++
control|)
block|{
if|if
condition|(
name|sp
operator|->
name|speed
operator|==
name|speed
condition|)
block|{
return|return
operator|(
name|sp
operator|->
name|nspeed
operator|)
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|speed_t
name|IntToSpeed
parameter_list|(
name|int
name|nspeed
parameter_list|)
block|{
name|struct
name|speeds
modifier|*
name|sp
decl_stmt|;
for|for
control|(
name|sp
operator|=
name|speeds
init|;
name|sp
operator|->
name|nspeed
condition|;
name|sp
operator|++
control|)
block|{
if|if
condition|(
name|sp
operator|->
name|nspeed
operator|==
name|nspeed
condition|)
block|{
return|return
operator|(
name|sp
operator|->
name|speed
operator|)
return|;
block|}
block|}
return|return
name|B0
return|;
block|}
end_function

begin_function
name|void
name|DownConnection
parameter_list|()
block|{
name|LogPrintf
argument_list|(
name|LogPHASE
argument_list|,
literal|"Disconnected!\n"
argument_list|)
expr_stmt|;
name|LcpDown
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  *  ModemTimeout() watches DCD signal and notifies if it's status is changed.  *  */
end_comment

begin_function
name|void
name|ModemTimeout
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|int
name|ombits
init|=
name|mbits
decl_stmt|;
name|int
name|change
decl_stmt|;
name|StopTimer
argument_list|(
operator|&
name|ModemTimer
argument_list|)
expr_stmt|;
name|StartTimer
argument_list|(
operator|&
name|ModemTimer
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev_is_modem
condition|)
block|{
if|if
condition|(
name|modem
operator|>=
literal|0
condition|)
block|{
if|if
condition|(
name|ioctl
argument_list|(
name|modem
argument_list|,
name|TIOCMGET
argument_list|,
operator|&
name|mbits
argument_list|)
operator|<
literal|0
condition|)
block|{
name|LogPrintf
argument_list|(
name|LogPHASE
argument_list|,
literal|"ioctl error (%s)!\n"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|DownConnection
argument_list|()
expr_stmt|;
return|return;
block|}
block|}
else|else
name|mbits
operator|=
literal|0
expr_stmt|;
name|change
operator|=
name|ombits
operator|^
name|mbits
expr_stmt|;
if|if
condition|(
name|change
operator|&
name|TIOCM_CD
condition|)
block|{
if|if
condition|(
name|Online
condition|)
block|{
name|LogPrintf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"ModemTimeout: offline -> online\n"
argument_list|)
expr_stmt|;
comment|/* 	 * In dedicated mode, start packet mode immediate after we detected 	 * carrier. 	 */
if|if
condition|(
name|mode
operator|&
name|MODE_DEDICATED
condition|)
name|PacketMode
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|LogPrintf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"ModemTimeout: online -> offline\n"
argument_list|)
expr_stmt|;
name|reconnect
argument_list|(
name|RECON_TRUE
argument_list|)
expr_stmt|;
name|DownConnection
argument_list|()
expr_stmt|;
block|}
block|}
else|else
name|LogPrintf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"ModemTimeout: Still %sline\n"
argument_list|,
name|Online
condition|?
literal|"on"
else|:
literal|"off"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|Online
condition|)
block|{
comment|/* mbits was set to zero in OpenModem() */
name|mbits
operator|=
name|TIOCM_CD
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|StartModemTimer
parameter_list|(
name|void
parameter_list|)
block|{
name|StopTimer
argument_list|(
operator|&
name|ModemTimer
argument_list|)
expr_stmt|;
name|ModemTimer
operator|.
name|state
operator|=
name|TIMER_STOPPED
expr_stmt|;
name|ModemTimer
operator|.
name|load
operator|=
name|SECTICKS
expr_stmt|;
name|ModemTimer
operator|.
name|func
operator|=
name|ModemTimeout
expr_stmt|;
name|LogPrintf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"ModemTimer using ModemTimeout() - %p\n"
argument_list|,
name|ModemTimeout
argument_list|)
expr_stmt|;
name|StartTimer
argument_list|(
operator|&
name|ModemTimer
argument_list|)
expr_stmt|;
block|}
end_function

begin_struct
struct|struct
name|parity
block|{
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
specifier|const
name|char
modifier|*
name|name1
decl_stmt|;
name|int
name|set
decl_stmt|;
block|}
name|validparity
index|[]
init|=
block|{
block|{
literal|"even"
block|,
literal|"P_EVEN"
block|,
name|CS7
operator||
name|PARENB
block|}
block|,
block|{
literal|"odd"
block|,
literal|"P_ODD"
block|,
name|CS7
operator||
name|PARENB
operator||
name|PARODD
block|}
block|,
block|{
literal|"none"
block|,
literal|"P_ZERO"
block|,
name|CS8
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|}
block|, }
struct|;
end_struct

begin_function
specifier|static
name|int
name|GetParityValue
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|)
block|{
name|struct
name|parity
modifier|*
name|pp
decl_stmt|;
for|for
control|(
name|pp
operator|=
name|validparity
init|;
name|pp
operator|->
name|name
condition|;
name|pp
operator|++
control|)
block|{
if|if
condition|(
name|strcasecmp
argument_list|(
name|pp
operator|->
name|name
argument_list|,
name|str
argument_list|)
operator|==
literal|0
operator|||
name|strcasecmp
argument_list|(
name|pp
operator|->
name|name1
argument_list|,
name|str
argument_list|)
operator|==
literal|0
condition|)
block|{
return|return
name|VarParity
operator|=
name|pp
operator|->
name|set
return|;
block|}
block|}
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ChangeParity
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|)
block|{
name|struct
name|termios
name|rstio
decl_stmt|;
name|int
name|val
decl_stmt|;
name|val
operator|=
name|GetParityValue
argument_list|(
name|str
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|>
literal|0
condition|)
block|{
name|VarParity
operator|=
name|val
expr_stmt|;
name|tcgetattr
argument_list|(
name|modem
argument_list|,
operator|&
name|rstio
argument_list|)
expr_stmt|;
name|rstio
operator|.
name|c_cflag
operator|&=
operator|~
operator|(
name|CSIZE
operator||
name|PARODD
operator||
name|PARENB
operator|)
expr_stmt|;
name|rstio
operator|.
name|c_cflag
operator||=
name|val
expr_stmt|;
name|tcsetattr
argument_list|(
name|modem
argument_list|,
name|TCSADRAIN
argument_list|,
operator|&
name|rstio
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|LogPrintf
argument_list|(
name|LogWARN
argument_list|,
literal|"ChangeParity: %s: Invalid parity\n"
argument_list|,
name|str
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|OpenConnection
parameter_list|(
name|char
modifier|*
name|host
parameter_list|,
name|char
modifier|*
name|port
parameter_list|)
block|{
name|struct
name|sockaddr_in
name|dest
decl_stmt|;
name|int
name|sock
decl_stmt|;
name|struct
name|hostent
modifier|*
name|hp
decl_stmt|;
name|struct
name|servent
modifier|*
name|sp
decl_stmt|;
name|dest
operator|.
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|dest
operator|.
name|sin_addr
operator|.
name|s_addr
operator|=
name|inet_addr
argument_list|(
name|host
argument_list|)
expr_stmt|;
if|if
condition|(
name|dest
operator|.
name|sin_addr
operator|.
name|s_addr
operator|==
name|INADDR_NONE
condition|)
block|{
name|hp
operator|=
name|gethostbyname
argument_list|(
name|host
argument_list|)
expr_stmt|;
if|if
condition|(
name|hp
condition|)
block|{
name|memcpy
argument_list|(
operator|&
name|dest
operator|.
name|sin_addr
operator|.
name|s_addr
argument_list|,
name|hp
operator|->
name|h_addr_list
index|[
literal|0
index|]
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|LogPrintf
argument_list|(
name|LogWARN
argument_list|,
literal|"OpenConnection: unknown host: %s\n"
argument_list|,
name|host
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
name|dest
operator|.
name|sin_port
operator|=
name|htons
argument_list|(
name|atoi
argument_list|(
name|port
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dest
operator|.
name|sin_port
operator|==
literal|0
condition|)
block|{
name|sp
operator|=
name|getservbyname
argument_list|(
name|port
argument_list|,
literal|"tcp"
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
condition|)
block|{
name|dest
operator|.
name|sin_port
operator|=
name|sp
operator|->
name|s_port
expr_stmt|;
block|}
else|else
block|{
name|LogPrintf
argument_list|(
name|LogWARN
argument_list|,
literal|"OpenConnection: unknown service: %s\n"
argument_list|,
name|port
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
name|LogPrintf
argument_list|(
name|LogPHASE
argument_list|,
literal|"Connecting to %s:%s\n"
argument_list|,
name|host
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|sock
operator|=
name|socket
argument_list|(
name|PF_INET
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|sock
operator|<
literal|0
condition|)
block|{
return|return
operator|(
name|sock
operator|)
return|;
block|}
if|if
condition|(
name|connect
argument_list|(
name|sock
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|dest
argument_list|,
sizeof|sizeof
name|dest
argument_list|)
operator|<
literal|0
condition|)
block|{
name|LogPrintf
argument_list|(
name|LogWARN
argument_list|,
literal|"OpenConnection: connection failed.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|LogPrintf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"OpenConnection: modem fd is %d.\n"
argument_list|,
name|sock
argument_list|)
expr_stmt|;
return|return
operator|(
name|sock
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|char
name|fn
index|[
name|MAXPATHLEN
index|]
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|LockModem
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|res
decl_stmt|;
name|FILE
modifier|*
name|lockfile
decl_stmt|;
if|if
condition|(
operator|*
name|VarDevice
operator|!=
literal|'/'
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|!
operator|(
name|mode
operator|&
name|MODE_DIRECT
operator|)
operator|&&
operator|(
name|res
operator|=
name|ID0uu_lock
argument_list|(
name|VarBaseDevice
argument_list|)
operator|)
operator|!=
name|UU_LOCK_OK
condition|)
block|{
if|if
condition|(
name|res
operator|==
name|UU_LOCK_INUSE
condition|)
name|LogPrintf
argument_list|(
name|LogPHASE
argument_list|,
literal|"Modem %s is in use\n"
argument_list|,
name|VarDevice
argument_list|)
expr_stmt|;
else|else
name|LogPrintf
argument_list|(
name|LogPHASE
argument_list|,
literal|"Modem %s is in use: uu_lock: %s\n"
argument_list|,
name|VarDevice
argument_list|,
name|uu_lockerr
argument_list|(
name|res
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|snprintf
argument_list|(
name|fn
argument_list|,
sizeof|sizeof
name|fn
argument_list|,
literal|"%s%s.if"
argument_list|,
name|_PATH_VARRUN
argument_list|,
name|VarBaseDevice
argument_list|)
expr_stmt|;
name|lockfile
operator|=
name|ID0fopen
argument_list|(
name|fn
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
if|if
condition|(
name|lockfile
operator|!=
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|lockfile
argument_list|,
literal|"tun%d\n"
argument_list|,
name|tunno
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|lockfile
argument_list|)
expr_stmt|;
block|}
else|else
name|LogPrintf
argument_list|(
name|LogALERT
argument_list|,
literal|"Warning: Can't create %s: %s\n"
argument_list|,
name|fn
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|UnlockModem
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
operator|*
name|VarDevice
operator|!=
literal|'/'
condition|)
return|return;
name|snprintf
argument_list|(
name|fn
argument_list|,
sizeof|sizeof
name|fn
argument_list|,
literal|"%s%s.if"
argument_list|,
name|_PATH_VARRUN
argument_list|,
name|VarBaseDevice
argument_list|)
expr_stmt|;
if|if
condition|(
name|ID0unlink
argument_list|(
name|fn
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|LogPrintf
argument_list|(
name|LogALERT
argument_list|,
literal|"Warning: Can't remove %s: %s\n"
argument_list|,
name|fn
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|mode
operator|&
name|MODE_DIRECT
operator|)
operator|&&
name|ID0uu_unlock
argument_list|(
name|VarBaseDevice
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|LogPrintf
argument_list|(
name|LogALERT
argument_list|,
literal|"Warning: Can't uu_unlock %s\n"
argument_list|,
name|fn
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|HaveModem
parameter_list|(
name|void
parameter_list|)
block|{
name|throughput_start
argument_list|(
operator|&
name|throughput
argument_list|)
expr_stmt|;
name|connect_count
operator|++
expr_stmt|;
name|LogPrintf
argument_list|(
name|LogPHASE
argument_list|,
literal|"Connected!\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
name|struct
name|termios
name|modemios
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|OpenModem
parameter_list|()
block|{
name|struct
name|termios
name|rstio
decl_stmt|;
name|int
name|oldflag
decl_stmt|;
name|char
modifier|*
name|host
decl_stmt|,
modifier|*
name|port
decl_stmt|;
name|char
modifier|*
name|cp
decl_stmt|;
name|char
name|tmpDeviceList
index|[
sizeof|sizeof
name|VarDeviceList
index|]
decl_stmt|;
name|char
modifier|*
name|tmpDevice
decl_stmt|;
if|if
condition|(
name|modem
operator|>=
literal|0
condition|)
name|LogPrintf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"OpenModem: Modem is already open!\n"
argument_list|)
expr_stmt|;
comment|/* We're going back into "term" mode */
elseif|else
if|if
condition|(
name|mode
operator|&
name|MODE_DIRECT
condition|)
block|{
name|struct
name|cmdargs
name|arg
decl_stmt|;
name|arg
operator|.
name|cmd
operator|=
name|NULL
expr_stmt|;
name|arg
operator|.
name|data
operator|=
operator|(
specifier|const
name|void
operator|*
operator|)
name|VAR_DEVICE
expr_stmt|;
if|if
condition|(
name|isatty
argument_list|(
name|STDIN_FILENO
argument_list|)
condition|)
block|{
name|LogPrintf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"OpenModem(direct): Modem is a tty\n"
argument_list|)
expr_stmt|;
name|cp
operator|=
name|ttyname
argument_list|(
name|STDIN_FILENO
argument_list|)
expr_stmt|;
name|arg
operator|.
name|argc
operator|=
literal|1
expr_stmt|;
name|arg
operator|.
name|argv
operator|=
operator|(
name|char
specifier|const
operator|*
specifier|const
operator|*
operator|)
operator|&
name|cp
expr_stmt|;
name|SetVariable
argument_list|(
operator|&
name|arg
argument_list|)
expr_stmt|;
if|if
condition|(
name|LockModem
argument_list|()
operator|==
operator|-
literal|1
condition|)
block|{
name|close
argument_list|(
name|STDIN_FILENO
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|modem
operator|=
name|STDIN_FILENO
expr_stmt|;
name|HaveModem
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|LogPrintf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"OpenModem(direct): Modem is not a tty\n"
argument_list|)
expr_stmt|;
name|arg
operator|.
name|argc
operator|=
literal|0
expr_stmt|;
name|arg
operator|.
name|argv
operator|=
name|NULL
expr_stmt|;
name|SetVariable
argument_list|(
operator|&
name|arg
argument_list|)
expr_stmt|;
comment|/* We don't call ModemTimeout() with this type of connection */
name|HaveModem
argument_list|()
expr_stmt|;
return|return
name|modem
operator|=
name|STDIN_FILENO
return|;
block|}
block|}
else|else
block|{
name|strncpy
argument_list|(
name|tmpDeviceList
argument_list|,
name|VarDeviceList
argument_list|,
sizeof|sizeof
name|tmpDeviceList
operator|-
literal|1
argument_list|)
expr_stmt|;
name|tmpDeviceList
index|[
sizeof|sizeof
name|tmpDeviceList
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
for|for
control|(
name|tmpDevice
operator|=
name|strtok
argument_list|(
name|tmpDeviceList
argument_list|,
literal|","
argument_list|)
init|;
name|tmpDevice
operator|&&
operator|(
name|modem
operator|<
literal|0
operator|)
condition|;
name|tmpDevice
operator|=
name|strtok
argument_list|(
name|NULL
argument_list|,
literal|","
argument_list|)
control|)
block|{
name|strncpy
argument_list|(
name|VarDevice
argument_list|,
name|tmpDevice
argument_list|,
sizeof|sizeof
name|VarDevice
operator|-
literal|1
argument_list|)
expr_stmt|;
name|VarDevice
index|[
sizeof|sizeof
name|VarDevice
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|VarBaseDevice
operator|=
name|strrchr
argument_list|(
name|VarDevice
argument_list|,
literal|'/'
argument_list|)
expr_stmt|;
name|VarBaseDevice
operator|=
name|VarBaseDevice
condition|?
name|VarBaseDevice
operator|+
literal|1
else|:
literal|""
expr_stmt|;
if|if
condition|(
name|strncmp
argument_list|(
name|VarDevice
argument_list|,
literal|"/dev/"
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|LockModem
argument_list|()
operator|==
operator|-
literal|1
condition|)
block|{
name|modem
operator|=
operator|-
literal|1
expr_stmt|;
block|}
else|else
block|{
name|modem
operator|=
name|ID0open
argument_list|(
name|VarDevice
argument_list|,
name|O_RDWR
operator||
name|O_NONBLOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|modem
operator|<
literal|0
condition|)
block|{
name|LogPrintf
argument_list|(
name|LogERROR
argument_list|,
literal|"OpenModem failed: %s: %s\n"
argument_list|,
name|VarDevice
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|UnlockModem
argument_list|()
expr_stmt|;
name|modem
operator|=
operator|-
literal|1
expr_stmt|;
block|}
else|else
block|{
name|HaveModem
argument_list|()
expr_stmt|;
name|LogPrintf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"OpenModem: Modem is %s\n"
argument_list|,
name|VarDevice
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
comment|/* PPP over TCP */
name|cp
operator|=
name|strchr
argument_list|(
name|VarDevice
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
name|cp
condition|)
block|{
operator|*
name|cp
operator|=
literal|'\0'
expr_stmt|;
name|host
operator|=
name|VarDevice
expr_stmt|;
name|port
operator|=
name|cp
operator|+
literal|1
expr_stmt|;
if|if
condition|(
operator|*
name|host
operator|&&
operator|*
name|port
condition|)
block|{
name|modem
operator|=
name|OpenConnection
argument_list|(
name|host
argument_list|,
name|port
argument_list|)
expr_stmt|;
operator|*
name|cp
operator|=
literal|':'
expr_stmt|;
comment|/* Don't destroy VarDevice */
if|if
condition|(
name|modem
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|HaveModem
argument_list|()
expr_stmt|;
name|LogPrintf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"OpenModem: Modem is socket %s\n"
argument_list|,
name|VarDevice
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|*
name|cp
operator|=
literal|':'
expr_stmt|;
comment|/* Don't destroy VarDevice */
name|LogPrintf
argument_list|(
name|LogERROR
argument_list|,
literal|"Invalid host:port: \"%s\"\n"
argument_list|,
name|VarDevice
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
else|else
block|{
name|LogPrintf
argument_list|(
name|LogERROR
argument_list|,
literal|"Device (%s) must be in /dev or be a host:port pair\n"
argument_list|,
name|VarDevice
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
block|}
if|if
condition|(
name|modem
operator|<
literal|0
condition|)
return|return
name|modem
return|;
block|}
comment|/*    * If we are working on tty device, change it's mode into the one desired    * for further operation. In this implementation, we assume that modem is    * configuted to use CTS/RTS flow control.    */
name|mbits
operator|=
literal|0
expr_stmt|;
name|dev_is_modem
operator|=
name|isatty
argument_list|(
name|modem
argument_list|)
operator|||
name|DEV_IS_SYNC
expr_stmt|;
if|if
condition|(
name|DEV_IS_SYNC
condition|)
name|nointr_sleep
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev_is_modem
operator|&&
operator|!
name|DEV_IS_SYNC
condition|)
block|{
name|tcgetattr
argument_list|(
name|modem
argument_list|,
operator|&
name|rstio
argument_list|)
expr_stmt|;
name|modemios
operator|=
name|rstio
expr_stmt|;
name|LogPrintf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"OpenModem: modem = %d\n"
argument_list|,
name|modem
argument_list|)
expr_stmt|;
name|LogPrintf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"OpenModem: modem (get): iflag = %x, oflag = %x,"
literal|" cflag = %x\n"
argument_list|,
name|rstio
operator|.
name|c_iflag
argument_list|,
name|rstio
operator|.
name|c_oflag
argument_list|,
name|rstio
operator|.
name|c_cflag
argument_list|)
expr_stmt|;
name|cfmakeraw
argument_list|(
operator|&
name|rstio
argument_list|)
expr_stmt|;
if|if
condition|(
name|VarCtsRts
condition|)
name|rstio
operator|.
name|c_cflag
operator||=
name|CLOCAL
operator||
name|CCTS_OFLOW
operator||
name|CRTS_IFLOW
expr_stmt|;
else|else
block|{
name|rstio
operator|.
name|c_cflag
operator||=
name|CLOCAL
expr_stmt|;
name|rstio
operator|.
name|c_iflag
operator||=
name|IXOFF
expr_stmt|;
block|}
name|rstio
operator|.
name|c_iflag
operator||=
name|IXON
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|mode
operator|&
name|MODE_DEDICATED
operator|)
condition|)
name|rstio
operator|.
name|c_cflag
operator||=
name|HUPCL
expr_stmt|;
if|if
condition|(
operator|(
name|mode
operator|&
name|MODE_DIRECT
operator|)
operator|==
literal|0
condition|)
block|{
comment|/*        * If we are working as direct mode, don't change tty speed.        */
name|rstio
operator|.
name|c_cflag
operator|&=
operator|~
operator|(
name|CSIZE
operator||
name|PARODD
operator||
name|PARENB
operator|)
expr_stmt|;
name|rstio
operator|.
name|c_cflag
operator||=
name|VarParity
expr_stmt|;
if|if
condition|(
name|cfsetspeed
argument_list|(
operator|&
name|rstio
argument_list|,
name|IntToSpeed
argument_list|(
name|VarSpeed
argument_list|)
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|LogPrintf
argument_list|(
name|LogWARN
argument_list|,
literal|"Unable to set modem speed (modem %d to %d)\n"
argument_list|,
name|modem
argument_list|,
name|VarSpeed
argument_list|)
expr_stmt|;
block|}
block|}
name|tcsetattr
argument_list|(
name|modem
argument_list|,
name|TCSADRAIN
argument_list|,
operator|&
name|rstio
argument_list|)
expr_stmt|;
name|LogPrintf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"modem (put): iflag = %x, oflag = %x, cflag = %x\n"
argument_list|,
name|rstio
operator|.
name|c_iflag
argument_list|,
name|rstio
operator|.
name|c_oflag
argument_list|,
name|rstio
operator|.
name|c_cflag
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|mode
operator|&
name|MODE_DIRECT
operator|)
condition|)
if|if
condition|(
name|ioctl
argument_list|(
name|modem
argument_list|,
name|TIOCMGET
argument_list|,
operator|&
name|mbits
argument_list|)
condition|)
block|{
name|LogPrintf
argument_list|(
name|LogERROR
argument_list|,
literal|"OpenModem: Cannot get modem status: %s\n"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|CloseLogicalModem
argument_list|()
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|LogPrintf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"OpenModem: modem control = %o\n"
argument_list|,
name|mbits
argument_list|)
expr_stmt|;
name|oldflag
operator|=
name|fcntl
argument_list|(
name|modem
argument_list|,
name|F_GETFL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|oldflag
operator|<
literal|0
condition|)
block|{
name|LogPrintf
argument_list|(
name|LogERROR
argument_list|,
literal|"OpenModem: Cannot get modem flags: %s\n"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|CloseLogicalModem
argument_list|()
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
operator|(
name|void
operator|)
name|fcntl
argument_list|(
name|modem
argument_list|,
name|F_SETFL
argument_list|,
name|oldflag
operator|&
operator|~
name|O_NONBLOCK
argument_list|)
expr_stmt|;
block|}
name|StartModemTimer
argument_list|()
expr_stmt|;
return|return
operator|(
name|modem
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ModemSpeed
parameter_list|()
block|{
name|struct
name|termios
name|rstio
decl_stmt|;
name|tcgetattr
argument_list|(
name|modem
argument_list|,
operator|&
name|rstio
argument_list|)
expr_stmt|;
return|return
operator|(
name|SpeedToInt
argument_list|(
name|cfgetispeed
argument_list|(
operator|&
name|rstio
argument_list|)
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Put modem tty line into raw mode which is necessary in packet mode operation  */
end_comment

begin_function
name|int
name|RawModem
parameter_list|()
block|{
name|struct
name|termios
name|rstio
decl_stmt|;
name|int
name|oldflag
decl_stmt|;
if|if
condition|(
operator|!
name|isatty
argument_list|(
name|modem
argument_list|)
operator|||
name|DEV_IS_SYNC
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
operator|!
operator|(
name|mode
operator|&
name|MODE_DIRECT
operator|)
operator|&&
name|modem
operator|>=
literal|0
operator|&&
operator|!
name|Online
condition|)
block|{
name|LogPrintf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"RawModem: mode = %d, modem = %d, mbits = %x\n"
argument_list|,
name|mode
argument_list|,
name|modem
argument_list|,
name|mbits
argument_list|)
expr_stmt|;
block|}
name|tcgetattr
argument_list|(
name|modem
argument_list|,
operator|&
name|rstio
argument_list|)
expr_stmt|;
name|cfmakeraw
argument_list|(
operator|&
name|rstio
argument_list|)
expr_stmt|;
if|if
condition|(
name|VarCtsRts
condition|)
name|rstio
operator|.
name|c_cflag
operator||=
name|CLOCAL
operator||
name|CCTS_OFLOW
operator||
name|CRTS_IFLOW
expr_stmt|;
else|else
name|rstio
operator|.
name|c_cflag
operator||=
name|CLOCAL
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|mode
operator|&
name|MODE_DEDICATED
operator|)
condition|)
name|rstio
operator|.
name|c_cflag
operator||=
name|HUPCL
expr_stmt|;
name|tcsetattr
argument_list|(
name|modem
argument_list|,
name|TCSADRAIN
argument_list|,
operator|&
name|rstio
argument_list|)
expr_stmt|;
name|oldflag
operator|=
name|fcntl
argument_list|(
name|modem
argument_list|,
name|F_GETFL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|oldflag
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
operator|(
name|void
operator|)
name|fcntl
argument_list|(
name|modem
argument_list|,
name|F_SETFL
argument_list|,
name|oldflag
operator||
name|O_NONBLOCK
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|UnrawModem
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|oldflag
decl_stmt|;
if|if
condition|(
name|isatty
argument_list|(
name|modem
argument_list|)
operator|&&
operator|!
name|DEV_IS_SYNC
condition|)
block|{
name|tcsetattr
argument_list|(
name|modem
argument_list|,
name|TCSAFLUSH
argument_list|,
operator|&
name|modemios
argument_list|)
expr_stmt|;
name|oldflag
operator|=
name|fcntl
argument_list|(
name|modem
argument_list|,
name|F_GETFL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|oldflag
operator|<
literal|0
condition|)
return|return;
operator|(
name|void
operator|)
name|fcntl
argument_list|(
name|modem
argument_list|,
name|F_SETFL
argument_list|,
name|oldflag
operator|&
operator|~
name|O_NONBLOCK
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|ModemAddInOctets
parameter_list|(
name|int
name|n
parameter_list|)
block|{
name|throughput_addin
argument_list|(
operator|&
name|throughput
argument_list|,
name|n
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ModemAddOutOctets
parameter_list|(
name|int
name|n
parameter_list|)
block|{
name|throughput_addout
argument_list|(
operator|&
name|throughput
argument_list|,
name|n
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ClosePhysicalModem
parameter_list|(
name|void
parameter_list|)
block|{
name|LogPrintf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"ClosePhysicalModem\n"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|modem
argument_list|)
expr_stmt|;
name|modem
operator|=
operator|-
literal|1
expr_stmt|;
name|throughput_log
argument_list|(
operator|&
name|throughput
argument_list|,
name|LogPHASE
argument_list|,
literal|"Modem"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|HangupModem
parameter_list|(
name|int
name|flag
parameter_list|)
block|{
name|struct
name|termios
name|tio
decl_stmt|;
name|LogPrintf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"Hangup modem (%s)\n"
argument_list|,
name|modem
operator|>=
literal|0
condition|?
literal|"open"
else|:
literal|"closed"
argument_list|)
expr_stmt|;
if|if
condition|(
name|modem
operator|<
literal|0
condition|)
return|return;
name|StopTimer
argument_list|(
operator|&
name|ModemTimer
argument_list|)
expr_stmt|;
name|throughput_stop
argument_list|(
operator|&
name|throughput
argument_list|)
expr_stmt|;
if|if
condition|(
name|TermMode
condition|)
block|{
name|LogPrintf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"HangupModem: Not in 'term' mode\n"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|!
name|isatty
argument_list|(
name|modem
argument_list|)
condition|)
block|{
name|mbits
operator|&=
operator|~
name|TIOCM_DTR
expr_stmt|;
name|ClosePhysicalModem
argument_list|()
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|modem
operator|>=
literal|0
operator|&&
name|Online
condition|)
block|{
name|mbits
operator|&=
operator|~
name|TIOCM_DTR
expr_stmt|;
name|tcgetattr
argument_list|(
name|modem
argument_list|,
operator|&
name|tio
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfsetspeed
argument_list|(
operator|&
name|tio
argument_list|,
name|B0
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|LogPrintf
argument_list|(
name|LogWARN
argument_list|,
literal|"Unable to set modem to speed 0\n"
argument_list|)
expr_stmt|;
block|}
name|tcsetattr
argument_list|(
name|modem
argument_list|,
name|TCSANOW
argument_list|,
operator|&
name|tio
argument_list|)
expr_stmt|;
name|nointr_sleep
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|modem
operator|>=
literal|0
condition|)
block|{
name|char
name|ScriptBuffer
index|[
name|SCRIPT_LEN
index|]
decl_stmt|;
name|strncpy
argument_list|(
name|ScriptBuffer
argument_list|,
name|VarHangupScript
argument_list|,
sizeof|sizeof
name|ScriptBuffer
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ScriptBuffer
index|[
sizeof|sizeof
name|ScriptBuffer
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|LogPrintf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"HangupModem: Script: %s\n"
argument_list|,
name|ScriptBuffer
argument_list|)
expr_stmt|;
if|if
condition|(
name|flag
operator|||
operator|!
operator|(
name|mode
operator|&
name|MODE_DEDICATED
operator|)
condition|)
block|{
name|DoChat
argument_list|(
name|ScriptBuffer
argument_list|)
expr_stmt|;
name|tcflush
argument_list|(
name|modem
argument_list|,
name|TCIOFLUSH
argument_list|)
expr_stmt|;
name|UnrawModem
argument_list|()
expr_stmt|;
name|CloseLogicalModem
argument_list|()
expr_stmt|;
block|}
else|else
block|{
comment|/*        * If we are working as dedicated mode, never close it until we are        * directed to quit program.        */
name|mbits
operator||=
name|TIOCM_DTR
expr_stmt|;
name|ioctl
argument_list|(
name|modem
argument_list|,
name|TIOCMSET
argument_list|,
operator|&
name|mbits
argument_list|)
expr_stmt|;
name|DoChat
argument_list|(
name|ScriptBuffer
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|CloseLogicalModem
parameter_list|(
name|void
parameter_list|)
block|{
name|LogPrintf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"CloseLogicalModem\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|modem
operator|>=
literal|0
condition|)
block|{
name|ClosePhysicalModem
argument_list|()
expr_stmt|;
if|if
condition|(
name|Utmp
condition|)
block|{
name|struct
name|utmp
name|ut
decl_stmt|;
name|strncpy
argument_list|(
name|ut
operator|.
name|ut_line
argument_list|,
name|VarBaseDevice
argument_list|,
sizeof|sizeof
name|ut
operator|.
name|ut_line
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ut
operator|.
name|ut_line
index|[
sizeof|sizeof
name|ut
operator|.
name|ut_line
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|logout
argument_list|(
name|ut
operator|.
name|ut_line
argument_list|)
condition|)
name|logwtmp
argument_list|(
name|ut
operator|.
name|ut_line
argument_list|,
literal|""
argument_list|,
literal|""
argument_list|)
expr_stmt|;
else|else
name|LogPrintf
argument_list|(
name|LogERROR
argument_list|,
literal|"CloseLogicalModem: No longer logged in on %s\n"
argument_list|,
name|ut
operator|.
name|ut_line
argument_list|)
expr_stmt|;
name|Utmp
operator|=
literal|0
expr_stmt|;
block|}
name|UnlockModem
argument_list|()
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Write to modem. Actualy, requested packets are queued, and goes out  * to the line when ModemStartOutput() is called.  */
end_comment

begin_function
name|void
name|WriteModem
parameter_list|(
name|int
name|pri
parameter_list|,
specifier|const
name|char
modifier|*
name|ptr
parameter_list|,
name|int
name|count
parameter_list|)
block|{
name|struct
name|mbuf
modifier|*
name|bp
decl_stmt|;
name|bp
operator|=
name|mballoc
argument_list|(
name|count
argument_list|,
name|MB_MODEM
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|MBUF_CTOP
argument_list|(
name|bp
argument_list|)
argument_list|,
name|ptr
argument_list|,
name|count
argument_list|)
expr_stmt|;
comment|/*    * Should be NORMAL and LINK only. All IP frames get here marked NORMAL.    */
name|Enqueue
argument_list|(
operator|&
name|OutputQueues
index|[
name|pri
index|]
argument_list|,
name|bp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ModemOutput
parameter_list|(
name|int
name|pri
parameter_list|,
name|struct
name|mbuf
modifier|*
name|bp
parameter_list|)
block|{
name|struct
name|mbuf
modifier|*
name|wp
decl_stmt|;
name|int
name|len
decl_stmt|;
name|len
operator|=
name|plength
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|wp
operator|=
name|mballoc
argument_list|(
name|len
argument_list|,
name|MB_MODEM
argument_list|)
expr_stmt|;
name|mbread
argument_list|(
name|bp
argument_list|,
name|MBUF_CTOP
argument_list|(
name|wp
argument_list|)
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|Enqueue
argument_list|(
operator|&
name|OutputQueues
index|[
name|pri
index|]
argument_list|,
name|wp
argument_list|)
expr_stmt|;
name|ModemStartOutput
argument_list|(
name|modem
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|ModemQlen
parameter_list|()
block|{
name|struct
name|mqueue
modifier|*
name|queue
decl_stmt|;
name|int
name|len
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
name|PRI_NORMAL
init|;
name|i
operator|<=
name|PRI_LINK
condition|;
name|i
operator|++
control|)
block|{
name|queue
operator|=
operator|&
name|OutputQueues
index|[
name|i
index|]
expr_stmt|;
name|len
operator|+=
name|queue
operator|->
name|qlen
expr_stmt|;
block|}
return|return
operator|(
name|len
operator|)
return|;
block|}
end_function

begin_function
name|void
name|ModemStartOutput
parameter_list|(
name|int
name|fd
parameter_list|)
block|{
name|struct
name|mqueue
modifier|*
name|queue
decl_stmt|;
name|int
name|nb
decl_stmt|,
name|nw
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|modemout
operator|==
name|NULL
operator|&&
name|ModemQlen
argument_list|()
operator|==
literal|0
condition|)
name|IpStartOutput
argument_list|()
expr_stmt|;
if|if
condition|(
name|modemout
operator|==
name|NULL
condition|)
block|{
name|i
operator|=
name|PRI_LINK
expr_stmt|;
for|for
control|(
name|queue
operator|=
operator|&
name|OutputQueues
index|[
name|PRI_LINK
index|]
init|;
name|queue
operator|>=
name|OutputQueues
condition|;
name|queue
operator|--
control|)
block|{
if|if
condition|(
name|queue
operator|->
name|top
condition|)
block|{
name|modemout
operator|=
name|Dequeue
argument_list|(
name|queue
argument_list|)
expr_stmt|;
if|if
condition|(
name|LogIsKept
argument_list|(
name|LogDEBUG
argument_list|)
condition|)
block|{
if|if
condition|(
name|i
operator|>
name|PRI_NORMAL
condition|)
block|{
name|struct
name|mqueue
modifier|*
name|q
decl_stmt|;
name|q
operator|=
operator|&
name|OutputQueues
index|[
literal|0
index|]
expr_stmt|;
name|LogPrintf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"ModemStartOutput: Output from queue %d,"
literal|" normal has %d\n"
argument_list|,
name|i
argument_list|,
name|q
operator|->
name|qlen
argument_list|)
expr_stmt|;
block|}
name|LogPrintf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"ModemStartOutput: Dequeued %d\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
name|i
operator|--
expr_stmt|;
block|}
block|}
if|if
condition|(
name|modemout
condition|)
block|{
name|nb
operator|=
name|modemout
operator|->
name|cnt
expr_stmt|;
if|if
condition|(
name|nb
operator|>
literal|1600
condition|)
name|nb
operator|=
literal|1600
expr_stmt|;
name|nw
operator|=
name|write
argument_list|(
name|fd
argument_list|,
name|MBUF_CTOP
argument_list|(
name|modemout
argument_list|)
argument_list|,
name|nb
argument_list|)
expr_stmt|;
name|LogPrintf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"ModemStartOutput: wrote: %d(%d)\n"
argument_list|,
name|nw
argument_list|,
name|nb
argument_list|)
expr_stmt|;
name|LogDumpBuff
argument_list|(
name|LogDEBUG
argument_list|,
literal|"ModemStartOutput: modem write"
argument_list|,
name|MBUF_CTOP
argument_list|(
name|modemout
argument_list|)
argument_list|,
name|nb
argument_list|)
expr_stmt|;
if|if
condition|(
name|nw
operator|>
literal|0
condition|)
block|{
name|modemout
operator|->
name|cnt
operator|-=
name|nw
expr_stmt|;
name|modemout
operator|->
name|offset
operator|+=
name|nw
expr_stmt|;
if|if
condition|(
name|modemout
operator|->
name|cnt
operator|==
literal|0
condition|)
block|{
name|modemout
operator|=
name|mbfree
argument_list|(
name|modemout
argument_list|)
expr_stmt|;
name|LogPrintf
argument_list|(
name|LogDEBUG
argument_list|,
literal|"ModemStartOutput: mbfree\n"
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|nw
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|errno
operator|!=
name|EAGAIN
condition|)
block|{
name|LogPrintf
argument_list|(
name|LogERROR
argument_list|,
literal|"modem write (%d): %s\n"
argument_list|,
name|modem
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|reconnect
argument_list|(
name|RECON_TRUE
argument_list|)
expr_stmt|;
name|DownConnection
argument_list|()
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_function
name|int
name|DialModem
parameter_list|()
block|{
name|char
name|ScriptBuffer
index|[
name|SCRIPT_LEN
index|]
decl_stmt|;
name|int
name|excode
decl_stmt|;
name|strncpy
argument_list|(
name|ScriptBuffer
argument_list|,
name|VarDialScript
argument_list|,
sizeof|sizeof
name|ScriptBuffer
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ScriptBuffer
index|[
sizeof|sizeof
name|ScriptBuffer
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|(
name|excode
operator|=
name|DoChat
argument_list|(
name|ScriptBuffer
argument_list|)
operator|)
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|VarTerm
condition|)
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"dial OK!\n"
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|ScriptBuffer
argument_list|,
name|VarLoginScript
argument_list|,
sizeof|sizeof
name|ScriptBuffer
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|excode
operator|=
name|DoChat
argument_list|(
name|ScriptBuffer
argument_list|)
operator|)
operator|>
literal|0
condition|)
block|{
name|VarAltPhone
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|VarTerm
condition|)
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"login OK!\n"
argument_list|)
expr_stmt|;
return|return
name|EX_DONE
return|;
block|}
elseif|else
if|if
condition|(
name|excode
operator|==
operator|-
literal|1
condition|)
name|excode
operator|=
name|EX_SIG
expr_stmt|;
else|else
block|{
name|LogPrintf
argument_list|(
name|LogWARN
argument_list|,
literal|"DialModem: login failed.\n"
argument_list|)
expr_stmt|;
name|excode
operator|=
name|EX_NOLOGIN
expr_stmt|;
block|}
name|ModemTimeout
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
comment|/* Dummy call to check modem status */
block|}
elseif|else
if|if
condition|(
name|excode
operator|==
operator|-
literal|1
condition|)
name|excode
operator|=
name|EX_SIG
expr_stmt|;
else|else
block|{
name|LogPrintf
argument_list|(
name|LogWARN
argument_list|,
literal|"DialModem: dial failed.\n"
argument_list|)
expr_stmt|;
name|excode
operator|=
name|EX_NODIAL
expr_stmt|;
block|}
name|HangupModem
argument_list|(
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|excode
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ShowModemStatus
parameter_list|(
name|struct
name|cmdargs
specifier|const
modifier|*
name|arg
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|dev
decl_stmt|;
ifdef|#
directive|ifdef
name|TIOCOUTQ
name|int
name|nb
decl_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|VarTerm
condition|)
return|return
literal|1
return|;
name|dev
operator|=
operator|*
name|VarDevice
condition|?
name|VarDevice
else|:
literal|"network"
expr_stmt|;
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"device: %s  speed: "
argument_list|,
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|DEV_IS_SYNC
condition|)
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"sync\n"
argument_list|)
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"%d\n"
argument_list|,
name|VarSpeed
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|VarParity
operator|&
name|CSIZE
condition|)
block|{
case|case
name|CS7
case|:
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"cs7, "
argument_list|)
expr_stmt|;
break|break;
case|case
name|CS8
case|:
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"cs8, "
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|VarParity
operator|&
name|PARENB
condition|)
block|{
if|if
condition|(
name|VarParity
operator|&
name|PARODD
condition|)
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"odd parity, "
argument_list|)
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"even parity, "
argument_list|)
expr_stmt|;
block|}
else|else
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"no parity, "
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"CTS/RTS %s.\n"
argument_list|,
operator|(
name|VarCtsRts
condition|?
literal|"on"
else|:
literal|"off"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|LogIsKept
argument_list|(
name|LogDEBUG
argument_list|)
condition|)
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"fd = %d, modem control = %o\n"
argument_list|,
name|modem
argument_list|,
name|mbits
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"connect count: %d\n"
argument_list|,
name|connect_count
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|TIOCOUTQ
if|if
condition|(
name|modem
operator|>=
literal|0
condition|)
if|if
condition|(
name|ioctl
argument_list|(
name|modem
argument_list|,
name|TIOCOUTQ
argument_list|,
operator|&
name|nb
argument_list|)
operator|>=
literal|0
condition|)
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"outq: %d\n"
argument_list|,
name|nb
argument_list|)
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"outq: ioctl probe failed: %s\n"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"outqlen: %d\n"
argument_list|,
name|ModemQlen
argument_list|()
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"DialScript  = %s\n"
argument_list|,
name|VarDialScript
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"LoginScript = %s\n"
argument_list|,
name|VarLoginScript
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"PhoneNumber(s) = %s\n"
argument_list|,
name|VarPhoneList
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|VarTerm
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|throughput_disp
argument_list|(
operator|&
name|throughput
argument_list|,
name|VarTerm
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


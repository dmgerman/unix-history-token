begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 1997 Brian Somers<brian@Awfulhak.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<termios.h>
end_include

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_include
include|#
directive|include
file|"log.h"
end_include

begin_include
include|#
directive|include
file|"timer.h"
end_include

begin_include
include|#
directive|include
file|"throughput.h"
end_include

begin_include
include|#
directive|include
file|"descriptor.h"
end_include

begin_include
include|#
directive|include
file|"prompt.h"
end_include

begin_function
name|void
name|throughput_init
parameter_list|(
name|struct
name|pppThroughput
modifier|*
name|t
parameter_list|,
name|int
name|period
parameter_list|)
block|{
name|t
operator|->
name|OctetsIn
operator|=
name|t
operator|->
name|OctetsOut
operator|=
name|t
operator|->
name|PacketsIn
operator|=
name|t
operator|->
name|PacketsOut
operator|=
literal|0
expr_stmt|;
name|t
operator|->
name|SamplePeriod
operator|=
name|period
expr_stmt|;
name|t
operator|->
name|in
operator|.
name|SampleOctets
operator|=
operator|(
name|long
name|long
operator|*
operator|)
name|calloc
argument_list|(
name|period
argument_list|,
sizeof|sizeof
expr|*
name|t
operator|->
name|in
operator|.
name|SampleOctets
argument_list|)
expr_stmt|;
name|t
operator|->
name|in
operator|.
name|OctetsPerSecond
operator|=
literal|0
expr_stmt|;
name|t
operator|->
name|out
operator|.
name|SampleOctets
operator|=
operator|(
name|long
name|long
operator|*
operator|)
name|calloc
argument_list|(
name|period
argument_list|,
sizeof|sizeof
expr|*
name|t
operator|->
name|out
operator|.
name|SampleOctets
argument_list|)
expr_stmt|;
name|t
operator|->
name|out
operator|.
name|OctetsPerSecond
operator|=
literal|0
expr_stmt|;
name|t
operator|->
name|BestOctetsPerSecond
operator|=
literal|0
expr_stmt|;
name|t
operator|->
name|nSample
operator|=
literal|0
expr_stmt|;
name|time
argument_list|(
operator|&
name|t
operator|->
name|BestOctetsPerSecondTime
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|t
operator|->
name|Timer
argument_list|,
literal|'\0'
argument_list|,
sizeof|sizeof
name|t
operator|->
name|Timer
argument_list|)
expr_stmt|;
name|t
operator|->
name|Timer
operator|.
name|name
operator|=
literal|"throughput"
expr_stmt|;
name|t
operator|->
name|uptime
operator|=
literal|0
expr_stmt|;
name|t
operator|->
name|downtime
operator|=
literal|0
expr_stmt|;
name|t
operator|->
name|rolling
operator|=
literal|0
expr_stmt|;
name|t
operator|->
name|callback
operator|.
name|data
operator|=
name|NULL
expr_stmt|;
name|t
operator|->
name|callback
operator|.
name|fn
operator|=
name|NULL
expr_stmt|;
name|throughput_stop
argument_list|(
name|t
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|throughput_destroy
parameter_list|(
name|struct
name|pppThroughput
modifier|*
name|t
parameter_list|)
block|{
if|if
condition|(
name|t
operator|&&
name|t
operator|->
name|in
operator|.
name|SampleOctets
condition|)
block|{
name|throughput_stop
argument_list|(
name|t
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|t
operator|->
name|in
operator|.
name|SampleOctets
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|t
operator|->
name|out
operator|.
name|SampleOctets
argument_list|)
expr_stmt|;
name|t
operator|->
name|in
operator|.
name|SampleOctets
operator|=
name|NULL
expr_stmt|;
name|t
operator|->
name|out
operator|.
name|SampleOctets
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|throughput_uptime
parameter_list|(
name|struct
name|pppThroughput
modifier|*
name|t
parameter_list|)
block|{
name|time_t
name|downat
decl_stmt|;
name|downat
operator|=
name|t
operator|->
name|downtime
condition|?
name|t
operator|->
name|downtime
else|:
name|time
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|->
name|uptime
operator|&&
name|downat
operator|<
name|t
operator|->
name|uptime
condition|)
block|{
comment|/* Euch !  The clock's gone back ! */
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|t
operator|->
name|SamplePeriod
condition|;
name|i
operator|++
control|)
name|t
operator|->
name|in
operator|.
name|SampleOctets
index|[
name|i
index|]
operator|=
name|t
operator|->
name|out
operator|.
name|SampleOctets
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|t
operator|->
name|nSample
operator|=
literal|0
expr_stmt|;
name|t
operator|->
name|uptime
operator|=
name|downat
expr_stmt|;
block|}
return|return
name|t
operator|->
name|uptime
condition|?
name|downat
operator|-
name|t
operator|->
name|uptime
else|:
literal|0
return|;
block|}
end_function

begin_function
name|void
name|throughput_disp
parameter_list|(
name|struct
name|pppThroughput
modifier|*
name|t
parameter_list|,
name|struct
name|prompt
modifier|*
name|prompt
parameter_list|)
block|{
name|int
name|secs_up
decl_stmt|,
name|divisor
decl_stmt|;
name|secs_up
operator|=
name|throughput_uptime
argument_list|(
name|t
argument_list|)
expr_stmt|;
name|prompt_Printf
argument_list|(
name|prompt
argument_list|,
literal|"Connect time: %d:%02d:%02d"
argument_list|,
name|secs_up
operator|/
literal|3600
argument_list|,
operator|(
name|secs_up
operator|/
literal|60
operator|)
operator|%
literal|60
argument_list|,
name|secs_up
operator|%
literal|60
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|->
name|downtime
condition|)
name|prompt_Printf
argument_list|(
name|prompt
argument_list|,
literal|" - down at %s"
argument_list|,
name|ctime
argument_list|(
operator|&
name|t
operator|->
name|downtime
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|prompt_Printf
argument_list|(
name|prompt
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|divisor
operator|=
name|secs_up
condition|?
name|secs_up
else|:
literal|1
expr_stmt|;
name|prompt_Printf
argument_list|(
name|prompt
argument_list|,
literal|"%llu octets in, %llu octets out\n"
argument_list|,
name|t
operator|->
name|OctetsIn
argument_list|,
name|t
operator|->
name|OctetsOut
argument_list|)
expr_stmt|;
name|prompt_Printf
argument_list|(
name|prompt
argument_list|,
literal|"%llu packets in, %llu packets out\n"
argument_list|,
name|t
operator|->
name|PacketsIn
argument_list|,
name|t
operator|->
name|PacketsOut
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|->
name|rolling
condition|)
block|{
name|prompt_Printf
argument_list|(
name|prompt
argument_list|,
literal|"  overall   %6qu bytes/sec\n"
argument_list|,
operator|(
name|t
operator|->
name|OctetsIn
operator|+
name|t
operator|->
name|OctetsOut
operator|)
operator|/
name|divisor
argument_list|)
expr_stmt|;
name|prompt_Printf
argument_list|(
name|prompt
argument_list|,
literal|"  %s %6qu bytes/sec in, %6qu bytes/sec out "
literal|"(over the last %d secs)\n"
argument_list|,
name|t
operator|->
name|downtime
condition|?
literal|"average  "
else|:
literal|"currently"
argument_list|,
name|t
operator|->
name|in
operator|.
name|OctetsPerSecond
argument_list|,
name|t
operator|->
name|out
operator|.
name|OctetsPerSecond
argument_list|,
name|secs_up
operator|>
name|t
operator|->
name|SamplePeriod
condition|?
name|t
operator|->
name|SamplePeriod
else|:
name|secs_up
argument_list|)
expr_stmt|;
name|prompt_Printf
argument_list|(
name|prompt
argument_list|,
literal|"  peak      %6qu bytes/sec on %s"
argument_list|,
name|t
operator|->
name|BestOctetsPerSecond
argument_list|,
name|ctime
argument_list|(
operator|&
name|t
operator|->
name|BestOctetsPerSecondTime
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|prompt_Printf
argument_list|(
name|prompt
argument_list|,
literal|"Overall %llu bytes/sec\n"
argument_list|,
operator|(
name|t
operator|->
name|OctetsIn
operator|+
name|t
operator|->
name|OctetsOut
operator|)
operator|/
name|divisor
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|throughput_log
parameter_list|(
name|struct
name|pppThroughput
modifier|*
name|t
parameter_list|,
name|int
name|level
parameter_list|,
specifier|const
name|char
modifier|*
name|title
parameter_list|)
block|{
if|if
condition|(
name|t
operator|->
name|uptime
condition|)
block|{
name|int
name|secs_up
decl_stmt|;
name|secs_up
operator|=
name|throughput_uptime
argument_list|(
name|t
argument_list|)
expr_stmt|;
if|if
condition|(
name|title
operator|==
name|NULL
condition|)
name|title
operator|=
literal|""
expr_stmt|;
name|log_Printf
argument_list|(
name|level
argument_list|,
literal|"%s%sConnect time: %d secs: %llu octets in, %llu octets"
literal|" out\n"
argument_list|,
name|title
argument_list|,
operator|*
name|title
condition|?
literal|": "
else|:
literal|""
argument_list|,
name|secs_up
argument_list|,
name|t
operator|->
name|OctetsIn
argument_list|,
name|t
operator|->
name|OctetsOut
argument_list|)
expr_stmt|;
name|log_Printf
argument_list|(
name|level
argument_list|,
literal|"%s%s: %llu packets in, %llu packets out\n"
argument_list|,
name|title
argument_list|,
operator|*
name|title
condition|?
literal|": "
else|:
literal|""
argument_list|,
name|t
operator|->
name|PacketsIn
argument_list|,
name|t
operator|->
name|PacketsOut
argument_list|)
expr_stmt|;
if|if
condition|(
name|secs_up
operator|==
literal|0
condition|)
name|secs_up
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|t
operator|->
name|rolling
condition|)
name|log_Printf
argument_list|(
name|level
argument_list|,
literal|" total %llu bytes/sec, peak %llu bytes/sec on %s"
argument_list|,
operator|(
name|t
operator|->
name|OctetsIn
operator|+
name|t
operator|->
name|OctetsOut
operator|)
operator|/
name|secs_up
argument_list|,
name|t
operator|->
name|BestOctetsPerSecond
argument_list|,
name|ctime
argument_list|(
operator|&
name|t
operator|->
name|BestOctetsPerSecondTime
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|log_Printf
argument_list|(
name|level
argument_list|,
literal|" total %llu bytes/sec\n"
argument_list|,
operator|(
name|t
operator|->
name|OctetsIn
operator|+
name|t
operator|->
name|OctetsOut
operator|)
operator|/
name|secs_up
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|throughput_sampler
parameter_list|(
name|void
modifier|*
name|v
parameter_list|)
block|{
name|struct
name|pppThroughput
modifier|*
name|t
init|=
operator|(
expr|struct
name|pppThroughput
operator|*
operator|)
name|v
decl_stmt|;
name|unsigned
name|long
name|long
name|old
decl_stmt|;
name|int
name|uptime
decl_stmt|,
name|divisor
decl_stmt|;
name|unsigned
name|long
name|long
name|octets
decl_stmt|;
name|timer_Stop
argument_list|(
operator|&
name|t
operator|->
name|Timer
argument_list|)
expr_stmt|;
name|uptime
operator|=
name|throughput_uptime
argument_list|(
name|t
argument_list|)
expr_stmt|;
name|divisor
operator|=
name|uptime
operator|<
name|t
operator|->
name|SamplePeriod
condition|?
name|uptime
operator|+
literal|1
else|:
name|t
operator|->
name|SamplePeriod
expr_stmt|;
name|old
operator|=
name|t
operator|->
name|in
operator|.
name|SampleOctets
index|[
name|t
operator|->
name|nSample
index|]
expr_stmt|;
name|t
operator|->
name|in
operator|.
name|SampleOctets
index|[
name|t
operator|->
name|nSample
index|]
operator|=
name|t
operator|->
name|OctetsIn
expr_stmt|;
name|t
operator|->
name|in
operator|.
name|OctetsPerSecond
operator|=
operator|(
name|t
operator|->
name|in
operator|.
name|SampleOctets
index|[
name|t
operator|->
name|nSample
index|]
operator|-
name|old
operator|)
operator|/
name|divisor
expr_stmt|;
name|old
operator|=
name|t
operator|->
name|out
operator|.
name|SampleOctets
index|[
name|t
operator|->
name|nSample
index|]
expr_stmt|;
name|t
operator|->
name|out
operator|.
name|SampleOctets
index|[
name|t
operator|->
name|nSample
index|]
operator|=
name|t
operator|->
name|OctetsOut
expr_stmt|;
name|t
operator|->
name|out
operator|.
name|OctetsPerSecond
operator|=
operator|(
name|t
operator|->
name|out
operator|.
name|SampleOctets
index|[
name|t
operator|->
name|nSample
index|]
operator|-
name|old
operator|)
operator|/
name|divisor
expr_stmt|;
name|octets
operator|=
name|t
operator|->
name|in
operator|.
name|OctetsPerSecond
operator|+
name|t
operator|->
name|out
operator|.
name|OctetsPerSecond
expr_stmt|;
if|if
condition|(
name|t
operator|->
name|BestOctetsPerSecond
operator|<
name|octets
condition|)
block|{
name|t
operator|->
name|BestOctetsPerSecond
operator|=
name|octets
expr_stmt|;
name|time
argument_list|(
operator|&
name|t
operator|->
name|BestOctetsPerSecondTime
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|++
name|t
operator|->
name|nSample
operator|==
name|t
operator|->
name|SamplePeriod
condition|)
name|t
operator|->
name|nSample
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|t
operator|->
name|callback
operator|.
name|fn
operator|!=
name|NULL
operator|&&
name|uptime
operator|>=
name|t
operator|->
name|SamplePeriod
condition|)
call|(
modifier|*
name|t
operator|->
name|callback
operator|.
name|fn
call|)
argument_list|(
name|t
operator|->
name|callback
operator|.
name|data
argument_list|)
expr_stmt|;
name|timer_Start
argument_list|(
operator|&
name|t
operator|->
name|Timer
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|throughput_start
parameter_list|(
name|struct
name|pppThroughput
modifier|*
name|t
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|int
name|rolling
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|timer_Stop
argument_list|(
operator|&
name|t
operator|->
name|Timer
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|t
operator|->
name|SamplePeriod
condition|;
name|i
operator|++
control|)
name|t
operator|->
name|in
operator|.
name|SampleOctets
index|[
name|i
index|]
operator|=
name|t
operator|->
name|out
operator|.
name|SampleOctets
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|t
operator|->
name|nSample
operator|=
literal|0
expr_stmt|;
name|t
operator|->
name|OctetsIn
operator|=
name|t
operator|->
name|OctetsOut
operator|=
literal|0
expr_stmt|;
name|t
operator|->
name|in
operator|.
name|OctetsPerSecond
operator|=
name|t
operator|->
name|out
operator|.
name|OctetsPerSecond
operator|=
name|t
operator|->
name|BestOctetsPerSecond
operator|=
literal|0
expr_stmt|;
name|time
argument_list|(
operator|&
name|t
operator|->
name|BestOctetsPerSecondTime
argument_list|)
expr_stmt|;
name|t
operator|->
name|downtime
operator|=
literal|0
expr_stmt|;
name|time
argument_list|(
operator|&
name|t
operator|->
name|uptime
argument_list|)
expr_stmt|;
name|throughput_restart
argument_list|(
name|t
argument_list|,
name|name
argument_list|,
name|rolling
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|throughput_restart
parameter_list|(
name|struct
name|pppThroughput
modifier|*
name|t
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|int
name|rolling
parameter_list|)
block|{
name|timer_Stop
argument_list|(
operator|&
name|t
operator|->
name|Timer
argument_list|)
expr_stmt|;
name|t
operator|->
name|rolling
operator|=
name|rolling
condition|?
literal|1
else|:
literal|0
expr_stmt|;
if|if
condition|(
name|t
operator|->
name|rolling
condition|)
block|{
name|t
operator|->
name|Timer
operator|.
name|load
operator|=
name|SECTICKS
expr_stmt|;
name|t
operator|->
name|Timer
operator|.
name|func
operator|=
name|throughput_sampler
expr_stmt|;
name|t
operator|->
name|Timer
operator|.
name|name
operator|=
name|name
expr_stmt|;
name|t
operator|->
name|Timer
operator|.
name|arg
operator|=
name|t
expr_stmt|;
name|timer_Start
argument_list|(
operator|&
name|t
operator|->
name|Timer
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|t
operator|->
name|Timer
operator|.
name|load
operator|=
literal|0
expr_stmt|;
name|t
operator|->
name|Timer
operator|.
name|func
operator|=
name|NULL
expr_stmt|;
name|t
operator|->
name|Timer
operator|.
name|name
operator|=
name|NULL
expr_stmt|;
name|t
operator|->
name|Timer
operator|.
name|arg
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|throughput_stop
parameter_list|(
name|struct
name|pppThroughput
modifier|*
name|t
parameter_list|)
block|{
if|if
condition|(
name|t
operator|->
name|Timer
operator|.
name|state
operator|!=
name|TIMER_STOPPED
condition|)
name|time
argument_list|(
operator|&
name|t
operator|->
name|downtime
argument_list|)
expr_stmt|;
name|timer_Stop
argument_list|(
operator|&
name|t
operator|->
name|Timer
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|throughput_addin
parameter_list|(
name|struct
name|pppThroughput
modifier|*
name|t
parameter_list|,
name|long
name|long
name|n
parameter_list|)
block|{
name|t
operator|->
name|OctetsIn
operator|+=
name|n
expr_stmt|;
name|t
operator|->
name|PacketsIn
operator|++
expr_stmt|;
block|}
end_function

begin_function
name|void
name|throughput_addout
parameter_list|(
name|struct
name|pppThroughput
modifier|*
name|t
parameter_list|,
name|long
name|long
name|n
parameter_list|)
block|{
name|t
operator|->
name|OctetsOut
operator|+=
name|n
expr_stmt|;
name|t
operator|->
name|PacketsOut
operator|++
expr_stmt|;
block|}
end_function

begin_function
name|void
name|throughput_clear
parameter_list|(
name|struct
name|pppThroughput
modifier|*
name|t
parameter_list|,
name|int
name|clear_type
parameter_list|,
name|struct
name|prompt
modifier|*
name|prompt
parameter_list|)
block|{
if|if
condition|(
name|clear_type
operator|&
operator|(
name|THROUGHPUT_OVERALL
operator||
name|THROUGHPUT_CURRENT
operator|)
condition|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|t
operator|->
name|SamplePeriod
condition|;
name|i
operator|++
control|)
name|t
operator|->
name|in
operator|.
name|SampleOctets
index|[
name|i
index|]
operator|=
name|t
operator|->
name|out
operator|.
name|SampleOctets
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|t
operator|->
name|nSample
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|clear_type
operator|&
name|THROUGHPUT_OVERALL
condition|)
block|{
name|int
name|divisor
decl_stmt|;
if|if
condition|(
operator|(
name|divisor
operator|=
name|throughput_uptime
argument_list|(
name|t
argument_list|)
operator|)
operator|==
literal|0
condition|)
name|divisor
operator|=
literal|1
expr_stmt|;
name|prompt_Printf
argument_list|(
name|prompt
argument_list|,
literal|"overall cleared (was %6qu bytes/sec)\n"
argument_list|,
operator|(
name|t
operator|->
name|OctetsIn
operator|+
name|t
operator|->
name|OctetsOut
operator|)
operator|/
name|divisor
argument_list|)
expr_stmt|;
name|t
operator|->
name|OctetsIn
operator|=
name|t
operator|->
name|OctetsOut
operator|=
literal|0
expr_stmt|;
name|t
operator|->
name|downtime
operator|=
literal|0
expr_stmt|;
name|time
argument_list|(
operator|&
name|t
operator|->
name|uptime
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|clear_type
operator|&
name|THROUGHPUT_CURRENT
condition|)
block|{
name|prompt_Printf
argument_list|(
name|prompt
argument_list|,
literal|"current cleared (was %6qu bytes/sec in,"
literal|" %6qu bytes/sec out)\n"
argument_list|,
name|t
operator|->
name|in
operator|.
name|OctetsPerSecond
argument_list|,
name|t
operator|->
name|out
operator|.
name|OctetsPerSecond
argument_list|)
expr_stmt|;
name|t
operator|->
name|in
operator|.
name|OctetsPerSecond
operator|=
name|t
operator|->
name|out
operator|.
name|OctetsPerSecond
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|clear_type
operator|&
name|THROUGHPUT_PEAK
condition|)
block|{
name|char
modifier|*
name|time_buf
decl_stmt|,
modifier|*
name|last
decl_stmt|;
name|time_buf
operator|=
name|ctime
argument_list|(
operator|&
name|t
operator|->
name|BestOctetsPerSecondTime
argument_list|)
expr_stmt|;
name|last
operator|=
name|time_buf
operator|+
name|strlen
argument_list|(
name|time_buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|last
operator|>
name|time_buf
operator|&&
operator|*
operator|--
name|last
operator|==
literal|'\n'
condition|)
operator|*
name|last
operator|=
literal|'\0'
expr_stmt|;
name|prompt_Printf
argument_list|(
name|prompt
argument_list|,
literal|"peak    cleared (was %6qu bytes/sec on %s)\n"
argument_list|,
name|t
operator|->
name|BestOctetsPerSecond
argument_list|,
name|time_buf
argument_list|)
expr_stmt|;
name|t
operator|->
name|BestOctetsPerSecond
operator|=
literal|0
expr_stmt|;
name|time
argument_list|(
operator|&
name|t
operator|->
name|BestOctetsPerSecondTime
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|throughput_callback
parameter_list|(
name|struct
name|pppThroughput
modifier|*
name|t
parameter_list|,
name|void
function_decl|(
modifier|*
name|fn
function_decl|)
parameter_list|(
name|void
modifier|*
parameter_list|)
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|t
operator|->
name|callback
operator|.
name|fn
operator|=
name|fn
expr_stmt|;
name|t
operator|->
name|callback
operator|.
name|data
operator|=
name|data
expr_stmt|;
block|}
end_function

end_unit


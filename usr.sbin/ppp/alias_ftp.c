begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*     Alias_ftp.c performs special processing for FTP sessions under     TCP.  Specifically, when a PORT command from the client side     is sent, it is intercepted and modified.  The address is changed     to the gateway machine and an aliasing port is used.      For this routine to work, the PORT command must fit entirely     into a single TCP packet.  This is typically the case, but exceptions     can easily be envisioned under the actual specifications.      Probably the most troubling aspect of the approach taken here is     that the new PORT command will typically be a different length, and     this causes a certain amount of bookkeeping to keep track of the     changes of sequence and acknowledgment numbers, since the client     machine is totally unaware of the modification to the TCP stream.       This software is placed into the public domain with no restrictions     on its distribution.      Initial version:  August, 1996  (cjm) */
end_comment

begin_comment
comment|/* Includes */
end_comment

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_systm.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip.h>
end_include

begin_include
include|#
directive|include
file|<netinet/tcp.h>
end_include

begin_comment
comment|/* Constants */
end_comment

begin_define
define|#
directive|define
name|FTP_DATA_PORT_NUMBER
value|20
end_define

begin_comment
comment|/* Prototypes */
end_comment

begin_include
include|#
directive|include
file|"alias.p"
end_include

begin_function
name|void
name|HandleFtpOut
parameter_list|(
name|pip
parameter_list|,
name|link
parameter_list|)
name|struct
name|ip
modifier|*
name|pip
decl_stmt|;
name|char
modifier|*
name|link
decl_stmt|;
block|{
name|int
name|hlen
decl_stmt|,
name|tlen
decl_stmt|,
name|dlen
decl_stmt|;
name|struct
name|in_addr
name|true_addr
decl_stmt|;
name|u_short
name|true_port
decl_stmt|;
name|char
modifier|*
name|sptr
decl_stmt|;
name|struct
name|tcphdr
modifier|*
name|tc
decl_stmt|;
comment|/* Calculate data length of TCP packet */
name|tc
operator|=
operator|(
expr|struct
name|tcphdr
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|pip
operator|+
operator|(
name|pip
operator|->
name|ip_hl
operator|<<
literal|2
operator|)
operator|)
expr_stmt|;
name|hlen
operator|=
operator|(
name|pip
operator|->
name|ip_hl
operator|+
name|tc
operator|->
name|th_off
operator|)
operator|<<
literal|2
expr_stmt|;
name|tlen
operator|=
name|ntohs
argument_list|(
name|pip
operator|->
name|ip_len
argument_list|)
expr_stmt|;
name|dlen
operator|=
name|tlen
operator|-
name|hlen
expr_stmt|;
comment|/* Return is data length is too long or too short */
if|if
condition|(
name|dlen
operator|<
literal|10
operator|||
name|dlen
operator|>
literal|80
condition|)
return|return;
comment|/* Place string pointer and beginning of data */
name|sptr
operator|=
operator|(
name|char
operator|*
operator|)
name|pip
expr_stmt|;
name|sptr
operator|+=
name|hlen
expr_stmt|;
comment|/* Parse through string using state diagram method */
block|{
name|char
name|ch
decl_stmt|,
name|zero
decl_stmt|;
name|int
name|i
decl_stmt|,
name|state
decl_stmt|;
name|u_long
name|a1
decl_stmt|,
name|a2
decl_stmt|,
name|a3
decl_stmt|,
name|a4
decl_stmt|;
name|u_short
name|p1
decl_stmt|,
name|p2
decl_stmt|;
name|a1
operator|=
literal|0
expr_stmt|;
name|a2
operator|=
literal|0
expr_stmt|;
name|a3
operator|=
literal|0
expr_stmt|;
name|a4
operator|=
literal|0
expr_stmt|;
name|p1
operator|=
literal|0
expr_stmt|;
name|p2
operator|=
literal|0
expr_stmt|;
name|zero
operator|=
literal|'0'
expr_stmt|;
name|state
operator|=
operator|-
literal|4
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dlen
condition|;
name|i
operator|++
control|)
block|{
name|ch
operator|=
name|sptr
index|[
name|i
index|]
expr_stmt|;
switch|switch
condition|(
name|state
condition|)
block|{
case|case
operator|-
literal|4
case|:
if|if
condition|(
name|ch
operator|==
literal|'P'
condition|)
name|state
operator|=
operator|-
literal|3
expr_stmt|;
else|else
return|return;
break|break;
case|case
operator|-
literal|3
case|:
if|if
condition|(
name|ch
operator|==
literal|'O'
condition|)
name|state
operator|=
operator|-
literal|2
expr_stmt|;
else|else
return|return;
break|break;
case|case
operator|-
literal|2
case|:
if|if
condition|(
name|ch
operator|==
literal|'R'
condition|)
name|state
operator|=
operator|-
literal|1
expr_stmt|;
else|else
return|return;
break|break;
case|case
operator|-
literal|1
case|:
if|if
condition|(
name|ch
operator|==
literal|'T'
condition|)
name|state
operator|=
literal|0
expr_stmt|;
else|else
return|return;
break|break;
case|case
literal|0
case|:
if|if
condition|(
name|isdigit
argument_list|(
name|ch
argument_list|)
condition|)
block|{
name|a1
operator|=
name|ch
operator|-
name|zero
expr_stmt|;
name|state
operator|=
literal|1
expr_stmt|;
block|}
break|break;
case|case
literal|1
case|:
if|if
condition|(
name|isdigit
argument_list|(
name|ch
argument_list|)
condition|)
name|a1
operator|=
literal|10
operator|*
name|a1
operator|+
name|ch
operator|-
name|zero
expr_stmt|;
else|else
name|state
operator|=
literal|2
expr_stmt|;
break|break;
case|case
literal|2
case|:
if|if
condition|(
name|isdigit
argument_list|(
name|ch
argument_list|)
condition|)
block|{
name|a2
operator|=
name|ch
operator|-
name|zero
expr_stmt|;
name|state
operator|=
literal|3
expr_stmt|;
block|}
break|break;
case|case
literal|3
case|:
if|if
condition|(
name|isdigit
argument_list|(
name|ch
argument_list|)
condition|)
name|a2
operator|=
literal|10
operator|*
name|a2
operator|+
name|ch
operator|-
name|zero
expr_stmt|;
else|else
name|state
operator|=
literal|4
expr_stmt|;
break|break;
case|case
literal|4
case|:
if|if
condition|(
name|isdigit
argument_list|(
name|ch
argument_list|)
condition|)
block|{
name|a3
operator|=
name|ch
operator|-
name|zero
expr_stmt|;
name|state
operator|=
literal|5
expr_stmt|;
block|}
break|break;
case|case
literal|5
case|:
if|if
condition|(
name|isdigit
argument_list|(
name|ch
argument_list|)
condition|)
name|a3
operator|=
literal|10
operator|*
name|a3
operator|+
name|ch
operator|-
name|zero
expr_stmt|;
else|else
name|state
operator|=
literal|6
expr_stmt|;
break|break;
case|case
literal|6
case|:
if|if
condition|(
name|isdigit
argument_list|(
name|ch
argument_list|)
condition|)
block|{
name|a4
operator|=
name|ch
operator|-
name|zero
expr_stmt|;
name|state
operator|=
literal|7
expr_stmt|;
block|}
break|break;
case|case
literal|7
case|:
if|if
condition|(
name|isdigit
argument_list|(
name|ch
argument_list|)
condition|)
name|a4
operator|=
literal|10
operator|*
name|a4
operator|+
name|ch
operator|-
name|zero
expr_stmt|;
else|else
name|state
operator|=
literal|8
expr_stmt|;
break|break;
case|case
literal|8
case|:
if|if
condition|(
name|isdigit
argument_list|(
name|ch
argument_list|)
condition|)
block|{
name|p1
operator|=
name|ch
operator|-
name|zero
expr_stmt|;
name|state
operator|=
literal|9
expr_stmt|;
block|}
break|break;
case|case
literal|9
case|:
if|if
condition|(
name|isdigit
argument_list|(
name|ch
argument_list|)
condition|)
name|p1
operator|=
literal|10
operator|*
name|p1
operator|+
name|ch
operator|-
name|zero
expr_stmt|;
else|else
name|state
operator|=
literal|10
expr_stmt|;
break|break;
case|case
literal|10
case|:
if|if
condition|(
name|isdigit
argument_list|(
name|ch
argument_list|)
condition|)
block|{
name|p2
operator|=
name|ch
operator|-
name|zero
expr_stmt|;
name|state
operator|=
literal|11
expr_stmt|;
block|}
break|break;
case|case
literal|11
case|:
if|if
condition|(
name|isdigit
argument_list|(
name|ch
argument_list|)
condition|)
name|p2
operator|=
literal|10
operator|*
name|p2
operator|+
name|ch
operator|-
name|zero
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|state
operator|==
literal|11
condition|)
block|{
name|true_port
operator|=
name|htons
argument_list|(
operator|(
name|p1
operator|<<
literal|8
operator|)
operator|+
name|p2
argument_list|)
expr_stmt|;
name|true_addr
operator|.
name|s_addr
operator|=
name|htonl
argument_list|(
operator|(
name|a1
operator|<<
literal|24
operator|)
operator|+
operator|(
name|a2
operator|<<
literal|16
operator|)
operator|+
operator|(
name|a3
operator|<<
literal|8
operator|)
operator|+
name|a4
argument_list|)
expr_stmt|;
name|NewFtpPortCommand
argument_list|(
name|pip
argument_list|,
name|link
argument_list|,
name|true_addr
argument_list|,
name|true_port
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|void
name|NewFtpPortCommand
parameter_list|(
name|pip
parameter_list|,
name|link
parameter_list|,
name|true_addr
parameter_list|,
name|true_port
parameter_list|)
name|struct
name|ip
modifier|*
name|pip
decl_stmt|;
name|char
modifier|*
name|link
decl_stmt|;
name|struct
name|in_addr
name|true_addr
decl_stmt|;
name|u_short
name|true_port
decl_stmt|;
block|{
name|char
modifier|*
name|ftp_link
decl_stmt|;
comment|/* Establish link to address and port found in PORT command */
name|ftp_link
operator|=
name|FindTcpOut
argument_list|(
name|true_addr
argument_list|,
name|GetDestAddress
argument_list|(
name|link
argument_list|)
argument_list|,
name|true_port
argument_list|,
name|htons
argument_list|(
name|FTP_DATA_PORT_NUMBER
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ftp_link
operator|!=
name|NULL_PTR
condition|)
block|{
name|int
name|slen
decl_stmt|,
name|hlen
decl_stmt|,
name|tlen
decl_stmt|,
name|dlen
decl_stmt|;
name|struct
name|tcphdr
modifier|*
name|tc
decl_stmt|;
comment|/* Calculate data length of TCP packet */
name|tc
operator|=
operator|(
expr|struct
name|tcphdr
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|pip
operator|+
operator|(
name|pip
operator|->
name|ip_hl
operator|<<
literal|2
operator|)
operator|)
expr_stmt|;
name|hlen
operator|=
operator|(
name|pip
operator|->
name|ip_hl
operator|+
name|tc
operator|->
name|th_off
operator|)
operator|<<
literal|2
expr_stmt|;
name|tlen
operator|=
name|ntohs
argument_list|(
name|pip
operator|->
name|ip_len
argument_list|)
expr_stmt|;
name|dlen
operator|=
name|tlen
operator|-
name|hlen
expr_stmt|;
comment|/* Create new PORT command */
block|{
name|char
name|stemp
index|[
literal|80
index|]
decl_stmt|;
name|char
modifier|*
name|sptr
decl_stmt|;
name|u_short
name|alias_port
decl_stmt|;
name|u_char
modifier|*
name|ptr
decl_stmt|;
name|int
name|a1
decl_stmt|,
name|a2
decl_stmt|,
name|a3
decl_stmt|,
name|a4
decl_stmt|,
name|p1
decl_stmt|,
name|p2
decl_stmt|;
name|struct
name|in_addr
name|aliasAddress
decl_stmt|;
comment|/* Decompose alias address into quad format */
name|aliasAddress
operator|=
name|GetAliasAddress
argument_list|()
expr_stmt|;
name|ptr
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
name|aliasAddress
expr_stmt|;
name|a1
operator|=
operator|*
name|ptr
operator|++
expr_stmt|;
name|a2
operator|=
operator|*
name|ptr
operator|++
expr_stmt|;
name|a3
operator|=
operator|*
name|ptr
operator|++
expr_stmt|;
name|a4
operator|=
operator|*
name|ptr
expr_stmt|;
comment|/* Decompose alias port into pair format */
name|alias_port
operator|=
name|GetAliasPort
argument_list|(
name|ftp_link
argument_list|)
expr_stmt|;
name|ptr
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
name|alias_port
expr_stmt|;
name|p1
operator|=
operator|*
name|ptr
operator|++
expr_stmt|;
name|p2
operator|=
operator|*
name|ptr
expr_stmt|;
comment|/* Generate command string */
name|sprintf
argument_list|(
name|stemp
argument_list|,
literal|"PORT %d,%d,%d,%d,%d,%d\r\n"
argument_list|,
name|a1
argument_list|,
name|a2
argument_list|,
name|a3
argument_list|,
name|a4
argument_list|,
name|p1
argument_list|,
name|p2
argument_list|)
expr_stmt|;
comment|/* Save string length for IP header modification */
name|slen
operator|=
name|strlen
argument_list|(
name|stemp
argument_list|)
expr_stmt|;
comment|/* Copy into IP packet */
name|sptr
operator|=
operator|(
name|char
operator|*
operator|)
name|pip
expr_stmt|;
name|sptr
operator|+=
name|hlen
expr_stmt|;
name|strcpy
argument_list|(
name|sptr
argument_list|,
name|stemp
argument_list|)
expr_stmt|;
block|}
comment|/* Save information regarding modified seq and ack numbers */
block|{
name|int
name|delta
decl_stmt|;
name|SetAckModified
argument_list|(
name|link
argument_list|)
expr_stmt|;
name|delta
operator|=
name|GetDeltaSeqOut
argument_list|(
name|pip
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|AddSeq
argument_list|(
name|pip
argument_list|,
name|link
argument_list|,
name|delta
operator|+
name|slen
operator|-
name|dlen
argument_list|)
expr_stmt|;
name|pip
operator|->
name|ip_len
operator|=
name|ntohs
argument_list|(
name|hlen
operator|+
name|slen
argument_list|)
expr_stmt|;
block|}
comment|/* Compute TCP checksum for revised packet */
name|tc
operator|->
name|th_sum
operator|=
literal|0
expr_stmt|;
name|tc
operator|->
name|th_sum
operator|=
name|TcpChecksum
argument_list|(
name|pip
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"PacketAlias/HandleFtpOut: Cannot allocate FTP data port\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

end_unit


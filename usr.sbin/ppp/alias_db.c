begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*     Alias_db.c encapsulates all data structures used for storing     packet aliasing data.  Other parts of the aliasing software     access data through functions provided in this file.      Data storage is based on the notion of a "link", which is     established for ICMP echo/reply packets, UDP datagrams and     TCP stream connections.  A link stores the original source     and destination addresses.  For UDP and TCP, it also stores     source and destination port numbers, as well as an alias     port number.      There is a facility for sweeping through and deleting old     links as new packets are sent through.  A simple timeout is     used for ICMP and UDP links.  TCP links are left alone unless     there is an incomplete connection, in which case the link     can be deleted after a certain amount of time.  TCP links which     properly close are deleted by a function call to DeleteLink()     from alias.c.       This software is placed into the public domain with no restrictions     on its distribution.      Initial version: August, 1996  (cjm)      Version 1.4: September 16, 1996 (cjm)         Facility for handling incoming links added.      Version 1.6: September 18, 1996 (cjm)         ICMP data handling simplified. */
end_comment

begin_comment
comment|/* Include files */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_systm.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip.h>
end_include

begin_include
include|#
directive|include
file|<netinet/tcp.h>
end_include

begin_include
include|#
directive|include
file|<arpa/inet.h>
end_include

begin_include
include|#
directive|include
file|"defs.h"
end_include

begin_comment
comment|/* Constants */
end_comment

begin_define
define|#
directive|define
name|FTP_CONTROL_PORT_NUMBER
value|21
end_define

begin_define
define|#
directive|define
name|LINK_TABLE_SIZE
value|101
end_define

begin_define
define|#
directive|define
name|LINK_ICMP
value|1
end_define

begin_define
define|#
directive|define
name|LINK_UDP
value|2
end_define

begin_define
define|#
directive|define
name|LINK_TCP
value|3
end_define

begin_define
define|#
directive|define
name|LINK_FRAGMENT_ID
value|4
end_define

begin_define
define|#
directive|define
name|N_LINK_ICMP_DATA
value|20
end_define

begin_define
define|#
directive|define
name|N_LINK_ID_DATA
value|20
end_define

begin_define
define|#
directive|define
name|N_LINK_TCP_DATA
value|20
end_define

begin_define
define|#
directive|define
name|ICMP_EXPIRE_TIME
value|60
end_define

begin_define
define|#
directive|define
name|UDP_EXPIRE_TIME
value|60
end_define

begin_define
define|#
directive|define
name|TCP_EXPIRE_TIME
value|60
end_define

begin_define
define|#
directive|define
name|FRAGMENT_EXPIRE_TIME
value|60
end_define

begin_define
define|#
directive|define
name|ALIAS_PORT_BASE
value|30000
end_define

begin_define
define|#
directive|define
name|ALIAS_PORT_MASK
value|0x7fff
end_define

begin_define
define|#
directive|define
name|ALIAS_PORT_TABLE_SIZE
value|0x8000
end_define

begin_comment
comment|/* If MONITOR_ALIAS is defined, a message will be printed to /var/log/alias.log every time a link is created or deleted.  This is useful for debugging */
end_comment

begin_comment
comment|/* #define MONITOR_ALIAS */
end_comment

begin_comment
comment|/* If ALLOW_INCOMING is defined, then incoming connections (e.g. to ftp, telnet or web servers will be handled.  Otherwise, these types of connections will be prevented by the aliasing mechanism. */
end_comment

begin_define
define|#
directive|define
name|ALLOW_INCOMING
end_define

begin_comment
comment|/* Data Structures       The fundamental data structure used in this program is     "struct link_record".  Whenever a TCP connection is made,     a UDP datagram is sent out, or an ICMP echo request is made,     a link record is made (if it has not already been created).      The link record is identified by the source address/port     and the destination address/port. In the case of an ICMP     echo request, which has no port numbers, these fields are     set to zero.      The link record also can store some auxiliary data.  For ICMP     echo requests, there is space allocated to save id and sequence     numbers.  For tcp connections that have had sequence and     acknowledgment modifications, data space is available to     track these changes.  A state field is used to keep track in     changes to the tcp connection state.  Id numbers of fragments     can also be stored in the auxiliary space.      The link records are chained together and initially referenced     from a table in order to shorten lookup time. */
end_comment

begin_struct
struct|struct
name|id_data_record
comment|/* used to save data about ip fragments */
block|{
name|u_short
name|id
decl_stmt|;
name|u_char
name|protocol
decl_stmt|;
name|struct
name|in_addr
name|src_addr
decl_stmt|;
name|int
name|active
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|id_dat
block|{
name|int
name|index
decl_stmt|;
name|struct
name|id_data_record
name|data
index|[
name|N_LINK_ID_DATA
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|ack_data_record
comment|/* used to save changes to ack/seq numbers */
block|{
name|u_long
name|ack_old
decl_stmt|;
name|u_long
name|ack_new
decl_stmt|;
name|int
name|delta
decl_stmt|;
name|int
name|active
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|tcp_state
comment|/* Information about tcp connection */
block|{
name|int
name|in
decl_stmt|;
comment|/* State for outside -> inside  */
name|int
name|out
decl_stmt|;
comment|/* State for inside  -> outside */
name|int
name|index
decl_stmt|;
comment|/* Index to ack data array */
name|int
name|ack_modified
decl_stmt|;
comment|/* Indicates whether ack and seq numbers have                               been modified */
block|}
struct|;
end_struct

begin_struct
struct|struct
name|tcp_dat
block|{
name|struct
name|tcp_state
name|state
decl_stmt|;
name|struct
name|ack_data_record
name|ack
index|[
name|N_LINK_TCP_DATA
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|link_record
comment|/* Main data structure */
block|{
name|struct
name|in_addr
name|src_addr
decl_stmt|;
name|struct
name|in_addr
name|dst_addr
decl_stmt|;
name|u_short
name|src_port
decl_stmt|;
name|u_short
name|dst_port
decl_stmt|;
name|u_short
name|alias_port
decl_stmt|;
name|long
name|timestamp
decl_stmt|;
name|int
name|passthrough
decl_stmt|;
comment|/* set to 1 if non-aliasing link */
name|int
name|link_type
decl_stmt|;
comment|/* Type of link: tcp, udp, icmp, frag */
name|int
name|table_index
decl_stmt|;
comment|/* Index number in lookup table */
name|int
name|socket
decl_stmt|;
comment|/* Socket used to bind alias port */
name|struct
name|link_record
modifier|*
name|next
decl_stmt|;
comment|/* Pointer to next data structure */
name|struct
name|link_record
modifier|*
name|last
decl_stmt|;
comment|/* Pointer to previous data structure */
union|union
comment|/* Auxiliary data */
block|{
name|struct
name|id_dat
modifier|*
name|id
decl_stmt|;
name|struct
name|tcp_dat
modifier|*
name|tcp
decl_stmt|;
block|}
name|data
union|;
block|}
struct|;
end_struct

begin_comment
comment|/* Function Prototypes */
end_comment

begin_include
include|#
directive|include
file|"alias.p"
end_include

begin_comment
comment|/* Global Variables       The global variables listed here are only accessed from     within alias_db.c.   */
end_comment

begin_decl_stmt
name|struct
name|in_addr
name|aliasAddress
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Address written onto source */
end_comment

begin_comment
comment|/*    field of IP packet.      */
end_comment

begin_decl_stmt
name|struct
name|link_record
modifier|*
name|linkTable
index|[
name|LINK_TABLE_SIZE
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Lookup table of pointers to */
end_comment

begin_comment
comment|/*   chains of link records.   */
end_comment

begin_decl_stmt
name|char
name|portTable
index|[
name|ALIAS_PORT_TABLE_SIZE
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Table showing which ports   */
end_comment

begin_comment
comment|/* are in use (no distinction  */
end_comment

begin_comment
comment|/* is made between TCP and UDP */
end_comment

begin_decl_stmt
name|u_short
name|alias_sequence
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* used for aliasing sequence numbers of */
end_comment

begin_comment
comment|/*   ICMP packets                        */
end_comment

begin_decl_stmt
name|int
name|icmpLinkCount
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Storage for link statistics */
end_comment

begin_decl_stmt
name|int
name|udpLinkCount
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|tcpLinkCount
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|fragmentLinkCount
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|cleanupIndex
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Index to chain of link table being */
end_comment

begin_comment
comment|/*   inspected for old links          */
end_comment

begin_decl_stmt
name|int
name|monitorAlias
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Debug variable (set to 1 when active) */
end_comment

begin_decl_stmt
name|FILE
modifier|*
name|monitorFile
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Internal utility routines (used only in alias_db.c)      StartPoint     -- find lookup table start point     GetNewPort     -- find and reserve new alias port number     SetTimestamp   -- save last access time     SeqDiff        -- difference between two TCP sequences */
end_comment

begin_function
name|int
name|StartPoint
parameter_list|(
name|dst_addr
parameter_list|,
name|dst_port
parameter_list|,
name|link_type
parameter_list|)
name|struct
name|in_addr
name|dst_addr
decl_stmt|;
name|u_short
name|dst_port
decl_stmt|;
name|int
name|link_type
decl_stmt|;
block|{
name|u_long
name|n
decl_stmt|;
name|n
operator|=
name|dst_addr
operator|.
name|s_addr
expr_stmt|;
name|n
operator|+=
name|dst_port
expr_stmt|;
name|n
operator|+=
name|link_type
expr_stmt|;
return|return
operator|(
name|n
operator|%
name|LINK_TABLE_SIZE
operator|)
return|;
block|}
end_function

begin_function
name|u_short
name|GetNewPort
parameter_list|()
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|20
condition|;
name|i
operator|++
control|)
block|{
name|int
name|port_offset
decl_stmt|;
name|port_offset
operator|=
call|(
name|int
call|)
argument_list|(
name|random
argument_list|()
operator|&
name|ALIAS_PORT_MASK
argument_list|)
expr_stmt|;
if|if
condition|(
name|portTable
index|[
name|port_offset
index|]
operator|==
literal|0
condition|)
block|{
name|portTable
index|[
name|port_offset
index|]
operator|=
literal|1
expr_stmt|;
return|return
operator|(
name|htons
argument_list|(
name|ALIAS_PORT_BASE
operator|+
name|port_offset
argument_list|)
operator|)
return|;
block|}
block|}
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"PacketAlias/GetNewPort: Can't allocate port number.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|void
name|SetTimestamp
parameter_list|(
name|clink
parameter_list|)
name|char
modifier|*
name|clink
decl_stmt|;
block|{
name|struct
name|link_record
modifier|*
name|link
decl_stmt|;
name|struct
name|timezone
name|tz
decl_stmt|;
name|struct
name|timeval
name|tv
decl_stmt|;
if|if
condition|(
name|clink
operator|!=
name|NULL_PTR
condition|)
block|{
name|link
operator|=
operator|(
expr|struct
name|link_record
operator|*
operator|)
name|clink
expr_stmt|;
name|gettimeofday
argument_list|(
operator|&
name|tv
argument_list|,
operator|&
name|tz
argument_list|)
expr_stmt|;
name|link
operator|->
name|timestamp
operator|=
name|tv
operator|.
name|tv_sec
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|SeqDiff
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|)
name|u_long
name|x
decl_stmt|;
name|u_long
name|y
decl_stmt|;
block|{
comment|/* Return the difference between two TCP sequence numbers */
comment|/*     This function is encapsulated in case there are any unusual     arithmetic conditions that need to be considered. */
return|return
operator|(
name|ntohl
argument_list|(
name|y
argument_list|)
operator|-
name|ntohl
argument_list|(
name|x
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|void
name|ShowAliasStats
parameter_list|()
block|{
comment|/* Used for debugging */
name|fprintf
argument_list|(
name|monitorFile
argument_list|,
literal|"ShowAliasStats: icmp=%d, udp=%d, tcp=%d, frag=%d  /  tot=%d\n"
argument_list|,
name|icmpLinkCount
argument_list|,
name|udpLinkCount
argument_list|,
name|tcpLinkCount
argument_list|,
name|fragmentLinkCount
argument_list|,
name|icmpLinkCount
operator|+
name|udpLinkCount
operator|+
name|tcpLinkCount
operator|+
name|fragmentLinkCount
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|monitorFile
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Internal routines for finding, deleting and adding links      CleanupAliasData()     - remove all link chains from lookup table     IncrementalCleanup()   - look for stale links in a single chain     FindLink1()            - find link based on original ports     FindLink2()            - find link based on alias port     DeleteLink()           - remove link     AddLink()              - add link  */
end_comment

begin_function
name|void
name|CleanupAliasData
parameter_list|()
block|{
name|struct
name|link_record
modifier|*
name|link
decl_stmt|;
name|int
name|i
decl_stmt|,
name|icount
decl_stmt|;
name|icount
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|LINK_TABLE_SIZE
condition|;
name|i
operator|++
control|)
block|{
name|link
operator|=
name|linkTable
index|[
name|i
index|]
expr_stmt|;
name|linkTable
index|[
name|i
index|]
operator|=
name|NULL_PTR
expr_stmt|;
while|while
condition|(
name|link
operator|!=
name|NULL_PTR
condition|)
block|{
name|struct
name|link_record
modifier|*
name|link_next
decl_stmt|;
name|link_next
operator|=
name|link
operator|->
name|next
expr_stmt|;
name|icount
operator|++
expr_stmt|;
name|DeleteLink
argument_list|(
operator|(
name|char
operator|*
operator|)
name|link
argument_list|)
expr_stmt|;
name|link
operator|=
name|link_next
expr_stmt|;
block|}
block|}
name|icmpLinkCount
operator|=
literal|0
expr_stmt|;
name|udpLinkCount
operator|=
literal|0
expr_stmt|;
name|tcpLinkCount
operator|=
literal|0
expr_stmt|;
name|fragmentLinkCount
operator|=
literal|0
expr_stmt|;
name|cleanupIndex
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
name|void
name|IncrementalCleanup
parameter_list|()
block|{
name|int
name|icount
decl_stmt|;
name|long
name|secs
decl_stmt|;
name|struct
name|timeval
name|tv
decl_stmt|;
name|struct
name|timezone
name|tz
decl_stmt|;
name|struct
name|link_record
modifier|*
name|link
decl_stmt|;
name|gettimeofday
argument_list|(
operator|&
name|tv
argument_list|,
operator|&
name|tz
argument_list|)
expr_stmt|;
name|secs
operator|=
name|tv
operator|.
name|tv_sec
expr_stmt|;
name|icount
operator|=
literal|0
expr_stmt|;
name|link
operator|=
name|linkTable
index|[
name|cleanupIndex
operator|++
index|]
expr_stmt|;
while|while
condition|(
name|link
operator|!=
name|NULL_PTR
condition|)
block|{
name|long
name|idelta
decl_stmt|;
name|struct
name|link_record
modifier|*
name|link_next
decl_stmt|;
name|link_next
operator|=
name|link
operator|->
name|next
expr_stmt|;
name|idelta
operator|=
name|secs
operator|-
name|link
operator|->
name|timestamp
expr_stmt|;
switch|switch
condition|(
name|link
operator|->
name|link_type
condition|)
block|{
case|case
name|LINK_ICMP
case|:
if|if
condition|(
name|idelta
operator|>
name|ICMP_EXPIRE_TIME
condition|)
block|{
name|DeleteLink
argument_list|(
operator|(
name|char
operator|*
operator|)
name|link
argument_list|)
expr_stmt|;
name|icount
operator|++
expr_stmt|;
block|}
break|break;
case|case
name|LINK_UDP
case|:
if|if
condition|(
name|idelta
operator|>
name|UDP_EXPIRE_TIME
condition|)
block|{
name|DeleteLink
argument_list|(
operator|(
name|char
operator|*
operator|)
name|link
argument_list|)
expr_stmt|;
name|icount
operator|++
expr_stmt|;
block|}
break|break;
case|case
name|LINK_TCP
case|:
if|if
condition|(
name|idelta
operator|>
name|TCP_EXPIRE_TIME
condition|)
block|{
name|struct
name|tcp_dat
modifier|*
name|tcp_aux
decl_stmt|;
name|tcp_aux
operator|=
name|link
operator|->
name|data
operator|.
name|tcp
expr_stmt|;
if|if
condition|(
name|tcp_aux
operator|->
name|state
operator|.
name|in
operator|!=
literal|1
operator|||
name|tcp_aux
operator|->
name|state
operator|.
name|out
operator|!=
literal|1
condition|)
block|{
name|DeleteLink
argument_list|(
operator|(
name|char
operator|*
operator|)
name|link
argument_list|)
expr_stmt|;
name|icount
operator|++
expr_stmt|;
block|}
block|}
break|break;
case|case
name|LINK_FRAGMENT_ID
case|:
if|if
condition|(
name|idelta
operator|>
name|FRAGMENT_EXPIRE_TIME
condition|)
block|{
name|DeleteLink
argument_list|(
operator|(
name|char
operator|*
operator|)
name|link
argument_list|)
expr_stmt|;
name|icount
operator|++
expr_stmt|;
block|}
break|break;
block|}
name|link
operator|=
name|link_next
expr_stmt|;
block|}
if|if
condition|(
name|cleanupIndex
operator|==
name|LINK_TABLE_SIZE
condition|)
name|cleanupIndex
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
name|char
modifier|*
name|FindLink1
parameter_list|(
name|src_addr
parameter_list|,
name|dst_addr
parameter_list|,
name|src_port
parameter_list|,
name|dst_port
parameter_list|,
name|link_type
parameter_list|)
name|struct
name|in_addr
name|src_addr
decl_stmt|,
name|dst_addr
decl_stmt|;
name|u_short
name|src_port
decl_stmt|,
name|dst_port
decl_stmt|;
name|int
name|link_type
decl_stmt|;
block|{
name|int
name|i
decl_stmt|;
name|struct
name|link_record
modifier|*
name|link
decl_stmt|;
name|i
operator|=
name|StartPoint
argument_list|(
name|dst_addr
argument_list|,
name|dst_port
argument_list|,
name|link_type
argument_list|)
expr_stmt|;
name|link
operator|=
name|linkTable
index|[
name|i
index|]
expr_stmt|;
while|while
condition|(
name|link
operator|!=
name|NULL_PTR
condition|)
block|{
if|if
condition|(
name|link
operator|->
name|src_addr
operator|.
name|s_addr
operator|==
name|src_addr
operator|.
name|s_addr
operator|&&
name|link
operator|->
name|dst_addr
operator|.
name|s_addr
operator|==
name|dst_addr
operator|.
name|s_addr
operator|&&
name|link
operator|->
name|dst_port
operator|==
name|dst_port
operator|&&
name|link
operator|->
name|src_port
operator|==
name|src_port
operator|&&
name|link
operator|->
name|link_type
operator|==
name|link_type
condition|)
block|{
break|break;
block|}
name|link
operator|=
name|link
operator|->
name|next
expr_stmt|;
block|}
name|SetTimestamp
argument_list|(
operator|(
name|char
operator|*
operator|)
name|link
argument_list|)
expr_stmt|;
name|IncrementalCleanup
argument_list|()
expr_stmt|;
return|return
operator|(
operator|(
name|char
operator|*
operator|)
name|link
operator|)
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|FindLink2
parameter_list|(
name|dst_addr
parameter_list|,
name|dst_port
parameter_list|,
name|alias_port
parameter_list|,
name|link_type
parameter_list|)
name|struct
name|in_addr
name|dst_addr
decl_stmt|;
name|u_short
name|dst_port
decl_stmt|,
name|alias_port
decl_stmt|;
name|int
name|link_type
decl_stmt|;
block|{
name|int
name|i
decl_stmt|;
name|struct
name|link_record
modifier|*
name|link
decl_stmt|;
name|i
operator|=
name|StartPoint
argument_list|(
name|dst_addr
argument_list|,
name|dst_port
argument_list|,
name|link_type
argument_list|)
expr_stmt|;
name|link
operator|=
name|linkTable
index|[
name|i
index|]
expr_stmt|;
while|while
condition|(
name|link
operator|!=
name|NULL_PTR
condition|)
block|{
if|if
condition|(
name|link
operator|->
name|dst_addr
operator|.
name|s_addr
operator|==
name|dst_addr
operator|.
name|s_addr
operator|&&
name|link
operator|->
name|dst_port
operator|==
name|dst_port
operator|&&
name|link
operator|->
name|alias_port
operator|==
name|alias_port
operator|&&
name|link
operator|->
name|link_type
operator|==
name|link_type
condition|)
block|{
break|break;
block|}
name|link
operator|=
name|link
operator|->
name|next
expr_stmt|;
block|}
name|SetTimestamp
argument_list|(
operator|(
name|char
operator|*
operator|)
name|link
argument_list|)
expr_stmt|;
name|IncrementalCleanup
argument_list|()
expr_stmt|;
return|return
operator|(
operator|(
name|char
operator|*
operator|)
name|link
operator|)
return|;
block|}
end_function

begin_function
name|void
name|DeleteLink
parameter_list|(
name|clink
parameter_list|)
name|char
modifier|*
name|clink
decl_stmt|;
block|{
name|struct
name|link_record
modifier|*
name|link
decl_stmt|;
name|struct
name|link_record
modifier|*
name|link_last
decl_stmt|;
name|struct
name|link_record
modifier|*
name|link_next
decl_stmt|;
name|link
operator|=
operator|(
expr|struct
name|link_record
operator|*
operator|)
name|clink
expr_stmt|;
name|link_last
operator|=
name|link
operator|->
name|last
expr_stmt|;
name|link_next
operator|=
name|link
operator|->
name|next
expr_stmt|;
if|if
condition|(
name|link_last
operator|!=
name|NULL_PTR
condition|)
name|link_last
operator|->
name|next
operator|=
name|link_next
expr_stmt|;
else|else
name|linkTable
index|[
name|link
operator|->
name|table_index
index|]
operator|=
name|link
operator|->
name|next
expr_stmt|;
if|if
condition|(
name|link_next
operator|!=
name|NULL_PTR
condition|)
name|link_next
operator|->
name|last
operator|=
name|link_last
expr_stmt|;
switch|switch
condition|(
name|link
operator|->
name|link_type
condition|)
block|{
name|int
name|port
decl_stmt|;
case|case
name|LINK_ICMP
case|:
name|icmpLinkCount
operator|--
expr_stmt|;
break|break;
case|case
name|LINK_UDP
case|:
name|udpLinkCount
operator|--
expr_stmt|;
name|port
operator|=
name|ntohs
argument_list|(
name|link
operator|->
name|alias_port
argument_list|)
expr_stmt|;
if|if
condition|(
name|port
operator|!=
literal|0
operator|&&
name|link
operator|->
name|passthrough
operator|==
literal|0
condition|)
name|portTable
index|[
name|port
operator|-
name|ALIAS_PORT_BASE
index|]
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|LINK_TCP
case|:
name|tcpLinkCount
operator|--
expr_stmt|;
name|port
operator|=
name|ntohs
argument_list|(
name|link
operator|->
name|alias_port
argument_list|)
expr_stmt|;
if|if
condition|(
name|port
operator|!=
literal|0
operator|&&
name|link
operator|->
name|passthrough
operator|==
literal|0
condition|)
name|portTable
index|[
name|port
operator|-
name|ALIAS_PORT_BASE
index|]
operator|=
literal|0
expr_stmt|;
name|free
argument_list|(
name|link
operator|->
name|data
operator|.
name|tcp
argument_list|)
expr_stmt|;
break|break;
case|case
name|LINK_FRAGMENT_ID
case|:
name|fragmentLinkCount
operator|--
expr_stmt|;
name|free
argument_list|(
name|link
operator|->
name|data
operator|.
name|id
argument_list|)
expr_stmt|;
break|break;
block|}
name|free
argument_list|(
name|link
argument_list|)
expr_stmt|;
if|if
condition|(
name|monitorAlias
operator|==
literal|1
condition|)
block|{
name|ShowAliasStats
argument_list|()
expr_stmt|;
block|}
block|}
end_function

begin_function
name|char
modifier|*
name|AddLink
parameter_list|(
name|src_addr
parameter_list|,
name|dst_addr
parameter_list|,
name|src_port
parameter_list|,
name|dst_port
parameter_list|,
name|alias_port
parameter_list|,
name|link_type
parameter_list|)
name|struct
name|in_addr
name|src_addr
decl_stmt|,
name|dst_addr
decl_stmt|;
name|u_short
name|src_port
decl_stmt|,
name|dst_port
decl_stmt|,
name|alias_port
decl_stmt|;
name|int
name|link_type
decl_stmt|;
block|{
name|int
name|i
decl_stmt|;
name|struct
name|link_record
modifier|*
name|link
decl_stmt|,
modifier|*
name|last_link
decl_stmt|;
name|i
operator|=
name|StartPoint
argument_list|(
name|dst_addr
argument_list|,
name|dst_port
argument_list|,
name|link_type
argument_list|)
expr_stmt|;
name|last_link
operator|=
name|NULL_PTR
expr_stmt|;
name|link
operator|=
name|linkTable
index|[
name|i
index|]
expr_stmt|;
while|while
condition|(
name|link
operator|!=
name|NULL_PTR
condition|)
block|{
name|last_link
operator|=
name|link
expr_stmt|;
name|link
operator|=
name|link
operator|->
name|next
expr_stmt|;
block|}
name|link
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|link_record
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|link
operator|!=
name|NULL_PTR
condition|)
block|{
if|if
condition|(
name|last_link
operator|!=
name|NULL_PTR
condition|)
name|last_link
operator|->
name|next
operator|=
name|link
expr_stmt|;
else|else
name|linkTable
index|[
name|i
index|]
operator|=
name|link
expr_stmt|;
name|link
operator|->
name|next
operator|=
name|NULL_PTR
expr_stmt|;
name|link
operator|->
name|table_index
operator|=
name|i
expr_stmt|;
name|link
operator|->
name|last
operator|=
name|last_link
expr_stmt|;
name|link
operator|->
name|src_addr
operator|=
name|src_addr
expr_stmt|;
name|link
operator|->
name|dst_addr
operator|=
name|dst_addr
expr_stmt|;
name|link
operator|->
name|src_port
operator|=
name|src_port
expr_stmt|;
name|link
operator|->
name|dst_port
operator|=
name|dst_port
expr_stmt|;
name|link
operator|->
name|alias_port
operator|=
literal|0
expr_stmt|;
name|link
operator|->
name|link_type
operator|=
name|link_type
expr_stmt|;
name|link
operator|->
name|passthrough
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|link_type
condition|)
block|{
name|struct
name|id_dat
modifier|*
name|aux_id
decl_stmt|;
name|struct
name|tcp_dat
modifier|*
name|aux_tcp
decl_stmt|;
case|case
name|LINK_ICMP
case|:
name|icmpLinkCount
operator|++
expr_stmt|;
name|link
operator|->
name|alias_port
operator|=
name|alias_port
expr_stmt|;
break|break;
case|case
name|LINK_UDP
case|:
name|udpLinkCount
operator|++
expr_stmt|;
name|link
operator|->
name|alias_port
operator|=
name|alias_port
expr_stmt|;
break|break;
case|case
name|LINK_TCP
case|:
name|link
operator|->
name|alias_port
operator|=
name|alias_port
expr_stmt|;
name|aux_tcp
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|tcp_dat
argument_list|)
argument_list|)
expr_stmt|;
name|link
operator|->
name|data
operator|.
name|tcp
operator|=
name|aux_tcp
expr_stmt|;
if|if
condition|(
name|aux_tcp
operator|!=
name|NULL_PTR
condition|)
block|{
name|tcpLinkCount
operator|++
expr_stmt|;
name|aux_tcp
operator|->
name|state
operator|.
name|in
operator|=
literal|0
expr_stmt|;
name|aux_tcp
operator|->
name|state
operator|.
name|out
operator|=
literal|0
expr_stmt|;
name|aux_tcp
operator|->
name|state
operator|.
name|index
operator|=
literal|0
expr_stmt|;
name|aux_tcp
operator|->
name|state
operator|.
name|ack_modified
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|N_LINK_TCP_DATA
condition|;
name|i
operator|++
control|)
name|aux_tcp
operator|->
name|ack
index|[
name|i
index|]
operator|.
name|active
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"PacketAlias/AddLink:Cannot allocate auxiliary TCP data"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|LINK_FRAGMENT_ID
case|:
name|aux_id
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|id_dat
argument_list|)
argument_list|)
expr_stmt|;
name|link
operator|->
name|data
operator|.
name|id
operator|=
name|aux_id
expr_stmt|;
if|if
condition|(
name|aux_id
operator|!=
name|NULL_PTR
condition|)
block|{
name|fragmentLinkCount
operator|++
expr_stmt|;
name|aux_id
operator|->
name|index
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|N_LINK_ID_DATA
condition|;
name|i
operator|++
control|)
name|aux_id
operator|->
name|data
index|[
name|i
index|]
operator|.
name|active
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"PacketAlias/AddLink:Cannot allocate auxiliary id data"
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"PacketAlias/AddLink: Cannot dynamically allocate memory.\n"
argument_list|)
expr_stmt|;
block|}
name|SetTimestamp
argument_list|(
operator|(
name|char
operator|*
operator|)
name|link
argument_list|)
expr_stmt|;
name|IncrementalCleanup
argument_list|()
expr_stmt|;
if|if
condition|(
name|monitorAlias
operator|==
literal|1
condition|)
block|{
name|ShowAliasStats
argument_list|()
expr_stmt|;
block|}
return|return
operator|(
operator|(
name|char
operator|*
operator|)
name|link
operator|)
return|;
block|}
end_function

begin_comment
comment|/* External routines for finding/adding links      FindIcmpIn(), FindIcmpOut()     FindFragmentIn1(), FindFragmentIn2()     FindUdpIn(), FindUdpOut()     FindTcpIn(), FindTcpOut() */
end_comment

begin_function
name|char
modifier|*
name|FindIcmpIn
parameter_list|(
name|dst_addr
parameter_list|,
name|id
parameter_list|,
name|seq_alias
parameter_list|)
name|struct
name|in_addr
name|dst_addr
decl_stmt|;
name|u_short
name|id
decl_stmt|,
name|seq_alias
decl_stmt|;
block|{
return|return
operator|(
name|FindLink2
argument_list|(
name|dst_addr
argument_list|,
name|id
argument_list|,
name|seq_alias
argument_list|,
name|LINK_ICMP
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|FindIcmpOut
parameter_list|(
name|src_addr
parameter_list|,
name|dst_addr
parameter_list|,
name|id
parameter_list|,
name|seq
parameter_list|)
name|struct
name|in_addr
name|src_addr
decl_stmt|,
name|dst_addr
decl_stmt|;
name|u_short
name|id
decl_stmt|,
name|seq
decl_stmt|;
block|{
name|char
modifier|*
name|link
decl_stmt|;
name|link
operator|=
name|FindLink1
argument_list|(
name|src_addr
argument_list|,
name|dst_addr
argument_list|,
name|seq
argument_list|,
name|id
argument_list|,
name|LINK_ICMP
argument_list|)
expr_stmt|;
if|if
condition|(
name|link
operator|==
name|NULL_PTR
condition|)
name|link
operator|=
name|AddLink
argument_list|(
name|src_addr
argument_list|,
name|dst_addr
argument_list|,
name|seq
argument_list|,
name|id
argument_list|,
name|alias_sequence
operator|++
argument_list|,
name|LINK_ICMP
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
name|char
operator|*
operator|)
name|link
operator|)
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|FindFragmentIn1
parameter_list|(
name|dst_addr
parameter_list|)
name|struct
name|in_addr
name|dst_addr
decl_stmt|;
block|{
name|char
modifier|*
name|link
decl_stmt|;
name|link
operator|=
name|FindLink2
argument_list|(
name|dst_addr
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|LINK_FRAGMENT_ID
argument_list|)
expr_stmt|;
if|if
condition|(
name|link
operator|==
name|NULL_PTR
condition|)
name|link
operator|=
name|AddLink
argument_list|(
name|aliasAddress
argument_list|,
name|dst_addr
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|LINK_FRAGMENT_ID
argument_list|)
expr_stmt|;
return|return
operator|(
name|link
operator|)
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|FindFragmentIn2
parameter_list|(
name|dst_addr
parameter_list|)
name|struct
name|in_addr
name|dst_addr
decl_stmt|;
block|{
return|return
operator|(
name|FindLink2
argument_list|(
name|dst_addr
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|LINK_FRAGMENT_ID
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|FindUdpIn
parameter_list|(
name|dst_addr
parameter_list|,
name|dst_port
parameter_list|,
name|alias_port
parameter_list|)
name|struct
name|in_addr
name|dst_addr
decl_stmt|;
name|u_short
name|dst_port
decl_stmt|,
name|alias_port
decl_stmt|;
block|{
name|char
modifier|*
name|link
decl_stmt|;
name|link
operator|=
name|FindLink2
argument_list|(
name|dst_addr
argument_list|,
name|dst_port
argument_list|,
name|alias_port
argument_list|,
name|LINK_UDP
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|ALLOW_INCOMING
if|if
condition|(
name|link
operator|==
name|NULL_PTR
condition|)
block|{
name|link
operator|=
name|AddLink
argument_list|(
name|GetAliasAddress
argument_list|()
argument_list|,
name|dst_addr
argument_list|,
name|alias_port
argument_list|,
name|dst_port
argument_list|,
name|alias_port
argument_list|,
name|LINK_UDP
argument_list|)
expr_stmt|;
if|if
condition|(
name|link
operator|!=
name|NULL_PTR
condition|)
operator|(
operator|(
expr|struct
name|link_record
operator|*
operator|)
name|link
operator|)
operator|->
name|passthrough
operator|=
literal|1
expr_stmt|;
block|}
endif|#
directive|endif
return|return
operator|(
name|link
operator|)
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|FindUdpOut
parameter_list|(
name|src_addr
parameter_list|,
name|dst_addr
parameter_list|,
name|src_port
parameter_list|,
name|dst_port
parameter_list|)
name|struct
name|in_addr
name|src_addr
decl_stmt|,
name|dst_addr
decl_stmt|;
name|u_short
name|src_port
decl_stmt|,
name|dst_port
decl_stmt|;
block|{
name|char
modifier|*
name|link
decl_stmt|;
name|link
operator|=
name|FindLink1
argument_list|(
name|src_addr
argument_list|,
name|dst_addr
argument_list|,
name|src_port
argument_list|,
name|dst_port
argument_list|,
name|LINK_UDP
argument_list|)
expr_stmt|;
if|if
condition|(
name|link
operator|==
name|NULL_PTR
condition|)
name|link
operator|=
name|AddLink
argument_list|(
name|src_addr
argument_list|,
name|dst_addr
argument_list|,
name|src_port
argument_list|,
name|dst_port
argument_list|,
name|GetNewPort
argument_list|()
argument_list|,
name|LINK_UDP
argument_list|)
expr_stmt|;
return|return
operator|(
name|link
operator|)
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|FindTcpIn
parameter_list|(
name|dst_addr
parameter_list|,
name|dst_port
parameter_list|,
name|alias_port
parameter_list|)
name|struct
name|in_addr
name|dst_addr
decl_stmt|;
name|u_short
name|dst_port
decl_stmt|,
name|alias_port
decl_stmt|;
block|{
name|char
modifier|*
name|link
decl_stmt|;
name|link
operator|=
name|FindLink2
argument_list|(
name|dst_addr
argument_list|,
name|dst_port
argument_list|,
name|alias_port
argument_list|,
name|LINK_TCP
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|ALLOW_INCOMING
if|if
condition|(
name|link
operator|==
name|NULL_PTR
condition|)
name|link
operator|=
name|AddLink
argument_list|(
name|GetAliasAddress
argument_list|()
argument_list|,
name|dst_addr
argument_list|,
name|alias_port
argument_list|,
name|dst_port
argument_list|,
name|alias_port
argument_list|,
name|LINK_TCP
argument_list|)
expr_stmt|;
if|if
condition|(
name|link
operator|!=
name|NULL_PTR
condition|)
operator|(
operator|(
expr|struct
name|link_record
operator|*
operator|)
name|link
operator|)
operator|->
name|passthrough
operator|=
literal|1
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
name|link
operator|)
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|FindTcpOut
parameter_list|(
name|src_addr
parameter_list|,
name|dst_addr
parameter_list|,
name|src_port
parameter_list|,
name|dst_port
parameter_list|)
name|struct
name|in_addr
name|src_addr
decl_stmt|,
name|dst_addr
decl_stmt|;
name|u_short
name|src_port
decl_stmt|,
name|dst_port
decl_stmt|;
block|{
name|char
modifier|*
name|link
decl_stmt|;
name|link
operator|=
name|FindLink1
argument_list|(
name|src_addr
argument_list|,
name|dst_addr
argument_list|,
name|src_port
argument_list|,
name|dst_port
argument_list|,
name|LINK_TCP
argument_list|)
expr_stmt|;
if|if
condition|(
name|link
operator|==
name|NULL_PTR
condition|)
name|link
operator|=
name|AddLink
argument_list|(
name|src_addr
argument_list|,
name|dst_addr
argument_list|,
name|src_port
argument_list|,
name|dst_port
argument_list|,
name|GetNewPort
argument_list|()
argument_list|,
name|LINK_TCP
argument_list|)
expr_stmt|;
return|return
operator|(
name|link
operator|)
return|;
block|}
end_function

begin_comment
comment|/* External routines for getting or changing link data      SetFragmentData(), GetFragmentData()     SetStateIn(), SetStateOut(), GetStateIn(), GetStateOut()     GetOriginalAddress(), GetDestAddress(), GetAliasAddress()     GetOriginalPort(), GetDestPort(), GetAliasPort()     SetAckModified(), GetAckModified()     GetDeltaAckIn(), GetDeltaSeqOut(), AddSeq() */
end_comment

begin_function
name|void
name|SetFragmentData
parameter_list|(
name|clink
parameter_list|,
name|idnum
parameter_list|,
name|protocol
parameter_list|,
name|src_addr
parameter_list|)
name|char
modifier|*
name|clink
decl_stmt|;
name|u_short
name|idnum
decl_stmt|;
name|u_char
name|protocol
decl_stmt|;
name|struct
name|in_addr
name|src_addr
decl_stmt|;
block|{
name|struct
name|link_record
modifier|*
name|link
decl_stmt|;
name|struct
name|id_dat
modifier|*
name|idx
decl_stmt|;
name|int
name|i
decl_stmt|;
name|link
operator|=
operator|(
expr|struct
name|link_record
operator|*
operator|)
name|clink
expr_stmt|;
name|idx
operator|=
name|link
operator|->
name|data
operator|.
name|id
expr_stmt|;
if|if
condition|(
name|idx
operator|!=
name|NULL_PTR
condition|)
block|{
name|i
operator|=
name|idx
operator|->
name|index
expr_stmt|;
name|idx
operator|->
name|data
index|[
name|i
index|]
operator|.
name|id
operator|=
name|idnum
expr_stmt|;
name|idx
operator|->
name|data
index|[
name|i
index|]
operator|.
name|protocol
operator|=
name|protocol
expr_stmt|;
name|idx
operator|->
name|data
index|[
name|i
index|]
operator|.
name|src_addr
operator|=
name|src_addr
expr_stmt|;
name|idx
operator|->
name|data
index|[
name|i
index|]
operator|.
name|active
operator|=
literal|1
expr_stmt|;
name|i
operator|++
expr_stmt|;
if|if
condition|(
name|i
operator|==
name|N_LINK_ID_DATA
condition|)
name|idx
operator|->
name|index
operator|=
literal|0
expr_stmt|;
else|else
name|idx
operator|->
name|index
operator|=
name|i
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|GetFragmentAddr
parameter_list|(
name|clink
parameter_list|,
name|idnum
parameter_list|,
name|protocol
parameter_list|,
name|src_addr
parameter_list|)
name|char
modifier|*
name|clink
decl_stmt|;
name|u_short
name|idnum
decl_stmt|;
name|u_char
name|protocol
decl_stmt|;
name|struct
name|in_addr
modifier|*
name|src_addr
decl_stmt|;
block|{
name|struct
name|link_record
modifier|*
name|link
decl_stmt|;
name|int
name|i
decl_stmt|;
name|link
operator|=
operator|(
expr|struct
name|link_record
operator|*
operator|)
name|clink
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|N_LINK_ID_DATA
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|id_dat
modifier|*
name|idx
decl_stmt|;
name|idx
operator|=
name|link
operator|->
name|data
operator|.
name|id
expr_stmt|;
if|if
condition|(
name|idx
operator|->
name|data
index|[
name|i
index|]
operator|.
name|active
operator|==
literal|1
condition|)
block|{
if|if
condition|(
name|idx
operator|->
name|data
index|[
name|i
index|]
operator|.
name|id
operator|==
name|idnum
operator|&&
name|idx
operator|->
name|data
index|[
name|i
index|]
operator|.
name|protocol
operator|==
name|protocol
condition|)
block|{
operator|*
name|src_addr
operator|=
name|idx
operator|->
name|data
index|[
name|i
index|]
operator|.
name|src_addr
expr_stmt|;
break|break;
block|}
block|}
block|}
block|}
end_function

begin_function
name|void
name|SetStateIn
parameter_list|(
name|clink
parameter_list|,
name|state
parameter_list|)
name|char
modifier|*
name|clink
decl_stmt|;
name|int
name|state
decl_stmt|;
block|{
name|struct
name|link_record
modifier|*
name|link
decl_stmt|;
comment|/* TCP input state */
name|link
operator|=
operator|(
expr|struct
name|link_record
operator|*
operator|)
name|clink
expr_stmt|;
operator|(
name|link
operator|->
name|data
operator|.
name|tcp
operator|)
operator|->
name|state
operator|.
name|in
operator|=
name|state
expr_stmt|;
block|}
end_function

begin_function
name|void
name|SetStateOut
parameter_list|(
name|clink
parameter_list|,
name|state
parameter_list|)
name|char
modifier|*
name|clink
decl_stmt|;
name|int
name|state
decl_stmt|;
block|{
name|struct
name|link_record
modifier|*
name|link
decl_stmt|;
comment|/* TCP output state */
name|link
operator|=
operator|(
expr|struct
name|link_record
operator|*
operator|)
name|clink
expr_stmt|;
operator|(
name|link
operator|->
name|data
operator|.
name|tcp
operator|)
operator|->
name|state
operator|.
name|out
operator|=
name|state
expr_stmt|;
block|}
end_function

begin_function
name|int
name|GetStateIn
parameter_list|(
name|clink
parameter_list|)
name|char
modifier|*
name|clink
decl_stmt|;
block|{
name|struct
name|link_record
modifier|*
name|link
decl_stmt|;
comment|/* TCP input state */
name|link
operator|=
operator|(
expr|struct
name|link_record
operator|*
operator|)
name|clink
expr_stmt|;
return|return
operator|(
operator|(
name|link
operator|->
name|data
operator|.
name|tcp
operator|)
operator|->
name|state
operator|.
name|in
operator|)
return|;
block|}
end_function

begin_function
name|int
name|GetStateOut
parameter_list|(
name|clink
parameter_list|)
name|char
modifier|*
name|clink
decl_stmt|;
block|{
name|struct
name|link_record
modifier|*
name|link
decl_stmt|;
comment|/* TCP output state */
name|link
operator|=
operator|(
expr|struct
name|link_record
operator|*
operator|)
name|clink
expr_stmt|;
return|return
operator|(
operator|(
name|link
operator|->
name|data
operator|.
name|tcp
operator|)
operator|->
name|state
operator|.
name|out
operator|)
return|;
block|}
end_function

begin_function
name|struct
name|in_addr
name|GetOriginalAddress
parameter_list|(
name|clink
parameter_list|)
name|char
modifier|*
name|clink
decl_stmt|;
block|{
name|struct
name|link_record
modifier|*
name|link
decl_stmt|;
name|link
operator|=
operator|(
expr|struct
name|link_record
operator|*
operator|)
name|clink
expr_stmt|;
return|return
operator|(
name|link
operator|->
name|src_addr
operator|)
return|;
block|}
end_function

begin_function
name|struct
name|in_addr
name|GetDestAddress
parameter_list|(
name|clink
parameter_list|)
name|char
modifier|*
name|clink
decl_stmt|;
block|{
name|struct
name|link_record
modifier|*
name|link
decl_stmt|;
name|link
operator|=
operator|(
expr|struct
name|link_record
operator|*
operator|)
name|clink
expr_stmt|;
return|return
operator|(
name|link
operator|->
name|dst_addr
operator|)
return|;
block|}
end_function

begin_function
name|struct
name|in_addr
name|GetAliasAddress
parameter_list|()
block|{
return|return
operator|(
name|aliasAddress
operator|)
return|;
block|}
end_function

begin_function
name|u_short
name|GetOriginalPort
parameter_list|(
name|clink
parameter_list|)
name|char
modifier|*
name|clink
decl_stmt|;
block|{
name|struct
name|link_record
modifier|*
name|link
decl_stmt|;
name|link
operator|=
operator|(
expr|struct
name|link_record
operator|*
operator|)
name|clink
expr_stmt|;
return|return
operator|(
name|link
operator|->
name|src_port
operator|)
return|;
block|}
end_function

begin_function
name|u_short
name|GetDestPort
parameter_list|(
name|clink
parameter_list|)
name|char
modifier|*
name|clink
decl_stmt|;
block|{
name|struct
name|link_record
modifier|*
name|link
decl_stmt|;
name|link
operator|=
operator|(
expr|struct
name|link_record
operator|*
operator|)
name|clink
expr_stmt|;
return|return
operator|(
name|link
operator|->
name|dst_port
operator|)
return|;
block|}
end_function

begin_function
name|u_short
name|GetAliasPort
parameter_list|(
name|clink
parameter_list|)
name|char
modifier|*
name|clink
decl_stmt|;
block|{
name|struct
name|link_record
modifier|*
name|link
decl_stmt|;
name|link
operator|=
operator|(
expr|struct
name|link_record
operator|*
operator|)
name|clink
expr_stmt|;
return|return
operator|(
name|link
operator|->
name|alias_port
operator|)
return|;
block|}
end_function

begin_function
name|void
name|SetAckModified
parameter_list|(
name|clink
parameter_list|)
name|char
modifier|*
name|clink
decl_stmt|;
block|{
name|struct
name|link_record
modifier|*
name|link
decl_stmt|;
comment|/* Indicate that ack numbers have been modified in a TCP connection */
name|link
operator|=
operator|(
expr|struct
name|link_record
operator|*
operator|)
name|clink
expr_stmt|;
operator|(
name|link
operator|->
name|data
operator|.
name|tcp
operator|)
operator|->
name|state
operator|.
name|ack_modified
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_function
name|int
name|GetAckModified
parameter_list|(
name|clink
parameter_list|)
name|char
modifier|*
name|clink
decl_stmt|;
block|{
name|struct
name|link_record
modifier|*
name|link
decl_stmt|;
comment|/* See if ack numbers have been modified */
name|link
operator|=
operator|(
expr|struct
name|link_record
operator|*
operator|)
name|clink
expr_stmt|;
return|return
operator|(
operator|(
name|link
operator|->
name|data
operator|.
name|tcp
operator|)
operator|->
name|state
operator|.
name|ack_modified
operator|)
return|;
block|}
end_function

begin_function
name|int
name|GetDeltaAckIn
parameter_list|(
name|pip
parameter_list|,
name|clink
parameter_list|)
name|struct
name|ip
modifier|*
name|pip
decl_stmt|;
name|char
modifier|*
name|clink
decl_stmt|;
block|{
comment|/* Find out how much the ack number has been altered for an incoming TCP packet.  To do this, a circular list is ack numbers where the TCP packet size was altered is searched.  */
name|int
name|i
decl_stmt|;
name|struct
name|link_record
modifier|*
name|link
decl_stmt|;
name|struct
name|tcphdr
modifier|*
name|tc
decl_stmt|;
name|int
name|delta
decl_stmt|,
name|ack_diff_min
decl_stmt|;
name|u_long
name|ack
decl_stmt|;
name|link
operator|=
operator|(
expr|struct
name|link_record
operator|*
operator|)
name|clink
expr_stmt|;
name|tc
operator|=
operator|(
expr|struct
name|tcphdr
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|pip
operator|+
operator|(
name|pip
operator|->
name|ip_hl
operator|<<
literal|2
operator|)
operator|)
expr_stmt|;
name|ack
operator|=
name|tc
operator|->
name|th_ack
expr_stmt|;
name|delta
operator|=
literal|0
expr_stmt|;
name|ack_diff_min
operator|=
operator|-
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|N_LINK_TCP_DATA
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|ack_data_record
name|x
decl_stmt|;
name|x
operator|=
operator|(
name|link
operator|->
name|data
operator|.
name|tcp
operator|)
operator|->
name|ack
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|x
operator|.
name|active
operator|==
literal|1
condition|)
block|{
name|int
name|ack_diff
decl_stmt|;
name|ack_diff
operator|=
name|SeqDiff
argument_list|(
name|x
operator|.
name|ack_new
argument_list|,
name|ack
argument_list|)
expr_stmt|;
if|if
condition|(
name|ack_diff
operator|>=
literal|0
condition|)
block|{
if|if
condition|(
name|ack_diff_min
operator|>=
literal|0
condition|)
block|{
if|if
condition|(
name|ack_diff
operator|<
name|ack_diff_min
condition|)
block|{
name|delta
operator|=
name|x
operator|.
name|delta
expr_stmt|;
name|ack_diff_min
operator|=
name|ack_diff
expr_stmt|;
block|}
block|}
else|else
block|{
name|delta
operator|=
name|x
operator|.
name|delta
expr_stmt|;
name|ack_diff_min
operator|=
name|ack_diff
expr_stmt|;
block|}
block|}
block|}
block|}
return|return
operator|(
name|delta
operator|)
return|;
block|}
end_function

begin_function
name|int
name|GetDeltaSeqOut
parameter_list|(
name|pip
parameter_list|,
name|clink
parameter_list|)
name|struct
name|ip
modifier|*
name|pip
decl_stmt|;
name|char
modifier|*
name|clink
decl_stmt|;
block|{
comment|/* Find out how much the seq number has been altered for an outgoing TCP packet.  To do this, a circular list is ack numbers where the TCP packet size was altered is searched.  */
name|int
name|i
decl_stmt|;
name|struct
name|link_record
modifier|*
name|link
decl_stmt|;
name|struct
name|tcphdr
modifier|*
name|tc
decl_stmt|;
name|int
name|delta
decl_stmt|,
name|seq_diff_min
decl_stmt|;
name|u_long
name|seq
decl_stmt|;
name|link
operator|=
operator|(
expr|struct
name|link_record
operator|*
operator|)
name|clink
expr_stmt|;
name|tc
operator|=
operator|(
expr|struct
name|tcphdr
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|pip
operator|+
operator|(
name|pip
operator|->
name|ip_hl
operator|<<
literal|2
operator|)
operator|)
expr_stmt|;
name|seq
operator|=
name|tc
operator|->
name|th_seq
expr_stmt|;
name|delta
operator|=
literal|0
expr_stmt|;
name|seq_diff_min
operator|=
operator|-
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|N_LINK_TCP_DATA
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|ack_data_record
name|x
decl_stmt|;
name|x
operator|=
operator|(
name|link
operator|->
name|data
operator|.
name|tcp
operator|)
operator|->
name|ack
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|x
operator|.
name|active
operator|==
literal|1
condition|)
block|{
name|int
name|seq_diff
decl_stmt|;
name|seq_diff
operator|=
name|SeqDiff
argument_list|(
name|x
operator|.
name|ack_old
argument_list|,
name|seq
argument_list|)
expr_stmt|;
if|if
condition|(
name|seq_diff
operator|>=
literal|0
condition|)
block|{
if|if
condition|(
name|seq_diff_min
operator|>=
literal|0
condition|)
block|{
if|if
condition|(
name|seq_diff
operator|<
name|seq_diff_min
condition|)
block|{
name|delta
operator|=
name|x
operator|.
name|delta
expr_stmt|;
name|seq_diff_min
operator|=
name|seq_diff
expr_stmt|;
block|}
block|}
else|else
block|{
name|delta
operator|=
name|x
operator|.
name|delta
expr_stmt|;
name|seq_diff_min
operator|=
name|seq_diff
expr_stmt|;
block|}
block|}
block|}
block|}
return|return
operator|(
name|delta
operator|)
return|;
block|}
end_function

begin_function
name|void
name|AddSeq
parameter_list|(
name|pip
parameter_list|,
name|clink
parameter_list|,
name|delta
parameter_list|)
name|struct
name|ip
modifier|*
name|pip
decl_stmt|;
name|char
modifier|*
name|clink
decl_stmt|;
name|int
name|delta
decl_stmt|;
block|{
comment|/* When a TCP packet has been altered in length, save this information in a circular list.  If enough packets have been altered, then this list will begin to overwrite itself. */
name|struct
name|tcphdr
modifier|*
name|tc
decl_stmt|;
name|struct
name|link_record
modifier|*
name|link
decl_stmt|;
name|struct
name|ack_data_record
name|x
decl_stmt|;
name|int
name|hlen
decl_stmt|,
name|tlen
decl_stmt|,
name|dlen
decl_stmt|;
name|int
name|i
decl_stmt|;
name|link
operator|=
operator|(
expr|struct
name|link_record
operator|*
operator|)
name|clink
expr_stmt|;
name|tc
operator|=
operator|(
expr|struct
name|tcphdr
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|pip
operator|+
operator|(
name|pip
operator|->
name|ip_hl
operator|<<
literal|2
operator|)
operator|)
expr_stmt|;
name|hlen
operator|=
operator|(
name|pip
operator|->
name|ip_hl
operator|+
name|tc
operator|->
name|th_off
operator|)
operator|<<
literal|2
expr_stmt|;
name|tlen
operator|=
name|ntohs
argument_list|(
name|pip
operator|->
name|ip_len
argument_list|)
expr_stmt|;
name|dlen
operator|=
name|tlen
operator|-
name|hlen
expr_stmt|;
name|x
operator|.
name|ack_old
operator|=
name|htonl
argument_list|(
name|ntohl
argument_list|(
name|tc
operator|->
name|th_seq
argument_list|)
operator|+
name|dlen
argument_list|)
expr_stmt|;
name|x
operator|.
name|ack_new
operator|=
name|htonl
argument_list|(
name|ntohl
argument_list|(
name|tc
operator|->
name|th_seq
argument_list|)
operator|+
name|dlen
operator|+
name|delta
argument_list|)
expr_stmt|;
name|x
operator|.
name|delta
operator|=
name|delta
expr_stmt|;
name|x
operator|.
name|active
operator|=
literal|1
expr_stmt|;
name|i
operator|=
operator|(
name|link
operator|->
name|data
operator|.
name|tcp
operator|)
operator|->
name|state
operator|.
name|index
expr_stmt|;
operator|(
name|link
operator|->
name|data
operator|.
name|tcp
operator|)
operator|->
name|ack
index|[
name|i
index|]
operator|=
name|x
expr_stmt|;
name|i
operator|++
expr_stmt|;
if|if
condition|(
name|i
operator|==
name|N_LINK_TCP_DATA
condition|)
operator|(
name|link
operator|->
name|data
operator|.
name|tcp
operator|)
operator|->
name|state
operator|.
name|index
operator|=
literal|0
expr_stmt|;
else|else
operator|(
name|link
operator|->
name|data
operator|.
name|tcp
operator|)
operator|->
name|state
operator|.
name|index
operator|=
name|i
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Outside world interfaces      SetAliasAddress()     InitAliasLog()     InitAlias() */
end_comment

begin_function
name|void
name|SetAliasAddress
parameter_list|(
name|addr
parameter_list|)
name|struct
name|in_addr
name|addr
decl_stmt|;
block|{
name|aliasAddress
operator|=
name|addr
expr_stmt|;
name|CleanupAliasData
argument_list|()
expr_stmt|;
if|if
condition|(
name|monitorAlias
operator|==
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|monitorFile
argument_list|,
literal|"SetAliasAddress: %s\n"
argument_list|,
name|inet_ntoa
argument_list|(
name|aliasAddress
argument_list|)
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|monitorFile
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|InitAliasLog
parameter_list|()
block|{
name|monitorAlias
operator|=
literal|1
expr_stmt|;
name|monitorFile
operator|=
name|fopen
argument_list|(
literal|"/var/log/alias.log"
argument_list|,
literal|"a"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Alias log file opened.\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|InitAlias
parameter_list|()
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|LINK_TABLE_SIZE
condition|;
name|i
operator|++
control|)
name|linkTable
index|[
name|i
index|]
operator|=
name|NULL_PTR
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ALIAS_PORT_TABLE_SIZE
condition|;
name|i
operator|++
control|)
name|portTable
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|alias_sequence
operator|=
literal|0
expr_stmt|;
name|icmpLinkCount
operator|=
literal|0
expr_stmt|;
name|udpLinkCount
operator|=
literal|0
expr_stmt|;
name|tcpLinkCount
operator|=
literal|0
expr_stmt|;
name|fragmentLinkCount
operator|=
literal|0
expr_stmt|;
name|cleanupIndex
operator|=
literal|0
expr_stmt|;
name|monitorAlias
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|mode
operator|&
name|MODE_ALIAS
condition|)
name|printf
argument_list|(
literal|"Packet aliasing enabled.\n"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MONITOR_ALIAS
name|InitAliasLog
argument_list|()
expr_stmt|;
endif|#
directive|endif
block|}
end_function

end_unit


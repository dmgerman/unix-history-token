begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * First author: Michael Graff.  * Copyright (c) 1997-2000 Lan Media Corp. (www.lanmedia.com).  * All rights reserved.  *  * Second author: Andrew Stanley-Jones.  * Copyright (c) 2000-2002 SBE Corp. (www.sbei.com).  * All rights reserved.  *  * Third author: David Boggs.  * Copyright (c) 2002-2004 David Boggs. (boggs@boggs.palo-alto.ca.us).  * All rights reserved.  *  * BSD License:  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * GNU General Public License:  *  * This program is free software; you can redistribute it and/or modify it   * under the terms of the GNU General Public License as published by the Free   * Software Foundation; either version 2 of the License, or (at your option)   * any later version.  *   * This program is distributed in the hope that it will be useful, but WITHOUT   * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or   * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for   * more details.  *  * You should have received a copy of the GNU General Public License along with  * this program; if not, write to the Free Software Foundation, Inc., 59   * Temple Place - Suite 330, Boston, MA  02111-1307, USA.  *  * Description:  *  * This program configures the Unix/Linux device driver for SBE Corp's  *  wanADAPT and wanPMC series of Wide Area Network Interface Cards.  * There is a man page for this program; go find it.  *   * If Netgraph is present (FreeBSD only):  *    cc -o lmcconfig -l netgraph -D NETGRAPH lmcconfig.c  * If Netgraph is NOT present:  *    cc -o lmcconfig lmcconfig.c  * Install the executable program in /usr/local/sbin/lmcconfig.  *  * $FreeBSD$  */
end_comment

begin_escape
end_escape

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<inttypes.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<strings.h>
end_include

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|NETGRAPH
argument_list|)
end_if

begin_include
include|#
directive|include
file|<netgraph.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<dev/lmc/if_lmc.h>
end_include

begin_comment
comment|/* program global variables */
end_comment

begin_decl_stmt
name|char
modifier|*
name|progname
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* name of this program */
end_comment

begin_decl_stmt
name|char
modifier|*
name|ifname
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* interface name */
end_comment

begin_decl_stmt
name|int
name|fdcs
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* ifnet File Desc or ng Ctl Socket */
end_comment

begin_decl_stmt
name|struct
name|status
name|status
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* card status (read only) */
end_comment

begin_decl_stmt
name|struct
name|config
name|config
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* card configuration (read/write) */
end_comment

begin_decl_stmt
name|int
name|netgraph
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* non-zero if netgraph present */
end_comment

begin_decl_stmt
name|int
name|summary
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* print summary at end */
end_comment

begin_decl_stmt
name|int
name|update
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* update driver config */
end_comment

begin_decl_stmt
name|int
name|verbose
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* verbose output */
end_comment

begin_decl_stmt
name|u_int8_t
name|checksum
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* gate array ucode file checksum */
end_comment

begin_comment
comment|/* Functions currently unused. Keep compiler happy and provide prototypes. */
end_comment

begin_function_decl
name|void
name|ioctl_snmp_loop
parameter_list|(
name|u_int32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|init_srom
parameter_list|(
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|void
name|usage
parameter_list|(
name|void
parameter_list|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Usage: %s interface [-abBcCdDeEfhiLmMpPsStTuUvVwWxXyYzZ?]\n"
argument_list|,
name|progname
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"or\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Usage: %s interface -1 [-aABcdeEfFgiIlLpPstTuUvxX]\n"
argument_list|,
name|progname
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"or\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Usage: %s interface -3 [-aABcdefFlLsSvV]\n\n"
argument_list|,
name|progname
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\tInterface is the interface name, e.g. '%s'\n"
argument_list|,
name|ifname
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|NETGRAPH
argument_list|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\tIf interface name ends with ':' then use netgraph\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-1 following parameters apply to T1E1 cards\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-3 following parameters apply to T3 cards\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-a<number> Set Tx clock source, where:\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t   1:modem Tx clk 2:int src 3:modem Rx Clk 4:ext conn\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-b Read and print bios rom addrs 0-255\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-B Write bios rom with address pattern\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-c Set 16-bit CRC (default)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-C Set 32-bit CRC\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-d Clear driver DEBUG flag\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-D Set driver DEBUG flag (more log msgs)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-e Set DTE mode (default)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-E Set DCE mode\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-f<number> Set synth osc freq in bits/sec\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-F Set SPPP line protocol to Frame-Relay\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-h Help: this usage message\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-i Interface name (eg, lmc0)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-L<number> Set loopback: 1:none 2:payload 3:line 4:other\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t   5:inward 6:dual 16:Tulip 17:pins 18:LA/LL 19:LB/RL\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-m Read and print MII regs\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-M<addr><data> Write MII reg\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-p Read and print PCI config regs\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-P<addr><data> Write PCI config reg\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-s Read and print Tulip SROM\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-S<number> Initialize Tulip SROM\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-t Read and print Tulip Control/Status regs\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-T<addr><data> Write Tulip Control/status reg\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-u Reset event counters\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-U Reset gate array\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-v Set verbose printout mode\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-V Print card configuration\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-w Load gate array from ROM\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-W<filename> Load gate array from file\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-x select RAWIP mode and bypass line protocols\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-X Select line protocols: SPPP, P2P or HDLC\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-y disable SPPP keep-alive packets\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-Y enable SPPP keep-alive packets\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-z Set SPPP line protocol to Cisco-HDLC\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-Z Set SPPP line protocol to PPP\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"The -1 switch precedes T1/E1 commands.\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-a<y|b|a> Stop  sending Yellow|Blue|AIS signal\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-A<y|b|a> Start sending Yellow|Blue|AIS signal\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-B<number> Send BOP msg 25 times\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-c<number> Set cable length in meters\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-d Print status of T1 DSU/CSU\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-e<number> Set framing format, where:\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t   27:T1-ESF 9:T1-SF 0:E1-FAS 8:E1-FAS+CRC\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t   16:E1-FAS+CAS 24:E1-FAS+CRC+CAS 32:E1-NO-FRAMING\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-E<32-bit hex number> 1 activates a channel and 0 deactivates it.\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t   Use this to config a link in fractional T1/E1 mode\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-f Read and print Framer/LIU registers\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-F<addr><data> Write Framer/LIU register\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-g<number> Set receiver gain, where:\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t   0:short range  1:medium range\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t   2:long range   3:extended range\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t   4:auto-set based on cable length\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-i Send 'CSU Loop Down' inband msg\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-I Send 'CSU Loop Up' inband msg\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-l Send 'Line Loop Down' BOP msg\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-L Send 'Line Loop Up' BOP msg\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-p Send 'Payload Loop Down' BOP msg\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-P Send 'Payload Loop Up' BOP msg\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-s Print status of T1 DSU/CSU\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-t Stop sending test pattern\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-T<number> Start sending test pattern, where:\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t    0:unframed 2^11       1:unframed 2^15\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t    2:unframed 2^20       3:unframed 2^23\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t    4:unframed 2^11 w/ZS  5:unframed 2^15 w/ZS\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t    6:unframed QRSS       7:unframed 2^23 w/ZS\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t    8:  framed 2^11       9:  framed 2^15\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t   10:  framed 2^20      11:  framed 2^23\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t   12:  framed 2^11 w/ZS 13:  framed 2^15 w/ZS\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t   14:  framed QRSS      15:  framed 2^23 w/ZS\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-u<number> Set transmitter pulse shape, where:\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t   0:T1-DSX   0-40m       1:T1-DSX  40-80m\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t   2:T1-DSX  80-120m      3:T1-DSX 120-160m\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t   4:T1-DSX 160-200m      5:E1-G.703 75ohm coax\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t   6:E1-G.703 120ohm TP   7:T1-CSU Long range\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t   8:auto-set based on cable length (T1 only)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-U<number> Set line build out where:\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t   0:0dB 1:7.5dB 2:15dB 3:22.5dB\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t   4:auto-set based on cable length\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-v Set verbose printout mode\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-x disable Transmitter outputs\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-X enable  Transmitter outputs\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"The -3 switch precedes T3 commands.\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-a<y|b|a|i> Stop  sending Yellow|Blue|AIS|Idle signal\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-A<y|b|a|i> Start sending Yellow|Blue|AIS|Idle signal\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-B<bopcode> Send BOP msg 10 times\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-c<number> Set cable length in meters\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-d Print status of T3 DSU/CSU\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-e<number> Set T3 frame format, where:\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t   100:C-Bit Parity  101:M13\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-f Read and print Framer registers\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-F<addr><data> Write Framer register\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-l Send 'Line Loop Down' BOP msg\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-L Send 'Line Loop Up' BOP msg\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-s Print status of T3 DSU/CSU\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-S<number> Set DS3 scrambler mode, where:\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t   1:OFF 2:DigitalLink|Kentrox 3:Larse\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-v Set verbose printout mode\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-V<number> Write to T3 VCXO freq control DAC\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|call_driver
parameter_list|(
name|unsigned
name|long
name|cmd
parameter_list|,
name|struct
name|iohdr
modifier|*
name|iohdr
parameter_list|)
block|{
name|int
name|error
init|=
literal|0
decl_stmt|;
name|strncpy
argument_list|(
name|iohdr
operator|->
name|ifname
argument_list|,
name|ifname
argument_list|,
sizeof|sizeof
argument_list|(
name|iohdr
operator|->
name|ifname
argument_list|)
argument_list|)
expr_stmt|;
name|iohdr
operator|->
name|cookie
operator|=
name|NGM_LMC_COOKIE
expr_stmt|;
name|iohdr
operator|->
name|iohdr
operator|=
name|iohdr
expr_stmt|;
comment|/* Exchange data with a running device driver. */
if|#
directive|if
name|defined
argument_list|(
name|NETGRAPH
argument_list|)
if|if
condition|(
name|netgraph
condition|)
block|{
name|NgSendMsg
argument_list|(
name|fdcs
argument_list|,
name|ifname
argument_list|,
name|NGM_LMC_COOKIE
argument_list|,
name|cmd
argument_list|,
name|iohdr
argument_list|,
name|IOCPARM_LEN
argument_list|(
name|cmd
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd
operator|&
name|IOC_OUT
condition|)
block|{
name|int
name|replen
init|=
sizeof|sizeof
argument_list|(
expr|struct
name|ng_mesg
argument_list|)
operator|+
name|IOCPARM_LEN
argument_list|(
name|cmd
argument_list|)
decl_stmt|;
name|char
name|rep
index|[
name|replen
index|]
decl_stmt|;
comment|/* storage for the reply */
name|struct
name|ng_mesg
modifier|*
name|reply
init|=
operator|(
expr|struct
name|ng_mesg
operator|*
operator|)
name|rep
decl_stmt|;
name|int
name|rl
init|=
name|NgRecvMsg
argument_list|(
name|fdcs
argument_list|,
name|reply
argument_list|,
name|replen
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
if|if
condition|(
name|rl
operator|==
name|replen
condition|)
name|bcopy
argument_list|(
operator|&
name|reply
operator|->
name|data
argument_list|,
name|iohdr
argument_list|,
name|IOCPARM_LEN
argument_list|(
name|cmd
argument_list|)
argument_list|)
expr_stmt|;
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: NgRecvMsg returned %d bytes, expected %d\n"
argument_list|,
name|progname
argument_list|,
name|rl
argument_list|,
name|replen
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
endif|#
directive|endif
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|ioctl
argument_list|(
name|fdcs
argument_list|,
name|cmd
argument_list|,
operator|(
name|caddr_t
operator|)
name|iohdr
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: ioctl() returned error code %d: %s\n"
argument_list|,
name|progname
argument_list|,
name|errno
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|errno
operator|==
name|ENETDOWN
condition|)
name|printf
argument_list|(
literal|"Type: 'ifconfig %s up' then try again.\n"
argument_list|,
name|ifname
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|iohdr
operator|->
name|cookie
operator|!=
name|NGM_LMC_COOKIE
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: cookie = 0x%08X, expected 0x%08X\n"
argument_list|,
name|progname
argument_list|,
name|iohdr
operator|->
name|cookie
argument_list|,
name|NGM_LMC_COOKIE
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: This version of %s is incompatible with the device driver\n"
argument_list|,
name|progname
argument_list|,
name|progname
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|u_int32_t
name|read_pci_config
parameter_list|(
name|u_int8_t
name|addr
parameter_list|)
block|{
name|struct
name|ioctl
name|ioctl
decl_stmt|;
name|ioctl
operator|.
name|iohdr
operator|.
name|direction
operator|=
name|DIR_IOWR
expr_stmt|;
name|ioctl
operator|.
name|iohdr
operator|.
name|length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ioctl
argument_list|)
expr_stmt|;
name|ioctl
operator|.
name|cmd
operator|=
name|IOCTL_RW_PCI
expr_stmt|;
name|ioctl
operator|.
name|address
operator|=
name|addr
expr_stmt|;
name|call_driver
argument_list|(
name|LMCIOCREAD
argument_list|,
operator|&
name|ioctl
operator|.
name|iohdr
argument_list|)
expr_stmt|;
return|return
name|ioctl
operator|.
name|data
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|write_pci_config
parameter_list|(
name|u_int8_t
name|addr
parameter_list|,
name|u_int32_t
name|data
parameter_list|)
block|{
name|struct
name|ioctl
name|ioctl
decl_stmt|;
name|ioctl
operator|.
name|iohdr
operator|.
name|direction
operator|=
name|DIR_IOW
expr_stmt|;
name|ioctl
operator|.
name|iohdr
operator|.
name|length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ioctl
argument_list|)
expr_stmt|;
name|ioctl
operator|.
name|cmd
operator|=
name|IOCTL_RW_PCI
expr_stmt|;
name|ioctl
operator|.
name|address
operator|=
name|addr
expr_stmt|;
name|ioctl
operator|.
name|data
operator|=
name|data
expr_stmt|;
name|call_driver
argument_list|(
name|LMCIOCWRITE
argument_list|,
operator|&
name|ioctl
operator|.
name|iohdr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|u_int32_t
name|read_csr
parameter_list|(
name|u_int8_t
name|addr
parameter_list|)
block|{
name|struct
name|ioctl
name|ioctl
decl_stmt|;
name|ioctl
operator|.
name|iohdr
operator|.
name|direction
operator|=
name|DIR_IOWR
expr_stmt|;
name|ioctl
operator|.
name|iohdr
operator|.
name|length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ioctl
argument_list|)
expr_stmt|;
name|ioctl
operator|.
name|cmd
operator|=
name|IOCTL_RW_CSR
expr_stmt|;
name|ioctl
operator|.
name|address
operator|=
name|addr
expr_stmt|;
name|call_driver
argument_list|(
name|LMCIOCREAD
argument_list|,
operator|&
name|ioctl
operator|.
name|iohdr
argument_list|)
expr_stmt|;
return|return
name|ioctl
operator|.
name|data
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|write_csr
parameter_list|(
name|u_int8_t
name|addr
parameter_list|,
name|u_int32_t
name|data
parameter_list|)
block|{
name|struct
name|ioctl
name|ioctl
decl_stmt|;
name|ioctl
operator|.
name|iohdr
operator|.
name|direction
operator|=
name|DIR_IOW
expr_stmt|;
name|ioctl
operator|.
name|iohdr
operator|.
name|length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ioctl
argument_list|)
expr_stmt|;
name|ioctl
operator|.
name|cmd
operator|=
name|IOCTL_RW_CSR
expr_stmt|;
name|ioctl
operator|.
name|address
operator|=
name|addr
expr_stmt|;
name|ioctl
operator|.
name|data
operator|=
name|data
expr_stmt|;
name|call_driver
argument_list|(
name|LMCIOCWRITE
argument_list|,
operator|&
name|ioctl
operator|.
name|iohdr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|u_int16_t
name|read_srom
parameter_list|(
name|u_int8_t
name|addr
parameter_list|)
block|{
name|struct
name|ioctl
name|ioctl
decl_stmt|;
name|ioctl
operator|.
name|iohdr
operator|.
name|direction
operator|=
name|DIR_IOWR
expr_stmt|;
name|ioctl
operator|.
name|iohdr
operator|.
name|length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ioctl
argument_list|)
expr_stmt|;
name|ioctl
operator|.
name|cmd
operator|=
name|IOCTL_RW_SROM
expr_stmt|;
name|ioctl
operator|.
name|address
operator|=
name|addr
expr_stmt|;
name|call_driver
argument_list|(
name|LMCIOCREAD
argument_list|,
operator|&
name|ioctl
operator|.
name|iohdr
argument_list|)
expr_stmt|;
return|return
name|ioctl
operator|.
name|data
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|write_srom
parameter_list|(
name|u_int8_t
name|addr
parameter_list|,
name|u_int16_t
name|data
parameter_list|)
block|{
name|struct
name|ioctl
name|ioctl
decl_stmt|;
name|ioctl
operator|.
name|iohdr
operator|.
name|direction
operator|=
name|DIR_IOW
expr_stmt|;
name|ioctl
operator|.
name|iohdr
operator|.
name|length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ioctl
argument_list|)
expr_stmt|;
name|ioctl
operator|.
name|cmd
operator|=
name|IOCTL_RW_SROM
expr_stmt|;
name|ioctl
operator|.
name|address
operator|=
name|addr
expr_stmt|;
name|ioctl
operator|.
name|data
operator|=
name|data
expr_stmt|;
name|call_driver
argument_list|(
name|LMCIOCWRITE
argument_list|,
operator|&
name|ioctl
operator|.
name|iohdr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|u_int8_t
name|read_bios_rom
parameter_list|(
name|u_int32_t
name|addr
parameter_list|)
block|{
name|struct
name|ioctl
name|ioctl
decl_stmt|;
name|ioctl
operator|.
name|iohdr
operator|.
name|direction
operator|=
name|DIR_IOWR
expr_stmt|;
name|ioctl
operator|.
name|iohdr
operator|.
name|length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ioctl
argument_list|)
expr_stmt|;
name|ioctl
operator|.
name|cmd
operator|=
name|IOCTL_RW_BIOS
expr_stmt|;
name|ioctl
operator|.
name|address
operator|=
name|addr
expr_stmt|;
name|call_driver
argument_list|(
name|LMCIOCREAD
argument_list|,
operator|&
name|ioctl
operator|.
name|iohdr
argument_list|)
expr_stmt|;
return|return
name|ioctl
operator|.
name|data
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|write_bios_rom
parameter_list|(
name|u_int32_t
name|addr
parameter_list|,
name|u_int8_t
name|data
parameter_list|)
block|{
name|struct
name|ioctl
name|ioctl
decl_stmt|;
name|ioctl
operator|.
name|iohdr
operator|.
name|direction
operator|=
name|DIR_IOW
expr_stmt|;
name|ioctl
operator|.
name|iohdr
operator|.
name|length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ioctl
argument_list|)
expr_stmt|;
name|ioctl
operator|.
name|cmd
operator|=
name|IOCTL_RW_BIOS
expr_stmt|;
name|ioctl
operator|.
name|address
operator|=
name|addr
expr_stmt|;
name|ioctl
operator|.
name|data
operator|=
name|data
expr_stmt|;
name|call_driver
argument_list|(
name|LMCIOCWRITE
argument_list|,
operator|&
name|ioctl
operator|.
name|iohdr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|u_int16_t
name|read_mii
parameter_list|(
name|u_int8_t
name|addr
parameter_list|)
block|{
name|struct
name|ioctl
name|ioctl
decl_stmt|;
name|ioctl
operator|.
name|iohdr
operator|.
name|direction
operator|=
name|DIR_IOWR
expr_stmt|;
name|ioctl
operator|.
name|iohdr
operator|.
name|length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ioctl
argument_list|)
expr_stmt|;
name|ioctl
operator|.
name|cmd
operator|=
name|IOCTL_RW_MII
expr_stmt|;
name|ioctl
operator|.
name|address
operator|=
name|addr
expr_stmt|;
name|call_driver
argument_list|(
name|LMCIOCREAD
argument_list|,
operator|&
name|ioctl
operator|.
name|iohdr
argument_list|)
expr_stmt|;
return|return
name|ioctl
operator|.
name|data
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|write_mii
parameter_list|(
name|u_int8_t
name|addr
parameter_list|,
name|u_int16_t
name|data
parameter_list|)
block|{
name|struct
name|ioctl
name|ioctl
decl_stmt|;
name|ioctl
operator|.
name|iohdr
operator|.
name|direction
operator|=
name|DIR_IOW
expr_stmt|;
name|ioctl
operator|.
name|iohdr
operator|.
name|length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ioctl
argument_list|)
expr_stmt|;
name|ioctl
operator|.
name|cmd
operator|=
name|IOCTL_RW_MII
expr_stmt|;
name|ioctl
operator|.
name|address
operator|=
name|addr
expr_stmt|;
name|ioctl
operator|.
name|data
operator|=
name|data
expr_stmt|;
name|call_driver
argument_list|(
name|LMCIOCWRITE
argument_list|,
operator|&
name|ioctl
operator|.
name|iohdr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|unsigned
name|char
name|read_framer
parameter_list|(
name|u_int16_t
name|addr
parameter_list|)
block|{
name|struct
name|ioctl
name|ioctl
decl_stmt|;
name|ioctl
operator|.
name|iohdr
operator|.
name|direction
operator|=
name|DIR_IOWR
expr_stmt|;
name|ioctl
operator|.
name|iohdr
operator|.
name|length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ioctl
argument_list|)
expr_stmt|;
name|ioctl
operator|.
name|cmd
operator|=
name|IOCTL_RW_FRAME
expr_stmt|;
name|ioctl
operator|.
name|address
operator|=
name|addr
expr_stmt|;
name|call_driver
argument_list|(
name|LMCIOCREAD
argument_list|,
operator|&
name|ioctl
operator|.
name|iohdr
argument_list|)
expr_stmt|;
return|return
name|ioctl
operator|.
name|data
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|write_framer
parameter_list|(
name|u_int16_t
name|addr
parameter_list|,
name|u_int8_t
name|data
parameter_list|)
block|{
name|struct
name|ioctl
name|ioctl
decl_stmt|;
name|ioctl
operator|.
name|iohdr
operator|.
name|direction
operator|=
name|DIR_IOW
expr_stmt|;
name|ioctl
operator|.
name|iohdr
operator|.
name|length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ioctl
argument_list|)
expr_stmt|;
name|ioctl
operator|.
name|cmd
operator|=
name|IOCTL_RW_FRAME
expr_stmt|;
name|ioctl
operator|.
name|address
operator|=
name|addr
expr_stmt|;
name|ioctl
operator|.
name|data
operator|=
name|data
expr_stmt|;
name|call_driver
argument_list|(
name|LMCIOCWRITE
argument_list|,
operator|&
name|ioctl
operator|.
name|iohdr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|write_synth
parameter_list|(
name|struct
name|synth
name|synth
parameter_list|)
block|{
name|struct
name|ioctl
name|ioctl
decl_stmt|;
name|ioctl
operator|.
name|iohdr
operator|.
name|direction
operator|=
name|DIR_IOW
expr_stmt|;
name|ioctl
operator|.
name|iohdr
operator|.
name|length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ioctl
argument_list|)
expr_stmt|;
name|ioctl
operator|.
name|cmd
operator|=
name|IOCTL_WO_SYNTH
expr_stmt|;
name|bcopy
argument_list|(
operator|&
name|synth
argument_list|,
operator|&
name|ioctl
operator|.
name|data
argument_list|,
sizeof|sizeof
argument_list|(
name|synth
argument_list|)
argument_list|)
expr_stmt|;
name|call_driver
argument_list|(
name|LMCIOCWRITE
argument_list|,
operator|&
name|ioctl
operator|.
name|iohdr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|write_dac
parameter_list|(
name|u_int16_t
name|data
parameter_list|)
block|{
name|struct
name|ioctl
name|ioctl
decl_stmt|;
name|ioctl
operator|.
name|iohdr
operator|.
name|direction
operator|=
name|DIR_IOW
expr_stmt|;
name|ioctl
operator|.
name|iohdr
operator|.
name|length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ioctl
argument_list|)
expr_stmt|;
name|ioctl
operator|.
name|cmd
operator|=
name|IOCTL_WO_DAC
expr_stmt|;
name|ioctl
operator|.
name|data
operator|=
name|data
expr_stmt|;
name|call_driver
argument_list|(
name|LMCIOCWRITE
argument_list|,
operator|&
name|ioctl
operator|.
name|iohdr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|reset_xilinx
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|ioctl
name|ioctl
decl_stmt|;
name|ioctl
operator|.
name|iohdr
operator|.
name|direction
operator|=
name|DIR_IOWR
expr_stmt|;
name|ioctl
operator|.
name|iohdr
operator|.
name|length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ioctl
argument_list|)
expr_stmt|;
name|ioctl
operator|.
name|cmd
operator|=
name|IOCTL_XILINX_RESET
expr_stmt|;
name|call_driver
argument_list|(
name|LMCIOCTL
argument_list|,
operator|&
name|ioctl
operator|.
name|iohdr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|load_xilinx_from_rom
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|ioctl
name|ioctl
decl_stmt|;
name|ioctl
operator|.
name|iohdr
operator|.
name|direction
operator|=
name|DIR_IOWR
expr_stmt|;
name|ioctl
operator|.
name|iohdr
operator|.
name|length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ioctl
argument_list|)
expr_stmt|;
name|ioctl
operator|.
name|cmd
operator|=
name|IOCTL_XILINX_ROM
expr_stmt|;
name|call_driver
argument_list|(
name|LMCIOCTL
argument_list|,
operator|&
name|ioctl
operator|.
name|iohdr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|load_xilinx_from_file
parameter_list|(
name|char
modifier|*
name|ucode
parameter_list|,
name|u_int32_t
name|len
parameter_list|)
block|{
name|struct
name|ioctl
name|ioctl
decl_stmt|;
name|ioctl
operator|.
name|iohdr
operator|.
name|direction
operator|=
name|DIR_IOWR
expr_stmt|;
name|ioctl
operator|.
name|iohdr
operator|.
name|length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ioctl
argument_list|)
expr_stmt|;
name|ioctl
operator|.
name|cmd
operator|=
name|IOCTL_XILINX_FILE
expr_stmt|;
name|ioctl
operator|.
name|data
operator|=
name|len
expr_stmt|;
name|ioctl
operator|.
name|ucode
operator|=
name|ucode
expr_stmt|;
name|call_driver
argument_list|(
name|LMCIOCTL
argument_list|,
operator|&
name|ioctl
operator|.
name|iohdr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ioctl_snmp_send
parameter_list|(
name|u_int32_t
name|send
parameter_list|)
block|{
name|struct
name|ioctl
name|ioctl
decl_stmt|;
name|ioctl
operator|.
name|iohdr
operator|.
name|direction
operator|=
name|DIR_IOWR
expr_stmt|;
name|ioctl
operator|.
name|iohdr
operator|.
name|length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ioctl
argument_list|)
expr_stmt|;
name|ioctl
operator|.
name|cmd
operator|=
name|IOCTL_SNMP_SEND
expr_stmt|;
name|ioctl
operator|.
name|data
operator|=
name|send
expr_stmt|;
name|call_driver
argument_list|(
name|LMCIOCTL
argument_list|,
operator|&
name|ioctl
operator|.
name|iohdr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ioctl_snmp_loop
parameter_list|(
name|u_int32_t
name|loop
parameter_list|)
block|{
name|struct
name|ioctl
name|ioctl
decl_stmt|;
name|ioctl
operator|.
name|iohdr
operator|.
name|direction
operator|=
name|DIR_IOWR
expr_stmt|;
name|ioctl
operator|.
name|iohdr
operator|.
name|length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ioctl
argument_list|)
expr_stmt|;
name|ioctl
operator|.
name|cmd
operator|=
name|IOCTL_SNMP_LOOP
expr_stmt|;
name|ioctl
operator|.
name|data
operator|=
name|loop
expr_stmt|;
name|call_driver
argument_list|(
name|LMCIOCTL
argument_list|,
operator|&
name|ioctl
operator|.
name|iohdr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ioctl_reset_cntrs
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|ioctl
name|ioctl
decl_stmt|;
name|ioctl
operator|.
name|iohdr
operator|.
name|direction
operator|=
name|DIR_IOWR
expr_stmt|;
name|ioctl
operator|.
name|iohdr
operator|.
name|length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ioctl
argument_list|)
expr_stmt|;
name|ioctl
operator|.
name|cmd
operator|=
name|IOCTL_RESET_CNTRS
expr_stmt|;
name|call_driver
argument_list|(
name|LMCIOCTL
argument_list|,
operator|&
name|ioctl
operator|.
name|iohdr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ioctl_read_config
parameter_list|(
name|void
parameter_list|)
block|{
name|config
operator|.
name|iohdr
operator|.
name|direction
operator|=
name|DIR_IOWR
expr_stmt|;
name|config
operator|.
name|iohdr
operator|.
name|length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|config
argument_list|)
expr_stmt|;
name|call_driver
argument_list|(
name|LMCIOCGCFG
argument_list|,
operator|&
name|config
operator|.
name|iohdr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ioctl_write_config
parameter_list|(
name|void
parameter_list|)
block|{
name|config
operator|.
name|iohdr
operator|.
name|direction
operator|=
name|DIR_IOW
expr_stmt|;
name|config
operator|.
name|iohdr
operator|.
name|length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|config
argument_list|)
expr_stmt|;
name|call_driver
argument_list|(
name|LMCIOCSCFG
argument_list|,
operator|&
name|config
operator|.
name|iohdr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ioctl_read_status
parameter_list|(
name|void
parameter_list|)
block|{
name|status
operator|.
name|iohdr
operator|.
name|direction
operator|=
name|DIR_IOWR
expr_stmt|;
name|status
operator|.
name|iohdr
operator|.
name|length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|status
argument_list|)
expr_stmt|;
name|call_driver
argument_list|(
name|LMCIOCGSTAT
argument_list|,
operator|&
name|status
operator|.
name|iohdr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_card_name
parameter_list|(
name|void
parameter_list|)
block|{
name|printf
argument_list|(
literal|"Card name:\t\t%s\n"
argument_list|,
name|ifname
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_card_type
parameter_list|(
name|void
parameter_list|)
block|{
name|printf
argument_list|(
literal|"Card type:\t\t"
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|status
operator|.
name|card_type
condition|)
block|{
case|case
name|TLP_CSID_HSSI
case|:
name|printf
argument_list|(
literal|"HSSI (lmc5200)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|TLP_CSID_T3
case|:
name|printf
argument_list|(
literal|"T3 (lmc5245)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|TLP_CSID_SSI
case|:
name|printf
argument_list|(
literal|"SSI (lmc1000)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|TLP_CSID_T1E1
case|:
name|printf
argument_list|(
literal|"T1E1 (lmc1200)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|TLP_CSID_HSSIc
case|:
name|printf
argument_list|(
literal|"HSSI (lmc5200C)\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"unknown card_type: %d\n"
argument_list|,
name|status
operator|.
name|card_type
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|print_status
parameter_list|(
name|void
parameter_list|)
block|{
name|char
modifier|*
name|status_string
decl_stmt|;
if|if
condition|(
name|status
operator|.
name|oper_status
operator|==
name|STATUS_UP
condition|)
name|status_string
operator|=
literal|"Up"
expr_stmt|;
elseif|else
if|if
condition|(
name|status
operator|.
name|oper_status
operator|==
name|STATUS_DOWN
condition|)
name|status_string
operator|=
literal|"Down"
expr_stmt|;
elseif|else
if|if
condition|(
name|status
operator|.
name|oper_status
operator|==
name|STATUS_TEST
condition|)
name|status_string
operator|=
literal|"Test"
expr_stmt|;
else|else
name|status_string
operator|=
literal|"Unknown"
expr_stmt|;
name|printf
argument_list|(
literal|"Link status:\t\t%s\n"
argument_list|,
name|status_string
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_tx_speed
parameter_list|(
name|void
parameter_list|)
block|{
name|printf
argument_list|(
literal|"Tx Speed:\t\t%u\n"
argument_list|,
name|status
operator|.
name|tx_speed
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_debug
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
name|config
operator|.
name|debug
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"Debug:\t\t\t%s\n"
argument_list|,
literal|"On"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_line_prot
parameter_list|(
name|void
parameter_list|)
block|{
name|char
modifier|*
name|on
init|=
literal|"On"
decl_stmt|,
modifier|*
name|off
init|=
literal|"Off"
decl_stmt|;
name|printf
argument_list|(
literal|"Line Prot/Pkg:\t\t"
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|status
operator|.
name|line_prot
condition|)
block|{
case|case
literal|0
case|:
name|printf
argument_list|(
literal|"NotSet/"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PROT_PPP
case|:
name|printf
argument_list|(
literal|"PPP/"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PROT_C_HDLC
case|:
name|printf
argument_list|(
literal|"Cisco-HDLC/"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PROT_FRM_RLY
case|:
name|printf
argument_list|(
literal|"Frame-Relay/"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PROT_IP_HDLC
case|:
name|printf
argument_list|(
literal|"IP-in-HDLC/"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PROT_ETH_HDLC
case|:
name|printf
argument_list|(
literal|"Ether-in-HDLC/"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PROT_X25
case|:
name|printf
argument_list|(
literal|"X25+LAPB/"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"unknown line_prot: %d/"
argument_list|,
name|status
operator|.
name|line_prot
argument_list|)
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
name|status
operator|.
name|line_pkg
condition|)
block|{
case|case
literal|0
case|:
name|printf
argument_list|(
literal|"NotSet\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PKG_RAWIP
case|:
name|printf
argument_list|(
literal|"Driver\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PKG_NG
case|:
name|printf
argument_list|(
literal|"Netgraph\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PKG_GEN_HDLC
case|:
name|printf
argument_list|(
literal|"GenHDLC\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PKG_SPPP
case|:
name|printf
argument_list|(
literal|"SPPP\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PKG_P2P
case|:
name|printf
argument_list|(
literal|"P2P\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"unknown line_pkg: %d\n"
argument_list|,
name|status
operator|.
name|line_pkg
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|status
operator|.
name|line_pkg
operator|==
name|PKG_SPPP
condition|)
name|printf
argument_list|(
literal|"SPPP Keep-alives:\t%s\n"
argument_list|,
name|config
operator|.
name|keep_alive
condition|?
name|on
else|:
name|off
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_crc_len
parameter_list|(
name|void
parameter_list|)
block|{
name|printf
argument_list|(
literal|"CRC length:\t\t"
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|.
name|crc_len
operator|==
name|CFG_CRC_0
condition|)
name|printf
argument_list|(
literal|"no CRC\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|config
operator|.
name|crc_len
operator|==
name|CFG_CRC_16
condition|)
name|printf
argument_list|(
literal|"16 bits\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|config
operator|.
name|crc_len
operator|==
name|CFG_CRC_32
condition|)
name|printf
argument_list|(
literal|"32 bits\n"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"bad crc_len: %d\n"
argument_list|,
name|config
operator|.
name|crc_len
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_loop_back
parameter_list|(
name|void
parameter_list|)
block|{
name|printf
argument_list|(
literal|"Loopback:\t\t"
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|config
operator|.
name|loop_back
condition|)
block|{
case|case
name|CFG_LOOP_NONE
case|:
name|printf
argument_list|(
literal|"None\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|CFG_LOOP_PAYLOAD
case|:
name|printf
argument_list|(
literal|"Outward thru framer (payload loop)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|CFG_LOOP_LINE
case|:
name|printf
argument_list|(
literal|"Outward thru line interface (line loop)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|CFG_LOOP_OTHER
case|:
name|printf
argument_list|(
literal|"Inward thru line interface\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|CFG_LOOP_INWARD
case|:
name|printf
argument_list|(
literal|"Inward thru framer\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|CFG_LOOP_DUAL
case|:
name|printf
argument_list|(
literal|"Inward& outward (dual loop)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|CFG_LOOP_TULIP
case|:
name|printf
argument_list|(
literal|"Inward thru Tulip chip\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|CFG_LOOP_PINS
case|:
name|printf
argument_list|(
literal|"Inward thru drvrs/rcvrs\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|CFG_LOOP_LL
case|:
name|printf
argument_list|(
literal|"LA/LL asserted\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|CFG_LOOP_RL
case|:
name|printf
argument_list|(
literal|"LB/RL asserted\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"unknown loop_back: %d\n"
argument_list|,
name|config
operator|.
name|loop_back
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|print_tx_clk_src
parameter_list|(
name|void
parameter_list|)
block|{
name|printf
argument_list|(
literal|"Tx Clk src:\t\t"
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|config
operator|.
name|tx_clk_src
condition|)
block|{
case|case
name|CFG_CLKMUX_ST
case|:
name|printf
argument_list|(
literal|"Tx Clk from modem\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|CFG_CLKMUX_INT
case|:
name|printf
argument_list|(
literal|"Internal source\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|CFG_CLKMUX_RT
case|:
name|printf
argument_list|(
literal|"Rx Clk from modem (loop timed)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|CFG_CLKMUX_EXT
case|:
name|printf
argument_list|(
literal|"External connector\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"unknown tx_clk_src: %d\n"
argument_list|,
name|config
operator|.
name|tx_clk_src
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|print_format
parameter_list|(
name|void
parameter_list|)
block|{
name|printf
argument_list|(
literal|"Format-Frame/Code:\t"
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|config
operator|.
name|format
condition|)
block|{
case|case
name|CFG_FORMAT_T1SF
case|:
name|printf
argument_list|(
literal|"T1-SF/AMI\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|CFG_FORMAT_T1ESF
case|:
name|printf
argument_list|(
literal|"T1-ESF/B8ZS\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|CFG_FORMAT_E1FAS
case|:
name|printf
argument_list|(
literal|"E1-FAS/HDB3\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|CFG_FORMAT_E1FASCRC
case|:
name|printf
argument_list|(
literal|"E1-FAS+CRC/HDB3\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|CFG_FORMAT_E1FASCAS
case|:
name|printf
argument_list|(
literal|"E1-FAS+CAS/HDB3\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|CFG_FORMAT_E1FASCRCCAS
case|:
name|printf
argument_list|(
literal|"E1-FAS+CRC+CAS/HDB3\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|CFG_FORMAT_E1NONE
case|:
name|printf
argument_list|(
literal|"E1-NOFRAMING/HDB3\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|CFG_FORMAT_T3CPAR
case|:
name|printf
argument_list|(
literal|"T3-CParity/B3ZS\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|CFG_FORMAT_T3M13
case|:
name|printf
argument_list|(
literal|"T3-M13/B3ZS\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"unknown format: %d\n"
argument_list|,
name|config
operator|.
name|format
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|print_dte_dce
parameter_list|(
name|void
parameter_list|)
block|{
name|printf
argument_list|(
literal|"DTE or DCE:\t\t"
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|config
operator|.
name|dte_dce
condition|)
block|{
case|case
name|CFG_DTE
case|:
name|printf
argument_list|(
literal|"DTE (receiving TxClk)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|CFG_DCE
case|:
name|printf
argument_list|(
literal|"DCE (driving TxClk)\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"unknown dte_dce: %d\n"
argument_list|,
name|config
operator|.
name|dte_dce
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|print_synth_freq
parameter_list|(
name|void
parameter_list|)
block|{
name|double
name|Fref
init|=
literal|20e6
decl_stmt|;
name|double
name|Fout
decl_stmt|,
name|Fvco
decl_stmt|;
comment|/* decode the synthesizer params */
name|Fvco
operator|=
operator|(
name|Fref
operator|*
operator|(
name|config
operator|.
name|synth
operator|.
name|n
operator|<<
operator|(
literal|3
operator|*
name|config
operator|.
name|synth
operator|.
name|v
operator|)
operator|)
operator|)
operator|/
name|config
operator|.
name|synth
operator|.
name|m
expr_stmt|;
name|Fout
operator|=
name|Fvco
operator|/
operator|(
literal|1
operator|<<
operator|(
name|config
operator|.
name|synth
operator|.
name|x
operator|+
name|config
operator|.
name|synth
operator|.
name|r
operator|+
name|config
operator|.
name|synth
operator|.
name|prescale
operator|)
operator|)
expr_stmt|;
name|printf
argument_list|(
literal|"Synth freq:\t\t%.0f\n"
argument_list|,
name|Fout
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|synth_freq
parameter_list|(
name|unsigned
name|long
name|target
parameter_list|)
block|{
name|unsigned
name|int
name|n
decl_stmt|,
name|m
decl_stmt|,
name|v
decl_stmt|,
name|x
decl_stmt|,
name|r
decl_stmt|;
name|double
name|Fout
decl_stmt|,
name|Fvco
decl_stmt|,
name|Ftarg
decl_stmt|;
name|double
name|newdiff
decl_stmt|,
name|olddiff
decl_stmt|;
name|double
name|bestF
init|=
literal|0.0
decl_stmt|,
name|bestV
init|=
literal|0.0
decl_stmt|;
name|unsigned
name|prescale
init|=
operator|(
name|target
operator|<
literal|50000
operator|)
condition|?
literal|9
else|:
literal|4
decl_stmt|;
name|Ftarg
operator|=
name|target
operator|<<
name|prescale
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|3
init|;
name|n
operator|<=
literal|127
condition|;
name|n
operator|++
control|)
for|for
control|(
name|m
operator|=
literal|3
init|;
name|m
operator|<=
literal|127
condition|;
name|m
operator|++
control|)
for|for
control|(
name|v
operator|=
literal|0
init|;
name|v
operator|<=
literal|1
condition|;
name|v
operator|++
control|)
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|<=
literal|3
condition|;
name|x
operator|++
control|)
for|for
control|(
name|r
operator|=
literal|0
init|;
name|r
operator|<=
literal|3
condition|;
name|r
operator|++
control|)
block|{
name|Fvco
operator|=
operator|(
name|SYNTH_FREF
operator|*
operator|(
name|n
operator|<<
operator|(
literal|3
operator|*
name|v
operator|)
operator|)
operator|)
operator|/
name|m
expr_stmt|;
if|if
condition|(
name|Fvco
operator|<
name|SYNTH_FMIN
operator|||
name|Fvco
operator|>
name|SYNTH_FMAX
condition|)
continue|continue;
name|Fout
operator|=
name|Fvco
operator|/
operator|(
literal|1
operator|<<
operator|(
name|x
operator|+
name|r
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|Fout
operator|>=
name|Ftarg
condition|)
name|newdiff
operator|=
name|Fout
operator|-
name|Ftarg
expr_stmt|;
else|else
name|newdiff
operator|=
name|Ftarg
operator|-
name|Fout
expr_stmt|;
if|if
condition|(
name|bestF
operator|>=
name|Ftarg
condition|)
name|olddiff
operator|=
name|bestF
operator|-
name|Ftarg
expr_stmt|;
else|else
name|olddiff
operator|=
name|Ftarg
operator|-
name|bestF
expr_stmt|;
if|if
condition|(
operator|(
name|newdiff
operator|<
name|olddiff
operator|)
operator|||
operator|(
operator|(
name|newdiff
operator|==
name|olddiff
operator|)
operator|&&
operator|(
name|Fvco
operator|<
name|bestV
operator|)
operator|)
condition|)
block|{
name|config
operator|.
name|synth
operator|.
name|n
operator|=
name|n
expr_stmt|;
name|config
operator|.
name|synth
operator|.
name|m
operator|=
name|m
expr_stmt|;
name|config
operator|.
name|synth
operator|.
name|v
operator|=
name|v
expr_stmt|;
name|config
operator|.
name|synth
operator|.
name|x
operator|=
name|x
expr_stmt|;
name|config
operator|.
name|synth
operator|.
name|r
operator|=
name|r
expr_stmt|;
name|config
operator|.
name|synth
operator|.
name|prescale
operator|=
name|prescale
expr_stmt|;
name|bestF
operator|=
name|Fout
expr_stmt|;
name|bestV
operator|=
name|Fvco
expr_stmt|;
block|}
block|}
if|#
directive|if
literal|0
block|printf("Fbest=%.0f, Ftarg=%u, Fout=%.0f\n", bestF>>prescale, target, bestF);   printf("N=%u, M=%u, V=%u, X=%u, R=%u\n", config.synth.n,    config.synth.m, config.synth.v, config.synth.x, config.synth.r);
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|void
name|print_cable_len
parameter_list|(
name|void
parameter_list|)
block|{
name|printf
argument_list|(
literal|"Cable length:\t\t%d meters\n"
argument_list|,
name|config
operator|.
name|cable_len
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_cable_type
parameter_list|(
name|void
parameter_list|)
block|{
name|printf
argument_list|(
literal|"Cable type:\t\t"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|.
name|cable_type
operator|>
literal|7
condition|)
name|printf
argument_list|(
literal|"unknown cable_type: %d\n"
argument_list|,
name|status
operator|.
name|cable_type
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|ssi_cables
index|[
name|status
operator|.
name|cable_type
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_time_slots
parameter_list|(
name|void
parameter_list|)
block|{
name|printf
argument_list|(
literal|"TimeSlot [31-0]:\t0x%08X\n"
argument_list|,
name|config
operator|.
name|time_slots
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_scrambler
parameter_list|(
name|void
parameter_list|)
block|{
name|printf
argument_list|(
literal|"Scrambler:\t\t"
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|.
name|scrambler
operator|==
name|CFG_SCRAM_OFF
condition|)
name|printf
argument_list|(
literal|"off\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|config
operator|.
name|scrambler
operator|==
name|CFG_SCRAM_DL_KEN
condition|)
name|printf
argument_list|(
literal|"DigLink/Kentrox: X^43+1\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|config
operator|.
name|scrambler
operator|==
name|CFG_SCRAM_LARS
condition|)
name|printf
argument_list|(
literal|"Larse: X^20+X^17+1 w/28ZS\n"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"unknown scrambler: %d\n"
argument_list|,
name|config
operator|.
name|scrambler
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|double
name|vga_dbs
parameter_list|(
name|u_int8_t
name|vga
parameter_list|)
block|{
if|if
condition|(
name|vga
operator|<
literal|0x0F
condition|)
return|return
literal|0.0
return|;
if|if
condition|(
operator|(
name|vga
operator|>=
literal|0x0F
operator|)
operator|&&
operator|(
name|vga
operator|<=
literal|0x1B
operator|)
condition|)
return|return
literal|0.0
operator|+
literal|0.77
operator|*
operator|(
name|vga
operator|-
literal|0x0F
operator|)
return|;
if|if
condition|(
operator|(
name|vga
operator|>=
literal|0x1C
operator|)
operator|&&
operator|(
name|vga
operator|<=
literal|0x33
operator|)
condition|)
return|return
literal|10.0
operator|+
literal|1.25
operator|*
operator|(
name|vga
operator|-
literal|0x1C
operator|)
return|;
if|if
condition|(
operator|(
name|vga
operator|>=
literal|0x34
operator|)
operator|&&
operator|(
name|vga
operator|<=
literal|0x39
operator|)
condition|)
return|return
literal|40.0
operator|+
literal|1.67
operator|*
operator|(
name|vga
operator|-
literal|0x34
operator|)
return|;
if|if
condition|(
operator|(
name|vga
operator|>=
literal|0x3A
operator|)
operator|&&
operator|(
name|vga
operator|<
literal|0x3F
operator|)
condition|)
return|return
literal|50.0
operator|+
literal|2.80
operator|*
operator|(
name|vga
operator|-
literal|0x3A
operator|)
return|;
return|return
literal|64.0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_rx_gain
parameter_list|(
name|void
parameter_list|)
block|{
name|printf
argument_list|(
literal|"Rx gain max:\t\t"
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|.
name|rx_gain
operator|==
name|CFG_GAIN_AUTO
condition|)
name|printf
argument_list|(
literal|"auto-set to %02.1f dB\n"
argument_list|,
name|vga_dbs
argument_list|(
name|read_framer
argument_list|(
name|Bt8370_VGA_MAX
argument_list|)
operator|&
literal|0x3F
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"up to %02.1f dB\n"
argument_list|,
name|vga_dbs
argument_list|(
name|config
operator|.
name|rx_gain
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_tx_lbo
parameter_list|(
name|void
parameter_list|)
block|{
name|u_int8_t
name|saved_lbo
init|=
name|config
operator|.
name|tx_lbo
decl_stmt|;
name|printf
argument_list|(
literal|"LBO = "
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|.
name|tx_lbo
operator|==
name|CFG_LBO_AUTO
condition|)
block|{
name|config
operator|.
name|tx_lbo
operator|=
name|read_framer
argument_list|(
name|Bt8370_TLIU_CR
argument_list|)
operator|&
literal|0x30
expr_stmt|;
name|printf
argument_list|(
literal|"auto-set to "
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|config
operator|.
name|tx_lbo
condition|)
block|{
case|case
name|CFG_LBO_0DB
case|:
name|printf
argument_list|(
literal|"0 dB\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|CFG_LBO_7DB
case|:
name|printf
argument_list|(
literal|"7.5 dB\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|CFG_LBO_15DB
case|:
name|printf
argument_list|(
literal|"15 dB\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|CFG_LBO_22DB
case|:
name|printf
argument_list|(
literal|"22.5 dB\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"unknown tx_lbo: %d\n"
argument_list|,
name|config
operator|.
name|tx_lbo
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|saved_lbo
operator|==
name|CFG_LBO_AUTO
condition|)
name|config
operator|.
name|tx_lbo
operator|=
name|saved_lbo
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_tx_pulse
parameter_list|(
name|void
parameter_list|)
block|{
name|u_int8_t
name|saved_pulse
init|=
name|config
operator|.
name|tx_pulse
decl_stmt|;
name|printf
argument_list|(
literal|"Tx pulse shape:\t\t"
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|.
name|tx_pulse
operator|==
name|CFG_PULSE_AUTO
condition|)
block|{
name|config
operator|.
name|tx_pulse
operator|=
name|read_framer
argument_list|(
name|Bt8370_TLIU_CR
argument_list|)
operator|&
literal|0x0E
expr_stmt|;
name|printf
argument_list|(
literal|"auto-set to "
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|config
operator|.
name|tx_pulse
condition|)
block|{
case|case
name|CFG_PULSE_T1DSX0
case|:
name|printf
argument_list|(
literal|"T1-DSX: 0 to 40 meters\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|CFG_PULSE_T1DSX1
case|:
name|printf
argument_list|(
literal|"T1-DSX: 40 to 80 meters\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|CFG_PULSE_T1DSX2
case|:
name|printf
argument_list|(
literal|"T1-DSX: 80 to 120 meters\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|CFG_PULSE_T1DSX3
case|:
name|printf
argument_list|(
literal|"T1-DSX: 120 to 160 meters\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|CFG_PULSE_T1DSX4
case|:
name|printf
argument_list|(
literal|"T1-DSX: 160 to 200 meters\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|CFG_PULSE_E1COAX
case|:
name|printf
argument_list|(
literal|"E1: Twin Coax\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|CFG_PULSE_E1TWIST
case|:
name|printf
argument_list|(
literal|"E1: Twisted Pairs\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|CFG_PULSE_T1CSU
case|:
name|printf
argument_list|(
literal|"T1-CSU; "
argument_list|)
expr_stmt|;
name|print_tx_lbo
argument_list|()
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"unknown tx_pulse: %d\n"
argument_list|,
name|config
operator|.
name|tx_pulse
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|saved_pulse
operator|==
name|CFG_PULSE_AUTO
condition|)
name|config
operator|.
name|tx_pulse
operator|=
name|saved_pulse
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_ssi_sigs
parameter_list|(
name|void
parameter_list|)
block|{
name|u_int32_t
name|mii16
init|=
name|status
operator|.
name|snmp
operator|.
name|ssi
operator|.
name|sigs
decl_stmt|;
name|char
modifier|*
name|on
init|=
literal|"On"
decl_stmt|,
modifier|*
name|off
init|=
literal|"Off"
decl_stmt|;
name|printf
argument_list|(
literal|"Modem signals:\t\tDTR=%s DSR=%s RTS=%s CTS=%s\n"
argument_list|,
operator|(
name|mii16
operator|&
name|MII16_SSI_DTR
operator|)
condition|?
name|on
else|:
name|off
argument_list|,
operator|(
name|mii16
operator|&
name|MII16_SSI_DSR
operator|)
condition|?
name|on
else|:
name|off
argument_list|,
operator|(
name|mii16
operator|&
name|MII16_SSI_RTS
operator|)
condition|?
name|on
else|:
name|off
argument_list|,
operator|(
name|mii16
operator|&
name|MII16_SSI_CTS
operator|)
condition|?
name|on
else|:
name|off
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Modem signals:\t\tDCD=%s RI=%s LL=%s RL=%s TM=%s\n"
argument_list|,
operator|(
name|mii16
operator|&
name|MII16_SSI_DCD
operator|)
condition|?
name|on
else|:
name|off
argument_list|,
operator|(
name|mii16
operator|&
name|MII16_SSI_RI
operator|)
condition|?
name|on
else|:
name|off
argument_list|,
operator|(
name|mii16
operator|&
name|MII16_SSI_LL
operator|)
condition|?
name|on
else|:
name|off
argument_list|,
operator|(
name|mii16
operator|&
name|MII16_SSI_RL
operator|)
condition|?
name|on
else|:
name|off
argument_list|,
operator|(
name|mii16
operator|&
name|MII16_SSI_TM
operator|)
condition|?
name|on
else|:
name|off
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_hssi_sigs
parameter_list|(
name|void
parameter_list|)
block|{
name|u_int32_t
name|mii16
init|=
name|status
operator|.
name|snmp
operator|.
name|hssi
operator|.
name|sigs
decl_stmt|;
name|char
modifier|*
name|on
init|=
literal|"On"
decl_stmt|,
modifier|*
name|off
init|=
literal|"Off"
decl_stmt|;
name|printf
argument_list|(
literal|"Modem signals:\t\tTA=%s CA=%s\n"
argument_list|,
operator|(
name|mii16
operator|&
name|MII16_HSSI_TA
operator|)
condition|?
name|on
else|:
name|off
argument_list|,
operator|(
name|mii16
operator|&
name|MII16_HSSI_CA
operator|)
condition|?
name|on
else|:
name|off
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Modem signals:\t\tLA=%s LB=%s LC=%s TM=%s\n"
argument_list|,
operator|(
name|mii16
operator|&
name|MII16_HSSI_LA
operator|)
condition|?
name|on
else|:
name|off
argument_list|,
operator|(
name|mii16
operator|&
name|MII16_HSSI_LB
operator|)
condition|?
name|on
else|:
name|off
argument_list|,
operator|(
name|mii16
operator|&
name|MII16_HSSI_LC
operator|)
condition|?
name|on
else|:
name|off
argument_list|,
operator|(
name|mii16
operator|&
name|MII16_HSSI_TM
operator|)
condition|?
name|on
else|:
name|off
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_events
parameter_list|(
name|void
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|reset_time
decl_stmt|;
name|time_t
name|now
decl_stmt|;
name|now
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Current time:\t\t%s"
argument_list|,
name|ctime
argument_list|(
operator|&
name|now
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|.
name|cntrs
operator|.
name|reset_time
operator|.
name|tv_sec
operator|<
literal|1000
condition|)
name|reset_time
operator|=
literal|"Never\n"
expr_stmt|;
else|else
name|reset_time
operator|=
name|ctime
argument_list|(
operator|&
name|status
operator|.
name|cntrs
operator|.
name|reset_time
operator|.
name|tv_sec
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Cntrs reset:\t\t%s"
argument_list|,
name|reset_time
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|.
name|cntrs
operator|.
name|ibytes
condition|)
name|printf
argument_list|(
literal|"Rx bytes:\t\t%ju\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|status
operator|.
name|cntrs
operator|.
name|ibytes
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|.
name|cntrs
operator|.
name|obytes
condition|)
name|printf
argument_list|(
literal|"Tx bytes:\t\t%ju\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|status
operator|.
name|cntrs
operator|.
name|obytes
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|.
name|cntrs
operator|.
name|ipackets
condition|)
name|printf
argument_list|(
literal|"Rx packets:\t\t%ju\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|status
operator|.
name|cntrs
operator|.
name|ipackets
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|.
name|cntrs
operator|.
name|opackets
condition|)
name|printf
argument_list|(
literal|"Tx packets:\t\t%ju\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|status
operator|.
name|cntrs
operator|.
name|opackets
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|.
name|cntrs
operator|.
name|ierrors
condition|)
name|printf
argument_list|(
literal|"Rx errors:\t\t%u\n"
argument_list|,
name|status
operator|.
name|cntrs
operator|.
name|ierrors
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|.
name|cntrs
operator|.
name|oerrors
condition|)
name|printf
argument_list|(
literal|"Tx errors:\t\t%u\n"
argument_list|,
name|status
operator|.
name|cntrs
operator|.
name|oerrors
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|.
name|cntrs
operator|.
name|idiscards
condition|)
name|printf
argument_list|(
literal|"Rx discards:\t\t%u\n"
argument_list|,
name|status
operator|.
name|cntrs
operator|.
name|idiscards
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|.
name|cntrs
operator|.
name|odiscards
condition|)
name|printf
argument_list|(
literal|"Tx discards:\t\t%u\n"
argument_list|,
name|status
operator|.
name|cntrs
operator|.
name|odiscards
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|.
name|cntrs
operator|.
name|fifo_over
condition|)
name|printf
argument_list|(
literal|"Rx fifo overruns:\t%u\n"
argument_list|,
name|status
operator|.
name|cntrs
operator|.
name|fifo_over
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|.
name|cntrs
operator|.
name|fifo_under
condition|)
name|printf
argument_list|(
literal|"Tx fifo underruns:\t%u\n"
argument_list|,
name|status
operator|.
name|cntrs
operator|.
name|fifo_under
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|.
name|cntrs
operator|.
name|missed
condition|)
name|printf
argument_list|(
literal|"Rx missed:\t\t%u\n"
argument_list|,
name|status
operator|.
name|cntrs
operator|.
name|missed
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|.
name|cntrs
operator|.
name|overruns
condition|)
name|printf
argument_list|(
literal|"Rx overruns:\t\t%u\n"
argument_list|,
name|status
operator|.
name|cntrs
operator|.
name|overruns
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|.
name|cntrs
operator|.
name|fdl_pkts
condition|)
name|printf
argument_list|(
literal|"Rx FDL pkts:\t\t%u\n"
argument_list|,
name|status
operator|.
name|cntrs
operator|.
name|fdl_pkts
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|.
name|cntrs
operator|.
name|crc_errs
condition|)
name|printf
argument_list|(
literal|"Rx CRC:\t\t\t%u\n"
argument_list|,
name|status
operator|.
name|cntrs
operator|.
name|crc_errs
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|.
name|cntrs
operator|.
name|lcv_errs
condition|)
name|printf
argument_list|(
literal|"Rx line code:\t\t%u\n"
argument_list|,
name|status
operator|.
name|cntrs
operator|.
name|lcv_errs
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|.
name|cntrs
operator|.
name|frm_errs
condition|)
name|printf
argument_list|(
literal|"Rx F-bits:\t\t%u\n"
argument_list|,
name|status
operator|.
name|cntrs
operator|.
name|frm_errs
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|.
name|cntrs
operator|.
name|febe_errs
condition|)
name|printf
argument_list|(
literal|"Rx FEBE:\t\t%u\n"
argument_list|,
name|status
operator|.
name|cntrs
operator|.
name|febe_errs
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|.
name|cntrs
operator|.
name|par_errs
condition|)
name|printf
argument_list|(
literal|"Rx P-parity:\t\t%u\n"
argument_list|,
name|status
operator|.
name|cntrs
operator|.
name|par_errs
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|.
name|cntrs
operator|.
name|cpar_errs
condition|)
name|printf
argument_list|(
literal|"Rx C-parity:\t\t%u\n"
argument_list|,
name|status
operator|.
name|cntrs
operator|.
name|cpar_errs
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|.
name|cntrs
operator|.
name|mfrm_errs
condition|)
name|printf
argument_list|(
literal|"Rx M-bits:\t\t%u\n"
argument_list|,
name|status
operator|.
name|cntrs
operator|.
name|mfrm_errs
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|.
name|debug
condition|)
block|{
comment|/* These events are hard to explain and may worry users, */
if|if
condition|(
name|status
operator|.
name|cntrs
operator|.
name|rxdma
condition|)
name|printf
argument_list|(
literal|"Rx no buffs:\t\t%u\n"
argument_list|,
name|status
operator|.
name|cntrs
operator|.
name|rxdma
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|.
name|cntrs
operator|.
name|txdma
condition|)
name|printf
argument_list|(
literal|"Tx no descs:\t\t%u\n"
argument_list|,
name|status
operator|.
name|cntrs
operator|.
name|txdma
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|.
name|cntrs
operator|.
name|lck_watch
condition|)
name|printf
argument_list|(
literal|"Lck watch:\t\t%u\n"
argument_list|,
name|status
operator|.
name|cntrs
operator|.
name|lck_watch
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|.
name|cntrs
operator|.
name|lck_ioctl
condition|)
name|printf
argument_list|(
literal|"Lck ioctl:\t\t%u\n"
argument_list|,
name|status
operator|.
name|cntrs
operator|.
name|lck_ioctl
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|.
name|cntrs
operator|.
name|lck_intr
condition|)
name|printf
argument_list|(
literal|"Lck intr:\t\t%u\n"
argument_list|,
name|status
operator|.
name|cntrs
operator|.
name|lck_intr
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|print_summary
parameter_list|(
name|void
parameter_list|)
block|{
switch|switch
condition|(
name|status
operator|.
name|card_type
condition|)
block|{
case|case
name|TLP_CSID_HSSI
case|:
block|{
name|print_card_name
argument_list|()
expr_stmt|;
name|print_card_type
argument_list|()
expr_stmt|;
name|print_debug
argument_list|()
expr_stmt|;
name|print_status
argument_list|()
expr_stmt|;
name|print_tx_speed
argument_list|()
expr_stmt|;
name|print_line_prot
argument_list|()
expr_stmt|;
name|print_crc_len
argument_list|()
expr_stmt|;
name|print_loop_back
argument_list|()
expr_stmt|;
name|print_tx_clk_src
argument_list|()
expr_stmt|;
name|print_hssi_sigs
argument_list|()
expr_stmt|;
name|print_events
argument_list|()
expr_stmt|;
break|break;
block|}
case|case
name|TLP_CSID_T3
case|:
block|{
name|print_card_name
argument_list|()
expr_stmt|;
name|print_card_type
argument_list|()
expr_stmt|;
name|print_debug
argument_list|()
expr_stmt|;
name|print_status
argument_list|()
expr_stmt|;
name|print_tx_speed
argument_list|()
expr_stmt|;
name|print_line_prot
argument_list|()
expr_stmt|;
name|print_crc_len
argument_list|()
expr_stmt|;
name|print_loop_back
argument_list|()
expr_stmt|;
name|print_format
argument_list|()
expr_stmt|;
name|print_cable_len
argument_list|()
expr_stmt|;
name|print_scrambler
argument_list|()
expr_stmt|;
name|print_events
argument_list|()
expr_stmt|;
break|break;
block|}
case|case
name|TLP_CSID_SSI
case|:
block|{
name|print_card_name
argument_list|()
expr_stmt|;
name|print_card_type
argument_list|()
expr_stmt|;
name|print_debug
argument_list|()
expr_stmt|;
name|print_status
argument_list|()
expr_stmt|;
name|print_tx_speed
argument_list|()
expr_stmt|;
name|print_line_prot
argument_list|()
expr_stmt|;
name|print_crc_len
argument_list|()
expr_stmt|;
name|print_loop_back
argument_list|()
expr_stmt|;
name|print_dte_dce
argument_list|()
expr_stmt|;
name|print_synth_freq
argument_list|()
expr_stmt|;
name|print_cable_type
argument_list|()
expr_stmt|;
name|print_ssi_sigs
argument_list|()
expr_stmt|;
name|print_events
argument_list|()
expr_stmt|;
break|break;
block|}
case|case
name|TLP_CSID_T1E1
case|:
block|{
name|print_card_name
argument_list|()
expr_stmt|;
name|print_card_type
argument_list|()
expr_stmt|;
name|print_debug
argument_list|()
expr_stmt|;
name|print_status
argument_list|()
expr_stmt|;
name|print_tx_speed
argument_list|()
expr_stmt|;
name|print_line_prot
argument_list|()
expr_stmt|;
name|print_crc_len
argument_list|()
expr_stmt|;
name|print_loop_back
argument_list|()
expr_stmt|;
name|print_tx_clk_src
argument_list|()
expr_stmt|;
name|print_format
argument_list|()
expr_stmt|;
name|print_time_slots
argument_list|()
expr_stmt|;
name|print_cable_len
argument_list|()
expr_stmt|;
name|print_tx_pulse
argument_list|()
expr_stmt|;
name|print_rx_gain
argument_list|()
expr_stmt|;
name|print_events
argument_list|()
expr_stmt|;
break|break;
block|}
case|case
name|TLP_CSID_HSSIc
case|:
block|{
name|print_card_name
argument_list|()
expr_stmt|;
name|print_card_type
argument_list|()
expr_stmt|;
name|print_debug
argument_list|()
expr_stmt|;
name|print_status
argument_list|()
expr_stmt|;
name|print_line_prot
argument_list|()
expr_stmt|;
name|print_tx_speed
argument_list|()
expr_stmt|;
name|print_crc_len
argument_list|()
expr_stmt|;
name|print_loop_back
argument_list|()
expr_stmt|;
name|print_tx_clk_src
argument_list|()
expr_stmt|;
name|print_dte_dce
argument_list|()
expr_stmt|;
name|print_synth_freq
argument_list|()
expr_stmt|;
name|print_hssi_sigs
argument_list|()
expr_stmt|;
name|print_events
argument_list|()
expr_stmt|;
break|break;
block|}
default|default:
block|{
name|printf
argument_list|(
literal|"%s: Unknown card type: %d\n"
argument_list|,
name|ifname
argument_list|,
name|status
operator|.
name|card_type
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|print_t3_bop
parameter_list|(
name|int
name|bop_code
parameter_list|)
block|{
switch|switch
condition|(
name|bop_code
condition|)
block|{
case|case
literal|0x00
case|:
return|return
literal|"far end LOF"
return|;
case|case
literal|0x0E
case|:
return|return
literal|"far end LOS"
return|;
case|case
literal|0x16
case|:
return|return
literal|"far end AIS"
return|;
case|case
literal|0x1A
case|:
return|return
literal|"far end IDL"
return|;
case|case
literal|0x07
case|:
return|return
literal|"Line Loopback activate"
return|;
case|case
literal|0x1C
case|:
return|return
literal|"Line Loopback deactivate"
return|;
case|case
literal|0x1B
case|:
return|return
literal|"Entire DS3 line"
return|;
default|default:
return|return
literal|"Unknown BOP code"
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|print_t3_snmp
parameter_list|(
name|void
parameter_list|)
block|{
name|printf
argument_list|(
literal|"SNMP performance data:\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" LCV=%d"
argument_list|,
name|status
operator|.
name|snmp
operator|.
name|t3
operator|.
name|lcv
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" LOS=%d"
argument_list|,
operator|(
name|status
operator|.
name|snmp
operator|.
name|t3
operator|.
name|line
operator|&
name|TLINE_LOS
operator|)
condition|?
literal|1
else|:
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" PCV=%d"
argument_list|,
name|status
operator|.
name|snmp
operator|.
name|t3
operator|.
name|pcv
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" CCV=%d"
argument_list|,
name|status
operator|.
name|snmp
operator|.
name|t3
operator|.
name|ccv
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" AIS=%d"
argument_list|,
operator|(
name|status
operator|.
name|snmp
operator|.
name|t3
operator|.
name|line
operator|&
name|TLINE_RX_AIS
operator|)
condition|?
literal|1
else|:
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" SEF=%d"
argument_list|,
operator|(
name|status
operator|.
name|snmp
operator|.
name|t3
operator|.
name|line
operator|&
name|T1LINE_SEF
operator|)
condition|?
literal|1
else|:
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" OOF=%d"
argument_list|,
operator|(
name|status
operator|.
name|snmp
operator|.
name|t3
operator|.
name|line
operator|&
name|TLINE_LOF
operator|)
condition|?
literal|1
else|:
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  FEBE=%d"
argument_list|,
name|status
operator|.
name|snmp
operator|.
name|t3
operator|.
name|febe
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" RAI=%d"
argument_list|,
operator|(
name|status
operator|.
name|snmp
operator|.
name|t3
operator|.
name|line
operator|&
name|TLINE_RX_RAI
operator|)
condition|?
literal|1
else|:
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_t3_dsu
parameter_list|(
name|void
parameter_list|)
block|{
name|char
modifier|*
name|no
init|=
literal|"No"
decl_stmt|,
modifier|*
name|yes
init|=
literal|"Yes"
decl_stmt|;
name|u_int16_t
name|mii16
init|=
name|read_mii
argument_list|(
literal|16
argument_list|)
decl_stmt|;
name|u_int8_t
name|ctl1
init|=
name|read_framer
argument_list|(
name|T3CSR_CTL1
argument_list|)
decl_stmt|;
name|u_int8_t
name|ctl8
init|=
name|read_framer
argument_list|(
name|T3CSR_CTL8
argument_list|)
decl_stmt|;
name|u_int8_t
name|stat9
init|=
name|read_framer
argument_list|(
name|T3CSR_STAT9
argument_list|)
decl_stmt|;
name|u_int8_t
name|ctl12
init|=
name|read_framer
argument_list|(
name|T3CSR_CTL12
argument_list|)
decl_stmt|;
name|u_int8_t
name|stat16
init|=
name|read_framer
argument_list|(
name|T3CSR_STAT16
argument_list|)
decl_stmt|;
name|printf
argument_list|(
literal|"Framing:       \t\t%s\n"
argument_list|,
name|ctl1
operator|&
name|CTL1_M13MODE
condition|?
literal|"M13"
else|:
literal|"CPAR"
argument_list|)
expr_stmt|;
name|print_tx_speed
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"Scrambler:     \t\t%s\n"
argument_list|,
name|mii16
operator|&
name|MII16_DS3_SCRAM
condition|?
name|yes
else|:
name|no
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Scram poly:    \t\t%s\n"
argument_list|,
name|mii16
operator|&
name|MII16_DS3_POLY
condition|?
literal|"X^20"
else|:
literal|"X^43"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Cable length   \t\t%s\n"
argument_list|,
name|mii16
operator|&
name|MII16_DS3_ZERO
condition|?
literal|"Short"
else|:
literal|"Long"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Line    loop:  \t\t%s\n"
argument_list|,
name|mii16
operator|&
name|MII16_DS3_LNLBK
condition|?
name|yes
else|:
name|no
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Payload loop:  \t\t%s\n"
argument_list|,
name|ctl12
operator|&
name|CTL12_RTPLOOP
condition|?
name|yes
else|:
name|no
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Frame   loop:  \t\t%s\n"
argument_list|,
name|ctl1
operator|&
name|CTL1_3LOOP
condition|?
name|yes
else|:
name|no
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Host    loop:  \t\t%s\n"
argument_list|,
name|mii16
operator|&
name|MII16_DS3_TRLBK
condition|?
name|yes
else|:
name|no
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Transmit RAI:  \t\t%s\n"
argument_list|,
name|ctl1
operator|&
name|CTL1_XTX
condition|?
name|no
else|:
name|yes
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Receive  RAI   \t\t%s\n"
argument_list|,
name|stat16
operator|&
name|STAT16_XERR
condition|?
name|yes
else|:
name|no
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Transmit AIS:  \t\t%s\n"
argument_list|,
name|ctl1
operator|&
name|CTL1_TXAIS
condition|?
name|yes
else|:
name|no
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Receive  AIS:  \t\t%s\n"
argument_list|,
name|stat16
operator|&
name|STAT16_RAIS
condition|?
name|yes
else|:
name|no
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Transmit IDLE: \t\t%s\n"
argument_list|,
name|ctl1
operator|&
name|CTL1_TXIDL
condition|?
name|yes
else|:
name|no
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Receive  IDLE: \t\t%s\n"
argument_list|,
name|stat16
operator|&
name|STAT16_RIDL
condition|?
name|yes
else|:
name|no
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Transmit BLUE: \t\t%s\n"
argument_list|,
name|ctl8
operator|&
name|CTL8_TBLU
condition|?
name|yes
else|:
name|no
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Receive  BLUE: \t\t%s\n"
argument_list|,
name|stat9
operator|&
name|STAT9_RBLU
condition|?
name|yes
else|:
name|no
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Loss of Signal:\t\t%s\n"
argument_list|,
name|stat16
operator|&
name|STAT16_RLOS
condition|?
name|yes
else|:
name|no
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Loss of Frame: \t\t%s\n"
argument_list|,
name|stat16
operator|&
name|STAT16_ROOF
condition|?
name|yes
else|:
name|no
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Sev Err Frms:  \t\t%s\n"
argument_list|,
name|stat16
operator|&
name|STAT16_SEF
condition|?
name|yes
else|:
name|no
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Code  errors:  \t\t%d\n"
argument_list|,
name|read_framer
argument_list|(
name|T3CSR_CVLO
argument_list|)
operator|+
operator|(
name|read_framer
argument_list|(
name|T3CSR_CVHI
argument_list|)
operator|<<
literal|8
operator|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"C-Par errors:  \t\t%d\n"
argument_list|,
name|read_framer
argument_list|(
name|T3CSR_CERR
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"P-Par errors:  \t\t%d\n"
argument_list|,
name|read_framer
argument_list|(
name|T3CSR_PERR
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"F-Bit errors:  \t\t%d\n"
argument_list|,
name|read_framer
argument_list|(
name|T3CSR_FERR
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"M-Bit errors:  \t\t%d\n"
argument_list|,
name|read_framer
argument_list|(
name|T3CSR_MERR
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"FarEndBitErrs: \t\t%d\n"
argument_list|,
name|read_framer
argument_list|(
name|T3CSR_FEBE
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Last Tx  FEAC msg:\t0x%02X (%s)\n"
argument_list|,
name|read_framer
argument_list|(
name|T3CSR_TX_FEAC
argument_list|)
operator|&
literal|0x3F
argument_list|,
name|print_t3_bop
argument_list|(
name|read_framer
argument_list|(
name|T3CSR_TX_FEAC
argument_list|)
operator|&
literal|0x3F
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Last dbl FEAC msg;\t0x%02X (%s)\n"
argument_list|,
name|read_framer
argument_list|(
name|T3CSR_DBL_FEAC
argument_list|)
operator|&
literal|0x3F
argument_list|,
name|print_t3_bop
argument_list|(
name|read_framer
argument_list|(
name|T3CSR_DBL_FEAC
argument_list|)
operator|&
literal|0x3F
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Last Rx  FEAC msg:\t0x%02X (%s)\n"
argument_list|,
name|read_framer
argument_list|(
name|T3CSR_RX_FEAC
argument_list|)
operator|&
literal|0x3F
argument_list|,
name|print_t3_bop
argument_list|(
name|read_framer
argument_list|(
name|T3CSR_RX_FEAC
argument_list|)
operator|&
literal|0x3F
argument_list|)
argument_list|)
expr_stmt|;
name|print_t3_snmp
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|t3_cmd
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|int
name|ch
decl_stmt|;
while|while
condition|(
operator|(
name|ch
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"a:A:B:c:de:fF:lLsS:vV:"
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'a'
case|:
comment|/* stop alarms */
block|{
switch|switch
condition|(
name|optarg
index|[
literal|0
index|]
condition|)
block|{
case|case
literal|'a'
case|:
comment|/* Stop sending AIS Signal */
block|{
name|write_mii
argument_list|(
literal|16
argument_list|,
name|read_mii
argument_list|(
literal|16
argument_list|)
operator|&
operator|~
name|MII16_DS3_FRAME
argument_list|)
expr_stmt|;
name|write_framer
argument_list|(
name|T3CSR_CTL1
argument_list|,
name|read_framer
argument_list|(
name|T3CSR_CTL1
argument_list|)
operator|&
operator|~
name|CTL1_TXAIS
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"Stop sending Alarm Indication Signal (AIS)\n"
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|'b'
case|:
comment|/* Stop sending Blue signal */
block|{
name|write_mii
argument_list|(
literal|16
argument_list|,
name|read_mii
argument_list|(
literal|16
argument_list|)
operator|&
operator|~
name|MII16_DS3_FRAME
argument_list|)
expr_stmt|;
name|write_framer
argument_list|(
name|T3CSR_CTL8
argument_list|,
name|read_framer
argument_list|(
name|T3CSR_CTL8
argument_list|)
operator|&
operator|~
name|CTL8_TBLU
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"Stop sending Blue signal\n"
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|'i'
case|:
comment|/* Stop sending IDLE signal */
block|{
name|write_framer
argument_list|(
name|T3CSR_CTL1
argument_list|,
name|read_framer
argument_list|(
name|T3CSR_CTL1
argument_list|)
operator|&
operator|~
name|CTL1_TXIDL
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"Stop sending IDLE signal\n"
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|'y'
case|:
comment|/* Stop sending Yellow alarm */
block|{
name|write_framer
argument_list|(
name|T3CSR_CTL1
argument_list|,
name|read_framer
argument_list|(
name|T3CSR_CTL1
argument_list|)
operator||
name|CTL1_XTX
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"Stop sending Yellow alarm\n"
argument_list|)
expr_stmt|;
break|break;
block|}
default|default:
name|printf
argument_list|(
literal|"Unknown alarm: %c\n"
argument_list|,
name|optarg
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
block|}
case|case
literal|'A'
case|:
comment|/* start alarms */
block|{
switch|switch
condition|(
name|optarg
index|[
literal|0
index|]
condition|)
block|{
case|case
literal|'a'
case|:
comment|/* Start sending AIS Signal */
block|{
name|write_mii
argument_list|(
literal|16
argument_list|,
name|read_mii
argument_list|(
literal|16
argument_list|)
operator||
name|MII16_DS3_FRAME
argument_list|)
expr_stmt|;
name|write_framer
argument_list|(
name|T3CSR_CTL1
argument_list|,
name|read_framer
argument_list|(
name|T3CSR_CTL1
argument_list|)
operator||
name|CTL1_TXAIS
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"Sending AIS signal (framed 1010..)\n"
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|'b'
case|:
comment|/* Start sending Blue signal */
block|{
name|write_mii
argument_list|(
literal|16
argument_list|,
name|read_mii
argument_list|(
literal|16
argument_list|)
operator||
name|MII16_DS3_FRAME
argument_list|)
expr_stmt|;
name|write_framer
argument_list|(
name|T3CSR_CTL8
argument_list|,
name|read_framer
argument_list|(
name|T3CSR_CTL8
argument_list|)
operator||
name|CTL8_TBLU
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"Sending Blue signal (unframed all 1s)\n"
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|'i'
case|:
comment|/* Start sending IDLE signal */
block|{
name|write_framer
argument_list|(
name|T3CSR_CTL1
argument_list|,
name|read_framer
argument_list|(
name|T3CSR_CTL1
argument_list|)
operator||
name|CTL1_TXIDL
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"Sending IDLE signal (framed 1100..)\n"
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|'y'
case|:
comment|/* Start sending Yellow alarm */
block|{
name|write_framer
argument_list|(
name|T3CSR_CTL1
argument_list|,
name|read_framer
argument_list|(
name|T3CSR_CTL1
argument_list|)
operator|&
operator|~
name|CTL1_XTX
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"Sending Yellow alarm (X-bits=0)\n"
argument_list|)
expr_stmt|;
break|break;
block|}
default|default:
name|printf
argument_list|(
literal|"Unknown alarm: %c\n"
argument_list|,
name|optarg
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
block|}
case|case
literal|'B'
case|:
comment|/* send BOP msg */
block|{
name|u_int8_t
name|bop
init|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|write_framer
argument_list|(
name|T3CSR_TX_FEAC
argument_list|,
literal|0xC0
operator|+
name|bop
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"Sent '0x%02X' BOP msg 10 times\n"
argument_list|,
name|bop
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|'c'
case|:
comment|/* set cable length */
block|{
name|config
operator|.
name|cable_len
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|print_cable_len
argument_list|()
expr_stmt|;
name|update
operator|=
literal|1
expr_stmt|;
break|break;
block|}
case|case
literal|'d'
case|:
comment|/* DSU status */
case|case
literal|'s'
case|:
comment|/* deprecated */
block|{
name|print_t3_dsu
argument_list|()
expr_stmt|;
break|break;
block|}
case|case
literal|'e'
case|:
comment|/* set framimg format */
block|{
name|config
operator|.
name|format
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|print_format
argument_list|()
expr_stmt|;
name|update
operator|=
literal|1
expr_stmt|;
break|break;
block|}
case|case
literal|'f'
case|:
comment|/* read and print framer regs */
block|{
name|int
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"TXC03401 regs:\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"     0  1  2  3  4  5  6  7"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|21
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|%
literal|8
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"\n%02X: "
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%02X "
argument_list|,
name|read_framer
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n\n"
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|'F'
case|:
comment|/* write framer reg */
block|{
name|u_int32_t
name|addr
init|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|u_int32_t
name|data
init|=
name|strtoul
argument_list|(
name|argv
index|[
name|optind
operator|++
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|write_framer
argument_list|(
name|addr
argument_list|,
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
block|{
name|data
operator|=
name|read_framer
argument_list|(
name|addr
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Write framer register: addr = 0x%02X data = 0x%02X\n"
argument_list|,
name|addr
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
case|case
literal|'l'
case|:
comment|/* send DS3 line loopback deactivate BOP cmd */
block|{
name|ioctl_snmp_send
argument_list|(
name|TSEND_RESET
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"Sent 'DS3 Line Loopback deactivate' BOP cmd\n"
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|'L'
case|:
comment|/* send DS3 line loopback activate BOP cmd */
block|{
name|ioctl_snmp_send
argument_list|(
name|TSEND_LINE
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"Sent 'DS3 Line Loopback activate' BOP cmd\n"
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|'S'
case|:
comment|/* set scrambler */
block|{
name|config
operator|.
name|scrambler
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|print_scrambler
argument_list|()
expr_stmt|;
name|update
operator|=
literal|1
expr_stmt|;
break|break;
block|}
case|case
literal|'v'
case|:
comment|/* set verbose mode */
block|{
name|verbose
operator|=
literal|1
expr_stmt|;
break|break;
block|}
case|case
literal|'V'
case|:
comment|/* set T3 freq control DAC */
block|{
name|u_int32_t
name|dac
init|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|write_dac
argument_list|(
name|dac
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"VCXO DAC value is %d\n"
argument_list|,
name|dac
argument_list|)
expr_stmt|;
break|break;
block|}
default|default:
block|{
name|printf
argument_list|(
literal|"Unknown command char: %c\n"
argument_list|,
name|ch
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* case */
block|}
comment|/* switch */
block|}
comment|/* while */
block|}
end_function

begin_comment
comment|/* proc */
end_comment

begin_function
specifier|static
name|void
name|print_test_pattern
parameter_list|(
name|int
name|patt
parameter_list|)
block|{
name|printf
argument_list|(
literal|"Test Pattern:\t\t"
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|patt
condition|)
block|{
case|case
literal|0
case|:
name|printf
argument_list|(
literal|"unframed X^11+X^9+1\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|printf
argument_list|(
literal|"unframed X^15+X^14+1\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|printf
argument_list|(
literal|"unframed X^20+X^17+1\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|printf
argument_list|(
literal|"unframed X^23+X^18+1\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|printf
argument_list|(
literal|"unframed X^11+X^9+1 w/7ZS\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|5
case|:
name|printf
argument_list|(
literal|"unframed X^15+X^14+1 w/7ZS\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|6
case|:
name|printf
argument_list|(
literal|"unframed X^20+X^17+1 w/14ZS (QRSS)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|7
case|:
name|printf
argument_list|(
literal|"unframed X^23+X^18+1 w/14ZS\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|8
case|:
name|printf
argument_list|(
literal|"framed X^11+X^9+1\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|9
case|:
name|printf
argument_list|(
literal|"framed X^15+X^14+1\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|10
case|:
name|printf
argument_list|(
literal|"framed X^20+X^17+1\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|11
case|:
name|printf
argument_list|(
literal|"framed X^23+X^18+1\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|12
case|:
empty_stmt|;
name|printf
argument_list|(
literal|"framed X^11+X^9+1 w/7ZS\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|13
case|:
name|printf
argument_list|(
literal|"framed X^15+X^14+1 w/7ZS\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|14
case|:
name|printf
argument_list|(
literal|"framed X^20+X^17+1 w/14ZS (QRSS)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|15
case|:
name|printf
argument_list|(
literal|"framed X^23+X^18+1 w/14ZS\n"
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|print_t1_bop
parameter_list|(
name|int
name|bop_code
parameter_list|)
block|{
switch|switch
condition|(
name|bop_code
condition|)
block|{
case|case
literal|0x00
case|:
return|return
literal|"Yellow Alarm (far end LOF)"
return|;
case|case
literal|0x07
case|:
return|return
literal|"Line Loop up"
return|;
case|case
literal|0x1C
case|:
return|return
literal|"Line Loop down"
return|;
case|case
literal|0x0A
case|:
return|return
literal|"Payload Loop up"
return|;
case|case
literal|0x19
case|:
return|return
literal|"Payload Loop down"
return|;
case|case
literal|0x09
case|:
return|return
literal|"Network Loop up"
return|;
case|case
literal|0x12
case|:
return|return
literal|"Network Loop down"
return|;
default|default:
return|return
literal|"Unknown BOP code"
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|print_far_report
parameter_list|(
name|int
name|index
parameter_list|)
block|{
name|u_int16_t
name|far
init|=
name|status
operator|.
name|snmp
operator|.
name|t1
operator|.
name|prm
index|[
name|index
index|]
decl_stmt|;
name|printf
argument_list|(
literal|" SEQ=%d "
argument_list|,
operator|(
name|far
operator|&
name|T1PRM_SEQ
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|far
operator|&
name|T1PRM_G1
condition|)
name|printf
argument_list|(
literal|"CRC=1"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|far
operator|&
name|T1PRM_G2
condition|)
name|printf
argument_list|(
literal|"CRC=1 to 5"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|far
operator|&
name|T1PRM_G3
condition|)
name|printf
argument_list|(
literal|"CRC=5 to 10"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|far
operator|&
name|T1PRM_G4
condition|)
name|printf
argument_list|(
literal|"CRC=10 to 100"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|far
operator|&
name|T1PRM_G5
condition|)
name|printf
argument_list|(
literal|"CRC=100 to 319"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|far
operator|&
name|T1PRM_G6
condition|)
name|printf
argument_list|(
literal|"CRC>=320"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"CRC=0"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" SE=%d"
argument_list|,
operator|(
name|far
operator|&
name|T1PRM_SE
operator|)
condition|?
literal|1
else|:
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" FE=%d"
argument_list|,
operator|(
name|far
operator|&
name|T1PRM_FE
operator|)
condition|?
literal|1
else|:
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" LV=%d"
argument_list|,
operator|(
name|far
operator|&
name|T1PRM_LV
operator|)
condition|?
literal|1
else|:
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" SL=%d"
argument_list|,
operator|(
name|far
operator|&
name|T1PRM_SL
operator|)
condition|?
literal|1
else|:
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" LB=%d"
argument_list|,
operator|(
name|far
operator|&
name|T1PRM_LB
operator|)
condition|?
literal|1
else|:
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_t1_snmp
parameter_list|(
name|void
parameter_list|)
block|{
name|printf
argument_list|(
literal|"SNMP Near-end performance data:\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" LCV=%d"
argument_list|,
name|status
operator|.
name|snmp
operator|.
name|t1
operator|.
name|lcv
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" LOS=%d"
argument_list|,
operator|(
name|status
operator|.
name|snmp
operator|.
name|t1
operator|.
name|line
operator|&
name|TLINE_LOS
operator|)
condition|?
literal|1
else|:
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" FE=%d"
argument_list|,
name|status
operator|.
name|snmp
operator|.
name|t1
operator|.
name|fe
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" CRC=%d"
argument_list|,
name|status
operator|.
name|snmp
operator|.
name|t1
operator|.
name|crc
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" AIS=%d"
argument_list|,
operator|(
name|status
operator|.
name|snmp
operator|.
name|t1
operator|.
name|line
operator|&
name|TLINE_RX_AIS
operator|)
condition|?
literal|1
else|:
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" SEF=%d"
argument_list|,
operator|(
name|status
operator|.
name|snmp
operator|.
name|t1
operator|.
name|line
operator|&
name|T1LINE_SEF
operator|)
condition|?
literal|1
else|:
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" OOF=%d"
argument_list|,
operator|(
name|status
operator|.
name|snmp
operator|.
name|t1
operator|.
name|line
operator|&
name|TLINE_LOF
operator|)
condition|?
literal|1
else|:
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  RAI=%d"
argument_list|,
operator|(
name|status
operator|.
name|snmp
operator|.
name|t1
operator|.
name|line
operator|&
name|TLINE_RX_RAI
operator|)
condition|?
literal|1
else|:
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|.
name|format
operator|==
name|CFG_FORMAT_T1ESF
condition|)
block|{
name|printf
argument_list|(
literal|"ANSI Far-end performance reports:\n"
argument_list|)
expr_stmt|;
name|print_far_report
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|print_far_report
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|print_far_report
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|print_far_report
argument_list|(
literal|3
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|print_t1_dsu
parameter_list|(
name|void
parameter_list|)
block|{
name|char
modifier|*
name|no
init|=
literal|"No"
decl_stmt|,
modifier|*
name|yes
init|=
literal|"Yes"
decl_stmt|;
name|u_int16_t
name|mii16
init|=
name|read_mii
argument_list|(
literal|16
argument_list|)
decl_stmt|;
name|u_int8_t
name|isr0
init|=
name|read_framer
argument_list|(
name|Bt8370_ISR0
argument_list|)
decl_stmt|;
name|u_int8_t
name|loop
init|=
name|read_framer
argument_list|(
name|Bt8370_LOOP
argument_list|)
decl_stmt|;
name|u_int8_t
name|vga_max
init|=
name|read_framer
argument_list|(
name|Bt8370_VGA_MAX
argument_list|)
operator|&
literal|0x3F
decl_stmt|;
name|u_int8_t
name|alm1
init|=
name|read_framer
argument_list|(
name|Bt8370_ALM1
argument_list|)
decl_stmt|;
name|u_int8_t
name|alm3
init|=
name|read_framer
argument_list|(
name|Bt8370_ALM3
argument_list|)
decl_stmt|;
name|u_int8_t
name|talm
init|=
name|read_framer
argument_list|(
name|Bt8370_TALM
argument_list|)
decl_stmt|;
name|u_int8_t
name|tpatt
init|=
name|read_framer
argument_list|(
name|Bt8370_TPATT
argument_list|)
decl_stmt|;
name|u_int8_t
name|tpulse
init|=
name|read_framer
argument_list|(
name|Bt8370_TLIU_CR
argument_list|)
decl_stmt|;
name|u_int8_t
name|vga
decl_stmt|;
name|u_int8_t
name|saved_pulse
decl_stmt|,
name|saved_lbo
decl_stmt|;
comment|/* d/c write required before read */
name|write_framer
argument_list|(
name|Bt8370_VGA
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|vga
operator|=
name|read_framer
argument_list|(
name|Bt8370_VGA
argument_list|)
operator|&
literal|0x3F
expr_stmt|;
name|print_format
argument_list|()
expr_stmt|;
name|print_time_slots
argument_list|()
expr_stmt|;
name|print_tx_clk_src
argument_list|()
expr_stmt|;
name|print_tx_speed
argument_list|()
expr_stmt|;
name|saved_pulse
operator|=
name|config
operator|.
name|tx_pulse
expr_stmt|;
name|config
operator|.
name|tx_pulse
operator|=
name|tpulse
operator|&
literal|0x0E
expr_stmt|;
name|saved_lbo
operator|=
name|config
operator|.
name|tx_lbo
expr_stmt|;
name|config
operator|.
name|tx_lbo
operator|=
name|tpulse
operator|&
literal|0x30
expr_stmt|;
name|print_tx_pulse
argument_list|()
expr_stmt|;
name|config
operator|.
name|tx_pulse
operator|=
name|saved_pulse
expr_stmt|;
name|config
operator|.
name|tx_lbo
operator|=
name|saved_lbo
expr_stmt|;
name|printf
argument_list|(
literal|"Tx outputs:    \t\t%sabled\n"
argument_list|,
operator|(
name|mii16
operator|&
name|MII16_T1_XOE
operator|)
condition|?
literal|"En"
else|:
literal|"Dis"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Line impedance:\t\t%s ohms\n"
argument_list|,
operator|(
name|mii16
operator|&
name|MII16_T1_Z
operator|)
condition|?
literal|"120"
else|:
literal|"100"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Max line loss: \t\t%4.1f dB\n"
argument_list|,
name|vga_dbs
argument_list|(
name|vga_max
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Cur line loss: \t\t%4.1f dB\n"
argument_list|,
name|vga_dbs
argument_list|(
name|vga
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Invert data:   \t\t%s\n"
argument_list|,
operator|(
name|mii16
operator|&
name|MII16_T1_INVERT
operator|)
condition|?
name|yes
else|:
name|no
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Line    loop:  \t\t%s\n"
argument_list|,
operator|(
name|loop
operator|&
name|LOOP_LINE
operator|)
condition|?
name|yes
else|:
name|no
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Payload loop:  \t\t%s\n"
argument_list|,
operator|(
name|loop
operator|&
name|LOOP_PAYLOAD
operator|)
condition|?
name|yes
else|:
name|no
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Framer  loop:  \t\t%s\n"
argument_list|,
operator|(
name|loop
operator|&
name|LOOP_FRAMER
operator|)
condition|?
name|yes
else|:
name|no
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Analog  loop:  \t\t%s\n"
argument_list|,
operator|(
name|loop
operator|&
name|LOOP_ANALOG
operator|)
condition|?
name|yes
else|:
name|no
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Tx AIS:        \t\t%s\n"
argument_list|,
operator|(
operator|(
name|talm
operator|&
name|TALM_TAIS
operator|)
operator|||
operator|(
operator|(
name|talm
operator|&
name|TALM_AUTO_AIS
operator|)
operator|&&
operator|(
name|alm1
operator|&
name|ALM1_RLOS
operator|)
operator|)
operator|)
condition|?
name|yes
else|:
name|no
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Rx AIS:        \t\t%s\n"
argument_list|,
operator|(
name|alm1
operator|&
name|ALM1_RAIS
operator|)
condition|?
name|yes
else|:
name|no
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|config
operator|.
name|format
operator|&
literal|1
operator|)
operator|==
literal|0
operator|)
operator|&&
operator|(
name|config
operator|.
name|format
operator|!=
name|CFG_FORMAT_E1NONE
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"Tx RAI:        \t\t%s\n"
argument_list|,
operator|(
operator|(
name|talm
operator|&
name|TALM_TYEL
operator|)
operator|||
operator|(
operator|(
name|talm
operator|&
name|TALM_AUTO_YEL
operator|)
operator|&&
operator|(
name|alm3
operator|&
name|ALM3_FRED
operator|)
operator|)
operator|)
condition|?
name|yes
else|:
name|no
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Rx RAI:        \t\t%s\n"
argument_list|,
operator|(
name|alm1
operator|&
name|ALM1_RYEL
operator|)
condition|?
name|yes
else|:
name|no
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|config
operator|.
name|format
operator|==
name|CFG_FORMAT_T1ESF
condition|)
block|{
name|printf
argument_list|(
literal|"Tx BOP RAI:    \t\t%s\n"
argument_list|,
operator|(
name|alm1
operator|&
name|ALM1_RLOF
operator|)
condition|?
name|yes
else|:
name|no
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Rx BOP RAI:    \t\t%s\n"
argument_list|,
operator|(
name|alm1
operator|&
name|ALM1_RMYEL
operator|)
condition|?
name|yes
else|:
name|no
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|config
operator|.
name|format
operator|&
literal|0x11
operator|)
operator|==
literal|0x10
condition|)
comment|/* E1CAS */
block|{
name|printf
argument_list|(
literal|"Rx TS16 AIS:   \t\t%s\n"
argument_list|,
operator|(
name|alm3
operator|&
name|ALM3_RMAIS
operator|)
condition|?
name|yes
else|:
name|no
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Tx TS16 RAI;   \t\t%s\n"
argument_list|,
operator|(
operator|(
name|talm
operator|&
name|TALM_AUTO_MYEL
operator|)
operator|&&
operator|(
name|alm3
operator|&
name|ALM3_SRED
operator|)
operator|)
condition|?
name|yes
else|:
name|no
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Rx LOS analog: \t\t%s\n"
argument_list|,
operator|(
name|alm1
operator|&
name|ALM1_RALOS
operator|)
condition|?
name|yes
else|:
name|no
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Rx LOS digital:\t\t%s\n"
argument_list|,
operator|(
name|alm1
operator|&
name|ALM1_RLOS
operator|)
condition|?
name|yes
else|:
name|no
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Rx LOF:        \t\t%s\n"
argument_list|,
operator|(
name|alm1
operator|&
name|ALM1_RLOF
operator|)
condition|?
name|yes
else|:
name|no
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Tx QRS:        \t\t%s\n"
argument_list|,
operator|(
name|tpatt
operator|&
literal|0x10
operator|)
condition|?
name|yes
else|:
name|no
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Rx QRS:        \t\t%s\n"
argument_list|,
operator|(
name|isr0
operator|&
literal|0x10
operator|)
condition|?
name|yes
else|:
name|no
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"LCV errors:    \t\t%d\n"
argument_list|,
name|read_framer
argument_list|(
name|Bt8370_LCV_LO
argument_list|)
operator|+
operator|(
name|read_framer
argument_list|(
name|Bt8370_LCV_HI
argument_list|)
operator|<<
literal|8
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|.
name|format
operator|!=
name|CFG_FORMAT_E1NONE
condition|)
block|{
if|if
condition|(
operator|(
name|config
operator|.
name|format
operator|&
literal|1
operator|)
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"Far End Block Errors:\t%d\n"
argument_list|,
name|read_framer
argument_list|(
name|Bt8370_FEBE_LO
argument_list|)
operator|+
operator|(
name|read_framer
argument_list|(
name|Bt8370_FEBE_HI
argument_list|)
operator|<<
literal|8
operator|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"CRC errors:    \t\t%d\n"
argument_list|,
name|read_framer
argument_list|(
name|Bt8370_CRC_LO
argument_list|)
operator|+
operator|(
name|read_framer
argument_list|(
name|Bt8370_CRC_HI
argument_list|)
operator|<<
literal|8
operator|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Frame errors:  \t\t%d\n"
argument_list|,
name|read_framer
argument_list|(
name|Bt8370_FERR_LO
argument_list|)
operator|+
operator|(
name|read_framer
argument_list|(
name|Bt8370_FERR_HI
argument_list|)
operator|<<
literal|8
operator|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Sev Err Frms:  \t\t%d\n"
argument_list|,
name|read_framer
argument_list|(
name|Bt8370_AERR
argument_list|)
operator|&
literal|0x03
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Change of Frm align:\t%d\n"
argument_list|,
operator|(
name|read_framer
argument_list|(
name|Bt8370_AERR
argument_list|)
operator|&
literal|0x0C
operator|)
operator|>>
literal|2
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Loss of Frame events:\t%d\n"
argument_list|,
operator|(
name|read_framer
argument_list|(
name|Bt8370_AERR
argument_list|)
operator|&
literal|0xF0
operator|)
operator|>>
literal|4
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|config
operator|.
name|format
operator|==
name|CFG_FORMAT_T1ESF
condition|)
block|{
name|printf
argument_list|(
literal|"Last Tx BOP msg:\t0x%02X (%s)\n"
argument_list|,
name|read_framer
argument_list|(
name|Bt8370_TBOP
argument_list|)
argument_list|,
name|print_t1_bop
argument_list|(
name|read_framer
argument_list|(
name|Bt8370_TBOP
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Last Rx BOP msg:\t0x%02X (%s)\n"
argument_list|,
name|read_framer
argument_list|(
name|Bt8370_RBOP
argument_list|)
argument_list|,
name|print_t1_bop
argument_list|(
name|read_framer
argument_list|(
name|Bt8370_RBOP
argument_list|)
operator|&
literal|0x3F
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|print_t1_snmp
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|t1_cmd
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|int
name|ch
decl_stmt|;
while|while
condition|(
operator|(
name|ch
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"a:A:B:c:de:E:fF:g:iIlLpPstT:u:U:vxX"
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'a'
case|:
comment|/* stop alarms */
block|{
switch|switch
condition|(
name|optarg
index|[
literal|0
index|]
condition|)
block|{
case|case
literal|'y'
case|:
comment|/* Stop sending Yellow Alarm */
block|{
if|if
condition|(
operator|(
name|config
operator|.
name|format
operator|==
name|CFG_FORMAT_T1SF
operator|)
operator|||
operator|(
name|config
operator|.
name|format
operator|==
name|CFG_FORMAT_E1NONE
operator|)
condition|)
name|printf
argument_list|(
literal|"No Yellow alarm for this frame format\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|config
operator|.
name|format
operator|==
name|CFG_FORMAT_T1ESF
condition|)
name|write_framer
argument_list|(
name|Bt8370_BOP
argument_list|,
literal|0xE0
argument_list|)
expr_stmt|;
comment|/* rbop 25, tbop off */
else|else
block|{
name|u_int8_t
name|talm
init|=
name|read_framer
argument_list|(
name|Bt8370_TALM
argument_list|)
decl_stmt|;
name|write_framer
argument_list|(
name|Bt8370_TALM
argument_list|,
name|talm
operator|&
operator|~
name|TALM_TYEL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"Stop sending Yellow alarm\n"
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|'a'
case|:
comment|/* Stop sending AIS */
case|case
literal|'b'
case|:
comment|/* Stop sending Blue Alarm */
block|{
name|u_int8_t
name|talm
init|=
name|read_framer
argument_list|(
name|Bt8370_TALM
argument_list|)
decl_stmt|;
name|write_framer
argument_list|(
name|Bt8370_TALM
argument_list|,
name|talm
operator|&
operator|~
name|TALM_TAIS
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"Stop sending AIS/Blue signal\n"
argument_list|)
expr_stmt|;
break|break;
block|}
default|default:
name|printf
argument_list|(
literal|"Unknown alarm: %c\n"
argument_list|,
name|optarg
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
case|case
literal|'A'
case|:
comment|/* start alarms */
block|{
switch|switch
condition|(
name|optarg
index|[
literal|0
index|]
condition|)
block|{
case|case
literal|'y'
case|:
comment|/* Start sending Yellow Alarm */
block|{
if|if
condition|(
operator|(
name|config
operator|.
name|format
operator|==
name|CFG_FORMAT_T1SF
operator|)
operator|||
operator|(
name|config
operator|.
name|format
operator|==
name|CFG_FORMAT_E1NONE
operator|)
condition|)
name|printf
argument_list|(
literal|"No Yellow alarm for this frame format\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|config
operator|.
name|format
operator|==
name|CFG_FORMAT_T1ESF
condition|)
block|{
name|write_framer
argument_list|(
name|Bt8370_BOP
argument_list|,
literal|0x0F
argument_list|)
expr_stmt|;
comment|/* rbop off, tbop cont */
name|write_framer
argument_list|(
name|Bt8370_TBOP
argument_list|,
name|T1BOP_OOF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|u_int8_t
name|talm
init|=
name|read_framer
argument_list|(
name|Bt8370_TALM
argument_list|)
decl_stmt|;
name|write_framer
argument_list|(
name|Bt8370_TALM
argument_list|,
name|talm
operator||
name|TALM_TYEL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"Sending Yellow alarm\n"
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|'a'
case|:
comment|/* Start sending AIS */
case|case
literal|'b'
case|:
comment|/* Start sending Blue Alarm */
block|{
name|u_int8_t
name|talm
init|=
name|read_framer
argument_list|(
name|Bt8370_TALM
argument_list|)
decl_stmt|;
name|write_framer
argument_list|(
name|Bt8370_TALM
argument_list|,
name|talm
operator||
name|TALM_TAIS
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"Sending AIS/Blue signal\n"
argument_list|)
expr_stmt|;
break|break;
block|}
default|default:
name|printf
argument_list|(
literal|"Unknown alarm: %c\n"
argument_list|,
name|optarg
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
case|case
literal|'B'
case|:
comment|/* send BOP msg */
block|{
name|u_int8_t
name|bop
init|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
decl_stmt|;
if|if
condition|(
name|config
operator|.
name|format
operator|==
name|CFG_FORMAT_T1ESF
condition|)
block|{
name|write_framer
argument_list|(
name|Bt8370_BOP
argument_list|,
literal|0x0B
argument_list|)
expr_stmt|;
comment|/* rbop off, tbop 25 */
name|write_framer
argument_list|(
name|Bt8370_TBOP
argument_list|,
name|bop
argument_list|)
expr_stmt|;
comment|/* start sending BOP msg */
name|sleep
argument_list|(
literal|1
argument_list|)
expr_stmt|;
comment|/* sending 25 BOP msgs takes about 100 ms. */
name|write_framer
argument_list|(
name|Bt8370_BOP
argument_list|,
literal|0xE0
argument_list|)
expr_stmt|;
comment|/* rbop 25, tbop off */
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"Sent '0x%02X' BOP msg 25 times\n"
argument_list|,
name|bop
argument_list|)
expr_stmt|;
block|}
else|else
name|printf
argument_list|(
literal|"BOP msgs only work in T1-ESF format\n"
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|'c'
case|:
comment|/* set cable length */
block|{
name|config
operator|.
name|cable_len
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|print_cable_len
argument_list|()
expr_stmt|;
name|update
operator|=
literal|1
expr_stmt|;
break|break;
block|}
case|case
literal|'d'
case|:
comment|/* DSU status */
case|case
literal|'s'
case|:
comment|/* deprecated */
block|{
name|print_t1_dsu
argument_list|()
expr_stmt|;
break|break;
block|}
case|case
literal|'e'
case|:
comment|/* set framimg format */
block|{
name|config
operator|.
name|format
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|print_format
argument_list|()
expr_stmt|;
name|update
operator|=
literal|1
expr_stmt|;
break|break;
block|}
case|case
literal|'E'
case|:
comment|/* set time slots */
block|{
name|config
operator|.
name|time_slots
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|print_time_slots
argument_list|()
expr_stmt|;
name|update
operator|=
literal|1
expr_stmt|;
break|break;
block|}
case|case
literal|'f'
case|:
comment|/* read and print framer regs */
block|{
name|int
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"Bt8370 regs:\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"     0  1  2  3  4  5  6  7  8  9  A  B  C  D  E  F"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|512
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|%
literal|16
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"\n%03X: "
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%02X "
argument_list|,
name|read_framer
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n\n"
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|'F'
case|:
comment|/* write framer reg */
block|{
name|u_int32_t
name|addr
init|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|u_int32_t
name|data
init|=
name|strtoul
argument_list|(
name|argv
index|[
name|optind
operator|++
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|write_framer
argument_list|(
name|addr
argument_list|,
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
block|{
name|data
operator|=
name|read_framer
argument_list|(
name|addr
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Write framer register: addr = 0x%02X data = 0x%02X\n"
argument_list|,
name|addr
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
case|case
literal|'g'
case|:
comment|/* set receiver gain */
block|{
name|config
operator|.
name|rx_gain
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|print_rx_gain
argument_list|()
expr_stmt|;
name|update
operator|=
literal|1
expr_stmt|;
break|break;
block|}
case|case
literal|'i'
case|:
comment|/* send CSU loopback deactivate inband cmd */
block|{
if|if
condition|(
name|config
operator|.
name|format
operator|==
name|CFG_FORMAT_T1SF
condition|)
block|{
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"Sending 'CSU loop down' inband cmd for 10 secs..."
argument_list|)
expr_stmt|;
name|ioctl_snmp_send
argument_list|(
name|TSEND_RESET
argument_list|)
expr_stmt|;
name|sleep
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|ioctl_snmp_send
argument_list|(
name|TSEND_NORMAL
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"done\n"
argument_list|)
expr_stmt|;
block|}
else|else
name|printf
argument_list|(
literal|"Inband loopback cmds only work in T1-SF format"
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|'I'
case|:
comment|/* send CSU loopback activate inband cmd */
block|{
if|if
condition|(
name|config
operator|.
name|format
operator|==
name|CFG_FORMAT_T1SF
condition|)
block|{
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"Sending 'CSU loop up' inband cmd for 10 secs..."
argument_list|)
expr_stmt|;
name|ioctl_snmp_send
argument_list|(
name|TSEND_LINE
argument_list|)
expr_stmt|;
name|sleep
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|ioctl_snmp_send
argument_list|(
name|TSEND_NORMAL
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"done\n"
argument_list|)
expr_stmt|;
block|}
else|else
name|printf
argument_list|(
literal|"Inband loopback cmds only work in T1-SF format"
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|'l'
case|:
comment|/* send line loopback deactivate BOP msg */
block|{
if|if
condition|(
name|config
operator|.
name|format
operator|==
name|CFG_FORMAT_T1ESF
condition|)
block|{
name|ioctl_snmp_send
argument_list|(
name|TSEND_RESET
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"Sent 'Line Loop Down' BOP cmd\n"
argument_list|)
expr_stmt|;
block|}
else|else
name|printf
argument_list|(
literal|"BOP msgs only work in T1-ESF format\n"
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|'L'
case|:
comment|/* send line loopback activate BOP msg */
block|{
if|if
condition|(
name|config
operator|.
name|format
operator|==
name|CFG_FORMAT_T1ESF
condition|)
block|{
name|ioctl_snmp_send
argument_list|(
name|TSEND_LINE
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"Sent 'Line Loop Up' BOP cmd\n"
argument_list|)
expr_stmt|;
block|}
else|else
name|printf
argument_list|(
literal|"BOP msgs only work in T1-ESF format\n"
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|'p'
case|:
comment|/* send payload loopback deactivate BOP msg */
block|{
if|if
condition|(
name|config
operator|.
name|format
operator|==
name|CFG_FORMAT_T1ESF
condition|)
block|{
name|ioctl_snmp_send
argument_list|(
name|TSEND_RESET
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"Sent 'Payload Loop Down' BOP cmd\n"
argument_list|)
expr_stmt|;
block|}
else|else
name|printf
argument_list|(
literal|"BOP msgs only work in T1-ESF format\n"
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|'P'
case|:
comment|/* send payload loopback activate BOP msg */
block|{
if|if
condition|(
name|config
operator|.
name|format
operator|==
name|CFG_FORMAT_T1ESF
condition|)
block|{
name|ioctl_snmp_send
argument_list|(
name|TSEND_PAYLOAD
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"Sent 'Payload Loop Up' BOP cmd\n"
argument_list|)
expr_stmt|;
block|}
else|else
name|printf
argument_list|(
literal|"BOP msgs only work in T1-ESF format\n"
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|'t'
case|:
comment|/* stop sending test pattern */
block|{
name|ioctl_snmp_send
argument_list|(
name|TSEND_NORMAL
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"Stop sending test pattern\n"
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|'T'
case|:
comment|/* start sending test pattern */
block|{
name|u_int8_t
name|patt
init|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|write_framer
argument_list|(
name|Bt8370_TPATT
argument_list|,
literal|0x10
operator|+
name|patt
argument_list|)
expr_stmt|;
name|write_framer
argument_list|(
name|Bt8370_RPATT
argument_list|,
literal|0x30
operator|+
name|patt
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|print_test_pattern
argument_list|(
name|patt
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|'u'
case|:
comment|/* set transmit pulse shape */
block|{
name|config
operator|.
name|tx_pulse
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|print_tx_pulse
argument_list|()
expr_stmt|;
name|update
operator|=
literal|1
expr_stmt|;
break|break;
block|}
case|case
literal|'U'
case|:
comment|/* set tx line build-out */
block|{
if|if
condition|(
name|config
operator|.
name|tx_pulse
operator|==
name|CFG_PULSE_T1CSU
condition|)
block|{
name|config
operator|.
name|tx_lbo
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|print_tx_pulse
argument_list|()
expr_stmt|;
name|update
operator|=
literal|1
expr_stmt|;
block|}
else|else
name|printf
argument_list|(
literal|"LBO only meaningful if Tx Pulse is T1CSU\n"
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|'v'
case|:
comment|/* set verbose mode */
block|{
name|verbose
operator|=
literal|1
expr_stmt|;
break|break;
block|}
case|case
literal|'x'
case|:
comment|/* disable transmitter outputs */
block|{
name|write_mii
argument_list|(
literal|16
argument_list|,
name|read_mii
argument_list|(
literal|16
argument_list|)
operator|&
operator|~
name|MII16_T1_XOE
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"Transmitter outputs disabled\n"
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|'X'
case|:
comment|/* enable transmitter outputs */
block|{
name|write_mii
argument_list|(
literal|16
argument_list|,
name|read_mii
argument_list|(
literal|16
argument_list|)
operator||
name|MII16_T1_XOE
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"Transmitter outputs enabled\n"
argument_list|)
expr_stmt|;
break|break;
block|}
default|default:
block|{
name|printf
argument_list|(
literal|"Unknown command char: %c\n"
argument_list|,
name|ch
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* case */
block|}
comment|/* switch */
block|}
comment|/* while */
block|}
end_function

begin_comment
comment|/* proc */
end_comment

begin_comment
comment|/* used when reading Motorola S-Record format ROM files */
end_comment

begin_function
specifier|static
name|unsigned
name|char
name|read_hex
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|)
block|{
name|unsigned
name|char
name|a
decl_stmt|,
name|b
decl_stmt|,
name|c
decl_stmt|;
for|for
control|(
name|a
operator|=
literal|0
operator|,
name|b
operator|=
literal|0
init|;
name|a
operator|<
literal|2
condition|;
name|a
operator|++
control|)
block|{
name|c
operator|=
name|fgetc
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|c
operator|-=
literal|48
expr_stmt|;
if|if
condition|(
name|c
operator|>
literal|9
condition|)
name|c
operator|-=
literal|7
expr_stmt|;
name|b
operator|=
operator|(
name|b
operator|<<
literal|4
operator|)
operator||
operator|(
name|c
operator|&
literal|0xF
operator|)
expr_stmt|;
block|}
name|checksum
operator|+=
name|b
expr_stmt|;
return|return
name|b
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|load_xilinx
parameter_list|(
name|char
modifier|*
name|name
parameter_list|)
block|{
name|FILE
modifier|*
name|f
decl_stmt|;
name|char
modifier|*
name|ucode
decl_stmt|;
name|int
name|i
decl_stmt|,
name|length
decl_stmt|;
name|int
name|c
decl_stmt|;
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"Load firmware from file %s...\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|f
operator|=
name|fopen
argument_list|(
name|name
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|perror
argument_list|(
literal|"Failed to open file"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|ucode
operator|=
operator|(
name|char
operator|*
operator|)
name|malloc
argument_list|(
literal|8192
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|ucode
argument_list|,
literal|8192
argument_list|)
expr_stmt|;
name|c
operator|=
name|fgetc
argument_list|(
name|f
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|'X'
condition|)
block|{
comment|/* Xilinx raw bits file (foo.rbt) */
comment|/* skip seven lines of boiler plate */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|7
condition|;
control|)
if|if
condition|(
operator|(
name|c
operator|=
name|fgetc
argument_list|(
name|f
argument_list|)
operator|)
operator|==
literal|'\n'
condition|)
name|i
operator|++
expr_stmt|;
comment|/* build a dense bit array */
name|i
operator|=
name|length
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|fgetc
argument_list|(
name|f
argument_list|)
operator|)
operator|!=
name|EOF
condition|)
block|{
comment|/* LSB first */
if|if
condition|(
name|c
operator|==
literal|'1'
condition|)
name|ucode
index|[
name|length
index|]
operator||=
literal|1
operator|<<
name|i
operator|++
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|'0'
condition|)
name|i
operator|++
expr_stmt|;
if|if
condition|(
name|i
operator|==
literal|8
condition|)
block|{
name|i
operator|=
literal|0
expr_stmt|;
name|length
operator|++
expr_stmt|;
block|}
block|}
block|}
elseif|else
if|if
condition|(
name|c
operator|==
literal|'S'
condition|)
block|{
comment|/* Motarola S records (foo.exo) */
name|int
name|blklen
decl_stmt|;
name|length
operator|=
literal|0
expr_stmt|;
name|ungetc
argument_list|(
name|c
argument_list|,
name|f
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|fgetc
argument_list|(
name|f
argument_list|)
operator|)
operator|!=
name|EOF
condition|)
block|{
if|if
condition|(
name|c
operator|!=
literal|'S'
condition|)
block|{
name|printf
argument_list|(
literal|"I'm confused; I expected an 'S'\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|c
operator|=
name|fgetc
argument_list|(
name|f
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|'9'
condition|)
break|break;
elseif|else
if|if
condition|(
name|c
operator|==
literal|'1'
condition|)
block|{
name|checksum
operator|=
literal|0
expr_stmt|;
name|blklen
operator|=
name|read_hex
argument_list|(
name|f
argument_list|)
operator|-
literal|3
expr_stmt|;
name|read_hex
argument_list|(
name|f
argument_list|)
expr_stmt|;
comment|/* hi blkaddr */
name|read_hex
argument_list|(
name|f
argument_list|)
expr_stmt|;
comment|/* lo blkaddr */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|blklen
condition|;
name|i
operator|++
control|)
name|ucode
index|[
name|length
operator|++
index|]
operator|=
name|read_hex
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|read_hex
argument_list|(
name|f
argument_list|)
expr_stmt|;
comment|/* process but ignore checksum */
if|if
condition|(
name|checksum
operator|!=
literal|0xFF
condition|)
block|{
name|printf
argument_list|(
literal|"File checksum error\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|c
operator|=
name|fgetc
argument_list|(
name|f
argument_list|)
expr_stmt|;
comment|/* throw away eol */
name|c
operator|=
name|fgetc
argument_list|(
name|f
argument_list|)
expr_stmt|;
comment|/* throw away eol */
block|}
else|else
block|{
name|printf
argument_list|(
literal|"I'm confused; I expected a '1' or a '9'\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* while */
block|}
comment|/* Motorola S-Record */
else|else
block|{
name|printf
argument_list|(
literal|"Unknown file type giving up\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|load_xilinx_from_file
argument_list|(
name|ucode
argument_list|,
name|length
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* 32-bit CRC calculated right-to-left over 8-bit bytes */
end_comment

begin_function
specifier|static
name|u_int32_t
name|crc32
parameter_list|(
name|char
modifier|*
name|bufp
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|int
name|bit
decl_stmt|,
name|i
decl_stmt|;
name|u_int32_t
name|data
decl_stmt|;
name|u_int32_t
name|crc
init|=
literal|0xFFFFFFFFL
decl_stmt|;
name|u_int32_t
name|poly
init|=
literal|0xEDB88320L
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
for|for
control|(
name|data
operator|=
operator|*
name|bufp
operator|++
operator|,
name|bit
operator|=
literal|0
init|;
name|bit
operator|<
literal|8
condition|;
name|bit
operator|++
operator|,
name|data
operator|>>=
literal|1
control|)
name|crc
operator|=
operator|(
name|crc
operator|>>
literal|1
operator|)
operator|^
operator|(
operator|(
operator|(
name|crc
operator|^
name|data
operator|)
operator|&
literal|1
operator|)
condition|?
name|poly
else|:
literal|0
operator|)
expr_stmt|;
return|return
name|crc
return|;
block|}
end_function

begin_comment
comment|/* 8-bit CRC calculated left-to-right over 16-bit words */
end_comment

begin_function
specifier|static
name|u_int8_t
name|crc8
parameter_list|(
name|u_int16_t
modifier|*
name|bufp
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|int
name|bit
decl_stmt|,
name|i
decl_stmt|;
name|u_int16_t
name|data
decl_stmt|;
name|u_int8_t
name|crc
init|=
literal|0xFF
decl_stmt|;
name|u_int8_t
name|poly
init|=
literal|0x07
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
for|for
control|(
name|data
operator|=
operator|*
name|bufp
operator|++
operator|,
name|bit
operator|=
literal|15
init|;
name|bit
operator|>=
literal|0
condition|;
name|bit
operator|--
control|)
block|{
if|if
condition|(
operator|(
name|i
operator|==
literal|8
operator|)
operator|&&
operator|(
name|bit
operator|==
literal|7
operator|)
condition|)
break|break;
name|crc
operator|=
operator|(
name|crc
operator|<<
literal|1
operator|)
operator|^
operator|(
operator|(
operator|(
operator|(
name|crc
operator|>>
literal|7
operator|)
operator|^
operator|(
name|data
operator|>>
name|bit
operator|)
operator|)
operator|&
literal|1
operator|)
condition|?
name|poly
else|:
literal|0
operator|)
expr_stmt|;
block|}
return|return
name|crc
return|;
block|}
end_function

begin_comment
comment|/* HSSI=3, DS3=4, SSI=5, T1E1=6, HSSIc=7, SDSL=8 */
end_comment

begin_function
name|void
name|init_srom
parameter_list|(
name|int
name|board
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|u_int16_t
name|srom
index|[
literal|64
index|]
decl_stmt|;
comment|/* zero the entire rom */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|64
condition|;
name|i
operator|++
control|)
name|srom
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|srom
index|[
literal|0
index|]
operator|=
literal|0x1376
expr_stmt|;
comment|/* subsys vendor id */
name|srom
index|[
literal|1
index|]
operator|=
name|board
condition|?
name|board
else|:
operator|(
name|read_mii
argument_list|(
literal|3
argument_list|)
operator|>>
literal|4
operator|&
literal|0xF
operator|)
operator|+
literal|1
expr_stmt|;
name|srom
index|[
literal|8
index|]
operator|=
name|crc8
argument_list|(
name|srom
argument_list|,
literal|9
argument_list|)
expr_stmt|;
comment|/* Tulip hardware checks this checksum */
name|srom
index|[
literal|10
index|]
operator|=
literal|0x6000
expr_stmt|;
comment|/* ethernet address */
name|srom
index|[
literal|11
index|]
operator|=
literal|0x0099
expr_stmt|;
comment|/* ethernet address */
name|srom
index|[
literal|12
index|]
operator|=
literal|0x0000
expr_stmt|;
comment|/* ethernet address */
comment|/* srom checksum is low 16 bits of Ethernet CRC-32 */
name|srom
index|[
literal|63
index|]
operator|=
name|crc32
argument_list|(
operator|(
name|char
operator|*
operator|)
name|srom
argument_list|,
literal|126
argument_list|)
operator|^
literal|0xFFFFFFFFL
expr_stmt|;
comment|/* write the SROM */
if|#
directive|if
literal|1
comment|/* really write it */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|64
condition|;
name|i
operator|++
control|)
name|write_srom
argument_list|(
name|i
argument_list|,
name|srom
index|[
name|i
index|]
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* print what would be written */
name|printf
argument_list|(
literal|"     0  1  2  3  4  5  6  7  8  9  A  B  C  D  E  F"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|64
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|%
literal|8
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"\n%02X: "
argument_list|,
name|i
operator|<<
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%02X %02X "
argument_list|,
name|srom
index|[
name|i
index|]
operator|&
literal|0xFF
argument_list|,
name|srom
index|[
name|i
index|]
operator|>>
literal|8
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|error
decl_stmt|,
name|ch
decl_stmt|;
name|char
modifier|*
name|optstring
init|=
literal|"13a:bBcCdDeEf:Fhi:L:mM:pP:sS:tT:uUvVwW:xXyYzZ?"
decl_stmt|;
name|progname
operator|=
operator|(
name|char
operator|*
operator|)
name|argv
index|[
literal|0
index|]
expr_stmt|;
comment|/* Here is the overall plan:    *  1) Read the interface name from the command line.    *  2) Open the device; decide if netgraph is being used.    *  3) Read the current interface configuration from the driver.    *  4) Read the command line args and carry out their actions.    *  5) Write the modified interface configuration to the driver.    */
comment|/* 1) Read the interface name from the command line. */
if|#
directive|if
name|__linux__
name|ifname
operator|=
operator|(
name|argc
operator|==
literal|1
operator|)
condition|?
literal|"hdlc0"
else|:
operator|(
name|char
operator|*
operator|)
name|argv
index|[
literal|1
index|]
expr_stmt|;
else|#
directive|else
name|ifname
operator|=
operator|(
name|argc
operator|==
literal|1
operator|)
condition|?
name|DEVICE_NAME
literal|"0"
else|:
operator|(
name|char
operator|*
operator|)
name|argv
index|[
literal|1
index|]
expr_stmt|;
endif|#
directive|endif
comment|/* 2) Open the device; decide if netgraph is being used, */
comment|/* use netgraph if ifname ends with ":" */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|ifname
index|[
name|i
index|]
operator|==
literal|0
condition|)
break|break;
comment|/* Get a socket type file descriptor. */
if|#
directive|if
name|defined
argument_list|(
name|NETGRAPH
argument_list|)
if|if
condition|(
operator|(
name|netgraph
operator|=
operator|(
name|ifname
index|[
name|i
operator|-
literal|1
index|]
operator|==
literal|':'
operator|)
operator|)
condition|)
name|error
operator|=
name|NgMkSockNode
argument_list|(
name|NULL
argument_list|,
operator|&
name|fdcs
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
else|else
endif|#
directive|endif
name|error
operator|=
name|fdcs
operator|=
name|socket
argument_list|(
name|AF_INET
argument_list|,
name|SOCK_DGRAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: %s() failed: %s\n"
argument_list|,
name|progname
argument_list|,
name|netgraph
condition|?
literal|"NgMkSockNode"
else|:
literal|"socket"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* 3) Read the current interface configuration from the driver. */
name|ioctl_read_config
argument_list|()
expr_stmt|;
name|ioctl_read_status
argument_list|()
expr_stmt|;
name|summary
operator|=
operator|(
name|argc
operator|<=
literal|2
operator|)
expr_stmt|;
comment|/* print summary at end */
name|update
operator|=
literal|0
expr_stmt|;
comment|/* write to card at end */
comment|/* 4) Read the command line args and carry out their actions. */
name|optind
operator|=
literal|2
expr_stmt|;
while|while
condition|(
operator|(
operator|(
name|ch
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|optstring
argument_list|)
operator|)
operator|!=
operator|-
literal|1
operator|)
operator|&&
operator|(
name|argc
operator|>
literal|2
operator|)
condition|)
block|{
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'1'
case|:
comment|/* T1 commands */
block|{
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"Doing T1 settings\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|.
name|card_type
operator|!=
name|TLP_CSID_T1E1
condition|)
block|{
name|printf
argument_list|(
literal|"T1 settings only apply to T1E1 cards\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|t1_cmd
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|'3'
case|:
comment|/* T3 commands */
block|{
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"Doing T3 settings\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|.
name|card_type
operator|!=
name|TLP_CSID_T3
condition|)
block|{
name|printf
argument_list|(
literal|"T3 settings only apply to T3 cards\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|t3_cmd
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|'a'
case|:
comment|/* clock source */
block|{
if|if
condition|(
operator|(
name|status
operator|.
name|card_type
operator|!=
name|TLP_CSID_T1E1
operator|)
operator|||
operator|(
name|status
operator|.
name|card_type
operator|!=
name|TLP_CSID_HSSI
operator|)
operator|||
operator|(
name|status
operator|.
name|card_type
operator|!=
name|TLP_CSID_HSSIc
operator|)
condition|)
block|{
if|if
condition|(
name|verbose
condition|)
name|print_tx_clk_src
argument_list|()
expr_stmt|;
name|config
operator|.
name|tx_clk_src
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|update
operator|=
literal|1
expr_stmt|;
block|}
else|else
name|printf
argument_list|(
literal|"txclksrc only applies to T1E1 and HSSI card types\n"
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|'b'
case|:
comment|/* read bios rom */
block|{
name|int
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"Bios ROM:\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"     0  1  2  3  4  5  6  7  8  9  A  B  C  D  E  F"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|256
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|%
literal|16
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"\n%02X: "
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%02X "
argument_list|,
name|read_bios_rom
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n\n"
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|'B'
case|:
comment|/* write bios rom */
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|256
condition|;
name|i
operator|++
control|)
name|write_bios_rom
argument_list|(
name|i
argument_list|,
literal|255
operator|-
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"wrote (0..255) to bios rom addrs (0..255)\n"
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|'c'
case|:
comment|/* set crc_len = 16 */
block|{
name|config
operator|.
name|crc_len
operator|=
name|CFG_CRC_16
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|print_crc_len
argument_list|()
expr_stmt|;
name|update
operator|=
literal|1
expr_stmt|;
break|break;
block|}
case|case
literal|'C'
case|:
comment|/* set crc_len = 32 */
block|{
name|config
operator|.
name|crc_len
operator|=
name|CFG_CRC_32
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|print_crc_len
argument_list|()
expr_stmt|;
name|update
operator|=
literal|1
expr_stmt|;
break|break;
block|}
case|case
literal|'d'
case|:
comment|/* clear DEBUG flag */
block|{
name|config
operator|.
name|debug
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"DEBUG flag cleared\n"
argument_list|)
expr_stmt|;
name|update
operator|=
literal|1
expr_stmt|;
break|break;
block|}
case|case
literal|'D'
case|:
comment|/* set DEBUG flag */
block|{
name|config
operator|.
name|debug
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"DEBUG flag set\n"
argument_list|)
expr_stmt|;
name|update
operator|=
literal|1
expr_stmt|;
break|break;
block|}
case|case
literal|'e'
case|:
comment|/* set DTE (default) */
block|{
if|if
condition|(
operator|(
name|status
operator|.
name|card_type
operator|==
name|TLP_CSID_SSI
operator|)
operator|||
operator|(
name|status
operator|.
name|card_type
operator|==
name|TLP_CSID_HSSIc
operator|)
condition|)
block|{
name|config
operator|.
name|dte_dce
operator|=
name|CFG_DTE
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|print_dte_dce
argument_list|()
expr_stmt|;
name|update
operator|=
literal|1
expr_stmt|;
block|}
else|else
name|printf
argument_list|(
literal|"DTE cmd only applies to SSI& HSSIc cards\n"
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|'E'
case|:
comment|/* set DCE */
block|{
if|if
condition|(
operator|(
name|status
operator|.
name|card_type
operator|==
name|TLP_CSID_SSI
operator|)
operator|||
operator|(
name|status
operator|.
name|card_type
operator|==
name|TLP_CSID_HSSIc
operator|)
condition|)
block|{
name|config
operator|.
name|dte_dce
operator|=
name|CFG_DCE
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|print_dte_dce
argument_list|()
expr_stmt|;
name|update
operator|=
literal|1
expr_stmt|;
block|}
else|else
name|printf
argument_list|(
literal|"DCE cmd only applies to SSI& HSSIc cards\n"
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|'f'
case|:
comment|/* set synth osc freq */
block|{
if|if
condition|(
operator|(
name|status
operator|.
name|card_type
operator|==
name|TLP_CSID_SSI
operator|)
operator|||
operator|(
name|status
operator|.
name|card_type
operator|==
name|TLP_CSID_HSSIc
operator|)
condition|)
block|{
name|synth_freq
argument_list|(
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|write_synth
argument_list|(
name|config
operator|.
name|synth
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|print_synth_freq
argument_list|()
expr_stmt|;
block|}
else|else
name|printf
argument_list|(
literal|"synth osc freq only applies to SSI& HSSIc cards\n"
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|'F'
case|:
comment|/* set SPPP line protocol to Frame-Relay */
block|{
name|config
operator|.
name|line_prot
operator|=
name|PROT_FRM_RLY
expr_stmt|;
name|config
operator|.
name|keep_alive
operator|=
literal|1
expr_stmt|;
comment|/* required for LMI operation */
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"SPPP line protocol set to Frame-Relay\n"
argument_list|)
expr_stmt|;
name|update
operator|=
literal|1
expr_stmt|;
break|break;
block|}
case|case
literal|'h'
case|:
comment|/* help */
case|case
literal|'?'
case|:
block|{
name|usage
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
case|case
literal|'i'
case|:
comment|/* interface name */
block|{
comment|/* already scanned this */
break|break;
block|}
case|case
literal|'L'
case|:
comment|/* set loopback modes */
block|{
name|config
operator|.
name|loop_back
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|print_loop_back
argument_list|()
expr_stmt|;
name|update
operator|=
literal|1
expr_stmt|;
break|break;
block|}
case|case
literal|'m'
case|:
comment|/* read and print MII regs */
block|{
name|printf
argument_list|(
literal|"MII regs:\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"      0    1    2    3    4    5    6    7"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
block|{
name|u_int16_t
name|mii
init|=
name|read_mii
argument_list|(
name|i
argument_list|)
decl_stmt|;
if|if
condition|(
name|i
operator|%
literal|8
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"\n%02X: "
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%04X "
argument_list|,
name|mii
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n\n"
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|'M'
case|:
comment|/* write MII reg */
block|{
name|u_int32_t
name|addr
init|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|u_int32_t
name|data
init|=
name|strtoul
argument_list|(
name|argv
index|[
name|optind
operator|++
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|write_mii
argument_list|(
name|addr
argument_list|,
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
block|{
name|data
operator|=
name|read_mii
argument_list|(
name|addr
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Write mii register: addr = 0x%02X data = 0x%04X\n"
argument_list|,
name|addr
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
case|case
literal|'p'
case|:
comment|/* read and print PCI config regs */
block|{
name|int
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"21140A PCI Config regs:\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"       0        1        2        3"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|%
literal|4
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"\n%X: "
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%08X "
argument_list|,
name|read_pci_config
argument_list|(
name|i
operator|<<
literal|2
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n\n"
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|'P'
case|:
comment|/* write PCI config reg */
block|{
name|u_int32_t
name|addr
init|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|u_int32_t
name|data
init|=
name|strtoul
argument_list|(
name|argv
index|[
name|optind
operator|++
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|write_pci_config
argument_list|(
name|addr
argument_list|,
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
block|{
name|data
operator|=
name|read_pci_config
argument_list|(
name|addr
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Write PCI config reg: addr = 0x%02X data = 0x%08X\n"
argument_list|,
name|addr
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
case|case
literal|'s'
case|:
comment|/* read and print Tulip SROM */
block|{
name|int
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"21140A SROM:\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"     0  1  2  3  4  5  6  7  8  9  A  B  C  D  E  F"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|64
condition|;
name|i
operator|++
control|)
block|{
name|u_int16_t
name|srom
init|=
name|read_srom
argument_list|(
name|i
argument_list|)
decl_stmt|;
if|if
condition|(
name|i
operator|%
literal|8
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"\n%02X: "
argument_list|,
name|i
operator|<<
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%02X %02X "
argument_list|,
name|srom
operator|&
literal|0xFF
argument_list|,
name|srom
operator|>>
literal|8
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n\n"
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|'S'
case|:
comment|/* write Tulip SROM loc */
block|{
if|#
directive|if
literal|0
comment|/* write a single location -- not too useful */
block|u_int32_t addr = strtoul(optarg, NULL, 0);         u_int32_t data = strtoul(argv[optind++], NULL, 0);         write_mii(addr, data);         data = read_mii(addr);         printf("Write SROM: addr = 0x%02X data = 0x%04X\n", addr, data);
endif|#
directive|endif
if|#
directive|if
literal|0
comment|/* write the whole SROM -- very dangerous */
block|init_srom(strtoul(optarg, NULL, 0));
endif|#
directive|endif
name|printf
argument_list|(
literal|"Caution! Recompile %s to enable this.\n"
argument_list|,
name|progname
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|'t'
case|:
comment|/* read and print Tulip CSRs */
block|{
name|int
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"21140A CSRs:\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"       0        1        2        3"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|%
literal|4
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"\n%X: "
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%08X "
argument_list|,
name|read_csr
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n\n"
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|'T'
case|:
comment|/* write Tulip CSR */
block|{
name|u_int32_t
name|addr
init|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|u_int32_t
name|data
init|=
name|strtoul
argument_list|(
name|argv
index|[
name|optind
operator|++
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|write_csr
argument_list|(
name|addr
argument_list|,
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
block|{
name|data
operator|=
name|read_csr
argument_list|(
name|addr
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Write 21140A CSR: addr = 0x%02X data = 0x%08X\n"
argument_list|,
name|addr
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
case|case
literal|'u'
case|:
comment|/* reset event counters */
block|{
name|ioctl_reset_cntrs
argument_list|()
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"Event counters reset\n"
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|'U'
case|:
comment|/* reset gate array */
block|{
name|reset_xilinx
argument_list|()
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"gate array reset\n"
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|'v'
case|:
comment|/* set verbose mode */
block|{
name|verbose
operator|=
literal|1
expr_stmt|;
break|break;
block|}
case|case
literal|'V'
case|:
comment|/* print card configuration */
block|{
name|summary
operator|=
literal|1
expr_stmt|;
break|break;
block|}
case|case
literal|'w'
case|:
comment|/* load gate array microcode from ROM */
block|{
name|load_xilinx_from_rom
argument_list|()
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"gate array configured from on-board ROM\n"
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|'W'
case|:
comment|/* load gate array microcode from file */
block|{
name|load_xilinx
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"gate array configured from file %s\n"
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|'x'
case|:
comment|/* select RAWIP protocol */
block|{
name|config
operator|.
name|line_pkg
operator|=
name|PKG_RAWIP
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"RAWIP mode selected\n"
argument_list|)
expr_stmt|;
name|update
operator|=
literal|1
expr_stmt|;
break|break;
block|}
case|case
literal|'X'
case|:
comment|/* Select in-kernel line protocol packages */
block|{
name|config
operator|.
name|line_pkg
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"line protocol mode selected\n"
argument_list|)
expr_stmt|;
name|update
operator|=
literal|1
expr_stmt|;
break|break;
block|}
case|case
literal|'y'
case|:
comment|/* disable SPPP keep-alive packets */
block|{
if|if
condition|(
operator|(
name|config
operator|.
name|line_pkg
operator|==
name|PKG_SPPP
operator|)
operator|&&
operator|(
name|config
operator|.
name|line_prot
operator|==
name|PROT_FRM_RLY
operator|)
condition|)
name|printf
argument_list|(
literal|"keep-alives must be ON for Frame-Relay/SPPP\n"
argument_list|)
expr_stmt|;
else|else
block|{
name|config
operator|.
name|keep_alive
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"SPPP keep-alive packets disabled\n"
argument_list|)
expr_stmt|;
name|update
operator|=
literal|1
expr_stmt|;
block|}
break|break;
block|}
case|case
literal|'Y'
case|:
comment|/* enable SPPP keep-alive packets */
block|{
name|config
operator|.
name|keep_alive
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"SPPP keep-alive packets enabled\n"
argument_list|)
expr_stmt|;
name|update
operator|=
literal|1
expr_stmt|;
break|break;
block|}
case|case
literal|'z'
case|:
comment|/* set SPPP line protocol to Cisco HDLC */
block|{
name|config
operator|.
name|line_prot
operator|=
name|PROT_C_HDLC
expr_stmt|;
name|config
operator|.
name|keep_alive
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"SPPP line protocol set to Cisco-HDLC\n"
argument_list|)
expr_stmt|;
name|update
operator|=
literal|1
expr_stmt|;
break|break;
block|}
case|case
literal|'Z'
case|:
comment|/* set SPPP line protocol to PPP */
block|{
name|config
operator|.
name|line_prot
operator|=
name|PROT_PPP
expr_stmt|;
name|config
operator|.
name|keep_alive
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"SPPP line protocol set to PPP\n"
argument_list|)
expr_stmt|;
name|update
operator|=
literal|1
expr_stmt|;
break|break;
block|}
default|default:
block|{
name|printf
argument_list|(
literal|"Unknown command char: %c\n"
argument_list|,
name|ch
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* switch */
block|}
comment|/* while */
if|if
condition|(
name|summary
condition|)
name|print_summary
argument_list|()
expr_stmt|;
comment|/*  5) Write the modified interface configuration to the driver. */
if|if
condition|(
name|update
condition|)
name|ioctl_write_config
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


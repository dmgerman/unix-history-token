begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	$KAME: ftp.c,v 1.10 2000/09/14 00:23:39 itojun Exp $	*/
end_comment

begin_comment
comment|/*  * Copyright (C) 1997 and 1998 WIDE Project.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. Neither the name of the project nor the names of its contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE PROJECT AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE PROJECT OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<syslog.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<arpa/inet.h>
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_include
include|#
directive|include
file|"faithd.h"
end_include

begin_decl_stmt
specifier|static
name|char
name|rbuf
index|[
name|MSS
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|sbuf
index|[
name|MSS
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|passivemode
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|wport4
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* listen() to active */
end_comment

begin_decl_stmt
specifier|static
name|int
name|wport6
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* listen() to passive */
end_comment

begin_decl_stmt
specifier|static
name|int
name|port4
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* active: inbound  passive: outbound */
end_comment

begin_decl_stmt
specifier|static
name|int
name|port6
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* active: outbound  passive: inbound */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|sockaddr_storage
name|data4
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* server data address */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|sockaddr_storage
name|data6
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* client data address */
end_comment

begin_decl_stmt
specifier|static
name|int
name|epsvall
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|FAITH4
end_ifdef

begin_enum
enum|enum
name|state
block|{
name|NONE
block|,
name|LPRT
block|,
name|EPRT
block|,
name|PORT
block|,
name|LPSV
block|,
name|EPSV
block|,
name|PASV
block|}
enum|;
end_enum

begin_else
else|#
directive|else
end_else

begin_enum
enum|enum
name|state
block|{
name|NONE
block|,
name|LPRT
block|,
name|EPRT
block|,
name|LPSV
block|,
name|EPSV
block|}
enum|;
end_enum

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|static
name|int
name|ftp_activeconn
name|__P
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|ftp_passiveconn
name|__P
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|ftp_copy
name|__P
argument_list|(
operator|(
name|int
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|ftp_copyresult
name|__P
argument_list|(
operator|(
name|int
operator|,
name|int
operator|,
expr|enum
name|state
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|ftp_copycommand
name|__P
argument_list|(
operator|(
name|int
operator|,
name|int
operator|,
expr|enum
name|state
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|ftp_relay
parameter_list|(
name|int
name|ctl6
parameter_list|,
name|int
name|ctl4
parameter_list|)
block|{
name|fd_set
name|readfds
decl_stmt|;
name|int
name|error
decl_stmt|;
name|enum
name|state
name|state
init|=
name|NONE
decl_stmt|;
name|struct
name|timeval
name|tv
decl_stmt|;
name|syslog
argument_list|(
name|LOG_INFO
argument_list|,
literal|"starting ftp control connection"
argument_list|)
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|FD_ZERO
argument_list|(
operator|&
name|readfds
argument_list|)
expr_stmt|;
name|FD_SET
argument_list|(
name|ctl4
argument_list|,
operator|&
name|readfds
argument_list|)
expr_stmt|;
name|FD_SET
argument_list|(
name|ctl6
argument_list|,
operator|&
name|readfds
argument_list|)
expr_stmt|;
if|if
condition|(
literal|0
operator|<=
name|port4
condition|)
name|FD_SET
argument_list|(
name|port4
argument_list|,
operator|&
name|readfds
argument_list|)
expr_stmt|;
if|if
condition|(
literal|0
operator|<=
name|port6
condition|)
name|FD_SET
argument_list|(
name|port6
argument_list|,
operator|&
name|readfds
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|if (0<= wport4) 			FD_SET(wport4,&readfds); 		if (0<= wport6) 			FD_SET(wport6,&readfds);
endif|#
directive|endif
name|tv
operator|.
name|tv_sec
operator|=
name|FAITH_TIMEOUT
expr_stmt|;
name|tv
operator|.
name|tv_usec
operator|=
literal|0
expr_stmt|;
name|error
operator|=
name|select
argument_list|(
literal|256
argument_list|,
operator|&
name|readfds
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|tv
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
operator|-
literal|1
condition|)
name|exit_failure
argument_list|(
literal|"select: %s"
argument_list|,
name|ERRSTR
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|exit_failure
argument_list|(
literal|"connection timeout"
argument_list|)
expr_stmt|;
comment|/* 		 * The order of the following checks does (slightly) matter. 		 * It is important to visit all checks (do not use "continue"), 		 * otherwise some of the pipe may become full and we cannot 		 * relay correctly. 		 */
if|if
condition|(
name|FD_ISSET
argument_list|(
name|ctl6
argument_list|,
operator|&
name|readfds
argument_list|)
condition|)
block|{
comment|/* 			 * copy control connection from the client. 			 * command translation is necessary. 			 */
name|error
operator|=
name|ftp_copycommand
argument_list|(
name|ctl6
argument_list|,
name|ctl4
argument_list|,
operator|&
name|state
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|error
condition|)
block|{
case|case
operator|-
literal|1
case|:
goto|goto
name|bad
goto|;
case|case
literal|0
case|:
name|close
argument_list|(
name|ctl4
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|ctl6
argument_list|)
expr_stmt|;
name|exit_success
argument_list|(
literal|"terminating ftp control connection"
argument_list|)
expr_stmt|;
comment|/*NOTREACHED*/
default|default:
break|break;
block|}
block|}
if|if
condition|(
name|FD_ISSET
argument_list|(
name|ctl4
argument_list|,
operator|&
name|readfds
argument_list|)
condition|)
block|{
comment|/* 			 * copy control connection from the server 			 * translation of result code is necessary. 			 */
name|error
operator|=
name|ftp_copyresult
argument_list|(
name|ctl4
argument_list|,
name|ctl6
argument_list|,
name|state
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|error
condition|)
block|{
case|case
operator|-
literal|1
case|:
goto|goto
name|bad
goto|;
case|case
literal|0
case|:
name|close
argument_list|(
name|ctl4
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|ctl6
argument_list|)
expr_stmt|;
name|exit_success
argument_list|(
literal|"terminating ftp control connection"
argument_list|)
expr_stmt|;
comment|/*NOTREACHED*/
default|default:
break|break;
block|}
block|}
if|if
condition|(
literal|0
operator|<=
name|port4
operator|&&
literal|0
operator|<=
name|port6
operator|&&
name|FD_ISSET
argument_list|(
name|port4
argument_list|,
operator|&
name|readfds
argument_list|)
condition|)
block|{
comment|/* 			 * copy data connection. 			 * no special treatment necessary. 			 */
if|if
condition|(
name|FD_ISSET
argument_list|(
name|port4
argument_list|,
operator|&
name|readfds
argument_list|)
condition|)
name|error
operator|=
name|ftp_copy
argument_list|(
name|port4
argument_list|,
name|port6
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|error
condition|)
block|{
case|case
operator|-
literal|1
case|:
goto|goto
name|bad
goto|;
case|case
literal|0
case|:
name|close
argument_list|(
name|port4
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|port6
argument_list|)
expr_stmt|;
name|port4
operator|=
name|port6
operator|=
operator|-
literal|1
expr_stmt|;
name|syslog
argument_list|(
name|LOG_INFO
argument_list|,
literal|"terminating data connection"
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
if|if
condition|(
literal|0
operator|<=
name|port4
operator|&&
literal|0
operator|<=
name|port6
operator|&&
name|FD_ISSET
argument_list|(
name|port6
argument_list|,
operator|&
name|readfds
argument_list|)
condition|)
block|{
comment|/* 			 * copy data connection. 			 * no special treatment necessary. 			 */
if|if
condition|(
name|FD_ISSET
argument_list|(
name|port6
argument_list|,
operator|&
name|readfds
argument_list|)
condition|)
name|error
operator|=
name|ftp_copy
argument_list|(
name|port6
argument_list|,
name|port4
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|error
condition|)
block|{
case|case
operator|-
literal|1
case|:
goto|goto
name|bad
goto|;
case|case
literal|0
case|:
name|close
argument_list|(
name|port4
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|port6
argument_list|)
expr_stmt|;
name|port4
operator|=
name|port6
operator|=
operator|-
literal|1
expr_stmt|;
name|syslog
argument_list|(
name|LOG_INFO
argument_list|,
literal|"terminating data connection"
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
if|#
directive|if
literal|0
block|if (wport4&& FD_ISSET(wport4,&readfds)) {
comment|/* 			 * establish active data connection from the server. 			 */
block|ftp_activeconn(); 		} 		if (wport6&& FD_ISSET(wport6,&readfds)) {
comment|/* 			 * establish passive data connection from the client. 			 */
block|ftp_passiveconn(); 		}
endif|#
directive|endif
block|}
name|bad
label|:
name|exit_failure
argument_list|(
name|ERRSTR
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|ftp_activeconn
parameter_list|()
block|{
name|int
name|n
decl_stmt|;
name|int
name|error
decl_stmt|;
name|fd_set
name|set
decl_stmt|;
name|struct
name|timeval
name|timeout
decl_stmt|;
name|struct
name|sockaddr
modifier|*
name|sa
decl_stmt|;
comment|/* get active connection from server */
name|FD_ZERO
argument_list|(
operator|&
name|set
argument_list|)
expr_stmt|;
name|FD_SET
argument_list|(
name|wport4
argument_list|,
operator|&
name|set
argument_list|)
expr_stmt|;
name|timeout
operator|.
name|tv_sec
operator|=
literal|120
expr_stmt|;
name|timeout
operator|.
name|tv_usec
operator|=
operator|-
literal|1
expr_stmt|;
name|n
operator|=
sizeof|sizeof
argument_list|(
name|data4
argument_list|)
expr_stmt|;
if|if
condition|(
name|select
argument_list|(
name|wport4
operator|+
literal|1
argument_list|,
operator|&
name|set
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|timeout
argument_list|)
operator|==
literal|0
operator|||
operator|(
name|port4
operator|=
name|accept
argument_list|(
name|wport4
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|data4
argument_list|,
operator|&
name|n
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|close
argument_list|(
name|wport4
argument_list|)
expr_stmt|;
name|wport4
operator|=
operator|-
literal|1
expr_stmt|;
name|syslog
argument_list|(
name|LOG_INFO
argument_list|,
literal|"active mode data connection failed"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* ask active connection to client */
name|sa
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|data6
expr_stmt|;
name|port6
operator|=
name|socket
argument_list|(
name|sa
operator|->
name|sa_family
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|port6
operator|==
operator|-
literal|1
condition|)
block|{
name|close
argument_list|(
name|port4
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|wport4
argument_list|)
expr_stmt|;
name|port4
operator|=
name|wport4
operator|=
operator|-
literal|1
expr_stmt|;
name|syslog
argument_list|(
name|LOG_INFO
argument_list|,
literal|"active mode data connection failed"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|error
operator|=
name|connect
argument_list|(
name|port6
argument_list|,
name|sa
argument_list|,
name|sa
operator|->
name|sa_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|port6
operator|==
operator|-
literal|1
condition|)
block|{
name|close
argument_list|(
name|port6
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|port4
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|wport4
argument_list|)
expr_stmt|;
name|port6
operator|=
name|port4
operator|=
name|wport4
operator|=
operator|-
literal|1
expr_stmt|;
name|syslog
argument_list|(
name|LOG_INFO
argument_list|,
literal|"active mode data connection failed"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|syslog
argument_list|(
name|LOG_INFO
argument_list|,
literal|"active mode data connection established"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ftp_passiveconn
parameter_list|()
block|{
name|int
name|n
decl_stmt|;
name|int
name|error
decl_stmt|;
name|fd_set
name|set
decl_stmt|;
name|struct
name|timeval
name|timeout
decl_stmt|;
name|struct
name|sockaddr
modifier|*
name|sa
decl_stmt|;
comment|/* get passive connection from client */
name|FD_ZERO
argument_list|(
operator|&
name|set
argument_list|)
expr_stmt|;
name|FD_SET
argument_list|(
name|wport6
argument_list|,
operator|&
name|set
argument_list|)
expr_stmt|;
name|timeout
operator|.
name|tv_sec
operator|=
literal|120
expr_stmt|;
name|timeout
operator|.
name|tv_usec
operator|=
literal|0
expr_stmt|;
name|n
operator|=
sizeof|sizeof
argument_list|(
name|data6
argument_list|)
expr_stmt|;
if|if
condition|(
name|select
argument_list|(
name|wport6
operator|+
literal|1
argument_list|,
operator|&
name|set
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|timeout
argument_list|)
operator|==
literal|0
operator|||
operator|(
name|port6
operator|=
name|accept
argument_list|(
name|wport6
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|data6
argument_list|,
operator|&
name|n
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|close
argument_list|(
name|wport6
argument_list|)
expr_stmt|;
name|wport6
operator|=
operator|-
literal|1
expr_stmt|;
name|syslog
argument_list|(
name|LOG_INFO
argument_list|,
literal|"passive mode data connection failed"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* ask passive connection to server */
name|sa
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|data4
expr_stmt|;
name|port4
operator|=
name|socket
argument_list|(
name|sa
operator|->
name|sa_family
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|port4
operator|==
operator|-
literal|1
condition|)
block|{
name|close
argument_list|(
name|wport6
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|port6
argument_list|)
expr_stmt|;
name|wport6
operator|=
name|port6
operator|=
operator|-
literal|1
expr_stmt|;
name|syslog
argument_list|(
name|LOG_INFO
argument_list|,
literal|"passive mode data connection failed"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|error
operator|=
name|connect
argument_list|(
name|port4
argument_list|,
name|sa
argument_list|,
name|sa
operator|->
name|sa_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|port4
operator|==
operator|-
literal|1
condition|)
block|{
name|close
argument_list|(
name|wport6
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|port4
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|port6
argument_list|)
expr_stmt|;
name|wport6
operator|=
name|port4
operator|=
name|port6
operator|=
operator|-
literal|1
expr_stmt|;
name|syslog
argument_list|(
name|LOG_INFO
argument_list|,
literal|"passive mode data connection failed"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|syslog
argument_list|(
name|LOG_INFO
argument_list|,
literal|"passive mode data connection established"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ftp_copy
parameter_list|(
name|int
name|src
parameter_list|,
name|int
name|dst
parameter_list|)
block|{
name|int
name|error
decl_stmt|,
name|atmark
decl_stmt|;
name|int
name|n
decl_stmt|;
comment|/* OOB data handling */
name|error
operator|=
name|ioctl
argument_list|(
name|src
argument_list|,
name|SIOCATMARK
argument_list|,
operator|&
name|atmark
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
operator|-
literal|1
operator|&&
name|atmark
operator|==
literal|1
condition|)
block|{
name|n
operator|=
name|read
argument_list|(
name|src
argument_list|,
name|rbuf
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
operator|-
literal|1
condition|)
goto|goto
name|bad
goto|;
name|send
argument_list|(
name|dst
argument_list|,
name|rbuf
argument_list|,
name|n
argument_list|,
name|MSG_OOB
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|n = read(src, rbuf, sizeof(rbuf)); 		if (n == -1) 			goto bad; 		write(dst, rbuf, n); 		return n;
endif|#
directive|endif
block|}
name|n
operator|=
name|read
argument_list|(
name|src
argument_list|,
name|rbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|rbuf
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|n
condition|)
block|{
case|case
operator|-
literal|1
case|:
case|case
literal|0
case|:
return|return
name|n
return|;
default|default:
name|write
argument_list|(
name|dst
argument_list|,
name|rbuf
argument_list|,
name|n
argument_list|)
expr_stmt|;
return|return
name|n
return|;
block|}
name|bad
label|:
name|exit_failure
argument_list|(
name|ERRSTR
argument_list|)
expr_stmt|;
comment|/*NOTREACHED*/
return|return
literal|0
return|;
comment|/* to make gcc happy */
block|}
end_function

begin_function
specifier|static
name|int
name|ftp_copyresult
parameter_list|(
name|int
name|src
parameter_list|,
name|int
name|dst
parameter_list|,
name|enum
name|state
name|state
parameter_list|)
block|{
name|int
name|error
decl_stmt|,
name|atmark
decl_stmt|;
name|int
name|n
decl_stmt|;
name|char
modifier|*
name|param
decl_stmt|;
name|int
name|code
decl_stmt|;
comment|/* OOB data handling */
name|error
operator|=
name|ioctl
argument_list|(
name|src
argument_list|,
name|SIOCATMARK
argument_list|,
operator|&
name|atmark
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
operator|-
literal|1
operator|&&
name|atmark
operator|==
literal|1
condition|)
block|{
name|n
operator|=
name|read
argument_list|(
name|src
argument_list|,
name|rbuf
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
operator|-
literal|1
condition|)
goto|goto
name|bad
goto|;
name|send
argument_list|(
name|dst
argument_list|,
name|rbuf
argument_list|,
name|n
argument_list|,
name|MSG_OOB
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|n = read(src, rbuf, sizeof(rbuf)); 		if (n == -1) 			goto bad; 		write(dst, rbuf, n); 		return n;
endif|#
directive|endif
block|}
name|n
operator|=
name|read
argument_list|(
name|src
argument_list|,
name|rbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|rbuf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|<=
literal|0
condition|)
return|return
name|n
return|;
name|rbuf
index|[
name|n
index|]
operator|=
literal|'\0'
expr_stmt|;
comment|/* 	 * parse argument 	 */
block|{
name|char
modifier|*
name|p
decl_stmt|;
name|int
name|i
decl_stmt|;
name|p
operator|=
name|rbuf
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|3
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|isdigit
argument_list|(
operator|*
name|p
argument_list|)
condition|)
block|{
comment|/* invalid reply */
name|write
argument_list|(
name|dst
argument_list|,
name|rbuf
argument_list|,
name|n
argument_list|)
expr_stmt|;
return|return
name|n
return|;
block|}
name|p
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|isspace
argument_list|(
operator|*
name|p
argument_list|)
condition|)
block|{
comment|/* invalid reply */
name|write
argument_list|(
name|dst
argument_list|,
name|rbuf
argument_list|,
name|n
argument_list|)
expr_stmt|;
return|return
name|n
return|;
block|}
name|code
operator|=
name|atoi
argument_list|(
name|rbuf
argument_list|)
expr_stmt|;
name|param
operator|=
name|p
expr_stmt|;
comment|/* param points to first non-command token, if any */
while|while
condition|(
operator|*
name|param
operator|&&
name|isspace
argument_list|(
operator|*
name|param
argument_list|)
condition|)
name|param
operator|++
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|param
condition|)
name|param
operator|=
name|NULL
expr_stmt|;
block|}
switch|switch
condition|(
name|state
condition|)
block|{
case|case
name|NONE
case|:
if|if
condition|(
operator|!
name|passivemode
operator|&&
name|rbuf
index|[
literal|0
index|]
operator|==
literal|'1'
condition|)
block|{
if|if
condition|(
name|ftp_activeconn
argument_list|()
operator|<
literal|0
condition|)
block|{
name|n
operator|=
name|snprintf
argument_list|(
name|rbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|rbuf
argument_list|)
argument_list|,
literal|"425 Cannot open data connetion\r\n"
argument_list|)
expr_stmt|;
block|}
block|}
name|write
argument_list|(
name|dst
argument_list|,
name|rbuf
argument_list|,
name|n
argument_list|)
expr_stmt|;
return|return
name|n
return|;
case|case
name|LPRT
case|:
case|case
name|EPRT
case|:
comment|/* expecting "200 PORT command successful." */
if|if
condition|(
name|code
operator|==
literal|200
condition|)
block|{
name|char
modifier|*
name|p
decl_stmt|;
name|p
operator|=
name|strstr
argument_list|(
name|rbuf
argument_list|,
literal|"PORT"
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
condition|)
block|{
name|p
index|[
literal|0
index|]
operator|=
operator|(
name|state
operator|==
name|LPRT
operator|)
condition|?
literal|'L'
else|:
literal|'E'
expr_stmt|;
name|p
index|[
literal|1
index|]
operator|=
literal|'P'
expr_stmt|;
block|}
block|}
else|else
block|{
name|close
argument_list|(
name|wport4
argument_list|)
expr_stmt|;
name|wport4
operator|=
operator|-
literal|1
expr_stmt|;
block|}
name|write
argument_list|(
name|dst
argument_list|,
name|rbuf
argument_list|,
name|n
argument_list|)
expr_stmt|;
return|return
name|n
return|;
ifdef|#
directive|ifdef
name|FAITH4
case|case
name|PORT
case|:
comment|/* expecting "200 EPRT command successful." */
if|if
condition|(
name|code
operator|==
literal|200
condition|)
block|{
name|char
modifier|*
name|p
decl_stmt|;
name|p
operator|=
name|strstr
argument_list|(
name|rbuf
argument_list|,
literal|"EPRT"
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
condition|)
block|{
name|p
index|[
literal|0
index|]
operator|=
literal|'P'
expr_stmt|;
name|p
index|[
literal|1
index|]
operator|=
literal|'O'
expr_stmt|;
block|}
block|}
else|else
block|{
name|close
argument_list|(
name|wport4
argument_list|)
expr_stmt|;
name|wport4
operator|=
operator|-
literal|1
expr_stmt|;
block|}
name|write
argument_list|(
name|dst
argument_list|,
name|rbuf
argument_list|,
name|n
argument_list|)
expr_stmt|;
return|return
name|n
return|;
endif|#
directive|endif
case|case
name|LPSV
case|:
case|case
name|EPSV
case|:
comment|/* 		 * expecting "227 Entering Passive Mode (x,x,x,x,x,x,x)" 		 * (in some cases result comes without paren) 		 */
if|if
condition|(
name|code
operator|!=
literal|227
condition|)
block|{
name|passivefail0
label|:
name|close
argument_list|(
name|wport6
argument_list|)
expr_stmt|;
name|wport6
operator|=
operator|-
literal|1
expr_stmt|;
name|write
argument_list|(
name|dst
argument_list|,
name|rbuf
argument_list|,
name|n
argument_list|)
expr_stmt|;
return|return
name|n
return|;
block|}
block|{
name|unsigned
name|int
name|ho
index|[
literal|4
index|]
decl_stmt|,
name|po
index|[
literal|2
index|]
decl_stmt|;
name|struct
name|sockaddr_in
modifier|*
name|sin
decl_stmt|;
name|struct
name|sockaddr_in6
modifier|*
name|sin6
decl_stmt|;
name|u_short
name|port
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|;
comment|/* 		 * PASV result -> LPSV/EPSV result 		 */
name|p
operator|=
name|param
expr_stmt|;
while|while
condition|(
operator|*
name|p
operator|&&
operator|*
name|p
operator|!=
literal|'('
operator|&&
operator|!
name|isdigit
argument_list|(
operator|*
name|p
argument_list|)
condition|)
comment|/*)*/
name|p
operator|++
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|p
condition|)
goto|goto
name|passivefail0
goto|;
comment|/*XXX*/
if|if
condition|(
operator|*
name|p
operator|==
literal|'('
condition|)
comment|/*)*/
name|p
operator|++
expr_stmt|;
name|n
operator|=
name|sscanf
argument_list|(
name|p
argument_list|,
literal|"%u,%u,%u,%u,%u,%u"
argument_list|,
operator|&
name|ho
index|[
literal|0
index|]
argument_list|,
operator|&
name|ho
index|[
literal|1
index|]
argument_list|,
operator|&
name|ho
index|[
literal|2
index|]
argument_list|,
operator|&
name|ho
index|[
literal|3
index|]
argument_list|,
operator|&
name|po
index|[
literal|0
index|]
argument_list|,
operator|&
name|po
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|!=
literal|6
condition|)
goto|goto
name|passivefail0
goto|;
comment|/*XXX*/
comment|/* keep PORT parameter */
name|memset
argument_list|(
operator|&
name|data4
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|data4
argument_list|)
argument_list|)
expr_stmt|;
name|sin
operator|=
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
operator|&
name|data4
expr_stmt|;
name|sin
operator|->
name|sin_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|sin
argument_list|)
expr_stmt|;
name|sin
operator|->
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|sin
operator|->
name|sin_addr
operator|.
name|s_addr
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
literal|4
condition|;
name|n
operator|++
control|)
block|{
name|sin
operator|->
name|sin_addr
operator|.
name|s_addr
operator||=
name|htonl
argument_list|(
operator|(
name|ho
index|[
name|n
index|]
operator|&
literal|0xff
operator|)
operator|<<
operator|(
operator|(
literal|3
operator|-
name|n
operator|)
operator|*
literal|8
operator|)
argument_list|)
expr_stmt|;
block|}
name|sin
operator|->
name|sin_port
operator|=
name|htons
argument_list|(
operator|(
operator|(
name|po
index|[
literal|0
index|]
operator|&
literal|0xff
operator|)
operator|<<
literal|8
operator|)
operator||
operator|(
name|po
index|[
literal|1
index|]
operator|&
literal|0xff
operator|)
argument_list|)
expr_stmt|;
comment|/* get ready for passive data connection */
name|memset
argument_list|(
operator|&
name|data6
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|data6
argument_list|)
argument_list|)
expr_stmt|;
name|sin6
operator|=
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
operator|&
name|data6
expr_stmt|;
name|sin6
operator|->
name|sin6_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|sin6
argument_list|)
expr_stmt|;
name|sin6
operator|->
name|sin6_family
operator|=
name|AF_INET6
expr_stmt|;
name|wport6
operator|=
name|socket
argument_list|(
name|sin6
operator|->
name|sin6_family
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|wport6
operator|==
operator|-
literal|1
condition|)
block|{
name|passivefail
label|:
name|n
operator|=
name|snprintf
argument_list|(
name|sbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|sbuf
argument_list|)
argument_list|,
literal|"500 could not translate from PASV\r\n"
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|src
argument_list|,
name|sbuf
argument_list|,
name|n
argument_list|)
expr_stmt|;
return|return
name|n
return|;
block|}
ifdef|#
directive|ifdef
name|IPV6_FAITH
block|{
name|int
name|on
init|=
literal|1
decl_stmt|;
name|error
operator|=
name|setsockopt
argument_list|(
name|wport6
argument_list|,
name|IPPROTO_IPV6
argument_list|,
name|IPV6_FAITH
argument_list|,
operator|&
name|on
argument_list|,
sizeof|sizeof
argument_list|(
name|on
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
operator|-
literal|1
condition|)
name|exit_failure
argument_list|(
literal|"setsockopt(IPV6_FAITH): %s"
argument_list|,
name|ERRSTR
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|error
operator|=
name|bind
argument_list|(
name|wport6
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
name|sin6
argument_list|,
name|sin6
operator|->
name|sin6_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
operator|-
literal|1
condition|)
block|{
name|close
argument_list|(
name|wport6
argument_list|)
expr_stmt|;
name|wport6
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|passivefail
goto|;
block|}
name|error
operator|=
name|listen
argument_list|(
name|wport6
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
operator|-
literal|1
condition|)
block|{
name|close
argument_list|(
name|wport6
argument_list|)
expr_stmt|;
name|wport6
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|passivefail
goto|;
block|}
comment|/* transmit LPSV or EPSV */
comment|/* 		 * addr from dst, port from wport6 		 */
name|n
operator|=
sizeof|sizeof
argument_list|(
name|data6
argument_list|)
expr_stmt|;
name|error
operator|=
name|getsockname
argument_list|(
name|wport6
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|data6
argument_list|,
operator|&
name|n
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
operator|-
literal|1
condition|)
block|{
name|close
argument_list|(
name|wport6
argument_list|)
expr_stmt|;
name|wport6
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|passivefail
goto|;
block|}
name|sin6
operator|=
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
operator|&
name|data6
expr_stmt|;
name|port
operator|=
name|sin6
operator|->
name|sin6_port
expr_stmt|;
name|n
operator|=
sizeof|sizeof
argument_list|(
name|data6
argument_list|)
expr_stmt|;
name|error
operator|=
name|getsockname
argument_list|(
name|dst
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|data6
argument_list|,
operator|&
name|n
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
operator|-
literal|1
condition|)
block|{
name|close
argument_list|(
name|wport6
argument_list|)
expr_stmt|;
name|wport6
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|passivefail
goto|;
block|}
name|sin6
operator|=
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
operator|&
name|data6
expr_stmt|;
name|sin6
operator|->
name|sin6_port
operator|=
name|port
expr_stmt|;
if|if
condition|(
name|state
operator|==
name|LPSV
condition|)
block|{
name|char
modifier|*
name|a
decl_stmt|,
modifier|*
name|p
decl_stmt|;
name|a
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
name|sin6
operator|->
name|sin6_addr
expr_stmt|;
name|p
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
name|sin6
operator|->
name|sin6_port
expr_stmt|;
name|n
operator|=
name|snprintf
argument_list|(
name|sbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|sbuf
argument_list|)
argument_list|,
literal|"228 Entering Long Passive Mode (%d,%d,%d,%d,%d,%d,%d,%d,%d,%d,%d,%d,%d,%d,%d,%d,%d,%d,%d,%d,%d)\r\n"
argument_list|,
literal|6
argument_list|,
literal|16
argument_list|,
name|UC
argument_list|(
name|a
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|UC
argument_list|(
name|a
index|[
literal|1
index|]
argument_list|)
argument_list|,
name|UC
argument_list|(
name|a
index|[
literal|2
index|]
argument_list|)
argument_list|,
name|UC
argument_list|(
name|a
index|[
literal|3
index|]
argument_list|)
argument_list|,
name|UC
argument_list|(
name|a
index|[
literal|4
index|]
argument_list|)
argument_list|,
name|UC
argument_list|(
name|a
index|[
literal|5
index|]
argument_list|)
argument_list|,
name|UC
argument_list|(
name|a
index|[
literal|6
index|]
argument_list|)
argument_list|,
name|UC
argument_list|(
name|a
index|[
literal|7
index|]
argument_list|)
argument_list|,
name|UC
argument_list|(
name|a
index|[
literal|8
index|]
argument_list|)
argument_list|,
name|UC
argument_list|(
name|a
index|[
literal|9
index|]
argument_list|)
argument_list|,
name|UC
argument_list|(
name|a
index|[
literal|10
index|]
argument_list|)
argument_list|,
name|UC
argument_list|(
name|a
index|[
literal|11
index|]
argument_list|)
argument_list|,
name|UC
argument_list|(
name|a
index|[
literal|12
index|]
argument_list|)
argument_list|,
name|UC
argument_list|(
name|a
index|[
literal|13
index|]
argument_list|)
argument_list|,
name|UC
argument_list|(
name|a
index|[
literal|14
index|]
argument_list|)
argument_list|,
name|UC
argument_list|(
name|a
index|[
literal|15
index|]
argument_list|)
argument_list|,
literal|2
argument_list|,
name|UC
argument_list|(
name|p
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|UC
argument_list|(
name|p
index|[
literal|1
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|dst
argument_list|,
name|sbuf
argument_list|,
name|n
argument_list|)
expr_stmt|;
name|passivemode
operator|=
literal|1
expr_stmt|;
return|return
name|n
return|;
block|}
else|else
block|{
name|n
operator|=
name|snprintf
argument_list|(
name|sbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|sbuf
argument_list|)
argument_list|,
literal|"229 Entering Extended Passive Mode (|||%d|)\r\n"
argument_list|,
name|ntohs
argument_list|(
name|sin6
operator|->
name|sin6_port
argument_list|)
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|dst
argument_list|,
name|sbuf
argument_list|,
name|n
argument_list|)
expr_stmt|;
name|passivemode
operator|=
literal|1
expr_stmt|;
return|return
name|n
return|;
block|}
block|}
ifdef|#
directive|ifdef
name|FAITH4
case|case
name|PASV
case|:
comment|/* expecting "229 Entering Extended Passive Mode (|||x|)" */
if|if
condition|(
name|code
operator|!=
literal|229
condition|)
block|{
name|passivefail1
label|:
name|close
argument_list|(
name|wport6
argument_list|)
expr_stmt|;
name|wport6
operator|=
operator|-
literal|1
expr_stmt|;
name|write
argument_list|(
name|dst
argument_list|,
name|rbuf
argument_list|,
name|n
argument_list|)
expr_stmt|;
return|return
name|n
return|;
block|}
block|{
name|u_short
name|port
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|;
name|struct
name|sockaddr_in
modifier|*
name|sin
decl_stmt|;
name|struct
name|sockaddr_in6
modifier|*
name|sin6
decl_stmt|;
comment|/* 		 * EPSV result -> PORT result 		 */
name|p
operator|=
name|param
expr_stmt|;
while|while
condition|(
operator|*
name|p
operator|&&
operator|*
name|p
operator|!=
literal|'('
condition|)
comment|/*)*/
name|p
operator|++
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|p
condition|)
goto|goto
name|passivefail1
goto|;
comment|/*XXX*/
name|p
operator|++
expr_stmt|;
name|n
operator|=
name|sscanf
argument_list|(
name|p
argument_list|,
literal|"|||%hu|"
argument_list|,
operator|&
name|port
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|!=
literal|1
condition|)
goto|goto
name|passivefail1
goto|;
comment|/*XXX*/
comment|/* keep EPRT parameter */
name|n
operator|=
sizeof|sizeof
argument_list|(
name|data4
argument_list|)
expr_stmt|;
name|error
operator|=
name|getpeername
argument_list|(
name|src
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|data4
argument_list|,
operator|&
name|n
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
operator|-
literal|1
condition|)
goto|goto
name|passivefail1
goto|;
comment|/*XXX*/
name|sin6
operator|=
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
operator|&
name|data4
expr_stmt|;
name|sin6
operator|->
name|sin6_port
operator|=
name|htons
argument_list|(
name|port
argument_list|)
expr_stmt|;
comment|/* get ready for passive data connection */
name|memset
argument_list|(
operator|&
name|data6
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|data6
argument_list|)
argument_list|)
expr_stmt|;
name|sin
operator|=
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
operator|&
name|data6
expr_stmt|;
name|sin
operator|->
name|sin_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|sin
argument_list|)
expr_stmt|;
name|sin
operator|->
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|wport6
operator|=
name|socket
argument_list|(
name|sin
operator|->
name|sin_family
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|wport6
operator|==
operator|-
literal|1
condition|)
block|{
name|passivefail2
label|:
name|n
operator|=
name|snprintf
argument_list|(
name|sbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|sbuf
argument_list|)
argument_list|,
literal|"500 could not translate from EPSV\r\n"
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|src
argument_list|,
name|sbuf
argument_list|,
name|n
argument_list|)
expr_stmt|;
return|return
name|n
return|;
block|}
ifdef|#
directive|ifdef
name|IP_FAITH
block|{
name|int
name|on
init|=
literal|1
decl_stmt|;
name|error
operator|=
name|setsockopt
argument_list|(
name|wport6
argument_list|,
name|IPPROTO_IP
argument_list|,
name|IP_FAITH
argument_list|,
operator|&
name|on
argument_list|,
sizeof|sizeof
argument_list|(
name|on
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
operator|-
literal|1
condition|)
name|exit_error
argument_list|(
literal|"setsockopt(IP_FAITH): %s"
argument_list|,
name|ERRSTR
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|error
operator|=
name|bind
argument_list|(
name|wport6
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
name|sin
argument_list|,
name|sin
operator|->
name|sin_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
operator|-
literal|1
condition|)
block|{
name|close
argument_list|(
name|wport6
argument_list|)
expr_stmt|;
name|wport6
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|passivefail2
goto|;
block|}
name|error
operator|=
name|listen
argument_list|(
name|wport6
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
operator|-
literal|1
condition|)
block|{
name|close
argument_list|(
name|wport6
argument_list|)
expr_stmt|;
name|wport6
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|passivefail2
goto|;
block|}
comment|/* transmit PORT */
comment|/* 		 * addr from dst, port from wport6 		 */
name|n
operator|=
sizeof|sizeof
argument_list|(
name|data6
argument_list|)
expr_stmt|;
name|error
operator|=
name|getsockname
argument_list|(
name|wport6
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|data6
argument_list|,
operator|&
name|n
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
operator|-
literal|1
condition|)
block|{
name|close
argument_list|(
name|wport6
argument_list|)
expr_stmt|;
name|wport6
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|passivefail2
goto|;
block|}
name|sin
operator|=
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
operator|&
name|data6
expr_stmt|;
name|port
operator|=
name|sin
operator|->
name|sin_port
expr_stmt|;
name|n
operator|=
sizeof|sizeof
argument_list|(
name|data6
argument_list|)
expr_stmt|;
name|error
operator|=
name|getsockname
argument_list|(
name|dst
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|data6
argument_list|,
operator|&
name|n
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
operator|-
literal|1
condition|)
block|{
name|close
argument_list|(
name|wport6
argument_list|)
expr_stmt|;
name|wport6
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|passivefail2
goto|;
block|}
name|sin
operator|=
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
operator|&
name|data6
expr_stmt|;
name|sin
operator|->
name|sin_port
operator|=
name|port
expr_stmt|;
block|{
name|char
modifier|*
name|a
decl_stmt|,
modifier|*
name|p
decl_stmt|;
name|a
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
name|sin
operator|->
name|sin_addr
expr_stmt|;
name|p
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
name|sin
operator|->
name|sin_port
expr_stmt|;
name|n
operator|=
name|snprintf
argument_list|(
name|sbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|sbuf
argument_list|)
argument_list|,
literal|"227 Entering Passive Mode (%d,%d,%d,%d,%d,%d)\r\n"
argument_list|,
name|UC
argument_list|(
name|a
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|UC
argument_list|(
name|a
index|[
literal|1
index|]
argument_list|)
argument_list|,
name|UC
argument_list|(
name|a
index|[
literal|2
index|]
argument_list|)
argument_list|,
name|UC
argument_list|(
name|a
index|[
literal|3
index|]
argument_list|)
argument_list|,
name|UC
argument_list|(
name|p
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|UC
argument_list|(
name|p
index|[
literal|1
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|dst
argument_list|,
name|sbuf
argument_list|,
name|n
argument_list|)
expr_stmt|;
name|passivemode
operator|=
literal|1
expr_stmt|;
return|return
name|n
return|;
block|}
block|}
endif|#
directive|endif
comment|/* FAITH4 */
block|}
name|bad
label|:
name|exit_failure
argument_list|(
name|ERRSTR
argument_list|)
expr_stmt|;
comment|/*NOTREACHED*/
return|return
literal|0
return|;
comment|/* to make gcc happy */
block|}
end_function

begin_function
specifier|static
name|int
name|ftp_copycommand
parameter_list|(
name|int
name|src
parameter_list|,
name|int
name|dst
parameter_list|,
name|enum
name|state
modifier|*
name|state
parameter_list|)
block|{
name|int
name|error
decl_stmt|,
name|atmark
decl_stmt|;
name|int
name|n
decl_stmt|;
name|unsigned
name|int
name|af
decl_stmt|,
name|hal
decl_stmt|,
name|ho
index|[
literal|16
index|]
decl_stmt|,
name|pal
decl_stmt|,
name|po
index|[
literal|2
index|]
decl_stmt|;
name|char
modifier|*
name|a
decl_stmt|,
modifier|*
name|p
decl_stmt|;
name|char
name|cmd
index|[
literal|5
index|]
decl_stmt|,
modifier|*
name|param
decl_stmt|;
name|struct
name|sockaddr_in
modifier|*
name|sin
decl_stmt|;
name|struct
name|sockaddr_in6
modifier|*
name|sin6
decl_stmt|;
name|enum
name|state
name|nstate
decl_stmt|;
name|char
name|ch
decl_stmt|;
comment|/* OOB data handling */
name|error
operator|=
name|ioctl
argument_list|(
name|src
argument_list|,
name|SIOCATMARK
argument_list|,
operator|&
name|atmark
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
operator|-
literal|1
operator|&&
name|atmark
operator|==
literal|1
condition|)
block|{
name|n
operator|=
name|read
argument_list|(
name|src
argument_list|,
name|rbuf
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
operator|-
literal|1
condition|)
goto|goto
name|bad
goto|;
name|send
argument_list|(
name|dst
argument_list|,
name|rbuf
argument_list|,
name|n
argument_list|,
name|MSG_OOB
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|n = read(src, rbuf, sizeof(rbuf)); 		if (n == -1) 			goto bad; 		write(dst, rbuf, n); 		return n;
endif|#
directive|endif
block|}
name|n
operator|=
name|read
argument_list|(
name|src
argument_list|,
name|rbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|rbuf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|<=
literal|0
condition|)
return|return
name|n
return|;
name|rbuf
index|[
name|n
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|n
operator|<
literal|4
condition|)
block|{
name|write
argument_list|(
name|dst
argument_list|,
name|rbuf
argument_list|,
name|n
argument_list|)
expr_stmt|;
return|return
name|n
return|;
block|}
comment|/* 	 * parse argument 	 */
block|{
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
name|q
decl_stmt|;
name|int
name|i
decl_stmt|;
name|p
operator|=
name|rbuf
expr_stmt|;
name|q
operator|=
name|cmd
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|isalpha
argument_list|(
operator|*
name|p
argument_list|)
condition|)
block|{
comment|/* invalid command */
name|write
argument_list|(
name|dst
argument_list|,
name|rbuf
argument_list|,
name|n
argument_list|)
expr_stmt|;
return|return
name|n
return|;
block|}
operator|*
name|q
operator|++
operator|=
name|islower
argument_list|(
operator|*
name|p
argument_list|)
condition|?
name|toupper
argument_list|(
operator|*
name|p
argument_list|)
else|:
operator|*
name|p
expr_stmt|;
name|p
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|isspace
argument_list|(
operator|*
name|p
argument_list|)
condition|)
block|{
comment|/* invalid command */
name|write
argument_list|(
name|dst
argument_list|,
name|rbuf
argument_list|,
name|n
argument_list|)
expr_stmt|;
return|return
name|n
return|;
block|}
operator|*
name|q
operator|=
literal|'\0'
expr_stmt|;
name|param
operator|=
name|p
expr_stmt|;
comment|/* param points to first non-command token, if any */
while|while
condition|(
operator|*
name|param
operator|&&
name|isspace
argument_list|(
operator|*
name|param
argument_list|)
condition|)
name|param
operator|++
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|param
condition|)
name|param
operator|=
name|NULL
expr_stmt|;
block|}
operator|*
name|state
operator|=
name|NONE
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|cmd
argument_list|,
literal|"LPRT"
argument_list|)
operator|==
literal|0
operator|&&
name|param
condition|)
block|{
comment|/* 		 * LPRT -> PORT 		 */
name|nstate
operator|=
name|LPRT
expr_stmt|;
name|close
argument_list|(
name|wport4
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|wport6
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|port4
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|port6
argument_list|)
expr_stmt|;
name|wport4
operator|=
name|wport6
operator|=
name|port4
operator|=
name|port6
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|epsvall
condition|)
block|{
name|n
operator|=
name|snprintf
argument_list|(
name|sbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|sbuf
argument_list|)
argument_list|,
literal|"501 %s disallowed in EPSV ALL\r\n"
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|src
argument_list|,
name|sbuf
argument_list|,
name|n
argument_list|)
expr_stmt|;
return|return
name|n
return|;
block|}
name|n
operator|=
name|sscanf
argument_list|(
name|param
argument_list|,
literal|"%u,%u,%u,%u,%u,%u,%u,%u,%u,%u,%u,%u,%u,%u,%u,%u,%u,%u,%u,%u,%u"
argument_list|,
operator|&
name|af
argument_list|,
operator|&
name|hal
argument_list|,
operator|&
name|ho
index|[
literal|0
index|]
argument_list|,
operator|&
name|ho
index|[
literal|1
index|]
argument_list|,
operator|&
name|ho
index|[
literal|2
index|]
argument_list|,
operator|&
name|ho
index|[
literal|3
index|]
argument_list|,
operator|&
name|ho
index|[
literal|4
index|]
argument_list|,
operator|&
name|ho
index|[
literal|5
index|]
argument_list|,
operator|&
name|ho
index|[
literal|6
index|]
argument_list|,
operator|&
name|ho
index|[
literal|7
index|]
argument_list|,
operator|&
name|ho
index|[
literal|8
index|]
argument_list|,
operator|&
name|ho
index|[
literal|9
index|]
argument_list|,
operator|&
name|ho
index|[
literal|10
index|]
argument_list|,
operator|&
name|ho
index|[
literal|11
index|]
argument_list|,
operator|&
name|ho
index|[
literal|12
index|]
argument_list|,
operator|&
name|ho
index|[
literal|13
index|]
argument_list|,
operator|&
name|ho
index|[
literal|14
index|]
argument_list|,
operator|&
name|ho
index|[
literal|15
index|]
argument_list|,
operator|&
name|pal
argument_list|,
operator|&
name|po
index|[
literal|0
index|]
argument_list|,
operator|&
name|po
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|!=
literal|21
operator|||
name|af
operator|!=
literal|6
operator|||
name|hal
operator|!=
literal|16
operator|||
name|pal
operator|!=
literal|2
condition|)
block|{
name|n
operator|=
name|snprintf
argument_list|(
name|sbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|sbuf
argument_list|)
argument_list|,
literal|"501 illegal parameter to LPRT\r\n"
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|src
argument_list|,
name|sbuf
argument_list|,
name|n
argument_list|)
expr_stmt|;
return|return
name|n
return|;
block|}
comment|/* keep LPRT parameter */
name|memset
argument_list|(
operator|&
name|data6
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|data6
argument_list|)
argument_list|)
expr_stmt|;
name|sin6
operator|=
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
operator|&
name|data6
expr_stmt|;
name|sin6
operator|->
name|sin6_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|sin6
argument_list|)
expr_stmt|;
name|sin6
operator|->
name|sin6_family
operator|=
name|AF_INET6
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
literal|16
condition|;
name|n
operator|++
control|)
name|sin6
operator|->
name|sin6_addr
operator|.
name|s6_addr
index|[
name|n
index|]
operator|=
name|ho
index|[
name|n
index|]
expr_stmt|;
name|sin6
operator|->
name|sin6_port
operator|=
name|htons
argument_list|(
operator|(
operator|(
name|po
index|[
literal|0
index|]
operator|&
literal|0xff
operator|)
operator|<<
literal|8
operator|)
operator||
operator|(
name|po
index|[
literal|1
index|]
operator|&
literal|0xff
operator|)
argument_list|)
expr_stmt|;
name|sendport
label|:
comment|/* get ready for active data connection */
name|n
operator|=
sizeof|sizeof
argument_list|(
name|data4
argument_list|)
expr_stmt|;
name|error
operator|=
name|getsockname
argument_list|(
name|dst
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|data4
argument_list|,
operator|&
name|n
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
operator|-
literal|1
condition|)
block|{
name|lprtfail
label|:
name|n
operator|=
name|snprintf
argument_list|(
name|sbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|sbuf
argument_list|)
argument_list|,
literal|"500 could not translate to PORT\r\n"
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|src
argument_list|,
name|sbuf
argument_list|,
name|n
argument_list|)
expr_stmt|;
return|return
name|n
return|;
block|}
if|if
condition|(
operator|(
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|data4
operator|)
operator|->
name|sa_family
operator|!=
name|AF_INET
condition|)
goto|goto
name|lprtfail
goto|;
name|sin
operator|=
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
operator|&
name|data4
expr_stmt|;
name|sin
operator|->
name|sin_port
operator|=
literal|0
expr_stmt|;
name|wport4
operator|=
name|socket
argument_list|(
name|sin
operator|->
name|sin_family
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|wport4
operator|==
operator|-
literal|1
condition|)
goto|goto
name|lprtfail
goto|;
name|error
operator|=
name|bind
argument_list|(
name|wport4
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
name|sin
argument_list|,
name|sin
operator|->
name|sin_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
operator|-
literal|1
condition|)
block|{
name|close
argument_list|(
name|wport4
argument_list|)
expr_stmt|;
name|wport4
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|lprtfail
goto|;
block|}
name|error
operator|=
name|listen
argument_list|(
name|wport4
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
operator|-
literal|1
condition|)
block|{
name|close
argument_list|(
name|wport4
argument_list|)
expr_stmt|;
name|wport4
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|lprtfail
goto|;
block|}
comment|/* transmit PORT */
name|n
operator|=
sizeof|sizeof
argument_list|(
name|data4
argument_list|)
expr_stmt|;
name|error
operator|=
name|getsockname
argument_list|(
name|wport4
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|data4
argument_list|,
operator|&
name|n
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
operator|-
literal|1
condition|)
block|{
name|close
argument_list|(
name|wport4
argument_list|)
expr_stmt|;
name|wport4
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|lprtfail
goto|;
block|}
if|if
condition|(
operator|(
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|data4
operator|)
operator|->
name|sa_family
operator|!=
name|AF_INET
condition|)
block|{
name|close
argument_list|(
name|wport4
argument_list|)
expr_stmt|;
name|wport4
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|lprtfail
goto|;
block|}
name|sin
operator|=
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
operator|&
name|data4
expr_stmt|;
name|a
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
name|sin
operator|->
name|sin_addr
expr_stmt|;
name|p
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
name|sin
operator|->
name|sin_port
expr_stmt|;
name|n
operator|=
name|snprintf
argument_list|(
name|sbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|sbuf
argument_list|)
argument_list|,
literal|"PORT %d,%d,%d,%d,%d,%d\r\n"
argument_list|,
name|UC
argument_list|(
name|a
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|UC
argument_list|(
name|a
index|[
literal|1
index|]
argument_list|)
argument_list|,
name|UC
argument_list|(
name|a
index|[
literal|2
index|]
argument_list|)
argument_list|,
name|UC
argument_list|(
name|a
index|[
literal|3
index|]
argument_list|)
argument_list|,
name|UC
argument_list|(
name|p
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|UC
argument_list|(
name|p
index|[
literal|1
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|dst
argument_list|,
name|sbuf
argument_list|,
name|n
argument_list|)
expr_stmt|;
operator|*
name|state
operator|=
name|nstate
expr_stmt|;
name|passivemode
operator|=
literal|0
expr_stmt|;
return|return
name|n
return|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|cmd
argument_list|,
literal|"EPRT"
argument_list|)
operator|==
literal|0
operator|&&
name|param
condition|)
block|{
comment|/* 		 * EPRT -> PORT 		 */
name|char
modifier|*
name|afp
decl_stmt|,
modifier|*
name|hostp
decl_stmt|,
modifier|*
name|portp
decl_stmt|;
name|struct
name|addrinfo
name|hints
decl_stmt|,
modifier|*
name|res
decl_stmt|;
name|nstate
operator|=
name|EPRT
expr_stmt|;
name|close
argument_list|(
name|wport4
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|wport6
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|port4
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|port6
argument_list|)
expr_stmt|;
name|wport4
operator|=
name|wport6
operator|=
name|port4
operator|=
name|port6
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|epsvall
condition|)
block|{
name|n
operator|=
name|snprintf
argument_list|(
name|sbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|sbuf
argument_list|)
argument_list|,
literal|"501 %s disallowed in EPSV ALL\r\n"
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|src
argument_list|,
name|sbuf
argument_list|,
name|n
argument_list|)
expr_stmt|;
return|return
name|n
return|;
block|}
name|p
operator|=
name|param
expr_stmt|;
name|ch
operator|=
operator|*
name|p
operator|++
expr_stmt|;
comment|/* boundary character */
name|afp
operator|=
name|p
expr_stmt|;
while|while
condition|(
operator|*
name|p
operator|&&
operator|*
name|p
operator|!=
name|ch
condition|)
name|p
operator|++
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|p
condition|)
block|{
name|eprtparamfail
label|:
name|n
operator|=
name|snprintf
argument_list|(
name|sbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|sbuf
argument_list|)
argument_list|,
literal|"501 illegal parameter to EPRT\r\n"
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|src
argument_list|,
name|sbuf
argument_list|,
name|n
argument_list|)
expr_stmt|;
return|return
name|n
return|;
block|}
operator|*
name|p
operator|++
operator|=
literal|'\0'
expr_stmt|;
name|hostp
operator|=
name|p
expr_stmt|;
while|while
condition|(
operator|*
name|p
operator|&&
operator|*
name|p
operator|!=
name|ch
condition|)
name|p
operator|++
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|p
condition|)
goto|goto
name|eprtparamfail
goto|;
operator|*
name|p
operator|++
operator|=
literal|'\0'
expr_stmt|;
name|portp
operator|=
name|p
expr_stmt|;
while|while
condition|(
operator|*
name|p
operator|&&
operator|*
name|p
operator|!=
name|ch
condition|)
name|p
operator|++
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|p
condition|)
goto|goto
name|eprtparamfail
goto|;
operator|*
name|p
operator|++
operator|=
literal|'\0'
expr_stmt|;
name|n
operator|=
name|sscanf
argument_list|(
name|afp
argument_list|,
literal|"%d"
argument_list|,
operator|&
name|af
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|!=
literal|1
operator|||
name|af
operator|!=
literal|2
condition|)
block|{
name|n
operator|=
name|snprintf
argument_list|(
name|sbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|sbuf
argument_list|)
argument_list|,
literal|"501 unsupported address family to EPRT\r\n"
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|src
argument_list|,
name|sbuf
argument_list|,
name|n
argument_list|)
expr_stmt|;
return|return
name|n
return|;
block|}
name|memset
argument_list|(
operator|&
name|hints
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|hints
argument_list|)
argument_list|)
expr_stmt|;
name|hints
operator|.
name|ai_family
operator|=
name|AF_UNSPEC
expr_stmt|;
name|hints
operator|.
name|ai_socktype
operator|=
name|SOCK_STREAM
expr_stmt|;
name|error
operator|=
name|getaddrinfo
argument_list|(
name|hostp
argument_list|,
name|portp
argument_list|,
operator|&
name|hints
argument_list|,
operator|&
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|n
operator|=
name|snprintf
argument_list|(
name|sbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|sbuf
argument_list|)
argument_list|,
literal|"501 EPRT: %s\r\n"
argument_list|,
name|gai_strerror
argument_list|(
name|error
argument_list|)
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|src
argument_list|,
name|sbuf
argument_list|,
name|n
argument_list|)
expr_stmt|;
return|return
name|n
return|;
block|}
if|if
condition|(
name|res
operator|->
name|ai_next
condition|)
block|{
name|n
operator|=
name|snprintf
argument_list|(
name|sbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|sbuf
argument_list|)
argument_list|,
literal|"501 EPRT: %s resolved to multiple addresses\r\n"
argument_list|,
name|hostp
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|src
argument_list|,
name|sbuf
argument_list|,
name|n
argument_list|)
expr_stmt|;
return|return
name|n
return|;
block|}
name|memcpy
argument_list|(
operator|&
name|data6
argument_list|,
name|res
operator|->
name|ai_addr
argument_list|,
name|res
operator|->
name|ai_addrlen
argument_list|)
expr_stmt|;
goto|goto
name|sendport
goto|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|cmd
argument_list|,
literal|"LPSV"
argument_list|)
operator|==
literal|0
operator|&&
operator|!
name|param
condition|)
block|{
comment|/* 		 * LPSV -> PASV 		 */
name|nstate
operator|=
name|LPSV
expr_stmt|;
name|close
argument_list|(
name|wport4
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|wport6
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|port4
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|port6
argument_list|)
expr_stmt|;
name|wport4
operator|=
name|wport6
operator|=
name|port4
operator|=
name|port6
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|epsvall
condition|)
block|{
name|n
operator|=
name|snprintf
argument_list|(
name|sbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|sbuf
argument_list|)
argument_list|,
literal|"501 %s disallowed in EPSV ALL\r\n"
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|src
argument_list|,
name|sbuf
argument_list|,
name|n
argument_list|)
expr_stmt|;
return|return
name|n
return|;
block|}
comment|/* transmit PASV */
name|n
operator|=
name|snprintf
argument_list|(
name|sbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|sbuf
argument_list|)
argument_list|,
literal|"PASV\r\n"
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|dst
argument_list|,
name|sbuf
argument_list|,
name|n
argument_list|)
expr_stmt|;
operator|*
name|state
operator|=
name|LPSV
expr_stmt|;
name|passivemode
operator|=
literal|0
expr_stmt|;
comment|/* to be set to 1 later */
return|return
name|n
return|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|cmd
argument_list|,
literal|"EPSV"
argument_list|)
operator|==
literal|0
operator|&&
operator|!
name|param
condition|)
block|{
comment|/* 		 * EPSV -> PASV 		 */
name|close
argument_list|(
name|wport4
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|wport6
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|port4
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|port6
argument_list|)
expr_stmt|;
name|wport4
operator|=
name|wport6
operator|=
name|port4
operator|=
name|port6
operator|=
operator|-
literal|1
expr_stmt|;
name|n
operator|=
name|snprintf
argument_list|(
name|sbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|sbuf
argument_list|)
argument_list|,
literal|"PASV\r\n"
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|dst
argument_list|,
name|sbuf
argument_list|,
name|n
argument_list|)
expr_stmt|;
operator|*
name|state
operator|=
name|EPSV
expr_stmt|;
name|passivemode
operator|=
literal|0
expr_stmt|;
comment|/* to be set to 1 later */
return|return
name|n
return|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|cmd
argument_list|,
literal|"EPSV"
argument_list|)
operator|==
literal|0
operator|&&
name|param
operator|&&
name|strncasecmp
argument_list|(
name|param
argument_list|,
literal|"ALL"
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
operator|&&
name|isspace
argument_list|(
name|param
index|[
literal|3
index|]
argument_list|)
condition|)
block|{
comment|/* 		 * EPSV ALL 		 */
name|epsvall
operator|=
literal|1
expr_stmt|;
name|n
operator|=
name|snprintf
argument_list|(
name|sbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|sbuf
argument_list|)
argument_list|,
literal|"200 EPSV ALL command successful.\r\n"
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|src
argument_list|,
name|sbuf
argument_list|,
name|n
argument_list|)
expr_stmt|;
return|return
name|n
return|;
ifdef|#
directive|ifdef
name|FAITH4
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|cmd
argument_list|,
literal|"PORT"
argument_list|)
operator|==
literal|0
operator|&&
name|param
condition|)
block|{
comment|/* 		 * PORT -> EPRT 		 */
name|char
name|host
index|[
name|NI_MAXHOST
index|]
decl_stmt|,
name|serv
index|[
name|NI_MAXSERV
index|]
decl_stmt|;
name|nstate
operator|=
name|PORT
expr_stmt|;
name|close
argument_list|(
name|wport4
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|wport6
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|port4
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|port6
argument_list|)
expr_stmt|;
name|wport4
operator|=
name|wport6
operator|=
name|port4
operator|=
name|port6
operator|=
operator|-
literal|1
expr_stmt|;
name|p
operator|=
name|param
expr_stmt|;
name|n
operator|=
name|sscanf
argument_list|(
name|p
argument_list|,
literal|"%u,%u,%u,%u,%u,%u"
argument_list|,
operator|&
name|ho
index|[
literal|0
index|]
argument_list|,
operator|&
name|ho
index|[
literal|1
index|]
argument_list|,
operator|&
name|ho
index|[
literal|2
index|]
argument_list|,
operator|&
name|ho
index|[
literal|3
index|]
argument_list|,
operator|&
name|po
index|[
literal|0
index|]
argument_list|,
operator|&
name|po
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|!=
literal|6
condition|)
block|{
name|n
operator|=
name|snprintf
argument_list|(
name|sbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|sbuf
argument_list|)
argument_list|,
literal|"501 illegal parameter to PORT\r\n"
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|src
argument_list|,
name|sbuf
argument_list|,
name|n
argument_list|)
expr_stmt|;
return|return
name|n
return|;
block|}
name|memset
argument_list|(
operator|&
name|data6
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|data6
argument_list|)
argument_list|)
expr_stmt|;
name|sin
operator|=
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
operator|&
name|data6
expr_stmt|;
name|sin
operator|->
name|sin_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|sin
argument_list|)
expr_stmt|;
name|sin
operator|->
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|sin
operator|->
name|sin_addr
operator|.
name|s_addr
operator|=
name|htonl
argument_list|(
operator|(
operator|(
name|ho
index|[
literal|0
index|]
operator|&
literal|0xff
operator|)
operator|<<
literal|24
operator|)
operator||
operator|(
operator|(
name|ho
index|[
literal|1
index|]
operator|&
literal|0xff
operator|)
operator|<<
literal|16
operator|)
operator||
operator|(
operator|(
name|ho
index|[
literal|2
index|]
operator|&
literal|0xff
operator|)
operator|<<
literal|8
operator|)
operator||
operator|(
name|ho
index|[
literal|3
index|]
operator|&
literal|0xff
operator|)
argument_list|)
expr_stmt|;
name|sin
operator|->
name|sin_port
operator|=
name|htons
argument_list|(
operator|(
operator|(
name|po
index|[
literal|0
index|]
operator|&
literal|0xff
operator|)
operator|<<
literal|8
operator|)
operator||
operator|(
name|po
index|[
literal|1
index|]
operator|&
literal|0xff
operator|)
argument_list|)
expr_stmt|;
comment|/* get ready for active data connection */
name|n
operator|=
sizeof|sizeof
argument_list|(
name|data4
argument_list|)
expr_stmt|;
name|error
operator|=
name|getsockname
argument_list|(
name|dst
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|data4
argument_list|,
operator|&
name|n
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
operator|-
literal|1
condition|)
block|{
name|portfail
label|:
name|n
operator|=
name|snprintf
argument_list|(
name|sbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|sbuf
argument_list|)
argument_list|,
literal|"500 could not translate to EPRT\r\n"
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|src
argument_list|,
name|sbuf
argument_list|,
name|n
argument_list|)
expr_stmt|;
return|return
name|n
return|;
block|}
if|if
condition|(
operator|(
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|data4
operator|)
operator|->
name|sa_family
operator|!=
name|AF_INET6
condition|)
goto|goto
name|portfail
goto|;
operator|(
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
operator|&
name|data4
operator|)
operator|->
name|sin6_port
operator|=
literal|0
expr_stmt|;
name|sa
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|data4
expr_stmt|;
name|wport4
operator|=
name|socket
argument_list|(
name|sa
operator|->
name|sa_family
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|wport4
operator|==
operator|-
literal|1
condition|)
goto|goto
name|portfail
goto|;
name|error
operator|=
name|bind
argument_list|(
name|wport4
argument_list|,
name|sa
argument_list|,
name|sa
operator|->
name|sa_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
operator|-
literal|1
condition|)
block|{
name|close
argument_list|(
name|wport4
argument_list|)
expr_stmt|;
name|wport4
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|portfail
goto|;
block|}
name|error
operator|=
name|listen
argument_list|(
name|wport4
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
operator|-
literal|1
condition|)
block|{
name|close
argument_list|(
name|wport4
argument_list|)
expr_stmt|;
name|wport4
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|portfail
goto|;
block|}
comment|/* transmit EPRT */
name|n
operator|=
sizeof|sizeof
argument_list|(
name|data4
argument_list|)
expr_stmt|;
name|error
operator|=
name|getsockname
argument_list|(
name|wport4
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|data4
argument_list|,
operator|&
name|n
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
operator|-
literal|1
condition|)
block|{
name|close
argument_list|(
name|wport4
argument_list|)
expr_stmt|;
name|wport4
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|portfail
goto|;
block|}
name|af
operator|=
literal|2
expr_stmt|;
name|sa
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|data4
expr_stmt|;
if|if
condition|(
name|getnameinfo
argument_list|(
name|sa
argument_list|,
name|sa
operator|->
name|sa_len
argument_list|,
name|host
argument_list|,
sizeof|sizeof
argument_list|(
name|host
argument_list|)
argument_list|,
name|serv
argument_list|,
sizeof|sizeof
argument_list|(
name|serv
argument_list|)
argument_list|,
name|NI_NUMERICHOST
operator||
name|NI_NUMERICSERV
argument_list|)
condition|)
block|{
name|close
argument_list|(
name|wport4
argument_list|)
expr_stmt|;
name|wport4
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|portfail
goto|;
block|}
name|n
operator|=
name|snprintf
argument_list|(
name|sbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|sbuf
argument_list|)
argument_list|,
literal|"EPRT |%d|%s|%s|\r\n"
argument_list|,
name|af
argument_list|,
name|host
argument_list|,
name|serv
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|dst
argument_list|,
name|sbuf
argument_list|,
name|n
argument_list|)
expr_stmt|;
operator|*
name|state
operator|=
name|nstate
expr_stmt|;
name|passivemode
operator|=
literal|0
expr_stmt|;
return|return
name|n
return|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|cmd
argument_list|,
literal|"PASV"
argument_list|)
operator|==
literal|0
operator|&&
operator|!
name|param
condition|)
block|{
comment|/* 		 * PASV -> EPSV 		 */
name|nstate
operator|=
name|PASV
expr_stmt|;
name|close
argument_list|(
name|wport4
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|wport6
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|port4
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|port6
argument_list|)
expr_stmt|;
name|wport4
operator|=
name|wport6
operator|=
name|port4
operator|=
name|port6
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* transmit EPSV */
name|n
operator|=
name|snprintf
argument_list|(
name|sbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|sbuf
argument_list|)
argument_list|,
literal|"EPSV\r\n"
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|dst
argument_list|,
name|sbuf
argument_list|,
name|n
argument_list|)
expr_stmt|;
operator|*
name|state
operator|=
name|PASV
expr_stmt|;
name|passivemode
operator|=
literal|0
expr_stmt|;
comment|/* to be set to 1 later */
return|return
name|n
return|;
else|#
directive|else
comment|/* FAITH4 */
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|cmd
argument_list|,
literal|"PORT"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|cmd
argument_list|,
literal|"PASV"
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* 		 * reject PORT/PASV 		 */
name|n
operator|=
name|snprintf
argument_list|(
name|sbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|sbuf
argument_list|)
argument_list|,
literal|"502 %s not implemented.\r\n"
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|src
argument_list|,
name|sbuf
argument_list|,
name|n
argument_list|)
expr_stmt|;
return|return
name|n
return|;
endif|#
directive|endif
comment|/* FAITH4 */
block|}
elseif|else
if|if
condition|(
name|passivemode
operator|&&
operator|(
name|strcmp
argument_list|(
name|cmd
argument_list|,
literal|"STOR"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|cmd
argument_list|,
literal|"STOU"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|cmd
argument_list|,
literal|"RETR"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|cmd
argument_list|,
literal|"LIST"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|cmd
argument_list|,
literal|"NLST"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|cmd
argument_list|,
literal|"APPE"
argument_list|)
operator|==
literal|0
operator|)
condition|)
block|{
comment|/* 		 * commands with data transfer.  need to care about passive 		 * mode data connection. 		 */
if|if
condition|(
name|ftp_passiveconn
argument_list|()
operator|<
literal|0
condition|)
block|{
name|n
operator|=
name|snprintf
argument_list|(
name|sbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|sbuf
argument_list|)
argument_list|,
literal|"425 Cannot open data connetion\r\n"
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|src
argument_list|,
name|sbuf
argument_list|,
name|n
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* simply relay the command */
name|write
argument_list|(
name|dst
argument_list|,
name|rbuf
argument_list|,
name|n
argument_list|)
expr_stmt|;
block|}
operator|*
name|state
operator|=
name|NONE
expr_stmt|;
return|return
name|n
return|;
block|}
else|else
block|{
comment|/* simply relay it */
operator|*
name|state
operator|=
name|NONE
expr_stmt|;
name|write
argument_list|(
name|dst
argument_list|,
name|rbuf
argument_list|,
name|n
argument_list|)
expr_stmt|;
return|return
name|n
return|;
block|}
name|bad
label|:
name|exit_failure
argument_list|(
name|ERRSTR
argument_list|)
expr_stmt|;
comment|/*NOTREACHED*/
return|return
literal|0
return|;
comment|/* to make gcc happy */
block|}
end_function

end_unit


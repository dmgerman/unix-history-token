begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2008 Yahoo!, Inc.  * All rights reserved.  * Written by: John Baldwin<jhb@FreeBSD.org>  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. Neither the name of the author nor the names of any co-contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__RCSID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/errno.h>
end_include

begin_include
include|#
directive|include
file|<err.h>
end_include

begin_include
include|#
directive|include
file|<libutil.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|"mpsutil.h"
end_include

begin_function_decl
specifier|static
name|char
modifier|*
name|get_device_speed
parameter_list|(
name|uint8_t
name|rate
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|char
modifier|*
name|get_device_type
parameter_list|(
name|uint32_t
name|di
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|show_all
parameter_list|(
name|int
name|ac
parameter_list|,
name|char
modifier|*
modifier|*
name|av
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|show_devices
parameter_list|(
name|int
name|ac
parameter_list|,
name|char
modifier|*
modifier|*
name|av
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|show_enclosures
parameter_list|(
name|int
name|ac
parameter_list|,
name|char
modifier|*
modifier|*
name|av
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|show_expanders
parameter_list|(
name|int
name|ac
parameter_list|,
name|char
modifier|*
modifier|*
name|av
parameter_list|)
function_decl|;
end_function_decl

begin_expr_stmt
name|MPS_TABLE
argument_list|(
name|top
argument_list|,
name|show
argument_list|)
expr_stmt|;
end_expr_stmt

begin_define
define|#
directive|define
name|STANDALONE_STATE
value|"ONLINE"
end_define

begin_function
specifier|static
name|int
name|show_adapter
parameter_list|(
name|int
name|ac
parameter_list|,
name|char
modifier|*
modifier|*
name|av
parameter_list|)
block|{
name|MPI2_CONFIG_PAGE_SASIOUNIT_0
modifier|*
name|sas0
decl_stmt|;
name|MPI2_CONFIG_PAGE_SASIOUNIT_1
modifier|*
name|sas1
decl_stmt|;
name|MPI2_SAS_IO_UNIT0_PHY_DATA
modifier|*
name|phy0
decl_stmt|;
name|MPI2_SAS_IO_UNIT1_PHY_DATA
modifier|*
name|phy1
decl_stmt|;
name|MPI2_CONFIG_PAGE_MAN_0
modifier|*
name|man0
decl_stmt|;
name|MPI2_CONFIG_PAGE_BIOS_3
modifier|*
name|bios3
decl_stmt|;
name|MPI2_IOC_FACTS_REPLY
modifier|*
name|facts
decl_stmt|;
name|U16
name|IOCStatus
decl_stmt|;
name|char
modifier|*
name|speed
decl_stmt|,
modifier|*
name|minspeed
decl_stmt|,
modifier|*
name|maxspeed
decl_stmt|,
modifier|*
name|isdisabled
decl_stmt|,
modifier|*
name|type
decl_stmt|;
name|char
name|devhandle
index|[
literal|5
index|]
decl_stmt|,
name|ctrlhandle
index|[
literal|5
index|]
decl_stmt|;
name|int
name|error
decl_stmt|,
name|fd
decl_stmt|,
name|v
decl_stmt|,
name|i
decl_stmt|;
if|if
condition|(
name|ac
operator|!=
literal|1
condition|)
block|{
name|warnx
argument_list|(
literal|"show adapter: extra arguments"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
name|fd
operator|=
name|mps_open
argument_list|(
name|mps_unit
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|<
literal|0
condition|)
block|{
name|error
operator|=
name|errno
expr_stmt|;
name|warn
argument_list|(
literal|"mps_open"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|man0
operator|=
name|mps_read_man_page
argument_list|(
name|fd
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|man0
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|errno
expr_stmt|;
name|warn
argument_list|(
literal|"Failed to get controller info"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
if|if
condition|(
name|man0
operator|->
name|Header
operator|.
name|PageLength
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|man0
argument_list|)
operator|/
literal|4
condition|)
block|{
name|warnx
argument_list|(
literal|"Invalid controller info"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
name|printf
argument_list|(
literal|"mps%d Adapter:\n"
argument_list|,
name|mps_unit
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"       Board Name: %.16s\n"
argument_list|,
name|man0
operator|->
name|BoardName
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"   Board Assembly: %.16s\n"
argument_list|,
name|man0
operator|->
name|BoardAssembly
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"        Chip Name: %.16s\n"
argument_list|,
name|man0
operator|->
name|ChipName
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    Chip Revision: %.16s\n"
argument_list|,
name|man0
operator|->
name|ChipRevision
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|man0
argument_list|)
expr_stmt|;
name|bios3
operator|=
name|mps_read_config_page
argument_list|(
name|fd
argument_list|,
name|MPI2_CONFIG_PAGETYPE_BIOS
argument_list|,
literal|3
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|bios3
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|errno
expr_stmt|;
name|warn
argument_list|(
literal|"Failed to get BIOS page 3 info"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|v
operator|=
name|bios3
operator|->
name|BiosVersion
expr_stmt|;
name|printf
argument_list|(
literal|"    BIOS Revision: %d.%02d.%02d.%02d\n"
argument_list|,
operator|(
operator|(
name|v
operator|&
literal|0xff000000
operator|)
operator|>>
literal|24
operator|)
argument_list|,
operator|(
operator|(
name|v
operator|&
literal|0xff0000
operator|)
operator|>>
literal|16
operator|)
argument_list|,
operator|(
operator|(
name|v
operator|&
literal|0xff00
operator|)
operator|>>
literal|8
operator|)
argument_list|,
operator|(
name|v
operator|&
literal|0xff
operator|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|bios3
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|facts
operator|=
name|mps_get_iocfacts
argument_list|(
name|fd
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"could not get controller IOCFacts\n"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
operator|(
name|errno
operator|)
return|;
block|}
name|v
operator|=
name|facts
operator|->
name|FWVersion
operator|.
name|Word
expr_stmt|;
name|printf
argument_list|(
literal|"Firmware Revision: %d.%02d.%02d.%02d\n"
argument_list|,
operator|(
operator|(
name|v
operator|&
literal|0xff000000
operator|)
operator|>>
literal|24
operator|)
argument_list|,
operator|(
operator|(
name|v
operator|&
literal|0xff0000
operator|)
operator|>>
literal|16
operator|)
argument_list|,
operator|(
operator|(
name|v
operator|&
literal|0xff00
operator|)
operator|>>
literal|8
operator|)
argument_list|,
operator|(
name|v
operator|&
literal|0xff
operator|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  Integrated RAID: %s\n"
argument_list|,
operator|(
name|facts
operator|->
name|IOCCapabilities
operator|&
name|MPI2_IOCFACTS_CAPABILITY_INTEGRATED_RAID
operator|)
condition|?
literal|"yes"
else|:
literal|"no"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|facts
argument_list|)
expr_stmt|;
name|fd
operator|=
name|mps_open
argument_list|(
name|mps_unit
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|<
literal|0
condition|)
block|{
name|error
operator|=
name|errno
expr_stmt|;
name|warn
argument_list|(
literal|"mps_open"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|sas0
operator|=
name|mps_read_extended_config_page
argument_list|(
name|fd
argument_list|,
name|MPI2_CONFIG_EXTPAGETYPE_SAS_IO_UNIT
argument_list|,
name|MPI2_SASIOUNITPAGE0_PAGEVERSION
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|IOCStatus
argument_list|)
expr_stmt|;
if|if
condition|(
name|sas0
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|errno
expr_stmt|;
name|warn
argument_list|(
literal|"Error retrieving SAS IO Unit page %d"
argument_list|,
name|IOCStatus
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|sas1
operator|=
name|mps_read_extended_config_page
argument_list|(
name|fd
argument_list|,
name|MPI2_CONFIG_EXTPAGETYPE_SAS_IO_UNIT
argument_list|,
name|MPI2_SASIOUNITPAGE1_PAGEVERSION
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
operator|&
name|IOCStatus
argument_list|)
expr_stmt|;
if|if
condition|(
name|sas0
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|errno
expr_stmt|;
name|warn
argument_list|(
literal|"Error retrieving SAS IO Unit page %d"
argument_list|,
name|IOCStatus
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"PhyNum  CtlrHandle  DevHandle  Disabled  Speed   Min    Max      Device\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sas0
operator|->
name|NumPhys
condition|;
name|i
operator|++
control|)
block|{
name|phy0
operator|=
operator|&
name|sas0
operator|->
name|PhyData
index|[
name|i
index|]
expr_stmt|;
name|phy1
operator|=
operator|&
name|sas1
operator|->
name|PhyData
index|[
name|i
index|]
expr_stmt|;
name|printf
argument_list|(
literal|"  %d  "
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy0
operator|->
name|PortFlags
operator|&
name|MPI2_SASIOUNIT0_PORTFLAGS_DISCOVERY_IN_PROGRESS
condition|)
block|{
name|printf
argument_list|(
literal|"Discovery still in progress\n"
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|phy0
operator|->
name|PhyFlags
operator|&
name|MPI2_SASIOUNIT0_PHYFLAGS_PHY_DISABLED
condition|)
name|isdisabled
operator|=
literal|"Y"
expr_stmt|;
else|else
name|isdisabled
operator|=
literal|"N"
expr_stmt|;
name|minspeed
operator|=
name|get_device_speed
argument_list|(
name|phy1
operator|->
name|MaxMinLinkRate
argument_list|)
expr_stmt|;
name|maxspeed
operator|=
name|get_device_speed
argument_list|(
name|phy1
operator|->
name|MaxMinLinkRate
operator|>>
literal|4
argument_list|)
expr_stmt|;
name|type
operator|=
name|get_device_type
argument_list|(
name|phy0
operator|->
name|ControllerPhyDeviceInfo
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy0
operator|->
name|AttachedDevHandle
operator|!=
literal|0
condition|)
block|{
name|snprintf
argument_list|(
name|devhandle
argument_list|,
literal|5
argument_list|,
literal|"%04x"
argument_list|,
name|phy0
operator|->
name|AttachedDevHandle
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|ctrlhandle
argument_list|,
literal|5
argument_list|,
literal|"%04x"
argument_list|,
name|phy0
operator|->
name|ControllerDevHandle
argument_list|)
expr_stmt|;
name|speed
operator|=
name|get_device_speed
argument_list|(
name|phy0
operator|->
name|NegotiatedLinkRate
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|snprintf
argument_list|(
name|devhandle
argument_list|,
literal|5
argument_list|,
literal|"    "
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|ctrlhandle
argument_list|,
literal|5
argument_list|,
literal|"    "
argument_list|)
expr_stmt|;
name|speed
operator|=
literal|"     "
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"      %s       %s        %s      %s  %s  %s  %s\n"
argument_list|,
name|ctrlhandle
argument_list|,
name|devhandle
argument_list|,
name|isdisabled
argument_list|,
name|speed
argument_list|,
name|minspeed
argument_list|,
name|maxspeed
argument_list|,
name|type
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|sas0
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|sas1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_macro
name|MPS_COMMAND
argument_list|(
argument|show
argument_list|,
argument|adapter
argument_list|,
argument|show_adapter
argument_list|,
literal|""
argument_list|,
literal|"display controller information"
argument_list|)
end_macro

begin_function
specifier|static
name|int
name|show_iocfacts
parameter_list|(
name|int
name|ac
parameter_list|,
name|char
modifier|*
modifier|*
name|av
parameter_list|)
block|{
name|MPI2_IOC_FACTS_REPLY
modifier|*
name|facts
decl_stmt|;
name|int
name|error
decl_stmt|,
name|fd
decl_stmt|;
name|fd
operator|=
name|mps_open
argument_list|(
name|mps_unit
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|<
literal|0
condition|)
block|{
name|error
operator|=
name|errno
expr_stmt|;
name|warn
argument_list|(
literal|"mps_open"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|facts
operator|=
name|mps_get_iocfacts
argument_list|(
name|fd
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"could not get controller IOCFacts\n"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
operator|(
name|errno
operator|)
return|;
block|}
name|printf
argument_list|(
literal|"       MaxChainDepth: %d\n"
argument_list|,
name|facts
operator|->
name|MaxChainDepth
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"             WhoInit: 0x%x\n"
argument_list|,
name|facts
operator|->
name|WhoInit
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"       NumberOfPorts: %d\n"
argument_list|,
name|facts
operator|->
name|NumberOfPorts
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"      MaxMSIxVectors: %d\n"
argument_list|,
name|facts
operator|->
name|MaxMSIxVectors
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"       RequestCredit: %d\n"
argument_list|,
name|facts
operator|->
name|RequestCredit
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"           ProductID: 0x%x\n"
argument_list|,
name|facts
operator|->
name|ProductID
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"     IOCCapabilities: 0x%x\n"
argument_list|,
name|facts
operator|->
name|IOCCapabilities
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"           FWVersion: 0x%08x\n"
argument_list|,
name|facts
operator|->
name|FWVersion
operator|.
name|Word
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" IOCRequestFrameSize: %d\n"
argument_list|,
name|facts
operator|->
name|IOCRequestFrameSize
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"       MaxInitiators: %d\n"
argument_list|,
name|facts
operator|->
name|MaxInitiators
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"          MaxTargets: %d\n"
argument_list|,
name|facts
operator|->
name|MaxTargets
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"     MaxSasExpanders: %d\n"
argument_list|,
name|facts
operator|->
name|MaxSasExpanders
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"       MaxEnclosures: %d\n"
argument_list|,
name|facts
operator|->
name|MaxEnclosures
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"       ProtocolFlags: 0x%x\n"
argument_list|,
name|facts
operator|->
name|ProtocolFlags
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  HighPriorityCredit: %d\n"
argument_list|,
name|facts
operator|->
name|HighPriorityCredit
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"MaxRepDescPostQDepth: %d\n"
argument_list|,
name|facts
operator|->
name|MaxReplyDescriptorPostQueueDepth
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"      ReplyFrameSize: %d\n"
argument_list|,
name|facts
operator|->
name|ReplyFrameSize
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"          MaxVolumes: %d\n"
argument_list|,
name|facts
operator|->
name|MaxVolumes
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"        MaxDevHandle: %d\n"
argument_list|,
name|facts
operator|->
name|MaxDevHandle
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"MaxPersistentEntries: %d\n"
argument_list|,
name|facts
operator|->
name|MaxPersistentEntries
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"        MinDevHandle: %d\n"
argument_list|,
name|facts
operator|->
name|MinDevHandle
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|facts
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_expr_stmt
name|MPS_COMMAND
argument_list|(
name|show
argument_list|,
name|iocfacts
argument_list|,
name|show_iocfacts
argument_list|,
literal|""
argument_list|,
literal|"Show IOC Facts Message"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|int
name|show_adapters
parameter_list|(
name|int
name|ac
parameter_list|,
name|char
modifier|*
modifier|*
name|av
parameter_list|)
block|{
name|MPI2_CONFIG_PAGE_MAN_0
modifier|*
name|man0
decl_stmt|;
name|MPI2_IOC_FACTS_REPLY
modifier|*
name|facts
decl_stmt|;
name|int
name|unit
decl_stmt|,
name|fd
decl_stmt|,
name|error
decl_stmt|;
name|printf
argument_list|(
literal|"Device Name\t      Chip Name        Board Name        Firmware\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|unit
operator|=
literal|0
init|;
name|unit
operator|<
name|MPS_MAX_UNIT
condition|;
name|unit
operator|++
control|)
block|{
name|fd
operator|=
name|mps_open
argument_list|(
name|unit
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|<
literal|0
condition|)
continue|continue;
name|facts
operator|=
name|mps_get_iocfacts
argument_list|(
name|fd
argument_list|)
expr_stmt|;
if|if
condition|(
name|facts
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|errno
expr_stmt|;
name|warn
argument_list|(
literal|"Faled to get controller iocfacts"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|man0
operator|=
name|mps_read_man_page
argument_list|(
name|fd
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|man0
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|errno
expr_stmt|;
name|warn
argument_list|(
literal|"Failed to get controller info"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
if|if
condition|(
name|man0
operator|->
name|Header
operator|.
name|PageLength
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|man0
argument_list|)
operator|/
literal|4
condition|)
block|{
name|warnx
argument_list|(
literal|"Invalid controller info"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|man0
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
name|printf
argument_list|(
literal|"/dev/mp%s%d\t%16s %16s        %08x\n"
argument_list|,
name|is_mps
condition|?
literal|"s"
else|:
literal|"r"
argument_list|,
name|unit
argument_list|,
name|man0
operator|->
name|ChipName
argument_list|,
name|man0
operator|->
name|BoardName
argument_list|,
name|facts
operator|->
name|FWVersion
operator|.
name|Word
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|man0
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|facts
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_expr_stmt
name|MPS_COMMAND
argument_list|(
name|show
argument_list|,
name|adapters
argument_list|,
name|show_adapters
argument_list|,
literal|""
argument_list|,
literal|"Show a summary of all adapters"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|char
modifier|*
name|get_device_type
parameter_list|(
name|uint32_t
name|di
parameter_list|)
block|{
if|if
condition|(
name|di
operator|&
literal|0x4000
condition|)
return|return
operator|(
literal|"SEP Target    "
operator|)
return|;
if|if
condition|(
name|di
operator|&
literal|0x2000
condition|)
return|return
operator|(
literal|"ATAPI Target  "
operator|)
return|;
if|if
condition|(
name|di
operator|&
literal|0x400
condition|)
return|return
operator|(
literal|"SAS Target    "
operator|)
return|;
if|if
condition|(
name|di
operator|&
literal|0x200
condition|)
return|return
operator|(
literal|"STP Target    "
operator|)
return|;
if|if
condition|(
name|di
operator|&
literal|0x100
condition|)
return|return
operator|(
literal|"SMP Target    "
operator|)
return|;
if|if
condition|(
name|di
operator|&
literal|0x80
condition|)
return|return
operator|(
literal|"SATA Target   "
operator|)
return|;
if|if
condition|(
name|di
operator|&
literal|0x70
condition|)
return|return
operator|(
literal|"SAS Initiator "
operator|)
return|;
if|if
condition|(
name|di
operator|&
literal|0x8
condition|)
return|return
operator|(
literal|"SATA Initiator"
operator|)
return|;
if|if
condition|(
operator|(
name|di
operator|&
literal|0x7
operator|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|"No Device     "
operator|)
return|;
return|return
operator|(
literal|"Unknown Device"
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|get_enc_type
parameter_list|(
name|uint32_t
name|flags
parameter_list|,
name|int
modifier|*
name|issep
parameter_list|)
block|{
name|char
modifier|*
name|type
decl_stmt|;
operator|*
name|issep
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|flags
operator|&
literal|0xf
condition|)
block|{
case|case
literal|0x01
case|:
name|type
operator|=
literal|"Direct Attached SES-2"
expr_stmt|;
operator|*
name|issep
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|0x02
case|:
name|type
operator|=
literal|"Direct Attached SGPIO"
expr_stmt|;
break|break;
case|case
literal|0x03
case|:
name|type
operator|=
literal|"Expander SGPIO"
expr_stmt|;
break|break;
case|case
literal|0x04
case|:
name|type
operator|=
literal|"External SES-2"
expr_stmt|;
operator|*
name|issep
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|0x05
case|:
name|type
operator|=
literal|"Direct Attached GPIO"
expr_stmt|;
break|break;
case|case
literal|0x0
case|:
default|default:
return|return
operator|(
literal|"Unknown"
operator|)
return|;
block|}
return|return
operator|(
name|type
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|char
modifier|*
name|mps_device_speed
index|[]
init|=
block|{
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
literal|"1.5"
block|,
literal|"3.0"
block|,
literal|"6.0"
block|,
literal|"12 "
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|char
modifier|*
name|get_device_speed
parameter_list|(
name|uint8_t
name|rate
parameter_list|)
block|{
name|char
modifier|*
name|speed
decl_stmt|;
name|rate
operator|&=
literal|0xf
expr_stmt|;
if|if
condition|(
name|rate
operator|>=
sizeof|sizeof
argument_list|(
name|mps_device_speed
argument_list|)
condition|)
return|return
operator|(
literal|"Unk"
operator|)
return|;
if|if
condition|(
operator|(
name|speed
operator|=
name|mps_device_speed
index|[
name|rate
index|]
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
literal|"???"
operator|)
return|;
return|return
operator|(
name|speed
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|char
modifier|*
name|mps_page_name
index|[]
init|=
block|{
literal|"IO Unit"
block|,
literal|"IOC"
block|,
literal|"BIOS"
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
literal|"RAID Volume"
block|,
literal|"Manufacturing"
block|,
literal|"RAID Physical Disk"
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
literal|"SAS IO Unit"
block|,
literal|"SAS Expander"
block|,
literal|"SAS Device"
block|,
literal|"SAS PHY"
block|,
literal|"Log"
block|,
literal|"Enclosure"
block|,
literal|"RAID Configuration"
block|,
literal|"Driver Persistent Mapping"
block|,
literal|"SAS Port"
block|,
literal|"Ethernet Port"
block|,
literal|"Extended Manufacturing"
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|char
modifier|*
name|get_page_name
parameter_list|(
name|u_int
name|page
parameter_list|)
block|{
name|char
modifier|*
name|name
decl_stmt|;
if|if
condition|(
name|page
operator|>=
sizeof|sizeof
argument_list|(
name|mps_page_name
argument_list|)
condition|)
return|return
operator|(
literal|"Unknown"
operator|)
return|;
if|if
condition|(
operator|(
name|name
operator|=
name|mps_page_name
index|[
name|page
index|]
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
literal|"Unknown"
operator|)
return|;
return|return
operator|(
name|name
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|show_all
parameter_list|(
name|int
name|ac
parameter_list|,
name|char
modifier|*
modifier|*
name|av
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
name|printf
argument_list|(
literal|"Adapter:\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|show_adapter
argument_list|(
name|ac
argument_list|,
name|av
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Devices:\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|show_devices
argument_list|(
name|ac
argument_list|,
name|av
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Enclosures:\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|show_enclosures
argument_list|(
name|ac
argument_list|,
name|av
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Expanders:\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|show_expanders
argument_list|(
name|ac
argument_list|,
name|av
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_expr_stmt
name|MPS_COMMAND
argument_list|(
name|show
argument_list|,
name|all
argument_list|,
name|show_all
argument_list|,
literal|""
argument_list|,
literal|"Show all devices"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|int
name|show_devices
parameter_list|(
name|int
name|ac
parameter_list|,
name|char
modifier|*
modifier|*
name|av
parameter_list|)
block|{
name|MPI2_CONFIG_PAGE_SASIOUNIT_0
modifier|*
name|sas0
decl_stmt|;
name|MPI2_SAS_IO_UNIT0_PHY_DATA
modifier|*
name|phydata
decl_stmt|;
name|MPI2_CONFIG_PAGE_SAS_DEV_0
modifier|*
name|device
decl_stmt|;
name|MPI2_CONFIG_PAGE_EXPANDER_1
modifier|*
name|exp1
decl_stmt|;
name|uint16_t
name|IOCStatus
decl_stmt|,
name|handle
decl_stmt|,
name|bus
decl_stmt|,
name|target
decl_stmt|;
name|char
modifier|*
name|type
decl_stmt|,
modifier|*
name|speed
decl_stmt|,
name|enchandle
index|[
literal|5
index|]
decl_stmt|,
name|slot
index|[
literal|3
index|]
decl_stmt|,
name|bt
index|[
literal|7
index|]
decl_stmt|;
name|int
name|fd
decl_stmt|,
name|error
decl_stmt|,
name|nphys
decl_stmt|;
name|fd
operator|=
name|mps_open
argument_list|(
name|mps_unit
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|<
literal|0
condition|)
block|{
name|error
operator|=
name|errno
expr_stmt|;
name|warn
argument_list|(
literal|"mps_open"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|sas0
operator|=
name|mps_read_extended_config_page
argument_list|(
name|fd
argument_list|,
name|MPI2_CONFIG_EXTPAGETYPE_SAS_IO_UNIT
argument_list|,
name|MPI2_SASIOUNITPAGE0_PAGEVERSION
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|IOCStatus
argument_list|)
expr_stmt|;
if|if
condition|(
name|sas0
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|errno
expr_stmt|;
name|warn
argument_list|(
literal|"Error retrieving SAS IO Unit page %d"
argument_list|,
name|IOCStatus
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|nphys
operator|=
name|sas0
operator|->
name|NumPhys
expr_stmt|;
name|printf
argument_list|(
literal|"B____T    SAS Address     Handle  Parent    Device       Speed Enc  Slot  Wdt\n"
argument_list|)
expr_stmt|;
name|handle
operator|=
literal|0xffff
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|device
operator|=
name|mps_read_extended_config_page
argument_list|(
name|fd
argument_list|,
name|MPI2_CONFIG_EXTPAGETYPE_SAS_DEVICE
argument_list|,
name|MPI2_SASDEVICE0_PAGEVERSION
argument_list|,
literal|0
argument_list|,
name|MPI2_SAS_DEVICE_PGAD_FORM_GET_NEXT_HANDLE
operator||
name|handle
argument_list|,
operator|&
name|IOCStatus
argument_list|)
expr_stmt|;
if|if
condition|(
name|device
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|IOCStatus
operator|==
name|MPI2_IOCSTATUS_CONFIG_INVALID_PAGE
condition|)
break|break;
name|error
operator|=
name|errno
expr_stmt|;
name|warn
argument_list|(
literal|"Error retrieving device page"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|handle
operator|=
name|device
operator|->
name|DevHandle
expr_stmt|;
if|if
condition|(
name|device
operator|->
name|ParentDevHandle
operator|==
literal|0x0
condition|)
block|{
name|free
argument_list|(
name|device
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|bus
operator|=
literal|0xffff
expr_stmt|;
name|target
operator|=
literal|0xffff
expr_stmt|;
name|error
operator|=
name|mps_map_btdh
argument_list|(
name|fd
argument_list|,
operator|&
name|handle
argument_list|,
operator|&
name|bus
argument_list|,
operator|&
name|target
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|free
argument_list|(
name|device
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|(
name|bus
operator|==
literal|0xffff
operator|)
operator|||
operator|(
name|target
operator|==
literal|0xffff
operator|)
condition|)
name|snprintf
argument_list|(
name|bt
argument_list|,
literal|7
argument_list|,
literal|"      "
argument_list|)
expr_stmt|;
else|else
name|snprintf
argument_list|(
name|bt
argument_list|,
literal|7
argument_list|,
literal|"%02d  %02d"
argument_list|,
name|bus
argument_list|,
name|target
argument_list|)
expr_stmt|;
name|type
operator|=
name|get_device_type
argument_list|(
name|device
operator|->
name|DeviceInfo
argument_list|)
expr_stmt|;
if|if
condition|(
name|device
operator|->
name|PhyNum
operator|<
name|nphys
condition|)
block|{
name|phydata
operator|=
operator|&
name|sas0
operator|->
name|PhyData
index|[
name|device
operator|->
name|PhyNum
index|]
expr_stmt|;
name|speed
operator|=
name|get_device_speed
argument_list|(
name|phydata
operator|->
name|NegotiatedLinkRate
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|device
operator|->
name|ParentDevHandle
operator|>
literal|0
condition|)
block|{
name|exp1
operator|=
name|mps_read_extended_config_page
argument_list|(
name|fd
argument_list|,
name|MPI2_CONFIG_EXTPAGETYPE_SAS_EXPANDER
argument_list|,
name|MPI2_SASEXPANDER1_PAGEVERSION
argument_list|,
literal|1
argument_list|,
name|MPI2_SAS_EXPAND_PGAD_FORM_HNDL_PHY_NUM
operator||
operator|(
name|device
operator|->
name|PhyNum
operator|<<
name|MPI2_SAS_EXPAND_PGAD_PHYNUM_SHIFT
operator|)
operator||
name|device
operator|->
name|ParentDevHandle
argument_list|,
operator|&
name|IOCStatus
argument_list|)
expr_stmt|;
if|if
condition|(
name|exp1
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|IOCStatus
operator|!=
name|MPI2_IOCSTATUS_CONFIG_INVALID_PAGE
condition|)
block|{
name|error
operator|=
name|errno
expr_stmt|;
name|warn
argument_list|(
literal|"Error retrieving expander page 1: 0x%x"
argument_list|,
name|IOCStatus
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|speed
operator|=
literal|" "
expr_stmt|;
block|}
else|else
block|{
name|speed
operator|=
name|get_device_speed
argument_list|(
name|exp1
operator|->
name|NegotiatedLinkRate
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|exp1
argument_list|)
expr_stmt|;
block|}
block|}
else|else
name|speed
operator|=
literal|" "
expr_stmt|;
if|if
condition|(
name|device
operator|->
name|EnclosureHandle
operator|!=
literal|0
condition|)
block|{
name|snprintf
argument_list|(
name|enchandle
argument_list|,
literal|5
argument_list|,
literal|"%04x"
argument_list|,
name|device
operator|->
name|EnclosureHandle
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|slot
argument_list|,
literal|3
argument_list|,
literal|"%02d"
argument_list|,
name|device
operator|->
name|Slot
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|snprintf
argument_list|(
name|enchandle
argument_list|,
literal|5
argument_list|,
literal|"    "
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|slot
argument_list|,
literal|3
argument_list|,
literal|"  "
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"%s    %08x%08x   %04x    %04x   %s  %s  %s  %s    %d\n"
argument_list|,
name|bt
argument_list|,
name|device
operator|->
name|SASAddress
operator|.
name|High
argument_list|,
name|device
operator|->
name|SASAddress
operator|.
name|Low
argument_list|,
name|device
operator|->
name|DevHandle
argument_list|,
name|device
operator|->
name|ParentDevHandle
argument_list|,
name|type
argument_list|,
name|speed
argument_list|,
name|enchandle
argument_list|,
name|slot
argument_list|,
name|device
operator|->
name|MaxPortConnections
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|device
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|sas0
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_expr_stmt
name|MPS_COMMAND
argument_list|(
name|show
argument_list|,
name|devices
argument_list|,
name|show_devices
argument_list|,
literal|""
argument_list|,
literal|"Show attached devices"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|int
name|show_enclosures
parameter_list|(
name|int
name|ac
parameter_list|,
name|char
modifier|*
modifier|*
name|av
parameter_list|)
block|{
name|MPI2_CONFIG_PAGE_SAS_ENCLOSURE_0
modifier|*
name|enc
decl_stmt|;
name|char
modifier|*
name|type
decl_stmt|,
name|sepstr
index|[
literal|5
index|]
decl_stmt|;
name|uint16_t
name|IOCStatus
decl_stmt|,
name|handle
decl_stmt|;
name|int
name|fd
decl_stmt|,
name|error
decl_stmt|,
name|issep
decl_stmt|;
name|fd
operator|=
name|mps_open
argument_list|(
name|mps_unit
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|<
literal|0
condition|)
block|{
name|error
operator|=
name|errno
expr_stmt|;
name|warn
argument_list|(
literal|"mps_open"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|printf
argument_list|(
literal|"Slots      Logical ID     SEPHandle  EncHandle    Type\n"
argument_list|)
expr_stmt|;
name|handle
operator|=
literal|0xffff
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|enc
operator|=
name|mps_read_extended_config_page
argument_list|(
name|fd
argument_list|,
name|MPI2_CONFIG_EXTPAGETYPE_ENCLOSURE
argument_list|,
name|MPI2_SASENCLOSURE0_PAGEVERSION
argument_list|,
literal|0
argument_list|,
name|MPI2_SAS_ENCLOS_PGAD_FORM_GET_NEXT_HANDLE
operator||
name|handle
argument_list|,
operator|&
name|IOCStatus
argument_list|)
expr_stmt|;
if|if
condition|(
name|enc
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|IOCStatus
operator|==
name|MPI2_IOCSTATUS_CONFIG_INVALID_PAGE
condition|)
break|break;
name|error
operator|=
name|errno
expr_stmt|;
name|warn
argument_list|(
literal|"Error retrieving enclosure page"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|type
operator|=
name|get_enc_type
argument_list|(
name|enc
operator|->
name|Flags
argument_list|,
operator|&
name|issep
argument_list|)
expr_stmt|;
if|if
condition|(
name|issep
operator|==
literal|0
condition|)
name|snprintf
argument_list|(
name|sepstr
argument_list|,
literal|5
argument_list|,
literal|"    "
argument_list|)
expr_stmt|;
else|else
name|snprintf
argument_list|(
name|sepstr
argument_list|,
literal|5
argument_list|,
literal|"%04x"
argument_list|,
name|enc
operator|->
name|SEPDevHandle
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  %.2d    %08x%08x    %s       %04x     %s\n"
argument_list|,
name|enc
operator|->
name|NumSlots
argument_list|,
name|enc
operator|->
name|EnclosureLogicalID
operator|.
name|High
argument_list|,
name|enc
operator|->
name|EnclosureLogicalID
operator|.
name|Low
argument_list|,
name|sepstr
argument_list|,
name|enc
operator|->
name|EnclosureHandle
argument_list|,
name|type
argument_list|)
expr_stmt|;
name|handle
operator|=
name|enc
operator|->
name|EnclosureHandle
expr_stmt|;
name|free
argument_list|(
name|enc
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_expr_stmt
name|MPS_COMMAND
argument_list|(
name|show
argument_list|,
name|enclosures
argument_list|,
name|show_enclosures
argument_list|,
literal|""
argument_list|,
literal|"Show attached enclosures"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|int
name|show_expanders
parameter_list|(
name|int
name|ac
parameter_list|,
name|char
modifier|*
modifier|*
name|av
parameter_list|)
block|{
name|MPI2_CONFIG_PAGE_EXPANDER_0
modifier|*
name|exp0
decl_stmt|;
name|MPI2_CONFIG_PAGE_EXPANDER_1
modifier|*
name|exp1
decl_stmt|;
name|uint16_t
name|IOCStatus
decl_stmt|,
name|handle
decl_stmt|;
name|char
name|enchandle
index|[
literal|5
index|]
decl_stmt|,
name|parent
index|[
literal|5
index|]
decl_stmt|,
name|rphy
index|[
literal|3
index|]
decl_stmt|,
name|rhandle
index|[
literal|5
index|]
decl_stmt|;
name|char
modifier|*
name|speed
decl_stmt|,
modifier|*
name|min
decl_stmt|,
modifier|*
name|max
decl_stmt|,
modifier|*
name|type
decl_stmt|;
name|int
name|fd
decl_stmt|,
name|error
decl_stmt|,
name|nphys
decl_stmt|,
name|i
decl_stmt|;
name|fd
operator|=
name|mps_open
argument_list|(
name|mps_unit
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|<
literal|0
condition|)
block|{
name|error
operator|=
name|errno
expr_stmt|;
name|warn
argument_list|(
literal|"mps_open"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|printf
argument_list|(
literal|"NumPhys   SAS Address     DevHandle   Parent  EncHandle  SAS Level\n"
argument_list|)
expr_stmt|;
name|handle
operator|=
literal|0xffff
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|exp0
operator|=
name|mps_read_extended_config_page
argument_list|(
name|fd
argument_list|,
name|MPI2_CONFIG_EXTPAGETYPE_SAS_EXPANDER
argument_list|,
name|MPI2_SASEXPANDER0_PAGEVERSION
argument_list|,
literal|0
argument_list|,
name|MPI2_SAS_EXPAND_PGAD_FORM_GET_NEXT_HNDL
operator||
name|handle
argument_list|,
operator|&
name|IOCStatus
argument_list|)
expr_stmt|;
if|if
condition|(
name|exp0
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|IOCStatus
operator|==
name|MPI2_IOCSTATUS_CONFIG_INVALID_PAGE
condition|)
break|break;
name|error
operator|=
name|errno
expr_stmt|;
name|warn
argument_list|(
literal|"Error retrieving expander page 0"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|nphys
operator|=
name|exp0
operator|->
name|NumPhys
expr_stmt|;
name|handle
operator|=
name|exp0
operator|->
name|DevHandle
expr_stmt|;
if|if
condition|(
name|exp0
operator|->
name|EnclosureHandle
operator|==
literal|0x00
condition|)
name|snprintf
argument_list|(
name|enchandle
argument_list|,
literal|5
argument_list|,
literal|"    "
argument_list|)
expr_stmt|;
else|else
name|snprintf
argument_list|(
name|enchandle
argument_list|,
literal|5
argument_list|,
literal|"%04d"
argument_list|,
name|exp0
operator|->
name|EnclosureHandle
argument_list|)
expr_stmt|;
if|if
condition|(
name|exp0
operator|->
name|ParentDevHandle
operator|==
literal|0x0
condition|)
name|snprintf
argument_list|(
name|parent
argument_list|,
literal|5
argument_list|,
literal|"    "
argument_list|)
expr_stmt|;
else|else
name|snprintf
argument_list|(
name|parent
argument_list|,
literal|5
argument_list|,
literal|"%04x"
argument_list|,
name|exp0
operator|->
name|ParentDevHandle
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  %02d    %08x%08x    %04x       %s     %s       %d\n"
argument_list|,
name|exp0
operator|->
name|NumPhys
argument_list|,
name|exp0
operator|->
name|SASAddress
operator|.
name|High
argument_list|,
name|exp0
operator|->
name|SASAddress
operator|.
name|Low
argument_list|,
name|exp0
operator|->
name|DevHandle
argument_list|,
name|parent
argument_list|,
name|enchandle
argument_list|,
name|exp0
operator|->
name|SASLevel
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"     Phy  RemotePhy  DevHandle  Speed   Min    Max    Device\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nphys
condition|;
name|i
operator|++
control|)
block|{
name|exp1
operator|=
name|mps_read_extended_config_page
argument_list|(
name|fd
argument_list|,
name|MPI2_CONFIG_EXTPAGETYPE_SAS_EXPANDER
argument_list|,
name|MPI2_SASEXPANDER1_PAGEVERSION
argument_list|,
literal|1
argument_list|,
name|MPI2_SAS_EXPAND_PGAD_FORM_HNDL_PHY_NUM
operator||
operator|(
name|i
operator|<<
name|MPI2_SAS_EXPAND_PGAD_PHYNUM_SHIFT
operator|)
operator||
name|exp0
operator|->
name|DevHandle
argument_list|,
operator|&
name|IOCStatus
argument_list|)
expr_stmt|;
if|if
condition|(
name|exp1
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|IOCStatus
operator|!=
name|MPI2_IOCSTATUS_CONFIG_INVALID_PAGE
condition|)
name|warn
argument_list|(
literal|"Error retrieving expander pg 1"
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|type
operator|=
name|get_device_type
argument_list|(
name|exp1
operator|->
name|AttachedDeviceInfo
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|exp1
operator|->
name|AttachedDeviceInfo
operator|&
literal|0x7
operator|)
operator|==
literal|0
condition|)
block|{
name|speed
operator|=
literal|"     "
expr_stmt|;
name|snprintf
argument_list|(
name|rphy
argument_list|,
literal|3
argument_list|,
literal|"  "
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|rhandle
argument_list|,
literal|5
argument_list|,
literal|"     "
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|speed
operator|=
name|get_device_speed
argument_list|(
name|exp1
operator|->
name|NegotiatedLinkRate
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|rphy
argument_list|,
literal|3
argument_list|,
literal|"%02d"
argument_list|,
name|exp1
operator|->
name|AttachedPhyIdentifier
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|rhandle
argument_list|,
literal|5
argument_list|,
literal|"%04x"
argument_list|,
name|exp1
operator|->
name|AttachedDevHandle
argument_list|)
expr_stmt|;
block|}
name|min
operator|=
name|get_device_speed
argument_list|(
name|exp1
operator|->
name|HwLinkRate
argument_list|)
expr_stmt|;
name|max
operator|=
name|get_device_speed
argument_list|(
name|exp1
operator|->
name|HwLinkRate
operator|>>
literal|4
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"     %02d     %s         %s     %s  %s  %s  %s\n"
argument_list|,
name|exp1
operator|->
name|Phy
argument_list|,
name|rphy
argument_list|,
name|rhandle
argument_list|,
name|speed
argument_list|,
name|min
argument_list|,
name|max
argument_list|,
name|type
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|exp1
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|exp0
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_expr_stmt
name|MPS_COMMAND
argument_list|(
name|show
argument_list|,
name|expanders
argument_list|,
name|show_expanders
argument_list|,
literal|""
argument_list|,
literal|"Show attached expanders"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|int
name|show_cfgpage
parameter_list|(
name|int
name|ac
parameter_list|,
name|char
modifier|*
modifier|*
name|av
parameter_list|)
block|{
name|MPI2_CONFIG_PAGE_HEADER
modifier|*
name|hdr
decl_stmt|;
name|MPI2_CONFIG_EXTENDED_PAGE_HEADER
modifier|*
name|ehdr
decl_stmt|;
name|void
modifier|*
name|data
decl_stmt|;
name|uint32_t
name|addr
decl_stmt|;
name|uint16_t
name|IOCStatus
decl_stmt|;
name|uint8_t
name|page
decl_stmt|,
name|num
decl_stmt|;
name|int
name|fd
decl_stmt|,
name|error
decl_stmt|,
name|len
decl_stmt|,
name|attrs
decl_stmt|;
name|char
modifier|*
name|pgname
decl_stmt|,
modifier|*
name|pgattr
decl_stmt|;
name|fd
operator|=
name|mps_open
argument_list|(
name|mps_unit
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|<
literal|0
condition|)
block|{
name|error
operator|=
name|errno
expr_stmt|;
name|warn
argument_list|(
literal|"mps_open"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|addr
operator|=
literal|0
expr_stmt|;
name|num
operator|=
literal|0
expr_stmt|;
name|page
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|ac
condition|)
block|{
case|case
literal|4
case|:
name|addr
operator|=
operator|(
name|uint32_t
operator|)
name|strtoul
argument_list|(
name|av
index|[
literal|3
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
case|case
literal|3
case|:
name|num
operator|=
operator|(
name|uint8_t
operator|)
name|strtoul
argument_list|(
name|av
index|[
literal|2
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
case|case
literal|2
case|:
name|page
operator|=
operator|(
name|uint8_t
operator|)
name|strtoul
argument_list|(
name|av
index|[
literal|1
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
default|default:
name|errno
operator|=
name|EINVAL
expr_stmt|;
name|warn
argument_list|(
literal|"cfgpage: not enough arguments"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
if|if
condition|(
name|page
operator|>=
literal|0x10
condition|)
name|data
operator|=
name|mps_read_extended_config_page
argument_list|(
name|fd
argument_list|,
name|page
argument_list|,
literal|0
argument_list|,
name|num
argument_list|,
name|addr
argument_list|,
operator|&
name|IOCStatus
argument_list|)
expr_stmt|;
else|else
name|data
operator|=
name|mps_read_config_page
argument_list|(
name|fd
argument_list|,
name|page
argument_list|,
name|num
argument_list|,
name|addr
argument_list|,
operator|&
name|IOCStatus
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|errno
expr_stmt|;
name|warn
argument_list|(
literal|"Error retrieving cfg page: %s\n"
argument_list|,
name|mps_ioc_status
argument_list|(
name|IOCStatus
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
if|if
condition|(
name|page
operator|>=
literal|0x10
condition|)
block|{
name|ehdr
operator|=
name|data
expr_stmt|;
name|len
operator|=
name|ehdr
operator|->
name|ExtPageLength
operator|*
literal|4
expr_stmt|;
name|page
operator|=
name|ehdr
operator|->
name|ExtPageType
expr_stmt|;
name|attrs
operator|=
name|ehdr
operator|->
name|PageType
operator|>>
literal|4
expr_stmt|;
block|}
else|else
block|{
name|hdr
operator|=
name|data
expr_stmt|;
name|len
operator|=
name|hdr
operator|->
name|PageLength
operator|*
literal|4
expr_stmt|;
name|page
operator|=
name|hdr
operator|->
name|PageType
operator|&
literal|0xf
expr_stmt|;
name|attrs
operator|=
name|hdr
operator|->
name|PageType
operator|>>
literal|4
expr_stmt|;
block|}
name|pgname
operator|=
name|get_page_name
argument_list|(
name|page
argument_list|)
expr_stmt|;
if|if
condition|(
name|attrs
operator|==
literal|0
condition|)
name|pgattr
operator|=
literal|"Read-only"
expr_stmt|;
elseif|else
if|if
condition|(
name|attrs
operator|==
literal|1
condition|)
name|pgattr
operator|=
literal|"Read-Write"
expr_stmt|;
elseif|else
if|if
condition|(
name|attrs
operator|==
literal|2
condition|)
name|pgattr
operator|=
literal|"Read-Write Persistent"
expr_stmt|;
else|else
name|pgattr
operator|=
literal|"Unknown Page Attribute"
expr_stmt|;
name|printf
argument_list|(
literal|"Page 0x%x: %s %d, %s\n"
argument_list|,
name|page
argument_list|,
name|pgname
argument_list|,
name|num
argument_list|,
name|pgattr
argument_list|)
expr_stmt|;
name|hexdump
argument_list|(
name|data
argument_list|,
name|len
argument_list|,
name|NULL
argument_list|,
name|HD_REVERSED
operator||
literal|4
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_expr_stmt
name|MPS_COMMAND
argument_list|(
name|show
argument_list|,
name|cfgpage
argument_list|,
name|show_cfgpage
argument_list|,
literal|"page [num] [addr]"
argument_list|,
literal|"Display config page"
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


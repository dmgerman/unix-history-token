begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/************************************************************************** ** **  $Id: ncrcontrol.c,v 1.13.2.1 1996/12/21 12:13:40 se Exp $ ** **  Utility for NCR 53C810 device driver. ** **  386bsd / FreeBSD / NetBSD ** **------------------------------------------------------------------------- ** **  Written for 386bsd and FreeBSD by **	wolf@dentaro.gun.de	Wolfgang Stanglmeier **	se@mi.Uni-Koeln.de	Stefan Esser ** **  Ported to NetBSD by **	mycroft@gnu.ai.mit.edu ** **------------------------------------------------------------------------- ** ** Copyright (c) 1994 Wolfgang Stanglmeier.  All rights reserved. ** ** Redistribution and use in source and binary forms, with or without ** modification, are permitted provided that the following conditions ** are met: ** 1. Redistributions of source code must retain the above copyright **    notice, this list of conditions and the following disclaimer. ** 2. Redistributions in binary form must reproduce the above copyright **    notice, this list of conditions and the following disclaimer in the **    documentation and/or other materials provided with the distribution. ** 3. The name of the author may not be used to endorse or promote products **    derived from this software without specific prior written permission. ** ** THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR ** IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES ** OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. ** IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT, ** INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT ** NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, ** DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY ** THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT ** (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF ** THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE. ** ** *************************************************************************** */
end_comment

begin_include
include|#
directive|include
file|<sys/file.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|__NetBSD__
end_ifdef

begin_include
include|#
directive|include
file|<sys/device.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<nlist.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<paths.h>
end_include

begin_include
include|#
directive|include
file|<limits.h>
end_include

begin_include
include|#
directive|include
file|<kvm.h>
end_include

begin_include
include|#
directive|include
file|<pci/ncr.c>
end_include

begin_comment
comment|/* **	used external functions */
end_comment

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__NetBSD__
argument_list|)
operator|||
operator|(
name|__FreeBSD__
operator|>=
literal|2
operator|)
end_if

begin_decl_stmt
name|kvm_t
modifier|*
name|kvm
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|KVM_NLIST
parameter_list|(
name|n
parameter_list|)
value|(kvm_nlist(kvm, (n))>= 0)
end_define

begin_define
define|#
directive|define
name|KVM_READ
parameter_list|(
name|o
parameter_list|,
name|p
parameter_list|,
name|l
parameter_list|)
value|(kvm_read(kvm, (o), (void*)(p), (l)) == (l))
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|KVM_NLIST
parameter_list|(
name|n
parameter_list|)
value|(kvm_nlist((n))>= 0)
end_define

begin_define
define|#
directive|define
name|KVM_READ
parameter_list|(
name|o
parameter_list|,
name|p
parameter_list|,
name|l
parameter_list|)
value|(kvm_read((void*)(o), (p), (l)) == (l))
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|extern
name|void
name|exit
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|char
modifier|*
name|strerror
parameter_list|(
name|int
name|num
parameter_list|)
function_decl|;
end_function_decl

begin_escape
end_escape

begin_comment
comment|/*=========================================================== ** **	Global variables. ** **=========================================================== */
end_comment

begin_decl_stmt
name|char
modifier|*
name|prog
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_long
name|verbose
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_long
name|wizard
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|nlist
name|nl
index|[]
init|=
block|{
define|#
directive|define
name|N_NCR_VERSION
value|0
block|{
literal|"_ncr_version"
block|}
block|,
ifdef|#
directive|ifdef
name|__NetBSD__
define|#
directive|define
name|N_NCRCD
value|1
block|{
literal|"_ncrcd"
block|}
block|,
else|#
directive|else
define|#
directive|define
name|N_NCRP
value|1
block|{
literal|"_ncrp"
block|}
block|,
define|#
directive|define
name|N_NNCR
value|2
block|{
literal|"_nncr"
block|}
block|,
endif|#
directive|endif
block|{
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|const
name|char
modifier|*
name|vmunix
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|kmemf
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|kvm_isopen
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_long
name|ncr_base
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_long
name|lcb_base
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_long
name|ccb_base
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_long
name|ncr_unit
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|__NetBSD__
end_ifdef

begin_decl_stmt
name|struct
name|cfdriver
name|ncrcd
decl_stmt|;
end_decl_stmt

begin_else
else|#
directive|else
end_else

begin_decl_stmt
name|u_long
name|ncr_units
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
name|struct
name|ncb
name|ncr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|lcb
name|lcb
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|ccb
name|ccb
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_long
name|target_mask
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_long
name|global_lun_mask
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_long
name|lun_mask
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_long
name|interval
decl_stmt|;
end_decl_stmt

begin_escape
end_escape

begin_comment
comment|/*=========================================================== ** **	Accessing kernel memory via kvm library. ** **=========================================================== */
end_comment

begin_macro
name|read_ccb
argument_list|(
argument|u_long base
argument_list|)
end_macro

begin_block
block|{
name|ccb_base
operator|=
name|base
expr_stmt|;
if|if
condition|(
operator|!
name|KVM_READ
argument_list|(
name|base
argument_list|,
operator|&
name|ccb
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ccb
argument_list|)
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: bad kvm read at %x.\n"
argument_list|,
name|prog
argument_list|,
name|base
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
block|}
end_block

begin_macro
name|read_lcb
argument_list|(
argument|u_long base
argument_list|)
end_macro

begin_block
block|{
name|lcb_base
operator|=
name|base
expr_stmt|;
if|if
condition|(
operator|!
name|KVM_READ
argument_list|(
name|base
argument_list|,
operator|&
name|lcb
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|lcb
argument_list|)
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: bad kvm read at %x.\n"
argument_list|,
name|prog
argument_list|,
name|base
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
block|}
end_block

begin_macro
name|read_ncr
argument_list|()
end_macro

begin_block
block|{
if|if
condition|(
operator|!
name|KVM_READ
argument_list|(
name|ncr_base
argument_list|,
operator|&
name|ncr
argument_list|,
sizeof|sizeof
argument_list|(
name|ncr
argument_list|)
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: bad kvm read at %x.\n"
argument_list|,
name|prog
argument_list|,
name|ncr_base
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
block|}
end_block

begin_escape
end_escape

begin_function
name|void
name|open_kvm
parameter_list|(
name|int
name|flags
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|u_long
name|kernel_version
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|__NetBSD__
argument_list|)
operator|||
operator|(
name|__FreeBSD__
operator|>=
literal|2
operator|)
name|char
name|errbuf
index|[
name|_POSIX2_LINE_MAX
index|]
decl_stmt|;
endif|#
directive|endif
if|if
condition|(
name|kvm_isopen
condition|)
return|return;
if|#
directive|if
name|defined
argument_list|(
name|__NetBSD__
argument_list|)
operator|||
operator|(
name|__FreeBSD__
operator|>=
literal|2
operator|)
comment|/* 	 * Discard setgid privileges if not the running kernel so that bad 	 * guys can't print interesting stuff from kernel memory. 	 */
if|if
condition|(
name|vmunix
operator|!=
name|NULL
operator|||
name|kmemf
operator|!=
name|NULL
condition|)
name|setgid
argument_list|(
name|getgid
argument_list|()
argument_list|)
expr_stmt|;
else|else
block|{
if|#
directive|if
operator|(
name|__FreeBSD__
operator|>=
literal|2
operator|)
name|vmunix
operator|=
name|getbootfile
argument_list|()
expr_stmt|;
else|#
directive|else
name|vmunix
operator|=
name|_PATH_UNIX
expr_stmt|;
endif|#
directive|endif
block|}
name|kvm
operator|=
name|kvm_openfiles
argument_list|(
name|vmunix
argument_list|,
name|kmemf
argument_list|,
name|NULL
argument_list|,
name|flags
argument_list|,
name|errbuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|kvm
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: kvm_openfiles: %s\n"
argument_list|,
name|prog
argument_list|,
name|errbuf
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
else|#
directive|else
if|if
condition|(
name|vmunix
operator|!=
name|NULL
condition|)
block|{
if|#
directive|if
operator|(
name|__FreeBSD__
operator|>=
literal|2
operator|)
name|vmunix
operator|=
name|getbootfile
argument_list|()
expr_stmt|;
else|#
directive|else
name|vmunix
operator|=
name|_PATH_UNIX
expr_stmt|;
endif|#
directive|endif
block|}
if|if
condition|(
name|kvm_openfiles
argument_list|(
name|vmunix
argument_list|,
name|kmemf
argument_list|,
name|NULL
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: kvm_openfiles: %s\n"
argument_list|,
name|prog
argument_list|,
name|kvm_geterr
argument_list|()
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
operator|!
name|KVM_NLIST
argument_list|(
name|nl
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: no symbols in \"%s\".\n"
argument_list|,
name|prog
argument_list|,
name|vmunix
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|nl
index|[
name|i
index|]
operator|.
name|n_name
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|nl
index|[
name|i
index|]
operator|.
name|n_type
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: no symbol \"%s\" in \"%s\".\n"
argument_list|,
name|prog
argument_list|,
name|nl
index|[
name|i
index|]
operator|.
name|n_name
argument_list|,
name|vmunix
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|KVM_READ
argument_list|(
name|nl
index|[
name|N_NCR_VERSION
index|]
operator|.
name|n_value
argument_list|,
operator|&
name|kernel_version
argument_list|,
sizeof|sizeof
argument_list|(
name|kernel_version
argument_list|)
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: bad kvm read.\n"
argument_list|,
name|prog
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
if|if
condition|(
name|kernel_version
operator|!=
name|ncr_version
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: incompatible with kernel. Rebuild!\n"
argument_list|,
name|prog
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
ifdef|#
directive|ifdef
name|__NetBSD__
if|if
condition|(
operator|!
name|KVM_READ
argument_list|(
name|nl
index|[
name|N_NCRCD
index|]
operator|.
name|n_value
argument_list|,
operator|&
name|ncrcd
argument_list|,
sizeof|sizeof
argument_list|(
name|ncrcd
argument_list|)
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: bad kvm read.\n"
argument_list|,
name|prog
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
if|if
condition|(
name|ncr_unit
operator|>=
name|ncrcd
operator|.
name|cd_ndevs
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: bad unit number (valid range: 0-%d).\n"
argument_list|,
name|prog
argument_list|,
name|ncrcd
operator|.
name|cd_ndevs
operator|-
literal|1
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
if|if
condition|(
operator|!
name|KVM_READ
argument_list|(
name|ncrcd
operator|.
name|cd_devs
operator|+
literal|4
operator|*
name|ncr_unit
argument_list|,
operator|&
name|ncr_base
argument_list|,
sizeof|sizeof
argument_list|(
name|ncr_base
argument_list|)
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: bad kvm read.\n"
argument_list|,
name|prog
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
if|if
condition|(
operator|!
name|ncr_base
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: control structure not allocated (not found in autoconfig?)\n"
argument_list|,
name|prog
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
else|#
directive|else
comment|/* !__NetBSD__ */
if|if
condition|(
operator|!
name|KVM_READ
argument_list|(
name|nl
index|[
name|N_NNCR
index|]
operator|.
name|n_value
argument_list|,
operator|&
name|ncr_units
argument_list|,
sizeof|sizeof
argument_list|(
name|ncr_units
argument_list|)
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: bad kvm read.\n"
argument_list|,
name|prog
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
if|if
condition|(
name|ncr_unit
operator|>=
name|ncr_units
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: bad unit number (valid range: 0-%d).\n"
argument_list|,
name|prog
argument_list|,
name|ncr_units
operator|-
literal|1
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
if|if
condition|(
operator|!
name|KVM_READ
argument_list|(
name|nl
index|[
name|N_NCRP
index|]
operator|.
name|n_value
operator|+
literal|4
operator|*
name|ncr_unit
argument_list|,
operator|&
name|ncr_base
argument_list|,
sizeof|sizeof
argument_list|(
name|ncr_base
argument_list|)
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: bad kvm read.\n"
argument_list|,
name|prog
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
if|if
condition|(
operator|!
name|ncr_base
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: control structure not allocated (not found in autoconfig?)\n"
argument_list|,
name|prog
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
endif|#
directive|endif
comment|/* !__NetBSD__ */
name|read_ncr
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|ncr
operator|.
name|vaddr
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: 53c810 not mapped (not found in autoconfig?)\n"
argument_list|,
name|prog
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
name|kvm_isopen
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_function
name|void
name|set_target_mask
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|t
decl_stmt|;
if|if
condition|(
name|target_mask
condition|)
return|return;
for|for
control|(
name|t
operator|=
literal|0
init|;
name|t
operator|<
name|MAX_TARGET
condition|;
name|t
operator|++
control|)
if|if
condition|(
name|ncr
operator|.
name|target
index|[
name|t
index|]
operator|.
name|jump_tcb
operator|.
name|l_cmd
condition|)
name|target_mask
operator||=
operator|(
literal|1
operator|<<
name|t
operator|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|set_lun_mask
parameter_list|(
name|struct
name|tcb
modifier|*
name|tp
parameter_list|)
block|{
name|int
name|l
decl_stmt|;
name|lun_mask
operator|=
name|global_lun_mask
expr_stmt|;
if|if
condition|(
name|lun_mask
condition|)
return|return;
for|for
control|(
name|l
operator|=
literal|0
init|;
name|l
operator|<
name|MAX_LUN
condition|;
name|l
operator|++
control|)
if|if
condition|(
name|tp
operator|->
name|lp
index|[
name|l
index|]
condition|)
name|lun_mask
operator||=
operator|(
literal|1
operator|<<
name|l
operator|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|printc
parameter_list|(
name|u_char
modifier|*
name|p
parameter_list|,
name|int
name|l
parameter_list|)
block|{
for|for
control|(
init|;
name|l
operator|>
literal|0
condition|;
name|l
operator|--
control|)
block|{
name|char
name|c
init|=
operator|*
name|p
operator|++
decl_stmt|;
name|printf
argument_list|(
literal|"%c"
argument_list|,
name|c
condition|?
name|c
else|:
literal|'_'
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/*================================================================ ** ** **	system info ** ** **================================================================ */
end_comment

begin_function
specifier|static
name|double
name|syncmhz
parameter_list|(
name|int
name|negoval
parameter_list|)
block|{
switch|switch
condition|(
name|negoval
condition|)
block|{
case|case
literal|0
case|:
return|return
literal|0.0
return|;
case|case
literal|10
case|:
return|return
literal|40.0
return|;
case|case
literal|11
case|:
return|return
literal|33.0
return|;
case|case
literal|12
case|:
return|return
literal|20.0
return|;
block|}
return|return
literal|250.0
operator|/
name|negoval
return|;
block|}
end_function

begin_function
name|void
name|do_info
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|t
decl_stmt|,
name|l
decl_stmt|,
name|i
decl_stmt|,
name|d
decl_stmt|,
name|f
decl_stmt|,
name|fl
decl_stmt|;
name|struct
name|tcb
modifier|*
name|tip
decl_stmt|;
name|open_kvm
argument_list|(
name|O_RDONLY
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
operator|>=
literal|3
condition|)
name|printf
argument_list|(
literal|"ncr unit=%d  data@%x  register@%x  (pci@%x)\n\n"
argument_list|,
name|ncr_unit
argument_list|,
name|ncr_base
argument_list|,
name|ncr
operator|.
name|vaddr
argument_list|,
name|ncr
operator|.
name|paddr
argument_list|)
expr_stmt|;
name|set_target_mask
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"T:L  Vendor   Device           Rev  Speed   Max Wide Tags\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|t
operator|=
literal|0
init|;
name|t
operator|<
name|MAX_TARGET
condition|;
name|t
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
operator|(
name|target_mask
operator|>>
name|t
operator|)
operator|&
literal|1
operator|)
condition|)
continue|continue;
name|tip
operator|=
operator|&
name|ncr
operator|.
name|target
index|[
name|t
index|]
expr_stmt|;
name|set_lun_mask
argument_list|(
name|tip
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|lun_mask
condition|)
name|lun_mask
operator|=
literal|1
expr_stmt|;
name|fl
operator|=
literal|1
expr_stmt|;
for|for
control|(
name|l
operator|=
literal|0
init|;
name|l
operator|<
name|MAX_LUN
condition|;
name|l
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
operator|(
name|lun_mask
operator|>>
name|l
operator|)
operator|&
literal|1
operator|)
condition|)
continue|continue;
name|printf
argument_list|(
literal|"%d:%d  "
argument_list|,
name|t
argument_list|,
name|l
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tip
operator|->
name|jump_tcb
operator|.
name|l_cmd
condition|)
break|break;
if|if
condition|(
name|fl
condition|)
block|{
name|fl
operator|=
literal|0
expr_stmt|;
name|printc
argument_list|(
operator|&
name|tip
operator|->
name|inqdata
index|[
literal|8
index|]
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
name|printc
argument_list|(
operator|&
name|tip
operator|->
name|inqdata
index|[
literal|16
index|]
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
name|printc
argument_list|(
operator|&
name|tip
operator|->
name|inqdata
index|[
literal|32
index|]
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  "
argument_list|)
expr_stmt|;
if|if
condition|(
name|tip
operator|->
name|period
operator|==
literal|0xffff
condition|)
block|{
name|printf
argument_list|(
literal|"asyn"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|tip
operator|->
name|period
condition|)
block|{
name|printf
argument_list|(
literal|"%4.1f"
argument_list|,
literal|10000.0
operator|/
name|tip
operator|->
name|period
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"   ?"
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"  "
argument_list|)
expr_stmt|;
if|if
condition|(
name|tip
operator|->
name|minsync
operator|==
literal|255
condition|)
block|{
name|printf
argument_list|(
literal|"asyn"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|tip
operator|->
name|minsync
condition|)
block|{
name|printf
argument_list|(
literal|"%4.1f"
argument_list|,
name|syncmhz
argument_list|(
name|tip
operator|->
name|minsync
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"   ?"
argument_list|)
expr_stmt|;
block|}
block|}
else|else
name|printf
argument_list|(
literal|"%42s"
argument_list|,
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tip
operator|->
name|lp
index|[
name|l
index|]
condition|)
block|{
name|printf
argument_list|(
literal|"   no\n"
argument_list|)
expr_stmt|;
continue|continue;
block|}
empty_stmt|;
name|read_lcb
argument_list|(
operator|(
name|u_long
operator|)
name|tip
operator|->
name|lp
index|[
name|l
index|]
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|tip
operator|->
name|widedone
condition|)
block|{
case|case
literal|1
case|:
name|printf
argument_list|(
literal|"   8"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|printf
argument_list|(
literal|"  16"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|printf
argument_list|(
literal|"  32"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"   ?"
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
if|if
condition|(
name|lcb
operator|.
name|usetags
condition|)
name|printf
argument_list|(
literal|"%5d"
argument_list|,
name|lcb
operator|.
name|actlink
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"    -"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
if|if
condition|(
operator|!
name|tip
operator|->
name|jump_tcb
operator|.
name|l_cmd
condition|)
block|{
name|printf
argument_list|(
literal|" --- no target.\n"
argument_list|)
expr_stmt|;
continue|continue;
block|}
empty_stmt|;
if|if
condition|(
name|verbose
operator|<
literal|1
condition|)
continue|continue;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
block|{
name|char
argument_list|*
operator|(
name|class
index|[
literal|10
index|]
operator|)
operator|=
block|{
literal|"disk"
block|,
literal|"tape"
block|,
literal|"printer"
block|,
literal|"processor"
block|,
literal|"worm"
block|,
literal|"cdrom"
block|,
literal|"scanner"
block|,
literal|"optical disk"
block|,
literal|"media changer"
block|,
literal|"communication device"
block|}
argument_list|;
name|d
operator|=
name|tip
operator|->
name|inqdata
index|[
name|i
index|]
argument_list|;
name|printf
argument_list|(
literal|"[%02x]: "
argument_list|,
name|d
argument_list|)
argument_list|;
argument_list|switch
operator|(
name|i
operator|)
block|{
case|case
literal|0
case|:
name|f
operator|=
name|d
operator|&
literal|0x1f
block|;
if|if
condition|(
name|f
operator|<
literal|10
condition|)
name|printf
argument_list|(
name|class
index|[
name|f
index|]
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"unknown (%x)"
argument_list|,
name|f
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|f
operator|=
operator|(
name|d
operator|>>
literal|7
operator|)
operator|&
literal|1
expr_stmt|;
if|if
condition|(
name|f
condition|)
name|printf
argument_list|(
literal|"removable media"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"fixed media"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|f
operator|=
name|d
operator|&
literal|7
expr_stmt|;
switch|switch
condition|(
name|f
condition|)
block|{
case|case
literal|0
case|:
name|printf
argument_list|(
literal|"SCSI-1"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|printf
argument_list|(
literal|"SCSI-1 with CCS"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|printf
argument_list|(
literal|"SCSI-2"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"unknown ansi version (%d)"
argument_list|,
name|f
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|3
case|:
if|if
condition|(
name|d
operator|&
literal|0xc0
condition|)
name|printf
argument_list|(
literal|"capabilities:"
argument_list|)
expr_stmt|;
if|if
condition|(
name|d
operator|&
literal|0x80
condition|)
name|printf
argument_list|(
literal|" AEN"
argument_list|)
expr_stmt|;
if|if
condition|(
name|d
operator|&
literal|0x40
condition|)
name|printf
argument_list|(
literal|" TERMINATE-I/O"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|7
case|:
if|if
condition|(
name|d
operator|&
literal|0xfb
condition|)
name|printf
argument_list|(
literal|"capabilities:"
argument_list|)
expr_stmt|;
if|if
condition|(
name|d
operator|&
literal|0x80
condition|)
name|printf
argument_list|(
literal|" relative"
argument_list|)
expr_stmt|;
if|if
condition|(
name|d
operator|&
literal|0x40
condition|)
name|printf
argument_list|(
literal|" wide32"
argument_list|)
expr_stmt|;
if|if
condition|(
name|d
operator|&
literal|0x20
condition|)
name|printf
argument_list|(
literal|" wide"
argument_list|)
expr_stmt|;
if|if
condition|(
name|d
operator|&
literal|0x10
condition|)
name|printf
argument_list|(
literal|" synch"
argument_list|)
expr_stmt|;
if|if
condition|(
name|d
operator|&
literal|0x08
condition|)
name|printf
argument_list|(
literal|" link"
argument_list|)
expr_stmt|;
if|if
condition|(
name|d
operator|&
literal|0x02
condition|)
name|printf
argument_list|(
literal|" tags"
argument_list|)
expr_stmt|;
if|if
condition|(
name|d
operator|&
literal|0x01
condition|)
name|printf
argument_list|(
literal|" soft-reset"
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_expr_stmt
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_escape
unit|}
end_escape

begin_comment
comment|/*================================================================ ** ** **	profiling ** ** **================================================================ */
end_comment

begin_expr_stmt
unit|do_profile
operator|(
name|void
operator|)
block|{
define|#
directive|define
name|old
value|backup.profile
define|#
directive|define
name|new
value|ncr.profile
block|struct
name|ncb
name|backup
block|; 	struct
name|profile
name|diff
block|;
name|int
name|tra
block|,
name|line
block|,
name|t
block|;
name|open_kvm
argument_list|(
name|O_RDONLY
argument_list|)
block|;
name|set_target_mask
argument_list|()
block|;
if|if
condition|(
name|interval
operator|<
literal|1
condition|)
name|interval
operator|=
literal|1
expr_stmt|;
end_expr_stmt

begin_for
for|for
control|(
init|;
condition|;
control|)
block|{
comment|/* 		**	Header Line 1 		*/
name|printf
argument_list|(
literal|"  total  "
argument_list|)
expr_stmt|;
for|for
control|(
name|t
operator|=
literal|0
init|;
name|t
operator|<
name|MAX_TARGET
condition|;
name|t
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
operator|(
name|target_mask
operator|>>
name|t
operator|)
operator|&
literal|1
operator|)
condition|)
continue|continue;
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
name|printc
argument_list|(
operator|&
name|ncr
operator|.
name|target
index|[
name|t
index|]
operator|.
name|inqdata
index|[
literal|16
index|]
argument_list|,
literal|8
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
name|printf
argument_list|(
literal|" transf.  disconn interru"
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
operator|>=
literal|1
condition|)
name|printf
argument_list|(
literal|"  ---- ms/transfer ----"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
comment|/* 		**	Header Line 2 		*/
name|printf
argument_list|(
literal|"t/s kb/s "
argument_list|)
expr_stmt|;
for|for
control|(
name|t
operator|=
literal|0
init|;
name|t
operator|<
name|MAX_TARGET
condition|;
name|t
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
operator|(
name|target_mask
operator|>>
name|t
operator|)
operator|&
literal|1
operator|)
condition|)
continue|continue;
name|printf
argument_list|(
literal|" t/s kb/s"
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
name|printf
argument_list|(
literal|" length   exp une fly brk"
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
operator|>=
literal|1
condition|)
name|printf
argument_list|(
literal|"  total  pre post  disc"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
comment|/* 		**	Data 		*/
for|for
control|(
name|line
operator|=
literal|0
init|;
name|line
operator|<
literal|20
condition|;
name|line
operator|++
control|)
block|{
name|backup
operator|=
name|ncr
expr_stmt|;
name|read_ncr
argument_list|()
expr_stmt|;
name|diff
operator|.
name|num_trans
operator|=
name|new
operator|.
name|num_trans
operator|-
name|old
operator|.
name|num_trans
expr_stmt|;
name|diff
operator|.
name|num_bytes
operator|=
name|new
operator|.
name|num_bytes
operator|-
name|old
operator|.
name|num_bytes
expr_stmt|;
name|diff
operator|.
name|num_fly
operator|=
name|new
operator|.
name|num_fly
operator|-
name|old
operator|.
name|num_fly
expr_stmt|;
name|diff
operator|.
name|num_int
operator|=
name|new
operator|.
name|num_int
operator|-
name|old
operator|.
name|num_int
expr_stmt|;
name|diff
operator|.
name|ms_setup
operator|=
name|new
operator|.
name|ms_setup
operator|-
name|old
operator|.
name|ms_setup
expr_stmt|;
name|diff
operator|.
name|ms_data
operator|=
name|new
operator|.
name|ms_data
operator|-
name|old
operator|.
name|ms_data
expr_stmt|;
name|diff
operator|.
name|ms_disc
operator|=
name|new
operator|.
name|ms_disc
operator|-
name|old
operator|.
name|ms_disc
expr_stmt|;
name|diff
operator|.
name|ms_post
operator|=
name|new
operator|.
name|ms_post
operator|-
name|old
operator|.
name|ms_post
expr_stmt|;
name|diff
operator|.
name|num_disc
operator|=
name|new
operator|.
name|num_disc
operator|-
name|old
operator|.
name|num_disc
expr_stmt|;
name|diff
operator|.
name|num_break
operator|=
name|new
operator|.
name|num_break
operator|-
name|old
operator|.
name|num_break
expr_stmt|;
name|tra
operator|=
name|diff
operator|.
name|num_trans
expr_stmt|;
if|if
condition|(
operator|!
name|tra
condition|)
name|tra
operator|=
literal|1
expr_stmt|;
name|printf
argument_list|(
literal|"%3.0f %4.0f "
argument_list|,
operator|(
literal|1.0
operator|*
name|diff
operator|.
name|num_trans
operator|)
operator|/
name|interval
argument_list|,
operator|(
literal|1.0
operator|*
name|diff
operator|.
name|num_bytes
operator|)
operator|/
operator|(
literal|1024
operator|*
name|interval
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|t
operator|=
literal|0
init|;
name|t
operator|<
name|MAX_TARGET
condition|;
name|t
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
operator|(
name|target_mask
operator|>>
name|t
operator|)
operator|&
literal|1
operator|)
condition|)
continue|continue;
name|printf
argument_list|(
literal|" %3.0f %4.0f"
argument_list|,
operator|(
operator|(
name|ncr
operator|.
name|target
index|[
name|t
index|]
operator|.
name|transfers
operator|-
name|backup
operator|.
name|target
index|[
name|t
index|]
operator|.
name|transfers
operator|)
operator|*
literal|1.0
operator|)
operator|/
name|interval
argument_list|,
operator|(
operator|(
name|ncr
operator|.
name|target
index|[
name|t
index|]
operator|.
name|bytes
operator|-
name|backup
operator|.
name|target
index|[
name|t
index|]
operator|.
name|bytes
operator|)
operator|*
literal|1.0
operator|)
operator|/
operator|(
literal|1024
operator|*
name|interval
operator|)
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
name|printf
argument_list|(
literal|"%7.0f "
argument_list|,
operator|(
name|diff
operator|.
name|num_bytes
operator|*
literal|1.0
operator|)
operator|/
name|tra
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" %4.0f"
argument_list|,
operator|(
literal|1.0
operator|*
operator|(
name|diff
operator|.
name|num_disc
operator|-
name|diff
operator|.
name|num_break
operator|)
operator|)
operator|/
name|interval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%4.0f"
argument_list|,
operator|(
literal|1.0
operator|*
name|diff
operator|.
name|num_break
operator|)
operator|/
name|interval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%4.0f"
argument_list|,
operator|(
literal|1.0
operator|*
name|diff
operator|.
name|num_fly
operator|)
operator|/
name|interval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%4.0f"
argument_list|,
operator|(
literal|1.0
operator|*
name|diff
operator|.
name|num_int
operator|)
operator|/
name|interval
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
operator|>=
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"%7.1f"
argument_list|,
operator|(
name|diff
operator|.
name|ms_disc
operator|+
name|diff
operator|.
name|ms_data
operator|+
name|diff
operator|.
name|ms_setup
operator|+
name|diff
operator|.
name|ms_post
operator|)
operator|*
literal|1.0
operator|/
name|tra
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%5.1f%5.1f%6.1f"
argument_list|,
literal|1.0
operator|*
name|diff
operator|.
name|ms_setup
operator|/
name|tra
argument_list|,
literal|1.0
operator|*
name|diff
operator|.
name|ms_post
operator|/
name|tra
argument_list|,
literal|1.0
operator|*
name|diff
operator|.
name|ms_disc
operator|/
name|tra
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|sleep
argument_list|(
name|interval
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
block|}
end_for

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_escape
unit|}
end_escape

begin_comment
comment|/*================================================================ ** ** **	Port access ** ** **================================================================ */
end_comment

begin_decl_stmt
unit|static
name|int
name|kernelwritefile
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|kernelwritefilename
init|=
name|_PATH_KMEM
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|openkernelwritefile
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
name|kernelwritefile
condition|)
return|return;
name|kernelwritefile
operator|=
name|open
argument_list|(
name|kernelwritefilename
argument_list|,
name|O_WRONLY
argument_list|)
expr_stmt|;
if|if
condition|(
name|kernelwritefile
operator|<
literal|3
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: %s: %s\n"
argument_list|,
name|prog
argument_list|,
name|kernelwritefilename
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
block|}
end_function

begin_function
name|void
name|out
parameter_list|(
name|u_char
name|reg
parameter_list|,
name|u_char
name|val
parameter_list|)
block|{
name|u_long
name|addr
init|=
name|ncr
operator|.
name|vaddr
operator|+
name|reg
decl_stmt|;
name|openkernelwritefile
argument_list|()
expr_stmt|;
if|if
condition|(
name|lseek
argument_list|(
name|kernelwritefile
argument_list|,
name|addr
argument_list|,
literal|0
argument_list|)
operator|!=
name|addr
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: %s: %s\n"
argument_list|,
name|prog
argument_list|,
name|kernelwritefilename
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|write
argument_list|(
name|kernelwritefile
argument_list|,
operator|&
name|val
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: %s: %s\n"
argument_list|,
name|prog
argument_list|,
name|kernelwritefilename
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
block|}
end_function

begin_function
name|u_char
name|in
parameter_list|(
name|u_char
name|reg
parameter_list|)
block|{
name|u_char
name|res
decl_stmt|;
if|if
condition|(
operator|!
name|KVM_READ
argument_list|(
operator|(
name|ncr
operator|.
name|vaddr
operator|+
name|reg
operator|)
argument_list|,
operator|&
name|res
argument_list|,
literal|1
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: bad kvm read.\n"
argument_list|,
name|prog
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|res
operator|)
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/*================================================================ ** ** **	Setting of driver parameters ** ** **================================================================ */
end_comment

begin_function
name|void
name|do_set
parameter_list|(
name|char
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|usrcmd
name|user
decl_stmt|;
name|u_long
name|addr
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"?"
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"async:         disable synchronous transfers.\n"
literal|"sync=value:    set the maximal synchronous transfer rate (MHz).\n"
literal|"fast:          set FAST SCSI-2.\n"
literal|"\n"
literal|"wide=value:    set the bus width (0=8bit 1=16bit).\n"
literal|"\n"
literal|"tags=value:    use this number of tags.\n"
literal|"orderedtag:    use ordered tags only.\n"
literal|"simpletag:     use simple tags only.\n"
literal|"orderedwrite:  use simple tags for read, else ordered tags.\n"
literal|"\n"
literal|"debug=value:   set debug mode.\n"
literal|"\n"
argument_list|)
expr_stmt|;
return|return;
block|}
empty_stmt|;
name|open_kvm
argument_list|(
name|O_RDWR
argument_list|)
expr_stmt|;
name|addr
operator|=
name|ncr_base
operator|+
name|offsetof
argument_list|(
expr|struct
name|ncb
argument_list|,
name|user
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|3
init|;
name|i
condition|;
name|i
operator|--
control|)
block|{
if|if
condition|(
operator|!
name|KVM_READ
argument_list|(
operator|(
name|addr
operator|)
argument_list|,
operator|&
name|user
argument_list|,
sizeof|sizeof
argument_list|(
name|user
argument_list|)
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: bad kvm read.\n"
argument_list|,
name|prog
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|user
operator|.
name|cmd
condition|)
break|break;
name|sleep
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|user
operator|.
name|cmd
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: ncb.user busy.\n"
argument_list|,
name|prog
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
name|set_target_mask
argument_list|()
expr_stmt|;
name|user
operator|.
name|target
operator|=
name|target_mask
expr_stmt|;
name|user
operator|.
name|lun
operator|=
name|lun_mask
expr_stmt|;
name|user
operator|.
name|data
operator|=
literal|0
expr_stmt|;
name|user
operator|.
name|cmd
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"async"
argument_list|)
condition|)
block|{
name|user
operator|.
name|data
operator|=
literal|255
expr_stmt|;
name|user
operator|.
name|cmd
operator|=
name|UC_SETSYNC
expr_stmt|;
block|}
empty_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"fast"
argument_list|)
condition|)
block|{
name|user
operator|.
name|data
operator|=
literal|25
expr_stmt|;
name|user
operator|.
name|cmd
operator|=
name|UC_SETSYNC
expr_stmt|;
block|}
empty_stmt|;
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|arg
argument_list|,
literal|"sync="
argument_list|,
literal|5
argument_list|)
condition|)
block|{
name|double
name|f
init|=
name|strtod
argument_list|(
name|arg
operator|+
literal|5
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
if|if
condition|(
name|f
operator|>=
literal|4.0
operator|&&
name|f
operator|<=
literal|10.0
condition|)
block|{
name|user
operator|.
name|data
operator|=
literal|250.0
operator|/
name|f
expr_stmt|;
name|user
operator|.
name|cmd
operator|=
name|UC_SETSYNC
expr_stmt|;
block|}
empty_stmt|;
block|}
empty_stmt|;
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|arg
argument_list|,
literal|"wide="
argument_list|,
literal|5
argument_list|)
condition|)
block|{
name|u_char
name|t
init|=
name|strtoul
argument_list|(
name|arg
operator|+
literal|5
argument_list|,
operator|(
name|char
operator|*
operator|*
operator|)
literal|0
argument_list|,
literal|0
argument_list|)
decl_stmt|;
if|if
condition|(
name|t
operator|<=
literal|1
condition|)
block|{
name|user
operator|.
name|data
operator|=
name|t
expr_stmt|;
name|user
operator|.
name|cmd
operator|=
name|UC_SETWIDE
expr_stmt|;
block|}
empty_stmt|;
block|}
empty_stmt|;
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|arg
argument_list|,
literal|"tags="
argument_list|,
literal|5
argument_list|)
condition|)
block|{
name|u_char
name|t
init|=
name|strtoul
argument_list|(
name|arg
operator|+
literal|5
argument_list|,
operator|(
name|char
operator|*
operator|*
operator|)
literal|0
argument_list|,
literal|0
argument_list|)
decl_stmt|;
if|if
condition|(
name|t
operator|<=
name|MAX_TAGS
condition|)
block|{
name|user
operator|.
name|data
operator|=
name|t
expr_stmt|;
name|user
operator|.
name|cmd
operator|=
name|UC_SETTAGS
expr_stmt|;
block|}
empty_stmt|;
block|}
empty_stmt|;
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|arg
argument_list|,
literal|"flags="
argument_list|,
literal|6
argument_list|)
condition|)
block|{
name|u_char
name|t
init|=
name|strtoul
argument_list|(
name|arg
operator|+
literal|6
argument_list|,
operator|(
name|char
operator|*
operator|*
operator|)
literal|0
argument_list|,
literal|0
argument_list|)
decl_stmt|;
if|if
condition|(
name|t
operator|<=
literal|0xff
condition|)
block|{
name|user
operator|.
name|data
operator|=
name|t
expr_stmt|;
name|user
operator|.
name|cmd
operator|=
name|UC_SETFLAG
expr_stmt|;
block|}
empty_stmt|;
block|}
empty_stmt|;
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|arg
argument_list|,
literal|"debug="
argument_list|,
literal|6
argument_list|)
condition|)
block|{
name|user
operator|.
name|data
operator|=
name|strtoul
argument_list|(
name|arg
operator|+
literal|6
argument_list|,
operator|(
name|char
operator|*
operator|*
operator|)
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|user
operator|.
name|cmd
operator|=
name|UC_SETDEBUG
expr_stmt|;
block|}
empty_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"orderedtag"
argument_list|)
condition|)
block|{
name|user
operator|.
name|data
operator|=
name|M_ORDERED_TAG
expr_stmt|;
name|user
operator|.
name|cmd
operator|=
name|UC_SETORDER
expr_stmt|;
block|}
empty_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"simpletag"
argument_list|)
condition|)
block|{
name|user
operator|.
name|data
operator|=
name|M_SIMPLE_TAG
expr_stmt|;
name|user
operator|.
name|cmd
operator|=
name|UC_SETORDER
expr_stmt|;
block|}
empty_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"orderedwrite"
argument_list|)
condition|)
block|{
name|user
operator|.
name|data
operator|=
literal|0
expr_stmt|;
name|user
operator|.
name|cmd
operator|=
name|UC_SETORDER
expr_stmt|;
block|}
empty_stmt|;
if|if
condition|(
name|user
operator|.
name|cmd
condition|)
block|{
name|openkernelwritefile
argument_list|()
expr_stmt|;
if|if
condition|(
name|lseek
argument_list|(
name|kernelwritefile
argument_list|,
name|addr
argument_list|,
literal|0
argument_list|)
operator|!=
name|addr
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: %s: %s\n"
argument_list|,
name|prog
argument_list|,
name|kernelwritefilename
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|write
argument_list|(
name|kernelwritefile
argument_list|,
operator|&
name|user
argument_list|,
sizeof|sizeof
argument_list|(
name|user
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: %s: %s\n"
argument_list|,
name|prog
argument_list|,
name|kernelwritefilename
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
empty_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: do_set \"%s\" not (yet) implemented.\n"
argument_list|,
name|prog
argument_list|,
name|arg
argument_list|)
expr_stmt|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/*================================================================ ** ** **	D O _ K I L L ** ** **================================================================ */
end_comment

begin_macro
name|do_kill
argument_list|(
argument|char * arg
argument_list|)
end_macro

begin_block
block|{
name|open_kvm
argument_list|(
name|O_RDWR
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"?"
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"scsireset:     force SCSI bus reset.\n"
literal|"scriptabort:   send an abort cmd to the script processor.\n"
literal|"scriptstart:   start script processind (set SIGP bit).\n"
literal|"evenparity:    force even parity.\n"
literal|"oddparity:     force odd parity.\n"
literal|"noreselect:    disable reselect (force timeouts).\n"
literal|"doreselect:    enable reselect.\n"
literal|"\n"
argument_list|)
expr_stmt|;
return|return;
block|}
empty_stmt|;
if|if
condition|(
operator|!
name|wizard
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: You are NOT a wizard!\n"
argument_list|,
name|prog
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"scsireset"
argument_list|)
condition|)
block|{
name|out
argument_list|(
literal|0x01
argument_list|,
literal|0x08
argument_list|)
expr_stmt|;
name|out
argument_list|(
literal|0x01
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
return|return;
block|}
empty_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"scriptabort"
argument_list|)
condition|)
block|{
name|out
argument_list|(
literal|0x14
argument_list|,
literal|0x80
argument_list|)
expr_stmt|;
name|out
argument_list|(
literal|0x14
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
return|return;
block|}
empty_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"scriptstart"
argument_list|)
condition|)
block|{
name|out
argument_list|(
literal|0x14
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
return|return;
block|}
empty_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"evenparity"
argument_list|)
condition|)
block|{
name|out
argument_list|(
literal|0x01
argument_list|,
literal|0x04
argument_list|)
expr_stmt|;
return|return;
block|}
empty_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"oddparity"
argument_list|)
condition|)
block|{
name|out
argument_list|(
literal|0x01
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
return|return;
block|}
empty_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"noreselect"
argument_list|)
condition|)
block|{
name|out
argument_list|(
literal|0x04
argument_list|,
name|in
argument_list|(
literal|0x04
argument_list|)
operator|&
operator|~
name|RRE
argument_list|)
expr_stmt|;
return|return;
block|}
empty_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"doreselect"
argument_list|)
condition|)
block|{
name|out
argument_list|(
literal|0x04
argument_list|,
name|in
argument_list|(
literal|0x04
argument_list|)
operator||
name|RRE
argument_list|)
expr_stmt|;
return|return;
block|}
empty_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: do_kill \"%s\" not (yet) implemented.\n"
argument_list|,
name|prog
argument_list|,
name|arg
argument_list|)
expr_stmt|;
block|}
end_block

begin_escape
end_escape

begin_comment
comment|/*================================================================ ** ** **	Write debug info: utilities:     write symbolname. ** ** **================================================================ */
end_comment

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|sn
parameter_list|(
name|u_long
name|a
parameter_list|)
block|{
specifier|static
name|char
name|buffer
index|[
literal|100
index|]
decl_stmt|;
specifier|const
name|char
modifier|*
name|s
init|=
literal|""
decl_stmt|;
name|u_long
name|d
decl_stmt|,
name|m
decl_stmt|;
name|a
operator|-=
name|ncr
operator|.
name|p_script
expr_stmt|;
name|m
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|script
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|d
operator|=
name|a
operator|-
name|offsetof
argument_list|(
expr|struct
name|script
argument_list|,
name|start
argument_list|)
operator|)
operator|<
name|m
condition|)
name|m
operator|=
name|d
operator|,
name|s
operator|=
literal|"<start>"
expr_stmt|;
if|if
condition|(
operator|(
name|d
operator|=
name|a
operator|-
name|offsetof
argument_list|(
expr|struct
name|script
argument_list|,
name|start1
argument_list|)
operator|)
operator|<
name|m
condition|)
name|m
operator|=
name|d
operator|,
name|s
operator|=
literal|"<start1>"
expr_stmt|;
if|if
condition|(
operator|(
name|d
operator|=
name|a
operator|-
name|offsetof
argument_list|(
expr|struct
name|script
argument_list|,
name|startpos
argument_list|)
operator|)
operator|<
name|m
condition|)
name|m
operator|=
name|d
operator|,
name|s
operator|=
literal|"<startpos>"
expr_stmt|;
if|if
condition|(
operator|(
name|d
operator|=
name|a
operator|-
name|offsetof
argument_list|(
expr|struct
name|scripth
argument_list|,
name|tryloop
argument_list|)
operator|)
operator|<
name|m
condition|)
name|m
operator|=
name|d
operator|,
name|s
operator|=
literal|"<tryloop>"
expr_stmt|;
if|if
condition|(
operator|(
name|d
operator|=
name|a
operator|-
name|offsetof
argument_list|(
expr|struct
name|script
argument_list|,
name|trysel
argument_list|)
operator|)
operator|<
name|m
condition|)
name|m
operator|=
name|d
operator|,
name|s
operator|=
literal|"<trysel>"
expr_stmt|;
if|if
condition|(
operator|(
name|d
operator|=
name|a
operator|-
name|offsetof
argument_list|(
expr|struct
name|script
argument_list|,
name|skip
argument_list|)
operator|)
operator|<
name|m
condition|)
name|m
operator|=
name|d
operator|,
name|s
operator|=
literal|"<skip>"
expr_stmt|;
if|if
condition|(
operator|(
name|d
operator|=
name|a
operator|-
name|offsetof
argument_list|(
expr|struct
name|script
argument_list|,
name|skip2
argument_list|)
operator|)
operator|<
name|m
condition|)
name|m
operator|=
name|d
operator|,
name|s
operator|=
literal|"<skip2>"
expr_stmt|;
if|if
condition|(
operator|(
name|d
operator|=
name|a
operator|-
name|offsetof
argument_list|(
expr|struct
name|script
argument_list|,
name|idle
argument_list|)
operator|)
operator|<
name|m
condition|)
name|m
operator|=
name|d
operator|,
name|s
operator|=
literal|"<idle>"
expr_stmt|;
if|if
condition|(
operator|(
name|d
operator|=
name|a
operator|-
name|offsetof
argument_list|(
expr|struct
name|script
argument_list|,
name|select
argument_list|)
operator|)
operator|<
name|m
condition|)
name|m
operator|=
name|d
operator|,
name|s
operator|=
literal|"<select>"
expr_stmt|;
if|if
condition|(
operator|(
name|d
operator|=
name|a
operator|-
name|offsetof
argument_list|(
expr|struct
name|script
argument_list|,
name|prepare
argument_list|)
operator|)
operator|<
name|m
condition|)
name|m
operator|=
name|d
operator|,
name|s
operator|=
literal|"<prepare>"
expr_stmt|;
if|if
condition|(
operator|(
name|d
operator|=
name|a
operator|-
name|offsetof
argument_list|(
expr|struct
name|script
argument_list|,
name|loadpos
argument_list|)
operator|)
operator|<
name|m
condition|)
name|m
operator|=
name|d
operator|,
name|s
operator|=
literal|"<loadpos>"
expr_stmt|;
if|if
condition|(
operator|(
name|d
operator|=
name|a
operator|-
name|offsetof
argument_list|(
expr|struct
name|script
argument_list|,
name|prepare2
argument_list|)
operator|)
operator|<
name|m
condition|)
name|m
operator|=
name|d
operator|,
name|s
operator|=
literal|"<prepare2>"
expr_stmt|;
if|if
condition|(
operator|(
name|d
operator|=
name|a
operator|-
name|offsetof
argument_list|(
expr|struct
name|script
argument_list|,
name|setmsg
argument_list|)
operator|)
operator|<
name|m
condition|)
name|m
operator|=
name|d
operator|,
name|s
operator|=
literal|"<setmsg>"
expr_stmt|;
if|if
condition|(
operator|(
name|d
operator|=
name|a
operator|-
name|offsetof
argument_list|(
expr|struct
name|script
argument_list|,
name|clrack
argument_list|)
operator|)
operator|<
name|m
condition|)
name|m
operator|=
name|d
operator|,
name|s
operator|=
literal|"<clrack>"
expr_stmt|;
if|if
condition|(
operator|(
name|d
operator|=
name|a
operator|-
name|offsetof
argument_list|(
expr|struct
name|script
argument_list|,
name|dispatch
argument_list|)
operator|)
operator|<
name|m
condition|)
name|m
operator|=
name|d
operator|,
name|s
operator|=
literal|"<dispatch>"
expr_stmt|;
if|if
condition|(
operator|(
name|d
operator|=
name|a
operator|-
name|offsetof
argument_list|(
expr|struct
name|script
argument_list|,
name|checkatn
argument_list|)
operator|)
operator|<
name|m
condition|)
name|m
operator|=
name|d
operator|,
name|s
operator|=
literal|"<checkatn>"
expr_stmt|;
if|if
condition|(
operator|(
name|d
operator|=
name|a
operator|-
name|offsetof
argument_list|(
expr|struct
name|script
argument_list|,
name|command
argument_list|)
operator|)
operator|<
name|m
condition|)
name|m
operator|=
name|d
operator|,
name|s
operator|=
literal|"<command>"
expr_stmt|;
if|if
condition|(
operator|(
name|d
operator|=
name|a
operator|-
name|offsetof
argument_list|(
expr|struct
name|script
argument_list|,
name|status
argument_list|)
operator|)
operator|<
name|m
condition|)
name|m
operator|=
name|d
operator|,
name|s
operator|=
literal|"<status>"
expr_stmt|;
if|if
condition|(
operator|(
name|d
operator|=
name|a
operator|-
name|offsetof
argument_list|(
expr|struct
name|script
argument_list|,
name|msg_in
argument_list|)
operator|)
operator|<
name|m
condition|)
name|m
operator|=
name|d
operator|,
name|s
operator|=
literal|"<msg_in>"
expr_stmt|;
if|if
condition|(
operator|(
name|d
operator|=
name|a
operator|-
name|offsetof
argument_list|(
expr|struct
name|script
argument_list|,
name|msg_bad
argument_list|)
operator|)
operator|<
name|m
condition|)
name|m
operator|=
name|d
operator|,
name|s
operator|=
literal|"<msg_bad>"
expr_stmt|;
if|if
condition|(
operator|(
name|d
operator|=
name|a
operator|-
name|offsetof
argument_list|(
expr|struct
name|scripth
argument_list|,
name|msg_parity
argument_list|)
operator|)
operator|<
name|m
condition|)
name|m
operator|=
name|d
operator|,
name|s
operator|=
literal|"<msg_parity>"
expr_stmt|;
if|if
condition|(
operator|(
name|d
operator|=
name|a
operator|-
name|offsetof
argument_list|(
expr|struct
name|scripth
argument_list|,
name|msg_reject
argument_list|)
operator|)
operator|<
name|m
condition|)
name|m
operator|=
name|d
operator|,
name|s
operator|=
literal|"<msg_reject>"
expr_stmt|;
if|if
condition|(
operator|(
name|d
operator|=
name|a
operator|-
name|offsetof
argument_list|(
expr|struct
name|scripth
argument_list|,
name|msg_extended
argument_list|)
operator|)
operator|<
name|m
condition|)
name|m
operator|=
name|d
operator|,
name|s
operator|=
literal|"<msg_extended>"
expr_stmt|;
if|if
condition|(
operator|(
name|d
operator|=
name|a
operator|-
name|offsetof
argument_list|(
expr|struct
name|scripth
argument_list|,
name|msg_sdtr
argument_list|)
operator|)
operator|<
name|m
condition|)
name|m
operator|=
name|d
operator|,
name|s
operator|=
literal|"<msg_sdtr>"
expr_stmt|;
if|if
condition|(
operator|(
name|d
operator|=
name|a
operator|-
name|offsetof
argument_list|(
expr|struct
name|script
argument_list|,
name|complete
argument_list|)
operator|)
operator|<
name|m
condition|)
name|m
operator|=
name|d
operator|,
name|s
operator|=
literal|"<complete>"
expr_stmt|;
if|if
condition|(
operator|(
name|d
operator|=
name|a
operator|-
name|offsetof
argument_list|(
expr|struct
name|script
argument_list|,
name|cleanup
argument_list|)
operator|)
operator|<
name|m
condition|)
name|m
operator|=
name|d
operator|,
name|s
operator|=
literal|"<cleanup>"
expr_stmt|;
if|if
condition|(
operator|(
name|d
operator|=
name|a
operator|-
name|offsetof
argument_list|(
expr|struct
name|script
argument_list|,
name|cleanup0
argument_list|)
operator|)
operator|<
name|m
condition|)
name|m
operator|=
name|d
operator|,
name|s
operator|=
literal|"<cleanup>"
expr_stmt|;
if|if
condition|(
operator|(
name|d
operator|=
name|a
operator|-
name|offsetof
argument_list|(
expr|struct
name|script
argument_list|,
name|signal
argument_list|)
operator|)
operator|<
name|m
condition|)
name|m
operator|=
name|d
operator|,
name|s
operator|=
literal|"<signal>"
expr_stmt|;
if|if
condition|(
operator|(
name|d
operator|=
name|a
operator|-
name|offsetof
argument_list|(
expr|struct
name|script
argument_list|,
name|save_dp
argument_list|)
operator|)
operator|<
name|m
condition|)
name|m
operator|=
name|d
operator|,
name|s
operator|=
literal|"<save_dp>"
expr_stmt|;
if|if
condition|(
operator|(
name|d
operator|=
name|a
operator|-
name|offsetof
argument_list|(
expr|struct
name|script
argument_list|,
name|restore_dp
argument_list|)
operator|)
operator|<
name|m
condition|)
name|m
operator|=
name|d
operator|,
name|s
operator|=
literal|"<restore_dp>"
expr_stmt|;
if|if
condition|(
operator|(
name|d
operator|=
name|a
operator|-
name|offsetof
argument_list|(
expr|struct
name|script
argument_list|,
name|disconnect
argument_list|)
operator|)
operator|<
name|m
condition|)
name|m
operator|=
name|d
operator|,
name|s
operator|=
literal|"<disconnect>"
expr_stmt|;
if|if
condition|(
operator|(
name|d
operator|=
name|a
operator|-
name|offsetof
argument_list|(
expr|struct
name|script
argument_list|,
name|msg_out
argument_list|)
operator|)
operator|<
name|m
condition|)
name|m
operator|=
name|d
operator|,
name|s
operator|=
literal|"<msg_out>"
expr_stmt|;
if|if
condition|(
operator|(
name|d
operator|=
name|a
operator|-
name|offsetof
argument_list|(
expr|struct
name|script
argument_list|,
name|msg_out_done
argument_list|)
operator|)
operator|<
name|m
condition|)
name|m
operator|=
name|d
operator|,
name|s
operator|=
literal|"<msg_out_done>"
expr_stmt|;
if|if
condition|(
operator|(
name|d
operator|=
name|a
operator|-
name|offsetof
argument_list|(
expr|struct
name|scripth
argument_list|,
name|msg_out_abort
argument_list|)
operator|)
operator|<
name|m
condition|)
name|m
operator|=
name|d
operator|,
name|s
operator|=
literal|"<msg_out_abort>"
expr_stmt|;
if|if
condition|(
operator|(
name|d
operator|=
name|a
operator|-
name|offsetof
argument_list|(
expr|struct
name|scripth
argument_list|,
name|getcc
argument_list|)
operator|)
operator|<
name|m
condition|)
name|m
operator|=
name|d
operator|,
name|s
operator|=
literal|"<getcc>"
expr_stmt|;
if|if
condition|(
operator|(
name|d
operator|=
name|a
operator|-
name|offsetof
argument_list|(
expr|struct
name|scripth
argument_list|,
name|getcc1
argument_list|)
operator|)
operator|<
name|m
condition|)
name|m
operator|=
name|d
operator|,
name|s
operator|=
literal|"<getcc1>"
expr_stmt|;
if|if
condition|(
operator|(
name|d
operator|=
name|a
operator|-
name|offsetof
argument_list|(
expr|struct
name|scripth
argument_list|,
name|getcc2
argument_list|)
operator|)
operator|<
name|m
condition|)
name|m
operator|=
name|d
operator|,
name|s
operator|=
literal|"<getcc2>"
expr_stmt|;
if|if
condition|(
operator|(
name|d
operator|=
name|a
operator|-
name|offsetof
argument_list|(
expr|struct
name|script
argument_list|,
name|badgetcc
argument_list|)
operator|)
operator|<
name|m
condition|)
name|m
operator|=
name|d
operator|,
name|s
operator|=
literal|"<badgetcc>"
expr_stmt|;
if|if
condition|(
operator|(
name|d
operator|=
name|a
operator|-
name|offsetof
argument_list|(
expr|struct
name|script
argument_list|,
name|reselect
argument_list|)
operator|)
operator|<
name|m
condition|)
name|m
operator|=
name|d
operator|,
name|s
operator|=
literal|"<reselect>"
expr_stmt|;
if|if
condition|(
operator|(
name|d
operator|=
name|a
operator|-
name|offsetof
argument_list|(
expr|struct
name|script
argument_list|,
name|reselect2
argument_list|)
operator|)
operator|<
name|m
condition|)
name|m
operator|=
name|d
operator|,
name|s
operator|=
literal|"<reselect2>"
expr_stmt|;
if|if
condition|(
operator|(
name|d
operator|=
name|a
operator|-
name|offsetof
argument_list|(
expr|struct
name|script
argument_list|,
name|resel_tmp
argument_list|)
operator|)
operator|<
name|m
condition|)
name|m
operator|=
name|d
operator|,
name|s
operator|=
literal|"<resel_tmp>"
expr_stmt|;
if|if
condition|(
operator|(
name|d
operator|=
name|a
operator|-
name|offsetof
argument_list|(
expr|struct
name|script
argument_list|,
name|resel_lun
argument_list|)
operator|)
operator|<
name|m
condition|)
name|m
operator|=
name|d
operator|,
name|s
operator|=
literal|"<resel_lun>"
expr_stmt|;
if|if
condition|(
operator|(
name|d
operator|=
name|a
operator|-
name|offsetof
argument_list|(
expr|struct
name|script
argument_list|,
name|resel_tag
argument_list|)
operator|)
operator|<
name|m
condition|)
name|m
operator|=
name|d
operator|,
name|s
operator|=
literal|"<resel_tag>"
expr_stmt|;
if|if
condition|(
operator|(
name|d
operator|=
name|a
operator|-
name|offsetof
argument_list|(
expr|struct
name|script
argument_list|,
name|data_in
argument_list|)
operator|)
operator|<
name|m
condition|)
name|m
operator|=
name|d
operator|,
name|s
operator|=
literal|"<data_in>"
expr_stmt|;
if|if
condition|(
operator|(
name|d
operator|=
name|a
operator|-
name|offsetof
argument_list|(
expr|struct
name|script
argument_list|,
name|data_out
argument_list|)
operator|)
operator|<
name|m
condition|)
name|m
operator|=
name|d
operator|,
name|s
operator|=
literal|"<data_out>"
expr_stmt|;
if|if
condition|(
operator|(
name|d
operator|=
name|a
operator|-
name|offsetof
argument_list|(
expr|struct
name|script
argument_list|,
name|no_data
argument_list|)
operator|)
operator|<
name|m
condition|)
name|m
operator|=
name|d
operator|,
name|s
operator|=
literal|"<no_data>"
expr_stmt|;
if|if
condition|(
operator|(
name|d
operator|=
name|a
operator|-
name|offsetof
argument_list|(
expr|struct
name|scripth
argument_list|,
name|aborttag
argument_list|)
operator|)
operator|<
name|m
condition|)
name|m
operator|=
name|d
operator|,
name|s
operator|=
literal|"<aborttag>"
expr_stmt|;
if|if
condition|(
operator|(
name|d
operator|=
name|a
operator|-
name|offsetof
argument_list|(
expr|struct
name|scripth
argument_list|,
name|abort
argument_list|)
operator|)
operator|<
name|m
condition|)
name|m
operator|=
name|d
operator|,
name|s
operator|=
literal|"<abort>"
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|s
condition|)
return|return
name|s
return|;
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"%s:%d%c"
argument_list|,
name|s
argument_list|,
name|m
operator|/
literal|4
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|buffer
operator|)
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/*================================================================ ** ** **	Write debug info: utilities:     write misc. fields. ** ** **================================================================ */
end_comment

begin_function
specifier|static
name|void
name|printm
parameter_list|(
name|u_char
modifier|*
name|msg
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|u_char
name|l
decl_stmt|;
do|do
block|{
if|if
condition|(
operator|*
name|msg
operator|==
name|M_EXTENDED
condition|)
name|l
operator|=
name|msg
index|[
literal|1
index|]
operator|+
literal|2
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
operator|*
name|msg
operator|&
literal|0xf0
operator|)
operator|==
literal|0x20
condition|)
name|l
operator|=
literal|2
expr_stmt|;
else|else
name|l
operator|=
literal|1
expr_stmt|;
name|len
operator|-=
name|l
expr_stmt|;
name|printf
argument_list|(
literal|" %x"
argument_list|,
operator|*
name|msg
operator|++
argument_list|)
expr_stmt|;
while|while
condition|(
operator|--
name|l
operator|>
literal|0
condition|)
name|printf
argument_list|(
literal|"-%x"
argument_list|,
operator|*
name|msg
operator|++
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|len
operator|>
literal|0
condition|)
do|;
block|}
end_function

begin_function
name|void
name|dump_table
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|,
name|struct
name|scr_tblmove
modifier|*
name|p
parameter_list|,
name|int
name|l
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|l
operator|>
literal|0
condition|;
name|i
operator|++
operator|,
name|p
operator|++
operator|,
name|l
operator|--
control|)
if|if
condition|(
name|p
operator|->
name|size
condition|)
block|{
name|printf
argument_list|(
literal|"    %s[%d]: %5d @ 0x%08x\n"
argument_list|,
name|str
argument_list|,
name|i
argument_list|,
name|p
operator|->
name|size
argument_list|,
name|p
operator|->
name|addr
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
block|}
end_function

begin_function
name|void
name|dump_link
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|struct
name|link
modifier|*
name|link
parameter_list|)
block|{
name|printf
argument_list|(
literal|"%s: cmd=%08x pa=%08x %s\n"
argument_list|,
name|name
argument_list|,
name|link
operator|->
name|l_cmd
argument_list|,
name|link
operator|->
name|l_paddr
argument_list|,
name|sn
argument_list|(
name|link
operator|->
name|l_paddr
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/*================================================================ ** ** **	Write debug info: utilities:     write time fields. ** ** **================================================================ */
end_comment

begin_function
name|void
name|dump_tstamp
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|struct
name|tstamp
modifier|*
name|p
parameter_list|)
define|#
directive|define
name|P
parameter_list|(
name|id
parameter_list|,
name|fld
parameter_list|)
define|\
value|if (p->fld.tv_sec) \ 		printf ("%s: "id" at %s.%06d",\ 			name,ctime(&p->fld.tv_sec),p->fld.tv_usec);
block|{
name|P
argument_list|(
literal|"started     "
argument_list|,
name|start
argument_list|)
expr_stmt|;
name|P
argument_list|(
literal|"ended       "
argument_list|,
name|end
argument_list|)
expr_stmt|;
name|P
argument_list|(
literal|"selected    "
argument_list|,
name|select
argument_list|)
expr_stmt|;
name|P
argument_list|(
literal|"command     "
argument_list|,
name|command
argument_list|)
expr_stmt|;
name|P
argument_list|(
literal|"data        "
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|P
argument_list|(
literal|"status      "
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|P
argument_list|(
literal|"disconnected"
argument_list|,
name|disconnect
argument_list|)
expr_stmt|;
name|P
argument_list|(
literal|"reselected  "
argument_list|,
name|reselect
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dump_profile
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|struct
name|profile
modifier|*
name|p
parameter_list|)
block|{
name|printf
argument_list|(
literal|"%s: %10d transfers.\n"
argument_list|,
name|name
argument_list|,
name|p
operator|->
name|num_trans
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s: %10d bytes transferred.\n"
argument_list|,
name|name
argument_list|,
name|p
operator|->
name|num_bytes
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s: %10d disconnects.\n"
argument_list|,
name|name
argument_list|,
name|p
operator|->
name|num_disc
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s: %10d short transfers.\n"
argument_list|,
name|name
argument_list|,
name|p
operator|->
name|num_break
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s: %10d interrupts.\n"
argument_list|,
name|name
argument_list|,
name|p
operator|->
name|num_int
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s: %10d on the fly ints.\n"
argument_list|,
name|name
argument_list|,
name|p
operator|->
name|num_fly
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s: %10d ms setup time.\n"
argument_list|,
name|name
argument_list|,
name|p
operator|->
name|ms_setup
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s: %10d ms data transfer.\n"
argument_list|,
name|name
argument_list|,
name|p
operator|->
name|ms_data
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s: %10d ms disconnected.\n"
argument_list|,
name|name
argument_list|,
name|p
operator|->
name|ms_disc
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s: %10d ms postprocessing.\n"
argument_list|,
name|name
argument_list|,
name|p
operator|->
name|ms_post
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/*================================================================ ** ** **	Write debug info: utilities:     write script registers. ** ** **================================================================ */
end_comment

begin_function
specifier|static
name|void
name|dump_reg
parameter_list|(
name|struct
name|ncr_reg
modifier|*
name|rp
parameter_list|)
block|{
name|u_char
modifier|*
name|reg
init|=
operator|(
name|u_char
operator|*
operator|)
name|rp
decl_stmt|;
define|#
directive|define
name|l
parameter_list|(
name|i
parameter_list|)
value|(reg[i]+(reg[i+1]<<8ul)+(reg[i+2]<<16ul)+(reg[i+3]<<24ul))
name|int
name|ad
decl_stmt|;
name|char
argument_list|*
operator|(
name|phasename
index|[
literal|8
index|]
operator|)
operator|=
block|{
literal|"DATA-OUT"
block|,
literal|"DATA-IN"
block|,
literal|"COMMAND"
block|,
literal|"STATUS"
block|,
literal|"ILG-OUT"
block|,
literal|"ILG-IN"
block|,
literal|"MESSAGE-OUT"
block|,
literal|"MESSAGE-IN"
block|}
argument_list|; 	for
operator|(
name|ad
operator|=
literal|0x00
expr|;
name|ad
operator|<
literal|0x80
expr|;
name|ad
operator|++
operator|)
block|{
switch|switch
condition|(
name|ad
operator|%
literal|16
condition|)
block|{
case|case
literal|0
case|:
name|printf
argument_list|(
literal|"        %02x:\t"
argument_list|,
name|ad
argument_list|)
expr_stmt|;
break|break;
case|case
literal|8
case|:
name|printf
argument_list|(
literal|" :  "
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
block|}
argument_list|;
name|printf
argument_list|(
literal|"%02x"
argument_list|,
name|reg
index|[
name|ad
index|]
argument_list|)
argument_list|; 		if
operator|(
name|ad
operator|%
literal|16
operator|==
literal|15
operator|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
argument_list|;
block|}
end_function

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_expr_stmt
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|printf
argument_list|(
literal|"        DSP  %08x %-20s  CMD %08x DSPS %08x %s\n"
argument_list|,
name|l
argument_list|(
literal|0x2c
argument_list|)
argument_list|,
name|sn
argument_list|(
name|l
argument_list|(
literal|0x2c
argument_list|)
argument_list|)
argument_list|,
name|l
argument_list|(
literal|0x24
argument_list|)
argument_list|,
name|l
argument_list|(
literal|0x30
argument_list|)
argument_list|,
name|sn
argument_list|(
name|l
argument_list|(
literal|0x30
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|printf
argument_list|(
literal|"        TEMP %08x %-20s  DSA %08x\n"
argument_list|,
name|l
argument_list|(
literal|0x1c
argument_list|)
argument_list|,
name|sn
argument_list|(
name|l
argument_list|(
literal|0x1c
argument_list|)
argument_list|)
argument_list|,
name|l
argument_list|(
literal|0x10
argument_list|)
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|printf
argument_list|(
literal|"        Busstatus: "
argument_list|)
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
operator|(
name|reg
index|[
literal|0x0b
index|]
operator|>>
literal|7
operator|)
operator|&
literal|1
condition|)
name|printf
argument_list|(
literal|" Req"
argument_list|)
expr_stmt|;
end_if

begin_if
if|if
condition|(
operator|(
name|reg
index|[
literal|0x0b
index|]
operator|>>
literal|6
operator|)
operator|&
literal|1
condition|)
name|printf
argument_list|(
literal|" Ack"
argument_list|)
expr_stmt|;
end_if

begin_if
if|if
condition|(
operator|(
name|reg
index|[
literal|0x0b
index|]
operator|>>
literal|5
operator|)
operator|&
literal|1
condition|)
name|printf
argument_list|(
literal|" Bsy"
argument_list|)
expr_stmt|;
end_if

begin_if
if|if
condition|(
operator|(
name|reg
index|[
literal|0x0b
index|]
operator|>>
literal|4
operator|)
operator|&
literal|1
condition|)
name|printf
argument_list|(
literal|" Sel"
argument_list|)
expr_stmt|;
end_if

begin_if
if|if
condition|(
operator|(
name|reg
index|[
literal|0x0b
index|]
operator|>>
literal|3
operator|)
operator|&
literal|1
condition|)
name|printf
argument_list|(
literal|" Atn"
argument_list|)
expr_stmt|;
end_if

begin_expr_stmt
name|printf
argument_list|(
literal|" %s\n"
argument_list|,
name|phasename
index|[
name|reg
index|[
literal|0x0b
index|]
operator|&
literal|7
index|]
argument_list|)
expr_stmt|;
end_expr_stmt

begin_escape
end_escape

begin_expr_stmt
name|printf
argument_list|(
literal|"        Dmastatus: "
argument_list|)
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
operator|(
name|reg
index|[
literal|0x0c
index|]
operator|>>
literal|7
operator|)
operator|&
literal|1
condition|)
name|printf
argument_list|(
literal|" FifoEmpty"
argument_list|)
expr_stmt|;
end_if

begin_if
if|if
condition|(
operator|(
name|reg
index|[
literal|0x0c
index|]
operator|>>
literal|6
operator|)
operator|&
literal|1
condition|)
name|printf
argument_list|(
literal|" MasterParityError"
argument_list|)
expr_stmt|;
end_if

begin_if
if|if
condition|(
operator|(
name|reg
index|[
literal|0x0c
index|]
operator|>>
literal|5
operator|)
operator|&
literal|1
condition|)
name|printf
argument_list|(
literal|" BusFault"
argument_list|)
expr_stmt|;
end_if

begin_if
if|if
condition|(
operator|(
name|reg
index|[
literal|0x0c
index|]
operator|>>
literal|4
operator|)
operator|&
literal|1
condition|)
name|printf
argument_list|(
literal|" Aborted"
argument_list|)
expr_stmt|;
end_if

begin_if
if|if
condition|(
operator|(
name|reg
index|[
literal|0x0c
index|]
operator|>>
literal|3
operator|)
operator|&
literal|1
condition|)
name|printf
argument_list|(
literal|" SingleStep"
argument_list|)
expr_stmt|;
end_if

begin_if
if|if
condition|(
operator|(
name|reg
index|[
literal|0x0c
index|]
operator|>>
literal|2
operator|)
operator|&
literal|1
condition|)
name|printf
argument_list|(
literal|" Interrupt"
argument_list|)
expr_stmt|;
end_if

begin_if
if|if
condition|(
operator|(
name|reg
index|[
literal|0x0c
index|]
operator|>>
literal|0
operator|)
operator|&
literal|1
condition|)
name|printf
argument_list|(
literal|" IllegalInstruction"
argument_list|)
expr_stmt|;
end_if

begin_expr_stmt
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|printf
argument_list|(
literal|"        Intstatus: "
argument_list|)
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
operator|(
name|reg
index|[
literal|0x14
index|]
operator|>>
literal|7
operator|)
operator|&
literal|1
condition|)
name|printf
argument_list|(
literal|" Abort"
argument_list|)
expr_stmt|;
end_if

begin_if
if|if
condition|(
operator|(
name|reg
index|[
literal|0x14
index|]
operator|>>
literal|6
operator|)
operator|&
literal|1
condition|)
name|printf
argument_list|(
literal|" SoftwareReset"
argument_list|)
expr_stmt|;
end_if

begin_if
if|if
condition|(
operator|(
name|reg
index|[
literal|0x14
index|]
operator|>>
literal|5
operator|)
operator|&
literal|1
condition|)
name|printf
argument_list|(
literal|" SignalProcess"
argument_list|)
expr_stmt|;
end_if

begin_if
if|if
condition|(
operator|(
name|reg
index|[
literal|0x14
index|]
operator|>>
literal|4
operator|)
operator|&
literal|1
condition|)
name|printf
argument_list|(
literal|" Semaphore"
argument_list|)
expr_stmt|;
end_if

begin_if
if|if
condition|(
operator|(
name|reg
index|[
literal|0x14
index|]
operator|>>
literal|3
operator|)
operator|&
literal|1
condition|)
name|printf
argument_list|(
literal|" Connected"
argument_list|)
expr_stmt|;
end_if

begin_if
if|if
condition|(
operator|(
name|reg
index|[
literal|0x14
index|]
operator|>>
literal|2
operator|)
operator|&
literal|1
condition|)
name|printf
argument_list|(
literal|" IntOnTheFly"
argument_list|)
expr_stmt|;
end_if

begin_if
if|if
condition|(
operator|(
name|reg
index|[
literal|0x14
index|]
operator|>>
literal|1
operator|)
operator|&
literal|1
condition|)
name|printf
argument_list|(
literal|" SCSI-Interrupt"
argument_list|)
expr_stmt|;
end_if

begin_if
if|if
condition|(
operator|(
name|reg
index|[
literal|0x14
index|]
operator|>>
literal|0
operator|)
operator|&
literal|1
condition|)
name|printf
argument_list|(
literal|" DMA-Interrupt"
argument_list|)
expr_stmt|;
end_if

begin_expr_stmt
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|printf
argument_list|(
literal|"        ScsiIstat: "
argument_list|)
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
operator|(
name|reg
index|[
literal|0x42
index|]
operator|>>
literal|7
operator|)
operator|&
literal|1
condition|)
name|printf
argument_list|(
literal|" PhaseMismatch"
argument_list|)
expr_stmt|;
end_if

begin_if
if|if
condition|(
operator|(
name|reg
index|[
literal|0x42
index|]
operator|>>
literal|6
operator|)
operator|&
literal|1
condition|)
name|printf
argument_list|(
literal|" Complete"
argument_list|)
expr_stmt|;
end_if

begin_if
if|if
condition|(
operator|(
name|reg
index|[
literal|0x42
index|]
operator|>>
literal|5
operator|)
operator|&
literal|1
condition|)
name|printf
argument_list|(
literal|" Selected"
argument_list|)
expr_stmt|;
end_if

begin_if
if|if
condition|(
operator|(
name|reg
index|[
literal|0x42
index|]
operator|>>
literal|4
operator|)
operator|&
literal|1
condition|)
name|printf
argument_list|(
literal|" Reselected"
argument_list|)
expr_stmt|;
end_if

begin_if
if|if
condition|(
operator|(
name|reg
index|[
literal|0x42
index|]
operator|>>
literal|3
operator|)
operator|&
literal|1
condition|)
name|printf
argument_list|(
literal|" GrossError"
argument_list|)
expr_stmt|;
end_if

begin_if
if|if
condition|(
operator|(
name|reg
index|[
literal|0x42
index|]
operator|>>
literal|2
operator|)
operator|&
literal|1
condition|)
name|printf
argument_list|(
literal|" UnexpectedDisconnect"
argument_list|)
expr_stmt|;
end_if

begin_if
if|if
condition|(
operator|(
name|reg
index|[
literal|0x42
index|]
operator|>>
literal|1
operator|)
operator|&
literal|1
condition|)
name|printf
argument_list|(
literal|" ScsiReset"
argument_list|)
expr_stmt|;
end_if

begin_if
if|if
condition|(
operator|(
name|reg
index|[
literal|0x42
index|]
operator|>>
literal|0
operator|)
operator|&
literal|1
condition|)
name|printf
argument_list|(
literal|" ParityError"
argument_list|)
expr_stmt|;
end_if

begin_if
if|if
condition|(
operator|(
name|reg
index|[
literal|0x43
index|]
operator|>>
literal|2
operator|)
operator|&
literal|1
condition|)
name|printf
argument_list|(
literal|" SelectionTimeout"
argument_list|)
expr_stmt|;
end_if

begin_if
if|if
condition|(
operator|(
name|reg
index|[
literal|0x43
index|]
operator|>>
literal|1
operator|)
operator|&
literal|1
condition|)
name|printf
argument_list|(
literal|" TimerExpired"
argument_list|)
expr_stmt|;
end_if

begin_if
if|if
condition|(
operator|(
name|reg
index|[
literal|0x43
index|]
operator|>>
literal|0
operator|)
operator|&
literal|1
condition|)
name|printf
argument_list|(
literal|" HandshakeTimeout"
argument_list|)
expr_stmt|;
end_if

begin_expr_stmt
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|printf
argument_list|(
literal|"        ID=%d  DEST-ID=%d  RESEL-ID=%d\n"
argument_list|,
name|reg
index|[
literal|4
index|]
operator|&
literal|7
argument_list|,
name|reg
index|[
literal|6
index|]
operator|&
literal|7
argument_list|,
name|reg
index|[
literal|0xa
index|]
operator|&
literal|7
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_escape
unit|}
end_escape

begin_comment
comment|/*================================================================ ** ** **	Write debug info: utilities:     write header. ** ** **================================================================ */
end_comment

begin_expr_stmt
unit|char
operator|*
name|debug_opt
expr_stmt|;
end_expr_stmt

begin_macro
name|dump_head
argument_list|(
argument|struct head * hp
argument_list|)
end_macro

begin_block
block|{
name|dump_link
argument_list|(
literal|"      launch"
argument_list|,
operator|&
name|hp
operator|->
name|launch
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"       savep: %08x %s\n"
argument_list|,
name|hp
operator|->
name|savep
argument_list|,
name|sn
argument_list|(
operator|(
name|u_long
operator|)
name|hp
operator|->
name|savep
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"          cp: %08x %s\n"
argument_list|,
name|hp
operator|->
name|cp
argument_list|,
name|sn
argument_list|(
operator|(
name|u_long
operator|)
name|hp
operator|->
name|cp
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|strchr
argument_list|(
name|debug_opt
argument_list|,
literal|'y'
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|dump_tstamp
argument_list|(
literal|"   timestamp"
argument_list|,
operator|&
name|hp
operator|->
name|stamp
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
name|printf
argument_list|(
literal|"      status: %x %x %x %x %x %x %x %x\n"
argument_list|,
name|hp
operator|->
name|status
index|[
literal|0
index|]
argument_list|,
name|hp
operator|->
name|status
index|[
literal|1
index|]
argument_list|,
name|hp
operator|->
name|status
index|[
literal|2
index|]
argument_list|,
name|hp
operator|->
name|status
index|[
literal|3
index|]
argument_list|,
name|hp
operator|->
name|status
index|[
literal|4
index|]
argument_list|,
name|hp
operator|->
name|status
index|[
literal|5
index|]
argument_list|,
name|hp
operator|->
name|status
index|[
literal|6
index|]
argument_list|,
name|hp
operator|->
name|status
index|[
literal|7
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_block

begin_escape
end_escape

begin_comment
comment|/*================================================================ ** ** **	Write debug info: utilities:     write ccb. ** ** **================================================================ */
end_comment

begin_function
name|void
name|dump_ccb
parameter_list|(
name|struct
name|ccb
modifier|*
name|cp
parameter_list|,
name|u_long
name|base
parameter_list|)
block|{
name|printf
argument_list|(
literal|"----------------------\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"struct ccb @ %08x:\n"
argument_list|,
name|base
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"----------------------\n"
argument_list|)
expr_stmt|;
name|dump_link
argument_list|(
literal|"        next"
argument_list|,
operator|&
name|cp
operator|->
name|jump_ccb
argument_list|)
expr_stmt|;
name|dump_link
argument_list|(
literal|"        call"
argument_list|,
operator|&
name|cp
operator|->
name|call_tmp
argument_list|)
expr_stmt|;
name|dump_head
argument_list|(
operator|&
name|cp
operator|->
name|phys
operator|.
name|header
argument_list|)
expr_stmt|;
if|if
condition|(
name|strchr
argument_list|(
name|debug_opt
argument_list|,
literal|'s'
argument_list|)
condition|)
block|{
name|dump_table
argument_list|(
literal|" smsg"
argument_list|,
operator|&
name|cp
operator|->
name|phys
operator|.
name|smsg
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|dump_table
argument_list|(
literal|"smsg2"
argument_list|,
operator|&
name|cp
operator|->
name|phys
operator|.
name|smsg2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|dump_table
argument_list|(
literal|"  cmd"
argument_list|,
operator|&
name|cp
operator|->
name|phys
operator|.
name|cmd
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|dump_table
argument_list|(
literal|" data"
argument_list|,
operator|&
name|cp
operator|->
name|phys
operator|.
name|data
index|[
literal|0
index|]
argument_list|,
name|MAX_SCATTER
argument_list|)
expr_stmt|;
name|dump_table
argument_list|(
literal|"sense"
argument_list|,
operator|&
name|cp
operator|->
name|phys
operator|.
name|sense
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
if|if
condition|(
name|strchr
argument_list|(
name|debug_opt
argument_list|,
literal|'a'
argument_list|)
condition|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"    patch[%d]: %08x\n"
argument_list|,
name|i
argument_list|,
name|cp
operator|->
name|patch
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
if|if
condition|(
name|strchr
argument_list|(
name|debug_opt
argument_list|,
literal|'x'
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"        xfer: -- dump not yet implemented.\n"
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
if|if
condition|(
name|strchr
argument_list|(
name|debug_opt
argument_list|,
literal|'m'
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"        smsg:"
argument_list|)
expr_stmt|;
name|printm
argument_list|(
name|cp
operator|->
name|scsi_smsg
argument_list|,
name|cp
operator|->
name|phys
operator|.
name|smsg
operator|.
name|size
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"       smsg2:"
argument_list|)
expr_stmt|;
name|printm
argument_list|(
name|cp
operator|->
name|scsi_smsg2
argument_list|,
name|cp
operator|->
name|phys
operator|.
name|smsg2
operator|.
name|size
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
name|printf
argument_list|(
literal|"       magic: %x\n"
argument_list|,
name|cp
operator|->
name|magic
argument_list|)
expr_stmt|;
if|if
condition|(
name|cp
operator|->
name|tlimit
condition|)
name|printf
argument_list|(
literal|"  timeout at: %s"
argument_list|,
name|ctime
argument_list|(
operator|(
name|time_t
operator|*
operator|)
operator|&
name|cp
operator|->
name|tlimit
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    link_ccb: %08x\n"
argument_list|,
operator|(
name|u_long
operator|)
name|cp
operator|->
name|link_ccb
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    next_ccb: %08x\n"
argument_list|,
operator|(
name|u_long
operator|)
name|cp
operator|->
name|next_ccb
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"         tag: %d\n"
argument_list|,
name|cp
operator|->
name|tag
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/*================================================================ ** ** **	Write debug info:	struct lcb ** ** **================================================================ */
end_comment

begin_function
specifier|static
name|void
name|dump_lcb
parameter_list|(
name|u_long
name|base
parameter_list|)
block|{
name|struct
name|lcb
name|l
decl_stmt|;
name|struct
name|ccb
name|c
decl_stmt|;
name|u_long
name|cp
decl_stmt|,
name|cn
decl_stmt|;
name|printf
argument_list|(
literal|"----------------------\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"struct lcb @ %08x:\n"
argument_list|,
name|base
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"----------------------\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|KVM_READ
argument_list|(
name|base
argument_list|,
operator|&
name|l
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|lcb
argument_list|)
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: bad kvm read.\n"
argument_list|,
name|prog
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
name|printf
argument_list|(
literal|"     reqccbs: %d\n"
argument_list|,
name|l
operator|.
name|reqccbs
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"     actccbs: %d\n"
argument_list|,
name|l
operator|.
name|actccbs
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"     reqlink: %d\n"
argument_list|,
name|l
operator|.
name|reqlink
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"     actlink: %d\n"
argument_list|,
name|l
operator|.
name|actlink
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"     usetags: %d\n"
argument_list|,
name|l
operator|.
name|usetags
argument_list|)
expr_stmt|;
name|dump_link
argument_list|(
literal|"    jump_lcb"
argument_list|,
operator|&
name|l
operator|.
name|jump_lcb
argument_list|)
expr_stmt|;
name|dump_link
argument_list|(
literal|"    call_tag"
argument_list|,
operator|&
name|l
operator|.
name|call_tag
argument_list|)
expr_stmt|;
name|dump_link
argument_list|(
literal|"    jump_ccb"
argument_list|,
operator|&
name|l
operator|.
name|jump_ccb
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|cp
operator|=
operator|(
name|u_long
operator|)
name|l
operator|.
name|next_ccb
expr_stmt|;
name|cn
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|cp
condition|)
block|{
name|cn
operator|++
expr_stmt|;
name|printf
argument_list|(
literal|"ccb #%d:\n"
argument_list|,
name|cn
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|KVM_READ
argument_list|(
name|cp
argument_list|,
operator|&
name|c
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ccb
argument_list|)
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: bad kvm read.\n"
argument_list|,
name|prog
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
name|dump_ccb
argument_list|(
operator|&
name|c
argument_list|,
name|cp
argument_list|)
expr_stmt|;
name|cp
operator|=
operator|(
name|u_long
operator|)
name|c
operator|.
name|next_ccb
expr_stmt|;
block|}
empty_stmt|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/*================================================================ ** ** **	Write debug info:	struct tcb ** ** **================================================================ */
end_comment

begin_function
specifier|static
name|void
name|dump_tip
parameter_list|(
name|struct
name|tcb
modifier|*
name|tip
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|u_long
name|lp
decl_stmt|;
name|printf
argument_list|(
literal|"----------------------\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"struct tcb:\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"----------------------\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"   transfers:%10d.\n"
argument_list|,
name|tip
operator|->
name|transfers
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"       bytes:%10d.\n"
argument_list|,
name|tip
operator|->
name|bytes
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" user limits: usrsync=%d  usrwide=%d  usrtags=%d.\n"
argument_list|,
name|tip
operator|->
name|usrsync
argument_list|,
name|tip
operator|->
name|usrwide
argument_list|,
name|tip
operator|->
name|usrtags
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"        sync: minsync=%d, maxoffs=%d, period=%d ns, sval=%x.\n"
argument_list|,
name|tip
operator|->
name|minsync
argument_list|,
name|tip
operator|->
name|maxoffs
argument_list|,
name|tip
operator|->
name|period
argument_list|,
name|tip
operator|->
name|sval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"	wide: widedone=%d, wval=%x.\n"
argument_list|,
name|tip
operator|->
name|widedone
argument_list|,
name|tip
operator|->
name|wval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"     hold_cp: %x\n"
argument_list|,
name|tip
operator|->
name|hold_cp
argument_list|)
expr_stmt|;
name|dump_link
argument_list|(
literal|"    jump_tcb"
argument_list|,
operator|&
name|tip
operator|->
name|jump_tcb
argument_list|)
expr_stmt|;
name|dump_link
argument_list|(
literal|"    call_lun"
argument_list|,
operator|&
name|tip
operator|->
name|call_lun
argument_list|)
expr_stmt|;
name|dump_link
argument_list|(
literal|"    jump_lcb"
argument_list|,
operator|&
name|tip
operator|->
name|jump_lcb
argument_list|)
expr_stmt|;
if|if
condition|(
name|tip
operator|->
name|hold_cp
condition|)
name|printf
argument_list|(
literal|"     hold_cp: @ %x\n"
argument_list|,
name|tip
operator|->
name|hold_cp
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|strchr
argument_list|(
name|debug_opt
argument_list|,
literal|'l'
argument_list|)
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_LUN
condition|;
name|i
operator|++
control|)
block|{
name|lp
operator|=
operator|(
name|u_long
operator|)
name|tip
operator|->
name|lp
index|[
name|i
index|]
expr_stmt|;
name|printf
argument_list|(
literal|"logic unit #%d:\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|lp
condition|)
name|dump_lcb
argument_list|(
name|lp
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
block|}
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/*================================================================ ** ** **	Write debug info:	struct ncb ** ** **================================================================ */
end_comment

begin_function
specifier|static
name|void
name|dump_ncr
parameter_list|(
name|void
parameter_list|)
block|{
name|u_long
name|tp
decl_stmt|;
name|int
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"----------------------\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"struct ncb @ %x:\n"
argument_list|,
name|ncr_base
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"----------------------\n"
argument_list|)
expr_stmt|;
name|dump_link
argument_list|(
literal|"    jump_tcb"
argument_list|,
operator|&
name|ncr
operator|.
name|jump_tcb
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    register: @ %x (p=%x)\n"
argument_list|,
name|ncr
operator|.
name|vaddr
argument_list|,
name|ncr
operator|.
name|paddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|wizard
operator|&&
name|strchr
argument_list|(
name|debug_opt
argument_list|,
literal|'r'
argument_list|)
condition|)
block|{
name|struct
name|ncr_reg
name|reg
decl_stmt|;
if|if
condition|(
operator|!
name|KVM_READ
argument_list|(
name|ncr
operator|.
name|vaddr
argument_list|,
operator|&
name|reg
argument_list|,
sizeof|sizeof
argument_list|(
name|reg
argument_list|)
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: bad kvm read.\n"
argument_list|,
name|prog
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|dump_reg
argument_list|(
operator|&
name|reg
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
name|printf
argument_list|(
literal|"      script: @ %x (p=%x)\n"
argument_list|,
name|ncr
operator|.
name|script
argument_list|,
name|ncr
operator|.
name|p_script
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"hostscsiaddr: %d\n"
argument_list|,
name|ncr
operator|.
name|myaddr
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"     minsync: %d\n"
argument_list|,
name|ncr
operator|.
name|minsync
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"      scntl3: 0x%02x\n"
argument_list|,
name|ncr
operator|.
name|rv_scntl3
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
comment|/* sc_link not dumped */
if|if
condition|(
name|strchr
argument_list|(
name|debug_opt
argument_list|,
literal|'u'
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"     usercmd: cmd=%x data=%x target=%x lun=%x\n"
argument_list|,
name|ncr
operator|.
name|user
operator|.
name|cmd
argument_list|,
name|ncr
operator|.
name|user
operator|.
name|data
argument_list|,
name|ncr
operator|.
name|user
operator|.
name|target
argument_list|,
name|ncr
operator|.
name|user
operator|.
name|lun
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
name|printf
argument_list|(
literal|"     actccbs: %d\n"
argument_list|,
name|ncr
operator|.
name|actccbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|strchr
argument_list|(
name|debug_opt
argument_list|,
literal|'q'
argument_list|)
condition|)
block|{
name|u_long
name|startpos
decl_stmt|;
if|if
condition|(
operator|!
name|KVM_READ
argument_list|(
operator|(
operator|(
name|u_long
operator|)
name|ncr
operator|.
name|script
operator|+
name|offsetof
argument_list|(
expr|struct
name|script
argument_list|,
name|startpos
argument_list|)
operator|)
argument_list|,
operator|&
name|startpos
argument_list|,
sizeof|sizeof
argument_list|(
name|startpos
argument_list|)
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: bad kvm read.\n"
argument_list|,
name|prog
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
name|printf
argument_list|(
literal|"    startpos: %x\n"
argument_list|,
name|startpos
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"        slot: %d\n"
argument_list|,
operator|(
name|startpos
operator|-
operator|(
name|ncr
operator|.
name|p_script
operator|+
name|offsetof
argument_list|(
expr|struct
name|scripth
argument_list|,
name|tryloop
argument_list|)
operator|)
operator|)
operator|/
literal|20
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    squeuput: %d\n"
argument_list|,
name|ncr
operator|.
name|squeueput
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_START
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"%12d: %08x %s\n"
argument_list|,
name|i
argument_list|,
name|ncr
operator|.
name|squeue
index|[
name|i
index|]
argument_list|,
name|sn
argument_list|(
name|ncr
operator|.
name|squeue
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
name|printf
argument_list|(
literal|"       ticks: %d ms\n"
argument_list|,
name|ncr
operator|.
name|ticks
operator|*
literal|10
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"   heartbeat: %s"
argument_list|,
name|ctime
argument_list|(
operator|(
name|time_t
operator|*
operator|)
operator|&
name|ncr
operator|.
name|heartbeat
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    lasttime: %s"
argument_list|,
name|ctime
argument_list|(
operator|(
name|time_t
operator|*
operator|)
operator|&
name|ncr
operator|.
name|lasttime
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wizard
operator|&&
name|strchr
argument_list|(
name|debug_opt
argument_list|,
literal|'d'
argument_list|)
operator|&&
name|ncr
operator|.
name|regtime
operator|.
name|tv_sec
condition|)
block|{
name|printf
argument_list|(
literal|"     regdump: %s"
argument_list|,
name|ctime
argument_list|(
operator|&
name|ncr
operator|.
name|regtime
operator|.
name|tv_sec
argument_list|)
argument_list|)
expr_stmt|;
name|dump_reg
argument_list|(
operator|&
name|ncr
operator|.
name|regdump
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
if|if
condition|(
name|strchr
argument_list|(
name|debug_opt
argument_list|,
literal|'p'
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|dump_profile
argument_list|(
literal|"     profile"
argument_list|,
operator|&
name|ncr
operator|.
name|profile
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
if|if
condition|(
name|strchr
argument_list|(
name|debug_opt
argument_list|,
literal|'h'
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|dump_head
argument_list|(
operator|&
name|ncr
operator|.
name|header
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
if|if
condition|(
name|strchr
argument_list|(
name|debug_opt
argument_list|,
literal|'c'
argument_list|)
condition|)
block|{
name|dump_ccb
argument_list|(
name|ncr
operator|.
name|ccb
argument_list|,
name|ncr_base
operator|+
name|offsetof
argument_list|(
expr|struct
name|ncb
argument_list|,
name|ccb
argument_list|)
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
if|if
condition|(
name|strchr
argument_list|(
name|debug_opt
argument_list|,
literal|'m'
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"      msgout:"
argument_list|)
expr_stmt|;
name|printm
argument_list|(
name|ncr
operator|.
name|msgout
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"      msg in:"
argument_list|)
expr_stmt|;
name|printm
argument_list|(
name|ncr
operator|.
name|msgin
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
if|if
condition|(
name|strchr
argument_list|(
name|debug_opt
argument_list|,
literal|'t'
argument_list|)
condition|)
block|{
name|struct
name|tcb
modifier|*
name|tip
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_TARGET
condition|;
name|i
operator|++
control|)
block|{
name|tip
operator|=
operator|&
name|ncr
operator|.
name|target
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
operator|!
name|tip
operator|->
name|jump_tcb
operator|.
name|l_cmd
condition|)
continue|continue;
name|printf
argument_list|(
literal|"target #%d:\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|dump_tip
argument_list|(
name|tip
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/*================================================================ ** ** **	D O _ D E B U G ** ** **================================================================ */
end_comment

begin_macro
name|do_debug
argument_list|(
argument|char * arg
argument_list|)
end_macro

begin_block
block|{
name|open_kvm
argument_list|(
name|O_RDONLY
argument_list|)
expr_stmt|;
name|debug_opt
operator|=
name|arg
expr_stmt|;
if|if
condition|(
name|strchr
argument_list|(
name|debug_opt
argument_list|,
literal|'?'
argument_list|)
condition|)
name|printf
argument_list|(
literal|"'?': list debug options [sic].\n"
literal|"'a': show patchfields in ccbs (requires c).\n"
literal|"'c': show ccbs.\n"
literal|"'d': show register dump.\n"
literal|"'h': show header information.\n"
literal|"'m': show message buffers.\n"
literal|"'n': show ncr main control block.\n"
literal|"'p': show profiling information.\n"
literal|"'q': show start queue.\n"
literal|"'r': show registers (*DANGEROUS*).\n"
literal|"'s': show scatter/gather info.\n"
literal|"'t': show target control blocks.\n"
literal|"'u': show user cmd field.\n"
literal|"'x': show generic xfer structure.\n"
literal|"'y': show timestamps.\n"
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|strchr
argument_list|(
name|debug_opt
argument_list|,
literal|'n'
argument_list|)
condition|)
name|dump_ncr
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|wizard
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: You are NOT a wizard!\n"
argument_list|,
name|prog
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
if|if
condition|(
name|strchr
argument_list|(
name|debug_opt
argument_list|,
literal|'r'
argument_list|)
condition|)
block|{
name|struct
name|ncr_reg
name|reg
decl_stmt|;
if|if
condition|(
operator|!
name|KVM_READ
argument_list|(
name|ncr
operator|.
name|vaddr
argument_list|,
operator|&
name|reg
argument_list|,
sizeof|sizeof
argument_list|(
name|reg
argument_list|)
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: bad kvm read.\n"
argument_list|,
name|prog
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
name|dump_reg
argument_list|(
operator|&
name|reg
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
block|}
end_block

begin_escape
end_escape

begin_comment
comment|/*================================================================ ** ** **	Main function ** ** **================================================================ */
end_comment

begin_function
name|void
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
specifier|extern
name|char
modifier|*
name|optarg
decl_stmt|;
specifier|extern
name|int
name|optind
decl_stmt|;
name|int
name|usage
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|charp
decl_stmt|;
name|int
name|ch
decl_stmt|,
name|getopt
argument_list|()
decl_stmt|,
name|atoi
argument_list|()
decl_stmt|;
name|int
name|i
decl_stmt|,
name|step
decl_stmt|;
name|prog
operator|=
operator|*
name|argv
expr_stmt|;
while|while
condition|(
operator|(
name|ch
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"M:N:u:f:t:l:p:s:k:d:vwhin:?"
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
switch|switch
condition|(
operator|(
name|char
operator|)
name|ch
condition|)
block|{
case|case
literal|'M'
case|:
if|if
condition|(
name|kvm_isopen
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: -M: kernel file already open.\n"
argument_list|,
name|prog
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
name|kmemf
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'N'
case|:
if|if
condition|(
name|kvm_isopen
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: -N: symbol table already open.\n"
argument_list|,
name|prog
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
name|vmunix
operator|=
name|optarg
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|OPT_F
case|case
literal|'f'
case|:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: -f: option not yet implemented.\n"
argument_list|,
name|prog
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
endif|#
directive|endif
case|case
literal|'u'
case|:
name|i
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
operator|&
name|charp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|optarg
operator|||
operator|*
name|charp
operator|||
operator|(
name|i
operator|<
literal|0
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: bad unit number \"%s\".\n"
argument_list|,
name|prog
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|ncr_unit
operator|=
name|i
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
name|i
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
operator|&
name|charp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|optarg
operator|||
operator|*
name|charp
operator|||
operator|(
name|i
operator|<
literal|0
operator|)
operator|||
operator|(
name|i
operator|>=
name|MAX_TARGET
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: bad target number \"%s\" (valid range: 0-%d).\n"
argument_list|,
name|prog
argument_list|,
name|optarg
argument_list|,
name|MAX_TARGET
operator|-
literal|1
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|target_mask
operator||=
literal|1ul
operator|<<
name|i
expr_stmt|;
break|break;
case|case
literal|'n'
case|:
name|open_kvm
argument_list|(
name|O_RDONLY
argument_list|)
expr_stmt|;
name|i
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
operator|&
name|charp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"addr %d (0x%x) has label %s.\n"
argument_list|,
name|i
argument_list|,
name|i
argument_list|,
name|sn
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
name|i
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
operator|&
name|charp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|optarg
operator|||
operator|*
name|charp
operator|||
operator|(
name|i
operator|<
literal|0
operator|)
operator|||
operator|(
name|i
operator|>=
name|MAX_LUN
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: bad logic unit number \"%s\" (valid range: 0-%d).\n"
argument_list|,
name|prog
argument_list|,
name|optarg
argument_list|,
name|MAX_LUN
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|global_lun_mask
operator||=
literal|1ul
operator|<<
name|i
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
name|i
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
operator|&
name|charp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|optarg
operator|||
operator|*
name|charp
operator|||
operator|(
name|i
operator|<
literal|1
operator|)
operator|||
operator|(
name|i
operator|>
literal|60
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: bad interval \"%s\".\n"
argument_list|,
name|prog
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|interval
operator|=
name|i
expr_stmt|;
name|do_profile
argument_list|()
expr_stmt|;
break|break;
case|case
literal|'w'
case|:
if|if
condition|(
name|geteuid
argument_list|()
operator|==
literal|0
condition|)
name|wizard
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'v'
case|:
name|verbose
operator|++
expr_stmt|;
break|break;
case|case
literal|'i'
case|:
name|do_info
argument_list|()
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
name|do_set
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
name|do_debug
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'k'
case|:
name|do_kill
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'h'
case|:
case|case
literal|'?'
case|:
name|usage
operator|++
expr_stmt|;
break|break;
default|default:
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: illegal option \"%c\".\n"
argument_list|,
name|prog
argument_list|,
name|ch
argument_list|)
expr_stmt|;
name|usage
operator|++
expr_stmt|;
block|}
name|argv
operator|+=
name|optind
expr_stmt|;
name|argc
operator|-=
name|optind
expr_stmt|;
if|if
condition|(
name|argc
condition|)
name|printf
argument_list|(
literal|"%s: rest of line starting with \"%s\" ignored.\n"
argument_list|,
name|prog
argument_list|,
operator|*
name|argv
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
operator|&&
operator|!
name|kvm_isopen
condition|)
name|usage
operator|++
expr_stmt|;
if|if
condition|(
name|usage
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Usage:\n"
literal|"\n"
literal|"%s [-M$] [-N$] [-u] {-t#} {-l#} [-hivw?] [-d$] [-s$] [-k] [[-p]<time>]\n"
literal|"\n"
literal|"-u<#>             select controller number\n"
literal|"-t<#>             select target number\n"
literal|"-l<#>             select lun number\n"
literal|"-i                 get info\n"
literal|"-v                 verbose\n"
literal|"-p<seconds>       performance data\n"
literal|"\n"
literal|"Wizards only (proceed on your own risk):\n"
literal|"-n<#>             get the name for address #\n"
literal|"-w                 wizard mode\n"
literal|"-d<options>       debug info\n"
literal|"-d?                list debug options\n"
literal|"-s<param=value>   set parameter\n"
literal|"-s?                list parameters\n"
literal|"-k<torture>       torture driver by simulating errors\n"
literal|"-k?                list tortures\n"
literal|"-M<kernelimage>   (default: %s)\n"
literal|"-N<symboltable>   (default: %s)\n"
argument_list|,
name|prog
argument_list|,
name|_PATH_KMEM
argument_list|,
if|#
directive|if
operator|(
name|__FreeBSD__
operator|>=
literal|2
operator|)
name|getbootfile
argument_list|()
else|#
directive|else
name|_PATH_UNIX
endif|#
directive|endif
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
name|ident
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|kvm_isopen
condition|)
block|{
name|do_info
argument_list|()
expr_stmt|;
name|do_profile
argument_list|()
expr_stmt|;
block|}
empty_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1999 Hellmuth Michaelis. All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  *---------------------------------------------------------------------------  *  *	i4b daemon - curses fullscreen output  *	-------------------------------------  *  *	$Id: curses.c,v 1.10 1999/12/13 21:25:25 hm Exp $   *  * $FreeBSD$  *  *      last edit-date: [Mon Dec 13 21:51:47 1999]  *  *---------------------------------------------------------------------------*/
end_comment

begin_include
include|#
directive|include
file|"monprivate.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|WIN32
end_ifndef

begin_function_decl
specifier|static
name|void
name|display_bell
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|display_chans
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*---------------------------------------------------------------------------*  *	program exit  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|do_exit
parameter_list|(
name|int
name|exitval
parameter_list|)
block|{
if|if
condition|(
name|curses_ready
condition|)
name|endwin
argument_list|()
expr_stmt|;
name|exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	init curses fullscreen display  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|init_screen
parameter_list|(
name|void
parameter_list|)
block|{
name|char
name|buffer
index|[
literal|512
index|]
decl_stmt|;
name|int
name|uheight
decl_stmt|,
name|lheight
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|initscr
argument_list|()
expr_stmt|;
comment|/* curses init */
if|if
condition|(
operator|(
name|COLS
operator|<
literal|80
operator|)
operator|||
operator|(
name|LINES
operator|<
literal|24
operator|)
condition|)
block|{
name|endwin
argument_list|()
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ERROR, minimal screensize must be 80x24, is %dx%d, terminating!"
argument_list|,
name|COLS
argument_list|,
name|LINES
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|noecho
argument_list|()
expr_stmt|;
name|raw
argument_list|()
expr_stmt|;
name|uheight
operator|=
name|nctrl
operator|*
literal|2
expr_stmt|;
comment|/* cards * b-channels */
name|lheight
operator|=
name|LINES
operator|-
name|uheight
operator|-
literal|6
operator|+
literal|1
expr_stmt|;
comment|/* rest of display */
if|if
condition|(
operator|(
name|upper_w
operator|=
name|newwin
argument_list|(
name|uheight
argument_list|,
name|COLS
argument_list|,
name|UPPER_B
argument_list|,
literal|0
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|endwin
argument_list|()
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ERROR, curses init upper window, terminating!"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|mid_w
operator|=
name|newwin
argument_list|(
literal|1
argument_list|,
name|COLS
argument_list|,
name|UPPER_B
operator|+
name|uheight
operator|+
literal|1
argument_list|,
literal|0
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|endwin
argument_list|()
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ERROR, curses init mid window, terminating!"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|lower_w
operator|=
name|newwin
argument_list|(
name|lheight
argument_list|,
name|COLS
argument_list|,
name|UPPER_B
operator|+
name|uheight
operator|+
literal|3
argument_list|,
literal|0
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|endwin
argument_list|()
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ERROR, curses init lower window, LINES = %d, lheight = %d, uheight = %d, terminating!"
argument_list|,
name|LINES
argument_list|,
name|lheight
argument_list|,
name|uheight
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|scrollok
argument_list|(
name|lower_w
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"----- isdn controller channel state ------------- isdnmonitor %02d.%02d.%d -"
argument_list|,
name|VERSION
argument_list|,
name|REL
argument_list|,
name|STEP
argument_list|)
expr_stmt|;
while|while
condition|(
name|strlen
argument_list|(
name|buffer
argument_list|)
operator|<
name|COLS
condition|)
name|strcat
argument_list|(
name|buffer
argument_list|,
literal|"-"
argument_list|)
expr_stmt|;
name|move
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|standout
argument_list|()
expr_stmt|;
name|addstr
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
name|standend
argument_list|()
expr_stmt|;
name|move
argument_list|(
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/*      01234567890123456789012345678901234567890123456789012345678901234567890123456789 */
name|addstr
argument_list|(
literal|"c tei b remote                 iface  dir outbytes   obps inbytes    ibps  units"
argument_list|)
expr_stmt|;
if|if
condition|(
name|hostname
condition|)
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"----- isdn userland interface state ------------- %s:%d -"
argument_list|,
name|hostname
argument_list|,
name|portno
argument_list|)
expr_stmt|;
else|else
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"----- isdn userland interface state ------------- %s -"
argument_list|,
name|sockpath
argument_list|)
expr_stmt|;
while|while
condition|(
name|strlen
argument_list|(
name|buffer
argument_list|)
operator|<
name|COLS
condition|)
name|strcat
argument_list|(
name|buffer
argument_list|,
literal|"-"
argument_list|)
expr_stmt|;
name|move
argument_list|(
name|uheight
operator|+
literal|2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|standout
argument_list|()
expr_stmt|;
name|addstr
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
name|standend
argument_list|()
expr_stmt|;
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"----- isdnd logfile display --------------------------------------------------"
argument_list|)
expr_stmt|;
while|while
condition|(
name|strlen
argument_list|(
name|buffer
argument_list|)
operator|<
name|COLS
condition|)
name|strcat
argument_list|(
name|buffer
argument_list|,
literal|"-"
argument_list|)
expr_stmt|;
name|move
argument_list|(
name|uheight
operator|+
literal|4
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|standout
argument_list|()
expr_stmt|;
name|addstr
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
name|standend
argument_list|()
expr_stmt|;
name|refresh
argument_list|()
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|j
operator|=
literal|0
init|;
name|i
operator|<=
name|nctrl
condition|;
name|i
operator|++
operator|,
name|j
operator|+=
literal|2
control|)
block|{
name|mvwprintw
argument_list|(
name|upper_w
argument_list|,
name|j
argument_list|,
name|H_CNTL
argument_list|,
literal|"%d --- 1 "
argument_list|,
name|i
argument_list|)
expr_stmt|;
comment|/*TEI*/
name|mvwprintw
argument_list|(
name|upper_w
argument_list|,
name|j
operator|+
literal|1
argument_list|,
name|H_CNTL
argument_list|,
literal|"  L12 2 "
argument_list|)
expr_stmt|;
block|}
name|wrefresh
argument_list|(
name|upper_w
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|NOTDEF
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|j
operator|=
literal|0
init|;
name|i
operator|<
name|nentries
condition|;
name|i
operator|++
control|)
comment|/* walk thru all entries */
block|{
name|p
operator|=
operator|&
name|cfg_entry_tab
index|[
name|i
index|]
expr_stmt|;
comment|/* get ptr to enry */
name|mvwprintw
argument_list|(
name|mid_w
argument_list|,
literal|0
argument_list|,
name|j
argument_list|,
literal|"%s%d "
argument_list|,
name|bdrivername
argument_list|(
name|p
operator|->
name|usrdevicename
argument_list|)
argument_list|,
name|p
operator|->
name|usrdeviceunit
argument_list|)
expr_stmt|;
name|p
operator|->
name|fs_position
operator|=
name|j
expr_stmt|;
name|j
operator|+=
operator|(
operator|(
name|strlen
argument_list|(
name|bdrivername
argument_list|(
name|p
operator|->
name|usrdevicename
argument_list|)
argument_list|)
operator|+
operator|(
name|p
operator|->
name|usrdeviceunit
operator|>
literal|9
condition|?
literal|2
else|:
literal|1
operator|)
operator|+
literal|1
operator|)
operator|)
expr_stmt|;
block|}
else|#
directive|else
name|mvwprintw
argument_list|(
name|mid_w
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|"%s"
argument_list|,
name|devbuf
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|wrefresh
argument_list|(
name|mid_w
argument_list|)
expr_stmt|;
name|wmove
argument_list|(
name|lower_w
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wrefresh
argument_list|(
name|lower_w
argument_list|)
expr_stmt|;
name|curses_ready
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	display the charge in units  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|display_charge
parameter_list|(
name|int
name|pos
parameter_list|,
name|int
name|charge
parameter_list|)
block|{
name|mvwprintw
argument_list|(
name|upper_w
argument_list|,
name|pos
argument_list|,
name|H_UNITS
argument_list|,
literal|"%d"
argument_list|,
name|charge
argument_list|)
expr_stmt|;
name|wclrtoeol
argument_list|(
name|upper_w
argument_list|)
expr_stmt|;
name|wrefresh
argument_list|(
name|upper_w
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	display the calculated charge in units  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|display_ccharge
parameter_list|(
name|int
name|pos
parameter_list|,
name|int
name|units
parameter_list|)
block|{
name|mvwprintw
argument_list|(
name|upper_w
argument_list|,
name|pos
argument_list|,
name|H_UNITS
argument_list|,
literal|"(%d)"
argument_list|,
name|units
argument_list|)
expr_stmt|;
name|wclrtoeol
argument_list|(
name|upper_w
argument_list|)
expr_stmt|;
name|wrefresh
argument_list|(
name|upper_w
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	display accounting information  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|display_acct
parameter_list|(
name|int
name|pos
parameter_list|,
name|int
name|obyte
parameter_list|,
name|int
name|obps
parameter_list|,
name|int
name|ibyte
parameter_list|,
name|int
name|ibps
parameter_list|)
block|{
name|mvwprintw
argument_list|(
name|upper_w
argument_list|,
name|pos
argument_list|,
name|H_OUT
argument_list|,
literal|"%-10d"
argument_list|,
name|obyte
argument_list|)
expr_stmt|;
name|mvwprintw
argument_list|(
name|upper_w
argument_list|,
name|pos
argument_list|,
name|H_OUTBPS
argument_list|,
literal|"%-4d"
argument_list|,
name|obps
argument_list|)
expr_stmt|;
name|mvwprintw
argument_list|(
name|upper_w
argument_list|,
name|pos
argument_list|,
name|H_IN
argument_list|,
literal|"%-10d"
argument_list|,
name|ibyte
argument_list|)
expr_stmt|;
name|mvwprintw
argument_list|(
name|upper_w
argument_list|,
name|pos
argument_list|,
name|H_INBPS
argument_list|,
literal|"%-4d"
argument_list|,
name|ibps
argument_list|)
expr_stmt|;
name|wrefresh
argument_list|(
name|upper_w
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	erase line at disconnect time  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|display_disconnect
parameter_list|(
name|int
name|pos
parameter_list|)
block|{
name|wmove
argument_list|(
name|upper_w
argument_list|,
name|pos
argument_list|,
name|H_TELN
argument_list|)
expr_stmt|;
name|wclrtoeol
argument_list|(
name|upper_w
argument_list|)
expr_stmt|;
name|wrefresh
argument_list|(
name|upper_w
argument_list|)
expr_stmt|;
if|if
condition|(
name|do_bell
condition|)
name|display_bell
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	display interface up/down information  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|display_updown
parameter_list|(
name|int
name|pos
parameter_list|,
name|int
name|updown
parameter_list|,
name|char
modifier|*
name|device
parameter_list|)
block|{
if|if
condition|(
name|updown
condition|)
name|wstandend
argument_list|(
name|mid_w
argument_list|)
expr_stmt|;
else|else
name|wstandout
argument_list|(
name|mid_w
argument_list|)
expr_stmt|;
name|mvwprintw
argument_list|(
name|mid_w
argument_list|,
literal|0
argument_list|,
name|pos
argument_list|,
literal|"%s "
argument_list|,
name|device
argument_list|)
expr_stmt|;
name|wstandend
argument_list|(
name|mid_w
argument_list|)
expr_stmt|;
name|wrefresh
argument_list|(
name|mid_w
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	display interface up/down information  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|display_l12stat
parameter_list|(
name|int
name|controller
parameter_list|,
name|int
name|layer
parameter_list|,
name|int
name|state
parameter_list|)
block|{
if|if
condition|(
name|controller
operator|>
name|nctrl
condition|)
return|return;
if|if
condition|(
operator|!
operator|(
name|layer
operator|==
literal|1
operator|||
name|layer
operator|==
literal|2
operator|)
condition|)
return|return;
if|if
condition|(
name|state
condition|)
name|wstandout
argument_list|(
name|upper_w
argument_list|)
expr_stmt|;
else|else
name|wstandend
argument_list|(
name|upper_w
argument_list|)
expr_stmt|;
if|if
condition|(
name|layer
operator|==
literal|1
condition|)
block|{
name|mvwprintw
argument_list|(
name|upper_w
argument_list|,
operator|(
name|controller
operator|*
literal|2
operator|)
operator|+
literal|1
argument_list|,
name|H_TEI
operator|+
literal|1
argument_list|,
literal|"1"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|state
condition|)
name|mvwprintw
argument_list|(
name|upper_w
argument_list|,
operator|(
name|controller
operator|*
literal|2
operator|)
operator|+
literal|1
argument_list|,
name|H_TEI
operator|+
literal|2
argument_list|,
literal|"2"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|layer
operator|==
literal|2
condition|)
block|{
name|mvwprintw
argument_list|(
name|upper_w
argument_list|,
operator|(
name|controller
operator|*
literal|2
operator|)
operator|+
literal|1
argument_list|,
name|H_TEI
operator|+
literal|2
argument_list|,
literal|"2"
argument_list|)
expr_stmt|;
if|if
condition|(
name|state
condition|)
name|mvwprintw
argument_list|(
name|upper_w
argument_list|,
operator|(
name|controller
operator|*
literal|2
operator|)
operator|+
literal|1
argument_list|,
name|H_TEI
operator|+
literal|1
argument_list|,
literal|"1"
argument_list|)
expr_stmt|;
block|}
name|wstandend
argument_list|(
name|upper_w
argument_list|)
expr_stmt|;
name|wrefresh
argument_list|(
name|upper_w
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	display TEI  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|display_tei
parameter_list|(
name|int
name|controller
parameter_list|,
name|int
name|tei
parameter_list|)
block|{
if|if
condition|(
name|controller
operator|>
name|nctrl
condition|)
return|return;
if|if
condition|(
name|tei
operator|==
operator|-
literal|1
condition|)
name|mvwprintw
argument_list|(
name|upper_w
argument_list|,
name|controller
operator|*
literal|2
argument_list|,
name|H_TEI
argument_list|,
literal|"---"
argument_list|)
expr_stmt|;
else|else
name|mvwprintw
argument_list|(
name|upper_w
argument_list|,
name|controller
operator|*
literal|2
argument_list|,
name|H_TEI
argument_list|,
literal|"%3d"
argument_list|,
name|tei
argument_list|)
expr_stmt|;
name|wrefresh
argument_list|(
name|upper_w
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	display bell :-)  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|display_bell
parameter_list|(
name|void
parameter_list|)
block|{
specifier|static
name|char
name|bell
index|[
literal|1
index|]
init|=
block|{
literal|0x07
block|}
decl_stmt|;
name|write
argument_list|(
name|STDOUT_FILENO
argument_list|,
operator|&
name|bell
index|[
literal|0
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	curses menu for fullscreen command mode  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|do_menu
parameter_list|(
name|void
parameter_list|)
block|{
specifier|static
name|char
modifier|*
name|menu
index|[
name|WMITEMS
index|]
init|=
block|{
literal|"1 - (D)isplay refresh"
block|,
literal|"2 - (H)angup (choose a channel)"
block|,
literal|"3 - (R)eread config file"
block|,
literal|"4 - (Q)uit the program"
block|,		 	}
decl_stmt|;
name|WINDOW
modifier|*
name|menu_w
decl_stmt|;
name|int
name|c
decl_stmt|;
name|int
name|mpos
decl_stmt|;
name|fd_set
name|set
decl_stmt|;
name|struct
name|timeval
name|timeout
decl_stmt|;
comment|/* create a new window in the lower screen area */
if|if
condition|(
operator|(
name|menu_w
operator|=
name|newwin
argument_list|(
name|WMENU_HGT
argument_list|,
name|WMENU_LEN
argument_list|,
name|WMENU_POSLN
argument_list|,
name|WMENU_POSCO
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
return|return;
block|}
comment|/* create a border around the window */
name|box
argument_list|(
name|menu_w
argument_list|,
literal|'|'
argument_list|,
literal|'-'
argument_list|)
expr_stmt|;
comment|/* add a title */
name|wstandout
argument_list|(
name|menu_w
argument_list|)
expr_stmt|;
name|mvwaddstr
argument_list|(
name|menu_w
argument_list|,
literal|0
argument_list|,
operator|(
name|WMENU_LEN
operator|/
literal|2
operator|)
operator|-
operator|(
name|strlen
argument_list|(
name|WMENU_TITLE
argument_list|)
operator|/
literal|2
operator|)
argument_list|,
name|WMENU_TITLE
argument_list|)
expr_stmt|;
name|wstandend
argument_list|(
name|menu_w
argument_list|)
expr_stmt|;
comment|/* fill the window with the menu options */
for|for
control|(
name|mpos
operator|=
literal|0
init|;
name|mpos
operator|<=
operator|(
name|WMITEMS
operator|-
literal|1
operator|)
condition|;
name|mpos
operator|++
control|)
name|mvwaddstr
argument_list|(
name|menu_w
argument_list|,
name|mpos
operator|+
literal|2
argument_list|,
literal|2
argument_list|,
name|menu
index|[
name|mpos
index|]
argument_list|)
expr_stmt|;
comment|/* highlight the first menu option */
name|mpos
operator|=
literal|0
expr_stmt|;
name|wstandout
argument_list|(
name|menu_w
argument_list|)
expr_stmt|;
name|mvwaddstr
argument_list|(
name|menu_w
argument_list|,
name|mpos
operator|+
literal|2
argument_list|,
literal|2
argument_list|,
name|menu
index|[
name|mpos
index|]
argument_list|)
expr_stmt|;
name|wstandend
argument_list|(
name|menu_w
argument_list|)
expr_stmt|;
comment|/* input loop */
for|for
control|(
init|;
condition|;
control|)
block|{
name|wrefresh
argument_list|(
name|menu_w
argument_list|)
expr_stmt|;
name|FD_ZERO
argument_list|(
operator|&
name|set
argument_list|)
expr_stmt|;
name|FD_SET
argument_list|(
name|STDIN_FILENO
argument_list|,
operator|&
name|set
argument_list|)
expr_stmt|;
name|timeout
operator|.
name|tv_sec
operator|=
name|WMTIMEOUT
expr_stmt|;
name|timeout
operator|.
name|tv_usec
operator|=
literal|0
expr_stmt|;
comment|/* if no char is available within timeout, exit menu*/
if|if
condition|(
operator|(
name|select
argument_list|(
name|STDIN_FILENO
operator|+
literal|1
argument_list|,
operator|&
name|set
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|timeout
argument_list|)
operator|)
operator|<=
literal|0
condition|)
goto|goto
name|mexit
goto|;
name|c
operator|=
name|wgetch
argument_list|(
name|menu_w
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|' '
case|:
case|case
literal|'\t'
case|:
comment|/* hilite next option */
name|mvwaddstr
argument_list|(
name|menu_w
argument_list|,
name|mpos
operator|+
literal|2
argument_list|,
literal|2
argument_list|,
name|menu
index|[
name|mpos
index|]
argument_list|)
expr_stmt|;
name|mpos
operator|++
expr_stmt|;
if|if
condition|(
name|mpos
operator|>=
name|WMITEMS
condition|)
name|mpos
operator|=
literal|0
expr_stmt|;
name|wstandout
argument_list|(
name|menu_w
argument_list|)
expr_stmt|;
name|mvwaddstr
argument_list|(
name|menu_w
argument_list|,
name|mpos
operator|+
literal|2
argument_list|,
literal|2
argument_list|,
name|menu
index|[
name|mpos
index|]
argument_list|)
expr_stmt|;
name|wstandend
argument_list|(
name|menu_w
argument_list|)
expr_stmt|;
break|break;
case|case
operator|(
literal|'0'
operator|+
name|WREFRESH
operator|+
literal|1
operator|)
case|:
comment|/* display refresh */
case|case
literal|'D'
case|:
case|case
literal|'d'
case|:
name|wrefresh
argument_list|(
name|curscr
argument_list|)
expr_stmt|;
goto|goto
name|mexit
goto|;
case|case
operator|(
literal|'0'
operator|+
name|WQUIT
operator|+
literal|1
operator|)
case|:
comment|/* quit program */
case|case
literal|'Q'
case|:
case|case
literal|'q'
case|:
name|do_exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
goto|goto
name|mexit
goto|;
case|case
operator|(
literal|'0'
operator|+
name|WHANGUP
operator|+
literal|1
operator|)
case|:
comment|/* hangup connection */
case|case
literal|'H'
case|:
case|case
literal|'h'
case|:
name|display_chans
argument_list|()
expr_stmt|;
goto|goto
name|mexit
goto|;
case|case
operator|(
literal|'0'
operator|+
name|WREREAD
operator|+
literal|1
operator|)
case|:
comment|/* reread config file */
case|case
literal|'R'
case|:
case|case
literal|'r'
case|:
name|reread
argument_list|()
expr_stmt|;
goto|goto
name|mexit
goto|;
case|case
literal|'\n'
case|:
case|case
literal|'\r'
case|:
comment|/* exec highlighted option */
switch|switch
condition|(
name|mpos
condition|)
block|{
case|case
name|WREFRESH
case|:
name|wrefresh
argument_list|(
name|curscr
argument_list|)
expr_stmt|;
break|break;
case|case
name|WQUIT
case|:
name|do_exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|WHANGUP
case|:
name|display_chans
argument_list|()
expr_stmt|;
break|break;
case|case
name|WREREAD
case|:
name|reread
argument_list|()
expr_stmt|;
break|break;
block|}
goto|goto
name|mexit
goto|;
break|break;
default|default:
goto|goto
name|mexit
goto|;
break|break;
block|}
block|}
name|mexit
label|:
comment|/* delete the menu window */
name|delwin
argument_list|(
name|menu_w
argument_list|)
expr_stmt|;
comment|/* re-display the original lower window contents */
name|touchwin
argument_list|(
name|lower_w
argument_list|)
expr_stmt|;
name|wrefresh
argument_list|(
name|lower_w
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	display connect information  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|display_connect
parameter_list|(
name|int
name|pos
parameter_list|,
name|int
name|dir
parameter_list|,
name|char
modifier|*
name|name
parameter_list|,
name|char
modifier|*
name|remtel
parameter_list|,
name|char
modifier|*
name|dev
parameter_list|)
block|{
name|char
name|buffer
index|[
literal|256
index|]
decl_stmt|;
comment|/* remote telephone number */
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"%s/%s"
argument_list|,
name|name
argument_list|,
name|remtel
argument_list|)
expr_stmt|;
name|buffer
index|[
name|H_IFN
operator|-
name|H_TELN
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|mvwprintw
argument_list|(
name|upper_w
argument_list|,
name|pos
argument_list|,
name|H_TELN
argument_list|,
literal|"%s"
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
comment|/* interface */
name|mvwprintw
argument_list|(
name|upper_w
argument_list|,
name|pos
argument_list|,
name|H_IFN
argument_list|,
literal|"%s "
argument_list|,
name|dev
argument_list|)
expr_stmt|;
name|mvwprintw
argument_list|(
name|upper_w
argument_list|,
name|pos
argument_list|,
name|H_IO
argument_list|,
name|dir
condition|?
literal|"out"
else|:
literal|"in"
argument_list|)
expr_stmt|;
name|mvwprintw
argument_list|(
name|upper_w
argument_list|,
name|pos
argument_list|,
name|H_OUT
argument_list|,
literal|"-"
argument_list|)
expr_stmt|;
name|mvwprintw
argument_list|(
name|upper_w
argument_list|,
name|pos
argument_list|,
name|H_OUTBPS
argument_list|,
literal|"-"
argument_list|)
expr_stmt|;
name|mvwprintw
argument_list|(
name|upper_w
argument_list|,
name|pos
argument_list|,
name|H_IN
argument_list|,
literal|"-"
argument_list|)
expr_stmt|;
name|mvwprintw
argument_list|(
name|upper_w
argument_list|,
name|pos
argument_list|,
name|H_INBPS
argument_list|,
literal|"-"
argument_list|)
expr_stmt|;
if|if
condition|(
name|do_bell
condition|)
name|display_bell
argument_list|()
expr_stmt|;
name|wrefresh
argument_list|(
name|upper_w
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	display channel information for shutdown  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|display_chans
parameter_list|(
name|void
parameter_list|)
block|{
name|char
name|buffer
index|[
literal|80
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|cnt
init|=
literal|0
decl_stmt|;
name|WINDOW
modifier|*
name|chan_w
decl_stmt|;
name|int
name|nlines
decl_stmt|,
name|ncols
decl_stmt|,
name|pos_x
decl_stmt|,
name|pos_y
decl_stmt|;
name|fd_set
name|set
decl_stmt|;
name|struct
name|timeval
name|timeout
decl_stmt|;
comment|/* need this later to close the connection */
struct|struct
name|ctlr_chan
block|{
name|int
name|cntl
decl_stmt|;
name|int
name|chn
decl_stmt|;
block|}
modifier|*
name|cc
init|=
name|NULL
struct|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nctrl
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|remstate
index|[
name|i
index|]
operator|.
name|ch1state
condition|)
name|cnt
operator|++
expr_stmt|;
if|if
condition|(
name|remstate
index|[
name|i
index|]
operator|.
name|ch2state
condition|)
name|cnt
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|cnt
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|cc
operator|=
operator|(
expr|struct
name|ctlr_chan
operator|*
operator|)
name|malloc
argument_list|(
name|cnt
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|ctlr_chan
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
return|return;
block|}
name|nlines
operator|=
name|cnt
operator|+
literal|4
expr_stmt|;
name|ncols
operator|=
literal|60
expr_stmt|;
block|}
else|else
block|{
name|nlines
operator|=
literal|5
expr_stmt|;
name|ncols
operator|=
literal|22
expr_stmt|;
block|}
name|pos_y
operator|=
name|WMENU_POSLN
operator|+
literal|4
expr_stmt|;
name|pos_x
operator|=
name|WMENU_POSCO
operator|+
literal|10
expr_stmt|;
comment|/* create a new window in the lower screen area */
if|if
condition|(
operator|(
name|chan_w
operator|=
name|newwin
argument_list|(
name|nlines
argument_list|,
name|ncols
argument_list|,
name|pos_y
argument_list|,
name|pos_x
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|cnt
operator|>
literal|0
condition|)
name|free
argument_list|(
name|cc
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* create a border around the window */
name|box
argument_list|(
name|chan_w
argument_list|,
literal|'|'
argument_list|,
literal|'-'
argument_list|)
expr_stmt|;
comment|/* add a title */
name|wstandout
argument_list|(
name|chan_w
argument_list|)
expr_stmt|;
name|mvwaddstr
argument_list|(
name|chan_w
argument_list|,
literal|0
argument_list|,
operator|(
name|ncols
operator|/
literal|2
operator|)
operator|-
operator|(
name|strlen
argument_list|(
literal|"Channels"
argument_list|)
operator|/
literal|2
operator|)
argument_list|,
literal|"Channels"
argument_list|)
expr_stmt|;
name|wstandend
argument_list|(
name|chan_w
argument_list|)
expr_stmt|;
comment|/* no active channels */
if|if
condition|(
name|cnt
operator|==
literal|0
condition|)
block|{
name|mvwaddstr
argument_list|(
name|chan_w
argument_list|,
literal|2
argument_list|,
literal|2
argument_list|,
literal|"No active channels"
argument_list|)
expr_stmt|;
name|wrefresh
argument_list|(
name|chan_w
argument_list|)
expr_stmt|;
name|sleep
argument_list|(
literal|1
argument_list|)
expr_stmt|;
comment|/* delete the channels window */
name|delwin
argument_list|(
name|chan_w
argument_list|)
expr_stmt|;
return|return;
block|}
name|nlines
operator|=
literal|2
expr_stmt|;
name|ncols
operator|=
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nctrl
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|remstate
index|[
name|i
index|]
operator|.
name|ch1state
condition|)
block|{
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"%d - Controller %d channel %s"
argument_list|,
name|ncols
argument_list|,
name|i
argument_list|,
literal|"B1"
argument_list|)
expr_stmt|;
name|mvwaddstr
argument_list|(
name|chan_w
argument_list|,
name|nlines
argument_list|,
literal|2
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
name|cc
index|[
name|ncols
operator|-
literal|1
index|]
operator|.
name|cntl
operator|=
name|i
expr_stmt|;
name|cc
index|[
name|ncols
operator|-
literal|1
index|]
operator|.
name|chn
operator|=
name|CHAN_B1
expr_stmt|;
name|nlines
operator|++
expr_stmt|;
name|ncols
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|remstate
index|[
name|i
index|]
operator|.
name|ch2state
condition|)
block|{
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"%d - Controller %d channel %s"
argument_list|,
name|ncols
argument_list|,
name|i
argument_list|,
literal|"B2"
argument_list|)
expr_stmt|;
name|mvwaddstr
argument_list|(
name|chan_w
argument_list|,
name|nlines
argument_list|,
literal|2
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
name|cc
index|[
name|ncols
operator|-
literal|1
index|]
operator|.
name|cntl
operator|=
name|i
expr_stmt|;
name|cc
index|[
name|ncols
operator|-
literal|1
index|]
operator|.
name|chn
operator|=
name|CHAN_B2
expr_stmt|;
name|nlines
operator|++
expr_stmt|;
name|ncols
operator|++
expr_stmt|;
block|}
block|}
for|for
control|(
init|;
condition|;
control|)
block|{
name|wrefresh
argument_list|(
name|chan_w
argument_list|)
expr_stmt|;
name|FD_ZERO
argument_list|(
operator|&
name|set
argument_list|)
expr_stmt|;
name|FD_SET
argument_list|(
name|STDIN_FILENO
argument_list|,
operator|&
name|set
argument_list|)
expr_stmt|;
name|timeout
operator|.
name|tv_sec
operator|=
name|WMTIMEOUT
expr_stmt|;
name|timeout
operator|.
name|tv_usec
operator|=
literal|0
expr_stmt|;
comment|/* if no char is available within timeout, exit menu*/
if|if
condition|(
operator|(
name|select
argument_list|(
name|STDIN_FILENO
operator|+
literal|1
argument_list|,
operator|&
name|set
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|timeout
argument_list|)
operator|)
operator|<=
literal|0
condition|)
break|break;
name|ncols
operator|=
name|wgetch
argument_list|(
name|chan_w
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|isdigit
argument_list|(
name|ncols
argument_list|)
operator|)
condition|)
block|{
name|display_bell
argument_list|()
expr_stmt|;
continue|continue;
block|}
name|nlines
operator|=
name|ncols
operator|-
literal|'0'
expr_stmt|;
if|if
condition|(
operator|(
name|nlines
operator|==
literal|0
operator|)
operator|||
operator|(
name|nlines
operator|>
name|cnt
operator|)
condition|)
block|{
name|display_bell
argument_list|()
expr_stmt|;
continue|continue;
block|}
name|hangup
argument_list|(
name|cc
index|[
name|nlines
operator|-
literal|1
index|]
operator|.
name|cntl
argument_list|,
name|cc
index|[
name|nlines
operator|-
literal|1
index|]
operator|.
name|chn
argument_list|)
expr_stmt|;
break|break;
block|}
name|free
argument_list|(
name|cc
argument_list|)
expr_stmt|;
comment|/* delete the channels window */
name|delwin
argument_list|(
name|chan_w
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* !WIN32*/
end_comment

begin_comment
comment|/* EOF */
end_comment

end_unit


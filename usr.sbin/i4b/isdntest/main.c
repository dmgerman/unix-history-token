begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1997, 1999 Hellmuth Michaelis. All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  *---------------------------------------------------------------------------  *  *	main.c - i4b selftest utility  *	-----------------------------  *  *	$Id: main.c,v 1.3 1999/05/20 10:14:11 hm Exp $   *  *      last edit-date: [Mon Apr 26 14:08:40 1999]  *  *---------------------------------------------------------------------------*/
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<sys/wait.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<machine/i4b_ioctl.h>
end_include

begin_include
include|#
directive|include
file|<machine/i4b_cause.h>
end_include

begin_function_decl
specifier|static
name|void
name|kbdrdhdl
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|isdnrdhdl
parameter_list|(
name|int
name|isdnfd
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|handle_connect_ind
parameter_list|(
name|unsigned
name|char
modifier|*
name|ptr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|handle_disconnect
parameter_list|(
name|unsigned
name|char
modifier|*
name|ptr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|handle_connect_active_ind
parameter_list|(
name|unsigned
name|char
modifier|*
name|ptr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|connect_response
parameter_list|(
name|int
name|isdnfd
parameter_list|,
name|unsigned
name|int
name|cdid
parameter_list|,
name|int
name|response
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|disconnect_request
parameter_list|(
name|int
name|isdnfd
parameter_list|,
name|unsigned
name|int
name|cdid
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|unsigned
name|int
name|get_cdid
parameter_list|(
name|int
name|isdnfd
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|connect_request
parameter_list|(
name|int
name|isdnfd
parameter_list|,
name|unsigned
name|int
name|cdid
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|do_test
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|cleanup
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|usage
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|setup_wrfix
parameter_list|(
name|int
name|len
parameter_list|,
name|unsigned
name|char
modifier|*
name|buf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|check_rd
parameter_list|(
name|int
name|len
parameter_list|,
name|unsigned
name|char
modifier|*
name|wbuf
parameter_list|,
name|unsigned
name|char
modifier|*
name|rdbuf
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|int
name|isdnfd
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|outgoingnumber
index|[
literal|32
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|incomingnumber
index|[
literal|32
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|debug_level
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|I4BDEVICE
value|"/dev/i4b"
end_define

begin_define
define|#
directive|define
name|DATADEV0
value|"/dev/i4brbch0"
end_define

begin_define
define|#
directive|define
name|DATAUNIT0
value|0
end_define

begin_define
define|#
directive|define
name|DATADEV1
value|"/dev/i4brbch1"
end_define

begin_define
define|#
directive|define
name|DATAUNIT1
value|1
end_define

begin_decl_stmt
name|unsigned
name|int
name|out_cdid
init|=
name|CDID_UNUSED
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|int
name|in_cdid
init|=
name|CDID_UNUSED
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|waitchar
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|usehdlc
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|controller
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|dotest
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*---------------------------------------------------------------------------*  *	program entry  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|c
decl_stmt|;
name|fd_set
name|set
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|char
modifier|*
name|ptr
decl_stmt|;
name|incomingnumber
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|outgoingnumber
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"c:d:hi:o:t:w"
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'c'
case|:
if|if
condition|(
name|isdigit
argument_list|(
operator|*
name|optarg
argument_list|)
condition|)
block|{
name|controller
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Error: option -c requires a numeric argument!\n"
argument_list|)
expr_stmt|;
name|usage
argument_list|()
expr_stmt|;
block|}
break|break;
case|case
literal|'d'
case|:
if|if
condition|(
name|isdigit
argument_list|(
operator|*
name|optarg
argument_list|)
condition|)
block|{
name|debug_level
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Error: option -d requires a numeric argument!\n"
argument_list|)
expr_stmt|;
name|usage
argument_list|()
expr_stmt|;
block|}
break|break;
case|case
literal|'o'
case|:
name|i
operator|=
literal|0
expr_stmt|;
name|ptr
operator|=
name|optarg
expr_stmt|;
while|while
condition|(
operator|*
name|ptr
condition|)
block|{
if|if
condition|(
name|isdigit
argument_list|(
operator|*
name|ptr
argument_list|)
condition|)
block|{
name|outgoingnumber
index|[
name|i
operator|++
index|]
operator|=
operator|*
name|ptr
operator|++
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Error: option -o requires a numeric argument!\n"
argument_list|)
expr_stmt|;
name|usage
argument_list|()
expr_stmt|;
block|}
block|}
name|outgoingnumber
index|[
name|i
index|]
operator|=
literal|'\0'
expr_stmt|;
break|break;
case|case
literal|'i'
case|:
name|i
operator|=
literal|0
expr_stmt|;
name|ptr
operator|=
name|optarg
expr_stmt|;
while|while
condition|(
operator|*
name|ptr
condition|)
block|{
if|if
condition|(
name|isdigit
argument_list|(
operator|*
name|ptr
argument_list|)
condition|)
block|{
name|incomingnumber
index|[
name|i
operator|++
index|]
operator|=
operator|*
name|ptr
operator|++
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Error: option -i requires a numeric argument!\n"
argument_list|)
expr_stmt|;
name|usage
argument_list|()
expr_stmt|;
block|}
block|}
name|incomingnumber
index|[
name|i
index|]
operator|=
literal|'\0'
expr_stmt|;
break|break;
case|case
literal|'w'
case|:
name|waitchar
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'h'
case|:
name|usehdlc
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
if|if
condition|(
name|isdigit
argument_list|(
operator|*
name|optarg
argument_list|)
condition|)
block|{
name|dotest
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Error: option -t requires a numeric argument!\n"
argument_list|)
expr_stmt|;
name|usage
argument_list|()
expr_stmt|;
block|}
break|break;
case|case
literal|'?'
case|:
default|default:
name|usage
argument_list|()
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
operator|(
name|strlen
argument_list|(
name|incomingnumber
argument_list|)
operator|==
literal|0
operator|)
operator|||
operator|(
name|strlen
argument_list|(
name|outgoingnumber
argument_list|)
operator|==
literal|0
operator|)
condition|)
name|usage
argument_list|()
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"isdntest: accepting calls from telephone number [%s] \n"
argument_list|,
name|incomingnumber
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"isdntest:          calling out telephone number [%s] \n"
argument_list|,
name|outgoingnumber
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|atexit
argument_list|(
name|cleanup
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"isdntest: atexit error: %s\n"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* open isdn device */
if|if
condition|(
operator|(
name|isdnfd
operator|=
name|open
argument_list|(
name|I4BDEVICE
argument_list|,
name|O_RDWR
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\nisdntest: cannot open %s: %s\n"
argument_list|,
name|I4BDEVICE
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"          isdnd is probably running, to use isdntest,\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"          terminate isdnd and then run isdntest again!\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|out_cdid
operator|=
name|get_cdid
argument_list|(
name|isdnfd
argument_list|)
operator|)
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"isdntest: error getting cdid: %s\n"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|connect_request
argument_list|(
name|isdnfd
argument_list|,
name|out_cdid
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"isdntest: error, outgoing call failed!\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
for|for
control|(
init|;
condition|;
control|)
block|{
name|FD_ZERO
argument_list|(
operator|&
name|set
argument_list|)
expr_stmt|;
name|FD_SET
argument_list|(
literal|0
argument_list|,
operator|&
name|set
argument_list|)
expr_stmt|;
name|FD_SET
argument_list|(
name|isdnfd
argument_list|,
operator|&
name|set
argument_list|)
expr_stmt|;
name|ret
operator|=
name|select
argument_list|(
name|isdnfd
operator|+
literal|1
argument_list|,
operator|&
name|set
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|FD_ISSET
argument_list|(
name|isdnfd
argument_list|,
operator|&
name|set
argument_list|)
condition|)
name|isdnrdhdl
argument_list|(
name|isdnfd
argument_list|)
expr_stmt|;
if|if
condition|(
name|FD_ISSET
argument_list|(
literal|0
argument_list|,
operator|&
name|set
argument_list|)
condition|)
name|kbdrdhdl
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"isdntest: select error: %s\n"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	data from keyboard available  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|kbdrdhdl
parameter_list|(
name|void
parameter_list|)
block|{
name|cleanup
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	data from /dev/isdn available, read and process them  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|isdnrdhdl
parameter_list|(
name|int
name|isdnfd
parameter_list|)
block|{
specifier|static
name|unsigned
name|char
name|buf
index|[
literal|1024
index|]
decl_stmt|;
name|int
name|len
decl_stmt|;
if|if
condition|(
operator|(
name|len
operator|=
name|read
argument_list|(
name|isdnfd
argument_list|,
name|buf
argument_list|,
literal|1024
operator|-
literal|1
argument_list|)
operator|)
operator|>
literal|0
condition|)
block|{
switch|switch
condition|(
name|buf
index|[
literal|0
index|]
condition|)
block|{
case|case
name|MSG_CONNECT_IND
case|:
name|handle_connect_ind
argument_list|(
operator|&
name|buf
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|MSG_CONNECT_ACTIVE_IND
case|:
name|handle_connect_active_ind
argument_list|(
operator|&
name|buf
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|MSG_DISCONNECT_IND
case|:
name|handle_disconnect
argument_list|(
operator|&
name|buf
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
default|default:
if|if
condition|(
name|debug_level
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"isdntest: unknown message 0x%x = %c\n"
argument_list|,
name|buf
index|[
literal|0
index|]
argument_list|,
name|buf
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"isdntest: read error, errno = %d, length = %d"
argument_list|,
name|errno
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	usage display and exit  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|usage
parameter_list|(
name|void
parameter_list|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"isdntest - i4b selftest, version %d.%d.%d, compiled %s %s\n"
argument_list|,
name|VERSION
argument_list|,
name|REL
argument_list|,
name|STEP
argument_list|,
name|__DATE__
argument_list|,
name|__TIME__
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"usage: isdntest -c<ctrl> -h -i<telno> -o<telno>\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       -c<ctrl>     specify controller to use\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       -h            use HDLC as Bchannel protocol\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       -i<telno>    incoming telephone number\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       -o<telno>    outgoing telephone number\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       -w            wait for keyboard entry to disconnect\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       -t num        send test pattern num times\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	initiate an outgoing connection  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|int
name|connect_request
parameter_list|(
name|int
name|isdnfd
parameter_list|,
name|unsigned
name|int
name|cdid
parameter_list|)
block|{
name|msg_connect_req_t
name|mcr
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|mcr
argument_list|,
sizeof|sizeof
argument_list|(
name|msg_connect_req_t
argument_list|)
argument_list|)
expr_stmt|;
name|mcr
operator|.
name|controller
operator|=
name|controller
expr_stmt|;
name|mcr
operator|.
name|channel
operator|=
name|CHAN_ANY
expr_stmt|;
comment|/* any channel */
name|mcr
operator|.
name|cdid
operator|=
name|cdid
expr_stmt|;
comment|/* cdid from get_cdid() */
if|if
condition|(
name|usehdlc
condition|)
name|mcr
operator|.
name|bprot
operator|=
name|BPROT_RHDLC
expr_stmt|;
comment|/* b channel protocol */
else|else
name|mcr
operator|.
name|bprot
operator|=
name|BPROT_NONE
expr_stmt|;
comment|/* b channel protocol */
name|mcr
operator|.
name|driver
operator|=
name|BDRV_RBCH
expr_stmt|;
comment|/* raw b channel driver */
name|mcr
operator|.
name|driver_unit
operator|=
name|DATAUNIT0
expr_stmt|;
comment|/* raw b channel driver unit */
name|strcpy
argument_list|(
name|mcr
operator|.
name|dst_telno
argument_list|,
name|outgoingnumber
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|mcr
operator|.
name|src_telno
argument_list|,
name|incomingnumber
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ret
operator|=
name|ioctl
argument_list|(
name|isdnfd
argument_list|,
name|I4B_CONNECT_REQ
argument_list|,
operator|&
name|mcr
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ioctl I4B_CONNECT_REQ failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"isdntest: calling out to telephone number [%s] \n"
argument_list|,
name|outgoingnumber
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	handle setup indicator  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|handle_connect_ind
parameter_list|(
name|unsigned
name|char
modifier|*
name|ptr
parameter_list|)
block|{
name|msg_connect_ind_t
modifier|*
name|msi
init|=
operator|(
name|msg_connect_ind_t
operator|*
operator|)
name|ptr
decl_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"isdntest: incoming SETUP: from %s to %s\n"
argument_list|,
name|msi
operator|->
name|src_telno
argument_list|,
name|msi
operator|->
name|dst_telno
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"          channel %d, controller %d, bprot %d, cdid %d\n"
argument_list|,
name|msi
operator|->
name|channel
argument_list|,
name|msi
operator|->
name|controller
argument_list|,
name|msi
operator|->
name|bprot
argument_list|,
name|msi
operator|->
name|header
operator|.
name|cdid
argument_list|)
expr_stmt|;
name|in_cdid
operator|=
name|msi
operator|->
name|header
operator|.
name|cdid
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|msi
operator|->
name|dst_telno
argument_list|,
name|outgoingnumber
argument_list|)
condition|)
block|{
name|msg_connect_resp_t
name|msr
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"isdntest: ignoring incoming SETUP: my number [%s] != outgoing [%s]\n"
argument_list|,
name|msi
operator|->
name|dst_telno
argument_list|,
name|outgoingnumber
argument_list|)
expr_stmt|;
name|msr
operator|.
name|cdid
operator|=
name|in_cdid
expr_stmt|;
name|msr
operator|.
name|response
operator|=
name|SETUP_RESP_DNTCRE
expr_stmt|;
if|if
condition|(
operator|(
name|ret
operator|=
name|ioctl
argument_list|(
name|isdnfd
argument_list|,
name|I4B_CONNECT_RESP
argument_list|,
operator|&
name|msr
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ioctl I4B_CONNECT_RESP ignore failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|msg_connect_resp_t
name|msr
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"isdntest: accepting call, sending CONNECT_RESPONSE .....\n"
argument_list|)
expr_stmt|;
name|msr
operator|.
name|cdid
operator|=
name|in_cdid
expr_stmt|;
name|msr
operator|.
name|response
operator|=
name|SETUP_RESP_ACCEPT
expr_stmt|;
if|if
condition|(
name|usehdlc
condition|)
name|msr
operator|.
name|bprot
operator|=
name|BPROT_RHDLC
expr_stmt|;
else|else
name|msr
operator|.
name|bprot
operator|=
name|BPROT_NONE
expr_stmt|;
name|msr
operator|.
name|driver
operator|=
name|BDRV_RBCH
expr_stmt|;
name|msr
operator|.
name|driver_unit
operator|=
name|DATAUNIT1
expr_stmt|;
if|if
condition|(
operator|(
name|ret
operator|=
name|ioctl
argument_list|(
name|isdnfd
argument_list|,
name|I4B_CONNECT_RESP
argument_list|,
operator|&
name|msr
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ioctl I4B_CONNECT_RESP accept failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_define
define|#
directive|define
name|SLEEPTIME
value|5
end_define

begin_comment
comment|/*---------------------------------------------------------------------------*  *	handle connection active  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|handle_connect_active_ind
parameter_list|(
name|unsigned
name|char
modifier|*
name|ptr
parameter_list|)
block|{
name|msg_connect_active_ind_t
modifier|*
name|msi
init|=
operator|(
name|msg_connect_active_ind_t
operator|*
operator|)
name|ptr
decl_stmt|;
name|int
name|i
decl_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"isdntest: connection active, cdid %d\n"
argument_list|,
name|msi
operator|->
name|header
operator|.
name|cdid
argument_list|)
expr_stmt|;
if|if
condition|(
name|out_cdid
operator|==
name|msi
operator|->
name|header
operator|.
name|cdid
condition|)
block|{
if|if
condition|(
name|waitchar
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"isdntest: press any key to disconnect ...%c%c%c\n"
argument_list|,
literal|0x07
argument_list|,
literal|0x07
argument_list|,
literal|0x07
argument_list|)
expr_stmt|;
name|getchar
argument_list|()
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|dotest
condition|)
block|{
name|do_test
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"isdntest: %d secs delay until disconnect:"
argument_list|,
name|SLEEPTIME
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SLEEPTIME
condition|;
name|i
operator|++
control|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|" ."
argument_list|)
expr_stmt|;
name|sleep
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|cleanup
argument_list|()
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	handle disconnect indication  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|handle_disconnect
parameter_list|(
name|unsigned
name|char
modifier|*
name|ptr
parameter_list|)
block|{
name|msg_disconnect_ind_t
modifier|*
name|mdi
init|=
operator|(
name|msg_disconnect_ind_t
operator|*
operator|)
name|ptr
decl_stmt|;
if|if
condition|(
name|mdi
operator|->
name|header
operator|.
name|cdid
operator|==
name|out_cdid
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"isdntest: incoming disconnect indication, cdid %d (out_cdid), cause %d\n"
argument_list|,
name|mdi
operator|->
name|header
operator|.
name|cdid
argument_list|,
name|mdi
operator|->
name|cause
argument_list|)
expr_stmt|;
name|out_cdid
operator|=
name|CDID_UNUSED
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|mdi
operator|->
name|header
operator|.
name|cdid
operator|==
name|in_cdid
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"isdntest: incoming disconnect indication, cdid %d (in_cdid), cause %d\n"
argument_list|,
name|mdi
operator|->
name|header
operator|.
name|cdid
argument_list|,
name|mdi
operator|->
name|cause
argument_list|)
expr_stmt|;
name|in_cdid
operator|=
name|CDID_UNUSED
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"isdntest: incoming disconnect indication, cdid %d (???), cause %d\n"
argument_list|,
name|mdi
operator|->
name|header
operator|.
name|cdid
argument_list|,
name|mdi
operator|->
name|cause
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	hang up  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|int
name|disconnect_request
parameter_list|(
name|int
name|isdnfd
parameter_list|,
name|unsigned
name|int
name|cdid
parameter_list|)
block|{
name|msg_discon_req_t
name|mdr
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|mdr
operator|.
name|cdid
operator|=
name|cdid
expr_stmt|;
name|mdr
operator|.
name|cause
operator|=
operator|(
name|CAUSET_I4B
operator|<<
literal|8
operator|)
operator||
name|CAUSE_I4B_NORMAL
expr_stmt|;
if|if
condition|(
operator|(
name|ret
operator|=
name|ioctl
argument_list|(
name|isdnfd
argument_list|,
name|I4B_DISCONNECT_REQ
argument_list|,
operator|&
name|mdr
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ioctl I4B_DISCONNECT_REQ failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"isdntest: sending disconnect request\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	get cdid from kernel  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|unsigned
name|int
name|get_cdid
parameter_list|(
name|int
name|isdnfd
parameter_list|)
block|{
name|msg_cdid_req_t
name|mcr
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|mcr
operator|.
name|cdid
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|ret
operator|=
name|ioctl
argument_list|(
name|isdnfd
argument_list|,
name|I4B_CDID_REQ
argument_list|,
operator|&
name|mcr
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ioctl I4B_CDID_REQ failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"isdntest: got cdid %d from kernel\n"
argument_list|,
name|mcr
operator|.
name|cdid
argument_list|)
expr_stmt|;
return|return
operator|(
name|mcr
operator|.
name|cdid
operator|)
return|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	make shure all cdid's are inactive before leaving  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|cleanup
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|len
decl_stmt|;
name|char
name|buf
index|[
literal|1024
index|]
decl_stmt|;
if|if
condition|(
name|out_cdid
operator|!=
name|CDID_UNUSED
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"isdntest: cleanup, send disconnect req for out_cdid %d, in_cdid %d\n"
argument_list|,
name|out_cdid
argument_list|,
name|in_cdid
argument_list|)
expr_stmt|;
name|disconnect_request
argument_list|(
name|isdnfd
argument_list|,
name|out_cdid
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
operator|(
name|out_cdid
operator|!=
name|CDID_UNUSED
operator|)
operator|||
operator|(
name|in_cdid
operator|!=
name|CDID_UNUSED
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"isdntest: cleanup, out_cdid %d, in_cdid %d\n"
argument_list|,
name|out_cdid
argument_list|,
name|in_cdid
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|len
operator|=
name|read
argument_list|(
name|isdnfd
argument_list|,
name|buf
argument_list|,
literal|1024
operator|-
literal|1
argument_list|)
operator|)
operator|>
literal|0
condition|)
block|{
switch|switch
condition|(
name|buf
index|[
literal|0
index|]
condition|)
block|{
case|case
name|MSG_CONNECT_IND
case|:
name|handle_connect_ind
argument_list|(
operator|&
name|buf
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|MSG_CONNECT_ACTIVE_IND
case|:
name|handle_connect_active_ind
argument_list|(
operator|&
name|buf
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|MSG_DISCONNECT_IND
case|:
name|handle_disconnect
argument_list|(
operator|&
name|buf
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"isdntest: unknown message 0x%x = %c\n"
argument_list|,
name|buf
index|[
literal|0
index|]
argument_list|,
name|buf
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"isdntest: read error, errno = %d, length = %d"
argument_list|,
name|errno
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
block|}
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"isdntest: exit cleanup, out_cdid %d, in_cdid %d\n"
argument_list|,
name|out_cdid
argument_list|,
name|in_cdid
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	test the b-channels  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|int
name|do_test
parameter_list|(
name|void
parameter_list|)
block|{
define|#
directive|define
name|FPH
value|0x3c
define|#
directive|define
name|FPL
value|0x66
name|int
name|fd0
decl_stmt|,
name|fd1
decl_stmt|;
name|unsigned
name|char
name|wrbuf
index|[
literal|2048
index|]
decl_stmt|;
name|unsigned
name|char
name|rdbuf
index|[
literal|2048
index|]
decl_stmt|;
name|int
name|sz
decl_stmt|;
name|fd_set
name|set
decl_stmt|;
name|struct
name|timeval
name|timeout
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|int
name|frame
decl_stmt|;
name|int
name|errcnt
decl_stmt|;
name|int
name|frm_len
decl_stmt|;
name|int
name|bytecnt
init|=
literal|0
decl_stmt|;
name|time_t
name|start_time
decl_stmt|;
name|time_t
name|cur_time
decl_stmt|;
name|time_t
name|run_time
decl_stmt|;
if|if
condition|(
operator|(
name|fd0
operator|=
name|open
argument_list|(
name|DATADEV0
argument_list|,
name|O_RDWR
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"open of %s failed: %s"
argument_list|,
name|DATADEV0
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|fd1
operator|=
name|open
argument_list|(
name|DATADEV1
argument_list|,
name|O_RDWR
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"open of %s failed: %s"
argument_list|,
name|DATADEV1
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|frame
operator|=
literal|0
expr_stmt|;
name|errcnt
operator|=
literal|0
expr_stmt|;
name|frm_len
operator|=
literal|2
expr_stmt|;
name|start_time
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" frame size errors totalbytes  bps elapsedtime\n"
argument_list|)
expr_stmt|;
for|for
control|(
init|;
name|dotest
operator|>
literal|0
condition|;
name|dotest
operator|--
control|)
block|{
name|setup_wrfix
argument_list|(
name|frm_len
argument_list|,
operator|&
name|wrbuf
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|frame
operator|++
expr_stmt|;
name|bytecnt
operator|+=
name|frm_len
expr_stmt|;
name|printf
argument_list|(
literal|"%6d %4d"
argument_list|,
name|frame
argument_list|,
name|frm_len
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sz
operator|=
name|write
argument_list|(
name|fd0
argument_list|,
name|wrbuf
argument_list|,
name|frm_len
argument_list|)
operator|)
operator|!=
name|frm_len
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"write (%d of %d bytes) to %s failed: %s\n"
argument_list|,
name|sz
argument_list|,
name|frm_len
argument_list|,
name|DATADEV0
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|timeout
operator|.
name|tv_sec
operator|=
literal|2
expr_stmt|;
name|timeout
operator|.
name|tv_usec
operator|=
literal|0
expr_stmt|;
name|FD_ZERO
argument_list|(
operator|&
name|set
argument_list|)
expr_stmt|;
name|FD_SET
argument_list|(
literal|0
argument_list|,
operator|&
name|set
argument_list|)
expr_stmt|;
name|FD_SET
argument_list|(
name|fd1
argument_list|,
operator|&
name|set
argument_list|)
expr_stmt|;
name|ret
operator|=
name|select
argument_list|(
name|fd1
operator|+
literal|1
argument_list|,
operator|&
name|set
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|timeout
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|FD_ISSET
argument_list|(
name|fd1
argument_list|,
operator|&
name|set
argument_list|)
condition|)
block|{
if|if
condition|(
operator|(
name|sz
operator|=
name|read
argument_list|(
name|fd1
argument_list|,
name|rdbuf
argument_list|,
literal|2048
argument_list|)
operator|)
operator|!=
name|frm_len
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"read (%d bytes) from %s failed: %s\n"
argument_list|,
name|sz
argument_list|,
name|DATADEV1
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|cur_time
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|run_time
operator|=
name|difftime
argument_list|(
name|cur_time
argument_list|,
name|start_time
argument_list|)
expr_stmt|;
if|if
condition|(
name|run_time
operator|==
literal|0
condition|)
name|run_time
operator|=
literal|1
expr_stmt|;
name|printf
argument_list|(
literal|" %6d %10d %4d %2.2d:%2.2d:%2.2d     \r"
argument_list|,
name|errcnt
argument_list|,
name|bytecnt
argument_list|,
call|(
name|int
call|)
argument_list|(
operator|(
name|int
operator|)
name|bytecnt
operator|/
operator|(
name|int
operator|)
name|run_time
argument_list|)
argument_list|,
operator|(
name|int
operator|)
name|run_time
operator|/
literal|3600
argument_list|,
operator|(
name|int
operator|)
name|run_time
operator|/
literal|60
argument_list|,
operator|(
name|int
operator|)
name|run_time
operator|%
literal|60
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|errcnt
operator|+=
name|check_rd
argument_list|(
name|frm_len
argument_list|,
operator|&
name|wrbuf
index|[
literal|0
index|]
argument_list|,
operator|&
name|rdbuf
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|NOTDEF
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sz
condition|;
name|i
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"0x%02x "
argument_list|,
operator|(
name|unsigned
name|char
operator|)
name|rdbuf
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
if|if
condition|(
name|FD_ISSET
argument_list|(
literal|0
argument_list|,
operator|&
name|set
argument_list|)
condition|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
name|printf
argument_list|(
literal|"\n\n"
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"isdntest, do_test: select error: %s\n"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|frm_len
operator|=
name|frm_len
operator|*
literal|2
expr_stmt|;
if|if
condition|(
name|frm_len
operator|>
literal|2048
condition|)
name|frm_len
operator|=
literal|2
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|void
name|setup_wrfix
parameter_list|(
name|int
name|len
parameter_list|,
name|unsigned
name|char
modifier|*
name|buf
parameter_list|)
block|{
specifier|register
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
control|)
block|{
operator|*
name|buf
operator|=
name|FPH
expr_stmt|;
name|buf
operator|++
expr_stmt|;
operator|*
name|buf
operator|=
name|FPL
expr_stmt|;
name|buf
operator|++
expr_stmt|;
name|i
operator|+=
literal|2
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|check_rd
parameter_list|(
name|int
name|len
parameter_list|,
name|unsigned
name|char
modifier|*
name|wbuf
parameter_list|,
name|unsigned
name|char
modifier|*
name|rbuf
parameter_list|)
block|{
specifier|register
name|int
name|i
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|*
name|wbuf
operator|!=
operator|*
name|rbuf
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\nERROR, byte %d, written 0x%02x, read 0x%02x\n"
argument_list|,
name|i
argument_list|,
operator|*
name|wbuf
argument_list|,
operator|*
name|rbuf
argument_list|)
expr_stmt|;
name|ret
operator|++
expr_stmt|;
block|}
name|wbuf
operator|++
expr_stmt|;
name|rbuf
operator|++
expr_stmt|;
block|}
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_comment
comment|/* EOF */
end_comment

end_unit


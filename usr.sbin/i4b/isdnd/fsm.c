begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1997, 1998 Hellmuth Michaelis. All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  *---------------------------------------------------------------------------  *  *	FSM for isdnd  *	-------------  *  * $FreeBSD$   *  *      last edit-date: [Sat Dec  5 18:07:31 1998]  *  *---------------------------------------------------------------------------*/
end_comment

begin_include
include|#
directive|include
file|"isdnd.h"
end_include

begin_comment
comment|/* table of state descriptions */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|state_text
index|[
name|N_STATES
index|]
init|=
block|{
literal|"idle"
block|,
literal|"dialing"
block|,
literal|"waitdialretry"
block|,
literal|"dialretry"
block|,
literal|"pcb-dialing"
block|,
literal|"pcb-dialfail"
block|,
literal|"pcb-waitcall"
block|,
literal|"acb-waitdisc"
block|,
literal|"acb-waitdial"
block|,
literal|"acb-dialing"
block|,
literal|"acb-dialfail"
block|,
literal|"accepted"
block|,
literal|"connected"
block|,
literal|"waitdisconnect"
block|,
literal|"down"
block|,
literal|"alert"
block|,
literal|"Illegal State"
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* table of event descriptions */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|event_text
index|[
name|N_EVENTS
index|]
init|=
block|{
comment|/* incoming messages */
literal|"msg-con-ind"
block|,
literal|"msg-con-act-ind"
block|,
literal|"msg-disc-ind"
block|,
literal|"msg-dialout"
block|,
comment|/* local events */
literal|"timeout"
block|,
literal|"disconnect-req"
block|,
literal|"callback-req"
block|,
literal|"alert-req"
block|,
comment|/* illegal */
literal|"Illegal Event"
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*---------------------------------------------------------------------------*  *	illegal state default action  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|F_ill
parameter_list|(
name|cfg_entry_t
modifier|*
name|cep
parameter_list|)
block|{
name|DBGL
argument_list|(
name|DL_STATE
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"F_ill: Illegal State reached !!!"
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	No change, No action  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|F_NcNa
parameter_list|(
name|cfg_entry_t
modifier|*
name|cep
parameter_list|)
block|{ }
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	incoming CONNECT, accepting call  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|F_MCI
parameter_list|(
name|cfg_entry_t
modifier|*
name|cep
parameter_list|)
block|{
name|DBGL
argument_list|(
name|DL_STATE
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"F_MCI: tx SETUP_RESP_ACCEPT"
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|sendm_connect_resp
argument_list|(
name|cep
argument_list|,
name|cep
operator|->
name|cdid
argument_list|,
name|SETUP_RESP_ACCEPT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|start_timer
argument_list|(
name|cep
argument_list|,
name|TIMEOUT_CONNECT_ACTIVE
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	incoming connect active, call is now active  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|F_MCAI
parameter_list|(
name|cfg_entry_t
modifier|*
name|cep
parameter_list|)
block|{
name|DBGL
argument_list|(
name|DL_STATE
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"F_MCAI: Connection active!"
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|stop_timer
argument_list|(
name|cep
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|cep
operator|->
name|dialin_reaction
operator|==
name|REACT_ANSWER
operator|)
operator|&&
operator|(
name|cep
operator|->
name|b1protocol
operator|==
name|BPROT_NONE
operator|)
condition|)
block|{
name|exec_answer
argument_list|(
name|cep
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	timeout  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|F_TIMO
parameter_list|(
name|cfg_entry_t
modifier|*
name|cep
parameter_list|)
block|{
name|DBGL
argument_list|(
name|DL_STATE
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"F_TIMO: Timout occured!"
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|sendm_disconnect_req
argument_list|(
name|cep
argument_list|,
operator|(
name|CAUSET_I4B
operator|<<
literal|8
operator|)
operator||
name|CAUSE_I4B_NORMAL
argument_list|)
expr_stmt|;
name|cep
operator|->
name|cdid
operator|=
name|CDID_UNUSED
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	incoming disconnect indication  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|F_IDIS
parameter_list|(
name|cfg_entry_t
modifier|*
name|cep
parameter_list|)
block|{
name|DBGL
argument_list|(
name|DL_STATE
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"F_IDIS: disconnect indication"
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|cep
operator|->
name|cdid
operator|=
name|CDID_UNUSED
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	local disconnect request  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|F_DRQ
parameter_list|(
name|cfg_entry_t
modifier|*
name|cep
parameter_list|)
block|{
name|DBGL
argument_list|(
name|DL_STATE
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"F_DRQ: local disconnect request"
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|sendm_disconnect_req
argument_list|(
name|cep
argument_list|,
operator|(
name|CAUSET_I4B
operator|<<
literal|8
operator|)
operator||
name|CAUSE_I4B_NORMAL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	disconnect indication after local disconnect req  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|F_MDI
parameter_list|(
name|cfg_entry_t
modifier|*
name|cep
parameter_list|)
block|{
name|DBGL
argument_list|(
name|DL_STATE
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"F_MDI: disconnect indication, local disconnected"
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|cep
operator|->
name|cdid
operator|=
name|CDID_UNUSED
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	local requested outgoing dial  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|F_DIAL
parameter_list|(
name|cfg_entry_t
modifier|*
name|cep
parameter_list|)
block|{
name|DBGL
argument_list|(
name|DL_STATE
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"F_DIAL: local dial out request"
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cep
operator|->
name|dialrandincr
condition|)
name|cep
operator|->
name|randomtime
operator|=
operator|(
name|random
argument_list|()
operator|&
name|RANDOM_MASK
operator|)
operator|+
name|cep
operator|->
name|recoverytime
expr_stmt|;
name|cep
operator|->
name|dial_count
operator|=
literal|0
expr_stmt|;
name|select_first_dialno
argument_list|(
name|cep
argument_list|)
expr_stmt|;
name|sendm_connect_req
argument_list|(
name|cep
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	outgoing dial successfull  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|F_DOK
parameter_list|(
name|cfg_entry_t
modifier|*
name|cep
parameter_list|)
block|{
name|DBGL
argument_list|(
name|DL_STATE
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"F_DOK: dial out ok"
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|select_this_dialno
argument_list|(
name|cep
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	outgoing dial fail (ST_SUSE !!!)  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|F_DFL
parameter_list|(
name|cfg_entry_t
modifier|*
name|cep
parameter_list|)
block|{
name|cep
operator|->
name|last_release_time
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|cep
operator|->
name|dialouttype
operator|==
name|DIALOUT_NORMAL
condition|)
block|{
name|cep
operator|->
name|dial_count
operator|++
expr_stmt|;
if|if
condition|(
name|cep
operator|->
name|dial_count
operator|<
name|cep
operator|->
name|dialretries
condition|)
block|{
comment|/* inside normal retry cycle */
name|DBGL
argument_list|(
name|DL_STATE
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"F_DFL: dial fail, dial retry"
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|select_next_dialno
argument_list|(
name|cep
argument_list|)
expr_stmt|;
name|cep
operator|->
name|cdid
operator|=
name|CDID_RESERVED
expr_stmt|;
name|cep
operator|->
name|state
operator|=
name|ST_DIALRTMRCHD
expr_stmt|;
return|return;
block|}
comment|/* retries exhausted */
if|if
condition|(
operator|!
name|cep
operator|->
name|usedown
condition|)
block|{
name|DBGL
argument_list|(
name|DL_STATE
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"F_DFL: dial retry fail, dial retries exhausted"
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|dialresponse
argument_list|(
name|cep
argument_list|,
name|DSTAT_TFAIL
argument_list|)
expr_stmt|;
name|cep
operator|->
name|cdid
operator|=
name|CDID_UNUSED
expr_stmt|;
name|cep
operator|->
name|dial_count
operator|=
literal|0
expr_stmt|;
name|cep
operator|->
name|state
operator|=
name|ST_IDLE
expr_stmt|;
return|return;
block|}
comment|/* interface up/down active */
name|cep
operator|->
name|down_retry_count
operator|++
expr_stmt|;
if|if
condition|(
name|cep
operator|->
name|down_retry_count
operator|>
name|cep
operator|->
name|downtries
condition|)
block|{
comment|/* set interface down */
name|DBGL
argument_list|(
name|DL_STATE
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"F_DFL: dial retry cycle fail, setting interface down!"
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|dialresponse
argument_list|(
name|cep
argument_list|,
name|DSTAT_PFAIL
argument_list|)
expr_stmt|;
name|if_down
argument_list|(
name|cep
argument_list|)
expr_stmt|;
name|cep
operator|->
name|state
operator|=
name|ST_DOWN
expr_stmt|;
block|}
else|else
block|{
comment|/* enter new dial retry cycle */
name|DBGL
argument_list|(
name|DL_STATE
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"F_DFL: dial retry cycle fail, enter new retry cycle!"
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|select_next_dialno
argument_list|(
name|cep
argument_list|)
expr_stmt|;
name|cep
operator|->
name|state
operator|=
name|ST_DIALRTMRCHD
expr_stmt|;
block|}
name|cep
operator|->
name|dial_count
operator|=
literal|0
expr_stmt|;
name|cep
operator|->
name|cdid
operator|=
name|CDID_RESERVED
expr_stmt|;
block|}
else|else
comment|/* cdp->dialouttype == DIALOUT_CALLEDBACK */
block|{
name|DBGL
argument_list|(
name|DL_STATE
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"F_DFL: calledback dial done, wait for incoming call"
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|cep
operator|->
name|cdid
operator|=
name|CDID_RESERVED
expr_stmt|;
name|cep
operator|->
name|state
operator|=
name|ST_PCB_WAITCALL
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	local requested outgoing dial  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|F_ACBW
parameter_list|(
name|cfg_entry_t
modifier|*
name|cep
parameter_list|)
block|{
name|DBGL
argument_list|(
name|DL_STATE
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"F_ACBW: local callback, wait callback recovery time"
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cep
operator|->
name|dialrandincr
condition|)
name|cep
operator|->
name|randomtime
operator|=
operator|(
name|random
argument_list|()
operator|&
name|RANDOM_MASK
operator|)
operator|+
name|cep
operator|->
name|recoverytime
expr_stmt|;
name|cep
operator|->
name|dial_count
operator|=
literal|0
expr_stmt|;
name|cep
operator|->
name|cdid
operator|=
name|CDID_RESERVED
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	active callback dialout retry (ST_SUSE !!!)  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|F_ACBR
parameter_list|(
name|cfg_entry_t
modifier|*
name|cep
parameter_list|)
block|{
name|cep
operator|->
name|dial_count
operator|++
expr_stmt|;
if|if
condition|(
name|cep
operator|->
name|dial_count
operator|<
name|cep
operator|->
name|dialretries
condition|)
block|{
comment|/* inside normal retry cycle */
name|DBGL
argument_list|(
name|DL_STATE
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"F_ACBR: dial fail, dial retry"
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|select_next_dialno
argument_list|(
name|cep
argument_list|)
expr_stmt|;
name|cep
operator|->
name|cdid
operator|=
name|CDID_RESERVED
expr_stmt|;
name|cep
operator|->
name|state
operator|=
name|ST_ACB_DIALFAIL
expr_stmt|;
return|return;
block|}
comment|/* retries exhausted */
if|if
condition|(
operator|!
name|cep
operator|->
name|usedown
condition|)
block|{
name|DBGL
argument_list|(
name|DL_STATE
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"F_ACBR: dial retry fail, dial retries exhausted"
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|dialresponse
argument_list|(
name|cep
argument_list|,
name|DSTAT_TFAIL
argument_list|)
expr_stmt|;
name|cep
operator|->
name|cdid
operator|=
name|CDID_UNUSED
expr_stmt|;
name|cep
operator|->
name|dial_count
operator|=
literal|0
expr_stmt|;
name|cep
operator|->
name|state
operator|=
name|ST_IDLE
expr_stmt|;
return|return;
block|}
comment|/* interface up/down active */
name|cep
operator|->
name|down_retry_count
operator|++
expr_stmt|;
if|if
condition|(
name|cep
operator|->
name|down_retry_count
operator|>
name|cep
operator|->
name|downtries
condition|)
block|{
comment|/* set interface down */
name|DBGL
argument_list|(
name|DL_STATE
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"F_ACBR: dial retry cycle fail, setting interface down!"
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|dialresponse
argument_list|(
name|cep
argument_list|,
name|DSTAT_PFAIL
argument_list|)
expr_stmt|;
name|if_down
argument_list|(
name|cep
argument_list|)
expr_stmt|;
name|cep
operator|->
name|state
operator|=
name|ST_DOWN
expr_stmt|;
block|}
else|else
block|{
comment|/* enter new dial retry cycle */
name|DBGL
argument_list|(
name|DL_STATE
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"F_ACBR: dial retry cycle fail, enter new retry cycle!"
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|select_next_dialno
argument_list|(
name|cep
argument_list|)
expr_stmt|;
name|cep
operator|->
name|state
operator|=
name|ST_ACB_DIALFAIL
expr_stmt|;
block|}
name|cep
operator|->
name|dial_count
operator|=
literal|0
expr_stmt|;
name|cep
operator|->
name|cdid
operator|=
name|CDID_RESERVED
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	local requested to send ALERT message  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|F_ALRT
parameter_list|(
name|cfg_entry_t
modifier|*
name|cep
parameter_list|)
block|{
name|DBGL
argument_list|(
name|DL_STATE
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"F_ALRT: local send alert request"
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|cep
operator|->
name|alert_time
operator|=
name|cep
operator|->
name|alert
expr_stmt|;
name|sendm_alert_req
argument_list|(
name|cep
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	isdn daemon state transition table  *---------------------------------------------------------------------------*/
end_comment

begin_struct
struct|struct
name|state_tab
block|{
name|void
function_decl|(
modifier|*
name|func
function_decl|)
parameter_list|(
name|cfg_entry_t
modifier|*
name|cep
parameter_list|)
function_decl|;
comment|/* function to execute */
name|int
name|newstate
decl_stmt|;
comment|/* next state */
block|}
name|state_tab
index|[
name|N_EVENTS
index|]
index|[
name|N_STATES
index|]
init|=
block|{
comment|/* STATE:	ST_IDLE			ST_DIAL			ST_DIALRTMRCHD		ST_DIALRETRY		ST_PCB_DIAL		ST_PCB_DIALFAIL		ST_PCB_WAITCALL		ST_ACB_WAITDISC		ST_ACB_WAITDIAL 	ST_ACB_DIAL		ST_ACB_DIALFAIL		ST_ACCEPTED		ST_CONNECTED		ST_WAITDISCI		ST_DOWN			ST_ALERT		ST_ILLEGAL		*/
comment|/* -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
comment|/* messages */
comment|/* EV_MCI   */
block|{
block|{
name|F_MCI
block|,
name|ST_ACCEPTED
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_MCI
block|,
name|ST_ACCEPTED
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_MCI
block|,
name|ST_ACCEPTED
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|}
block|,
comment|/* EV_MCAI  */
block|{
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_DOK
block|,
name|ST_CONNECTED
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_DOK
block|,
name|ST_CONNECTED
block|}
block|,
block|{
name|F_DOK
block|,
name|ST_CONNECTED
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_DOK
block|,
name|ST_CONNECTED
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_MCAI
block|,
name|ST_CONNECTED
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|}
block|,
comment|/* EV_MDI   */
block|{
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_DFL
block|,
name|ST_SUSE
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_DFL
block|,
name|ST_SUSE
block|}
block|,
block|{
name|F_DFL
block|,
name|ST_SUSE
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ACBW
block|,
name|ST_ACB_WAITDIAL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ACBR
block|,
name|ST_SUSE
block|}
block|,
block|{
name|F_ACBR
block|,
name|ST_SUSE
block|}
block|,
block|{
name|F_IDIS
block|,
name|ST_IDLE
block|}
block|,
block|{
name|F_IDIS
block|,
name|ST_IDLE
block|}
block|,
block|{
name|F_MDI
block|,
name|ST_IDLE
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_MDI
block|,
name|ST_IDLE
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|}
block|,
comment|/* EV_MDO   */
block|{
block|{
name|F_DIAL
block|,
name|ST_DIAL
block|}
block|,
block|{
name|F_NcNa
block|,
name|ST_DIAL
block|}
block|,
block|{
name|F_NcNa
block|,
name|ST_DIALRTMRCHD
block|}
block|,
block|{
name|F_NcNa
block|,
name|ST_DIALRETRY
block|}
block|,
block|{
name|F_NcNa
block|,
name|ST_PCB_DIAL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|}
block|,
comment|/* local requests */
comment|/* EV_TIMO  */
block|{
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_TIMO
block|,
name|ST_IDLE
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|}
block|,
comment|/* EV_DRQ   */
block|{
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_DRQ
block|,
name|ST_WAITDISCI
block|}
block|,
block|{
name|F_NcNa
block|,
name|ST_WAITDISCI
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|}
block|,
comment|/* EV_CBRQ  */
block|{
block|{
name|F_NcNa
block|,
name|ST_ACB_WAITDIAL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_NcNa
block|,
name|ST_ACB_WAITDIAL
block|}
block|,
block|{
name|F_NcNa
block|,
name|ST_ACB_DIAL
block|}
block|,
block|{
name|F_NcNa
block|,
name|ST_ACB_DIALFAIL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|}
block|,
comment|/* EV_ALRT  */
block|{
block|{
name|F_ALRT
block|,
name|ST_ALERT
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|}
block|,
comment|/* illegal  */
comment|/* EV_ILL   */
block|{
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|,
block|{
name|F_ill
block|,
name|ST_ILL
block|}
block|}
block|}
struct|;
end_struct

begin_comment
comment|/*---------------------------------------------------------------------------*  *	event handler  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|next_state
parameter_list|(
name|cfg_entry_t
modifier|*
name|cep
parameter_list|,
name|int
name|event
parameter_list|)
block|{
name|int
name|currstate
decl_stmt|,
name|newstate
decl_stmt|;
if|if
condition|(
name|event
operator|>
name|N_EVENTS
condition|)
block|{
name|log
argument_list|(
name|LL_ERR
argument_list|,
literal|"FSM: event> N_EVENTS"
argument_list|)
expr_stmt|;
name|do_exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|currstate
operator|=
name|cep
operator|->
name|state
expr_stmt|;
if|if
condition|(
name|currstate
operator|>
name|N_STATES
condition|)
block|{
name|log
argument_list|(
name|LL_ERR
argument_list|,
literal|"FSM: currstate> N_STATES"
argument_list|)
expr_stmt|;
name|do_exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|newstate
operator|=
name|state_tab
index|[
name|event
index|]
index|[
name|currstate
index|]
operator|.
name|newstate
expr_stmt|;
if|if
condition|(
name|newstate
operator|>
name|N_STATES
condition|)
block|{
name|log
argument_list|(
name|LL_ERR
argument_list|,
literal|"FSM: newstate> N_STATES"
argument_list|)
expr_stmt|;
name|do_exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|newstate
operator|!=
name|ST_SUSE
condition|)
block|{
name|DBGL
argument_list|(
name|DL_STATE
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"FSM event [%s]: [%s => %s]"
argument_list|,
name|event_text
index|[
name|event
index|]
argument_list|,
name|state_text
index|[
name|currstate
index|]
argument_list|,
name|state_text
index|[
name|newstate
index|]
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
operator|(
operator|*
name|state_tab
index|[
name|event
index|]
index|[
name|currstate
index|]
operator|.
name|func
operator|)
operator|(
name|cep
operator|)
expr_stmt|;
if|if
condition|(
name|newstate
operator|==
name|ST_ILL
condition|)
block|{
name|log
argument_list|(
name|LL_ERR
argument_list|,
literal|"FSM ILLEGAL STATE, event=%s: oldstate=%s => newstate=%s]"
argument_list|,
name|event_text
index|[
name|event
index|]
argument_list|,
name|state_text
index|[
name|currstate
index|]
argument_list|,
name|state_text
index|[
name|newstate
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|newstate
operator|==
name|ST_SUSE
condition|)
block|{
name|DBGL
argument_list|(
name|DL_STATE
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"FSM (SUSE) event [%s]: [%s => %s]"
argument_list|,
name|event_text
index|[
name|event
index|]
argument_list|,
name|state_text
index|[
name|currstate
index|]
argument_list|,
name|state_text
index|[
name|cep
operator|->
name|state
index|]
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|cep
operator|->
name|state
operator|=
name|newstate
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	return pointer to current state description  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|char
modifier|*
name|printstate
parameter_list|(
name|cfg_entry_t
modifier|*
name|cep
parameter_list|)
block|{
return|return
operator|(
operator|(
name|char
operator|*
operator|)
name|state_text
index|[
name|cep
operator|->
name|state
index|]
operator|)
return|;
block|}
end_function

begin_comment
comment|/* EOF */
end_comment

end_unit


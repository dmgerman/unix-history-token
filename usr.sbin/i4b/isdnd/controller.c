begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1997, 2001 Hellmuth Michaelis. All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  *---------------------------------------------------------------------------  *  *	i4b daemon - controller state support routines  *	----------------------------------------------  *  * $FreeBSD$  *  *      last edit-date: [Sun May 20 10:03:53 2001]  *  *---------------------------------------------------------------------------*/
end_comment

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/mman.h>
end_include

begin_include
include|#
directive|include
file|"isdnd.h"
end_include

begin_function_decl
specifier|static
name|int
name|init_controller_state
parameter_list|(
name|int
name|controller
parameter_list|,
name|int
name|ctrl_type
parameter_list|,
name|int
name|card_type
parameter_list|,
name|int
name|tei
parameter_list|,
name|int
name|nbch
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*---------------------------------------------------------------------------*  *	get name of a controller  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|const
name|char
modifier|*
name|name_of_controller
parameter_list|(
name|int
name|ctrl_type
parameter_list|,
name|int
name|card_type
parameter_list|)
block|{
specifier|static
name|char
modifier|*
name|passive_card
index|[]
init|=
block|{
literal|"Teles S0/8"
block|,
literal|"Teles S0/16"
block|,
literal|"Teles S0/16.3"
block|,
literal|"AVM A1 or Fritz!Card"
block|,
literal|"Teles S0/16.3 PnP"
block|,
literal|"Creatix S0 PnP"
block|,
literal|"USRobotics Sportster ISDN TA"
block|,
literal|"Dr. Neuhaus NICCY Go@"
block|,
literal|"Sedlbauer win speed"
block|,
literal|"Dynalink IS64PH"
block|,
literal|"ISDN Master, MasterII or Blaster"
block|,
literal|"AVM PCMCIA Fritz!Card"
block|,
literal|"ELSA QuickStep 1000pro/ISA"
block|,
literal|"ELSA QuickStep 1000pro/PCI"
block|,
literal|"Siemens I-Talk"
block|,
literal|"ELSA MicroLink ISDN/MC"
block|,
literal|"ELSA MicroLink MCall"
block|,
literal|"ITK ix1 micro"
block|,
literal|"AVM Fritz!Card PCI"
block|,
literal|"ELSA PCC-16"
block|,
literal|"AVM Fritz!Card PnP"
block|,
literal|"Siemens I-Surf 2.0 PnP"
block|,
literal|"Asuscom ISDNlink 128K PnP"
block|,
literal|"ASUSCOM P-IN100-ST-D (Winbond W6692)"
block|,
literal|"Teles S0/16.3c PnP"
block|,
literal|"AcerISDN P10 PnP"
block|,
literal|"TELEINT ISDN SPEED No. 1"
block|,
literal|"Cologne Chip HFC-S PCI based"
block|,
literal|"Traverse Tech NETjet-S / Teles PCI-TJ"
block|,
literal|"Eicon.Diehl DIVA 2.0 / 2.02 ISA PnP"
block|, 	}
decl_stmt|;
specifier|static
name|char
modifier|*
name|daic_card
index|[]
init|=
block|{
literal|"EICON.Diehl S"
block|,
literal|"EICON.Diehl SX/SXn"
block|,
literal|"EICON.Diehl SCOM"
block|,
literal|"EICON.Diehl QUADRO"
block|, 	}
decl_stmt|;
specifier|static
name|char
modifier|*
name|capi_card
index|[]
init|=
block|{
literal|"AVM T1 PCI"
block|,
literal|"AVM B1 PCI"
block|,
literal|"AVM B1 ISA"
block|, 	}
decl_stmt|;
if|if
condition|(
name|ctrl_type
operator|==
name|CTRL_PASSIVE
condition|)
block|{
name|int
name|index
init|=
name|card_type
operator|-
name|CARD_TYPEP_8
decl_stmt|;
if|if
condition|(
name|index
operator|>=
literal|0
operator|&&
name|index
operator|<
operator|(
sizeof|sizeof
name|passive_card
operator|/
sizeof|sizeof
name|passive_card
index|[
literal|0
index|]
operator|)
condition|)
return|return
name|passive_card
index|[
name|index
index|]
return|;
block|}
elseif|else
if|if
condition|(
name|ctrl_type
operator|==
name|CTRL_DAIC
condition|)
block|{
name|int
name|index
init|=
name|card_type
operator|-
name|CARD_TYPEA_DAIC_S
decl_stmt|;
if|if
condition|(
name|index
operator|>=
literal|0
operator|&&
name|index
operator|<
operator|(
sizeof|sizeof
name|daic_card
operator|/
sizeof|sizeof
name|daic_card
index|[
literal|0
index|]
operator|)
condition|)
return|return
name|daic_card
index|[
name|index
index|]
return|;
block|}
elseif|else
if|if
condition|(
name|ctrl_type
operator|==
name|CTRL_TINADD
condition|)
block|{
return|return
literal|"Stollmann tina-dd"
return|;
block|}
elseif|else
if|if
condition|(
name|ctrl_type
operator|==
name|CTRL_CAPI
condition|)
block|{
name|int
name|index
init|=
name|card_type
operator|-
name|CARD_TYPEC_AVM_T1_PCI
decl_stmt|;
if|if
condition|(
name|index
operator|>=
literal|0
operator|&&
name|index
operator|<
operator|(
sizeof|sizeof
name|capi_card
operator|/
sizeof|sizeof
name|capi_card
index|[
literal|0
index|]
operator|)
condition|)
return|return
name|capi_card
index|[
name|index
index|]
return|;
block|}
return|return
literal|"unknown card type"
return|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	init controller state array  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|init_controller
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|max
init|=
literal|1
decl_stmt|;
name|msg_ctrl_info_req_t
name|mcir
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|max
condition|;
name|i
operator|++
control|)
block|{
name|mcir
operator|.
name|controller
operator|=
name|i
expr_stmt|;
if|if
condition|(
operator|(
name|ioctl
argument_list|(
name|isdnfd
argument_list|,
name|I4B_CTRL_INFO_REQ
argument_list|,
operator|&
name|mcir
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|log
argument_list|(
name|LL_ERR
argument_list|,
literal|"init_controller: ioctl I4B_CTRL_INFO_REQ failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|do_exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|ncontroller
operator|=
name|max
operator|=
name|mcir
operator|.
name|ncontroller
operator|)
operator|==
literal|0
condition|)
block|{
name|log
argument_list|(
name|LL_ERR
argument_list|,
literal|"init_controller: no ISDN controller found!"
argument_list|)
expr_stmt|;
name|do_exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mcir
operator|.
name|ctrl_type
operator|==
operator|-
literal|1
operator|||
name|mcir
operator|.
name|card_type
operator|==
operator|-
literal|1
condition|)
block|{
name|log
argument_list|(
name|LL_ERR
argument_list|,
literal|"init_controller: ctrl/card is invalid!"
argument_list|)
expr_stmt|;
name|do_exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* init controller tab */
if|if
condition|(
operator|(
name|init_controller_state
argument_list|(
name|i
argument_list|,
name|mcir
operator|.
name|ctrl_type
argument_list|,
name|mcir
operator|.
name|card_type
argument_list|,
name|mcir
operator|.
name|tei
argument_list|,
name|mcir
operator|.
name|nbch
argument_list|)
operator|)
operator|==
name|ERROR
condition|)
block|{
name|log
argument_list|(
name|LL_ERR
argument_list|,
literal|"init_controller: init_controller_state for controller %d failed"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|do_exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
name|DBGL
argument_list|(
name|DL_RCCF
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"init_controller: found %d ISDN controller(s)"
argument_list|,
name|max
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*--------------------------------------------------------------------------*  *	init controller state table entry  *--------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|int
name|init_controller_state
parameter_list|(
name|int
name|controller
parameter_list|,
name|int
name|ctrl_type
parameter_list|,
name|int
name|card_type
parameter_list|,
name|int
name|tei
parameter_list|,
name|int
name|nbch
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|(
name|controller
operator|<
literal|0
operator|)
operator|||
operator|(
name|controller
operator|>=
name|ncontroller
operator|)
condition|)
block|{
name|log
argument_list|(
name|LL_ERR
argument_list|,
literal|"init_controller_state: invalid controller number [%d]!"
argument_list|,
name|controller
argument_list|)
expr_stmt|;
return|return
operator|(
name|ERROR
operator|)
return|;
block|}
comment|/* init controller tab */
switch|switch
condition|(
name|ctrl_type
condition|)
block|{
case|case
name|CTRL_PASSIVE
case|:
if|if
condition|(
operator|(
name|card_type
operator|>
name|CARD_TYPEP_UNK
operator|)
operator|&&
operator|(
name|card_type
operator|<=
name|CARD_TYPEP_MAX
operator|)
condition|)
block|{
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|ctrl_type
operator|=
name|ctrl_type
expr_stmt|;
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|card_type
operator|=
name|card_type
expr_stmt|;
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|state
operator|=
name|CTRL_UP
expr_stmt|;
block|}
else|else
block|{
name|log
argument_list|(
name|LL_ERR
argument_list|,
literal|"init_controller_state: unknown card type %d"
argument_list|,
name|card_type
argument_list|)
expr_stmt|;
return|return
operator|(
name|ERROR
operator|)
return|;
block|}
break|break;
case|case
name|CTRL_DAIC
case|:
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|ctrl_type
operator|=
name|ctrl_type
expr_stmt|;
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|card_type
operator|=
name|card_type
expr_stmt|;
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|state
operator|=
name|CTRL_DOWN
expr_stmt|;
break|break;
case|case
name|CTRL_TINADD
case|:
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|ctrl_type
operator|=
name|ctrl_type
expr_stmt|;
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|card_type
operator|=
literal|0
expr_stmt|;
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|state
operator|=
name|CTRL_DOWN
expr_stmt|;
break|break;
case|case
name|CTRL_CAPI
case|:
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|ctrl_type
operator|=
name|ctrl_type
expr_stmt|;
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|card_type
operator|=
name|card_type
expr_stmt|;
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|state
operator|=
name|CTRL_UP
expr_stmt|;
break|break;
default|default:
name|log
argument_list|(
name|LL_ERR
argument_list|,
literal|"init_controller_state: unknown controller type %d"
argument_list|,
name|ctrl_type
argument_list|)
expr_stmt|;
return|return
operator|(
name|ERROR
operator|)
return|;
block|}
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|nbch
operator|=
name|nbch
expr_stmt|;
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|freechans
operator|=
name|nbch
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nbch
condition|;
name|i
operator|++
control|)
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|stateb
index|[
name|i
index|]
operator|=
name|CHAN_IDLE
expr_stmt|;
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|tei
operator|=
name|tei
expr_stmt|;
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|l1stat
operator|=
name|LAYER_IDLE
expr_stmt|;
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|l2stat
operator|=
name|LAYER_IDLE
expr_stmt|;
name|log
argument_list|(
name|LL_DMN
argument_list|,
literal|"init_controller_state: controller %d is %s"
argument_list|,
name|controller
argument_list|,
name|name_of_controller
argument_list|(
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|ctrl_type
argument_list|,
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|card_type
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|GOOD
operator|)
return|;
block|}
end_function

begin_comment
comment|/*--------------------------------------------------------------------------*  *	init active or capi controller  *--------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|init_active_controller
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|int
name|unit
init|=
literal|0
decl_stmt|;
name|int
name|controller
decl_stmt|;
name|char
name|cmdbuf
index|[
name|MAXPATHLEN
operator|+
literal|128
index|]
decl_stmt|;
for|for
control|(
name|controller
operator|=
literal|0
init|;
name|controller
operator|<
name|ncontroller
condition|;
name|controller
operator|++
control|)
block|{
if|if
condition|(
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|ctrl_type
operator|==
name|CTRL_TINADD
condition|)
block|{
name|DBGL
argument_list|(
name|DL_RCCF
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"init_active_controller, tina-dd %d: executing [%s %d]"
argument_list|,
name|unit
argument_list|,
name|tinainitprog
argument_list|,
name|unit
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|cmdbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|cmdbuf
argument_list|)
argument_list|,
literal|"%s %d"
argument_list|,
name|tinainitprog
argument_list|,
name|unit
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ret
operator|=
name|system
argument_list|(
name|cmdbuf
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|log
argument_list|(
name|LL_ERR
argument_list|,
literal|"init_active_controller, tina-dd %d: %s returned %d!"
argument_list|,
name|unit
argument_list|,
name|tinainitprog
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|do_exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* 		 *  Generic microcode loading. If a controller has 		 *  defined a microcode file, load it using the 		 *  I4B_CTRL_DOWNLOAD ioctl. 		 */
if|if
condition|(
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|firmware
operator|!=
name|NULL
condition|)
block|{
name|int
name|fd
decl_stmt|,
name|ret
decl_stmt|;
name|struct
name|isdn_dr_prot
name|idp
decl_stmt|;
name|struct
name|isdn_download_request
name|idr
decl_stmt|;
name|fd
operator|=
name|open
argument_list|(
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|firmware
argument_list|,
name|O_RDONLY
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|<
literal|0
condition|)
block|{
name|log
argument_list|(
name|LL_ERR
argument_list|,
literal|"init_active_controller %d: open %s: %s!"
argument_list|,
name|controller
argument_list|,
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|firmware
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|do_exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|idp
operator|.
name|bytecount
operator|=
name|lseek
argument_list|(
name|fd
argument_list|,
literal|0
argument_list|,
name|SEEK_END
argument_list|)
expr_stmt|;
name|idp
operator|.
name|microcode
operator|=
name|mmap
argument_list|(
literal|0
argument_list|,
name|idp
operator|.
name|bytecount
argument_list|,
name|PROT_READ
argument_list|,
name|MAP_SHARED
argument_list|,
name|fd
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|idp
operator|.
name|microcode
operator|==
name|MAP_FAILED
condition|)
block|{
name|log
argument_list|(
name|LL_ERR
argument_list|,
literal|"init_active_controller %d: mmap %s: %s!"
argument_list|,
name|controller
argument_list|,
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|firmware
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|do_exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|DBGL
argument_list|(
name|DL_RCCF
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"init_active_controller %d: loading firmware from [%s]"
argument_list|,
name|controller
argument_list|,
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|firmware
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|idr
operator|.
name|controller
operator|=
name|controller
expr_stmt|;
name|idr
operator|.
name|numprotos
operator|=
literal|1
expr_stmt|;
name|idr
operator|.
name|protocols
operator|=
operator|&
name|idp
expr_stmt|;
name|ret
operator|=
name|ioctl
argument_list|(
name|isdnfd
argument_list|,
name|I4B_CTRL_DOWNLOAD
argument_list|,
operator|&
name|idr
argument_list|,
sizeof|sizeof
argument_list|(
name|idr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|log
argument_list|(
name|LL_ERR
argument_list|,
literal|"init_active_controller %d: load %s: %s!"
argument_list|,
name|controller
argument_list|,
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|firmware
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|do_exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|munmap
argument_list|(
name|idp
operator|.
name|microcode
argument_list|,
name|idp
operator|.
name|bytecount
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*--------------------------------------------------------------------------*  *	init controller D-channel ISDN protocol  *--------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|init_controller_protocol
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|controller
decl_stmt|;
name|msg_prot_ind_t
name|mpi
decl_stmt|;
for|for
control|(
name|controller
operator|=
literal|0
init|;
name|controller
operator|<
name|ncontroller
condition|;
name|controller
operator|++
control|)
block|{
name|mpi
operator|.
name|controller
operator|=
name|controller
expr_stmt|;
name|mpi
operator|.
name|protocol
operator|=
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|protocol
expr_stmt|;
if|if
condition|(
operator|(
name|ioctl
argument_list|(
name|isdnfd
argument_list|,
name|I4B_PROT_IND
argument_list|,
operator|&
name|mpi
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|log
argument_list|(
name|LL_ERR
argument_list|,
literal|"init_controller_protocol: ioctl I4B_PROT_IND failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|do_exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*--------------------------------------------------------------------------*  *	set controller state to UP/DOWN  *--------------------------------------------------------------------------*/
end_comment

begin_function
name|int
name|set_controller_state
parameter_list|(
name|int
name|controller
parameter_list|,
name|int
name|state
parameter_list|)
block|{
if|if
condition|(
operator|(
name|controller
operator|<
literal|0
operator|)
operator|||
operator|(
name|controller
operator|>=
name|ncontroller
operator|)
condition|)
block|{
name|log
argument_list|(
name|LL_ERR
argument_list|,
literal|"set_controller_state: invalid controller number [%d]!"
argument_list|,
name|controller
argument_list|)
expr_stmt|;
return|return
operator|(
name|ERROR
operator|)
return|;
block|}
if|if
condition|(
name|state
operator|==
name|CTRL_UP
condition|)
block|{
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|state
operator|=
name|CTRL_UP
expr_stmt|;
name|DBGL
argument_list|(
name|DL_CNST
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"set_controller_state: controller [%d] set UP!"
argument_list|,
name|controller
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|state
operator|==
name|CTRL_DOWN
condition|)
block|{
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|state
operator|=
name|CTRL_DOWN
expr_stmt|;
name|DBGL
argument_list|(
name|DL_CNST
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"set_controller_state: controller [%d] set DOWN!"
argument_list|,
name|controller
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|log
argument_list|(
name|LL_ERR
argument_list|,
literal|"set_controller_state: invalid controller state [%d]!"
argument_list|,
name|state
argument_list|)
expr_stmt|;
return|return
operator|(
name|ERROR
operator|)
return|;
block|}
return|return
operator|(
name|GOOD
operator|)
return|;
block|}
end_function

begin_comment
comment|/*--------------------------------------------------------------------------*  *	get controller state  *--------------------------------------------------------------------------*/
end_comment

begin_function
name|int
name|get_controller_state
parameter_list|(
name|int
name|controller
parameter_list|)
block|{
if|if
condition|(
operator|(
name|controller
operator|<
literal|0
operator|)
operator|||
operator|(
name|controller
operator|>=
name|ncontroller
operator|)
condition|)
block|{
name|log
argument_list|(
name|LL_ERR
argument_list|,
literal|"set_controller_state: invalid controller number [%d]!"
argument_list|,
name|controller
argument_list|)
expr_stmt|;
return|return
operator|(
name|ERROR
operator|)
return|;
block|}
return|return
operator|(
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|state
operator|)
return|;
block|}
end_function

begin_comment
comment|/*--------------------------------------------------------------------------*  *	decrement number of free channels for controller  *--------------------------------------------------------------------------*/
end_comment

begin_function
name|int
name|decr_free_channels
parameter_list|(
name|int
name|controller
parameter_list|)
block|{
if|if
condition|(
operator|(
name|controller
operator|<
literal|0
operator|)
operator|||
operator|(
name|controller
operator|>=
name|ncontroller
operator|)
condition|)
block|{
name|log
argument_list|(
name|LL_ERR
argument_list|,
literal|"decr_free_channels: invalid controller number [%d]!"
argument_list|,
name|controller
argument_list|)
expr_stmt|;
return|return
operator|(
name|ERROR
operator|)
return|;
block|}
if|if
condition|(
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|freechans
operator|>
literal|0
condition|)
block|{
operator|(
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|freechans
operator|)
operator|--
expr_stmt|;
name|DBGL
argument_list|(
name|DL_CNST
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"decr_free_channels: ctrl %d, now %d chan free"
argument_list|,
name|controller
argument_list|,
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|freechans
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|GOOD
operator|)
return|;
block|}
else|else
block|{
name|log
argument_list|(
name|LL_ERR
argument_list|,
literal|"decr_free_channels: controller [%d] already 0 free chans!"
argument_list|,
name|controller
argument_list|)
expr_stmt|;
return|return
operator|(
name|ERROR
operator|)
return|;
block|}
block|}
end_function

begin_comment
comment|/*--------------------------------------------------------------------------*  *	increment number of free channels for controller  *--------------------------------------------------------------------------*/
end_comment

begin_function
name|int
name|incr_free_channels
parameter_list|(
name|int
name|controller
parameter_list|)
block|{
if|if
condition|(
operator|(
name|controller
operator|<
literal|0
operator|)
operator|||
operator|(
name|controller
operator|>=
name|ncontroller
operator|)
condition|)
block|{
name|log
argument_list|(
name|LL_ERR
argument_list|,
literal|"incr_free_channels: invalid controller number [%d]!"
argument_list|,
name|controller
argument_list|)
expr_stmt|;
return|return
operator|(
name|ERROR
operator|)
return|;
block|}
if|if
condition|(
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|freechans
operator|<
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|nbch
condition|)
block|{
operator|(
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|freechans
operator|)
operator|++
expr_stmt|;
name|DBGL
argument_list|(
name|DL_CNST
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"incr_free_channels: ctrl %d, now %d chan free"
argument_list|,
name|controller
argument_list|,
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|freechans
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|GOOD
operator|)
return|;
block|}
else|else
block|{
name|log
argument_list|(
name|LL_ERR
argument_list|,
literal|"incr_free_channels: controller [%d] already %d free chans!"
argument_list|,
name|controller
argument_list|,
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|nbch
argument_list|)
expr_stmt|;
return|return
operator|(
name|ERROR
operator|)
return|;
block|}
block|}
end_function

begin_comment
comment|/*--------------------------------------------------------------------------*  *	get number of free channels for controller  *--------------------------------------------------------------------------*/
end_comment

begin_function
name|int
name|get_free_channels
parameter_list|(
name|int
name|controller
parameter_list|)
block|{
if|if
condition|(
operator|(
name|controller
operator|<
literal|0
operator|)
operator|||
operator|(
name|controller
operator|>=
name|ncontroller
operator|)
condition|)
block|{
name|log
argument_list|(
name|LL_ERR
argument_list|,
literal|"get_free_channels: invalid controller number [%d]!"
argument_list|,
name|controller
argument_list|)
expr_stmt|;
return|return
operator|(
name|ERROR
operator|)
return|;
block|}
name|DBGL
argument_list|(
name|DL_CNST
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"get_free_channels: ctrl %d, %d chan free"
argument_list|,
name|controller
argument_list|,
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|freechans
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|freechans
operator|)
return|;
block|}
end_function

begin_comment
comment|/*--------------------------------------------------------------------------*  *	set channel state to busy  *--------------------------------------------------------------------------*/
end_comment

begin_function
name|int
name|set_channel_busy
parameter_list|(
name|int
name|controller
parameter_list|,
name|int
name|channel
parameter_list|)
block|{
if|if
condition|(
operator|(
name|controller
operator|<
literal|0
operator|)
operator|||
operator|(
name|controller
operator|>=
name|ncontroller
operator|)
condition|)
block|{
name|log
argument_list|(
name|LL_ERR
argument_list|,
literal|"set_channel_busy: invalid controller number [%d]!"
argument_list|,
name|controller
argument_list|)
expr_stmt|;
return|return
operator|(
name|ERROR
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|channel
operator|<
literal|0
operator|)
operator|||
operator|(
name|channel
operator|>=
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|nbch
operator|)
condition|)
block|{
name|log
argument_list|(
name|LL_ERR
argument_list|,
literal|"set_channel_busy: controller [%d] invalid channel [%d]!"
argument_list|,
name|controller
argument_list|,
name|channel
argument_list|)
expr_stmt|;
return|return
operator|(
name|ERROR
operator|)
return|;
block|}
if|if
condition|(
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|stateb
index|[
name|channel
index|]
operator|==
name|CHAN_RUN
condition|)
block|{
name|DBGL
argument_list|(
name|DL_CNST
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"set_channel_busy: controller [%d] channel B%d already busy!"
argument_list|,
name|controller
argument_list|,
name|channel
operator|+
literal|1
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|stateb
index|[
name|channel
index|]
operator|=
name|CHAN_RUN
expr_stmt|;
name|DBGL
argument_list|(
name|DL_CNST
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"set_channel_busy: controller [%d] channel B%d set to BUSY!"
argument_list|,
name|controller
argument_list|,
name|channel
operator|+
literal|1
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|GOOD
operator|)
return|;
block|}
end_function

begin_comment
comment|/*--------------------------------------------------------------------------*  *	set channel state to idle  *--------------------------------------------------------------------------*/
end_comment

begin_function
name|int
name|set_channel_idle
parameter_list|(
name|int
name|controller
parameter_list|,
name|int
name|channel
parameter_list|)
block|{
if|if
condition|(
operator|(
name|controller
operator|<
literal|0
operator|)
operator|||
operator|(
name|controller
operator|>=
name|ncontroller
operator|)
condition|)
block|{
name|log
argument_list|(
name|LL_ERR
argument_list|,
literal|"set_channel_idle: invalid controller number [%d]!"
argument_list|,
name|controller
argument_list|)
expr_stmt|;
return|return
operator|(
name|ERROR
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|channel
operator|<
literal|0
operator|)
operator|||
operator|(
name|channel
operator|>=
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|nbch
operator|)
condition|)
block|{
name|log
argument_list|(
name|LL_ERR
argument_list|,
literal|"set_channel_busy: controller [%d] invalid channel [%d]!"
argument_list|,
name|controller
argument_list|,
name|channel
argument_list|)
expr_stmt|;
return|return
operator|(
name|ERROR
operator|)
return|;
block|}
if|if
condition|(
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|stateb
index|[
name|channel
index|]
operator|==
name|CHAN_IDLE
condition|)
block|{
name|DBGL
argument_list|(
name|DL_CNST
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"set_channel_idle: controller [%d] channel B%d already idle!"
argument_list|,
name|controller
argument_list|,
name|channel
operator|+
literal|1
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|stateb
index|[
name|channel
index|]
operator|=
name|CHAN_IDLE
expr_stmt|;
name|DBGL
argument_list|(
name|DL_CNST
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"set_channel_idle: controller [%d] channel B%d set to IDLE!"
argument_list|,
name|controller
argument_list|,
name|channel
operator|+
literal|1
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|GOOD
operator|)
return|;
block|}
end_function

begin_comment
comment|/*--------------------------------------------------------------------------*  *	return channel state  *--------------------------------------------------------------------------*/
end_comment

begin_function
name|int
name|ret_channel_state
parameter_list|(
name|int
name|controller
parameter_list|,
name|int
name|channel
parameter_list|)
block|{
if|if
condition|(
operator|(
name|controller
operator|<
literal|0
operator|)
operator|||
operator|(
name|controller
operator|>=
name|ncontroller
operator|)
condition|)
block|{
name|log
argument_list|(
name|LL_ERR
argument_list|,
literal|"ret_channel_state: invalid controller number [%d]!"
argument_list|,
name|controller
argument_list|)
expr_stmt|;
return|return
operator|(
name|ERROR
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|channel
operator|<
literal|0
operator|)
operator|||
operator|(
name|channel
operator|>=
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|nbch
operator|)
condition|)
block|{
name|log
argument_list|(
name|LL_ERR
argument_list|,
literal|"set_channel_busy: controller [%d] invalid channel [%d]!"
argument_list|,
name|controller
argument_list|,
name|channel
argument_list|)
expr_stmt|;
return|return
operator|(
name|ERROR
operator|)
return|;
block|}
return|return
operator|(
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|stateb
index|[
name|channel
index|]
operator|)
return|;
block|}
end_function

begin_comment
comment|/* EOF */
end_comment

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1997, 1998 Hellmuth Michaelis. All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  *---------------------------------------------------------------------------  *  *	i4b daemon - controller state support routines  *	----------------------------------------------  *  *	$Id: controller.c,v 1.10 1998/12/05 18:03:06 hm Exp $  *  *      last edit-date: [Sat Dec  5 18:06:10 1998]  *  *---------------------------------------------------------------------------*/
end_comment

begin_include
include|#
directive|include
file|"isdnd.h"
end_include

begin_comment
comment|/*--------------------------------------------------------------------------*  *	init controller state table entry  *--------------------------------------------------------------------------*/
end_comment

begin_function
name|int
name|init_controller_state
parameter_list|(
name|int
name|controller
parameter_list|,
name|int
name|ctrl_type
parameter_list|,
name|int
name|card_type
parameter_list|,
name|int
name|tei
parameter_list|)
block|{
if|if
condition|(
operator|(
name|controller
operator|<
literal|0
operator|)
operator|||
operator|(
name|controller
operator|>=
name|ncontroller
operator|)
condition|)
block|{
name|log
argument_list|(
name|LL_ERR
argument_list|,
literal|"init_controller_state: invalid controller number [%d]!"
argument_list|,
name|controller
argument_list|)
expr_stmt|;
return|return
operator|(
name|ERROR
operator|)
return|;
block|}
comment|/* init controller tab */
if|if
condition|(
name|ctrl_type
operator|==
name|CTRL_PASSIVE
condition|)
block|{
if|if
condition|(
operator|(
name|card_type
operator|>
name|CARD_TYPEP_UNK
operator|)
operator|&&
operator|(
name|card_type
operator|<=
name|CARD_TYPEP_MAX
operator|)
condition|)
block|{
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|ctrl_type
operator|=
name|ctrl_type
expr_stmt|;
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|card_type
operator|=
name|card_type
expr_stmt|;
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|state
operator|=
name|CTRL_UP
expr_stmt|;
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|stateb1
operator|=
name|CHAN_IDLE
expr_stmt|;
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|stateb2
operator|=
name|CHAN_IDLE
expr_stmt|;
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|freechans
operator|=
name|MAX_CHANCTRL
expr_stmt|;
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|tei
operator|=
name|tei
expr_stmt|;
name|log
argument_list|(
name|LL_DMN
argument_list|,
literal|"init_controller_state: controller %d is %s"
argument_list|,
name|controller
argument_list|,
name|name_of_controller
argument_list|(
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|ctrl_type
argument_list|,
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|card_type
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|log
argument_list|(
name|LL_ERR
argument_list|,
literal|"init_controller_state: unknown card type %d"
argument_list|,
name|card_type
argument_list|)
expr_stmt|;
return|return
operator|(
name|ERROR
operator|)
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|ctrl_type
operator|==
name|CTRL_DAIC
condition|)
block|{
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|ctrl_type
operator|=
name|ctrl_type
expr_stmt|;
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|card_type
operator|=
name|card_type
expr_stmt|;
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|state
operator|=
name|CTRL_DOWN
expr_stmt|;
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|stateb1
operator|=
name|CHAN_IDLE
expr_stmt|;
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|stateb2
operator|=
name|CHAN_IDLE
expr_stmt|;
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|freechans
operator|=
name|MAX_CHANCTRL
expr_stmt|;
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|tei
operator|=
operator|-
literal|1
expr_stmt|;
name|log
argument_list|(
name|LL_DMN
argument_list|,
literal|"init_controller_state: controller %d is %s"
argument_list|,
name|controller
argument_list|,
name|name_of_controller
argument_list|(
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|ctrl_type
argument_list|,
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|card_type
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* XXX active controller init here !!! */
name|log
argument_list|(
name|LL_ERR
argument_list|,
literal|"init_controller_state: unknown controller type %d"
argument_list|,
name|ctrl_type
argument_list|)
expr_stmt|;
return|return
operator|(
name|ERROR
operator|)
return|;
block|}
return|return
operator|(
name|GOOD
operator|)
return|;
block|}
end_function

begin_comment
comment|/*--------------------------------------------------------------------------*  *	set controller state to UP/DOWN  *--------------------------------------------------------------------------*/
end_comment

begin_function
name|int
name|set_controller_state
parameter_list|(
name|int
name|controller
parameter_list|,
name|int
name|state
parameter_list|)
block|{
if|if
condition|(
operator|(
name|controller
operator|<
literal|0
operator|)
operator|||
operator|(
name|controller
operator|>=
name|ncontroller
operator|)
condition|)
block|{
name|log
argument_list|(
name|LL_ERR
argument_list|,
literal|"set_controller_state: invalid controller number [%d]!"
argument_list|,
name|controller
argument_list|)
expr_stmt|;
return|return
operator|(
name|ERROR
operator|)
return|;
block|}
if|if
condition|(
name|state
operator|==
name|CTRL_UP
condition|)
block|{
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|state
operator|=
name|CTRL_UP
expr_stmt|;
name|DBGL
argument_list|(
name|DL_CNST
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"set_controller_state: controller [%d] set UP!"
argument_list|,
name|controller
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|state
operator|==
name|CTRL_DOWN
condition|)
block|{
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|state
operator|=
name|CTRL_DOWN
expr_stmt|;
name|DBGL
argument_list|(
name|DL_CNST
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"set_controller_state: controller [%d] set DOWN!"
argument_list|,
name|controller
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|log
argument_list|(
name|LL_ERR
argument_list|,
literal|"set_controller_state: invalid controller state [%d]!"
argument_list|,
name|state
argument_list|)
expr_stmt|;
return|return
operator|(
name|ERROR
operator|)
return|;
block|}
return|return
operator|(
name|GOOD
operator|)
return|;
block|}
end_function

begin_comment
comment|/*--------------------------------------------------------------------------*  *	get controller state  *--------------------------------------------------------------------------*/
end_comment

begin_function
name|int
name|get_controller_state
parameter_list|(
name|int
name|controller
parameter_list|)
block|{
if|if
condition|(
operator|(
name|controller
operator|<
literal|0
operator|)
operator|||
operator|(
name|controller
operator|>=
name|ncontroller
operator|)
condition|)
block|{
name|log
argument_list|(
name|LL_ERR
argument_list|,
literal|"set_controller_state: invalid controller number [%d]!"
argument_list|,
name|controller
argument_list|)
expr_stmt|;
return|return
operator|(
name|ERROR
operator|)
return|;
block|}
return|return
operator|(
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|state
operator|)
return|;
block|}
end_function

begin_comment
comment|/*--------------------------------------------------------------------------*  *	decrement number of free channels for controller  *--------------------------------------------------------------------------*/
end_comment

begin_function
name|int
name|decr_free_channels
parameter_list|(
name|int
name|controller
parameter_list|)
block|{
if|if
condition|(
operator|(
name|controller
operator|<
literal|0
operator|)
operator|||
operator|(
name|controller
operator|>=
name|ncontroller
operator|)
condition|)
block|{
name|log
argument_list|(
name|LL_ERR
argument_list|,
literal|"decr_free_channels: invalid controller number [%d]!"
argument_list|,
name|controller
argument_list|)
expr_stmt|;
return|return
operator|(
name|ERROR
operator|)
return|;
block|}
if|if
condition|(
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|freechans
operator|>
literal|0
condition|)
block|{
operator|(
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|freechans
operator|)
operator|--
expr_stmt|;
name|DBGL
argument_list|(
name|DL_CNST
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"decr_free_channels: ctrl %d, now %d chan free"
argument_list|,
name|controller
argument_list|,
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|freechans
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|GOOD
operator|)
return|;
block|}
else|else
block|{
name|log
argument_list|(
name|LL_ERR
argument_list|,
literal|"decr_free_channels: controller [%d] already 0 free chans!"
argument_list|,
name|controller
argument_list|)
expr_stmt|;
return|return
operator|(
name|ERROR
operator|)
return|;
block|}
block|}
end_function

begin_comment
comment|/*--------------------------------------------------------------------------*  *	increment number of free channels for controller  *--------------------------------------------------------------------------*/
end_comment

begin_function
name|int
name|incr_free_channels
parameter_list|(
name|int
name|controller
parameter_list|)
block|{
if|if
condition|(
operator|(
name|controller
operator|<
literal|0
operator|)
operator|||
operator|(
name|controller
operator|>=
name|ncontroller
operator|)
condition|)
block|{
name|log
argument_list|(
name|LL_ERR
argument_list|,
literal|"incr_free_channels: invalid controller number [%d]!"
argument_list|,
name|controller
argument_list|)
expr_stmt|;
return|return
operator|(
name|ERROR
operator|)
return|;
block|}
if|if
condition|(
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|freechans
operator|<
name|MAX_CHANCTRL
condition|)
block|{
operator|(
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|freechans
operator|)
operator|++
expr_stmt|;
name|DBGL
argument_list|(
name|DL_CNST
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"incr_free_channels: ctrl %d, now %d chan free"
argument_list|,
name|controller
argument_list|,
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|freechans
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|GOOD
operator|)
return|;
block|}
else|else
block|{
name|log
argument_list|(
name|LL_ERR
argument_list|,
literal|"incr_free_channels: controller [%d] already 2 free chans!"
argument_list|,
name|controller
argument_list|)
expr_stmt|;
return|return
operator|(
name|ERROR
operator|)
return|;
block|}
block|}
end_function

begin_comment
comment|/*--------------------------------------------------------------------------*  *	get number of free channels for controller  *--------------------------------------------------------------------------*/
end_comment

begin_function
name|int
name|get_free_channels
parameter_list|(
name|int
name|controller
parameter_list|)
block|{
if|if
condition|(
operator|(
name|controller
operator|<
literal|0
operator|)
operator|||
operator|(
name|controller
operator|>=
name|ncontroller
operator|)
condition|)
block|{
name|log
argument_list|(
name|LL_ERR
argument_list|,
literal|"get_free_channels: invalid controller number [%d]!"
argument_list|,
name|controller
argument_list|)
expr_stmt|;
return|return
operator|(
name|ERROR
operator|)
return|;
block|}
name|DBGL
argument_list|(
name|DL_CNST
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"get_free_channels: ctrl %d, %d chan free"
argument_list|,
name|controller
argument_list|,
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|freechans
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|freechans
operator|)
return|;
block|}
end_function

begin_comment
comment|/*--------------------------------------------------------------------------*  *	set channel state to busy  *--------------------------------------------------------------------------*/
end_comment

begin_function
name|int
name|set_channel_busy
parameter_list|(
name|int
name|controller
parameter_list|,
name|int
name|channel
parameter_list|)
block|{
if|if
condition|(
operator|(
name|controller
operator|<
literal|0
operator|)
operator|||
operator|(
name|controller
operator|>=
name|ncontroller
operator|)
condition|)
block|{
name|log
argument_list|(
name|LL_ERR
argument_list|,
literal|"set_channel_busy: invalid controller number [%d]!"
argument_list|,
name|controller
argument_list|)
expr_stmt|;
return|return
operator|(
name|ERROR
operator|)
return|;
block|}
switch|switch
condition|(
name|channel
condition|)
block|{
case|case
name|CHAN_B1
case|:
if|if
condition|(
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|stateb1
operator|==
name|CHAN_RUN
condition|)
block|{
name|DBGL
argument_list|(
name|DL_CNST
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"set_channel_busy: controller [%d] channel B1 already busy!"
argument_list|,
name|controller
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|stateb1
operator|=
name|CHAN_RUN
expr_stmt|;
name|DBGL
argument_list|(
name|DL_CNST
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"set_channel_busy: controller [%d] channel B1 set to BUSY!"
argument_list|,
name|controller
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|CHAN_B2
case|:
if|if
condition|(
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|stateb2
operator|==
name|CHAN_RUN
condition|)
block|{
name|DBGL
argument_list|(
name|DL_CNST
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"set_channel_busy: controller [%d] channel B2 already busy!"
argument_list|,
name|controller
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|stateb2
operator|=
name|CHAN_RUN
expr_stmt|;
name|DBGL
argument_list|(
name|DL_CNST
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"set_channel_busy: controller [%d] channel B2 set to BUSY!"
argument_list|,
name|controller
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|log
argument_list|(
name|LL_ERR
argument_list|,
literal|"set_channel_busy: controller [%d], invalid channel [%d]!"
argument_list|,
name|controller
argument_list|,
name|channel
argument_list|)
expr_stmt|;
return|return
operator|(
name|ERROR
operator|)
return|;
break|break;
block|}
return|return
operator|(
name|GOOD
operator|)
return|;
block|}
end_function

begin_comment
comment|/*--------------------------------------------------------------------------*  *	set channel state to idle  *--------------------------------------------------------------------------*/
end_comment

begin_function
name|int
name|set_channel_idle
parameter_list|(
name|int
name|controller
parameter_list|,
name|int
name|channel
parameter_list|)
block|{
if|if
condition|(
operator|(
name|controller
operator|<
literal|0
operator|)
operator|||
operator|(
name|controller
operator|>=
name|ncontroller
operator|)
condition|)
block|{
name|log
argument_list|(
name|LL_ERR
argument_list|,
literal|"set_channel_idle: invalid controller number [%d]!"
argument_list|,
name|controller
argument_list|)
expr_stmt|;
return|return
operator|(
name|ERROR
operator|)
return|;
block|}
switch|switch
condition|(
name|channel
condition|)
block|{
case|case
name|CHAN_B1
case|:
if|if
condition|(
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|stateb1
operator|==
name|CHAN_IDLE
condition|)
block|{
name|DBGL
argument_list|(
name|DL_CNST
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"set_channel_idle: controller [%d] channel B1 already idle!"
argument_list|,
name|controller
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|stateb1
operator|=
name|CHAN_IDLE
expr_stmt|;
name|DBGL
argument_list|(
name|DL_CNST
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"set_channel_idle: controller [%d] channel B1 set to IDLE!"
argument_list|,
name|controller
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|CHAN_B2
case|:
if|if
condition|(
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|stateb2
operator|==
name|CHAN_IDLE
condition|)
block|{
name|DBGL
argument_list|(
name|DL_CNST
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"set_channel_idle: controller [%d] channel B2 already idle!"
argument_list|,
name|controller
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|stateb2
operator|=
name|CHAN_IDLE
expr_stmt|;
name|DBGL
argument_list|(
name|DL_CNST
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"set_channel_idle: controller [%d] channel B2 set to IDLE!"
argument_list|,
name|controller
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|log
argument_list|(
name|LL_ERR
argument_list|,
literal|"set_channel_idle: controller [%d], invalid channel [%d]!"
argument_list|,
name|controller
argument_list|,
name|channel
argument_list|)
expr_stmt|;
return|return
operator|(
name|ERROR
operator|)
return|;
break|break;
block|}
return|return
operator|(
name|GOOD
operator|)
return|;
block|}
end_function

begin_comment
comment|/*--------------------------------------------------------------------------*  *	return channel state  *--------------------------------------------------------------------------*/
end_comment

begin_function
name|int
name|ret_channel_state
parameter_list|(
name|int
name|controller
parameter_list|,
name|int
name|channel
parameter_list|)
block|{
if|if
condition|(
operator|(
name|controller
operator|<
literal|0
operator|)
operator|||
operator|(
name|controller
operator|>=
name|ncontroller
operator|)
condition|)
block|{
name|log
argument_list|(
name|LL_ERR
argument_list|,
literal|"ret_channel_state: invalid controller number [%d]!"
argument_list|,
name|controller
argument_list|)
expr_stmt|;
return|return
operator|(
name|ERROR
operator|)
return|;
block|}
switch|switch
condition|(
name|channel
condition|)
block|{
case|case
name|CHAN_B1
case|:
return|return
operator|(
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|stateb1
operator|)
return|;
break|break;
case|case
name|CHAN_B2
case|:
return|return
operator|(
name|isdn_ctrl_tab
index|[
name|controller
index|]
operator|.
name|stateb2
operator|)
return|;
break|break;
default|default:
name|log
argument_list|(
name|LL_ERR
argument_list|,
literal|"ret_channel_state: controller [%d], invalid channel [%d]!"
argument_list|,
name|controller
argument_list|,
name|channel
argument_list|)
expr_stmt|;
return|return
operator|(
name|ERROR
operator|)
return|;
break|break;
block|}
return|return
operator|(
name|ERROR
operator|)
return|;
block|}
end_function

begin_comment
comment|/* EOF */
end_comment

end_unit


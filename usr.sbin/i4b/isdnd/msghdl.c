begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1997, 2001 Hellmuth Michaelis. All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  *---------------------------------------------------------------------------  *  *	i4b daemon - message from kernel handling routines  *	--------------------------------------------------  *  *	$Id: msghdl.c,v 1.78 2000/09/21 11:29:51 hm Exp $   *  * $FreeBSD$  *  *      last edit-date: [Thu Sep 21 11:11:48 2000]  *  *---------------------------------------------------------------------------*/
end_comment

begin_include
include|#
directive|include
file|"isdnd.h"
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_types.h>
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__FreeBSD__
argument_list|)
end_if

begin_include
include|#
directive|include
file|<net/if_var.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_systm.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_var.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip.h>
end_include

begin_include
include|#
directive|include
file|<netinet/tcp.h>
end_include

begin_include
include|#
directive|include
file|<netinet/udp.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip_icmp.h>
end_include

begin_comment
comment|/*---------------------------------------------------------------------------*  *	handle incoming CONNECT_IND (=SETUP) message  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|msg_connect_ind
parameter_list|(
name|msg_connect_ind_t
modifier|*
name|mp
parameter_list|)
block|{
name|cfg_entry_t
modifier|*
name|cep
decl_stmt|;
name|char
modifier|*
name|src_tela
init|=
literal|"ERROR-src_tela"
decl_stmt|;
name|char
modifier|*
name|dst_tela
init|=
literal|"ERROR-dst_tela"
decl_stmt|;
define|#
directive|define
name|SRC
value|(aliasing == 0 ? mp->src_telno : src_tela)
define|#
directive|define
name|DST
value|(aliasing == 0 ? mp->dst_telno : dst_tela)
if|if
condition|(
name|aliasing
condition|)
block|{
name|src_tela
operator|=
name|get_alias
argument_list|(
name|mp
operator|->
name|src_telno
argument_list|)
expr_stmt|;
name|dst_tela
operator|=
name|get_alias
argument_list|(
name|mp
operator|->
name|dst_telno
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|cep
operator|=
name|find_matching_entry_incoming
argument_list|(
name|mp
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
comment|/* log message generated in find_matching_entry_incoming() */
name|sendm_connect_resp
argument_list|(
name|NULL
argument_list|,
name|mp
operator|->
name|header
operator|.
name|cdid
argument_list|,
name|SETUP_RESP_DNTCRE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|handle_scrprs
argument_list|(
name|mp
operator|->
name|header
operator|.
name|cdid
argument_list|,
name|mp
operator|->
name|scr_ind
argument_list|,
name|mp
operator|->
name|prs_ind
argument_list|,
name|SRC
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|cep
operator|->
name|cdid
operator|!=
name|CDID_UNUSED
operator|&&
name|cep
operator|->
name|cdid
operator|!=
name|CDID_RESERVED
condition|)
block|{
comment|/*  		 * This is an incoming call on a number we just dialed out. 		 * Stop our dial-out and accept the incoming call. 		 */
if|if
condition|(
name|cep
operator|->
name|saved_call
operator|.
name|cdid
operator|!=
name|CDID_UNUSED
operator|&&
name|cep
operator|->
name|saved_call
operator|.
name|cdid
operator|!=
name|CDID_RESERVED
condition|)
block|{
name|int
name|cdid
decl_stmt|;
comment|/* disconnect old, not new */
name|cdid
operator|=
name|cep
operator|->
name|cdid
expr_stmt|;
name|cep
operator|->
name|cdid
operator|=
name|cep
operator|->
name|saved_call
operator|.
name|cdid
expr_stmt|;
name|sendm_disconnect_req
argument_list|(
name|cep
argument_list|,
operator|(
name|CAUSET_I4B
operator|<<
literal|8
operator|)
operator||
name|CAUSE_I4B_NORMAL
argument_list|)
expr_stmt|;
name|cep
operator|->
name|cdid
operator|=
name|cdid
expr_stmt|;
comment|/* 			 * Shortcut the state machine and mark this 			 * entry as free 			 */
comment|/* XXX */
name|cep
operator|->
name|state
operator|=
name|ST_IDLE
expr_stmt|;
comment|/* this is an invalid	*/
comment|/* transition,		*/
comment|/* so no next_state()	*/
comment|/* we have to wait here for an incoming	*/
comment|/* disconnect message !!! (-hm)		*/
block|}
block|}
if|if
condition|(
name|cep
operator|->
name|inout
operator|==
name|DIR_OUTONLY
condition|)
block|{
name|log
argument_list|(
name|LL_CHD
argument_list|,
literal|"%05d %s incoming call from %s to %s not allowed by configuration!"
argument_list|,
name|mp
operator|->
name|header
operator|.
name|cdid
argument_list|,
name|cep
operator|->
name|name
argument_list|,
name|SRC
argument_list|,
name|DST
argument_list|)
expr_stmt|;
name|sendm_connect_resp
argument_list|(
name|NULL
argument_list|,
name|mp
operator|->
name|header
operator|.
name|cdid
argument_list|,
name|SETUP_RESP_DNTCRE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|handle_scrprs
argument_list|(
name|mp
operator|->
name|header
operator|.
name|cdid
argument_list|,
name|mp
operator|->
name|scr_ind
argument_list|,
name|mp
operator|->
name|prs_ind
argument_list|,
name|SRC
argument_list|)
expr_stmt|;
return|return;
block|}
name|cep
operator|->
name|charge
operator|=
literal|0
expr_stmt|;
name|cep
operator|->
name|last_charge
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|cep
operator|->
name|dialin_reaction
condition|)
block|{
case|case
name|REACT_ACCEPT
case|:
name|log
argument_list|(
name|LL_CHD
argument_list|,
literal|"%05d %s accepting: incoming call from %s to %s"
argument_list|,
name|mp
operator|->
name|header
operator|.
name|cdid
argument_list|,
name|cep
operator|->
name|name
argument_list|,
name|SRC
argument_list|,
name|DST
argument_list|)
expr_stmt|;
name|decr_free_channels
argument_list|(
name|mp
operator|->
name|controller
argument_list|)
expr_stmt|;
name|next_state
argument_list|(
name|cep
argument_list|,
name|EV_MCI
argument_list|)
expr_stmt|;
break|break;
case|case
name|REACT_REJECT
case|:
name|log
argument_list|(
name|LL_CHD
argument_list|,
literal|"%05d %s rejecting: incoming call from %s to %s"
argument_list|,
name|mp
operator|->
name|header
operator|.
name|cdid
argument_list|,
name|cep
operator|->
name|name
argument_list|,
name|SRC
argument_list|,
name|DST
argument_list|)
expr_stmt|;
name|sendm_connect_resp
argument_list|(
name|cep
argument_list|,
name|mp
operator|->
name|header
operator|.
name|cdid
argument_list|,
name|SETUP_RESP_REJECT
argument_list|,
operator|(
name|CAUSET_I4B
operator|<<
literal|8
operator|)
operator||
name|CAUSE_I4B_REJECT
argument_list|)
expr_stmt|;
name|cep
operator|->
name|cdid
operator|=
name|CDID_UNUSED
expr_stmt|;
break|break;
case|case
name|REACT_IGNORE
case|:
name|log
argument_list|(
name|LL_CHD
argument_list|,
literal|"%05d %s ignoring: incoming call from %s to %s"
argument_list|,
name|mp
operator|->
name|header
operator|.
name|cdid
argument_list|,
name|cep
operator|->
name|name
argument_list|,
name|SRC
argument_list|,
name|DST
argument_list|)
expr_stmt|;
name|sendm_connect_resp
argument_list|(
name|NULL
argument_list|,
name|mp
operator|->
name|header
operator|.
name|cdid
argument_list|,
name|SETUP_RESP_DNTCRE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|cep
operator|->
name|cdid
operator|=
name|CDID_UNUSED
expr_stmt|;
break|break;
case|case
name|REACT_ANSWER
case|:
name|decr_free_channels
argument_list|(
name|mp
operator|->
name|controller
argument_list|)
expr_stmt|;
if|if
condition|(
name|cep
operator|->
name|alert
condition|)
block|{
if|if
condition|(
name|mp
operator|->
name|display
condition|)
block|{
name|log
argument_list|(
name|LL_CHD
argument_list|,
literal|"%05d %s alerting: incoming call from %s to %s (%s)"
argument_list|,
name|mp
operator|->
name|header
operator|.
name|cdid
argument_list|,
name|cep
operator|->
name|name
argument_list|,
name|SRC
argument_list|,
name|DST
argument_list|,
name|mp
operator|->
name|display
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|log
argument_list|(
name|LL_CHD
argument_list|,
literal|"%05d %s alerting: incoming call from %s to %s"
argument_list|,
name|mp
operator|->
name|header
operator|.
name|cdid
argument_list|,
name|cep
operator|->
name|name
argument_list|,
name|SRC
argument_list|,
name|DST
argument_list|)
expr_stmt|;
block|}
name|next_state
argument_list|(
name|cep
argument_list|,
name|EV_ALRT
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|mp
operator|->
name|display
condition|)
block|{
name|log
argument_list|(
name|LL_CHD
argument_list|,
literal|"%05d %s answering: incoming call from %s to %s (%s)"
argument_list|,
name|mp
operator|->
name|header
operator|.
name|cdid
argument_list|,
name|cep
operator|->
name|name
argument_list|,
name|SRC
argument_list|,
name|DST
argument_list|,
name|mp
operator|->
name|display
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|log
argument_list|(
name|LL_CHD
argument_list|,
literal|"%05d %s answering: incoming call from %s to %s"
argument_list|,
name|mp
operator|->
name|header
operator|.
name|cdid
argument_list|,
name|cep
operator|->
name|name
argument_list|,
name|SRC
argument_list|,
name|DST
argument_list|)
expr_stmt|;
block|}
name|next_state
argument_list|(
name|cep
argument_list|,
name|EV_MCI
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|REACT_CALLBACK
case|:
ifdef|#
directive|ifdef
name|NOTDEF
comment|/*XXX reserve channel ??? */
name|decr_free_channels
argument_list|(
name|mp
operator|->
name|controller
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|cep
operator|->
name|cdid
operator|==
name|CDID_RESERVED
condition|)
block|{
name|log
argument_list|(
name|LL_CHD
argument_list|,
literal|"%05d %s reserved: incoming call from %s to %s"
argument_list|,
name|mp
operator|->
name|header
operator|.
name|cdid
argument_list|,
name|cep
operator|->
name|name
argument_list|,
name|SRC
argument_list|,
name|DST
argument_list|)
expr_stmt|;
name|sendm_connect_resp
argument_list|(
name|cep
argument_list|,
name|mp
operator|->
name|header
operator|.
name|cdid
argument_list|,
name|SETUP_RESP_REJECT
argument_list|,
if|#
directive|if
literal|0
argument_list|(CAUSET_I4B<< 8) | CAUSE_I4B_NORMAL);
else|#
directive|else
operator|(
name|CAUSET_I4B
operator|<<
literal|8
operator|)
operator||
name|CAUSE_I4B_REJECT
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* no state change */
block|}
else|else
block|{
name|sendm_connect_resp
argument_list|(
name|cep
argument_list|,
name|mp
operator|->
name|header
operator|.
name|cdid
argument_list|,
name|SETUP_RESP_REJECT
argument_list|,
if|#
directive|if
literal|0
argument_list|(CAUSET_I4B<< 8) | CAUSE_I4B_NORMAL);
else|#
directive|else
operator|(
name|CAUSET_I4B
operator|<<
literal|8
operator|)
operator||
name|CAUSE_I4B_REJECT
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|cep
operator|->
name|budget_callbackperiod
operator|&&
name|cep
operator|->
name|budget_callbackncalls
condition|)
block|{
name|cep
operator|->
name|budget_callback_req
operator|++
expr_stmt|;
name|cep
operator|->
name|budget_calltype
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|cep
operator|->
name|budget_callbackncalls_cnt
operator|==
literal|0
condition|)
block|{
name|log
argument_list|(
name|LL_CHD
argument_list|,
literal|"%05d %s no budget: call from %s to %s"
argument_list|,
name|mp
operator|->
name|header
operator|.
name|cdid
argument_list|,
name|cep
operator|->
name|name
argument_list|,
name|SRC
argument_list|,
name|DST
argument_list|)
expr_stmt|;
name|cep
operator|->
name|cdid
operator|=
name|CDID_UNUSED
expr_stmt|;
name|cep
operator|->
name|budget_callback_rej
operator|++
expr_stmt|;
break|break;
block|}
else|else
block|{
name|cep
operator|->
name|budget_calltype
operator|=
name|BUDGET_TYPE_CBACK
expr_stmt|;
block|}
block|}
name|log
argument_list|(
name|LL_CHD
argument_list|,
literal|"%05d %s callback: incoming call from %s to %s"
argument_list|,
name|mp
operator|->
name|header
operator|.
name|cdid
argument_list|,
name|cep
operator|->
name|name
argument_list|,
name|SRC
argument_list|,
name|DST
argument_list|)
expr_stmt|;
name|cep
operator|->
name|last_release_time
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|cep
operator|->
name|cdid
operator|=
name|CDID_RESERVED
expr_stmt|;
name|next_state
argument_list|(
name|cep
argument_list|,
name|EV_CBRQ
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|log
argument_list|(
name|LL_WRN
argument_list|,
literal|"msg_connect_ind: unknown response type, tx SETUP_RESP_DNTCRE"
argument_list|)
expr_stmt|;
name|sendm_connect_resp
argument_list|(
name|NULL
argument_list|,
name|mp
operator|->
name|header
operator|.
name|cdid
argument_list|,
name|SETUP_RESP_DNTCRE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
name|handle_scrprs
argument_list|(
name|mp
operator|->
name|header
operator|.
name|cdid
argument_list|,
name|mp
operator|->
name|scr_ind
argument_list|,
name|mp
operator|->
name|prs_ind
argument_list|,
name|SRC
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|SRC
undef|#
directive|undef
name|DST
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	handle incoming CONNECT_ACTIVE_IND message  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|msg_connect_active_ind
parameter_list|(
name|msg_connect_active_ind_t
modifier|*
name|mp
parameter_list|)
block|{
name|cfg_entry_t
modifier|*
name|cep
decl_stmt|;
name|char
modifier|*
name|device
decl_stmt|;
if|if
condition|(
operator|(
name|cep
operator|=
name|get_cep_by_cdid
argument_list|(
name|mp
operator|->
name|header
operator|.
name|cdid
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|log
argument_list|(
name|LL_WRN
argument_list|,
literal|"msg_connect_active_ind: cdid not found!"
argument_list|)
expr_stmt|;
return|return;
block|}
name|cep
operator|->
name|isdncontrollerused
operator|=
name|mp
operator|->
name|controller
expr_stmt|;
name|cep
operator|->
name|isdnchannelused
operator|=
name|mp
operator|->
name|channel
expr_stmt|;
name|cep
operator|->
name|aoc_now
operator|=
name|cep
operator|->
name|connect_time
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|cep
operator|->
name|aoc_last
operator|=
literal|0
expr_stmt|;
name|cep
operator|->
name|aoc_diff
operator|=
literal|0
expr_stmt|;
name|cep
operator|->
name|aoc_valid
operator|=
name|AOC_INVALID
expr_stmt|;
name|cep
operator|->
name|local_disconnect
operator|=
name|DISCON_REM
expr_stmt|;
name|cep
operator|->
name|inbytes
operator|=
name|INVALID
expr_stmt|;
name|cep
operator|->
name|outbytes
operator|=
name|INVALID
expr_stmt|;
name|cep
operator|->
name|hangup
operator|=
literal|0
expr_stmt|;
name|device
operator|=
name|bdrivername
argument_list|(
name|cep
operator|->
name|usrdevicename
argument_list|)
expr_stmt|;
comment|/* set the B-channel to active */
if|if
condition|(
operator|(
name|set_channel_busy
argument_list|(
name|cep
operator|->
name|isdncontrollerused
argument_list|,
name|cep
operator|->
name|isdnchannelused
argument_list|)
operator|)
operator|==
name|ERROR
condition|)
name|log
argument_list|(
name|LL_ERR
argument_list|,
literal|"msg_connect_active_ind: set_channel_busy failed!"
argument_list|)
expr_stmt|;
if|if
condition|(
name|cep
operator|->
name|direction
operator|==
name|DIR_OUT
condition|)
block|{
name|log
argument_list|(
name|LL_CHD
argument_list|,
literal|"%05d %s outgoing call active (ctl %d, ch %d, %s%d)"
argument_list|,
name|cep
operator|->
name|cdid
argument_list|,
name|cep
operator|->
name|name
argument_list|,
name|cep
operator|->
name|isdncontrollerused
argument_list|,
name|cep
operator|->
name|isdnchannelused
argument_list|,
name|bdrivername
argument_list|(
name|cep
operator|->
name|usrdevicename
argument_list|)
argument_list|,
name|cep
operator|->
name|usrdeviceunit
argument_list|)
expr_stmt|;
if|if
condition|(
name|cep
operator|->
name|budget_calltype
condition|)
block|{
if|if
condition|(
name|cep
operator|->
name|budget_calltype
operator|==
name|BUDGET_TYPE_CBACK
condition|)
block|{
name|cep
operator|->
name|budget_callback_done
operator|++
expr_stmt|;
name|cep
operator|->
name|budget_callbackncalls_cnt
operator|--
expr_stmt|;
name|DBGL
argument_list|(
name|DL_BDGT
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"%s: new cback-budget = %d"
argument_list|,
name|cep
operator|->
name|name
argument_list|,
name|cep
operator|->
name|budget_callbackncalls_cnt
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cep
operator|->
name|budget_callbacks_file
operator|!=
name|NULL
condition|)
name|upd_callstat_file
argument_list|(
name|cep
operator|->
name|budget_callbacks_file
argument_list|,
name|cep
operator|->
name|budget_callbacksfile_rotate
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cep
operator|->
name|budget_calltype
operator|==
name|BUDGET_TYPE_COUT
condition|)
block|{
name|cep
operator|->
name|budget_callout_done
operator|++
expr_stmt|;
name|cep
operator|->
name|budget_calloutncalls_cnt
operator|--
expr_stmt|;
name|DBGL
argument_list|(
name|DL_BDGT
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"%s: new cout-budget = %d"
argument_list|,
name|cep
operator|->
name|name
argument_list|,
name|cep
operator|->
name|budget_calloutncalls_cnt
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cep
operator|->
name|budget_callouts_file
operator|!=
name|NULL
condition|)
name|upd_callstat_file
argument_list|(
name|cep
operator|->
name|budget_callouts_file
argument_list|,
name|cep
operator|->
name|budget_calloutsfile_rotate
argument_list|)
expr_stmt|;
block|}
name|cep
operator|->
name|budget_calltype
operator|=
literal|0
expr_stmt|;
block|}
block|}
else|else
block|{
name|log
argument_list|(
name|LL_CHD
argument_list|,
literal|"%05d %s incoming call active (ctl %d, ch %d, %s%d)"
argument_list|,
name|cep
operator|->
name|cdid
argument_list|,
name|cep
operator|->
name|name
argument_list|,
name|cep
operator|->
name|isdncontrollerused
argument_list|,
name|cep
operator|->
name|isdnchannelused
argument_list|,
name|bdrivername
argument_list|(
name|cep
operator|->
name|usrdevicename
argument_list|)
argument_list|,
name|cep
operator|->
name|usrdeviceunit
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|USE_CURSES
if|if
condition|(
name|do_fullscreen
condition|)
name|display_connect
argument_list|(
name|cep
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|I4B_EXTERNAL_MONITOR
if|if
condition|(
name|do_monitor
operator|&&
name|accepted
condition|)
name|monitor_evnt_connect
argument_list|(
name|cep
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|isdntime
operator|&&
operator|(
name|mp
operator|->
name|datetime
index|[
literal|0
index|]
operator|!=
literal|'\0'
operator|)
condition|)
block|{
name|log
argument_list|(
name|LL_DMN
argument_list|,
literal|"date/time from exchange = %s"
argument_list|,
name|mp
operator|->
name|datetime
argument_list|)
expr_stmt|;
block|}
name|next_state
argument_list|(
name|cep
argument_list|,
name|EV_MCAI
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	handle incoming PROCEEDING_IND message  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|msg_proceeding_ind
parameter_list|(
name|msg_proceeding_ind_t
modifier|*
name|mp
parameter_list|)
block|{
name|cfg_entry_t
modifier|*
name|cep
decl_stmt|;
if|if
condition|(
operator|(
name|cep
operator|=
name|get_cep_by_cdid
argument_list|(
name|mp
operator|->
name|header
operator|.
name|cdid
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|log
argument_list|(
name|LL_WRN
argument_list|,
literal|"msg_proceeding_ind: cdid not found!"
argument_list|)
expr_stmt|;
return|return;
block|}
name|cep
operator|->
name|isdncontrollerused
operator|=
name|mp
operator|->
name|controller
expr_stmt|;
name|cep
operator|->
name|isdnchannelused
operator|=
name|mp
operator|->
name|channel
expr_stmt|;
comment|/* set the B-channels active */
if|if
condition|(
operator|(
name|set_channel_busy
argument_list|(
name|cep
operator|->
name|isdncontrollerused
argument_list|,
name|cep
operator|->
name|isdnchannelused
argument_list|)
operator|)
operator|==
name|ERROR
condition|)
name|log
argument_list|(
name|LL_ERR
argument_list|,
literal|"msg_proceeding_ind: set_channel_busy failed!"
argument_list|)
expr_stmt|;
name|log
argument_list|(
name|LL_CHD
argument_list|,
literal|"%05d %s outgoing call proceeding (ctl %d, ch %d)"
argument_list|,
name|cep
operator|->
name|cdid
argument_list|,
name|cep
operator|->
name|name
argument_list|,
name|cep
operator|->
name|isdncontrollerused
argument_list|,
name|cep
operator|->
name|isdnchannelused
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	handle incoming ALERT_IND message  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|msg_alert_ind
parameter_list|(
name|msg_alert_ind_t
modifier|*
name|mp
parameter_list|)
block|{
name|cfg_entry_t
modifier|*
name|cep
decl_stmt|;
if|if
condition|(
operator|(
name|cep
operator|=
name|get_cep_by_cdid
argument_list|(
name|mp
operator|->
name|header
operator|.
name|cdid
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|log
argument_list|(
name|LL_WRN
argument_list|,
literal|"msg_alert_ind: cdid not found!"
argument_list|)
expr_stmt|;
return|return;
block|}
ifdef|#
directive|ifdef
name|NOTDEF
name|log
argument_list|(
name|LL_CHD
argument_list|,
literal|"%05d %s incoming alert"
argument_list|,
name|cep
operator|->
name|cdid
argument_list|,
name|cep
operator|->
name|name
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	handle incoming L12STAT_IND message  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|msg_l12stat_ind
parameter_list|(
name|msg_l12stat_ind_t
modifier|*
name|ml
parameter_list|)
block|{
if|if
condition|(
operator|(
name|ml
operator|->
name|controller
operator|<
literal|0
operator|)
operator|||
operator|(
name|ml
operator|->
name|controller
operator|>=
name|ncontroller
operator|)
condition|)
block|{
name|log
argument_list|(
name|LL_ERR
argument_list|,
literal|"msg_l12stat_ind: invalid controller number [%d]!"
argument_list|,
name|ml
operator|->
name|controller
argument_list|)
expr_stmt|;
return|return;
block|}
ifdef|#
directive|ifdef
name|USE_CURSES
if|if
condition|(
name|do_fullscreen
condition|)
name|display_l12stat
argument_list|(
name|ml
operator|->
name|controller
argument_list|,
name|ml
operator|->
name|layer
argument_list|,
name|ml
operator|->
name|state
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|I4B_EXTERNAL_MONITOR
if|if
condition|(
name|do_monitor
operator|&&
name|accepted
condition|)
name|monitor_evnt_l12stat
argument_list|(
name|ml
operator|->
name|controller
argument_list|,
name|ml
operator|->
name|layer
argument_list|,
name|ml
operator|->
name|state
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|DBGL
argument_list|(
name|DL_CNST
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"msg_l12stat_ind: unit %d, layer %d, state %d"
argument_list|,
name|ml
operator|->
name|controller
argument_list|,
name|ml
operator|->
name|layer
argument_list|,
name|ml
operator|->
name|state
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ml
operator|->
name|layer
operator|==
name|LAYER_ONE
condition|)
block|{
if|if
condition|(
name|ml
operator|->
name|state
operator|==
name|LAYER_IDLE
condition|)
name|isdn_ctrl_tab
index|[
name|ml
operator|->
name|controller
index|]
operator|.
name|l2stat
operator|=
name|ml
operator|->
name|state
expr_stmt|;
name|isdn_ctrl_tab
index|[
name|ml
operator|->
name|controller
index|]
operator|.
name|l1stat
operator|=
name|ml
operator|->
name|state
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ml
operator|->
name|layer
operator|==
name|LAYER_TWO
condition|)
block|{
if|if
condition|(
name|ml
operator|->
name|state
operator|==
name|LAYER_ACTIVE
condition|)
name|isdn_ctrl_tab
index|[
name|ml
operator|->
name|controller
index|]
operator|.
name|l1stat
operator|=
name|ml
operator|->
name|state
expr_stmt|;
name|isdn_ctrl_tab
index|[
name|ml
operator|->
name|controller
index|]
operator|.
name|l2stat
operator|=
name|ml
operator|->
name|state
expr_stmt|;
block|}
else|else
block|{
name|log
argument_list|(
name|LL_ERR
argument_list|,
literal|"msg_l12stat_ind: invalid layer number [%d]!"
argument_list|,
name|ml
operator|->
name|layer
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	handle incoming TEIASG_IND message  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|msg_teiasg_ind
parameter_list|(
name|msg_teiasg_ind_t
modifier|*
name|mt
parameter_list|)
block|{
if|if
condition|(
operator|(
name|mt
operator|->
name|controller
operator|<
literal|0
operator|)
operator|||
operator|(
name|mt
operator|->
name|controller
operator|>=
name|ncontroller
operator|)
condition|)
block|{
name|log
argument_list|(
name|LL_ERR
argument_list|,
literal|"msg_teiasg_ind: invalid controller number [%d]!"
argument_list|,
name|mt
operator|->
name|controller
argument_list|)
expr_stmt|;
return|return;
block|}
ifdef|#
directive|ifdef
name|USE_CURSES
if|if
condition|(
name|do_fullscreen
condition|)
name|display_tei
argument_list|(
name|mt
operator|->
name|controller
argument_list|,
name|mt
operator|->
name|tei
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|I4B_EXTERNAL_MONITOR
if|if
condition|(
name|do_monitor
operator|&&
name|accepted
condition|)
name|monitor_evnt_tei
argument_list|(
name|mt
operator|->
name|controller
argument_list|,
name|mt
operator|->
name|tei
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|DBGL
argument_list|(
name|DL_CNST
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"msg_teiasg_ind: unit %d, tei = %d"
argument_list|,
name|mt
operator|->
name|controller
argument_list|,
name|mt
operator|->
name|tei
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|isdn_ctrl_tab
index|[
name|mt
operator|->
name|controller
index|]
operator|.
name|tei
operator|=
name|mt
operator|->
name|tei
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	handle incoming PDEACT_IND message  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|msg_pdeact_ind
parameter_list|(
name|msg_pdeact_ind_t
modifier|*
name|md
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|ctrl
init|=
name|md
operator|->
name|controller
decl_stmt|;
name|cfg_entry_t
modifier|*
name|cep
decl_stmt|;
ifdef|#
directive|ifdef
name|USE_CURSES
if|if
condition|(
name|do_fullscreen
condition|)
block|{
name|display_l12stat
argument_list|(
name|ctrl
argument_list|,
name|LAYER_ONE
argument_list|,
name|LAYER_IDLE
argument_list|)
expr_stmt|;
name|display_l12stat
argument_list|(
name|ctrl
argument_list|,
name|LAYER_TWO
argument_list|,
name|LAYER_IDLE
argument_list|)
expr_stmt|;
name|display_tei
argument_list|(
name|ctrl
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
ifdef|#
directive|ifdef
name|I4B_EXTERNAL_MONITOR
if|if
condition|(
name|do_monitor
operator|&&
name|accepted
condition|)
block|{
name|monitor_evnt_l12stat
argument_list|(
name|ctrl
argument_list|,
name|LAYER_ONE
argument_list|,
name|LAYER_IDLE
argument_list|)
expr_stmt|;
name|monitor_evnt_l12stat
argument_list|(
name|ctrl
argument_list|,
name|LAYER_TWO
argument_list|,
name|LAYER_IDLE
argument_list|)
expr_stmt|;
name|monitor_evnt_tei
argument_list|(
name|ctrl
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|DBGL
argument_list|(
name|DL_CNST
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"msg_pdeact_ind: unit %d, persistent deactivation"
argument_list|,
name|ctrl
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|isdn_ctrl_tab
index|[
name|ctrl
index|]
operator|.
name|l1stat
operator|=
name|LAYER_IDLE
expr_stmt|;
name|isdn_ctrl_tab
index|[
name|ctrl
index|]
operator|.
name|l2stat
operator|=
name|LAYER_IDLE
expr_stmt|;
name|isdn_ctrl_tab
index|[
name|ctrl
index|]
operator|.
name|tei
operator|=
operator|-
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nentries
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|cfg_entry_tab
index|[
name|i
index|]
operator|.
name|cdid
operator|!=
name|CDID_UNUSED
operator|)
operator|&&
operator|(
name|cfg_entry_tab
index|[
name|i
index|]
operator|.
name|isdncontrollerused
operator|==
name|ctrl
operator|)
condition|)
block|{
name|cep
operator|=
operator|&
name|cfg_entry_tab
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|cep
operator|->
name|cdid
operator|==
name|CDID_RESERVED
condition|)
block|{
name|cep
operator|->
name|state
operator|=
name|ST_IDLE
expr_stmt|;
name|cep
operator|->
name|cdid
operator|=
name|CDID_UNUSED
expr_stmt|;
continue|continue;
block|}
name|cep
operator|->
name|cdid
operator|=
name|CDID_UNUSED
expr_stmt|;
name|cep
operator|->
name|last_release_time
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|SET_CAUSE_TYPE
argument_list|(
name|cep
operator|->
name|disc_cause
argument_list|,
name|CAUSET_I4B
argument_list|)
expr_stmt|;
name|SET_CAUSE_VAL
argument_list|(
name|cep
operator|->
name|disc_cause
argument_list|,
name|CAUSE_I4B_L1ERROR
argument_list|)
expr_stmt|;
if|if
condition|(
name|cep
operator|->
name|direction
operator|==
name|DIR_OUT
condition|)
block|{
name|log
argument_list|(
name|LL_CHD
argument_list|,
literal|"%05d %s outgoing call disconnected (local)"
argument_list|,
name|cep
operator|->
name|cdid
argument_list|,
name|cep
operator|->
name|name
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|log
argument_list|(
name|LL_CHD
argument_list|,
literal|"%05d %s incoming call disconnected (local)"
argument_list|,
name|cep
operator|->
name|cdid
argument_list|,
name|cep
operator|->
name|name
argument_list|)
expr_stmt|;
block|}
name|log
argument_list|(
name|LL_CHD
argument_list|,
literal|"%05d %s cause %s"
argument_list|,
name|cep
operator|->
name|cdid
argument_list|,
name|cep
operator|->
name|name
argument_list|,
name|print_i4b_cause
argument_list|(
name|cep
operator|->
name|disc_cause
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|USE_CURSES
if|if
condition|(
name|do_fullscreen
operator|&&
operator|(
name|cep
operator|->
name|connect_time
operator|>
literal|0
operator|)
condition|)
name|display_disconnect
argument_list|(
name|cep
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|I4B_EXTERNAL_MONITOR
if|if
condition|(
name|do_monitor
operator|&&
name|accepted
condition|)
name|monitor_evnt_disconnect
argument_list|(
name|cep
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|cep
operator|->
name|disconnectprog
condition|)
name|exec_connect_prog
argument_list|(
name|cep
argument_list|,
name|cep
operator|->
name|disconnectprog
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|cep
operator|->
name|connect_time
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|cep
operator|->
name|direction
operator|==
name|DIR_OUT
condition|)
block|{
name|log
argument_list|(
name|LL_CHD
argument_list|,
literal|"%05d %s charging: %d units, %d seconds"
argument_list|,
name|cep
operator|->
name|cdid
argument_list|,
name|cep
operator|->
name|name
argument_list|,
name|cep
operator|->
name|charge
argument_list|,
operator|(
name|int
operator|)
name|difftime
argument_list|(
name|time
argument_list|(
name|NULL
argument_list|)
argument_list|,
name|cep
operator|->
name|connect_time
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|log
argument_list|(
name|LL_CHD
argument_list|,
literal|"%05d %s connected %d seconds"
argument_list|,
name|cep
operator|->
name|cdid
argument_list|,
name|cep
operator|->
name|name
argument_list|,
operator|(
name|int
operator|)
name|difftime
argument_list|(
name|time
argument_list|(
name|NULL
argument_list|)
argument_list|,
name|cep
operator|->
name|connect_time
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|cep
operator|->
name|inbytes
operator|!=
name|INVALID
operator|)
operator|&&
operator|(
name|cep
operator|->
name|outbytes
operator|!=
name|INVALID
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|cep
operator|->
name|ioutbytes
operator|!=
name|cep
operator|->
name|outbytes
operator|)
operator|||
operator|(
name|cep
operator|->
name|iinbytes
operator|!=
name|cep
operator|->
name|inbytes
operator|)
condition|)
block|{
name|log
argument_list|(
name|LL_CHD
argument_list|,
literal|"%05d %s accounting: in %d, out %d (in %d, out %d)"
argument_list|,
name|cep
operator|->
name|cdid
argument_list|,
name|cep
operator|->
name|name
argument_list|,
name|cep
operator|->
name|inbytes
argument_list|,
name|cep
operator|->
name|outbytes
argument_list|,
name|cep
operator|->
name|iinbytes
argument_list|,
name|cep
operator|->
name|ioutbytes
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|log
argument_list|(
name|LL_CHD
argument_list|,
literal|"%05d %s accounting: in %d, out %d"
argument_list|,
name|cep
operator|->
name|cdid
argument_list|,
name|cep
operator|->
name|name
argument_list|,
name|cep
operator|->
name|inbytes
argument_list|,
name|cep
operator|->
name|outbytes
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|useacctfile
operator|&&
operator|(
name|cep
operator|->
name|connect_time
operator|>
literal|0
operator|)
condition|)
block|{
name|int
name|con_secs
decl_stmt|;
name|char
name|logdatetime
index|[
literal|41
index|]
decl_stmt|;
name|struct
name|tm
modifier|*
name|tp
decl_stmt|;
name|con_secs
operator|=
name|difftime
argument_list|(
name|time
argument_list|(
name|NULL
argument_list|)
argument_list|,
name|cep
operator|->
name|connect_time
argument_list|)
expr_stmt|;
name|tp
operator|=
name|localtime
argument_list|(
operator|&
name|cep
operator|->
name|connect_time
argument_list|)
expr_stmt|;
name|strftime
argument_list|(
name|logdatetime
argument_list|,
literal|40
argument_list|,
name|I4B_TIME_FORMAT
argument_list|,
name|tp
argument_list|)
expr_stmt|;
if|if
condition|(
name|cep
operator|->
name|inbytes
operator|!=
name|INVALID
operator|&&
name|cep
operator|->
name|outbytes
operator|!=
name|INVALID
condition|)
block|{
name|fprintf
argument_list|(
name|acctfp
argument_list|,
literal|"%s - %s %s %d (%d) (%d/%d)\n"
argument_list|,
name|logdatetime
argument_list|,
name|getlogdatetime
argument_list|()
argument_list|,
name|cep
operator|->
name|name
argument_list|,
name|cep
operator|->
name|charge
argument_list|,
name|con_secs
argument_list|,
name|cep
operator|->
name|inbytes
argument_list|,
name|cep
operator|->
name|outbytes
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|acctfp
argument_list|,
literal|"%s - %s %s %d (%d)\n"
argument_list|,
name|logdatetime
argument_list|,
name|getlogdatetime
argument_list|()
argument_list|,
name|cep
operator|->
name|name
argument_list|,
name|cep
operator|->
name|charge
argument_list|,
name|con_secs
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* set the B-channel inactive */
if|if
condition|(
operator|(
name|set_channel_idle
argument_list|(
name|cep
operator|->
name|isdncontrollerused
argument_list|,
name|cep
operator|->
name|isdnchannelused
argument_list|)
operator|)
operator|==
name|ERROR
condition|)
name|log
argument_list|(
name|LL_ERR
argument_list|,
literal|"msg_pdeact_ind: set_channel_idle failed!"
argument_list|)
expr_stmt|;
name|incr_free_channels
argument_list|(
name|cep
operator|->
name|isdncontrollerused
argument_list|)
expr_stmt|;
name|cep
operator|->
name|connect_time
operator|=
literal|0
expr_stmt|;
name|cep
operator|->
name|state
operator|=
name|ST_IDLE
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	handle incoming NEGCOMP_IND message  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|msg_negcomplete_ind
parameter_list|(
name|msg_negcomplete_ind_t
modifier|*
name|mp
parameter_list|)
block|{
name|cfg_entry_t
modifier|*
name|cep
decl_stmt|;
if|if
condition|(
operator|(
name|cep
operator|=
name|get_cep_by_cdid
argument_list|(
name|mp
operator|->
name|header
operator|.
name|cdid
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|log
argument_list|(
name|LL_WRN
argument_list|,
literal|"msg_negcomp_ind: cdid not found"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|cep
operator|->
name|connectprog
condition|)
name|exec_connect_prog
argument_list|(
name|cep
argument_list|,
name|cep
operator|->
name|connectprog
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	handle incoming IFSTATE_CHANGED indication  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|msg_ifstatechg_ind
parameter_list|(
name|msg_ifstatechg_ind_t
modifier|*
name|mp
parameter_list|)
block|{
name|cfg_entry_t
modifier|*
name|cep
decl_stmt|;
name|char
modifier|*
name|device
decl_stmt|;
if|if
condition|(
operator|(
name|cep
operator|=
name|get_cep_by_cdid
argument_list|(
name|mp
operator|->
name|header
operator|.
name|cdid
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|log
argument_list|(
name|LL_WRN
argument_list|,
literal|"msg_negcomp_ind: cdid not found"
argument_list|)
expr_stmt|;
return|return;
block|}
name|device
operator|=
name|bdrivername
argument_list|(
name|cep
operator|->
name|usrdevicename
argument_list|)
expr_stmt|;
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"%s%d: switched to state %d"
argument_list|,
name|device
argument_list|,
name|cep
operator|->
name|usrdeviceunit
argument_list|,
name|mp
operator|->
name|state
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	handle incoming DISCONNECT_IND message  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|msg_disconnect_ind
parameter_list|(
name|msg_disconnect_ind_t
modifier|*
name|mp
parameter_list|)
block|{
name|cfg_entry_t
modifier|*
name|cep
decl_stmt|;
if|if
condition|(
operator|(
name|cep
operator|=
name|get_cep_by_cdid
argument_list|(
name|mp
operator|->
name|header
operator|.
name|cdid
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|log
argument_list|(
name|LL_WRN
argument_list|,
literal|"msg_disconnect_ind: cdid not found"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* is this an aborted out-call prematurely called back? */
if|if
condition|(
name|cep
operator|->
name|saved_call
operator|.
name|cdid
operator|==
name|mp
operator|->
name|header
operator|.
name|cdid
condition|)
block|{
name|DBGL
argument_list|(
name|DL_CNST
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"aborted outcall %05d disconnected"
argument_list|,
name|mp
operator|->
name|header
operator|.
name|cdid
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|cep
operator|->
name|saved_call
operator|.
name|cdid
operator|=
name|CDID_UNUSED
expr_stmt|;
name|set_channel_idle
argument_list|(
name|cep
operator|->
name|saved_call
operator|.
name|controller
argument_list|,
name|cep
operator|->
name|saved_call
operator|.
name|channel
argument_list|)
expr_stmt|;
name|incr_free_channels
argument_list|(
name|cep
operator|->
name|saved_call
operator|.
name|controller
argument_list|)
expr_stmt|;
return|return;
block|}
name|cep
operator|->
name|last_release_time
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|cep
operator|->
name|disc_cause
operator|=
name|mp
operator|->
name|cause
expr_stmt|;
if|if
condition|(
name|cep
operator|->
name|direction
operator|==
name|DIR_OUT
condition|)
block|{
name|log
argument_list|(
name|LL_CHD
argument_list|,
literal|"%05d %s outgoing call disconnected %s"
argument_list|,
name|cep
operator|->
name|cdid
argument_list|,
name|cep
operator|->
name|name
argument_list|,
name|cep
operator|->
name|local_disconnect
operator|==
name|DISCON_LOC
condition|?
literal|"(local)"
else|:
literal|"(remote)"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|log
argument_list|(
name|LL_CHD
argument_list|,
literal|"%05d %s incoming call disconnected %s"
argument_list|,
name|cep
operator|->
name|cdid
argument_list|,
name|cep
operator|->
name|name
argument_list|,
name|cep
operator|->
name|local_disconnect
operator|==
name|DISCON_LOC
condition|?
literal|"(local)"
else|:
literal|"(remote)"
argument_list|)
expr_stmt|;
block|}
name|log
argument_list|(
name|LL_CHD
argument_list|,
literal|"%05d %s cause %s"
argument_list|,
name|cep
operator|->
name|cdid
argument_list|,
name|cep
operator|->
name|name
argument_list|,
name|print_i4b_cause
argument_list|(
name|mp
operator|->
name|cause
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|USE_CURSES
if|if
condition|(
name|do_fullscreen
operator|&&
operator|(
name|cep
operator|->
name|connect_time
operator|>
literal|0
operator|)
condition|)
name|display_disconnect
argument_list|(
name|cep
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|I4B_EXTERNAL_MONITOR
if|if
condition|(
name|do_monitor
operator|&&
name|accepted
condition|)
name|monitor_evnt_disconnect
argument_list|(
name|cep
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|cep
operator|->
name|disconnectprog
condition|)
name|exec_connect_prog
argument_list|(
name|cep
argument_list|,
name|cep
operator|->
name|disconnectprog
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|cep
operator|->
name|connect_time
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|cep
operator|->
name|direction
operator|==
name|DIR_OUT
condition|)
block|{
name|log
argument_list|(
name|LL_CHD
argument_list|,
literal|"%05d %s charging: %d units, %d seconds"
argument_list|,
name|cep
operator|->
name|cdid
argument_list|,
name|cep
operator|->
name|name
argument_list|,
name|cep
operator|->
name|charge
argument_list|,
operator|(
name|int
operator|)
name|difftime
argument_list|(
name|time
argument_list|(
name|NULL
argument_list|)
argument_list|,
name|cep
operator|->
name|connect_time
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|log
argument_list|(
name|LL_CHD
argument_list|,
literal|"%05d %s connected %d seconds"
argument_list|,
name|cep
operator|->
name|cdid
argument_list|,
name|cep
operator|->
name|name
argument_list|,
operator|(
name|int
operator|)
name|difftime
argument_list|(
name|time
argument_list|(
name|NULL
argument_list|)
argument_list|,
name|cep
operator|->
name|connect_time
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|cep
operator|->
name|inbytes
operator|!=
name|INVALID
operator|)
operator|&&
operator|(
name|cep
operator|->
name|outbytes
operator|!=
name|INVALID
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|cep
operator|->
name|ioutbytes
operator|!=
name|cep
operator|->
name|outbytes
operator|)
operator|||
operator|(
name|cep
operator|->
name|iinbytes
operator|!=
name|cep
operator|->
name|inbytes
operator|)
condition|)
block|{
name|log
argument_list|(
name|LL_CHD
argument_list|,
literal|"%05d %s accounting: in %d, out %d (in %d, out %d)"
argument_list|,
name|cep
operator|->
name|cdid
argument_list|,
name|cep
operator|->
name|name
argument_list|,
name|cep
operator|->
name|inbytes
argument_list|,
name|cep
operator|->
name|outbytes
argument_list|,
name|cep
operator|->
name|iinbytes
argument_list|,
name|cep
operator|->
name|ioutbytes
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|log
argument_list|(
name|LL_CHD
argument_list|,
literal|"%05d %s accounting: in %d, out %d"
argument_list|,
name|cep
operator|->
name|cdid
argument_list|,
name|cep
operator|->
name|name
argument_list|,
name|cep
operator|->
name|inbytes
argument_list|,
name|cep
operator|->
name|outbytes
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|useacctfile
operator|&&
operator|(
name|cep
operator|->
name|connect_time
operator|>
literal|0
operator|)
condition|)
block|{
name|int
name|con_secs
decl_stmt|;
name|char
name|logdatetime
index|[
literal|41
index|]
decl_stmt|;
name|struct
name|tm
modifier|*
name|tp
decl_stmt|;
name|con_secs
operator|=
name|difftime
argument_list|(
name|time
argument_list|(
name|NULL
argument_list|)
argument_list|,
name|cep
operator|->
name|connect_time
argument_list|)
expr_stmt|;
name|tp
operator|=
name|localtime
argument_list|(
operator|&
name|cep
operator|->
name|connect_time
argument_list|)
expr_stmt|;
name|strftime
argument_list|(
name|logdatetime
argument_list|,
literal|40
argument_list|,
name|I4B_TIME_FORMAT
argument_list|,
name|tp
argument_list|)
expr_stmt|;
if|if
condition|(
name|cep
operator|->
name|inbytes
operator|!=
name|INVALID
operator|&&
name|cep
operator|->
name|outbytes
operator|!=
name|INVALID
condition|)
block|{
name|fprintf
argument_list|(
name|acctfp
argument_list|,
literal|"%s - %s %s %d (%d) (%d/%d)\n"
argument_list|,
name|logdatetime
argument_list|,
name|getlogdatetime
argument_list|()
argument_list|,
name|cep
operator|->
name|name
argument_list|,
name|cep
operator|->
name|charge
argument_list|,
name|con_secs
argument_list|,
name|cep
operator|->
name|inbytes
argument_list|,
name|cep
operator|->
name|outbytes
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|acctfp
argument_list|,
literal|"%s - %s %s %d (%d)\n"
argument_list|,
name|logdatetime
argument_list|,
name|getlogdatetime
argument_list|()
argument_list|,
name|cep
operator|->
name|name
argument_list|,
name|cep
operator|->
name|charge
argument_list|,
name|con_secs
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* set the B-channel inactive */
name|set_channel_idle
argument_list|(
name|cep
operator|->
name|isdncontrollerused
argument_list|,
name|cep
operator|->
name|isdnchannelused
argument_list|)
expr_stmt|;
name|incr_free_channels
argument_list|(
name|cep
operator|->
name|isdncontrollerused
argument_list|)
expr_stmt|;
name|cep
operator|->
name|connect_time
operator|=
literal|0
expr_stmt|;
name|cep
operator|->
name|cdid
operator|=
name|CDID_UNUSED
expr_stmt|;
name|next_state
argument_list|(
name|cep
argument_list|,
name|EV_MDI
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	handle incoming DIALOUT message  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|msg_dialout
parameter_list|(
name|msg_dialout_ind_t
modifier|*
name|mp
parameter_list|)
block|{
name|cfg_entry_t
modifier|*
name|cep
decl_stmt|;
name|DBGL
argument_list|(
name|DL_DRVR
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"msg_dialout: dial req from %s, unit %d"
argument_list|,
name|bdrivername
argument_list|(
name|mp
operator|->
name|driver
argument_list|)
argument_list|,
name|mp
operator|->
name|driver_unit
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|cep
operator|=
name|find_by_device_for_dialout
argument_list|(
name|mp
operator|->
name|driver
argument_list|,
name|mp
operator|->
name|driver_unit
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|DBGL
argument_list|(
name|DL_DRVR
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"msg_dialout: config entry reserved or no match"
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|cep
operator|->
name|inout
operator|==
name|DIR_INONLY
condition|)
block|{
name|dialresponse
argument_list|(
name|cep
argument_list|,
name|DSTAT_INONLY
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|cep
operator|->
name|budget_calloutperiod
operator|&&
name|cep
operator|->
name|budget_calloutncalls
condition|)
block|{
name|cep
operator|->
name|budget_calltype
operator|=
literal|0
expr_stmt|;
name|cep
operator|->
name|budget_callout_req
operator|++
expr_stmt|;
if|if
condition|(
name|cep
operator|->
name|budget_calloutncalls_cnt
operator|==
literal|0
condition|)
block|{
name|log
argument_list|(
name|LL_CHD
argument_list|,
literal|"%05d %s no budget for calling out"
argument_list|,
literal|0
argument_list|,
name|cep
operator|->
name|name
argument_list|)
expr_stmt|;
name|cep
operator|->
name|budget_callout_rej
operator|++
expr_stmt|;
name|dialresponse
argument_list|(
name|cep
argument_list|,
name|DSTAT_TFAIL
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|cep
operator|->
name|budget_calltype
operator|=
name|BUDGET_TYPE_COUT
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|cep
operator|->
name|cdid
operator|=
name|get_cdid
argument_list|()
operator|)
operator|==
literal|0
condition|)
block|{
name|DBGL
argument_list|(
name|DL_DRVR
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"msg_dialout: get_cdid() returned 0!"
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|cep
operator|->
name|charge
operator|=
literal|0
expr_stmt|;
name|cep
operator|->
name|last_charge
operator|=
literal|0
expr_stmt|;
name|cep
operator|->
name|hangup
operator|=
literal|0
expr_stmt|;
name|next_state
argument_list|(
name|cep
argument_list|,
name|EV_MDO
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	handle incoming DIALOUTNUMBER message  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|msg_dialoutnumber
parameter_list|(
name|msg_dialoutnumber_ind_t
modifier|*
name|mp
parameter_list|)
block|{
name|cfg_entry_t
modifier|*
name|cep
decl_stmt|;
name|DBGL
argument_list|(
name|DL_DRVR
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"msg_dialoutnumber: dial req from %s, unit %d"
argument_list|,
name|bdrivername
argument_list|(
name|mp
operator|->
name|driver
argument_list|)
argument_list|,
name|mp
operator|->
name|driver_unit
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|cep
operator|=
name|find_by_device_for_dialoutnumber
argument_list|(
name|mp
operator|->
name|driver
argument_list|,
name|mp
operator|->
name|driver_unit
argument_list|,
name|mp
operator|->
name|cmdlen
argument_list|,
name|mp
operator|->
name|cmd
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|DBGL
argument_list|(
name|DL_DRVR
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"msg_dialoutnumber: config entry reserved or no match"
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|cep
operator|->
name|inout
operator|==
name|DIR_INONLY
condition|)
block|{
name|dialresponse
argument_list|(
name|cep
argument_list|,
name|DSTAT_INONLY
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|cep
operator|->
name|budget_calloutperiod
operator|&&
name|cep
operator|->
name|budget_calloutncalls
condition|)
block|{
name|cep
operator|->
name|budget_calltype
operator|=
literal|0
expr_stmt|;
name|cep
operator|->
name|budget_callout_req
operator|++
expr_stmt|;
if|if
condition|(
name|cep
operator|->
name|budget_calloutncalls_cnt
operator|==
literal|0
condition|)
block|{
name|log
argument_list|(
name|LL_CHD
argument_list|,
literal|"%05d %s no budget for calling out"
argument_list|,
literal|0
argument_list|,
name|cep
operator|->
name|name
argument_list|)
expr_stmt|;
name|cep
operator|->
name|budget_callout_rej
operator|++
expr_stmt|;
name|dialresponse
argument_list|(
name|cep
argument_list|,
name|DSTAT_TFAIL
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|cep
operator|->
name|budget_calltype
operator|=
name|BUDGET_TYPE_COUT
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|cep
operator|->
name|cdid
operator|=
name|get_cdid
argument_list|()
operator|)
operator|==
literal|0
condition|)
block|{
name|DBGL
argument_list|(
name|DL_DRVR
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"msg_dialoutnumber: get_cdid() returned 0!"
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|cep
operator|->
name|keypad
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|cep
operator|->
name|charge
operator|=
literal|0
expr_stmt|;
name|cep
operator|->
name|last_charge
operator|=
literal|0
expr_stmt|;
name|cep
operator|->
name|hangup
operator|=
literal|0
expr_stmt|;
name|next_state
argument_list|(
name|cep
argument_list|,
name|EV_MDO
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	handle incoming KEYPAD message  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|msg_keypad
parameter_list|(
name|msg_keypad_ind_t
modifier|*
name|mp
parameter_list|)
block|{
name|cfg_entry_t
modifier|*
name|cep
decl_stmt|;
name|DBGL
argument_list|(
name|DL_DRVR
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"msg_keypad: dial req from %s, unit %d"
argument_list|,
name|bdrivername
argument_list|(
name|mp
operator|->
name|driver
argument_list|)
argument_list|,
name|mp
operator|->
name|driver_unit
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|cep
operator|=
name|find_by_device_for_keypad
argument_list|(
name|mp
operator|->
name|driver
argument_list|,
name|mp
operator|->
name|driver_unit
argument_list|,
name|mp
operator|->
name|cmdlen
argument_list|,
name|mp
operator|->
name|cmd
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|DBGL
argument_list|(
name|DL_DRVR
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"msg_keypad: config entry reserved or no match"
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|cep
operator|->
name|inout
operator|==
name|DIR_INONLY
condition|)
block|{
name|dialresponse
argument_list|(
name|cep
argument_list|,
name|DSTAT_INONLY
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|cep
operator|->
name|budget_calloutperiod
operator|&&
name|cep
operator|->
name|budget_calloutncalls
condition|)
block|{
name|cep
operator|->
name|budget_calltype
operator|=
literal|0
expr_stmt|;
name|cep
operator|->
name|budget_callout_req
operator|++
expr_stmt|;
if|if
condition|(
name|cep
operator|->
name|budget_calloutncalls_cnt
operator|==
literal|0
condition|)
block|{
name|log
argument_list|(
name|LL_CHD
argument_list|,
literal|"%05d %s no budget for calling out"
argument_list|,
literal|0
argument_list|,
name|cep
operator|->
name|name
argument_list|)
expr_stmt|;
name|cep
operator|->
name|budget_callout_rej
operator|++
expr_stmt|;
name|dialresponse
argument_list|(
name|cep
argument_list|,
name|DSTAT_TFAIL
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|cep
operator|->
name|budget_calltype
operator|=
name|BUDGET_TYPE_COUT
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|cep
operator|->
name|cdid
operator|=
name|get_cdid
argument_list|()
operator|)
operator|==
literal|0
condition|)
block|{
name|DBGL
argument_list|(
name|DL_DRVR
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"msg_keypad: get_cdid() returned 0!"
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|cep
operator|->
name|charge
operator|=
literal|0
expr_stmt|;
name|cep
operator|->
name|last_charge
operator|=
literal|0
expr_stmt|;
name|cep
operator|->
name|hangup
operator|=
literal|0
expr_stmt|;
name|next_state
argument_list|(
name|cep
argument_list|,
name|EV_MDO
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	handle incoming DRVRDISC_REQ message  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|msg_drvrdisc_req
parameter_list|(
name|msg_drvrdisc_req_t
modifier|*
name|mp
parameter_list|)
block|{
name|cfg_entry_t
modifier|*
name|cep
decl_stmt|;
name|DBGL
argument_list|(
name|DL_DRVR
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"msg_drvrdisc_req: req from %s, unit %d"
argument_list|,
name|bdrivername
argument_list|(
name|mp
operator|->
name|driver
argument_list|)
argument_list|,
name|mp
operator|->
name|driver_unit
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|cep
operator|=
name|get_cep_by_driver
argument_list|(
name|mp
operator|->
name|driver
argument_list|,
name|mp
operator|->
name|driver_unit
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|DBGL
argument_list|(
name|DL_DRVR
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"msg_drvrdisc_req: config entry not found"
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|next_state
argument_list|(
name|cep
argument_list|,
name|EV_DRQ
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	handle incoming ACCOUNTING message  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|msg_accounting
parameter_list|(
name|msg_accounting_ind_t
modifier|*
name|mp
parameter_list|)
block|{
name|cfg_entry_t
modifier|*
name|cep
decl_stmt|;
if|if
condition|(
operator|(
name|cep
operator|=
name|find_active_entry_by_driver
argument_list|(
name|mp
operator|->
name|driver
argument_list|,
name|mp
operator|->
name|driver_unit
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|log
argument_list|(
name|LL_WRN
argument_list|,
literal|"msg_accounting: no config entry found!"
argument_list|)
expr_stmt|;
return|return;
block|}
name|cep
operator|->
name|inbytes
operator|=
name|mp
operator|->
name|inbytes
expr_stmt|;
name|cep
operator|->
name|iinbytes
operator|=
name|mp
operator|->
name|iinbytes
expr_stmt|;
name|cep
operator|->
name|outbytes
operator|=
name|mp
operator|->
name|outbytes
expr_stmt|;
name|cep
operator|->
name|ioutbytes
operator|=
name|mp
operator|->
name|ioutbytes
expr_stmt|;
name|cep
operator|->
name|inbps
operator|=
name|mp
operator|->
name|inbps
expr_stmt|;
name|cep
operator|->
name|outbps
operator|=
name|mp
operator|->
name|outbps
expr_stmt|;
if|if
condition|(
name|mp
operator|->
name|accttype
operator|==
name|ACCT_DURING
condition|)
block|{
ifdef|#
directive|ifdef
name|USE_CURSES
if|if
condition|(
name|do_fullscreen
condition|)
name|display_acct
argument_list|(
name|cep
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|I4B_EXTERNAL_MONITOR
if|if
condition|(
name|do_monitor
operator|&&
name|accepted
condition|)
name|monitor_evnt_acct
argument_list|(
name|cep
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	handle incoming CHARGING message  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|msg_charging_ind
parameter_list|(
name|msg_charging_ind_t
modifier|*
name|mp
parameter_list|)
block|{
specifier|static
name|char
modifier|*
name|cttab
index|[]
init|=
block|{
literal|"invalid"
block|,
literal|"AOCD"
block|,
literal|"AOCE"
block|,
literal|"estimated"
block|}
decl_stmt|;
name|cfg_entry_t
modifier|*
name|cep
decl_stmt|;
if|if
condition|(
operator|(
name|cep
operator|=
name|get_cep_by_cdid
argument_list|(
name|mp
operator|->
name|header
operator|.
name|cdid
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|log
argument_list|(
name|LL_WRN
argument_list|,
literal|"msg_charging_ind: cdid not found"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|mp
operator|->
name|units_type
operator|<
name|CHARGE_INVALID
operator|||
name|mp
operator|->
name|units_type
operator|>
name|CHARGE_CALC
condition|)
block|{
name|log
argument_list|(
name|LL_ERR
argument_list|,
literal|"msg_charging: units_type %d out of range!"
argument_list|,
name|mp
operator|->
name|units_type
argument_list|)
expr_stmt|;
name|error_exit
argument_list|(
literal|1
argument_list|,
literal|"msg_charging: units_type %d out of range!"
argument_list|,
name|mp
operator|->
name|units_type
argument_list|)
expr_stmt|;
block|}
name|DBGL
argument_list|(
name|DL_DRVR
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"msg_charging: %d unit(s) (%s)"
argument_list|,
name|mp
operator|->
name|units
argument_list|,
name|cttab
index|[
name|mp
operator|->
name|units_type
index|]
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|cep
operator|->
name|charge
operator|=
name|mp
operator|->
name|units
expr_stmt|;
switch|switch
condition|(
name|mp
operator|->
name|units_type
condition|)
block|{
case|case
name|CHARGE_AOCD
case|:
if|if
condition|(
operator|(
name|cep
operator|->
name|unitlengthsrc
operator|==
name|ULSRC_DYN
operator|)
operator|&&
operator|(
name|cep
operator|->
name|charge
operator|!=
name|cep
operator|->
name|last_charge
operator|)
condition|)
block|{
name|cep
operator|->
name|last_charge
operator|=
name|cep
operator|->
name|charge
expr_stmt|;
name|handle_charge
argument_list|(
name|cep
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|CHARGE_CALC
case|:
ifdef|#
directive|ifdef
name|USE_CURSES
if|if
condition|(
name|do_fullscreen
condition|)
name|display_ccharge
argument_list|(
name|cep
argument_list|,
name|mp
operator|->
name|units
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|I4B_EXTERNAL_MONITOR
if|if
condition|(
name|do_monitor
operator|&&
name|accepted
condition|)
name|monitor_evnt_charge
argument_list|(
name|cep
argument_list|,
name|mp
operator|->
name|units
argument_list|,
literal|1
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
block|}
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	handle incoming IDLE_TIMEOUT_IND message  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|msg_idle_timeout_ind
parameter_list|(
name|msg_idle_timeout_ind_t
modifier|*
name|mp
parameter_list|)
block|{
name|cfg_entry_t
modifier|*
name|cep
decl_stmt|;
if|if
condition|(
operator|(
name|cep
operator|=
name|get_cep_by_cdid
argument_list|(
name|mp
operator|->
name|header
operator|.
name|cdid
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|log
argument_list|(
name|LL_WRN
argument_list|,
literal|"msg_idle_timeout_ind: cdid not found!"
argument_list|)
expr_stmt|;
return|return;
block|}
name|cep
operator|->
name|local_disconnect
operator|=
name|DISCON_LOC
expr_stmt|;
name|DBGL
argument_list|(
name|DL_DRVR
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"msg_idle_timeout_ind: idletimeout, kernel sent disconnect!"
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|check_and_kill
argument_list|(
name|cep
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *    handle incoming MSG_PACKET_IND message  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|char
modifier|*
name|strapp
parameter_list|(
name|char
modifier|*
name|buf
parameter_list|,
specifier|const
name|char
modifier|*
name|txt
parameter_list|)
block|{
while|while
condition|(
operator|*
name|txt
condition|)
operator|*
name|buf
operator|++
operator|=
operator|*
name|txt
operator|++
expr_stmt|;
operator|*
name|buf
operator|=
literal|'\0'
expr_stmt|;
return|return
name|buf
return|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *    handle incoming MSG_PACKET_IND message  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|char
modifier|*
name|ipapp
parameter_list|(
name|char
modifier|*
name|buf
parameter_list|,
name|unsigned
name|long
name|a
parameter_list|)
block|{
name|unsigned
name|long
name|ma
init|=
name|ntohl
argument_list|(
name|a
argument_list|)
decl_stmt|;
name|buf
operator|+=
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%lu.%lu.%lu.%lu"
argument_list|,
operator|(
name|ma
operator|>>
literal|24
operator|)
operator|&
literal|0xFF
argument_list|,
operator|(
name|ma
operator|>>
literal|16
operator|)
operator|&
literal|0xFF
argument_list|,
operator|(
name|ma
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
argument_list|,
operator|(
name|ma
operator|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
return|return
name|buf
return|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *    handle incoming MSG_PACKET_IND message  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|msg_packet_ind
parameter_list|(
name|msg_packet_ind_t
modifier|*
name|mp
parameter_list|)
block|{
name|cfg_entry_t
modifier|*
name|cep
decl_stmt|;
name|struct
name|ip
modifier|*
name|ip
decl_stmt|;
name|u_char
modifier|*
name|proto_hdr
decl_stmt|;
name|char
name|tmp
index|[
literal|80
index|]
decl_stmt|;
name|char
modifier|*
name|cptr
init|=
name|tmp
decl_stmt|;
name|char
modifier|*
name|name
init|=
literal|"???"
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nentries
condition|;
name|i
operator|++
control|)
block|{
name|cep
operator|=
operator|&
name|cfg_entry_tab
index|[
name|i
index|]
expr_stmt|;
comment|/* ptr to config entry */
if|if
condition|(
name|cep
operator|->
name|usrdevicename
operator|==
name|mp
operator|->
name|driver
operator|&&
name|cep
operator|->
name|usrdeviceunit
operator|==
name|mp
operator|->
name|driver_unit
condition|)
block|{
name|name
operator|=
name|cep
operator|->
name|name
expr_stmt|;
break|break;
block|}
block|}
name|ip
operator|=
operator|(
expr|struct
name|ip
operator|*
operator|)
name|mp
operator|->
name|pktdata
expr_stmt|;
name|proto_hdr
operator|=
name|mp
operator|->
name|pktdata
operator|+
operator|(
operator|(
name|ip
operator|->
name|ip_hl
operator|)
operator|<<
literal|2
operator|)
expr_stmt|;
if|if
condition|(
name|ip
operator|->
name|ip_p
operator|==
name|IPPROTO_TCP
condition|)
block|{
name|struct
name|tcphdr
modifier|*
name|tcp
init|=
operator|(
expr|struct
name|tcphdr
operator|*
operator|)
name|proto_hdr
decl_stmt|;
name|cptr
operator|=
name|strapp
argument_list|(
name|cptr
argument_list|,
literal|"TCP "
argument_list|)
expr_stmt|;
name|cptr
operator|=
name|ipapp
argument_list|(
name|cptr
argument_list|,
name|ip
operator|->
name|ip_src
operator|.
name|s_addr
argument_list|)
expr_stmt|;
name|cptr
operator|+=
name|sprintf
argument_list|(
name|cptr
argument_list|,
literal|":%u -> "
argument_list|,
name|ntohs
argument_list|(
name|tcp
operator|->
name|th_sport
argument_list|)
argument_list|)
expr_stmt|;
name|cptr
operator|=
name|ipapp
argument_list|(
name|cptr
argument_list|,
name|ip
operator|->
name|ip_dst
operator|.
name|s_addr
argument_list|)
expr_stmt|;
name|cptr
operator|+=
name|sprintf
argument_list|(
name|cptr
argument_list|,
literal|":%u"
argument_list|,
name|ntohs
argument_list|(
name|tcp
operator|->
name|th_dport
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tcp
operator|->
name|th_flags
operator|&
name|TH_FIN
condition|)
name|cptr
operator|=
name|strapp
argument_list|(
name|cptr
argument_list|,
literal|" FIN"
argument_list|)
expr_stmt|;
if|if
condition|(
name|tcp
operator|->
name|th_flags
operator|&
name|TH_SYN
condition|)
name|cptr
operator|=
name|strapp
argument_list|(
name|cptr
argument_list|,
literal|" SYN"
argument_list|)
expr_stmt|;
if|if
condition|(
name|tcp
operator|->
name|th_flags
operator|&
name|TH_RST
condition|)
name|cptr
operator|=
name|strapp
argument_list|(
name|cptr
argument_list|,
literal|" RST"
argument_list|)
expr_stmt|;
if|if
condition|(
name|tcp
operator|->
name|th_flags
operator|&
name|TH_PUSH
condition|)
name|cptr
operator|=
name|strapp
argument_list|(
name|cptr
argument_list|,
literal|" PUSH"
argument_list|)
expr_stmt|;
if|if
condition|(
name|tcp
operator|->
name|th_flags
operator|&
name|TH_ACK
condition|)
name|cptr
operator|=
name|strapp
argument_list|(
name|cptr
argument_list|,
literal|" ACK"
argument_list|)
expr_stmt|;
if|if
condition|(
name|tcp
operator|->
name|th_flags
operator|&
name|TH_URG
condition|)
name|cptr
operator|=
name|strapp
argument_list|(
name|cptr
argument_list|,
literal|" URG"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ip
operator|->
name|ip_p
operator|==
name|IPPROTO_UDP
condition|)
block|{
name|struct
name|udphdr
modifier|*
name|udp
init|=
operator|(
expr|struct
name|udphdr
operator|*
operator|)
name|proto_hdr
decl_stmt|;
name|cptr
operator|=
name|strapp
argument_list|(
name|cptr
argument_list|,
literal|"UDP "
argument_list|)
expr_stmt|;
name|cptr
operator|=
name|ipapp
argument_list|(
name|cptr
argument_list|,
name|ip
operator|->
name|ip_src
operator|.
name|s_addr
argument_list|)
expr_stmt|;
name|cptr
operator|+=
name|sprintf
argument_list|(
name|cptr
argument_list|,
literal|":%u -> "
argument_list|,
name|ntohs
argument_list|(
name|udp
operator|->
name|uh_sport
argument_list|)
argument_list|)
expr_stmt|;
name|cptr
operator|=
name|ipapp
argument_list|(
name|cptr
argument_list|,
name|ip
operator|->
name|ip_dst
operator|.
name|s_addr
argument_list|)
expr_stmt|;
name|cptr
operator|+=
name|sprintf
argument_list|(
name|cptr
argument_list|,
literal|":%u"
argument_list|,
name|ntohs
argument_list|(
name|udp
operator|->
name|uh_dport
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ip
operator|->
name|ip_p
operator|==
name|IPPROTO_ICMP
condition|)
block|{
name|struct
name|icmp
modifier|*
name|icmp
init|=
operator|(
expr|struct
name|icmp
operator|*
operator|)
name|proto_hdr
decl_stmt|;
name|cptr
operator|+=
name|sprintf
argument_list|(
name|cptr
argument_list|,
literal|"ICMP:%u.%u"
argument_list|,
name|icmp
operator|->
name|icmp_type
argument_list|,
name|icmp
operator|->
name|icmp_code
argument_list|)
expr_stmt|;
name|cptr
operator|=
name|ipapp
argument_list|(
name|cptr
argument_list|,
name|ip
operator|->
name|ip_src
operator|.
name|s_addr
argument_list|)
expr_stmt|;
name|cptr
operator|=
name|strapp
argument_list|(
name|cptr
argument_list|,
literal|" -> "
argument_list|)
expr_stmt|;
name|cptr
operator|=
name|ipapp
argument_list|(
name|cptr
argument_list|,
name|ip
operator|->
name|ip_dst
operator|.
name|s_addr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|cptr
operator|+=
name|sprintf
argument_list|(
name|cptr
argument_list|,
literal|"PROTO=%u "
argument_list|,
name|ip
operator|->
name|ip_p
argument_list|)
expr_stmt|;
name|cptr
operator|=
name|ipapp
argument_list|(
name|cptr
argument_list|,
name|ip
operator|->
name|ip_src
operator|.
name|s_addr
argument_list|)
expr_stmt|;
name|cptr
operator|=
name|strapp
argument_list|(
name|cptr
argument_list|,
literal|" -> "
argument_list|)
expr_stmt|;
name|cptr
operator|=
name|ipapp
argument_list|(
name|cptr
argument_list|,
name|ip
operator|->
name|ip_dst
operator|.
name|s_addr
argument_list|)
expr_stmt|;
block|}
name|log
argument_list|(
name|LL_PKT
argument_list|,
literal|"%s %s %u %s"
argument_list|,
name|name
argument_list|,
name|mp
operator|->
name|direction
condition|?
literal|"send"
else|:
literal|"recv"
argument_list|,
name|ntohs
argument_list|(
name|ip
operator|->
name|ip_len
argument_list|)
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	get a cdid from kernel  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|int
name|get_cdid
parameter_list|(
name|void
parameter_list|)
block|{
name|msg_cdid_req_t
name|mcr
decl_stmt|;
name|mcr
operator|.
name|cdid
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|ioctl
argument_list|(
name|isdnfd
argument_list|,
name|I4B_CDID_REQ
argument_list|,
operator|&
name|mcr
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|log
argument_list|(
name|LL_ERR
argument_list|,
literal|"get_cdid: ioctl I4B_CDID_REQ failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|error_exit
argument_list|(
literal|1
argument_list|,
literal|"get_cdid: ioctl I4B_CDID_REQ failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|mcr
operator|.
name|cdid
operator|)
return|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *      send message "connect request" to kernel  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|int
name|sendm_connect_req
parameter_list|(
name|cfg_entry_t
modifier|*
name|cep
parameter_list|)
block|{
name|msg_connect_req_t
name|mcr
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|cep
operator|->
name|local_disconnect
operator|=
name|DISCON_REM
expr_stmt|;
name|cep
operator|->
name|unitlength
operator|=
name|get_current_rate
argument_list|(
name|cep
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|mcr
operator|.
name|cdid
operator|=
name|cep
operator|->
name|cdid
expr_stmt|;
name|mcr
operator|.
name|controller
operator|=
name|cep
operator|->
name|isdncontrollerused
expr_stmt|;
name|mcr
operator|.
name|channel
operator|=
name|cep
operator|->
name|isdnchannelused
expr_stmt|;
name|mcr
operator|.
name|txdelay
operator|=
name|cep
operator|->
name|isdntxdelout
expr_stmt|;
name|mcr
operator|.
name|bprot
operator|=
name|cep
operator|->
name|b1protocol
expr_stmt|;
name|mcr
operator|.
name|driver
operator|=
name|cep
operator|->
name|usrdevicename
expr_stmt|;
name|mcr
operator|.
name|driver_unit
operator|=
name|cep
operator|->
name|usrdeviceunit
expr_stmt|;
comment|/* setup the shorthold data */
name|mcr
operator|.
name|shorthold_data
operator|.
name|shorthold_algorithm
operator|=
name|cep
operator|->
name|shorthold_algorithm
expr_stmt|;
name|mcr
operator|.
name|shorthold_data
operator|.
name|unitlen_time
operator|=
name|cep
operator|->
name|unitlength
expr_stmt|;
name|mcr
operator|.
name|shorthold_data
operator|.
name|idle_time
operator|=
name|cep
operator|->
name|idle_time_out
expr_stmt|;
name|mcr
operator|.
name|shorthold_data
operator|.
name|earlyhup_time
operator|=
name|cep
operator|->
name|earlyhangup
expr_stmt|;
if|if
condition|(
name|cep
operator|->
name|unitlengthsrc
operator|==
name|ULSRC_DYN
condition|)
name|mcr
operator|.
name|unitlen_method
operator|=
name|ULEN_METHOD_DYNAMIC
expr_stmt|;
else|else
name|mcr
operator|.
name|unitlen_method
operator|=
name|ULEN_METHOD_STATIC
expr_stmt|;
name|strcpy
argument_list|(
name|mcr
operator|.
name|dst_telno
argument_list|,
name|cep
operator|->
name|remote_phone_dialout
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|mcr
operator|.
name|src_telno
argument_list|,
name|cep
operator|->
name|local_phone_dialout
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|mcr
operator|.
name|keypad
argument_list|,
name|cep
operator|->
name|keypad
argument_list|)
expr_stmt|;
name|cep
operator|->
name|last_dial_time
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|cep
operator|->
name|direction
operator|=
name|DIR_OUT
expr_stmt|;
name|DBGL
argument_list|(
name|DL_CNST
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"sendm_connect_req: ctrl = %d, chan = %d"
argument_list|,
name|cep
operator|->
name|isdncontrollerused
argument_list|,
name|cep
operator|->
name|isdnchannelused
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ret
operator|=
name|ioctl
argument_list|(
name|isdnfd
argument_list|,
name|I4B_CONNECT_REQ
argument_list|,
operator|&
name|mcr
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|log
argument_list|(
name|LL_ERR
argument_list|,
literal|"sendm_connect_req: ioctl I4B_CONNECT_REQ failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|error_exit
argument_list|(
literal|1
argument_list|,
literal|"sendm_connect_req: ioctl I4B_CONNECT_REQ failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|decr_free_channels
argument_list|(
name|cep
operator|->
name|isdncontrollerused
argument_list|)
expr_stmt|;
name|log
argument_list|(
name|LL_CHD
argument_list|,
literal|"%05d %s dialing out from %s to %s"
argument_list|,
name|cep
operator|->
name|cdid
argument_list|,
name|cep
operator|->
name|name
argument_list|,
name|aliasing
condition|?
name|get_alias
argument_list|(
name|cep
operator|->
name|local_phone_dialout
argument_list|)
else|:
name|cep
operator|->
name|local_phone_dialout
argument_list|,
name|aliasing
condition|?
name|get_alias
argument_list|(
name|cep
operator|->
name|remote_phone_dialout
argument_list|)
else|:
name|cep
operator|->
name|remote_phone_dialout
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	send message "connect response" to kernel  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|int
name|sendm_connect_resp
parameter_list|(
name|cfg_entry_t
modifier|*
name|cep
parameter_list|,
name|int
name|cdid
parameter_list|,
name|int
name|response
parameter_list|,
name|cause_t
name|cause
parameter_list|)
block|{
name|msg_connect_resp_t
name|mcr
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|mcr
operator|.
name|cdid
operator|=
name|cdid
expr_stmt|;
name|mcr
operator|.
name|response
operator|=
name|response
expr_stmt|;
if|if
condition|(
name|response
operator|==
name|SETUP_RESP_REJECT
condition|)
block|{
name|mcr
operator|.
name|cause
operator|=
name|cause
expr_stmt|;
name|DBGL
argument_list|(
name|DL_DRVR
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"sendm_connect_resp: reject, cause=0x%x"
argument_list|,
name|cause
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|response
operator|==
name|SETUP_RESP_ACCEPT
condition|)
block|{
name|cep
operator|->
name|direction
operator|=
name|DIR_IN
expr_stmt|;
name|mcr
operator|.
name|txdelay
operator|=
name|cep
operator|->
name|isdntxdelin
expr_stmt|;
name|mcr
operator|.
name|bprot
operator|=
name|cep
operator|->
name|b1protocol
expr_stmt|;
name|mcr
operator|.
name|driver
operator|=
name|cep
operator|->
name|usrdevicename
expr_stmt|;
name|mcr
operator|.
name|driver_unit
operator|=
name|cep
operator|->
name|usrdeviceunit
expr_stmt|;
name|mcr
operator|.
name|max_idle_time
operator|=
name|cep
operator|->
name|idle_time_in
expr_stmt|;
name|DBGL
argument_list|(
name|DL_DRVR
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"sendm_connect_resp: accept"
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|ret
operator|=
name|ioctl
argument_list|(
name|isdnfd
argument_list|,
name|I4B_CONNECT_RESP
argument_list|,
operator|&
name|mcr
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|log
argument_list|(
name|LL_ERR
argument_list|,
literal|"sendm_connect_resp: ioctl I4B_CONNECT_RESP failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|error_exit
argument_list|(
literal|1
argument_list|,
literal|"sendm_connect_resp: ioctl I4B_CONNECT_RESP failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	send message "disconnect request" to kernel  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|int
name|sendm_disconnect_req
parameter_list|(
name|cfg_entry_t
modifier|*
name|cep
parameter_list|,
name|cause_t
name|cause
parameter_list|)
block|{
name|msg_discon_req_t
name|mcr
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|mcr
operator|.
name|cdid
operator|=
name|cep
operator|->
name|cdid
expr_stmt|;
name|mcr
operator|.
name|cause
operator|=
name|cause
expr_stmt|;
name|cep
operator|->
name|local_disconnect
operator|=
name|DISCON_LOC
expr_stmt|;
if|if
condition|(
operator|(
name|ret
operator|=
name|ioctl
argument_list|(
name|isdnfd
argument_list|,
name|I4B_DISCONNECT_REQ
argument_list|,
operator|&
name|mcr
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|log
argument_list|(
name|LL_ERR
argument_list|,
literal|"sendm_disconnect_req: ioctl I4B_DISCONNECT_REQ failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DBGL
argument_list|(
name|DL_DRVR
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"sendm_disconnect_req: sent DISCONNECT_REQ"
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	send message "alert request" to kernel  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|int
name|sendm_alert_req
parameter_list|(
name|cfg_entry_t
modifier|*
name|cep
parameter_list|)
block|{
name|msg_alert_req_t
name|mar
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|mar
operator|.
name|cdid
operator|=
name|cep
operator|->
name|cdid
expr_stmt|;
if|if
condition|(
operator|(
name|ret
operator|=
name|ioctl
argument_list|(
name|isdnfd
argument_list|,
name|I4B_ALERT_REQ
argument_list|,
operator|&
name|mar
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|log
argument_list|(
name|LL_ERR
argument_list|,
literal|"sendm_alert_req: ioctl I4B_ALERT_REQ failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|error_exit
argument_list|(
literal|1
argument_list|,
literal|"sendm_alert_req: ioctl I4B_ALERT_REQ failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DBGL
argument_list|(
name|DL_DRVR
argument_list|,
operator|(
name|log
argument_list|(
name|LL_DBG
argument_list|,
literal|"sendm_alert_req: sent ALERT_REQ"
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_comment
comment|/* EOF */
end_comment

end_unit


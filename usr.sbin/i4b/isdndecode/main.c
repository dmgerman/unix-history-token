begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1997, 2000 Hellmuth Michaelis. All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  *---------------------------------------------------------------------------  *  *	main.c - isdndecode main program file  *	-------------------------------------  *  *	$Id: main.c,v 1.13 2000/02/21 15:17:17 hm Exp $  *  * $FreeBSD$  *  *      last edit-date: [Mon Feb 21 16:19:30 2000]  *  *---------------------------------------------------------------------------*/
end_comment

begin_include
include|#
directive|include
file|"decode.h"
end_include

begin_decl_stmt
name|unsigned
name|char
name|buf
index|[
name|BSIZE
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILE
modifier|*
name|Fout
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILE
modifier|*
name|BP
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|outflag
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|header
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|print_q921
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|unit
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|dchan
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|bchan
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|traceon
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|analyze
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|Rx
init|=
name|RxUDEF
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|Tx
init|=
name|TxUDEF
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|f
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|Bopt
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|Popt
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|bpopt
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|info
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|xflag
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|enable_trace
init|=
name|TRACE_D_RX
operator||
name|TRACE_D_TX
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|outfilename
index|[
literal|1024
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|BPfilename
index|[
literal|1024
index|]
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|dumpbuf
parameter_list|(
name|int
name|n
parameter_list|,
name|unsigned
name|char
modifier|*
name|buf
parameter_list|,
name|i4b_trace_hdr_t
modifier|*
name|hdr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|switch_driver
parameter_list|(
name|int
name|value
parameter_list|,
name|int
name|rx
parameter_list|,
name|int
name|tx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|usage
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|exit_hdl
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|reopenfiles
parameter_list|(
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*---------------------------------------------------------------------------*  *	usage intructions  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|usage
parameter_list|(
name|void
parameter_list|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"isdndecode - isdn4bsd package ISDN decoder for passive cards (%d.%d.%d)\n"
argument_list|,
name|VERSION
argument_list|,
name|REL
argument_list|,
name|STEP
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"usage: isdntrace -a -b -d -f<file> -h -i -l -n<val> -o -p<file> -r -u<unit>\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"                 -x -B -P -R<unit> -T<unit>\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       -a        analyzer mode ................................... (default off)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       -b        switch B channel trace on ....................... (default off)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       -d        switch D channel trace off ....................... (default on)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       -f<file> write output to file filename ........... (default %s0)\n"
argument_list|,
name|DECODE_FILE_NAME
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       -h        don't print header for each message ............. (default off)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       -i        print I.430 (layer 1) INFO signals .............. (default off)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       -l        don't decode low layer Q.921 messages ........... (default off)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       -o        don't write output to a file .................... (default off)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       -p<file> specify filename for -B and -P ........ (default %s0)\n"
argument_list|,
name|BIN_FILE_NAME
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       -u<unit> specify controller unit number ............... (default unit 0)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       -x        print packets with unknown protocoldiscriminator  (default off)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       -B        write binary trace data to file filename ........ (default off)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       -P        playback from binary trace data file ............ (default off)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       -R<unit> analyze Rx controller unit number (for -a) ... (default unit %d)\n"
argument_list|,
name|RxUDEF
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       -T<unit> analyze Tx controller unit number (for -a) ... (default unit %d)\n"
argument_list|,
name|TxUDEF
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	main  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
specifier|extern
name|int
name|optind
decl_stmt|;
specifier|extern
name|int
name|opterr
decl_stmt|;
specifier|extern
name|char
modifier|*
name|optarg
decl_stmt|;
name|char
name|devicename
index|[
literal|80
index|]
decl_stmt|;
name|char
name|headerbuf
index|[
literal|256
index|]
decl_stmt|;
name|int
name|n
decl_stmt|;
name|int
name|c
decl_stmt|;
name|char
modifier|*
name|b
decl_stmt|;
name|char
modifier|*
name|outfile
init|=
name|DECODE_FILE_NAME
decl_stmt|;
name|char
modifier|*
name|binfile
init|=
name|BIN_FILE_NAME
decl_stmt|;
name|int
name|outfileset
init|=
literal|0
decl_stmt|;
name|time_t
name|tm
decl_stmt|;
name|i4b_trace_hdr_t
modifier|*
name|ithp
init|=
name|NULL
decl_stmt|;
name|int
name|l
decl_stmt|;
name|b
operator|=
operator|&
name|buf
index|[
sizeof|sizeof
argument_list|(
name|i4b_trace_hdr_t
argument_list|)
index|]
expr_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"abdf:hiln:op:u:xBPR:T:"
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'a'
case|:
name|analyze
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'b'
case|:
name|enable_trace
operator||=
operator|(
name|TRACE_B_RX
operator||
name|TRACE_B_TX
operator|)
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
name|enable_trace
operator|&=
operator|(
operator|~
operator|(
name|TRACE_D_TX
operator||
name|TRACE_D_RX
operator|)
operator|)
expr_stmt|;
break|break;
case|case
literal|'o'
case|:
name|outflag
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'f'
case|:
name|outfile
operator|=
name|optarg
expr_stmt|;
name|outfileset
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'h'
case|:
name|header
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'i'
case|:
name|enable_trace
operator||=
name|TRACE_I
expr_stmt|;
name|info
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
name|print_q921
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
name|binfile
operator|=
name|optarg
expr_stmt|;
name|bpopt
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'u'
case|:
name|unit
operator|=
name|atoi
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
if|if
condition|(
name|unit
operator|<
literal|0
operator|||
name|unit
operator|>=
name|MAX_CONTROLLERS
condition|)
name|usage
argument_list|()
expr_stmt|;
break|break;
case|case
literal|'x'
case|:
name|xflag
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'B'
case|:
name|Bopt
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'P'
case|:
name|Popt
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'R'
case|:
name|Rx
operator|=
name|atoi
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
if|if
condition|(
name|Rx
operator|<
literal|0
operator|||
name|Rx
operator|>=
name|MAX_CONTROLLERS
condition|)
name|usage
argument_list|()
expr_stmt|;
break|break;
case|case
literal|'T'
case|:
name|Tx
operator|=
name|atoi
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
if|if
condition|(
name|Tx
operator|<
literal|0
operator|||
name|Tx
operator|>=
name|MAX_CONTROLLERS
condition|)
name|usage
argument_list|()
expr_stmt|;
break|break;
case|case
literal|'?'
case|:
default|default:
name|usage
argument_list|()
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|enable_trace
operator|==
literal|0
condition|)
name|usage
argument_list|()
expr_stmt|;
if|if
condition|(
name|Bopt
operator|&&
name|Popt
condition|)
name|usage
argument_list|()
expr_stmt|;
name|atexit
argument_list|(
name|exit_hdl
argument_list|)
expr_stmt|;
if|if
condition|(
name|Bopt
condition|)
block|{
if|if
condition|(
name|bpopt
condition|)
name|sprintf
argument_list|(
name|BPfilename
argument_list|,
literal|"%s"
argument_list|,
name|binfile
argument_list|)
expr_stmt|;
else|else
name|sprintf
argument_list|(
name|BPfilename
argument_list|,
literal|"%s%d"
argument_list|,
name|BIN_FILE_NAME
argument_list|,
name|unit
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|BP
operator|=
name|fopen
argument_list|(
name|BPfilename
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|char
name|buffer
index|[
literal|1024
index|]
decl_stmt|;
name|fclose
argument_list|(
name|BP
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"%s%s"
argument_list|,
name|BPfilename
argument_list|,
name|DECODE_FILE_NAME_BAK
argument_list|)
expr_stmt|;
name|rename
argument_list|(
name|BPfilename
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|BP
operator|=
name|fopen
argument_list|(
name|BPfilename
argument_list|,
literal|"w"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|char
name|buffer
index|[
literal|80
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"Error opening file [%s]"
argument_list|,
name|BPfilename
argument_list|)
expr_stmt|;
name|perror
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|setvbuf
argument_list|(
name|BP
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|,
name|_IONBF
argument_list|,
literal|0
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|char
name|buffer
index|[
literal|80
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"Error setting file [%s] to unbuffered"
argument_list|,
name|BPfilename
argument_list|)
expr_stmt|;
name|perror
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|Popt
condition|)
block|{
if|if
condition|(
name|bpopt
condition|)
name|sprintf
argument_list|(
name|BPfilename
argument_list|,
literal|"%s"
argument_list|,
name|binfile
argument_list|)
expr_stmt|;
else|else
name|sprintf
argument_list|(
name|BPfilename
argument_list|,
literal|"%s%d"
argument_list|,
name|BIN_FILE_NAME
argument_list|,
name|unit
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|BP
operator|=
name|fopen
argument_list|(
name|BPfilename
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|char
name|buffer
index|[
literal|80
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"Error opening file [%s]"
argument_list|,
name|BPfilename
argument_list|)
expr_stmt|;
name|perror
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|sprintf
argument_list|(
name|devicename
argument_list|,
literal|"%s%d"
argument_list|,
name|I4BTRC_DEVICE
argument_list|,
name|unit
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|f
operator|=
name|open
argument_list|(
name|devicename
argument_list|,
name|O_RDWR
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|char
name|buffer
index|[
literal|80
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"Error opening trace device [%s]"
argument_list|,
name|devicename
argument_list|)
expr_stmt|;
name|perror
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|outflag
condition|)
block|{
if|if
condition|(
name|outfileset
operator|==
literal|0
condition|)
name|sprintf
argument_list|(
name|outfilename
argument_list|,
literal|"%s%d"
argument_list|,
name|DECODE_FILE_NAME
argument_list|,
name|unit
argument_list|)
expr_stmt|;
else|else
name|strcpy
argument_list|(
name|outfilename
argument_list|,
name|outfile
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|Fout
operator|=
name|fopen
argument_list|(
name|outfilename
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|char
name|buffer
index|[
literal|1024
index|]
decl_stmt|;
name|fclose
argument_list|(
name|Fout
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"%s%s"
argument_list|,
name|outfilename
argument_list|,
name|DECODE_FILE_NAME_BAK
argument_list|)
expr_stmt|;
name|rename
argument_list|(
name|outfilename
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|Fout
operator|=
name|fopen
argument_list|(
name|outfilename
argument_list|,
literal|"w"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|char
name|buffer
index|[
literal|80
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"Error opening file [%s]"
argument_list|,
name|outfilename
argument_list|)
expr_stmt|;
name|perror
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|setvbuf
argument_list|(
name|Fout
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|,
name|_IONBF
argument_list|,
literal|0
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|char
name|buffer
index|[
literal|80
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"Error setting file [%s] to unbuffered"
argument_list|,
name|outfile
argument_list|)
expr_stmt|;
name|perror
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|setvbuf
argument_list|(
name|stdout
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|,
name|_IOLBF
argument_list|,
literal|0
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|char
name|buffer
index|[
literal|80
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"Error setting stdout to line-buffered"
argument_list|)
expr_stmt|;
name|perror
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|Popt
condition|)
block|{
if|if
condition|(
operator|(
name|switch_driver
argument_list|(
name|enable_trace
argument_list|,
name|Rx
argument_list|,
name|Tx
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
else|else
name|traceon
operator|=
literal|1
expr_stmt|;
block|}
name|signal
argument_list|(
name|SIGHUP
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
comment|/* ignore hangup signal */
name|signal
argument_list|(
name|SIGUSR1
argument_list|,
name|reopenfiles
argument_list|)
expr_stmt|;
comment|/* rotate logfile(s)	*/
name|time
argument_list|(
operator|&
name|tm
argument_list|)
expr_stmt|;
if|if
condition|(
name|analyze
condition|)
block|{
name|sprintf
argument_list|(
name|headerbuf
argument_list|,
literal|"\n==== isdnanalyze controller rx #%d - tx #%d ==== started %s"
argument_list|,
name|Rx
argument_list|,
name|Tx
argument_list|,
name|ctime
argument_list|(
operator|&
name|tm
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|sprintf
argument_list|(
name|headerbuf
argument_list|,
literal|"\n=========== isdntrace controller #%d =========== started %s"
argument_list|,
name|unit
argument_list|,
name|ctime
argument_list|(
operator|&
name|tm
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|headerbuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|outflag
condition|)
name|fprintf
argument_list|(
name|Fout
argument_list|,
literal|"%s"
argument_list|,
name|headerbuf
argument_list|)
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|Popt
operator|==
literal|0
condition|)
block|{
name|n
operator|=
name|read
argument_list|(
name|f
argument_list|,
name|buf
argument_list|,
name|BSIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|Bopt
condition|)
block|{
if|if
condition|(
operator|(
name|fwrite
argument_list|(
name|buf
argument_list|,
literal|1
argument_list|,
name|n
argument_list|,
name|BP
argument_list|)
operator|)
operator|!=
name|n
condition|)
block|{
name|char
name|buffer
index|[
literal|80
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"Error writing file [%s]"
argument_list|,
name|BPfilename
argument_list|)
expr_stmt|;
name|perror
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
name|n
operator|-=
sizeof|sizeof
argument_list|(
name|i4b_trace_hdr_t
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|(
name|fread
argument_list|(
name|buf
argument_list|,
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|i4b_trace_hdr_t
argument_list|)
argument_list|,
name|BP
argument_list|)
operator|)
operator|!=
sizeof|sizeof
argument_list|(
name|i4b_trace_hdr_t
argument_list|)
condition|)
block|{
if|if
condition|(
name|feof
argument_list|(
name|BP
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"\nEnd of playback input file reached.\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|char
name|buffer
index|[
literal|80
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"Error reading hdr from file [%s]"
argument_list|,
name|BPfilename
argument_list|)
expr_stmt|;
name|perror
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
name|ithp
operator|=
operator|(
name|i4b_trace_hdr_t
operator|*
operator|)
name|buf
expr_stmt|;
name|l
operator|=
name|ithp
operator|->
name|length
operator|-
sizeof|sizeof
argument_list|(
name|i4b_trace_hdr_t
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|n
operator|=
name|fread
argument_list|(
name|buf
operator|+
sizeof|sizeof
argument_list|(
name|i4b_trace_hdr_t
argument_list|)
argument_list|,
literal|1
argument_list|,
name|l
argument_list|,
name|BP
argument_list|)
operator|)
operator|!=
name|l
condition|)
block|{
name|char
name|buffer
index|[
literal|80
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"Error reading data from file [%s]"
argument_list|,
name|BPfilename
argument_list|)
expr_stmt|;
name|perror
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|n
operator|>
literal|0
condition|)
block|{
name|dumpbuf
argument_list|(
name|n
argument_list|,
name|b
argument_list|,
operator|(
name|i4b_trace_hdr_t
operator|*
operator|)
name|buf
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	format header into static buffer, return buffer address  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|char
modifier|*
name|fmt_hdr
parameter_list|(
name|i4b_trace_hdr_t
modifier|*
name|hdr
parameter_list|,
name|int
name|frm_len
parameter_list|)
block|{
name|struct
name|tm
modifier|*
name|s
decl_stmt|;
specifier|static
name|char
name|hbuf
index|[
literal|256
index|]
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
name|s
operator|=
name|localtime
argument_list|(
operator|(
name|time_t
operator|*
operator|)
operator|&
operator|(
name|hdr
operator|->
name|time
operator|.
name|tv_sec
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|hdr
operator|->
name|type
operator|==
name|TRC_CH_I
condition|)
comment|/* Layer 1 INFO's */
block|{
name|sprintf
argument_list|(
name|hbuf
argument_list|,
literal|"\n-- %s - unit:%d ---------------- time:%2.2d.%2.2d %2.2d:%2.2d:%2.2d.%06u "
argument_list|,
operator|(
operator|(
name|hdr
operator|->
name|dir
operator|)
condition|?
literal|"NT->TE"
else|:
literal|"TE->NT"
operator|)
argument_list|,
name|hdr
operator|->
name|unit
argument_list|,
name|s
operator|->
name|tm_mday
argument_list|,
name|s
operator|->
name|tm_mon
operator|+
literal|1
argument_list|,
name|s
operator|->
name|tm_hour
argument_list|,
name|s
operator|->
name|tm_min
argument_list|,
name|s
operator|->
name|tm_sec
argument_list|,
operator|(
name|u_int32_t
operator|)
name|hdr
operator|->
name|time
operator|.
name|tv_usec
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|hdr
operator|->
name|trunc
operator|>
literal|0
condition|)
block|{
name|sprintf
argument_list|(
name|hbuf
argument_list|,
literal|"\n-- %s - unit:%d - frame:%6.6u - time:%2.2d.%2.2d %2.2d:%2.2d:%2.2d.%06u - length:%d (%d) "
argument_list|,
operator|(
operator|(
name|hdr
operator|->
name|dir
operator|)
condition|?
literal|"NT->TE"
else|:
literal|"TE->NT"
operator|)
argument_list|,
name|hdr
operator|->
name|unit
argument_list|,
name|hdr
operator|->
name|count
argument_list|,
name|s
operator|->
name|tm_mday
argument_list|,
name|s
operator|->
name|tm_mon
operator|+
literal|1
argument_list|,
name|s
operator|->
name|tm_hour
argument_list|,
name|s
operator|->
name|tm_min
argument_list|,
name|s
operator|->
name|tm_sec
argument_list|,
operator|(
name|u_int32_t
operator|)
name|hdr
operator|->
name|time
operator|.
name|tv_usec
argument_list|,
name|frm_len
argument_list|,
name|hdr
operator|->
name|trunc
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|sprintf
argument_list|(
name|hbuf
argument_list|,
literal|"\n-- %s - unit:%d - frame:%6.6u - time:%2.2d.%2.2d %2.2d:%2.2d:%2.2d.%06u - length:%d "
argument_list|,
operator|(
operator|(
name|hdr
operator|->
name|dir
operator|)
condition|?
literal|"NT->TE"
else|:
literal|"TE->NT"
operator|)
argument_list|,
name|hdr
operator|->
name|unit
argument_list|,
name|hdr
operator|->
name|count
argument_list|,
name|s
operator|->
name|tm_mday
argument_list|,
name|s
operator|->
name|tm_mon
operator|+
literal|1
argument_list|,
name|s
operator|->
name|tm_hour
argument_list|,
name|s
operator|->
name|tm_min
argument_list|,
name|s
operator|->
name|tm_sec
argument_list|,
operator|(
name|u_int32_t
operator|)
name|hdr
operator|->
name|time
operator|.
name|tv_usec
argument_list|,
name|frm_len
argument_list|)
expr_stmt|;
block|}
block|}
for|for
control|(
name|i
operator|=
name|strlen
argument_list|(
name|hbuf
argument_list|)
init|;
name|i
operator|<=
name|NCOLS
condition|;
control|)
name|hbuf
index|[
name|i
operator|++
index|]
operator|=
literal|'-'
expr_stmt|;
name|hbuf
index|[
name|i
operator|++
index|]
operator|=
literal|'\n'
expr_stmt|;
name|hbuf
index|[
name|i
index|]
operator|=
literal|'\0'
expr_stmt|;
return|return
operator|(
name|hbuf
operator|)
return|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	decode protocol and output to file(s)  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|dumpbuf
parameter_list|(
name|int
name|n
parameter_list|,
name|unsigned
name|char
modifier|*
name|buf
parameter_list|,
name|i4b_trace_hdr_t
modifier|*
name|hdr
parameter_list|)
block|{
specifier|static
name|char
name|l1buf
index|[
literal|128
index|]
decl_stmt|;
specifier|static
name|unsigned
name|char
name|l2buf
index|[
literal|32000
index|]
decl_stmt|;
specifier|static
name|unsigned
name|char
name|l3buf
index|[
literal|32000
index|]
decl_stmt|;
name|int
name|cnt
decl_stmt|;
name|int
name|nsave
init|=
name|n
decl_stmt|;
name|char
modifier|*
name|pbuf
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|l1buf
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|l2buf
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|l3buf
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
switch|switch
condition|(
name|hdr
operator|->
name|type
condition|)
block|{
case|case
name|TRC_CH_I
case|:
comment|/* Layer 1 INFO's */
if|if
condition|(
name|enable_trace
operator|&
name|TRACE_I
condition|)
name|layer1
argument_list|(
name|l1buf
argument_list|,
name|buf
argument_list|)
expr_stmt|;
break|break;
case|case
name|TRC_CH_D
case|:
comment|/* D-channel data */
name|cnt
operator|=
name|layer2
argument_list|(
name|l2buf
argument_list|,
name|buf
argument_list|,
name|hdr
operator|->
name|dir
argument_list|,
name|print_q921
argument_list|)
expr_stmt|;
if|if
condition|(
name|print_q921
operator|==
literal|0
condition|)
name|l2buf
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|n
operator|-=
name|cnt
expr_stmt|;
name|buf
operator|+=
name|cnt
expr_stmt|;
if|if
condition|(
name|n
condition|)
block|{
if|if
condition|(
operator|(
operator|*
name|buf
operator|!=
literal|0x08
operator|)
operator|&&
operator|(
name|xflag
operator|==
literal|0
operator|)
condition|)
block|{
name|l2buf
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|l3buf
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
break|break;
block|}
name|layer3
argument_list|(
name|l3buf
argument_list|,
name|n
argument_list|,
name|cnt
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
comment|/* B-channel data */
name|pbuf
operator|=
operator|&
name|l2buf
index|[
literal|0
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|+=
literal|16
control|)
block|{
name|sprintf
argument_list|(
operator|(
name|pbuf
operator|+
name|strlen
argument_list|(
name|pbuf
argument_list|)
operator|)
argument_list|,
literal|"B%d:%.3x  "
argument_list|,
name|hdr
operator|->
name|type
argument_list|,
name|i
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|16
condition|;
name|j
operator|++
control|)
if|if
condition|(
name|i
operator|+
name|j
operator|<
name|n
condition|)
name|sprintf
argument_list|(
operator|(
name|pbuf
operator|+
name|strlen
argument_list|(
name|pbuf
argument_list|)
operator|)
argument_list|,
literal|"%02x "
argument_list|,
name|buf
index|[
name|i
operator|+
name|j
index|]
argument_list|)
expr_stmt|;
else|else
name|sprintf
argument_list|(
operator|(
name|pbuf
operator|+
name|strlen
argument_list|(
name|pbuf
argument_list|)
operator|)
argument_list|,
literal|"   "
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
operator|(
name|pbuf
operator|+
name|strlen
argument_list|(
name|pbuf
argument_list|)
operator|)
argument_list|,
literal|"      "
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|16
operator|&&
name|i
operator|+
name|j
operator|<
name|n
condition|;
name|j
operator|++
control|)
if|if
condition|(
name|isprint
argument_list|(
name|buf
index|[
name|i
operator|+
name|j
index|]
argument_list|)
condition|)
name|sprintf
argument_list|(
operator|(
name|pbuf
operator|+
name|strlen
argument_list|(
name|pbuf
argument_list|)
operator|)
argument_list|,
literal|"%c"
argument_list|,
name|buf
index|[
name|i
operator|+
name|j
index|]
argument_list|)
expr_stmt|;
else|else
name|sprintf
argument_list|(
operator|(
name|pbuf
operator|+
name|strlen
argument_list|(
name|pbuf
argument_list|)
operator|)
argument_list|,
literal|"."
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
operator|(
name|pbuf
operator|+
name|strlen
argument_list|(
name|pbuf
argument_list|)
operator|)
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
if|if
condition|(
name|header
operator|&&
operator|(
operator|(
name|l1buf
index|[
literal|0
index|]
operator|!=
literal|'\0'
operator|||
name|l2buf
index|[
literal|0
index|]
operator|!=
literal|'\0'
operator|)
operator|||
operator|(
name|l3buf
index|[
literal|0
index|]
operator|!=
literal|0
operator|)
operator|)
condition|)
block|{
name|char
modifier|*
name|p
decl_stmt|;
name|p
operator|=
name|fmt_hdr
argument_list|(
name|hdr
argument_list|,
name|nsave
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|outflag
condition|)
name|fprintf
argument_list|(
name|Fout
argument_list|,
literal|"%s"
argument_list|,
name|p
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|l1buf
index|[
literal|0
index|]
operator|!=
literal|'\0'
condition|)
block|{
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|l1buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|outflag
condition|)
name|fprintf
argument_list|(
name|Fout
argument_list|,
literal|"%s"
argument_list|,
name|l1buf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|l2buf
index|[
literal|0
index|]
operator|!=
literal|'\0'
condition|)
block|{
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|l2buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|outflag
condition|)
name|fprintf
argument_list|(
name|Fout
argument_list|,
literal|"%s"
argument_list|,
name|l2buf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|l3buf
index|[
literal|0
index|]
operator|!=
literal|'\0'
condition|)
block|{
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|l3buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|outflag
condition|)
name|fprintf
argument_list|(
name|Fout
argument_list|,
literal|"%s"
argument_list|,
name|l3buf
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	exit handler function to be called at program exit  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|exit_hdl
parameter_list|()
block|{
if|if
condition|(
name|traceon
condition|)
name|switch_driver
argument_list|(
name|TRACE_OFF
argument_list|,
name|Rx
argument_list|,
name|Tx
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	switch driver debugging output on/off  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|int
name|switch_driver
parameter_list|(
name|int
name|value
parameter_list|,
name|int
name|rx
parameter_list|,
name|int
name|tx
parameter_list|)
block|{
name|char
name|buffer
index|[
literal|80
index|]
decl_stmt|;
name|int
name|v
init|=
name|value
decl_stmt|;
if|if
condition|(
name|analyze
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|ioctl
argument_list|(
name|f
argument_list|,
name|I4B_TRC_SET
argument_list|,
operator|&
name|v
argument_list|)
operator|<
literal|0
condition|)
block|{
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"Error ioctl I4B_TRC_SET, val = %d"
argument_list|,
name|v
argument_list|)
expr_stmt|;
name|perror
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|value
operator|==
name|TRACE_OFF
condition|)
block|{
if|if
condition|(
name|ioctl
argument_list|(
name|f
argument_list|,
name|I4B_TRC_RESETA
argument_list|,
operator|&
name|v
argument_list|)
operator|<
literal|0
condition|)
block|{
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"Error ioctl I4B_TRC_RESETA - "
argument_list|)
expr_stmt|;
name|perror
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
else|else
block|{
name|i4b_trace_setupa_t
name|tsa
decl_stmt|;
name|tsa
operator|.
name|rxunit
operator|=
name|rx
expr_stmt|;
name|tsa
operator|.
name|rxflags
operator|=
name|value
expr_stmt|;
name|tsa
operator|.
name|txunit
operator|=
name|tx
expr_stmt|;
name|tsa
operator|.
name|txflags
operator|=
name|value
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|f
argument_list|,
name|I4B_TRC_SETA
argument_list|,
operator|&
name|tsa
argument_list|)
operator|<
literal|0
condition|)
block|{
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"Error ioctl I4B_TRC_SETA, val = %d"
argument_list|,
name|v
argument_list|)
expr_stmt|;
name|perror
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	reopen files to support rotating logfile(s) on SIGUSR1  *  *	based on an idea from Ripley (ripley@nostromo.in-berlin.de)  *  *	close file and reopen it for append. this will be a nop  *	if the previously opened file hasn't moved but will open  *	a new one otherwise, thus enabling a rotation...  *   *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|reopenfiles
parameter_list|(
name|int
name|dummy
parameter_list|)
block|{
if|if
condition|(
name|outflag
condition|)
block|{
name|fclose
argument_list|(
name|Fout
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|Fout
operator|=
name|fopen
argument_list|(
name|outfilename
argument_list|,
literal|"a"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|char
name|buffer
index|[
literal|80
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"Error re-opening file [%s]"
argument_list|,
name|outfilename
argument_list|)
expr_stmt|;
name|perror
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|setvbuf
argument_list|(
name|Fout
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|,
name|_IONBF
argument_list|,
literal|0
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|char
name|buffer
index|[
literal|80
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"Error re-setting file [%s] to unbuffered"
argument_list|,
name|outfilename
argument_list|)
expr_stmt|;
name|perror
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|Bopt
condition|)
block|{
name|fclose
argument_list|(
name|BP
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|BP
operator|=
name|fopen
argument_list|(
name|BPfilename
argument_list|,
literal|"a"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|char
name|buffer
index|[
literal|80
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"Error re-opening file [%s]"
argument_list|,
name|BPfilename
argument_list|)
expr_stmt|;
name|perror
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|setvbuf
argument_list|(
name|BP
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|,
name|_IONBF
argument_list|,
literal|0
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|char
name|buffer
index|[
literal|80
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"Error re-setting file [%s] to unbuffered"
argument_list|,
name|BPfilename
argument_list|)
expr_stmt|;
name|perror
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	decode extension bit  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|extension
parameter_list|(
name|int
name|layer
parameter_list|,
name|char
modifier|*
name|buffer
parameter_list|,
name|int
name|cnt
parameter_list|,
name|unsigned
name|char
name|value
parameter_list|,
name|unsigned
name|char
name|mask
parameter_list|)
block|{
name|sprintline
argument_list|(
name|layer
argument_list|,
name|buffer
argument_list|,
name|cnt
argument_list|,
name|value
argument_list|,
name|mask
argument_list|,
literal|"Extension Bit = %c (%s)"
argument_list|,
operator|(
name|value
operator|&
name|mask
operator|)
condition|?
literal|'1'
else|:
literal|'0'
argument_list|,
operator|(
name|value
operator|&
name|mask
operator|)
condition|?
literal|"no extension, final octet"
else|:
literal|"with extension, octet follows"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	print bits as 0/1 available for mask  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|char
modifier|*
name|print_bits
parameter_list|(
name|unsigned
name|char
name|val
parameter_list|,
name|unsigned
name|char
name|mask
parameter_list|)
block|{
specifier|static
name|char
name|buffer
index|[
literal|10
index|]
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
name|int
name|length
init|=
literal|8
decl_stmt|;
while|while
condition|(
name|length
operator|--
condition|)
block|{
if|if
condition|(
name|mask
operator|&
literal|0x80
condition|)
block|{
if|if
condition|(
name|val
operator|&
literal|0x80
condition|)
name|buffer
index|[
name|i
operator|++
index|]
operator|=
literal|'1'
expr_stmt|;
else|else
name|buffer
index|[
name|i
operator|++
index|]
operator|=
literal|'0'
expr_stmt|;
block|}
else|else
block|{
name|buffer
index|[
name|i
operator|++
index|]
operator|=
literal|'-'
expr_stmt|;
block|}
name|val
operator|=
name|val
operator|<<
literal|1
expr_stmt|;
name|mask
operator|=
name|mask
operator|<<
literal|1
expr_stmt|;
block|}
name|buffer
index|[
name|i
index|]
operator|=
literal|'\0'
expr_stmt|;
return|return
operator|(
name|buffer
operator|)
return|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	print one decoded output line  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|sprintline
parameter_list|(
name|int
name|layer
parameter_list|,
name|char
modifier|*
name|buffer
parameter_list|,
name|int
name|oct_count
parameter_list|,
name|int
name|oct_val
parameter_list|,
name|int
name|oct_mask
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|char
name|lbuffer
index|[
literal|256
index|]
decl_stmt|;
specifier|static
name|int
name|lastcount
init|=
operator|-
literal|1
decl_stmt|;
name|char
modifier|*
name|ptr
decl_stmt|;
name|va_list
name|ap
decl_stmt|;
name|va_start
argument_list|(
name|ap
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
if|if
condition|(
name|oct_count
operator|!=
name|lastcount
condition|)
block|{
name|lastcount
operator|=
name|oct_count
expr_stmt|;
name|sprintf
argument_list|(
name|lbuffer
argument_list|,
literal|"L%d %2d %02X %s "
argument_list|,
name|layer
argument_list|,
name|oct_count
argument_list|,
name|oct_val
argument_list|,
name|print_bits
argument_list|(
name|oct_val
argument_list|,
name|oct_mask
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|sprintf
argument_list|(
name|lbuffer
argument_list|,
literal|"         %s "
argument_list|,
name|print_bits
argument_list|(
name|oct_val
argument_list|,
name|oct_mask
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|vsprintf
argument_list|(
name|lbuffer
operator|+
name|strlen
argument_list|(
name|lbuffer
argument_list|)
argument_list|,
name|fmt
argument_list|,
name|ap
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|lbuffer
operator|+
name|strlen
argument_list|(
name|lbuffer
argument_list|)
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ptr
operator|=
name|rindex
argument_list|(
name|lbuffer
argument_list|,
literal|'('
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|char
modifier|*
name|s
init|=
name|lbuffer
decl_stmt|;
name|char
modifier|*
name|b
init|=
name|buffer
decl_stmt|;
name|int
name|len
init|=
name|strlen
argument_list|(
name|lbuffer
argument_list|)
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|s
operator|=
name|lbuffer
init|;
name|s
operator|<
name|ptr
condition|;
operator|*
name|b
operator|++
operator|=
operator|*
name|s
operator|++
control|)
empty_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|(
name|i
operator|+
name|len
operator|)
operator|<=
name|NCOLS
condition|;
operator|*
name|b
operator|++
operator|=
literal|' '
operator|,
name|i
operator|++
control|)
empty_stmt|;
for|for
control|(
init|;
operator|*
name|s
condition|;
operator|*
name|b
operator|++
operator|=
operator|*
name|s
operator|++
control|)
empty_stmt|;
operator|*
name|b
operator|=
literal|'\0'
expr_stmt|;
block|}
else|else
block|{
name|strcpy
argument_list|(
name|buffer
argument_list|,
name|lbuffer
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* EOF */
end_comment

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * The new sysinstall program.  *  * This is probably the last attempt in the `sysinstall' line, the next  * generation being slated to essentially a complete rewrite.  *  * $Id: network.c,v 1.29 1997/02/22 14:12:12 peter Exp $  *  * Copyright (c) 1995  *	Jordan Hubbard.  All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer,  *    verbatim and that no modifications are made prior to this  *    point in the file.  *  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY JORDAN HUBBARD ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL JORDAN HUBBARD OR HIS PETS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, LIFE OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  */
end_comment

begin_comment
comment|/* These routines deal with getting things off of network media */
end_comment

begin_include
include|#
directive|include
file|"sysinstall.h"
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<sys/fcntl.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_decl_stmt
specifier|static
name|Boolean
name|networkInitialized
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|pid_t
name|startPPP
parameter_list|(
name|Device
modifier|*
name|devp
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|pid_t
name|pppPID
decl_stmt|;
end_decl_stmt

begin_function
name|Boolean
name|mediaInitNetwork
parameter_list|(
name|Device
modifier|*
name|dev
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|char
modifier|*
name|rp
decl_stmt|;
name|char
modifier|*
name|cp
decl_stmt|,
name|ifconfig
index|[
literal|255
index|]
decl_stmt|;
if|if
condition|(
operator|!
name|RunningAsInit
operator|||
name|networkInitialized
condition|)
return|return
name|TRUE
return|;
name|msgDebug
argument_list|(
literal|"Init routine called for network device %s.\n"
argument_list|,
name|dev
operator|->
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|file_readable
argument_list|(
literal|"/etc/resolv.conf"
argument_list|)
condition|)
name|configResolv
argument_list|()
expr_stmt|;
comment|/* Old PPP process lying around? */
if|if
condition|(
name|pppPID
condition|)
block|{
name|msgNotify
argument_list|(
literal|"Killing previous PPP process %d."
argument_list|,
name|pppPID
argument_list|)
expr_stmt|;
name|kill
argument_list|(
name|pppPID
argument_list|,
name|SIGTERM
argument_list|)
expr_stmt|;
name|pppPID
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|strncmp
argument_list|(
literal|"ppp"
argument_list|,
name|dev
operator|->
name|name
argument_list|,
literal|3
argument_list|)
condition|)
block|{
comment|/* PPP? */
if|if
condition|(
operator|!
operator|(
name|pppPID
operator|=
name|startPPP
argument_list|(
name|dev
argument_list|)
operator|)
condition|)
block|{
name|msgConfirm
argument_list|(
literal|"Unable to start PPP!  This installation method cannot be used."
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
name|networkInitialized
operator|=
name|TRUE
expr_stmt|;
return|return
name|TRUE
return|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strncmp
argument_list|(
literal|"sl"
argument_list|,
name|dev
operator|->
name|name
argument_list|,
literal|2
argument_list|)
condition|)
block|{
comment|/* SLIP? */
name|char
modifier|*
name|val
decl_stmt|;
name|char
name|attach
index|[
literal|256
index|]
decl_stmt|;
name|dialog_clear_norefresh
argument_list|()
expr_stmt|;
comment|/* Cheesy slip attach */
name|snprintf
argument_list|(
name|attach
argument_list|,
literal|256
argument_list|,
literal|"slattach -a -h -l -s 9600 %s"
argument_list|,
name|dev
operator|->
name|devname
argument_list|)
expr_stmt|;
name|val
operator|=
name|msgGetInput
argument_list|(
name|attach
argument_list|,
literal|"Warning:  SLIP is rather poorly supported in this revision\n"
literal|"of the installation due to the lack of a dialing utility.\n"
literal|"If you can use PPP for this instead then you're much better\n"
literal|"off doing so, otherwise SLIP works fairly well for *hardwired*\n"
literal|"links.  Please edit the following slattach command for\n"
literal|"correctness (default here is: VJ compression, Hardware flow-\n"
literal|"control, ignore carrier and 9600 baud data rate).  When you're\n"
literal|"ready, press [ENTER] to execute it."
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|val
condition|)
block|{
name|msgConfirm
argument_list|(
literal|"slattach command was empty.  Try again!"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
else|else
name|SAFE_STRCPY
argument_list|(
name|attach
argument_list|,
name|val
argument_list|)
expr_stmt|;
comment|/* 	 * Doing this with vsystem() is actually bogus since we should be storing the pid of slattach 	 * for later killing.  It's just too convenient to call vsystem(), however, rather than 	 * constructing a proper argument for exec() so we punt on doing slip right for now. 	 */
if|if
condition|(
name|vsystem
argument_list|(
name|attach
argument_list|)
condition|)
block|{
name|msgConfirm
argument_list|(
literal|"slattach returned a bad status!  Please verify that\n"
literal|"the command is correct and try this operation again."
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
block|}
name|snprintf
argument_list|(
name|ifconfig
argument_list|,
literal|255
argument_list|,
literal|"%s%s"
argument_list|,
name|VAR_IFCONFIG
argument_list|,
name|dev
operator|->
name|name
argument_list|)
expr_stmt|;
name|cp
operator|=
name|variable_get
argument_list|(
name|ifconfig
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cp
condition|)
block|{
name|msgConfirm
argument_list|(
literal|"The %s device is not configured.  You will need to do so\n"
literal|"in the Networking configuration menu before proceeding."
argument_list|,
name|dev
operator|->
name|name
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
name|msgNotify
argument_list|(
literal|"ifconfig %s %s"
argument_list|,
name|dev
operator|->
name|name
argument_list|,
name|cp
argument_list|)
expr_stmt|;
name|i
operator|=
name|vsystem
argument_list|(
literal|"ifconfig %s %s"
argument_list|,
name|dev
operator|->
name|name
argument_list|,
name|cp
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
condition|)
block|{
name|msgConfirm
argument_list|(
literal|"Unable to configure the %s interface!\n"
literal|"This installation method cannot be used."
argument_list|,
name|dev
operator|->
name|name
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
name|rp
operator|=
name|variable_get
argument_list|(
name|VAR_GATEWAY
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rp
operator|||
operator|*
name|rp
operator|==
literal|'0'
condition|)
block|{
name|msgConfirm
argument_list|(
literal|"No gateway has been set. You may be unable to access hosts\n"
literal|"not on your local network"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|msgNotify
argument_list|(
literal|"Adding default route to %s."
argument_list|,
name|rp
argument_list|)
expr_stmt|;
name|vsystem
argument_list|(
literal|"route add default %s"
argument_list|,
name|rp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|isDebug
argument_list|()
condition|)
name|msgDebug
argument_list|(
literal|"Network initialized successfully.\n"
argument_list|)
expr_stmt|;
name|networkInitialized
operator|=
name|TRUE
expr_stmt|;
return|return
name|TRUE
return|;
block|}
end_function

begin_function
name|void
name|mediaShutdownNetwork
parameter_list|(
name|Device
modifier|*
name|dev
parameter_list|)
block|{
name|char
modifier|*
name|cp
decl_stmt|;
if|if
condition|(
operator|!
name|RunningAsInit
operator|||
operator|!
name|networkInitialized
condition|)
return|return;
name|msgDebug
argument_list|(
literal|"Shutdown called for network device %s\n"
argument_list|,
name|dev
operator|->
name|name
argument_list|)
expr_stmt|;
comment|/* Not a serial device? */
if|if
condition|(
name|strncmp
argument_list|(
literal|"sl"
argument_list|,
name|dev
operator|->
name|name
argument_list|,
literal|2
argument_list|)
operator|&&
name|strncmp
argument_list|(
literal|"ppp"
argument_list|,
name|dev
operator|->
name|name
argument_list|,
literal|3
argument_list|)
condition|)
block|{
name|int
name|i
decl_stmt|;
name|char
name|ifconfig
index|[
literal|255
index|]
decl_stmt|;
name|snprintf
argument_list|(
name|ifconfig
argument_list|,
literal|255
argument_list|,
literal|"%s%s"
argument_list|,
name|VAR_IFCONFIG
argument_list|,
name|dev
operator|->
name|name
argument_list|)
expr_stmt|;
name|cp
operator|=
name|variable_get
argument_list|(
name|ifconfig
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cp
condition|)
return|return;
name|msgNotify
argument_list|(
literal|"ifconfig %s down"
argument_list|,
name|dev
operator|->
name|name
argument_list|)
expr_stmt|;
name|i
operator|=
name|vsystem
argument_list|(
literal|"ifconfig %s down"
argument_list|,
name|dev
operator|->
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
condition|)
name|msgConfirm
argument_list|(
literal|"Warning: Unable to down the %s interface properly"
argument_list|,
name|dev
operator|->
name|name
argument_list|)
expr_stmt|;
name|cp
operator|=
name|variable_get
argument_list|(
name|VAR_GATEWAY
argument_list|)
expr_stmt|;
if|if
condition|(
name|cp
condition|)
block|{
name|msgNotify
argument_list|(
literal|"Deleting default route."
argument_list|)
expr_stmt|;
name|vsystem
argument_list|(
literal|"route delete default"
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|pppPID
condition|)
block|{
name|msgNotify
argument_list|(
literal|"Killing previous PPP process %d."
argument_list|,
name|pppPID
argument_list|)
expr_stmt|;
name|kill
argument_list|(
name|pppPID
argument_list|,
name|SIGTERM
argument_list|)
expr_stmt|;
name|pppPID
operator|=
literal|0
expr_stmt|;
block|}
name|networkInitialized
operator|=
name|FALSE
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Start PPP on the 3rd screen */
end_comment

begin_function
specifier|static
name|pid_t
name|startPPP
parameter_list|(
name|Device
modifier|*
name|devp
parameter_list|)
block|{
name|int
name|fd2
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
name|char
modifier|*
name|val
decl_stmt|;
name|pid_t
name|pid
init|=
literal|0
decl_stmt|;
name|char
name|myaddr
index|[
literal|16
index|]
decl_stmt|,
name|provider
index|[
literal|16
index|]
decl_stmt|,
name|speed
index|[
literal|16
index|]
decl_stmt|;
comment|/* These are needed to make ppp work */
name|Mkdir
argument_list|(
literal|"/var/log"
argument_list|)
expr_stmt|;
name|Mkdir
argument_list|(
literal|"/var/run"
argument_list|)
expr_stmt|;
name|Mkdir
argument_list|(
literal|"/var/spool/lock"
argument_list|)
expr_stmt|;
name|Mkdir
argument_list|(
literal|"/etc/ppp"
argument_list|)
expr_stmt|;
name|dialog_clear_norefresh
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|variable_get
argument_list|(
name|VAR_SERIAL_SPEED
argument_list|)
condition|)
name|variable_set2
argument_list|(
name|VAR_SERIAL_SPEED
argument_list|,
literal|"115200"
argument_list|)
expr_stmt|;
comment|/* Get any important user values */
name|val
operator|=
name|variable_get_value
argument_list|(
name|VAR_SERIAL_SPEED
argument_list|,
literal|"Enter the baud rate for your modem - this can be higher than the actual\n"
literal|"maximum data rate since most modems can talk at one speed to the\n"
literal|"computer and at another speed to the remote end.\n\n"
literal|"If you're not sure what to put here, just select the default."
argument_list|)
expr_stmt|;
name|SAFE_STRCPY
argument_list|(
name|speed
argument_list|,
operator|(
name|val
operator|&&
operator|*
name|val
operator|)
condition|?
name|val
else|:
literal|"115200"
argument_list|)
expr_stmt|;
name|val
operator|=
name|variable_get
argument_list|(
name|VAR_GATEWAY
argument_list|)
expr_stmt|;
name|SAFE_STRCPY
argument_list|(
name|provider
argument_list|,
operator|(
name|val
operator|&&
operator|*
name|val
operator|)
condition|?
name|val
else|:
literal|"0"
argument_list|)
expr_stmt|;
name|dialog_clear_norefresh
argument_list|()
expr_stmt|;
name|val
operator|=
name|msgGetInput
argument_list|(
name|provider
argument_list|,
literal|"Enter the IP address of your service provider or 0 if you\n"
literal|"don't know it and would prefer to negotiate it dynamically."
argument_list|)
expr_stmt|;
name|SAFE_STRCPY
argument_list|(
name|provider
argument_list|,
operator|(
name|val
operator|&&
operator|*
name|val
operator|)
condition|?
name|val
else|:
literal|"0"
argument_list|)
expr_stmt|;
if|if
condition|(
name|devp
operator|->
name|private
operator|&&
operator|(
operator|(
name|DevInfo
operator|*
operator|)
name|devp
operator|->
name|private
operator|)
operator|->
name|ipaddr
index|[
literal|0
index|]
condition|)
name|SAFE_STRCPY
argument_list|(
name|myaddr
argument_list|,
operator|(
operator|(
name|DevInfo
operator|*
operator|)
name|devp
operator|->
name|private
operator|)
operator|->
name|ipaddr
argument_list|)
expr_stmt|;
else|else
name|strcpy
argument_list|(
name|myaddr
argument_list|,
literal|"0"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|Fake
condition|)
name|fp
operator|=
name|fopen
argument_list|(
literal|"/etc/ppp/ppp.linkup"
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
else|else
name|fp
operator|=
name|fopen
argument_list|(
literal|"/dev/stderr"
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|!=
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"MYADDR:\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|" delete ALL\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|" add 0 0 HISADDR\n"
argument_list|)
expr_stmt|;
name|fchmod
argument_list|(
name|fileno
argument_list|(
name|fp
argument_list|)
argument_list|,
literal|0755
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|Fake
condition|)
name|fd2
operator|=
name|open
argument_list|(
literal|"/etc/ppp/ppp.secret"
argument_list|,
name|O_CREAT
argument_list|)
expr_stmt|;
else|else
name|fd2
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|fd2
operator|!=
operator|-
literal|1
condition|)
block|{
name|fchmod
argument_list|(
name|fd2
argument_list|,
literal|0700
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|Fake
condition|)
name|fp
operator|=
name|fopen
argument_list|(
literal|"/etc/ppp/ppp.conf"
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
else|else
name|fp
operator|=
name|fopen
argument_list|(
literal|"/dev/stderr"
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|fp
condition|)
block|{
name|msgConfirm
argument_list|(
literal|"Couldn't open /etc/ppp/ppp.conf file!  This isn't going to work"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"default:\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|" set speed %s\n"
argument_list|,
name|speed
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|" set device %s\n"
argument_list|,
name|devp
operator|->
name|devname
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|" set ifaddr %s %s\n"
argument_list|,
name|myaddr
argument_list|,
name|provider
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|" set timeout 0\n"
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|Fake
operator|&&
operator|!
name|file_readable
argument_list|(
literal|"/dev/tun0"
argument_list|)
operator|&&
name|mknod
argument_list|(
literal|"/dev/tun0"
argument_list|,
literal|0600
operator||
name|S_IFCHR
argument_list|,
name|makedev
argument_list|(
literal|52
argument_list|,
literal|0
argument_list|)
argument_list|)
condition|)
block|{
name|msgConfirm
argument_list|(
literal|"Warning:  No /dev/tun0 device.  PPP will not work!"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|isDebug
argument_list|()
condition|)
name|msgDebug
argument_list|(
literal|"About to start PPP on device %s @ %s baud.  Provider = %s\n"
argument_list|,
name|devp
operator|->
name|devname
argument_list|,
name|speed
argument_list|,
name|provider
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|Fake
operator|&&
operator|!
operator|(
name|pid
operator|=
name|fork
argument_list|()
operator|)
condition|)
block|{
name|int
name|i
decl_stmt|,
name|fd
decl_stmt|;
name|struct
name|termios
name|foo
decl_stmt|;
specifier|extern
name|int
name|login_tty
argument_list|(
name|int
argument_list|)
decl_stmt|;
for|for
control|(
name|i
operator|=
name|getdtablesize
argument_list|()
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
name|close
argument_list|(
name|i
argument_list|)
expr_stmt|;
comment|/* We're going over to VTY2 */
name|fd
operator|=
name|open
argument_list|(
literal|"/dev/ttyv2"
argument_list|,
name|O_RDWR
argument_list|)
expr_stmt|;
name|ioctl
argument_list|(
literal|0
argument_list|,
name|TIOCSCTTY
argument_list|,
operator|&
name|fd
argument_list|)
expr_stmt|;
name|dup2
argument_list|(
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|dup2
argument_list|(
literal|0
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|DebugFD
operator|=
literal|2
expr_stmt|;
if|if
condition|(
name|login_tty
argument_list|(
name|fd
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|msgDebug
argument_list|(
literal|"ppp: Can't set the controlling terminal.\n"
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGTTOU
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
if|if
condition|(
name|tcgetattr
argument_list|(
name|fd
argument_list|,
operator|&
name|foo
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
name|foo
operator|.
name|c_cc
index|[
name|VERASE
index|]
operator|=
literal|'\010'
expr_stmt|;
if|if
condition|(
name|tcsetattr
argument_list|(
name|fd
argument_list|,
name|TCSANOW
argument_list|,
operator|&
name|foo
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|msgDebug
argument_list|(
literal|"ppp: Unable to set the erase character.\n"
argument_list|)
expr_stmt|;
block|}
else|else
name|msgDebug
argument_list|(
literal|"ppp: Unable to get the terminal attributes!\n"
argument_list|)
expr_stmt|;
name|execlp
argument_list|(
literal|"ppp"
argument_list|,
literal|"ppp"
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
name|msgDebug
argument_list|(
literal|"PPP process failed to exec!\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|dialog_clear_norefresh
argument_list|()
expr_stmt|;
name|msgConfirm
argument_list|(
literal|"NOTICE: The PPP command is now started on VTY3 (type ALT-F3 to\n"
literal|"interact with it, ALT-F1 to switch back here). The only command\n"
literal|"you'll probably want or need to use is the \"term\" command\n"
literal|"which starts a terminal emulator you can use to talk to your\n"
literal|"modem and dial the service provider.  Once you're connected,\n"
literal|"come back to this screen and press return.\n\n"
literal|"DO NOT PRESS [ENTER] HERE UNTIL THE CONNECTION IS FULLY\n"
literal|"ESTABLISHED!"
argument_list|)
expr_stmt|;
block|}
return|return
name|pid
return|;
block|}
end_function

end_unit


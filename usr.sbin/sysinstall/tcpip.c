begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * $Id: tcpip.c,v 1.12 1995/05/24 01:27:15 jkh Exp $  *  * Copyright (c) 1995  *      Gary J Palmer. All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer,   *    verbatim and that no modifications are made prior to this   *    point in the file.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. All advertising materials mentioning features or use of this software  *    must display the following acknowledgement:  *      This product includes software developed by Gary J Palmer  *	for the FreeBSD Project.  * 4. The name of Gary J Palmer or the FreeBSD Project may  *    not be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY GARY J PALMER ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL GARY J PALMER BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,  * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS  * OF USE, DATA, LIFE OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED  * AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR  * TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  *  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<dialog.h>
end_include

begin_include
include|#
directive|include
file|"ui_objects.h"
end_include

begin_include
include|#
directive|include
file|"dir.h"
end_include

begin_include
include|#
directive|include
file|"dialog.priv.h"
end_include

begin_include
include|#
directive|include
file|"colors.h"
end_include

begin_include
include|#
directive|include
file|"rc.h"
end_include

begin_include
include|#
directive|include
file|"sysinstall.h"
end_include

begin_comment
comment|/* These are nasty, but they make the layout structure a lot easier ... */
end_comment

begin_decl_stmt
specifier|static
name|char
name|hostname
index|[
literal|256
index|]
decl_stmt|,
name|domainname
index|[
literal|256
index|]
decl_stmt|,
name|gateway
index|[
literal|32
index|]
decl_stmt|,
name|nameserver
index|[
literal|32
index|]
decl_stmt|,
name|iface
index|[
literal|8
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|okbutton
decl_stmt|,
name|cancelbutton
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|ipaddr
index|[
literal|32
index|]
decl_stmt|,
name|netmask
index|[
literal|32
index|]
decl_stmt|,
name|extras
index|[
literal|256
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* What the screen size is meant to be */
end_comment

begin_define
define|#
directive|define
name|TCP_DIALOG_Y
value|0
end_define

begin_define
define|#
directive|define
name|TCP_DIALOG_X
value|8
end_define

begin_define
define|#
directive|define
name|TCP_DIALOG_WIDTH
value|COLS - 16
end_define

begin_define
define|#
directive|define
name|TCP_DIALOG_HEIGHT
value|LINES - 2
end_define

begin_comment
comment|/* The per interface set of records */
end_comment

begin_typedef
typedef|typedef
struct|struct
name|_interface
block|{
name|char
name|ipaddr
index|[
literal|32
index|]
decl_stmt|;
name|char
name|netmask
index|[
literal|32
index|]
decl_stmt|;
name|char
name|extras
index|[
literal|256
index|]
decl_stmt|;
comment|/* Extra stuff for ifconfig (link0, etc) */
name|int
name|valid
decl_stmt|;
name|Device
modifier|*
name|dptr
decl_stmt|;
block|}
name|Interface
typedef|;
end_typedef

begin_comment
comment|/* The names and details of the available interfaces, for the list */
end_comment

begin_decl_stmt
name|Interface
name|if_list
index|[
name|INTERFACE_MAX
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|iface_names
index|[
name|INTERFACE_MAX
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* The screen layout structure */
end_comment

begin_typedef
typedef|typedef
struct|struct
name|_layout
block|{
name|int
name|y
decl_stmt|;
comment|/* x& Y co-ordinates */
name|int
name|x
decl_stmt|;
name|int
name|len
decl_stmt|;
comment|/* The size of the dialog on the screen */
name|int
name|maxlen
decl_stmt|;
comment|/* How much the user can type in ... */
name|char
modifier|*
name|prompt
decl_stmt|;
comment|/* The string for the prompt */
name|char
modifier|*
name|help
decl_stmt|;
comment|/* The display for the help line */
name|void
modifier|*
name|var
decl_stmt|;
comment|/* The var to set when this changes */
name|int
name|type
decl_stmt|;
comment|/* The type of the dialog to create */
name|void
modifier|*
name|obj
decl_stmt|;
comment|/* The obj pointer returned by libdialog */
block|}
name|Layout
typedef|;
end_typedef

begin_decl_stmt
specifier|static
name|Layout
name|layout
index|[]
init|=
block|{
block|{
literal|1
block|,
literal|2
block|,
literal|25
block|,
literal|255
block|,
literal|"Host name:"
block|,
literal|"The name of your machine on a network, e.g. foo.bar.com"
block|,
name|hostname
block|,
name|STRINGOBJ
block|,
name|NULL
block|}
block|,
define|#
directive|define
name|LAYOUT_HOSTNAME
value|0
block|{
literal|1
block|,
literal|35
block|,
literal|20
block|,
literal|255
block|,
literal|"Domain name:"
block|,
literal|"The name of the domain that your machine is in, e.g. bar.com"
block|,
name|domainname
block|,
name|STRINGOBJ
block|,
name|NULL
block|}
block|,
define|#
directive|define
name|LAYOUT_DOMAINNAME
value|1
block|{
literal|5
block|,
literal|2
block|,
literal|18
block|,
literal|15
block|,
literal|"Gateway:"
block|,
literal|"IP address of host forwarding packets to non-local hosts or nets"
block|,
name|gateway
block|,
name|STRINGOBJ
block|,
name|NULL
block|}
block|,
define|#
directive|define
name|LAYOUT_GATEWAY
value|2
block|{
literal|5
block|,
literal|35
block|,
literal|18
block|,
literal|15
block|,
literal|"Name server:"
block|,
literal|"IP address of your local DNS server"
block|,
name|nameserver
block|,
name|STRINGOBJ
block|,
name|NULL
block|}
block|,
define|#
directive|define
name|LAYOUT_NAMESERVER
value|3
block|{
literal|9
block|,
literal|2
block|,
literal|9
block|,
literal|6
block|,
literal|"Interface:"
block|,
literal|"Network devices found on boot (use<TAB> to exit from here)"
block|,
name|iface
block|,
name|LISTOBJ
block|,
name|NULL
block|}
block|,
define|#
directive|define
name|LAYOUT_IFACE
value|4
block|{
literal|10
block|,
literal|18
block|,
literal|18
block|,
literal|15
block|,
literal|"IP Address:"
block|,
literal|"The IP address to be used for this interface - use 127.0.0.1 for lo0"
block|,
name|ipaddr
block|,
name|STRINGOBJ
block|,
name|NULL
block|}
block|,
define|#
directive|define
name|LAYOUT_IPADDR
value|5
block|{
literal|10
block|,
literal|37
block|,
literal|18
block|,
literal|15
block|,
literal|"Netmask:"
block|,
literal|"The netmask for this interfaace, e.g. 0xffffff00 for a class C network"
block|,
name|netmask
block|,
name|STRINGOBJ
block|,
name|NULL
block|}
block|,
define|#
directive|define
name|LAYOUT_NETMASK
value|6
block|{
literal|14
block|,
literal|18
block|,
literal|37
block|,
literal|255
block|,
literal|"Extra options to ifconfig:"
block|,
literal|"Any interface-specific options to ifconfig you'd like to use"
block|,
name|extras
block|,
name|STRINGOBJ
block|,
name|NULL
block|}
block|,
define|#
directive|define
name|LAYOUT_EXTRAS
value|7
block|{
literal|19
block|,
literal|10
block|,
literal|0
block|,
literal|0
block|,
literal|"OK"
block|,
literal|"Select this if you are happy with these settings"
block|,
operator|&
name|okbutton
block|,
name|BUTTONOBJ
block|,
name|NULL
block|}
block|,
define|#
directive|define
name|LAYOUT_OKBUTTON
value|8
block|{
literal|19
block|,
literal|30
block|,
literal|0
block|,
literal|0
block|,
literal|"CANCEL"
block|,
literal|"Select this if you wish to cancel this screen"
block|,
operator|&
name|cancelbutton
block|,
name|BUTTONOBJ
block|,
name|NULL
block|}
block|,
define|#
directive|define
name|LAYOUT_CANCELBUTTON
value|9
block|{
name|NULL
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|_validByte
parameter_list|(
name|b
parameter_list|)
value|((b)> 0&& (b)< 255)
end_define

begin_comment
comment|/* A JKH special - inform the user of an unusal error in a controlled    fashion */
end_comment

begin_function
specifier|static
name|void
name|feepout
parameter_list|(
name|char
modifier|*
name|msg
parameter_list|)
block|{
name|beep
argument_list|()
expr_stmt|;
name|dialog_notify
argument_list|(
name|msg
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Very basic IP address integrity check - could be drastically improved */
end_comment

begin_function
specifier|static
name|int
name|verifyIP
parameter_list|(
name|char
modifier|*
name|ip
parameter_list|)
block|{
name|int
name|a
decl_stmt|,
name|b
decl_stmt|,
name|c
decl_stmt|,
name|d
decl_stmt|;
if|if
condition|(
name|ip
operator|&&
name|sscanf
argument_list|(
name|ip
argument_list|,
literal|"%d.%d.%d.%d"
argument_list|,
operator|&
name|a
argument_list|,
operator|&
name|b
argument_list|,
operator|&
name|c
argument_list|,
operator|&
name|d
argument_list|)
operator|==
literal|4
operator|&&
name|_validByte
argument_list|(
name|a
argument_list|)
operator|&&
name|_validByte
argument_list|(
name|b
argument_list|)
operator|&&
name|_validByte
argument_list|(
name|c
argument_list|)
operator|&&
name|_validByte
argument_list|(
name|d
argument_list|)
condition|)
return|return
literal|1
return|;
else|else
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Check for the settings on the screen - the per interface stuff is    moved to the main handling code now to do it on the fly - sigh */
end_comment

begin_function
specifier|static
name|int
name|verifySettings
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
operator|!
name|hostname
index|[
literal|0
index|]
condition|)
name|feepout
argument_list|(
literal|"Must specify a host name of some sort!"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|gateway
index|[
literal|0
index|]
operator|&&
operator|!
name|verifyIP
argument_list|(
name|gateway
argument_list|)
condition|)
name|feepout
argument_list|(
literal|"Invalid gateway IP address specified"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|nameserver
index|[
literal|0
index|]
operator|&&
operator|!
name|verifyIP
argument_list|(
name|nameserver
argument_list|)
condition|)
name|feepout
argument_list|(
literal|"Invalid name server IP address specified"
argument_list|)
expr_stmt|;
else|else
return|return
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* This is it - how to get TCP setup values */
end_comment

begin_function
name|int
name|tcpOpenDialog
parameter_list|(
name|char
modifier|*
name|str
parameter_list|)
block|{
name|WINDOW
modifier|*
name|ds_win
decl_stmt|;
name|ComposeObj
modifier|*
name|obj
init|=
name|NULL
decl_stmt|;
name|ComposeObj
modifier|*
name|first
decl_stmt|,
modifier|*
name|last
decl_stmt|;
name|int
name|n
init|=
literal|0
decl_stmt|,
name|quit
init|=
name|FALSE
decl_stmt|,
name|cancel
init|=
name|FALSE
decl_stmt|,
name|ret
decl_stmt|,
name|max
decl_stmt|,
name|n_iface
decl_stmt|;
name|char
modifier|*
name|tmp
decl_stmt|;
name|Device
modifier|*
modifier|*
name|devs
decl_stmt|;
name|char
name|old_iface
index|[
literal|8
index|]
decl_stmt|;
name|char
name|help
index|[
name|FILENAME_MAX
index|]
decl_stmt|;
comment|/* We need a curses window */
name|ds_win
operator|=
name|newwin
argument_list|(
name|LINES
argument_list|,
name|COLS
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ds_win
operator|==
literal|0
condition|)
name|msgFatal
argument_list|(
literal|"Cannot open TCP/IP dialog window!!"
argument_list|)
expr_stmt|;
comment|/* Look for net.devices for us to configure */
name|devs
operator|=
name|deviceFind
argument_list|(
name|NULL
argument_list|,
name|DEVICE_TYPE_NETWORK
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|devs
condition|)
block|{
name|msgConfirm
argument_list|(
literal|"Couldn't find any potential network devices!"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
while|while
condition|(
name|devs
index|[
name|n
index|]
operator|!=
name|NULL
condition|)
block|{
name|iface_names
index|[
name|n
index|]
operator|=
operator|(
name|devs
index|[
name|n
index|]
operator|)
operator|->
name|name
expr_stmt|;
name|if_list
index|[
name|n
index|]
operator|.
name|dptr
operator|=
name|devs
index|[
name|n
index|]
expr_stmt|;
operator|++
name|n
expr_stmt|;
block|}
name|n_iface
operator|=
name|n
expr_stmt|;
comment|/* Setup a nice screen for us to splat stuff onto */
name|systemHelpFile
argument_list|(
name|TCP_HELPFILE
argument_list|,
name|help
argument_list|)
expr_stmt|;
name|use_helpfile
argument_list|(
name|help
argument_list|)
expr_stmt|;
name|draw_box
argument_list|(
name|ds_win
argument_list|,
name|TCP_DIALOG_Y
argument_list|,
name|TCP_DIALOG_X
argument_list|,
name|TCP_DIALOG_HEIGHT
argument_list|,
name|TCP_DIALOG_WIDTH
argument_list|,
name|dialog_attr
argument_list|,
name|border_attr
argument_list|)
expr_stmt|;
name|wattrset
argument_list|(
name|ds_win
argument_list|,
name|dialog_attr
argument_list|)
expr_stmt|;
name|mvwaddstr
argument_list|(
name|ds_win
argument_list|,
name|TCP_DIALOG_Y
argument_list|,
name|TCP_DIALOG_X
operator|+
literal|20
argument_list|,
literal|" Network Configuration "
argument_list|)
expr_stmt|;
name|draw_box
argument_list|(
name|ds_win
argument_list|,
name|TCP_DIALOG_Y
operator|+
literal|9
argument_list|,
name|TCP_DIALOG_X
operator|+
literal|16
argument_list|,
name|TCP_DIALOG_HEIGHT
operator|-
literal|13
argument_list|,
name|TCP_DIALOG_WIDTH
operator|-
literal|21
argument_list|,
name|dialog_attr
argument_list|,
name|border_attr
argument_list|)
expr_stmt|;
name|wattrset
argument_list|(
name|ds_win
argument_list|,
name|dialog_attr
argument_list|)
expr_stmt|;
name|mvwaddstr
argument_list|(
name|ds_win
argument_list|,
name|TCP_DIALOG_Y
operator|+
literal|9
argument_list|,
name|TCP_DIALOG_X
operator|+
literal|24
argument_list|,
literal|" Per Interface Configuration "
argument_list|)
expr_stmt|;
comment|/* Initialise vars so that dialog has something to chew on */
name|strcpy
argument_list|(
name|ipaddr
argument_list|,
name|if_list
index|[
literal|0
index|]
operator|.
name|ipaddr
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|netmask
argument_list|,
name|if_list
index|[
literal|0
index|]
operator|.
name|netmask
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|extras
argument_list|,
name|if_list
index|[
literal|0
index|]
operator|.
name|extras
argument_list|)
expr_stmt|;
comment|/* Look up values already recorded with the system, or blank the        string variables ready to accept some new data */
name|tmp
operator|=
name|getenv
argument_list|(
name|VAR_HOSTNAME
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
condition|)
name|strcpy
argument_list|(
name|hostname
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
else|else
name|bzero
argument_list|(
name|hostname
argument_list|,
sizeof|sizeof
argument_list|(
name|hostname
argument_list|)
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|getenv
argument_list|(
name|VAR_DOMAINNAME
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
condition|)
name|strcpy
argument_list|(
name|domainname
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
else|else
name|bzero
argument_list|(
name|domainname
argument_list|,
sizeof|sizeof
argument_list|(
name|domainname
argument_list|)
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|getenv
argument_list|(
name|VAR_GATEWAY
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
condition|)
name|strcpy
argument_list|(
name|gateway
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
else|else
name|bzero
argument_list|(
name|gateway
argument_list|,
sizeof|sizeof
argument_list|(
name|gateway
argument_list|)
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|getenv
argument_list|(
name|VAR_NAMESERVER
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
condition|)
name|strcpy
argument_list|(
name|nameserver
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
else|else
name|bzero
argument_list|(
name|nameserver
argument_list|,
sizeof|sizeof
argument_list|(
name|nameserver
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Loop over the layout list, create the objects, and add them        onto the chain of objects that dialog uses for traversal*/
name|n
operator|=
literal|0
expr_stmt|;
define|#
directive|define
name|lt
value|layout[n]
while|while
condition|(
name|lt
operator|.
name|help
operator|!=
name|NULL
condition|)
block|{
switch|switch
condition|(
name|lt
operator|.
name|type
condition|)
block|{
case|case
name|STRINGOBJ
case|:
name|lt
operator|.
name|obj
operator|=
name|NewStringObj
argument_list|(
name|ds_win
argument_list|,
name|lt
operator|.
name|prompt
argument_list|,
name|lt
operator|.
name|var
argument_list|,
name|lt
operator|.
name|y
operator|+
name|TCP_DIALOG_Y
argument_list|,
name|lt
operator|.
name|x
operator|+
name|TCP_DIALOG_X
argument_list|,
name|lt
operator|.
name|len
argument_list|,
name|lt
operator|.
name|maxlen
argument_list|)
expr_stmt|;
break|break;
case|case
name|BUTTONOBJ
case|:
name|lt
operator|.
name|obj
operator|=
name|NewButtonObj
argument_list|(
name|ds_win
argument_list|,
name|lt
operator|.
name|prompt
argument_list|,
name|lt
operator|.
name|var
argument_list|,
name|lt
operator|.
name|y
operator|+
name|TCP_DIALOG_Y
argument_list|,
name|lt
operator|.
name|x
operator|+
name|TCP_DIALOG_X
argument_list|)
expr_stmt|;
break|break;
case|case
name|LISTOBJ
case|:
name|lt
operator|.
name|obj
operator|=
name|NewListObj
argument_list|(
name|ds_win
argument_list|,
name|lt
operator|.
name|prompt
argument_list|,
operator|(
name|char
operator|*
operator|*
operator|)
name|iface_names
argument_list|,
name|lt
operator|.
name|var
argument_list|,
name|lt
operator|.
name|y
operator|+
name|TCP_DIALOG_Y
argument_list|,
name|lt
operator|.
name|x
operator|+
name|TCP_DIALOG_X
argument_list|,
name|lt
operator|.
name|len
argument_list|,
literal|12
argument_list|,
name|n_iface
argument_list|)
expr_stmt|;
break|break;
default|default:
name|msgFatal
argument_list|(
literal|"Don't support this object yet!"
argument_list|)
expr_stmt|;
block|}
name|AddObj
argument_list|(
operator|&
name|obj
argument_list|,
name|lt
operator|.
name|type
argument_list|,
operator|(
name|void
operator|*
operator|)
name|lt
operator|.
name|obj
argument_list|)
expr_stmt|;
name|n
operator|++
expr_stmt|;
block|}
name|max
operator|=
name|n
operator|-
literal|1
expr_stmt|;
comment|/* Find the last object we can traverse to */
name|last
operator|=
name|obj
expr_stmt|;
while|while
condition|(
name|last
operator|->
name|next
condition|)
name|last
operator|=
name|last
operator|->
name|next
expr_stmt|;
comment|/* Find the first object in the list */
name|first
operator|=
name|obj
expr_stmt|;
while|while
condition|(
name|first
operator|->
name|prev
condition|)
name|first
operator|=
name|first
operator|->
name|prev
expr_stmt|;
comment|/* Some more initialisation before we go into the main input loop */
name|n
operator|=
literal|0
expr_stmt|;
name|cancelbutton
operator|=
name|okbutton
operator|=
literal|0
expr_stmt|;
name|strcpy
argument_list|(
name|iface
argument_list|,
name|iface_names
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|if_list
index|[
literal|0
index|]
operator|.
name|valid
operator|=
name|FALSE
expr_stmt|;
name|strcpy
argument_list|(
name|old_iface
argument_list|,
name|iface
argument_list|)
expr_stmt|;
comment|/* Incoming user data - DUCK! */
while|while
condition|(
operator|!
name|quit
condition|)
block|{
name|char
name|help_line
index|[
literal|80
index|]
decl_stmt|;
name|int
name|i
decl_stmt|,
name|len
init|=
name|strlen
argument_list|(
name|lt
operator|.
name|help
argument_list|)
decl_stmt|;
comment|/* Display the help line at the bottom of the screen */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|79
condition|;
name|i
operator|++
control|)
name|help_line
index|[
name|i
index|]
operator|=
operator|(
name|i
operator|<
name|len
operator|)
condition|?
name|lt
operator|.
name|help
index|[
name|i
index|]
else|:
literal|' '
expr_stmt|;
name|help_line
index|[
name|i
index|]
operator|=
literal|'\0'
expr_stmt|;
name|use_helpline
argument_list|(
name|help_line
argument_list|)
expr_stmt|;
name|display_helpline
argument_list|(
name|ds_win
argument_list|,
name|LINES
operator|-
literal|1
argument_list|,
name|COLS
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* Ask for libdialog to do its stuff */
name|ret
operator|=
name|PollObj
argument_list|(
operator|&
name|obj
argument_list|)
expr_stmt|;
comment|/* We are in the Hostname field - calculate the domainname */
if|if
condition|(
name|n
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|tmp
operator|=
name|index
argument_list|(
name|hostname
argument_list|,
literal|'.'
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|strncpy
argument_list|(
name|domainname
argument_list|,
name|tmp
operator|+
literal|1
argument_list|,
name|strlen
argument_list|(
name|tmp
operator|+
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|domainname
index|[
name|strlen
argument_list|(
name|tmp
operator|+
literal|1
argument_list|)
index|]
operator|=
literal|'\0'
expr_stmt|;
name|RefreshStringObj
argument_list|(
name|layout
index|[
literal|1
index|]
operator|.
name|obj
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Handle special case stuff that libdialog misses. Sigh */
switch|switch
condition|(
name|ret
condition|)
block|{
comment|/* Bail out */
case|case
name|SEL_ESC
case|:
name|quit
operator|=
name|TRUE
operator|,
name|cancel
operator|=
name|TRUE
expr_stmt|;
break|break;
comment|/* This doesn't work for list dialogs. Oh well. Perhaps 	       should special case the move from the OK button ``up'' 	       to make it go to the interface list, but then it gets 	       awkward for the user to go back and correct screw up's 	       in the per-interface section */
case|case
name|KEY_UP
case|:
if|if
condition|(
name|obj
operator|->
name|prev
operator|!=
name|NULL
condition|)
block|{
name|obj
operator|=
name|obj
operator|->
name|prev
expr_stmt|;
operator|--
name|n
expr_stmt|;
block|}
else|else
block|{
name|obj
operator|=
name|last
expr_stmt|;
name|n
operator|=
name|max
expr_stmt|;
block|}
break|break;
comment|/* More special case handling - if we are at the interface                list, move to the OK button - the user hasn't selected                one of the entries in the list by pressing CR, so (s)he                must be wanting to skip to<OK>&<CANCEL> */
case|case
name|KEY_DOWN
case|:
if|if
condition|(
name|n
operator|==
name|LAYOUT_EXTRAS
condition|)
block|{
name|n
operator|=
name|LAYOUT_IFACE
expr_stmt|;
name|obj
operator|=
operator|(
operator|(
operator|(
name|first
operator|->
name|next
operator|)
operator|->
name|next
operator|)
operator|->
name|next
operator|)
operator|->
name|next
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|obj
operator|->
name|next
operator|!=
name|NULL
condition|)
block|{
name|obj
operator|=
name|obj
operator|->
name|next
expr_stmt|;
operator|++
name|n
expr_stmt|;
block|}
else|else
block|{
name|obj
operator|=
name|first
expr_stmt|;
name|n
operator|=
literal|0
expr_stmt|;
block|}
break|break;
comment|/* Same as KEY_DOWN, but dialog has already move us to the                next object on the list, which makes this slightly                different. */
case|case
name|SEL_TAB
case|:
if|if
condition|(
name|n
operator|==
name|LAYOUT_EXTRAS
condition|)
block|{
name|n
operator|=
name|LAYOUT_IFACE
expr_stmt|;
name|obj
operator|=
operator|(
operator|(
operator|(
name|first
operator|->
name|next
operator|)
operator|->
name|next
operator|)
operator|->
name|next
operator|)
operator|->
name|next
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|n
operator|<
name|max
condition|)
block|{
operator|++
name|n
expr_stmt|;
block|}
else|else
block|{
name|n
operator|=
literal|0
expr_stmt|;
block|}
comment|/* This looks double dutch, but we have already MOVED onto                the next field, so we special case around getting to                that field, rather than moving off the previous                one. Hence we are really testing for 	       (n == LAYOUT_IFACE) */
if|if
condition|(
name|n
operator|==
name|LAYOUT_IPADDR
condition|)
block|{
name|n
operator|=
name|LAYOUT_OKBUTTON
expr_stmt|;
name|obj
operator|=
operator|(
operator|(
name|obj
operator|->
name|next
operator|)
operator|->
name|next
operator|)
operator|->
name|next
expr_stmt|;
block|}
break|break;
comment|/* The user has pressed enter over a button object */
case|case
name|SEL_BUTTON
case|:
if|if
condition|(
name|cancelbutton
condition|)
block|{
name|cancel
operator|=
name|TRUE
operator|,
name|quit
operator|=
name|TRUE
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|verifySettings
argument_list|()
condition|)
name|quit
operator|=
name|TRUE
expr_stmt|;
block|}
break|break;
comment|/* Generic CR handler */
case|case
name|SEL_CR
case|:
comment|/* Has the user selected a new interface? */
if|if
condition|(
name|strcmp
argument_list|(
name|old_iface
argument_list|,
name|iface
argument_list|)
condition|)
block|{
comment|/* Now go find the new location */
name|n_iface
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|strcmp
argument_list|(
name|iface
argument_list|,
name|iface_names
index|[
name|n_iface
index|]
argument_list|)
operator|&&
operator|(
name|iface_names
index|[
name|n_iface
index|]
operator|!=
name|NULL
operator|)
condition|)
operator|++
name|n_iface
expr_stmt|;
if|if
condition|(
name|iface_names
index|[
name|n_iface
index|]
operator|==
name|NULL
condition|)
name|msgFatal
argument_list|(
literal|"Erk - run off the end of the list of interfaces!"
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|ipaddr
argument_list|,
name|if_list
index|[
name|n_iface
index|]
operator|.
name|ipaddr
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|netmask
argument_list|,
name|if_list
index|[
name|n_iface
index|]
operator|.
name|netmask
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|extras
argument_list|,
name|if_list
index|[
name|n_iface
index|]
operator|.
name|extras
argument_list|)
expr_stmt|;
name|if_list
index|[
name|n_iface
index|]
operator|.
name|valid
operator|=
name|FALSE
expr_stmt|;
name|RefreshStringObj
argument_list|(
name|layout
index|[
name|LAYOUT_IPADDR
index|]
operator|.
name|obj
argument_list|)
expr_stmt|;
name|RefreshStringObj
argument_list|(
name|layout
index|[
name|LAYOUT_NETMASK
index|]
operator|.
name|obj
argument_list|)
expr_stmt|;
name|RefreshStringObj
argument_list|(
name|layout
index|[
name|LAYOUT_EXTRAS
index|]
operator|.
name|obj
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|old_iface
argument_list|,
name|iface
argument_list|)
expr_stmt|;
block|}
comment|/* Loop back to the interface list from the extras box -                now we handle the case of saving out the data the user                typed in (and also do basic verification of its                sanity) */
if|if
condition|(
name|n
operator|==
name|LAYOUT_EXTRAS
condition|)
block|{
name|n
operator|=
name|LAYOUT_IFACE
expr_stmt|;
name|obj
operator|=
operator|(
operator|(
operator|(
name|first
operator|->
name|next
operator|)
operator|->
name|next
operator|)
operator|->
name|next
operator|)
operator|->
name|next
expr_stmt|;
comment|/* First, find the old value */
name|n_iface
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|strcmp
argument_list|(
name|old_iface
argument_list|,
name|iface_names
index|[
name|n_iface
index|]
argument_list|)
operator|&&
operator|(
name|iface_names
index|[
name|n_iface
index|]
operator|!=
name|NULL
operator|)
condition|)
operator|++
name|n_iface
expr_stmt|;
if|if
condition|(
name|iface_names
index|[
name|n_iface
index|]
operator|==
name|NULL
condition|)
name|msgFatal
argument_list|(
literal|"Erk - run off the end of the list of interfaces!"
argument_list|)
expr_stmt|;
comment|/* Sanity check what the user supplied - this could probably 		   be better :-( */
if|if
condition|(
operator|!
name|verifyIP
argument_list|(
name|ipaddr
argument_list|)
condition|)
block|{
name|feepout
argument_list|(
literal|"Invalid or missing IP address!"
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|iface
argument_list|,
name|old_iface
argument_list|)
expr_stmt|;
name|n
operator|=
name|LAYOUT_IFACE
expr_stmt|;
name|obj
operator|=
operator|(
operator|(
operator|(
name|first
operator|->
name|next
operator|)
operator|->
name|next
operator|)
operator|->
name|next
operator|)
operator|->
name|next
expr_stmt|;
name|RefreshListObj
argument_list|(
name|layout
index|[
name|LAYOUT_IFACE
index|]
operator|.
name|obj
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|netmask
index|[
literal|0
index|]
operator|<
literal|'0'
operator|||
name|netmask
index|[
literal|0
index|]
operator|>
literal|'9'
condition|)
block|{
name|feepout
argument_list|(
literal|"Invalid or missing netmask!"
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|iface
argument_list|,
name|old_iface
argument_list|)
expr_stmt|;
name|n
operator|=
name|LAYOUT_IFACE
expr_stmt|;
name|obj
operator|=
operator|(
operator|(
operator|(
name|first
operator|->
name|next
operator|)
operator|->
name|next
operator|)
operator|->
name|next
operator|)
operator|->
name|next
expr_stmt|;
name|RefreshListObj
argument_list|(
name|layout
index|[
name|LAYOUT_IFACE
index|]
operator|.
name|obj
argument_list|)
expr_stmt|;
block|}
name|strcpy
argument_list|(
name|if_list
index|[
name|n_iface
index|]
operator|.
name|ipaddr
argument_list|,
name|ipaddr
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|if_list
index|[
name|n_iface
index|]
operator|.
name|netmask
argument_list|,
name|netmask
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|if_list
index|[
name|n_iface
index|]
operator|.
name|extras
argument_list|,
name|extras
argument_list|)
expr_stmt|;
name|if_list
index|[
name|n_iface
index|]
operator|.
name|valid
operator|=
name|TRUE
expr_stmt|;
name|if_list
index|[
name|n_iface
index|]
operator|.
name|dptr
operator|->
name|enabled
operator|=
name|TRUE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|n
operator|<
name|max
condition|)
operator|++
name|n
expr_stmt|;
else|else
name|n
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|SEL_BACKTAB
case|:
if|if
condition|(
name|n
condition|)
operator|--
name|n
expr_stmt|;
else|else
name|n
operator|=
name|max
expr_stmt|;
break|break;
case|case
name|KEY_F
argument_list|(
literal|1
argument_list|)
case|:
name|display_helpfile
argument_list|()
expr_stmt|;
comment|/* They tried some key combination we don't support - tell them! */
default|default:
name|beep
argument_list|()
expr_stmt|;
block|}
comment|/* BODGE ALERT! */
if|if
condition|(
operator|(
name|tmp
operator|=
name|index
argument_list|(
name|hostname
argument_list|,
literal|'.'
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|strncpy
argument_list|(
name|domainname
argument_list|,
name|tmp
operator|+
literal|1
argument_list|,
name|strlen
argument_list|(
name|tmp
operator|+
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|domainname
index|[
name|strlen
argument_list|(
name|tmp
operator|+
literal|1
argument_list|)
index|]
operator|=
literal|'\0'
expr_stmt|;
name|RefreshStringObj
argument_list|(
name|layout
index|[
literal|1
index|]
operator|.
name|obj
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Clear this crap off the screen */
name|dialog_clear
argument_list|()
expr_stmt|;
name|refresh
argument_list|()
expr_stmt|;
name|use_helpfile
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
comment|/* We actually need to inform the rest of sysinstall about this        data now - if the user hasn't selected cancel, save the stuff        out to the environment via the variable_set layers */
if|if
condition|(
operator|!
name|cancel
condition|)
block|{
name|int
name|foo
decl_stmt|;
name|variable_set2
argument_list|(
name|VAR_HOSTNAME
argument_list|,
name|hostname
argument_list|)
expr_stmt|;
name|variable_set2
argument_list|(
name|VAR_DOMAINNAME
argument_list|,
name|domainname
argument_list|)
expr_stmt|;
if|if
condition|(
name|gateway
index|[
literal|0
index|]
condition|)
name|variable_set2
argument_list|(
name|VAR_GATEWAY
argument_list|,
name|gateway
argument_list|)
expr_stmt|;
if|if
condition|(
name|nameserver
index|[
literal|0
index|]
condition|)
name|variable_set2
argument_list|(
name|VAR_NAMESERVER
argument_list|,
name|nameserver
argument_list|)
expr_stmt|;
comment|/* Loop over the per-interface data saving data which has been            validated ... */
for|for
control|(
name|foo
operator|=
literal|0
init|;
name|foo
operator|<
name|INTERFACE_MAX
condition|;
name|foo
operator|++
control|)
block|{
if|if
condition|(
name|if_list
index|[
name|foo
index|]
operator|.
name|valid
operator|==
name|TRUE
condition|)
block|{
name|char
name|temp
index|[
literal|512
index|]
decl_stmt|,
name|ifn
index|[
literal|64
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|temp
argument_list|,
literal|"inet %s %s netmask %s"
argument_list|,
name|if_list
index|[
name|foo
index|]
operator|.
name|ipaddr
argument_list|,
name|if_list
index|[
name|foo
index|]
operator|.
name|extras
argument_list|,
name|if_list
index|[
name|foo
index|]
operator|.
name|netmask
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|ifn
argument_list|,
literal|"%s%s"
argument_list|,
name|VAR_IFCONFIG
argument_list|,
name|iface_names
index|[
name|foo
index|]
argument_list|)
expr_stmt|;
name|variable_set2
argument_list|(
name|ifn
argument_list|,
name|temp
argument_list|)
expr_stmt|;
block|}
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|Device
modifier|*
name|netDevice
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|netHook
parameter_list|(
name|char
modifier|*
name|str
parameter_list|)
block|{
name|Device
modifier|*
modifier|*
name|devs
decl_stmt|;
comment|/* Clip garbage off the ends */
name|string_prune
argument_list|(
name|str
argument_list|)
expr_stmt|;
name|str
operator|=
name|string_skipwhite
argument_list|(
name|str
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|str
condition|)
return|return
literal|0
return|;
name|devs
operator|=
name|deviceFind
argument_list|(
name|str
argument_list|,
name|DEVICE_TYPE_NETWORK
argument_list|)
expr_stmt|;
if|if
condition|(
name|devs
condition|)
name|netDevice
operator|=
name|devs
index|[
literal|0
index|]
expr_stmt|;
return|return
name|devs
condition|?
literal|1
else|:
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Get a network device */
end_comment

begin_function
name|Device
modifier|*
name|tcpDeviceSelect
parameter_list|(
name|void
parameter_list|)
block|{
name|DMenu
modifier|*
name|menu
decl_stmt|;
comment|/* If we can't find a hostname, ask user to set up TCP/IP */
if|if
condition|(
operator|!
name|getenv
argument_list|(
name|VAR_HOSTNAME
argument_list|)
condition|)
name|tcpOpenDialog
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
comment|/* If we still can't, user is a bonehead */
if|if
condition|(
operator|!
name|getenv
argument_list|(
name|VAR_HOSTNAME
argument_list|)
condition|)
block|{
name|msgConfirm
argument_list|(
literal|"Sorry, I can't do this if you don't set up your networking first!"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|menu
operator|=
name|deviceCreateMenu
argument_list|(
operator|&
name|MenuNetworkDevice
argument_list|,
name|DEVICE_TYPE_NETWORK
argument_list|,
name|netHook
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|menu
condition|)
name|msgFatal
argument_list|(
literal|"Unable to create network device menu!  Argh!"
argument_list|)
expr_stmt|;
name|dmenuOpenSimple
argument_list|(
name|menu
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|menu
argument_list|)
expr_stmt|;
return|return
name|netDevice
return|;
block|}
end_function

begin_comment
comment|/* Start PPP on the 3rd screen */
end_comment

begin_function
name|Boolean
name|tcpStartPPP
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|fd
decl_stmt|;
name|fd
operator|=
name|open
argument_list|(
literal|"/dev/ttyv2"
argument_list|,
name|O_RDWR
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|==
operator|-
literal|1
condition|)
return|return
name|FALSE
return|;
name|Mkdir
argument_list|(
literal|"/var/log"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|fork
argument_list|()
condition|)
block|{
name|dup2
argument_list|(
name|fd
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|dup2
argument_list|(
name|fd
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|dup2
argument_list|(
name|fd
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|execl
argument_list|(
literal|"/stand/ppp"
argument_list|,
literal|"/stand/ppp"
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
name|TRUE
return|;
block|}
end_function

end_unit


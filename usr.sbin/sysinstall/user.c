begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * $FreeBSD$  *  * Copyright (c) 1996  *      JÃ¶rg Wunsch. All rights reserved.  *  * The basic structure has been taken from tcpip.c, which is:  *  * Copyright (c) 1995  *      Gary J Palmer. All rights reserved.  *      Jordan K Hubbard. All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer,  *    verbatim and that no modifications are made prior to this  *    point in the file.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHORS ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHORS BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,  * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS  * OF USE, DATA, LIFE OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED  * AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR  * TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  *  */
end_comment

begin_include
include|#
directive|include
file|"sysinstall.h"
end_include

begin_include
include|#
directive|include
file|<utmp.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sysexits.h>
end_include

begin_comment
comment|/* The help file for the user mgmt screen */
end_comment

begin_define
define|#
directive|define
name|USER_HELPFILE
value|"usermgmt"
end_define

begin_comment
comment|/* XXX should they be moved out to sysinstall.h? */
end_comment

begin_define
define|#
directive|define
name|GNAME_FIELD_LEN
value|32
end_define

begin_define
define|#
directive|define
name|GID_FIELD_LEN
value|10
end_define

begin_define
define|#
directive|define
name|GMEMB_FIELD_LEN
value|64
end_define

begin_define
define|#
directive|define
name|UID_FIELD_LEN
value|10
end_define

begin_define
define|#
directive|define
name|UGROUP_FIELD_LEN
value|GNAME_FIELD_LEN
end_define

begin_define
define|#
directive|define
name|GECOS_FIELD_LEN
value|64
end_define

begin_define
define|#
directive|define
name|UMEMB_FIELD_LEN
value|GMEMB_FIELD_LEN
end_define

begin_define
define|#
directive|define
name|HOMEDIR_FIELD_LEN
value|48
end_define

begin_define
define|#
directive|define
name|SHELL_FIELD_LEN
value|48
end_define

begin_define
define|#
directive|define
name|PASSWD_FIELD_LEN
value|32
end_define

begin_comment
comment|/* These are nasty, but they make the layout structure a lot easier ... */
end_comment

begin_decl_stmt
specifier|static
name|char
name|gname
index|[
name|GNAME_FIELD_LEN
index|]
decl_stmt|,
name|gid
index|[
name|GID_FIELD_LEN
index|]
decl_stmt|,
name|gmemb
index|[
name|GMEMB_FIELD_LEN
index|]
decl_stmt|,
name|uname
index|[
name|UT_NAMESIZE
operator|+
literal|1
index|]
decl_stmt|,
name|passwd
index|[
name|PASSWD_FIELD_LEN
index|]
decl_stmt|,
name|uid
index|[
name|UID_FIELD_LEN
index|]
decl_stmt|,
name|ugroup
index|[
name|UGROUP_FIELD_LEN
index|]
decl_stmt|,
name|gecos
index|[
name|GECOS_FIELD_LEN
index|]
decl_stmt|,
name|umemb
index|[
name|UMEMB_FIELD_LEN
index|]
decl_stmt|,
name|homedir
index|[
name|HOMEDIR_FIELD_LEN
index|]
decl_stmt|,
name|shell
index|[
name|SHELL_FIELD_LEN
index|]
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|CLEAR
parameter_list|(
name|v
parameter_list|)
value|memset(v, 0, sizeof v)
end_define

begin_decl_stmt
specifier|static
name|int
name|okbutton
decl_stmt|,
name|cancelbutton
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* What the screen size is meant to be */
end_comment

begin_define
define|#
directive|define
name|USER_DIALOG_Y
value|0
end_define

begin_define
define|#
directive|define
name|USER_DIALOG_X
value|8
end_define

begin_define
define|#
directive|define
name|USER_DIALOG_WIDTH
value|COLS - 16
end_define

begin_define
define|#
directive|define
name|USER_DIALOG_HEIGHT
value|LINES - 2
end_define

begin_comment
comment|/* The group configuration menu. */
end_comment

begin_decl_stmt
specifier|static
name|Layout
name|groupLayout
index|[]
init|=
block|{
define|#
directive|define
name|LAYOUT_GNAME
value|0
block|{
literal|4
block|,
literal|10
block|,
literal|20
block|,
name|GNAME_FIELD_LEN
operator|-
literal|1
block|,
literal|"Group name:"
block|,
literal|"The alphanumeric name of the new group (mandatory)"
block|,
name|gname
block|,
name|STRINGOBJ
block|,
name|NULL
block|}
block|,
define|#
directive|define
name|LAYOUT_GID
value|1
block|{
literal|4
block|,
literal|38
block|,
literal|10
block|,
name|GID_FIELD_LEN
operator|-
literal|1
block|,
literal|"GID:"
block|,
literal|"The numerical ID for this group (leave blank for automatic choice)"
block|,
name|gid
block|,
name|STRINGOBJ
block|,
name|NULL
block|}
block|,
define|#
directive|define
name|LAYOUT_GMEMB
value|2
block|{
literal|11
block|,
literal|10
block|,
literal|40
block|,
name|GMEMB_FIELD_LEN
operator|-
literal|1
block|,
literal|"Group members:"
block|,
literal|"Who belongs to this group (i.e., gets access rights for it)"
block|,
name|gmemb
block|,
name|STRINGOBJ
block|,
name|NULL
block|}
block|,
define|#
directive|define
name|LAYOUT_OKBUTTON
value|3
block|{
literal|18
block|,
literal|15
block|,
literal|0
block|,
literal|0
block|,
literal|"OK"
block|,
literal|"Select this if you are happy with these settings"
block|,
operator|&
name|okbutton
block|,
name|BUTTONOBJ
block|,
name|NULL
block|}
block|,
define|#
directive|define
name|LAYOUT_CANCELBUTTON
value|4
block|{
literal|18
block|,
literal|35
block|,
literal|0
block|,
literal|0
block|,
literal|"CANCEL"
block|,
literal|"Select this if you wish to cancel this screen"
block|,
operator|&
name|cancelbutton
block|,
name|BUTTONOBJ
block|,
name|NULL
block|}
block|,
block|{
name|NULL
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* The user configuration menu. */
end_comment

begin_decl_stmt
specifier|static
name|Layout
name|userLayout
index|[]
init|=
block|{
define|#
directive|define
name|LAYOUT_UNAME
value|0
block|{
literal|3
block|,
literal|6
block|,
name|UT_NAMESIZE
block|,
name|UT_NAMESIZE
operator|+
literal|1
block|,
literal|"Login ID:"
block|,
literal|"The login name of the new user (mandatory)"
block|,
name|uname
block|,
name|STRINGOBJ
block|,
name|NULL
block|}
block|,
define|#
directive|define
name|LAYOUT_UID
value|1
block|{
literal|3
block|,
literal|23
block|,
literal|8
block|,
name|UID_FIELD_LEN
operator|-
literal|1
block|,
literal|"UID:"
block|,
literal|"The numerical ID for this user (leave blank for automatic choice)"
block|,
name|uid
block|,
name|STRINGOBJ
block|,
name|NULL
block|}
block|,
define|#
directive|define
name|LAYOUT_UGROUP
value|2
block|{
literal|3
block|,
literal|33
block|,
literal|8
block|,
name|UGROUP_FIELD_LEN
operator|-
literal|1
block|,
literal|"Group:"
block|,
literal|"The login group name for this user (leave blank for automatic choice)"
block|,
name|ugroup
block|,
name|STRINGOBJ
block|,
name|NULL
block|}
block|,
define|#
directive|define
name|LAYOUT_PASSWD
value|3
block|{
literal|3
block|,
literal|43
block|,
literal|15
block|,
name|PASSWD_FIELD_LEN
operator|-
literal|1
block|,
literal|"Password:"
block|,
literal|"The password for this user (enter this field with care!)"
block|,
name|passwd
block|,
name|NO_ECHO_OBJ
argument_list|(
name|STRINGOBJ
argument_list|)
block|,
name|NULL
block|}
block|,
define|#
directive|define
name|LAYOUT_GECOS
value|4
block|{
literal|8
block|,
literal|6
block|,
literal|33
block|,
name|GECOS_FIELD_LEN
operator|-
literal|1
block|,
literal|"Full name:"
block|,
literal|"The user's full name (comment)"
block|,
name|gecos
block|,
name|STRINGOBJ
block|,
name|NULL
block|}
block|,
define|#
directive|define
name|LAYOUT_UMEMB
value|5
block|{
literal|8
block|,
literal|43
block|,
literal|15
block|,
name|UMEMB_FIELD_LEN
operator|-
literal|1
block|,
literal|"Member groups:"
block|,
literal|"The groups this user belongs to (i.e. gets access rights for)"
block|,
name|umemb
block|,
name|STRINGOBJ
block|,
name|NULL
block|}
block|,
define|#
directive|define
name|LAYOUT_HOMEDIR
value|6
block|{
literal|13
block|,
literal|6
block|,
literal|20
block|,
name|HOMEDIR_FIELD_LEN
operator|-
literal|1
block|,
literal|"Home directory:"
block|,
literal|"The user's home directory (leave blank for default)"
block|,
name|homedir
block|,
name|STRINGOBJ
block|,
name|NULL
block|}
block|,
define|#
directive|define
name|LAYOUT_SHELL
value|7
block|{
literal|13
block|,
literal|29
block|,
literal|29
block|,
name|SHELL_FIELD_LEN
operator|-
literal|1
block|,
literal|"Login shell:"
block|,
literal|"The user's login shell (leave blank for default)"
block|,
name|shell
block|,
name|STRINGOBJ
block|,
name|NULL
block|}
block|,
define|#
directive|define
name|LAYOUT_U_OKBUTTON
value|8
block|{
literal|18
block|,
literal|15
block|,
literal|0
block|,
literal|0
block|,
literal|"OK"
block|,
literal|"Select this if you are happy with these settings"
block|,
operator|&
name|okbutton
block|,
name|BUTTONOBJ
block|,
name|NULL
block|}
block|,
define|#
directive|define
name|LAYOUT_U_CANCELBUTTON
value|9
block|{
literal|18
block|,
literal|35
block|,
literal|0
block|,
literal|0
block|,
literal|"CANCEL"
block|,
literal|"Select this if you wish to cancel this screen"
block|,
operator|&
name|cancelbutton
block|,
name|BUTTONOBJ
block|,
name|NULL
block|}
block|,
block|{
name|NULL
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* whine */
end_comment

begin_function
specifier|static
name|void
name|feepout
parameter_list|(
name|char
modifier|*
name|msg
parameter_list|)
block|{
name|beep
argument_list|()
expr_stmt|;
name|dialog_notify
argument_list|(
name|msg
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Check for the settings on the screen. */
end_comment

begin_function
specifier|static
name|int
name|verifyGroupSettings
parameter_list|(
name|void
parameter_list|)
block|{
name|char
name|tmp
index|[
literal|256
index|]
decl_stmt|,
modifier|*
name|cp
decl_stmt|;
name|long
name|lgid
decl_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|gname
argument_list|)
operator|==
literal|0
condition|)
block|{
name|feepout
argument_list|(
literal|"The group name field must not be empty!"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|snprintf
argument_list|(
name|tmp
argument_list|,
literal|256
argument_list|,
literal|"pw group show -q -n %s> /dev/null"
argument_list|,
name|gname
argument_list|)
expr_stmt|;
if|if
condition|(
name|vsystem
argument_list|(
literal|"%s"
argument_list|,
name|tmp
argument_list|)
operator|==
literal|0
condition|)
block|{
name|feepout
argument_list|(
literal|"This group name is already in use."
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|strlen
argument_list|(
name|gid
argument_list|)
operator|>
literal|0
condition|)
block|{
name|lgid
operator|=
name|strtol
argument_list|(
name|gid
argument_list|,
operator|&
name|cp
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|lgid
operator|<
literal|0
operator|||
name|lgid
operator|>=
literal|65536
operator|||
operator|(
operator|*
name|cp
operator|!=
literal|'\0'
operator|&&
operator|!
name|isspace
argument_list|(
operator|*
name|cp
argument_list|)
operator|)
condition|)
block|{
name|feepout
argument_list|(
literal|"The GID must be a number between 1 and 65535."
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
if|if
condition|(
name|strlen
argument_list|(
name|gmemb
argument_list|)
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|strpbrk
argument_list|(
name|gmemb
argument_list|,
literal|" \t"
argument_list|)
operator|!=
name|NULL
condition|)
block|{
name|feepout
argument_list|(
literal|"The group member list must not contain any whitespace;\n"
literal|"use commas to separate the names."
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
ifndef|#
directive|ifndef
name|notyet
comment|/* XXX */
name|feepout
argument_list|(
literal|"Sorry, the group member list feature\n"
literal|"is currently not yet implemented."
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
endif|#
directive|endif
block|}
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/*  * Ask pw(8) to fill in the blanks for us.  * Works solely on the global variables.  */
end_comment

begin_function
specifier|static
name|void
name|completeGroup
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|pfd
index|[
literal|2
index|]
decl_stmt|,
name|i
decl_stmt|;
name|char
name|tmp
index|[
literal|256
index|]
decl_stmt|,
modifier|*
name|cp
decl_stmt|;
name|ssize_t
name|l
decl_stmt|;
name|size_t
name|amnt
decl_stmt|;
name|pid_t
name|pid
decl_stmt|;
name|char
modifier|*
name|vec
index|[
literal|4
index|]
init|=
block|{
literal|"pw"
block|,
literal|"group"
block|,
literal|"next"
block|,
literal|0
block|}
decl_stmt|;
name|pipe
argument_list|(
name|pfd
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pid
operator|=
name|fork
argument_list|()
operator|)
operator|==
literal|0
condition|)
block|{
comment|/* The kiddy. */
name|dup2
argument_list|(
name|pfd
index|[
literal|1
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|dup2
argument_list|(
name|pfd
index|[
literal|1
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|getdtablesize
argument_list|()
init|;
name|i
operator|>
literal|2
condition|;
name|i
operator|--
control|)
name|close
argument_list|(
name|i
argument_list|)
expr_stmt|;
name|execv
argument_list|(
literal|"/usr/sbin/pw"
argument_list|,
name|vec
argument_list|)
expr_stmt|;
name|msgDebug
argument_list|(
literal|"Cannot execv() /usr/sbin/pw.\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
literal|99
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* The oldie. */
name|close
argument_list|(
name|pfd
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|amnt
operator|=
sizeof|sizeof
name|tmp
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
name|l
operator|=
name|read
argument_list|(
name|pfd
index|[
literal|0
index|]
argument_list|,
operator|&
name|tmp
index|[
name|i
index|]
argument_list|,
name|amnt
argument_list|)
operator|)
operator|>
literal|0
condition|)
block|{
name|amnt
operator|-=
name|l
expr_stmt|;
name|i
operator|+=
name|l
expr_stmt|;
if|if
condition|(
name|amnt
operator|==
literal|0
condition|)
block|{
name|close
argument_list|(
name|pfd
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|close
argument_list|(
name|pfd
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|tmp
index|[
name|i
index|]
operator|=
literal|'\0'
expr_stmt|;
name|waitpid
argument_list|(
name|pid
argument_list|,
operator|&
name|i
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|WIFSIGNALED
argument_list|(
name|i
argument_list|)
operator|||
name|WEXITSTATUS
argument_list|(
name|i
argument_list|)
operator|!=
literal|0
condition|)
comment|/* ignore by now */
return|return;
if|if
condition|(
operator|(
name|cp
operator|=
name|strchr
argument_list|(
name|tmp
argument_list|,
literal|'\n'
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
operator|*
name|cp
operator|=
literal|'\0'
expr_stmt|;
name|strncpy
argument_list|(
name|gid
argument_list|,
name|tmp
argument_list|,
sizeof|sizeof
name|gid
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|addGroup
parameter_list|(
name|WINDOW
modifier|*
name|ds_win
parameter_list|)
block|{
name|char
name|tmp
index|[
literal|256
index|]
decl_stmt|;
name|int
name|pfd
index|[
literal|2
index|]
decl_stmt|,
name|i
decl_stmt|;
name|ssize_t
name|l
decl_stmt|;
name|size_t
name|amnt
decl_stmt|;
name|pid_t
name|pid
decl_stmt|;
name|char
modifier|*
name|vec
index|[
literal|8
index|]
init|=
block|{
literal|"pw"
block|,
literal|"group"
block|,
literal|"add"
block|,
literal|"-n"
block|,
literal|0
block|,
literal|"-g"
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
define|#
directive|define
name|VEC_GNAME
value|4
define|#
directive|define
name|VEC_GID
value|6
name|msgNotify
argument_list|(
literal|"Adding group \"%s\"..."
argument_list|,
name|gname
argument_list|)
expr_stmt|;
name|pipe
argument_list|(
name|pfd
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pid
operator|=
name|fork
argument_list|()
operator|)
operator|==
literal|0
condition|)
block|{
comment|/* The kiddy. */
name|dup2
argument_list|(
name|pfd
index|[
literal|1
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|dup2
argument_list|(
name|pfd
index|[
literal|1
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|getdtablesize
argument_list|()
init|;
name|i
operator|>
literal|2
condition|;
name|i
operator|--
control|)
name|close
argument_list|(
name|i
argument_list|)
expr_stmt|;
name|vec
index|[
name|VEC_GNAME
index|]
operator|=
name|gname
expr_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|gid
argument_list|)
operator|>
literal|0
condition|)
name|vec
index|[
name|VEC_GID
index|]
operator|=
name|gid
expr_stmt|;
else|else
name|vec
index|[
name|VEC_GID
operator|-
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|execv
argument_list|(
literal|"/usr/sbin/pw"
argument_list|,
name|vec
argument_list|)
expr_stmt|;
name|msgDebug
argument_list|(
literal|"Cannot execv() /usr/sbin/pw.\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
literal|99
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* The oldie. */
name|close
argument_list|(
name|pfd
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|amnt
operator|=
sizeof|sizeof
name|tmp
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
name|l
operator|=
name|read
argument_list|(
name|pfd
index|[
literal|0
index|]
argument_list|,
operator|&
name|tmp
index|[
name|i
index|]
argument_list|,
name|amnt
argument_list|)
operator|)
operator|>
literal|0
condition|)
block|{
name|amnt
operator|-=
name|l
expr_stmt|;
name|i
operator|+=
name|l
expr_stmt|;
if|if
condition|(
name|amnt
operator|==
literal|0
condition|)
block|{
name|close
argument_list|(
name|pfd
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|close
argument_list|(
name|pfd
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|tmp
index|[
name|i
index|]
operator|=
literal|'\0'
expr_stmt|;
name|waitpid
argument_list|(
name|pid
argument_list|,
operator|&
name|i
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|WIFSIGNALED
argument_list|(
name|i
argument_list|)
condition|)
name|msgDebug
argument_list|(
literal|"pw(8) exited with signal %d.\n"
argument_list|,
name|WTERMSIG
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|WEXITSTATUS
argument_list|(
name|i
argument_list|)
condition|)
block|{
name|i
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|strncmp
argument_list|(
name|tmp
argument_list|,
literal|"pw: "
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
name|i
operator|=
literal|4
expr_stmt|;
name|tmp
index|[
sizeof|sizeof
name|tmp
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
comment|/* sanity */
name|msgConfirm
argument_list|(
literal|"The `pw' command exited with an error status.\n"
literal|"Its error message was:\n\n%s"
argument_list|,
operator|&
name|tmp
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
undef|#
directive|undef
name|VEC_GNAME
undef|#
directive|undef
name|VEC_GID
block|}
end_function

begin_function
name|int
name|userAddGroup
parameter_list|(
name|dialogMenuItem
modifier|*
name|self
parameter_list|)
block|{
name|WINDOW
modifier|*
name|ds_win
decl_stmt|,
modifier|*
name|save
decl_stmt|;
name|ComposeObj
modifier|*
name|obj
init|=
name|NULL
decl_stmt|;
name|int
name|n
init|=
literal|0
decl_stmt|,
name|cancel
init|=
name|FALSE
decl_stmt|,
name|ret
decl_stmt|;
name|int
name|max
decl_stmt|,
name|firsttime
init|=
name|TRUE
decl_stmt|;
if|if
condition|(
name|RunningAsInit
operator|&&
operator|!
name|strstr
argument_list|(
name|variable_get
argument_list|(
name|SYSTEM_STATE
argument_list|)
argument_list|,
literal|"install"
argument_list|)
condition|)
block|{
name|msgConfirm
argument_list|(
literal|"This option may only be used after the system is installed, sorry!"
argument_list|)
expr_stmt|;
return|return
name|DITEM_FAILURE
return|;
block|}
name|save
operator|=
name|savescr
argument_list|()
expr_stmt|;
name|dialog_clear_norefresh
argument_list|()
expr_stmt|;
comment|/* We need a curses window */
if|if
condition|(
operator|!
operator|(
name|ds_win
operator|=
name|openLayoutDialog
argument_list|(
name|USER_HELPFILE
argument_list|,
literal|" User and Group Management "
argument_list|,
name|USER_DIALOG_X
argument_list|,
name|USER_DIALOG_Y
argument_list|,
name|USER_DIALOG_WIDTH
argument_list|,
name|USER_DIALOG_HEIGHT
argument_list|)
operator|)
condition|)
block|{
name|beep
argument_list|()
expr_stmt|;
name|msgConfirm
argument_list|(
literal|"Cannot open addgroup dialog window!!"
argument_list|)
expr_stmt|;
return|return
operator|(
name|DITEM_FAILURE
operator|)
return|;
block|}
comment|/* Draw a group entry box */
name|draw_box
argument_list|(
name|ds_win
argument_list|,
name|USER_DIALOG_Y
operator|+
literal|2
argument_list|,
name|USER_DIALOG_X
operator|+
literal|8
argument_list|,
name|USER_DIALOG_HEIGHT
operator|-
literal|8
argument_list|,
name|USER_DIALOG_WIDTH
operator|-
literal|17
argument_list|,
name|dialog_attr
argument_list|,
name|border_attr
argument_list|)
expr_stmt|;
name|wattrset
argument_list|(
name|ds_win
argument_list|,
name|dialog_attr
argument_list|)
expr_stmt|;
name|mvwaddstr
argument_list|(
name|ds_win
argument_list|,
name|USER_DIALOG_Y
operator|+
literal|2
argument_list|,
name|USER_DIALOG_X
operator|+
literal|22
argument_list|,
literal|" Add a new group "
argument_list|)
expr_stmt|;
name|CLEAR
argument_list|(
name|gname
argument_list|)
expr_stmt|;
name|CLEAR
argument_list|(
name|gid
argument_list|)
expr_stmt|;
name|CLEAR
argument_list|(
name|gmemb
argument_list|)
expr_stmt|;
comment|/* Some more initialisation before we go into the main input loop */
name|obj
operator|=
name|initLayoutDialog
argument_list|(
name|ds_win
argument_list|,
name|groupLayout
argument_list|,
name|USER_DIALOG_X
argument_list|,
name|USER_DIALOG_Y
argument_list|,
operator|&
name|max
argument_list|)
expr_stmt|;
name|reenter
label|:
name|cancelbutton
operator|=
name|okbutton
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|firsttime
condition|)
block|{
comment|/* fill in the blanks, well, just the GID */
name|completeGroup
argument_list|()
expr_stmt|;
name|RefreshStringObj
argument_list|(
name|groupLayout
index|[
name|LAYOUT_GID
index|]
operator|.
name|obj
argument_list|)
expr_stmt|;
name|firsttime
operator|=
name|FALSE
expr_stmt|;
block|}
while|while
condition|(
name|layoutDialogLoop
argument_list|(
name|ds_win
argument_list|,
name|groupLayout
argument_list|,
operator|&
name|obj
argument_list|,
operator|&
name|n
argument_list|,
name|max
argument_list|,
operator|&
name|cancelbutton
argument_list|,
operator|&
name|cancel
argument_list|)
condition|)
empty_stmt|;
if|if
condition|(
operator|!
name|cancel
operator|&&
operator|!
name|verifyGroupSettings
argument_list|()
condition|)
goto|goto
name|reenter
goto|;
comment|/* Clear this crap off the screen */
name|delwin
argument_list|(
name|ds_win
argument_list|)
expr_stmt|;
name|dialog_clear_norefresh
argument_list|()
expr_stmt|;
name|use_helpfile
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cancel
condition|)
block|{
name|addGroup
argument_list|(
name|ds_win
argument_list|)
expr_stmt|;
name|ret
operator|=
name|DITEM_SUCCESS
expr_stmt|;
block|}
else|else
name|ret
operator|=
name|DITEM_FAILURE
expr_stmt|;
name|restorescr
argument_list|(
name|save
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/* Check for the settings on the screen. */
end_comment

begin_function
specifier|static
name|int
name|verifyUserSettings
parameter_list|(
name|WINDOW
modifier|*
name|ds_win
parameter_list|)
block|{
name|char
name|tmp
index|[
literal|256
index|]
decl_stmt|,
modifier|*
name|cp
decl_stmt|;
name|long
name|luid
decl_stmt|;
name|WINDOW
modifier|*
name|save
decl_stmt|;
name|int
name|rv
decl_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|uname
argument_list|)
operator|==
literal|0
condition|)
block|{
name|feepout
argument_list|(
literal|"The user name field must not be empty!"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|snprintf
argument_list|(
name|tmp
argument_list|,
literal|256
argument_list|,
literal|"pw user show -q -n %s> /dev/null"
argument_list|,
name|uname
argument_list|)
expr_stmt|;
if|if
condition|(
name|vsystem
argument_list|(
literal|"%s"
argument_list|,
name|tmp
argument_list|)
operator|==
literal|0
condition|)
block|{
name|feepout
argument_list|(
literal|"This user name is already in use."
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|strlen
argument_list|(
name|uid
argument_list|)
operator|>
literal|0
condition|)
block|{
name|luid
operator|=
name|strtol
argument_list|(
name|uid
argument_list|,
operator|&
name|cp
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|luid
operator|<
literal|0
operator|||
name|luid
operator|>=
literal|65536
operator|||
operator|(
operator|*
name|cp
operator|!=
literal|'\0'
operator|&&
operator|!
name|isspace
argument_list|(
operator|*
name|cp
argument_list|)
operator|)
condition|)
block|{
name|feepout
argument_list|(
literal|"The UID must be a number between 1 and 65535."
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
if|if
condition|(
operator|(
name|homedir
index|[
literal|0
index|]
operator|!=
literal|0
operator|)
operator|&&
operator|(
name|homedir
index|[
literal|0
index|]
operator|!=
literal|'/'
operator|)
condition|)
block|{
name|feepout
argument_list|(
literal|"The pathname for home directories must begin with a '/'."
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|strlen
argument_list|(
name|shell
argument_list|)
operator|>
literal|0
condition|)
block|{
while|while
condition|(
operator|(
name|cp
operator|=
name|getusershell
argument_list|()
operator|)
operator|!=
name|NULL
condition|)
if|if
condition|(
name|strcmp
argument_list|(
name|cp
argument_list|,
name|shell
argument_list|)
operator|==
literal|0
condition|)
break|break;
name|endusershell
argument_list|()
expr_stmt|;
if|if
condition|(
name|cp
operator|==
name|NULL
condition|)
block|{
name|save
operator|=
name|savescr
argument_list|()
expr_stmt|;
name|rv
operator|=
name|msgYesNo
argument_list|(
literal|"Warning:\n\n"
literal|"The requested shell \"%s\" is not\n"
literal|"a valid user shell.\n\n"
literal|"Use it anyway?\n"
argument_list|,
name|shell
argument_list|)
expr_stmt|;
name|restorescr
argument_list|(
name|save
argument_list|)
expr_stmt|;
name|wrefresh
argument_list|(
name|ds_win
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
name|DITEM_SUCCESS
condition|)
return|return
literal|0
return|;
block|}
block|}
if|if
condition|(
name|strlen
argument_list|(
name|umemb
argument_list|)
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|strpbrk
argument_list|(
name|umemb
argument_list|,
literal|" \t"
argument_list|)
operator|!=
name|NULL
condition|)
block|{
name|feepout
argument_list|(
literal|"The member groups list must not contain any whitespace;\n"
literal|"use commas to separate the names."
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/*  * Ask pw(8) to fill in the blanks for us.  * Works solely on the global variables.  */
end_comment

begin_function
specifier|static
name|void
name|completeUser
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|pfd
index|[
literal|2
index|]
decl_stmt|,
name|i
decl_stmt|;
name|char
name|tmp
index|[
literal|256
index|]
decl_stmt|,
modifier|*
name|cp
decl_stmt|,
modifier|*
name|cp2
decl_stmt|;
name|ssize_t
name|l
decl_stmt|;
name|size_t
name|amnt
decl_stmt|;
name|pid_t
name|pid
decl_stmt|;
name|char
modifier|*
name|vec
index|[
literal|7
index|]
init|=
block|{
literal|"pw"
block|,
literal|"user"
block|,
literal|"add"
block|,
literal|"-N"
block|,
literal|"-n"
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
define|#
directive|define
name|VEC_UNAME
value|5
name|pipe
argument_list|(
name|pfd
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pid
operator|=
name|fork
argument_list|()
operator|)
operator|==
literal|0
condition|)
block|{
comment|/* The kiddy. */
name|dup2
argument_list|(
name|pfd
index|[
literal|1
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|dup2
argument_list|(
name|pfd
index|[
literal|1
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|getdtablesize
argument_list|()
init|;
name|i
operator|>
literal|2
condition|;
name|i
operator|--
control|)
name|close
argument_list|(
name|i
argument_list|)
expr_stmt|;
name|vec
index|[
name|VEC_UNAME
index|]
operator|=
name|uname
expr_stmt|;
name|execv
argument_list|(
literal|"/usr/sbin/pw"
argument_list|,
name|vec
argument_list|)
expr_stmt|;
name|msgDebug
argument_list|(
literal|"Cannot execv() /usr/sbin/pw.\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
literal|99
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* The oldie. */
name|close
argument_list|(
name|pfd
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|amnt
operator|=
sizeof|sizeof
name|tmp
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
name|l
operator|=
name|read
argument_list|(
name|pfd
index|[
literal|0
index|]
argument_list|,
operator|&
name|tmp
index|[
name|i
index|]
argument_list|,
name|amnt
argument_list|)
operator|)
operator|>
literal|0
condition|)
block|{
name|amnt
operator|-=
name|l
expr_stmt|;
name|i
operator|+=
name|l
expr_stmt|;
if|if
condition|(
name|amnt
operator|==
literal|0
condition|)
block|{
name|close
argument_list|(
name|pfd
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|close
argument_list|(
name|pfd
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|tmp
index|[
name|i
index|]
operator|=
literal|'\0'
expr_stmt|;
name|waitpid
argument_list|(
name|pid
argument_list|,
operator|&
name|i
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|WIFSIGNALED
argument_list|(
name|i
argument_list|)
operator|||
name|WEXITSTATUS
argument_list|(
name|i
argument_list|)
operator|!=
literal|0
condition|)
comment|/* ignore by now */
return|return;
if|if
condition|(
operator|(
name|cp
operator|=
name|strchr
argument_list|(
name|tmp
argument_list|,
literal|'\n'
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
operator|*
name|cp
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|(
name|cp
operator|=
name|strchr
argument_list|(
name|tmp
argument_list|,
literal|':'
argument_list|)
operator|)
operator|==
name|NULL
operator|||
operator|(
name|cp
operator|=
name|strchr
argument_list|(
operator|++
name|cp
argument_list|,
literal|':'
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return;
name|cp
operator|++
expr_stmt|;
if|if
condition|(
operator|(
name|cp2
operator|=
name|strchr
argument_list|(
name|cp
argument_list|,
literal|':'
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return;
operator|*
name|cp2
operator|++
operator|=
literal|'\0'
expr_stmt|;
name|strncpy
argument_list|(
name|uid
argument_list|,
name|cp
argument_list|,
sizeof|sizeof
name|uid
argument_list|)
expr_stmt|;
name|cp
operator|=
name|cp2
expr_stmt|;
if|if
condition|(
operator|(
name|cp2
operator|=
name|strchr
argument_list|(
name|cp
argument_list|,
literal|':'
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return;
operator|*
name|cp2
operator|++
operator|=
literal|'\0'
expr_stmt|;
ifdef|#
directive|ifdef
name|notyet
comment|/* XXX pw user add -g doesn't accept a numerical GID */
name|strncpy
argument_list|(
name|ugroup
argument_list|,
name|cp
argument_list|,
sizeof|sizeof
name|ugroup
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|cp
operator|=
name|cp2
expr_stmt|;
if|if
condition|(
operator|(
name|cp2
operator|=
name|strchr
argument_list|(
name|cp
argument_list|,
literal|':'
argument_list|)
operator|)
operator|==
name|NULL
operator|||
operator|(
name|cp2
operator|=
name|strchr
argument_list|(
operator|++
name|cp2
argument_list|,
literal|':'
argument_list|)
operator|)
operator|==
name|NULL
operator|||
operator|(
name|cp
operator|=
name|cp2
operator|=
name|strchr
argument_list|(
operator|++
name|cp2
argument_list|,
literal|':'
argument_list|)
operator|)
operator|==
name|NULL
operator|||
operator|(
name|cp2
operator|=
name|strchr
argument_list|(
operator|++
name|cp2
argument_list|,
literal|':'
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return;
operator|*
name|cp2
operator|++
operator|=
literal|'\0'
expr_stmt|;
name|cp
operator|++
expr_stmt|;
name|strncpy
argument_list|(
name|gecos
argument_list|,
name|cp
argument_list|,
sizeof|sizeof
name|gecos
argument_list|)
expr_stmt|;
name|cp
operator|=
name|cp2
expr_stmt|;
if|if
condition|(
operator|(
name|cp2
operator|=
name|strchr
argument_list|(
name|cp
argument_list|,
literal|':'
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return;
operator|*
name|cp2
operator|++
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|*
name|cp2
condition|)
name|strncpy
argument_list|(
name|shell
argument_list|,
name|cp2
argument_list|,
sizeof|sizeof
name|shell
argument_list|)
expr_stmt|;
block|}
undef|#
directive|undef
name|VEC_UNAME
block|}
end_function

begin_function
specifier|static
name|void
name|addUser
parameter_list|(
name|WINDOW
modifier|*
name|ds_win
parameter_list|)
block|{
name|char
name|tmp
index|[
literal|256
index|]
decl_stmt|,
modifier|*
name|msg
decl_stmt|;
name|int
name|pfd
index|[
literal|2
index|]
decl_stmt|,
name|ipfd
index|[
literal|2
index|]
decl_stmt|,
name|i
decl_stmt|,
name|j
decl_stmt|;
name|ssize_t
name|l
decl_stmt|;
name|size_t
name|amnt
decl_stmt|;
name|pid_t
name|pid
decl_stmt|;
comment|/*      * Maximal list:      * pw user add -m -n uname -g grp -u uid -c comment -d homedir -s shell -G grplist -h 0      */
name|char
modifier|*
name|vec
index|[
literal|21
index|]
init|=
block|{
literal|"pw"
block|,
literal|"user"
block|,
literal|"add"
block|,
literal|"-m"
block|,
literal|"-n"
block|,
comment|/* ... */
block|}
decl_stmt|;
define|#
directive|define
name|VEC_UNAME
value|5
name|msgNotify
argument_list|(
literal|"Adding user \"%s\"..."
argument_list|,
name|uname
argument_list|)
expr_stmt|;
name|pipe
argument_list|(
name|pfd
argument_list|)
expr_stmt|;
name|pipe
argument_list|(
name|ipfd
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pid
operator|=
name|fork
argument_list|()
operator|)
operator|==
literal|0
condition|)
block|{
comment|/* The kiddy. */
name|dup2
argument_list|(
name|ipfd
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|dup2
argument_list|(
name|pfd
index|[
literal|1
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|dup2
argument_list|(
name|pfd
index|[
literal|1
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|getdtablesize
argument_list|()
init|;
name|i
operator|>
literal|2
condition|;
name|i
operator|--
control|)
name|close
argument_list|(
name|i
argument_list|)
expr_stmt|;
name|vec
index|[
name|i
operator|=
name|VEC_UNAME
index|]
operator|=
name|uname
expr_stmt|;
name|i
operator|++
expr_stmt|;
define|#
directive|define
name|ADDVEC
parameter_list|(
name|var
parameter_list|,
name|option
parameter_list|)
value|do { if (strlen(var)> 0) { vec[i++] = option; vec[i++] = var; } } while (0)
name|ADDVEC
argument_list|(
name|ugroup
argument_list|,
literal|"-g"
argument_list|)
expr_stmt|;
name|ADDVEC
argument_list|(
name|uid
argument_list|,
literal|"-u"
argument_list|)
expr_stmt|;
name|ADDVEC
argument_list|(
name|gecos
argument_list|,
literal|"-c"
argument_list|)
expr_stmt|;
name|ADDVEC
argument_list|(
name|homedir
argument_list|,
literal|"-d"
argument_list|)
expr_stmt|;
name|ADDVEC
argument_list|(
name|shell
argument_list|,
literal|"-s"
argument_list|)
expr_stmt|;
name|ADDVEC
argument_list|(
name|umemb
argument_list|,
literal|"-G"
argument_list|)
expr_stmt|;
if|if
condition|(
name|passwd
index|[
literal|0
index|]
condition|)
block|{
name|vec
index|[
name|i
operator|++
index|]
operator|=
literal|"-h"
expr_stmt|;
name|vec
index|[
name|i
operator|++
index|]
operator|=
literal|"0"
expr_stmt|;
block|}
name|vec
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|execv
argument_list|(
literal|"/usr/sbin/pw"
argument_list|,
name|vec
argument_list|)
expr_stmt|;
name|msgDebug
argument_list|(
literal|"Cannot execv() /usr/sbin/pw.\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
literal|99
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* The oldie. */
name|close
argument_list|(
name|pfd
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|ipfd
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|passwd
index|[
literal|0
index|]
condition|)
name|write
argument_list|(
name|ipfd
index|[
literal|1
index|]
argument_list|,
name|passwd
argument_list|,
name|strlen
argument_list|(
name|passwd
argument_list|)
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|ipfd
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|amnt
operator|=
sizeof|sizeof
name|tmp
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
name|l
operator|=
name|read
argument_list|(
name|pfd
index|[
literal|0
index|]
argument_list|,
operator|&
name|tmp
index|[
name|i
index|]
argument_list|,
name|amnt
argument_list|)
operator|)
operator|>
literal|0
condition|)
block|{
name|amnt
operator|-=
name|l
expr_stmt|;
name|i
operator|+=
name|l
expr_stmt|;
if|if
condition|(
name|amnt
operator|==
literal|0
condition|)
block|{
name|close
argument_list|(
name|pfd
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|close
argument_list|(
name|pfd
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|tmp
index|[
name|i
index|]
operator|=
literal|'\0'
expr_stmt|;
name|waitpid
argument_list|(
name|pid
argument_list|,
operator|&
name|i
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|WIFSIGNALED
argument_list|(
name|i
argument_list|)
condition|)
block|{
name|j
operator|=
name|WTERMSIG
argument_list|(
name|i
argument_list|)
expr_stmt|;
name|msg
operator|=
literal|"The `pw' command exited with signal %d.\n"
expr_stmt|;
goto|goto
name|sysfail
goto|;
block|}
elseif|else
if|if
condition|(
operator|(
name|j
operator|=
name|WEXITSTATUS
argument_list|(
name|i
argument_list|)
operator|)
condition|)
block|{
name|i
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|strncmp
argument_list|(
name|tmp
argument_list|,
literal|"pw: "
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
name|i
operator|=
literal|4
expr_stmt|;
name|tmp
index|[
sizeof|sizeof
name|tmp
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
comment|/* sanity */
if|if
condition|(
name|j
operator|==
name|EX_DATAERR
operator|||
name|j
operator|==
name|EX_NOUSER
operator|||
name|j
operator|==
name|EX_SOFTWARE
condition|)
name|msgConfirm
argument_list|(
literal|"The `pw' command exited with an error status.\n"
literal|"Its error message was:\n\n%s"
argument_list|,
operator|&
name|tmp
index|[
name|i
index|]
argument_list|)
expr_stmt|;
else|else
block|{
name|msg
operator|=
literal|"The `pw' command exited with unexpected status %d.\n"
expr_stmt|;
name|sysfail
label|:
name|msgDebug
argument_list|(
name|msg
argument_list|,
name|j
argument_list|)
expr_stmt|;
name|msgDebug
argument_list|(
literal|"Command stdout and stderr was:\n\n%s"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|msgConfirm
argument_list|(
name|msg
argument_list|,
name|j
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
operator|!
name|passwd
index|[
literal|0
index|]
condition|)
name|msgConfirm
argument_list|(
literal|"You will need to enter a password for this user\n"
literal|"later, using the passwd(1) command from the shell.\n\n"
literal|"The account for `%s' is currently still disabled."
argument_list|,
name|uname
argument_list|)
expr_stmt|;
block|}
undef|#
directive|undef
name|VEC_UNAME
undef|#
directive|undef
name|ADDVEC
block|}
end_function

begin_function
name|int
name|userAddUser
parameter_list|(
name|dialogMenuItem
modifier|*
name|self
parameter_list|)
block|{
name|WINDOW
modifier|*
name|ds_win
decl_stmt|,
modifier|*
name|save
decl_stmt|;
name|ComposeObj
modifier|*
name|obj
init|=
name|NULL
decl_stmt|;
name|int
name|n
init|=
literal|0
decl_stmt|,
name|cancel
init|=
name|FALSE
decl_stmt|,
name|ret
decl_stmt|;
name|int
name|max
decl_stmt|,
name|firsttime
init|=
name|TRUE
decl_stmt|,
name|filled
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|RunningAsInit
operator|&&
operator|!
name|strstr
argument_list|(
name|variable_get
argument_list|(
name|SYSTEM_STATE
argument_list|)
argument_list|,
literal|"install"
argument_list|)
condition|)
block|{
name|msgConfirm
argument_list|(
literal|"This option may only be used after the system is installed, sorry!"
argument_list|)
expr_stmt|;
return|return
name|DITEM_FAILURE
return|;
block|}
name|save
operator|=
name|savescr
argument_list|()
expr_stmt|;
name|dialog_clear_norefresh
argument_list|()
expr_stmt|;
comment|/* We need a curses window */
if|if
condition|(
operator|!
operator|(
name|ds_win
operator|=
name|openLayoutDialog
argument_list|(
name|USER_HELPFILE
argument_list|,
literal|" User and Group Management "
argument_list|,
name|USER_DIALOG_X
argument_list|,
name|USER_DIALOG_Y
argument_list|,
name|USER_DIALOG_WIDTH
argument_list|,
name|USER_DIALOG_HEIGHT
argument_list|)
operator|)
condition|)
block|{
name|beep
argument_list|()
expr_stmt|;
name|msgConfirm
argument_list|(
literal|"Cannot open adduser dialog window!!"
argument_list|)
expr_stmt|;
return|return
operator|(
name|DITEM_FAILURE
operator|)
return|;
block|}
comment|/* Draw a user entry box */
name|draw_box
argument_list|(
name|ds_win
argument_list|,
name|USER_DIALOG_Y
operator|+
literal|1
argument_list|,
name|USER_DIALOG_X
operator|+
literal|3
argument_list|,
name|USER_DIALOG_HEIGHT
operator|-
literal|6
argument_list|,
name|USER_DIALOG_WIDTH
operator|-
literal|6
argument_list|,
name|dialog_attr
argument_list|,
name|border_attr
argument_list|)
expr_stmt|;
name|wattrset
argument_list|(
name|ds_win
argument_list|,
name|dialog_attr
argument_list|)
expr_stmt|;
name|mvwaddstr
argument_list|(
name|ds_win
argument_list|,
name|USER_DIALOG_Y
operator|+
literal|1
argument_list|,
name|USER_DIALOG_X
operator|+
literal|22
argument_list|,
literal|" Add a new user "
argument_list|)
expr_stmt|;
name|CLEAR
argument_list|(
name|uname
argument_list|)
expr_stmt|;
name|CLEAR
argument_list|(
name|uid
argument_list|)
expr_stmt|;
name|CLEAR
argument_list|(
name|ugroup
argument_list|)
expr_stmt|;
name|CLEAR
argument_list|(
name|gecos
argument_list|)
expr_stmt|;
name|CLEAR
argument_list|(
name|passwd
argument_list|)
expr_stmt|;
name|CLEAR
argument_list|(
name|umemb
argument_list|)
expr_stmt|;
name|CLEAR
argument_list|(
name|homedir
argument_list|)
expr_stmt|;
name|CLEAR
argument_list|(
name|shell
argument_list|)
expr_stmt|;
comment|/* Some more initialisation before we go into the main input loop */
name|obj
operator|=
name|initLayoutDialog
argument_list|(
name|ds_win
argument_list|,
name|userLayout
argument_list|,
name|USER_DIALOG_X
argument_list|,
name|USER_DIALOG_Y
argument_list|,
operator|&
name|max
argument_list|)
expr_stmt|;
name|reenter
label|:
name|cancelbutton
operator|=
name|okbutton
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|firsttime
condition|)
block|{
comment|/* fill in the blanks, well, just the GID */
name|completeUser
argument_list|()
expr_stmt|;
name|RefreshStringObj
argument_list|(
name|userLayout
index|[
name|LAYOUT_UID
index|]
operator|.
name|obj
argument_list|)
expr_stmt|;
name|RefreshStringObj
argument_list|(
name|userLayout
index|[
name|LAYOUT_UGROUP
index|]
operator|.
name|obj
argument_list|)
expr_stmt|;
name|RefreshStringObj
argument_list|(
name|userLayout
index|[
name|LAYOUT_GECOS
index|]
operator|.
name|obj
argument_list|)
expr_stmt|;
name|RefreshStringObj
argument_list|(
name|userLayout
index|[
name|LAYOUT_UMEMB
index|]
operator|.
name|obj
argument_list|)
expr_stmt|;
name|RefreshStringObj
argument_list|(
name|userLayout
index|[
name|LAYOUT_HOMEDIR
index|]
operator|.
name|obj
argument_list|)
expr_stmt|;
name|RefreshStringObj
argument_list|(
name|userLayout
index|[
name|LAYOUT_SHELL
index|]
operator|.
name|obj
argument_list|)
expr_stmt|;
name|firsttime
operator|=
name|FALSE
expr_stmt|;
block|}
while|while
condition|(
name|layoutDialogLoop
argument_list|(
name|ds_win
argument_list|,
name|userLayout
argument_list|,
operator|&
name|obj
argument_list|,
operator|&
name|n
argument_list|,
name|max
argument_list|,
operator|&
name|cancelbutton
argument_list|,
operator|&
name|cancel
argument_list|)
condition|)
block|{
comment|/* Prevent this from being irritating if user really means NO */
if|if
condition|(
name|filled
operator|<
literal|3
condition|)
block|{
if|if
condition|(
operator|(
name|uname
index|[
literal|0
index|]
operator|)
operator|&&
operator|!
name|homedir
index|[
literal|0
index|]
condition|)
block|{
name|SAFE_STRCPY
argument_list|(
name|homedir
argument_list|,
literal|"/home/"
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|homedir
argument_list|,
name|uname
argument_list|)
expr_stmt|;
name|RefreshStringObj
argument_list|(
name|userLayout
index|[
name|LAYOUT_HOMEDIR
index|]
operator|.
name|obj
argument_list|)
expr_stmt|;
operator|++
name|filled
expr_stmt|;
block|}
block|}
block|}
empty_stmt|;
if|if
condition|(
operator|!
name|cancel
operator|&&
operator|!
name|verifyUserSettings
argument_list|(
name|ds_win
argument_list|)
condition|)
goto|goto
name|reenter
goto|;
comment|/* Clear this crap off the screen */
name|delwin
argument_list|(
name|ds_win
argument_list|)
expr_stmt|;
name|dialog_clear_norefresh
argument_list|()
expr_stmt|;
name|use_helpfile
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cancel
condition|)
block|{
name|addUser
argument_list|(
name|ds_win
argument_list|)
expr_stmt|;
name|ret
operator|=
name|DITEM_SUCCESS
expr_stmt|;
block|}
else|else
name|ret
operator|=
name|DITEM_FAILURE
expr_stmt|;
name|restorescr
argument_list|(
name|save
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

end_unit


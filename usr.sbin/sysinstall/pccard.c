begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * PC-card support for sysinstall  *  * $FreeBSD$  *  * Copyright (c) 1997-1999  *	Tatsumi Hosokawa<hosokawa@jp.FreeBSD.org>.  All rights reserved.  *  * This software may be used, modified, copied, and distributed, in  * both source and binary form provided that the above copyright and  * these terms are retained. Under no circumstances is the author  * responsible for the proper functioning of this software, nor does  * the author assume any responsibility for damages incurred with its  * use.  */
end_comment

begin_include
include|#
directive|include
file|"sysinstall.h"
end_include

begin_include
include|#
directive|include
file|<sys/fcntl.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<pccard/cardinfo.h>
end_include

begin_decl_stmt
name|int
name|pccard_mode
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Set up defines for pccardd interrupt selection.  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|PC98
end_ifdef

begin_define
define|#
directive|define
name|IRQ_COUNT
value|11
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|IRQ_COUNT
value|9
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* PC98 */
end_comment

begin_define
define|#
directive|define
name|IRQ_10
value|0x00001
end_define

begin_define
define|#
directive|define
name|IRQ_11
value|0x00002
end_define

begin_define
define|#
directive|define
name|IRQ_03
value|0x00004
end_define

begin_define
define|#
directive|define
name|IRQ_09
value|0x00008
end_define

begin_define
define|#
directive|define
name|IRQ_04
value|0x00010
end_define

begin_define
define|#
directive|define
name|IRQ_07
value|0x00020
end_define

begin_define
define|#
directive|define
name|IRQ_05
value|0x00040
end_define

begin_define
define|#
directive|define
name|IRQ_06
value|0x00080
end_define

begin_define
define|#
directive|define
name|IRQ_15
value|0x00100
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|PC98
end_ifdef

begin_define
define|#
directive|define
name|IRQ_12
value|0x00200
end_define

begin_define
define|#
directive|define
name|IRQ_13
value|0x00400
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* PC98 */
end_comment

begin_decl_stmt
name|unsigned
name|int
name|CardIrq
decl_stmt|;
end_decl_stmt

begin_typedef
typedef|typedef
struct|struct
name|_irq
block|{
name|char
modifier|*
name|my_name
decl_stmt|;
name|char
modifier|*
name|my_flag
decl_stmt|;
name|unsigned
name|int
name|my_mask
decl_stmt|;
name|unsigned
name|int
name|my_bit
decl_stmt|;
block|}
name|Irq
typedef|;
end_typedef

begin_comment
comment|/* Fill in with potential free IRQs for pccardd */
end_comment

begin_decl_stmt
specifier|static
name|Irq
name|IrqTable
index|[]
init|=
block|{
block|{
literal|"irq_03"
block|,
literal|"-i 3"
block|,
operator|~
name|IRQ_03
block|,
name|IRQ_03
block|}
block|,
block|{
literal|"irq_04"
block|,
literal|"-i 4"
block|,
operator|~
name|IRQ_04
block|,
name|IRQ_04
block|}
block|,
block|{
literal|"irq_05"
block|,
literal|"-i 5"
block|,
operator|~
name|IRQ_05
block|,
name|IRQ_05
block|}
block|,
block|{
literal|"irq_06"
block|,
literal|"-i 6"
block|,
operator|~
name|IRQ_06
block|,
name|IRQ_06
block|}
block|,
block|{
literal|"irq_07"
block|,
literal|"-i 7"
block|,
operator|~
name|IRQ_07
block|,
name|IRQ_07
block|}
block|,
block|{
literal|"irq_09"
block|,
literal|"-i 9"
block|,
operator|~
name|IRQ_09
block|,
name|IRQ_09
block|}
block|,
block|{
literal|"irq_10"
block|,
literal|"-i 10"
block|,
operator|~
name|IRQ_10
block|,
name|IRQ_10
block|}
block|,
block|{
literal|"irq_11"
block|,
literal|"-i 11"
block|,
operator|~
name|IRQ_11
block|,
name|IRQ_11
block|}
block|,
block|{
literal|"irq_15"
block|,
literal|"-i 15"
block|,
operator|~
name|IRQ_15
block|,
name|IRQ_15
block|}
block|,
ifdef|#
directive|ifdef
name|PC98
block|{
literal|"irq_12"
block|,
literal|"-i 12"
block|,
operator|~
name|IRQ_12
block|,
name|IRQ_12
block|}
block|,
block|{
literal|"irq_13"
block|,
literal|"-i 13"
block|,
operator|~
name|IRQ_13
block|,
name|IRQ_13
block|}
block|,
endif|#
directive|endif
comment|/* PC98 */
block|{
name|NULL
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|pccardIrqReset
parameter_list|(
name|dialogMenuItem
modifier|*
name|self
parameter_list|)
block|{
name|CardIrq
operator|=
literal|0
expr_stmt|;
return|return
name|DITEM_SUCCESS
operator||
name|DITEM_REDRAW
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|checkTrue
parameter_list|(
name|dialogMenuItem
modifier|*
name|item
parameter_list|)
block|{
return|return
name|TRUE
return|;
block|}
end_function

begin_decl_stmt
name|DMenu
name|MenuPCICMem
init|=
block|{
name|DMENU_NORMAL_TYPE
operator||
name|DMENU_SELECTION_RETURNS
block|,
literal|"Please select free address area used by PC-card controller"
block|,
literal|"PC-card controller uses memory area to get card information.\n"
literal|"Please specify an address that is not used by other devices.\n"
literal|"If you're uncertain of detailed specification of your hardware,\n"
ifdef|#
directive|ifdef
name|PC98
literal|"leave it untouched (default == 0xd0000).\n"
literal|"If you use PC-9801 P, NS/A, NX/C, NL/R or PC-9821 Ne please \n"
literal|"select [DA] here."
block|,
else|#
directive|else
literal|"leave it untouched (default == 0xd0000)."
block|,
endif|#
directive|endif
comment|/* PC98 */
literal|"Press F1 for more HELP"
block|,
literal|"pccard"
block|,
block|{
block|{
literal|"Default"
block|,
literal|"I/O address 0xd0000 - 0xd3fff"
block|,
name|NULL
block|,
name|dmenuSetVariable
block|,
name|NULL
block|,
literal|"_pcicmem=0"
block|}
block|,
block|{
literal|"D4"
block|,
literal|"I/O address 0xd4000 - 0xd7fff"
block|,
name|NULL
block|,
name|dmenuSetVariable
block|,
name|NULL
block|,
literal|"_pcicmem=1"
block|}
block|,
block|{
literal|"D8"
block|,
literal|"I/O address 0xd8000 - 0xdbfff"
block|,
name|NULL
block|,
name|dmenuSetVariable
block|,
name|NULL
block|,
literal|"_pcicmem=2"
block|}
block|,
block|{
literal|"DC"
block|,
literal|"I/O address 0xdc000 - 0xdffff"
block|,
name|NULL
block|,
name|dmenuSetVariable
block|,
name|NULL
block|,
literal|"_pcicmem=3"
block|}
block|,
ifdef|#
directive|ifdef
name|PC98
block|{
literal|"DA"
block|,
literal|"I/O address 0xda000 - 0xdbfff"
block|,
name|NULL
block|,
name|dmenuSetVariable
block|,
name|NULL
block|,
literal|"_pcicmem=4"
block|}
block|,
endif|#
directive|endif
comment|/* PC98 */
block|{
name|NULL
block|}
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|DMenu
name|MenuCardIRQ
init|=
block|{
name|DMENU_CHECKLIST_TYPE
operator||
name|DMENU_SELECTION_RETURNS
block|,
literal|"Please specify the IRQs that may be used by PC-Cards"
block|,
literal|"(NOTE: remove any cards that will NOT be used for installation).\n"
literal|"The IRQs that you choose must be free (unshared), or you risk \n"
literal|"subpar performance and/or a complete system lockup (choose wisely).\n"
literal|"One way to determine which IRQs are available is to \"cheat\" and\n"
literal|"use the Windows 9x/2000 Device Manager as a reference prior to the\n"
literal|"installation.\n"
block|,
literal|"Select Free IRQ for PC-Cardd"
block|,
name|NULL
block|,
block|{
block|{
literal|"X Exit"
block|,
literal|"Exit this menu"
block|,
name|checkTrue
block|,
name|dmenuExit
block|,
name|NULL
block|,
name|NULL
block|,
literal|'<'
block|,
literal|'<'
block|,
literal|'<'
block|}
block|,
block|{
literal|"Reset"
block|,
literal|"Reset selected IRQ list"
block|,
name|NULL
block|,
name|pccardIrqReset
block|,
name|NULL
block|,
name|NULL
block|,
literal|' '
block|,
literal|' '
block|,
literal|' '
block|}
block|,
ifdef|#
directive|ifdef
name|PC98
block|{
literal|"3 IRQ 3"
block|,
literal|"(INT 0) is 2nd serial port, internal modem"
block|,
name|dmenuFlagCheck
block|,
name|dmenuSetFlag
block|,
name|NULL
block|,
operator|&
name|CardIrq
block|,
literal|'['
block|,
literal|'X'
block|,
literal|']'
block|,
name|IRQ_03
block|}
block|,
block|{
literal|"4 IRQ 5"
block|,
literal|"(INT 1) is Infrared communication, SCSI I/F, (2nd serial)"
block|,
name|dmenuFlagCheck
block|,
name|dmenuSetFlag
block|,
name|NULL
block|,
operator|&
name|CardIrq
block|,
literal|'['
block|,
literal|'X'
block|,
literal|']'
block|,
name|IRQ_05
block|}
block|,
block|{
literal|"5 IRQ 6"
block|,
literal|"(INT 2) is PC-card Controller"
block|,
name|dmenuFlagCheck
block|,
name|dmenuSetFlag
block|,
name|NULL
block|,
operator|&
name|CardIrq
block|,
literal|'['
block|,
literal|'X'
block|,
literal|']'
block|,
name|IRQ_06
block|}
block|,
block|{
literal|"6 IRQ 9"
block|,
literal|"(INT 3) is IDE disk Controller"
block|,
name|dmenuFlagCheck
block|,
name|dmenuSetFlag
block|,
name|NULL
block|,
operator|&
name|CardIrq
block|,
literal|'['
block|,
literal|'X'
block|,
literal|']'
block|,
name|IRQ_09
block|}
block|,
block|{
literal|"7 IRQ 10"
block|,
literal|"(INT 41) is often free"
block|,
name|dmenuFlagCheck
block|,
name|dmenuSetFlag
block|,
name|NULL
block|,
operator|&
name|CardIrq
block|,
literal|'['
block|,
literal|'X'
block|,
literal|']'
block|,
name|IRQ_10
block|}
block|,
block|{
literal|"8 IRQ 12"
block|,
literal|"(INT 5) is Internal sound"
block|,
name|dmenuFlagCheck
block|,
name|dmenuSetFlag
block|,
name|NULL
block|,
operator|&
name|CardIrq
block|,
literal|'['
block|,
literal|'X'
block|,
literal|']'
block|,
name|IRQ_12
block|}
block|,
block|{
literal|"9 IRQ 13"
block|,
literal|"(INT 6) is Bus Mouse"
block|,
name|dmenuFlagCheck
block|,
name|dmenuSetFlag
block|,
name|NULL
block|,
operator|&
name|CardIrq
block|,
literal|'['
block|,
literal|'X'
block|,
literal|']'
block|,
name|IRQ_13
block|}
block|,
else|#
directive|else
block|{
literal|"3 IRQ 10"
block|,
literal|"IRQ 10 is often free (verify in BIOS)"
block|,
name|dmenuFlagCheck
block|,
name|dmenuSetFlag
block|,
name|NULL
block|,
operator|&
name|CardIrq
block|,
literal|'['
block|,
literal|'X'
block|,
literal|']'
block|,
name|IRQ_10
block|}
block|,
block|{
literal|"4 IRQ 11"
block|,
literal|"Verify IRQ 11 is not being used as PCI shared interrupt"
block|,
name|dmenuFlagCheck
block|,
name|dmenuSetFlag
block|,
name|NULL
block|,
operator|&
name|CardIrq
block|,
literal|'['
block|,
literal|'X'
block|,
literal|']'
block|,
name|IRQ_11
block|}
block|,
block|{
literal|"5 IRQ 3"
block|,
literal|"IRQ 3 is often free in most laptops"
block|,
name|dmenuFlagCheck
block|,
name|dmenuSetFlag
block|,
name|NULL
block|,
operator|&
name|CardIrq
block|,
literal|'['
block|,
literal|'X'
block|,
literal|']'
block|,
name|IRQ_03
block|}
block|,
block|{
literal|"6 IRQ 9"
block|,
literal|"IRQ 9 may be used by video or sound or USB"
block|,
name|dmenuFlagCheck
block|,
name|dmenuSetFlag
block|,
name|NULL
block|,
operator|&
name|CardIrq
block|,
literal|'['
block|,
literal|'X'
block|,
literal|']'
block|,
name|IRQ_09
block|}
block|,
block|{
literal|"7 IRQ 4"
block|,
literal|"IRQ 4, usually COM1 (disable in BIOS to make free)"
block|,
name|dmenuFlagCheck
block|,
name|dmenuSetFlag
block|,
name|NULL
block|,
operator|&
name|CardIrq
block|,
literal|'['
block|,
literal|'X'
block|,
literal|']'
block|,
name|IRQ_04
block|}
block|,
block|{
literal|"8 IRQ 7"
block|,
literal|"IRQ 7, usually LPT1 (disable in BIOS to make free)"
block|,
name|dmenuFlagCheck
block|,
name|dmenuSetFlag
block|,
name|NULL
block|,
operator|&
name|CardIrq
block|,
literal|'['
block|,
literal|'X'
block|,
literal|']'
block|,
name|IRQ_07
block|}
block|,
block|{
literal|"9 IRQ 5"
block|,
literal|"IRQ 5, usually ISA Audio (disable in BIOS to make free)"
block|,
name|dmenuFlagCheck
block|,
name|dmenuSetFlag
block|,
name|NULL
block|,
operator|&
name|CardIrq
block|,
literal|'['
block|,
literal|'X'
block|,
literal|']'
block|,
name|IRQ_05
block|}
block|,
block|{
literal|"10 IRQ 15"
block|,
literal|"IRQ 15, usually Secondary IDE channel"
block|,
name|dmenuFlagCheck
block|,
name|dmenuSetFlag
block|,
name|NULL
block|,
operator|&
name|CardIrq
block|,
literal|'['
block|,
literal|'X'
block|,
literal|']'
block|,
name|IRQ_15
block|}
block|,
block|{
literal|"11 IRQ 6"
block|,
literal|"IRQ 6 will be free if laptop only has USB floppy drive"
block|,
name|dmenuFlagCheck
block|,
name|dmenuSetFlag
block|,
name|NULL
block|,
operator|&
name|CardIrq
block|,
literal|'['
block|,
literal|'X'
block|,
literal|']'
block|,
name|IRQ_06
block|}
block|,
endif|#
directive|endif
comment|/* PC98 */
block|{
name|NULL
block|}
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|pccardInitialize
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|fd
decl_stmt|;
name|int
name|t
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|pcic_mem
init|=
literal|0xd0000
decl_stmt|;
name|int
name|beep_newstat
decl_stmt|;
name|char
name|card_device
index|[
literal|16
index|]
decl_stmt|;
name|char
name|card_irq
index|[
literal|256
index|]
init|=
literal|""
decl_stmt|;
name|char
name|temp
index|[
literal|256
index|]
decl_stmt|;
name|char
modifier|*
name|spcic_mem
decl_stmt|;
name|char
name|pccardd_cmd
index|[
literal|256
index|]
decl_stmt|;
name|WINDOW
modifier|*
name|w
decl_stmt|;
name|pccard_mode
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|RunningAsInit
operator|&&
operator|!
name|Fake
condition|)
block|{
comment|/* It's not my job... */
return|return;
block|}
name|sprintf
argument_list|(
name|card_device
argument_list|,
name|CARD_DEVICE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fd
operator|=
name|open
argument_list|(
name|card_device
argument_list|,
name|O_RDWR
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|msgDebug
argument_list|(
literal|"Can't open PC-card controller %s.\n"
argument_list|,
name|card_device
argument_list|)
expr_stmt|;
return|return;
block|}
elseif|else
if|if
condition|(
name|msgYesNo
argument_list|(
literal|"Found PC-card slot(s).\n"
literal|"Use PC-card device as installation media?\n"
argument_list|)
condition|)
block|{
return|return;
block|}
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|variable_set2
argument_list|(
literal|"_pccard_install"
argument_list|,
literal|"YES"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|dmenuOpenSimple
argument_list|(
operator|&
name|MenuPCICMem
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|spcic_mem
operator|=
name|variable_get
argument_list|(
literal|"_pcicmem"
argument_list|)
expr_stmt|;
name|dmenuOpenSimple
argument_list|(
operator|&
name|MenuCardIRQ
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|sscanf
argument_list|(
name|spcic_mem
argument_list|,
literal|"%d"
argument_list|,
operator|&
name|t
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|t
condition|)
block|{
case|case
literal|0
case|:
name|pcic_mem
operator|=
literal|0xd0000
expr_stmt|;
name|variable_set2
argument_list|(
literal|"pccard_mem"
argument_list|,
literal|"DEFAULT"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|pcic_mem
operator|=
literal|0xd4000
expr_stmt|;
name|variable_set2
argument_list|(
literal|"pccard_mem"
argument_list|,
literal|"0xd4000"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|pcic_mem
operator|=
literal|0xd8000
expr_stmt|;
name|variable_set2
argument_list|(
literal|"pccard_mem"
argument_list|,
literal|"0xd8000"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|pcic_mem
operator|=
literal|0xdc000
expr_stmt|;
name|variable_set2
argument_list|(
literal|"pccard_mem"
argument_list|,
literal|"0xdc000"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|PC98
case|case
literal|4
case|:
name|pcic_mem
operator|=
literal|0xda000
expr_stmt|;
name|variable_set2
argument_list|(
literal|"pccard_mem"
argument_list|,
literal|"0xda000"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* PC98 */
block|}
comment|/* get card_irq out of CardIrq somehow */
if|if
condition|(
name|CardIrq
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|IRQ_COUNT
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|CardIrq
operator|&
name|IrqTable
index|[
name|i
index|]
operator|.
name|my_bit
operator|)
operator|!=
literal|0
condition|)
block|{
name|sprintf
argument_list|(
name|temp
argument_list|,
literal|"%s %s"
argument_list|,
name|card_irq
argument_list|,
name|IrqTable
index|[
name|i
index|]
operator|.
name|my_flag
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|card_irq
argument_list|,
name|temp
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|w
operator|=
name|savescr
argument_list|()
expr_stmt|;
name|dialog_clear_norefresh
argument_list|()
expr_stmt|;
name|msgConfirm
argument_list|(
literal|"Now we start initializing PC-card controller and cards.\n"
literal|"If you've executed this installer from a PC-card floppy\n"
literal|"drive, this is the last chance to replace it with\n"
literal|"installation media (PC-card Ethernet, CDROM, etc.).\n"
literal|"Please insert installation media and press [Enter].\n"
literal|"If you've not plugged the PC-card installation media\n"
literal|"in yet, please plug it in now and press [Enter].\n"
literal|"Otherwise, just press [Enter] to proceed."
argument_list|)
expr_stmt|;
name|dialog_clear
argument_list|()
expr_stmt|;
name|msgNotify
argument_list|(
literal|"Initializing PC-card controller...."
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|Fake
condition|)
block|{
if|if
condition|(
operator|(
name|fd
operator|=
name|open
argument_list|(
name|card_device
argument_list|,
name|O_RDWR
argument_list|)
operator|)
operator|<
literal|1
condition|)
block|{
name|msgNotify
argument_list|(
literal|"Can't open PC-card controller %s.\n"
argument_list|,
name|card_device
argument_list|)
expr_stmt|;
name|restorescr
argument_list|(
name|w
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|PIOCRWMEM
argument_list|,
operator|&
name|pcic_mem
argument_list|)
operator|<
literal|0
condition|)
block|{
name|msgNotify
argument_list|(
literal|"ioctl %s failed.\n"
argument_list|,
name|card_device
argument_list|)
expr_stmt|;
name|restorescr
argument_list|(
name|w
argument_list|)
expr_stmt|;
return|return;
block|}
name|beep_newstat
operator|=
literal|2
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|PIOCSBEEP
argument_list|,
operator|&
name|beep_newstat
argument_list|)
operator|<
literal|0
condition|)
block|{
name|msgNotify
argument_list|(
literal|"Warning: unable to set pccard insertion beep type for %s"
argument_list|,
name|card_device
argument_list|)
expr_stmt|;
name|restorescr
argument_list|(
name|w
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|strcpy
argument_list|(
name|pccardd_cmd
argument_list|,
literal|"/stand/pccardd "
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|pccardd_cmd
argument_list|,
name|card_irq
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|pccardd_cmd
argument_list|,
literal|" -z"
argument_list|)
expr_stmt|;
name|variable_set2
argument_list|(
literal|"pccardd_flags"
argument_list|,
name|card_irq
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|variable_set2
argument_list|(
literal|"pccard_enable"
argument_list|,
literal|"YES"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|vsystem
argument_list|(
name|pccardd_cmd
argument_list|)
expr_stmt|;
name|restorescr
argument_list|(
name|w
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/***************************************************************  *   * Program:	pkg_ui.c  * Author:	Marc van Kempen  * Desc:	user interface parts of pkg_manage  *  * Copyright (c) 1995, Marc van Kempen  *  * All rights reserved.  *  * This software may be used, modified, copied, distributed, and  * sold, in both source and binary form provided that the above  * copyright and these terms are retained, verbatim, as the first  * lines of this file.  Under no circumstances is the author  * responsible for the proper functioning of this software, nor does  * the author assume any responsibility for damages incurred with  * its use.  *   ***************************************************************/
end_comment

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|"pkg_manage.h"
end_include

begin_include
include|#
directive|include
file|"dir.h"
end_include

begin_include
include|#
directive|include
file|"dialog.priv.h"
end_include

begin_include
include|#
directive|include
file|"ui_objects.h"
end_include

begin_decl_stmt
specifier|extern
name|PKG_info
name|p_inf
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|StartDir
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Local prototypes  */
end_comment

begin_function_decl
name|void
name|install_pkgs_indir
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * Functions  */
end_comment

begin_function
name|void
name|view_installed
parameter_list|(
name|void
parameter_list|)
comment|/*  * Desc: View the installed packages  */
block|{
name|int
name|i
decl_stmt|,
name|quit_view
decl_stmt|,
name|sc
init|=
literal|0
decl_stmt|,
name|ch
init|=
literal|0
decl_stmt|;
name|char
name|selection
index|[
literal|1024
index|]
decl_stmt|;
if|if
condition|(
name|p_inf
operator|.
name|Nitems
operator|==
literal|0
condition|)
block|{
name|use_helpfile
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|use_helpline
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|dialog_notify
argument_list|(
literal|"No packages installed or no info available"
argument_list|)
expr_stmt|;
return|return;
block|}
name|use_helpfile
argument_list|(
name|VIEW_INST_HLP
argument_list|)
expr_stmt|;
name|quit_view
operator|=
name|FALSE
expr_stmt|;
while|while
condition|(
operator|!
name|quit_view
condition|)
block|{
name|use_helpline
argument_list|(
literal|"F1=help, use arrow-keys or character to select option and press enter"
argument_list|)
expr_stmt|;
if|if
condition|(
name|dialog_menu
argument_list|(
literal|"View installed packages"
argument_list|,
literal|"Press enter to see the package descriptions"
argument_list|,
name|LINES
argument_list|,
name|COLS
argument_list|,
name|LINES
operator|-
literal|5
argument_list|,
name|p_inf
operator|.
name|Nitems
argument_list|,
name|p_inf
operator|.
name|mnu
argument_list|,
name|selection
argument_list|,
operator|&
name|ch
argument_list|,
operator|&
name|sc
argument_list|)
condition|)
block|{
name|quit_view
operator|=
name|TRUE
expr_stmt|;
block|}
else|else
block|{
name|i
operator|=
name|get_pkg_index
argument_list|(
name|selection
argument_list|)
expr_stmt|;
name|use_helpline
argument_list|(
literal|"F1=help, use PgUp and PgDn and arrow-keys to move through the text"
argument_list|)
expr_stmt|;
name|dialog_mesgbox
argument_list|(
name|p_inf
operator|.
name|comment
index|[
name|i
index|]
argument_list|,
name|p_inf
operator|.
name|description
index|[
name|i
index|]
argument_list|,
name|LINES
argument_list|,
name|COLS
argument_list|)
expr_stmt|;
block|}
block|}
name|use_helpfile
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|use_helpline
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/* view_installed() */
end_comment

begin_function
name|void
name|delete_installed
parameter_list|(
name|void
parameter_list|)
comment|/*  * Desc: Delete an installed package  */
block|{
name|unsigned
name|char
modifier|*
name|mnu
index|[]
init|=
block|{
literal|"1. Simulate delete"
block|,
literal|"Display commands that are going to be executed"
block|,
literal|"2. Delete"
block|,
literal|"Execute commands to delete the package"
block|,
literal|"3. Cancel"
block|,
literal|"Do NOT delete the package"
block|}
decl_stmt|;
name|char
name|tmp
index|[
literal|512
index|]
decl_stmt|,
name|args
index|[
literal|512
index|]
decl_stmt|,
name|selection
index|[
literal|512
index|]
decl_stmt|,
modifier|*
name|tmp_file
decl_stmt|;
name|int
name|quit_view
decl_stmt|,
name|quit_del
decl_stmt|;
name|int
name|i
decl_stmt|,
name|sel
decl_stmt|,
name|ch
init|=
literal|0
decl_stmt|,
name|sc
init|=
literal|0
decl_stmt|,
name|ch0
init|=
literal|0
decl_stmt|,
name|sc0
init|=
literal|0
decl_stmt|,
name|ret
decl_stmt|;
if|if
condition|(
name|p_inf
operator|.
name|Nitems
operator|==
literal|0
condition|)
block|{
name|use_helpfile
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|use_helpline
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|dialog_notify
argument_list|(
literal|"No packages installed or no info available"
argument_list|)
expr_stmt|;
return|return;
block|}
name|quit_view
operator|=
name|FALSE
expr_stmt|;
while|while
condition|(
operator|!
name|quit_view
condition|)
block|{
name|use_helpline
argument_list|(
literal|"F1=help, use arrow-keys or character to select option and press enter"
argument_list|)
expr_stmt|;
name|use_helpfile
argument_list|(
name|DEL_INST_HLP
argument_list|)
expr_stmt|;
if|if
condition|(
name|dialog_menu
argument_list|(
literal|"DELETE an installed package"
argument_list|,
literal|"Press enter to select a package"
argument_list|,
name|LINES
argument_list|,
name|COLS
argument_list|,
name|LINES
operator|-
literal|5
argument_list|,
name|p_inf
operator|.
name|Nitems
argument_list|,
name|p_inf
operator|.
name|mnu
argument_list|,
name|selection
argument_list|,
operator|&
name|ch
argument_list|,
operator|&
name|sc
argument_list|)
condition|)
block|{
name|quit_view
operator|=
name|TRUE
expr_stmt|;
block|}
else|else
block|{
name|quit_del
operator|=
name|FALSE
expr_stmt|;
name|i
operator|=
name|get_pkg_index
argument_list|(
name|selection
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
name|quit_del
condition|)
block|{
name|sprintf
argument_list|(
name|tmp
argument_list|,
literal|"Delete<%s>"
argument_list|,
name|p_inf
operator|.
name|name
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|use_helpline
argument_list|(
literal|"F1=help, use arrow-keys or digit to select option and press enter"
argument_list|)
expr_stmt|;
if|if
condition|(
name|dialog_menu
argument_list|(
literal|"Delete a package"
argument_list|,
name|tmp
argument_list|,
literal|10
argument_list|,
name|COLS
operator|-
literal|6
argument_list|,
literal|3
argument_list|,
literal|3
argument_list|,
name|mnu
argument_list|,
name|selection
argument_list|,
operator|&
name|ch0
argument_list|,
operator|&
name|sc0
argument_list|)
condition|)
block|{
name|quit_del
operator|=
name|TRUE
expr_stmt|;
block|}
else|else
block|{
name|sel
operator|=
name|atoi
argument_list|(
name|selection
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|sel
condition|)
block|{
case|case
literal|1
case|:
name|tmp_file
operator|=
name|tempnam
argument_list|(
name|NULL
argument_list|,
literal|"pkg."
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|args
argument_list|,
literal|"-n %s"
argument_list|,
name|p_inf
operator|.
name|name
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|ret
operator|=
name|exec_catch_errors
argument_list|(
name|PKG_DELETE
argument_list|,
name|args
argument_list|,
name|tmp_file
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
block|{
name|dialog_textbox
argument_list|(
literal|"Package deletion commands"
argument_list|,
name|tmp_file
argument_list|,
name|LINES
argument_list|,
name|COLS
argument_list|)
expr_stmt|;
block|}
name|unlink
argument_list|(
name|tmp_file
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|tmp_file
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|exec_catch_errors
argument_list|(
name|PKG_DELETE
argument_list|,
name|p_inf
operator|.
name|name
index|[
name|i
index|]
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|get_pkginfo
argument_list|()
expr_stmt|;
if|if
condition|(
name|ch
operator|>=
name|p_inf
operator|.
name|Nitems
condition|)
block|{
comment|/* adjust pointers */
name|ch
operator|=
name|p_inf
operator|.
name|Nitems
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|sc
operator|>
name|ch
condition|)
name|sc
operator|=
name|ch
expr_stmt|;
block|}
name|quit_del
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|p_inf
operator|.
name|Nitems
operator|==
literal|0
condition|)
block|{
comment|/* Quit 'delete-installed' when no packages available */
name|quit_view
operator|=
name|TRUE
expr_stmt|;
block|}
break|break;
case|case
literal|3
case|:
name|quit_del
operator|=
name|TRUE
expr_stmt|;
break|break;
block|}
block|}
block|}
block|}
block|}
name|use_helpfile
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|use_helpline
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/* delete_installed() */
end_comment

begin_function
name|void
name|preview_pkg
parameter_list|(
name|void
parameter_list|)
comment|/*   * Desc: View the package description and comment before installation  */
block|{
name|char
modifier|*
name|fname
decl_stmt|,
modifier|*
name|tmp_file
decl_stmt|;
name|char
name|args
index|[
literal|512
index|]
decl_stmt|,
name|title
index|[
literal|512
index|]
decl_stmt|;
name|int
name|err
decl_stmt|;
name|use_helpfile
argument_list|(
name|PREVIEW_FS_HLP
argument_list|)
expr_stmt|;
name|use_helpline
argument_list|(
literal|"Select package to preview"
argument_list|)
expr_stmt|;
name|fname
operator|=
name|dialog_fselect
argument_list|(
name|StartDir
condition|?
name|StartDir
else|:
literal|"."
argument_list|,
literal|"*.tgz"
argument_list|)
expr_stmt|;
while|while
condition|(
name|fname
condition|)
block|{
name|use_helpfile
argument_list|(
name|PREVIEW_HLP
argument_list|)
expr_stmt|;
name|use_helpline
argument_list|(
literal|"use PgUp and PgDn and arrow-keys to move through the text"
argument_list|)
expr_stmt|;
name|tmp_file
operator|=
name|tempnam
argument_list|(
name|NULL
argument_list|,
literal|"pkg."
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tmp_file
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"preview_pkg: Could not allocate space for tmp_file\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
name|sprintf
argument_list|(
name|args
argument_list|,
literal|"-n %s"
argument_list|,
name|fname
argument_list|)
expr_stmt|;
name|err
operator|=
name|exec_catch_errors
argument_list|(
name|PKG_ADD
argument_list|,
name|args
argument_list|,
name|tmp_file
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|err
condition|)
block|{
name|sprintf
argument_list|(
name|title
argument_list|,
literal|"Preview package<%s>"
argument_list|,
name|fname
argument_list|)
expr_stmt|;
name|dialog_textbox
argument_list|(
name|title
argument_list|,
name|tmp_file
argument_list|,
name|LINES
argument_list|,
name|COLS
argument_list|)
expr_stmt|;
block|}
name|unlink
argument_list|(
name|tmp_file
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|fname
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|tmp_file
argument_list|)
expr_stmt|;
name|use_helpfile
argument_list|(
name|PREVIEW_FS_HLP
argument_list|)
expr_stmt|;
name|use_helpline
argument_list|(
literal|"Select package to preview"
argument_list|)
expr_stmt|;
name|fname
operator|=
name|dialog_fselect
argument_list|(
name|StartDir
condition|?
name|StartDir
else|:
literal|"."
argument_list|,
literal|"*.tgz"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fname
condition|)
name|free
argument_list|(
name|fname
argument_list|)
expr_stmt|;
name|use_helpfile
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|use_helpline
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/* preview_pkg() */
end_comment

begin_function
name|void
name|install_batch
parameter_list|(
name|void
parameter_list|)
comment|/*  * Desc: Get the directory from which to list and install packages  */
block|{
name|int
name|quit
decl_stmt|;
name|use_helpfile
argument_list|(
name|DS_INSTALL_HLP
argument_list|)
expr_stmt|;
name|quit
operator|=
name|FALSE
expr_stmt|;
while|while
condition|(
operator|!
name|quit
condition|)
block|{
if|if
condition|(
name|StartDir
condition|)
name|install_pkgs_indir
argument_list|()
expr_stmt|;
else|else
block|{
name|use_helpline
argument_list|(
literal|"Select directory where the pkg's reside"
argument_list|)
expr_stmt|;
if|if
condition|(
name|dialog_dselect
argument_list|(
literal|"."
argument_list|,
literal|"*.tgz"
argument_list|)
condition|)
name|quit
operator|=
name|TRUE
expr_stmt|;
else|else
name|install_pkgs_indir
argument_list|()
expr_stmt|;
block|}
block|}
return|return;
block|}
end_function

begin_comment
comment|/* install_batch() */
end_comment

begin_function
name|void
name|install_pkgs_indir
parameter_list|(
name|void
parameter_list|)
comment|/*  * Desc: install several packages.   */
block|{
name|WINDOW
modifier|*
name|pkg_win
decl_stmt|,
modifier|*
name|w
decl_stmt|,
modifier|*
name|tmpwin
decl_stmt|;
name|DirList
modifier|*
name|d
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
modifier|*
name|fnames
decl_stmt|,
name|o_pkg
index|[
name|MAXPATHLEN
index|]
decl_stmt|,
name|o_pkgi
index|[
name|MAXPATHLEN
index|]
decl_stmt|,
modifier|*
modifier|*
name|comment
decl_stmt|,
modifier|*
modifier|*
name|desc
decl_stmt|,
modifier|*
modifier|*
name|names
decl_stmt|,
name|msg
index|[
literal|512
index|]
decl_stmt|;
name|int
name|n
decl_stmt|,
name|nf
decl_stmt|,
name|i
decl_stmt|,
name|p
decl_stmt|,
name|quit
decl_stmt|,
name|j
decl_stmt|,
modifier|*
name|a
decl_stmt|,
name|recalc
decl_stmt|;
name|struct
name|ComposeObj
modifier|*
name|obj
init|=
name|NULL
decl_stmt|;
name|ListObj
modifier|*
name|pkg_obj
decl_stmt|,
modifier|*
name|pkgi_obj
decl_stmt|;
name|ButtonObj
modifier|*
name|installbut_obj
decl_stmt|,
modifier|*
name|cancelbut_obj
decl_stmt|;
name|int
name|o_installbut
decl_stmt|,
name|o_cancelbut
decl_stmt|,
name|install
decl_stmt|;
name|long
name|total_marked
init|=
literal|0
decl_stmt|,
modifier|*
name|sizes
decl_stmt|;
name|char
modifier|*
name|tmp_file
decl_stmt|,
name|tmp_dir
index|[
name|MAXPATHLEN
index|]
decl_stmt|;
comment|/* list all packages in the current directory with a short description of        the package. Pressing enter should give more info about a specific        package. */
comment|/* save current window */
name|tmpwin
operator|=
name|dupwin
argument_list|(
name|newscr
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmpwin
operator|==
name|NULL
condition|)
block|{
name|endwin
argument_list|()
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\ninstall_pkgs_indir: dupwin(newscr) failed\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|use_helpline
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|pkg_win
operator|=
name|newwin
argument_list|(
name|LINES
operator|-
literal|4
argument_list|,
name|COLS
operator|-
literal|12
argument_list|,
literal|2
argument_list|,
literal|5
argument_list|)
expr_stmt|;
if|if
condition|(
name|pkg_win
operator|==
name|NULL
condition|)
block|{
name|endwin
argument_list|()
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\nnewwin(%d,%d,%d,%d) failed, maybe wrong dims\n"
argument_list|,
name|LINES
operator|-
literal|4
argument_list|,
name|COLS
operator|-
literal|10
argument_list|,
literal|2
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|draw_box
argument_list|(
name|pkg_win
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|LINES
operator|-
literal|4
argument_list|,
name|COLS
operator|-
literal|12
argument_list|,
name|dialog_attr
argument_list|,
name|border_attr
argument_list|)
expr_stmt|;
name|wattrset
argument_list|(
name|pkg_win
argument_list|,
name|dialog_attr
argument_list|)
expr_stmt|;
name|mvwaddstr
argument_list|(
name|pkg_win
argument_list|,
literal|0
argument_list|,
operator|(
name|COLS
operator|-
literal|12
operator|)
operator|/
literal|2
operator|-
literal|12
argument_list|,
literal|" Install multiple packages "
argument_list|)
expr_stmt|;
name|draw_shadow
argument_list|(
name|stdscr
argument_list|,
literal|2
argument_list|,
literal|5
argument_list|,
name|LINES
operator|-
literal|4
argument_list|,
name|COLS
operator|-
literal|12
argument_list|)
expr_stmt|;
name|use_helpline
argument_list|(
literal|"Enter,F2=info, Space=mark, *=mark all, -=unmark all, TAB=move"
argument_list|)
expr_stmt|;
name|display_helpline
argument_list|(
name|pkg_win
argument_list|,
name|LINES
operator|-
literal|5
argument_list|,
name|COLS
operator|-
literal|12
argument_list|)
expr_stmt|;
name|wrefresh
argument_list|(
name|pkg_win
argument_list|)
expr_stmt|;
comment|/* now build a list of the packages in the chosen directory */
comment|/* and display them in a list */
name|get_dir
argument_list|(
name|StartDir
condition|?
name|StartDir
else|:
literal|"."
argument_list|,
literal|"*.tgz"
argument_list|,
operator|&
name|d
argument_list|,
operator|&
name|n
argument_list|)
expr_stmt|;
name|get_filenames
argument_list|(
name|d
argument_list|,
name|n
argument_list|,
operator|&
name|fnames
argument_list|,
operator|&
name|nf
argument_list|)
expr_stmt|;
name|FreeDir
argument_list|(
name|d
argument_list|,
name|n
argument_list|)
expr_stmt|;
comment|/* free the space allocated to d */
comment|/* now get the description and comment and the name from the packages.  */
comment|/* If there is  no +COMMENT or +DESC in the package, then it's propably */
comment|/* not a package 							    */
if|if
condition|(
name|nf
operator|==
literal|0
condition|)
block|{
name|dialog_notify
argument_list|(
literal|"No installable packages in this directory"
argument_list|)
expr_stmt|;
return|return;
block|}
name|names
operator|=
operator|(
name|char
operator|*
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
operator|*
name|nf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|names
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"install_batch(): Error mallocing space for names\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
name|comment
operator|=
operator|(
name|char
operator|*
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
operator|*
name|nf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|comment
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"install_batch(): Error malloc'ing space for comment\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
name|desc
operator|=
operator|(
name|char
operator|*
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
operator|*
name|nf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|desc
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"install_batch(): Error malloc'ing space for desc\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
name|sizes
operator|=
operator|(
name|long
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|long
argument_list|)
operator|*
name|nf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sizes
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"install_batch(): Error malloc'ing space for desc\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* get_desc extracts the info from the file names[i] and puts the */
comment|/* comment in comment[i] and the description in desc[i], space is */
comment|/* malloc'ed as needed, and should be freed when done with it.    */
comment|/* get_desc() returns FALSE when fnames[i] is not a package       */
comment|/* the name of the package is extracted from CONTENT and put in   */
comment|/* names */
comment|/* create a tmp directory in which the files will be extracted */
name|tmp_file
operator|=
name|tempnam
argument_list|(
literal|""
argument_list|,
literal|"pkg."
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tmp_file
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"install_batch(): Error malloc'ing space for tmpfile\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|getenv
argument_list|(
literal|"TMPDIR"
argument_list|)
condition|)
block|{
name|sprintf
argument_list|(
name|tmp_dir
argument_list|,
literal|"%s/%s"
argument_list|,
name|getenv
argument_list|(
literal|"TMP_DIR"
argument_list|)
argument_list|,
name|tmp_file
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|sprintf
argument_list|(
name|tmp_dir
argument_list|,
literal|"/tmp/%s"
argument_list|,
name|tmp_file
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|tmp_file
argument_list|)
expr_stmt|;
if|if
condition|(
name|mkdir
argument_list|(
name|tmp_dir
argument_list|,
name|S_IRWXU
argument_list|)
condition|)
block|{
name|dialog_notify
argument_list|(
literal|"Could not create temporary directory in /tmp, exiting"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|names
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|comment
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|desc
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nf
condition|;
name|i
operator|++
control|)
name|free
argument_list|(
name|fnames
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|fnames
argument_list|)
expr_stmt|;
name|delwin
argument_list|(
name|pkg_win
argument_list|)
expr_stmt|;
return|return;
block|}
name|w
operator|=
name|dupwin
argument_list|(
name|curscr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|w
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"install_batch(): Error malloc'ing new window\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
name|a
operator|=
operator|(
name|int
operator|*
operator|)
name|malloc
argument_list|(
name|nf
operator|*
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
name|j
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nf
condition|;
name|i
operator|++
control|)
block|{
name|dialog_gauge
argument_list|(
literal|"Scanning directory:"
argument_list|,
name|fnames
index|[
name|i
index|]
argument_list|,
name|LINES
operator|/
literal|2
operator|-
literal|3
argument_list|,
name|COLS
operator|/
literal|2
operator|-
literal|30
argument_list|,
literal|7
argument_list|,
literal|60
argument_list|,
call|(
name|int
call|)
argument_list|(
call|(
name|float
call|)
argument_list|(
name|i
operator|+
literal|1
argument_list|)
operator|/
name|nf
operator|*
literal|100
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|get_desc
argument_list|(
name|fnames
index|[
name|i
index|]
argument_list|,
operator|&
operator|(
name|names
index|[
name|i
index|]
operator|)
argument_list|,
operator|&
operator|(
name|comment
index|[
name|i
index|]
operator|)
argument_list|,
operator|&
operator|(
name|desc
index|[
name|i
index|]
operator|)
argument_list|,
operator|&
operator|(
name|sizes
index|[
name|i
index|]
operator|)
argument_list|,
name|tmp_dir
argument_list|)
operator|==
name|FALSE
condition|)
block|{
name|a
index|[
name|j
index|]
operator|=
name|i
expr_stmt|;
name|j
operator|++
expr_stmt|;
block|}
block|}
name|wrefresh
argument_list|(
name|w
argument_list|)
expr_stmt|;
name|delwin
argument_list|(
name|w
argument_list|)
expr_stmt|;
comment|/* remove the tmp directory and change to the previous directory */
if|if
condition|(
name|rmdir
argument_list|(
name|tmp_dir
argument_list|)
condition|)
block|{
name|dialog_notify
argument_list|(
literal|"install_batch(): Error removing temporary directory"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nf
condition|;
name|i
operator|++
control|)
block|{
name|free
argument_list|(
name|fnames
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|names
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|comment
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|desc
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|fnames
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|names
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|comment
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|desc
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|sizes
argument_list|)
expr_stmt|;
name|delwin
argument_list|(
name|pkg_win
argument_list|)
expr_stmt|;
block|}
comment|/* Now we should have an array with indices of filenames that are not */
comment|/* packages, say a[0..k), 0<=k<=n, and the filenames itself           */
comment|/* remove the non-packages from the array 				  */
name|i
operator|=
literal|0
expr_stmt|;
name|p
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|i
operator|+
name|p
operator|<
name|nf
condition|)
block|{
if|if
condition|(
operator|(
name|i
operator|+
name|p
operator|==
name|a
index|[
name|p
index|]
operator|)
operator|&&
operator|(
name|p
operator|<
name|j
operator|)
condition|)
block|{
name|free
argument_list|(
name|fnames
index|[
name|i
operator|+
name|p
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|names
index|[
name|i
operator|+
name|p
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|comment
index|[
name|i
operator|+
name|p
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|desc
index|[
name|i
operator|+
name|p
index|]
argument_list|)
expr_stmt|;
name|p
operator|++
expr_stmt|;
block|}
else|else
block|{
name|fnames
index|[
name|i
index|]
operator|=
name|fnames
index|[
name|i
operator|+
name|p
index|]
expr_stmt|;
name|names
index|[
name|i
index|]
operator|=
name|names
index|[
name|i
operator|+
name|p
index|]
expr_stmt|;
name|comment
index|[
name|i
index|]
operator|=
name|comment
index|[
name|i
operator|+
name|p
index|]
expr_stmt|;
name|desc
index|[
name|i
index|]
operator|=
name|desc
index|[
name|i
operator|+
name|p
index|]
expr_stmt|;
name|sizes
index|[
name|i
index|]
operator|=
name|sizes
index|[
name|i
operator|+
name|p
index|]
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
block|}
name|nf
operator|=
name|nf
operator|-
name|j
expr_stmt|;
name|free
argument_list|(
name|a
argument_list|)
expr_stmt|;
name|o_pkg
index|[
literal|0
index|]
operator|=
literal|'0'
expr_stmt|;
name|pkg_obj
operator|=
name|NewListObj
argument_list|(
name|pkg_win
argument_list|,
literal|"To be installed"
argument_list|,
name|names
argument_list|,
name|o_pkg
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
name|LINES
operator|-
literal|11
argument_list|,
name|COLS
operator|-
literal|50
argument_list|,
name|nf
argument_list|)
expr_stmt|;
name|AddObj
argument_list|(
operator|&
name|obj
argument_list|,
name|LISTOBJ
argument_list|,
operator|(
name|void
operator|*
operator|)
name|pkg_obj
argument_list|)
expr_stmt|;
name|o_pkgi
index|[
literal|0
index|]
operator|=
literal|'0'
expr_stmt|;
name|pkgi_obj
operator|=
name|NewListObj
argument_list|(
name|pkg_win
argument_list|,
literal|"Already Installed"
argument_list|,
name|p_inf
operator|.
name|name
argument_list|,
name|o_pkgi
argument_list|,
literal|1
argument_list|,
name|COLS
operator|-
literal|45
argument_list|,
name|LINES
operator|-
literal|11
argument_list|,
name|COLS
operator|-
literal|50
argument_list|,
name|p_inf
operator|.
name|Nitems
argument_list|)
expr_stmt|;
name|AddObj
argument_list|(
operator|&
name|obj
argument_list|,
name|LISTOBJ
argument_list|,
operator|(
name|void
operator|*
operator|)
name|pkgi_obj
argument_list|)
expr_stmt|;
name|o_installbut
operator|=
name|FALSE
expr_stmt|;
name|installbut_obj
operator|=
name|NewButtonObj
argument_list|(
name|pkg_win
argument_list|,
literal|"Install marked"
argument_list|,
operator|&
name|o_installbut
argument_list|,
name|LINES
operator|-
literal|8
argument_list|,
operator|(
name|COLS
operator|-
literal|12
operator|)
operator|/
literal|2
operator|-
literal|22
argument_list|)
expr_stmt|;
name|AddObj
argument_list|(
operator|&
name|obj
argument_list|,
name|BUTTONOBJ
argument_list|,
operator|(
name|void
operator|*
operator|)
name|installbut_obj
argument_list|)
expr_stmt|;
name|o_cancelbut
operator|=
name|FALSE
expr_stmt|;
name|cancelbut_obj
operator|=
name|NewButtonObj
argument_list|(
name|pkg_win
argument_list|,
literal|"Cancel"
argument_list|,
operator|&
name|o_cancelbut
argument_list|,
name|LINES
operator|-
literal|8
argument_list|,
operator|(
name|COLS
operator|-
literal|12
operator|)
operator|/
literal|2
operator|+
literal|2
argument_list|)
expr_stmt|;
name|AddObj
argument_list|(
operator|&
name|obj
argument_list|,
name|BUTTONOBJ
argument_list|,
operator|(
name|void
operator|*
operator|)
name|cancelbut_obj
argument_list|)
expr_stmt|;
comment|/* print total_marked in window */
name|wmove
argument_list|(
name|pkg_win
argument_list|,
name|LINES
operator|-
literal|9
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|wattrset
argument_list|(
name|pkg_win
argument_list|,
name|dialog_attr
argument_list|)
expr_stmt|;
name|waddstr
argument_list|(
name|pkg_win
argument_list|,
literal|"Total marked =     0 kB"
argument_list|)
expr_stmt|;
name|total_marked
operator|=
literal|0
expr_stmt|;
name|recalc
operator|=
name|FALSE
expr_stmt|;
name|quit
operator|=
name|FALSE
expr_stmt|;
name|install
operator|=
name|FALSE
expr_stmt|;
while|while
condition|(
operator|!
name|quit
condition|)
block|{
name|use_helpfile
argument_list|(
name|INSTALL_HLP
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|PollObj
argument_list|(
operator|&
name|obj
argument_list|)
condition|)
block|{
case|case
name|SEL_CR
case|:
comment|/* first move back one list object */
if|if
condition|(
name|obj
operator|->
name|prev
condition|)
name|obj
operator|=
name|obj
operator|->
name|prev
expr_stmt|;
if|if
condition|(
operator|(
name|ListObj
operator|*
operator|)
name|obj
operator|->
name|obj
operator|==
name|pkg_obj
condition|)
block|{
name|dialog_notify
argument_list|(
name|comment
index|[
name|pkg_obj
operator|->
name|sel
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|ListObj
operator|*
operator|)
name|obj
operator|->
name|obj
operator|==
name|pkgi_obj
condition|)
block|{
name|dialog_notify
argument_list|(
name|p_inf
operator|.
name|comment
index|[
name|pkgi_obj
operator|->
name|sel
index|]
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SEL_BUTTON
case|:
if|if
condition|(
name|o_installbut
condition|)
block|{
name|install
operator|=
name|TRUE
expr_stmt|;
name|quit
operator|=
name|TRUE
expr_stmt|;
block|}
if|if
condition|(
name|o_cancelbut
condition|)
block|{
name|quit
operator|=
name|TRUE
expr_stmt|;
block|}
break|break;
case|case
name|SEL_ESC
case|:
name|quit
operator|=
name|TRUE
expr_stmt|;
break|break;
case|case
literal|' '
case|:
if|if
condition|(
operator|(
name|ListObj
operator|*
operator|)
name|obj
operator|->
name|obj
operator|==
name|pkg_obj
condition|)
block|{
name|MarkCurrentListObj
argument_list|(
name|pkg_obj
argument_list|)
expr_stmt|;
block|}
name|recalc
operator|=
name|TRUE
expr_stmt|;
name|wrefresh
argument_list|(
name|pkg_win
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'*'
case|:
if|if
condition|(
operator|(
name|ListObj
operator|*
operator|)
name|obj
operator|->
name|obj
operator|==
name|pkg_obj
condition|)
block|{
name|MarkAllListObj
argument_list|(
name|pkg_obj
argument_list|)
expr_stmt|;
block|}
name|recalc
operator|=
name|TRUE
expr_stmt|;
break|break;
case|case
literal|'-'
case|:
if|if
condition|(
operator|(
name|ListObj
operator|*
operator|)
name|obj
operator|->
name|obj
operator|==
name|pkg_obj
condition|)
block|{
name|UnMarkAllListObj
argument_list|(
name|pkg_obj
argument_list|)
expr_stmt|;
block|}
name|recalc
operator|=
name|TRUE
expr_stmt|;
break|break;
case|case
name|KEY_F
argument_list|(
literal|1
argument_list|)
case|:
name|display_helpfile
argument_list|()
expr_stmt|;
break|break;
case|case
name|KEY_F
argument_list|(
literal|2
argument_list|)
case|:
if|if
condition|(
operator|(
name|ListObj
operator|*
operator|)
name|obj
operator|->
name|obj
operator|==
name|pkg_obj
condition|)
block|{
name|dialog_notify
argument_list|(
name|desc
index|[
name|pkg_obj
operator|->
name|sel
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|ListObj
operator|*
operator|)
name|obj
operator|->
name|obj
operator|==
name|pkgi_obj
condition|)
block|{
name|dialog_notify
argument_list|(
name|p_inf
operator|.
name|description
index|[
name|pkgi_obj
operator|->
name|sel
index|]
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
if|if
condition|(
name|recalc
condition|)
block|{
name|total_marked
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nf
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|pkg_obj
operator|->
name|seld
index|[
name|i
index|]
condition|)
block|{
name|total_marked
operator|+=
name|sizes
index|[
name|i
index|]
expr_stmt|;
block|}
block|}
name|recalc
operator|=
name|FALSE
expr_stmt|;
comment|/* print total_marked in window */
name|wmove
argument_list|(
name|pkg_win
argument_list|,
name|LINES
operator|-
literal|9
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|wattrset
argument_list|(
name|pkg_win
argument_list|,
name|dialog_attr
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|msg
argument_list|,
literal|"Total marked = %6ld kB"
argument_list|,
call|(
name|long
call|)
argument_list|(
name|total_marked
operator|/
literal|1024
argument_list|)
argument_list|)
expr_stmt|;
name|waddstr
argument_list|(
name|pkg_win
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|wrefresh
argument_list|(
name|pkg_win
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|install
condition|)
block|{
comment|/* check if any of the packages marked for installation are */
comment|/* already installed */
name|i
operator|=
literal|0
expr_stmt|;
name|n
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|i
operator|<
name|nf
condition|)
block|{
if|if
condition|(
operator|(
name|pkg_obj
operator|->
name|seld
index|[
name|i
index|]
operator|)
operator|&&
operator|(
name|already_installed
argument_list|(
name|names
index|[
name|i
index|]
argument_list|)
operator|)
condition|)
block|{
comment|/* popup a warning and remove the package from the */
comment|/* packages that are going to be installed */
name|sprintf
argument_list|(
name|msg
argument_list|,
literal|" The following package is already installed:\n\n   %s (%s)\n\n"
argument_list|,
name|names
index|[
name|i
index|]
argument_list|,
name|fnames
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|msg
argument_list|,
literal|" This package will be skipped\n"
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|msg
argument_list|,
literal|" If you want to install it anyway, remove it first"
argument_list|)
expr_stmt|;
name|dialog_notify
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|pkg_obj
operator|->
name|seld
index|[
name|i
index|]
operator|=
name|FALSE
expr_stmt|;
block|}
if|if
condition|(
name|pkg_obj
operator|->
name|seld
index|[
name|i
index|]
condition|)
name|n
operator|++
expr_stmt|;
comment|/* count selected packages */
name|i
operator|++
expr_stmt|;
block|}
comment|/* now install whatever is left */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nf
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|pkg_obj
operator|->
name|seld
index|[
name|i
index|]
condition|)
block|{
name|dialog_gauge
argument_list|(
literal|"Installing packages:"
argument_list|,
name|names
index|[
name|i
index|]
argument_list|,
name|LINES
operator|/
literal|2
operator|-
literal|3
argument_list|,
name|COLS
operator|/
literal|2
operator|-
literal|30
argument_list|,
literal|7
argument_list|,
literal|60
argument_list|,
call|(
name|int
call|)
argument_list|(
call|(
name|float
call|)
argument_list|(
name|i
operator|+
literal|1
argument_list|)
operator|/
name|n
operator|*
literal|100
argument_list|)
argument_list|)
expr_stmt|;
name|install_package
argument_list|(
name|fnames
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|n
operator|>
literal|0
condition|)
name|get_pkginfo
argument_list|()
expr_stmt|;
block|}
comment|/* clean up */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nf
condition|;
name|i
operator|++
control|)
block|{
name|free
argument_list|(
name|fnames
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|names
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|comment
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|desc
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|fnames
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|names
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|comment
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|desc
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|sizes
argument_list|)
expr_stmt|;
name|DelObj
argument_list|(
name|obj
argument_list|)
expr_stmt|;
name|use_helpfile
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|use_helpline
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|delwin
argument_list|(
name|pkg_win
argument_list|)
expr_stmt|;
name|touchwin
argument_list|(
name|tmpwin
argument_list|)
expr_stmt|;
name|wrefresh
argument_list|(
name|tmpwin
argument_list|)
expr_stmt|;
name|delwin
argument_list|(
name|tmpwin
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/* install_batch() */
end_comment

begin_function
name|void
name|run_menu
parameter_list|(
name|void
parameter_list|)
comment|/*  * Desc: display/choose from menu  */
block|{
name|int
name|quit_pkg
decl_stmt|,
name|sel
decl_stmt|,
name|ch
init|=
literal|0
decl_stmt|,
name|sc
init|=
literal|0
decl_stmt|;
name|char
name|selection
index|[
literal|30
index|]
decl_stmt|;
name|unsigned
name|char
modifier|*
name|pkg_menu
index|[]
init|=
block|{
literal|"1. View installed"
block|,
literal|"Overview of the installed packages"
block|,
literal|"2. Delete installed"
block|,
literal|"Delete an installed package"
block|,
literal|"3. Preview package"
block|,
literal|"Preview commands executed on installation"
block|,
literal|"4. Install packages"
block|,
literal|"Install one or more packages"
block|,
literal|"5. Quit"
block|,
literal|"Leave the program"
block|,     }
decl_stmt|;
name|quit_pkg
operator|=
name|FALSE
expr_stmt|;
while|while
condition|(
operator|!
name|quit_pkg
condition|)
block|{
name|use_helpline
argument_list|(
literal|"F1=help, use arrow-keys or digit to select option and press enter"
argument_list|)
expr_stmt|;
name|use_helpfile
argument_list|(
name|MAIN_HLP
argument_list|)
expr_stmt|;
if|if
condition|(
name|dialog_menu
argument_list|(
literal|"Package Manager"
argument_list|,
literal|"Choose one of the options"
argument_list|,
name|LINES
argument_list|,
name|COLS
argument_list|,
literal|5
argument_list|,
literal|5
argument_list|,
name|pkg_menu
argument_list|,
name|selection
argument_list|,
operator|&
name|ch
argument_list|,
operator|&
name|sc
argument_list|)
condition|)
block|{
name|quit_pkg
operator|=
name|TRUE
expr_stmt|;
block|}
else|else
block|{
name|sel
operator|=
name|atoi
argument_list|(
name|selection
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|sel
condition|)
block|{
case|case
literal|1
case|:
comment|/* View installed packages */
name|view_installed
argument_list|()
expr_stmt|;
break|break;
case|case
literal|2
case|:
comment|/* Delete installed package */
name|delete_installed
argument_list|()
expr_stmt|;
break|break;
case|case
literal|3
case|:
comment|/* Preview install */
name|preview_pkg
argument_list|()
expr_stmt|;
break|break;
case|case
literal|4
case|:
comment|/* Install multiple packages */
name|install_batch
argument_list|()
expr_stmt|;
break|break;
case|case
literal|5
case|:
comment|/* Quit */
name|quit_pkg
operator|=
name|TRUE
expr_stmt|;
break|break;
block|}
block|}
block|}
return|return;
block|}
end_function

begin_comment
comment|/* run_menu() */
end_comment

end_unit


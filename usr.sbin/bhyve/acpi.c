begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2012 NetApp, Inc.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY NETAPP, INC ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL NETAPP, INC OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_comment
comment|/*  * bhyve ACPI table generator.  *  * Create the minimal set of ACPI tables required to boot FreeBSD (and  * hopefully other o/s's) by writing out ASL template files for each of  * the tables and the compiling them to AML with the Intel iasl compiler.  * The AML files are then read into guest memory.  *  *  The tables are placed in the guest's ROM area just below 1MB physical,  * above the MPTable.  *  *  Layout  *  ------  *   RSDP  ->   0xf2400    (36 bytes fixed)  *     RSDT  ->   0xf2440    (36 bytes + 4*N table addrs, 2 used)  *     XSDT  ->   0xf2480    (36 bytes + 8*N table addrs, 2 used)  *       MADT  ->   0xf2500  (depends on #CPUs)  *       FADT  ->   0xf2600  (268 bytes)  *       HPET  ->   0xf2740  (56 bytes)  *         FACS  ->   0xf2780 (64 bytes)  *         DSDT  ->   0xf2800 (variable - can go up to 0x100000)  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/errno.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<paths.h>
end_include

begin_include
include|#
directive|include
file|<stdarg.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<machine/vmm.h>
end_include

begin_include
include|#
directive|include
file|<vmmapi.h>
end_include

begin_include
include|#
directive|include
file|"bhyverun.h"
end_include

begin_include
include|#
directive|include
file|"acpi.h"
end_include

begin_include
include|#
directive|include
file|"pci_emul.h"
end_include

begin_comment
comment|/*  * Define the base address of the ACPI tables, and the offsets to  * the individual tables  */
end_comment

begin_define
define|#
directive|define
name|BHYVE_ACPI_BASE
value|0xf2400
end_define

begin_define
define|#
directive|define
name|RSDT_OFFSET
value|0x040
end_define

begin_define
define|#
directive|define
name|XSDT_OFFSET
value|0x080
end_define

begin_define
define|#
directive|define
name|MADT_OFFSET
value|0x100
end_define

begin_define
define|#
directive|define
name|FADT_OFFSET
value|0x200
end_define

begin_define
define|#
directive|define
name|HPET_OFFSET
value|0x340
end_define

begin_define
define|#
directive|define
name|FACS_OFFSET
value|0x380
end_define

begin_define
define|#
directive|define
name|DSDT_OFFSET
value|0x400
end_define

begin_define
define|#
directive|define
name|BHYVE_ASL_TEMPLATE
value|"bhyve.XXXXXXX"
end_define

begin_define
define|#
directive|define
name|BHYVE_ASL_SUFFIX
value|".aml"
end_define

begin_define
define|#
directive|define
name|BHYVE_ASL_COMPILER
value|"/usr/sbin/iasl"
end_define

begin_decl_stmt
specifier|static
name|int
name|basl_keep_temps
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|basl_verbose_iasl
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|basl_ncpu
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|uint32_t
name|basl_acpi_base
init|=
name|BHYVE_ACPI_BASE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|uint32_t
name|hpet_capabilities
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Contains the full pathname of the template to be passed  * to mkstemp/mktemps(3)  */
end_comment

begin_decl_stmt
specifier|static
name|char
name|basl_template
index|[
name|MAXPATHLEN
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|basl_stemplate
index|[
name|MAXPATHLEN
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * State for dsdt_line(), dsdt_indent(), and dsdt_unindent().  */
end_comment

begin_decl_stmt
specifier|static
name|FILE
modifier|*
name|dsdt_fp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|dsdt_indent_level
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|dsdt_error
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|basl_fio
block|{
name|int
name|fd
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
name|char
name|f_name
index|[
name|MAXPATHLEN
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|EFPRINTF
parameter_list|(
modifier|...
parameter_list|)
define|\
value|err = fprintf(__VA_ARGS__); if (err< 0) goto err_exit;
end_define

begin_define
define|#
directive|define
name|EFFLUSH
parameter_list|(
name|x
parameter_list|)
define|\
value|err = fflush(x); if (err != 0) goto err_exit;
end_define

begin_function
specifier|static
name|int
name|basl_fwrite_rsdp
parameter_list|(
name|FILE
modifier|*
name|fp
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|err
operator|=
literal|0
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"/*\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|" * bhyve RSDP template\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|" */\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0008]\t\tSignature : \"RSD PTR \"\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tChecksum : 43\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0006]\t\tOem ID : \"BHYVE \"\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tRevision : 02\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tRSDT Address : %08X\n"
argument_list|,
name|basl_acpi_base
operator|+
name|RSDT_OFFSET
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tLength : 00000024\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0008]\t\tXSDT Address : 00000000%08X\n"
argument_list|,
name|basl_acpi_base
operator|+
name|XSDT_OFFSET
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tExtended Checksum : 00\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0003]\t\tReserved : 000000\n"
argument_list|)
expr_stmt|;
name|EFFLUSH
argument_list|(
name|fp
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|err_exit
label|:
return|return
operator|(
name|errno
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|basl_fwrite_rsdt
parameter_list|(
name|FILE
modifier|*
name|fp
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|err
operator|=
literal|0
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"/*\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|" * bhyve RSDT template\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|" */\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tSignature : \"RSDT\"\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tTable Length : 00000000\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tRevision : 01\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tChecksum : 00\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0006]\t\tOem ID : \"BHYVE \"\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0008]\t\tOem Table ID : \"BVRSDT  \"\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tOem Revision : 00000001\n"
argument_list|)
expr_stmt|;
comment|/* iasl will fill in the compiler ID/revision fields */
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tAsl Compiler ID : \"xxxx\"\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tAsl Compiler Revision : 00000000\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
comment|/* Add in pointers to the MADT, FADT and HPET */
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tACPI Table Address 0 : %08X\n"
argument_list|,
name|basl_acpi_base
operator|+
name|MADT_OFFSET
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tACPI Table Address 1 : %08X\n"
argument_list|,
name|basl_acpi_base
operator|+
name|FADT_OFFSET
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tACPI Table Address 2 : %08X\n"
argument_list|,
name|basl_acpi_base
operator|+
name|HPET_OFFSET
argument_list|)
expr_stmt|;
name|EFFLUSH
argument_list|(
name|fp
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|err_exit
label|:
return|return
operator|(
name|errno
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|basl_fwrite_xsdt
parameter_list|(
name|FILE
modifier|*
name|fp
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|err
operator|=
literal|0
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"/*\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|" * bhyve XSDT template\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|" */\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tSignature : \"XSDT\"\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tTable Length : 00000000\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tRevision : 01\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tChecksum : 00\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0006]\t\tOem ID : \"BHYVE \"\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0008]\t\tOem Table ID : \"BVXSDT  \"\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tOem Revision : 00000001\n"
argument_list|)
expr_stmt|;
comment|/* iasl will fill in the compiler ID/revision fields */
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tAsl Compiler ID : \"xxxx\"\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tAsl Compiler Revision : 00000000\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
comment|/* Add in pointers to the MADT, FADT and HPET */
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tACPI Table Address 0 : 00000000%08X\n"
argument_list|,
name|basl_acpi_base
operator|+
name|MADT_OFFSET
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tACPI Table Address 1 : 00000000%08X\n"
argument_list|,
name|basl_acpi_base
operator|+
name|FADT_OFFSET
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tACPI Table Address 2 : 00000000%08X\n"
argument_list|,
name|basl_acpi_base
operator|+
name|HPET_OFFSET
argument_list|)
expr_stmt|;
name|EFFLUSH
argument_list|(
name|fp
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|err_exit
label|:
return|return
operator|(
name|errno
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|basl_fwrite_madt
parameter_list|(
name|FILE
modifier|*
name|fp
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|int
name|i
decl_stmt|;
name|err
operator|=
literal|0
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"/*\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|" * bhyve MADT template\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|" */\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tSignature : \"APIC\"\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tTable Length : 00000000\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tRevision : 01\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tChecksum : 00\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0006]\t\tOem ID : \"BHYVE \"\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0008]\t\tOem Table ID : \"BVMADT  \"\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tOem Revision : 00000001\n"
argument_list|)
expr_stmt|;
comment|/* iasl will fill in the compiler ID/revision fields */
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tAsl Compiler ID : \"xxxx\"\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tAsl Compiler Revision : 00000000\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tLocal Apic Address : FEE00000\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tFlags (decoded below) : 00000001\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\t\t\tPC-AT Compatibility : 1\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
comment|/* Add a Processor Local APIC entry for each CPU */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|basl_ncpu
condition|;
name|i
operator|++
control|)
block|{
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tSubtable Type : 00\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tLength : 08\n"
argument_list|)
expr_stmt|;
comment|/* iasl expects hex values for the proc and apic id's */
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tProcessor ID : %02x\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tLocal Apic ID : %02x\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tFlags (decoded below) : 00000001\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\t\t\tProcessor Enabled : 1\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
comment|/* Always a single IOAPIC entry, with ID 0 */
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tSubtable Type : 01\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tLength : 0C\n"
argument_list|)
expr_stmt|;
comment|/* iasl expects a hex value for the i/o apic id */
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tI/O Apic ID : %02x\n"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tReserved : 00\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tAddress : fec00000\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tInterrupt : 00000000\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
comment|/* Legacy IRQ0 is connected to pin 2 of the IOAPIC */
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tSubtable Type : 02\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tLength : 0A\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tBus : 00\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tSource : 00\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tInterrupt : 00000002\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0002]\t\tFlags (decoded below) : 0005\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\t\t\tPolarity : 1\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\t\t\tTrigger Mode : 1\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tSubtable Type : 02\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tLength : 0A\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tBus : 00\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tSource : %02X\n"
argument_list|,
name|SCI_INT
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tInterrupt : %08X\n"
argument_list|,
name|SCI_INT
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0002]\t\tFlags (decoded below) : 0000\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\t\t\tPolarity : 3\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\t\t\tTrigger Mode : 3\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
comment|/* Local APIC NMI is connected to LINT 1 on all CPUs */
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tSubtable Type : 04\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tLength : 06\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tProcessorId : FF\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0002]\t\tFlags (decoded below) : 0005\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\t\t\tPolarity : 1\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\t\t\tTrigger Mode : 1\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tInterrupt : 01\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|EFFLUSH
argument_list|(
name|fp
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|err_exit
label|:
return|return
operator|(
name|errno
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|basl_fwrite_fadt
parameter_list|(
name|FILE
modifier|*
name|fp
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|err
operator|=
literal|0
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"/*\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|" * bhyve FADT template\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|" */\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tSignature : \"FACP\"\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tTable Length : 0000010C\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tRevision : 05\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tChecksum : 00\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0006]\t\tOem ID : \"BHYVE \"\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0008]\t\tOem Table ID : \"BVFACP  \"\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tOem Revision : 00000001\n"
argument_list|)
expr_stmt|;
comment|/* iasl will fill in the compiler ID/revision fields */
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tAsl Compiler ID : \"xxxx\"\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tAsl Compiler Revision : 00000000\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tFACS Address : %08X\n"
argument_list|,
name|basl_acpi_base
operator|+
name|FACS_OFFSET
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tDSDT Address : %08X\n"
argument_list|,
name|basl_acpi_base
operator|+
name|DSDT_OFFSET
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tModel : 01\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tPM Profile : 00 [Unspecified]\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0002]\t\tSCI Interrupt : %04X\n"
argument_list|,
name|SCI_INT
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tSMI Command Port : %08X\n"
argument_list|,
name|SMI_CMD
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tACPI Enable Value : %02X\n"
argument_list|,
name|BHYVE_ACPI_ENABLE
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tACPI Disable Value : %02X\n"
argument_list|,
name|BHYVE_ACPI_DISABLE
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tS4BIOS Command : 00\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tP-State Control : 00\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tPM1A Event Block Address : %08X\n"
argument_list|,
name|PM1A_EVT_ADDR
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tPM1B Event Block Address : 00000000\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tPM1A Control Block Address : %08X\n"
argument_list|,
name|PM1A_CNT_ADDR
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tPM1B Control Block Address : 00000000\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tPM2 Control Block Address : 00000000\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tPM Timer Block Address : %08X\n"
argument_list|,
name|IO_PMTMR
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tGPE0 Block Address : 00000000\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tGPE1 Block Address : 00000000\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tPM1 Event Block Length : 04\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tPM1 Control Block Length : 02\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tPM2 Control Block Length : 00\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tPM Timer Block Length : 04\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tGPE0 Block Length : 00\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tGPE1 Block Length : 00\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tGPE1 Base Offset : 00\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\t_CST Support : 00\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0002]\t\tC2 Latency : 0000\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0002]\t\tC3 Latency : 0000\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0002]\t\tCPU Cache Size : 0000\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0002]\t\tCache Flush Stride : 0000\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tDuty Cycle Offset : 00\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tDuty Cycle Width : 00\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tRTC Day Alarm Index : 00\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tRTC Month Alarm Index : 00\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tRTC Century Index : 00\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0002]\t\tBoot Flags (decoded below) : 0000\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\t\t\tLegacy Devices Supported (V2) : 0\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\t\t\t8042 Present on ports 60/64 (V2) : 0\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\t\t\tVGA Not Present (V4) : 1\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\t\t\tMSI Not Supported (V4) : 0\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\t\t\tPCIe ASPM Not Supported (V4) : 1\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\t\t\tCMOS RTC Not Present (V5) : 0\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tReserved : 00\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tFlags (decoded below) : 00000000\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\t\t\tWBINVD instruction is operational (V1) : 1\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\t\t\tWBINVD flushes all caches (V1) : 0\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\t\t\tAll CPUs support C1 (V1) : 1\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\t\t\tC2 works on MP system (V1) : 0\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\t\t\tControl Method Power Button (V1) : 0\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\t\t\tControl Method Sleep Button (V1) : 1\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\t\t\tRTC wake not in fixed reg space (V1) : 0\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\t\t\tRTC can wake system from S4 (V1) : 0\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\t\t\t32-bit PM Timer (V1) : 1\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\t\t\tDocking Supported (V1) : 0\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\t\t\tReset Register Supported (V2) : 1\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\t\t\tSealed Case (V3) : 0\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\t\t\tHeadless - No Video (V3) : 1\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\t\t\tUse native instr after SLP_TYPx (V3) : 0\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\t\t\tPCIEXP_WAK Bits Supported (V4) : 0\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\t\t\tUse Platform Timer (V4) : 0\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\t\t\tRTC_STS valid on S4 wake (V4) : 0\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\t\t\tRemote Power-on capable (V4) : 0\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\t\t\tUse APIC Cluster Model (V4) : 0\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\t\t\tUse APIC Physical Destination Mode (V4) : 1\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\t\t\tHardware Reduced (V5) : 0\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\t\t\tLow Power S0 Idle (V5) : 0\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0012]\t\tReset Register : [Generic Address Structure]\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tSpace ID : 01 [SystemIO]\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tBit Width : 08\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tBit Offset : 00\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tEncoded Access Width : 01 [Byte Access:8]\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0008]\t\tAddress : 0000000000000CF9\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tValue to cause reset : 06\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0003]\t\tReserved : 000000\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0008]\t\tFACS Address : 00000000%08X\n"
argument_list|,
name|basl_acpi_base
operator|+
name|FACS_OFFSET
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0008]\t\tDSDT Address : 00000000%08X\n"
argument_list|,
name|basl_acpi_base
operator|+
name|DSDT_OFFSET
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0012]\t\tPM1A Event Block : [Generic Address Structure]\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tSpace ID : 01 [SystemIO]\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tBit Width : 20\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tBit Offset : 00\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tEncoded Access Width : 02 [Word Access:16]\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0008]\t\tAddress : 00000000%08X\n"
argument_list|,
name|PM1A_EVT_ADDR
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0012]\t\tPM1B Event Block : [Generic Address Structure]\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tSpace ID : 01 [SystemIO]\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tBit Width : 00\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tBit Offset : 00\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tEncoded Access Width : 00 [Undefined/Legacy]\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0008]\t\tAddress : 0000000000000000\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0012]\t\tPM1A Control Block : [Generic Address Structure]\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tSpace ID : 01 [SystemIO]\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tBit Width : 10\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tBit Offset : 00\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tEncoded Access Width : 02 [Word Access:16]\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0008]\t\tAddress : 00000000%08X\n"
argument_list|,
name|PM1A_CNT_ADDR
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0012]\t\tPM1B Control Block : [Generic Address Structure]\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tSpace ID : 01 [SystemIO]\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tBit Width : 00\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tBit Offset : 00\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tEncoded Access Width : 00 [Undefined/Legacy]\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0008]\t\tAddress : 0000000000000000\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0012]\t\tPM2 Control Block : [Generic Address Structure]\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tSpace ID : 01 [SystemIO]\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tBit Width : 08\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tBit Offset : 00\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tEncoded Access Width : 00 [Undefined/Legacy]\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0008]\t\tAddress : 0000000000000000\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
comment|/* Valid for bhyve */
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0012]\t\tPM Timer Block : [Generic Address Structure]\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tSpace ID : 01 [SystemIO]\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tBit Width : 32\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tBit Offset : 00\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tEncoded Access Width : 03 [DWord Access:32]\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0008]\t\tAddress : 00000000%08X\n"
argument_list|,
name|IO_PMTMR
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0012]\t\tGPE0 Block : [Generic Address Structure]\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tSpace ID : 01 [SystemIO]\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tBit Width : 80\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tBit Offset : 00\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tEncoded Access Width : 01 [Byte Access:8]\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0008]\t\tAddress : 0000000000000000\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0012]\t\tGPE1 Block : [Generic Address Structure]\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tSpace ID : 01 [SystemIO]\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tBit Width : 00\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tBit Offset : 00\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tEncoded Access Width : 00 [Undefined/Legacy]\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0008]\t\tAddress : 0000000000000000\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0012]\t\tSleep Control Register : [Generic Address Structure]\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tSpace ID : 01 [SystemIO]\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tBit Width : 08\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tBit Offset : 00\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tEncoded Access Width : 01 [Byte Access:8]\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0008]\t\tAddress : 0000000000000000\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0012]\t\tSleep Status Register : [Generic Address Structure]\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tSpace ID : 01 [SystemIO]\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tBit Width : 08\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tBit Offset : 00\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tEncoded Access Width : 01 [Byte Access:8]\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0008]\t\tAddress : 0000000000000000\n"
argument_list|)
expr_stmt|;
name|EFFLUSH
argument_list|(
name|fp
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|err_exit
label|:
return|return
operator|(
name|errno
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|basl_fwrite_hpet
parameter_list|(
name|FILE
modifier|*
name|fp
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|err
operator|=
literal|0
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"/*\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|" * bhyve HPET template\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|" */\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tSignature : \"HPET\"\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tTable Length : 00000000\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tRevision : 01\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tChecksum : 00\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0006]\t\tOem ID : \"BHYVE \"\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0008]\t\tOem Table ID : \"BVHPET  \"\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tOem Revision : 00000001\n"
argument_list|)
expr_stmt|;
comment|/* iasl will fill in the compiler ID/revision fields */
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tAsl Compiler ID : \"xxxx\"\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tAsl Compiler Revision : 00000000\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tTimer Block ID : %08X\n"
argument_list|,
name|hpet_capabilities
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0012]\t\tTimer Block Register : [Generic Address Structure]\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tSpace ID : 00 [SystemMemory]\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tBit Width : 00\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tBit Offset : 00\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tEncoded Access Width : 00 [Undefined/Legacy]\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0008]\t\tAddress : 00000000FED00000\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tHPET Number : 00\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0002]\t\tMinimum Clock Ticks : 0000\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tFlags (decoded below) : 00000001\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\t\t\t4K Page Protect : 1\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\t\t\t64K Page Protect : 0\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|EFFLUSH
argument_list|(
name|fp
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|err_exit
label|:
return|return
operator|(
name|errno
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|basl_fwrite_facs
parameter_list|(
name|FILE
modifier|*
name|fp
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|err
operator|=
literal|0
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"/*\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|" * bhyve FACS template\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|" */\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tSignature : \"FACS\"\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tLength : 00000040\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tHardware Signature : 00000000\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\t32 Firmware Waking Vector : 00000000\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tGlobal Lock : 00000000\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tFlags (decoded below) : 00000000\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\t\t\tS4BIOS Support Present : 0\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\t\t\t64-bit Wake Supported (V2) : 0\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0008]\t\t64 Firmware Waking Vector : 0000000000000000\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0001]\t\tVersion : 02\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0003]\t\tReserved : 000000\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"[0004]\t\tOspmFlags (decoded below) : 00000000\n"
argument_list|)
expr_stmt|;
name|EFPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\t\t\t64-bit Wake Env Required (V2) : 0\n"
argument_list|)
expr_stmt|;
name|EFFLUSH
argument_list|(
name|fp
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|err_exit
label|:
return|return
operator|(
name|errno
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Helper routines for writing to the DSDT from other modules.  */
end_comment

begin_function
name|void
name|dsdt_line
parameter_list|(
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|ap
decl_stmt|;
name|int
name|err
decl_stmt|;
if|if
condition|(
name|dsdt_error
operator|!=
literal|0
condition|)
return|return;
if|if
condition|(
name|strcmp
argument_list|(
name|fmt
argument_list|,
literal|""
argument_list|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|dsdt_indent_level
operator|!=
literal|0
condition|)
name|EFPRINTF
argument_list|(
name|dsdt_fp
argument_list|,
literal|"%*c"
argument_list|,
name|dsdt_indent_level
operator|*
literal|2
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
name|va_start
argument_list|(
name|ap
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
if|if
condition|(
name|vfprintf
argument_list|(
name|dsdt_fp
argument_list|,
name|fmt
argument_list|,
name|ap
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|err_exit
goto|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
block|}
name|EFPRINTF
argument_list|(
name|dsdt_fp
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
return|return;
name|err_exit
label|:
name|dsdt_error
operator|=
name|errno
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dsdt_indent
parameter_list|(
name|int
name|levels
parameter_list|)
block|{
name|dsdt_indent_level
operator|+=
name|levels
expr_stmt|;
name|assert
argument_list|(
name|dsdt_indent_level
operator|>=
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dsdt_unindent
parameter_list|(
name|int
name|levels
parameter_list|)
block|{
name|assert
argument_list|(
name|dsdt_indent_level
operator|>=
name|levels
argument_list|)
expr_stmt|;
name|dsdt_indent_level
operator|-=
name|levels
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dsdt_fixed_ioport
parameter_list|(
name|uint16_t
name|iobase
parameter_list|,
name|uint16_t
name|length
parameter_list|)
block|{
name|dsdt_line
argument_list|(
literal|"IO (Decode16,"
argument_list|)
expr_stmt|;
name|dsdt_line
argument_list|(
literal|"  0x%04X,             // Range Minimum"
argument_list|,
name|iobase
argument_list|)
expr_stmt|;
name|dsdt_line
argument_list|(
literal|"  0x%04X,             // Range Maximum"
argument_list|,
name|iobase
argument_list|)
expr_stmt|;
name|dsdt_line
argument_list|(
literal|"  0x01,               // Alignment"
argument_list|)
expr_stmt|;
name|dsdt_line
argument_list|(
literal|"  0x%02X,               // Length"
argument_list|,
name|length
argument_list|)
expr_stmt|;
name|dsdt_line
argument_list|(
literal|"  )"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dsdt_fixed_irq
parameter_list|(
name|uint8_t
name|irq
parameter_list|)
block|{
name|dsdt_line
argument_list|(
literal|"IRQNoFlags ()"
argument_list|)
expr_stmt|;
name|dsdt_line
argument_list|(
literal|"  {%d}"
argument_list|,
name|irq
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dsdt_fixed_mem32
parameter_list|(
name|uint32_t
name|base
parameter_list|,
name|uint32_t
name|length
parameter_list|)
block|{
name|dsdt_line
argument_list|(
literal|"Memory32Fixed (ReadWrite,"
argument_list|)
expr_stmt|;
name|dsdt_line
argument_list|(
literal|"  0x%08X,         // Address Base"
argument_list|,
name|base
argument_list|)
expr_stmt|;
name|dsdt_line
argument_list|(
literal|"  0x%08X,         // Address Length"
argument_list|,
name|length
argument_list|)
expr_stmt|;
name|dsdt_line
argument_list|(
literal|"  )"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|basl_fwrite_dsdt
parameter_list|(
name|FILE
modifier|*
name|fp
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|err
operator|=
literal|0
expr_stmt|;
name|dsdt_fp
operator|=
name|fp
expr_stmt|;
name|dsdt_error
operator|=
literal|0
expr_stmt|;
name|dsdt_indent_level
operator|=
literal|0
expr_stmt|;
name|dsdt_line
argument_list|(
literal|"/*"
argument_list|)
expr_stmt|;
name|dsdt_line
argument_list|(
literal|" * bhyve DSDT template"
argument_list|)
expr_stmt|;
name|dsdt_line
argument_list|(
literal|" */"
argument_list|)
expr_stmt|;
name|dsdt_line
argument_list|(
literal|"DefinitionBlock (\"bhyve_dsdt.aml\", \"DSDT\", 2,"
literal|"\"BHYVE \", \"BVDSDT  \", 0x00000001)"
argument_list|)
expr_stmt|;
name|dsdt_line
argument_list|(
literal|"{"
argument_list|)
expr_stmt|;
name|dsdt_line
argument_list|(
literal|"  Name (_S5, Package (0x02)"
argument_list|)
expr_stmt|;
name|dsdt_line
argument_list|(
literal|"  {"
argument_list|)
expr_stmt|;
name|dsdt_line
argument_list|(
literal|"      0x05,"
argument_list|)
expr_stmt|;
name|dsdt_line
argument_list|(
literal|"      Zero,"
argument_list|)
expr_stmt|;
name|dsdt_line
argument_list|(
literal|"  })"
argument_list|)
expr_stmt|;
name|pci_write_dsdt
argument_list|()
expr_stmt|;
name|dsdt_line
argument_list|(
literal|""
argument_list|)
expr_stmt|;
name|dsdt_line
argument_list|(
literal|"  Scope (_SB.PC00)"
argument_list|)
expr_stmt|;
name|dsdt_line
argument_list|(
literal|"  {"
argument_list|)
expr_stmt|;
name|dsdt_line
argument_list|(
literal|"    Device (HPET)"
argument_list|)
expr_stmt|;
name|dsdt_line
argument_list|(
literal|"    {"
argument_list|)
expr_stmt|;
name|dsdt_line
argument_list|(
literal|"      Name (_HID, EISAID(\"PNP0103\"))"
argument_list|)
expr_stmt|;
name|dsdt_line
argument_list|(
literal|"      Name (_UID, 0)"
argument_list|)
expr_stmt|;
name|dsdt_line
argument_list|(
literal|"      Name (_CRS, ResourceTemplate ()"
argument_list|)
expr_stmt|;
name|dsdt_line
argument_list|(
literal|"      {"
argument_list|)
expr_stmt|;
name|dsdt_indent
argument_list|(
literal|4
argument_list|)
expr_stmt|;
name|dsdt_fixed_mem32
argument_list|(
literal|0xFED00000
argument_list|,
literal|0x400
argument_list|)
expr_stmt|;
name|dsdt_unindent
argument_list|(
literal|4
argument_list|)
expr_stmt|;
name|dsdt_line
argument_list|(
literal|"      })"
argument_list|)
expr_stmt|;
name|dsdt_line
argument_list|(
literal|"    }"
argument_list|)
expr_stmt|;
name|dsdt_line
argument_list|(
literal|"  }"
argument_list|)
expr_stmt|;
name|dsdt_line
argument_list|(
literal|"}"
argument_list|)
expr_stmt|;
if|if
condition|(
name|dsdt_error
operator|!=
literal|0
condition|)
return|return
operator|(
name|dsdt_error
operator|)
return|;
name|EFFLUSH
argument_list|(
name|fp
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|err_exit
label|:
return|return
operator|(
name|errno
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|basl_open
parameter_list|(
name|struct
name|basl_fio
modifier|*
name|bf
parameter_list|,
name|int
name|suffix
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|err
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|suffix
condition|)
block|{
name|strncpy
argument_list|(
name|bf
operator|->
name|f_name
argument_list|,
name|basl_stemplate
argument_list|,
name|MAXPATHLEN
argument_list|)
expr_stmt|;
name|bf
operator|->
name|fd
operator|=
name|mkstemps
argument_list|(
name|bf
operator|->
name|f_name
argument_list|,
name|strlen
argument_list|(
name|BHYVE_ASL_SUFFIX
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|strncpy
argument_list|(
name|bf
operator|->
name|f_name
argument_list|,
name|basl_template
argument_list|,
name|MAXPATHLEN
argument_list|)
expr_stmt|;
name|bf
operator|->
name|fd
operator|=
name|mkstemp
argument_list|(
name|bf
operator|->
name|f_name
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|bf
operator|->
name|fd
operator|>
literal|0
condition|)
block|{
name|bf
operator|->
name|fp
operator|=
name|fdopen
argument_list|(
name|bf
operator|->
name|fd
argument_list|,
literal|"w+"
argument_list|)
expr_stmt|;
if|if
condition|(
name|bf
operator|->
name|fp
operator|==
name|NULL
condition|)
block|{
name|unlink
argument_list|(
name|bf
operator|->
name|f_name
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|bf
operator|->
name|fd
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|err
operator|=
literal|1
expr_stmt|;
block|}
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|basl_close
parameter_list|(
name|struct
name|basl_fio
modifier|*
name|bf
parameter_list|)
block|{
if|if
condition|(
operator|!
name|basl_keep_temps
condition|)
name|unlink
argument_list|(
name|bf
operator|->
name|f_name
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|bf
operator|->
name|fp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|basl_start
parameter_list|(
name|struct
name|basl_fio
modifier|*
name|in
parameter_list|,
name|struct
name|basl_fio
modifier|*
name|out
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|err
operator|=
name|basl_open
argument_list|(
name|in
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|err
condition|)
block|{
name|err
operator|=
name|basl_open
argument_list|(
name|out
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|basl_close
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
block|}
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|basl_end
parameter_list|(
name|struct
name|basl_fio
modifier|*
name|in
parameter_list|,
name|struct
name|basl_fio
modifier|*
name|out
parameter_list|)
block|{
name|basl_close
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|basl_close
argument_list|(
name|out
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|basl_load
parameter_list|(
name|struct
name|vmctx
modifier|*
name|ctx
parameter_list|,
name|int
name|fd
parameter_list|,
name|uint64_t
name|off
parameter_list|)
block|{
name|struct
name|stat
name|sb
decl_stmt|;
name|void
modifier|*
name|gaddr
decl_stmt|;
if|if
condition|(
name|fstat
argument_list|(
name|fd
argument_list|,
operator|&
name|sb
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
name|errno
operator|)
return|;
name|gaddr
operator|=
name|paddr_guest2host
argument_list|(
name|ctx
argument_list|,
name|basl_acpi_base
operator|+
name|off
argument_list|,
name|sb
operator|.
name|st_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|gaddr
operator|==
name|NULL
condition|)
return|return
operator|(
name|EFAULT
operator|)
return|;
if|if
condition|(
name|read
argument_list|(
name|fd
argument_list|,
name|gaddr
argument_list|,
name|sb
operator|.
name|st_size
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
name|errno
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|basl_compile
parameter_list|(
name|struct
name|vmctx
modifier|*
name|ctx
parameter_list|,
name|int
function_decl|(
modifier|*
name|fwrite_section
function_decl|)
parameter_list|(
name|FILE
modifier|*
parameter_list|)
parameter_list|,
name|uint64_t
name|offset
parameter_list|)
block|{
name|struct
name|basl_fio
name|io
index|[
literal|2
index|]
decl_stmt|;
specifier|static
name|char
name|iaslbuf
index|[
literal|3
operator|*
name|MAXPATHLEN
operator|+
literal|10
index|]
decl_stmt|;
name|char
modifier|*
name|fmt
decl_stmt|;
name|int
name|err
decl_stmt|;
name|err
operator|=
name|basl_start
argument_list|(
operator|&
name|io
index|[
literal|0
index|]
argument_list|,
operator|&
name|io
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|err
condition|)
block|{
name|err
operator|=
call|(
modifier|*
name|fwrite_section
call|)
argument_list|(
name|io
index|[
literal|0
index|]
operator|.
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|err
condition|)
block|{
comment|/* 			 * iasl sends the results of the compilation to 			 * stdout. Shut this down by using the shell to 			 * redirect stdout to /dev/null, unless the user 			 * has requested verbose output for debugging 			 * purposes 			 */
name|fmt
operator|=
name|basl_verbose_iasl
condition|?
literal|"%s -p %s %s"
else|:
literal|"/bin/sh -c \"%s -p %s %s\" 1> /dev/null"
expr_stmt|;
name|snprintf
argument_list|(
name|iaslbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|iaslbuf
argument_list|)
argument_list|,
name|fmt
argument_list|,
name|BHYVE_ASL_COMPILER
argument_list|,
name|io
index|[
literal|1
index|]
operator|.
name|f_name
argument_list|,
name|io
index|[
literal|0
index|]
operator|.
name|f_name
argument_list|)
expr_stmt|;
name|err
operator|=
name|system
argument_list|(
name|iaslbuf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|err
condition|)
block|{
comment|/* 				 * Copy the aml output file into guest 				 * memory at the specified location 				 */
name|err
operator|=
name|basl_load
argument_list|(
name|ctx
argument_list|,
name|io
index|[
literal|1
index|]
operator|.
name|fd
argument_list|,
name|offset
argument_list|)
expr_stmt|;
block|}
block|}
name|basl_end
argument_list|(
operator|&
name|io
index|[
literal|0
index|]
argument_list|,
operator|&
name|io
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|basl_make_templates
parameter_list|(
name|void
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|tmpdir
decl_stmt|;
name|int
name|err
decl_stmt|;
name|int
name|len
decl_stmt|;
name|err
operator|=
literal|0
expr_stmt|;
comment|/* 	 *  	 */
if|if
condition|(
operator|(
name|tmpdir
operator|=
name|getenv
argument_list|(
literal|"BHYVE_TMPDIR"
argument_list|)
operator|)
operator|==
name|NULL
operator|||
operator|*
name|tmpdir
operator|==
literal|'\0'
operator|||
operator|(
name|tmpdir
operator|=
name|getenv
argument_list|(
literal|"TMPDIR"
argument_list|)
operator|)
operator|==
name|NULL
operator|||
operator|*
name|tmpdir
operator|==
literal|'\0'
condition|)
block|{
name|tmpdir
operator|=
name|_PATH_TMP
expr_stmt|;
block|}
name|len
operator|=
name|strlen
argument_list|(
name|tmpdir
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|len
operator|+
sizeof|sizeof
argument_list|(
name|BHYVE_ASL_TEMPLATE
argument_list|)
operator|+
literal|1
operator|)
operator|<
name|MAXPATHLEN
condition|)
block|{
name|strcpy
argument_list|(
name|basl_template
argument_list|,
name|tmpdir
argument_list|)
expr_stmt|;
while|while
condition|(
name|len
operator|>
literal|0
operator|&&
name|basl_template
index|[
name|len
operator|-
literal|1
index|]
operator|==
literal|'/'
condition|)
name|len
operator|--
expr_stmt|;
name|basl_template
index|[
name|len
index|]
operator|=
literal|'/'
expr_stmt|;
name|strcpy
argument_list|(
operator|&
name|basl_template
index|[
name|len
operator|+
literal|1
index|]
argument_list|,
name|BHYVE_ASL_TEMPLATE
argument_list|)
expr_stmt|;
block|}
else|else
name|err
operator|=
name|E2BIG
expr_stmt|;
if|if
condition|(
operator|!
name|err
condition|)
block|{
comment|/* 		 * len has been intialized (and maybe adjusted) above 		 */
if|if
condition|(
operator|(
name|len
operator|+
sizeof|sizeof
argument_list|(
name|BHYVE_ASL_TEMPLATE
argument_list|)
operator|+
literal|1
operator|+
sizeof|sizeof
argument_list|(
name|BHYVE_ASL_SUFFIX
argument_list|)
operator|)
operator|<
name|MAXPATHLEN
condition|)
block|{
name|strcpy
argument_list|(
name|basl_stemplate
argument_list|,
name|tmpdir
argument_list|)
expr_stmt|;
name|basl_stemplate
index|[
name|len
index|]
operator|=
literal|'/'
expr_stmt|;
name|strcpy
argument_list|(
operator|&
name|basl_stemplate
index|[
name|len
operator|+
literal|1
index|]
argument_list|,
name|BHYVE_ASL_TEMPLATE
argument_list|)
expr_stmt|;
name|len
operator|=
name|strlen
argument_list|(
name|basl_stemplate
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
operator|&
name|basl_stemplate
index|[
name|len
index|]
argument_list|,
name|BHYVE_ASL_SUFFIX
argument_list|)
expr_stmt|;
block|}
else|else
name|err
operator|=
name|E2BIG
expr_stmt|;
block|}
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_struct
specifier|static
struct|struct
block|{
name|int
function_decl|(
modifier|*
name|wsect
function_decl|)
parameter_list|(
name|FILE
modifier|*
name|fp
parameter_list|)
function_decl|;
name|uint64_t
name|offset
decl_stmt|;
block|}
name|basl_ftables
index|[]
init|=
block|{
block|{
name|basl_fwrite_rsdp
block|,
literal|0
block|}
block|,
block|{
name|basl_fwrite_rsdt
block|,
name|RSDT_OFFSET
block|}
block|,
block|{
name|basl_fwrite_xsdt
block|,
name|XSDT_OFFSET
block|}
block|,
block|{
name|basl_fwrite_madt
block|,
name|MADT_OFFSET
block|}
block|,
block|{
name|basl_fwrite_fadt
block|,
name|FADT_OFFSET
block|}
block|,
block|{
name|basl_fwrite_hpet
block|,
name|HPET_OFFSET
block|}
block|,
block|{
name|basl_fwrite_facs
block|,
name|FACS_OFFSET
block|}
block|,
block|{
name|basl_fwrite_dsdt
block|,
name|DSDT_OFFSET
block|}
block|,
block|{
name|NULL
block|}
block|}
struct|;
end_struct

begin_function
name|int
name|acpi_build
parameter_list|(
name|struct
name|vmctx
modifier|*
name|ctx
parameter_list|,
name|int
name|ncpu
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|int
name|i
decl_stmt|;
name|basl_ncpu
operator|=
name|ncpu
expr_stmt|;
name|err
operator|=
name|vm_get_hpet_capabilities
argument_list|(
name|ctx
argument_list|,
operator|&
name|hpet_capabilities
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
return|return
operator|(
name|err
operator|)
return|;
comment|/* 	 * For debug, allow the user to have iasl compiler output sent 	 * to stdout rather than /dev/null 	 */
if|if
condition|(
name|getenv
argument_list|(
literal|"BHYVE_ACPI_VERBOSE_IASL"
argument_list|)
condition|)
name|basl_verbose_iasl
operator|=
literal|1
expr_stmt|;
comment|/* 	 * Allow the user to keep the generated ASL files for debugging 	 * instead of deleting them following use 	 */
if|if
condition|(
name|getenv
argument_list|(
literal|"BHYVE_ACPI_KEEPTMPS"
argument_list|)
condition|)
name|basl_keep_temps
operator|=
literal|1
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
name|err
operator|=
name|basl_make_templates
argument_list|()
expr_stmt|;
comment|/* 	 * Run through all the ASL files, compiling them and 	 * copying them into guest memory 	 */
while|while
condition|(
operator|!
name|err
operator|&&
name|basl_ftables
index|[
name|i
index|]
operator|.
name|wsect
operator|!=
name|NULL
condition|)
block|{
name|err
operator|=
name|basl_compile
argument_list|(
name|ctx
argument_list|,
name|basl_ftables
index|[
name|i
index|]
operator|.
name|wsect
argument_list|,
name|basl_ftables
index|[
name|i
index|]
operator|.
name|offset
argument_list|)
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2014 Leon Dang<ldang@nahannisys.com>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_comment
comment|/*    XHCI options:     -s<n>,xhci,{devices}     devices:      tablet             USB tablet mouse  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/uio.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<stdint.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<pthread.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usbdi.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb_freebsd.h>
end_include

begin_include
include|#
directive|include
file|<xhcireg.h>
end_include

begin_include
include|#
directive|include
file|"bhyverun.h"
end_include

begin_include
include|#
directive|include
file|"pci_emul.h"
end_include

begin_include
include|#
directive|include
file|"pci_xhci.h"
end_include

begin_include
include|#
directive|include
file|"usb_emul.h"
end_include

begin_decl_stmt
specifier|static
name|int
name|xhci_debug
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|DPRINTF
parameter_list|(
name|params
parameter_list|)
value|if (xhci_debug) printf params
end_define

begin_define
define|#
directive|define
name|WPRINTF
parameter_list|(
name|params
parameter_list|)
value|printf params
end_define

begin_define
define|#
directive|define
name|XHCI_NAME
value|"xhci"
end_define

begin_define
define|#
directive|define
name|XHCI_MAX_DEVS
value|8
end_define

begin_comment
comment|/* 4 USB3 + 4 USB2 devs */
end_comment

begin_define
define|#
directive|define
name|XHCI_MAX_SLOTS
value|64
end_define

begin_comment
comment|/* min allowed by Windows drivers */
end_comment

begin_comment
comment|/*  * XHCI data structures can be up to 64k, but limit paddr_guest2host mapping  * to 4k to avoid going over the guest physical memory barrier.  */
end_comment

begin_define
define|#
directive|define
name|XHCI_PADDR_SZ
value|4096
end_define

begin_comment
comment|/* paddr_guest2host max size */
end_comment

begin_define
define|#
directive|define
name|XHCI_ERST_MAX
value|0
end_define

begin_comment
comment|/* max 2^entries event ring seg tbl */
end_comment

begin_define
define|#
directive|define
name|XHCI_CAPLEN
value|(4*8)
end_define

begin_comment
comment|/* offset of op register space */
end_comment

begin_define
define|#
directive|define
name|XHCI_HCCPRAMS2
value|0x1C
end_define

begin_comment
comment|/* offset of HCCPARAMS2 register */
end_comment

begin_define
define|#
directive|define
name|XHCI_PORTREGS_START
value|0x400
end_define

begin_define
define|#
directive|define
name|XHCI_DOORBELL_MAX
value|256
end_define

begin_define
define|#
directive|define
name|XHCI_STREAMS_MAX
value|1
end_define

begin_comment
comment|/* 4-15 in XHCI spec */
end_comment

begin_comment
comment|/* caplength and hci-version registers */
end_comment

begin_define
define|#
directive|define
name|XHCI_SET_CAPLEN
parameter_list|(
name|x
parameter_list|)
value|((x)& 0xFF)
end_define

begin_define
define|#
directive|define
name|XHCI_SET_HCIVERSION
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0xFFFF)<< 16)
end_define

begin_define
define|#
directive|define
name|XHCI_GET_HCIVERSION
parameter_list|(
name|x
parameter_list|)
value|(((x)>> 16)& 0xFFFF)
end_define

begin_comment
comment|/* hcsparams1 register */
end_comment

begin_define
define|#
directive|define
name|XHCI_SET_HCSP1_MAXSLOTS
parameter_list|(
name|x
parameter_list|)
value|((x)& 0xFF)
end_define

begin_define
define|#
directive|define
name|XHCI_SET_HCSP1_MAXINTR
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0x7FF)<< 8)
end_define

begin_define
define|#
directive|define
name|XHCI_SET_HCSP1_MAXPORTS
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0xFF)<< 24)
end_define

begin_comment
comment|/* hcsparams2 register */
end_comment

begin_define
define|#
directive|define
name|XHCI_SET_HCSP2_IST
parameter_list|(
name|x
parameter_list|)
value|((x)& 0x0F)
end_define

begin_define
define|#
directive|define
name|XHCI_SET_HCSP2_ERSTMAX
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0x0F)<< 4)
end_define

begin_define
define|#
directive|define
name|XHCI_SET_HCSP2_MAXSCRATCH_HI
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0x1F)<< 21)
end_define

begin_define
define|#
directive|define
name|XHCI_SET_HCSP2_MAXSCRATCH_LO
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0x1F)<< 27)
end_define

begin_comment
comment|/* hcsparams3 register */
end_comment

begin_define
define|#
directive|define
name|XHCI_SET_HCSP3_U1EXITLATENCY
parameter_list|(
name|x
parameter_list|)
value|((x)& 0xFF)
end_define

begin_define
define|#
directive|define
name|XHCI_SET_HCSP3_U2EXITLATENCY
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0xFFFF)<< 16)
end_define

begin_comment
comment|/* hccparams1 register */
end_comment

begin_define
define|#
directive|define
name|XHCI_SET_HCCP1_AC64
parameter_list|(
name|x
parameter_list|)
value|((x)& 0x01)
end_define

begin_define
define|#
directive|define
name|XHCI_SET_HCCP1_BNC
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0x01)<< 1)
end_define

begin_define
define|#
directive|define
name|XHCI_SET_HCCP1_CSZ
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0x01)<< 2)
end_define

begin_define
define|#
directive|define
name|XHCI_SET_HCCP1_PPC
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0x01)<< 3)
end_define

begin_define
define|#
directive|define
name|XHCI_SET_HCCP1_PIND
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0x01)<< 4)
end_define

begin_define
define|#
directive|define
name|XHCI_SET_HCCP1_LHRC
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0x01)<< 5)
end_define

begin_define
define|#
directive|define
name|XHCI_SET_HCCP1_LTC
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0x01)<< 6)
end_define

begin_define
define|#
directive|define
name|XHCI_SET_HCCP1_NSS
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0x01)<< 7)
end_define

begin_define
define|#
directive|define
name|XHCI_SET_HCCP1_PAE
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0x01)<< 8)
end_define

begin_define
define|#
directive|define
name|XHCI_SET_HCCP1_SPC
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0x01)<< 9)
end_define

begin_define
define|#
directive|define
name|XHCI_SET_HCCP1_SEC
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0x01)<< 10)
end_define

begin_define
define|#
directive|define
name|XHCI_SET_HCCP1_CFC
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0x01)<< 11)
end_define

begin_define
define|#
directive|define
name|XHCI_SET_HCCP1_MAXPSA
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0x0F)<< 12)
end_define

begin_define
define|#
directive|define
name|XHCI_SET_HCCP1_XECP
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0xFFFF)<< 16)
end_define

begin_comment
comment|/* hccparams2 register */
end_comment

begin_define
define|#
directive|define
name|XHCI_SET_HCCP2_U3C
parameter_list|(
name|x
parameter_list|)
value|((x)& 0x01)
end_define

begin_define
define|#
directive|define
name|XHCI_SET_HCCP2_CMC
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0x01)<< 1)
end_define

begin_define
define|#
directive|define
name|XHCI_SET_HCCP2_FSC
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0x01)<< 2)
end_define

begin_define
define|#
directive|define
name|XHCI_SET_HCCP2_CTC
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0x01)<< 3)
end_define

begin_define
define|#
directive|define
name|XHCI_SET_HCCP2_LEC
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0x01)<< 4)
end_define

begin_define
define|#
directive|define
name|XHCI_SET_HCCP2_CIC
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0x01)<< 5)
end_define

begin_comment
comment|/* other registers */
end_comment

begin_define
define|#
directive|define
name|XHCI_SET_DOORBELL
parameter_list|(
name|x
parameter_list|)
value|((x)& ~0x03)
end_define

begin_define
define|#
directive|define
name|XHCI_SET_RTSOFFSET
parameter_list|(
name|x
parameter_list|)
value|((x)& ~0x0F)
end_define

begin_comment
comment|/* register masks */
end_comment

begin_define
define|#
directive|define
name|XHCI_PS_PLS_MASK
value|(0xF<< 5)
end_define

begin_comment
comment|/* port link state */
end_comment

begin_define
define|#
directive|define
name|XHCI_PS_SPEED_MASK
value|(0xF<< 10)
end_define

begin_comment
comment|/* port speed */
end_comment

begin_define
define|#
directive|define
name|XHCI_PS_PIC_MASK
value|(0x3<< 14)
end_define

begin_comment
comment|/* port indicator */
end_comment

begin_comment
comment|/* port register set */
end_comment

begin_define
define|#
directive|define
name|XHCI_PORTREGS_BASE
value|0x400
end_define

begin_comment
comment|/* base offset */
end_comment

begin_define
define|#
directive|define
name|XHCI_PORTREGS_PORT0
value|0x3F0
end_define

begin_define
define|#
directive|define
name|XHCI_PORTREGS_SETSZ
value|0x10
end_define

begin_comment
comment|/* size of a set */
end_comment

begin_define
define|#
directive|define
name|MASK_64_HI
parameter_list|(
name|x
parameter_list|)
value|((x)& ~0xFFFFFFFFULL)
end_define

begin_define
define|#
directive|define
name|MASK_64_LO
parameter_list|(
name|x
parameter_list|)
value|((x)& 0xFFFFFFFFULL)
end_define

begin_define
define|#
directive|define
name|FIELD_REPLACE
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|,
name|m
parameter_list|,
name|s
parameter_list|)
value|(((a)& ~((m)<< (s))) | \ 					(((b)& (m))<< (s)))
end_define

begin_define
define|#
directive|define
name|FIELD_COPY
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|,
name|m
parameter_list|,
name|s
parameter_list|)
value|(((a)& ~((m)<< (s))) | \ 					(((b)& ((m)<< (s)))))
end_define

begin_struct
struct|struct
name|pci_xhci_trb_ring
block|{
name|uint64_t
name|ringaddr
decl_stmt|;
comment|/* current dequeue guest address */
name|uint32_t
name|ccs
decl_stmt|;
comment|/* consumer cycle state */
block|}
struct|;
end_struct

begin_comment
comment|/* device endpoint transfer/stream rings */
end_comment

begin_struct
struct|struct
name|pci_xhci_dev_ep
block|{
union|union
block|{
name|struct
name|xhci_trb
modifier|*
name|_epu_tr
decl_stmt|;
name|struct
name|xhci_stream_ctx
modifier|*
name|_epu_sctx
decl_stmt|;
block|}
name|_ep_trbsctx
union|;
define|#
directive|define
name|ep_tr
value|_ep_trbsctx._epu_tr
define|#
directive|define
name|ep_sctx
value|_ep_trbsctx._epu_sctx
union|union
block|{
name|struct
name|pci_xhci_trb_ring
name|_epu_trb
decl_stmt|;
name|struct
name|pci_xhci_trb_ring
modifier|*
name|_epu_sctx_trbs
decl_stmt|;
block|}
name|_ep_trb_rings
union|;
define|#
directive|define
name|ep_ringaddr
value|_ep_trb_rings._epu_trb.ringaddr
define|#
directive|define
name|ep_ccs
value|_ep_trb_rings._epu_trb.ccs
define|#
directive|define
name|ep_sctx_trbs
value|_ep_trb_rings._epu_sctx_trbs
name|struct
name|usb_data_xfer
modifier|*
name|ep_xfer
decl_stmt|;
comment|/* transfer chain */
block|}
struct|;
end_struct

begin_comment
comment|/* device context base address array: maps slot->device context */
end_comment

begin_struct
struct|struct
name|xhci_dcbaa
block|{
name|uint64_t
name|dcba
index|[
name|USB_MAX_DEVICES
operator|+
literal|1
index|]
decl_stmt|;
comment|/* xhci_dev_ctx ptrs */
block|}
struct|;
end_struct

begin_comment
comment|/* port status registers */
end_comment

begin_struct
struct|struct
name|pci_xhci_portregs
block|{
name|uint32_t
name|portsc
decl_stmt|;
comment|/* port status and control */
name|uint32_t
name|portpmsc
decl_stmt|;
comment|/* port pwr mgmt status& control */
name|uint32_t
name|portli
decl_stmt|;
comment|/* port link info */
name|uint32_t
name|porthlpmc
decl_stmt|;
comment|/* port hardware LPM control */
block|}
name|__packed
struct|;
end_struct

begin_define
define|#
directive|define
name|XHCI_PS_SPEED_SET
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0xF)<< 10)
end_define

begin_comment
comment|/* xHC operational registers */
end_comment

begin_struct
struct|struct
name|pci_xhci_opregs
block|{
name|uint32_t
name|usbcmd
decl_stmt|;
comment|/* usb command */
name|uint32_t
name|usbsts
decl_stmt|;
comment|/* usb status */
name|uint32_t
name|pgsz
decl_stmt|;
comment|/* page size */
name|uint32_t
name|dnctrl
decl_stmt|;
comment|/* device notification control */
name|uint64_t
name|crcr
decl_stmt|;
comment|/* command ring control */
name|uint64_t
name|dcbaap
decl_stmt|;
comment|/* device ctx base addr array ptr */
name|uint32_t
name|config
decl_stmt|;
comment|/* configure */
comment|/* guest mapped addresses: */
name|struct
name|xhci_trb
modifier|*
name|cr_p
decl_stmt|;
comment|/* crcr dequeue */
name|struct
name|xhci_dcbaa
modifier|*
name|dcbaa_p
decl_stmt|;
comment|/* dev ctx array ptr */
block|}
struct|;
end_struct

begin_comment
comment|/* xHC runtime registers */
end_comment

begin_struct
struct|struct
name|pci_xhci_rtsregs
block|{
name|uint32_t
name|mfindex
decl_stmt|;
comment|/* microframe index */
struct|struct
block|{
comment|/* interrupter register set */
name|uint32_t
name|iman
decl_stmt|;
comment|/* interrupter management */
name|uint32_t
name|imod
decl_stmt|;
comment|/* interrupter moderation */
name|uint32_t
name|erstsz
decl_stmt|;
comment|/* event ring segment table size */
name|uint32_t
name|rsvd
decl_stmt|;
name|uint64_t
name|erstba
decl_stmt|;
comment|/* event ring seg-tbl base addr */
name|uint64_t
name|erdp
decl_stmt|;
comment|/* event ring dequeue ptr */
block|}
name|intrreg
name|__packed
struct|;
comment|/* guest mapped addresses */
name|struct
name|xhci_event_ring_seg
modifier|*
name|erstba_p
decl_stmt|;
name|struct
name|xhci_trb
modifier|*
name|erst_p
decl_stmt|;
comment|/* event ring segment tbl */
name|int
name|er_deq_seg
decl_stmt|;
comment|/* event ring dequeue segment */
name|int
name|er_enq_idx
decl_stmt|;
comment|/* event ring enqueue index - xHCI */
name|int
name|er_enq_seg
decl_stmt|;
comment|/* event ring enqueue segment */
name|uint32_t
name|er_events_cnt
decl_stmt|;
comment|/* number of events in ER */
name|uint32_t
name|event_pcs
decl_stmt|;
comment|/* producer cycle state flag */
block|}
struct|;
end_struct

begin_struct_decl
struct_decl|struct
name|pci_xhci_softc
struct_decl|;
end_struct_decl

begin_comment
comment|/*  * USB device emulation container.  * This is referenced from usb_hci->hci_sc; 1 pci_xhci_dev_emu for each  * emulated device instance.  */
end_comment

begin_struct
struct|struct
name|pci_xhci_dev_emu
block|{
name|struct
name|pci_xhci_softc
modifier|*
name|xsc
decl_stmt|;
comment|/* XHCI contexts */
name|struct
name|xhci_dev_ctx
modifier|*
name|dev_ctx
decl_stmt|;
name|struct
name|pci_xhci_dev_ep
name|eps
index|[
name|XHCI_MAX_ENDPOINTS
index|]
decl_stmt|;
name|int
name|dev_slotstate
decl_stmt|;
name|struct
name|usb_devemu
modifier|*
name|dev_ue
decl_stmt|;
comment|/* USB emulated dev */
name|void
modifier|*
name|dev_sc
decl_stmt|;
comment|/* device's softc */
name|struct
name|usb_hci
name|hci
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|pci_xhci_softc
block|{
name|struct
name|pci_devinst
modifier|*
name|xsc_pi
decl_stmt|;
name|pthread_mutex_t
name|mtx
decl_stmt|;
name|uint32_t
name|caplength
decl_stmt|;
comment|/* caplen& hciversion */
name|uint32_t
name|hcsparams1
decl_stmt|;
comment|/* structural parameters 1 */
name|uint32_t
name|hcsparams2
decl_stmt|;
comment|/* structural parameters 2 */
name|uint32_t
name|hcsparams3
decl_stmt|;
comment|/* structural parameters 3 */
name|uint32_t
name|hccparams1
decl_stmt|;
comment|/* capability parameters 1 */
name|uint32_t
name|dboff
decl_stmt|;
comment|/* doorbell offset */
name|uint32_t
name|rtsoff
decl_stmt|;
comment|/* runtime register space offset */
name|uint32_t
name|hccparams2
decl_stmt|;
comment|/* capability parameters 2 */
name|uint32_t
name|regsend
decl_stmt|;
comment|/* end of configuration registers */
name|struct
name|pci_xhci_opregs
name|opregs
decl_stmt|;
name|struct
name|pci_xhci_rtsregs
name|rtsregs
decl_stmt|;
name|struct
name|pci_xhci_portregs
modifier|*
name|portregs
decl_stmt|;
name|struct
name|pci_xhci_dev_emu
modifier|*
modifier|*
name|devices
decl_stmt|;
comment|/* XHCI[port] = device */
name|struct
name|pci_xhci_dev_emu
modifier|*
modifier|*
name|slots
decl_stmt|;
comment|/* slots assigned from 1 */
name|int
name|ndevices
decl_stmt|;
name|int
name|usb2_port_start
decl_stmt|;
name|int
name|usb3_port_start
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* portregs and devices arrays are set up to start from idx=1 */
end_comment

begin_define
define|#
directive|define
name|XHCI_PORTREG_PTR
parameter_list|(
name|x
parameter_list|,
name|n
parameter_list|)
value|&(x)->portregs[(n)]
end_define

begin_define
define|#
directive|define
name|XHCI_DEVINST_PTR
parameter_list|(
name|x
parameter_list|,
name|n
parameter_list|)
value|(x)->devices[(n)]
end_define

begin_define
define|#
directive|define
name|XHCI_SLOTDEV_PTR
parameter_list|(
name|x
parameter_list|,
name|n
parameter_list|)
value|(x)->slots[(n)]
end_define

begin_define
define|#
directive|define
name|XHCI_HALTED
parameter_list|(
name|sc
parameter_list|)
value|((sc)->opregs.usbsts& XHCI_STS_HCH)
end_define

begin_define
define|#
directive|define
name|XHCI_GADDR
parameter_list|(
name|sc
parameter_list|,
name|a
parameter_list|)
value|paddr_guest2host((sc)->xsc_pi->pi_vmctx, \ 				    (a),                                 \ 				    XHCI_PADDR_SZ - ((a)& (XHCI_PADDR_SZ-1)))
end_define

begin_decl_stmt
specifier|static
name|int
name|xhci_in_use
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* map USB errors to XHCI */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|int
name|xhci_usb_errors
index|[
name|USB_ERR_MAX
index|]
init|=
block|{
index|[
name|USB_ERR_NORMAL_COMPLETION
index|]
operator|=
name|XHCI_TRB_ERROR_SUCCESS
block|,
index|[
name|USB_ERR_PENDING_REQUESTS
index|]
operator|=
name|XHCI_TRB_ERROR_RESOURCE
block|,
index|[
name|USB_ERR_NOT_STARTED
index|]
operator|=
name|XHCI_TRB_ERROR_ENDP_NOT_ON
block|,
index|[
name|USB_ERR_INVAL
index|]
operator|=
name|XHCI_TRB_ERROR_INVALID
block|,
index|[
name|USB_ERR_NOMEM
index|]
operator|=
name|XHCI_TRB_ERROR_RESOURCE
block|,
index|[
name|USB_ERR_CANCELLED
index|]
operator|=
name|XHCI_TRB_ERROR_STOPPED
block|,
index|[
name|USB_ERR_BAD_ADDRESS
index|]
operator|=
name|XHCI_TRB_ERROR_PARAMETER
block|,
index|[
name|USB_ERR_BAD_BUFSIZE
index|]
operator|=
name|XHCI_TRB_ERROR_PARAMETER
block|,
index|[
name|USB_ERR_BAD_FLAG
index|]
operator|=
name|XHCI_TRB_ERROR_PARAMETER
block|,
index|[
name|USB_ERR_NO_CALLBACK
index|]
operator|=
name|XHCI_TRB_ERROR_STALL
block|,
index|[
name|USB_ERR_IN_USE
index|]
operator|=
name|XHCI_TRB_ERROR_RESOURCE
block|,
index|[
name|USB_ERR_NO_ADDR
index|]
operator|=
name|XHCI_TRB_ERROR_RESOURCE
block|,
index|[
name|USB_ERR_NO_PIPE
index|]
operator|=
name|XHCI_TRB_ERROR_RESOURCE
block|,
index|[
name|USB_ERR_ZERO_NFRAMES
index|]
operator|=
name|XHCI_TRB_ERROR_UNDEFINED
block|,
index|[
name|USB_ERR_ZERO_MAXP
index|]
operator|=
name|XHCI_TRB_ERROR_UNDEFINED
block|,
index|[
name|USB_ERR_SET_ADDR_FAILED
index|]
operator|=
name|XHCI_TRB_ERROR_RESOURCE
block|,
index|[
name|USB_ERR_NO_POWER
index|]
operator|=
name|XHCI_TRB_ERROR_ENDP_NOT_ON
block|,
index|[
name|USB_ERR_TOO_DEEP
index|]
operator|=
name|XHCI_TRB_ERROR_RESOURCE
block|,
index|[
name|USB_ERR_IOERROR
index|]
operator|=
name|XHCI_TRB_ERROR_TRB
block|,
index|[
name|USB_ERR_NOT_CONFIGURED
index|]
operator|=
name|XHCI_TRB_ERROR_ENDP_NOT_ON
block|,
index|[
name|USB_ERR_TIMEOUT
index|]
operator|=
name|XHCI_TRB_ERROR_CMD_ABORTED
block|,
index|[
name|USB_ERR_SHORT_XFER
index|]
operator|=
name|XHCI_TRB_ERROR_SHORT_PKT
block|,
index|[
name|USB_ERR_STALLED
index|]
operator|=
name|XHCI_TRB_ERROR_STALL
block|,
index|[
name|USB_ERR_INTERRUPTED
index|]
operator|=
name|XHCI_TRB_ERROR_CMD_ABORTED
block|,
index|[
name|USB_ERR_DMA_LOAD_FAILED
index|]
operator|=
name|XHCI_TRB_ERROR_DATA_BUF
block|,
index|[
name|USB_ERR_BAD_CONTEXT
index|]
operator|=
name|XHCI_TRB_ERROR_TRB
block|,
index|[
name|USB_ERR_NO_ROOT_HUB
index|]
operator|=
name|XHCI_TRB_ERROR_UNDEFINED
block|,
index|[
name|USB_ERR_NO_INTR_THREAD
index|]
operator|=
name|XHCI_TRB_ERROR_UNDEFINED
block|,
index|[
name|USB_ERR_NOT_LOCKED
index|]
operator|=
name|XHCI_TRB_ERROR_UNDEFINED
block|, }
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|USB_TO_XHCI_ERR
parameter_list|(
name|e
parameter_list|)
value|((e)< USB_ERR_MAX ? xhci_usb_errors[(e)] : \ 				XHCI_TRB_ERROR_INVALID)
end_define

begin_function_decl
specifier|static
name|int
name|pci_xhci_insert_event
parameter_list|(
name|struct
name|pci_xhci_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|xhci_trb
modifier|*
name|evtrb
parameter_list|,
name|int
name|do_intr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|pci_xhci_dump_trb
parameter_list|(
name|struct
name|xhci_trb
modifier|*
name|trb
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|pci_xhci_assert_interrupt
parameter_list|(
name|struct
name|pci_xhci_softc
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|pci_xhci_reset_slot
parameter_list|(
name|struct
name|pci_xhci_softc
modifier|*
name|sc
parameter_list|,
name|int
name|slot
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|pci_xhci_reset_port
parameter_list|(
name|struct
name|pci_xhci_softc
modifier|*
name|sc
parameter_list|,
name|int
name|portn
parameter_list|,
name|int
name|warm
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|pci_xhci_update_ep_ring
parameter_list|(
name|struct
name|pci_xhci_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|pci_xhci_dev_emu
modifier|*
name|dev
parameter_list|,
name|struct
name|pci_xhci_dev_ep
modifier|*
name|devep
parameter_list|,
name|struct
name|xhci_endp_ctx
modifier|*
name|ep_ctx
parameter_list|,
name|uint32_t
name|streamid
parameter_list|,
name|uint64_t
name|ringaddr
parameter_list|,
name|int
name|ccs
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|void
name|pci_xhci_set_evtrb
parameter_list|(
name|struct
name|xhci_trb
modifier|*
name|evtrb
parameter_list|,
name|uint64_t
name|port
parameter_list|,
name|uint32_t
name|errcode
parameter_list|,
name|uint32_t
name|evtype
parameter_list|)
block|{
name|evtrb
operator|->
name|qwTrb0
operator|=
name|port
operator|<<
literal|24
expr_stmt|;
name|evtrb
operator|->
name|dwTrb2
operator|=
name|XHCI_TRB_2_ERROR_SET
argument_list|(
name|errcode
argument_list|)
expr_stmt|;
name|evtrb
operator|->
name|dwTrb3
operator|=
name|XHCI_TRB_3_TYPE_SET
argument_list|(
name|evtype
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* controller reset */
end_comment

begin_function
specifier|static
name|void
name|pci_xhci_reset
parameter_list|(
name|struct
name|pci_xhci_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|sc
operator|->
name|rtsregs
operator|.
name|er_enq_idx
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|rtsregs
operator|.
name|er_events_cnt
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|rtsregs
operator|.
name|event_pcs
operator|=
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
name|XHCI_MAX_SLOTS
condition|;
name|i
operator|++
control|)
block|{
name|pci_xhci_reset_slot
argument_list|(
name|sc
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|pci_xhci_usbcmd_write
parameter_list|(
name|struct
name|pci_xhci_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|cmd
parameter_list|)
block|{
name|int
name|do_intr
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|cmd
operator|&
name|XHCI_CMD_RS
condition|)
block|{
name|do_intr
operator|=
operator|(
name|sc
operator|->
name|opregs
operator|.
name|usbcmd
operator|&
name|XHCI_CMD_RS
operator|)
operator|==
literal|0
expr_stmt|;
name|sc
operator|->
name|opregs
operator|.
name|usbcmd
operator||=
name|XHCI_CMD_RS
expr_stmt|;
name|sc
operator|->
name|opregs
operator|.
name|usbsts
operator|&=
operator|~
name|XHCI_STS_HCH
expr_stmt|;
name|sc
operator|->
name|opregs
operator|.
name|usbsts
operator||=
name|XHCI_STS_PCD
expr_stmt|;
comment|/* Queue port change event on controller run from stop */
if|if
condition|(
name|do_intr
condition|)
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
name|XHCI_MAX_DEVS
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|pci_xhci_dev_emu
modifier|*
name|dev
decl_stmt|;
name|struct
name|pci_xhci_portregs
modifier|*
name|port
decl_stmt|;
name|struct
name|xhci_trb
name|evtrb
decl_stmt|;
if|if
condition|(
operator|(
name|dev
operator|=
name|XHCI_DEVINST_PTR
argument_list|(
name|sc
argument_list|,
name|i
argument_list|)
operator|)
operator|==
name|NULL
condition|)
continue|continue;
name|port
operator|=
name|XHCI_PORTREG_PTR
argument_list|(
name|sc
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|port
operator|->
name|portsc
operator||=
name|XHCI_PS_CSC
operator||
name|XHCI_PS_CCS
expr_stmt|;
name|port
operator|->
name|portsc
operator|&=
operator|~
name|XHCI_PS_PLS_MASK
expr_stmt|;
comment|/* 				 * XHCI 4.19.3 USB2 RxDetect->Polling, 				 *             USB3 Polling->U0 				 */
if|if
condition|(
name|dev
operator|->
name|dev_ue
operator|->
name|ue_usbver
operator|==
literal|2
condition|)
name|port
operator|->
name|portsc
operator||=
name|XHCI_PS_PLS_SET
argument_list|(
name|UPS_PORT_LS_POLL
argument_list|)
expr_stmt|;
else|else
name|port
operator|->
name|portsc
operator||=
name|XHCI_PS_PLS_SET
argument_list|(
name|UPS_PORT_LS_U0
argument_list|)
expr_stmt|;
name|pci_xhci_set_evtrb
argument_list|(
operator|&
name|evtrb
argument_list|,
name|i
argument_list|,
name|XHCI_TRB_ERROR_SUCCESS
argument_list|,
name|XHCI_TRB_EVENT_PORT_STS_CHANGE
argument_list|)
expr_stmt|;
if|if
condition|(
name|pci_xhci_insert_event
argument_list|(
name|sc
argument_list|,
operator|&
name|evtrb
argument_list|,
literal|0
argument_list|)
operator|!=
name|XHCI_TRB_ERROR_SUCCESS
condition|)
break|break;
block|}
block|}
else|else
block|{
name|sc
operator|->
name|opregs
operator|.
name|usbcmd
operator|&=
operator|~
name|XHCI_CMD_RS
expr_stmt|;
name|sc
operator|->
name|opregs
operator|.
name|usbsts
operator||=
name|XHCI_STS_HCH
expr_stmt|;
name|sc
operator|->
name|opregs
operator|.
name|usbsts
operator|&=
operator|~
name|XHCI_STS_PCD
expr_stmt|;
block|}
comment|/* start execution of schedule; stop when set to 0 */
name|cmd
operator||=
name|sc
operator|->
name|opregs
operator|.
name|usbcmd
operator|&
name|XHCI_CMD_RS
expr_stmt|;
if|if
condition|(
name|cmd
operator|&
name|XHCI_CMD_HCRST
condition|)
block|{
comment|/* reset controller */
name|pci_xhci_reset
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|cmd
operator|&=
operator|~
name|XHCI_CMD_HCRST
expr_stmt|;
block|}
name|cmd
operator|&=
operator|~
operator|(
name|XHCI_CMD_CSS
operator||
name|XHCI_CMD_CRS
operator|)
expr_stmt|;
if|if
condition|(
name|do_intr
condition|)
name|pci_xhci_assert_interrupt
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|cmd
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|pci_xhci_portregs_write
parameter_list|(
name|struct
name|pci_xhci_softc
modifier|*
name|sc
parameter_list|,
name|uint64_t
name|offset
parameter_list|,
name|uint64_t
name|value
parameter_list|)
block|{
name|struct
name|xhci_trb
name|evtrb
decl_stmt|;
name|struct
name|pci_xhci_portregs
modifier|*
name|p
decl_stmt|;
name|int
name|port
decl_stmt|;
name|uint32_t
name|oldpls
decl_stmt|,
name|newpls
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|portregs
operator|==
name|NULL
condition|)
return|return;
name|port
operator|=
operator|(
name|offset
operator|-
name|XHCI_PORTREGS_PORT0
operator|)
operator|/
name|XHCI_PORTREGS_SETSZ
expr_stmt|;
name|offset
operator|=
operator|(
name|offset
operator|-
name|XHCI_PORTREGS_PORT0
operator|)
operator|%
name|XHCI_PORTREGS_SETSZ
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci: portregs wr offset 0x%lx, port %u: 0x%lx\r\n"
operator|,
name|offset
operator|,
name|port
operator|,
name|value
operator|)
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|port
operator|>=
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|port
operator|>
name|XHCI_MAX_DEVS
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci: portregs_write port %d> ndevices\r\n"
operator|,
name|port
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|XHCI_DEVINST_PTR
argument_list|(
name|sc
argument_list|,
name|port
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci: portregs_write to unattached port %d\r\n"
operator|,
name|port
operator|)
argument_list|)
expr_stmt|;
block|}
name|p
operator|=
name|XHCI_PORTREG_PTR
argument_list|(
name|sc
argument_list|,
name|port
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|offset
condition|)
block|{
case|case
literal|0
case|:
comment|/* port reset or warm reset */
if|if
condition|(
name|value
operator|&
operator|(
name|XHCI_PS_PR
operator||
name|XHCI_PS_WPR
operator|)
condition|)
block|{
name|pci_xhci_reset_port
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|value
operator|&
name|XHCI_PS_WPR
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|(
name|p
operator|->
name|portsc
operator|&
name|XHCI_PS_PP
operator|)
operator|==
literal|0
condition|)
block|{
name|WPRINTF
argument_list|(
operator|(
literal|"pci_xhci: portregs_write to unpowered "
literal|"port %d\r\n"
operator|,
name|port
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* Port status and control register  */
name|oldpls
operator|=
name|XHCI_PS_PLS_GET
argument_list|(
name|p
operator|->
name|portsc
argument_list|)
expr_stmt|;
name|newpls
operator|=
name|XHCI_PS_PLS_GET
argument_list|(
name|value
argument_list|)
expr_stmt|;
name|p
operator|->
name|portsc
operator|&=
name|XHCI_PS_PED
operator||
name|XHCI_PS_PLS_MASK
operator||
name|XHCI_PS_SPEED_MASK
operator||
name|XHCI_PS_PIC_MASK
expr_stmt|;
if|if
condition|(
name|XHCI_DEVINST_PTR
argument_list|(
name|sc
argument_list|,
name|port
argument_list|)
condition|)
name|p
operator|->
name|portsc
operator||=
name|XHCI_PS_CCS
expr_stmt|;
name|p
operator|->
name|portsc
operator||=
operator|(
name|value
operator|&
operator|~
operator|(
name|XHCI_PS_OCA
operator||
name|XHCI_PS_PR
operator||
name|XHCI_PS_PED
operator||
name|XHCI_PS_PLS_MASK
operator||
comment|/* link state */
name|XHCI_PS_SPEED_MASK
operator||
name|XHCI_PS_PIC_MASK
operator||
comment|/* port indicator */
name|XHCI_PS_LWS
operator||
name|XHCI_PS_DR
operator||
name|XHCI_PS_WPR
operator|)
operator|)
expr_stmt|;
comment|/* clear control bits */
name|p
operator|->
name|portsc
operator|&=
operator|~
operator|(
name|value
operator|&
operator|(
name|XHCI_PS_CSC
operator||
name|XHCI_PS_PEC
operator||
name|XHCI_PS_WRC
operator||
name|XHCI_PS_OCC
operator||
name|XHCI_PS_PRC
operator||
name|XHCI_PS_PLC
operator||
name|XHCI_PS_CEC
operator||
name|XHCI_PS_CAS
operator|)
operator|)
expr_stmt|;
comment|/* port disable request; for USB3, don't care */
if|if
condition|(
name|value
operator|&
name|XHCI_PS_PED
condition|)
name|DPRINTF
argument_list|(
operator|(
literal|"Disable port %d request\r\n"
operator|,
name|port
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|value
operator|&
name|XHCI_PS_LWS
operator|)
condition|)
break|break;
name|DPRINTF
argument_list|(
operator|(
literal|"Port new PLS: %d\r\n"
operator|,
name|newpls
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|newpls
condition|)
block|{
case|case
literal|0
case|:
comment|/* U0 */
case|case
literal|3
case|:
comment|/* U3 */
if|if
condition|(
name|oldpls
operator|!=
name|newpls
condition|)
block|{
name|p
operator|->
name|portsc
operator|&=
operator|~
name|XHCI_PS_PLS_MASK
expr_stmt|;
name|p
operator|->
name|portsc
operator||=
name|XHCI_PS_PLS_SET
argument_list|(
name|newpls
argument_list|)
operator||
name|XHCI_PS_PLC
expr_stmt|;
if|if
condition|(
name|oldpls
operator|!=
literal|0
operator|&&
name|newpls
operator|==
literal|0
condition|)
block|{
name|pci_xhci_set_evtrb
argument_list|(
operator|&
name|evtrb
argument_list|,
name|port
argument_list|,
name|XHCI_TRB_ERROR_SUCCESS
argument_list|,
name|XHCI_TRB_EVENT_PORT_STS_CHANGE
argument_list|)
expr_stmt|;
name|pci_xhci_insert_event
argument_list|(
name|sc
argument_list|,
operator|&
name|evtrb
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
default|default:
name|DPRINTF
argument_list|(
operator|(
literal|"Unhandled change port %d PLS %u\r\n"
operator|,
name|port
operator|,
name|newpls
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|4
case|:
comment|/* Port power management status and control register  */
name|p
operator|->
name|portpmsc
operator|=
name|value
expr_stmt|;
break|break;
case|case
literal|8
case|:
comment|/* Port link information register */
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci attempted write to PORTLI, port %d\r\n"
operator|,
name|port
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|12
case|:
comment|/* 		 * Port hardware LPM control register. 		 * For USB3, this register is reserved. 		 */
name|p
operator|->
name|porthlpmc
operator|=
name|value
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
name|struct
name|xhci_dev_ctx
modifier|*
name|pci_xhci_get_dev_ctx
parameter_list|(
name|struct
name|pci_xhci_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|slot
parameter_list|)
block|{
name|uint64_t
name|devctx_addr
decl_stmt|;
name|struct
name|xhci_dev_ctx
modifier|*
name|devctx
decl_stmt|;
name|assert
argument_list|(
name|slot
operator|>
literal|0
operator|&&
name|slot
operator|<=
name|sc
operator|->
name|ndevices
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|sc
operator|->
name|opregs
operator|.
name|dcbaa_p
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|devctx_addr
operator|=
name|sc
operator|->
name|opregs
operator|.
name|dcbaa_p
operator|->
name|dcba
index|[
name|slot
index|]
expr_stmt|;
if|if
condition|(
name|devctx_addr
operator|==
literal|0
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"get_dev_ctx devctx_addr == 0\r\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci: get dev ctx, slot %u devctx addr %016lx\r\n"
operator|,
name|slot
operator|,
name|devctx_addr
operator|)
argument_list|)
expr_stmt|;
name|devctx
operator|=
name|XHCI_GADDR
argument_list|(
name|sc
argument_list|,
name|devctx_addr
operator|&
operator|~
literal|0x3FUL
argument_list|)
expr_stmt|;
return|return
operator|(
name|devctx
operator|)
return|;
block|}
end_function

begin_function
name|struct
name|xhci_trb
modifier|*
name|pci_xhci_trb_next
parameter_list|(
name|struct
name|pci_xhci_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|xhci_trb
modifier|*
name|curtrb
parameter_list|,
name|uint64_t
modifier|*
name|guestaddr
parameter_list|)
block|{
name|struct
name|xhci_trb
modifier|*
name|next
decl_stmt|;
name|assert
argument_list|(
name|curtrb
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|XHCI_TRB_3_TYPE_GET
argument_list|(
name|curtrb
operator|->
name|dwTrb3
argument_list|)
operator|==
name|XHCI_TRB_TYPE_LINK
condition|)
block|{
if|if
condition|(
name|guestaddr
condition|)
operator|*
name|guestaddr
operator|=
name|curtrb
operator|->
name|qwTrb0
operator|&
operator|~
literal|0xFUL
expr_stmt|;
name|next
operator|=
name|XHCI_GADDR
argument_list|(
name|sc
argument_list|,
name|curtrb
operator|->
name|qwTrb0
operator|&
operator|~
literal|0xFUL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|guestaddr
condition|)
operator|*
name|guestaddr
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|xhci_trb
argument_list|)
operator|&
operator|~
literal|0xFUL
expr_stmt|;
name|next
operator|=
name|curtrb
operator|+
literal|1
expr_stmt|;
block|}
return|return
operator|(
name|next
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|pci_xhci_assert_interrupt
parameter_list|(
name|struct
name|pci_xhci_softc
modifier|*
name|sc
parameter_list|)
block|{
name|sc
operator|->
name|rtsregs
operator|.
name|intrreg
operator|.
name|erdp
operator||=
name|XHCI_ERDP_LO_BUSY
expr_stmt|;
name|sc
operator|->
name|rtsregs
operator|.
name|intrreg
operator|.
name|iman
operator||=
name|XHCI_IMAN_INTR_PEND
expr_stmt|;
name|sc
operator|->
name|opregs
operator|.
name|usbsts
operator||=
name|XHCI_STS_EINT
expr_stmt|;
comment|/* only trigger interrupt if permitted */
if|if
condition|(
operator|(
name|sc
operator|->
name|opregs
operator|.
name|usbcmd
operator|&
name|XHCI_CMD_INTE
operator|)
operator|&&
operator|(
name|sc
operator|->
name|rtsregs
operator|.
name|intrreg
operator|.
name|iman
operator|&
name|XHCI_IMAN_INTR_ENA
operator|)
condition|)
block|{
if|if
condition|(
name|pci_msi_enabled
argument_list|(
name|sc
operator|->
name|xsc_pi
argument_list|)
condition|)
name|pci_generate_msi
argument_list|(
name|sc
operator|->
name|xsc_pi
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
name|pci_lintr_assert
argument_list|(
name|sc
operator|->
name|xsc_pi
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|pci_xhci_deassert_interrupt
parameter_list|(
name|struct
name|pci_xhci_softc
modifier|*
name|sc
parameter_list|)
block|{
if|if
condition|(
operator|!
name|pci_msi_enabled
argument_list|(
name|sc
operator|->
name|xsc_pi
argument_list|)
condition|)
name|pci_lintr_assert
argument_list|(
name|sc
operator|->
name|xsc_pi
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|pci_xhci_init_ep
parameter_list|(
name|struct
name|pci_xhci_dev_emu
modifier|*
name|dev
parameter_list|,
name|int
name|epid
parameter_list|)
block|{
name|struct
name|xhci_dev_ctx
modifier|*
name|dev_ctx
decl_stmt|;
name|struct
name|pci_xhci_dev_ep
modifier|*
name|devep
decl_stmt|;
name|struct
name|xhci_endp_ctx
modifier|*
name|ep_ctx
decl_stmt|;
name|uint32_t
name|pstreams
decl_stmt|;
name|int
name|i
decl_stmt|;
name|dev_ctx
operator|=
name|dev
operator|->
name|dev_ctx
expr_stmt|;
name|ep_ctx
operator|=
operator|&
name|dev_ctx
operator|->
name|ctx_ep
index|[
name|epid
index|]
expr_stmt|;
name|devep
operator|=
operator|&
name|dev
operator|->
name|eps
index|[
name|epid
index|]
expr_stmt|;
name|pstreams
operator|=
name|XHCI_EPCTX_0_MAXP_STREAMS_GET
argument_list|(
name|ep_ctx
operator|->
name|dwEpCtx0
argument_list|)
expr_stmt|;
if|if
condition|(
name|pstreams
operator|>
literal|0
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"init_ep %d with pstreams %d\r\n"
operator|,
name|epid
operator|,
name|pstreams
operator|)
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|devep
operator|->
name|ep_sctx_trbs
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|devep
operator|->
name|ep_sctx
operator|=
name|XHCI_GADDR
argument_list|(
name|dev
operator|->
name|xsc
argument_list|,
name|ep_ctx
operator|->
name|qwEpCtx2
operator|&
name|XHCI_EPCTX_2_TR_DQ_PTR_MASK
argument_list|)
expr_stmt|;
name|devep
operator|->
name|ep_sctx_trbs
operator|=
name|calloc
argument_list|(
name|pstreams
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|pci_xhci_trb_ring
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pstreams
condition|;
name|i
operator|++
control|)
block|{
name|devep
operator|->
name|ep_sctx_trbs
index|[
name|i
index|]
operator|.
name|ringaddr
operator|=
name|devep
operator|->
name|ep_sctx
index|[
name|i
index|]
operator|.
name|qwSctx0
operator|&
name|XHCI_SCTX_0_TR_DQ_PTR_MASK
expr_stmt|;
name|devep
operator|->
name|ep_sctx_trbs
index|[
name|i
index|]
operator|.
name|ccs
operator|=
name|XHCI_SCTX_0_DCS_GET
argument_list|(
name|devep
operator|->
name|ep_sctx
index|[
name|i
index|]
operator|.
name|qwSctx0
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"init_ep %d with no pstreams\r\n"
operator|,
name|epid
operator|)
argument_list|)
expr_stmt|;
name|devep
operator|->
name|ep_ringaddr
operator|=
name|ep_ctx
operator|->
name|qwEpCtx2
operator|&
name|XHCI_EPCTX_2_TR_DQ_PTR_MASK
expr_stmt|;
name|devep
operator|->
name|ep_ccs
operator|=
name|XHCI_EPCTX_2_DCS_GET
argument_list|(
name|ep_ctx
operator|->
name|qwEpCtx2
argument_list|)
expr_stmt|;
name|devep
operator|->
name|ep_tr
operator|=
name|XHCI_GADDR
argument_list|(
name|dev
operator|->
name|xsc
argument_list|,
name|devep
operator|->
name|ep_ringaddr
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"init_ep tr DCS %x\r\n"
operator|,
name|devep
operator|->
name|ep_ccs
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|devep
operator|->
name|ep_xfer
operator|==
name|NULL
condition|)
block|{
name|devep
operator|->
name|ep_xfer
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|usb_data_xfer
argument_list|)
argument_list|)
expr_stmt|;
name|USB_DATA_XFER_INIT
argument_list|(
name|devep
operator|->
name|ep_xfer
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|pci_xhci_disable_ep
parameter_list|(
name|struct
name|pci_xhci_dev_emu
modifier|*
name|dev
parameter_list|,
name|int
name|epid
parameter_list|)
block|{
name|struct
name|xhci_dev_ctx
modifier|*
name|dev_ctx
decl_stmt|;
name|struct
name|pci_xhci_dev_ep
modifier|*
name|devep
decl_stmt|;
name|struct
name|xhci_endp_ctx
modifier|*
name|ep_ctx
decl_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci disable_ep %d\r\n"
operator|,
name|epid
operator|)
argument_list|)
expr_stmt|;
name|dev_ctx
operator|=
name|dev
operator|->
name|dev_ctx
expr_stmt|;
name|ep_ctx
operator|=
operator|&
name|dev_ctx
operator|->
name|ctx_ep
index|[
name|epid
index|]
expr_stmt|;
name|ep_ctx
operator|->
name|dwEpCtx0
operator|=
operator|(
name|ep_ctx
operator|->
name|dwEpCtx0
operator|&
operator|~
literal|0x7
operator|)
operator||
name|XHCI_ST_EPCTX_DISABLED
expr_stmt|;
name|devep
operator|=
operator|&
name|dev
operator|->
name|eps
index|[
name|epid
index|]
expr_stmt|;
if|if
condition|(
name|XHCI_EPCTX_0_MAXP_STREAMS_GET
argument_list|(
name|ep_ctx
operator|->
name|dwEpCtx0
argument_list|)
operator|>
literal|0
operator|&&
name|devep
operator|->
name|ep_sctx_trbs
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|devep
operator|->
name|ep_sctx_trbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|devep
operator|->
name|ep_xfer
operator|!=
name|NULL
condition|)
block|{
name|free
argument_list|(
name|devep
operator|->
name|ep_xfer
argument_list|)
expr_stmt|;
name|devep
operator|->
name|ep_xfer
operator|=
name|NULL
expr_stmt|;
block|}
name|memset
argument_list|(
name|devep
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|pci_xhci_dev_ep
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* reset device at slot and data structures related to it */
end_comment

begin_function
specifier|static
name|void
name|pci_xhci_reset_slot
parameter_list|(
name|struct
name|pci_xhci_softc
modifier|*
name|sc
parameter_list|,
name|int
name|slot
parameter_list|)
block|{
name|struct
name|pci_xhci_dev_emu
modifier|*
name|dev
decl_stmt|;
name|dev
operator|=
name|XHCI_SLOTDEV_PTR
argument_list|(
name|sc
argument_list|,
name|slot
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dev
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"xhci reset unassigned slot (%d)?\r\n"
operator|,
name|slot
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|dev
operator|->
name|dev_slotstate
operator|=
name|XHCI_ST_DISABLED
expr_stmt|;
block|}
comment|/* TODO: reset ring buffer pointers */
block|}
end_function

begin_function
specifier|static
name|int
name|pci_xhci_insert_event
parameter_list|(
name|struct
name|pci_xhci_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|xhci_trb
modifier|*
name|evtrb
parameter_list|,
name|int
name|do_intr
parameter_list|)
block|{
name|struct
name|pci_xhci_rtsregs
modifier|*
name|rts
decl_stmt|;
name|uint64_t
name|erdp
decl_stmt|;
name|int
name|erdp_idx
decl_stmt|;
name|int
name|err
decl_stmt|;
name|struct
name|xhci_trb
modifier|*
name|evtrbptr
decl_stmt|;
name|err
operator|=
name|XHCI_TRB_ERROR_SUCCESS
expr_stmt|;
name|rts
operator|=
operator|&
name|sc
operator|->
name|rtsregs
expr_stmt|;
name|erdp
operator|=
name|rts
operator|->
name|intrreg
operator|.
name|erdp
operator|&
operator|~
literal|0xF
expr_stmt|;
name|erdp_idx
operator|=
operator|(
name|erdp
operator|-
name|rts
operator|->
name|erstba_p
index|[
name|rts
operator|->
name|er_deq_seg
index|]
operator|.
name|qwEvrsTablePtr
operator|)
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|xhci_trb
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci: insert event 0[%lx] 2[%x] 3[%x]\r\n"
literal|"\terdp idx %d/seg %d, enq idx %d/seg %d, pcs %u\r\n"
literal|"\t(erdp=0x%lx, erst=0x%lx, tblsz=%u, do_intr %d)\r\n"
operator|,
name|evtrb
operator|->
name|qwTrb0
operator|,
name|evtrb
operator|->
name|dwTrb2
operator|,
name|evtrb
operator|->
name|dwTrb3
operator|,
name|erdp_idx
operator|,
name|rts
operator|->
name|er_deq_seg
operator|,
name|rts
operator|->
name|er_enq_idx
operator|,
name|rts
operator|->
name|er_enq_seg
operator|,
name|rts
operator|->
name|event_pcs
operator|,
name|erdp
operator|,
name|rts
operator|->
name|erstba_p
operator|->
name|qwEvrsTablePtr
operator|,
name|rts
operator|->
name|erstba_p
operator|->
name|dwEvrsTableSize
operator|,
name|do_intr
operator|)
argument_list|)
expr_stmt|;
name|evtrbptr
operator|=
operator|&
name|rts
operator|->
name|erst_p
index|[
name|rts
operator|->
name|er_enq_idx
index|]
expr_stmt|;
comment|/* TODO: multi-segment table */
if|if
condition|(
name|rts
operator|->
name|er_events_cnt
operator|>=
name|rts
operator|->
name|erstba_p
operator|->
name|dwEvrsTableSize
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci[%d] cannot insert event; ring full\r\n"
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|XHCI_TRB_ERROR_EV_RING_FULL
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|rts
operator|->
name|er_events_cnt
operator|==
name|rts
operator|->
name|erstba_p
operator|->
name|dwEvrsTableSize
operator|-
literal|1
condition|)
block|{
name|struct
name|xhci_trb
name|errev
decl_stmt|;
if|if
condition|(
operator|(
name|evtrbptr
operator|->
name|dwTrb3
operator|&
literal|0x1
operator|)
operator|==
operator|(
name|rts
operator|->
name|event_pcs
operator|&
literal|0x1
operator|)
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci[%d] insert evt err: ring full\r\n"
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
name|errev
operator|.
name|qwTrb0
operator|=
literal|0
expr_stmt|;
name|errev
operator|.
name|dwTrb2
operator|=
name|XHCI_TRB_2_ERROR_SET
argument_list|(
name|XHCI_TRB_ERROR_EV_RING_FULL
argument_list|)
expr_stmt|;
name|errev
operator|.
name|dwTrb3
operator|=
name|XHCI_TRB_3_TYPE_SET
argument_list|(
name|XHCI_TRB_EVENT_HOST_CTRL
argument_list|)
operator||
name|rts
operator|->
name|event_pcs
expr_stmt|;
name|rts
operator|->
name|er_events_cnt
operator|++
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|rts
operator|->
name|erst_p
index|[
name|rts
operator|->
name|er_enq_idx
index|]
argument_list|,
operator|&
name|errev
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|xhci_trb
argument_list|)
argument_list|)
expr_stmt|;
name|rts
operator|->
name|er_enq_idx
operator|=
operator|(
name|rts
operator|->
name|er_enq_idx
operator|+
literal|1
operator|)
operator|%
name|rts
operator|->
name|erstba_p
operator|->
name|dwEvrsTableSize
expr_stmt|;
name|err
operator|=
name|XHCI_TRB_ERROR_EV_RING_FULL
expr_stmt|;
name|do_intr
operator|=
literal|1
expr_stmt|;
goto|goto
name|done
goto|;
block|}
block|}
else|else
block|{
name|rts
operator|->
name|er_events_cnt
operator|++
expr_stmt|;
block|}
name|evtrb
operator|->
name|dwTrb3
operator|&=
operator|~
name|XHCI_TRB_3_CYCLE_BIT
expr_stmt|;
name|evtrb
operator|->
name|dwTrb3
operator||=
name|rts
operator|->
name|event_pcs
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|rts
operator|->
name|erst_p
index|[
name|rts
operator|->
name|er_enq_idx
index|]
argument_list|,
name|evtrb
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|xhci_trb
argument_list|)
argument_list|)
expr_stmt|;
name|rts
operator|->
name|er_enq_idx
operator|=
operator|(
name|rts
operator|->
name|er_enq_idx
operator|+
literal|1
operator|)
operator|%
name|rts
operator|->
name|erstba_p
operator|->
name|dwEvrsTableSize
expr_stmt|;
if|if
condition|(
name|rts
operator|->
name|er_enq_idx
operator|==
literal|0
condition|)
name|rts
operator|->
name|event_pcs
operator|^=
literal|1
expr_stmt|;
name|done
label|:
if|if
condition|(
name|do_intr
condition|)
name|pci_xhci_assert_interrupt
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|pci_xhci_cmd_enable_slot
parameter_list|(
name|struct
name|pci_xhci_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
modifier|*
name|slot
parameter_list|)
block|{
name|struct
name|pci_xhci_dev_emu
modifier|*
name|dev
decl_stmt|;
name|uint32_t
name|cmderr
decl_stmt|;
name|int
name|i
decl_stmt|;
name|cmderr
operator|=
name|XHCI_TRB_ERROR_NO_SLOTS
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|portregs
operator|!=
name|NULL
condition|)
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
name|XHCI_MAX_SLOTS
condition|;
name|i
operator|++
control|)
block|{
name|dev
operator|=
name|XHCI_SLOTDEV_PTR
argument_list|(
name|sc
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev
operator|&&
name|dev
operator|->
name|dev_slotstate
operator|==
name|XHCI_ST_DISABLED
condition|)
block|{
operator|*
name|slot
operator|=
name|i
expr_stmt|;
name|dev
operator|->
name|dev_slotstate
operator|=
name|XHCI_ST_ENABLED
expr_stmt|;
name|cmderr
operator|=
name|XHCI_TRB_ERROR_SUCCESS
expr_stmt|;
name|dev
operator|->
name|hci
operator|.
name|hci_address
operator|=
name|i
expr_stmt|;
break|break;
block|}
block|}
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci enable slot (error=%d) slot %u\r\n"
operator|,
name|cmderr
operator|!=
name|XHCI_TRB_ERROR_SUCCESS
operator|,
operator|*
name|slot
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|cmderr
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|pci_xhci_cmd_disable_slot
parameter_list|(
name|struct
name|pci_xhci_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|slot
parameter_list|)
block|{
name|struct
name|pci_xhci_dev_emu
modifier|*
name|dev
decl_stmt|;
name|uint32_t
name|cmderr
decl_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci disable slot %u\r\n"
operator|,
name|slot
operator|)
argument_list|)
expr_stmt|;
name|cmderr
operator|=
name|XHCI_TRB_ERROR_NO_SLOTS
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|portregs
operator|==
name|NULL
condition|)
goto|goto
name|done
goto|;
if|if
condition|(
name|slot
operator|>
name|sc
operator|->
name|ndevices
condition|)
block|{
name|cmderr
operator|=
name|XHCI_TRB_ERROR_SLOT_NOT_ON
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|dev
operator|=
name|XHCI_SLOTDEV_PTR
argument_list|(
name|sc
argument_list|,
name|slot
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev
condition|)
block|{
if|if
condition|(
name|dev
operator|->
name|dev_slotstate
operator|==
name|XHCI_ST_DISABLED
condition|)
block|{
name|cmderr
operator|=
name|XHCI_TRB_ERROR_SLOT_NOT_ON
expr_stmt|;
block|}
else|else
block|{
name|dev
operator|->
name|dev_slotstate
operator|=
name|XHCI_ST_DISABLED
expr_stmt|;
name|cmderr
operator|=
name|XHCI_TRB_ERROR_SUCCESS
expr_stmt|;
comment|/* TODO: reset events and endpoints */
block|}
block|}
name|done
label|:
return|return
operator|(
name|cmderr
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|pci_xhci_cmd_reset_device
parameter_list|(
name|struct
name|pci_xhci_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|slot
parameter_list|)
block|{
name|struct
name|pci_xhci_dev_emu
modifier|*
name|dev
decl_stmt|;
name|struct
name|xhci_dev_ctx
modifier|*
name|dev_ctx
decl_stmt|;
name|struct
name|xhci_endp_ctx
modifier|*
name|ep_ctx
decl_stmt|;
name|uint32_t
name|cmderr
decl_stmt|;
name|int
name|i
decl_stmt|;
name|cmderr
operator|=
name|XHCI_TRB_ERROR_NO_SLOTS
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|portregs
operator|==
name|NULL
condition|)
goto|goto
name|done
goto|;
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci reset device slot %u\r\n"
operator|,
name|slot
operator|)
argument_list|)
expr_stmt|;
name|dev
operator|=
name|XHCI_SLOTDEV_PTR
argument_list|(
name|sc
argument_list|,
name|slot
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dev
operator|||
name|dev
operator|->
name|dev_slotstate
operator|==
name|XHCI_ST_DISABLED
condition|)
name|cmderr
operator|=
name|XHCI_TRB_ERROR_SLOT_NOT_ON
expr_stmt|;
else|else
block|{
name|dev
operator|->
name|dev_slotstate
operator|=
name|XHCI_ST_DEFAULT
expr_stmt|;
name|dev
operator|->
name|hci
operator|.
name|hci_address
operator|=
literal|0
expr_stmt|;
name|dev_ctx
operator|=
name|pci_xhci_get_dev_ctx
argument_list|(
name|sc
argument_list|,
name|slot
argument_list|)
expr_stmt|;
comment|/* slot state */
name|dev_ctx
operator|->
name|ctx_slot
operator|.
name|dwSctx3
operator|=
name|FIELD_REPLACE
argument_list|(
name|dev_ctx
operator|->
name|ctx_slot
operator|.
name|dwSctx3
argument_list|,
name|XHCI_ST_SLCTX_DEFAULT
argument_list|,
literal|0x1F
argument_list|,
literal|27
argument_list|)
expr_stmt|;
comment|/* number of contexts */
name|dev_ctx
operator|->
name|ctx_slot
operator|.
name|dwSctx0
operator|=
name|FIELD_REPLACE
argument_list|(
name|dev_ctx
operator|->
name|ctx_slot
operator|.
name|dwSctx0
argument_list|,
literal|1
argument_list|,
literal|0x1F
argument_list|,
literal|27
argument_list|)
expr_stmt|;
comment|/* reset all eps other than ep-0 */
for|for
control|(
name|i
operator|=
literal|2
init|;
name|i
operator|<=
literal|31
condition|;
name|i
operator|++
control|)
block|{
name|ep_ctx
operator|=
operator|&
name|dev_ctx
operator|->
name|ctx_ep
index|[
name|i
index|]
expr_stmt|;
name|ep_ctx
operator|->
name|dwEpCtx0
operator|=
name|FIELD_REPLACE
argument_list|(
name|ep_ctx
operator|->
name|dwEpCtx0
argument_list|,
name|XHCI_ST_EPCTX_DISABLED
argument_list|,
literal|0x7
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|cmderr
operator|=
name|XHCI_TRB_ERROR_SUCCESS
expr_stmt|;
block|}
name|pci_xhci_reset_slot
argument_list|(
name|sc
argument_list|,
name|slot
argument_list|)
expr_stmt|;
name|done
label|:
return|return
operator|(
name|cmderr
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|pci_xhci_cmd_address_device
parameter_list|(
name|struct
name|pci_xhci_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|slot
parameter_list|,
name|struct
name|xhci_trb
modifier|*
name|trb
parameter_list|)
block|{
name|struct
name|pci_xhci_dev_emu
modifier|*
name|dev
decl_stmt|;
name|struct
name|xhci_input_dev_ctx
modifier|*
name|input_ctx
decl_stmt|;
name|struct
name|xhci_slot_ctx
modifier|*
name|islot_ctx
decl_stmt|;
name|struct
name|xhci_dev_ctx
modifier|*
name|dev_ctx
decl_stmt|;
name|struct
name|xhci_endp_ctx
modifier|*
name|ep0_ctx
decl_stmt|;
name|uint32_t
name|cmderr
decl_stmt|;
name|input_ctx
operator|=
name|XHCI_GADDR
argument_list|(
name|sc
argument_list|,
name|trb
operator|->
name|qwTrb0
operator|&
operator|~
literal|0xFUL
argument_list|)
expr_stmt|;
name|islot_ctx
operator|=
operator|&
name|input_ctx
operator|->
name|ctx_slot
expr_stmt|;
name|ep0_ctx
operator|=
operator|&
name|input_ctx
operator|->
name|ctx_ep
index|[
literal|1
index|]
expr_stmt|;
name|cmderr
operator|=
name|XHCI_TRB_ERROR_SUCCESS
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci: address device, input ctl: D 0x%08x A 0x%08x,\r\n"
literal|"          slot %08x %08x %08x %08x\r\n"
literal|"          ep0  %08x %08x %016lx %08x\r\n"
operator|,
name|input_ctx
operator|->
name|ctx_input
operator|.
name|dwInCtx0
operator|,
name|input_ctx
operator|->
name|ctx_input
operator|.
name|dwInCtx1
operator|,
name|islot_ctx
operator|->
name|dwSctx0
operator|,
name|islot_ctx
operator|->
name|dwSctx1
operator|,
name|islot_ctx
operator|->
name|dwSctx2
operator|,
name|islot_ctx
operator|->
name|dwSctx3
operator|,
name|ep0_ctx
operator|->
name|dwEpCtx0
operator|,
name|ep0_ctx
operator|->
name|dwEpCtx1
operator|,
name|ep0_ctx
operator|->
name|qwEpCtx2
operator|,
name|ep0_ctx
operator|->
name|dwEpCtx4
operator|)
argument_list|)
expr_stmt|;
comment|/* when setting address: drop-ctx=0, add-ctx=slot+ep0 */
if|if
condition|(
operator|(
name|input_ctx
operator|->
name|ctx_input
operator|.
name|dwInCtx0
operator|!=
literal|0
operator|)
operator|||
operator|(
name|input_ctx
operator|->
name|ctx_input
operator|.
name|dwInCtx1
operator|&
literal|0x03
operator|)
operator|!=
literal|0x03
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci: address device, input ctl invalid\r\n"
operator|)
argument_list|)
expr_stmt|;
name|cmderr
operator|=
name|XHCI_TRB_ERROR_TRB
expr_stmt|;
goto|goto
name|done
goto|;
block|}
comment|/* assign address to slot */
name|dev_ctx
operator|=
name|pci_xhci_get_dev_ctx
argument_list|(
name|sc
argument_list|,
name|slot
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci: address device, dev ctx\r\n"
literal|"          slot %08x %08x %08x %08x\r\n"
operator|,
name|dev_ctx
operator|->
name|ctx_slot
operator|.
name|dwSctx0
operator|,
name|dev_ctx
operator|->
name|ctx_slot
operator|.
name|dwSctx1
operator|,
name|dev_ctx
operator|->
name|ctx_slot
operator|.
name|dwSctx2
operator|,
name|dev_ctx
operator|->
name|ctx_slot
operator|.
name|dwSctx3
operator|)
argument_list|)
expr_stmt|;
name|dev
operator|=
name|XHCI_SLOTDEV_PTR
argument_list|(
name|sc
argument_list|,
name|slot
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|dev
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|dev
operator|->
name|hci
operator|.
name|hci_address
operator|=
name|slot
expr_stmt|;
name|dev
operator|->
name|dev_ctx
operator|=
name|dev_ctx
expr_stmt|;
if|if
condition|(
name|dev
operator|->
name|dev_ue
operator|->
name|ue_reset
operator|==
name|NULL
operator|||
name|dev
operator|->
name|dev_ue
operator|->
name|ue_reset
argument_list|(
name|dev
operator|->
name|dev_sc
argument_list|)
operator|<
literal|0
condition|)
block|{
name|cmderr
operator|=
name|XHCI_TRB_ERROR_ENDP_NOT_ON
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|memcpy
argument_list|(
operator|&
name|dev_ctx
operator|->
name|ctx_slot
argument_list|,
name|islot_ctx
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|xhci_slot_ctx
argument_list|)
argument_list|)
expr_stmt|;
name|dev_ctx
operator|->
name|ctx_slot
operator|.
name|dwSctx3
operator|=
name|XHCI_SCTX_3_SLOT_STATE_SET
argument_list|(
name|XHCI_ST_SLCTX_ADDRESSED
argument_list|)
operator||
name|XHCI_SCTX_3_DEV_ADDR_SET
argument_list|(
name|slot
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|dev_ctx
operator|->
name|ctx_ep
index|[
literal|1
index|]
argument_list|,
name|ep0_ctx
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|xhci_endp_ctx
argument_list|)
argument_list|)
expr_stmt|;
name|ep0_ctx
operator|=
operator|&
name|dev_ctx
operator|->
name|ctx_ep
index|[
literal|1
index|]
expr_stmt|;
name|ep0_ctx
operator|->
name|dwEpCtx0
operator|=
operator|(
name|ep0_ctx
operator|->
name|dwEpCtx0
operator|&
operator|~
literal|0x7
operator|)
operator||
name|XHCI_EPCTX_0_EPSTATE_SET
argument_list|(
name|XHCI_ST_EPCTX_RUNNING
argument_list|)
expr_stmt|;
name|pci_xhci_init_ep
argument_list|(
name|dev
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|dev
operator|->
name|dev_slotstate
operator|=
name|XHCI_ST_ADDRESSED
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci: address device, output ctx\r\n"
literal|"          slot %08x %08x %08x %08x\r\n"
literal|"          ep0  %08x %08x %016lx %08x\r\n"
operator|,
name|dev_ctx
operator|->
name|ctx_slot
operator|.
name|dwSctx0
operator|,
name|dev_ctx
operator|->
name|ctx_slot
operator|.
name|dwSctx1
operator|,
name|dev_ctx
operator|->
name|ctx_slot
operator|.
name|dwSctx2
operator|,
name|dev_ctx
operator|->
name|ctx_slot
operator|.
name|dwSctx3
operator|,
name|ep0_ctx
operator|->
name|dwEpCtx0
operator|,
name|ep0_ctx
operator|->
name|dwEpCtx1
operator|,
name|ep0_ctx
operator|->
name|qwEpCtx2
operator|,
name|ep0_ctx
operator|->
name|dwEpCtx4
operator|)
argument_list|)
expr_stmt|;
name|done
label|:
return|return
operator|(
name|cmderr
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|pci_xhci_cmd_config_ep
parameter_list|(
name|struct
name|pci_xhci_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|slot
parameter_list|,
name|struct
name|xhci_trb
modifier|*
name|trb
parameter_list|)
block|{
name|struct
name|xhci_input_dev_ctx
modifier|*
name|input_ctx
decl_stmt|;
name|struct
name|pci_xhci_dev_emu
modifier|*
name|dev
decl_stmt|;
name|struct
name|xhci_dev_ctx
modifier|*
name|dev_ctx
decl_stmt|;
name|struct
name|xhci_endp_ctx
modifier|*
name|ep_ctx
decl_stmt|,
modifier|*
name|iep_ctx
decl_stmt|;
name|uint32_t
name|cmderr
decl_stmt|;
name|int
name|i
decl_stmt|;
name|cmderr
operator|=
name|XHCI_TRB_ERROR_SUCCESS
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci config_ep slot %u\r\n"
operator|,
name|slot
operator|)
argument_list|)
expr_stmt|;
name|dev
operator|=
name|XHCI_SLOTDEV_PTR
argument_list|(
name|sc
argument_list|,
name|slot
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|dev
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|trb
operator|->
name|dwTrb3
operator|&
name|XHCI_TRB_3_DCEP_BIT
operator|)
operator|!=
literal|0
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci config_ep - deconfigure ep slot %u\r\n"
operator|,
name|slot
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev
operator|->
name|dev_ue
operator|->
name|ue_stop
operator|!=
name|NULL
condition|)
name|dev
operator|->
name|dev_ue
operator|->
name|ue_stop
argument_list|(
name|dev
operator|->
name|dev_sc
argument_list|)
expr_stmt|;
name|dev
operator|->
name|dev_slotstate
operator|=
name|XHCI_ST_ADDRESSED
expr_stmt|;
name|dev
operator|->
name|hci
operator|.
name|hci_address
operator|=
literal|0
expr_stmt|;
name|dev_ctx
operator|=
name|pci_xhci_get_dev_ctx
argument_list|(
name|sc
argument_list|,
name|slot
argument_list|)
expr_stmt|;
comment|/* number of contexts */
name|dev_ctx
operator|->
name|ctx_slot
operator|.
name|dwSctx0
operator|=
name|FIELD_REPLACE
argument_list|(
name|dev_ctx
operator|->
name|ctx_slot
operator|.
name|dwSctx0
argument_list|,
literal|1
argument_list|,
literal|0x1F
argument_list|,
literal|27
argument_list|)
expr_stmt|;
comment|/* slot state */
name|dev_ctx
operator|->
name|ctx_slot
operator|.
name|dwSctx3
operator|=
name|FIELD_REPLACE
argument_list|(
name|dev_ctx
operator|->
name|ctx_slot
operator|.
name|dwSctx3
argument_list|,
name|XHCI_ST_SLCTX_ADDRESSED
argument_list|,
literal|0x1F
argument_list|,
literal|27
argument_list|)
expr_stmt|;
comment|/* disable endpoints */
for|for
control|(
name|i
operator|=
literal|2
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
name|pci_xhci_disable_ep
argument_list|(
name|dev
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|cmderr
operator|=
name|XHCI_TRB_ERROR_SUCCESS
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|dev
operator|->
name|dev_slotstate
operator|<
name|XHCI_ST_ADDRESSED
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci: config_ep slotstate x%x != addressed\r\n"
operator|,
name|dev
operator|->
name|dev_slotstate
operator|)
argument_list|)
expr_stmt|;
name|cmderr
operator|=
name|XHCI_TRB_ERROR_SLOT_NOT_ON
expr_stmt|;
goto|goto
name|done
goto|;
block|}
comment|/* In addressed/configured state; 	 * for each drop endpoint ctx flag: 	 *   ep->state = DISABLED 	 * for each add endpoint ctx flag: 	 *   cp(ep-in, ep-out) 	 *   ep->state = RUNNING 	 * for each drop+add endpoint flag: 	 *   reset ep resources 	 *   cp(ep-in, ep-out) 	 *   ep->state = RUNNING 	 * if input->DisabledCtx[2-31]< 30: (at least 1 ep not disabled) 	 *   slot->state = configured 	 */
name|input_ctx
operator|=
name|XHCI_GADDR
argument_list|(
name|sc
argument_list|,
name|trb
operator|->
name|qwTrb0
operator|&
operator|~
literal|0xFUL
argument_list|)
expr_stmt|;
name|dev_ctx
operator|=
name|dev
operator|->
name|dev_ctx
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci: config_ep inputctx: D:x%08x A:x%08x 7:x%08x\r\n"
operator|,
name|input_ctx
operator|->
name|ctx_input
operator|.
name|dwInCtx0
operator|,
name|input_ctx
operator|->
name|ctx_input
operator|.
name|dwInCtx1
operator|,
name|input_ctx
operator|->
name|ctx_input
operator|.
name|dwInCtx7
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|2
init|;
name|i
operator|<=
literal|31
condition|;
name|i
operator|++
control|)
block|{
name|ep_ctx
operator|=
operator|&
name|dev_ctx
operator|->
name|ctx_ep
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|input_ctx
operator|->
name|ctx_input
operator|.
name|dwInCtx0
operator|&
name|XHCI_INCTX_0_DROP_MASK
argument_list|(
name|i
argument_list|)
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|" config ep - dropping ep %d\r\n"
operator|,
name|i
operator|)
argument_list|)
expr_stmt|;
name|pci_xhci_disable_ep
argument_list|(
name|dev
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|input_ctx
operator|->
name|ctx_input
operator|.
name|dwInCtx1
operator|&
name|XHCI_INCTX_1_ADD_MASK
argument_list|(
name|i
argument_list|)
condition|)
block|{
name|iep_ctx
operator|=
operator|&
name|input_ctx
operator|->
name|ctx_ep
index|[
name|i
index|]
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|" enable ep[%d]  %08x %08x %016lx %08x\r\n"
operator|,
name|i
operator|,
name|iep_ctx
operator|->
name|dwEpCtx0
operator|,
name|iep_ctx
operator|->
name|dwEpCtx1
operator|,
name|iep_ctx
operator|->
name|qwEpCtx2
operator|,
name|iep_ctx
operator|->
name|dwEpCtx4
operator|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|ep_ctx
argument_list|,
name|iep_ctx
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|xhci_endp_ctx
argument_list|)
argument_list|)
expr_stmt|;
name|pci_xhci_init_ep
argument_list|(
name|dev
argument_list|,
name|i
argument_list|)
expr_stmt|;
comment|/* ep state */
name|ep_ctx
operator|->
name|dwEpCtx0
operator|=
name|FIELD_REPLACE
argument_list|(
name|ep_ctx
operator|->
name|dwEpCtx0
argument_list|,
name|XHCI_ST_EPCTX_RUNNING
argument_list|,
literal|0x7
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* slot state to configured */
name|dev_ctx
operator|->
name|ctx_slot
operator|.
name|dwSctx3
operator|=
name|FIELD_REPLACE
argument_list|(
name|dev_ctx
operator|->
name|ctx_slot
operator|.
name|dwSctx3
argument_list|,
name|XHCI_ST_SLCTX_CONFIGURED
argument_list|,
literal|0x1F
argument_list|,
literal|27
argument_list|)
expr_stmt|;
name|dev_ctx
operator|->
name|ctx_slot
operator|.
name|dwSctx0
operator|=
name|FIELD_COPY
argument_list|(
name|dev_ctx
operator|->
name|ctx_slot
operator|.
name|dwSctx0
argument_list|,
name|input_ctx
operator|->
name|ctx_slot
operator|.
name|dwSctx0
argument_list|,
literal|0x1F
argument_list|,
literal|27
argument_list|)
expr_stmt|;
name|dev
operator|->
name|dev_slotstate
operator|=
name|XHCI_ST_CONFIGURED
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"EP configured; slot %u [0]=0x%08x [1]=0x%08x [2]=0x%08x "
literal|"[3]=0x%08x\r\n"
operator|,
name|slot
operator|,
name|dev_ctx
operator|->
name|ctx_slot
operator|.
name|dwSctx0
operator|,
name|dev_ctx
operator|->
name|ctx_slot
operator|.
name|dwSctx1
operator|,
name|dev_ctx
operator|->
name|ctx_slot
operator|.
name|dwSctx2
operator|,
name|dev_ctx
operator|->
name|ctx_slot
operator|.
name|dwSctx3
operator|)
argument_list|)
expr_stmt|;
name|done
label|:
return|return
operator|(
name|cmderr
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|pci_xhci_cmd_reset_ep
parameter_list|(
name|struct
name|pci_xhci_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|slot
parameter_list|,
name|struct
name|xhci_trb
modifier|*
name|trb
parameter_list|)
block|{
name|struct
name|pci_xhci_dev_emu
modifier|*
name|dev
decl_stmt|;
name|struct
name|pci_xhci_dev_ep
modifier|*
name|devep
decl_stmt|;
name|struct
name|xhci_dev_ctx
modifier|*
name|dev_ctx
decl_stmt|;
name|struct
name|xhci_endp_ctx
modifier|*
name|ep_ctx
decl_stmt|;
name|uint32_t
name|cmderr
decl_stmt|,
name|epid
decl_stmt|;
name|uint32_t
name|type
decl_stmt|;
name|epid
operator|=
name|XHCI_TRB_3_EP_GET
argument_list|(
name|trb
operator|->
name|dwTrb3
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci: reset ep %u: slot %u\r\n"
operator|,
name|epid
operator|,
name|slot
operator|)
argument_list|)
expr_stmt|;
name|cmderr
operator|=
name|XHCI_TRB_ERROR_SUCCESS
expr_stmt|;
name|type
operator|=
name|XHCI_TRB_3_TYPE_GET
argument_list|(
name|trb
operator|->
name|dwTrb3
argument_list|)
expr_stmt|;
name|dev
operator|=
name|XHCI_SLOTDEV_PTR
argument_list|(
name|sc
argument_list|,
name|slot
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|dev
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|XHCI_TRB_TYPE_STOP_EP
operator|&&
operator|(
name|trb
operator|->
name|dwTrb3
operator|&
name|XHCI_TRB_3_SUSP_EP_BIT
operator|)
operator|!=
literal|0
condition|)
block|{
comment|/* XXX suspend endpoint for 10ms */
block|}
if|if
condition|(
name|epid
operator|<
literal|1
operator|||
name|epid
operator|>
literal|31
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci: reset ep: invalid epid %u\r\n"
operator|,
name|epid
operator|)
argument_list|)
expr_stmt|;
name|cmderr
operator|=
name|XHCI_TRB_ERROR_TRB
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|devep
operator|=
operator|&
name|dev
operator|->
name|eps
index|[
name|epid
index|]
expr_stmt|;
if|if
condition|(
name|devep
operator|->
name|ep_xfer
operator|!=
name|NULL
condition|)
name|USB_DATA_XFER_RESET
argument_list|(
name|devep
operator|->
name|ep_xfer
argument_list|)
expr_stmt|;
name|dev_ctx
operator|=
name|dev
operator|->
name|dev_ctx
expr_stmt|;
name|assert
argument_list|(
name|dev_ctx
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ep_ctx
operator|=
operator|&
name|dev_ctx
operator|->
name|ctx_ep
index|[
name|epid
index|]
expr_stmt|;
name|ep_ctx
operator|->
name|dwEpCtx0
operator|=
operator|(
name|ep_ctx
operator|->
name|dwEpCtx0
operator|&
operator|~
literal|0x7
operator|)
operator||
name|XHCI_ST_EPCTX_STOPPED
expr_stmt|;
if|if
condition|(
name|XHCI_EPCTX_0_MAXP_STREAMS_GET
argument_list|(
name|ep_ctx
operator|->
name|dwEpCtx0
argument_list|)
operator|==
literal|0
condition|)
name|ep_ctx
operator|->
name|qwEpCtx2
operator|=
name|devep
operator|->
name|ep_ringaddr
operator||
name|devep
operator|->
name|ep_ccs
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci: reset ep[%u] %08x %08x %016lx %08x\r\n"
operator|,
name|epid
operator|,
name|ep_ctx
operator|->
name|dwEpCtx0
operator|,
name|ep_ctx
operator|->
name|dwEpCtx1
operator|,
name|ep_ctx
operator|->
name|qwEpCtx2
operator|,
name|ep_ctx
operator|->
name|dwEpCtx4
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|XHCI_TRB_TYPE_RESET_EP
operator|&&
operator|(
name|dev
operator|->
name|dev_ue
operator|->
name|ue_reset
operator|==
name|NULL
operator|||
name|dev
operator|->
name|dev_ue
operator|->
name|ue_reset
argument_list|(
name|dev
operator|->
name|dev_sc
argument_list|)
operator|<
literal|0
operator|)
condition|)
block|{
name|cmderr
operator|=
name|XHCI_TRB_ERROR_ENDP_NOT_ON
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|done
label|:
return|return
operator|(
name|cmderr
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|pci_xhci_find_stream
parameter_list|(
name|struct
name|pci_xhci_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|xhci_endp_ctx
modifier|*
name|ep
parameter_list|,
name|uint32_t
name|streamid
parameter_list|,
name|struct
name|xhci_stream_ctx
modifier|*
modifier|*
name|osctx
parameter_list|)
block|{
name|struct
name|xhci_stream_ctx
modifier|*
name|sctx
decl_stmt|;
name|uint32_t
name|maxpstreams
decl_stmt|;
name|maxpstreams
operator|=
name|XHCI_EPCTX_0_MAXP_STREAMS_GET
argument_list|(
name|ep
operator|->
name|dwEpCtx0
argument_list|)
expr_stmt|;
if|if
condition|(
name|maxpstreams
operator|==
literal|0
condition|)
return|return
operator|(
name|XHCI_TRB_ERROR_TRB
operator|)
return|;
if|if
condition|(
name|maxpstreams
operator|>
name|XHCI_STREAMS_MAX
condition|)
return|return
operator|(
name|XHCI_TRB_ERROR_INVALID_SID
operator|)
return|;
if|if
condition|(
name|XHCI_EPCTX_0_LSA_GET
argument_list|(
name|ep
operator|->
name|dwEpCtx0
argument_list|)
operator|==
literal|0
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci: find_stream; LSA bit not set\r\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|XHCI_TRB_ERROR_INVALID_SID
operator|)
return|;
block|}
comment|/* only support primary stream */
if|if
condition|(
name|streamid
operator|>
name|maxpstreams
condition|)
return|return
operator|(
name|XHCI_TRB_ERROR_STREAM_TYPE
operator|)
return|;
name|sctx
operator|=
name|XHCI_GADDR
argument_list|(
name|sc
argument_list|,
name|ep
operator|->
name|qwEpCtx2
operator|&
operator|~
literal|0xFUL
argument_list|)
operator|+
name|streamid
expr_stmt|;
if|if
condition|(
operator|!
name|XHCI_SCTX_0_SCT_GET
argument_list|(
name|sctx
operator|->
name|qwSctx0
argument_list|)
condition|)
return|return
operator|(
name|XHCI_TRB_ERROR_STREAM_TYPE
operator|)
return|;
operator|*
name|osctx
operator|=
name|sctx
expr_stmt|;
return|return
operator|(
name|XHCI_TRB_ERROR_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|pci_xhci_cmd_set_tr
parameter_list|(
name|struct
name|pci_xhci_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|slot
parameter_list|,
name|struct
name|xhci_trb
modifier|*
name|trb
parameter_list|)
block|{
name|struct
name|pci_xhci_dev_emu
modifier|*
name|dev
decl_stmt|;
name|struct
name|pci_xhci_dev_ep
modifier|*
name|devep
decl_stmt|;
name|struct
name|xhci_dev_ctx
modifier|*
name|dev_ctx
decl_stmt|;
name|struct
name|xhci_endp_ctx
modifier|*
name|ep_ctx
decl_stmt|;
name|uint32_t
name|cmderr
decl_stmt|,
name|epid
decl_stmt|;
name|uint32_t
name|streamid
decl_stmt|;
name|cmderr
operator|=
name|XHCI_TRB_ERROR_SUCCESS
expr_stmt|;
name|dev
operator|=
name|XHCI_SLOTDEV_PTR
argument_list|(
name|sc
argument_list|,
name|slot
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|dev
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci set_tr: new-tr x%016lx, SCT %u DCS %u\r\n"
literal|"                 stream-id %u, slot %u, epid %u, C %u\r\n"
operator|,
operator|(
name|trb
operator|->
name|qwTrb0
operator|&
operator|~
literal|0xF
operator|)
operator|,
call|(
name|uint32_t
call|)
argument_list|(
operator|(
name|trb
operator|->
name|qwTrb0
operator|>>
literal|1
operator|)
operator|&
literal|0x7
argument_list|)
operator|,
call|(
name|uint32_t
call|)
argument_list|(
name|trb
operator|->
name|qwTrb0
operator|&
literal|0x1
argument_list|)
operator|,
operator|(
name|trb
operator|->
name|dwTrb2
operator|>>
literal|16
operator|)
operator|&
literal|0xFFFF
operator|,
name|XHCI_TRB_3_SLOT_GET
argument_list|(
name|trb
operator|->
name|dwTrb3
argument_list|)
operator|,
name|XHCI_TRB_3_EP_GET
argument_list|(
name|trb
operator|->
name|dwTrb3
argument_list|)
operator|,
name|trb
operator|->
name|dwTrb3
operator|&
literal|0x1
operator|)
argument_list|)
expr_stmt|;
name|epid
operator|=
name|XHCI_TRB_3_EP_GET
argument_list|(
name|trb
operator|->
name|dwTrb3
argument_list|)
expr_stmt|;
if|if
condition|(
name|epid
operator|<
literal|1
operator|||
name|epid
operator|>
literal|31
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci: set_tr_deq: invalid epid %u\r\n"
operator|,
name|epid
operator|)
argument_list|)
expr_stmt|;
name|cmderr
operator|=
name|XHCI_TRB_ERROR_TRB
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|dev_ctx
operator|=
name|dev
operator|->
name|dev_ctx
expr_stmt|;
name|assert
argument_list|(
name|dev_ctx
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ep_ctx
operator|=
operator|&
name|dev_ctx
operator|->
name|ctx_ep
index|[
name|epid
index|]
expr_stmt|;
name|devep
operator|=
operator|&
name|dev
operator|->
name|eps
index|[
name|epid
index|]
expr_stmt|;
switch|switch
condition|(
name|XHCI_EPCTX_0_EPSTATE_GET
argument_list|(
name|ep_ctx
operator|->
name|dwEpCtx0
argument_list|)
condition|)
block|{
case|case
name|XHCI_ST_EPCTX_STOPPED
case|:
case|case
name|XHCI_ST_EPCTX_ERROR
case|:
break|break;
default|default:
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci cmd set_tr invalid state %x\r\n"
operator|,
name|XHCI_EPCTX_0_EPSTATE_GET
argument_list|(
name|ep_ctx
operator|->
name|dwEpCtx0
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|cmderr
operator|=
name|XHCI_TRB_ERROR_CONTEXT_STATE
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|streamid
operator|=
name|XHCI_TRB_2_STREAM_GET
argument_list|(
name|trb
operator|->
name|dwTrb2
argument_list|)
expr_stmt|;
if|if
condition|(
name|XHCI_EPCTX_0_MAXP_STREAMS_GET
argument_list|(
name|ep_ctx
operator|->
name|dwEpCtx0
argument_list|)
operator|>
literal|0
condition|)
block|{
name|struct
name|xhci_stream_ctx
modifier|*
name|sctx
decl_stmt|;
name|sctx
operator|=
name|NULL
expr_stmt|;
name|cmderr
operator|=
name|pci_xhci_find_stream
argument_list|(
name|sc
argument_list|,
name|ep_ctx
argument_list|,
name|streamid
argument_list|,
operator|&
name|sctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|sctx
operator|!=
name|NULL
condition|)
block|{
name|assert
argument_list|(
name|devep
operator|->
name|ep_sctx
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|devep
operator|->
name|ep_sctx
index|[
name|streamid
index|]
operator|.
name|qwSctx0
operator|=
name|trb
operator|->
name|qwTrb0
expr_stmt|;
name|devep
operator|->
name|ep_sctx_trbs
index|[
name|streamid
index|]
operator|.
name|ringaddr
operator|=
name|trb
operator|->
name|qwTrb0
operator|&
operator|~
literal|0xF
expr_stmt|;
name|devep
operator|->
name|ep_sctx_trbs
index|[
name|streamid
index|]
operator|.
name|ccs
operator|=
name|XHCI_EPCTX_2_DCS_GET
argument_list|(
name|trb
operator|->
name|qwTrb0
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|streamid
operator|!=
literal|0
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci cmd set_tr streamid %x != 0\r\n"
operator|,
name|streamid
operator|)
argument_list|)
expr_stmt|;
block|}
name|ep_ctx
operator|->
name|qwEpCtx2
operator|=
name|trb
operator|->
name|qwTrb0
operator|&
operator|~
literal|0xFUL
expr_stmt|;
name|devep
operator|->
name|ep_ringaddr
operator|=
name|ep_ctx
operator|->
name|qwEpCtx2
operator|&
operator|~
literal|0xFUL
expr_stmt|;
name|devep
operator|->
name|ep_ccs
operator|=
name|trb
operator|->
name|qwTrb0
operator|&
literal|0x1
expr_stmt|;
name|devep
operator|->
name|ep_tr
operator|=
name|XHCI_GADDR
argument_list|(
name|sc
argument_list|,
name|devep
operator|->
name|ep_ringaddr
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci set_tr first TRB:\r\n"
operator|)
argument_list|)
expr_stmt|;
name|pci_xhci_dump_trb
argument_list|(
name|devep
operator|->
name|ep_tr
argument_list|)
expr_stmt|;
block|}
name|ep_ctx
operator|->
name|dwEpCtx0
operator|=
operator|(
name|ep_ctx
operator|->
name|dwEpCtx0
operator|&
operator|~
literal|0x7
operator|)
operator||
name|XHCI_ST_EPCTX_STOPPED
expr_stmt|;
name|done
label|:
return|return
operator|(
name|cmderr
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|pci_xhci_cmd_eval_ctx
parameter_list|(
name|struct
name|pci_xhci_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|slot
parameter_list|,
name|struct
name|xhci_trb
modifier|*
name|trb
parameter_list|)
block|{
name|struct
name|xhci_input_dev_ctx
modifier|*
name|input_ctx
decl_stmt|;
name|struct
name|xhci_slot_ctx
modifier|*
name|islot_ctx
decl_stmt|;
name|struct
name|xhci_dev_ctx
modifier|*
name|dev_ctx
decl_stmt|;
name|struct
name|xhci_endp_ctx
modifier|*
name|ep0_ctx
decl_stmt|;
name|uint32_t
name|cmderr
decl_stmt|;
name|input_ctx
operator|=
name|XHCI_GADDR
argument_list|(
name|sc
argument_list|,
name|trb
operator|->
name|qwTrb0
operator|&
operator|~
literal|0xFUL
argument_list|)
expr_stmt|;
name|islot_ctx
operator|=
operator|&
name|input_ctx
operator|->
name|ctx_slot
expr_stmt|;
name|ep0_ctx
operator|=
operator|&
name|input_ctx
operator|->
name|ctx_ep
index|[
literal|1
index|]
expr_stmt|;
name|cmderr
operator|=
name|XHCI_TRB_ERROR_SUCCESS
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci: eval ctx, input ctl: D 0x%08x A 0x%08x,\r\n"
literal|"          slot %08x %08x %08x %08x\r\n"
literal|"          ep0  %08x %08x %016lx %08x\r\n"
operator|,
name|input_ctx
operator|->
name|ctx_input
operator|.
name|dwInCtx0
operator|,
name|input_ctx
operator|->
name|ctx_input
operator|.
name|dwInCtx1
operator|,
name|islot_ctx
operator|->
name|dwSctx0
operator|,
name|islot_ctx
operator|->
name|dwSctx1
operator|,
name|islot_ctx
operator|->
name|dwSctx2
operator|,
name|islot_ctx
operator|->
name|dwSctx3
operator|,
name|ep0_ctx
operator|->
name|dwEpCtx0
operator|,
name|ep0_ctx
operator|->
name|dwEpCtx1
operator|,
name|ep0_ctx
operator|->
name|qwEpCtx2
operator|,
name|ep0_ctx
operator|->
name|dwEpCtx4
operator|)
argument_list|)
expr_stmt|;
comment|/* this command expects drop-ctx=0& add-ctx=slot+ep0 */
if|if
condition|(
operator|(
name|input_ctx
operator|->
name|ctx_input
operator|.
name|dwInCtx0
operator|!=
literal|0
operator|)
operator|||
operator|(
name|input_ctx
operator|->
name|ctx_input
operator|.
name|dwInCtx1
operator|&
literal|0x03
operator|)
operator|==
literal|0
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci: eval ctx, input ctl invalid\r\n"
operator|)
argument_list|)
expr_stmt|;
name|cmderr
operator|=
name|XHCI_TRB_ERROR_TRB
expr_stmt|;
goto|goto
name|done
goto|;
block|}
comment|/* assign address to slot; in this emulation, slot_id = address */
name|dev_ctx
operator|=
name|pci_xhci_get_dev_ctx
argument_list|(
name|sc
argument_list|,
name|slot
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci: eval ctx, dev ctx\r\n"
literal|"          slot %08x %08x %08x %08x\r\n"
operator|,
name|dev_ctx
operator|->
name|ctx_slot
operator|.
name|dwSctx0
operator|,
name|dev_ctx
operator|->
name|ctx_slot
operator|.
name|dwSctx1
operator|,
name|dev_ctx
operator|->
name|ctx_slot
operator|.
name|dwSctx2
operator|,
name|dev_ctx
operator|->
name|ctx_slot
operator|.
name|dwSctx3
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|input_ctx
operator|->
name|ctx_input
operator|.
name|dwInCtx1
operator|&
literal|0x01
condition|)
block|{
comment|/* slot ctx */
comment|/* set max exit latency */
name|dev_ctx
operator|->
name|ctx_slot
operator|.
name|dwSctx1
operator|=
name|FIELD_COPY
argument_list|(
name|dev_ctx
operator|->
name|ctx_slot
operator|.
name|dwSctx1
argument_list|,
name|input_ctx
operator|->
name|ctx_slot
operator|.
name|dwSctx1
argument_list|,
literal|0xFFFF
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* set interrupter target */
name|dev_ctx
operator|->
name|ctx_slot
operator|.
name|dwSctx2
operator|=
name|FIELD_COPY
argument_list|(
name|dev_ctx
operator|->
name|ctx_slot
operator|.
name|dwSctx2
argument_list|,
name|input_ctx
operator|->
name|ctx_slot
operator|.
name|dwSctx2
argument_list|,
literal|0x3FF
argument_list|,
literal|22
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|input_ctx
operator|->
name|ctx_input
operator|.
name|dwInCtx1
operator|&
literal|0x02
condition|)
block|{
comment|/* control ctx */
comment|/* set max packet size */
name|dev_ctx
operator|->
name|ctx_ep
index|[
literal|1
index|]
operator|.
name|dwEpCtx1
operator|=
name|FIELD_COPY
argument_list|(
name|dev_ctx
operator|->
name|ctx_ep
index|[
literal|1
index|]
operator|.
name|dwEpCtx1
argument_list|,
name|ep0_ctx
operator|->
name|dwEpCtx1
argument_list|,
literal|0xFFFF
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|ep0_ctx
operator|=
operator|&
name|dev_ctx
operator|->
name|ctx_ep
index|[
literal|1
index|]
expr_stmt|;
block|}
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci: eval ctx, output ctx\r\n"
literal|"          slot %08x %08x %08x %08x\r\n"
literal|"          ep0  %08x %08x %016lx %08x\r\n"
operator|,
name|dev_ctx
operator|->
name|ctx_slot
operator|.
name|dwSctx0
operator|,
name|dev_ctx
operator|->
name|ctx_slot
operator|.
name|dwSctx1
operator|,
name|dev_ctx
operator|->
name|ctx_slot
operator|.
name|dwSctx2
operator|,
name|dev_ctx
operator|->
name|ctx_slot
operator|.
name|dwSctx3
operator|,
name|ep0_ctx
operator|->
name|dwEpCtx0
operator|,
name|ep0_ctx
operator|->
name|dwEpCtx1
operator|,
name|ep0_ctx
operator|->
name|qwEpCtx2
operator|,
name|ep0_ctx
operator|->
name|dwEpCtx4
operator|)
argument_list|)
expr_stmt|;
name|done
label|:
return|return
operator|(
name|cmderr
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|pci_xhci_complete_commands
parameter_list|(
name|struct
name|pci_xhci_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|xhci_trb
name|evtrb
decl_stmt|;
name|struct
name|xhci_trb
modifier|*
name|trb
decl_stmt|;
name|uint64_t
name|crcr
decl_stmt|;
name|uint32_t
name|ccs
decl_stmt|;
comment|/* cycle state (XHCI 4.9.2) */
name|uint32_t
name|type
decl_stmt|;
name|uint32_t
name|slot
decl_stmt|;
name|uint32_t
name|cmderr
decl_stmt|;
name|int
name|error
decl_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|opregs
operator|.
name|crcr
operator||=
name|XHCI_CRCR_LO_CRR
expr_stmt|;
name|trb
operator|=
name|sc
operator|->
name|opregs
operator|.
name|cr_p
expr_stmt|;
name|ccs
operator|=
name|sc
operator|->
name|opregs
operator|.
name|crcr
operator|&
name|XHCI_CRCR_LO_RCS
expr_stmt|;
name|crcr
operator|=
name|sc
operator|->
name|opregs
operator|.
name|crcr
operator|&
operator|~
literal|0xF
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|sc
operator|->
name|opregs
operator|.
name|cr_p
operator|=
name|trb
expr_stmt|;
name|type
operator|=
name|XHCI_TRB_3_TYPE_GET
argument_list|(
name|trb
operator|->
name|dwTrb3
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|trb
operator|->
name|dwTrb3
operator|&
name|XHCI_TRB_3_CYCLE_BIT
operator|)
operator|!=
operator|(
name|ccs
operator|&
name|XHCI_TRB_3_CYCLE_BIT
operator|)
condition|)
break|break;
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci: cmd type 0x%x, Trb0 x%016lx dwTrb2 x%08x"
literal|" dwTrb3 x%08x, TRB_CYCLE %u/ccs %u\r\n"
operator|,
name|type
operator|,
name|trb
operator|->
name|qwTrb0
operator|,
name|trb
operator|->
name|dwTrb2
operator|,
name|trb
operator|->
name|dwTrb3
operator|,
name|trb
operator|->
name|dwTrb3
operator|&
name|XHCI_TRB_3_CYCLE_BIT
operator|,
name|ccs
operator|)
argument_list|)
expr_stmt|;
name|cmderr
operator|=
name|XHCI_TRB_ERROR_SUCCESS
expr_stmt|;
name|evtrb
operator|.
name|dwTrb2
operator|=
literal|0
expr_stmt|;
name|evtrb
operator|.
name|dwTrb3
operator|=
operator|(
name|ccs
operator|&
name|XHCI_TRB_3_CYCLE_BIT
operator|)
operator||
name|XHCI_TRB_3_TYPE_SET
argument_list|(
name|XHCI_TRB_EVENT_CMD_COMPLETE
argument_list|)
expr_stmt|;
name|slot
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|XHCI_TRB_TYPE_LINK
case|:
comment|/* 0x06 */
if|if
condition|(
name|trb
operator|->
name|dwTrb3
operator|&
name|XHCI_TRB_3_TC_BIT
condition|)
name|ccs
operator|^=
name|XHCI_CRCR_LO_RCS
expr_stmt|;
break|break;
case|case
name|XHCI_TRB_TYPE_ENABLE_SLOT
case|:
comment|/* 0x09 */
name|cmderr
operator|=
name|pci_xhci_cmd_enable_slot
argument_list|(
name|sc
argument_list|,
operator|&
name|slot
argument_list|)
expr_stmt|;
break|break;
case|case
name|XHCI_TRB_TYPE_DISABLE_SLOT
case|:
comment|/* 0x0A */
name|slot
operator|=
name|XHCI_TRB_3_SLOT_GET
argument_list|(
name|trb
operator|->
name|dwTrb3
argument_list|)
expr_stmt|;
name|cmderr
operator|=
name|pci_xhci_cmd_disable_slot
argument_list|(
name|sc
argument_list|,
name|slot
argument_list|)
expr_stmt|;
break|break;
case|case
name|XHCI_TRB_TYPE_ADDRESS_DEVICE
case|:
comment|/* 0x0B */
name|slot
operator|=
name|XHCI_TRB_3_SLOT_GET
argument_list|(
name|trb
operator|->
name|dwTrb3
argument_list|)
expr_stmt|;
name|cmderr
operator|=
name|pci_xhci_cmd_address_device
argument_list|(
name|sc
argument_list|,
name|slot
argument_list|,
name|trb
argument_list|)
expr_stmt|;
break|break;
case|case
name|XHCI_TRB_TYPE_CONFIGURE_EP
case|:
comment|/* 0x0C */
name|slot
operator|=
name|XHCI_TRB_3_SLOT_GET
argument_list|(
name|trb
operator|->
name|dwTrb3
argument_list|)
expr_stmt|;
name|cmderr
operator|=
name|pci_xhci_cmd_config_ep
argument_list|(
name|sc
argument_list|,
name|slot
argument_list|,
name|trb
argument_list|)
expr_stmt|;
break|break;
case|case
name|XHCI_TRB_TYPE_EVALUATE_CTX
case|:
comment|/* 0x0D */
name|slot
operator|=
name|XHCI_TRB_3_SLOT_GET
argument_list|(
name|trb
operator|->
name|dwTrb3
argument_list|)
expr_stmt|;
name|cmderr
operator|=
name|pci_xhci_cmd_eval_ctx
argument_list|(
name|sc
argument_list|,
name|slot
argument_list|,
name|trb
argument_list|)
expr_stmt|;
break|break;
case|case
name|XHCI_TRB_TYPE_RESET_EP
case|:
comment|/* 0x0E */
name|DPRINTF
argument_list|(
operator|(
literal|"Reset Endpoint on slot %d\r\n"
operator|,
name|slot
operator|)
argument_list|)
expr_stmt|;
name|slot
operator|=
name|XHCI_TRB_3_SLOT_GET
argument_list|(
name|trb
operator|->
name|dwTrb3
argument_list|)
expr_stmt|;
name|cmderr
operator|=
name|pci_xhci_cmd_reset_ep
argument_list|(
name|sc
argument_list|,
name|slot
argument_list|,
name|trb
argument_list|)
expr_stmt|;
break|break;
case|case
name|XHCI_TRB_TYPE_STOP_EP
case|:
comment|/* 0x0F */
name|DPRINTF
argument_list|(
operator|(
literal|"Stop Endpoint on slot %d\r\n"
operator|,
name|slot
operator|)
argument_list|)
expr_stmt|;
name|slot
operator|=
name|XHCI_TRB_3_SLOT_GET
argument_list|(
name|trb
operator|->
name|dwTrb3
argument_list|)
expr_stmt|;
name|cmderr
operator|=
name|pci_xhci_cmd_reset_ep
argument_list|(
name|sc
argument_list|,
name|slot
argument_list|,
name|trb
argument_list|)
expr_stmt|;
break|break;
case|case
name|XHCI_TRB_TYPE_SET_TR_DEQUEUE
case|:
comment|/* 0x10 */
name|slot
operator|=
name|XHCI_TRB_3_SLOT_GET
argument_list|(
name|trb
operator|->
name|dwTrb3
argument_list|)
expr_stmt|;
name|cmderr
operator|=
name|pci_xhci_cmd_set_tr
argument_list|(
name|sc
argument_list|,
name|slot
argument_list|,
name|trb
argument_list|)
expr_stmt|;
break|break;
case|case
name|XHCI_TRB_TYPE_RESET_DEVICE
case|:
comment|/* 0x11 */
name|slot
operator|=
name|XHCI_TRB_3_SLOT_GET
argument_list|(
name|trb
operator|->
name|dwTrb3
argument_list|)
expr_stmt|;
name|cmderr
operator|=
name|pci_xhci_cmd_reset_device
argument_list|(
name|sc
argument_list|,
name|slot
argument_list|)
expr_stmt|;
break|break;
case|case
name|XHCI_TRB_TYPE_FORCE_EVENT
case|:
comment|/* 0x12 */
comment|/* TODO: */
break|break;
case|case
name|XHCI_TRB_TYPE_NEGOTIATE_BW
case|:
comment|/* 0x13 */
break|break;
case|case
name|XHCI_TRB_TYPE_SET_LATENCY_TOL
case|:
comment|/* 0x14 */
break|break;
case|case
name|XHCI_TRB_TYPE_GET_PORT_BW
case|:
comment|/* 0x15 */
break|break;
case|case
name|XHCI_TRB_TYPE_FORCE_HEADER
case|:
comment|/* 0x16 */
break|break;
case|case
name|XHCI_TRB_TYPE_NOOP_CMD
case|:
comment|/* 0x17 */
break|break;
default|default:
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci: unsupported cmd %x\r\n"
operator|,
name|type
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|type
operator|!=
name|XHCI_TRB_TYPE_LINK
condition|)
block|{
comment|/*  			 * insert command completion event and assert intr 			 */
name|evtrb
operator|.
name|qwTrb0
operator|=
name|crcr
expr_stmt|;
name|evtrb
operator|.
name|dwTrb2
operator||=
name|XHCI_TRB_2_ERROR_SET
argument_list|(
name|cmderr
argument_list|)
expr_stmt|;
name|evtrb
operator|.
name|dwTrb3
operator||=
name|XHCI_TRB_3_SLOT_SET
argument_list|(
name|slot
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci: command 0x%x result: 0x%x\r\n"
operator|,
name|type
operator|,
name|cmderr
operator|)
argument_list|)
expr_stmt|;
name|pci_xhci_insert_event
argument_list|(
name|sc
argument_list|,
operator|&
name|evtrb
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|trb
operator|=
name|pci_xhci_trb_next
argument_list|(
name|sc
argument_list|,
name|trb
argument_list|,
operator|&
name|crcr
argument_list|)
expr_stmt|;
block|}
name|sc
operator|->
name|opregs
operator|.
name|crcr
operator|=
name|crcr
operator||
operator|(
name|sc
operator|->
name|opregs
operator|.
name|crcr
operator|&
name|XHCI_CRCR_LO_CA
operator|)
operator||
name|ccs
expr_stmt|;
name|sc
operator|->
name|opregs
operator|.
name|crcr
operator|&=
operator|~
name|XHCI_CRCR_LO_CRR
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|pci_xhci_dump_trb
parameter_list|(
name|struct
name|xhci_trb
modifier|*
name|trb
parameter_list|)
block|{
specifier|static
specifier|const
name|char
modifier|*
name|trbtypes
index|[]
init|=
block|{
literal|"RESERVED"
block|,
literal|"NORMAL"
block|,
literal|"SETUP_STAGE"
block|,
literal|"DATA_STAGE"
block|,
literal|"STATUS_STAGE"
block|,
literal|"ISOCH"
block|,
literal|"LINK"
block|,
literal|"EVENT_DATA"
block|,
literal|"NOOP"
block|,
literal|"ENABLE_SLOT"
block|,
literal|"DISABLE_SLOT"
block|,
literal|"ADDRESS_DEVICE"
block|,
literal|"CONFIGURE_EP"
block|,
literal|"EVALUATE_CTX"
block|,
literal|"RESET_EP"
block|,
literal|"STOP_EP"
block|,
literal|"SET_TR_DEQUEUE"
block|,
literal|"RESET_DEVICE"
block|,
literal|"FORCE_EVENT"
block|,
literal|"NEGOTIATE_BW"
block|,
literal|"SET_LATENCY_TOL"
block|,
literal|"GET_PORT_BW"
block|,
literal|"FORCE_HEADER"
block|,
literal|"NOOP_CMD"
block|}
decl_stmt|;
name|uint32_t
name|type
decl_stmt|;
name|type
operator|=
name|XHCI_TRB_3_TYPE_GET
argument_list|(
name|trb
operator|->
name|dwTrb3
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci: trb[@%p] type x%02x %s 0:x%016lx 2:x%08x 3:x%08x\r\n"
operator|,
name|trb
operator|,
name|type
operator|,
name|type
operator|<=
name|XHCI_TRB_TYPE_NOOP_CMD
condition|?
name|trbtypes
index|[
name|type
index|]
else|:
literal|"INVALID"
operator|,
name|trb
operator|->
name|qwTrb0
operator|,
name|trb
operator|->
name|dwTrb2
operator|,
name|trb
operator|->
name|dwTrb3
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|pci_xhci_xfer_complete
parameter_list|(
name|struct
name|pci_xhci_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|usb_data_xfer
modifier|*
name|xfer
parameter_list|,
name|uint32_t
name|slot
parameter_list|,
name|uint32_t
name|epid
parameter_list|,
name|int
modifier|*
name|do_intr
parameter_list|)
block|{
name|struct
name|pci_xhci_dev_emu
modifier|*
name|dev
decl_stmt|;
name|struct
name|pci_xhci_dev_ep
modifier|*
name|devep
decl_stmt|;
name|struct
name|xhci_dev_ctx
modifier|*
name|dev_ctx
decl_stmt|;
name|struct
name|xhci_endp_ctx
modifier|*
name|ep_ctx
decl_stmt|;
name|struct
name|xhci_trb
modifier|*
name|trb
decl_stmt|;
name|struct
name|xhci_trb
name|evtrb
decl_stmt|;
name|uint32_t
name|trbflags
decl_stmt|;
name|uint32_t
name|edtla
decl_stmt|;
name|int
name|i
decl_stmt|,
name|err
decl_stmt|;
name|dev
operator|=
name|XHCI_SLOTDEV_PTR
argument_list|(
name|sc
argument_list|,
name|slot
argument_list|)
expr_stmt|;
name|devep
operator|=
operator|&
name|dev
operator|->
name|eps
index|[
name|epid
index|]
expr_stmt|;
name|dev_ctx
operator|=
name|pci_xhci_get_dev_ctx
argument_list|(
name|sc
argument_list|,
name|slot
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|dev_ctx
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ep_ctx
operator|=
operator|&
name|dev_ctx
operator|->
name|ctx_ep
index|[
name|epid
index|]
expr_stmt|;
name|err
operator|=
name|XHCI_TRB_ERROR_SUCCESS
expr_stmt|;
operator|*
name|do_intr
operator|=
literal|0
expr_stmt|;
name|edtla
operator|=
literal|0
expr_stmt|;
comment|/* go through list of TRBs and insert event(s) */
for|for
control|(
name|i
operator|=
name|xfer
operator|->
name|head
init|;
name|xfer
operator|->
name|ndata
operator|>
literal|0
condition|;
control|)
block|{
name|evtrb
operator|.
name|qwTrb0
operator|=
operator|(
name|uint64_t
operator|)
name|xfer
operator|->
name|data
index|[
name|i
index|]
operator|.
name|hci_data
expr_stmt|;
name|trb
operator|=
name|XHCI_GADDR
argument_list|(
name|sc
argument_list|,
name|evtrb
operator|.
name|qwTrb0
argument_list|)
expr_stmt|;
name|trbflags
operator|=
name|trb
operator|->
name|dwTrb3
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci: xfer[%d] done?%u:%d trb %x %016lx %x "
literal|"(err %d) IOC?%d\r\n"
operator|,
name|i
operator|,
name|xfer
operator|->
name|data
index|[
name|i
index|]
operator|.
name|processed
operator|,
name|xfer
operator|->
name|data
index|[
name|i
index|]
operator|.
name|blen
operator|,
name|XHCI_TRB_3_TYPE_GET
argument_list|(
name|trbflags
argument_list|)
operator|,
name|evtrb
operator|.
name|qwTrb0
operator|,
name|trbflags
operator|,
name|err
operator|,
name|trb
operator|->
name|dwTrb3
operator|&
name|XHCI_TRB_3_IOC_BIT
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|xfer
operator|->
name|data
index|[
name|i
index|]
operator|.
name|processed
condition|)
block|{
name|xfer
operator|->
name|head
operator|=
name|i
expr_stmt|;
break|break;
block|}
name|xfer
operator|->
name|ndata
operator|--
expr_stmt|;
name|edtla
operator|+=
name|xfer
operator|->
name|data
index|[
name|i
index|]
operator|.
name|bdone
expr_stmt|;
name|trb
operator|->
name|dwTrb3
operator|=
operator|(
name|trb
operator|->
name|dwTrb3
operator|&
operator|~
literal|0x1
operator|)
operator||
operator|(
name|xfer
operator|->
name|data
index|[
name|i
index|]
operator|.
name|ccs
operator|)
expr_stmt|;
name|pci_xhci_update_ep_ring
argument_list|(
name|sc
argument_list|,
name|dev
argument_list|,
name|devep
argument_list|,
name|ep_ctx
argument_list|,
name|xfer
operator|->
name|data
index|[
name|i
index|]
operator|.
name|streamid
argument_list|,
name|xfer
operator|->
name|data
index|[
name|i
index|]
operator|.
name|trbnext
argument_list|,
name|xfer
operator|->
name|data
index|[
name|i
index|]
operator|.
name|ccs
argument_list|)
expr_stmt|;
comment|/* Only interrupt if IOC or short packet */
if|if
condition|(
operator|!
operator|(
name|trb
operator|->
name|dwTrb3
operator|&
name|XHCI_TRB_3_IOC_BIT
operator|)
operator|&&
operator|!
operator|(
operator|(
name|err
operator|==
name|XHCI_TRB_ERROR_SHORT_PKT
operator|)
operator|&&
operator|(
name|trb
operator|->
name|dwTrb3
operator|&
name|XHCI_TRB_3_ISP_BIT
operator|)
operator|)
condition|)
block|{
name|i
operator|=
operator|(
name|i
operator|+
literal|1
operator|)
operator|%
name|USB_MAX_XFER_BLOCKS
expr_stmt|;
continue|continue;
block|}
name|evtrb
operator|.
name|dwTrb2
operator|=
name|XHCI_TRB_2_ERROR_SET
argument_list|(
name|err
argument_list|)
operator||
name|XHCI_TRB_2_REM_SET
argument_list|(
name|xfer
operator|->
name|data
index|[
name|i
index|]
operator|.
name|blen
argument_list|)
expr_stmt|;
name|evtrb
operator|.
name|dwTrb3
operator|=
name|XHCI_TRB_3_TYPE_SET
argument_list|(
name|XHCI_TRB_EVENT_TRANSFER
argument_list|)
operator||
name|XHCI_TRB_3_SLOT_SET
argument_list|(
name|slot
argument_list|)
operator||
name|XHCI_TRB_3_EP_SET
argument_list|(
name|epid
argument_list|)
expr_stmt|;
if|if
condition|(
name|XHCI_TRB_3_TYPE_GET
argument_list|(
name|trbflags
argument_list|)
operator|==
name|XHCI_TRB_TYPE_EVENT_DATA
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci EVENT_DATA edtla %u\r\n"
operator|,
name|edtla
operator|)
argument_list|)
expr_stmt|;
name|evtrb
operator|.
name|qwTrb0
operator|=
name|trb
operator|->
name|qwTrb0
expr_stmt|;
name|evtrb
operator|.
name|dwTrb2
operator|=
operator|(
name|edtla
operator|&
literal|0xFFFFF
operator|)
operator||
name|XHCI_TRB_2_ERROR_SET
argument_list|(
name|err
argument_list|)
expr_stmt|;
name|evtrb
operator|.
name|dwTrb3
operator||=
name|XHCI_TRB_3_ED_BIT
expr_stmt|;
name|edtla
operator|=
literal|0
expr_stmt|;
block|}
operator|*
name|do_intr
operator|=
literal|1
expr_stmt|;
name|err
operator|=
name|pci_xhci_insert_event
argument_list|(
name|sc
argument_list|,
operator|&
name|evtrb
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|XHCI_TRB_ERROR_SUCCESS
condition|)
block|{
break|break;
block|}
name|i
operator|=
operator|(
name|i
operator|+
literal|1
operator|)
operator|%
name|USB_MAX_XFER_BLOCKS
expr_stmt|;
block|}
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|pci_xhci_update_ep_ring
parameter_list|(
name|struct
name|pci_xhci_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|pci_xhci_dev_emu
modifier|*
name|dev
parameter_list|,
name|struct
name|pci_xhci_dev_ep
modifier|*
name|devep
parameter_list|,
name|struct
name|xhci_endp_ctx
modifier|*
name|ep_ctx
parameter_list|,
name|uint32_t
name|streamid
parameter_list|,
name|uint64_t
name|ringaddr
parameter_list|,
name|int
name|ccs
parameter_list|)
block|{
if|if
condition|(
name|XHCI_EPCTX_0_MAXP_STREAMS_GET
argument_list|(
name|ep_ctx
operator|->
name|dwEpCtx0
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|devep
operator|->
name|ep_sctx
index|[
name|streamid
index|]
operator|.
name|qwSctx0
operator|=
operator|(
name|ringaddr
operator|&
operator|~
literal|0xFUL
operator|)
operator||
operator|(
name|ccs
operator|&
literal|0x1
operator|)
expr_stmt|;
name|devep
operator|->
name|ep_sctx_trbs
index|[
name|streamid
index|]
operator|.
name|ringaddr
operator|=
name|ringaddr
operator|&
operator|~
literal|0xFUL
expr_stmt|;
name|devep
operator|->
name|ep_sctx_trbs
index|[
name|streamid
index|]
operator|.
name|ccs
operator|=
name|ccs
operator|&
literal|0x1
expr_stmt|;
name|ep_ctx
operator|->
name|qwEpCtx2
operator|=
operator|(
name|ep_ctx
operator|->
name|qwEpCtx2
operator|&
operator|~
literal|0x1
operator|)
operator||
operator|(
name|ccs
operator|&
literal|0x1
operator|)
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"xhci update ep-ring stream %d, addr %lx\r\n"
operator|,
name|streamid
operator|,
name|devep
operator|->
name|ep_sctx
index|[
name|streamid
index|]
operator|.
name|qwSctx0
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|devep
operator|->
name|ep_ringaddr
operator|=
name|ringaddr
operator|&
operator|~
literal|0xFUL
expr_stmt|;
name|devep
operator|->
name|ep_ccs
operator|=
name|ccs
operator|&
literal|0x1
expr_stmt|;
name|devep
operator|->
name|ep_tr
operator|=
name|XHCI_GADDR
argument_list|(
name|sc
argument_list|,
name|ringaddr
operator|&
operator|~
literal|0xFUL
argument_list|)
expr_stmt|;
name|ep_ctx
operator|->
name|qwEpCtx2
operator|=
operator|(
name|ringaddr
operator|&
operator|~
literal|0xFUL
operator|)
operator||
operator|(
name|ccs
operator|&
literal|0x1
operator|)
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"xhci update ep-ring, addr %lx\r\n"
operator|,
operator|(
name|devep
operator|->
name|ep_ringaddr
operator||
name|devep
operator|->
name|ep_ccs
operator|)
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Outstanding transfer still in progress (device NAK'd earlier) so retry  * the transfer again to see if it succeeds.  */
end_comment

begin_function
specifier|static
name|int
name|pci_xhci_try_usb_xfer
parameter_list|(
name|struct
name|pci_xhci_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|pci_xhci_dev_emu
modifier|*
name|dev
parameter_list|,
name|struct
name|pci_xhci_dev_ep
modifier|*
name|devep
parameter_list|,
name|struct
name|xhci_endp_ctx
modifier|*
name|ep_ctx
parameter_list|,
name|uint32_t
name|slot
parameter_list|,
name|uint32_t
name|epid
parameter_list|)
block|{
name|struct
name|usb_data_xfer
modifier|*
name|xfer
decl_stmt|;
name|int
name|err
decl_stmt|;
name|int
name|do_intr
decl_stmt|;
name|ep_ctx
operator|->
name|dwEpCtx0
operator|=
name|FIELD_REPLACE
argument_list|(
name|ep_ctx
operator|->
name|dwEpCtx0
argument_list|,
name|XHCI_ST_EPCTX_RUNNING
argument_list|,
literal|0x7
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|err
operator|=
literal|0
expr_stmt|;
name|do_intr
operator|=
literal|0
expr_stmt|;
name|xfer
operator|=
name|devep
operator|->
name|ep_xfer
expr_stmt|;
name|USB_DATA_XFER_LOCK
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
comment|/* outstanding requests queued up */
if|if
condition|(
name|dev
operator|->
name|dev_ue
operator|->
name|ue_data
operator|!=
name|NULL
condition|)
block|{
name|err
operator|=
name|dev
operator|->
name|dev_ue
operator|->
name|ue_data
argument_list|(
name|dev
operator|->
name|dev_sc
argument_list|,
name|xfer
argument_list|,
name|epid
operator|&
literal|0x1
condition|?
name|USB_XFER_IN
else|:
name|USB_XFER_OUT
argument_list|,
name|epid
operator|/
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|USB_ERR_CANCELLED
condition|)
block|{
if|if
condition|(
name|USB_DATA_GET_ERRCODE
argument_list|(
operator|&
name|xfer
operator|->
name|data
index|[
name|xfer
operator|->
name|head
index|]
argument_list|)
operator|==
name|USB_NAK
condition|)
name|err
operator|=
name|XHCI_TRB_ERROR_SUCCESS
expr_stmt|;
block|}
else|else
block|{
name|err
operator|=
name|pci_xhci_xfer_complete
argument_list|(
name|sc
argument_list|,
name|xfer
argument_list|,
name|slot
argument_list|,
name|epid
argument_list|,
operator|&
name|do_intr
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|XHCI_TRB_ERROR_SUCCESS
operator|&&
name|do_intr
condition|)
block|{
name|pci_xhci_assert_interrupt
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
comment|/* XXX should not do it if error? */
name|USB_DATA_XFER_RESET
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
block|}
block|}
name|USB_DATA_XFER_UNLOCK
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|pci_xhci_handle_transfer
parameter_list|(
name|struct
name|pci_xhci_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|pci_xhci_dev_emu
modifier|*
name|dev
parameter_list|,
name|struct
name|pci_xhci_dev_ep
modifier|*
name|devep
parameter_list|,
name|struct
name|xhci_endp_ctx
modifier|*
name|ep_ctx
parameter_list|,
name|struct
name|xhci_trb
modifier|*
name|trb
parameter_list|,
name|uint32_t
name|slot
parameter_list|,
name|uint32_t
name|epid
parameter_list|,
name|uint64_t
name|addr
parameter_list|,
name|uint32_t
name|ccs
parameter_list|,
name|uint32_t
name|streamid
parameter_list|)
block|{
name|struct
name|xhci_trb
modifier|*
name|setup_trb
decl_stmt|;
name|struct
name|usb_data_xfer
modifier|*
name|xfer
decl_stmt|;
name|struct
name|usb_data_xfer_block
modifier|*
name|xfer_block
decl_stmt|;
name|uint64_t
name|val
decl_stmt|;
name|uint32_t
name|trbflags
decl_stmt|;
name|int
name|do_intr
decl_stmt|,
name|err
decl_stmt|;
name|int
name|do_retry
decl_stmt|;
name|ep_ctx
operator|->
name|dwEpCtx0
operator|=
name|FIELD_REPLACE
argument_list|(
name|ep_ctx
operator|->
name|dwEpCtx0
argument_list|,
name|XHCI_ST_EPCTX_RUNNING
argument_list|,
literal|0x7
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|xfer
operator|=
name|devep
operator|->
name|ep_xfer
expr_stmt|;
name|USB_DATA_XFER_LOCK
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci handle_transfer slot %u\r\n"
operator|,
name|slot
operator|)
argument_list|)
expr_stmt|;
name|retry
label|:
name|err
operator|=
literal|0
expr_stmt|;
name|do_retry
operator|=
literal|0
expr_stmt|;
name|do_intr
operator|=
literal|0
expr_stmt|;
name|setup_trb
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|pci_xhci_dump_trb
argument_list|(
name|trb
argument_list|)
expr_stmt|;
name|trbflags
operator|=
name|trb
operator|->
name|dwTrb3
expr_stmt|;
if|if
condition|(
name|XHCI_TRB_3_TYPE_GET
argument_list|(
name|trbflags
argument_list|)
operator|!=
name|XHCI_TRB_TYPE_LINK
operator|&&
operator|(
name|trbflags
operator|&
name|XHCI_TRB_3_CYCLE_BIT
operator|)
operator|!=
operator|(
name|ccs
operator|&
name|XHCI_TRB_3_CYCLE_BIT
operator|)
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"Cycle-bit changed trbflags %x, ccs %x\r\n"
operator|,
name|trbflags
operator|&
name|XHCI_TRB_3_CYCLE_BIT
operator|,
name|ccs
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|xfer_block
operator|=
name|NULL
expr_stmt|;
switch|switch
condition|(
name|XHCI_TRB_3_TYPE_GET
argument_list|(
name|trbflags
argument_list|)
condition|)
block|{
case|case
name|XHCI_TRB_TYPE_LINK
case|:
if|if
condition|(
name|trb
operator|->
name|dwTrb3
operator|&
name|XHCI_TRB_3_TC_BIT
condition|)
name|ccs
operator|^=
literal|0x1
expr_stmt|;
name|xfer_block
operator|=
name|usb_data_xfer_append
argument_list|(
name|xfer
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
operator|(
name|void
operator|*
operator|)
name|addr
argument_list|,
name|ccs
argument_list|)
expr_stmt|;
name|xfer_block
operator|->
name|processed
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|XHCI_TRB_TYPE_SETUP_STAGE
case|:
if|if
condition|(
operator|(
name|trbflags
operator|&
name|XHCI_TRB_3_IDT_BIT
operator|)
operator|==
literal|0
operator|||
name|XHCI_TRB_2_BYTES_GET
argument_list|(
name|trb
operator|->
name|dwTrb2
argument_list|)
operator|!=
literal|8
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci: invalid setup trb\r\n"
operator|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|XHCI_TRB_ERROR_TRB
expr_stmt|;
goto|goto
name|errout
goto|;
block|}
name|setup_trb
operator|=
name|trb
expr_stmt|;
name|val
operator|=
name|trb
operator|->
name|qwTrb0
expr_stmt|;
if|if
condition|(
operator|!
name|xfer
operator|->
name|ureq
condition|)
name|xfer
operator|->
name|ureq
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|usb_device_request
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|xfer
operator|->
name|ureq
argument_list|,
operator|&
name|val
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|usb_device_request
argument_list|)
argument_list|)
expr_stmt|;
name|xfer_block
operator|=
name|usb_data_xfer_append
argument_list|(
name|xfer
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
operator|(
name|void
operator|*
operator|)
name|addr
argument_list|,
name|ccs
argument_list|)
expr_stmt|;
name|xfer_block
operator|->
name|processed
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|XHCI_TRB_TYPE_NORMAL
case|:
case|case
name|XHCI_TRB_TYPE_ISOCH
case|:
if|if
condition|(
name|setup_trb
operator|!=
name|NULL
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci: trb not supposed to be in "
literal|"ctl scope\r\n"
operator|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|XHCI_TRB_ERROR_TRB
expr_stmt|;
goto|goto
name|errout
goto|;
block|}
comment|/* fall through */
case|case
name|XHCI_TRB_TYPE_DATA_STAGE
case|:
name|xfer_block
operator|=
name|usb_data_xfer_append
argument_list|(
name|xfer
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
name|trbflags
operator|&
name|XHCI_TRB_3_IDT_BIT
condition|?
operator|&
name|trb
operator|->
name|qwTrb0
else|:
name|XHCI_GADDR
argument_list|(
name|sc
argument_list|,
name|trb
operator|->
name|qwTrb0
argument_list|)
operator|)
argument_list|,
name|trb
operator|->
name|dwTrb2
operator|&
literal|0x1FFFF
argument_list|,
operator|(
name|void
operator|*
operator|)
name|addr
argument_list|,
name|ccs
argument_list|)
expr_stmt|;
break|break;
case|case
name|XHCI_TRB_TYPE_STATUS_STAGE
case|:
name|xfer_block
operator|=
name|usb_data_xfer_append
argument_list|(
name|xfer
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
operator|(
name|void
operator|*
operator|)
name|addr
argument_list|,
name|ccs
argument_list|)
expr_stmt|;
break|break;
case|case
name|XHCI_TRB_TYPE_NOOP
case|:
name|xfer_block
operator|=
name|usb_data_xfer_append
argument_list|(
name|xfer
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
operator|(
name|void
operator|*
operator|)
name|addr
argument_list|,
name|ccs
argument_list|)
expr_stmt|;
name|xfer_block
operator|->
name|processed
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|XHCI_TRB_TYPE_EVENT_DATA
case|:
name|xfer_block
operator|=
name|usb_data_xfer_append
argument_list|(
name|xfer
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
operator|(
name|void
operator|*
operator|)
name|addr
argument_list|,
name|ccs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|epid
operator|>
literal|1
operator|)
operator|&&
operator|(
name|trbflags
operator|&
name|XHCI_TRB_3_IOC_BIT
operator|)
condition|)
block|{
name|xfer_block
operator|->
name|processed
operator|=
literal|1
expr_stmt|;
block|}
break|break;
default|default:
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci: handle xfer unexpected trb type "
literal|"0x%x\r\n"
operator|,
name|XHCI_TRB_3_TYPE_GET
argument_list|(
name|trbflags
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|XHCI_TRB_ERROR_TRB
expr_stmt|;
goto|goto
name|errout
goto|;
block|}
name|trb
operator|=
name|pci_xhci_trb_next
argument_list|(
name|sc
argument_list|,
name|trb
argument_list|,
operator|&
name|addr
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci: next trb: 0x%lx\r\n"
operator|,
operator|(
name|uint64_t
operator|)
name|trb
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|xfer_block
condition|)
block|{
name|xfer_block
operator|->
name|trbnext
operator|=
name|addr
expr_stmt|;
name|xfer_block
operator|->
name|streamid
operator|=
name|streamid
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|setup_trb
operator|&&
operator|!
operator|(
name|trbflags
operator|&
name|XHCI_TRB_3_CHAIN_BIT
operator|)
operator|&&
name|XHCI_TRB_3_TYPE_GET
argument_list|(
name|trbflags
argument_list|)
operator|!=
name|XHCI_TRB_TYPE_LINK
condition|)
block|{
break|break;
block|}
comment|/* handle current batch that requires interrupt on complete */
if|if
condition|(
name|trbflags
operator|&
name|XHCI_TRB_3_IOC_BIT
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci: trb IOC bit set\r\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|epid
operator|==
literal|1
condition|)
name|do_retry
operator|=
literal|1
expr_stmt|;
break|break;
block|}
block|}
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci[%d]: xfer->ndata %u\r\n"
operator|,
name|__LINE__
operator|,
name|xfer
operator|->
name|ndata
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|epid
operator|==
literal|1
condition|)
block|{
name|err
operator|=
name|USB_ERR_NOT_STARTED
expr_stmt|;
if|if
condition|(
name|dev
operator|->
name|dev_ue
operator|->
name|ue_request
operator|!=
name|NULL
condition|)
name|err
operator|=
name|dev
operator|->
name|dev_ue
operator|->
name|ue_request
argument_list|(
name|dev
operator|->
name|dev_sc
argument_list|,
name|xfer
argument_list|)
expr_stmt|;
name|setup_trb
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
comment|/* handle data transfer */
name|pci_xhci_try_usb_xfer
argument_list|(
name|sc
argument_list|,
name|dev
argument_list|,
name|devep
argument_list|,
name|ep_ctx
argument_list|,
name|slot
argument_list|,
name|epid
argument_list|)
expr_stmt|;
name|err
operator|=
name|XHCI_TRB_ERROR_SUCCESS
expr_stmt|;
goto|goto
name|errout
goto|;
block|}
name|err
operator|=
name|USB_TO_XHCI_ERR
argument_list|(
name|err
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|==
name|XHCI_TRB_ERROR_SUCCESS
operator|)
operator|||
operator|(
name|err
operator|==
name|XHCI_TRB_ERROR_SHORT_PKT
operator|)
condition|)
block|{
name|err
operator|=
name|pci_xhci_xfer_complete
argument_list|(
name|sc
argument_list|,
name|xfer
argument_list|,
name|slot
argument_list|,
name|epid
argument_list|,
operator|&
name|do_intr
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|XHCI_TRB_ERROR_SUCCESS
condition|)
name|do_retry
operator|=
literal|0
expr_stmt|;
block|}
name|errout
label|:
if|if
condition|(
name|err
operator|==
name|XHCI_TRB_ERROR_EV_RING_FULL
condition|)
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci[%d]: event ring full\r\n"
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|do_retry
condition|)
name|USB_DATA_XFER_UNLOCK
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
if|if
condition|(
name|do_intr
condition|)
name|pci_xhci_assert_interrupt
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|do_retry
condition|)
block|{
name|USB_DATA_XFER_RESET
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci[%d]: retry:continuing with next TRBs\r\n"
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|retry
goto|;
block|}
if|if
condition|(
name|epid
operator|==
literal|1
condition|)
name|USB_DATA_XFER_RESET
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|pci_xhci_device_doorbell
parameter_list|(
name|struct
name|pci_xhci_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|slot
parameter_list|,
name|uint32_t
name|epid
parameter_list|,
name|uint32_t
name|streamid
parameter_list|)
block|{
name|struct
name|pci_xhci_dev_emu
modifier|*
name|dev
decl_stmt|;
name|struct
name|pci_xhci_dev_ep
modifier|*
name|devep
decl_stmt|;
name|struct
name|xhci_dev_ctx
modifier|*
name|dev_ctx
decl_stmt|;
name|struct
name|xhci_endp_ctx
modifier|*
name|ep_ctx
decl_stmt|;
name|struct
name|pci_xhci_trb_ring
modifier|*
name|sctx_tr
decl_stmt|;
name|struct
name|xhci_trb
modifier|*
name|trb
decl_stmt|;
name|uint64_t
name|ringaddr
decl_stmt|;
name|uint32_t
name|ccs
decl_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci doorbell slot %u epid %u stream %u\r\n"
operator|,
name|slot
operator|,
name|epid
operator|,
name|streamid
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|slot
operator|==
literal|0
operator|||
name|slot
operator|>
name|sc
operator|->
name|ndevices
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci: invalid doorbell slot %u\r\n"
operator|,
name|slot
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|dev
operator|=
name|XHCI_SLOTDEV_PTR
argument_list|(
name|sc
argument_list|,
name|slot
argument_list|)
expr_stmt|;
name|devep
operator|=
operator|&
name|dev
operator|->
name|eps
index|[
name|epid
index|]
expr_stmt|;
name|dev_ctx
operator|=
name|pci_xhci_get_dev_ctx
argument_list|(
name|sc
argument_list|,
name|slot
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dev_ctx
condition|)
block|{
return|return;
block|}
name|ep_ctx
operator|=
operator|&
name|dev_ctx
operator|->
name|ctx_ep
index|[
name|epid
index|]
expr_stmt|;
name|sctx_tr
operator|=
name|NULL
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci: device doorbell ep[%u] %08x %08x %016lx %08x\r\n"
operator|,
name|epid
operator|,
name|ep_ctx
operator|->
name|dwEpCtx0
operator|,
name|ep_ctx
operator|->
name|dwEpCtx1
operator|,
name|ep_ctx
operator|->
name|qwEpCtx2
operator|,
name|ep_ctx
operator|->
name|dwEpCtx4
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ep_ctx
operator|->
name|qwEpCtx2
operator|==
literal|0
condition|)
return|return;
comment|/* handle pending transfers */
if|if
condition|(
name|devep
operator|->
name|ep_xfer
operator|->
name|ndata
operator|>
literal|0
condition|)
block|{
name|pci_xhci_try_usb_xfer
argument_list|(
name|sc
argument_list|,
name|dev
argument_list|,
name|devep
argument_list|,
name|ep_ctx
argument_list|,
name|slot
argument_list|,
name|epid
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* get next trb work item */
if|if
condition|(
name|XHCI_EPCTX_0_MAXP_STREAMS_GET
argument_list|(
name|ep_ctx
operator|->
name|dwEpCtx0
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|sctx_tr
operator|=
operator|&
name|devep
operator|->
name|ep_sctx_trbs
index|[
name|streamid
index|]
expr_stmt|;
name|ringaddr
operator|=
name|sctx_tr
operator|->
name|ringaddr
expr_stmt|;
name|ccs
operator|=
name|sctx_tr
operator|->
name|ccs
expr_stmt|;
name|trb
operator|=
name|XHCI_GADDR
argument_list|(
name|sc
argument_list|,
name|sctx_tr
operator|->
name|ringaddr
operator|&
operator|~
literal|0xFUL
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"doorbell, stream %u, ccs %lx, trb ccs %x\r\n"
operator|,
name|streamid
operator|,
name|ep_ctx
operator|->
name|qwEpCtx2
operator|&
name|XHCI_TRB_3_CYCLE_BIT
operator|,
name|trb
operator|->
name|dwTrb3
operator|&
name|XHCI_TRB_3_CYCLE_BIT
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ringaddr
operator|=
name|devep
operator|->
name|ep_ringaddr
expr_stmt|;
name|ccs
operator|=
name|devep
operator|->
name|ep_ccs
expr_stmt|;
name|trb
operator|=
name|devep
operator|->
name|ep_tr
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"doorbell, ccs %lx, trb ccs %x\r\n"
operator|,
name|ep_ctx
operator|->
name|qwEpCtx2
operator|&
name|XHCI_TRB_3_CYCLE_BIT
operator|,
name|trb
operator|->
name|dwTrb3
operator|&
name|XHCI_TRB_3_CYCLE_BIT
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|XHCI_TRB_3_TYPE_GET
argument_list|(
name|trb
operator|->
name|dwTrb3
argument_list|)
operator|==
literal|0
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci: ring %lx trb[%lx] EP %u is RESERVED?\r\n"
operator|,
name|ep_ctx
operator|->
name|qwEpCtx2
operator|,
name|devep
operator|->
name|ep_ringaddr
operator|,
name|epid
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|pci_xhci_handle_transfer
argument_list|(
name|sc
argument_list|,
name|dev
argument_list|,
name|devep
argument_list|,
name|ep_ctx
argument_list|,
name|trb
argument_list|,
name|slot
argument_list|,
name|epid
argument_list|,
name|ringaddr
argument_list|,
name|ccs
argument_list|,
name|streamid
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|pci_xhci_dbregs_write
parameter_list|(
name|struct
name|pci_xhci_softc
modifier|*
name|sc
parameter_list|,
name|uint64_t
name|offset
parameter_list|,
name|uint64_t
name|value
parameter_list|)
block|{
name|offset
operator|=
operator|(
name|offset
operator|-
name|sc
operator|->
name|dboff
operator|)
operator|/
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci: doorbell write offset 0x%lx: 0x%lx\r\n"
operator|,
name|offset
operator|,
name|value
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|XHCI_HALTED
argument_list|(
name|sc
argument_list|)
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci: controller halted\r\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|offset
operator|==
literal|0
condition|)
name|pci_xhci_complete_commands
argument_list|(
name|sc
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|sc
operator|->
name|portregs
operator|!=
name|NULL
condition|)
name|pci_xhci_device_doorbell
argument_list|(
name|sc
argument_list|,
name|offset
argument_list|,
name|XHCI_DB_TARGET_GET
argument_list|(
name|value
argument_list|)
argument_list|,
name|XHCI_DB_SID_GET
argument_list|(
name|value
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|pci_xhci_rtsregs_write
parameter_list|(
name|struct
name|pci_xhci_softc
modifier|*
name|sc
parameter_list|,
name|uint64_t
name|offset
parameter_list|,
name|uint64_t
name|value
parameter_list|)
block|{
name|struct
name|pci_xhci_rtsregs
modifier|*
name|rts
decl_stmt|;
name|offset
operator|-=
name|sc
operator|->
name|rtsoff
expr_stmt|;
if|if
condition|(
name|offset
operator|==
literal|0
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci attempted write to MFINDEX\r\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci: runtime regs write offset 0x%lx: 0x%lx\r\n"
operator|,
name|offset
operator|,
name|value
operator|)
argument_list|)
expr_stmt|;
name|offset
operator|-=
literal|0x20
expr_stmt|;
comment|/* start of intrreg */
name|rts
operator|=
operator|&
name|sc
operator|->
name|rtsregs
expr_stmt|;
switch|switch
condition|(
name|offset
condition|)
block|{
case|case
literal|0x00
case|:
if|if
condition|(
name|value
operator|&
name|XHCI_IMAN_INTR_PEND
condition|)
name|rts
operator|->
name|intrreg
operator|.
name|iman
operator|&=
operator|~
name|XHCI_IMAN_INTR_PEND
expr_stmt|;
name|rts
operator|->
name|intrreg
operator|.
name|iman
operator|=
operator|(
name|value
operator|&
name|XHCI_IMAN_INTR_ENA
operator|)
operator||
operator|(
name|rts
operator|->
name|intrreg
operator|.
name|iman
operator|&
name|XHCI_IMAN_INTR_PEND
operator|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|value
operator|&
name|XHCI_IMAN_INTR_ENA
operator|)
condition|)
name|pci_xhci_deassert_interrupt
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x04
case|:
name|rts
operator|->
name|intrreg
operator|.
name|imod
operator|=
name|value
expr_stmt|;
break|break;
case|case
literal|0x08
case|:
name|rts
operator|->
name|intrreg
operator|.
name|erstsz
operator|=
name|value
operator|&
literal|0xFFFF
expr_stmt|;
break|break;
case|case
literal|0x10
case|:
comment|/* ERSTBA low bits */
name|rts
operator|->
name|intrreg
operator|.
name|erstba
operator|=
name|MASK_64_HI
argument_list|(
name|sc
operator|->
name|rtsregs
operator|.
name|intrreg
operator|.
name|erstba
argument_list|)
operator||
operator|(
name|value
operator|&
operator|~
literal|0x3F
operator|)
expr_stmt|;
break|break;
case|case
literal|0x14
case|:
comment|/* ERSTBA high bits */
name|rts
operator|->
name|intrreg
operator|.
name|erstba
operator|=
operator|(
name|value
operator|<<
literal|32
operator|)
operator||
name|MASK_64_LO
argument_list|(
name|sc
operator|->
name|rtsregs
operator|.
name|intrreg
operator|.
name|erstba
argument_list|)
expr_stmt|;
name|rts
operator|->
name|erstba_p
operator|=
name|XHCI_GADDR
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|rtsregs
operator|.
name|intrreg
operator|.
name|erstba
operator|&
operator|~
literal|0x3FUL
argument_list|)
expr_stmt|;
name|rts
operator|->
name|erst_p
operator|=
name|XHCI_GADDR
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|rtsregs
operator|.
name|erstba_p
operator|->
name|qwEvrsTablePtr
operator|&
operator|~
literal|0x3FUL
argument_list|)
expr_stmt|;
name|rts
operator|->
name|er_enq_idx
operator|=
literal|0
expr_stmt|;
name|rts
operator|->
name|er_events_cnt
operator|=
literal|0
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci: wr erstba erst (%p) ptr 0x%lx, sz %u\r\n"
operator|,
name|rts
operator|->
name|erstba_p
operator|,
name|rts
operator|->
name|erstba_p
operator|->
name|qwEvrsTablePtr
operator|,
name|rts
operator|->
name|erstba_p
operator|->
name|dwEvrsTableSize
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x18
case|:
comment|/* ERDP low bits */
name|rts
operator|->
name|intrreg
operator|.
name|erdp
operator|=
name|MASK_64_HI
argument_list|(
name|sc
operator|->
name|rtsregs
operator|.
name|intrreg
operator|.
name|erdp
argument_list|)
operator||
operator|(
name|rts
operator|->
name|intrreg
operator|.
name|erdp
operator|&
name|XHCI_ERDP_LO_BUSY
operator|)
operator||
operator|(
name|value
operator|&
operator|~
literal|0xF
operator|)
expr_stmt|;
if|if
condition|(
name|value
operator|&
name|XHCI_ERDP_LO_BUSY
condition|)
block|{
name|rts
operator|->
name|intrreg
operator|.
name|erdp
operator|&=
operator|~
name|XHCI_ERDP_LO_BUSY
expr_stmt|;
name|rts
operator|->
name|intrreg
operator|.
name|iman
operator|&=
operator|~
name|XHCI_IMAN_INTR_PEND
expr_stmt|;
block|}
name|rts
operator|->
name|er_deq_seg
operator|=
name|XHCI_ERDP_LO_SINDEX
argument_list|(
name|value
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x1C
case|:
comment|/* ERDP high bits */
name|rts
operator|->
name|intrreg
operator|.
name|erdp
operator|=
operator|(
name|value
operator|<<
literal|32
operator|)
operator||
name|MASK_64_LO
argument_list|(
name|sc
operator|->
name|rtsregs
operator|.
name|intrreg
operator|.
name|erdp
argument_list|)
expr_stmt|;
if|if
condition|(
name|rts
operator|->
name|er_events_cnt
operator|>
literal|0
condition|)
block|{
name|uint64_t
name|erdp
decl_stmt|;
name|uint32_t
name|erdp_i
decl_stmt|;
name|erdp
operator|=
name|rts
operator|->
name|intrreg
operator|.
name|erdp
operator|&
operator|~
literal|0xF
expr_stmt|;
name|erdp_i
operator|=
operator|(
name|erdp
operator|-
name|rts
operator|->
name|erstba_p
operator|->
name|qwEvrsTablePtr
operator|)
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|xhci_trb
argument_list|)
expr_stmt|;
if|if
condition|(
name|erdp_i
operator|<=
name|rts
operator|->
name|er_enq_idx
condition|)
name|rts
operator|->
name|er_events_cnt
operator|=
name|rts
operator|->
name|er_enq_idx
operator|-
name|erdp_i
expr_stmt|;
else|else
name|rts
operator|->
name|er_events_cnt
operator|=
name|rts
operator|->
name|erstba_p
operator|->
name|dwEvrsTableSize
operator|-
operator|(
name|erdp_i
operator|-
name|rts
operator|->
name|er_enq_idx
operator|)
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci: erdp 0x%lx, events cnt %u\r\n"
operator|,
name|erdp
operator|,
name|rts
operator|->
name|er_events_cnt
operator|)
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci attempted write to RTS offset 0x%lx\r\n"
operator|,
name|offset
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|uint64_t
name|pci_xhci_portregs_read
parameter_list|(
name|struct
name|pci_xhci_softc
modifier|*
name|sc
parameter_list|,
name|uint64_t
name|offset
parameter_list|)
block|{
name|int
name|port
decl_stmt|;
name|uint32_t
modifier|*
name|p
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|portregs
operator|==
name|NULL
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|port
operator|=
operator|(
name|offset
operator|-
literal|0x3F0
operator|)
operator|/
literal|0x10
expr_stmt|;
if|if
condition|(
name|port
operator|>
name|XHCI_MAX_DEVS
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci: portregs_read port %d>= XHCI_MAX_DEVS\r\n"
operator|,
name|port
operator|)
argument_list|)
expr_stmt|;
comment|/* return default value for unused port */
return|return
operator|(
name|XHCI_PS_SPEED_SET
argument_list|(
literal|3
argument_list|)
operator|)
return|;
block|}
name|offset
operator|=
operator|(
name|offset
operator|-
literal|0x3F0
operator|)
operator|%
literal|0x10
expr_stmt|;
name|p
operator|=
operator|&
name|sc
operator|->
name|portregs
index|[
name|port
index|]
operator|.
name|portsc
expr_stmt|;
name|p
operator|+=
name|offset
operator|/
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci: portregs read offset 0x%lx port %u -> 0x%x\r\n"
operator|,
name|offset
operator|,
name|port
operator|,
operator|*
name|p
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|*
name|p
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|pci_xhci_hostop_write
parameter_list|(
name|struct
name|pci_xhci_softc
modifier|*
name|sc
parameter_list|,
name|uint64_t
name|offset
parameter_list|,
name|uint64_t
name|value
parameter_list|)
block|{
name|offset
operator|-=
name|XHCI_CAPLEN
expr_stmt|;
if|if
condition|(
name|offset
operator|<
literal|0x400
condition|)
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci: hostop write offset 0x%lx: 0x%lx\r\n"
operator|,
name|offset
operator|,
name|value
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|offset
condition|)
block|{
case|case
name|XHCI_USBCMD
case|:
name|sc
operator|->
name|opregs
operator|.
name|usbcmd
operator|=
name|pci_xhci_usbcmd_write
argument_list|(
name|sc
argument_list|,
name|value
operator|&
literal|0x3F0F
argument_list|)
expr_stmt|;
break|break;
case|case
name|XHCI_USBSTS
case|:
comment|/* clear bits on write */
name|sc
operator|->
name|opregs
operator|.
name|usbsts
operator|&=
operator|~
operator|(
name|value
operator|&
operator|(
name|XHCI_STS_HSE
operator||
name|XHCI_STS_EINT
operator||
name|XHCI_STS_PCD
operator||
name|XHCI_STS_SSS
operator||
name|XHCI_STS_RSS
operator||
name|XHCI_STS_SRE
operator||
name|XHCI_STS_CNR
operator|)
operator|)
expr_stmt|;
break|break;
case|case
name|XHCI_PAGESIZE
case|:
comment|/* read only */
break|break;
case|case
name|XHCI_DNCTRL
case|:
name|sc
operator|->
name|opregs
operator|.
name|dnctrl
operator|=
name|value
operator|&
literal|0xFFFF
expr_stmt|;
break|break;
case|case
name|XHCI_CRCR_LO
case|:
if|if
condition|(
name|sc
operator|->
name|opregs
operator|.
name|crcr
operator|&
name|XHCI_CRCR_LO_CRR
condition|)
block|{
name|sc
operator|->
name|opregs
operator|.
name|crcr
operator|&=
operator|~
operator|(
name|XHCI_CRCR_LO_CS
operator||
name|XHCI_CRCR_LO_CA
operator|)
expr_stmt|;
name|sc
operator|->
name|opregs
operator|.
name|crcr
operator||=
name|value
operator|&
operator|(
name|XHCI_CRCR_LO_CS
operator||
name|XHCI_CRCR_LO_CA
operator|)
expr_stmt|;
block|}
else|else
block|{
name|sc
operator|->
name|opregs
operator|.
name|crcr
operator|=
name|MASK_64_HI
argument_list|(
name|sc
operator|->
name|opregs
operator|.
name|crcr
argument_list|)
operator||
operator|(
name|value
operator|&
operator|(
literal|0xFFFFFFC0
operator||
name|XHCI_CRCR_LO_RCS
operator|)
operator|)
expr_stmt|;
block|}
break|break;
case|case
name|XHCI_CRCR_HI
case|:
if|if
condition|(
operator|!
operator|(
name|sc
operator|->
name|opregs
operator|.
name|crcr
operator|&
name|XHCI_CRCR_LO_CRR
operator|)
condition|)
block|{
name|sc
operator|->
name|opregs
operator|.
name|crcr
operator|=
name|MASK_64_LO
argument_list|(
name|sc
operator|->
name|opregs
operator|.
name|crcr
argument_list|)
operator||
operator|(
name|value
operator|<<
literal|32
operator|)
expr_stmt|;
name|sc
operator|->
name|opregs
operator|.
name|cr_p
operator|=
name|XHCI_GADDR
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|opregs
operator|.
name|crcr
operator|&
operator|~
literal|0xF
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|opregs
operator|.
name|crcr
operator|&
name|XHCI_CRCR_LO_CS
condition|)
block|{
comment|/* Stop operation of Command Ring */
block|}
if|if
condition|(
name|sc
operator|->
name|opregs
operator|.
name|crcr
operator|&
name|XHCI_CRCR_LO_CA
condition|)
block|{
comment|/* Abort command */
block|}
break|break;
case|case
name|XHCI_DCBAAP_LO
case|:
name|sc
operator|->
name|opregs
operator|.
name|dcbaap
operator|=
name|MASK_64_HI
argument_list|(
name|sc
operator|->
name|opregs
operator|.
name|dcbaap
argument_list|)
operator||
operator|(
name|value
operator|&
literal|0xFFFFFFC0
operator|)
expr_stmt|;
break|break;
case|case
name|XHCI_DCBAAP_HI
case|:
name|sc
operator|->
name|opregs
operator|.
name|dcbaap
operator|=
name|MASK_64_LO
argument_list|(
name|sc
operator|->
name|opregs
operator|.
name|dcbaap
argument_list|)
operator||
operator|(
name|value
operator|<<
literal|32
operator|)
expr_stmt|;
name|sc
operator|->
name|opregs
operator|.
name|dcbaa_p
operator|=
name|XHCI_GADDR
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|opregs
operator|.
name|dcbaap
operator|&
operator|~
literal|0x3FUL
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci: opregs dcbaap = 0x%lx (vaddr 0x%lx)\r\n"
operator|,
name|sc
operator|->
name|opregs
operator|.
name|dcbaap
operator|,
operator|(
name|uint64_t
operator|)
name|sc
operator|->
name|opregs
operator|.
name|dcbaa_p
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|XHCI_CONFIG
case|:
name|sc
operator|->
name|opregs
operator|.
name|config
operator|=
name|value
operator|&
literal|0x03FF
expr_stmt|;
break|break;
default|default:
if|if
condition|(
name|offset
operator|>=
literal|0x400
condition|)
name|pci_xhci_portregs_write
argument_list|(
name|sc
argument_list|,
name|offset
argument_list|,
name|value
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|pci_xhci_write
parameter_list|(
name|struct
name|vmctx
modifier|*
name|ctx
parameter_list|,
name|int
name|vcpu
parameter_list|,
name|struct
name|pci_devinst
modifier|*
name|pi
parameter_list|,
name|int
name|baridx
parameter_list|,
name|uint64_t
name|offset
parameter_list|,
name|int
name|size
parameter_list|,
name|uint64_t
name|value
parameter_list|)
block|{
name|struct
name|pci_xhci_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|pi
operator|->
name|pi_arg
expr_stmt|;
name|assert
argument_list|(
name|baridx
operator|==
literal|0
argument_list|)
expr_stmt|;
name|pthread_mutex_lock
argument_list|(
operator|&
name|sc
operator|->
name|mtx
argument_list|)
expr_stmt|;
if|if
condition|(
name|offset
operator|<
name|XHCI_CAPLEN
condition|)
comment|/* read only registers */
name|WPRINTF
argument_list|(
operator|(
literal|"pci_xhci: write RO-CAPs offset %ld\r\n"
operator|,
name|offset
operator|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|offset
operator|<
name|sc
operator|->
name|dboff
condition|)
name|pci_xhci_hostop_write
argument_list|(
name|sc
argument_list|,
name|offset
argument_list|,
name|value
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|offset
operator|<
name|sc
operator|->
name|rtsoff
condition|)
name|pci_xhci_dbregs_write
argument_list|(
name|sc
argument_list|,
name|offset
argument_list|,
name|value
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|offset
operator|<
name|sc
operator|->
name|regsend
condition|)
name|pci_xhci_rtsregs_write
argument_list|(
name|sc
argument_list|,
name|offset
argument_list|,
name|value
argument_list|)
expr_stmt|;
else|else
name|WPRINTF
argument_list|(
operator|(
literal|"pci_xhci: write invalid offset %ld\r\n"
operator|,
name|offset
operator|)
argument_list|)
expr_stmt|;
name|pthread_mutex_unlock
argument_list|(
operator|&
name|sc
operator|->
name|mtx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|uint64_t
name|pci_xhci_hostcap_read
parameter_list|(
name|struct
name|pci_xhci_softc
modifier|*
name|sc
parameter_list|,
name|uint64_t
name|offset
parameter_list|)
block|{
name|uint64_t
name|value
decl_stmt|;
switch|switch
condition|(
name|offset
condition|)
block|{
case|case
name|XHCI_CAPLENGTH
case|:
comment|/* 0x00 */
name|value
operator|=
name|sc
operator|->
name|caplength
expr_stmt|;
break|break;
case|case
name|XHCI_HCSPARAMS1
case|:
comment|/* 0x04 */
name|value
operator|=
name|sc
operator|->
name|hcsparams1
expr_stmt|;
break|break;
case|case
name|XHCI_HCSPARAMS2
case|:
comment|/* 0x08 */
name|value
operator|=
name|sc
operator|->
name|hcsparams2
expr_stmt|;
break|break;
case|case
name|XHCI_HCSPARAMS3
case|:
comment|/* 0x0C */
name|value
operator|=
name|sc
operator|->
name|hcsparams3
expr_stmt|;
break|break;
case|case
name|XHCI_HCSPARAMS0
case|:
comment|/* 0x10 */
name|value
operator|=
name|sc
operator|->
name|hccparams1
expr_stmt|;
break|break;
case|case
name|XHCI_DBOFF
case|:
comment|/* 0x14 */
name|value
operator|=
name|sc
operator|->
name|dboff
expr_stmt|;
break|break;
case|case
name|XHCI_RTSOFF
case|:
comment|/* 0x18 */
name|value
operator|=
name|sc
operator|->
name|rtsoff
expr_stmt|;
break|break;
case|case
name|XHCI_HCCPRAMS2
case|:
comment|/* 0x1C */
name|value
operator|=
name|sc
operator|->
name|hccparams2
expr_stmt|;
break|break;
default|default:
name|value
operator|=
literal|0
expr_stmt|;
break|break;
block|}
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci: hostcap read offset 0x%lx -> 0x%lx\r\n"
operator|,
name|offset
operator|,
name|value
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|value
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint64_t
name|pci_xhci_hostop_read
parameter_list|(
name|struct
name|pci_xhci_softc
modifier|*
name|sc
parameter_list|,
name|uint64_t
name|offset
parameter_list|)
block|{
name|uint64_t
name|value
decl_stmt|;
name|offset
operator|=
operator|(
name|offset
operator|-
name|XHCI_CAPLEN
operator|)
expr_stmt|;
switch|switch
condition|(
name|offset
condition|)
block|{
case|case
name|XHCI_USBCMD
case|:
comment|/* 0x00 */
name|value
operator|=
name|sc
operator|->
name|opregs
operator|.
name|usbcmd
expr_stmt|;
break|break;
case|case
name|XHCI_USBSTS
case|:
comment|/* 0x04 */
name|value
operator|=
name|sc
operator|->
name|opregs
operator|.
name|usbsts
expr_stmt|;
break|break;
case|case
name|XHCI_PAGESIZE
case|:
comment|/* 0x08 */
name|value
operator|=
name|sc
operator|->
name|opregs
operator|.
name|pgsz
expr_stmt|;
break|break;
case|case
name|XHCI_DNCTRL
case|:
comment|/* 0x14 */
name|value
operator|=
name|sc
operator|->
name|opregs
operator|.
name|dnctrl
expr_stmt|;
break|break;
case|case
name|XHCI_CRCR_LO
case|:
comment|/* 0x18 */
name|value
operator|=
name|sc
operator|->
name|opregs
operator|.
name|crcr
operator|&
name|XHCI_CRCR_LO_CRR
expr_stmt|;
break|break;
case|case
name|XHCI_CRCR_HI
case|:
comment|/* 0x1C */
name|value
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|XHCI_DCBAAP_LO
case|:
comment|/* 0x30 */
name|value
operator|=
name|sc
operator|->
name|opregs
operator|.
name|dcbaap
operator|&
literal|0xFFFFFFFF
expr_stmt|;
break|break;
case|case
name|XHCI_DCBAAP_HI
case|:
comment|/* 0x34 */
name|value
operator|=
operator|(
name|sc
operator|->
name|opregs
operator|.
name|dcbaap
operator|>>
literal|32
operator|)
operator|&
literal|0xFFFFFFFF
expr_stmt|;
break|break;
case|case
name|XHCI_CONFIG
case|:
comment|/* 0x38 */
name|value
operator|=
name|sc
operator|->
name|opregs
operator|.
name|config
expr_stmt|;
break|break;
default|default:
if|if
condition|(
name|offset
operator|>=
literal|0x400
condition|)
name|value
operator|=
name|pci_xhci_portregs_read
argument_list|(
name|sc
argument_list|,
name|offset
argument_list|)
expr_stmt|;
else|else
name|value
operator|=
literal|0
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|offset
operator|<
literal|0x400
condition|)
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci: hostop read offset 0x%lx -> 0x%lx\r\n"
operator|,
name|offset
operator|,
name|value
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|value
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint64_t
name|pci_xhci_dbregs_read
parameter_list|(
name|struct
name|pci_xhci_softc
modifier|*
name|sc
parameter_list|,
name|uint64_t
name|offset
parameter_list|)
block|{
comment|/* read doorbell always returns 0 */
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint64_t
name|pci_xhci_rtsregs_read
parameter_list|(
name|struct
name|pci_xhci_softc
modifier|*
name|sc
parameter_list|,
name|uint64_t
name|offset
parameter_list|)
block|{
name|uint32_t
name|value
decl_stmt|;
name|offset
operator|-=
name|sc
operator|->
name|rtsoff
expr_stmt|;
name|value
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|offset
operator|==
name|XHCI_MFINDEX
condition|)
block|{
name|value
operator|=
name|sc
operator|->
name|rtsregs
operator|.
name|mfindex
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|offset
operator|>=
literal|0x20
condition|)
block|{
name|int
name|item
decl_stmt|;
name|uint32_t
modifier|*
name|p
decl_stmt|;
name|offset
operator|-=
literal|0x20
expr_stmt|;
name|item
operator|=
name|offset
operator|%
literal|32
expr_stmt|;
name|assert
argument_list|(
name|offset
operator|<
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|rtsregs
operator|.
name|intrreg
argument_list|)
argument_list|)
expr_stmt|;
name|p
operator|=
operator|&
name|sc
operator|->
name|rtsregs
operator|.
name|intrreg
operator|.
name|iman
expr_stmt|;
name|p
operator|+=
name|item
operator|/
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
name|value
operator|=
operator|*
name|p
expr_stmt|;
block|}
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci: rtsregs read offset 0x%lx -> 0x%x\r\n"
operator|,
name|offset
operator|,
name|value
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|value
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint64_t
name|pci_xhci_xecp_read
parameter_list|(
name|struct
name|pci_xhci_softc
modifier|*
name|sc
parameter_list|,
name|uint64_t
name|offset
parameter_list|)
block|{
name|uint32_t
name|value
decl_stmt|;
name|offset
operator|-=
name|sc
operator|->
name|regsend
expr_stmt|;
name|value
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|offset
condition|)
block|{
case|case
literal|0
case|:
comment|/* rev major | rev minor | next-cap | cap-id */
name|value
operator|=
operator|(
literal|0x02
operator|<<
literal|24
operator|)
operator||
operator|(
literal|4
operator|<<
literal|8
operator|)
operator||
name|XHCI_ID_PROTOCOLS
expr_stmt|;
break|break;
case|case
literal|4
case|:
comment|/* name string = "USB" */
name|value
operator|=
literal|0x20425355
expr_stmt|;
break|break;
case|case
literal|8
case|:
comment|/* psic | proto-defined | compat # | compat offset */
name|value
operator|=
operator|(
operator|(
name|XHCI_MAX_DEVS
operator|/
literal|2
operator|)
operator|<<
literal|8
operator|)
operator||
name|sc
operator|->
name|usb2_port_start
expr_stmt|;
break|break;
case|case
literal|12
case|:
break|break;
case|case
literal|16
case|:
comment|/* rev major | rev minor | next-cap | cap-id */
name|value
operator|=
operator|(
literal|0x03
operator|<<
literal|24
operator|)
operator||
name|XHCI_ID_PROTOCOLS
expr_stmt|;
break|break;
case|case
literal|20
case|:
comment|/* name string = "USB" */
name|value
operator|=
literal|0x20425355
expr_stmt|;
break|break;
case|case
literal|24
case|:
comment|/* psic | proto-defined | compat # | compat offset */
name|value
operator|=
operator|(
operator|(
name|XHCI_MAX_DEVS
operator|/
literal|2
operator|)
operator|<<
literal|8
operator|)
operator||
name|sc
operator|->
name|usb3_port_start
expr_stmt|;
break|break;
case|case
literal|28
case|:
break|break;
default|default:
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci: xecp invalid offset 0x%lx\r\n"
operator|,
name|offset
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci: xecp read offset 0x%lx -> 0x%x\r\n"
operator|,
name|offset
operator|,
name|value
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|value
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint64_t
name|pci_xhci_read
parameter_list|(
name|struct
name|vmctx
modifier|*
name|ctx
parameter_list|,
name|int
name|vcpu
parameter_list|,
name|struct
name|pci_devinst
modifier|*
name|pi
parameter_list|,
name|int
name|baridx
parameter_list|,
name|uint64_t
name|offset
parameter_list|,
name|int
name|size
parameter_list|)
block|{
name|struct
name|pci_xhci_softc
modifier|*
name|sc
decl_stmt|;
name|uint32_t
name|value
decl_stmt|;
name|sc
operator|=
name|pi
operator|->
name|pi_arg
expr_stmt|;
name|assert
argument_list|(
name|baridx
operator|==
literal|0
argument_list|)
expr_stmt|;
name|pthread_mutex_lock
argument_list|(
operator|&
name|sc
operator|->
name|mtx
argument_list|)
expr_stmt|;
if|if
condition|(
name|offset
operator|<
name|XHCI_CAPLEN
condition|)
name|value
operator|=
name|pci_xhci_hostcap_read
argument_list|(
name|sc
argument_list|,
name|offset
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|offset
operator|<
name|sc
operator|->
name|dboff
condition|)
name|value
operator|=
name|pci_xhci_hostop_read
argument_list|(
name|sc
argument_list|,
name|offset
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|offset
operator|<
name|sc
operator|->
name|rtsoff
condition|)
name|value
operator|=
name|pci_xhci_dbregs_read
argument_list|(
name|sc
argument_list|,
name|offset
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|offset
operator|<
name|sc
operator|->
name|regsend
condition|)
name|value
operator|=
name|pci_xhci_rtsregs_read
argument_list|(
name|sc
argument_list|,
name|offset
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|offset
operator|<
operator|(
name|sc
operator|->
name|regsend
operator|+
literal|4
operator|*
literal|32
operator|)
condition|)
name|value
operator|=
name|pci_xhci_xecp_read
argument_list|(
name|sc
argument_list|,
name|offset
argument_list|)
expr_stmt|;
else|else
block|{
name|value
operator|=
literal|0
expr_stmt|;
name|WPRINTF
argument_list|(
operator|(
literal|"pci_xhci: read invalid offset %ld\r\n"
operator|,
name|offset
operator|)
argument_list|)
expr_stmt|;
block|}
name|pthread_mutex_unlock
argument_list|(
operator|&
name|sc
operator|->
name|mtx
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|size
condition|)
block|{
case|case
literal|1
case|:
name|value
operator|&=
literal|0xFF
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|value
operator|&=
literal|0xFFFF
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|value
operator|&=
literal|0xFFFFFFFF
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|value
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|pci_xhci_reset_port
parameter_list|(
name|struct
name|pci_xhci_softc
modifier|*
name|sc
parameter_list|,
name|int
name|portn
parameter_list|,
name|int
name|warm
parameter_list|)
block|{
name|struct
name|pci_xhci_portregs
modifier|*
name|port
decl_stmt|;
name|struct
name|pci_xhci_dev_emu
modifier|*
name|dev
decl_stmt|;
name|struct
name|xhci_trb
name|evtrb
decl_stmt|;
name|int
name|error
decl_stmt|;
name|assert
argument_list|(
name|portn
operator|<=
name|XHCI_MAX_DEVS
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"xhci reset port %d\r\n"
operator|,
name|portn
operator|)
argument_list|)
expr_stmt|;
name|port
operator|=
name|XHCI_PORTREG_PTR
argument_list|(
name|sc
argument_list|,
name|portn
argument_list|)
expr_stmt|;
name|dev
operator|=
name|XHCI_DEVINST_PTR
argument_list|(
name|sc
argument_list|,
name|portn
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev
condition|)
block|{
name|port
operator|->
name|portsc
operator|&=
operator|~
operator|(
name|XHCI_PS_PLS_MASK
operator||
name|XHCI_PS_PR
operator||
name|XHCI_PS_PRC
operator|)
expr_stmt|;
name|port
operator|->
name|portsc
operator||=
name|XHCI_PS_PED
operator||
name|XHCI_PS_SPEED_SET
argument_list|(
name|dev
operator|->
name|dev_ue
operator|->
name|ue_usbspeed
argument_list|)
expr_stmt|;
if|if
condition|(
name|warm
operator|&&
name|dev
operator|->
name|dev_ue
operator|->
name|ue_usbver
operator|==
literal|3
condition|)
block|{
name|port
operator|->
name|portsc
operator||=
name|XHCI_PS_WRC
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|port
operator|->
name|portsc
operator|&
name|XHCI_PS_PRC
operator|)
operator|==
literal|0
condition|)
block|{
name|port
operator|->
name|portsc
operator||=
name|XHCI_PS_PRC
expr_stmt|;
name|pci_xhci_set_evtrb
argument_list|(
operator|&
name|evtrb
argument_list|,
name|portn
argument_list|,
name|XHCI_TRB_ERROR_SUCCESS
argument_list|,
name|XHCI_TRB_EVENT_PORT_STS_CHANGE
argument_list|)
expr_stmt|;
name|error
operator|=
name|pci_xhci_insert_event
argument_list|(
name|sc
argument_list|,
operator|&
name|evtrb
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|XHCI_TRB_ERROR_SUCCESS
condition|)
name|DPRINTF
argument_list|(
operator|(
literal|"xhci reset port insert event "
literal|"failed\r\n"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|pci_xhci_init_port
parameter_list|(
name|struct
name|pci_xhci_softc
modifier|*
name|sc
parameter_list|,
name|int
name|portn
parameter_list|)
block|{
name|struct
name|pci_xhci_portregs
modifier|*
name|port
decl_stmt|;
name|struct
name|pci_xhci_dev_emu
modifier|*
name|dev
decl_stmt|;
name|port
operator|=
name|XHCI_PORTREG_PTR
argument_list|(
name|sc
argument_list|,
name|portn
argument_list|)
expr_stmt|;
name|dev
operator|=
name|XHCI_DEVINST_PTR
argument_list|(
name|sc
argument_list|,
name|portn
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev
condition|)
block|{
name|port
operator|->
name|portsc
operator|=
name|XHCI_PS_CCS
operator||
comment|/* connected */
name|XHCI_PS_PP
expr_stmt|;
comment|/* port power */
if|if
condition|(
name|dev
operator|->
name|dev_ue
operator|->
name|ue_usbver
operator|==
literal|2
condition|)
block|{
name|port
operator|->
name|portsc
operator||=
name|XHCI_PS_PLS_SET
argument_list|(
name|UPS_PORT_LS_POLL
argument_list|)
operator||
name|XHCI_PS_SPEED_SET
argument_list|(
name|dev
operator|->
name|dev_ue
operator|->
name|ue_usbspeed
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|port
operator|->
name|portsc
operator||=
name|XHCI_PS_PLS_SET
argument_list|(
name|UPS_PORT_LS_U0
argument_list|)
operator||
name|XHCI_PS_PED
operator||
comment|/* enabled */
name|XHCI_PS_SPEED_SET
argument_list|(
name|dev
operator|->
name|dev_ue
operator|->
name|ue_usbspeed
argument_list|)
expr_stmt|;
block|}
name|DPRINTF
argument_list|(
operator|(
literal|"Init port %d 0x%x\n"
operator|,
name|portn
operator|,
name|port
operator|->
name|portsc
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|port
operator|->
name|portsc
operator|=
name|XHCI_PS_PLS_SET
argument_list|(
name|UPS_PORT_LS_RX_DET
argument_list|)
operator||
name|XHCI_PS_PP
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"Init empty port %d 0x%x\n"
operator|,
name|portn
operator|,
name|port
operator|->
name|portsc
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|pci_xhci_dev_intr
parameter_list|(
name|struct
name|usb_hci
modifier|*
name|hci
parameter_list|,
name|int
name|epctx
parameter_list|)
block|{
name|struct
name|pci_xhci_dev_emu
modifier|*
name|dev
decl_stmt|;
name|struct
name|xhci_dev_ctx
modifier|*
name|dev_ctx
decl_stmt|;
name|struct
name|xhci_trb
name|evtrb
decl_stmt|;
name|struct
name|pci_xhci_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|pci_xhci_portregs
modifier|*
name|p
decl_stmt|;
name|struct
name|xhci_endp_ctx
modifier|*
name|ep_ctx
decl_stmt|;
name|int
name|error
decl_stmt|;
name|int
name|dir_in
decl_stmt|;
name|int
name|epid
decl_stmt|;
name|dir_in
operator|=
name|epctx
operator|&
literal|0x80
expr_stmt|;
name|epid
operator|=
name|epctx
operator|&
operator|~
literal|0x80
expr_stmt|;
comment|/* HW endpoint contexts are 0-15; convert to epid based on dir */
name|epid
operator|=
operator|(
name|epid
operator|*
literal|2
operator|)
operator|+
operator|(
name|dir_in
condition|?
literal|1
else|:
literal|0
operator|)
expr_stmt|;
name|assert
argument_list|(
name|epid
operator|>=
literal|1
operator|&&
name|epid
operator|<=
literal|31
argument_list|)
expr_stmt|;
name|dev
operator|=
name|hci
operator|->
name|hci_sc
expr_stmt|;
name|sc
operator|=
name|dev
operator|->
name|xsc
expr_stmt|;
comment|/* check if device is ready; OS has to initialise it */
if|if
condition|(
name|sc
operator|->
name|rtsregs
operator|.
name|erstba_p
operator|==
name|NULL
operator|||
operator|(
name|sc
operator|->
name|opregs
operator|.
name|usbcmd
operator|&
name|XHCI_CMD_RS
operator|)
operator|==
literal|0
operator|||
name|dev
operator|->
name|dev_ctx
operator|==
name|NULL
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|p
operator|=
name|XHCI_PORTREG_PTR
argument_list|(
name|sc
argument_list|,
name|hci
operator|->
name|hci_port
argument_list|)
expr_stmt|;
comment|/* raise event if link U3 (suspended) state */
if|if
condition|(
name|XHCI_PS_PLS_GET
argument_list|(
name|p
operator|->
name|portsc
argument_list|)
operator|==
literal|3
condition|)
block|{
name|p
operator|->
name|portsc
operator|&=
operator|~
name|XHCI_PS_PLS_MASK
expr_stmt|;
name|p
operator|->
name|portsc
operator||=
name|XHCI_PS_PLS_SET
argument_list|(
name|UPS_PORT_LS_RESUME
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p
operator|->
name|portsc
operator|&
name|XHCI_PS_PLC
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|p
operator|->
name|portsc
operator||=
name|XHCI_PS_PLC
expr_stmt|;
name|pci_xhci_set_evtrb
argument_list|(
operator|&
name|evtrb
argument_list|,
name|hci
operator|->
name|hci_port
argument_list|,
name|XHCI_TRB_ERROR_SUCCESS
argument_list|,
name|XHCI_TRB_EVENT_PORT_STS_CHANGE
argument_list|)
expr_stmt|;
name|error
operator|=
name|pci_xhci_insert_event
argument_list|(
name|sc
argument_list|,
operator|&
name|evtrb
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|XHCI_TRB_ERROR_SUCCESS
condition|)
goto|goto
name|done
goto|;
block|}
name|dev_ctx
operator|=
name|dev
operator|->
name|dev_ctx
expr_stmt|;
name|ep_ctx
operator|=
operator|&
name|dev_ctx
operator|->
name|ctx_ep
index|[
name|epid
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|ep_ctx
operator|->
name|dwEpCtx0
operator|&
literal|0x7
operator|)
operator|==
name|XHCI_ST_EPCTX_DISABLED
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"xhci device interrupt on disabled endpoint %d\r\n"
operator|,
name|epid
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|DPRINTF
argument_list|(
operator|(
literal|"xhci device interrupt on endpoint %d\r\n"
operator|,
name|epid
operator|)
argument_list|)
expr_stmt|;
name|pci_xhci_device_doorbell
argument_list|(
name|sc
argument_list|,
name|hci
operator|->
name|hci_port
argument_list|,
name|epid
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|done
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|pci_xhci_dev_event
parameter_list|(
name|struct
name|usb_hci
modifier|*
name|hci
parameter_list|,
name|enum
name|hci_usbev
name|evid
parameter_list|,
name|void
modifier|*
name|param
parameter_list|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"xhci device event port %d\r\n"
operator|,
name|hci
operator|->
name|hci_port
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|pci_xhci_device_usage
parameter_list|(
name|char
modifier|*
name|opt
parameter_list|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Invalid USB emulation \"%s\"\r\n"
argument_list|,
name|opt
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|pci_xhci_parse_opts
parameter_list|(
name|struct
name|pci_xhci_softc
modifier|*
name|sc
parameter_list|,
name|char
modifier|*
name|opts
parameter_list|)
block|{
name|struct
name|pci_xhci_dev_emu
modifier|*
modifier|*
name|devices
decl_stmt|;
name|struct
name|pci_xhci_dev_emu
modifier|*
name|dev
decl_stmt|;
name|struct
name|usb_devemu
modifier|*
name|ue
decl_stmt|;
name|void
modifier|*
name|devsc
decl_stmt|;
name|char
modifier|*
name|uopt
decl_stmt|,
modifier|*
name|xopts
decl_stmt|,
modifier|*
name|config
decl_stmt|;
name|int
name|usb3_port
decl_stmt|,
name|usb2_port
decl_stmt|,
name|i
decl_stmt|;
name|usb3_port
operator|=
name|sc
operator|->
name|usb3_port_start
operator|-
literal|1
expr_stmt|;
name|usb2_port
operator|=
name|sc
operator|->
name|usb2_port_start
operator|-
literal|1
expr_stmt|;
name|devices
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|opts
operator|==
name|NULL
condition|)
goto|goto
name|portsfinal
goto|;
name|devices
operator|=
name|calloc
argument_list|(
name|XHCI_MAX_DEVS
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|pci_xhci_dev_emu
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|slots
operator|=
name|calloc
argument_list|(
name|XHCI_MAX_SLOTS
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|pci_xhci_dev_emu
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|devices
operator|=
name|devices
expr_stmt|;
name|sc
operator|->
name|ndevices
operator|=
literal|0
expr_stmt|;
name|uopt
operator|=
name|strdup
argument_list|(
name|opts
argument_list|)
expr_stmt|;
for|for
control|(
name|xopts
operator|=
name|strtok
argument_list|(
name|uopt
argument_list|,
literal|","
argument_list|)
init|;
name|xopts
operator|!=
name|NULL
condition|;
name|xopts
operator|=
name|strtok
argument_list|(
name|NULL
argument_list|,
literal|","
argument_list|)
control|)
block|{
if|if
condition|(
name|usb2_port
operator|==
operator|(
operator|(
name|sc
operator|->
name|usb2_port_start
operator|-
literal|1
operator|)
operator|+
name|XHCI_MAX_DEVS
operator|/
literal|2
operator|)
operator|||
name|usb3_port
operator|==
operator|(
operator|(
name|sc
operator|->
name|usb3_port_start
operator|-
literal|1
operator|)
operator|+
name|XHCI_MAX_DEVS
operator|/
literal|2
operator|)
condition|)
block|{
name|WPRINTF
argument_list|(
operator|(
literal|"pci_xhci max number of USB 2 or 3 "
literal|"devices reached, max %d\r\n"
operator|,
name|XHCI_MAX_DEVS
operator|/
literal|2
operator|)
argument_list|)
expr_stmt|;
name|usb2_port
operator|=
name|usb3_port
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|done
goto|;
block|}
comment|/* device[=<config>] */
if|if
condition|(
operator|(
name|config
operator|=
name|strchr
argument_list|(
name|xopts
argument_list|,
literal|'='
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|config
operator|=
literal|""
expr_stmt|;
comment|/* no config */
else|else
operator|*
name|config
operator|++
operator|=
literal|'\0'
expr_stmt|;
name|ue
operator|=
name|usb_emu_finddev
argument_list|(
name|xopts
argument_list|)
expr_stmt|;
if|if
condition|(
name|ue
operator|==
name|NULL
condition|)
block|{
name|pci_xhci_device_usage
argument_list|(
name|xopts
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci device not found %s\r\n"
operator|,
name|xopts
operator|)
argument_list|)
expr_stmt|;
name|usb2_port
operator|=
name|usb3_port
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci adding device %s, opts \"%s\"\r\n"
operator|,
name|xopts
operator|,
name|config
operator|)
argument_list|)
expr_stmt|;
name|dev
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|pci_xhci_dev_emu
argument_list|)
argument_list|)
expr_stmt|;
name|dev
operator|->
name|xsc
operator|=
name|sc
expr_stmt|;
name|dev
operator|->
name|hci
operator|.
name|hci_sc
operator|=
name|dev
expr_stmt|;
name|dev
operator|->
name|hci
operator|.
name|hci_intr
operator|=
name|pci_xhci_dev_intr
expr_stmt|;
name|dev
operator|->
name|hci
operator|.
name|hci_event
operator|=
name|pci_xhci_dev_event
expr_stmt|;
if|if
condition|(
name|ue
operator|->
name|ue_usbver
operator|==
literal|2
condition|)
block|{
name|dev
operator|->
name|hci
operator|.
name|hci_port
operator|=
name|usb2_port
operator|+
literal|1
expr_stmt|;
name|devices
index|[
name|usb2_port
index|]
operator|=
name|dev
expr_stmt|;
name|usb2_port
operator|++
expr_stmt|;
block|}
else|else
block|{
name|dev
operator|->
name|hci
operator|.
name|hci_port
operator|=
name|usb3_port
operator|+
literal|1
expr_stmt|;
name|devices
index|[
name|usb3_port
index|]
operator|=
name|dev
expr_stmt|;
name|usb3_port
operator|++
expr_stmt|;
block|}
name|dev
operator|->
name|hci
operator|.
name|hci_address
operator|=
literal|0
expr_stmt|;
name|devsc
operator|=
name|ue
operator|->
name|ue_init
argument_list|(
operator|&
name|dev
operator|->
name|hci
argument_list|,
name|config
argument_list|)
expr_stmt|;
if|if
condition|(
name|devsc
operator|==
name|NULL
condition|)
block|{
name|pci_xhci_device_usage
argument_list|(
name|xopts
argument_list|)
expr_stmt|;
name|usb2_port
operator|=
name|usb3_port
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|dev
operator|->
name|dev_ue
operator|=
name|ue
expr_stmt|;
name|dev
operator|->
name|dev_sc
operator|=
name|devsc
expr_stmt|;
comment|/* assign slot number to device */
name|sc
operator|->
name|slots
index|[
name|sc
operator|->
name|ndevices
index|]
operator|=
name|dev
expr_stmt|;
name|sc
operator|->
name|ndevices
operator|++
expr_stmt|;
block|}
name|portsfinal
label|:
name|sc
operator|->
name|portregs
operator|=
name|calloc
argument_list|(
name|XHCI_MAX_DEVS
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|pci_xhci_portregs
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|ndevices
operator|>
literal|0
condition|)
block|{
comment|/* port and slot numbering start from 1 */
name|sc
operator|->
name|devices
operator|--
expr_stmt|;
name|sc
operator|->
name|portregs
operator|--
expr_stmt|;
name|sc
operator|->
name|slots
operator|--
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
name|XHCI_MAX_DEVS
condition|;
name|i
operator|++
control|)
block|{
name|pci_xhci_init_port
argument_list|(
name|sc
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|WPRINTF
argument_list|(
operator|(
literal|"pci_xhci no USB devices configured\r\n"
operator|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|ndevices
operator|=
literal|1
expr_stmt|;
block|}
name|done
label|:
if|if
condition|(
name|devices
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|usb2_port
operator|<=
literal|0
operator|&&
name|usb3_port
operator|<=
literal|0
condition|)
block|{
name|sc
operator|->
name|devices
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|devices
index|[
name|i
index|]
operator|!=
name|NULL
condition|;
name|i
operator|++
control|)
name|free
argument_list|(
name|devices
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|sc
operator|->
name|ndevices
operator|=
operator|-
literal|1
expr_stmt|;
name|free
argument_list|(
name|devices
argument_list|)
expr_stmt|;
block|}
block|}
return|return
operator|(
name|sc
operator|->
name|ndevices
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|pci_xhci_init
parameter_list|(
name|struct
name|vmctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|pci_devinst
modifier|*
name|pi
parameter_list|,
name|char
modifier|*
name|opts
parameter_list|)
block|{
name|struct
name|pci_xhci_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|error
decl_stmt|;
if|if
condition|(
name|xhci_in_use
condition|)
block|{
name|WPRINTF
argument_list|(
operator|(
literal|"pci_xhci controller already defined\r\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|xhci_in_use
operator|=
literal|1
expr_stmt|;
name|sc
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|pci_xhci_softc
argument_list|)
argument_list|)
expr_stmt|;
name|pi
operator|->
name|pi_arg
operator|=
name|sc
expr_stmt|;
name|sc
operator|->
name|xsc_pi
operator|=
name|pi
expr_stmt|;
name|sc
operator|->
name|usb2_port_start
operator|=
operator|(
name|XHCI_MAX_DEVS
operator|/
literal|2
operator|)
operator|+
literal|1
expr_stmt|;
name|sc
operator|->
name|usb3_port_start
operator|=
literal|1
expr_stmt|;
comment|/* discover devices */
name|error
operator|=
name|pci_xhci_parse_opts
argument_list|(
name|sc
argument_list|,
name|opts
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|<
literal|0
condition|)
goto|goto
name|done
goto|;
else|else
name|error
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|caplength
operator|=
name|XHCI_SET_CAPLEN
argument_list|(
name|XHCI_CAPLEN
argument_list|)
operator||
name|XHCI_SET_HCIVERSION
argument_list|(
literal|0x0100
argument_list|)
expr_stmt|;
name|sc
operator|->
name|hcsparams1
operator|=
name|XHCI_SET_HCSP1_MAXPORTS
argument_list|(
name|XHCI_MAX_DEVS
argument_list|)
operator||
name|XHCI_SET_HCSP1_MAXINTR
argument_list|(
literal|1
argument_list|)
operator||
comment|/* interrupters */
name|XHCI_SET_HCSP1_MAXSLOTS
argument_list|(
name|XHCI_MAX_SLOTS
argument_list|)
expr_stmt|;
name|sc
operator|->
name|hcsparams2
operator|=
name|XHCI_SET_HCSP2_ERSTMAX
argument_list|(
name|XHCI_ERST_MAX
argument_list|)
operator||
name|XHCI_SET_HCSP2_IST
argument_list|(
literal|0x04
argument_list|)
expr_stmt|;
name|sc
operator|->
name|hcsparams3
operator|=
literal|0
expr_stmt|;
comment|/* no latency */
name|sc
operator|->
name|hccparams1
operator|=
name|XHCI_SET_HCCP1_NSS
argument_list|(
literal|1
argument_list|)
operator||
comment|/* no 2nd-streams */
name|XHCI_SET_HCCP1_SPC
argument_list|(
literal|1
argument_list|)
operator||
comment|/* short packet */
name|XHCI_SET_HCCP1_MAXPSA
argument_list|(
name|XHCI_STREAMS_MAX
argument_list|)
expr_stmt|;
name|sc
operator|->
name|hccparams2
operator|=
name|XHCI_SET_HCCP2_LEC
argument_list|(
literal|1
argument_list|)
operator||
name|XHCI_SET_HCCP2_U3C
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|sc
operator|->
name|dboff
operator|=
name|XHCI_SET_DOORBELL
argument_list|(
name|XHCI_CAPLEN
operator|+
name|XHCI_PORTREGS_START
operator|+
name|XHCI_MAX_DEVS
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|pci_xhci_portregs
argument_list|)
argument_list|)
expr_stmt|;
comment|/* dboff must be 32-bit aligned */
if|if
condition|(
name|sc
operator|->
name|dboff
operator|&
literal|0x3
condition|)
name|sc
operator|->
name|dboff
operator|=
operator|(
name|sc
operator|->
name|dboff
operator|+
literal|0x3
operator|)
operator|&
operator|~
literal|0x3
expr_stmt|;
comment|/* rtsoff must be 32-bytes aligned */
name|sc
operator|->
name|rtsoff
operator|=
name|XHCI_SET_RTSOFFSET
argument_list|(
name|sc
operator|->
name|dboff
operator|+
operator|(
name|XHCI_MAX_SLOTS
operator|+
literal|1
operator|)
operator|*
literal|32
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|rtsoff
operator|&
literal|0x1F
condition|)
name|sc
operator|->
name|rtsoff
operator|=
operator|(
name|sc
operator|->
name|rtsoff
operator|+
literal|0x1F
operator|)
operator|&
operator|~
literal|0x1F
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci dboff: 0x%x, rtsoff: 0x%x\r\n"
operator|,
name|sc
operator|->
name|dboff
operator|,
name|sc
operator|->
name|rtsoff
operator|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|opregs
operator|.
name|usbsts
operator|=
name|XHCI_STS_HCH
expr_stmt|;
name|sc
operator|->
name|opregs
operator|.
name|pgsz
operator|=
name|XHCI_PAGESIZE_4K
expr_stmt|;
name|pci_xhci_reset
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|regsend
operator|=
name|sc
operator|->
name|rtsoff
operator|+
literal|0x20
operator|+
literal|32
expr_stmt|;
comment|/* only 1 intrpter */
comment|/* 	 * Set extended capabilities pointer to be after regsend; 	 * value of xecp field is 32-bit offset. 	 */
name|sc
operator|->
name|hccparams1
operator||=
name|XHCI_SET_HCCP1_XECP
argument_list|(
name|sc
operator|->
name|regsend
operator|/
literal|4
argument_list|)
expr_stmt|;
name|pci_set_cfgdata16
argument_list|(
name|pi
argument_list|,
name|PCIR_DEVICE
argument_list|,
literal|0x1E31
argument_list|)
expr_stmt|;
name|pci_set_cfgdata16
argument_list|(
name|pi
argument_list|,
name|PCIR_VENDOR
argument_list|,
literal|0x8086
argument_list|)
expr_stmt|;
name|pci_set_cfgdata8
argument_list|(
name|pi
argument_list|,
name|PCIR_CLASS
argument_list|,
name|PCIC_SERIALBUS
argument_list|)
expr_stmt|;
name|pci_set_cfgdata8
argument_list|(
name|pi
argument_list|,
name|PCIR_SUBCLASS
argument_list|,
name|PCIS_SERIALBUS_USB
argument_list|)
expr_stmt|;
name|pci_set_cfgdata8
argument_list|(
name|pi
argument_list|,
name|PCIR_PROGIF
argument_list|,
name|PCIP_SERIALBUS_USB_XHCI
argument_list|)
expr_stmt|;
name|pci_set_cfgdata8
argument_list|(
name|pi
argument_list|,
name|PCI_USBREV
argument_list|,
name|PCI_USB_REV_3_0
argument_list|)
expr_stmt|;
name|pci_emul_add_msicap
argument_list|(
name|pi
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* regsend + xecp registers */
name|pci_emul_alloc_bar
argument_list|(
name|pi
argument_list|,
literal|0
argument_list|,
name|PCIBAR_MEM32
argument_list|,
name|sc
operator|->
name|regsend
operator|+
literal|4
operator|*
literal|32
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"pci_xhci pci_emu_alloc: %d\r\n"
operator|,
name|sc
operator|->
name|regsend
operator|+
literal|4
operator|*
literal|32
operator|)
argument_list|)
expr_stmt|;
name|pci_lintr_request
argument_list|(
name|pi
argument_list|)
expr_stmt|;
name|pthread_mutex_init
argument_list|(
operator|&
name|sc
operator|->
name|mtx
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|done
label|:
if|if
condition|(
name|error
condition|)
block|{
name|free
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_decl_stmt
name|struct
name|pci_devemu
name|pci_de_xhci
init|=
block|{
operator|.
name|pe_emu
operator|=
literal|"xhci"
block|,
operator|.
name|pe_init
operator|=
name|pci_xhci_init
block|,
operator|.
name|pe_barwrite
operator|=
name|pci_xhci_write
block|,
operator|.
name|pe_barread
operator|=
name|pci_xhci_read
block|}
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|PCI_EMUL_SET
argument_list|(
name|pci_de_xhci
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2015 Tycho Nightingale<tycho.nightingale@pluribusnetworks.com>  * Copyright (c) 2015 Leon Dang  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|WITHOUT_CAPSICUM
end_ifndef

begin_include
include|#
directive|include
file|<sys/capsicum.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/select.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<arpa/inet.h>
end_include

begin_include
include|#
directive|include
file|<machine/cpufunc.h>
end_include

begin_include
include|#
directive|include
file|<machine/specialreg.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<assert.h>
end_include

begin_include
include|#
directive|include
file|<err.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<pthread.h>
end_include

begin_include
include|#
directive|include
file|<pthread_np.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<stdbool.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<sysexits.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<zlib.h>
end_include

begin_include
include|#
directive|include
file|"bhyvegc.h"
end_include

begin_include
include|#
directive|include
file|"console.h"
end_include

begin_include
include|#
directive|include
file|"rfb.h"
end_include

begin_include
include|#
directive|include
file|"sockstream.h"
end_include

begin_decl_stmt
specifier|static
name|int
name|rfb_debug
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|DPRINTF
parameter_list|(
name|params
parameter_list|)
value|if (rfb_debug) printf params
end_define

begin_define
define|#
directive|define
name|WPRINTF
parameter_list|(
name|params
parameter_list|)
value|printf params
end_define

begin_struct
struct|struct
name|rfb_softc
block|{
name|int
name|sfd
decl_stmt|;
name|pthread_t
name|tid
decl_stmt|;
name|int
name|cfd
decl_stmt|;
name|int
name|width
decl_stmt|,
name|height
decl_stmt|;
name|bool
name|enc_raw_ok
decl_stmt|;
name|bool
name|enc_zlib_ok
decl_stmt|;
name|bool
name|enc_resize_ok
decl_stmt|;
name|z_stream
name|zstream
decl_stmt|;
name|uint8_t
modifier|*
name|zbuf
decl_stmt|;
name|int
name|zbuflen
decl_stmt|;
name|int
name|conn_wait
decl_stmt|;
name|int
name|sending
decl_stmt|;
name|pthread_mutex_t
name|mtx
decl_stmt|;
name|pthread_cond_t
name|cond
decl_stmt|;
name|int
name|hw_crc
decl_stmt|;
name|uint32_t
modifier|*
name|crc
decl_stmt|;
comment|/* WxH crc cells */
name|uint32_t
modifier|*
name|crc_tmp
decl_stmt|;
comment|/* buffer to store single crc row */
name|int
name|crc_width
decl_stmt|,
name|crc_height
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|rfb_pixfmt
block|{
name|uint8_t
name|bpp
decl_stmt|;
name|uint8_t
name|depth
decl_stmt|;
name|uint8_t
name|bigendian
decl_stmt|;
name|uint8_t
name|truecolor
decl_stmt|;
name|uint16_t
name|red_max
decl_stmt|;
name|uint16_t
name|green_max
decl_stmt|;
name|uint16_t
name|blue_max
decl_stmt|;
name|uint8_t
name|red_shift
decl_stmt|;
name|uint8_t
name|green_shift
decl_stmt|;
name|uint8_t
name|blue_shift
decl_stmt|;
name|uint8_t
name|pad
index|[
literal|3
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|rfb_srvr_info
block|{
name|uint16_t
name|width
decl_stmt|;
name|uint16_t
name|height
decl_stmt|;
name|struct
name|rfb_pixfmt
name|pixfmt
decl_stmt|;
name|uint32_t
name|namelen
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|rfb_pixfmt_msg
block|{
name|uint8_t
name|type
decl_stmt|;
name|uint8_t
name|pad
index|[
literal|3
index|]
decl_stmt|;
name|struct
name|rfb_pixfmt
name|pixfmt
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|RFB_ENCODING_RAW
value|0
end_define

begin_define
define|#
directive|define
name|RFB_ENCODING_ZLIB
value|6
end_define

begin_define
define|#
directive|define
name|RFB_ENCODING_RESIZE
value|-223
end_define

begin_define
define|#
directive|define
name|RFB_MAX_WIDTH
value|2000
end_define

begin_define
define|#
directive|define
name|RFB_MAX_HEIGHT
value|1200
end_define

begin_define
define|#
directive|define
name|RFB_ZLIB_BUFSZ
value|RFB_MAX_WIDTH*RFB_MAX_HEIGHT*4
end_define

begin_comment
comment|/* percentage changes to screen before sending the entire screen */
end_comment

begin_define
define|#
directive|define
name|RFB_SEND_ALL_THRESH
value|25
end_define

begin_struct
struct|struct
name|rfb_enc_msg
block|{
name|uint8_t
name|type
decl_stmt|;
name|uint8_t
name|pad
decl_stmt|;
name|uint16_t
name|numencs
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|rfb_updt_msg
block|{
name|uint8_t
name|type
decl_stmt|;
name|uint8_t
name|incremental
decl_stmt|;
name|uint16_t
name|x
decl_stmt|;
name|uint16_t
name|y
decl_stmt|;
name|uint16_t
name|width
decl_stmt|;
name|uint16_t
name|height
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|rfb_key_msg
block|{
name|uint8_t
name|type
decl_stmt|;
name|uint8_t
name|down
decl_stmt|;
name|uint16_t
name|pad
decl_stmt|;
name|uint32_t
name|code
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|rfb_ptr_msg
block|{
name|uint8_t
name|type
decl_stmt|;
name|uint8_t
name|button
decl_stmt|;
name|uint16_t
name|x
decl_stmt|;
name|uint16_t
name|y
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|rfb_srvr_updt_msg
block|{
name|uint8_t
name|type
decl_stmt|;
name|uint8_t
name|pad
decl_stmt|;
name|uint16_t
name|numrects
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|rfb_srvr_rect_hdr
block|{
name|uint16_t
name|x
decl_stmt|;
name|uint16_t
name|y
decl_stmt|;
name|uint16_t
name|width
decl_stmt|;
name|uint16_t
name|height
decl_stmt|;
name|uint32_t
name|encoding
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|rfb_cuttext_msg
block|{
name|uint8_t
name|type
decl_stmt|;
name|uint8_t
name|padding
index|[
literal|3
index|]
decl_stmt|;
name|uint32_t
name|length
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
name|rfb_send_server_init_msg
parameter_list|(
name|int
name|cfd
parameter_list|)
block|{
name|struct
name|bhyvegc_image
modifier|*
name|gc_image
decl_stmt|;
name|struct
name|rfb_srvr_info
name|sinfo
decl_stmt|;
name|gc_image
operator|=
name|console_get_image
argument_list|()
expr_stmt|;
name|sinfo
operator|.
name|width
operator|=
name|htons
argument_list|(
name|gc_image
operator|->
name|width
argument_list|)
expr_stmt|;
name|sinfo
operator|.
name|height
operator|=
name|htons
argument_list|(
name|gc_image
operator|->
name|height
argument_list|)
expr_stmt|;
name|sinfo
operator|.
name|pixfmt
operator|.
name|bpp
operator|=
literal|32
expr_stmt|;
name|sinfo
operator|.
name|pixfmt
operator|.
name|depth
operator|=
literal|32
expr_stmt|;
name|sinfo
operator|.
name|pixfmt
operator|.
name|bigendian
operator|=
literal|0
expr_stmt|;
name|sinfo
operator|.
name|pixfmt
operator|.
name|truecolor
operator|=
literal|1
expr_stmt|;
name|sinfo
operator|.
name|pixfmt
operator|.
name|red_max
operator|=
name|htons
argument_list|(
literal|255
argument_list|)
expr_stmt|;
name|sinfo
operator|.
name|pixfmt
operator|.
name|green_max
operator|=
name|htons
argument_list|(
literal|255
argument_list|)
expr_stmt|;
name|sinfo
operator|.
name|pixfmt
operator|.
name|blue_max
operator|=
name|htons
argument_list|(
literal|255
argument_list|)
expr_stmt|;
name|sinfo
operator|.
name|pixfmt
operator|.
name|red_shift
operator|=
literal|16
expr_stmt|;
name|sinfo
operator|.
name|pixfmt
operator|.
name|green_shift
operator|=
literal|8
expr_stmt|;
name|sinfo
operator|.
name|pixfmt
operator|.
name|blue_shift
operator|=
literal|0
expr_stmt|;
name|sinfo
operator|.
name|namelen
operator|=
name|htonl
argument_list|(
name|strlen
argument_list|(
literal|"bhyve"
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|stream_write
argument_list|(
name|cfd
argument_list|,
operator|&
name|sinfo
argument_list|,
sizeof|sizeof
argument_list|(
name|sinfo
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|stream_write
argument_list|(
name|cfd
argument_list|,
literal|"bhyve"
argument_list|,
name|strlen
argument_list|(
literal|"bhyve"
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rfb_send_resize_update_msg
parameter_list|(
name|struct
name|rfb_softc
modifier|*
name|rc
parameter_list|,
name|int
name|cfd
parameter_list|)
block|{
name|struct
name|rfb_srvr_updt_msg
name|supdt_msg
decl_stmt|;
name|struct
name|rfb_srvr_rect_hdr
name|srect_hdr
decl_stmt|;
comment|/* Number of rectangles: 1 */
name|supdt_msg
operator|.
name|type
operator|=
literal|0
expr_stmt|;
name|supdt_msg
operator|.
name|pad
operator|=
literal|0
expr_stmt|;
name|supdt_msg
operator|.
name|numrects
operator|=
name|htons
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|stream_write
argument_list|(
name|cfd
argument_list|,
operator|&
name|supdt_msg
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|rfb_srvr_updt_msg
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Rectangle header */
name|srect_hdr
operator|.
name|x
operator|=
name|htons
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|srect_hdr
operator|.
name|y
operator|=
name|htons
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|srect_hdr
operator|.
name|width
operator|=
name|htons
argument_list|(
name|rc
operator|->
name|width
argument_list|)
expr_stmt|;
name|srect_hdr
operator|.
name|height
operator|=
name|htons
argument_list|(
name|rc
operator|->
name|height
argument_list|)
expr_stmt|;
name|srect_hdr
operator|.
name|encoding
operator|=
name|htonl
argument_list|(
name|RFB_ENCODING_RESIZE
argument_list|)
expr_stmt|;
name|stream_write
argument_list|(
name|cfd
argument_list|,
operator|&
name|srect_hdr
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|rfb_srvr_rect_hdr
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rfb_recv_set_pixfmt_msg
parameter_list|(
name|struct
name|rfb_softc
modifier|*
name|rc
parameter_list|,
name|int
name|cfd
parameter_list|)
block|{
name|struct
name|rfb_pixfmt_msg
name|pixfmt_msg
decl_stmt|;
operator|(
name|void
operator|)
name|stream_read
argument_list|(
name|cfd
argument_list|,
operator|(
operator|(
name|void
operator|*
operator|)
operator|&
name|pixfmt_msg
operator|)
operator|+
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|pixfmt_msg
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rfb_recv_set_encodings_msg
parameter_list|(
name|struct
name|rfb_softc
modifier|*
name|rc
parameter_list|,
name|int
name|cfd
parameter_list|)
block|{
name|struct
name|rfb_enc_msg
name|enc_msg
decl_stmt|;
name|int
name|i
decl_stmt|;
name|uint32_t
name|encoding
decl_stmt|;
name|assert
argument_list|(
operator|(
sizeof|sizeof
argument_list|(
name|enc_msg
argument_list|)
operator|-
literal|1
operator|)
operator|==
literal|3
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|stream_read
argument_list|(
name|cfd
argument_list|,
operator|(
operator|(
name|void
operator|*
operator|)
operator|&
name|enc_msg
operator|)
operator|+
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|enc_msg
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|htons
argument_list|(
name|enc_msg
operator|.
name|numencs
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
operator|(
name|void
operator|)
name|stream_read
argument_list|(
name|cfd
argument_list|,
operator|&
name|encoding
argument_list|,
sizeof|sizeof
argument_list|(
name|encoding
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|htonl
argument_list|(
name|encoding
argument_list|)
condition|)
block|{
case|case
name|RFB_ENCODING_RAW
case|:
name|rc
operator|->
name|enc_raw_ok
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|RFB_ENCODING_ZLIB
case|:
name|rc
operator|->
name|enc_zlib_ok
operator|=
name|true
expr_stmt|;
name|deflateInit
argument_list|(
operator|&
name|rc
operator|->
name|zstream
argument_list|,
name|Z_BEST_SPEED
argument_list|)
expr_stmt|;
break|break;
case|case
name|RFB_ENCODING_RESIZE
case|:
name|rc
operator|->
name|enc_resize_ok
operator|=
name|true
expr_stmt|;
break|break;
block|}
block|}
block|}
end_function

begin_comment
comment|/*  * Calculate CRC32 using SSE4.2; Intel or AMD Bulldozer+ CPUs only  */
end_comment

begin_function
specifier|static
name|__inline
name|uint32_t
name|fast_crc32
parameter_list|(
name|void
modifier|*
name|buf
parameter_list|,
name|int
name|len
parameter_list|,
name|uint32_t
name|crcval
parameter_list|)
block|{
name|uint32_t
name|q
init|=
name|len
operator|/
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
decl_stmt|;
name|uint32_t
modifier|*
name|p
init|=
operator|(
name|uint32_t
operator|*
operator|)
name|buf
decl_stmt|;
while|while
condition|(
name|q
operator|--
condition|)
block|{
asm|asm
specifier|volatile
asm|( 			".byte 0xf2, 0xf, 0x38, 0xf1, 0xf1;" 			:"=S" (crcval) 			:"0" (crcval), "c" (*p) 		);
name|p
operator|++
expr_stmt|;
block|}
return|return
operator|(
name|crcval
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rfb_send_rect
parameter_list|(
name|struct
name|rfb_softc
modifier|*
name|rc
parameter_list|,
name|int
name|cfd
parameter_list|,
name|struct
name|bhyvegc_image
modifier|*
name|gc
parameter_list|,
name|int
name|x
parameter_list|,
name|int
name|y
parameter_list|,
name|int
name|w
parameter_list|,
name|int
name|h
parameter_list|)
block|{
name|struct
name|rfb_srvr_updt_msg
name|supdt_msg
decl_stmt|;
name|struct
name|rfb_srvr_rect_hdr
name|srect_hdr
decl_stmt|;
name|unsigned
name|long
name|zlen
decl_stmt|;
name|ssize_t
name|nwrite
decl_stmt|,
name|total
decl_stmt|;
name|int
name|err
decl_stmt|;
name|uint32_t
modifier|*
name|p
decl_stmt|;
name|uint8_t
modifier|*
name|zbufp
decl_stmt|;
comment|/* 	 * Send a single rectangle of the given x, y, w h dimensions. 	 */
comment|/* Number of rectangles: 1 */
name|supdt_msg
operator|.
name|type
operator|=
literal|0
expr_stmt|;
name|supdt_msg
operator|.
name|pad
operator|=
literal|0
expr_stmt|;
name|supdt_msg
operator|.
name|numrects
operator|=
name|htons
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|nwrite
operator|=
name|stream_write
argument_list|(
name|cfd
argument_list|,
operator|&
name|supdt_msg
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|rfb_srvr_updt_msg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|nwrite
operator|<=
literal|0
condition|)
return|return
operator|(
name|nwrite
operator|)
return|;
comment|/* Rectangle header */
name|srect_hdr
operator|.
name|x
operator|=
name|htons
argument_list|(
name|x
argument_list|)
expr_stmt|;
name|srect_hdr
operator|.
name|y
operator|=
name|htons
argument_list|(
name|y
argument_list|)
expr_stmt|;
name|srect_hdr
operator|.
name|width
operator|=
name|htons
argument_list|(
name|w
argument_list|)
expr_stmt|;
name|srect_hdr
operator|.
name|height
operator|=
name|htons
argument_list|(
name|h
argument_list|)
expr_stmt|;
name|h
operator|=
name|y
operator|+
name|h
expr_stmt|;
name|w
operator|*=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|->
name|enc_zlib_ok
condition|)
block|{
name|zbufp
operator|=
name|rc
operator|->
name|zbuf
expr_stmt|;
name|rc
operator|->
name|zstream
operator|.
name|total_in
operator|=
literal|0
expr_stmt|;
name|rc
operator|->
name|zstream
operator|.
name|total_out
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|p
operator|=
operator|&
name|gc
operator|->
name|data
index|[
name|y
operator|*
name|gc
operator|->
name|width
operator|+
name|x
index|]
init|;
name|y
operator|<
name|h
condition|;
name|y
operator|++
control|)
block|{
name|rc
operator|->
name|zstream
operator|.
name|next_in
operator|=
operator|(
name|Bytef
operator|*
operator|)
name|p
expr_stmt|;
name|rc
operator|->
name|zstream
operator|.
name|avail_in
operator|=
name|w
expr_stmt|;
name|rc
operator|->
name|zstream
operator|.
name|next_out
operator|=
operator|(
name|Bytef
operator|*
operator|)
name|zbufp
expr_stmt|;
name|rc
operator|->
name|zstream
operator|.
name|avail_out
operator|=
name|RFB_ZLIB_BUFSZ
operator|+
literal|16
operator|-
name|rc
operator|->
name|zstream
operator|.
name|total_out
expr_stmt|;
name|rc
operator|->
name|zstream
operator|.
name|data_type
operator|=
name|Z_BINARY
expr_stmt|;
comment|/* Compress with zlib */
name|err
operator|=
name|deflate
argument_list|(
operator|&
name|rc
operator|->
name|zstream
argument_list|,
name|Z_SYNC_FLUSH
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|Z_OK
condition|)
block|{
name|WPRINTF
argument_list|(
operator|(
literal|"zlib[rect] deflate err: %d\n"
operator|,
name|err
operator|)
argument_list|)
expr_stmt|;
name|rc
operator|->
name|enc_zlib_ok
operator|=
name|false
expr_stmt|;
name|deflateEnd
argument_list|(
operator|&
name|rc
operator|->
name|zstream
argument_list|)
expr_stmt|;
goto|goto
name|doraw
goto|;
block|}
name|zbufp
operator|=
name|rc
operator|->
name|zbuf
operator|+
name|rc
operator|->
name|zstream
operator|.
name|total_out
expr_stmt|;
name|p
operator|+=
name|gc
operator|->
name|width
expr_stmt|;
block|}
name|srect_hdr
operator|.
name|encoding
operator|=
name|htonl
argument_list|(
name|RFB_ENCODING_ZLIB
argument_list|)
expr_stmt|;
name|nwrite
operator|=
name|stream_write
argument_list|(
name|cfd
argument_list|,
operator|&
name|srect_hdr
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|rfb_srvr_rect_hdr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|nwrite
operator|<=
literal|0
condition|)
return|return
operator|(
name|nwrite
operator|)
return|;
name|zlen
operator|=
name|htonl
argument_list|(
name|rc
operator|->
name|zstream
operator|.
name|total_out
argument_list|)
expr_stmt|;
name|nwrite
operator|=
name|stream_write
argument_list|(
name|cfd
argument_list|,
operator|&
name|zlen
argument_list|,
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|nwrite
operator|<=
literal|0
condition|)
return|return
operator|(
name|nwrite
operator|)
return|;
return|return
operator|(
name|stream_write
argument_list|(
name|cfd
argument_list|,
name|rc
operator|->
name|zbuf
argument_list|,
name|rc
operator|->
name|zstream
operator|.
name|total_out
argument_list|)
operator|)
return|;
block|}
name|doraw
label|:
name|total
operator|=
literal|0
expr_stmt|;
name|zbufp
operator|=
name|rc
operator|->
name|zbuf
expr_stmt|;
for|for
control|(
name|p
operator|=
operator|&
name|gc
operator|->
name|data
index|[
name|y
operator|*
name|gc
operator|->
name|width
operator|+
name|x
index|]
init|;
name|y
operator|<
name|h
condition|;
name|y
operator|++
control|)
block|{
name|memcpy
argument_list|(
name|zbufp
argument_list|,
name|p
argument_list|,
name|w
argument_list|)
expr_stmt|;
name|zbufp
operator|+=
name|w
expr_stmt|;
name|total
operator|+=
name|w
expr_stmt|;
name|p
operator|+=
name|gc
operator|->
name|width
expr_stmt|;
block|}
name|srect_hdr
operator|.
name|encoding
operator|=
name|htonl
argument_list|(
name|RFB_ENCODING_RAW
argument_list|)
expr_stmt|;
name|nwrite
operator|=
name|stream_write
argument_list|(
name|cfd
argument_list|,
operator|&
name|srect_hdr
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|rfb_srvr_rect_hdr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|nwrite
operator|<=
literal|0
condition|)
return|return
operator|(
name|nwrite
operator|)
return|;
name|total
operator|=
name|stream_write
argument_list|(
name|cfd
argument_list|,
name|rc
operator|->
name|zbuf
argument_list|,
name|total
argument_list|)
expr_stmt|;
return|return
operator|(
name|total
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rfb_send_all
parameter_list|(
name|struct
name|rfb_softc
modifier|*
name|rc
parameter_list|,
name|int
name|cfd
parameter_list|,
name|struct
name|bhyvegc_image
modifier|*
name|gc
parameter_list|)
block|{
name|struct
name|rfb_srvr_updt_msg
name|supdt_msg
decl_stmt|;
name|struct
name|rfb_srvr_rect_hdr
name|srect_hdr
decl_stmt|;
name|ssize_t
name|nwrite
decl_stmt|;
name|unsigned
name|long
name|zlen
decl_stmt|;
name|int
name|err
decl_stmt|;
comment|/* 	 * Send the whole thing 	 */
comment|/* Number of rectangles: 1 */
name|supdt_msg
operator|.
name|type
operator|=
literal|0
expr_stmt|;
name|supdt_msg
operator|.
name|pad
operator|=
literal|0
expr_stmt|;
name|supdt_msg
operator|.
name|numrects
operator|=
name|htons
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|nwrite
operator|=
name|stream_write
argument_list|(
name|cfd
argument_list|,
operator|&
name|supdt_msg
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|rfb_srvr_updt_msg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|nwrite
operator|<=
literal|0
condition|)
return|return
operator|(
name|nwrite
operator|)
return|;
comment|/* Rectangle header */
name|srect_hdr
operator|.
name|x
operator|=
literal|0
expr_stmt|;
name|srect_hdr
operator|.
name|y
operator|=
literal|0
expr_stmt|;
name|srect_hdr
operator|.
name|width
operator|=
name|htons
argument_list|(
name|gc
operator|->
name|width
argument_list|)
expr_stmt|;
name|srect_hdr
operator|.
name|height
operator|=
name|htons
argument_list|(
name|gc
operator|->
name|height
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|->
name|enc_zlib_ok
condition|)
block|{
name|rc
operator|->
name|zstream
operator|.
name|next_in
operator|=
operator|(
name|Bytef
operator|*
operator|)
name|gc
operator|->
name|data
expr_stmt|;
name|rc
operator|->
name|zstream
operator|.
name|avail_in
operator|=
name|gc
operator|->
name|width
operator|*
name|gc
operator|->
name|height
operator|*
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
name|rc
operator|->
name|zstream
operator|.
name|next_out
operator|=
operator|(
name|Bytef
operator|*
operator|)
name|rc
operator|->
name|zbuf
expr_stmt|;
name|rc
operator|->
name|zstream
operator|.
name|avail_out
operator|=
name|RFB_ZLIB_BUFSZ
operator|+
literal|16
expr_stmt|;
name|rc
operator|->
name|zstream
operator|.
name|data_type
operator|=
name|Z_BINARY
expr_stmt|;
name|rc
operator|->
name|zstream
operator|.
name|total_in
operator|=
literal|0
expr_stmt|;
name|rc
operator|->
name|zstream
operator|.
name|total_out
operator|=
literal|0
expr_stmt|;
comment|/* Compress with zlib */
name|err
operator|=
name|deflate
argument_list|(
operator|&
name|rc
operator|->
name|zstream
argument_list|,
name|Z_SYNC_FLUSH
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|Z_OK
condition|)
block|{
name|WPRINTF
argument_list|(
operator|(
literal|"zlib deflate err: %d\n"
operator|,
name|err
operator|)
argument_list|)
expr_stmt|;
name|rc
operator|->
name|enc_zlib_ok
operator|=
name|false
expr_stmt|;
name|deflateEnd
argument_list|(
operator|&
name|rc
operator|->
name|zstream
argument_list|)
expr_stmt|;
goto|goto
name|doraw
goto|;
block|}
name|srect_hdr
operator|.
name|encoding
operator|=
name|htonl
argument_list|(
name|RFB_ENCODING_ZLIB
argument_list|)
expr_stmt|;
name|nwrite
operator|=
name|stream_write
argument_list|(
name|cfd
argument_list|,
operator|&
name|srect_hdr
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|rfb_srvr_rect_hdr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|nwrite
operator|<=
literal|0
condition|)
return|return
operator|(
name|nwrite
operator|)
return|;
name|zlen
operator|=
name|htonl
argument_list|(
name|rc
operator|->
name|zstream
operator|.
name|total_out
argument_list|)
expr_stmt|;
name|nwrite
operator|=
name|stream_write
argument_list|(
name|cfd
argument_list|,
operator|&
name|zlen
argument_list|,
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|nwrite
operator|<=
literal|0
condition|)
return|return
operator|(
name|nwrite
operator|)
return|;
return|return
operator|(
name|stream_write
argument_list|(
name|cfd
argument_list|,
name|rc
operator|->
name|zbuf
argument_list|,
name|rc
operator|->
name|zstream
operator|.
name|total_out
argument_list|)
operator|)
return|;
block|}
name|doraw
label|:
name|srect_hdr
operator|.
name|encoding
operator|=
name|htonl
argument_list|(
name|RFB_ENCODING_RAW
argument_list|)
expr_stmt|;
name|nwrite
operator|=
name|stream_write
argument_list|(
name|cfd
argument_list|,
operator|&
name|srect_hdr
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|rfb_srvr_rect_hdr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|nwrite
operator|<=
literal|0
condition|)
return|return
operator|(
name|nwrite
operator|)
return|;
name|nwrite
operator|=
name|stream_write
argument_list|(
name|cfd
argument_list|,
name|gc
operator|->
name|data
argument_list|,
name|gc
operator|->
name|width
operator|*
name|gc
operator|->
name|height
operator|*
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|nwrite
operator|)
return|;
block|}
end_function

begin_define
define|#
directive|define
name|PIX_PER_CELL
value|32
end_define

begin_define
define|#
directive|define
name|PIXCELL_SHIFT
value|5
end_define

begin_define
define|#
directive|define
name|PIXCELL_MASK
value|0x1F
end_define

begin_function
specifier|static
name|int
name|rfb_send_screen
parameter_list|(
name|struct
name|rfb_softc
modifier|*
name|rc
parameter_list|,
name|int
name|cfd
parameter_list|,
name|int
name|all
parameter_list|)
block|{
name|struct
name|bhyvegc_image
modifier|*
name|gc_image
decl_stmt|;
name|ssize_t
name|nwrite
decl_stmt|;
name|int
name|x
decl_stmt|,
name|y
decl_stmt|;
name|int
name|celly
decl_stmt|,
name|cellwidth
decl_stmt|;
name|int
name|xcells
decl_stmt|,
name|ycells
decl_stmt|;
name|int
name|w
decl_stmt|,
name|h
decl_stmt|;
name|uint32_t
modifier|*
name|p
decl_stmt|;
name|int
name|rem_x
decl_stmt|,
name|rem_y
decl_stmt|;
comment|/* remainder for resolutions not x32 pixels ratio */
name|int
name|retval
decl_stmt|;
name|uint32_t
modifier|*
name|crc_p
decl_stmt|,
modifier|*
name|orig_crc
decl_stmt|;
name|int
name|changes
decl_stmt|;
name|console_refresh
argument_list|()
expr_stmt|;
name|gc_image
operator|=
name|console_get_image
argument_list|()
expr_stmt|;
name|pthread_mutex_lock
argument_list|(
operator|&
name|rc
operator|->
name|mtx
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|->
name|sending
condition|)
block|{
name|pthread_mutex_unlock
argument_list|(
operator|&
name|rc
operator|->
name|mtx
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|rc
operator|->
name|sending
operator|=
literal|1
expr_stmt|;
name|pthread_mutex_unlock
argument_list|(
operator|&
name|rc
operator|->
name|mtx
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|all
condition|)
block|{
name|retval
operator|=
name|rfb_send_all
argument_list|(
name|rc
argument_list|,
name|cfd
argument_list|,
name|gc_image
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
comment|/* 	 * Calculate the checksum for each 32x32 cell. Send each that 	 * has changed since the last scan. 	 */
comment|/* Resolution changed */
name|rc
operator|->
name|crc_width
operator|=
name|gc_image
operator|->
name|width
expr_stmt|;
name|rc
operator|->
name|crc_height
operator|=
name|gc_image
operator|->
name|height
expr_stmt|;
name|w
operator|=
name|rc
operator|->
name|crc_width
expr_stmt|;
name|h
operator|=
name|rc
operator|->
name|crc_height
expr_stmt|;
name|xcells
operator|=
name|howmany
argument_list|(
name|rc
operator|->
name|crc_width
argument_list|,
name|PIX_PER_CELL
argument_list|)
expr_stmt|;
name|ycells
operator|=
name|howmany
argument_list|(
name|rc
operator|->
name|crc_height
argument_list|,
name|PIX_PER_CELL
argument_list|)
expr_stmt|;
name|rem_x
operator|=
name|w
operator|&
name|PIXCELL_MASK
expr_stmt|;
name|rem_y
operator|=
name|h
operator|&
name|PIXCELL_MASK
expr_stmt|;
if|if
condition|(
operator|!
name|rem_y
condition|)
name|rem_y
operator|=
name|PIX_PER_CELL
expr_stmt|;
name|p
operator|=
name|gc_image
operator|->
name|data
expr_stmt|;
comment|/* 	 * Go through all cells and calculate crc. If significant number 	 * of changes, then send entire screen. 	 * crc_tmp is dual purpose: to store the new crc and to flag as 	 * a cell that has changed. 	 */
name|crc_p
operator|=
name|rc
operator|->
name|crc_tmp
operator|-
name|xcells
expr_stmt|;
name|orig_crc
operator|=
name|rc
operator|->
name|crc
operator|-
name|xcells
expr_stmt|;
name|changes
operator|=
literal|0
expr_stmt|;
name|memset
argument_list|(
name|rc
operator|->
name|crc_tmp
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|*
name|xcells
operator|*
name|ycells
argument_list|)
expr_stmt|;
for|for
control|(
name|y
operator|=
literal|0
init|;
name|y
operator|<
name|h
condition|;
name|y
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|y
operator|&
name|PIXCELL_MASK
operator|)
operator|==
literal|0
condition|)
block|{
name|crc_p
operator|+=
name|xcells
expr_stmt|;
name|orig_crc
operator|+=
name|xcells
expr_stmt|;
block|}
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|<
name|xcells
condition|;
name|x
operator|++
control|)
block|{
if|if
condition|(
name|rc
operator|->
name|hw_crc
condition|)
name|crc_p
index|[
name|x
index|]
operator|=
name|fast_crc32
argument_list|(
name|p
argument_list|,
name|PIX_PER_CELL
operator|*
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|,
name|crc_p
index|[
name|x
index|]
argument_list|)
expr_stmt|;
else|else
name|crc_p
index|[
name|x
index|]
operator|=
operator|(
name|uint32_t
operator|)
name|crc32
argument_list|(
name|crc_p
index|[
name|x
index|]
argument_list|,
operator|(
name|Bytef
operator|*
operator|)
name|p
argument_list|,
name|PIX_PER_CELL
operator|*
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
expr_stmt|;
name|p
operator|+=
name|PIX_PER_CELL
expr_stmt|;
comment|/* check for crc delta if last row in cell */
if|if
condition|(
operator|(
name|y
operator|&
name|PIXCELL_MASK
operator|)
operator|==
name|PIXCELL_MASK
operator|||
name|y
operator|==
operator|(
name|h
operator|-
literal|1
operator|)
condition|)
block|{
if|if
condition|(
name|orig_crc
index|[
name|x
index|]
operator|!=
name|crc_p
index|[
name|x
index|]
condition|)
block|{
name|orig_crc
index|[
name|x
index|]
operator|=
name|crc_p
index|[
name|x
index|]
expr_stmt|;
name|crc_p
index|[
name|x
index|]
operator|=
literal|1
expr_stmt|;
name|changes
operator|++
expr_stmt|;
block|}
else|else
block|{
name|crc_p
index|[
name|x
index|]
operator|=
literal|0
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|rem_x
condition|)
block|{
if|if
condition|(
name|rc
operator|->
name|hw_crc
condition|)
name|crc_p
index|[
name|x
index|]
operator|=
name|fast_crc32
argument_list|(
name|p
argument_list|,
name|rem_x
operator|*
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|,
name|crc_p
index|[
name|x
index|]
argument_list|)
expr_stmt|;
else|else
name|crc_p
index|[
name|x
index|]
operator|=
operator|(
name|uint32_t
operator|)
name|crc32
argument_list|(
name|crc_p
index|[
name|x
index|]
argument_list|,
operator|(
name|Bytef
operator|*
operator|)
name|p
argument_list|,
name|rem_x
operator|*
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
expr_stmt|;
name|p
operator|+=
name|rem_x
expr_stmt|;
if|if
condition|(
operator|(
name|y
operator|&
name|PIXCELL_MASK
operator|)
operator|==
name|PIXCELL_MASK
operator|||
name|y
operator|==
operator|(
name|h
operator|-
literal|1
operator|)
condition|)
block|{
if|if
condition|(
name|orig_crc
index|[
name|x
index|]
operator|!=
name|crc_p
index|[
name|x
index|]
condition|)
block|{
name|orig_crc
index|[
name|x
index|]
operator|=
name|crc_p
index|[
name|x
index|]
expr_stmt|;
name|crc_p
index|[
name|x
index|]
operator|=
literal|1
expr_stmt|;
name|changes
operator|++
expr_stmt|;
block|}
else|else
block|{
name|crc_p
index|[
name|x
index|]
operator|=
literal|0
expr_stmt|;
block|}
block|}
block|}
block|}
comment|/* If number of changes is> THRESH percent, send the whole screen */
if|if
condition|(
operator|(
operator|(
name|changes
operator|*
literal|100
operator|)
operator|/
operator|(
name|xcells
operator|*
name|ycells
operator|)
operator|)
operator|>=
name|RFB_SEND_ALL_THRESH
condition|)
block|{
name|retval
operator|=
name|rfb_send_all
argument_list|(
name|rc
argument_list|,
name|cfd
argument_list|,
name|gc_image
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
comment|/* Go through all cells, and send only changed ones */
name|crc_p
operator|=
name|rc
operator|->
name|crc_tmp
expr_stmt|;
for|for
control|(
name|y
operator|=
literal|0
init|;
name|y
operator|<
name|h
condition|;
name|y
operator|+=
name|PIX_PER_CELL
control|)
block|{
comment|/* previous cell's row */
name|celly
operator|=
operator|(
name|y
operator|>>
name|PIXCELL_SHIFT
operator|)
expr_stmt|;
comment|/* Delta check crc to previous set */
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|<
name|xcells
condition|;
name|x
operator|++
control|)
block|{
if|if
condition|(
operator|*
name|crc_p
operator|++
operator|==
literal|0
condition|)
continue|continue;
if|if
condition|(
name|x
operator|==
operator|(
name|xcells
operator|-
literal|1
operator|)
operator|&&
name|rem_x
operator|>
literal|0
condition|)
name|cellwidth
operator|=
name|rem_x
expr_stmt|;
else|else
name|cellwidth
operator|=
name|PIX_PER_CELL
expr_stmt|;
name|nwrite
operator|=
name|rfb_send_rect
argument_list|(
name|rc
argument_list|,
name|cfd
argument_list|,
name|gc_image
argument_list|,
name|x
operator|*
name|PIX_PER_CELL
argument_list|,
name|celly
operator|*
name|PIX_PER_CELL
argument_list|,
name|cellwidth
argument_list|,
name|y
operator|+
name|PIX_PER_CELL
operator|>=
name|h
condition|?
name|rem_y
else|:
name|PIX_PER_CELL
argument_list|)
expr_stmt|;
if|if
condition|(
name|nwrite
operator|<=
literal|0
condition|)
block|{
name|retval
operator|=
name|nwrite
expr_stmt|;
goto|goto
name|done
goto|;
block|}
block|}
block|}
name|retval
operator|=
literal|1
expr_stmt|;
name|done
label|:
name|pthread_mutex_lock
argument_list|(
operator|&
name|rc
operator|->
name|mtx
argument_list|)
expr_stmt|;
name|rc
operator|->
name|sending
operator|=
literal|0
expr_stmt|;
name|pthread_mutex_unlock
argument_list|(
operator|&
name|rc
operator|->
name|mtx
argument_list|)
expr_stmt|;
return|return
operator|(
name|retval
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|rfb_recv_update_msg
parameter_list|(
name|struct
name|rfb_softc
modifier|*
name|rc
parameter_list|,
name|int
name|cfd
parameter_list|,
name|int
name|discardonly
parameter_list|)
block|{
name|struct
name|rfb_updt_msg
name|updt_msg
decl_stmt|;
name|struct
name|bhyvegc_image
modifier|*
name|gc_image
decl_stmt|;
operator|(
name|void
operator|)
name|stream_read
argument_list|(
name|cfd
argument_list|,
operator|(
operator|(
name|void
operator|*
operator|)
operator|&
name|updt_msg
operator|)
operator|+
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|updt_msg
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|console_refresh
argument_list|()
expr_stmt|;
name|gc_image
operator|=
name|console_get_image
argument_list|()
expr_stmt|;
name|updt_msg
operator|.
name|x
operator|=
name|htons
argument_list|(
name|updt_msg
operator|.
name|x
argument_list|)
expr_stmt|;
name|updt_msg
operator|.
name|y
operator|=
name|htons
argument_list|(
name|updt_msg
operator|.
name|y
argument_list|)
expr_stmt|;
name|updt_msg
operator|.
name|width
operator|=
name|htons
argument_list|(
name|updt_msg
operator|.
name|width
argument_list|)
expr_stmt|;
name|updt_msg
operator|.
name|height
operator|=
name|htons
argument_list|(
name|updt_msg
operator|.
name|height
argument_list|)
expr_stmt|;
if|if
condition|(
name|updt_msg
operator|.
name|width
operator|!=
name|gc_image
operator|->
name|width
operator|||
name|updt_msg
operator|.
name|height
operator|!=
name|gc_image
operator|->
name|height
condition|)
block|{
name|rc
operator|->
name|width
operator|=
name|gc_image
operator|->
name|width
expr_stmt|;
name|rc
operator|->
name|height
operator|=
name|gc_image
operator|->
name|height
expr_stmt|;
if|if
condition|(
name|rc
operator|->
name|enc_resize_ok
condition|)
name|rfb_send_resize_update_msg
argument_list|(
name|rc
argument_list|,
name|cfd
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|discardonly
condition|)
return|return;
name|rfb_send_screen
argument_list|(
name|rc
argument_list|,
name|cfd
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rfb_recv_key_msg
parameter_list|(
name|struct
name|rfb_softc
modifier|*
name|rc
parameter_list|,
name|int
name|cfd
parameter_list|)
block|{
name|struct
name|rfb_key_msg
name|key_msg
decl_stmt|;
operator|(
name|void
operator|)
name|stream_read
argument_list|(
name|cfd
argument_list|,
operator|(
operator|(
name|void
operator|*
operator|)
operator|&
name|key_msg
operator|)
operator|+
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|key_msg
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|console_key_event
argument_list|(
name|key_msg
operator|.
name|down
argument_list|,
name|htonl
argument_list|(
name|key_msg
operator|.
name|code
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rfb_recv_ptr_msg
parameter_list|(
name|struct
name|rfb_softc
modifier|*
name|rc
parameter_list|,
name|int
name|cfd
parameter_list|)
block|{
name|struct
name|rfb_ptr_msg
name|ptr_msg
decl_stmt|;
operator|(
name|void
operator|)
name|stream_read
argument_list|(
name|cfd
argument_list|,
operator|(
operator|(
name|void
operator|*
operator|)
operator|&
name|ptr_msg
operator|)
operator|+
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|ptr_msg
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|console_ptr_event
argument_list|(
name|ptr_msg
operator|.
name|button
argument_list|,
name|htons
argument_list|(
name|ptr_msg
operator|.
name|x
argument_list|)
argument_list|,
name|htons
argument_list|(
name|ptr_msg
operator|.
name|y
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rfb_recv_cuttext_msg
parameter_list|(
name|struct
name|rfb_softc
modifier|*
name|rc
parameter_list|,
name|int
name|cfd
parameter_list|)
block|{
name|struct
name|rfb_cuttext_msg
name|ct_msg
decl_stmt|;
name|unsigned
name|char
name|buf
index|[
literal|32
index|]
decl_stmt|;
name|int
name|len
decl_stmt|;
name|len
operator|=
name|stream_read
argument_list|(
name|cfd
argument_list|,
operator|(
operator|(
name|void
operator|*
operator|)
operator|&
name|ct_msg
operator|)
operator|+
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|ct_msg
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ct_msg
operator|.
name|length
operator|=
name|htonl
argument_list|(
name|ct_msg
operator|.
name|length
argument_list|)
expr_stmt|;
while|while
condition|(
name|ct_msg
operator|.
name|length
operator|>
literal|0
condition|)
block|{
name|len
operator|=
name|stream_read
argument_list|(
name|cfd
argument_list|,
name|buf
argument_list|,
name|ct_msg
operator|.
name|length
operator|>
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
condition|?
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
else|:
name|ct_msg
operator|.
name|length
argument_list|)
expr_stmt|;
name|ct_msg
operator|.
name|length
operator|-=
name|len
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int64_t
name|timeval_delta
parameter_list|(
name|struct
name|timeval
modifier|*
name|prev
parameter_list|,
name|struct
name|timeval
modifier|*
name|now
parameter_list|)
block|{
name|int64_t
name|n1
decl_stmt|,
name|n2
decl_stmt|;
name|n1
operator|=
name|now
operator|->
name|tv_sec
operator|*
literal|1000000
operator|+
name|now
operator|->
name|tv_usec
expr_stmt|;
name|n2
operator|=
name|prev
operator|->
name|tv_sec
operator|*
literal|1000000
operator|+
name|prev
operator|->
name|tv_usec
expr_stmt|;
return|return
operator|(
name|n1
operator|-
name|n2
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|rfb_wr_thr
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|rfb_softc
modifier|*
name|rc
decl_stmt|;
name|fd_set
name|rfds
decl_stmt|;
name|struct
name|timeval
name|tv
decl_stmt|;
name|struct
name|timeval
name|prev_tv
decl_stmt|;
name|int64_t
name|tdiff
decl_stmt|;
name|int
name|cfd
decl_stmt|;
name|int
name|err
decl_stmt|;
name|rc
operator|=
name|arg
expr_stmt|;
name|cfd
operator|=
name|rc
operator|->
name|cfd
expr_stmt|;
name|prev_tv
operator|.
name|tv_sec
operator|=
literal|0
expr_stmt|;
name|prev_tv
operator|.
name|tv_usec
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|rc
operator|->
name|cfd
operator|>=
literal|0
condition|)
block|{
name|FD_ZERO
argument_list|(
operator|&
name|rfds
argument_list|)
expr_stmt|;
name|FD_SET
argument_list|(
name|cfd
argument_list|,
operator|&
name|rfds
argument_list|)
expr_stmt|;
name|tv
operator|.
name|tv_sec
operator|=
literal|0
expr_stmt|;
name|tv
operator|.
name|tv_usec
operator|=
literal|10000
expr_stmt|;
name|err
operator|=
name|select
argument_list|(
name|cfd
operator|+
literal|1
argument_list|,
operator|&
name|rfds
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|tv
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|<
literal|0
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
comment|/* Determine if its time to push screen; ~24hz */
name|gettimeofday
argument_list|(
operator|&
name|tv
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|tdiff
operator|=
name|timeval_delta
argument_list|(
operator|&
name|prev_tv
argument_list|,
operator|&
name|tv
argument_list|)
expr_stmt|;
if|if
condition|(
name|tdiff
operator|>
literal|40000
condition|)
block|{
name|prev_tv
operator|.
name|tv_sec
operator|=
name|tv
operator|.
name|tv_sec
expr_stmt|;
name|prev_tv
operator|.
name|tv_usec
operator|=
name|tv
operator|.
name|tv_usec
expr_stmt|;
if|if
condition|(
name|rfb_send_screen
argument_list|(
name|rc
argument_list|,
name|cfd
argument_list|,
literal|0
argument_list|)
operator|<=
literal|0
condition|)
block|{
return|return
operator|(
name|NULL
operator|)
return|;
block|}
block|}
else|else
block|{
comment|/* sleep */
name|usleep
argument_list|(
literal|40000
operator|-
name|tdiff
argument_list|)
expr_stmt|;
block|}
block|}
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_function
name|void
name|rfb_handle
parameter_list|(
name|struct
name|rfb_softc
modifier|*
name|rc
parameter_list|,
name|int
name|cfd
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|vbuf
init|=
literal|"RFB 003.008\n"
decl_stmt|;
name|unsigned
name|char
name|buf
index|[
literal|80
index|]
decl_stmt|;
name|pthread_t
name|tid
decl_stmt|;
name|uint32_t
name|sres
decl_stmt|;
name|int
name|len
decl_stmt|;
name|rc
operator|->
name|cfd
operator|=
name|cfd
expr_stmt|;
comment|/* 1a. Send server version */
name|stream_write
argument_list|(
name|cfd
argument_list|,
name|vbuf
argument_list|,
name|strlen
argument_list|(
name|vbuf
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 1b. Read client version */
name|len
operator|=
name|read
argument_list|(
name|cfd
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 2a. Send security type 'none' */
name|buf
index|[
literal|0
index|]
operator|=
literal|1
expr_stmt|;
name|buf
index|[
literal|1
index|]
operator|=
literal|1
expr_stmt|;
comment|/* none */
name|stream_write
argument_list|(
name|cfd
argument_list|,
name|buf
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* 2b. Read agreed security type */
name|len
operator|=
name|stream_read
argument_list|(
name|cfd
argument_list|,
name|buf
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* 2c. Write back a status of 0 */
name|sres
operator|=
literal|0
expr_stmt|;
name|stream_write
argument_list|(
name|cfd
argument_list|,
operator|&
name|sres
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/* 3a. Read client shared-flag byte */
name|len
operator|=
name|stream_read
argument_list|(
name|cfd
argument_list|,
name|buf
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* 4a. Write server-init info */
name|rfb_send_server_init_msg
argument_list|(
name|cfd
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rc
operator|->
name|zbuf
condition|)
block|{
name|rc
operator|->
name|zbuf
operator|=
name|malloc
argument_list|(
name|RFB_ZLIB_BUFSZ
operator|+
literal|16
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|rc
operator|->
name|zbuf
operator|!=
name|NULL
argument_list|)
expr_stmt|;
block|}
name|rfb_send_screen
argument_list|(
name|rc
argument_list|,
name|cfd
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pthread_create
argument_list|(
operator|&
name|tid
argument_list|,
name|NULL
argument_list|,
name|rfb_wr_thr
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|pthread_set_name_np
argument_list|(
name|tid
argument_list|,
literal|"rfbout"
argument_list|)
expr_stmt|;
comment|/* Now read in client requests. 1st byte identifies type */
for|for
control|(
init|;
condition|;
control|)
block|{
name|len
operator|=
name|read
argument_list|(
name|cfd
argument_list|,
name|buf
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<=
literal|0
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"rfb client exiting\r\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
name|buf
index|[
literal|0
index|]
condition|)
block|{
case|case
literal|0
case|:
name|rfb_recv_set_pixfmt_msg
argument_list|(
name|rc
argument_list|,
name|cfd
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|rfb_recv_set_encodings_msg
argument_list|(
name|rc
argument_list|,
name|cfd
argument_list|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|rfb_recv_update_msg
argument_list|(
name|rc
argument_list|,
name|cfd
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|rfb_recv_key_msg
argument_list|(
name|rc
argument_list|,
name|cfd
argument_list|)
expr_stmt|;
break|break;
case|case
literal|5
case|:
name|rfb_recv_ptr_msg
argument_list|(
name|rc
argument_list|,
name|cfd
argument_list|)
expr_stmt|;
break|break;
case|case
literal|6
case|:
name|rfb_recv_cuttext_msg
argument_list|(
name|rc
argument_list|,
name|cfd
argument_list|)
expr_stmt|;
break|break;
default|default:
name|WPRINTF
argument_list|(
operator|(
literal|"rfb unknown cli-code %d!\n"
operator|,
name|buf
index|[
literal|0
index|]
operator|&
literal|0xff
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
block|}
name|done
label|:
name|rc
operator|->
name|cfd
operator|=
operator|-
literal|1
expr_stmt|;
name|pthread_join
argument_list|(
name|tid
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|->
name|enc_zlib_ok
condition|)
name|deflateEnd
argument_list|(
operator|&
name|rc
operator|->
name|zstream
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|rfb_thr
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|rfb_softc
modifier|*
name|rc
decl_stmt|;
name|sigset_t
name|set
decl_stmt|;
name|int
name|cfd
decl_stmt|;
name|rc
operator|=
name|arg
expr_stmt|;
name|sigemptyset
argument_list|(
operator|&
name|set
argument_list|)
expr_stmt|;
name|sigaddset
argument_list|(
operator|&
name|set
argument_list|,
name|SIGPIPE
argument_list|)
expr_stmt|;
if|if
condition|(
name|pthread_sigmask
argument_list|(
name|SIG_BLOCK
argument_list|,
operator|&
name|set
argument_list|,
name|NULL
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"pthread_sigmask"
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
for|for
control|(
init|;
condition|;
control|)
block|{
name|rc
operator|->
name|enc_raw_ok
operator|=
name|false
expr_stmt|;
name|rc
operator|->
name|enc_zlib_ok
operator|=
name|false
expr_stmt|;
name|rc
operator|->
name|enc_resize_ok
operator|=
name|false
expr_stmt|;
name|cfd
operator|=
name|accept
argument_list|(
name|rc
operator|->
name|sfd
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|->
name|conn_wait
condition|)
block|{
name|pthread_mutex_lock
argument_list|(
operator|&
name|rc
operator|->
name|mtx
argument_list|)
expr_stmt|;
name|pthread_cond_signal
argument_list|(
operator|&
name|rc
operator|->
name|cond
argument_list|)
expr_stmt|;
name|pthread_mutex_unlock
argument_list|(
operator|&
name|rc
operator|->
name|mtx
argument_list|)
expr_stmt|;
name|rc
operator|->
name|conn_wait
operator|=
literal|0
expr_stmt|;
block|}
name|rfb_handle
argument_list|(
name|rc
argument_list|,
name|cfd
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|cfd
argument_list|)
expr_stmt|;
block|}
comment|/* NOTREACHED */
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sse42_supported
parameter_list|(
name|void
parameter_list|)
block|{
name|u_int
name|cpu_registers
index|[
literal|4
index|]
decl_stmt|,
name|ecx
decl_stmt|;
name|do_cpuid
argument_list|(
literal|1
argument_list|,
name|cpu_registers
argument_list|)
expr_stmt|;
name|ecx
operator|=
name|cpu_registers
index|[
literal|2
index|]
expr_stmt|;
return|return
operator|(
operator|(
name|ecx
operator|&
name|CPUID2_SSE42
operator|)
operator|!=
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|rfb_init
parameter_list|(
name|char
modifier|*
name|hostname
parameter_list|,
name|int
name|port
parameter_list|,
name|int
name|wait
parameter_list|)
block|{
name|struct
name|rfb_softc
modifier|*
name|rc
decl_stmt|;
name|struct
name|sockaddr_in
name|sin
decl_stmt|;
name|int
name|on
init|=
literal|1
decl_stmt|;
ifndef|#
directive|ifndef
name|WITHOUT_CAPSICUM
name|cap_rights_t
name|rights
decl_stmt|;
endif|#
directive|endif
name|rc
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|rfb_softc
argument_list|)
argument_list|)
expr_stmt|;
name|rc
operator|->
name|crc
operator|=
name|calloc
argument_list|(
name|howmany
argument_list|(
name|RFB_MAX_WIDTH
operator|*
name|RFB_MAX_HEIGHT
argument_list|,
literal|32
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
expr_stmt|;
name|rc
operator|->
name|crc_tmp
operator|=
name|calloc
argument_list|(
name|howmany
argument_list|(
name|RFB_MAX_WIDTH
operator|*
name|RFB_MAX_HEIGHT
argument_list|,
literal|32
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
expr_stmt|;
name|rc
operator|->
name|crc_width
operator|=
name|RFB_MAX_WIDTH
expr_stmt|;
name|rc
operator|->
name|crc_height
operator|=
name|RFB_MAX_HEIGHT
expr_stmt|;
name|rc
operator|->
name|sfd
operator|=
name|socket
argument_list|(
name|AF_INET
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|->
name|sfd
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"socket"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|setsockopt
argument_list|(
name|rc
operator|->
name|sfd
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_REUSEADDR
argument_list|,
operator|&
name|on
argument_list|,
sizeof|sizeof
argument_list|(
name|on
argument_list|)
argument_list|)
expr_stmt|;
name|sin
operator|.
name|sin_len
operator|=
sizeof|sizeof
argument_list|(
name|sin
argument_list|)
expr_stmt|;
name|sin
operator|.
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|sin
operator|.
name|sin_port
operator|=
name|htons
argument_list|(
name|port
argument_list|)
expr_stmt|;
if|if
condition|(
name|hostname
operator|&&
name|strlen
argument_list|(
name|hostname
argument_list|)
operator|>
literal|0
condition|)
name|inet_pton
argument_list|(
name|AF_INET
argument_list|,
name|hostname
argument_list|,
operator|&
operator|(
name|sin
operator|.
name|sin_addr
operator|)
argument_list|)
expr_stmt|;
else|else
name|sin
operator|.
name|sin_addr
operator|.
name|s_addr
operator|=
name|htonl
argument_list|(
name|INADDR_ANY
argument_list|)
expr_stmt|;
if|if
condition|(
name|bind
argument_list|(
name|rc
operator|->
name|sfd
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|sin
argument_list|,
sizeof|sizeof
argument_list|(
name|sin
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"bind"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|listen
argument_list|(
name|rc
operator|->
name|sfd
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"listen"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
ifndef|#
directive|ifndef
name|WITHOUT_CAPSICUM
name|cap_rights_init
argument_list|(
operator|&
name|rights
argument_list|,
name|CAP_ACCEPT
argument_list|,
name|CAP_EVENT
argument_list|,
name|CAP_READ
argument_list|,
name|CAP_WRITE
argument_list|)
expr_stmt|;
if|if
condition|(
name|cap_rights_limit
argument_list|(
name|rc
operator|->
name|sfd
argument_list|,
operator|&
name|rights
argument_list|)
operator|==
operator|-
literal|1
operator|&&
name|errno
operator|!=
name|ENOSYS
condition|)
name|errx
argument_list|(
name|EX_OSERR
argument_list|,
literal|"Unable to apply rights for sandbox"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|rc
operator|->
name|hw_crc
operator|=
name|sse42_supported
argument_list|()
expr_stmt|;
name|rc
operator|->
name|conn_wait
operator|=
name|wait
expr_stmt|;
if|if
condition|(
name|wait
condition|)
block|{
name|pthread_mutex_init
argument_list|(
operator|&
name|rc
operator|->
name|mtx
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|pthread_cond_init
argument_list|(
operator|&
name|rc
operator|->
name|cond
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
name|pthread_create
argument_list|(
operator|&
name|rc
operator|->
name|tid
argument_list|,
name|NULL
argument_list|,
name|rfb_thr
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|pthread_set_name_np
argument_list|(
name|rc
operator|->
name|tid
argument_list|,
literal|"rfb"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wait
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"Waiting for rfb client...\n"
operator|)
argument_list|)
expr_stmt|;
name|pthread_mutex_lock
argument_list|(
operator|&
name|rc
operator|->
name|mtx
argument_list|)
expr_stmt|;
name|pthread_cond_wait
argument_list|(
operator|&
name|rc
operator|->
name|cond
argument_list|,
operator|&
name|rc
operator|->
name|mtx
argument_list|)
expr_stmt|;
name|pthread_mutex_unlock
argument_list|(
operator|&
name|rc
operator|->
name|mtx
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


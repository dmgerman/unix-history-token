begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2013  Zhixiang Yu<zcore@freebsd.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/linker_set.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<sys/uio.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/disk.h>
end_include

begin_include
include|#
directive|include
file|<sys/ata.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<stdint.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<strings.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<assert.h>
end_include

begin_include
include|#
directive|include
file|<pthread.h>
end_include

begin_include
include|#
directive|include
file|<pthread_np.h>
end_include

begin_include
include|#
directive|include
file|<inttypes.h>
end_include

begin_include
include|#
directive|include
file|<md5.h>
end_include

begin_include
include|#
directive|include
file|"bhyverun.h"
end_include

begin_include
include|#
directive|include
file|"pci_emul.h"
end_include

begin_include
include|#
directive|include
file|"ahci.h"
end_include

begin_include
include|#
directive|include
file|"block_if.h"
end_include

begin_define
define|#
directive|define
name|MAX_PORTS
value|6
end_define

begin_comment
comment|/* Intel ICH8 AHCI supports 6 ports */
end_comment

begin_define
define|#
directive|define
name|PxSIG_ATA
value|0x00000101
end_define

begin_comment
comment|/* ATA drive */
end_comment

begin_define
define|#
directive|define
name|PxSIG_ATAPI
value|0xeb140101
end_define

begin_comment
comment|/* ATAPI drive */
end_comment

begin_enum
enum|enum
name|sata_fis_type
block|{
name|FIS_TYPE_REGH2D
init|=
literal|0x27
block|,
comment|/* Register FIS - host to device */
name|FIS_TYPE_REGD2H
init|=
literal|0x34
block|,
comment|/* Register FIS - device to host */
name|FIS_TYPE_DMAACT
init|=
literal|0x39
block|,
comment|/* DMA activate FIS - device to host */
name|FIS_TYPE_DMASETUP
init|=
literal|0x41
block|,
comment|/* DMA setup FIS - bidirectional */
name|FIS_TYPE_DATA
init|=
literal|0x46
block|,
comment|/* Data FIS - bidirectional */
name|FIS_TYPE_BIST
init|=
literal|0x58
block|,
comment|/* BIST activate FIS - bidirectional */
name|FIS_TYPE_PIOSETUP
init|=
literal|0x5F
block|,
comment|/* PIO setup FIS - device to host */
name|FIS_TYPE_SETDEVBITS
init|=
literal|0xA1
block|,
comment|/* Set dev bits FIS - device to host */
block|}
enum|;
end_enum

begin_comment
comment|/*  * SCSI opcodes  */
end_comment

begin_define
define|#
directive|define
name|TEST_UNIT_READY
value|0x00
end_define

begin_define
define|#
directive|define
name|REQUEST_SENSE
value|0x03
end_define

begin_define
define|#
directive|define
name|INQUIRY
value|0x12
end_define

begin_define
define|#
directive|define
name|START_STOP_UNIT
value|0x1B
end_define

begin_define
define|#
directive|define
name|PREVENT_ALLOW
value|0x1E
end_define

begin_define
define|#
directive|define
name|READ_CAPACITY
value|0x25
end_define

begin_define
define|#
directive|define
name|READ_10
value|0x28
end_define

begin_define
define|#
directive|define
name|POSITION_TO_ELEMENT
value|0x2B
end_define

begin_define
define|#
directive|define
name|READ_TOC
value|0x43
end_define

begin_define
define|#
directive|define
name|GET_EVENT_STATUS_NOTIFICATION
value|0x4A
end_define

begin_define
define|#
directive|define
name|MODE_SENSE_10
value|0x5A
end_define

begin_define
define|#
directive|define
name|REPORT_LUNS
value|0xA0
end_define

begin_define
define|#
directive|define
name|READ_12
value|0xA8
end_define

begin_define
define|#
directive|define
name|READ_CD
value|0xBE
end_define

begin_comment
comment|/*  * SCSI mode page codes  */
end_comment

begin_define
define|#
directive|define
name|MODEPAGE_RW_ERROR_RECOVERY
value|0x01
end_define

begin_define
define|#
directive|define
name|MODEPAGE_CD_CAPABILITIES
value|0x2A
end_define

begin_comment
comment|/*  * ATA commands  */
end_comment

begin_define
define|#
directive|define
name|ATA_SF_ENAB_SATA_SF
value|0x10
end_define

begin_define
define|#
directive|define
name|ATA_SATA_SF_AN
value|0x05
end_define

begin_define
define|#
directive|define
name|ATA_SF_DIS_SATA_SF
value|0x90
end_define

begin_comment
comment|/*  * Debug printf  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|AHCI_DEBUG
end_ifdef

begin_decl_stmt
specifier|static
name|FILE
modifier|*
name|dbg
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|DPRINTF
parameter_list|(
name|format
parameter_list|,
name|arg
modifier|...
parameter_list|)
value|do{fprintf(dbg, format, ##arg);fflush(dbg);}while(0)
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|DPRINTF
parameter_list|(
name|format
parameter_list|,
name|arg
modifier|...
parameter_list|)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|WPRINTF
parameter_list|(
name|format
parameter_list|,
name|arg
modifier|...
parameter_list|)
value|printf(format, ##arg)
end_define

begin_struct
struct|struct
name|ahci_ioreq
block|{
name|struct
name|blockif_req
name|io_req
decl_stmt|;
name|struct
name|ahci_port
modifier|*
name|io_pr
decl_stmt|;
name|STAILQ_ENTRY
argument_list|(
argument|ahci_ioreq
argument_list|)
name|io_flist
expr_stmt|;
name|TAILQ_ENTRY
argument_list|(
argument|ahci_ioreq
argument_list|)
name|io_blist
expr_stmt|;
name|uint8_t
modifier|*
name|cfis
decl_stmt|;
name|uint32_t
name|len
decl_stmt|;
name|uint32_t
name|done
decl_stmt|;
name|int
name|slot
decl_stmt|;
name|int
name|more
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|ahci_port
block|{
name|struct
name|blockif_ctxt
modifier|*
name|bctx
decl_stmt|;
name|struct
name|pci_ahci_softc
modifier|*
name|pr_sc
decl_stmt|;
name|uint8_t
modifier|*
name|cmd_lst
decl_stmt|;
name|uint8_t
modifier|*
name|rfis
decl_stmt|;
name|char
name|ident
index|[
literal|20
operator|+
literal|1
index|]
decl_stmt|;
name|int
name|atapi
decl_stmt|;
name|int
name|reset
decl_stmt|;
name|int
name|mult_sectors
decl_stmt|;
name|uint8_t
name|xfermode
decl_stmt|;
name|uint8_t
name|err_cfis
index|[
literal|20
index|]
decl_stmt|;
name|uint8_t
name|sense_key
decl_stmt|;
name|uint8_t
name|asc
decl_stmt|;
name|uint32_t
name|pending
decl_stmt|;
name|uint32_t
name|clb
decl_stmt|;
name|uint32_t
name|clbu
decl_stmt|;
name|uint32_t
name|fb
decl_stmt|;
name|uint32_t
name|fbu
decl_stmt|;
name|uint32_t
name|is
decl_stmt|;
name|uint32_t
name|ie
decl_stmt|;
name|uint32_t
name|cmd
decl_stmt|;
name|uint32_t
name|unused0
decl_stmt|;
name|uint32_t
name|tfd
decl_stmt|;
name|uint32_t
name|sig
decl_stmt|;
name|uint32_t
name|ssts
decl_stmt|;
name|uint32_t
name|sctl
decl_stmt|;
name|uint32_t
name|serr
decl_stmt|;
name|uint32_t
name|sact
decl_stmt|;
name|uint32_t
name|ci
decl_stmt|;
name|uint32_t
name|sntf
decl_stmt|;
name|uint32_t
name|fbs
decl_stmt|;
comment|/* 	 * i/o request info 	 */
name|struct
name|ahci_ioreq
modifier|*
name|ioreq
decl_stmt|;
name|int
name|ioqsz
decl_stmt|;
name|STAILQ_HEAD
argument_list|(
argument|ahci_fhead
argument_list|,
argument|ahci_ioreq
argument_list|)
name|iofhd
expr_stmt|;
name|TAILQ_HEAD
argument_list|(
argument|ahci_bhead
argument_list|,
argument|ahci_ioreq
argument_list|)
name|iobhd
expr_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|ahci_cmd_hdr
block|{
name|uint16_t
name|flags
decl_stmt|;
name|uint16_t
name|prdtl
decl_stmt|;
name|uint32_t
name|prdbc
decl_stmt|;
name|uint64_t
name|ctba
decl_stmt|;
name|uint32_t
name|reserved
index|[
literal|4
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|ahci_prdt_entry
block|{
name|uint64_t
name|dba
decl_stmt|;
name|uint32_t
name|reserved
decl_stmt|;
define|#
directive|define
name|DBCMASK
value|0x3fffff
name|uint32_t
name|dbc
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|pci_ahci_softc
block|{
name|struct
name|pci_devinst
modifier|*
name|asc_pi
decl_stmt|;
name|pthread_mutex_t
name|mtx
decl_stmt|;
name|int
name|ports
decl_stmt|;
name|uint32_t
name|cap
decl_stmt|;
name|uint32_t
name|ghc
decl_stmt|;
name|uint32_t
name|is
decl_stmt|;
name|uint32_t
name|pi
decl_stmt|;
name|uint32_t
name|vs
decl_stmt|;
name|uint32_t
name|ccc_ctl
decl_stmt|;
name|uint32_t
name|ccc_pts
decl_stmt|;
name|uint32_t
name|em_loc
decl_stmt|;
name|uint32_t
name|em_ctl
decl_stmt|;
name|uint32_t
name|cap2
decl_stmt|;
name|uint32_t
name|bohc
decl_stmt|;
name|uint32_t
name|lintr
decl_stmt|;
name|struct
name|ahci_port
name|port
index|[
name|MAX_PORTS
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|ahci_ctx
parameter_list|(
name|sc
parameter_list|)
value|((sc)->asc_pi->pi_vmctx)
end_define

begin_function
specifier|static
specifier|inline
name|void
name|lba_to_msf
parameter_list|(
name|uint8_t
modifier|*
name|buf
parameter_list|,
name|int
name|lba
parameter_list|)
block|{
name|lba
operator|+=
literal|150
expr_stmt|;
name|buf
index|[
literal|0
index|]
operator|=
operator|(
name|lba
operator|/
literal|75
operator|)
operator|/
literal|60
expr_stmt|;
name|buf
index|[
literal|1
index|]
operator|=
operator|(
name|lba
operator|/
literal|75
operator|)
operator|%
literal|60
expr_stmt|;
name|buf
index|[
literal|2
index|]
operator|=
name|lba
operator|%
literal|75
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * generate HBA intr depending on whether or not ports within  * the controller have an interrupt pending.  */
end_comment

begin_function
specifier|static
name|void
name|ahci_generate_intr
parameter_list|(
name|struct
name|pci_ahci_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|pci_devinst
modifier|*
name|pi
decl_stmt|;
name|int
name|i
decl_stmt|;
name|pi
operator|=
name|sc
operator|->
name|asc_pi
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|ports
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|ahci_port
modifier|*
name|pr
decl_stmt|;
name|pr
operator|=
operator|&
name|sc
operator|->
name|port
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|pr
operator|->
name|is
operator|&
name|pr
operator|->
name|ie
condition|)
name|sc
operator|->
name|is
operator||=
operator|(
literal|1
operator|<<
name|i
operator|)
expr_stmt|;
block|}
name|DPRINTF
argument_list|(
literal|"%s %x\n"
argument_list|,
name|__func__
argument_list|,
name|sc
operator|->
name|is
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|is
operator|&&
operator|(
name|sc
operator|->
name|ghc
operator|&
name|AHCI_GHC_IE
operator|)
condition|)
block|{
if|if
condition|(
name|pci_msi_enabled
argument_list|(
name|pi
argument_list|)
condition|)
block|{
comment|/* 			 * Generate an MSI interrupt on every edge 			 */
name|pci_generate_msi
argument_list|(
name|pi
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|sc
operator|->
name|lintr
condition|)
block|{
comment|/* 			 * Only generate a pin-based interrupt if one wasn't 			 * in progress 			 */
name|sc
operator|->
name|lintr
operator|=
literal|1
expr_stmt|;
name|pci_lintr_assert
argument_list|(
name|pi
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|sc
operator|->
name|lintr
condition|)
block|{
comment|/* 		 * No interrupts: deassert pin-based signal if it had 		 * been asserted 		 */
name|pci_lintr_deassert
argument_list|(
name|pi
argument_list|)
expr_stmt|;
name|sc
operator|->
name|lintr
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ahci_write_fis
parameter_list|(
name|struct
name|ahci_port
modifier|*
name|p
parameter_list|,
name|enum
name|sata_fis_type
name|ft
parameter_list|,
name|uint8_t
modifier|*
name|fis
parameter_list|)
block|{
name|int
name|offset
decl_stmt|,
name|len
decl_stmt|,
name|irq
decl_stmt|;
if|if
condition|(
name|p
operator|->
name|rfis
operator|==
name|NULL
operator|||
operator|!
operator|(
name|p
operator|->
name|cmd
operator|&
name|AHCI_P_CMD_FRE
operator|)
condition|)
return|return;
switch|switch
condition|(
name|ft
condition|)
block|{
case|case
name|FIS_TYPE_REGD2H
case|:
name|offset
operator|=
literal|0x40
expr_stmt|;
name|len
operator|=
literal|20
expr_stmt|;
name|irq
operator|=
name|AHCI_P_IX_DHR
expr_stmt|;
break|break;
case|case
name|FIS_TYPE_SETDEVBITS
case|:
name|offset
operator|=
literal|0x58
expr_stmt|;
name|len
operator|=
literal|8
expr_stmt|;
name|irq
operator|=
name|AHCI_P_IX_SDB
expr_stmt|;
break|break;
case|case
name|FIS_TYPE_PIOSETUP
case|:
name|offset
operator|=
literal|0x20
expr_stmt|;
name|len
operator|=
literal|20
expr_stmt|;
name|irq
operator|=
literal|0
expr_stmt|;
break|break;
default|default:
name|WPRINTF
argument_list|(
literal|"unsupported fis type %d\n"
argument_list|,
name|ft
argument_list|)
expr_stmt|;
return|return;
block|}
name|memcpy
argument_list|(
name|p
operator|->
name|rfis
operator|+
name|offset
argument_list|,
name|fis
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|irq
condition|)
block|{
name|p
operator|->
name|is
operator||=
name|irq
expr_stmt|;
name|ahci_generate_intr
argument_list|(
name|p
operator|->
name|pr_sc
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ahci_write_fis_piosetup
parameter_list|(
name|struct
name|ahci_port
modifier|*
name|p
parameter_list|)
block|{
name|uint8_t
name|fis
index|[
literal|20
index|]
decl_stmt|;
name|memset
argument_list|(
name|fis
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|fis
argument_list|)
argument_list|)
expr_stmt|;
name|fis
index|[
literal|0
index|]
operator|=
name|FIS_TYPE_PIOSETUP
expr_stmt|;
name|ahci_write_fis
argument_list|(
name|p
argument_list|,
name|FIS_TYPE_PIOSETUP
argument_list|,
name|fis
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ahci_write_fis_sdb
parameter_list|(
name|struct
name|ahci_port
modifier|*
name|p
parameter_list|,
name|int
name|slot
parameter_list|,
name|uint8_t
modifier|*
name|cfis
parameter_list|,
name|uint32_t
name|tfd
parameter_list|)
block|{
name|uint8_t
name|fis
index|[
literal|8
index|]
decl_stmt|;
name|uint8_t
name|error
decl_stmt|;
name|error
operator|=
operator|(
name|tfd
operator|>>
literal|8
operator|)
operator|&
literal|0xff
expr_stmt|;
name|memset
argument_list|(
name|fis
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|fis
argument_list|)
argument_list|)
expr_stmt|;
name|fis
index|[
literal|0
index|]
operator|=
name|FIS_TYPE_SETDEVBITS
expr_stmt|;
name|fis
index|[
literal|1
index|]
operator|=
operator|(
literal|1
operator|<<
literal|6
operator|)
expr_stmt|;
name|fis
index|[
literal|2
index|]
operator|=
name|tfd
operator|&
literal|0x77
expr_stmt|;
name|fis
index|[
literal|3
index|]
operator|=
name|error
expr_stmt|;
if|if
condition|(
name|fis
index|[
literal|2
index|]
operator|&
name|ATA_S_ERROR
condition|)
block|{
name|p
operator|->
name|is
operator||=
name|AHCI_P_IX_TFE
expr_stmt|;
name|p
operator|->
name|err_cfis
index|[
literal|0
index|]
operator|=
name|slot
expr_stmt|;
name|p
operator|->
name|err_cfis
index|[
literal|2
index|]
operator|=
name|tfd
operator|&
literal|0x77
expr_stmt|;
name|p
operator|->
name|err_cfis
index|[
literal|3
index|]
operator|=
name|error
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|p
operator|->
name|err_cfis
index|[
literal|4
index|]
argument_list|,
name|cfis
operator|+
literal|4
argument_list|,
literal|16
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|*
operator|(
name|uint32_t
operator|*
operator|)
operator|(
name|fis
operator|+
literal|4
operator|)
operator|=
operator|(
literal|1
operator|<<
name|slot
operator|)
expr_stmt|;
name|p
operator|->
name|sact
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|slot
operator|)
expr_stmt|;
block|}
name|p
operator|->
name|tfd
operator|=
name|tfd
expr_stmt|;
name|ahci_write_fis
argument_list|(
name|p
argument_list|,
name|FIS_TYPE_SETDEVBITS
argument_list|,
name|fis
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ahci_write_fis_d2h
parameter_list|(
name|struct
name|ahci_port
modifier|*
name|p
parameter_list|,
name|int
name|slot
parameter_list|,
name|uint8_t
modifier|*
name|cfis
parameter_list|,
name|uint32_t
name|tfd
parameter_list|)
block|{
name|uint8_t
name|fis
index|[
literal|20
index|]
decl_stmt|;
name|uint8_t
name|error
decl_stmt|;
name|error
operator|=
operator|(
name|tfd
operator|>>
literal|8
operator|)
operator|&
literal|0xff
expr_stmt|;
name|memset
argument_list|(
name|fis
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|fis
argument_list|)
argument_list|)
expr_stmt|;
name|fis
index|[
literal|0
index|]
operator|=
name|FIS_TYPE_REGD2H
expr_stmt|;
name|fis
index|[
literal|1
index|]
operator|=
operator|(
literal|1
operator|<<
literal|6
operator|)
expr_stmt|;
name|fis
index|[
literal|2
index|]
operator|=
name|tfd
operator|&
literal|0xff
expr_stmt|;
name|fis
index|[
literal|3
index|]
operator|=
name|error
expr_stmt|;
name|fis
index|[
literal|4
index|]
operator|=
name|cfis
index|[
literal|4
index|]
expr_stmt|;
name|fis
index|[
literal|5
index|]
operator|=
name|cfis
index|[
literal|5
index|]
expr_stmt|;
name|fis
index|[
literal|6
index|]
operator|=
name|cfis
index|[
literal|6
index|]
expr_stmt|;
name|fis
index|[
literal|7
index|]
operator|=
name|cfis
index|[
literal|7
index|]
expr_stmt|;
name|fis
index|[
literal|8
index|]
operator|=
name|cfis
index|[
literal|8
index|]
expr_stmt|;
name|fis
index|[
literal|9
index|]
operator|=
name|cfis
index|[
literal|9
index|]
expr_stmt|;
name|fis
index|[
literal|10
index|]
operator|=
name|cfis
index|[
literal|10
index|]
expr_stmt|;
name|fis
index|[
literal|11
index|]
operator|=
name|cfis
index|[
literal|11
index|]
expr_stmt|;
name|fis
index|[
literal|12
index|]
operator|=
name|cfis
index|[
literal|12
index|]
expr_stmt|;
name|fis
index|[
literal|13
index|]
operator|=
name|cfis
index|[
literal|13
index|]
expr_stmt|;
if|if
condition|(
name|fis
index|[
literal|2
index|]
operator|&
name|ATA_S_ERROR
condition|)
block|{
name|p
operator|->
name|is
operator||=
name|AHCI_P_IX_TFE
expr_stmt|;
name|p
operator|->
name|err_cfis
index|[
literal|0
index|]
operator|=
literal|0x80
expr_stmt|;
name|p
operator|->
name|err_cfis
index|[
literal|2
index|]
operator|=
name|tfd
operator|&
literal|0xff
expr_stmt|;
name|p
operator|->
name|err_cfis
index|[
literal|3
index|]
operator|=
name|error
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|p
operator|->
name|err_cfis
index|[
literal|4
index|]
argument_list|,
name|cfis
operator|+
literal|4
argument_list|,
literal|16
argument_list|)
expr_stmt|;
block|}
else|else
name|p
operator|->
name|ci
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|slot
operator|)
expr_stmt|;
name|p
operator|->
name|tfd
operator|=
name|tfd
expr_stmt|;
name|ahci_write_fis
argument_list|(
name|p
argument_list|,
name|FIS_TYPE_REGD2H
argument_list|,
name|fis
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ahci_write_reset_fis_d2h
parameter_list|(
name|struct
name|ahci_port
modifier|*
name|p
parameter_list|)
block|{
name|uint8_t
name|fis
index|[
literal|20
index|]
decl_stmt|;
name|memset
argument_list|(
name|fis
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|fis
argument_list|)
argument_list|)
expr_stmt|;
name|fis
index|[
literal|0
index|]
operator|=
name|FIS_TYPE_REGD2H
expr_stmt|;
name|fis
index|[
literal|3
index|]
operator|=
literal|1
expr_stmt|;
name|fis
index|[
literal|4
index|]
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|atapi
condition|)
block|{
name|fis
index|[
literal|5
index|]
operator|=
literal|0x14
expr_stmt|;
name|fis
index|[
literal|6
index|]
operator|=
literal|0xeb
expr_stmt|;
block|}
name|fis
index|[
literal|12
index|]
operator|=
literal|1
expr_stmt|;
name|ahci_write_fis
argument_list|(
name|p
argument_list|,
name|FIS_TYPE_REGD2H
argument_list|,
name|fis
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ahci_check_stopped
parameter_list|(
name|struct
name|ahci_port
modifier|*
name|p
parameter_list|)
block|{
comment|/* 	 * If we are no longer processing the command list and nothing 	 * is in-flight, clear the running bit, the current command 	 * slot, the command issue and active bits. 	 */
if|if
condition|(
operator|!
operator|(
name|p
operator|->
name|cmd
operator|&
name|AHCI_P_CMD_ST
operator|)
condition|)
block|{
if|if
condition|(
name|p
operator|->
name|pending
operator|==
literal|0
condition|)
block|{
name|p
operator|->
name|cmd
operator|&=
operator|~
operator|(
name|AHCI_P_CMD_CR
operator||
name|AHCI_P_CMD_CCS_MASK
operator|)
expr_stmt|;
name|p
operator|->
name|ci
operator|=
literal|0
expr_stmt|;
name|p
operator|->
name|sact
operator|=
literal|0
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ahci_port_stop
parameter_list|(
name|struct
name|ahci_port
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|ahci_ioreq
modifier|*
name|aior
decl_stmt|;
name|uint8_t
modifier|*
name|cfis
decl_stmt|;
name|int
name|slot
decl_stmt|;
name|int
name|ncq
decl_stmt|;
name|int
name|error
decl_stmt|;
name|assert
argument_list|(
name|pthread_mutex_isowned_np
argument_list|(
operator|&
name|p
operator|->
name|pr_sc
operator|->
name|mtx
argument_list|)
argument_list|)
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|aior
argument_list|,
argument|&p->iobhd
argument_list|,
argument|io_blist
argument_list|)
block|{
comment|/* 		 * Try to cancel the outstanding blockif request. 		 */
name|error
operator|=
name|blockif_cancel
argument_list|(
name|p
operator|->
name|bctx
argument_list|,
operator|&
name|aior
operator|->
name|io_req
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
continue|continue;
name|slot
operator|=
name|aior
operator|->
name|slot
expr_stmt|;
name|cfis
operator|=
name|aior
operator|->
name|cfis
expr_stmt|;
if|if
condition|(
name|cfis
index|[
literal|2
index|]
operator|==
name|ATA_WRITE_FPDMA_QUEUED
operator|||
name|cfis
index|[
literal|2
index|]
operator|==
name|ATA_READ_FPDMA_QUEUED
condition|)
name|ncq
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|ncq
condition|)
name|p
operator|->
name|sact
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|slot
operator|)
expr_stmt|;
else|else
name|p
operator|->
name|ci
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|slot
operator|)
expr_stmt|;
comment|/* 		 * This command is now done. 		 */
name|p
operator|->
name|pending
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|slot
operator|)
expr_stmt|;
comment|/* 		 * Delete the blockif request from the busy list 		 */
name|TAILQ_REMOVE
argument_list|(
operator|&
name|p
operator|->
name|iobhd
argument_list|,
name|aior
argument_list|,
name|io_blist
argument_list|)
expr_stmt|;
comment|/* 		 * Move the blockif request back to the free list 		 */
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|p
operator|->
name|iofhd
argument_list|,
name|aior
argument_list|,
name|io_flist
argument_list|)
expr_stmt|;
block|}
name|ahci_check_stopped
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ahci_port_reset
parameter_list|(
name|struct
name|ahci_port
modifier|*
name|pr
parameter_list|)
block|{
name|pr
operator|->
name|serr
operator|=
literal|0
expr_stmt|;
name|pr
operator|->
name|sact
operator|=
literal|0
expr_stmt|;
name|pr
operator|->
name|xfermode
operator|=
name|ATA_UDMA6
expr_stmt|;
name|pr
operator|->
name|mult_sectors
operator|=
literal|128
expr_stmt|;
if|if
condition|(
operator|!
name|pr
operator|->
name|bctx
condition|)
block|{
name|pr
operator|->
name|ssts
operator|=
name|ATA_SS_DET_NO_DEVICE
expr_stmt|;
name|pr
operator|->
name|sig
operator|=
literal|0xFFFFFFFF
expr_stmt|;
name|pr
operator|->
name|tfd
operator|=
literal|0x7F
expr_stmt|;
return|return;
block|}
name|pr
operator|->
name|ssts
operator|=
name|ATA_SS_DET_PHY_ONLINE
operator||
name|ATA_SS_IPM_ACTIVE
expr_stmt|;
if|if
condition|(
name|pr
operator|->
name|sctl
operator|&
name|ATA_SC_SPD_MASK
condition|)
name|pr
operator|->
name|ssts
operator||=
operator|(
name|pr
operator|->
name|sctl
operator|&
name|ATA_SC_SPD_MASK
operator|)
expr_stmt|;
else|else
name|pr
operator|->
name|ssts
operator||=
name|ATA_SS_SPD_GEN3
expr_stmt|;
name|pr
operator|->
name|tfd
operator|=
operator|(
literal|1
operator|<<
literal|8
operator|)
operator||
name|ATA_S_DSC
operator||
name|ATA_S_DMA
expr_stmt|;
if|if
condition|(
operator|!
name|pr
operator|->
name|atapi
condition|)
block|{
name|pr
operator|->
name|sig
operator|=
name|PxSIG_ATA
expr_stmt|;
name|pr
operator|->
name|tfd
operator||=
name|ATA_S_READY
expr_stmt|;
block|}
else|else
name|pr
operator|->
name|sig
operator|=
name|PxSIG_ATAPI
expr_stmt|;
name|ahci_write_reset_fis_d2h
argument_list|(
name|pr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ahci_reset
parameter_list|(
name|struct
name|pci_ahci_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|sc
operator|->
name|ghc
operator|=
name|AHCI_GHC_AE
expr_stmt|;
name|sc
operator|->
name|is
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|lintr
condition|)
block|{
name|pci_lintr_deassert
argument_list|(
name|sc
operator|->
name|asc_pi
argument_list|)
expr_stmt|;
name|sc
operator|->
name|lintr
operator|=
literal|0
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|ports
condition|;
name|i
operator|++
control|)
block|{
name|sc
operator|->
name|port
index|[
name|i
index|]
operator|.
name|ie
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|port
index|[
name|i
index|]
operator|.
name|is
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|port
index|[
name|i
index|]
operator|.
name|sctl
operator|=
literal|0
expr_stmt|;
name|ahci_port_reset
argument_list|(
operator|&
name|sc
operator|->
name|port
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ata_string
parameter_list|(
name|uint8_t
modifier|*
name|dest
parameter_list|,
specifier|const
name|char
modifier|*
name|src
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|*
name|src
condition|)
name|dest
index|[
name|i
operator|^
literal|1
index|]
operator|=
operator|*
name|src
operator|++
expr_stmt|;
else|else
name|dest
index|[
name|i
operator|^
literal|1
index|]
operator|=
literal|' '
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|atapi_string
parameter_list|(
name|uint8_t
modifier|*
name|dest
parameter_list|,
specifier|const
name|char
modifier|*
name|src
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|*
name|src
condition|)
name|dest
index|[
name|i
index|]
operator|=
operator|*
name|src
operator|++
expr_stmt|;
else|else
name|dest
index|[
name|i
index|]
operator|=
literal|' '
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Build up the iovec based on the PRDT, 'done' and 'len'.  */
end_comment

begin_function
specifier|static
name|void
name|ahci_build_iov
parameter_list|(
name|struct
name|ahci_port
modifier|*
name|p
parameter_list|,
name|struct
name|ahci_ioreq
modifier|*
name|aior
parameter_list|,
name|struct
name|ahci_prdt_entry
modifier|*
name|prdt
parameter_list|,
name|uint16_t
name|prdtl
parameter_list|)
block|{
name|struct
name|blockif_req
modifier|*
name|breq
init|=
operator|&
name|aior
operator|->
name|io_req
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|skip
decl_stmt|,
name|todo
decl_stmt|,
name|left
decl_stmt|,
name|extra
decl_stmt|;
name|uint32_t
name|dbcsz
decl_stmt|;
comment|/* Copy part of PRDT between 'done' and 'len' bytes into the iov. */
name|skip
operator|=
name|aior
operator|->
name|done
expr_stmt|;
name|left
operator|=
name|aior
operator|->
name|len
operator|-
name|aior
operator|->
name|done
expr_stmt|;
name|todo
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|j
operator|=
literal|0
init|;
name|i
operator|<
name|prdtl
operator|&&
name|j
operator|<
name|BLOCKIF_IOV_MAX
operator|&&
name|left
operator|>
literal|0
condition|;
name|i
operator|++
operator|,
name|prdt
operator|++
control|)
block|{
name|dbcsz
operator|=
operator|(
name|prdt
operator|->
name|dbc
operator|&
name|DBCMASK
operator|)
operator|+
literal|1
expr_stmt|;
comment|/* Skip already done part of the PRDT */
if|if
condition|(
name|dbcsz
operator|<=
name|skip
condition|)
block|{
name|skip
operator|-=
name|dbcsz
expr_stmt|;
continue|continue;
block|}
name|dbcsz
operator|-=
name|skip
expr_stmt|;
if|if
condition|(
name|dbcsz
operator|>
name|left
condition|)
name|dbcsz
operator|=
name|left
expr_stmt|;
name|breq
operator|->
name|br_iov
index|[
name|j
index|]
operator|.
name|iov_base
operator|=
name|paddr_guest2host
argument_list|(
name|ahci_ctx
argument_list|(
name|p
operator|->
name|pr_sc
argument_list|)
argument_list|,
name|prdt
operator|->
name|dba
operator|+
name|skip
argument_list|,
name|dbcsz
argument_list|)
expr_stmt|;
name|breq
operator|->
name|br_iov
index|[
name|j
index|]
operator|.
name|iov_len
operator|=
name|dbcsz
expr_stmt|;
name|todo
operator|+=
name|dbcsz
expr_stmt|;
name|left
operator|-=
name|dbcsz
expr_stmt|;
name|skip
operator|=
literal|0
expr_stmt|;
name|j
operator|++
expr_stmt|;
block|}
comment|/* If we got limited by IOV length, round I/O down to sector size. */
if|if
condition|(
name|j
operator|==
name|BLOCKIF_IOV_MAX
condition|)
block|{
name|extra
operator|=
name|todo
operator|%
name|blockif_sectsz
argument_list|(
name|p
operator|->
name|bctx
argument_list|)
expr_stmt|;
name|todo
operator|-=
name|extra
expr_stmt|;
name|assert
argument_list|(
name|todo
operator|>
literal|0
argument_list|)
expr_stmt|;
while|while
condition|(
name|extra
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|breq
operator|->
name|br_iov
index|[
name|j
operator|-
literal|1
index|]
operator|.
name|iov_len
operator|>
name|extra
condition|)
block|{
name|breq
operator|->
name|br_iov
index|[
name|j
operator|-
literal|1
index|]
operator|.
name|iov_len
operator|-=
name|extra
expr_stmt|;
break|break;
block|}
name|extra
operator|-=
name|breq
operator|->
name|br_iov
index|[
name|j
operator|-
literal|1
index|]
operator|.
name|iov_len
expr_stmt|;
name|j
operator|--
expr_stmt|;
block|}
block|}
name|breq
operator|->
name|br_iovcnt
operator|=
name|j
expr_stmt|;
name|aior
operator|->
name|done
operator|+=
name|todo
expr_stmt|;
name|aior
operator|->
name|more
operator|=
operator|(
name|aior
operator|->
name|done
operator|<
name|aior
operator|->
name|len
operator|&&
name|i
operator|<
name|prdtl
operator|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ahci_handle_rw
parameter_list|(
name|struct
name|ahci_port
modifier|*
name|p
parameter_list|,
name|int
name|slot
parameter_list|,
name|uint8_t
modifier|*
name|cfis
parameter_list|,
name|uint32_t
name|done
parameter_list|)
block|{
name|struct
name|ahci_ioreq
modifier|*
name|aior
decl_stmt|;
name|struct
name|blockif_req
modifier|*
name|breq
decl_stmt|;
name|struct
name|ahci_prdt_entry
modifier|*
name|prdt
decl_stmt|;
name|struct
name|ahci_cmd_hdr
modifier|*
name|hdr
decl_stmt|;
name|uint64_t
name|lba
decl_stmt|;
name|uint32_t
name|len
decl_stmt|;
name|int
name|err
decl_stmt|,
name|ncq
decl_stmt|,
name|readop
decl_stmt|;
name|prdt
operator|=
operator|(
expr|struct
name|ahci_prdt_entry
operator|*
operator|)
operator|(
name|cfis
operator|+
literal|0x80
operator|)
expr_stmt|;
name|hdr
operator|=
operator|(
expr|struct
name|ahci_cmd_hdr
operator|*
operator|)
operator|(
name|p
operator|->
name|cmd_lst
operator|+
name|slot
operator|*
name|AHCI_CL_SIZE
operator|)
expr_stmt|;
name|ncq
operator|=
literal|0
expr_stmt|;
name|readop
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|cfis
index|[
literal|2
index|]
operator|==
name|ATA_WRITE
operator|||
name|cfis
index|[
literal|2
index|]
operator|==
name|ATA_WRITE48
operator|||
name|cfis
index|[
literal|2
index|]
operator|==
name|ATA_WRITE_MUL
operator|||
name|cfis
index|[
literal|2
index|]
operator|==
name|ATA_WRITE_MUL48
operator|||
name|cfis
index|[
literal|2
index|]
operator|==
name|ATA_WRITE_DMA
operator|||
name|cfis
index|[
literal|2
index|]
operator|==
name|ATA_WRITE_DMA48
operator|||
name|cfis
index|[
literal|2
index|]
operator|==
name|ATA_WRITE_FPDMA_QUEUED
condition|)
name|readop
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|cfis
index|[
literal|2
index|]
operator|==
name|ATA_WRITE_FPDMA_QUEUED
operator|||
name|cfis
index|[
literal|2
index|]
operator|==
name|ATA_READ_FPDMA_QUEUED
condition|)
block|{
name|lba
operator|=
operator|(
operator|(
name|uint64_t
operator|)
name|cfis
index|[
literal|10
index|]
operator|<<
literal|40
operator|)
operator||
operator|(
operator|(
name|uint64_t
operator|)
name|cfis
index|[
literal|9
index|]
operator|<<
literal|32
operator|)
operator||
operator|(
operator|(
name|uint64_t
operator|)
name|cfis
index|[
literal|8
index|]
operator|<<
literal|24
operator|)
operator||
operator|(
operator|(
name|uint64_t
operator|)
name|cfis
index|[
literal|6
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
operator|(
name|uint64_t
operator|)
name|cfis
index|[
literal|5
index|]
operator|<<
literal|8
operator|)
operator||
name|cfis
index|[
literal|4
index|]
expr_stmt|;
name|len
operator|=
name|cfis
index|[
literal|11
index|]
operator|<<
literal|8
operator||
name|cfis
index|[
literal|3
index|]
expr_stmt|;
if|if
condition|(
operator|!
name|len
condition|)
name|len
operator|=
literal|65536
expr_stmt|;
name|ncq
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cfis
index|[
literal|2
index|]
operator|==
name|ATA_READ48
operator|||
name|cfis
index|[
literal|2
index|]
operator|==
name|ATA_WRITE48
operator|||
name|cfis
index|[
literal|2
index|]
operator|==
name|ATA_READ_MUL48
operator|||
name|cfis
index|[
literal|2
index|]
operator|==
name|ATA_WRITE_MUL48
operator|||
name|cfis
index|[
literal|2
index|]
operator|==
name|ATA_READ_DMA48
operator|||
name|cfis
index|[
literal|2
index|]
operator|==
name|ATA_WRITE_DMA48
condition|)
block|{
name|lba
operator|=
operator|(
operator|(
name|uint64_t
operator|)
name|cfis
index|[
literal|10
index|]
operator|<<
literal|40
operator|)
operator||
operator|(
operator|(
name|uint64_t
operator|)
name|cfis
index|[
literal|9
index|]
operator|<<
literal|32
operator|)
operator||
operator|(
operator|(
name|uint64_t
operator|)
name|cfis
index|[
literal|8
index|]
operator|<<
literal|24
operator|)
operator||
operator|(
operator|(
name|uint64_t
operator|)
name|cfis
index|[
literal|6
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
operator|(
name|uint64_t
operator|)
name|cfis
index|[
literal|5
index|]
operator|<<
literal|8
operator|)
operator||
name|cfis
index|[
literal|4
index|]
expr_stmt|;
name|len
operator|=
name|cfis
index|[
literal|13
index|]
operator|<<
literal|8
operator||
name|cfis
index|[
literal|12
index|]
expr_stmt|;
if|if
condition|(
operator|!
name|len
condition|)
name|len
operator|=
literal|65536
expr_stmt|;
block|}
else|else
block|{
name|lba
operator|=
operator|(
operator|(
name|cfis
index|[
literal|7
index|]
operator|&
literal|0xf
operator|)
operator|<<
literal|24
operator|)
operator||
operator|(
name|cfis
index|[
literal|6
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
name|cfis
index|[
literal|5
index|]
operator|<<
literal|8
operator|)
operator||
name|cfis
index|[
literal|4
index|]
expr_stmt|;
name|len
operator|=
name|cfis
index|[
literal|12
index|]
expr_stmt|;
if|if
condition|(
operator|!
name|len
condition|)
name|len
operator|=
literal|256
expr_stmt|;
block|}
name|lba
operator|*=
name|blockif_sectsz
argument_list|(
name|p
operator|->
name|bctx
argument_list|)
expr_stmt|;
name|len
operator|*=
name|blockif_sectsz
argument_list|(
name|p
operator|->
name|bctx
argument_list|)
expr_stmt|;
comment|/* Pull request off free list */
name|aior
operator|=
name|STAILQ_FIRST
argument_list|(
operator|&
name|p
operator|->
name|iofhd
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|aior
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|STAILQ_REMOVE_HEAD
argument_list|(
operator|&
name|p
operator|->
name|iofhd
argument_list|,
name|io_flist
argument_list|)
expr_stmt|;
name|aior
operator|->
name|cfis
operator|=
name|cfis
expr_stmt|;
name|aior
operator|->
name|slot
operator|=
name|slot
expr_stmt|;
name|aior
operator|->
name|len
operator|=
name|len
expr_stmt|;
name|aior
operator|->
name|done
operator|=
name|done
expr_stmt|;
name|breq
operator|=
operator|&
name|aior
operator|->
name|io_req
expr_stmt|;
name|breq
operator|->
name|br_offset
operator|=
name|lba
operator|+
name|done
expr_stmt|;
name|ahci_build_iov
argument_list|(
name|p
argument_list|,
name|aior
argument_list|,
name|prdt
argument_list|,
name|hdr
operator|->
name|prdtl
argument_list|)
expr_stmt|;
comment|/* Mark this command in-flight. */
name|p
operator|->
name|pending
operator||=
literal|1
operator|<<
name|slot
expr_stmt|;
comment|/* Stuff request onto busy list. */
name|TAILQ_INSERT_HEAD
argument_list|(
operator|&
name|p
operator|->
name|iobhd
argument_list|,
name|aior
argument_list|,
name|io_blist
argument_list|)
expr_stmt|;
if|if
condition|(
name|readop
condition|)
name|err
operator|=
name|blockif_read
argument_list|(
name|p
operator|->
name|bctx
argument_list|,
name|breq
argument_list|)
expr_stmt|;
else|else
name|err
operator|=
name|blockif_write
argument_list|(
name|p
operator|->
name|bctx
argument_list|,
name|breq
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|err
operator|==
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ncq
condition|)
name|p
operator|->
name|ci
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|slot
operator|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ahci_handle_flush
parameter_list|(
name|struct
name|ahci_port
modifier|*
name|p
parameter_list|,
name|int
name|slot
parameter_list|,
name|uint8_t
modifier|*
name|cfis
parameter_list|)
block|{
name|struct
name|ahci_ioreq
modifier|*
name|aior
decl_stmt|;
name|struct
name|blockif_req
modifier|*
name|breq
decl_stmt|;
name|int
name|err
decl_stmt|;
comment|/* 	 * Pull request off free list 	 */
name|aior
operator|=
name|STAILQ_FIRST
argument_list|(
operator|&
name|p
operator|->
name|iofhd
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|aior
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|STAILQ_REMOVE_HEAD
argument_list|(
operator|&
name|p
operator|->
name|iofhd
argument_list|,
name|io_flist
argument_list|)
expr_stmt|;
name|aior
operator|->
name|cfis
operator|=
name|cfis
expr_stmt|;
name|aior
operator|->
name|slot
operator|=
name|slot
expr_stmt|;
name|aior
operator|->
name|len
operator|=
literal|0
expr_stmt|;
name|aior
operator|->
name|done
operator|=
literal|0
expr_stmt|;
name|aior
operator|->
name|more
operator|=
literal|0
expr_stmt|;
name|breq
operator|=
operator|&
name|aior
operator|->
name|io_req
expr_stmt|;
comment|/* 	 * Mark this command in-flight. 	 */
name|p
operator|->
name|pending
operator||=
literal|1
operator|<<
name|slot
expr_stmt|;
comment|/* 	 * Stuff request onto busy list 	 */
name|TAILQ_INSERT_HEAD
argument_list|(
operator|&
name|p
operator|->
name|iobhd
argument_list|,
name|aior
argument_list|,
name|io_blist
argument_list|)
expr_stmt|;
name|err
operator|=
name|blockif_flush
argument_list|(
name|p
operator|->
name|bctx
argument_list|,
name|breq
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|err
operator|==
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|read_prdt
parameter_list|(
name|struct
name|ahci_port
modifier|*
name|p
parameter_list|,
name|int
name|slot
parameter_list|,
name|uint8_t
modifier|*
name|cfis
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|,
name|int
name|size
parameter_list|)
block|{
name|struct
name|ahci_cmd_hdr
modifier|*
name|hdr
decl_stmt|;
name|struct
name|ahci_prdt_entry
modifier|*
name|prdt
decl_stmt|;
name|void
modifier|*
name|to
decl_stmt|;
name|int
name|i
decl_stmt|,
name|len
decl_stmt|;
name|hdr
operator|=
operator|(
expr|struct
name|ahci_cmd_hdr
operator|*
operator|)
operator|(
name|p
operator|->
name|cmd_lst
operator|+
name|slot
operator|*
name|AHCI_CL_SIZE
operator|)
expr_stmt|;
name|len
operator|=
name|size
expr_stmt|;
name|to
operator|=
name|buf
expr_stmt|;
name|prdt
operator|=
operator|(
expr|struct
name|ahci_prdt_entry
operator|*
operator|)
operator|(
name|cfis
operator|+
literal|0x80
operator|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|hdr
operator|->
name|prdtl
operator|&&
name|len
condition|;
name|i
operator|++
control|)
block|{
name|uint8_t
modifier|*
name|ptr
decl_stmt|;
name|uint32_t
name|dbcsz
decl_stmt|;
name|int
name|sublen
decl_stmt|;
name|dbcsz
operator|=
operator|(
name|prdt
operator|->
name|dbc
operator|&
name|DBCMASK
operator|)
operator|+
literal|1
expr_stmt|;
name|ptr
operator|=
name|paddr_guest2host
argument_list|(
name|ahci_ctx
argument_list|(
name|p
operator|->
name|pr_sc
argument_list|)
argument_list|,
name|prdt
operator|->
name|dba
argument_list|,
name|dbcsz
argument_list|)
expr_stmt|;
name|sublen
operator|=
name|len
operator|<
name|dbcsz
condition|?
name|len
else|:
name|dbcsz
expr_stmt|;
name|memcpy
argument_list|(
name|to
argument_list|,
name|ptr
argument_list|,
name|sublen
argument_list|)
expr_stmt|;
name|len
operator|-=
name|sublen
expr_stmt|;
name|to
operator|+=
name|sublen
expr_stmt|;
name|prdt
operator|++
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ahci_handle_dsm_trim
parameter_list|(
name|struct
name|ahci_port
modifier|*
name|p
parameter_list|,
name|int
name|slot
parameter_list|,
name|uint8_t
modifier|*
name|cfis
parameter_list|,
name|uint32_t
name|done
parameter_list|)
block|{
name|struct
name|ahci_ioreq
modifier|*
name|aior
decl_stmt|;
name|struct
name|blockif_req
modifier|*
name|breq
decl_stmt|;
name|uint8_t
modifier|*
name|entry
decl_stmt|;
name|uint64_t
name|elba
decl_stmt|;
name|uint32_t
name|len
decl_stmt|,
name|elen
decl_stmt|;
name|int
name|err
decl_stmt|;
name|uint8_t
name|buf
index|[
literal|512
index|]
decl_stmt|;
if|if
condition|(
name|cfis
index|[
literal|2
index|]
operator|==
name|ATA_DATA_SET_MANAGEMENT
condition|)
block|{
name|len
operator|=
operator|(
name|uint16_t
operator|)
name|cfis
index|[
literal|13
index|]
operator|<<
literal|8
operator||
name|cfis
index|[
literal|12
index|]
expr_stmt|;
name|len
operator|*=
literal|512
expr_stmt|;
block|}
else|else
block|{
comment|/* ATA_SEND_FPDMA_QUEUED */
name|len
operator|=
operator|(
name|uint16_t
operator|)
name|cfis
index|[
literal|11
index|]
operator|<<
literal|8
operator||
name|cfis
index|[
literal|3
index|]
expr_stmt|;
name|len
operator|*=
literal|512
expr_stmt|;
block|}
name|read_prdt
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|next
label|:
name|entry
operator|=
operator|&
name|buf
index|[
name|done
index|]
expr_stmt|;
name|elba
operator|=
operator|(
operator|(
name|uint64_t
operator|)
name|entry
index|[
literal|5
index|]
operator|<<
literal|40
operator|)
operator||
operator|(
operator|(
name|uint64_t
operator|)
name|entry
index|[
literal|4
index|]
operator|<<
literal|32
operator|)
operator||
operator|(
operator|(
name|uint64_t
operator|)
name|entry
index|[
literal|3
index|]
operator|<<
literal|24
operator|)
operator||
operator|(
operator|(
name|uint64_t
operator|)
name|entry
index|[
literal|2
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
operator|(
name|uint64_t
operator|)
name|entry
index|[
literal|1
index|]
operator|<<
literal|8
operator|)
operator||
name|entry
index|[
literal|0
index|]
expr_stmt|;
name|elen
operator|=
operator|(
name|uint16_t
operator|)
name|entry
index|[
literal|7
index|]
operator|<<
literal|8
operator||
name|entry
index|[
literal|6
index|]
expr_stmt|;
name|done
operator|+=
literal|8
expr_stmt|;
if|if
condition|(
name|elen
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|done
operator|>=
name|len
condition|)
block|{
name|ahci_write_fis_d2h
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|,
name|ATA_S_READY
operator||
name|ATA_S_DSC
argument_list|)
expr_stmt|;
name|p
operator|->
name|pending
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|slot
operator|)
expr_stmt|;
name|ahci_check_stopped
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return;
block|}
goto|goto
name|next
goto|;
block|}
comment|/* 	 * Pull request off free list 	 */
name|aior
operator|=
name|STAILQ_FIRST
argument_list|(
operator|&
name|p
operator|->
name|iofhd
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|aior
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|STAILQ_REMOVE_HEAD
argument_list|(
operator|&
name|p
operator|->
name|iofhd
argument_list|,
name|io_flist
argument_list|)
expr_stmt|;
name|aior
operator|->
name|cfis
operator|=
name|cfis
expr_stmt|;
name|aior
operator|->
name|slot
operator|=
name|slot
expr_stmt|;
name|aior
operator|->
name|len
operator|=
name|len
expr_stmt|;
name|aior
operator|->
name|done
operator|=
name|done
expr_stmt|;
name|aior
operator|->
name|more
operator|=
operator|(
name|len
operator|!=
name|done
operator|)
expr_stmt|;
name|breq
operator|=
operator|&
name|aior
operator|->
name|io_req
expr_stmt|;
name|breq
operator|->
name|br_offset
operator|=
name|elba
operator|*
name|blockif_sectsz
argument_list|(
name|p
operator|->
name|bctx
argument_list|)
expr_stmt|;
name|breq
operator|->
name|br_iovcnt
operator|=
literal|1
expr_stmt|;
name|breq
operator|->
name|br_iov
index|[
literal|0
index|]
operator|.
name|iov_len
operator|=
name|elen
operator|*
name|blockif_sectsz
argument_list|(
name|p
operator|->
name|bctx
argument_list|)
expr_stmt|;
comment|/* 	 * Mark this command in-flight. 	 */
name|p
operator|->
name|pending
operator||=
literal|1
operator|<<
name|slot
expr_stmt|;
comment|/* 	 * Stuff request onto busy list 	 */
name|TAILQ_INSERT_HEAD
argument_list|(
operator|&
name|p
operator|->
name|iobhd
argument_list|,
name|aior
argument_list|,
name|io_blist
argument_list|)
expr_stmt|;
name|err
operator|=
name|blockif_delete
argument_list|(
name|p
operator|->
name|bctx
argument_list|,
name|breq
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|err
operator|==
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|write_prdt
parameter_list|(
name|struct
name|ahci_port
modifier|*
name|p
parameter_list|,
name|int
name|slot
parameter_list|,
name|uint8_t
modifier|*
name|cfis
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|,
name|int
name|size
parameter_list|)
block|{
name|struct
name|ahci_cmd_hdr
modifier|*
name|hdr
decl_stmt|;
name|struct
name|ahci_prdt_entry
modifier|*
name|prdt
decl_stmt|;
name|void
modifier|*
name|from
decl_stmt|;
name|int
name|i
decl_stmt|,
name|len
decl_stmt|;
name|hdr
operator|=
operator|(
expr|struct
name|ahci_cmd_hdr
operator|*
operator|)
operator|(
name|p
operator|->
name|cmd_lst
operator|+
name|slot
operator|*
name|AHCI_CL_SIZE
operator|)
expr_stmt|;
name|len
operator|=
name|size
expr_stmt|;
name|from
operator|=
name|buf
expr_stmt|;
name|prdt
operator|=
operator|(
expr|struct
name|ahci_prdt_entry
operator|*
operator|)
operator|(
name|cfis
operator|+
literal|0x80
operator|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|hdr
operator|->
name|prdtl
operator|&&
name|len
condition|;
name|i
operator|++
control|)
block|{
name|uint8_t
modifier|*
name|ptr
decl_stmt|;
name|uint32_t
name|dbcsz
decl_stmt|;
name|int
name|sublen
decl_stmt|;
name|dbcsz
operator|=
operator|(
name|prdt
operator|->
name|dbc
operator|&
name|DBCMASK
operator|)
operator|+
literal|1
expr_stmt|;
name|ptr
operator|=
name|paddr_guest2host
argument_list|(
name|ahci_ctx
argument_list|(
name|p
operator|->
name|pr_sc
argument_list|)
argument_list|,
name|prdt
operator|->
name|dba
argument_list|,
name|dbcsz
argument_list|)
expr_stmt|;
name|sublen
operator|=
name|len
operator|<
name|dbcsz
condition|?
name|len
else|:
name|dbcsz
expr_stmt|;
name|memcpy
argument_list|(
name|ptr
argument_list|,
name|from
argument_list|,
name|sublen
argument_list|)
expr_stmt|;
name|len
operator|-=
name|sublen
expr_stmt|;
name|from
operator|+=
name|sublen
expr_stmt|;
name|prdt
operator|++
expr_stmt|;
block|}
name|hdr
operator|->
name|prdbc
operator|=
name|size
operator|-
name|len
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ahci_checksum
parameter_list|(
name|uint8_t
modifier|*
name|buf
parameter_list|,
name|int
name|size
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|uint8_t
name|sum
init|=
literal|0
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|size
operator|-
literal|1
condition|;
name|i
operator|++
control|)
name|sum
operator|+=
name|buf
index|[
name|i
index|]
expr_stmt|;
name|buf
index|[
name|size
operator|-
literal|1
index|]
operator|=
literal|0x100
operator|-
name|sum
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ahci_handle_read_log
parameter_list|(
name|struct
name|ahci_port
modifier|*
name|p
parameter_list|,
name|int
name|slot
parameter_list|,
name|uint8_t
modifier|*
name|cfis
parameter_list|)
block|{
name|struct
name|ahci_cmd_hdr
modifier|*
name|hdr
decl_stmt|;
name|uint8_t
name|buf
index|[
literal|512
index|]
decl_stmt|;
name|hdr
operator|=
operator|(
expr|struct
name|ahci_cmd_hdr
operator|*
operator|)
operator|(
name|p
operator|->
name|cmd_lst
operator|+
name|slot
operator|*
name|AHCI_CL_SIZE
operator|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|atapi
operator|||
name|hdr
operator|->
name|prdtl
operator|==
literal|0
operator|||
name|cfis
index|[
literal|4
index|]
operator|!=
literal|0x10
operator|||
name|cfis
index|[
literal|5
index|]
operator|!=
literal|0
operator|||
name|cfis
index|[
literal|9
index|]
operator|!=
literal|0
operator|||
name|cfis
index|[
literal|12
index|]
operator|!=
literal|1
operator|||
name|cfis
index|[
literal|13
index|]
operator|!=
literal|0
condition|)
block|{
name|ahci_write_fis_d2h
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|,
operator|(
name|ATA_E_ABORT
operator|<<
literal|8
operator|)
operator||
name|ATA_S_READY
operator||
name|ATA_S_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
name|memset
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|buf
argument_list|,
name|p
operator|->
name|err_cfis
argument_list|,
sizeof|sizeof
argument_list|(
name|p
operator|->
name|err_cfis
argument_list|)
argument_list|)
expr_stmt|;
name|ahci_checksum
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfis
index|[
literal|2
index|]
operator|==
name|ATA_READ_LOG_EXT
condition|)
name|ahci_write_fis_piosetup
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|write_prdt
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|,
operator|(
name|void
operator|*
operator|)
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|ahci_write_fis_d2h
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|,
name|ATA_S_DSC
operator||
name|ATA_S_READY
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|handle_identify
parameter_list|(
name|struct
name|ahci_port
modifier|*
name|p
parameter_list|,
name|int
name|slot
parameter_list|,
name|uint8_t
modifier|*
name|cfis
parameter_list|)
block|{
name|struct
name|ahci_cmd_hdr
modifier|*
name|hdr
decl_stmt|;
name|hdr
operator|=
operator|(
expr|struct
name|ahci_cmd_hdr
operator|*
operator|)
operator|(
name|p
operator|->
name|cmd_lst
operator|+
name|slot
operator|*
name|AHCI_CL_SIZE
operator|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|atapi
operator|||
name|hdr
operator|->
name|prdtl
operator|==
literal|0
condition|)
block|{
name|ahci_write_fis_d2h
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|,
operator|(
name|ATA_E_ABORT
operator|<<
literal|8
operator|)
operator||
name|ATA_S_READY
operator||
name|ATA_S_ERROR
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|uint16_t
name|buf
index|[
literal|256
index|]
decl_stmt|;
name|uint64_t
name|sectors
decl_stmt|;
name|int
name|sectsz
decl_stmt|,
name|psectsz
decl_stmt|,
name|psectoff
decl_stmt|,
name|candelete
decl_stmt|,
name|ro
decl_stmt|;
name|uint16_t
name|cyl
decl_stmt|;
name|uint8_t
name|sech
decl_stmt|,
name|heads
decl_stmt|;
name|ro
operator|=
name|blockif_is_ro
argument_list|(
name|p
operator|->
name|bctx
argument_list|)
expr_stmt|;
name|candelete
operator|=
name|blockif_candelete
argument_list|(
name|p
operator|->
name|bctx
argument_list|)
expr_stmt|;
name|sectsz
operator|=
name|blockif_sectsz
argument_list|(
name|p
operator|->
name|bctx
argument_list|)
expr_stmt|;
name|sectors
operator|=
name|blockif_size
argument_list|(
name|p
operator|->
name|bctx
argument_list|)
operator|/
name|sectsz
expr_stmt|;
name|blockif_chs
argument_list|(
name|p
operator|->
name|bctx
argument_list|,
operator|&
name|cyl
argument_list|,
operator|&
name|heads
argument_list|,
operator|&
name|sech
argument_list|)
expr_stmt|;
name|blockif_psectsz
argument_list|(
name|p
operator|->
name|bctx
argument_list|,
operator|&
name|psectsz
argument_list|,
operator|&
name|psectoff
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|buf
index|[
literal|0
index|]
operator|=
literal|0x0040
expr_stmt|;
name|buf
index|[
literal|1
index|]
operator|=
name|cyl
expr_stmt|;
name|buf
index|[
literal|3
index|]
operator|=
name|heads
expr_stmt|;
name|buf
index|[
literal|6
index|]
operator|=
name|sech
expr_stmt|;
name|ata_string
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
operator|(
name|buf
operator|+
literal|10
operator|)
argument_list|,
name|p
operator|->
name|ident
argument_list|,
literal|20
argument_list|)
expr_stmt|;
name|ata_string
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
operator|(
name|buf
operator|+
literal|23
operator|)
argument_list|,
literal|"001"
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|ata_string
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
operator|(
name|buf
operator|+
literal|27
operator|)
argument_list|,
literal|"BHYVE SATA DISK"
argument_list|,
literal|40
argument_list|)
expr_stmt|;
name|buf
index|[
literal|47
index|]
operator|=
operator|(
literal|0x8000
operator||
literal|128
operator|)
expr_stmt|;
name|buf
index|[
literal|48
index|]
operator|=
literal|0x1
expr_stmt|;
name|buf
index|[
literal|49
index|]
operator|=
operator|(
literal|1
operator|<<
literal|8
operator||
literal|1
operator|<<
literal|9
operator||
literal|1
operator|<<
literal|11
operator|)
expr_stmt|;
name|buf
index|[
literal|50
index|]
operator|=
operator|(
literal|1
operator|<<
literal|14
operator|)
expr_stmt|;
name|buf
index|[
literal|53
index|]
operator|=
operator|(
literal|1
operator|<<
literal|1
operator||
literal|1
operator|<<
literal|2
operator|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|mult_sectors
condition|)
name|buf
index|[
literal|59
index|]
operator|=
operator|(
literal|0x100
operator||
name|p
operator|->
name|mult_sectors
operator|)
expr_stmt|;
if|if
condition|(
name|sectors
operator|<=
literal|0x0fffffff
condition|)
block|{
name|buf
index|[
literal|60
index|]
operator|=
name|sectors
expr_stmt|;
name|buf
index|[
literal|61
index|]
operator|=
operator|(
name|sectors
operator|>>
literal|16
operator|)
expr_stmt|;
block|}
else|else
block|{
name|buf
index|[
literal|60
index|]
operator|=
literal|0xffff
expr_stmt|;
name|buf
index|[
literal|61
index|]
operator|=
literal|0x0fff
expr_stmt|;
block|}
name|buf
index|[
literal|63
index|]
operator|=
literal|0x7
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|xfermode
operator|&
name|ATA_WDMA0
condition|)
name|buf
index|[
literal|63
index|]
operator||=
operator|(
literal|1
operator|<<
operator|(
operator|(
name|p
operator|->
name|xfermode
operator|&
literal|7
operator|)
operator|+
literal|8
operator|)
operator|)
expr_stmt|;
name|buf
index|[
literal|64
index|]
operator|=
literal|0x3
expr_stmt|;
name|buf
index|[
literal|65
index|]
operator|=
literal|120
expr_stmt|;
name|buf
index|[
literal|66
index|]
operator|=
literal|120
expr_stmt|;
name|buf
index|[
literal|67
index|]
operator|=
literal|120
expr_stmt|;
name|buf
index|[
literal|68
index|]
operator|=
literal|120
expr_stmt|;
name|buf
index|[
literal|69
index|]
operator|=
literal|0
expr_stmt|;
name|buf
index|[
literal|75
index|]
operator|=
literal|31
expr_stmt|;
name|buf
index|[
literal|76
index|]
operator|=
operator|(
name|ATA_SATA_GEN1
operator||
name|ATA_SATA_GEN2
operator||
name|ATA_SATA_GEN3
operator||
name|ATA_SUPPORT_NCQ
operator|)
expr_stmt|;
name|buf
index|[
literal|77
index|]
operator|=
operator|(
name|ATA_SUPPORT_RCVSND_FPDMA_QUEUED
operator||
operator|(
name|p
operator|->
name|ssts
operator|&
name|ATA_SS_SPD_MASK
operator|)
operator|>>
literal|3
operator|)
expr_stmt|;
name|buf
index|[
literal|80
index|]
operator|=
literal|0x3f0
expr_stmt|;
name|buf
index|[
literal|81
index|]
operator|=
literal|0x28
expr_stmt|;
name|buf
index|[
literal|82
index|]
operator|=
operator|(
name|ATA_SUPPORT_POWERMGT
operator||
name|ATA_SUPPORT_WRITECACHE
operator||
name|ATA_SUPPORT_LOOKAHEAD
operator||
name|ATA_SUPPORT_NOP
operator|)
expr_stmt|;
name|buf
index|[
literal|83
index|]
operator|=
operator|(
name|ATA_SUPPORT_ADDRESS48
operator||
name|ATA_SUPPORT_FLUSHCACHE
operator||
name|ATA_SUPPORT_FLUSHCACHE48
operator||
literal|1
operator|<<
literal|14
operator|)
expr_stmt|;
name|buf
index|[
literal|84
index|]
operator|=
operator|(
literal|1
operator|<<
literal|14
operator|)
expr_stmt|;
name|buf
index|[
literal|85
index|]
operator|=
operator|(
name|ATA_SUPPORT_POWERMGT
operator||
name|ATA_SUPPORT_WRITECACHE
operator||
name|ATA_SUPPORT_LOOKAHEAD
operator||
name|ATA_SUPPORT_NOP
operator|)
expr_stmt|;
name|buf
index|[
literal|86
index|]
operator|=
operator|(
name|ATA_SUPPORT_ADDRESS48
operator||
name|ATA_SUPPORT_FLUSHCACHE
operator||
name|ATA_SUPPORT_FLUSHCACHE48
operator||
literal|1
operator|<<
literal|15
operator|)
expr_stmt|;
name|buf
index|[
literal|87
index|]
operator|=
operator|(
literal|1
operator|<<
literal|14
operator|)
expr_stmt|;
name|buf
index|[
literal|88
index|]
operator|=
literal|0x7f
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|xfermode
operator|&
name|ATA_UDMA0
condition|)
name|buf
index|[
literal|88
index|]
operator||=
operator|(
literal|1
operator|<<
operator|(
operator|(
name|p
operator|->
name|xfermode
operator|&
literal|7
operator|)
operator|+
literal|8
operator|)
operator|)
expr_stmt|;
name|buf
index|[
literal|93
index|]
operator|=
operator|(
literal|1
operator||
literal|1
operator|<<
literal|14
operator|)
expr_stmt|;
name|buf
index|[
literal|100
index|]
operator|=
name|sectors
expr_stmt|;
name|buf
index|[
literal|101
index|]
operator|=
operator|(
name|sectors
operator|>>
literal|16
operator|)
expr_stmt|;
name|buf
index|[
literal|102
index|]
operator|=
operator|(
name|sectors
operator|>>
literal|32
operator|)
expr_stmt|;
name|buf
index|[
literal|103
index|]
operator|=
operator|(
name|sectors
operator|>>
literal|48
operator|)
expr_stmt|;
if|if
condition|(
name|candelete
operator|&&
operator|!
name|ro
condition|)
block|{
name|buf
index|[
literal|69
index|]
operator||=
name|ATA_SUPPORT_RZAT
operator||
name|ATA_SUPPORT_DRAT
expr_stmt|;
name|buf
index|[
literal|105
index|]
operator|=
literal|1
expr_stmt|;
name|buf
index|[
literal|169
index|]
operator|=
name|ATA_SUPPORT_DSM_TRIM
expr_stmt|;
block|}
name|buf
index|[
literal|106
index|]
operator|=
literal|0x4000
expr_stmt|;
name|buf
index|[
literal|209
index|]
operator|=
literal|0x4000
expr_stmt|;
if|if
condition|(
name|psectsz
operator|>
name|sectsz
condition|)
block|{
name|buf
index|[
literal|106
index|]
operator||=
literal|0x2000
expr_stmt|;
name|buf
index|[
literal|106
index|]
operator||=
name|ffsl
argument_list|(
name|psectsz
operator|/
name|sectsz
argument_list|)
operator|-
literal|1
expr_stmt|;
name|buf
index|[
literal|209
index|]
operator||=
operator|(
name|psectoff
operator|/
name|sectsz
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|sectsz
operator|>
literal|512
condition|)
block|{
name|buf
index|[
literal|106
index|]
operator||=
literal|0x1000
expr_stmt|;
name|buf
index|[
literal|117
index|]
operator|=
name|sectsz
operator|/
literal|2
expr_stmt|;
name|buf
index|[
literal|118
index|]
operator|=
operator|(
operator|(
name|sectsz
operator|/
literal|2
operator|)
operator|>>
literal|16
operator|)
expr_stmt|;
block|}
name|buf
index|[
literal|119
index|]
operator|=
operator|(
name|ATA_SUPPORT_RWLOGDMAEXT
operator||
literal|1
operator|<<
literal|14
operator|)
expr_stmt|;
name|buf
index|[
literal|120
index|]
operator|=
operator|(
name|ATA_SUPPORT_RWLOGDMAEXT
operator||
literal|1
operator|<<
literal|14
operator|)
expr_stmt|;
name|buf
index|[
literal|222
index|]
operator|=
literal|0x1020
expr_stmt|;
name|buf
index|[
literal|255
index|]
operator|=
literal|0x00a5
expr_stmt|;
name|ahci_checksum
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|ahci_write_fis_piosetup
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|write_prdt
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|,
operator|(
name|void
operator|*
operator|)
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|ahci_write_fis_d2h
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|,
name|ATA_S_DSC
operator||
name|ATA_S_READY
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|handle_atapi_identify
parameter_list|(
name|struct
name|ahci_port
modifier|*
name|p
parameter_list|,
name|int
name|slot
parameter_list|,
name|uint8_t
modifier|*
name|cfis
parameter_list|)
block|{
if|if
condition|(
operator|!
name|p
operator|->
name|atapi
condition|)
block|{
name|ahci_write_fis_d2h
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|,
operator|(
name|ATA_E_ABORT
operator|<<
literal|8
operator|)
operator||
name|ATA_S_READY
operator||
name|ATA_S_ERROR
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|uint16_t
name|buf
index|[
literal|256
index|]
decl_stmt|;
name|memset
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|buf
index|[
literal|0
index|]
operator|=
operator|(
literal|2
operator|<<
literal|14
operator||
literal|5
operator|<<
literal|8
operator||
literal|1
operator|<<
literal|7
operator||
literal|2
operator|<<
literal|5
operator|)
expr_stmt|;
name|ata_string
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
operator|(
name|buf
operator|+
literal|10
operator|)
argument_list|,
name|p
operator|->
name|ident
argument_list|,
literal|20
argument_list|)
expr_stmt|;
name|ata_string
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
operator|(
name|buf
operator|+
literal|23
operator|)
argument_list|,
literal|"001"
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|ata_string
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
operator|(
name|buf
operator|+
literal|27
operator|)
argument_list|,
literal|"BHYVE SATA DVD ROM"
argument_list|,
literal|40
argument_list|)
expr_stmt|;
name|buf
index|[
literal|49
index|]
operator|=
operator|(
literal|1
operator|<<
literal|9
operator||
literal|1
operator|<<
literal|8
operator|)
expr_stmt|;
name|buf
index|[
literal|50
index|]
operator|=
operator|(
literal|1
operator|<<
literal|14
operator||
literal|1
operator|)
expr_stmt|;
name|buf
index|[
literal|53
index|]
operator|=
operator|(
literal|1
operator|<<
literal|2
operator||
literal|1
operator|<<
literal|1
operator|)
expr_stmt|;
name|buf
index|[
literal|62
index|]
operator|=
literal|0x3f
expr_stmt|;
name|buf
index|[
literal|63
index|]
operator|=
literal|7
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|xfermode
operator|&
name|ATA_WDMA0
condition|)
name|buf
index|[
literal|63
index|]
operator||=
operator|(
literal|1
operator|<<
operator|(
operator|(
name|p
operator|->
name|xfermode
operator|&
literal|7
operator|)
operator|+
literal|8
operator|)
operator|)
expr_stmt|;
name|buf
index|[
literal|64
index|]
operator|=
literal|3
expr_stmt|;
name|buf
index|[
literal|65
index|]
operator|=
literal|120
expr_stmt|;
name|buf
index|[
literal|66
index|]
operator|=
literal|120
expr_stmt|;
name|buf
index|[
literal|67
index|]
operator|=
literal|120
expr_stmt|;
name|buf
index|[
literal|68
index|]
operator|=
literal|120
expr_stmt|;
name|buf
index|[
literal|76
index|]
operator|=
operator|(
name|ATA_SATA_GEN1
operator||
name|ATA_SATA_GEN2
operator||
name|ATA_SATA_GEN3
operator|)
expr_stmt|;
name|buf
index|[
literal|77
index|]
operator|=
operator|(
operator|(
name|p
operator|->
name|ssts
operator|&
name|ATA_SS_SPD_MASK
operator|)
operator|>>
literal|3
operator|)
expr_stmt|;
name|buf
index|[
literal|78
index|]
operator|=
operator|(
literal|1
operator|<<
literal|5
operator|)
expr_stmt|;
name|buf
index|[
literal|80
index|]
operator|=
literal|0x3f0
expr_stmt|;
name|buf
index|[
literal|82
index|]
operator|=
operator|(
name|ATA_SUPPORT_POWERMGT
operator||
name|ATA_SUPPORT_PACKET
operator||
name|ATA_SUPPORT_RESET
operator||
name|ATA_SUPPORT_NOP
operator|)
expr_stmt|;
name|buf
index|[
literal|83
index|]
operator|=
operator|(
literal|1
operator|<<
literal|14
operator|)
expr_stmt|;
name|buf
index|[
literal|84
index|]
operator|=
operator|(
literal|1
operator|<<
literal|14
operator|)
expr_stmt|;
name|buf
index|[
literal|85
index|]
operator|=
operator|(
name|ATA_SUPPORT_POWERMGT
operator||
name|ATA_SUPPORT_PACKET
operator||
name|ATA_SUPPORT_RESET
operator||
name|ATA_SUPPORT_NOP
operator|)
expr_stmt|;
name|buf
index|[
literal|87
index|]
operator|=
operator|(
literal|1
operator|<<
literal|14
operator|)
expr_stmt|;
name|buf
index|[
literal|88
index|]
operator|=
literal|0x7f
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|xfermode
operator|&
name|ATA_UDMA0
condition|)
name|buf
index|[
literal|88
index|]
operator||=
operator|(
literal|1
operator|<<
operator|(
operator|(
name|p
operator|->
name|xfermode
operator|&
literal|7
operator|)
operator|+
literal|8
operator|)
operator|)
expr_stmt|;
name|buf
index|[
literal|222
index|]
operator|=
literal|0x1020
expr_stmt|;
name|buf
index|[
literal|255
index|]
operator|=
literal|0x00a5
expr_stmt|;
name|ahci_checksum
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|ahci_write_fis_piosetup
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|write_prdt
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|,
operator|(
name|void
operator|*
operator|)
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|ahci_write_fis_d2h
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|,
name|ATA_S_DSC
operator||
name|ATA_S_READY
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|atapi_inquiry
parameter_list|(
name|struct
name|ahci_port
modifier|*
name|p
parameter_list|,
name|int
name|slot
parameter_list|,
name|uint8_t
modifier|*
name|cfis
parameter_list|)
block|{
name|uint8_t
name|buf
index|[
literal|36
index|]
decl_stmt|;
name|uint8_t
modifier|*
name|acmd
decl_stmt|;
name|int
name|len
decl_stmt|;
name|uint32_t
name|tfd
decl_stmt|;
name|acmd
operator|=
name|cfis
operator|+
literal|0x40
expr_stmt|;
if|if
condition|(
name|acmd
index|[
literal|1
index|]
operator|&
literal|1
condition|)
block|{
comment|/* VPD */
if|if
condition|(
name|acmd
index|[
literal|2
index|]
operator|==
literal|0
condition|)
block|{
comment|/* Supported VPD pages */
name|buf
index|[
literal|0
index|]
operator|=
literal|0x05
expr_stmt|;
name|buf
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|buf
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|buf
index|[
literal|3
index|]
operator|=
literal|1
expr_stmt|;
name|buf
index|[
literal|4
index|]
operator|=
literal|0
expr_stmt|;
name|len
operator|=
literal|4
operator|+
name|buf
index|[
literal|3
index|]
expr_stmt|;
block|}
else|else
block|{
name|p
operator|->
name|sense_key
operator|=
name|ATA_SENSE_ILLEGAL_REQUEST
expr_stmt|;
name|p
operator|->
name|asc
operator|=
literal|0x24
expr_stmt|;
name|tfd
operator|=
operator|(
name|p
operator|->
name|sense_key
operator|<<
literal|12
operator|)
operator||
name|ATA_S_READY
operator||
name|ATA_S_ERROR
expr_stmt|;
name|cfis
index|[
literal|4
index|]
operator|=
operator|(
name|cfis
index|[
literal|4
index|]
operator|&
operator|~
literal|7
operator|)
operator||
name|ATA_I_CMD
operator||
name|ATA_I_IN
expr_stmt|;
name|ahci_write_fis_d2h
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|,
name|tfd
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
else|else
block|{
name|buf
index|[
literal|0
index|]
operator|=
literal|0x05
expr_stmt|;
name|buf
index|[
literal|1
index|]
operator|=
literal|0x80
expr_stmt|;
name|buf
index|[
literal|2
index|]
operator|=
literal|0x00
expr_stmt|;
name|buf
index|[
literal|3
index|]
operator|=
literal|0x21
expr_stmt|;
name|buf
index|[
literal|4
index|]
operator|=
literal|31
expr_stmt|;
name|buf
index|[
literal|5
index|]
operator|=
literal|0
expr_stmt|;
name|buf
index|[
literal|6
index|]
operator|=
literal|0
expr_stmt|;
name|buf
index|[
literal|7
index|]
operator|=
literal|0
expr_stmt|;
name|atapi_string
argument_list|(
name|buf
operator|+
literal|8
argument_list|,
literal|"BHYVE"
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|atapi_string
argument_list|(
name|buf
operator|+
literal|16
argument_list|,
literal|"BHYVE DVD-ROM"
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|atapi_string
argument_list|(
name|buf
operator|+
literal|32
argument_list|,
literal|"001"
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|len
operator|>
name|acmd
index|[
literal|4
index|]
condition|)
name|len
operator|=
name|acmd
index|[
literal|4
index|]
expr_stmt|;
name|cfis
index|[
literal|4
index|]
operator|=
operator|(
name|cfis
index|[
literal|4
index|]
operator|&
operator|~
literal|7
operator|)
operator||
name|ATA_I_CMD
operator||
name|ATA_I_IN
expr_stmt|;
name|write_prdt
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|ahci_write_fis_d2h
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|,
name|ATA_S_READY
operator||
name|ATA_S_DSC
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|atapi_read_capacity
parameter_list|(
name|struct
name|ahci_port
modifier|*
name|p
parameter_list|,
name|int
name|slot
parameter_list|,
name|uint8_t
modifier|*
name|cfis
parameter_list|)
block|{
name|uint8_t
name|buf
index|[
literal|8
index|]
decl_stmt|;
name|uint64_t
name|sectors
decl_stmt|;
name|sectors
operator|=
name|blockif_size
argument_list|(
name|p
operator|->
name|bctx
argument_list|)
operator|/
literal|2048
expr_stmt|;
name|be32enc
argument_list|(
name|buf
argument_list|,
name|sectors
operator|-
literal|1
argument_list|)
expr_stmt|;
name|be32enc
argument_list|(
name|buf
operator|+
literal|4
argument_list|,
literal|2048
argument_list|)
expr_stmt|;
name|cfis
index|[
literal|4
index|]
operator|=
operator|(
name|cfis
index|[
literal|4
index|]
operator|&
operator|~
literal|7
operator|)
operator||
name|ATA_I_CMD
operator||
name|ATA_I_IN
expr_stmt|;
name|write_prdt
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|ahci_write_fis_d2h
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|,
name|ATA_S_READY
operator||
name|ATA_S_DSC
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|atapi_read_toc
parameter_list|(
name|struct
name|ahci_port
modifier|*
name|p
parameter_list|,
name|int
name|slot
parameter_list|,
name|uint8_t
modifier|*
name|cfis
parameter_list|)
block|{
name|uint8_t
modifier|*
name|acmd
decl_stmt|;
name|uint8_t
name|format
decl_stmt|;
name|int
name|len
decl_stmt|;
name|acmd
operator|=
name|cfis
operator|+
literal|0x40
expr_stmt|;
name|len
operator|=
name|be16dec
argument_list|(
name|acmd
operator|+
literal|7
argument_list|)
expr_stmt|;
name|format
operator|=
name|acmd
index|[
literal|9
index|]
operator|>>
literal|6
expr_stmt|;
switch|switch
condition|(
name|format
condition|)
block|{
case|case
literal|0
case|:
block|{
name|int
name|msf
decl_stmt|,
name|size
decl_stmt|;
name|uint64_t
name|sectors
decl_stmt|;
name|uint8_t
name|start_track
decl_stmt|,
name|buf
index|[
literal|20
index|]
decl_stmt|,
modifier|*
name|bp
decl_stmt|;
name|msf
operator|=
operator|(
name|acmd
index|[
literal|1
index|]
operator|>>
literal|1
operator|)
operator|&
literal|1
expr_stmt|;
name|start_track
operator|=
name|acmd
index|[
literal|6
index|]
expr_stmt|;
if|if
condition|(
name|start_track
operator|>
literal|1
operator|&&
name|start_track
operator|!=
literal|0xaa
condition|)
block|{
name|uint32_t
name|tfd
decl_stmt|;
name|p
operator|->
name|sense_key
operator|=
name|ATA_SENSE_ILLEGAL_REQUEST
expr_stmt|;
name|p
operator|->
name|asc
operator|=
literal|0x24
expr_stmt|;
name|tfd
operator|=
operator|(
name|p
operator|->
name|sense_key
operator|<<
literal|12
operator|)
operator||
name|ATA_S_READY
operator||
name|ATA_S_ERROR
expr_stmt|;
name|cfis
index|[
literal|4
index|]
operator|=
operator|(
name|cfis
index|[
literal|4
index|]
operator|&
operator|~
literal|7
operator|)
operator||
name|ATA_I_CMD
operator||
name|ATA_I_IN
expr_stmt|;
name|ahci_write_fis_d2h
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|,
name|tfd
argument_list|)
expr_stmt|;
return|return;
block|}
name|bp
operator|=
name|buf
operator|+
literal|2
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|1
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|start_track
operator|<=
literal|1
condition|)
block|{
operator|*
name|bp
operator|++
operator|=
literal|0
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|0x14
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|1
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|msf
condition|)
block|{
operator|*
name|bp
operator|++
operator|=
literal|0
expr_stmt|;
name|lba_to_msf
argument_list|(
name|bp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bp
operator|+=
literal|3
expr_stmt|;
block|}
else|else
block|{
operator|*
name|bp
operator|++
operator|=
literal|0
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|0
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|0
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|0
expr_stmt|;
block|}
block|}
operator|*
name|bp
operator|++
operator|=
literal|0
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|0x14
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|0xaa
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|0
expr_stmt|;
name|sectors
operator|=
name|blockif_size
argument_list|(
name|p
operator|->
name|bctx
argument_list|)
operator|/
name|blockif_sectsz
argument_list|(
name|p
operator|->
name|bctx
argument_list|)
expr_stmt|;
name|sectors
operator|>>=
literal|2
expr_stmt|;
if|if
condition|(
name|msf
condition|)
block|{
operator|*
name|bp
operator|++
operator|=
literal|0
expr_stmt|;
name|lba_to_msf
argument_list|(
name|bp
argument_list|,
name|sectors
argument_list|)
expr_stmt|;
name|bp
operator|+=
literal|3
expr_stmt|;
block|}
else|else
block|{
name|be32enc
argument_list|(
name|bp
argument_list|,
name|sectors
argument_list|)
expr_stmt|;
name|bp
operator|+=
literal|4
expr_stmt|;
block|}
name|size
operator|=
name|bp
operator|-
name|buf
expr_stmt|;
name|be16enc
argument_list|(
name|buf
argument_list|,
name|size
operator|-
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|size
condition|)
name|len
operator|=
name|size
expr_stmt|;
name|write_prdt
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|cfis
index|[
literal|4
index|]
operator|=
operator|(
name|cfis
index|[
literal|4
index|]
operator|&
operator|~
literal|7
operator|)
operator||
name|ATA_I_CMD
operator||
name|ATA_I_IN
expr_stmt|;
name|ahci_write_fis_d2h
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|,
name|ATA_S_READY
operator||
name|ATA_S_DSC
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|1
case|:
block|{
name|uint8_t
name|buf
index|[
literal|12
index|]
decl_stmt|;
name|memset
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|buf
index|[
literal|1
index|]
operator|=
literal|0xa
expr_stmt|;
name|buf
index|[
literal|2
index|]
operator|=
literal|0x1
expr_stmt|;
name|buf
index|[
literal|3
index|]
operator|=
literal|0x1
expr_stmt|;
if|if
condition|(
name|len
operator|>
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
condition|)
name|len
operator|=
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|write_prdt
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|cfis
index|[
literal|4
index|]
operator|=
operator|(
name|cfis
index|[
literal|4
index|]
operator|&
operator|~
literal|7
operator|)
operator||
name|ATA_I_CMD
operator||
name|ATA_I_IN
expr_stmt|;
name|ahci_write_fis_d2h
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|,
name|ATA_S_READY
operator||
name|ATA_S_DSC
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|2
case|:
block|{
name|int
name|msf
decl_stmt|,
name|size
decl_stmt|;
name|uint64_t
name|sectors
decl_stmt|;
name|uint8_t
name|start_track
decl_stmt|,
modifier|*
name|bp
decl_stmt|,
name|buf
index|[
literal|50
index|]
decl_stmt|;
name|msf
operator|=
operator|(
name|acmd
index|[
literal|1
index|]
operator|>>
literal|1
operator|)
operator|&
literal|1
expr_stmt|;
name|start_track
operator|=
name|acmd
index|[
literal|6
index|]
expr_stmt|;
name|bp
operator|=
name|buf
operator|+
literal|2
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|1
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|1
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|1
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|0x14
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|0
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|0xa0
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|0
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|0
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|0
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|0
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|1
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|0
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|0
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|1
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|0x14
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|0
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|0xa1
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|0
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|0
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|0
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|0
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|1
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|0
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|0
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|1
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|0x14
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|0
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|0xa2
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|0
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|0
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|0
expr_stmt|;
name|sectors
operator|=
name|blockif_size
argument_list|(
name|p
operator|->
name|bctx
argument_list|)
operator|/
name|blockif_sectsz
argument_list|(
name|p
operator|->
name|bctx
argument_list|)
expr_stmt|;
name|sectors
operator|>>=
literal|2
expr_stmt|;
if|if
condition|(
name|msf
condition|)
block|{
operator|*
name|bp
operator|++
operator|=
literal|0
expr_stmt|;
name|lba_to_msf
argument_list|(
name|bp
argument_list|,
name|sectors
argument_list|)
expr_stmt|;
name|bp
operator|+=
literal|3
expr_stmt|;
block|}
else|else
block|{
name|be32enc
argument_list|(
name|bp
argument_list|,
name|sectors
argument_list|)
expr_stmt|;
name|bp
operator|+=
literal|4
expr_stmt|;
block|}
operator|*
name|bp
operator|++
operator|=
literal|1
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|0x14
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|0
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|1
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|0
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|0
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|msf
condition|)
block|{
operator|*
name|bp
operator|++
operator|=
literal|0
expr_stmt|;
name|lba_to_msf
argument_list|(
name|bp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bp
operator|+=
literal|3
expr_stmt|;
block|}
else|else
block|{
operator|*
name|bp
operator|++
operator|=
literal|0
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|0
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|0
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|0
expr_stmt|;
block|}
name|size
operator|=
name|bp
operator|-
name|buf
expr_stmt|;
name|be16enc
argument_list|(
name|buf
argument_list|,
name|size
operator|-
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|size
condition|)
name|len
operator|=
name|size
expr_stmt|;
name|write_prdt
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|cfis
index|[
literal|4
index|]
operator|=
operator|(
name|cfis
index|[
literal|4
index|]
operator|&
operator|~
literal|7
operator|)
operator||
name|ATA_I_CMD
operator||
name|ATA_I_IN
expr_stmt|;
name|ahci_write_fis_d2h
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|,
name|ATA_S_READY
operator||
name|ATA_S_DSC
argument_list|)
expr_stmt|;
break|break;
block|}
default|default:
block|{
name|uint32_t
name|tfd
decl_stmt|;
name|p
operator|->
name|sense_key
operator|=
name|ATA_SENSE_ILLEGAL_REQUEST
expr_stmt|;
name|p
operator|->
name|asc
operator|=
literal|0x24
expr_stmt|;
name|tfd
operator|=
operator|(
name|p
operator|->
name|sense_key
operator|<<
literal|12
operator|)
operator||
name|ATA_S_READY
operator||
name|ATA_S_ERROR
expr_stmt|;
name|cfis
index|[
literal|4
index|]
operator|=
operator|(
name|cfis
index|[
literal|4
index|]
operator|&
operator|~
literal|7
operator|)
operator||
name|ATA_I_CMD
operator||
name|ATA_I_IN
expr_stmt|;
name|ahci_write_fis_d2h
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|,
name|tfd
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|atapi_report_luns
parameter_list|(
name|struct
name|ahci_port
modifier|*
name|p
parameter_list|,
name|int
name|slot
parameter_list|,
name|uint8_t
modifier|*
name|cfis
parameter_list|)
block|{
name|uint8_t
name|buf
index|[
literal|16
index|]
decl_stmt|;
name|memset
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|buf
index|[
literal|3
index|]
operator|=
literal|8
expr_stmt|;
name|cfis
index|[
literal|4
index|]
operator|=
operator|(
name|cfis
index|[
literal|4
index|]
operator|&
operator|~
literal|7
operator|)
operator||
name|ATA_I_CMD
operator||
name|ATA_I_IN
expr_stmt|;
name|write_prdt
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|ahci_write_fis_d2h
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|,
name|ATA_S_READY
operator||
name|ATA_S_DSC
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|atapi_read
parameter_list|(
name|struct
name|ahci_port
modifier|*
name|p
parameter_list|,
name|int
name|slot
parameter_list|,
name|uint8_t
modifier|*
name|cfis
parameter_list|,
name|uint32_t
name|done
parameter_list|)
block|{
name|struct
name|ahci_ioreq
modifier|*
name|aior
decl_stmt|;
name|struct
name|ahci_cmd_hdr
modifier|*
name|hdr
decl_stmt|;
name|struct
name|ahci_prdt_entry
modifier|*
name|prdt
decl_stmt|;
name|struct
name|blockif_req
modifier|*
name|breq
decl_stmt|;
name|struct
name|pci_ahci_softc
modifier|*
name|sc
decl_stmt|;
name|uint8_t
modifier|*
name|acmd
decl_stmt|;
name|uint64_t
name|lba
decl_stmt|;
name|uint32_t
name|len
decl_stmt|;
name|int
name|err
decl_stmt|;
name|sc
operator|=
name|p
operator|->
name|pr_sc
expr_stmt|;
name|acmd
operator|=
name|cfis
operator|+
literal|0x40
expr_stmt|;
name|hdr
operator|=
operator|(
expr|struct
name|ahci_cmd_hdr
operator|*
operator|)
operator|(
name|p
operator|->
name|cmd_lst
operator|+
name|slot
operator|*
name|AHCI_CL_SIZE
operator|)
expr_stmt|;
name|prdt
operator|=
operator|(
expr|struct
name|ahci_prdt_entry
operator|*
operator|)
operator|(
name|cfis
operator|+
literal|0x80
operator|)
expr_stmt|;
name|lba
operator|=
name|be32dec
argument_list|(
name|acmd
operator|+
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|acmd
index|[
literal|0
index|]
operator|==
name|READ_10
condition|)
name|len
operator|=
name|be16dec
argument_list|(
name|acmd
operator|+
literal|7
argument_list|)
expr_stmt|;
else|else
name|len
operator|=
name|be32dec
argument_list|(
name|acmd
operator|+
literal|6
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|==
literal|0
condition|)
block|{
name|cfis
index|[
literal|4
index|]
operator|=
operator|(
name|cfis
index|[
literal|4
index|]
operator|&
operator|~
literal|7
operator|)
operator||
name|ATA_I_CMD
operator||
name|ATA_I_IN
expr_stmt|;
name|ahci_write_fis_d2h
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|,
name|ATA_S_READY
operator||
name|ATA_S_DSC
argument_list|)
expr_stmt|;
block|}
name|lba
operator|*=
literal|2048
expr_stmt|;
name|len
operator|*=
literal|2048
expr_stmt|;
comment|/* 	 * Pull request off free list 	 */
name|aior
operator|=
name|STAILQ_FIRST
argument_list|(
operator|&
name|p
operator|->
name|iofhd
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|aior
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|STAILQ_REMOVE_HEAD
argument_list|(
operator|&
name|p
operator|->
name|iofhd
argument_list|,
name|io_flist
argument_list|)
expr_stmt|;
name|aior
operator|->
name|cfis
operator|=
name|cfis
expr_stmt|;
name|aior
operator|->
name|slot
operator|=
name|slot
expr_stmt|;
name|aior
operator|->
name|len
operator|=
name|len
expr_stmt|;
name|aior
operator|->
name|done
operator|=
name|done
expr_stmt|;
name|breq
operator|=
operator|&
name|aior
operator|->
name|io_req
expr_stmt|;
name|breq
operator|->
name|br_offset
operator|=
name|lba
operator|+
name|done
expr_stmt|;
name|ahci_build_iov
argument_list|(
name|p
argument_list|,
name|aior
argument_list|,
name|prdt
argument_list|,
name|hdr
operator|->
name|prdtl
argument_list|)
expr_stmt|;
comment|/* Mark this command in-flight. */
name|p
operator|->
name|pending
operator||=
literal|1
operator|<<
name|slot
expr_stmt|;
comment|/* Stuff request onto busy list. */
name|TAILQ_INSERT_HEAD
argument_list|(
operator|&
name|p
operator|->
name|iobhd
argument_list|,
name|aior
argument_list|,
name|io_blist
argument_list|)
expr_stmt|;
name|err
operator|=
name|blockif_read
argument_list|(
name|p
operator|->
name|bctx
argument_list|,
name|breq
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|err
operator|==
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|atapi_request_sense
parameter_list|(
name|struct
name|ahci_port
modifier|*
name|p
parameter_list|,
name|int
name|slot
parameter_list|,
name|uint8_t
modifier|*
name|cfis
parameter_list|)
block|{
name|uint8_t
name|buf
index|[
literal|64
index|]
decl_stmt|;
name|uint8_t
modifier|*
name|acmd
decl_stmt|;
name|int
name|len
decl_stmt|;
name|acmd
operator|=
name|cfis
operator|+
literal|0x40
expr_stmt|;
name|len
operator|=
name|acmd
index|[
literal|4
index|]
expr_stmt|;
if|if
condition|(
name|len
operator|>
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
condition|)
name|len
operator|=
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|buf
index|[
literal|0
index|]
operator|=
literal|0x70
operator||
operator|(
literal|1
operator|<<
literal|7
operator|)
expr_stmt|;
name|buf
index|[
literal|2
index|]
operator|=
name|p
operator|->
name|sense_key
expr_stmt|;
name|buf
index|[
literal|7
index|]
operator|=
literal|10
expr_stmt|;
name|buf
index|[
literal|12
index|]
operator|=
name|p
operator|->
name|asc
expr_stmt|;
name|write_prdt
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|cfis
index|[
literal|4
index|]
operator|=
operator|(
name|cfis
index|[
literal|4
index|]
operator|&
operator|~
literal|7
operator|)
operator||
name|ATA_I_CMD
operator||
name|ATA_I_IN
expr_stmt|;
name|ahci_write_fis_d2h
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|,
name|ATA_S_READY
operator||
name|ATA_S_DSC
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|atapi_start_stop_unit
parameter_list|(
name|struct
name|ahci_port
modifier|*
name|p
parameter_list|,
name|int
name|slot
parameter_list|,
name|uint8_t
modifier|*
name|cfis
parameter_list|)
block|{
name|uint8_t
modifier|*
name|acmd
init|=
name|cfis
operator|+
literal|0x40
decl_stmt|;
name|uint32_t
name|tfd
decl_stmt|;
switch|switch
condition|(
name|acmd
index|[
literal|4
index|]
operator|&
literal|3
condition|)
block|{
case|case
literal|0
case|:
case|case
literal|1
case|:
case|case
literal|3
case|:
name|cfis
index|[
literal|4
index|]
operator|=
operator|(
name|cfis
index|[
literal|4
index|]
operator|&
operator|~
literal|7
operator|)
operator||
name|ATA_I_CMD
operator||
name|ATA_I_IN
expr_stmt|;
name|tfd
operator|=
name|ATA_S_READY
operator||
name|ATA_S_DSC
expr_stmt|;
break|break;
case|case
literal|2
case|:
comment|/* TODO eject media */
name|cfis
index|[
literal|4
index|]
operator|=
operator|(
name|cfis
index|[
literal|4
index|]
operator|&
operator|~
literal|7
operator|)
operator||
name|ATA_I_CMD
operator||
name|ATA_I_IN
expr_stmt|;
name|p
operator|->
name|sense_key
operator|=
name|ATA_SENSE_ILLEGAL_REQUEST
expr_stmt|;
name|p
operator|->
name|asc
operator|=
literal|0x53
expr_stmt|;
name|tfd
operator|=
operator|(
name|p
operator|->
name|sense_key
operator|<<
literal|12
operator|)
operator||
name|ATA_S_READY
operator||
name|ATA_S_ERROR
expr_stmt|;
break|break;
block|}
name|ahci_write_fis_d2h
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|,
name|tfd
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|atapi_mode_sense
parameter_list|(
name|struct
name|ahci_port
modifier|*
name|p
parameter_list|,
name|int
name|slot
parameter_list|,
name|uint8_t
modifier|*
name|cfis
parameter_list|)
block|{
name|uint8_t
modifier|*
name|acmd
decl_stmt|;
name|uint32_t
name|tfd
decl_stmt|;
name|uint8_t
name|pc
decl_stmt|,
name|code
decl_stmt|;
name|int
name|len
decl_stmt|;
name|acmd
operator|=
name|cfis
operator|+
literal|0x40
expr_stmt|;
name|len
operator|=
name|be16dec
argument_list|(
name|acmd
operator|+
literal|7
argument_list|)
expr_stmt|;
name|pc
operator|=
name|acmd
index|[
literal|2
index|]
operator|>>
literal|6
expr_stmt|;
name|code
operator|=
name|acmd
index|[
literal|2
index|]
operator|&
literal|0x3f
expr_stmt|;
switch|switch
condition|(
name|pc
condition|)
block|{
case|case
literal|0
case|:
switch|switch
condition|(
name|code
condition|)
block|{
case|case
name|MODEPAGE_RW_ERROR_RECOVERY
case|:
block|{
name|uint8_t
name|buf
index|[
literal|16
index|]
decl_stmt|;
if|if
condition|(
name|len
operator|>
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
condition|)
name|len
operator|=
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|be16enc
argument_list|(
name|buf
argument_list|,
literal|16
operator|-
literal|2
argument_list|)
expr_stmt|;
name|buf
index|[
literal|2
index|]
operator|=
literal|0x70
expr_stmt|;
name|buf
index|[
literal|8
index|]
operator|=
literal|0x01
expr_stmt|;
name|buf
index|[
literal|9
index|]
operator|=
literal|16
operator|-
literal|10
expr_stmt|;
name|buf
index|[
literal|11
index|]
operator|=
literal|0x05
expr_stmt|;
name|write_prdt
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|tfd
operator|=
name|ATA_S_READY
operator||
name|ATA_S_DSC
expr_stmt|;
break|break;
block|}
case|case
name|MODEPAGE_CD_CAPABILITIES
case|:
block|{
name|uint8_t
name|buf
index|[
literal|30
index|]
decl_stmt|;
if|if
condition|(
name|len
operator|>
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
condition|)
name|len
operator|=
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|be16enc
argument_list|(
name|buf
argument_list|,
literal|30
operator|-
literal|2
argument_list|)
expr_stmt|;
name|buf
index|[
literal|2
index|]
operator|=
literal|0x70
expr_stmt|;
name|buf
index|[
literal|8
index|]
operator|=
literal|0x2A
expr_stmt|;
name|buf
index|[
literal|9
index|]
operator|=
literal|30
operator|-
literal|10
expr_stmt|;
name|buf
index|[
literal|10
index|]
operator|=
literal|0x08
expr_stmt|;
name|buf
index|[
literal|12
index|]
operator|=
literal|0x71
expr_stmt|;
name|be16enc
argument_list|(
operator|&
name|buf
index|[
literal|18
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|be16enc
argument_list|(
operator|&
name|buf
index|[
literal|20
index|]
argument_list|,
literal|512
argument_list|)
expr_stmt|;
name|write_prdt
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|tfd
operator|=
name|ATA_S_READY
operator||
name|ATA_S_DSC
expr_stmt|;
break|break;
block|}
default|default:
goto|goto
name|error
goto|;
break|break;
block|}
break|break;
case|case
literal|3
case|:
name|p
operator|->
name|sense_key
operator|=
name|ATA_SENSE_ILLEGAL_REQUEST
expr_stmt|;
name|p
operator|->
name|asc
operator|=
literal|0x39
expr_stmt|;
name|tfd
operator|=
operator|(
name|p
operator|->
name|sense_key
operator|<<
literal|12
operator|)
operator||
name|ATA_S_READY
operator||
name|ATA_S_ERROR
expr_stmt|;
break|break;
name|error
label|:
case|case
literal|1
case|:
case|case
literal|2
case|:
name|p
operator|->
name|sense_key
operator|=
name|ATA_SENSE_ILLEGAL_REQUEST
expr_stmt|;
name|p
operator|->
name|asc
operator|=
literal|0x24
expr_stmt|;
name|tfd
operator|=
operator|(
name|p
operator|->
name|sense_key
operator|<<
literal|12
operator|)
operator||
name|ATA_S_READY
operator||
name|ATA_S_ERROR
expr_stmt|;
break|break;
block|}
name|cfis
index|[
literal|4
index|]
operator|=
operator|(
name|cfis
index|[
literal|4
index|]
operator|&
operator|~
literal|7
operator|)
operator||
name|ATA_I_CMD
operator||
name|ATA_I_IN
expr_stmt|;
name|ahci_write_fis_d2h
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|,
name|tfd
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|atapi_get_event_status_notification
parameter_list|(
name|struct
name|ahci_port
modifier|*
name|p
parameter_list|,
name|int
name|slot
parameter_list|,
name|uint8_t
modifier|*
name|cfis
parameter_list|)
block|{
name|uint8_t
modifier|*
name|acmd
decl_stmt|;
name|uint32_t
name|tfd
decl_stmt|;
name|acmd
operator|=
name|cfis
operator|+
literal|0x40
expr_stmt|;
comment|/* we don't support asynchronous operation */
if|if
condition|(
operator|!
operator|(
name|acmd
index|[
literal|1
index|]
operator|&
literal|1
operator|)
condition|)
block|{
name|p
operator|->
name|sense_key
operator|=
name|ATA_SENSE_ILLEGAL_REQUEST
expr_stmt|;
name|p
operator|->
name|asc
operator|=
literal|0x24
expr_stmt|;
name|tfd
operator|=
operator|(
name|p
operator|->
name|sense_key
operator|<<
literal|12
operator|)
operator||
name|ATA_S_READY
operator||
name|ATA_S_ERROR
expr_stmt|;
block|}
else|else
block|{
name|uint8_t
name|buf
index|[
literal|8
index|]
decl_stmt|;
name|int
name|len
decl_stmt|;
name|len
operator|=
name|be16dec
argument_list|(
name|acmd
operator|+
literal|7
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
condition|)
name|len
operator|=
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|be16enc
argument_list|(
name|buf
argument_list|,
literal|8
operator|-
literal|2
argument_list|)
expr_stmt|;
name|buf
index|[
literal|2
index|]
operator|=
literal|0x04
expr_stmt|;
name|buf
index|[
literal|3
index|]
operator|=
literal|0x10
expr_stmt|;
name|buf
index|[
literal|5
index|]
operator|=
literal|0x02
expr_stmt|;
name|write_prdt
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|tfd
operator|=
name|ATA_S_READY
operator||
name|ATA_S_DSC
expr_stmt|;
block|}
name|cfis
index|[
literal|4
index|]
operator|=
operator|(
name|cfis
index|[
literal|4
index|]
operator|&
operator|~
literal|7
operator|)
operator||
name|ATA_I_CMD
operator||
name|ATA_I_IN
expr_stmt|;
name|ahci_write_fis_d2h
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|,
name|tfd
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|handle_packet_cmd
parameter_list|(
name|struct
name|ahci_port
modifier|*
name|p
parameter_list|,
name|int
name|slot
parameter_list|,
name|uint8_t
modifier|*
name|cfis
parameter_list|)
block|{
name|uint8_t
modifier|*
name|acmd
decl_stmt|;
name|acmd
operator|=
name|cfis
operator|+
literal|0x40
expr_stmt|;
ifdef|#
directive|ifdef
name|AHCI_DEBUG
block|{
name|int
name|i
decl_stmt|;
name|DPRINTF
argument_list|(
literal|"ACMD:"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
name|DPRINTF
argument_list|(
literal|"%02x "
argument_list|,
name|acmd
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
switch|switch
condition|(
name|acmd
index|[
literal|0
index|]
condition|)
block|{
case|case
name|TEST_UNIT_READY
case|:
name|cfis
index|[
literal|4
index|]
operator|=
operator|(
name|cfis
index|[
literal|4
index|]
operator|&
operator|~
literal|7
operator|)
operator||
name|ATA_I_CMD
operator||
name|ATA_I_IN
expr_stmt|;
name|ahci_write_fis_d2h
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|,
name|ATA_S_READY
operator||
name|ATA_S_DSC
argument_list|)
expr_stmt|;
break|break;
case|case
name|INQUIRY
case|:
name|atapi_inquiry
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|)
expr_stmt|;
break|break;
case|case
name|READ_CAPACITY
case|:
name|atapi_read_capacity
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|)
expr_stmt|;
break|break;
case|case
name|PREVENT_ALLOW
case|:
comment|/* TODO */
name|cfis
index|[
literal|4
index|]
operator|=
operator|(
name|cfis
index|[
literal|4
index|]
operator|&
operator|~
literal|7
operator|)
operator||
name|ATA_I_CMD
operator||
name|ATA_I_IN
expr_stmt|;
name|ahci_write_fis_d2h
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|,
name|ATA_S_READY
operator||
name|ATA_S_DSC
argument_list|)
expr_stmt|;
break|break;
case|case
name|READ_TOC
case|:
name|atapi_read_toc
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|)
expr_stmt|;
break|break;
case|case
name|REPORT_LUNS
case|:
name|atapi_report_luns
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|)
expr_stmt|;
break|break;
case|case
name|READ_10
case|:
case|case
name|READ_12
case|:
name|atapi_read
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|REQUEST_SENSE
case|:
name|atapi_request_sense
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|)
expr_stmt|;
break|break;
case|case
name|START_STOP_UNIT
case|:
name|atapi_start_stop_unit
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|)
expr_stmt|;
break|break;
case|case
name|MODE_SENSE_10
case|:
name|atapi_mode_sense
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|)
expr_stmt|;
break|break;
case|case
name|GET_EVENT_STATUS_NOTIFICATION
case|:
name|atapi_get_event_status_notification
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|)
expr_stmt|;
break|break;
default|default:
name|cfis
index|[
literal|4
index|]
operator|=
operator|(
name|cfis
index|[
literal|4
index|]
operator|&
operator|~
literal|7
operator|)
operator||
name|ATA_I_CMD
operator||
name|ATA_I_IN
expr_stmt|;
name|p
operator|->
name|sense_key
operator|=
name|ATA_SENSE_ILLEGAL_REQUEST
expr_stmt|;
name|p
operator|->
name|asc
operator|=
literal|0x20
expr_stmt|;
name|ahci_write_fis_d2h
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|,
operator|(
name|p
operator|->
name|sense_key
operator|<<
literal|12
operator|)
operator||
name|ATA_S_READY
operator||
name|ATA_S_ERROR
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ahci_handle_cmd
parameter_list|(
name|struct
name|ahci_port
modifier|*
name|p
parameter_list|,
name|int
name|slot
parameter_list|,
name|uint8_t
modifier|*
name|cfis
parameter_list|)
block|{
switch|switch
condition|(
name|cfis
index|[
literal|2
index|]
condition|)
block|{
case|case
name|ATA_ATA_IDENTIFY
case|:
name|handle_identify
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|)
expr_stmt|;
break|break;
case|case
name|ATA_SETFEATURES
case|:
block|{
switch|switch
condition|(
name|cfis
index|[
literal|3
index|]
condition|)
block|{
case|case
name|ATA_SF_ENAB_SATA_SF
case|:
switch|switch
condition|(
name|cfis
index|[
literal|12
index|]
condition|)
block|{
case|case
name|ATA_SATA_SF_AN
case|:
name|p
operator|->
name|tfd
operator|=
name|ATA_S_DSC
operator||
name|ATA_S_READY
expr_stmt|;
break|break;
default|default:
name|p
operator|->
name|tfd
operator|=
name|ATA_S_ERROR
operator||
name|ATA_S_READY
expr_stmt|;
name|p
operator|->
name|tfd
operator||=
operator|(
name|ATA_ERROR_ABORT
operator|<<
literal|8
operator|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|ATA_SF_ENAB_WCACHE
case|:
case|case
name|ATA_SF_DIS_WCACHE
case|:
case|case
name|ATA_SF_ENAB_RCACHE
case|:
case|case
name|ATA_SF_DIS_RCACHE
case|:
name|p
operator|->
name|tfd
operator|=
name|ATA_S_DSC
operator||
name|ATA_S_READY
expr_stmt|;
break|break;
case|case
name|ATA_SF_SETXFER
case|:
block|{
switch|switch
condition|(
name|cfis
index|[
literal|12
index|]
operator|&
literal|0xf8
condition|)
block|{
case|case
name|ATA_PIO
case|:
case|case
name|ATA_PIO0
case|:
break|break;
case|case
name|ATA_WDMA0
case|:
case|case
name|ATA_UDMA0
case|:
name|p
operator|->
name|xfermode
operator|=
operator|(
name|cfis
index|[
literal|12
index|]
operator|&
literal|0x7
operator|)
expr_stmt|;
break|break;
block|}
name|p
operator|->
name|tfd
operator|=
name|ATA_S_DSC
operator||
name|ATA_S_READY
expr_stmt|;
break|break;
block|}
default|default:
name|p
operator|->
name|tfd
operator|=
name|ATA_S_ERROR
operator||
name|ATA_S_READY
expr_stmt|;
name|p
operator|->
name|tfd
operator||=
operator|(
name|ATA_ERROR_ABORT
operator|<<
literal|8
operator|)
expr_stmt|;
break|break;
block|}
name|ahci_write_fis_d2h
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|,
name|p
operator|->
name|tfd
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|ATA_SET_MULTI
case|:
if|if
condition|(
name|cfis
index|[
literal|12
index|]
operator|!=
literal|0
operator|&&
operator|(
name|cfis
index|[
literal|12
index|]
operator|>
literal|128
operator|||
operator|(
name|cfis
index|[
literal|12
index|]
operator|&
operator|(
name|cfis
index|[
literal|12
index|]
operator|-
literal|1
operator|)
operator|)
operator|)
condition|)
block|{
name|p
operator|->
name|tfd
operator|=
name|ATA_S_ERROR
operator||
name|ATA_S_READY
expr_stmt|;
name|p
operator|->
name|tfd
operator||=
operator|(
name|ATA_ERROR_ABORT
operator|<<
literal|8
operator|)
expr_stmt|;
block|}
else|else
block|{
name|p
operator|->
name|mult_sectors
operator|=
name|cfis
index|[
literal|12
index|]
expr_stmt|;
name|p
operator|->
name|tfd
operator|=
name|ATA_S_DSC
operator||
name|ATA_S_READY
expr_stmt|;
block|}
name|ahci_write_fis_d2h
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|,
name|p
operator|->
name|tfd
argument_list|)
expr_stmt|;
break|break;
case|case
name|ATA_READ
case|:
case|case
name|ATA_WRITE
case|:
case|case
name|ATA_READ48
case|:
case|case
name|ATA_WRITE48
case|:
case|case
name|ATA_READ_MUL
case|:
case|case
name|ATA_WRITE_MUL
case|:
case|case
name|ATA_READ_MUL48
case|:
case|case
name|ATA_WRITE_MUL48
case|:
case|case
name|ATA_READ_DMA
case|:
case|case
name|ATA_WRITE_DMA
case|:
case|case
name|ATA_READ_DMA48
case|:
case|case
name|ATA_WRITE_DMA48
case|:
case|case
name|ATA_READ_FPDMA_QUEUED
case|:
case|case
name|ATA_WRITE_FPDMA_QUEUED
case|:
name|ahci_handle_rw
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|ATA_FLUSHCACHE
case|:
case|case
name|ATA_FLUSHCACHE48
case|:
name|ahci_handle_flush
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|)
expr_stmt|;
break|break;
case|case
name|ATA_DATA_SET_MANAGEMENT
case|:
if|if
condition|(
name|cfis
index|[
literal|11
index|]
operator|==
literal|0
operator|&&
name|cfis
index|[
literal|3
index|]
operator|==
name|ATA_DSM_TRIM
operator|&&
name|cfis
index|[
literal|13
index|]
operator|==
literal|0
operator|&&
name|cfis
index|[
literal|12
index|]
operator|==
literal|1
condition|)
block|{
name|ahci_handle_dsm_trim
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
name|ahci_write_fis_d2h
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|,
operator|(
name|ATA_E_ABORT
operator|<<
literal|8
operator|)
operator||
name|ATA_S_READY
operator||
name|ATA_S_ERROR
argument_list|)
expr_stmt|;
break|break;
case|case
name|ATA_SEND_FPDMA_QUEUED
case|:
if|if
condition|(
operator|(
name|cfis
index|[
literal|13
index|]
operator|&
literal|0x1f
operator|)
operator|==
name|ATA_SFPDMA_DSM
operator|&&
name|cfis
index|[
literal|17
index|]
operator|==
literal|0
operator|&&
name|cfis
index|[
literal|16
index|]
operator|==
name|ATA_DSM_TRIM
operator|&&
name|cfis
index|[
literal|11
index|]
operator|==
literal|0
operator|&&
name|cfis
index|[
literal|13
index|]
operator|==
literal|1
condition|)
block|{
name|ahci_handle_dsm_trim
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
name|ahci_write_fis_d2h
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|,
operator|(
name|ATA_E_ABORT
operator|<<
literal|8
operator|)
operator||
name|ATA_S_READY
operator||
name|ATA_S_ERROR
argument_list|)
expr_stmt|;
break|break;
case|case
name|ATA_READ_LOG_EXT
case|:
case|case
name|ATA_READ_LOG_DMA_EXT
case|:
name|ahci_handle_read_log
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|)
expr_stmt|;
break|break;
case|case
name|ATA_NOP
case|:
name|ahci_write_fis_d2h
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|,
operator|(
name|ATA_E_ABORT
operator|<<
literal|8
operator|)
operator||
name|ATA_S_READY
operator||
name|ATA_S_ERROR
argument_list|)
expr_stmt|;
break|break;
case|case
name|ATA_STANDBY_CMD
case|:
case|case
name|ATA_STANDBY_IMMEDIATE
case|:
case|case
name|ATA_IDLE_CMD
case|:
case|case
name|ATA_IDLE_IMMEDIATE
case|:
case|case
name|ATA_SLEEP
case|:
name|ahci_write_fis_d2h
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|,
name|ATA_S_READY
operator||
name|ATA_S_DSC
argument_list|)
expr_stmt|;
break|break;
case|case
name|ATA_ATAPI_IDENTIFY
case|:
name|handle_atapi_identify
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|)
expr_stmt|;
break|break;
case|case
name|ATA_PACKET_CMD
case|:
if|if
condition|(
operator|!
name|p
operator|->
name|atapi
condition|)
block|{
name|ahci_write_fis_d2h
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|,
operator|(
name|ATA_E_ABORT
operator|<<
literal|8
operator|)
operator||
name|ATA_S_READY
operator||
name|ATA_S_ERROR
argument_list|)
expr_stmt|;
block|}
else|else
name|handle_packet_cmd
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|)
expr_stmt|;
break|break;
default|default:
name|WPRINTF
argument_list|(
literal|"Unsupported cmd:%02x\n"
argument_list|,
name|cfis
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|ahci_write_fis_d2h
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|,
operator|(
name|ATA_E_ABORT
operator|<<
literal|8
operator|)
operator||
name|ATA_S_READY
operator||
name|ATA_S_ERROR
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ahci_handle_slot
parameter_list|(
name|struct
name|ahci_port
modifier|*
name|p
parameter_list|,
name|int
name|slot
parameter_list|)
block|{
name|struct
name|ahci_cmd_hdr
modifier|*
name|hdr
decl_stmt|;
name|struct
name|ahci_prdt_entry
modifier|*
name|prdt
decl_stmt|;
name|struct
name|pci_ahci_softc
modifier|*
name|sc
decl_stmt|;
name|uint8_t
modifier|*
name|cfis
decl_stmt|;
name|int
name|cfl
decl_stmt|;
name|sc
operator|=
name|p
operator|->
name|pr_sc
expr_stmt|;
name|hdr
operator|=
operator|(
expr|struct
name|ahci_cmd_hdr
operator|*
operator|)
operator|(
name|p
operator|->
name|cmd_lst
operator|+
name|slot
operator|*
name|AHCI_CL_SIZE
operator|)
expr_stmt|;
name|cfl
operator|=
operator|(
name|hdr
operator|->
name|flags
operator|&
literal|0x1f
operator|)
operator|*
literal|4
expr_stmt|;
name|cfis
operator|=
name|paddr_guest2host
argument_list|(
name|ahci_ctx
argument_list|(
name|sc
argument_list|)
argument_list|,
name|hdr
operator|->
name|ctba
argument_list|,
literal|0x80
operator|+
name|hdr
operator|->
name|prdtl
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|ahci_prdt_entry
argument_list|)
argument_list|)
expr_stmt|;
name|prdt
operator|=
operator|(
expr|struct
name|ahci_prdt_entry
operator|*
operator|)
operator|(
name|cfis
operator|+
literal|0x80
operator|)
expr_stmt|;
ifdef|#
directive|ifdef
name|AHCI_DEBUG
name|DPRINTF
argument_list|(
literal|"\ncfis:"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cfl
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|%
literal|10
operator|==
literal|0
condition|)
name|DPRINTF
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"%02x "
argument_list|,
name|cfis
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|DPRINTF
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|hdr
operator|->
name|prdtl
condition|;
name|i
operator|++
control|)
block|{
name|DPRINTF
argument_list|(
literal|"%d@%08"
name|PRIx64
literal|"\n"
argument_list|,
name|prdt
operator|->
name|dbc
operator|&
literal|0x3fffff
argument_list|,
name|prdt
operator|->
name|dba
argument_list|)
expr_stmt|;
name|prdt
operator|++
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|cfis
index|[
literal|0
index|]
operator|!=
name|FIS_TYPE_REGH2D
condition|)
block|{
name|WPRINTF
argument_list|(
literal|"Not a H2D FIS:%02x\n"
argument_list|,
name|cfis
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|cfis
index|[
literal|1
index|]
operator|&
literal|0x80
condition|)
block|{
name|ahci_handle_cmd
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|cfis
index|[
literal|15
index|]
operator|&
operator|(
literal|1
operator|<<
literal|2
operator|)
condition|)
name|p
operator|->
name|reset
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|p
operator|->
name|reset
condition|)
block|{
name|p
operator|->
name|reset
operator|=
literal|0
expr_stmt|;
name|ahci_port_reset
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
name|p
operator|->
name|ci
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|slot
operator|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ahci_handle_port
parameter_list|(
name|struct
name|ahci_port
modifier|*
name|p
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|p
operator|->
name|cmd
operator|&
name|AHCI_P_CMD_ST
operator|)
condition|)
return|return;
comment|/* 	 * Search for any new commands to issue ignoring those that 	 * are already in-flight. 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|(
name|i
operator|<
literal|32
operator|)
operator|&&
name|p
operator|->
name|ci
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|p
operator|->
name|ci
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
operator|)
operator|&&
operator|!
operator|(
name|p
operator|->
name|pending
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
operator|)
condition|)
block|{
name|p
operator|->
name|cmd
operator|&=
operator|~
name|AHCI_P_CMD_CCS_MASK
expr_stmt|;
name|p
operator|->
name|cmd
operator||=
name|i
operator|<<
name|AHCI_P_CMD_CCS_SHIFT
expr_stmt|;
name|ahci_handle_slot
argument_list|(
name|p
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*  * blockif callback routine - this runs in the context of the blockif  * i/o thread, so the mutex needs to be acquired.  */
end_comment

begin_function
specifier|static
name|void
name|ata_ioreq_cb
parameter_list|(
name|struct
name|blockif_req
modifier|*
name|br
parameter_list|,
name|int
name|err
parameter_list|)
block|{
name|struct
name|ahci_cmd_hdr
modifier|*
name|hdr
decl_stmt|;
name|struct
name|ahci_ioreq
modifier|*
name|aior
decl_stmt|;
name|struct
name|ahci_port
modifier|*
name|p
decl_stmt|;
name|struct
name|pci_ahci_softc
modifier|*
name|sc
decl_stmt|;
name|uint32_t
name|tfd
decl_stmt|;
name|uint8_t
modifier|*
name|cfis
decl_stmt|;
name|int
name|slot
decl_stmt|,
name|ncq
decl_stmt|,
name|dsm
decl_stmt|;
name|DPRINTF
argument_list|(
literal|"%s %d\n"
argument_list|,
name|__func__
argument_list|,
name|err
argument_list|)
expr_stmt|;
name|ncq
operator|=
name|dsm
operator|=
literal|0
expr_stmt|;
name|aior
operator|=
name|br
operator|->
name|br_param
expr_stmt|;
name|p
operator|=
name|aior
operator|->
name|io_pr
expr_stmt|;
name|cfis
operator|=
name|aior
operator|->
name|cfis
expr_stmt|;
name|slot
operator|=
name|aior
operator|->
name|slot
expr_stmt|;
name|sc
operator|=
name|p
operator|->
name|pr_sc
expr_stmt|;
name|hdr
operator|=
operator|(
expr|struct
name|ahci_cmd_hdr
operator|*
operator|)
operator|(
name|p
operator|->
name|cmd_lst
operator|+
name|slot
operator|*
name|AHCI_CL_SIZE
operator|)
expr_stmt|;
if|if
condition|(
name|cfis
index|[
literal|2
index|]
operator|==
name|ATA_WRITE_FPDMA_QUEUED
operator|||
name|cfis
index|[
literal|2
index|]
operator|==
name|ATA_READ_FPDMA_QUEUED
operator|||
name|cfis
index|[
literal|2
index|]
operator|==
name|ATA_SEND_FPDMA_QUEUED
condition|)
name|ncq
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|cfis
index|[
literal|2
index|]
operator|==
name|ATA_DATA_SET_MANAGEMENT
operator|||
operator|(
name|cfis
index|[
literal|2
index|]
operator|==
name|ATA_SEND_FPDMA_QUEUED
operator|&&
operator|(
name|cfis
index|[
literal|13
index|]
operator|&
literal|0x1f
operator|)
operator|==
name|ATA_SFPDMA_DSM
operator|)
condition|)
name|dsm
operator|=
literal|1
expr_stmt|;
name|pthread_mutex_lock
argument_list|(
operator|&
name|sc
operator|->
name|mtx
argument_list|)
expr_stmt|;
comment|/* 	 * Delete the blockif request from the busy list 	 */
name|TAILQ_REMOVE
argument_list|(
operator|&
name|p
operator|->
name|iobhd
argument_list|,
name|aior
argument_list|,
name|io_blist
argument_list|)
expr_stmt|;
comment|/* 	 * Move the blockif request back to the free list 	 */
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|p
operator|->
name|iofhd
argument_list|,
name|aior
argument_list|,
name|io_flist
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|err
condition|)
name|hdr
operator|->
name|prdbc
operator|=
name|aior
operator|->
name|done
expr_stmt|;
if|if
condition|(
operator|!
name|err
operator|&&
name|aior
operator|->
name|more
condition|)
block|{
if|if
condition|(
name|dsm
condition|)
name|ahci_handle_dsm_trim
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|,
name|aior
operator|->
name|done
argument_list|)
expr_stmt|;
else|else
name|ahci_handle_rw
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|,
name|aior
operator|->
name|done
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
operator|!
name|err
condition|)
name|tfd
operator|=
name|ATA_S_READY
operator||
name|ATA_S_DSC
expr_stmt|;
else|else
name|tfd
operator|=
operator|(
name|ATA_E_ABORT
operator|<<
literal|8
operator|)
operator||
name|ATA_S_READY
operator||
name|ATA_S_ERROR
expr_stmt|;
if|if
condition|(
name|ncq
condition|)
name|ahci_write_fis_sdb
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|,
name|tfd
argument_list|)
expr_stmt|;
else|else
name|ahci_write_fis_d2h
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|,
name|tfd
argument_list|)
expr_stmt|;
comment|/* 	 * This command is now complete. 	 */
name|p
operator|->
name|pending
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|slot
operator|)
expr_stmt|;
name|ahci_check_stopped
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|out
label|:
name|pthread_mutex_unlock
argument_list|(
operator|&
name|sc
operator|->
name|mtx
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"%s exit\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|atapi_ioreq_cb
parameter_list|(
name|struct
name|blockif_req
modifier|*
name|br
parameter_list|,
name|int
name|err
parameter_list|)
block|{
name|struct
name|ahci_cmd_hdr
modifier|*
name|hdr
decl_stmt|;
name|struct
name|ahci_ioreq
modifier|*
name|aior
decl_stmt|;
name|struct
name|ahci_port
modifier|*
name|p
decl_stmt|;
name|struct
name|pci_ahci_softc
modifier|*
name|sc
decl_stmt|;
name|uint8_t
modifier|*
name|cfis
decl_stmt|;
name|uint32_t
name|tfd
decl_stmt|;
name|int
name|slot
decl_stmt|;
name|DPRINTF
argument_list|(
literal|"%s %d\n"
argument_list|,
name|__func__
argument_list|,
name|err
argument_list|)
expr_stmt|;
name|aior
operator|=
name|br
operator|->
name|br_param
expr_stmt|;
name|p
operator|=
name|aior
operator|->
name|io_pr
expr_stmt|;
name|cfis
operator|=
name|aior
operator|->
name|cfis
expr_stmt|;
name|slot
operator|=
name|aior
operator|->
name|slot
expr_stmt|;
name|sc
operator|=
name|p
operator|->
name|pr_sc
expr_stmt|;
name|hdr
operator|=
operator|(
expr|struct
name|ahci_cmd_hdr
operator|*
operator|)
operator|(
name|p
operator|->
name|cmd_lst
operator|+
name|aior
operator|->
name|slot
operator|*
name|AHCI_CL_SIZE
operator|)
expr_stmt|;
name|pthread_mutex_lock
argument_list|(
operator|&
name|sc
operator|->
name|mtx
argument_list|)
expr_stmt|;
comment|/* 	 * Delete the blockif request from the busy list 	 */
name|TAILQ_REMOVE
argument_list|(
operator|&
name|p
operator|->
name|iobhd
argument_list|,
name|aior
argument_list|,
name|io_blist
argument_list|)
expr_stmt|;
comment|/* 	 * Move the blockif request back to the free list 	 */
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|p
operator|->
name|iofhd
argument_list|,
name|aior
argument_list|,
name|io_flist
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|err
condition|)
name|hdr
operator|->
name|prdbc
operator|=
name|aior
operator|->
name|done
expr_stmt|;
if|if
condition|(
operator|!
name|err
operator|&&
name|aior
operator|->
name|more
condition|)
block|{
name|atapi_read
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|,
name|aior
operator|->
name|done
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
operator|!
name|err
condition|)
block|{
name|tfd
operator|=
name|ATA_S_READY
operator||
name|ATA_S_DSC
expr_stmt|;
block|}
else|else
block|{
name|p
operator|->
name|sense_key
operator|=
name|ATA_SENSE_ILLEGAL_REQUEST
expr_stmt|;
name|p
operator|->
name|asc
operator|=
literal|0x21
expr_stmt|;
name|tfd
operator|=
operator|(
name|p
operator|->
name|sense_key
operator|<<
literal|12
operator|)
operator||
name|ATA_S_READY
operator||
name|ATA_S_ERROR
expr_stmt|;
block|}
name|cfis
index|[
literal|4
index|]
operator|=
operator|(
name|cfis
index|[
literal|4
index|]
operator|&
operator|~
literal|7
operator|)
operator||
name|ATA_I_CMD
operator||
name|ATA_I_IN
expr_stmt|;
name|ahci_write_fis_d2h
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|cfis
argument_list|,
name|tfd
argument_list|)
expr_stmt|;
comment|/* 	 * This command is now complete. 	 */
name|p
operator|->
name|pending
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|slot
operator|)
expr_stmt|;
name|ahci_check_stopped
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|out
label|:
name|pthread_mutex_unlock
argument_list|(
operator|&
name|sc
operator|->
name|mtx
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"%s exit\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|pci_ahci_ioreq_init
parameter_list|(
name|struct
name|ahci_port
modifier|*
name|pr
parameter_list|)
block|{
name|struct
name|ahci_ioreq
modifier|*
name|vr
decl_stmt|;
name|int
name|i
decl_stmt|;
name|pr
operator|->
name|ioqsz
operator|=
name|blockif_queuesz
argument_list|(
name|pr
operator|->
name|bctx
argument_list|)
expr_stmt|;
name|pr
operator|->
name|ioreq
operator|=
name|calloc
argument_list|(
name|pr
operator|->
name|ioqsz
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ahci_ioreq
argument_list|)
argument_list|)
expr_stmt|;
name|STAILQ_INIT
argument_list|(
operator|&
name|pr
operator|->
name|iofhd
argument_list|)
expr_stmt|;
comment|/* 	 * Add all i/o request entries to the free queue 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pr
operator|->
name|ioqsz
condition|;
name|i
operator|++
control|)
block|{
name|vr
operator|=
operator|&
name|pr
operator|->
name|ioreq
index|[
name|i
index|]
expr_stmt|;
name|vr
operator|->
name|io_pr
operator|=
name|pr
expr_stmt|;
if|if
condition|(
operator|!
name|pr
operator|->
name|atapi
condition|)
name|vr
operator|->
name|io_req
operator|.
name|br_callback
operator|=
name|ata_ioreq_cb
expr_stmt|;
else|else
name|vr
operator|->
name|io_req
operator|.
name|br_callback
operator|=
name|atapi_ioreq_cb
expr_stmt|;
name|vr
operator|->
name|io_req
operator|.
name|br_param
operator|=
name|vr
expr_stmt|;
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|pr
operator|->
name|iofhd
argument_list|,
name|vr
argument_list|,
name|io_flist
argument_list|)
expr_stmt|;
block|}
name|TAILQ_INIT
argument_list|(
operator|&
name|pr
operator|->
name|iobhd
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|pci_ahci_port_write
parameter_list|(
name|struct
name|pci_ahci_softc
modifier|*
name|sc
parameter_list|,
name|uint64_t
name|offset
parameter_list|,
name|uint64_t
name|value
parameter_list|)
block|{
name|int
name|port
init|=
operator|(
name|offset
operator|-
name|AHCI_OFFSET
operator|)
operator|/
name|AHCI_STEP
decl_stmt|;
name|offset
operator|=
operator|(
name|offset
operator|-
name|AHCI_OFFSET
operator|)
operator|%
name|AHCI_STEP
expr_stmt|;
name|struct
name|ahci_port
modifier|*
name|p
init|=
operator|&
name|sc
operator|->
name|port
index|[
name|port
index|]
decl_stmt|;
name|DPRINTF
argument_list|(
literal|"pci_ahci_port %d: write offset 0x%"
name|PRIx64
literal|" value 0x%"
name|PRIx64
literal|"\n"
argument_list|,
name|port
argument_list|,
name|offset
argument_list|,
name|value
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|offset
condition|)
block|{
case|case
name|AHCI_P_CLB
case|:
name|p
operator|->
name|clb
operator|=
name|value
expr_stmt|;
break|break;
case|case
name|AHCI_P_CLBU
case|:
name|p
operator|->
name|clbu
operator|=
name|value
expr_stmt|;
break|break;
case|case
name|AHCI_P_FB
case|:
name|p
operator|->
name|fb
operator|=
name|value
expr_stmt|;
break|break;
case|case
name|AHCI_P_FBU
case|:
name|p
operator|->
name|fbu
operator|=
name|value
expr_stmt|;
break|break;
case|case
name|AHCI_P_IS
case|:
name|p
operator|->
name|is
operator|&=
operator|~
name|value
expr_stmt|;
break|break;
case|case
name|AHCI_P_IE
case|:
name|p
operator|->
name|ie
operator|=
name|value
operator|&
literal|0xFDC000FF
expr_stmt|;
name|ahci_generate_intr
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
case|case
name|AHCI_P_CMD
case|:
block|{
name|p
operator|->
name|cmd
operator|=
name|value
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|value
operator|&
name|AHCI_P_CMD_ST
operator|)
condition|)
block|{
name|ahci_port_stop
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|uint64_t
name|clb
decl_stmt|;
name|p
operator|->
name|cmd
operator||=
name|AHCI_P_CMD_CR
expr_stmt|;
name|clb
operator|=
operator|(
name|uint64_t
operator|)
name|p
operator|->
name|clbu
operator|<<
literal|32
operator||
name|p
operator|->
name|clb
expr_stmt|;
name|p
operator|->
name|cmd_lst
operator|=
name|paddr_guest2host
argument_list|(
name|ahci_ctx
argument_list|(
name|sc
argument_list|)
argument_list|,
name|clb
argument_list|,
name|AHCI_CL_SIZE
operator|*
name|AHCI_MAX_SLOTS
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|value
operator|&
name|AHCI_P_CMD_FRE
condition|)
block|{
name|uint64_t
name|fb
decl_stmt|;
name|p
operator|->
name|cmd
operator||=
name|AHCI_P_CMD_FR
expr_stmt|;
name|fb
operator|=
operator|(
name|uint64_t
operator|)
name|p
operator|->
name|fbu
operator|<<
literal|32
operator||
name|p
operator|->
name|fb
expr_stmt|;
comment|/* we don't support FBSCP, so rfis size is 256Bytes */
name|p
operator|->
name|rfis
operator|=
name|paddr_guest2host
argument_list|(
name|ahci_ctx
argument_list|(
name|sc
argument_list|)
argument_list|,
name|fb
argument_list|,
literal|256
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|p
operator|->
name|cmd
operator|&=
operator|~
name|AHCI_P_CMD_FR
expr_stmt|;
block|}
if|if
condition|(
name|value
operator|&
name|AHCI_P_CMD_CLO
condition|)
block|{
name|p
operator|->
name|tfd
operator|=
literal|0
expr_stmt|;
name|p
operator|->
name|cmd
operator|&=
operator|~
name|AHCI_P_CMD_CLO
expr_stmt|;
block|}
name|ahci_handle_port
argument_list|(
name|p
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|AHCI_P_TFD
case|:
case|case
name|AHCI_P_SIG
case|:
case|case
name|AHCI_P_SSTS
case|:
name|WPRINTF
argument_list|(
literal|"pci_ahci_port: read only registers 0x%"
name|PRIx64
literal|"\n"
argument_list|,
name|offset
argument_list|)
expr_stmt|;
break|break;
case|case
name|AHCI_P_SCTL
case|:
name|p
operator|->
name|sctl
operator|=
name|value
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|p
operator|->
name|cmd
operator|&
name|AHCI_P_CMD_ST
operator|)
condition|)
block|{
if|if
condition|(
name|value
operator|&
name|ATA_SC_DET_RESET
condition|)
name|ahci_port_reset
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|AHCI_P_SERR
case|:
name|p
operator|->
name|serr
operator|&=
operator|~
name|value
expr_stmt|;
break|break;
case|case
name|AHCI_P_SACT
case|:
name|p
operator|->
name|sact
operator||=
name|value
expr_stmt|;
break|break;
case|case
name|AHCI_P_CI
case|:
name|p
operator|->
name|ci
operator||=
name|value
expr_stmt|;
name|ahci_handle_port
argument_list|(
name|p
argument_list|)
expr_stmt|;
break|break;
case|case
name|AHCI_P_SNTF
case|:
case|case
name|AHCI_P_FBS
case|:
default|default:
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|pci_ahci_host_write
parameter_list|(
name|struct
name|pci_ahci_softc
modifier|*
name|sc
parameter_list|,
name|uint64_t
name|offset
parameter_list|,
name|uint64_t
name|value
parameter_list|)
block|{
name|DPRINTF
argument_list|(
literal|"pci_ahci_host: write offset 0x%"
name|PRIx64
literal|" value 0x%"
name|PRIx64
literal|"\n"
argument_list|,
name|offset
argument_list|,
name|value
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|offset
condition|)
block|{
case|case
name|AHCI_CAP
case|:
case|case
name|AHCI_PI
case|:
case|case
name|AHCI_VS
case|:
case|case
name|AHCI_CAP2
case|:
name|DPRINTF
argument_list|(
literal|"pci_ahci_host: read only registers 0x%"
name|PRIx64
literal|"\n"
argument_list|,
name|offset
argument_list|)
expr_stmt|;
break|break;
case|case
name|AHCI_GHC
case|:
if|if
condition|(
name|value
operator|&
name|AHCI_GHC_HR
condition|)
name|ahci_reset
argument_list|(
name|sc
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|value
operator|&
name|AHCI_GHC_IE
condition|)
block|{
name|sc
operator|->
name|ghc
operator||=
name|AHCI_GHC_IE
expr_stmt|;
name|ahci_generate_intr
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|AHCI_IS
case|:
name|sc
operator|->
name|is
operator|&=
operator|~
name|value
expr_stmt|;
name|ahci_generate_intr
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|pci_ahci_write
parameter_list|(
name|struct
name|vmctx
modifier|*
name|ctx
parameter_list|,
name|int
name|vcpu
parameter_list|,
name|struct
name|pci_devinst
modifier|*
name|pi
parameter_list|,
name|int
name|baridx
parameter_list|,
name|uint64_t
name|offset
parameter_list|,
name|int
name|size
parameter_list|,
name|uint64_t
name|value
parameter_list|)
block|{
name|struct
name|pci_ahci_softc
modifier|*
name|sc
init|=
name|pi
operator|->
name|pi_arg
decl_stmt|;
name|assert
argument_list|(
name|baridx
operator|==
literal|5
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|size
operator|==
literal|4
argument_list|)
expr_stmt|;
name|pthread_mutex_lock
argument_list|(
operator|&
name|sc
operator|->
name|mtx
argument_list|)
expr_stmt|;
if|if
condition|(
name|offset
operator|<
name|AHCI_OFFSET
condition|)
name|pci_ahci_host_write
argument_list|(
name|sc
argument_list|,
name|offset
argument_list|,
name|value
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|offset
operator|<
name|AHCI_OFFSET
operator|+
name|sc
operator|->
name|ports
operator|*
name|AHCI_STEP
condition|)
name|pci_ahci_port_write
argument_list|(
name|sc
argument_list|,
name|offset
argument_list|,
name|value
argument_list|)
expr_stmt|;
else|else
name|WPRINTF
argument_list|(
literal|"pci_ahci: unknown i/o write offset 0x%"
name|PRIx64
literal|"\n"
argument_list|,
name|offset
argument_list|)
expr_stmt|;
name|pthread_mutex_unlock
argument_list|(
operator|&
name|sc
operator|->
name|mtx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|uint64_t
name|pci_ahci_host_read
parameter_list|(
name|struct
name|pci_ahci_softc
modifier|*
name|sc
parameter_list|,
name|uint64_t
name|offset
parameter_list|)
block|{
name|uint32_t
name|value
decl_stmt|;
switch|switch
condition|(
name|offset
condition|)
block|{
case|case
name|AHCI_CAP
case|:
case|case
name|AHCI_GHC
case|:
case|case
name|AHCI_IS
case|:
case|case
name|AHCI_PI
case|:
case|case
name|AHCI_VS
case|:
case|case
name|AHCI_CCCC
case|:
case|case
name|AHCI_CCCP
case|:
case|case
name|AHCI_EM_LOC
case|:
case|case
name|AHCI_EM_CTL
case|:
case|case
name|AHCI_CAP2
case|:
block|{
name|uint32_t
modifier|*
name|p
init|=
operator|&
name|sc
operator|->
name|cap
decl_stmt|;
name|p
operator|+=
operator|(
name|offset
operator|-
name|AHCI_CAP
operator|)
operator|/
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
name|value
operator|=
operator|*
name|p
expr_stmt|;
break|break;
block|}
default|default:
name|value
operator|=
literal|0
expr_stmt|;
break|break;
block|}
name|DPRINTF
argument_list|(
literal|"pci_ahci_host: read offset 0x%"
name|PRIx64
literal|" value 0x%x\n"
argument_list|,
name|offset
argument_list|,
name|value
argument_list|)
expr_stmt|;
return|return
operator|(
name|value
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint64_t
name|pci_ahci_port_read
parameter_list|(
name|struct
name|pci_ahci_softc
modifier|*
name|sc
parameter_list|,
name|uint64_t
name|offset
parameter_list|)
block|{
name|uint32_t
name|value
decl_stmt|;
name|int
name|port
init|=
operator|(
name|offset
operator|-
name|AHCI_OFFSET
operator|)
operator|/
name|AHCI_STEP
decl_stmt|;
name|offset
operator|=
operator|(
name|offset
operator|-
name|AHCI_OFFSET
operator|)
operator|%
name|AHCI_STEP
expr_stmt|;
switch|switch
condition|(
name|offset
condition|)
block|{
case|case
name|AHCI_P_CLB
case|:
case|case
name|AHCI_P_CLBU
case|:
case|case
name|AHCI_P_FB
case|:
case|case
name|AHCI_P_FBU
case|:
case|case
name|AHCI_P_IS
case|:
case|case
name|AHCI_P_IE
case|:
case|case
name|AHCI_P_CMD
case|:
case|case
name|AHCI_P_TFD
case|:
case|case
name|AHCI_P_SIG
case|:
case|case
name|AHCI_P_SSTS
case|:
case|case
name|AHCI_P_SCTL
case|:
case|case
name|AHCI_P_SERR
case|:
case|case
name|AHCI_P_SACT
case|:
case|case
name|AHCI_P_CI
case|:
case|case
name|AHCI_P_SNTF
case|:
case|case
name|AHCI_P_FBS
case|:
block|{
name|uint32_t
modifier|*
name|p
init|=
operator|&
name|sc
operator|->
name|port
index|[
name|port
index|]
operator|.
name|clb
decl_stmt|;
name|p
operator|+=
operator|(
name|offset
operator|-
name|AHCI_P_CLB
operator|)
operator|/
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
name|value
operator|=
operator|*
name|p
expr_stmt|;
break|break;
block|}
default|default:
name|value
operator|=
literal|0
expr_stmt|;
break|break;
block|}
name|DPRINTF
argument_list|(
literal|"pci_ahci_port %d: read offset 0x%"
name|PRIx64
literal|" value 0x%x\n"
argument_list|,
name|port
argument_list|,
name|offset
argument_list|,
name|value
argument_list|)
expr_stmt|;
return|return
name|value
return|;
block|}
end_function

begin_function
specifier|static
name|uint64_t
name|pci_ahci_read
parameter_list|(
name|struct
name|vmctx
modifier|*
name|ctx
parameter_list|,
name|int
name|vcpu
parameter_list|,
name|struct
name|pci_devinst
modifier|*
name|pi
parameter_list|,
name|int
name|baridx
parameter_list|,
name|uint64_t
name|offset
parameter_list|,
name|int
name|size
parameter_list|)
block|{
name|struct
name|pci_ahci_softc
modifier|*
name|sc
init|=
name|pi
operator|->
name|pi_arg
decl_stmt|;
name|uint32_t
name|value
decl_stmt|;
name|assert
argument_list|(
name|baridx
operator|==
literal|5
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|size
operator|==
literal|4
argument_list|)
expr_stmt|;
name|pthread_mutex_lock
argument_list|(
operator|&
name|sc
operator|->
name|mtx
argument_list|)
expr_stmt|;
if|if
condition|(
name|offset
operator|<
name|AHCI_OFFSET
condition|)
name|value
operator|=
name|pci_ahci_host_read
argument_list|(
name|sc
argument_list|,
name|offset
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|offset
operator|<
name|AHCI_OFFSET
operator|+
name|sc
operator|->
name|ports
operator|*
name|AHCI_STEP
condition|)
name|value
operator|=
name|pci_ahci_port_read
argument_list|(
name|sc
argument_list|,
name|offset
argument_list|)
expr_stmt|;
else|else
block|{
name|value
operator|=
literal|0
expr_stmt|;
name|WPRINTF
argument_list|(
literal|"pci_ahci: unknown i/o read offset 0x%"
name|PRIx64
literal|"\n"
argument_list|,
name|offset
argument_list|)
expr_stmt|;
block|}
name|pthread_mutex_unlock
argument_list|(
operator|&
name|sc
operator|->
name|mtx
argument_list|)
expr_stmt|;
return|return
operator|(
name|value
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|pci_ahci_init
parameter_list|(
name|struct
name|vmctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|pci_devinst
modifier|*
name|pi
parameter_list|,
name|char
modifier|*
name|opts
parameter_list|,
name|int
name|atapi
parameter_list|)
block|{
name|char
name|bident
index|[
sizeof|sizeof
argument_list|(
literal|"XX:X:X"
argument_list|)
index|]
decl_stmt|;
name|struct
name|blockif_ctxt
modifier|*
name|bctxt
decl_stmt|;
name|struct
name|pci_ahci_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|ret
decl_stmt|,
name|slots
decl_stmt|;
name|MD5_CTX
name|mdctx
decl_stmt|;
name|u_char
name|digest
index|[
literal|16
index|]
decl_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|opts
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"pci_ahci: backing device required\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
ifdef|#
directive|ifdef
name|AHCI_DEBUG
name|dbg
operator|=
name|fopen
argument_list|(
literal|"/tmp/log"
argument_list|,
literal|"w+"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|sc
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|pci_ahci_softc
argument_list|)
argument_list|)
expr_stmt|;
name|pi
operator|->
name|pi_arg
operator|=
name|sc
expr_stmt|;
name|sc
operator|->
name|asc_pi
operator|=
name|pi
expr_stmt|;
name|sc
operator|->
name|ports
operator|=
name|MAX_PORTS
expr_stmt|;
comment|/* 	 * Only use port 0 for a backing device. All other ports will be 	 * marked as unused 	 */
name|sc
operator|->
name|port
index|[
literal|0
index|]
operator|.
name|atapi
operator|=
name|atapi
expr_stmt|;
comment|/* 	 * Attempt to open the backing image. Use the PCI 	 * slot/func for the identifier string. 	 */
name|snprintf
argument_list|(
name|bident
argument_list|,
sizeof|sizeof
argument_list|(
name|bident
argument_list|)
argument_list|,
literal|"%d:%d"
argument_list|,
name|pi
operator|->
name|pi_slot
argument_list|,
name|pi
operator|->
name|pi_func
argument_list|)
expr_stmt|;
name|bctxt
operator|=
name|blockif_open
argument_list|(
name|opts
argument_list|,
name|bident
argument_list|)
expr_stmt|;
if|if
condition|(
name|bctxt
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
literal|1
expr_stmt|;
goto|goto
name|open_fail
goto|;
block|}
name|sc
operator|->
name|port
index|[
literal|0
index|]
operator|.
name|bctx
operator|=
name|bctxt
expr_stmt|;
name|sc
operator|->
name|port
index|[
literal|0
index|]
operator|.
name|pr_sc
operator|=
name|sc
expr_stmt|;
comment|/* 	 * Create an identifier for the backing file. Use parts of the 	 * md5 sum of the filename 	 */
name|MD5Init
argument_list|(
operator|&
name|mdctx
argument_list|)
expr_stmt|;
name|MD5Update
argument_list|(
operator|&
name|mdctx
argument_list|,
name|opts
argument_list|,
name|strlen
argument_list|(
name|opts
argument_list|)
argument_list|)
expr_stmt|;
name|MD5Final
argument_list|(
name|digest
argument_list|,
operator|&
name|mdctx
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|sc
operator|->
name|port
index|[
literal|0
index|]
operator|.
name|ident
argument_list|,
literal|"BHYVE-%02X%02X-%02X%02X-%02X%02X"
argument_list|,
name|digest
index|[
literal|0
index|]
argument_list|,
name|digest
index|[
literal|1
index|]
argument_list|,
name|digest
index|[
literal|2
index|]
argument_list|,
name|digest
index|[
literal|3
index|]
argument_list|,
name|digest
index|[
literal|4
index|]
argument_list|,
name|digest
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
comment|/* 	 * Allocate blockif request structures and add them 	 * to the free list 	 */
name|pci_ahci_ioreq_init
argument_list|(
operator|&
name|sc
operator|->
name|port
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|pthread_mutex_init
argument_list|(
operator|&
name|sc
operator|->
name|mtx
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* Intel ICH8 AHCI */
name|slots
operator|=
name|sc
operator|->
name|port
index|[
literal|0
index|]
operator|.
name|ioqsz
expr_stmt|;
if|if
condition|(
name|slots
operator|>
literal|32
condition|)
name|slots
operator|=
literal|32
expr_stmt|;
operator|--
name|slots
expr_stmt|;
name|sc
operator|->
name|cap
operator|=
name|AHCI_CAP_64BIT
operator||
name|AHCI_CAP_SNCQ
operator||
name|AHCI_CAP_SSNTF
operator||
name|AHCI_CAP_SMPS
operator||
name|AHCI_CAP_SSS
operator||
name|AHCI_CAP_SALP
operator||
name|AHCI_CAP_SAL
operator||
name|AHCI_CAP_SCLO
operator||
operator|(
literal|0x3
operator|<<
name|AHCI_CAP_ISS_SHIFT
operator|)
operator||
name|AHCI_CAP_PMD
operator||
name|AHCI_CAP_SSC
operator||
name|AHCI_CAP_PSC
operator||
operator|(
name|slots
operator|<<
name|AHCI_CAP_NCS_SHIFT
operator|)
operator||
name|AHCI_CAP_SXS
operator||
operator|(
name|sc
operator|->
name|ports
operator|-
literal|1
operator|)
expr_stmt|;
comment|/* Only port 0 implemented */
name|sc
operator|->
name|pi
operator|=
literal|1
expr_stmt|;
name|sc
operator|->
name|vs
operator|=
literal|0x10300
expr_stmt|;
name|sc
operator|->
name|cap2
operator|=
name|AHCI_CAP2_APST
expr_stmt|;
name|ahci_reset
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|pci_set_cfgdata16
argument_list|(
name|pi
argument_list|,
name|PCIR_DEVICE
argument_list|,
literal|0x2821
argument_list|)
expr_stmt|;
name|pci_set_cfgdata16
argument_list|(
name|pi
argument_list|,
name|PCIR_VENDOR
argument_list|,
literal|0x8086
argument_list|)
expr_stmt|;
name|pci_set_cfgdata8
argument_list|(
name|pi
argument_list|,
name|PCIR_CLASS
argument_list|,
name|PCIC_STORAGE
argument_list|)
expr_stmt|;
name|pci_set_cfgdata8
argument_list|(
name|pi
argument_list|,
name|PCIR_SUBCLASS
argument_list|,
name|PCIS_STORAGE_SATA
argument_list|)
expr_stmt|;
name|pci_set_cfgdata8
argument_list|(
name|pi
argument_list|,
name|PCIR_PROGIF
argument_list|,
name|PCIP_STORAGE_SATA_AHCI_1_0
argument_list|)
expr_stmt|;
name|pci_emul_add_msicap
argument_list|(
name|pi
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pci_emul_alloc_bar
argument_list|(
name|pi
argument_list|,
literal|5
argument_list|,
name|PCIBAR_MEM32
argument_list|,
name|AHCI_OFFSET
operator|+
name|sc
operator|->
name|ports
operator|*
name|AHCI_STEP
argument_list|)
expr_stmt|;
name|pci_lintr_request
argument_list|(
name|pi
argument_list|)
expr_stmt|;
name|open_fail
label|:
if|if
condition|(
name|ret
condition|)
block|{
name|blockif_close
argument_list|(
name|sc
operator|->
name|port
index|[
literal|0
index|]
operator|.
name|bctx
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|pci_ahci_hd_init
parameter_list|(
name|struct
name|vmctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|pci_devinst
modifier|*
name|pi
parameter_list|,
name|char
modifier|*
name|opts
parameter_list|)
block|{
return|return
operator|(
name|pci_ahci_init
argument_list|(
name|ctx
argument_list|,
name|pi
argument_list|,
name|opts
argument_list|,
literal|0
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|pci_ahci_atapi_init
parameter_list|(
name|struct
name|vmctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|pci_devinst
modifier|*
name|pi
parameter_list|,
name|char
modifier|*
name|opts
parameter_list|)
block|{
return|return
operator|(
name|pci_ahci_init
argument_list|(
name|ctx
argument_list|,
name|pi
argument_list|,
name|opts
argument_list|,
literal|1
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Use separate emulation names to distinguish drive and atapi devices  */
end_comment

begin_decl_stmt
name|struct
name|pci_devemu
name|pci_de_ahci_hd
init|=
block|{
operator|.
name|pe_emu
operator|=
literal|"ahci-hd"
block|,
operator|.
name|pe_init
operator|=
name|pci_ahci_hd_init
block|,
operator|.
name|pe_barwrite
operator|=
name|pci_ahci_write
block|,
operator|.
name|pe_barread
operator|=
name|pci_ahci_read
block|}
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|PCI_EMUL_SET
argument_list|(
name|pci_de_ahci_hd
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|struct
name|pci_devemu
name|pci_de_ahci_cd
init|=
block|{
operator|.
name|pe_emu
operator|=
literal|"ahci-cd"
block|,
operator|.
name|pe_init
operator|=
name|pci_ahci_atapi_init
block|,
operator|.
name|pe_barwrite
operator|=
name|pci_ahci_write
block|,
operator|.
name|pe_barread
operator|=
name|pci_ahci_read
block|}
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|PCI_EMUL_SET
argument_list|(
name|pci_de_ahci_cd
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


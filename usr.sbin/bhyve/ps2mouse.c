begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2015 Tycho Nightingale<tycho.nightingale@pluribusnetworks.com>  * Copyright (c) 2015 Nahanni Systems Inc.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<assert.h>
end_include

begin_include
include|#
directive|include
file|<stdbool.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<strings.h>
end_include

begin_include
include|#
directive|include
file|<pthread.h>
end_include

begin_include
include|#
directive|include
file|<pthread_np.h>
end_include

begin_include
include|#
directive|include
file|"atkbdc.h"
end_include

begin_include
include|#
directive|include
file|"console.h"
end_include

begin_comment
comment|/* mouse device commands */
end_comment

begin_define
define|#
directive|define
name|PS2MC_RESET_DEV
value|0xff
end_define

begin_define
define|#
directive|define
name|PS2MC_SET_DEFAULTS
value|0xf6
end_define

begin_define
define|#
directive|define
name|PS2MC_DISABLE
value|0xf5
end_define

begin_define
define|#
directive|define
name|PS2MC_ENABLE
value|0xf4
end_define

begin_define
define|#
directive|define
name|PS2MC_SET_SAMPLING_RATE
value|0xf3
end_define

begin_define
define|#
directive|define
name|PS2MC_SEND_DEV_ID
value|0xf2
end_define

begin_define
define|#
directive|define
name|PS2MC_SET_REMOTE_MODE
value|0xf0
end_define

begin_define
define|#
directive|define
name|PS2MC_SEND_DEV_DATA
value|0xeb
end_define

begin_define
define|#
directive|define
name|PS2MC_SET_STREAM_MODE
value|0xea
end_define

begin_define
define|#
directive|define
name|PS2MC_SEND_DEV_STATUS
value|0xe9
end_define

begin_define
define|#
directive|define
name|PS2MC_SET_RESOLUTION
value|0xe8
end_define

begin_define
define|#
directive|define
name|PS2MC_SET_SCALING1
value|0xe7
end_define

begin_define
define|#
directive|define
name|PS2MC_SET_SCALING2
value|0xe6
end_define

begin_define
define|#
directive|define
name|PS2MC_BAT_SUCCESS
value|0xaa
end_define

begin_define
define|#
directive|define
name|PS2MC_ACK
value|0xfa
end_define

begin_comment
comment|/* mouse device id */
end_comment

begin_define
define|#
directive|define
name|PS2MOUSE_DEV_ID
value|0x0
end_define

begin_comment
comment|/* mouse data bits */
end_comment

begin_define
define|#
directive|define
name|PS2M_DATA_Y_OFLOW
value|0x80
end_define

begin_define
define|#
directive|define
name|PS2M_DATA_X_OFLOW
value|0x40
end_define

begin_define
define|#
directive|define
name|PS2M_DATA_Y_SIGN
value|0x20
end_define

begin_define
define|#
directive|define
name|PS2M_DATA_X_SIGN
value|0x10
end_define

begin_define
define|#
directive|define
name|PS2M_DATA_AONE
value|0x08
end_define

begin_define
define|#
directive|define
name|PS2M_DATA_MID_BUTTON
value|0x04
end_define

begin_define
define|#
directive|define
name|PS2M_DATA_RIGHT_BUTTON
value|0x02
end_define

begin_define
define|#
directive|define
name|PS2M_DATA_LEFT_BUTTON
value|0x01
end_define

begin_comment
comment|/* mouse status bits */
end_comment

begin_define
define|#
directive|define
name|PS2M_STS_REMOTE_MODE
value|0x40
end_define

begin_define
define|#
directive|define
name|PS2M_STS_ENABLE_DEV
value|0x20
end_define

begin_define
define|#
directive|define
name|PS2M_STS_SCALING_21
value|0x10
end_define

begin_define
define|#
directive|define
name|PS2M_STS_MID_BUTTON
value|0x04
end_define

begin_define
define|#
directive|define
name|PS2M_STS_RIGHT_BUTTON
value|0x02
end_define

begin_define
define|#
directive|define
name|PS2M_STS_LEFT_BUTTON
value|0x01
end_define

begin_define
define|#
directive|define
name|PS2MOUSE_FIFOSZ
value|16
end_define

begin_struct
struct|struct
name|fifo
block|{
name|uint8_t
name|buf
index|[
name|PS2MOUSE_FIFOSZ
index|]
decl_stmt|;
name|int
name|rindex
decl_stmt|;
comment|/* index to read from */
name|int
name|windex
decl_stmt|;
comment|/* index to write to */
name|int
name|num
decl_stmt|;
comment|/* number of bytes in the fifo */
name|int
name|size
decl_stmt|;
comment|/* size of the fifo */
block|}
struct|;
end_struct

begin_struct
struct|struct
name|ps2mouse_softc
block|{
name|struct
name|atkbdc_softc
modifier|*
name|atkbdc_sc
decl_stmt|;
name|pthread_mutex_t
name|mtx
decl_stmt|;
name|uint8_t
name|status
decl_stmt|;
name|uint8_t
name|resolution
decl_stmt|;
name|uint8_t
name|sampling_rate
decl_stmt|;
name|int
name|ctrlenable
decl_stmt|;
name|struct
name|fifo
name|fifo
decl_stmt|;
name|uint8_t
name|curcmd
decl_stmt|;
comment|/* current command for next byte */
name|int
name|cur_x
decl_stmt|,
name|cur_y
decl_stmt|;
name|int
name|delta_x
decl_stmt|,
name|delta_y
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
name|fifo_init
parameter_list|(
name|struct
name|ps2mouse_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|fifo
modifier|*
name|fifo
decl_stmt|;
name|fifo
operator|=
operator|&
name|sc
operator|->
name|fifo
expr_stmt|;
name|fifo
operator|->
name|size
operator|=
sizeof|sizeof
argument_list|(
operator|(
operator|(
expr|struct
name|fifo
operator|*
operator|)
literal|0
operator|)
operator|->
name|buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|fifo_reset
parameter_list|(
name|struct
name|ps2mouse_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|fifo
modifier|*
name|fifo
decl_stmt|;
name|fifo
operator|=
operator|&
name|sc
operator|->
name|fifo
expr_stmt|;
name|bzero
argument_list|(
name|fifo
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|fifo
argument_list|)
argument_list|)
expr_stmt|;
name|fifo
operator|->
name|size
operator|=
sizeof|sizeof
argument_list|(
operator|(
operator|(
expr|struct
name|fifo
operator|*
operator|)
literal|0
operator|)
operator|->
name|buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|fifo_put
parameter_list|(
name|struct
name|ps2mouse_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|val
parameter_list|)
block|{
name|struct
name|fifo
modifier|*
name|fifo
decl_stmt|;
name|fifo
operator|=
operator|&
name|sc
operator|->
name|fifo
expr_stmt|;
if|if
condition|(
name|fifo
operator|->
name|num
operator|<
name|fifo
operator|->
name|size
condition|)
block|{
name|fifo
operator|->
name|buf
index|[
name|fifo
operator|->
name|windex
index|]
operator|=
name|val
expr_stmt|;
name|fifo
operator|->
name|windex
operator|=
operator|(
name|fifo
operator|->
name|windex
operator|+
literal|1
operator|)
operator|%
name|fifo
operator|->
name|size
expr_stmt|;
name|fifo
operator|->
name|num
operator|++
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|fifo_get
parameter_list|(
name|struct
name|ps2mouse_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
modifier|*
name|val
parameter_list|)
block|{
name|struct
name|fifo
modifier|*
name|fifo
decl_stmt|;
name|fifo
operator|=
operator|&
name|sc
operator|->
name|fifo
expr_stmt|;
if|if
condition|(
name|fifo
operator|->
name|num
operator|>
literal|0
condition|)
block|{
operator|*
name|val
operator|=
name|fifo
operator|->
name|buf
index|[
name|fifo
operator|->
name|rindex
index|]
expr_stmt|;
name|fifo
operator|->
name|rindex
operator|=
operator|(
name|fifo
operator|->
name|rindex
operator|+
literal|1
operator|)
operator|%
name|fifo
operator|->
name|size
expr_stmt|;
name|fifo
operator|->
name|num
operator|--
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|movement_reset
parameter_list|(
name|struct
name|ps2mouse_softc
modifier|*
name|sc
parameter_list|)
block|{
name|assert
argument_list|(
name|pthread_mutex_isowned_np
argument_list|(
operator|&
name|sc
operator|->
name|mtx
argument_list|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|delta_x
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|delta_y
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|movement_update
parameter_list|(
name|struct
name|ps2mouse_softc
modifier|*
name|sc
parameter_list|,
name|int
name|x
parameter_list|,
name|int
name|y
parameter_list|)
block|{
name|sc
operator|->
name|delta_x
operator|+=
name|x
operator|-
name|sc
operator|->
name|cur_x
expr_stmt|;
name|sc
operator|->
name|delta_y
operator|+=
name|sc
operator|->
name|cur_y
operator|-
name|y
expr_stmt|;
name|sc
operator|->
name|cur_x
operator|=
name|x
expr_stmt|;
name|sc
operator|->
name|cur_y
operator|=
name|y
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|movement_get
parameter_list|(
name|struct
name|ps2mouse_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint8_t
name|val0
decl_stmt|,
name|val1
decl_stmt|,
name|val2
decl_stmt|;
name|assert
argument_list|(
name|pthread_mutex_isowned_np
argument_list|(
operator|&
name|sc
operator|->
name|mtx
argument_list|)
argument_list|)
expr_stmt|;
name|val0
operator|=
name|PS2M_DATA_AONE
expr_stmt|;
name|val0
operator||=
name|sc
operator|->
name|status
operator|&
operator|(
name|PS2M_DATA_LEFT_BUTTON
operator||
name|PS2M_DATA_RIGHT_BUTTON
operator||
name|PS2M_DATA_MID_BUTTON
operator|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|delta_x
operator|>=
literal|0
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|delta_x
operator|>
literal|255
condition|)
block|{
name|val0
operator||=
name|PS2M_DATA_X_OFLOW
expr_stmt|;
name|val1
operator|=
literal|255
expr_stmt|;
block|}
else|else
name|val1
operator|=
name|sc
operator|->
name|delta_x
expr_stmt|;
block|}
else|else
block|{
name|val0
operator||=
name|PS2M_DATA_X_SIGN
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|delta_x
operator|<
operator|-
literal|255
condition|)
block|{
name|val0
operator||=
name|PS2M_DATA_X_OFLOW
expr_stmt|;
name|val1
operator|=
literal|255
expr_stmt|;
block|}
else|else
name|val1
operator|=
name|sc
operator|->
name|delta_x
expr_stmt|;
block|}
name|sc
operator|->
name|delta_x
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|delta_y
operator|>=
literal|0
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|delta_y
operator|>
literal|255
condition|)
block|{
name|val0
operator||=
name|PS2M_DATA_Y_OFLOW
expr_stmt|;
name|val2
operator|=
literal|255
expr_stmt|;
block|}
else|else
name|val2
operator|=
name|sc
operator|->
name|delta_y
expr_stmt|;
block|}
else|else
block|{
name|val0
operator||=
name|PS2M_DATA_Y_SIGN
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|delta_y
operator|<
operator|-
literal|255
condition|)
block|{
name|val0
operator||=
name|PS2M_DATA_Y_OFLOW
expr_stmt|;
name|val2
operator|=
literal|255
expr_stmt|;
block|}
else|else
name|val2
operator|=
name|sc
operator|->
name|delta_y
expr_stmt|;
block|}
name|sc
operator|->
name|delta_y
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|fifo
operator|.
name|num
operator|<
operator|(
name|sc
operator|->
name|fifo
operator|.
name|size
operator|-
literal|3
operator|)
condition|)
block|{
name|fifo_put
argument_list|(
name|sc
argument_list|,
name|val0
argument_list|)
expr_stmt|;
name|fifo_put
argument_list|(
name|sc
argument_list|,
name|val1
argument_list|)
expr_stmt|;
name|fifo_put
argument_list|(
name|sc
argument_list|,
name|val2
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ps2mouse_reset
parameter_list|(
name|struct
name|ps2mouse_softc
modifier|*
name|sc
parameter_list|)
block|{
name|assert
argument_list|(
name|pthread_mutex_isowned_np
argument_list|(
operator|&
name|sc
operator|->
name|mtx
argument_list|)
argument_list|)
expr_stmt|;
name|fifo_reset
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|movement_reset
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|status
operator|=
name|PS2M_STS_ENABLE_DEV
expr_stmt|;
name|sc
operator|->
name|resolution
operator|=
literal|4
expr_stmt|;
name|sc
operator|->
name|sampling_rate
operator|=
literal|100
expr_stmt|;
name|sc
operator|->
name|cur_x
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|cur_y
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|delta_x
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|delta_y
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
name|int
name|ps2mouse_read
parameter_list|(
name|struct
name|ps2mouse_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
modifier|*
name|val
parameter_list|)
block|{
name|int
name|retval
decl_stmt|;
name|pthread_mutex_lock
argument_list|(
operator|&
name|sc
operator|->
name|mtx
argument_list|)
expr_stmt|;
name|retval
operator|=
name|fifo_get
argument_list|(
name|sc
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|pthread_mutex_unlock
argument_list|(
operator|&
name|sc
operator|->
name|mtx
argument_list|)
expr_stmt|;
return|return
operator|(
name|retval
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ps2mouse_fifocnt
parameter_list|(
name|struct
name|ps2mouse_softc
modifier|*
name|sc
parameter_list|)
block|{
return|return
operator|(
name|sc
operator|->
name|fifo
operator|.
name|num
operator|)
return|;
block|}
end_function

begin_function
name|void
name|ps2mouse_toggle
parameter_list|(
name|struct
name|ps2mouse_softc
modifier|*
name|sc
parameter_list|,
name|int
name|enable
parameter_list|)
block|{
name|pthread_mutex_lock
argument_list|(
operator|&
name|sc
operator|->
name|mtx
argument_list|)
expr_stmt|;
if|if
condition|(
name|enable
condition|)
name|sc
operator|->
name|ctrlenable
operator|=
literal|1
expr_stmt|;
else|else
block|{
name|sc
operator|->
name|ctrlenable
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|fifo
operator|.
name|rindex
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|fifo
operator|.
name|windex
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|fifo
operator|.
name|num
operator|=
literal|0
expr_stmt|;
block|}
name|pthread_mutex_unlock
argument_list|(
operator|&
name|sc
operator|->
name|mtx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ps2mouse_write
parameter_list|(
name|struct
name|ps2mouse_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|val
parameter_list|,
name|int
name|insert
parameter_list|)
block|{
name|pthread_mutex_lock
argument_list|(
operator|&
name|sc
operator|->
name|mtx
argument_list|)
expr_stmt|;
name|fifo_reset
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|curcmd
condition|)
block|{
switch|switch
condition|(
name|sc
operator|->
name|curcmd
condition|)
block|{
case|case
name|PS2MC_SET_SAMPLING_RATE
case|:
name|sc
operator|->
name|sampling_rate
operator|=
name|val
expr_stmt|;
name|fifo_put
argument_list|(
name|sc
argument_list|,
name|PS2MC_ACK
argument_list|)
expr_stmt|;
break|break;
case|case
name|PS2MC_SET_RESOLUTION
case|:
name|sc
operator|->
name|resolution
operator|=
name|val
expr_stmt|;
name|fifo_put
argument_list|(
name|sc
argument_list|,
name|PS2MC_ACK
argument_list|)
expr_stmt|;
break|break;
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Unhandled ps2 mouse current "
literal|"command byte 0x%02x\n"
argument_list|,
name|val
argument_list|)
expr_stmt|;
break|break;
block|}
name|sc
operator|->
name|curcmd
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|insert
condition|)
block|{
name|fifo_put
argument_list|(
name|sc
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
else|else
block|{
switch|switch
condition|(
name|val
condition|)
block|{
case|case
literal|0x00
case|:
name|fifo_put
argument_list|(
name|sc
argument_list|,
name|PS2MC_ACK
argument_list|)
expr_stmt|;
break|break;
case|case
name|PS2MC_RESET_DEV
case|:
name|ps2mouse_reset
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|fifo_put
argument_list|(
name|sc
argument_list|,
name|PS2MC_ACK
argument_list|)
expr_stmt|;
name|fifo_put
argument_list|(
name|sc
argument_list|,
name|PS2MC_BAT_SUCCESS
argument_list|)
expr_stmt|;
name|fifo_put
argument_list|(
name|sc
argument_list|,
name|PS2MOUSE_DEV_ID
argument_list|)
expr_stmt|;
break|break;
case|case
name|PS2MC_SET_DEFAULTS
case|:
name|ps2mouse_reset
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|fifo_put
argument_list|(
name|sc
argument_list|,
name|PS2MC_ACK
argument_list|)
expr_stmt|;
break|break;
case|case
name|PS2MC_DISABLE
case|:
name|fifo_reset
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|status
operator|&=
operator|~
name|PS2M_STS_ENABLE_DEV
expr_stmt|;
name|fifo_put
argument_list|(
name|sc
argument_list|,
name|PS2MC_ACK
argument_list|)
expr_stmt|;
break|break;
case|case
name|PS2MC_ENABLE
case|:
name|fifo_reset
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|status
operator||=
name|PS2M_STS_ENABLE_DEV
expr_stmt|;
name|fifo_put
argument_list|(
name|sc
argument_list|,
name|PS2MC_ACK
argument_list|)
expr_stmt|;
break|break;
case|case
name|PS2MC_SET_SAMPLING_RATE
case|:
name|sc
operator|->
name|curcmd
operator|=
name|val
expr_stmt|;
name|fifo_put
argument_list|(
name|sc
argument_list|,
name|PS2MC_ACK
argument_list|)
expr_stmt|;
break|break;
case|case
name|PS2MC_SEND_DEV_ID
case|:
name|fifo_put
argument_list|(
name|sc
argument_list|,
name|PS2MC_ACK
argument_list|)
expr_stmt|;
name|fifo_put
argument_list|(
name|sc
argument_list|,
name|PS2MOUSE_DEV_ID
argument_list|)
expr_stmt|;
break|break;
case|case
name|PS2MC_SET_REMOTE_MODE
case|:
name|sc
operator|->
name|status
operator||=
name|PS2M_STS_REMOTE_MODE
expr_stmt|;
name|fifo_put
argument_list|(
name|sc
argument_list|,
name|PS2MC_ACK
argument_list|)
expr_stmt|;
break|break;
case|case
name|PS2MC_SEND_DEV_DATA
case|:
name|fifo_put
argument_list|(
name|sc
argument_list|,
name|PS2MC_ACK
argument_list|)
expr_stmt|;
name|movement_get
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
case|case
name|PS2MC_SET_STREAM_MODE
case|:
name|sc
operator|->
name|status
operator|&=
operator|~
name|PS2M_STS_REMOTE_MODE
expr_stmt|;
name|fifo_put
argument_list|(
name|sc
argument_list|,
name|PS2MC_ACK
argument_list|)
expr_stmt|;
break|break;
case|case
name|PS2MC_SEND_DEV_STATUS
case|:
name|fifo_put
argument_list|(
name|sc
argument_list|,
name|PS2MC_ACK
argument_list|)
expr_stmt|;
name|fifo_put
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|status
argument_list|)
expr_stmt|;
name|fifo_put
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|resolution
argument_list|)
expr_stmt|;
name|fifo_put
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|sampling_rate
argument_list|)
expr_stmt|;
break|break;
case|case
name|PS2MC_SET_RESOLUTION
case|:
name|sc
operator|->
name|curcmd
operator|=
name|val
expr_stmt|;
name|fifo_put
argument_list|(
name|sc
argument_list|,
name|PS2MC_ACK
argument_list|)
expr_stmt|;
break|break;
case|case
name|PS2MC_SET_SCALING1
case|:
case|case
name|PS2MC_SET_SCALING2
case|:
name|fifo_put
argument_list|(
name|sc
argument_list|,
name|PS2MC_ACK
argument_list|)
expr_stmt|;
break|break;
default|default:
name|fifo_put
argument_list|(
name|sc
argument_list|,
name|PS2MC_ACK
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Unhandled ps2 mouse command "
literal|"0x%02x\n"
argument_list|,
name|val
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|pthread_mutex_unlock
argument_list|(
operator|&
name|sc
operator|->
name|mtx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ps2mouse_event
parameter_list|(
name|uint8_t
name|button
parameter_list|,
name|int
name|x
parameter_list|,
name|int
name|y
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|ps2mouse_softc
modifier|*
name|sc
init|=
name|arg
decl_stmt|;
name|pthread_mutex_lock
argument_list|(
operator|&
name|sc
operator|->
name|mtx
argument_list|)
expr_stmt|;
name|movement_update
argument_list|(
name|sc
argument_list|,
name|x
argument_list|,
name|y
argument_list|)
expr_stmt|;
name|sc
operator|->
name|status
operator|&=
operator|~
operator|(
name|PS2M_STS_LEFT_BUTTON
operator||
name|PS2M_STS_RIGHT_BUTTON
operator||
name|PS2M_STS_MID_BUTTON
operator|)
expr_stmt|;
if|if
condition|(
name|button
operator|&
operator|(
literal|1
operator|<<
literal|0
operator|)
condition|)
name|sc
operator|->
name|status
operator||=
name|PS2M_STS_LEFT_BUTTON
expr_stmt|;
if|if
condition|(
name|button
operator|&
operator|(
literal|1
operator|<<
literal|1
operator|)
condition|)
name|sc
operator|->
name|status
operator||=
name|PS2M_STS_MID_BUTTON
expr_stmt|;
if|if
condition|(
name|button
operator|&
operator|(
literal|1
operator|<<
literal|2
operator|)
condition|)
name|sc
operator|->
name|status
operator||=
name|PS2M_STS_RIGHT_BUTTON
expr_stmt|;
if|if
condition|(
operator|(
name|sc
operator|->
name|status
operator|&
name|PS2M_STS_ENABLE_DEV
operator|)
operator|==
literal|0
operator|||
operator|!
name|sc
operator|->
name|ctrlenable
condition|)
block|{
comment|/* no data reporting */
name|pthread_mutex_unlock
argument_list|(
operator|&
name|sc
operator|->
name|mtx
argument_list|)
expr_stmt|;
return|return;
block|}
name|movement_get
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|pthread_mutex_unlock
argument_list|(
operator|&
name|sc
operator|->
name|mtx
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|fifo
operator|.
name|num
operator|>
literal|0
condition|)
name|atkbdc_event
argument_list|(
name|sc
operator|->
name|atkbdc_sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|struct
name|ps2mouse_softc
modifier|*
name|ps2mouse_init
parameter_list|(
name|struct
name|atkbdc_softc
modifier|*
name|atkbdc_sc
parameter_list|)
block|{
name|struct
name|ps2mouse_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ps2mouse_softc
argument_list|)
argument_list|)
expr_stmt|;
name|pthread_mutex_init
argument_list|(
operator|&
name|sc
operator|->
name|mtx
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|fifo_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|atkbdc_sc
operator|=
name|atkbdc_sc
expr_stmt|;
name|pthread_mutex_lock
argument_list|(
operator|&
name|sc
operator|->
name|mtx
argument_list|)
expr_stmt|;
name|ps2mouse_reset
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|pthread_mutex_unlock
argument_list|(
operator|&
name|sc
operator|->
name|mtx
argument_list|)
expr_stmt|;
name|console_ptr_register
argument_list|(
name|ps2mouse_event
argument_list|,
name|sc
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
operator|(
name|sc
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2015 Tycho Nightingale<tycho.nightingale@pluribusnetworks.com>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<assert.h>
end_include

begin_include
include|#
directive|include
file|<pthread.h>
end_include

begin_include
include|#
directive|include
file|<stdbool.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<machine/vmm.h>
end_include

begin_include
include|#
directive|include
file|"bhyvegc.h"
end_include

begin_include
include|#
directive|include
file|"console.h"
end_include

begin_include
include|#
directive|include
file|"inout.h"
end_include

begin_include
include|#
directive|include
file|"mem.h"
end_include

begin_include
include|#
directive|include
file|"vga.h"
end_include

begin_define
define|#
directive|define
name|KB
value|(1024UL)
end_define

begin_define
define|#
directive|define
name|MB
value|(1024 * 1024UL)
end_define

begin_struct
struct|struct
name|vga_softc
block|{
name|struct
name|mem_range
name|mr
decl_stmt|;
name|struct
name|bhyvegc
modifier|*
name|gc
decl_stmt|;
name|int
name|gc_width
decl_stmt|;
name|int
name|gc_height
decl_stmt|;
name|struct
name|bhyvegc_image
modifier|*
name|gc_image
decl_stmt|;
name|uint8_t
modifier|*
name|vga_ram
decl_stmt|;
comment|/* 	 * General registers 	 */
name|uint8_t
name|vga_misc
decl_stmt|;
name|uint8_t
name|vga_sts1
decl_stmt|;
comment|/* 	 * Sequencer 	 */
struct|struct
block|{
name|int
name|seq_index
decl_stmt|;
name|uint8_t
name|seq_reset
decl_stmt|;
name|uint8_t
name|seq_clock_mode
decl_stmt|;
name|int
name|seq_cm_dots
decl_stmt|;
name|uint8_t
name|seq_map_mask
decl_stmt|;
name|uint8_t
name|seq_cmap_sel
decl_stmt|;
name|int
name|seq_cmap_pri_off
decl_stmt|;
name|int
name|seq_cmap_sec_off
decl_stmt|;
name|uint8_t
name|seq_mm
decl_stmt|;
block|}
name|vga_seq
struct|;
comment|/* 	 * CRT Controller 	 */
struct|struct
block|{
name|int
name|crtc_index
decl_stmt|;
name|uint8_t
name|crtc_mode_ctrl
decl_stmt|;
name|uint8_t
name|crtc_horiz_total
decl_stmt|;
name|uint8_t
name|crtc_horiz_disp_end
decl_stmt|;
name|uint8_t
name|crtc_start_horiz_blank
decl_stmt|;
name|uint8_t
name|crtc_end_horiz_blank
decl_stmt|;
name|uint8_t
name|crtc_start_horiz_retrace
decl_stmt|;
name|uint8_t
name|crtc_end_horiz_retrace
decl_stmt|;
name|uint8_t
name|crtc_vert_total
decl_stmt|;
name|uint8_t
name|crtc_overflow
decl_stmt|;
name|uint8_t
name|crtc_present_row_scan
decl_stmt|;
name|uint8_t
name|crtc_max_scan_line
decl_stmt|;
name|uint8_t
name|crtc_cursor_start
decl_stmt|;
name|uint8_t
name|crtc_cursor_on
decl_stmt|;
name|uint8_t
name|crtc_cursor_end
decl_stmt|;
name|uint8_t
name|crtc_start_addr_high
decl_stmt|;
name|uint8_t
name|crtc_start_addr_low
decl_stmt|;
name|uint16_t
name|crtc_start_addr
decl_stmt|;
name|uint8_t
name|crtc_cursor_loc_low
decl_stmt|;
name|uint8_t
name|crtc_cursor_loc_high
decl_stmt|;
name|uint16_t
name|crtc_cursor_loc
decl_stmt|;
name|uint8_t
name|crtc_vert_retrace_start
decl_stmt|;
name|uint8_t
name|crtc_vert_retrace_end
decl_stmt|;
name|uint8_t
name|crtc_vert_disp_end
decl_stmt|;
name|uint8_t
name|crtc_offset
decl_stmt|;
name|uint8_t
name|crtc_underline_loc
decl_stmt|;
name|uint8_t
name|crtc_start_vert_blank
decl_stmt|;
name|uint8_t
name|crtc_end_vert_blank
decl_stmt|;
name|uint8_t
name|crtc_line_compare
decl_stmt|;
block|}
name|vga_crtc
struct|;
comment|/* 	 * Graphics Controller 	 */
struct|struct
block|{
name|int
name|gc_index
decl_stmt|;
name|uint8_t
name|gc_set_reset
decl_stmt|;
name|uint8_t
name|gc_enb_set_reset
decl_stmt|;
name|uint8_t
name|gc_color_compare
decl_stmt|;
name|uint8_t
name|gc_rotate
decl_stmt|;
name|uint8_t
name|gc_op
decl_stmt|;
name|uint8_t
name|gc_read_map_sel
decl_stmt|;
name|uint8_t
name|gc_mode
decl_stmt|;
name|bool
name|gc_mode_c4
decl_stmt|;
comment|/* chain 4 */
name|bool
name|gc_mode_oe
decl_stmt|;
comment|/* odd/even */
name|uint8_t
name|gc_mode_rm
decl_stmt|;
comment|/* read mode */
name|uint8_t
name|gc_mode_wm
decl_stmt|;
comment|/* write mode */
name|uint8_t
name|gc_misc
decl_stmt|;
name|uint8_t
name|gc_misc_gm
decl_stmt|;
comment|/* graphics mode */
name|uint8_t
name|gc_misc_mm
decl_stmt|;
comment|/* memory map */
name|uint8_t
name|gc_color_dont_care
decl_stmt|;
name|uint8_t
name|gc_bit_mask
decl_stmt|;
name|uint8_t
name|gc_latch0
decl_stmt|;
name|uint8_t
name|gc_latch1
decl_stmt|;
name|uint8_t
name|gc_latch2
decl_stmt|;
name|uint8_t
name|gc_latch3
decl_stmt|;
block|}
name|vga_gc
struct|;
comment|/* 	 * Attribute Controller 	 */
struct|struct
block|{
name|int
name|atc_flipflop
decl_stmt|;
name|int
name|atc_index
decl_stmt|;
name|uint8_t
name|atc_palette
index|[
literal|16
index|]
decl_stmt|;
name|uint8_t
name|atc_mode
decl_stmt|;
name|uint8_t
name|atc_overscan_color
decl_stmt|;
name|uint8_t
name|atc_color_plane_enb
decl_stmt|;
name|uint8_t
name|atc_horiz_pixel_panning
decl_stmt|;
name|uint8_t
name|atc_color_select
decl_stmt|;
name|uint8_t
name|atc_color_select_45
decl_stmt|;
name|uint8_t
name|atc_color_select_67
decl_stmt|;
block|}
name|vga_atc
struct|;
comment|/* 	 * DAC 	 */
struct|struct
block|{
name|uint8_t
name|dac_state
decl_stmt|;
name|uint8_t
name|dac_rd_index
decl_stmt|;
name|uint8_t
name|dac_rd_subindex
decl_stmt|;
name|uint8_t
name|dac_wr_index
decl_stmt|;
name|uint8_t
name|dac_wr_subindex
decl_stmt|;
name|uint8_t
name|dac_palette
index|[
literal|3
operator|*
literal|256
index|]
decl_stmt|;
name|uint32_t
name|dac_palette_rgb
index|[
literal|256
index|]
decl_stmt|;
block|}
name|vga_dac
struct|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|bool
name|vga_in_reset
parameter_list|(
name|struct
name|vga_softc
modifier|*
name|sc
parameter_list|)
block|{
return|return
operator|(
operator|(
operator|(
name|sc
operator|->
name|vga_seq
operator|.
name|seq_clock_mode
operator|&
name|SEQ_CM_SO
operator|)
operator|!=
literal|0
operator|)
operator|||
operator|(
operator|(
name|sc
operator|->
name|vga_seq
operator|.
name|seq_reset
operator|&
name|SEQ_RESET_ASYNC
operator|)
operator|==
literal|0
operator|)
operator|||
operator|(
operator|(
name|sc
operator|->
name|vga_seq
operator|.
name|seq_reset
operator|&
name|SEQ_RESET_SYNC
operator|)
operator|==
literal|0
operator|)
operator|||
operator|(
operator|(
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_mode_ctrl
operator|&
name|CRTC_MC_TE
operator|)
operator|==
literal|0
operator|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vga_check_size
parameter_list|(
name|struct
name|bhyvegc
modifier|*
name|gc
parameter_list|,
name|struct
name|vga_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|old_width
decl_stmt|,
name|old_height
decl_stmt|;
if|if
condition|(
name|vga_in_reset
argument_list|(
name|sc
argument_list|)
condition|)
return|return;
comment|//old_width = sc->gc_width;
comment|//old_height = sc->gc_height;
name|old_width
operator|=
name|sc
operator|->
name|gc_image
operator|->
name|width
expr_stmt|;
name|old_height
operator|=
name|sc
operator|->
name|gc_image
operator|->
name|height
expr_stmt|;
comment|/* 	 * Horizontal Display End: For text modes this is the number 	 * of characters.  For graphics modes this is the number of 	 * pixels per scanlines divided by the number of pixels per 	 * character clock. 	 */
name|sc
operator|->
name|gc_width
operator|=
operator|(
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_horiz_disp_end
operator|+
literal|1
operator|)
operator|*
name|sc
operator|->
name|vga_seq
operator|.
name|seq_cm_dots
expr_stmt|;
name|sc
operator|->
name|gc_height
operator|=
operator|(
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_vert_disp_end
operator||
operator|(
operator|(
operator|(
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_overflow
operator|&
name|CRTC_OF_VDE8
operator|)
operator|>>
name|CRTC_OF_VDE8_SHIFT
operator|)
operator|<<
literal|8
operator|)
operator||
operator|(
operator|(
operator|(
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_overflow
operator|&
name|CRTC_OF_VDE9
operator|)
operator|>>
name|CRTC_OF_VDE9_SHIFT
operator|)
operator|<<
literal|9
operator|)
operator|)
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|old_width
operator|!=
name|sc
operator|->
name|gc_width
operator|||
name|old_height
operator|!=
name|sc
operator|->
name|gc_height
condition|)
name|bhyvegc_resize
argument_list|(
name|gc
argument_list|,
name|sc
operator|->
name|gc_width
argument_list|,
name|sc
operator|->
name|gc_height
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|vga_get_pixel
parameter_list|(
name|struct
name|vga_softc
modifier|*
name|sc
parameter_list|,
name|int
name|x
parameter_list|,
name|int
name|y
parameter_list|)
block|{
name|int
name|offset
decl_stmt|;
name|int
name|bit
decl_stmt|;
name|uint8_t
name|data
decl_stmt|;
name|uint8_t
name|idx
decl_stmt|;
name|offset
operator|=
operator|(
name|y
operator|*
name|sc
operator|->
name|gc_width
operator|/
literal|8
operator|)
operator|+
operator|(
name|x
operator|/
literal|8
operator|)
expr_stmt|;
name|bit
operator|=
literal|7
operator|-
operator|(
name|x
operator|%
literal|8
operator|)
expr_stmt|;
name|data
operator|=
operator|(
operator|(
operator|(
name|sc
operator|->
name|vga_ram
index|[
name|offset
operator|+
literal|0
operator|*
literal|64
operator|*
name|KB
index|]
operator|>>
name|bit
operator|)
operator|&
literal|0x1
operator|)
operator|<<
literal|0
operator|)
operator||
operator|(
operator|(
operator|(
name|sc
operator|->
name|vga_ram
index|[
name|offset
operator|+
literal|1
operator|*
literal|64
operator|*
name|KB
index|]
operator|>>
name|bit
operator|)
operator|&
literal|0x1
operator|)
operator|<<
literal|1
operator|)
operator||
operator|(
operator|(
operator|(
name|sc
operator|->
name|vga_ram
index|[
name|offset
operator|+
literal|2
operator|*
literal|64
operator|*
name|KB
index|]
operator|>>
name|bit
operator|)
operator|&
literal|0x1
operator|)
operator|<<
literal|2
operator|)
operator||
operator|(
operator|(
operator|(
name|sc
operator|->
name|vga_ram
index|[
name|offset
operator|+
literal|3
operator|*
literal|64
operator|*
name|KB
index|]
operator|>>
name|bit
operator|)
operator|&
literal|0x1
operator|)
operator|<<
literal|3
operator|)
expr_stmt|;
name|data
operator|&=
name|sc
operator|->
name|vga_atc
operator|.
name|atc_color_plane_enb
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|vga_atc
operator|.
name|atc_mode
operator|&
name|ATC_MC_IPS
condition|)
block|{
name|idx
operator|=
name|sc
operator|->
name|vga_atc
operator|.
name|atc_palette
index|[
name|data
index|]
operator|&
literal|0x0f
expr_stmt|;
name|idx
operator||=
name|sc
operator|->
name|vga_atc
operator|.
name|atc_color_select_45
expr_stmt|;
block|}
else|else
block|{
name|idx
operator|=
name|sc
operator|->
name|vga_atc
operator|.
name|atc_palette
index|[
name|data
index|]
expr_stmt|;
block|}
name|idx
operator||=
name|sc
operator|->
name|vga_atc
operator|.
name|atc_color_select_67
expr_stmt|;
return|return
operator|(
name|sc
operator|->
name|vga_dac
operator|.
name|dac_palette_rgb
index|[
name|idx
index|]
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vga_render_graphics
parameter_list|(
name|struct
name|vga_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|x
decl_stmt|,
name|y
decl_stmt|;
for|for
control|(
name|y
operator|=
literal|0
init|;
name|y
operator|<
name|sc
operator|->
name|gc_height
condition|;
name|y
operator|++
control|)
block|{
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|<
name|sc
operator|->
name|gc_width
condition|;
name|x
operator|++
control|)
block|{
name|int
name|offset
decl_stmt|;
name|offset
operator|=
name|y
operator|*
name|sc
operator|->
name|gc_width
operator|+
name|x
expr_stmt|;
name|sc
operator|->
name|gc_image
operator|->
name|data
index|[
name|offset
index|]
operator|=
name|vga_get_pixel
argument_list|(
name|sc
argument_list|,
name|x
argument_list|,
name|y
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|vga_get_text_pixel
parameter_list|(
name|struct
name|vga_softc
modifier|*
name|sc
parameter_list|,
name|int
name|x
parameter_list|,
name|int
name|y
parameter_list|)
block|{
name|int
name|dots
decl_stmt|,
name|offset
decl_stmt|,
name|bit
decl_stmt|,
name|font_offset
decl_stmt|;
name|uint8_t
name|ch
decl_stmt|,
name|attr
decl_stmt|,
name|font
decl_stmt|;
name|uint8_t
name|idx
decl_stmt|;
name|dots
operator|=
name|sc
operator|->
name|vga_seq
operator|.
name|seq_cm_dots
expr_stmt|;
name|offset
operator|=
literal|2
operator|*
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_start_addr
expr_stmt|;
name|offset
operator|+=
operator|(
name|y
operator|/
literal|16
operator|*
name|sc
operator|->
name|gc_width
operator|/
name|dots
operator|)
operator|*
literal|2
operator|+
operator|(
name|x
operator|/
name|dots
operator|)
operator|*
literal|2
expr_stmt|;
name|bit
operator|=
literal|7
operator|-
operator|(
name|x
operator|%
name|dots
operator|>
literal|7
condition|?
literal|7
else|:
name|x
operator|%
name|dots
operator|)
expr_stmt|;
name|ch
operator|=
name|sc
operator|->
name|vga_ram
index|[
name|offset
operator|+
literal|0
operator|*
literal|64
operator|*
name|KB
index|]
expr_stmt|;
name|attr
operator|=
name|sc
operator|->
name|vga_ram
index|[
name|offset
operator|+
literal|1
operator|*
literal|64
operator|*
name|KB
index|]
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_cursor_on
operator|&&
operator|(
name|offset
operator|==
operator|(
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_cursor_loc
operator|*
literal|2
operator|)
operator|)
operator|&&
operator|(
operator|(
name|y
operator|%
literal|16
operator|)
operator|>=
operator|(
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_cursor_start
operator|&
name|CRTC_CS_CS
operator|)
operator|)
operator|&&
operator|(
operator|(
name|y
operator|%
literal|16
operator|)
operator|<=
operator|(
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_cursor_end
operator|&
name|CRTC_CE_CE
operator|)
operator|)
condition|)
block|{
name|idx
operator|=
name|sc
operator|->
name|vga_atc
operator|.
name|atc_palette
index|[
name|attr
operator|&
literal|0xf
index|]
expr_stmt|;
return|return
operator|(
name|sc
operator|->
name|vga_dac
operator|.
name|dac_palette_rgb
index|[
name|idx
index|]
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|sc
operator|->
name|vga_seq
operator|.
name|seq_mm
operator|&
name|SEQ_MM_EM
operator|)
operator|&&
name|sc
operator|->
name|vga_seq
operator|.
name|seq_cmap_pri_off
operator|!=
name|sc
operator|->
name|vga_seq
operator|.
name|seq_cmap_sec_off
condition|)
block|{
if|if
condition|(
name|attr
operator|&
literal|0x8
condition|)
name|font_offset
operator|=
name|sc
operator|->
name|vga_seq
operator|.
name|seq_cmap_pri_off
operator|+
operator|(
name|ch
operator|<<
literal|5
operator|)
operator|+
name|y
operator|%
literal|16
expr_stmt|;
else|else
name|font_offset
operator|=
name|sc
operator|->
name|vga_seq
operator|.
name|seq_cmap_sec_off
operator|+
operator|(
name|ch
operator|<<
literal|5
operator|)
operator|+
name|y
operator|%
literal|16
expr_stmt|;
name|attr
operator|&=
operator|~
literal|0x8
expr_stmt|;
block|}
else|else
block|{
name|font_offset
operator|=
operator|(
name|ch
operator|<<
literal|5
operator|)
operator|+
name|y
operator|%
literal|16
expr_stmt|;
block|}
name|font
operator|=
name|sc
operator|->
name|vga_ram
index|[
name|font_offset
operator|+
literal|2
operator|*
literal|64
operator|*
name|KB
index|]
expr_stmt|;
if|if
condition|(
name|font
operator|&
operator|(
literal|1
operator|<<
name|bit
operator|)
condition|)
name|idx
operator|=
name|sc
operator|->
name|vga_atc
operator|.
name|atc_palette
index|[
name|attr
operator|&
literal|0xf
index|]
expr_stmt|;
else|else
name|idx
operator|=
name|sc
operator|->
name|vga_atc
operator|.
name|atc_palette
index|[
name|attr
operator|>>
literal|4
index|]
expr_stmt|;
return|return
operator|(
name|sc
operator|->
name|vga_dac
operator|.
name|dac_palette_rgb
index|[
name|idx
index|]
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vga_render_text
parameter_list|(
name|struct
name|vga_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|x
decl_stmt|,
name|y
decl_stmt|;
for|for
control|(
name|y
operator|=
literal|0
init|;
name|y
operator|<
name|sc
operator|->
name|gc_height
condition|;
name|y
operator|++
control|)
block|{
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|<
name|sc
operator|->
name|gc_width
condition|;
name|x
operator|++
control|)
block|{
name|int
name|offset
decl_stmt|;
name|offset
operator|=
name|y
operator|*
name|sc
operator|->
name|gc_width
operator|+
name|x
expr_stmt|;
name|sc
operator|->
name|gc_image
operator|->
name|data
index|[
name|offset
index|]
operator|=
name|vga_get_text_pixel
argument_list|(
name|sc
argument_list|,
name|x
argument_list|,
name|y
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|void
name|vga_render
parameter_list|(
name|struct
name|bhyvegc
modifier|*
name|gc
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|vga_softc
modifier|*
name|sc
init|=
name|arg
decl_stmt|;
name|vga_check_size
argument_list|(
name|gc
argument_list|,
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|vga_in_reset
argument_list|(
name|sc
argument_list|)
condition|)
block|{
name|memset
argument_list|(
name|sc
operator|->
name|gc_image
operator|->
name|data
argument_list|,
literal|0
argument_list|,
name|sc
operator|->
name|gc_image
operator|->
name|width
operator|*
name|sc
operator|->
name|gc_image
operator|->
name|height
operator|*
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|sc
operator|->
name|vga_gc
operator|.
name|gc_misc_gm
operator|&&
operator|(
name|sc
operator|->
name|vga_atc
operator|.
name|atc_mode
operator|&
name|ATC_MC_GA
operator|)
condition|)
name|vga_render_graphics
argument_list|(
name|sc
argument_list|)
expr_stmt|;
else|else
name|vga_render_text
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|uint64_t
name|vga_mem_rd_handler
parameter_list|(
name|struct
name|vmctx
modifier|*
name|ctx
parameter_list|,
name|uint64_t
name|addr
parameter_list|,
name|void
modifier|*
name|arg1
parameter_list|)
block|{
name|struct
name|vga_softc
modifier|*
name|sc
init|=
name|arg1
decl_stmt|;
name|uint8_t
name|map_sel
decl_stmt|;
name|int
name|offset
decl_stmt|;
name|offset
operator|=
name|addr
expr_stmt|;
switch|switch
condition|(
name|sc
operator|->
name|vga_gc
operator|.
name|gc_misc_mm
condition|)
block|{
case|case
literal|0x0
case|:
comment|/* 		 * extended mode: base 0xa0000 size 128k 		 */
name|offset
operator|-=
literal|0xa0000
expr_stmt|;
name|offset
operator|&=
operator|(
literal|128
operator|*
name|KB
operator|-
literal|1
operator|)
expr_stmt|;
break|break;
case|case
literal|0x1
case|:
comment|/* 		 * EGA/VGA mode: base 0xa0000 size 64k 		 */
name|offset
operator|-=
literal|0xa0000
expr_stmt|;
name|offset
operator|&=
operator|(
literal|64
operator|*
name|KB
operator|-
literal|1
operator|)
expr_stmt|;
break|break;
case|case
literal|0x2
case|:
comment|/* 		 * monochrome text mode: base 0xb0000 size 32kb 		 */
name|assert
argument_list|(
literal|0
argument_list|)
expr_stmt|;
case|case
literal|0x3
case|:
comment|/* 		 * color text mode and CGA: base 0xb8000 size 32kb 		 */
name|offset
operator|-=
literal|0xb8000
expr_stmt|;
name|offset
operator|&=
operator|(
literal|32
operator|*
name|KB
operator|-
literal|1
operator|)
expr_stmt|;
break|break;
block|}
comment|/* Fill latches. */
name|sc
operator|->
name|vga_gc
operator|.
name|gc_latch0
operator|=
name|sc
operator|->
name|vga_ram
index|[
name|offset
operator|+
literal|0
operator|*
literal|64
operator|*
name|KB
index|]
expr_stmt|;
name|sc
operator|->
name|vga_gc
operator|.
name|gc_latch1
operator|=
name|sc
operator|->
name|vga_ram
index|[
name|offset
operator|+
literal|1
operator|*
literal|64
operator|*
name|KB
index|]
expr_stmt|;
name|sc
operator|->
name|vga_gc
operator|.
name|gc_latch2
operator|=
name|sc
operator|->
name|vga_ram
index|[
name|offset
operator|+
literal|2
operator|*
literal|64
operator|*
name|KB
index|]
expr_stmt|;
name|sc
operator|->
name|vga_gc
operator|.
name|gc_latch3
operator|=
name|sc
operator|->
name|vga_ram
index|[
name|offset
operator|+
literal|3
operator|*
literal|64
operator|*
name|KB
index|]
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|vga_gc
operator|.
name|gc_mode_rm
condition|)
block|{
comment|/* read mode 1 */
name|assert
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|map_sel
operator|=
name|sc
operator|->
name|vga_gc
operator|.
name|gc_read_map_sel
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|vga_gc
operator|.
name|gc_mode_oe
condition|)
block|{
name|map_sel
operator||=
operator|(
name|offset
operator|&
literal|1
operator|)
expr_stmt|;
name|offset
operator|&=
operator|~
literal|1
expr_stmt|;
block|}
comment|/* read mode 0: return the byte from the selected plane. */
name|offset
operator|+=
name|map_sel
operator|*
literal|64
operator|*
name|KB
expr_stmt|;
return|return
operator|(
name|sc
operator|->
name|vga_ram
index|[
name|offset
index|]
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vga_mem_wr_handler
parameter_list|(
name|struct
name|vmctx
modifier|*
name|ctx
parameter_list|,
name|uint64_t
name|addr
parameter_list|,
name|uint8_t
name|val
parameter_list|,
name|void
modifier|*
name|arg1
parameter_list|)
block|{
name|struct
name|vga_softc
modifier|*
name|sc
init|=
name|arg1
decl_stmt|;
name|uint8_t
name|c0
decl_stmt|,
name|c1
decl_stmt|,
name|c2
decl_stmt|,
name|c3
decl_stmt|;
name|uint8_t
name|m0
decl_stmt|,
name|m1
decl_stmt|,
name|m2
decl_stmt|,
name|m3
decl_stmt|;
name|uint8_t
name|set_reset
decl_stmt|;
name|uint8_t
name|enb_set_reset
decl_stmt|;
name|uint8_t
name|mask
decl_stmt|;
name|int
name|offset
decl_stmt|;
name|offset
operator|=
name|addr
expr_stmt|;
switch|switch
condition|(
name|sc
operator|->
name|vga_gc
operator|.
name|gc_misc_mm
condition|)
block|{
case|case
literal|0x0
case|:
comment|/* 		 * extended mode: base 0xa0000 size 128kb 		 */
name|offset
operator|-=
literal|0xa0000
expr_stmt|;
name|offset
operator|&=
operator|(
literal|128
operator|*
name|KB
operator|-
literal|1
operator|)
expr_stmt|;
break|break;
case|case
literal|0x1
case|:
comment|/* 		 * EGA/VGA mode: base 0xa0000 size 64kb 		 */
name|offset
operator|-=
literal|0xa0000
expr_stmt|;
name|offset
operator|&=
operator|(
literal|64
operator|*
name|KB
operator|-
literal|1
operator|)
expr_stmt|;
break|break;
case|case
literal|0x2
case|:
comment|/* 		 * monochrome text mode: base 0xb0000 size 32kb 		 */
name|assert
argument_list|(
literal|0
argument_list|)
expr_stmt|;
case|case
literal|0x3
case|:
comment|/* 		 * color text mode and CGA: base 0xb8000 size 32kb 		 */
name|offset
operator|-=
literal|0xb8000
expr_stmt|;
name|offset
operator|&=
operator|(
literal|32
operator|*
name|KB
operator|-
literal|1
operator|)
expr_stmt|;
break|break;
block|}
name|set_reset
operator|=
name|sc
operator|->
name|vga_gc
operator|.
name|gc_set_reset
expr_stmt|;
name|enb_set_reset
operator|=
name|sc
operator|->
name|vga_gc
operator|.
name|gc_enb_set_reset
expr_stmt|;
name|c0
operator|=
name|sc
operator|->
name|vga_gc
operator|.
name|gc_latch0
expr_stmt|;
name|c1
operator|=
name|sc
operator|->
name|vga_gc
operator|.
name|gc_latch1
expr_stmt|;
name|c2
operator|=
name|sc
operator|->
name|vga_gc
operator|.
name|gc_latch2
expr_stmt|;
name|c3
operator|=
name|sc
operator|->
name|vga_gc
operator|.
name|gc_latch3
expr_stmt|;
switch|switch
condition|(
name|sc
operator|->
name|vga_gc
operator|.
name|gc_mode_wm
condition|)
block|{
case|case
literal|0
case|:
comment|/* write mode 0 */
name|mask
operator|=
name|sc
operator|->
name|vga_gc
operator|.
name|gc_bit_mask
expr_stmt|;
name|val
operator|=
operator|(
name|val
operator|>>
name|sc
operator|->
name|vga_gc
operator|.
name|gc_rotate
operator|)
operator||
operator|(
name|val
operator|<<
operator|(
literal|8
operator|-
name|sc
operator|->
name|vga_gc
operator|.
name|gc_rotate
operator|)
operator|)
expr_stmt|;
switch|switch
condition|(
name|sc
operator|->
name|vga_gc
operator|.
name|gc_op
condition|)
block|{
case|case
literal|0x00
case|:
comment|/* replace */
name|m0
operator|=
operator|(
name|set_reset
operator|&
literal|1
operator|)
condition|?
name|mask
else|:
literal|0x00
expr_stmt|;
name|m1
operator|=
operator|(
name|set_reset
operator|&
literal|2
operator|)
condition|?
name|mask
else|:
literal|0x00
expr_stmt|;
name|m2
operator|=
operator|(
name|set_reset
operator|&
literal|4
operator|)
condition|?
name|mask
else|:
literal|0x00
expr_stmt|;
name|m3
operator|=
operator|(
name|set_reset
operator|&
literal|8
operator|)
condition|?
name|mask
else|:
literal|0x00
expr_stmt|;
name|c0
operator|=
operator|(
name|enb_set_reset
operator|&
literal|1
operator|)
condition|?
operator|(
name|c0
operator|&
operator|~
name|mask
operator|)
else|:
operator|(
name|val
operator|&
name|mask
operator|)
expr_stmt|;
name|c1
operator|=
operator|(
name|enb_set_reset
operator|&
literal|2
operator|)
condition|?
operator|(
name|c1
operator|&
operator|~
name|mask
operator|)
else|:
operator|(
name|val
operator|&
name|mask
operator|)
expr_stmt|;
name|c2
operator|=
operator|(
name|enb_set_reset
operator|&
literal|4
operator|)
condition|?
operator|(
name|c2
operator|&
operator|~
name|mask
operator|)
else|:
operator|(
name|val
operator|&
name|mask
operator|)
expr_stmt|;
name|c3
operator|=
operator|(
name|enb_set_reset
operator|&
literal|8
operator|)
condition|?
operator|(
name|c3
operator|&
operator|~
name|mask
operator|)
else|:
operator|(
name|val
operator|&
name|mask
operator|)
expr_stmt|;
name|c0
operator||=
name|m0
expr_stmt|;
name|c1
operator||=
name|m1
expr_stmt|;
name|c2
operator||=
name|m2
expr_stmt|;
name|c3
operator||=
name|m3
expr_stmt|;
break|break;
case|case
literal|0x08
case|:
comment|/* AND */
name|m0
operator|=
name|set_reset
operator|&
literal|1
condition|?
literal|0xff
else|:
operator|~
name|mask
expr_stmt|;
name|m1
operator|=
name|set_reset
operator|&
literal|2
condition|?
literal|0xff
else|:
operator|~
name|mask
expr_stmt|;
name|m2
operator|=
name|set_reset
operator|&
literal|4
condition|?
literal|0xff
else|:
operator|~
name|mask
expr_stmt|;
name|m3
operator|=
name|set_reset
operator|&
literal|8
condition|?
literal|0xff
else|:
operator|~
name|mask
expr_stmt|;
name|c0
operator|=
name|enb_set_reset
operator|&
literal|1
condition|?
name|c0
operator|&
name|m0
else|:
name|val
operator|&
name|m0
expr_stmt|;
name|c1
operator|=
name|enb_set_reset
operator|&
literal|2
condition|?
name|c1
operator|&
name|m1
else|:
name|val
operator|&
name|m1
expr_stmt|;
name|c2
operator|=
name|enb_set_reset
operator|&
literal|4
condition|?
name|c2
operator|&
name|m2
else|:
name|val
operator|&
name|m2
expr_stmt|;
name|c3
operator|=
name|enb_set_reset
operator|&
literal|8
condition|?
name|c3
operator|&
name|m3
else|:
name|val
operator|&
name|m3
expr_stmt|;
break|break;
case|case
literal|0x10
case|:
comment|/* OR */
name|m0
operator|=
name|set_reset
operator|&
literal|1
condition|?
name|mask
else|:
literal|0x00
expr_stmt|;
name|m1
operator|=
name|set_reset
operator|&
literal|2
condition|?
name|mask
else|:
literal|0x00
expr_stmt|;
name|m2
operator|=
name|set_reset
operator|&
literal|4
condition|?
name|mask
else|:
literal|0x00
expr_stmt|;
name|m3
operator|=
name|set_reset
operator|&
literal|8
condition|?
name|mask
else|:
literal|0x00
expr_stmt|;
name|c0
operator|=
name|enb_set_reset
operator|&
literal|1
condition|?
name|c0
operator||
name|m0
else|:
name|val
operator||
name|m0
expr_stmt|;
name|c1
operator|=
name|enb_set_reset
operator|&
literal|2
condition|?
name|c1
operator||
name|m1
else|:
name|val
operator||
name|m1
expr_stmt|;
name|c2
operator|=
name|enb_set_reset
operator|&
literal|4
condition|?
name|c2
operator||
name|m2
else|:
name|val
operator||
name|m2
expr_stmt|;
name|c3
operator|=
name|enb_set_reset
operator|&
literal|8
condition|?
name|c3
operator||
name|m3
else|:
name|val
operator||
name|m3
expr_stmt|;
break|break;
case|case
literal|0x18
case|:
comment|/* XOR */
name|m0
operator|=
name|set_reset
operator|&
literal|1
condition|?
name|mask
else|:
literal|0x00
expr_stmt|;
name|m1
operator|=
name|set_reset
operator|&
literal|2
condition|?
name|mask
else|:
literal|0x00
expr_stmt|;
name|m2
operator|=
name|set_reset
operator|&
literal|4
condition|?
name|mask
else|:
literal|0x00
expr_stmt|;
name|m3
operator|=
name|set_reset
operator|&
literal|8
condition|?
name|mask
else|:
literal|0x00
expr_stmt|;
name|c0
operator|=
name|enb_set_reset
operator|&
literal|1
condition|?
name|c0
operator|^
name|m0
else|:
name|val
operator|^
name|m0
expr_stmt|;
name|c1
operator|=
name|enb_set_reset
operator|&
literal|2
condition|?
name|c1
operator|^
name|m1
else|:
name|val
operator|^
name|m1
expr_stmt|;
name|c2
operator|=
name|enb_set_reset
operator|&
literal|4
condition|?
name|c2
operator|^
name|m2
else|:
name|val
operator|^
name|m2
expr_stmt|;
name|c3
operator|=
name|enb_set_reset
operator|&
literal|8
condition|?
name|c3
operator|^
name|m3
else|:
name|val
operator|^
name|m3
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|1
case|:
comment|/* write mode 1 */
break|break;
case|case
literal|2
case|:
comment|/* write mode 2 */
name|mask
operator|=
name|sc
operator|->
name|vga_gc
operator|.
name|gc_bit_mask
expr_stmt|;
switch|switch
condition|(
name|sc
operator|->
name|vga_gc
operator|.
name|gc_op
condition|)
block|{
case|case
literal|0x00
case|:
comment|/* replace */
name|m0
operator|=
operator|(
name|val
operator|&
literal|1
condition|?
literal|0xff
else|:
literal|0x00
operator|)
operator|&
name|mask
expr_stmt|;
name|m1
operator|=
operator|(
name|val
operator|&
literal|2
condition|?
literal|0xff
else|:
literal|0x00
operator|)
operator|&
name|mask
expr_stmt|;
name|m2
operator|=
operator|(
name|val
operator|&
literal|4
condition|?
literal|0xff
else|:
literal|0x00
operator|)
operator|&
name|mask
expr_stmt|;
name|m3
operator|=
operator|(
name|val
operator|&
literal|8
condition|?
literal|0xff
else|:
literal|0x00
operator|)
operator|&
name|mask
expr_stmt|;
name|c0
operator|&=
operator|~
name|mask
expr_stmt|;
name|c1
operator|&=
operator|~
name|mask
expr_stmt|;
name|c2
operator|&=
operator|~
name|mask
expr_stmt|;
name|c3
operator|&=
operator|~
name|mask
expr_stmt|;
name|c0
operator||=
name|m0
expr_stmt|;
name|c1
operator||=
name|m1
expr_stmt|;
name|c2
operator||=
name|m2
expr_stmt|;
name|c3
operator||=
name|m3
expr_stmt|;
break|break;
case|case
literal|0x08
case|:
comment|/* AND */
name|m0
operator|=
operator|(
name|val
operator|&
literal|1
condition|?
literal|0xff
else|:
literal|0x00
operator|)
operator||
operator|~
name|mask
expr_stmt|;
name|m1
operator|=
operator|(
name|val
operator|&
literal|2
condition|?
literal|0xff
else|:
literal|0x00
operator|)
operator||
operator|~
name|mask
expr_stmt|;
name|m2
operator|=
operator|(
name|val
operator|&
literal|4
condition|?
literal|0xff
else|:
literal|0x00
operator|)
operator||
operator|~
name|mask
expr_stmt|;
name|m3
operator|=
operator|(
name|val
operator|&
literal|8
condition|?
literal|0xff
else|:
literal|0x00
operator|)
operator||
operator|~
name|mask
expr_stmt|;
name|c0
operator|&=
name|m0
expr_stmt|;
name|c1
operator|&=
name|m1
expr_stmt|;
name|c2
operator|&=
name|m2
expr_stmt|;
name|c3
operator|&=
name|m3
expr_stmt|;
break|break;
case|case
literal|0x10
case|:
comment|/* OR */
name|m0
operator|=
operator|(
name|val
operator|&
literal|1
condition|?
literal|0xff
else|:
literal|0x00
operator|)
operator|&
name|mask
expr_stmt|;
name|m1
operator|=
operator|(
name|val
operator|&
literal|2
condition|?
literal|0xff
else|:
literal|0x00
operator|)
operator|&
name|mask
expr_stmt|;
name|m2
operator|=
operator|(
name|val
operator|&
literal|4
condition|?
literal|0xff
else|:
literal|0x00
operator|)
operator|&
name|mask
expr_stmt|;
name|m3
operator|=
operator|(
name|val
operator|&
literal|8
condition|?
literal|0xff
else|:
literal|0x00
operator|)
operator|&
name|mask
expr_stmt|;
name|c0
operator||=
name|m0
expr_stmt|;
name|c1
operator||=
name|m1
expr_stmt|;
name|c2
operator||=
name|m2
expr_stmt|;
name|c3
operator||=
name|m3
expr_stmt|;
break|break;
case|case
literal|0x18
case|:
comment|/* XOR */
name|m0
operator|=
operator|(
name|val
operator|&
literal|1
condition|?
literal|0xff
else|:
literal|0x00
operator|)
operator|&
name|mask
expr_stmt|;
name|m1
operator|=
operator|(
name|val
operator|&
literal|2
condition|?
literal|0xff
else|:
literal|0x00
operator|)
operator|&
name|mask
expr_stmt|;
name|m2
operator|=
operator|(
name|val
operator|&
literal|4
condition|?
literal|0xff
else|:
literal|0x00
operator|)
operator|&
name|mask
expr_stmt|;
name|m3
operator|=
operator|(
name|val
operator|&
literal|8
condition|?
literal|0xff
else|:
literal|0x00
operator|)
operator|&
name|mask
expr_stmt|;
name|c0
operator|^=
name|m0
expr_stmt|;
name|c1
operator|^=
name|m1
expr_stmt|;
name|c2
operator|^=
name|m2
expr_stmt|;
name|c3
operator|^=
name|m3
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|3
case|:
comment|/* write mode 3 */
name|mask
operator|=
name|sc
operator|->
name|vga_gc
operator|.
name|gc_bit_mask
operator|&
name|val
expr_stmt|;
name|val
operator|=
operator|(
name|val
operator|>>
name|sc
operator|->
name|vga_gc
operator|.
name|gc_rotate
operator|)
operator||
operator|(
name|val
operator|<<
operator|(
literal|8
operator|-
name|sc
operator|->
name|vga_gc
operator|.
name|gc_rotate
operator|)
operator|)
expr_stmt|;
switch|switch
condition|(
name|sc
operator|->
name|vga_gc
operator|.
name|gc_op
condition|)
block|{
case|case
literal|0x00
case|:
comment|/* replace */
name|m0
operator|=
operator|(
name|set_reset
operator|&
literal|1
condition|?
literal|0xff
else|:
literal|0x00
operator|)
operator|&
name|mask
expr_stmt|;
name|m1
operator|=
operator|(
name|set_reset
operator|&
literal|2
condition|?
literal|0xff
else|:
literal|0x00
operator|)
operator|&
name|mask
expr_stmt|;
name|m2
operator|=
operator|(
name|set_reset
operator|&
literal|4
condition|?
literal|0xff
else|:
literal|0x00
operator|)
operator|&
name|mask
expr_stmt|;
name|m3
operator|=
operator|(
name|set_reset
operator|&
literal|8
condition|?
literal|0xff
else|:
literal|0x00
operator|)
operator|&
name|mask
expr_stmt|;
name|c0
operator|&=
operator|~
name|mask
expr_stmt|;
name|c1
operator|&=
operator|~
name|mask
expr_stmt|;
name|c2
operator|&=
operator|~
name|mask
expr_stmt|;
name|c3
operator|&=
operator|~
name|mask
expr_stmt|;
name|c0
operator||=
name|m0
expr_stmt|;
name|c1
operator||=
name|m1
expr_stmt|;
name|c2
operator||=
name|m2
expr_stmt|;
name|c3
operator||=
name|m3
expr_stmt|;
break|break;
case|case
literal|0x08
case|:
comment|/* AND */
name|m0
operator|=
operator|(
name|set_reset
operator|&
literal|1
condition|?
literal|0xff
else|:
literal|0x00
operator|)
operator||
operator|~
name|mask
expr_stmt|;
name|m1
operator|=
operator|(
name|set_reset
operator|&
literal|2
condition|?
literal|0xff
else|:
literal|0x00
operator|)
operator||
operator|~
name|mask
expr_stmt|;
name|m2
operator|=
operator|(
name|set_reset
operator|&
literal|4
condition|?
literal|0xff
else|:
literal|0x00
operator|)
operator||
operator|~
name|mask
expr_stmt|;
name|m3
operator|=
operator|(
name|set_reset
operator|&
literal|8
condition|?
literal|0xff
else|:
literal|0x00
operator|)
operator||
operator|~
name|mask
expr_stmt|;
name|c0
operator|&=
name|m0
expr_stmt|;
name|c1
operator|&=
name|m1
expr_stmt|;
name|c2
operator|&=
name|m2
expr_stmt|;
name|c3
operator|&=
name|m3
expr_stmt|;
break|break;
case|case
literal|0x10
case|:
comment|/* OR */
name|m0
operator|=
operator|(
name|set_reset
operator|&
literal|1
condition|?
literal|0xff
else|:
literal|0x00
operator|)
operator|&
name|mask
expr_stmt|;
name|m1
operator|=
operator|(
name|set_reset
operator|&
literal|2
condition|?
literal|0xff
else|:
literal|0x00
operator|)
operator|&
name|mask
expr_stmt|;
name|m2
operator|=
operator|(
name|set_reset
operator|&
literal|4
condition|?
literal|0xff
else|:
literal|0x00
operator|)
operator|&
name|mask
expr_stmt|;
name|m3
operator|=
operator|(
name|set_reset
operator|&
literal|8
condition|?
literal|0xff
else|:
literal|0x00
operator|)
operator|&
name|mask
expr_stmt|;
name|c0
operator||=
name|m0
expr_stmt|;
name|c1
operator||=
name|m1
expr_stmt|;
name|c2
operator||=
name|m2
expr_stmt|;
name|c3
operator||=
name|m3
expr_stmt|;
break|break;
case|case
literal|0x18
case|:
comment|/* XOR */
name|m0
operator|=
operator|(
name|set_reset
operator|&
literal|1
condition|?
literal|0xff
else|:
literal|0x00
operator|)
operator|&
name|mask
expr_stmt|;
name|m1
operator|=
operator|(
name|set_reset
operator|&
literal|2
condition|?
literal|0xff
else|:
literal|0x00
operator|)
operator|&
name|mask
expr_stmt|;
name|m2
operator|=
operator|(
name|set_reset
operator|&
literal|4
condition|?
literal|0xff
else|:
literal|0x00
operator|)
operator|&
name|mask
expr_stmt|;
name|m3
operator|=
operator|(
name|set_reset
operator|&
literal|8
condition|?
literal|0xff
else|:
literal|0x00
operator|)
operator|&
name|mask
expr_stmt|;
name|c0
operator|^=
name|m0
expr_stmt|;
name|c1
operator|^=
name|m1
expr_stmt|;
name|c2
operator|^=
name|m2
expr_stmt|;
name|c3
operator|^=
name|m3
expr_stmt|;
break|break;
block|}
break|break;
block|}
if|if
condition|(
name|sc
operator|->
name|vga_gc
operator|.
name|gc_mode_oe
condition|)
block|{
if|if
condition|(
name|offset
operator|&
literal|1
condition|)
block|{
name|offset
operator|&=
operator|~
literal|1
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|vga_seq
operator|.
name|seq_map_mask
operator|&
literal|2
condition|)
name|sc
operator|->
name|vga_ram
index|[
name|offset
operator|+
literal|1
operator|*
literal|64
operator|*
name|KB
index|]
operator|=
name|c1
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|vga_seq
operator|.
name|seq_map_mask
operator|&
literal|8
condition|)
name|sc
operator|->
name|vga_ram
index|[
name|offset
operator|+
literal|3
operator|*
literal|64
operator|*
name|KB
index|]
operator|=
name|c3
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|sc
operator|->
name|vga_seq
operator|.
name|seq_map_mask
operator|&
literal|1
condition|)
name|sc
operator|->
name|vga_ram
index|[
name|offset
operator|+
literal|0
operator|*
literal|64
operator|*
name|KB
index|]
operator|=
name|c0
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|vga_seq
operator|.
name|seq_map_mask
operator|&
literal|4
condition|)
name|sc
operator|->
name|vga_ram
index|[
name|offset
operator|+
literal|2
operator|*
literal|64
operator|*
name|KB
index|]
operator|=
name|c2
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|sc
operator|->
name|vga_seq
operator|.
name|seq_map_mask
operator|&
literal|1
condition|)
name|sc
operator|->
name|vga_ram
index|[
name|offset
operator|+
literal|0
operator|*
literal|64
operator|*
name|KB
index|]
operator|=
name|c0
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|vga_seq
operator|.
name|seq_map_mask
operator|&
literal|2
condition|)
name|sc
operator|->
name|vga_ram
index|[
name|offset
operator|+
literal|1
operator|*
literal|64
operator|*
name|KB
index|]
operator|=
name|c1
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|vga_seq
operator|.
name|seq_map_mask
operator|&
literal|4
condition|)
name|sc
operator|->
name|vga_ram
index|[
name|offset
operator|+
literal|2
operator|*
literal|64
operator|*
name|KB
index|]
operator|=
name|c2
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|vga_seq
operator|.
name|seq_map_mask
operator|&
literal|8
condition|)
name|sc
operator|->
name|vga_ram
index|[
name|offset
operator|+
literal|3
operator|*
literal|64
operator|*
name|KB
index|]
operator|=
name|c3
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|vga_mem_handler
parameter_list|(
name|struct
name|vmctx
modifier|*
name|ctx
parameter_list|,
name|int
name|vcpu
parameter_list|,
name|int
name|dir
parameter_list|,
name|uint64_t
name|addr
parameter_list|,
name|int
name|size
parameter_list|,
name|uint64_t
modifier|*
name|val
parameter_list|,
name|void
modifier|*
name|arg1
parameter_list|,
name|long
name|arg2
parameter_list|)
block|{
if|if
condition|(
name|dir
operator|==
name|MEM_F_WRITE
condition|)
block|{
switch|switch
condition|(
name|size
condition|)
block|{
case|case
literal|1
case|:
name|vga_mem_wr_handler
argument_list|(
name|ctx
argument_list|,
name|addr
argument_list|,
operator|*
name|val
argument_list|,
name|arg1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|vga_mem_wr_handler
argument_list|(
name|ctx
argument_list|,
name|addr
argument_list|,
operator|*
name|val
argument_list|,
name|arg1
argument_list|)
expr_stmt|;
name|vga_mem_wr_handler
argument_list|(
name|ctx
argument_list|,
name|addr
operator|+
literal|1
argument_list|,
operator|*
name|val
operator|>>
literal|8
argument_list|,
name|arg1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|vga_mem_wr_handler
argument_list|(
name|ctx
argument_list|,
name|addr
argument_list|,
operator|*
name|val
argument_list|,
name|arg1
argument_list|)
expr_stmt|;
name|vga_mem_wr_handler
argument_list|(
name|ctx
argument_list|,
name|addr
operator|+
literal|1
argument_list|,
operator|*
name|val
operator|>>
literal|8
argument_list|,
name|arg1
argument_list|)
expr_stmt|;
name|vga_mem_wr_handler
argument_list|(
name|ctx
argument_list|,
name|addr
operator|+
literal|2
argument_list|,
operator|*
name|val
operator|>>
literal|16
argument_list|,
name|arg1
argument_list|)
expr_stmt|;
name|vga_mem_wr_handler
argument_list|(
name|ctx
argument_list|,
name|addr
operator|+
literal|3
argument_list|,
operator|*
name|val
operator|>>
literal|24
argument_list|,
name|arg1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|8
case|:
name|vga_mem_wr_handler
argument_list|(
name|ctx
argument_list|,
name|addr
argument_list|,
operator|*
name|val
argument_list|,
name|arg1
argument_list|)
expr_stmt|;
name|vga_mem_wr_handler
argument_list|(
name|ctx
argument_list|,
name|addr
operator|+
literal|1
argument_list|,
operator|*
name|val
operator|>>
literal|8
argument_list|,
name|arg1
argument_list|)
expr_stmt|;
name|vga_mem_wr_handler
argument_list|(
name|ctx
argument_list|,
name|addr
operator|+
literal|2
argument_list|,
operator|*
name|val
operator|>>
literal|16
argument_list|,
name|arg1
argument_list|)
expr_stmt|;
name|vga_mem_wr_handler
argument_list|(
name|ctx
argument_list|,
name|addr
operator|+
literal|3
argument_list|,
operator|*
name|val
operator|>>
literal|24
argument_list|,
name|arg1
argument_list|)
expr_stmt|;
name|vga_mem_wr_handler
argument_list|(
name|ctx
argument_list|,
name|addr
operator|+
literal|4
argument_list|,
operator|*
name|val
operator|>>
literal|32
argument_list|,
name|arg1
argument_list|)
expr_stmt|;
name|vga_mem_wr_handler
argument_list|(
name|ctx
argument_list|,
name|addr
operator|+
literal|5
argument_list|,
operator|*
name|val
operator|>>
literal|40
argument_list|,
name|arg1
argument_list|)
expr_stmt|;
name|vga_mem_wr_handler
argument_list|(
name|ctx
argument_list|,
name|addr
operator|+
literal|6
argument_list|,
operator|*
name|val
operator|>>
literal|48
argument_list|,
name|arg1
argument_list|)
expr_stmt|;
name|vga_mem_wr_handler
argument_list|(
name|ctx
argument_list|,
name|addr
operator|+
literal|7
argument_list|,
operator|*
name|val
operator|>>
literal|56
argument_list|,
name|arg1
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
switch|switch
condition|(
name|size
condition|)
block|{
case|case
literal|1
case|:
operator|*
name|val
operator|=
name|vga_mem_rd_handler
argument_list|(
name|ctx
argument_list|,
name|addr
argument_list|,
name|arg1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
operator|*
name|val
operator|=
name|vga_mem_rd_handler
argument_list|(
name|ctx
argument_list|,
name|addr
argument_list|,
name|arg1
argument_list|)
expr_stmt|;
operator|*
name|val
operator||=
name|vga_mem_rd_handler
argument_list|(
name|ctx
argument_list|,
name|addr
operator|+
literal|1
argument_list|,
name|arg1
argument_list|)
operator|<<
literal|8
expr_stmt|;
break|break;
case|case
literal|4
case|:
operator|*
name|val
operator|=
name|vga_mem_rd_handler
argument_list|(
name|ctx
argument_list|,
name|addr
argument_list|,
name|arg1
argument_list|)
expr_stmt|;
operator|*
name|val
operator||=
name|vga_mem_rd_handler
argument_list|(
name|ctx
argument_list|,
name|addr
operator|+
literal|1
argument_list|,
name|arg1
argument_list|)
operator|<<
literal|8
expr_stmt|;
operator|*
name|val
operator||=
name|vga_mem_rd_handler
argument_list|(
name|ctx
argument_list|,
name|addr
operator|+
literal|2
argument_list|,
name|arg1
argument_list|)
operator|<<
literal|16
expr_stmt|;
operator|*
name|val
operator||=
name|vga_mem_rd_handler
argument_list|(
name|ctx
argument_list|,
name|addr
operator|+
literal|3
argument_list|,
name|arg1
argument_list|)
operator|<<
literal|24
expr_stmt|;
break|break;
case|case
literal|8
case|:
operator|*
name|val
operator|=
name|vga_mem_rd_handler
argument_list|(
name|ctx
argument_list|,
name|addr
argument_list|,
name|arg1
argument_list|)
expr_stmt|;
operator|*
name|val
operator||=
name|vga_mem_rd_handler
argument_list|(
name|ctx
argument_list|,
name|addr
operator|+
literal|1
argument_list|,
name|arg1
argument_list|)
operator|<<
literal|8
expr_stmt|;
operator|*
name|val
operator||=
name|vga_mem_rd_handler
argument_list|(
name|ctx
argument_list|,
name|addr
operator|+
literal|2
argument_list|,
name|arg1
argument_list|)
operator|<<
literal|16
expr_stmt|;
operator|*
name|val
operator||=
name|vga_mem_rd_handler
argument_list|(
name|ctx
argument_list|,
name|addr
operator|+
literal|3
argument_list|,
name|arg1
argument_list|)
operator|<<
literal|24
expr_stmt|;
operator|*
name|val
operator||=
name|vga_mem_rd_handler
argument_list|(
name|ctx
argument_list|,
name|addr
operator|+
literal|4
argument_list|,
name|arg1
argument_list|)
operator|<<
literal|32
expr_stmt|;
operator|*
name|val
operator||=
name|vga_mem_rd_handler
argument_list|(
name|ctx
argument_list|,
name|addr
operator|+
literal|5
argument_list|,
name|arg1
argument_list|)
operator|<<
literal|40
expr_stmt|;
operator|*
name|val
operator||=
name|vga_mem_rd_handler
argument_list|(
name|ctx
argument_list|,
name|addr
operator|+
literal|6
argument_list|,
name|arg1
argument_list|)
operator|<<
literal|48
expr_stmt|;
operator|*
name|val
operator||=
name|vga_mem_rd_handler
argument_list|(
name|ctx
argument_list|,
name|addr
operator|+
literal|7
argument_list|,
name|arg1
argument_list|)
operator|<<
literal|56
expr_stmt|;
break|break;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vga_port_in_handler
parameter_list|(
name|struct
name|vmctx
modifier|*
name|ctx
parameter_list|,
name|int
name|in
parameter_list|,
name|int
name|port
parameter_list|,
name|int
name|bytes
parameter_list|,
name|uint8_t
modifier|*
name|val
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|vga_softc
modifier|*
name|sc
init|=
name|arg
decl_stmt|;
switch|switch
condition|(
name|port
condition|)
block|{
case|case
name|CRTC_IDX_MONO_PORT
case|:
case|case
name|CRTC_IDX_COLOR_PORT
case|:
operator|*
name|val
operator|=
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_index
expr_stmt|;
break|break;
case|case
name|CRTC_DATA_MONO_PORT
case|:
case|case
name|CRTC_DATA_COLOR_PORT
case|:
switch|switch
condition|(
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_index
condition|)
block|{
case|case
name|CRTC_HORIZ_TOTAL
case|:
operator|*
name|val
operator|=
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_horiz_total
expr_stmt|;
break|break;
case|case
name|CRTC_HORIZ_DISP_END
case|:
operator|*
name|val
operator|=
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_horiz_disp_end
expr_stmt|;
break|break;
case|case
name|CRTC_START_HORIZ_BLANK
case|:
operator|*
name|val
operator|=
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_start_horiz_blank
expr_stmt|;
break|break;
case|case
name|CRTC_END_HORIZ_BLANK
case|:
operator|*
name|val
operator|=
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_end_horiz_blank
expr_stmt|;
break|break;
case|case
name|CRTC_START_HORIZ_RETRACE
case|:
operator|*
name|val
operator|=
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_start_horiz_retrace
expr_stmt|;
break|break;
case|case
name|CRTC_END_HORIZ_RETRACE
case|:
operator|*
name|val
operator|=
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_end_horiz_retrace
expr_stmt|;
break|break;
case|case
name|CRTC_VERT_TOTAL
case|:
operator|*
name|val
operator|=
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_vert_total
expr_stmt|;
break|break;
case|case
name|CRTC_OVERFLOW
case|:
operator|*
name|val
operator|=
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_overflow
expr_stmt|;
break|break;
case|case
name|CRTC_PRESET_ROW_SCAN
case|:
operator|*
name|val
operator|=
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_present_row_scan
expr_stmt|;
break|break;
case|case
name|CRTC_MAX_SCAN_LINE
case|:
operator|*
name|val
operator|=
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_max_scan_line
expr_stmt|;
break|break;
case|case
name|CRTC_CURSOR_START
case|:
operator|*
name|val
operator|=
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_cursor_start
expr_stmt|;
break|break;
case|case
name|CRTC_CURSOR_END
case|:
operator|*
name|val
operator|=
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_cursor_end
expr_stmt|;
break|break;
case|case
name|CRTC_START_ADDR_HIGH
case|:
operator|*
name|val
operator|=
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_start_addr_high
expr_stmt|;
break|break;
case|case
name|CRTC_START_ADDR_LOW
case|:
operator|*
name|val
operator|=
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_start_addr_low
expr_stmt|;
break|break;
case|case
name|CRTC_CURSOR_LOC_HIGH
case|:
operator|*
name|val
operator|=
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_cursor_loc_high
expr_stmt|;
break|break;
case|case
name|CRTC_CURSOR_LOC_LOW
case|:
operator|*
name|val
operator|=
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_cursor_loc_low
expr_stmt|;
break|break;
case|case
name|CRTC_VERT_RETRACE_START
case|:
operator|*
name|val
operator|=
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_vert_retrace_start
expr_stmt|;
break|break;
case|case
name|CRTC_VERT_RETRACE_END
case|:
operator|*
name|val
operator|=
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_vert_retrace_end
expr_stmt|;
break|break;
case|case
name|CRTC_VERT_DISP_END
case|:
operator|*
name|val
operator|=
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_vert_disp_end
expr_stmt|;
break|break;
case|case
name|CRTC_OFFSET
case|:
operator|*
name|val
operator|=
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_offset
expr_stmt|;
break|break;
case|case
name|CRTC_UNDERLINE_LOC
case|:
operator|*
name|val
operator|=
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_underline_loc
expr_stmt|;
break|break;
case|case
name|CRTC_START_VERT_BLANK
case|:
operator|*
name|val
operator|=
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_start_vert_blank
expr_stmt|;
break|break;
case|case
name|CRTC_END_VERT_BLANK
case|:
operator|*
name|val
operator|=
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_end_vert_blank
expr_stmt|;
break|break;
case|case
name|CRTC_MODE_CONTROL
case|:
operator|*
name|val
operator|=
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_mode_ctrl
expr_stmt|;
break|break;
case|case
name|CRTC_LINE_COMPARE
case|:
operator|*
name|val
operator|=
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_line_compare
expr_stmt|;
break|break;
default|default:
comment|//printf("XXX VGA CRTC: inb 0x%04x at index %d\n", port, sc->vga_crtc.crtc_index);
name|assert
argument_list|(
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|ATC_IDX_PORT
case|:
operator|*
name|val
operator|=
name|sc
operator|->
name|vga_atc
operator|.
name|atc_index
expr_stmt|;
break|break;
case|case
name|ATC_DATA_PORT
case|:
switch|switch
condition|(
name|sc
operator|->
name|vga_atc
operator|.
name|atc_index
condition|)
block|{
case|case
name|ATC_PALETTE0
operator|...
name|ATC_PALETTE15
case|:
operator|*
name|val
operator|=
name|sc
operator|->
name|vga_atc
operator|.
name|atc_palette
index|[
name|sc
operator|->
name|vga_atc
operator|.
name|atc_index
index|]
expr_stmt|;
break|break;
case|case
name|ATC_MODE_CONTROL
case|:
operator|*
name|val
operator|=
name|sc
operator|->
name|vga_atc
operator|.
name|atc_mode
expr_stmt|;
break|break;
case|case
name|ATC_OVERSCAN_COLOR
case|:
operator|*
name|val
operator|=
name|sc
operator|->
name|vga_atc
operator|.
name|atc_overscan_color
expr_stmt|;
break|break;
case|case
name|ATC_COLOR_PLANE_ENABLE
case|:
operator|*
name|val
operator|=
name|sc
operator|->
name|vga_atc
operator|.
name|atc_color_plane_enb
expr_stmt|;
break|break;
case|case
name|ATC_HORIZ_PIXEL_PANNING
case|:
operator|*
name|val
operator|=
name|sc
operator|->
name|vga_atc
operator|.
name|atc_horiz_pixel_panning
expr_stmt|;
break|break;
case|case
name|ATC_COLOR_SELECT
case|:
operator|*
name|val
operator|=
name|sc
operator|->
name|vga_atc
operator|.
name|atc_color_select
expr_stmt|;
break|break;
default|default:
comment|//printf("XXX VGA ATC inb 0x%04x at index %d\n", port , sc->vga_atc.atc_index);
name|assert
argument_list|(
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|SEQ_IDX_PORT
case|:
operator|*
name|val
operator|=
name|sc
operator|->
name|vga_seq
operator|.
name|seq_index
expr_stmt|;
break|break;
case|case
name|SEQ_DATA_PORT
case|:
switch|switch
condition|(
name|sc
operator|->
name|vga_seq
operator|.
name|seq_index
condition|)
block|{
case|case
name|SEQ_RESET
case|:
operator|*
name|val
operator|=
name|sc
operator|->
name|vga_seq
operator|.
name|seq_reset
expr_stmt|;
break|break;
case|case
name|SEQ_CLOCKING_MODE
case|:
operator|*
name|val
operator|=
name|sc
operator|->
name|vga_seq
operator|.
name|seq_clock_mode
expr_stmt|;
break|break;
case|case
name|SEQ_MAP_MASK
case|:
operator|*
name|val
operator|=
name|sc
operator|->
name|vga_seq
operator|.
name|seq_map_mask
expr_stmt|;
break|break;
case|case
name|SEQ_CHAR_MAP_SELECT
case|:
operator|*
name|val
operator|=
name|sc
operator|->
name|vga_seq
operator|.
name|seq_cmap_sel
expr_stmt|;
break|break;
case|case
name|SEQ_MEMORY_MODE
case|:
operator|*
name|val
operator|=
name|sc
operator|->
name|vga_seq
operator|.
name|seq_mm
expr_stmt|;
break|break;
default|default:
comment|//printf("XXX VGA SEQ: inb 0x%04x at index %d\n", port, sc->vga_seq.seq_index);
name|assert
argument_list|(
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|DAC_DATA_PORT
case|:
operator|*
name|val
operator|=
name|sc
operator|->
name|vga_dac
operator|.
name|dac_palette
index|[
literal|3
operator|*
name|sc
operator|->
name|vga_dac
operator|.
name|dac_rd_index
operator|+
name|sc
operator|->
name|vga_dac
operator|.
name|dac_rd_subindex
index|]
expr_stmt|;
name|sc
operator|->
name|vga_dac
operator|.
name|dac_rd_subindex
operator|++
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|vga_dac
operator|.
name|dac_rd_subindex
operator|==
literal|3
condition|)
block|{
name|sc
operator|->
name|vga_dac
operator|.
name|dac_rd_index
operator|++
expr_stmt|;
name|sc
operator|->
name|vga_dac
operator|.
name|dac_rd_subindex
operator|=
literal|0
expr_stmt|;
block|}
break|break;
case|case
name|GC_IDX_PORT
case|:
operator|*
name|val
operator|=
name|sc
operator|->
name|vga_gc
operator|.
name|gc_index
expr_stmt|;
break|break;
case|case
name|GC_DATA_PORT
case|:
switch|switch
condition|(
name|sc
operator|->
name|vga_gc
operator|.
name|gc_index
condition|)
block|{
case|case
name|GC_SET_RESET
case|:
operator|*
name|val
operator|=
name|sc
operator|->
name|vga_gc
operator|.
name|gc_set_reset
expr_stmt|;
break|break;
case|case
name|GC_ENABLE_SET_RESET
case|:
operator|*
name|val
operator|=
name|sc
operator|->
name|vga_gc
operator|.
name|gc_enb_set_reset
expr_stmt|;
break|break;
case|case
name|GC_COLOR_COMPARE
case|:
operator|*
name|val
operator|=
name|sc
operator|->
name|vga_gc
operator|.
name|gc_color_compare
expr_stmt|;
break|break;
case|case
name|GC_DATA_ROTATE
case|:
operator|*
name|val
operator|=
name|sc
operator|->
name|vga_gc
operator|.
name|gc_rotate
expr_stmt|;
break|break;
case|case
name|GC_READ_MAP_SELECT
case|:
operator|*
name|val
operator|=
name|sc
operator|->
name|vga_gc
operator|.
name|gc_read_map_sel
expr_stmt|;
break|break;
case|case
name|GC_MODE
case|:
operator|*
name|val
operator|=
name|sc
operator|->
name|vga_gc
operator|.
name|gc_mode
expr_stmt|;
break|break;
case|case
name|GC_MISCELLANEOUS
case|:
operator|*
name|val
operator|=
name|sc
operator|->
name|vga_gc
operator|.
name|gc_misc
expr_stmt|;
break|break;
case|case
name|GC_COLOR_DONT_CARE
case|:
operator|*
name|val
operator|=
name|sc
operator|->
name|vga_gc
operator|.
name|gc_color_dont_care
expr_stmt|;
break|break;
case|case
name|GC_BIT_MASK
case|:
operator|*
name|val
operator|=
name|sc
operator|->
name|vga_gc
operator|.
name|gc_bit_mask
expr_stmt|;
break|break;
default|default:
comment|//printf("XXX VGA GC: inb 0x%04x at index %d\n", port, sc->vga_crtc.crtc_index);
name|assert
argument_list|(
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|GEN_MISC_OUTPUT_PORT
case|:
operator|*
name|val
operator|=
name|sc
operator|->
name|vga_misc
expr_stmt|;
break|break;
case|case
name|GEN_INPUT_STS0_PORT
case|:
name|assert
argument_list|(
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|GEN_INPUT_STS1_MONO_PORT
case|:
case|case
name|GEN_INPUT_STS1_COLOR_PORT
case|:
name|sc
operator|->
name|vga_atc
operator|.
name|atc_flipflop
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|vga_sts1
operator|=
name|GEN_IS1_VR
operator||
name|GEN_IS1_DE
expr_stmt|;
comment|//sc->vga_sts1 ^= (GEN_IS1_VR | GEN_IS1_DE);
operator|*
name|val
operator|=
name|sc
operator|->
name|vga_sts1
expr_stmt|;
break|break;
case|case
name|GEN_FEATURE_CTRL_PORT
case|:
comment|// OpenBSD calls this with bytes = 1
comment|//assert(0);
operator|*
name|val
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|0x3c3
case|:
operator|*
name|val
operator|=
literal|0
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"XXX vga_port_in_handler() unhandled port 0x%x\n"
argument_list|,
name|port
argument_list|)
expr_stmt|;
comment|//assert(0);
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vga_port_out_handler
parameter_list|(
name|struct
name|vmctx
modifier|*
name|ctx
parameter_list|,
name|int
name|in
parameter_list|,
name|int
name|port
parameter_list|,
name|int
name|bytes
parameter_list|,
name|uint8_t
name|val
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|vga_softc
modifier|*
name|sc
init|=
name|arg
decl_stmt|;
switch|switch
condition|(
name|port
condition|)
block|{
case|case
name|CRTC_IDX_MONO_PORT
case|:
case|case
name|CRTC_IDX_COLOR_PORT
case|:
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_index
operator|=
name|val
expr_stmt|;
break|break;
case|case
name|CRTC_DATA_MONO_PORT
case|:
case|case
name|CRTC_DATA_COLOR_PORT
case|:
switch|switch
condition|(
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_index
condition|)
block|{
case|case
name|CRTC_HORIZ_TOTAL
case|:
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_horiz_total
operator|=
name|val
expr_stmt|;
break|break;
case|case
name|CRTC_HORIZ_DISP_END
case|:
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_horiz_disp_end
operator|=
name|val
expr_stmt|;
break|break;
case|case
name|CRTC_START_HORIZ_BLANK
case|:
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_start_horiz_blank
operator|=
name|val
expr_stmt|;
break|break;
case|case
name|CRTC_END_HORIZ_BLANK
case|:
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_end_horiz_blank
operator|=
name|val
expr_stmt|;
break|break;
case|case
name|CRTC_START_HORIZ_RETRACE
case|:
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_start_horiz_retrace
operator|=
name|val
expr_stmt|;
break|break;
case|case
name|CRTC_END_HORIZ_RETRACE
case|:
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_end_horiz_retrace
operator|=
name|val
expr_stmt|;
break|break;
case|case
name|CRTC_VERT_TOTAL
case|:
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_vert_total
operator|=
name|val
expr_stmt|;
break|break;
case|case
name|CRTC_OVERFLOW
case|:
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_overflow
operator|=
name|val
expr_stmt|;
break|break;
case|case
name|CRTC_PRESET_ROW_SCAN
case|:
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_present_row_scan
operator|=
name|val
expr_stmt|;
break|break;
case|case
name|CRTC_MAX_SCAN_LINE
case|:
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_max_scan_line
operator|=
name|val
expr_stmt|;
break|break;
case|case
name|CRTC_CURSOR_START
case|:
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_cursor_start
operator|=
name|val
expr_stmt|;
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_cursor_on
operator|=
operator|(
name|val
operator|&
name|CRTC_CS_CO
operator|)
operator|==
literal|0
expr_stmt|;
break|break;
case|case
name|CRTC_CURSOR_END
case|:
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_cursor_end
operator|=
name|val
expr_stmt|;
break|break;
case|case
name|CRTC_START_ADDR_HIGH
case|:
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_start_addr_high
operator|=
name|val
expr_stmt|;
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_start_addr
operator|&=
literal|0x00ff
expr_stmt|;
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_start_addr
operator||=
operator|(
name|val
operator|<<
literal|8
operator|)
expr_stmt|;
break|break;
case|case
name|CRTC_START_ADDR_LOW
case|:
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_start_addr_low
operator|=
name|val
expr_stmt|;
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_start_addr
operator|&=
literal|0xff00
expr_stmt|;
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_start_addr
operator||=
operator|(
name|val
operator|&
literal|0xff
operator|)
expr_stmt|;
break|break;
case|case
name|CRTC_CURSOR_LOC_HIGH
case|:
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_cursor_loc_high
operator|=
name|val
expr_stmt|;
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_cursor_loc
operator|&=
literal|0x00ff
expr_stmt|;
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_cursor_loc
operator||=
operator|(
name|val
operator|<<
literal|8
operator|)
expr_stmt|;
break|break;
case|case
name|CRTC_CURSOR_LOC_LOW
case|:
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_cursor_loc_low
operator|=
name|val
expr_stmt|;
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_cursor_loc
operator|&=
literal|0xff00
expr_stmt|;
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_cursor_loc
operator||=
operator|(
name|val
operator|&
literal|0xff
operator|)
expr_stmt|;
break|break;
case|case
name|CRTC_VERT_RETRACE_START
case|:
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_vert_retrace_start
operator|=
name|val
expr_stmt|;
break|break;
case|case
name|CRTC_VERT_RETRACE_END
case|:
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_vert_retrace_end
operator|=
name|val
expr_stmt|;
break|break;
case|case
name|CRTC_VERT_DISP_END
case|:
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_vert_disp_end
operator|=
name|val
expr_stmt|;
break|break;
case|case
name|CRTC_OFFSET
case|:
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_offset
operator|=
name|val
expr_stmt|;
break|break;
case|case
name|CRTC_UNDERLINE_LOC
case|:
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_underline_loc
operator|=
name|val
expr_stmt|;
break|break;
case|case
name|CRTC_START_VERT_BLANK
case|:
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_start_vert_blank
operator|=
name|val
expr_stmt|;
break|break;
case|case
name|CRTC_END_VERT_BLANK
case|:
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_end_vert_blank
operator|=
name|val
expr_stmt|;
break|break;
case|case
name|CRTC_MODE_CONTROL
case|:
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_mode_ctrl
operator|=
name|val
expr_stmt|;
break|break;
case|case
name|CRTC_LINE_COMPARE
case|:
name|sc
operator|->
name|vga_crtc
operator|.
name|crtc_line_compare
operator|=
name|val
expr_stmt|;
break|break;
default|default:
comment|//printf("XXX VGA CRTC: outb 0x%04x, 0x%02x at index %d\n", port, val, sc->vga_crtc.crtc_index);
name|assert
argument_list|(
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|ATC_IDX_PORT
case|:
if|if
condition|(
name|sc
operator|->
name|vga_atc
operator|.
name|atc_flipflop
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|vga_atc
operator|.
name|atc_index
operator|&
literal|0x20
condition|)
name|assert
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vga_atc
operator|.
name|atc_index
operator|=
name|val
operator|&
name|ATC_IDX_MASK
expr_stmt|;
block|}
else|else
block|{
switch|switch
condition|(
name|sc
operator|->
name|vga_atc
operator|.
name|atc_index
condition|)
block|{
case|case
name|ATC_PALETTE0
operator|...
name|ATC_PALETTE15
case|:
name|sc
operator|->
name|vga_atc
operator|.
name|atc_palette
index|[
name|sc
operator|->
name|vga_atc
operator|.
name|atc_index
index|]
operator|=
name|val
operator|&
literal|0x3f
expr_stmt|;
break|break;
case|case
name|ATC_MODE_CONTROL
case|:
name|sc
operator|->
name|vga_atc
operator|.
name|atc_mode
operator|=
name|val
expr_stmt|;
break|break;
case|case
name|ATC_OVERSCAN_COLOR
case|:
name|sc
operator|->
name|vga_atc
operator|.
name|atc_overscan_color
operator|=
name|val
expr_stmt|;
break|break;
case|case
name|ATC_COLOR_PLANE_ENABLE
case|:
name|sc
operator|->
name|vga_atc
operator|.
name|atc_color_plane_enb
operator|=
name|val
expr_stmt|;
break|break;
case|case
name|ATC_HORIZ_PIXEL_PANNING
case|:
name|sc
operator|->
name|vga_atc
operator|.
name|atc_horiz_pixel_panning
operator|=
name|val
expr_stmt|;
break|break;
case|case
name|ATC_COLOR_SELECT
case|:
name|sc
operator|->
name|vga_atc
operator|.
name|atc_color_select
operator|=
name|val
expr_stmt|;
name|sc
operator|->
name|vga_atc
operator|.
name|atc_color_select_45
operator|=
operator|(
name|val
operator|&
name|ATC_CS_C45
operator|)
operator|<<
literal|4
expr_stmt|;
name|sc
operator|->
name|vga_atc
operator|.
name|atc_color_select_67
operator|=
operator|(
name|val
operator|&
name|ATC_CS_C67
operator|)
operator|<<
literal|6
expr_stmt|;
break|break;
default|default:
comment|//printf("XXX VGA ATC: outb 0x%04x, 0x%02x at index %d\n", port, val, sc->vga_atc.atc_index);
name|assert
argument_list|(
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|sc
operator|->
name|vga_atc
operator|.
name|atc_flipflop
operator|^=
literal|1
expr_stmt|;
break|break;
case|case
name|ATC_DATA_PORT
case|:
break|break;
case|case
name|SEQ_IDX_PORT
case|:
name|sc
operator|->
name|vga_seq
operator|.
name|seq_index
operator|=
name|val
operator|&
literal|0x1f
expr_stmt|;
break|break;
case|case
name|SEQ_DATA_PORT
case|:
switch|switch
condition|(
name|sc
operator|->
name|vga_seq
operator|.
name|seq_index
condition|)
block|{
case|case
name|SEQ_RESET
case|:
name|sc
operator|->
name|vga_seq
operator|.
name|seq_reset
operator|=
name|val
expr_stmt|;
break|break;
case|case
name|SEQ_CLOCKING_MODE
case|:
name|sc
operator|->
name|vga_seq
operator|.
name|seq_clock_mode
operator|=
name|val
expr_stmt|;
name|sc
operator|->
name|vga_seq
operator|.
name|seq_cm_dots
operator|=
operator|(
name|val
operator|&
name|SEQ_CM_89
operator|)
condition|?
literal|8
else|:
literal|9
expr_stmt|;
break|break;
case|case
name|SEQ_MAP_MASK
case|:
name|sc
operator|->
name|vga_seq
operator|.
name|seq_map_mask
operator|=
name|val
expr_stmt|;
break|break;
case|case
name|SEQ_CHAR_MAP_SELECT
case|:
name|sc
operator|->
name|vga_seq
operator|.
name|seq_cmap_sel
operator|=
name|val
expr_stmt|;
name|sc
operator|->
name|vga_seq
operator|.
name|seq_cmap_pri_off
operator|=
operator|(
operator|(
operator|(
operator|(
name|val
operator|&
name|SEQ_CMS_SA
operator|)
operator|>>
name|SEQ_CMS_SA_SHIFT
operator|)
operator|*
literal|2
operator|)
operator|+
operator|(
operator|(
name|val
operator|&
name|SEQ_CMS_SAH
operator|)
operator|>>
name|SEQ_CMS_SAH_SHIFT
operator|)
operator|)
operator|*
literal|8
operator|*
name|KB
expr_stmt|;
name|sc
operator|->
name|vga_seq
operator|.
name|seq_cmap_sec_off
operator|=
operator|(
operator|(
operator|(
operator|(
name|val
operator|&
name|SEQ_CMS_SB
operator|)
operator|>>
name|SEQ_CMS_SB_SHIFT
operator|)
operator|*
literal|2
operator|)
operator|+
operator|(
operator|(
name|val
operator|&
name|SEQ_CMS_SBH
operator|)
operator|>>
name|SEQ_CMS_SBH_SHIFT
operator|)
operator|)
operator|*
literal|8
operator|*
name|KB
expr_stmt|;
break|break;
case|case
name|SEQ_MEMORY_MODE
case|:
name|sc
operator|->
name|vga_seq
operator|.
name|seq_mm
operator|=
name|val
expr_stmt|;
comment|/* Windows queries Chain4 */
comment|//assert((sc->vga_seq.seq_mm& SEQ_MM_C4) == 0);
break|break;
default|default:
comment|//printf("XXX VGA SEQ: outb 0x%04x, 0x%02x at index %d\n", port, val, sc->vga_seq.seq_index);
name|assert
argument_list|(
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|DAC_MASK
case|:
break|break;
case|case
name|DAC_IDX_RD_PORT
case|:
name|sc
operator|->
name|vga_dac
operator|.
name|dac_rd_index
operator|=
name|val
expr_stmt|;
name|sc
operator|->
name|vga_dac
operator|.
name|dac_rd_subindex
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|DAC_IDX_WR_PORT
case|:
name|sc
operator|->
name|vga_dac
operator|.
name|dac_wr_index
operator|=
name|val
expr_stmt|;
name|sc
operator|->
name|vga_dac
operator|.
name|dac_wr_subindex
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|DAC_DATA_PORT
case|:
name|sc
operator|->
name|vga_dac
operator|.
name|dac_palette
index|[
literal|3
operator|*
name|sc
operator|->
name|vga_dac
operator|.
name|dac_wr_index
operator|+
name|sc
operator|->
name|vga_dac
operator|.
name|dac_wr_subindex
index|]
operator|=
name|val
expr_stmt|;
name|sc
operator|->
name|vga_dac
operator|.
name|dac_wr_subindex
operator|++
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|vga_dac
operator|.
name|dac_wr_subindex
operator|==
literal|3
condition|)
block|{
name|sc
operator|->
name|vga_dac
operator|.
name|dac_palette_rgb
index|[
name|sc
operator|->
name|vga_dac
operator|.
name|dac_wr_index
index|]
operator|=
operator|(
operator|(
operator|(
operator|(
name|sc
operator|->
name|vga_dac
operator|.
name|dac_palette
index|[
literal|3
operator|*
name|sc
operator|->
name|vga_dac
operator|.
name|dac_wr_index
operator|+
literal|0
index|]
operator|<<
literal|2
operator|)
operator||
operator|(
operator|(
name|sc
operator|->
name|vga_dac
operator|.
name|dac_palette
index|[
literal|3
operator|*
name|sc
operator|->
name|vga_dac
operator|.
name|dac_wr_index
operator|+
literal|0
index|]
operator|&
literal|0x1
operator|)
operator|<<
literal|1
operator|)
operator||
operator|(
name|sc
operator|->
name|vga_dac
operator|.
name|dac_palette
index|[
literal|3
operator|*
name|sc
operator|->
name|vga_dac
operator|.
name|dac_wr_index
operator|+
literal|0
index|]
operator|&
literal|0x1
operator|)
operator|)
operator|<<
literal|16
operator|)
operator||
operator|(
operator|(
operator|(
name|sc
operator|->
name|vga_dac
operator|.
name|dac_palette
index|[
literal|3
operator|*
name|sc
operator|->
name|vga_dac
operator|.
name|dac_wr_index
operator|+
literal|1
index|]
operator|<<
literal|2
operator|)
operator||
operator|(
operator|(
name|sc
operator|->
name|vga_dac
operator|.
name|dac_palette
index|[
literal|3
operator|*
name|sc
operator|->
name|vga_dac
operator|.
name|dac_wr_index
operator|+
literal|1
index|]
operator|&
literal|0x1
operator|)
operator|<<
literal|1
operator|)
operator||
operator|(
name|sc
operator|->
name|vga_dac
operator|.
name|dac_palette
index|[
literal|3
operator|*
name|sc
operator|->
name|vga_dac
operator|.
name|dac_wr_index
operator|+
literal|1
index|]
operator|&
literal|0x1
operator|)
operator|)
operator|<<
literal|8
operator|)
operator||
operator|(
operator|(
operator|(
name|sc
operator|->
name|vga_dac
operator|.
name|dac_palette
index|[
literal|3
operator|*
name|sc
operator|->
name|vga_dac
operator|.
name|dac_wr_index
operator|+
literal|2
index|]
operator|<<
literal|2
operator|)
operator||
operator|(
operator|(
name|sc
operator|->
name|vga_dac
operator|.
name|dac_palette
index|[
literal|3
operator|*
name|sc
operator|->
name|vga_dac
operator|.
name|dac_wr_index
operator|+
literal|2
index|]
operator|&
literal|0x1
operator|)
operator|<<
literal|1
operator|)
operator||
operator|(
name|sc
operator|->
name|vga_dac
operator|.
name|dac_palette
index|[
literal|3
operator|*
name|sc
operator|->
name|vga_dac
operator|.
name|dac_wr_index
operator|+
literal|2
index|]
operator|&
literal|0x1
operator|)
operator|)
operator|<<
literal|0
operator|)
operator|)
expr_stmt|;
name|sc
operator|->
name|vga_dac
operator|.
name|dac_wr_index
operator|++
expr_stmt|;
name|sc
operator|->
name|vga_dac
operator|.
name|dac_wr_subindex
operator|=
literal|0
expr_stmt|;
block|}
break|break;
case|case
name|GC_IDX_PORT
case|:
name|sc
operator|->
name|vga_gc
operator|.
name|gc_index
operator|=
name|val
expr_stmt|;
break|break;
case|case
name|GC_DATA_PORT
case|:
switch|switch
condition|(
name|sc
operator|->
name|vga_gc
operator|.
name|gc_index
condition|)
block|{
case|case
name|GC_SET_RESET
case|:
name|sc
operator|->
name|vga_gc
operator|.
name|gc_set_reset
operator|=
name|val
expr_stmt|;
break|break;
case|case
name|GC_ENABLE_SET_RESET
case|:
name|sc
operator|->
name|vga_gc
operator|.
name|gc_enb_set_reset
operator|=
name|val
expr_stmt|;
break|break;
case|case
name|GC_COLOR_COMPARE
case|:
name|sc
operator|->
name|vga_gc
operator|.
name|gc_color_compare
operator|=
name|val
expr_stmt|;
break|break;
case|case
name|GC_DATA_ROTATE
case|:
name|sc
operator|->
name|vga_gc
operator|.
name|gc_rotate
operator|=
name|val
expr_stmt|;
name|sc
operator|->
name|vga_gc
operator|.
name|gc_op
operator|=
operator|(
name|val
operator|>>
literal|3
operator|)
operator|&
literal|0x3
expr_stmt|;
break|break;
case|case
name|GC_READ_MAP_SELECT
case|:
name|sc
operator|->
name|vga_gc
operator|.
name|gc_read_map_sel
operator|=
name|val
expr_stmt|;
break|break;
case|case
name|GC_MODE
case|:
name|sc
operator|->
name|vga_gc
operator|.
name|gc_mode
operator|=
name|val
expr_stmt|;
name|sc
operator|->
name|vga_gc
operator|.
name|gc_mode_c4
operator|=
operator|(
name|val
operator|&
name|GC_MODE_C4
operator|)
operator|!=
literal|0
expr_stmt|;
name|assert
argument_list|(
operator|!
name|sc
operator|->
name|vga_gc
operator|.
name|gc_mode_c4
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vga_gc
operator|.
name|gc_mode_oe
operator|=
operator|(
name|val
operator|&
name|GC_MODE_OE
operator|)
operator|!=
literal|0
expr_stmt|;
name|sc
operator|->
name|vga_gc
operator|.
name|gc_mode_rm
operator|=
operator|(
name|val
operator|>>
literal|3
operator|)
operator|&
literal|0x1
expr_stmt|;
name|sc
operator|->
name|vga_gc
operator|.
name|gc_mode_wm
operator|=
name|val
operator|&
literal|0x3
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|gc_image
condition|)
name|sc
operator|->
name|gc_image
operator|->
name|vgamode
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|GC_MISCELLANEOUS
case|:
name|sc
operator|->
name|vga_gc
operator|.
name|gc_misc
operator|=
name|val
expr_stmt|;
name|sc
operator|->
name|vga_gc
operator|.
name|gc_misc_gm
operator|=
name|val
operator|&
name|GC_MISC_GM
expr_stmt|;
name|sc
operator|->
name|vga_gc
operator|.
name|gc_misc_mm
operator|=
operator|(
name|val
operator|&
name|GC_MISC_MM
operator|)
operator|>>
name|GC_MISC_MM_SHIFT
expr_stmt|;
break|break;
case|case
name|GC_COLOR_DONT_CARE
case|:
name|sc
operator|->
name|vga_gc
operator|.
name|gc_color_dont_care
operator|=
name|val
expr_stmt|;
break|break;
case|case
name|GC_BIT_MASK
case|:
name|sc
operator|->
name|vga_gc
operator|.
name|gc_bit_mask
operator|=
name|val
expr_stmt|;
break|break;
default|default:
comment|//printf("XXX VGA GC: outb 0x%04x, 0x%02x at index %d\n", port, val, sc->vga_gc.gc_index);
name|assert
argument_list|(
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|GEN_INPUT_STS0_PORT
case|:
comment|/* write to Miscellaneous Output Register */
name|sc
operator|->
name|vga_misc
operator|=
name|val
expr_stmt|;
break|break;
case|case
name|GEN_INPUT_STS1_MONO_PORT
case|:
case|case
name|GEN_INPUT_STS1_COLOR_PORT
case|:
comment|/* write to Feature Control Register */
break|break;
comment|//	case 0x3c3:
comment|//		break;
default|default:
name|printf
argument_list|(
literal|"XXX vga_port_out_handler() unhandled port 0x%x, val 0x%x\n"
argument_list|,
name|port
argument_list|,
name|val
argument_list|)
expr_stmt|;
comment|//assert(0);
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vga_port_handler
parameter_list|(
name|struct
name|vmctx
modifier|*
name|ctx
parameter_list|,
name|int
name|vcpu
parameter_list|,
name|int
name|in
parameter_list|,
name|int
name|port
parameter_list|,
name|int
name|bytes
parameter_list|,
name|uint32_t
modifier|*
name|eax
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|uint8_t
name|val
decl_stmt|;
name|int
name|error
decl_stmt|;
switch|switch
condition|(
name|bytes
condition|)
block|{
case|case
literal|1
case|:
if|if
condition|(
name|in
condition|)
block|{
operator|*
name|eax
operator|&=
operator|~
literal|0xff
expr_stmt|;
name|error
operator|=
name|vga_port_in_handler
argument_list|(
name|ctx
argument_list|,
name|in
argument_list|,
name|port
argument_list|,
literal|1
argument_list|,
operator|&
name|val
argument_list|,
name|arg
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
block|{
operator|*
name|eax
operator||=
name|val
operator|&
literal|0xff
expr_stmt|;
block|}
block|}
else|else
block|{
name|val
operator|=
operator|*
name|eax
operator|&
literal|0xff
expr_stmt|;
name|error
operator|=
name|vga_port_out_handler
argument_list|(
name|ctx
argument_list|,
name|in
argument_list|,
name|port
argument_list|,
literal|1
argument_list|,
name|val
argument_list|,
name|arg
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|2
case|:
if|if
condition|(
name|in
condition|)
block|{
operator|*
name|eax
operator|&=
operator|~
literal|0xffff
expr_stmt|;
name|error
operator|=
name|vga_port_in_handler
argument_list|(
name|ctx
argument_list|,
name|in
argument_list|,
name|port
argument_list|,
literal|1
argument_list|,
operator|&
name|val
argument_list|,
name|arg
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
block|{
operator|*
name|eax
operator||=
name|val
operator|&
literal|0xff
expr_stmt|;
block|}
name|error
operator|=
name|vga_port_in_handler
argument_list|(
name|ctx
argument_list|,
name|in
argument_list|,
name|port
operator|+
literal|1
argument_list|,
literal|1
argument_list|,
operator|&
name|val
argument_list|,
name|arg
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
block|{
operator|*
name|eax
operator||=
operator|(
name|val
operator|&
literal|0xff
operator|)
operator|<<
literal|8
expr_stmt|;
block|}
block|}
else|else
block|{
name|val
operator|=
operator|*
name|eax
operator|&
literal|0xff
expr_stmt|;
name|error
operator|=
name|vga_port_out_handler
argument_list|(
name|ctx
argument_list|,
name|in
argument_list|,
name|port
argument_list|,
literal|1
argument_list|,
name|val
argument_list|,
name|arg
argument_list|)
expr_stmt|;
name|val
operator|=
operator|(
operator|*
name|eax
operator|>>
literal|8
operator|)
operator|&
literal|0xff
expr_stmt|;
name|error
operator|=
name|vga_port_out_handler
argument_list|(
name|ctx
argument_list|,
name|in
argument_list|,
name|port
operator|+
literal|1
argument_list|,
literal|1
argument_list|,
name|val
argument_list|,
name|arg
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|assert
argument_list|(
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
name|void
modifier|*
name|vga_init
parameter_list|(
name|int
name|io_only
parameter_list|)
block|{
name|struct
name|inout_port
name|iop
decl_stmt|;
name|struct
name|vga_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|port
decl_stmt|,
name|error
decl_stmt|;
name|sc
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|vga_softc
argument_list|)
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|iop
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|inout_port
argument_list|)
argument_list|)
expr_stmt|;
name|iop
operator|.
name|name
operator|=
literal|"VGA"
expr_stmt|;
for|for
control|(
name|port
operator|=
name|VGA_IOPORT_START
init|;
name|port
operator|<=
name|VGA_IOPORT_END
condition|;
name|port
operator|++
control|)
block|{
name|iop
operator|.
name|port
operator|=
name|port
expr_stmt|;
name|iop
operator|.
name|size
operator|=
literal|1
expr_stmt|;
name|iop
operator|.
name|flags
operator|=
name|IOPORT_F_INOUT
expr_stmt|;
name|iop
operator|.
name|handler
operator|=
name|vga_port_handler
expr_stmt|;
name|iop
operator|.
name|arg
operator|=
name|sc
expr_stmt|;
name|error
operator|=
name|register_inout
argument_list|(
operator|&
name|iop
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|error
operator|==
literal|0
argument_list|)
expr_stmt|;
block|}
name|sc
operator|->
name|gc_image
operator|=
name|console_get_image
argument_list|()
expr_stmt|;
comment|/* only handle io ports; vga graphics is disabled */
if|if
condition|(
name|io_only
condition|)
return|return
operator|(
name|sc
operator|)
return|;
name|sc
operator|->
name|mr
operator|.
name|name
operator|=
literal|"VGA memory"
expr_stmt|;
name|sc
operator|->
name|mr
operator|.
name|flags
operator|=
name|MEM_F_RW
expr_stmt|;
name|sc
operator|->
name|mr
operator|.
name|base
operator|=
literal|640
operator|*
name|KB
expr_stmt|;
name|sc
operator|->
name|mr
operator|.
name|size
operator|=
literal|128
operator|*
name|KB
expr_stmt|;
name|sc
operator|->
name|mr
operator|.
name|handler
operator|=
name|vga_mem_handler
expr_stmt|;
name|sc
operator|->
name|mr
operator|.
name|arg1
operator|=
name|sc
expr_stmt|;
name|error
operator|=
name|register_mem_fallback
argument_list|(
operator|&
name|sc
operator|->
name|mr
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|error
operator|==
literal|0
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vga_ram
operator|=
name|malloc
argument_list|(
literal|256
operator|*
name|KB
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|sc
operator|->
name|vga_ram
argument_list|,
literal|0
argument_list|,
literal|256
operator|*
name|KB
argument_list|)
expr_stmt|;
block|{
specifier|static
name|uint8_t
name|palette
index|[]
init|=
block|{
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x2a
block|,
literal|0x00
block|,
literal|0x2a
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x2a
block|,
literal|0x2a
block|,
literal|0x2a
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x2a
block|,
literal|0x00
block|,
literal|0x2a
block|,
literal|0x2a
block|,
literal|0x2a
block|,
literal|0x00
block|,
literal|0x2a
block|,
literal|0x2a
block|,
literal|0x2a
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x15
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x3f
block|,
literal|0x00
block|,
literal|0x2a
block|,
literal|0x15
block|,
literal|0x00
block|,
literal|0x2a
block|,
literal|0x3f
block|,
literal|0x2a
block|,
literal|0x00
block|,
literal|0x15
block|,
literal|0x2a
block|,
literal|0x00
block|,
literal|0x3f
block|,
literal|0x2a
block|,
literal|0x2a
block|,
literal|0x15
block|,
literal|0x2a
block|,
literal|0x2a
block|,
literal|0x3f
block|, 		}
decl_stmt|;
name|int
name|i
decl_stmt|;
name|memcpy
argument_list|(
name|sc
operator|->
name|vga_dac
operator|.
name|dac_palette
argument_list|,
name|palette
argument_list|,
literal|16
operator|*
literal|3
operator|*
sizeof|sizeof
argument_list|(
name|uint8_t
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
block|{
name|sc
operator|->
name|vga_dac
operator|.
name|dac_palette_rgb
index|[
name|i
index|]
operator|=
operator|(
operator|(
operator|(
operator|(
name|sc
operator|->
name|vga_dac
operator|.
name|dac_palette
index|[
literal|3
operator|*
name|i
operator|+
literal|0
index|]
operator|<<
literal|2
operator|)
operator||
operator|(
operator|(
name|sc
operator|->
name|vga_dac
operator|.
name|dac_palette
index|[
literal|3
operator|*
name|i
operator|+
literal|0
index|]
operator|&
literal|0x1
operator|)
operator|<<
literal|1
operator|)
operator||
operator|(
name|sc
operator|->
name|vga_dac
operator|.
name|dac_palette
index|[
literal|3
operator|*
name|i
operator|+
literal|0
index|]
operator|&
literal|0x1
operator|)
operator|)
operator|<<
literal|16
operator|)
operator||
operator|(
operator|(
operator|(
name|sc
operator|->
name|vga_dac
operator|.
name|dac_palette
index|[
literal|3
operator|*
name|i
operator|+
literal|1
index|]
operator|<<
literal|2
operator|)
operator||
operator|(
operator|(
name|sc
operator|->
name|vga_dac
operator|.
name|dac_palette
index|[
literal|3
operator|*
name|i
operator|+
literal|1
index|]
operator|&
literal|0x1
operator|)
operator|<<
literal|1
operator|)
operator||
operator|(
name|sc
operator|->
name|vga_dac
operator|.
name|dac_palette
index|[
literal|3
operator|*
name|i
operator|+
literal|1
index|]
operator|&
literal|0x1
operator|)
operator|)
operator|<<
literal|8
operator|)
operator||
operator|(
operator|(
operator|(
name|sc
operator|->
name|vga_dac
operator|.
name|dac_palette
index|[
literal|3
operator|*
name|i
operator|+
literal|2
index|]
operator|<<
literal|2
operator|)
operator||
operator|(
operator|(
name|sc
operator|->
name|vga_dac
operator|.
name|dac_palette
index|[
literal|3
operator|*
name|i
operator|+
literal|2
index|]
operator|&
literal|0x1
operator|)
operator|<<
literal|1
operator|)
operator||
operator|(
name|sc
operator|->
name|vga_dac
operator|.
name|dac_palette
index|[
literal|3
operator|*
name|i
operator|+
literal|2
index|]
operator|&
literal|0x1
operator|)
operator|)
operator|<<
literal|0
operator|)
operator|)
expr_stmt|;
block|}
block|}
return|return
operator|(
name|sc
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2014 Leon Dang<ldang@nahannisys.com>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<pthread.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usbdi.h>
end_include

begin_include
include|#
directive|include
file|"usb_emul.h"
end_include

begin_include
include|#
directive|include
file|"console.h"
end_include

begin_include
include|#
directive|include
file|"bhyvegc.h"
end_include

begin_decl_stmt
specifier|static
name|int
name|umouse_debug
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|DPRINTF
parameter_list|(
name|params
parameter_list|)
value|if (umouse_debug) printf params
end_define

begin_define
define|#
directive|define
name|WPRINTF
parameter_list|(
name|params
parameter_list|)
value|printf params
end_define

begin_comment
comment|/* USB endpoint context (1-15) for reporting mouse data events*/
end_comment

begin_define
define|#
directive|define
name|UMOUSE_INTR_ENDPT
value|1
end_define

begin_define
define|#
directive|define
name|UMOUSE_REPORT_DESC_TYPE
value|0x22
end_define

begin_define
define|#
directive|define
name|UMOUSE_GET_REPORT
value|0x01
end_define

begin_define
define|#
directive|define
name|UMOUSE_GET_IDLE
value|0x02
end_define

begin_define
define|#
directive|define
name|UMOUSE_GET_PROTOCOL
value|0x03
end_define

begin_define
define|#
directive|define
name|UMOUSE_SET_REPORT
value|0x09
end_define

begin_define
define|#
directive|define
name|UMOUSE_SET_IDLE
value|0x0A
end_define

begin_define
define|#
directive|define
name|UMOUSE_SET_PROTOCOL
value|0x0B
end_define

begin_define
define|#
directive|define
name|HSETW
parameter_list|(
name|ptr
parameter_list|,
name|val
parameter_list|)
value|ptr = { (uint8_t)(val), (uint8_t)((val)>> 8) }
end_define

begin_enum
enum|enum
block|{
name|UMSTR_LANG
block|,
name|UMSTR_MANUFACTURER
block|,
name|UMSTR_PRODUCT
block|,
name|UMSTR_SERIAL
block|,
name|UMSTR_CONFIG
block|,
name|UMSTR_MAX
block|}
enum|;
end_enum

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|umouse_desc_strings
index|[]
init|=
block|{
literal|"\x04\x09"
block|,
literal|"BHYVE"
block|,
literal|"HID Tablet"
block|,
literal|"01"
block|,
literal|"HID Tablet Device"
block|, }
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|umouse_hid_descriptor
block|{
name|uint8_t
name|bLength
decl_stmt|;
name|uint8_t
name|bDescriptorType
decl_stmt|;
name|uint8_t
name|bcdHID
index|[
literal|2
index|]
decl_stmt|;
name|uint8_t
name|bCountryCode
decl_stmt|;
name|uint8_t
name|bNumDescriptors
decl_stmt|;
name|uint8_t
name|bReportDescriptorType
decl_stmt|;
name|uint8_t
name|wItemLength
index|[
literal|2
index|]
decl_stmt|;
block|}
name|__packed
struct|;
end_struct

begin_struct
struct|struct
name|umouse_config_desc
block|{
name|struct
name|usb_config_descriptor
name|confd
decl_stmt|;
name|struct
name|usb_interface_descriptor
name|ifcd
decl_stmt|;
name|struct
name|umouse_hid_descriptor
name|hidd
decl_stmt|;
name|struct
name|usb_endpoint_descriptor
name|endpd
decl_stmt|;
name|struct
name|usb_endpoint_ss_comp_descriptor
name|sscompd
decl_stmt|;
block|}
name|__packed
struct|;
end_struct

begin_define
define|#
directive|define
name|MOUSE_MAX_X
value|0x8000
end_define

begin_define
define|#
directive|define
name|MOUSE_MAX_Y
value|0x8000
end_define

begin_decl_stmt
specifier|static
specifier|const
name|uint8_t
name|umouse_report_desc
index|[]
init|=
block|{
literal|0x05
block|,
literal|0x01
block|,
comment|/* USAGE_PAGE (Generic Desktop)		*/
literal|0x09
block|,
literal|0x02
block|,
comment|/* USAGE (Mouse)			*/
literal|0xa1
block|,
literal|0x01
block|,
comment|/* COLLECTION (Application) 		*/
literal|0x09
block|,
literal|0x01
block|,
comment|/*   USAGE (Pointer)			*/
literal|0xa1
block|,
literal|0x00
block|,
comment|/*   COLLECTION (Physical)		*/
literal|0x05
block|,
literal|0x09
block|,
comment|/*     USAGE_PAGE (Button)		*/
literal|0x19
block|,
literal|0x01
block|,
comment|/*     USAGE_MINIMUM (Button 1)		*/
literal|0x29
block|,
literal|0x03
block|,
comment|/*     USAGE_MAXIMUM (Button 3)		*/
literal|0x15
block|,
literal|0x00
block|,
comment|/*     LOGICAL_MINIMUM (0)		*/
literal|0x25
block|,
literal|0x01
block|,
comment|/*     LOGICAL_MAXIMUM (1)		*/
literal|0x75
block|,
literal|0x01
block|,
comment|/*     REPORT_SIZE (1)			*/
literal|0x95
block|,
literal|0x03
block|,
comment|/*     REPORT_COUNT (3)			*/
literal|0x81
block|,
literal|0x02
block|,
comment|/*     INPUT (Data,Var,Abs); 3 buttons	*/
literal|0x75
block|,
literal|0x05
block|,
comment|/*     REPORT_SIZE (5)			*/
literal|0x95
block|,
literal|0x01
block|,
comment|/*     REPORT_COUNT (1)			*/
literal|0x81
block|,
literal|0x03
block|,
comment|/*     INPUT (Cnst,Var,Abs); padding	*/
literal|0x05
block|,
literal|0x01
block|,
comment|/*     USAGE_PAGE (Generic Desktop)	*/
literal|0x09
block|,
literal|0x30
block|,
comment|/*     USAGE (X)			*/
literal|0x09
block|,
literal|0x31
block|,
comment|/*     USAGE (Y)			*/
literal|0x35
block|,
literal|0x00
block|,
comment|/*     PHYSICAL_MINIMUM (0)		*/
literal|0x46
block|,
literal|0xff
block|,
literal|0x7f
block|,
comment|/*     PHYSICAL_MAXIMUM (0x7fff)	*/
literal|0x15
block|,
literal|0x00
block|,
comment|/*     LOGICAL_MINIMUM (0)		*/
literal|0x26
block|,
literal|0xff
block|,
literal|0x7f
block|,
comment|/*     LOGICAL_MAXIMUM (0x7fff)		*/
literal|0x75
block|,
literal|0x10
block|,
comment|/*     REPORT_SIZE (16)			*/
literal|0x95
block|,
literal|0x02
block|,
comment|/*     REPORT_COUNT (2)			*/
literal|0x81
block|,
literal|0x02
block|,
comment|/*     INPUT (Data,Var,Abs)		*/
literal|0x05
block|,
literal|0x01
block|,
comment|/*     USAGE Page (Generic Desktop)	*/
literal|0x09
block|,
literal|0x38
block|,
comment|/*     USAGE (Wheel)			*/
literal|0x35
block|,
literal|0x00
block|,
comment|/*     PHYSICAL_MINIMUM (0)		*/
literal|0x45
block|,
literal|0x00
block|,
comment|/*     PHYSICAL_MAXIMUM (0)		*/
literal|0x15
block|,
literal|0x81
block|,
comment|/*     LOGICAL_MINIMUM (-127)		*/
literal|0x25
block|,
literal|0x7f
block|,
comment|/*     LOGICAL_MAXIMUM (127)		*/
literal|0x75
block|,
literal|0x08
block|,
comment|/*     REPORT_SIZE (8)			*/
literal|0x95
block|,
literal|0x01
block|,
comment|/*     REPORT_COUNT (1)			*/
literal|0x81
block|,
literal|0x06
block|,
comment|/*     INPUT (Data,Var,Rel)		*/
literal|0xc0
block|,
comment|/*   END_COLLECTION			*/
literal|0xc0
comment|/* END_COLLECTION			*/
block|}
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|umouse_report
block|{
name|uint8_t
name|buttons
decl_stmt|;
comment|/* bits: 0 left, 1 right, 2 middle */
name|int16_t
name|x
decl_stmt|;
comment|/* x position */
name|int16_t
name|y
decl_stmt|;
comment|/* y position */
name|int8_t
name|z
decl_stmt|;
comment|/* z wheel position */
block|}
name|__packed
struct|;
end_struct

begin_define
define|#
directive|define
name|MSETW
parameter_list|(
name|ptr
parameter_list|,
name|val
parameter_list|)
value|ptr = { (uint8_t)(val), (uint8_t)((val)>> 8) }
end_define

begin_decl_stmt
specifier|static
name|struct
name|usb_device_descriptor
name|umouse_dev_desc
init|=
block|{
operator|.
name|bLength
operator|=
sizeof|sizeof
argument_list|(
name|umouse_dev_desc
argument_list|)
block|,
operator|.
name|bDescriptorType
operator|=
name|UDESC_DEVICE
block|,
name|MSETW
argument_list|(
operator|.
name|bcdUSB
argument_list|,
name|UD_USB_3_0
argument_list|)
block|,
operator|.
name|bMaxPacketSize
operator|=
literal|8
block|,
comment|/* max packet size */
name|MSETW
argument_list|(
operator|.
name|idVendor
argument_list|,
literal|0xFB5D
argument_list|)
block|,
comment|/* vendor */
name|MSETW
argument_list|(
operator|.
name|idProduct
argument_list|,
literal|0x0001
argument_list|)
block|,
comment|/* product */
name|MSETW
argument_list|(
operator|.
name|bcdDevice
argument_list|,
literal|0
argument_list|)
block|,
comment|/* device version */
operator|.
name|iManufacturer
operator|=
name|UMSTR_MANUFACTURER
block|,
operator|.
name|iProduct
operator|=
name|UMSTR_PRODUCT
block|,
operator|.
name|iSerialNumber
operator|=
name|UMSTR_SERIAL
block|,
operator|.
name|bNumConfigurations
operator|=
literal|1
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|umouse_config_desc
name|umouse_confd
init|=
block|{
operator|.
name|confd
operator|=
block|{
operator|.
name|bLength
operator|=
sizeof|sizeof
argument_list|(
name|umouse_confd
operator|.
name|confd
argument_list|)
block|,
operator|.
name|bDescriptorType
operator|=
name|UDESC_CONFIG
block|,
operator|.
name|wTotalLength
index|[
literal|0
index|]
operator|=
sizeof|sizeof
argument_list|(
name|umouse_confd
argument_list|)
block|,
operator|.
name|bNumInterface
operator|=
literal|1
block|,
operator|.
name|bConfigurationValue
operator|=
literal|1
block|,
operator|.
name|iConfiguration
operator|=
name|UMSTR_CONFIG
block|,
operator|.
name|bmAttributes
operator|=
name|UC_BUS_POWERED
operator||
name|UC_REMOTE_WAKEUP
block|,
operator|.
name|bMaxPower
operator|=
literal|0
block|, 	}
block|,
operator|.
name|ifcd
operator|=
block|{
operator|.
name|bLength
operator|=
sizeof|sizeof
argument_list|(
name|umouse_confd
operator|.
name|ifcd
argument_list|)
block|,
operator|.
name|bDescriptorType
operator|=
name|UDESC_INTERFACE
block|,
operator|.
name|bNumEndpoints
operator|=
literal|1
block|,
operator|.
name|bInterfaceClass
operator|=
name|UICLASS_HID
block|,
operator|.
name|bInterfaceSubClass
operator|=
name|UISUBCLASS_BOOT
block|,
operator|.
name|bInterfaceProtocol
operator|=
name|UIPROTO_MOUSE
block|, 	}
block|,
operator|.
name|hidd
operator|=
block|{
operator|.
name|bLength
operator|=
sizeof|sizeof
argument_list|(
name|umouse_confd
operator|.
name|hidd
argument_list|)
block|,
operator|.
name|bDescriptorType
operator|=
literal|0x21
block|,
operator|.
name|bcdHID
operator|=
block|{
literal|0x01
block|,
literal|0x10
block|}
block|,
operator|.
name|bCountryCode
operator|=
literal|0
block|,
operator|.
name|bNumDescriptors
operator|=
literal|1
block|,
operator|.
name|bReportDescriptorType
operator|=
name|UMOUSE_REPORT_DESC_TYPE
block|,
operator|.
name|wItemLength
operator|=
block|{
sizeof|sizeof
argument_list|(
name|umouse_report_desc
argument_list|)
block|,
literal|0
block|}
block|, 	}
block|,
operator|.
name|endpd
operator|=
block|{
operator|.
name|bLength
operator|=
sizeof|sizeof
argument_list|(
name|umouse_confd
operator|.
name|endpd
argument_list|)
block|,
operator|.
name|bDescriptorType
operator|=
name|UDESC_ENDPOINT
block|,
operator|.
name|bEndpointAddress
operator|=
name|UE_DIR_IN
operator||
name|UMOUSE_INTR_ENDPT
block|,
operator|.
name|bmAttributes
operator|=
name|UE_INTERRUPT
block|,
operator|.
name|wMaxPacketSize
index|[
literal|0
index|]
operator|=
literal|8
block|,
operator|.
name|bInterval
operator|=
literal|0xA
block|, 	}
block|,
operator|.
name|sscompd
operator|=
block|{
operator|.
name|bLength
operator|=
sizeof|sizeof
argument_list|(
name|umouse_confd
operator|.
name|sscompd
argument_list|)
block|,
operator|.
name|bDescriptorType
operator|=
name|UDESC_ENDPOINT_SS_COMP
block|,
operator|.
name|bMaxBurst
operator|=
literal|0
block|,
operator|.
name|bmAttributes
operator|=
literal|0
block|,
name|MSETW
argument_list|(
operator|.
name|wBytesPerInterval
argument_list|,
literal|0
argument_list|)
block|, 	}
block|, }
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|umouse_bos_desc
block|{
name|struct
name|usb_bos_descriptor
name|bosd
decl_stmt|;
name|struct
name|usb_devcap_ss_descriptor
name|usbssd
decl_stmt|;
block|}
name|__packed
struct|;
end_struct

begin_decl_stmt
name|struct
name|umouse_bos_desc
name|umouse_bosd
init|=
block|{
operator|.
name|bosd
operator|=
block|{
operator|.
name|bLength
operator|=
sizeof|sizeof
argument_list|(
name|umouse_bosd
operator|.
name|bosd
argument_list|)
block|,
operator|.
name|bDescriptorType
operator|=
name|UDESC_BOS
block|,
name|HSETW
argument_list|(
operator|.
name|wTotalLength
argument_list|,
sizeof|sizeof
argument_list|(
name|umouse_bosd
argument_list|)
argument_list|)
block|,
operator|.
name|bNumDeviceCaps
operator|=
literal|1
block|, 	}
block|,
operator|.
name|usbssd
operator|=
block|{
operator|.
name|bLength
operator|=
sizeof|sizeof
argument_list|(
name|umouse_bosd
operator|.
name|usbssd
argument_list|)
block|,
operator|.
name|bDescriptorType
operator|=
name|UDESC_DEVICE_CAPABILITY
block|,
operator|.
name|bDevCapabilityType
operator|=
literal|3
block|,
operator|.
name|bmAttributes
operator|=
literal|0
block|,
name|HSETW
argument_list|(
operator|.
name|wSpeedsSupported
argument_list|,
literal|0x08
argument_list|)
block|,
operator|.
name|bFunctionalitySupport
operator|=
literal|3
block|,
operator|.
name|bU1DevExitLat
operator|=
literal|0xa
block|,
comment|/* dummy - not used */
operator|.
name|wU2DevExitLat
operator|=
block|{
literal|0x20
block|,
literal|0x00
block|}
block|,         }
block|}
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|umouse_softc
block|{
name|struct
name|usb_hci
modifier|*
name|hci
decl_stmt|;
name|char
modifier|*
name|opt
decl_stmt|;
name|struct
name|umouse_report
name|um_report
decl_stmt|;
name|int
name|newdata
decl_stmt|;
struct|struct
block|{
name|uint8_t
name|idle
decl_stmt|;
name|uint8_t
name|protocol
decl_stmt|;
name|uint8_t
name|feature
decl_stmt|;
block|}
name|hid
struct|;
name|pthread_mutex_t
name|mtx
decl_stmt|;
name|pthread_mutex_t
name|ev_mtx
decl_stmt|;
name|int
name|polling
decl_stmt|;
name|struct
name|timeval
name|prev_evt
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
name|umouse_event
parameter_list|(
name|uint8_t
name|button
parameter_list|,
name|int
name|x
parameter_list|,
name|int
name|y
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|umouse_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|bhyvegc_image
modifier|*
name|gc
decl_stmt|;
name|gc
operator|=
name|console_get_image
argument_list|()
expr_stmt|;
if|if
condition|(
name|gc
operator|==
name|NULL
condition|)
block|{
comment|/* not ready */
return|return;
block|}
name|sc
operator|=
name|arg
expr_stmt|;
name|pthread_mutex_lock
argument_list|(
operator|&
name|sc
operator|->
name|mtx
argument_list|)
expr_stmt|;
name|sc
operator|->
name|um_report
operator|.
name|buttons
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|um_report
operator|.
name|z
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|button
operator|&
literal|0x01
condition|)
name|sc
operator|->
name|um_report
operator|.
name|buttons
operator||=
literal|0x01
expr_stmt|;
comment|/* left */
if|if
condition|(
name|button
operator|&
literal|0x02
condition|)
name|sc
operator|->
name|um_report
operator|.
name|buttons
operator||=
literal|0x04
expr_stmt|;
comment|/* middle */
if|if
condition|(
name|button
operator|&
literal|0x04
condition|)
name|sc
operator|->
name|um_report
operator|.
name|buttons
operator||=
literal|0x02
expr_stmt|;
comment|/* right */
if|if
condition|(
name|button
operator|&
literal|0x8
condition|)
name|sc
operator|->
name|um_report
operator|.
name|z
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|button
operator|&
literal|0x10
condition|)
name|sc
operator|->
name|um_report
operator|.
name|z
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* scale coords to mouse resolution */
name|sc
operator|->
name|um_report
operator|.
name|x
operator|=
name|MOUSE_MAX_X
operator|*
name|x
operator|/
name|gc
operator|->
name|width
expr_stmt|;
name|sc
operator|->
name|um_report
operator|.
name|y
operator|=
name|MOUSE_MAX_X
operator|*
name|y
operator|/
name|gc
operator|->
name|height
expr_stmt|;
name|sc
operator|->
name|newdata
operator|=
literal|1
expr_stmt|;
name|pthread_mutex_unlock
argument_list|(
operator|&
name|sc
operator|->
name|mtx
argument_list|)
expr_stmt|;
name|pthread_mutex_lock
argument_list|(
operator|&
name|sc
operator|->
name|ev_mtx
argument_list|)
expr_stmt|;
name|sc
operator|->
name|hci
operator|->
name|hci_intr
argument_list|(
name|sc
operator|->
name|hci
argument_list|,
name|UE_DIR_IN
operator||
name|UMOUSE_INTR_ENDPT
argument_list|)
expr_stmt|;
name|pthread_mutex_unlock
argument_list|(
operator|&
name|sc
operator|->
name|ev_mtx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|umouse_init
parameter_list|(
name|struct
name|usb_hci
modifier|*
name|hci
parameter_list|,
name|char
modifier|*
name|opt
parameter_list|)
block|{
name|struct
name|umouse_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|umouse_softc
argument_list|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|hci
operator|=
name|hci
expr_stmt|;
name|sc
operator|->
name|hid
operator|.
name|protocol
operator|=
literal|1
expr_stmt|;
comment|/* REPORT protocol */
name|sc
operator|->
name|opt
operator|=
name|strdup
argument_list|(
name|opt
argument_list|)
expr_stmt|;
name|pthread_mutex_init
argument_list|(
operator|&
name|sc
operator|->
name|mtx
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|pthread_mutex_init
argument_list|(
operator|&
name|sc
operator|->
name|ev_mtx
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|console_ptr_register
argument_list|(
name|umouse_event
argument_list|,
name|sc
argument_list|,
literal|10
argument_list|)
expr_stmt|;
return|return
operator|(
name|sc
operator|)
return|;
block|}
end_function

begin_define
define|#
directive|define
name|UREQ
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|)
value|((x) | ((y)<< 8))
end_define

begin_function
specifier|static
name|int
name|umouse_request
parameter_list|(
name|void
modifier|*
name|scarg
parameter_list|,
name|struct
name|usb_data_xfer
modifier|*
name|xfer
parameter_list|)
block|{
name|struct
name|umouse_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|usb_data_xfer_block
modifier|*
name|data
decl_stmt|;
specifier|const
name|char
modifier|*
name|str
decl_stmt|;
name|uint16_t
name|value
decl_stmt|;
name|uint16_t
name|index
decl_stmt|;
name|uint16_t
name|len
decl_stmt|;
name|uint16_t
name|slen
decl_stmt|;
name|uint8_t
modifier|*
name|udata
decl_stmt|;
name|int
name|err
decl_stmt|;
name|int
name|i
decl_stmt|,
name|idx
decl_stmt|;
name|int
name|eshort
decl_stmt|;
name|sc
operator|=
name|scarg
expr_stmt|;
name|data
operator|=
name|NULL
expr_stmt|;
name|udata
operator|=
name|NULL
expr_stmt|;
name|idx
operator|=
name|xfer
operator|->
name|head
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|xfer
operator|->
name|ndata
condition|;
name|i
operator|++
control|)
block|{
name|xfer
operator|->
name|data
index|[
name|idx
index|]
operator|.
name|bdone
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
operator|&&
name|USB_DATA_OK
argument_list|(
name|xfer
argument_list|,
name|i
argument_list|)
condition|)
block|{
name|data
operator|=
operator|&
name|xfer
operator|->
name|data
index|[
name|idx
index|]
expr_stmt|;
name|udata
operator|=
name|data
operator|->
name|buf
expr_stmt|;
block|}
name|xfer
operator|->
name|data
index|[
name|idx
index|]
operator|.
name|processed
operator|=
literal|1
expr_stmt|;
name|idx
operator|=
operator|(
name|idx
operator|+
literal|1
operator|)
operator|%
name|USB_MAX_XFER_BLOCKS
expr_stmt|;
block|}
name|err
operator|=
name|USB_ERR_NORMAL_COMPLETION
expr_stmt|;
name|eshort
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|xfer
operator|->
name|ureq
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"umouse_request: port %d\r\n"
operator|,
name|sc
operator|->
name|hci
operator|->
name|hci_port
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|value
operator|=
name|UGETW
argument_list|(
name|xfer
operator|->
name|ureq
operator|->
name|wValue
argument_list|)
expr_stmt|;
name|index
operator|=
name|UGETW
argument_list|(
name|xfer
operator|->
name|ureq
operator|->
name|wIndex
argument_list|)
expr_stmt|;
name|len
operator|=
name|UGETW
argument_list|(
name|xfer
operator|->
name|ureq
operator|->
name|wLength
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"umouse_request: port %d, type 0x%x, req 0x%x, val 0x%x, "
literal|"idx 0x%x, len %u\r\n"
operator|,
name|sc
operator|->
name|hci
operator|->
name|hci_port
operator|,
name|xfer
operator|->
name|ureq
operator|->
name|bmRequestType
operator|,
name|xfer
operator|->
name|ureq
operator|->
name|bRequest
operator|,
name|value
operator|,
name|index
operator|,
name|len
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|UREQ
argument_list|(
name|xfer
operator|->
name|ureq
operator|->
name|bRequest
argument_list|,
name|xfer
operator|->
name|ureq
operator|->
name|bmRequestType
argument_list|)
condition|)
block|{
case|case
name|UREQ
argument_list|(
name|UR_GET_CONFIG
argument_list|,
name|UT_READ_DEVICE
argument_list|)
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"umouse: (UR_GET_CONFIG, UT_READ_DEVICE)\r\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|data
condition|)
break|break;
operator|*
name|udata
operator|=
name|umouse_confd
operator|.
name|confd
operator|.
name|bConfigurationValue
expr_stmt|;
name|data
operator|->
name|blen
operator|=
name|len
operator|>
literal|0
condition|?
name|len
operator|-
literal|1
else|:
literal|0
expr_stmt|;
name|eshort
operator|=
name|data
operator|->
name|blen
operator|>
literal|0
expr_stmt|;
name|data
operator|->
name|bdone
operator|+=
literal|1
expr_stmt|;
break|break;
case|case
name|UREQ
argument_list|(
name|UR_GET_DESCRIPTOR
argument_list|,
name|UT_READ_DEVICE
argument_list|)
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"umouse: (UR_GET_DESCRIPTOR, UT_READ_DEVICE) val %x\r\n"
operator|,
name|value
operator|>>
literal|8
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|data
condition|)
break|break;
switch|switch
condition|(
name|value
operator|>>
literal|8
condition|)
block|{
case|case
name|UDESC_DEVICE
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"umouse: (->UDESC_DEVICE) len %u ?= "
literal|"sizeof(umouse_dev_desc) %lu\r\n"
operator|,
name|len
operator|,
sizeof|sizeof
argument_list|(
name|umouse_dev_desc
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|value
operator|&
literal|0xFF
operator|)
operator|!=
literal|0
condition|)
block|{
name|err
operator|=
name|USB_ERR_IOERROR
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|len
operator|>
sizeof|sizeof
argument_list|(
name|umouse_dev_desc
argument_list|)
condition|)
block|{
name|data
operator|->
name|blen
operator|=
name|len
operator|-
sizeof|sizeof
argument_list|(
name|umouse_dev_desc
argument_list|)
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
name|umouse_dev_desc
argument_list|)
expr_stmt|;
block|}
else|else
name|data
operator|->
name|blen
operator|=
literal|0
expr_stmt|;
name|memcpy
argument_list|(
name|data
operator|->
name|buf
argument_list|,
operator|&
name|umouse_dev_desc
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|data
operator|->
name|bdone
operator|+=
name|len
expr_stmt|;
break|break;
case|case
name|UDESC_CONFIG
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"umouse: (->UDESC_CONFIG)\r\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|value
operator|&
literal|0xFF
operator|)
operator|!=
literal|0
condition|)
block|{
name|err
operator|=
name|USB_ERR_IOERROR
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|len
operator|>
sizeof|sizeof
argument_list|(
name|umouse_confd
argument_list|)
condition|)
block|{
name|data
operator|->
name|blen
operator|=
name|len
operator|-
sizeof|sizeof
argument_list|(
name|umouse_confd
argument_list|)
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
name|umouse_confd
argument_list|)
expr_stmt|;
block|}
else|else
name|data
operator|->
name|blen
operator|=
literal|0
expr_stmt|;
name|memcpy
argument_list|(
name|data
operator|->
name|buf
argument_list|,
operator|&
name|umouse_confd
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|data
operator|->
name|bdone
operator|+=
name|len
expr_stmt|;
break|break;
case|case
name|UDESC_STRING
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"umouse: (->UDESC_STRING)\r\n"
operator|)
argument_list|)
expr_stmt|;
name|str
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|(
name|value
operator|&
literal|0xFF
operator|)
operator|<
name|UMSTR_MAX
condition|)
name|str
operator|=
name|umouse_desc_strings
index|[
name|value
operator|&
literal|0xFF
index|]
expr_stmt|;
else|else
goto|goto
name|done
goto|;
if|if
condition|(
operator|(
name|value
operator|&
literal|0xFF
operator|)
operator|==
name|UMSTR_LANG
condition|)
block|{
name|udata
index|[
literal|0
index|]
operator|=
literal|4
expr_stmt|;
name|udata
index|[
literal|1
index|]
operator|=
name|UDESC_STRING
expr_stmt|;
name|data
operator|->
name|blen
operator|=
name|len
operator|-
literal|2
expr_stmt|;
name|len
operator|-=
literal|2
expr_stmt|;
name|data
operator|->
name|bdone
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|len
operator|>=
literal|2
condition|)
block|{
name|udata
index|[
literal|2
index|]
operator|=
name|str
index|[
literal|0
index|]
expr_stmt|;
name|udata
index|[
literal|3
index|]
operator|=
name|str
index|[
literal|1
index|]
expr_stmt|;
name|data
operator|->
name|blen
operator|-=
literal|2
expr_stmt|;
name|data
operator|->
name|bdone
operator|+=
literal|2
expr_stmt|;
block|}
else|else
name|data
operator|->
name|blen
operator|=
literal|0
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|slen
operator|=
literal|2
operator|+
name|strlen
argument_list|(
name|str
argument_list|)
operator|*
literal|2
expr_stmt|;
name|udata
index|[
literal|0
index|]
operator|=
name|slen
expr_stmt|;
name|udata
index|[
literal|1
index|]
operator|=
name|UDESC_STRING
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|slen
condition|)
block|{
name|data
operator|->
name|blen
operator|=
name|len
operator|-
name|slen
expr_stmt|;
name|len
operator|=
name|slen
expr_stmt|;
block|}
else|else
name|data
operator|->
name|blen
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|2
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|+=
literal|2
control|)
block|{
name|udata
index|[
name|i
index|]
operator|=
operator|*
name|str
operator|++
expr_stmt|;
name|udata
index|[
name|i
operator|+
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
name|data
operator|->
name|bdone
operator|+=
name|slen
expr_stmt|;
break|break;
case|case
name|UDESC_BOS
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"umouse: USB3 BOS\r\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
sizeof|sizeof
argument_list|(
name|umouse_bosd
argument_list|)
condition|)
block|{
name|data
operator|->
name|blen
operator|=
name|len
operator|-
sizeof|sizeof
argument_list|(
name|umouse_bosd
argument_list|)
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
name|umouse_bosd
argument_list|)
expr_stmt|;
block|}
else|else
name|data
operator|->
name|blen
operator|=
literal|0
expr_stmt|;
name|memcpy
argument_list|(
name|udata
argument_list|,
operator|&
name|umouse_bosd
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|data
operator|->
name|bdone
operator|+=
name|len
expr_stmt|;
break|break;
default|default:
name|DPRINTF
argument_list|(
operator|(
literal|"umouse: unknown(%d)->ERROR\r\n"
operator|,
name|value
operator|>>
literal|8
operator|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|USB_ERR_IOERROR
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|eshort
operator|=
name|data
operator|->
name|blen
operator|>
literal|0
expr_stmt|;
break|break;
case|case
name|UREQ
argument_list|(
name|UR_GET_DESCRIPTOR
argument_list|,
name|UT_READ_INTERFACE
argument_list|)
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"umouse: (UR_GET_DESCRIPTOR, UT_READ_INTERFACE) "
literal|"0x%x\r\n"
operator|,
operator|(
name|value
operator|>>
literal|8
operator|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|data
condition|)
break|break;
switch|switch
condition|(
name|value
operator|>>
literal|8
condition|)
block|{
case|case
name|UMOUSE_REPORT_DESC_TYPE
case|:
if|if
condition|(
name|len
operator|>
sizeof|sizeof
argument_list|(
name|umouse_report_desc
argument_list|)
condition|)
block|{
name|data
operator|->
name|blen
operator|=
name|len
operator|-
sizeof|sizeof
argument_list|(
name|umouse_report_desc
argument_list|)
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
name|umouse_report_desc
argument_list|)
expr_stmt|;
block|}
else|else
name|data
operator|->
name|blen
operator|=
literal|0
expr_stmt|;
name|memcpy
argument_list|(
name|data
operator|->
name|buf
argument_list|,
name|umouse_report_desc
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|data
operator|->
name|bdone
operator|+=
name|len
expr_stmt|;
break|break;
default|default:
name|DPRINTF
argument_list|(
operator|(
literal|"umouse: IO ERROR\r\n"
operator|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|USB_ERR_IOERROR
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|eshort
operator|=
name|data
operator|->
name|blen
operator|>
literal|0
expr_stmt|;
break|break;
case|case
name|UREQ
argument_list|(
name|UR_GET_INTERFACE
argument_list|,
name|UT_READ_INTERFACE
argument_list|)
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"umouse: (UR_GET_INTERFACE, UT_READ_INTERFACE)\r\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|index
operator|!=
literal|0
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"umouse get_interface, invalid index %d\r\n"
operator|,
name|index
operator|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|USB_ERR_IOERROR
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
operator|!
name|data
condition|)
break|break;
if|if
condition|(
name|len
operator|>
literal|0
condition|)
block|{
operator|*
name|udata
operator|=
literal|0
expr_stmt|;
name|data
operator|->
name|blen
operator|=
name|len
operator|-
literal|1
expr_stmt|;
block|}
name|eshort
operator|=
name|data
operator|->
name|blen
operator|>
literal|0
expr_stmt|;
name|data
operator|->
name|bdone
operator|+=
literal|1
expr_stmt|;
break|break;
case|case
name|UREQ
argument_list|(
name|UR_GET_STATUS
argument_list|,
name|UT_READ_DEVICE
argument_list|)
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"umouse: (UR_GET_STATUS, UT_READ_DEVICE)\r\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|!=
name|NULL
operator|&&
name|len
operator|>
literal|1
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|hid
operator|.
name|feature
operator|==
name|UF_DEVICE_REMOTE_WAKEUP
condition|)
name|USETW
argument_list|(
name|udata
argument_list|,
name|UDS_REMOTE_WAKEUP
argument_list|)
expr_stmt|;
else|else
name|USETW
argument_list|(
name|udata
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|data
operator|->
name|blen
operator|=
name|len
operator|-
literal|2
expr_stmt|;
name|data
operator|->
name|bdone
operator|+=
literal|2
expr_stmt|;
block|}
name|eshort
operator|=
name|data
operator|->
name|blen
operator|>
literal|0
expr_stmt|;
break|break;
case|case
name|UREQ
argument_list|(
name|UR_GET_STATUS
argument_list|,
name|UT_READ_INTERFACE
argument_list|)
case|:
case|case
name|UREQ
argument_list|(
name|UR_GET_STATUS
argument_list|,
name|UT_READ_ENDPOINT
argument_list|)
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"umouse: (UR_GET_STATUS, UT_READ_INTERFACE)\r\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|!=
name|NULL
operator|&&
name|len
operator|>
literal|1
condition|)
block|{
name|USETW
argument_list|(
name|udata
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|data
operator|->
name|blen
operator|=
name|len
operator|-
literal|2
expr_stmt|;
name|data
operator|->
name|bdone
operator|+=
literal|2
expr_stmt|;
block|}
name|eshort
operator|=
name|data
operator|->
name|blen
operator|>
literal|0
expr_stmt|;
break|break;
case|case
name|UREQ
argument_list|(
name|UR_SET_ADDRESS
argument_list|,
name|UT_WRITE_DEVICE
argument_list|)
case|:
comment|/* XXX Controller should've handled this */
name|DPRINTF
argument_list|(
operator|(
literal|"umouse set address %u\r\n"
operator|,
name|value
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|UREQ
argument_list|(
name|UR_SET_CONFIG
argument_list|,
name|UT_WRITE_DEVICE
argument_list|)
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"umouse set config %u\r\n"
operator|,
name|value
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|UREQ
argument_list|(
name|UR_SET_DESCRIPTOR
argument_list|,
name|UT_WRITE_DEVICE
argument_list|)
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"umouse set descriptor %u\r\n"
operator|,
name|value
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|UREQ
argument_list|(
name|UR_CLEAR_FEATURE
argument_list|,
name|UT_WRITE_DEVICE
argument_list|)
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"umouse: (UR_SET_FEATURE, UT_WRITE_DEVICE) %x\r\n"
operator|,
name|value
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|==
name|UF_DEVICE_REMOTE_WAKEUP
condition|)
name|sc
operator|->
name|hid
operator|.
name|feature
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|UREQ
argument_list|(
name|UR_SET_FEATURE
argument_list|,
name|UT_WRITE_DEVICE
argument_list|)
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"umouse: (UR_SET_FEATURE, UT_WRITE_DEVICE) %x\r\n"
operator|,
name|value
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|==
name|UF_DEVICE_REMOTE_WAKEUP
condition|)
name|sc
operator|->
name|hid
operator|.
name|feature
operator|=
name|UF_DEVICE_REMOTE_WAKEUP
expr_stmt|;
break|break;
case|case
name|UREQ
argument_list|(
name|UR_CLEAR_FEATURE
argument_list|,
name|UT_WRITE_INTERFACE
argument_list|)
case|:
case|case
name|UREQ
argument_list|(
name|UR_CLEAR_FEATURE
argument_list|,
name|UT_WRITE_ENDPOINT
argument_list|)
case|:
case|case
name|UREQ
argument_list|(
name|UR_SET_FEATURE
argument_list|,
name|UT_WRITE_INTERFACE
argument_list|)
case|:
case|case
name|UREQ
argument_list|(
name|UR_SET_FEATURE
argument_list|,
name|UT_WRITE_ENDPOINT
argument_list|)
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"umouse: (UR_CLEAR_FEATURE, UT_WRITE_INTERFACE)\r\n"
operator|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|USB_ERR_IOERROR
expr_stmt|;
goto|goto
name|done
goto|;
case|case
name|UREQ
argument_list|(
name|UR_SET_INTERFACE
argument_list|,
name|UT_WRITE_INTERFACE
argument_list|)
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"umouse set interface %u\r\n"
operator|,
name|value
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|UREQ
argument_list|(
name|UR_ISOCH_DELAY
argument_list|,
name|UT_WRITE_DEVICE
argument_list|)
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"umouse set isoch delay %u\r\n"
operator|,
name|value
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|UREQ
argument_list|(
name|UR_SET_SEL
argument_list|,
literal|0
argument_list|)
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"umouse set sel\r\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|UREQ
argument_list|(
name|UR_SYNCH_FRAME
argument_list|,
name|UT_WRITE_ENDPOINT
argument_list|)
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"umouse synch frame\r\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
comment|/* HID device requests */
case|case
name|UREQ
argument_list|(
name|UMOUSE_GET_REPORT
argument_list|,
name|UT_READ_CLASS_INTERFACE
argument_list|)
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"umouse: (UMOUSE_GET_REPORT, UT_READ_CLASS_INTERFACE) "
literal|"0x%x\r\n"
operator|,
operator|(
name|value
operator|>>
literal|8
operator|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|data
condition|)
break|break;
if|if
condition|(
operator|(
name|value
operator|>>
literal|8
operator|)
operator|==
literal|0x01
operator|&&
name|len
operator|>=
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|um_report
argument_list|)
condition|)
block|{
comment|/* TODO read from backend */
if|if
condition|(
name|len
operator|>
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|um_report
argument_list|)
condition|)
block|{
name|data
operator|->
name|blen
operator|=
name|len
operator|-
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|um_report
argument_list|)
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|um_report
argument_list|)
expr_stmt|;
block|}
else|else
name|data
operator|->
name|blen
operator|=
literal|0
expr_stmt|;
name|memcpy
argument_list|(
name|data
operator|->
name|buf
argument_list|,
operator|&
name|sc
operator|->
name|um_report
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|data
operator|->
name|bdone
operator|+=
name|len
expr_stmt|;
block|}
else|else
block|{
name|err
operator|=
name|USB_ERR_IOERROR
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|eshort
operator|=
name|data
operator|->
name|blen
operator|>
literal|0
expr_stmt|;
break|break;
case|case
name|UREQ
argument_list|(
name|UMOUSE_GET_IDLE
argument_list|,
name|UT_READ_CLASS_INTERFACE
argument_list|)
case|:
if|if
condition|(
name|data
operator|!=
name|NULL
operator|&&
name|len
operator|>
literal|0
condition|)
block|{
operator|*
name|udata
operator|=
name|sc
operator|->
name|hid
operator|.
name|idle
expr_stmt|;
name|data
operator|->
name|blen
operator|=
name|len
operator|-
literal|1
expr_stmt|;
name|data
operator|->
name|bdone
operator|+=
literal|1
expr_stmt|;
block|}
name|eshort
operator|=
name|data
operator|->
name|blen
operator|>
literal|0
expr_stmt|;
break|break;
case|case
name|UREQ
argument_list|(
name|UMOUSE_GET_PROTOCOL
argument_list|,
name|UT_READ_CLASS_INTERFACE
argument_list|)
case|:
if|if
condition|(
name|data
operator|!=
name|NULL
operator|&&
name|len
operator|>
literal|0
condition|)
block|{
operator|*
name|udata
operator|=
name|sc
operator|->
name|hid
operator|.
name|protocol
expr_stmt|;
name|data
operator|->
name|blen
operator|=
name|len
operator|-
literal|1
expr_stmt|;
name|data
operator|->
name|bdone
operator|+=
literal|1
expr_stmt|;
block|}
name|eshort
operator|=
name|data
operator|->
name|blen
operator|>
literal|0
expr_stmt|;
break|break;
case|case
name|UREQ
argument_list|(
name|UMOUSE_SET_REPORT
argument_list|,
name|UT_WRITE_CLASS_INTERFACE
argument_list|)
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"umouse: (UMOUSE_SET_REPORT, UT_WRITE_CLASS_INTERFACE) ignored\r\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|UREQ
argument_list|(
name|UMOUSE_SET_IDLE
argument_list|,
name|UT_WRITE_CLASS_INTERFACE
argument_list|)
case|:
name|sc
operator|->
name|hid
operator|.
name|idle
operator|=
name|UGETW
argument_list|(
name|xfer
operator|->
name|ureq
operator|->
name|wValue
argument_list|)
operator|>>
literal|8
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"umouse: (UMOUSE_SET_IDLE, UT_WRITE_CLASS_INTERFACE) %x\r\n"
operator|,
name|sc
operator|->
name|hid
operator|.
name|idle
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|UREQ
argument_list|(
name|UMOUSE_SET_PROTOCOL
argument_list|,
name|UT_WRITE_CLASS_INTERFACE
argument_list|)
case|:
name|sc
operator|->
name|hid
operator|.
name|protocol
operator|=
name|UGETW
argument_list|(
name|xfer
operator|->
name|ureq
operator|->
name|wValue
argument_list|)
operator|>>
literal|8
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"umouse: (UR_CLEAR_FEATURE, UT_WRITE_CLASS_INTERFACE) %x\r\n"
operator|,
name|sc
operator|->
name|hid
operator|.
name|protocol
operator|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|DPRINTF
argument_list|(
operator|(
literal|"**** umouse request unhandled\r\n"
operator|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|USB_ERR_IOERROR
expr_stmt|;
break|break;
block|}
name|done
label|:
if|if
condition|(
name|xfer
operator|->
name|ureq
operator|&&
operator|(
name|xfer
operator|->
name|ureq
operator|->
name|bmRequestType
operator|&
name|UT_WRITE
operator|)
operator|&&
operator|(
name|err
operator|==
name|USB_ERR_NORMAL_COMPLETION
operator|)
operator|&&
operator|(
name|data
operator|!=
name|NULL
operator|)
condition|)
name|data
operator|->
name|blen
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|eshort
condition|)
name|err
operator|=
name|USB_ERR_SHORT_XFER
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"umouse request error code %d (0=ok), blen %u txlen %u\r\n"
operator|,
name|err
operator|,
operator|(
name|data
condition|?
name|data
operator|->
name|blen
else|:
literal|0
operator|)
operator|,
operator|(
name|data
condition|?
name|data
operator|->
name|bdone
else|:
literal|0
operator|)
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|umouse_data_handler
parameter_list|(
name|void
modifier|*
name|scarg
parameter_list|,
name|struct
name|usb_data_xfer
modifier|*
name|xfer
parameter_list|,
name|int
name|dir
parameter_list|,
name|int
name|epctx
parameter_list|)
block|{
name|struct
name|umouse_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|usb_data_xfer_block
modifier|*
name|data
decl_stmt|;
name|uint8_t
modifier|*
name|udata
decl_stmt|;
name|int
name|len
decl_stmt|,
name|i
decl_stmt|,
name|idx
decl_stmt|;
name|int
name|err
decl_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"umouse handle data - DIR=%s|EP=%d, blen %d\r\n"
operator|,
name|dir
condition|?
literal|"IN"
else|:
literal|"OUT"
operator|,
name|epctx
operator|,
name|xfer
operator|->
name|data
index|[
literal|0
index|]
operator|.
name|blen
operator|)
argument_list|)
expr_stmt|;
comment|/* find buffer to add data */
name|udata
operator|=
name|NULL
expr_stmt|;
name|err
operator|=
name|USB_ERR_NORMAL_COMPLETION
expr_stmt|;
comment|/* handle xfer at first unprocessed item with buffer */
name|data
operator|=
name|NULL
expr_stmt|;
name|idx
operator|=
name|xfer
operator|->
name|head
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|xfer
operator|->
name|ndata
condition|;
name|i
operator|++
control|)
block|{
name|data
operator|=
operator|&
name|xfer
operator|->
name|data
index|[
name|idx
index|]
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|buf
operator|!=
name|NULL
operator|&&
name|data
operator|->
name|blen
operator|!=
literal|0
condition|)
block|{
break|break;
block|}
else|else
block|{
name|data
operator|->
name|processed
operator|=
literal|1
expr_stmt|;
name|data
operator|=
name|NULL
expr_stmt|;
block|}
name|idx
operator|=
operator|(
name|idx
operator|+
literal|1
operator|)
operator|%
name|USB_MAX_XFER_BLOCKS
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|data
condition|)
goto|goto
name|done
goto|;
name|udata
operator|=
name|data
operator|->
name|buf
expr_stmt|;
name|len
operator|=
name|data
operator|->
name|blen
expr_stmt|;
if|if
condition|(
name|udata
operator|==
name|NULL
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"umouse no buffer provided for input\r\n"
operator|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|USB_ERR_NOMEM
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|sc
operator|=
name|scarg
expr_stmt|;
if|if
condition|(
name|dir
condition|)
block|{
name|pthread_mutex_lock
argument_list|(
operator|&
name|sc
operator|->
name|mtx
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sc
operator|->
name|newdata
condition|)
block|{
name|err
operator|=
name|USB_ERR_CANCELLED
expr_stmt|;
name|USB_DATA_SET_ERRCODE
argument_list|(
operator|&
name|xfer
operator|->
name|data
index|[
name|xfer
operator|->
name|head
index|]
argument_list|,
name|USB_NAK
argument_list|)
expr_stmt|;
name|pthread_mutex_unlock
argument_list|(
operator|&
name|sc
operator|->
name|mtx
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|sc
operator|->
name|polling
condition|)
block|{
name|err
operator|=
name|USB_ERR_STALLED
expr_stmt|;
name|USB_DATA_SET_ERRCODE
argument_list|(
name|data
argument_list|,
name|USB_STALL
argument_list|)
expr_stmt|;
name|pthread_mutex_unlock
argument_list|(
operator|&
name|sc
operator|->
name|mtx
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|sc
operator|->
name|polling
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|len
operator|>
literal|0
condition|)
block|{
name|sc
operator|->
name|newdata
operator|=
literal|0
expr_stmt|;
name|data
operator|->
name|processed
operator|=
literal|1
expr_stmt|;
name|data
operator|->
name|bdone
operator|+=
literal|6
expr_stmt|;
name|memcpy
argument_list|(
name|udata
argument_list|,
operator|&
name|sc
operator|->
name|um_report
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|data
operator|->
name|blen
operator|=
name|len
operator|-
literal|6
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|blen
operator|>
literal|0
condition|)
name|err
operator|=
name|USB_ERR_SHORT_XFER
expr_stmt|;
block|}
name|sc
operator|->
name|polling
operator|=
literal|0
expr_stmt|;
name|pthread_mutex_unlock
argument_list|(
operator|&
name|sc
operator|->
name|mtx
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|USB_DATA_SET_ERRCODE
argument_list|(
name|data
argument_list|,
name|USB_STALL
argument_list|)
expr_stmt|;
name|err
operator|=
name|USB_ERR_STALLED
expr_stmt|;
block|}
name|done
label|:
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|umouse_reset
parameter_list|(
name|void
modifier|*
name|scarg
parameter_list|)
block|{
name|struct
name|umouse_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|scarg
expr_stmt|;
name|sc
operator|->
name|newdata
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|umouse_remove
parameter_list|(
name|void
modifier|*
name|scarg
parameter_list|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|umouse_stop
parameter_list|(
name|void
modifier|*
name|scarg
parameter_list|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_decl_stmt
name|struct
name|usb_devemu
name|ue_mouse
init|=
block|{
operator|.
name|ue_emu
operator|=
literal|"tablet"
block|,
operator|.
name|ue_usbver
operator|=
literal|3
block|,
operator|.
name|ue_usbspeed
operator|=
name|USB_SPEED_HIGH
block|,
operator|.
name|ue_init
operator|=
name|umouse_init
block|,
operator|.
name|ue_request
operator|=
name|umouse_request
block|,
operator|.
name|ue_data
operator|=
name|umouse_data_handler
block|,
operator|.
name|ue_reset
operator|=
name|umouse_reset
block|,
operator|.
name|ue_remove
operator|=
name|umouse_remove
block|,
operator|.
name|ue_stop
operator|=
name|umouse_stop
block|}
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|USB_EMUL_SET
argument_list|(
name|ue_mouse
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright 1995 Massachusetts Institute of Technology  *  * Permission to use, copy, modify, and distribute this software and  * its documentation for any purpose and without fee is hereby  * granted, provided that both the above copyright notice and this  * permission notice appear in all copies, that both the above  * copyright notice and this permission notice appear in all  * supporting documentation, and that the name of M.I.T. not be used  * in advertising or publicity pertaining to distribution of the  * software without specific, written prior permission.  M.I.T. makes  * no representations about the suitability of this software for any  * purpose.  It is provided "as is" without express or implied  * warranty.  *  * THIS SOFTWARE IS PROVIDED BY M.I.T. ``AS IS''.  M.I.T. DISCLAIMS  * ALL EXPRESS OR IMPLIED WARRANTIES WITH REGARD TO THIS SOFTWARE,  * INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF  * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE. IN NO EVENT  * SHALL M.I.T. BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|char
name|rcsid
index|[]
init|=
literal|"$FreeBSD$"
decl_stmt|;
end_decl_stmt

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<ncurses.h>
end_include

begin_include
include|#
directive|include
file|<dialog.h>
end_include

begin_include
include|#
directive|include
file|<limits.h>
end_include

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|"tzsetup.h"
end_include

begin_define
define|#
directive|define
name|PATH_LOCALTIME
value|"/etc/localtime"
end_define

begin_define
define|#
directive|define
name|PATH_WALL_CMOS_CLOCK
value|"/etc/wall_cmos_clock"
end_define

begin_define
define|#
directive|define
name|PATH_ZONEINFO
value|"/usr/share/zoneinfo"
end_define

begin_function_decl
specifier|static
name|int
name|set_time
parameter_list|()
function_decl|;
end_function_decl

begin_enum
enum|enum
name|cmos
block|{
name|CMOS_UTC
block|,
name|CMOS_LOCAL
block|,
name|CMOS_LEAVE
block|}
name|cmos_state
init|=
name|CMOS_LEAVE
enum|;
end_enum

begin_decl_stmt
specifier|static
name|int
name|time_adjust
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|enum
name|cmos
name|cmos
parameter_list|(
name|enum
name|cmos
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|fiddle_cmos
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|int
name|main
parameter_list|(
name|void
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|tz
decl_stmt|;
name|init_dialog
argument_list|()
expr_stmt|;
if|if
condition|(
name|set_time
argument_list|()
operator|!=
literal|0
condition|)
block|{
name|end_dialog
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|tz
operator|=
name|tzmenu
argument_list|()
expr_stmt|;
name|fiddle_cmos
argument_list|()
expr_stmt|;
name|dialog_notify
argument_list|(
literal|"Daemons will only notice\n"
literal|"a timezone change.\n"
literal|"after rebooting.\n"
argument_list|)
expr_stmt|;
name|end_dialog
argument_list|()
expr_stmt|;
return|return
name|tz
condition|?
literal|0
else|:
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|set_time
parameter_list|(
name|void
parameter_list|)
block|{
name|unsigned
name|char
name|result
index|[
name|_POSIX2_LINE_MAX
index|]
decl_stmt|;
name|unsigned
name|char
name|buf2
index|[
name|_POSIX2_LINE_MAX
index|]
decl_stmt|;
specifier|static
name|struct
name|tm
name|usertm
decl_stmt|,
name|systm
decl_stmt|;
name|time_t
name|usertime
decl_stmt|,
name|systime
decl_stmt|;
name|long
name|diff
decl_stmt|;
name|int
name|rv
decl_stmt|;
comment|/* 	 * If /etc/wall_cmos_clock exists, or if there is already a timezone 	 * file installed, then just leave it alone and don't ask the user 	 * what time it is (because the system clock is already in POSIX 	 * time so we don't need to adjust anything later on). 	 */
name|time
argument_list|(
operator|&
name|systime
argument_list|)
expr_stmt|;
name|systm
operator|=
operator|*
name|localtime
argument_list|(
operator|&
name|systime
argument_list|)
expr_stmt|;
if|if
condition|(
name|systm
operator|.
name|tm_zone
index|[
literal|0
index|]
operator|||
name|access
argument_list|(
name|PATH_WALL_CMOS_CLOCK
argument_list|,
literal|0
argument_list|)
operator|==
literal|0
condition|)
block|{
name|cmos_state
operator|=
name|CMOS_LEAVE
expr_stmt|;
return|return
literal|0
return|;
block|}
name|usertm
operator|=
name|systm
expr_stmt|;
name|usertm
operator|.
name|tm_isdst
operator|=
operator|-
literal|1
expr_stmt|;
name|result
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|rv
operator|=
name|dialog_inputbox
argument_list|(
literal|"Checking current time"
argument_list|,
literal|"Please enter the current local time"
literal|" using 24-hour style,\n"
literal|"in the form HH:MM"
argument_list|,
literal|8
argument_list|,
literal|78
argument_list|,
name|result
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
return|return
literal|1
return|;
if|if
condition|(
name|result
index|[
literal|0
index|]
condition|)
block|{
if|if
condition|(
name|sscanf
argument_list|(
name|result
argument_list|,
literal|"%d:%d:%d"
argument_list|,
operator|&
name|usertm
operator|.
name|tm_hour
argument_list|,
operator|&
name|usertm
operator|.
name|tm_min
argument_list|,
operator|&
name|usertm
operator|.
name|tm_sec
argument_list|)
operator|<
literal|2
condition|)
block|{
name|snprintf
argument_list|(
name|buf2
argument_list|,
sizeof|sizeof
name|buf2
argument_list|,
literal|"Invalid time format: %s"
argument_list|,
name|result
argument_list|)
expr_stmt|;
name|dialog_notify
argument_list|(
name|buf2
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|usertime
operator|=
name|mktime
argument_list|(
operator|&
name|usertm
argument_list|)
expr_stmt|;
if|if
condition|(
name|usertime
operator|==
operator|(
name|time_t
operator|)
operator|-
literal|1
condition|)
block|{
name|snprintf
argument_list|(
name|buf2
argument_list|,
sizeof|sizeof
name|buf2
argument_list|,
literal|"Unreasonable time: %s"
argument_list|,
name|result
argument_list|)
expr_stmt|;
name|dialog_notify
argument_list|(
name|buf2
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|diff
operator|=
name|usertime
operator|-
name|systime
expr_stmt|;
if|if
condition|(
name|labs
argument_list|(
name|diff
argument_list|)
operator|>
literal|15
operator|*
literal|60
condition|)
block|{
name|cmos_state
operator|=
name|cmos
argument_list|(
name|CMOS_LOCAL
argument_list|)
expr_stmt|;
if|if
condition|(
name|diff
operator|>
literal|0
condition|)
block|{
name|time_adjust
operator|=
operator|(
operator|(
name|diff
operator|+
literal|15
operator|*
literal|60
operator|)
operator|/
operator|(
literal|30
operator|*
literal|60
operator|)
operator|*
literal|30
operator|*
literal|60
operator|)
expr_stmt|;
block|}
else|else
block|{
name|time_adjust
operator|=
operator|(
operator|(
name|diff
operator|-
literal|15
operator|*
literal|60
operator|)
operator|/
operator|(
literal|30
operator|*
literal|60
operator|)
operator|*
literal|30
operator|*
literal|60
operator|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|cmos_state
operator|=
name|cmos
argument_list|(
name|CMOS_UTC
argument_list|)
expr_stmt|;
name|time_adjust
operator|=
literal|0
expr_stmt|;
block|}
break|break;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|unsigned
name|char
modifier|*
name|cmos_list
index|[]
init|=
block|{
literal|"1"
block|,
literal|"CMOS clock is set to Universal time (UTC)"
block|,
literal|"2"
block|,
literal|"CMOS clock is set to local time"
block|,
literal|"3"
block|,
literal|"I'm not sure, leave it alone"
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|enum
name|cmos
name|cmos
parameter_list|(
name|enum
name|cmos
name|state
parameter_list|)
block|{
name|int
name|rv
decl_stmt|,
name|sel
init|=
literal|0
decl_stmt|;
name|unsigned
name|char
name|buf
index|[
name|_POSIX2_LINE_MAX
index|]
decl_stmt|;
name|unsigned
name|char
name|result
index|[
name|_POSIX2_LINE_MAX
index|]
decl_stmt|;
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
name|buf
argument_list|,
literal|"%s seems most likely"
argument_list|,
name|state
operator|==
name|CMOS_UTC
condition|?
literal|"UTC"
else|:
literal|"local time"
argument_list|)
expr_stmt|;
name|rv
operator|=
name|dialog_menu
argument_list|(
literal|"CMOS clock in local time or UTC"
argument_list|,
name|buf
argument_list|,
literal|12
argument_list|,
literal|78
argument_list|,
literal|3
argument_list|,
literal|3
argument_list|,
name|cmos_list
argument_list|,
name|result
argument_list|,
operator|&
name|sel
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|==
literal|0
condition|)
block|{
return|return
name|sel
return|;
block|}
else|else
block|{
return|return
name|state
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|fiddle_cmos
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|fd
decl_stmt|;
switch|switch
condition|(
name|cmos_state
condition|)
block|{
case|case
name|CMOS_LEAVE
case|:
break|break;
case|case
name|CMOS_UTC
case|:
if|if
condition|(
name|unlink
argument_list|(
name|PATH_WALL_CMOS_CLOCK
argument_list|)
operator|==
operator|-
literal|1
operator|&&
name|errno
operator|!=
name|ENOENT
condition|)
name|dialog_notify
argument_list|(
literal|"Error removing "
name|PATH_WALL_CMOS_CLOCK
argument_list|)
expr_stmt|;
break|break;
case|case
name|CMOS_LOCAL
case|:
if|if
condition|(
operator|(
name|fd
operator|=
name|open
argument_list|(
name|PATH_WALL_CMOS_CLOCK
argument_list|,
name|O_RDONLY
operator||
name|O_CREAT
argument_list|,
literal|0644
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
name|dialog_notify
argument_list|(
literal|"Error creating "
name|PATH_WALL_CMOS_CLOCK
argument_list|)
expr_stmt|;
else|else
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
name|int
name|setzone
parameter_list|(
specifier|const
name|char
modifier|*
name|zone
parameter_list|)
block|{
name|time_t
name|systime
decl_stmt|;
name|struct
name|tm
modifier|*
name|tm
decl_stmt|;
name|char
name|msg
index|[
name|_POSIX2_LINE_MAX
index|]
decl_stmt|;
name|int
name|rv
decl_stmt|;
name|struct
name|stat
name|sb
decl_stmt|;
comment|/* 	 * Make sure the definition file does exist before clobbering 	 * an existing PATH_LOCALTIME.  We do this before evaluating 	 * locatlime below, since a missing zoneinfo file would result 	 * in nothing but garbage in the displayed time information. 	 */
name|snprintf
argument_list|(
name|msg
argument_list|,
sizeof|sizeof
name|msg
argument_list|,
name|PATH_ZONEINFO
literal|"/%s"
argument_list|,
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|stat
argument_list|(
name|msg
argument_list|,
operator|&
name|sb
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|snprintf
argument_list|(
name|msg
argument_list|,
sizeof|sizeof
name|msg
argument_list|,
literal|"Could not find definition file\n"
name|PATH_ZONEINFO
literal|"/%s"
argument_list|,
name|zone
argument_list|)
expr_stmt|;
name|dialog_notify
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
name|snprintf
argument_list|(
name|msg
argument_list|,
sizeof|sizeof
name|msg
argument_list|,
literal|"TZ=%s"
argument_list|,
name|zone
argument_list|)
expr_stmt|;
name|putenv
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|tzset
argument_list|()
expr_stmt|;
name|time
argument_list|(
operator|&
name|systime
argument_list|)
expr_stmt|;
name|systime
operator|+=
name|time_adjust
expr_stmt|;
name|tm
operator|=
name|localtime
argument_list|(
operator|&
name|systime
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|msg
argument_list|,
sizeof|sizeof
name|msg
argument_list|,
literal|"Does %s look reasonable?"
argument_list|,
name|tm
operator|->
name|tm_zone
argument_list|)
expr_stmt|;
name|rv
operator|=
name|dialog_yesno
argument_list|(
literal|"Verifying timezone selection"
argument_list|,
name|msg
argument_list|,
operator|-
literal|1
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
condition|)
return|return
literal|1
return|;
if|if
condition|(
name|lstat
argument_list|(
name|PATH_LOCALTIME
argument_list|,
operator|&
name|sb
argument_list|)
operator|==
literal|0
operator|&&
name|S_ISLNK
argument_list|(
name|sb
operator|.
name|st_mode
argument_list|)
condition|)
block|{
comment|/* The destination is already a symlink, symlink it. */
operator|(
name|void
operator|)
name|unlink
argument_list|(
name|PATH_LOCALTIME
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|msg
argument_list|,
sizeof|sizeof
name|msg
argument_list|,
name|PATH_ZONEINFO
literal|"/%s"
argument_list|,
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|symlink
argument_list|(
name|msg
argument_list|,
name|PATH_LOCALTIME
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|dialog_notify
argument_list|(
literal|"Could not create a symbolic link for "
name|PATH_LOCALTIME
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
block|}
else|else
block|{
comment|/* Copy it. */
name|snprintf
argument_list|(
name|msg
argument_list|,
sizeof|sizeof
name|msg
argument_list|,
literal|"install -C -o bin -g bin -m 0444 "
name|PATH_ZONEINFO
literal|"/%s "
name|PATH_LOCALTIME
argument_list|,
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|system
argument_list|(
name|msg
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|dialog_notify
argument_list|(
literal|"Could not copy zone information into "
name|PATH_LOCALTIME
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
block|}
name|snprintf
argument_list|(
name|msg
argument_list|,
sizeof|sizeof
name|msg
argument_list|,
literal|"Installed timezone file %s"
argument_list|,
name|zone
argument_list|)
expr_stmt|;
name|dialog_notify
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


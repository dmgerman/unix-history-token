begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2006 Shteryana Shopova<syrinx@FreeBSD.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * Bridge MIB implementation for SNMPd.  * Bridge interface objects.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<net/ethernet.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_mib.h>
end_include

begin_include
include|#
directive|include
file|<net/if_types.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<stdarg.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<syslog.h>
end_include

begin_include
include|#
directive|include
file|<bsnmp/snmpmod.h>
end_include

begin_include
include|#
directive|include
file|<bsnmp/snmp_mibII.h>
end_include

begin_include
include|#
directive|include
file|"bridge_tree.h"
end_include

begin_include
include|#
directive|include
file|"bridge_snmp.h"
end_include

begin_include
include|#
directive|include
file|"bridge_oid.h"
end_include

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|asn_oid
name|oid_newRoot
init|=
name|OIDX_newRoot
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|asn_oid
name|oid_TopologyChange
init|=
name|OIDX_topologyChange
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|asn_oid
name|oid_begemotBrigeName
init|= \
name|OIDX_begemotBridgeBaseName
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|asn_oid
name|oid_begemotNewRoot
init|=
name|OIDX_begemotBridgeNewRoot
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|asn_oid
name|oid_begemotTopologyChange
init|= \
name|OIDX_begemotBridgeTopologyChange
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|TAILQ_HEAD
argument_list|(
name|bridge_ifs
argument_list|,
name|bridge_if
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*  * Free the bridge interface list.  */
end_comment

begin_function
specifier|static
name|void
name|bridge_ifs_free
parameter_list|(
name|struct
name|bridge_ifs
modifier|*
name|headp
parameter_list|)
block|{
name|struct
name|bridge_if
modifier|*
name|b
decl_stmt|;
while|while
condition|(
operator|(
name|b
operator|=
name|TAILQ_FIRST
argument_list|(
name|headp
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|TAILQ_REMOVE
argument_list|(
name|headp
argument_list|,
name|b
argument_list|,
name|b_if
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|b
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Insert an entry in the bridge interface TAILQ. Keep the  * TAILQ sorted by the bridge's interface name.  */
end_comment

begin_function
specifier|static
name|void
name|bridge_ifs_insert
parameter_list|(
name|struct
name|bridge_ifs
modifier|*
name|headp
parameter_list|,
name|struct
name|bridge_if
modifier|*
name|b
parameter_list|)
block|{
name|struct
name|bridge_if
modifier|*
name|temp
decl_stmt|;
if|if
condition|(
operator|(
name|temp
operator|=
name|TAILQ_FIRST
argument_list|(
name|headp
argument_list|)
operator|)
operator|==
name|NULL
operator|||
name|strcmp
argument_list|(
name|b
operator|->
name|bif_name
argument_list|,
name|temp
operator|->
name|bif_name
argument_list|)
operator|<
literal|0
condition|)
block|{
name|TAILQ_INSERT_HEAD
argument_list|(
name|headp
argument_list|,
name|b
argument_list|,
name|b_if
argument_list|)
expr_stmt|;
return|return;
block|}
name|TAILQ_FOREACH
argument_list|(
argument|temp
argument_list|,
argument|headp
argument_list|,
argument|b_if
argument_list|)
if|if
condition|(
name|strcmp
argument_list|(
name|b
operator|->
name|bif_name
argument_list|,
name|temp
operator|->
name|bif_name
argument_list|)
operator|<
literal|0
condition|)
name|TAILQ_INSERT_BEFORE
argument_list|(
name|temp
argument_list|,
name|b
argument_list|,
name|b_if
argument_list|)
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
name|headp
argument_list|,
name|b
argument_list|,
name|b_if
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* The global bridge interface list. */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|bridge_ifs
name|bridge_ifs
init|=
name|TAILQ_HEAD_INITIALIZER
argument_list|(
name|bridge_ifs
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|time_t
name|bridge_list_age
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Free the global list.  */
end_comment

begin_function
name|void
name|bridge_ifs_fini
parameter_list|(
name|void
parameter_list|)
block|{
name|bridge_ifs_free
argument_list|(
operator|&
name|bridge_ifs
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Find a bridge interface entry by the bridge interface system index.  */
end_comment

begin_function
name|struct
name|bridge_if
modifier|*
name|bridge_if_find_ifs
parameter_list|(
name|uint32_t
name|sysindex
parameter_list|)
block|{
name|struct
name|bridge_if
modifier|*
name|b
decl_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|b
argument_list|,
argument|&bridge_ifs
argument_list|,
argument|b_if
argument_list|)
if|if
condition|(
name|b
operator|->
name|sysindex
operator|==
name|sysindex
condition|)
return|return
operator|(
name|b
operator|)
return|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Find a bridge interface entry by the bridge interface name.  */
end_comment

begin_function
name|struct
name|bridge_if
modifier|*
name|bridge_if_find_ifname
parameter_list|(
specifier|const
name|char
modifier|*
name|b_name
parameter_list|)
block|{
name|struct
name|bridge_if
modifier|*
name|b
decl_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|b
argument_list|,
argument|&bridge_ifs
argument_list|,
argument|b_if
argument_list|)
if|if
condition|(
name|strcmp
argument_list|(
name|b_name
argument_list|,
name|b
operator|->
name|bif_name
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|b
operator|)
return|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Find a bridge name by the bridge interface system index.  */
end_comment

begin_function
specifier|const
name|char
modifier|*
name|bridge_if_find_name
parameter_list|(
name|uint32_t
name|sysindex
parameter_list|)
block|{
name|struct
name|bridge_if
modifier|*
name|b
decl_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|b
argument_list|,
argument|&bridge_ifs
argument_list|,
argument|b_if
argument_list|)
if|if
condition|(
name|b
operator|->
name|sysindex
operator|==
name|sysindex
condition|)
return|return
operator|(
name|b
operator|->
name|bif_name
operator|)
return|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Given two bridge interfaces' system indexes, find their  * corresponding names and return the result of the name  * comparison. Returns:  * error : -2  * i1< i2 : -1  * i1> i2 : +1  * i1 = i2 : 0  */
end_comment

begin_function
name|int
name|bridge_compare_sysidx
parameter_list|(
name|uint32_t
name|i1
parameter_list|,
name|uint32_t
name|i2
parameter_list|)
block|{
name|int
name|c
decl_stmt|;
specifier|const
name|char
modifier|*
name|b1
decl_stmt|,
modifier|*
name|b2
decl_stmt|;
if|if
condition|(
name|i1
operator|==
name|i2
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
operator|(
name|b1
operator|=
name|bridge_if_find_name
argument_list|(
name|i1
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"Bridge interface %d does not exist"
argument_list|,
name|i1
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|2
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|b2
operator|=
name|bridge_if_find_name
argument_list|(
name|i2
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"Bridge interface %d does not exist"
argument_list|,
name|i2
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|2
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|c
operator|=
name|strcmp
argument_list|(
name|b1
argument_list|,
name|b2
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
elseif|else
if|if
condition|(
name|c
operator|>
literal|0
condition|)
return|return
operator|(
literal|1
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Fetch the first bridge interface from the list.  */
end_comment

begin_function
name|struct
name|bridge_if
modifier|*
name|bridge_first_bif
parameter_list|(
name|void
parameter_list|)
block|{
return|return
operator|(
name|TAILQ_FIRST
argument_list|(
operator|&
name|bridge_ifs
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Fetch the next bridge interface from the list.  */
end_comment

begin_function
name|struct
name|bridge_if
modifier|*
name|bridge_next_bif
parameter_list|(
name|struct
name|bridge_if
modifier|*
name|b_pr
parameter_list|)
block|{
return|return
operator|(
name|TAILQ_NEXT
argument_list|(
name|b_pr
argument_list|,
name|b_if
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Create a new entry for a bridge interface and insert  * it in the list.  */
end_comment

begin_function
specifier|static
name|struct
name|bridge_if
modifier|*
name|bridge_new_bif
parameter_list|(
specifier|const
name|char
modifier|*
name|bif_n
parameter_list|,
name|uint32_t
name|sysindex
parameter_list|,
specifier|const
name|u_char
modifier|*
name|physaddr
parameter_list|)
block|{
name|struct
name|bridge_if
modifier|*
name|bif
decl_stmt|;
if|if
condition|(
operator|(
name|bif
operator|=
operator|(
expr|struct
name|bridge_if
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|bif
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"bridge new interface failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|bzero
argument_list|(
name|bif
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|bridge_if
argument_list|)
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|bif
operator|->
name|bif_name
argument_list|,
name|bif_n
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|physaddr
argument_list|,
name|bif
operator|->
name|br_addr
operator|.
name|octet
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|bif
operator|->
name|sysindex
operator|=
name|sysindex
expr_stmt|;
name|bif
operator|->
name|br_type
operator|=
name|BaseType_transparent_only
expr_stmt|;
comment|/* 1 - all bridges default hold time * 100 - centi-seconds */
name|bif
operator|->
name|hold_time
operator|=
literal|1
operator|*
literal|100
expr_stmt|;
name|bif
operator|->
name|prot_spec
operator|=
name|dot1dStpProtocolSpecification_ieee8021d
expr_stmt|;
name|bridge_ifs_insert
argument_list|(
operator|&
name|bridge_ifs
argument_list|,
name|bif
argument_list|)
expr_stmt|;
return|return
operator|(
name|bif
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Remove a bridge interface from the list, freeing all it's ports  * and address entries.  */
end_comment

begin_function
name|void
name|bridge_remove_bif
parameter_list|(
name|struct
name|bridge_if
modifier|*
name|bif
parameter_list|)
block|{
name|bridge_members_free
argument_list|(
name|bif
argument_list|)
expr_stmt|;
name|bridge_addrs_free
argument_list|(
name|bif
argument_list|)
expr_stmt|;
name|TAILQ_REMOVE
argument_list|(
operator|&
name|bridge_ifs
argument_list|,
name|bif
argument_list|,
name|b_if
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|bif
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Prepare the variable (bridge interface name) for the private  * begemot notifications.  */
end_comment

begin_function
specifier|static
name|struct
name|snmp_value
modifier|*
name|bridge_basename_var
parameter_list|(
name|struct
name|bridge_if
modifier|*
name|bif
parameter_list|,
name|struct
name|snmp_value
modifier|*
name|b_val
parameter_list|)
block|{
name|uint
name|i
decl_stmt|;
name|b_val
operator|->
name|var
operator|=
name|oid_begemotBrigeName
expr_stmt|;
name|b_val
operator|->
name|var
operator|.
name|subs
index|[
name|b_val
operator|->
name|var
operator|.
name|len
operator|++
index|]
operator|=
name|strlen
argument_list|(
name|bif
operator|->
name|bif_name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|b_val
operator|->
name|v
operator|.
name|octetstring
operator|.
name|octets
operator|=
operator|(
name|u_char
operator|*
operator|)
name|malloc
argument_list|(
name|strlen
argument_list|(
name|bif
operator|->
name|bif_name
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|strlen
argument_list|(
name|bif
operator|->
name|bif_name
argument_list|)
condition|;
name|i
operator|++
control|)
name|b_val
operator|->
name|var
operator|.
name|subs
index|[
name|b_val
operator|->
name|var
operator|.
name|len
operator|++
index|]
operator|=
name|bif
operator|->
name|bif_name
index|[
name|i
index|]
expr_stmt|;
name|b_val
operator|->
name|v
operator|.
name|octetstring
operator|.
name|len
operator|=
name|strlen
argument_list|(
name|bif
operator|->
name|bif_name
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|bif
operator|->
name|bif_name
argument_list|,
name|b_val
operator|->
name|v
operator|.
name|octetstring
operator|.
name|octets
argument_list|,
name|strlen
argument_list|(
name|bif
operator|->
name|bif_name
argument_list|)
argument_list|)
expr_stmt|;
name|b_val
operator|->
name|syntax
operator|=
name|SNMP_SYNTAX_OCTETSTRING
expr_stmt|;
return|return
operator|(
name|b_val
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Compare the values of the old and the new root port and  * send a new root notification, if they are not matching.  */
end_comment

begin_function
specifier|static
name|void
name|bridge_new_root
parameter_list|(
name|struct
name|bridge_if
modifier|*
name|bif
parameter_list|)
block|{
name|struct
name|snmp_value
name|bif_idx
decl_stmt|;
if|if
condition|(
name|bridge_get_default
argument_list|()
operator|==
name|bif
condition|)
name|snmp_send_trap
argument_list|(
operator|&
name|oid_newRoot
argument_list|,
operator|(
expr|struct
name|snmp_value
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|bridge_basename_var
argument_list|(
name|bif
argument_list|,
operator|&
name|bif_idx
argument_list|)
operator|==
name|NULL
condition|)
return|return;
name|snmp_send_trap
argument_list|(
operator|&
name|oid_begemotTopologyChange
argument_list|,
operator|&
name|bif_idx
argument_list|,
operator|(
expr|struct
name|snmp_value
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Compare the new and old topology change times and send a  * topology change notification if necessary.  */
end_comment

begin_function
specifier|static
name|void
name|bridge_top_change
parameter_list|(
name|struct
name|bridge_if
modifier|*
name|bif
parameter_list|)
block|{
name|struct
name|snmp_value
name|bif_idx
decl_stmt|;
if|if
condition|(
name|bridge_get_default
argument_list|()
operator|==
name|bif
condition|)
name|snmp_send_trap
argument_list|(
operator|&
name|oid_TopologyChange
argument_list|,
operator|(
expr|struct
name|snmp_value
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|bridge_basename_var
argument_list|(
name|bif
argument_list|,
operator|&
name|bif_idx
argument_list|)
operator|==
name|NULL
condition|)
return|return;
name|snmp_send_trap
argument_list|(
operator|&
name|oid_begemotNewRoot
argument_list|,
operator|&
name|bif_idx
argument_list|,
operator|(
expr|struct
name|snmp_value
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|bridge_if_create
parameter_list|(
specifier|const
name|char
modifier|*
name|b_name
parameter_list|,
name|int8_t
name|up
parameter_list|)
block|{
if|if
condition|(
name|bridge_create
argument_list|(
name|b_name
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|up
operator|==
literal|1
operator|&&
operator|(
name|bridge_set_if_up
argument_list|(
name|b_name
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
operator|)
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
comment|/* 	 * Do not create a new bridge entry here - 	 * wait until the mibII module notifies us. 	 */
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bridge_if_destroy
parameter_list|(
name|struct
name|bridge_if
modifier|*
name|bif
parameter_list|)
block|{
if|if
condition|(
name|bridge_destroy
argument_list|(
name|bif
operator|->
name|bif_name
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|bridge_remove_bif
argument_list|(
name|bif
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Calculate the timeticks since the last topology change.  */
end_comment

begin_function
specifier|static
name|int
name|bridge_get_time_since_tc
parameter_list|(
name|struct
name|bridge_if
modifier|*
name|bif
parameter_list|,
name|uint32_t
modifier|*
name|ticks
parameter_list|)
block|{
name|struct
name|timeval
name|ct
decl_stmt|;
if|if
condition|(
name|gettimeofday
argument_list|(
operator|&
name|ct
argument_list|,
name|NULL
argument_list|)
operator|<
literal|0
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"bridge get time since last TC:"
literal|"getttimeofday failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|ct
operator|.
name|tv_usec
operator|-
name|bif
operator|->
name|last_tc_time
operator|.
name|tv_usec
operator|<
literal|0
condition|)
block|{
name|ct
operator|.
name|tv_sec
operator|-=
literal|1
expr_stmt|;
name|ct
operator|.
name|tv_usec
operator|+=
literal|1000000
expr_stmt|;
block|}
name|ct
operator|.
name|tv_sec
operator|-=
name|bif
operator|->
name|last_tc_time
operator|.
name|tv_sec
expr_stmt|;
name|ct
operator|.
name|tv_usec
operator|-=
name|bif
operator|->
name|last_tc_time
operator|.
name|tv_usec
expr_stmt|;
operator|*
name|ticks
operator|=
name|ct
operator|.
name|tv_sec
operator|*
literal|100
operator|+
name|ct
operator|.
name|tv_usec
operator|/
literal|10000
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Update the info we have for a single bridge interface.  * Return:  * 1, if successful  * 0, if the interface was deleted  * -1, error occured while fetching the info from the kernel.  */
end_comment

begin_function
specifier|static
name|int
name|bridge_update_bif
parameter_list|(
name|struct
name|bridge_if
modifier|*
name|bif
parameter_list|)
block|{
name|struct
name|mibif
modifier|*
name|ifp
decl_stmt|;
comment|/* Walk through the mibII interface list. */
for|for
control|(
name|ifp
operator|=
name|mib_first_if
argument_list|()
init|;
name|ifp
operator|!=
name|NULL
condition|;
name|ifp
operator|=
name|mib_next_if
argument_list|(
name|ifp
argument_list|)
control|)
if|if
condition|(
name|strcmp
argument_list|(
name|ifp
operator|->
name|name
argument_list|,
name|bif
operator|->
name|bif_name
argument_list|)
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
name|ifp
operator|==
name|NULL
condition|)
block|{
comment|/* Ops, we do not exist anymore. */
name|bridge_remove_bif
argument_list|(
name|bif
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|ifp
operator|->
name|physaddr
operator|!=
name|NULL
condition|)
name|bcopy
argument_list|(
name|ifp
operator|->
name|physaddr
argument_list|,
name|bif
operator|->
name|br_addr
operator|.
name|octet
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
else|else
name|bridge_get_basemac
argument_list|(
name|bif
operator|->
name|bif_name
argument_list|,
name|bif
operator|->
name|br_addr
operator|.
name|octet
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|mib
operator|.
name|ifmd_flags
operator|&
name|IFF_RUNNING
condition|)
name|bif
operator|->
name|if_status
operator|=
name|RowStatus_active
expr_stmt|;
else|else
name|bif
operator|->
name|if_status
operator|=
name|RowStatus_notInService
expr_stmt|;
switch|switch
condition|(
name|bridge_getinfo_bif
argument_list|(
name|bif
argument_list|)
condition|)
block|{
case|case
literal|2
case|:
name|bridge_new_root
argument_list|(
name|bif
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|bridge_top_change
argument_list|(
name|bif
argument_list|)
expr_stmt|;
break|break;
case|case
operator|-
literal|1
case|:
name|bridge_remove_bif
argument_list|(
name|bif
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
default|default:
break|break;
block|}
comment|/* 	 * The number of ports is accessible via SNMP - 	 * update the ports each time the bridge interface data 	 * is refreshed too. 	 */
name|bif
operator|->
name|num_ports
operator|=
name|bridge_update_memif
argument_list|(
name|bif
argument_list|)
expr_stmt|;
name|bif
operator|->
name|entry_age
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Update all bridge interfaces' ports only -   * make sure each bridge interface exists first.  */
end_comment

begin_function
name|void
name|bridge_update_all_ports
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|mibif
modifier|*
name|ifp
decl_stmt|;
name|struct
name|bridge_if
modifier|*
name|bif
decl_stmt|,
modifier|*
name|t_bif
decl_stmt|;
for|for
control|(
name|bif
operator|=
name|bridge_first_bif
argument_list|()
init|;
name|bif
operator|!=
name|NULL
condition|;
name|bif
operator|=
name|t_bif
control|)
block|{
name|t_bif
operator|=
name|bridge_next_bif
argument_list|(
name|bif
argument_list|)
expr_stmt|;
for|for
control|(
name|ifp
operator|=
name|mib_first_if
argument_list|()
init|;
name|ifp
operator|!=
name|NULL
condition|;
name|ifp
operator|=
name|mib_next_if
argument_list|(
name|ifp
argument_list|)
control|)
if|if
condition|(
name|strcmp
argument_list|(
name|ifp
operator|->
name|name
argument_list|,
name|bif
operator|->
name|bif_name
argument_list|)
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
name|ifp
operator|!=
name|NULL
condition|)
name|bif
operator|->
name|num_ports
operator|=
name|bridge_update_memif
argument_list|(
name|bif
argument_list|)
expr_stmt|;
else|else
comment|/* Ops, we do not exist anymore. */
name|bridge_remove_bif
argument_list|(
name|bif
argument_list|)
expr_stmt|;
block|}
name|bridge_ports_update_listage
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Update all addresses only.  */
end_comment

begin_function
name|void
name|bridge_update_all_addrs
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|mibif
modifier|*
name|ifp
decl_stmt|;
name|struct
name|bridge_if
modifier|*
name|bif
decl_stmt|,
modifier|*
name|t_bif
decl_stmt|;
for|for
control|(
name|bif
operator|=
name|bridge_first_bif
argument_list|()
init|;
name|bif
operator|!=
name|NULL
condition|;
name|bif
operator|=
name|t_bif
control|)
block|{
name|t_bif
operator|=
name|bridge_next_bif
argument_list|(
name|bif
argument_list|)
expr_stmt|;
for|for
control|(
name|ifp
operator|=
name|mib_first_if
argument_list|()
init|;
name|ifp
operator|!=
name|NULL
condition|;
name|ifp
operator|=
name|mib_next_if
argument_list|(
name|ifp
argument_list|)
control|)
if|if
condition|(
name|strcmp
argument_list|(
name|ifp
operator|->
name|name
argument_list|,
name|bif
operator|->
name|bif_name
argument_list|)
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
name|ifp
operator|!=
name|NULL
condition|)
name|bif
operator|->
name|num_addrs
operator|=
name|bridge_update_addrs
argument_list|(
name|bif
argument_list|)
expr_stmt|;
else|else
comment|/* Ops, we don't exist anymore. */
name|bridge_remove_bif
argument_list|(
name|bif
argument_list|)
expr_stmt|;
block|}
name|bridge_addrs_update_listage
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Update only the bridge interfaces' data - skip addresses.  */
end_comment

begin_function
name|void
name|bridge_update_all_ifs
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|bridge_if
modifier|*
name|bif
decl_stmt|,
modifier|*
name|t_bif
decl_stmt|;
for|for
control|(
name|bif
operator|=
name|bridge_first_bif
argument_list|()
init|;
name|bif
operator|!=
name|NULL
condition|;
name|bif
operator|=
name|t_bif
control|)
block|{
name|t_bif
operator|=
name|bridge_next_bif
argument_list|(
name|bif
argument_list|)
expr_stmt|;
name|bridge_update_bif
argument_list|(
name|bif
argument_list|)
expr_stmt|;
block|}
name|bridge_ports_update_listage
argument_list|()
expr_stmt|;
name|bridge_list_age
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Update all info we have for all bridges.  */
end_comment

begin_function
name|void
name|bridge_update_all
parameter_list|(
name|void
modifier|*
name|arg
name|__unused
parameter_list|)
block|{
name|struct
name|bridge_if
modifier|*
name|bif
decl_stmt|,
modifier|*
name|t_bif
decl_stmt|;
for|for
control|(
name|bif
operator|=
name|bridge_first_bif
argument_list|()
init|;
name|bif
operator|!=
name|NULL
condition|;
name|bif
operator|=
name|t_bif
control|)
block|{
name|t_bif
operator|=
name|bridge_next_bif
argument_list|(
name|bif
argument_list|)
expr_stmt|;
if|if
condition|(
name|bridge_update_bif
argument_list|(
name|bif
argument_list|)
operator|<=
literal|0
condition|)
continue|continue;
comment|/* Update our learnt addresses. */
name|bif
operator|->
name|num_addrs
operator|=
name|bridge_update_addrs
argument_list|(
name|bif
argument_list|)
expr_stmt|;
block|}
name|bridge_list_age
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|bridge_ports_update_listage
argument_list|()
expr_stmt|;
name|bridge_addrs_update_listage
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Callback for polling our last topology change time -  * check whether we are root or whether a TC was detected once every  * 30 seconds, so that we can send the newRoot and TopologyChange traps  * on time. The rest of the data is polled only once every 5 min.  */
end_comment

begin_function
name|void
name|bridge_update_tc_time
parameter_list|(
name|void
modifier|*
name|arg
name|__unused
parameter_list|)
block|{
name|struct
name|bridge_if
modifier|*
name|bif
decl_stmt|;
name|struct
name|mibif
modifier|*
name|ifp
decl_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|bif
argument_list|,
argument|&bridge_ifs
argument_list|,
argument|b_if
argument_list|)
block|{
comment|/* Walk through the mibII interface list. */
for|for
control|(
name|ifp
operator|=
name|mib_first_if
argument_list|()
init|;
name|ifp
operator|!=
name|NULL
condition|;
name|ifp
operator|=
name|mib_next_if
argument_list|(
name|ifp
argument_list|)
control|)
if|if
condition|(
name|strcmp
argument_list|(
name|ifp
operator|->
name|name
argument_list|,
name|bif
operator|->
name|bif_name
argument_list|)
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
name|ifp
operator|==
name|NULL
condition|)
block|{
name|bridge_remove_bif
argument_list|(
name|bif
argument_list|)
expr_stmt|;
continue|continue;
block|}
switch|switch
condition|(
name|bridge_get_op_param
argument_list|(
name|bif
argument_list|)
condition|)
block|{
case|case
literal|2
case|:
name|bridge_new_root
argument_list|(
name|bif
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|bridge_top_change
argument_list|(
name|bif
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
end_function

begin_comment
comment|/*  * Callback for handling new bridge interface creation.  */
end_comment

begin_function
name|int
name|bridge_attach_newif
parameter_list|(
name|struct
name|mibif
modifier|*
name|ifp
parameter_list|)
block|{
name|u_char
modifier|*
name|p_mac
decl_stmt|,
name|mac
index|[
name|ETHER_ADDR_LEN
index|]
decl_stmt|;
name|struct
name|bridge_if
modifier|*
name|bif
decl_stmt|;
if|if
condition|(
name|ifp
operator|->
name|mib
operator|.
name|ifmd_data
operator|.
name|ifi_type
operator|!=
name|IFT_BRIDGE
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* Make sure it does not exist in our list. */
name|TAILQ_FOREACH
argument_list|(
argument|bif
argument_list|,
argument|&bridge_ifs
argument_list|,
argument|b_if
argument_list|)
if|if
condition|(
name|strcmp
argument_list|(
name|bif
operator|->
name|bif_name
argument_list|,
name|ifp
operator|->
name|name
argument_list|)
operator|==
literal|0
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"bridge interface %s already "
literal|"in list"
argument_list|,
name|bif
operator|->
name|bif_name
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|p_mac
operator|=
name|ifp
operator|->
name|physaddr
operator|)
operator|==
name|NULL
operator|&&
operator|(
name|p_mac
operator|=
name|bridge_get_basemac
argument_list|(
name|ifp
operator|->
name|name
argument_list|,
name|mac
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"bridge attach new %s failed - "
literal|"no bridge mac address"
argument_list|,
name|ifp
operator|->
name|name
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|bif
operator|=
name|bridge_new_bif
argument_list|(
name|ifp
operator|->
name|name
argument_list|,
name|ifp
operator|->
name|sysindex
argument_list|,
name|p_mac
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|ifp
operator|->
name|mib
operator|.
name|ifmd_flags
operator|&
name|IFF_RUNNING
condition|)
name|bif
operator|->
name|if_status
operator|=
name|RowStatus_active
expr_stmt|;
else|else
name|bif
operator|->
name|if_status
operator|=
name|RowStatus_notInService
expr_stmt|;
comment|/* Skip sending notifications if the interface was just created. */
if|if
condition|(
name|bridge_getinfo_bif
argument_list|(
name|bif
argument_list|)
operator|<
literal|0
operator|||
operator|(
name|bif
operator|->
name|num_ports
operator|=
name|bridge_getinfo_bif_ports
argument_list|(
name|bif
argument_list|)
operator|)
operator|<
literal|0
operator|||
operator|(
name|bif
operator|->
name|num_addrs
operator|=
name|bridge_getinfo_bif_addrs
argument_list|(
name|bif
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|bridge_remove_bif
argument_list|(
name|bif
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* Check whether we are the default bridge interface. */
if|if
condition|(
name|strcmp
argument_list|(
name|ifp
operator|->
name|name
argument_list|,
name|bridge_get_default_name
argument_list|()
argument_list|)
operator|==
literal|0
condition|)
name|bridge_set_default
argument_list|(
name|bif
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|void
name|bridge_ifs_dump
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|bridge_if
modifier|*
name|bif
decl_stmt|;
for|for
control|(
name|bif
operator|=
name|bridge_first_bif
argument_list|()
init|;
name|bif
operator|!=
name|NULL
condition|;
name|bif
operator|=
name|bridge_next_bif
argument_list|(
name|bif
argument_list|)
control|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"Bridge %s, index - %d"
argument_list|,
name|bif
operator|->
name|bif_name
argument_list|,
name|bif
operator|->
name|sysindex
argument_list|)
expr_stmt|;
name|bridge_ports_dump
argument_list|(
name|bif
argument_list|)
expr_stmt|;
name|bridge_addrs_dump
argument_list|(
name|bif
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * RFC4188 specifics.  */
end_comment

begin_function
name|int
name|op_dot1d_base
parameter_list|(
name|struct
name|snmp_context
modifier|*
name|ctx
name|__unused
parameter_list|,
name|struct
name|snmp_value
modifier|*
name|value
parameter_list|,
name|uint
name|sub
parameter_list|,
name|uint
name|iidx
name|__unused
parameter_list|,
name|enum
name|snmp_op
name|op
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|struct
name|bridge_if
modifier|*
name|bif
decl_stmt|;
if|if
condition|(
operator|(
name|bif
operator|=
name|bridge_get_default
argument_list|()
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
if|if
condition|(
name|time
argument_list|(
name|NULL
argument_list|)
operator|-
name|bif
operator|->
name|entry_age
operator|>
name|bridge_get_data_maxage
argument_list|()
operator|&&
name|bridge_update_bif
argument_list|(
name|bif
argument_list|)
operator|<=
literal|0
condition|)
comment|/* It was just deleted. */
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
name|ret
operator|=
name|SNMP_ERR_NOERROR
expr_stmt|;
switch|switch
condition|(
name|op
condition|)
block|{
case|case
name|SNMP_OP_GET
case|:
switch|switch
condition|(
name|value
operator|->
name|var
operator|.
name|subs
index|[
name|sub
operator|-
literal|1
index|]
condition|)
block|{
case|case
name|LEAF_dot1dBaseBridgeAddress
case|:
name|ret
operator|=
name|string_get
argument_list|(
name|value
argument_list|,
name|bif
operator|->
name|br_addr
operator|.
name|octet
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
break|break;
case|case
name|LEAF_dot1dBaseNumPorts
case|:
name|value
operator|->
name|v
operator|.
name|integer
operator|=
name|bif
operator|->
name|num_ports
expr_stmt|;
break|break;
case|case
name|LEAF_dot1dBaseType
case|:
name|value
operator|->
name|v
operator|.
name|integer
operator|=
name|bif
operator|->
name|br_type
expr_stmt|;
break|break;
name|abort
argument_list|()
expr_stmt|;
block|}
break|break;
case|case
name|SNMP_OP_SET
case|:
name|ret
operator|=
name|SNMP_ERR_NOT_WRITEABLE
expr_stmt|;
break|break;
case|case
name|SNMP_OP_GETNEXT
case|:
case|case
name|SNMP_OP_ROLLBACK
case|:
case|case
name|SNMP_OP_COMMIT
case|:
name|abort
argument_list|()
expr_stmt|;
block|}
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
name|int
name|op_dot1d_stp
parameter_list|(
name|struct
name|snmp_context
modifier|*
name|ctx
parameter_list|,
name|struct
name|snmp_value
modifier|*
name|value
parameter_list|,
name|uint
name|sub
parameter_list|,
name|uint
name|iidx
name|__unused
parameter_list|,
name|enum
name|snmp_op
name|op
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|struct
name|bridge_if
modifier|*
name|bif
decl_stmt|;
if|if
condition|(
operator|(
name|bif
operator|=
name|bridge_get_default
argument_list|()
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
if|if
condition|(
name|time
argument_list|(
name|NULL
argument_list|)
operator|-
name|bif
operator|->
name|entry_age
operator|>
name|bridge_get_data_maxage
argument_list|()
operator|&&
name|bridge_update_bif
argument_list|(
name|bif
argument_list|)
operator|<=
literal|0
condition|)
comment|/* It was just deleted. */
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
switch|switch
condition|(
name|op
condition|)
block|{
case|case
name|SNMP_OP_GET
case|:
switch|switch
condition|(
name|value
operator|->
name|var
operator|.
name|subs
index|[
name|sub
operator|-
literal|1
index|]
condition|)
block|{
case|case
name|LEAF_dot1dStpProtocolSpecification
case|:
name|value
operator|->
name|v
operator|.
name|integer
operator|=
name|bif
operator|->
name|prot_spec
expr_stmt|;
break|break;
case|case
name|LEAF_dot1dStpPriority
case|:
name|value
operator|->
name|v
operator|.
name|integer
operator|=
name|bif
operator|->
name|priority
expr_stmt|;
break|break;
case|case
name|LEAF_dot1dStpTimeSinceTopologyChange
case|:
if|if
condition|(
name|bridge_get_time_since_tc
argument_list|(
name|bif
argument_list|,
operator|&
operator|(
name|value
operator|->
name|v
operator|.
name|uint32
operator|)
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
name|SNMP_ERR_GENERR
operator|)
return|;
break|break;
case|case
name|LEAF_dot1dStpTopChanges
case|:
name|value
operator|->
name|v
operator|.
name|uint32
operator|=
name|bif
operator|->
name|top_changes
expr_stmt|;
break|break;
case|case
name|LEAF_dot1dStpDesignatedRoot
case|:
return|return
operator|(
name|string_get
argument_list|(
name|value
argument_list|,
name|bif
operator|->
name|design_root
argument_list|,
name|SNMP_BRIDGE_ID_LEN
argument_list|)
operator|)
return|;
case|case
name|LEAF_dot1dStpRootCost
case|:
name|value
operator|->
name|v
operator|.
name|integer
operator|=
name|bif
operator|->
name|root_cost
expr_stmt|;
break|break;
case|case
name|LEAF_dot1dStpRootPort
case|:
name|value
operator|->
name|v
operator|.
name|integer
operator|=
name|bif
operator|->
name|root_port
expr_stmt|;
break|break;
case|case
name|LEAF_dot1dStpMaxAge
case|:
name|value
operator|->
name|v
operator|.
name|integer
operator|=
name|bif
operator|->
name|max_age
expr_stmt|;
break|break;
case|case
name|LEAF_dot1dStpHelloTime
case|:
name|value
operator|->
name|v
operator|.
name|integer
operator|=
name|bif
operator|->
name|hello_time
expr_stmt|;
break|break;
case|case
name|LEAF_dot1dStpHoldTime
case|:
name|value
operator|->
name|v
operator|.
name|integer
operator|=
name|bif
operator|->
name|hold_time
expr_stmt|;
break|break;
case|case
name|LEAF_dot1dStpForwardDelay
case|:
name|value
operator|->
name|v
operator|.
name|integer
operator|=
name|bif
operator|->
name|fwd_delay
expr_stmt|;
break|break;
case|case
name|LEAF_dot1dStpBridgeMaxAge
case|:
name|value
operator|->
name|v
operator|.
name|integer
operator|=
name|bif
operator|->
name|bridge_max_age
expr_stmt|;
break|break;
case|case
name|LEAF_dot1dStpBridgeHelloTime
case|:
name|value
operator|->
name|v
operator|.
name|integer
operator|=
name|bif
operator|->
name|bridge_hello_time
expr_stmt|;
break|break;
case|case
name|LEAF_dot1dStpBridgeForwardDelay
case|:
name|value
operator|->
name|v
operator|.
name|integer
operator|=
name|bif
operator|->
name|bridge_fwd_delay
expr_stmt|;
break|break;
case|case
name|LEAF_dot1dStpVersion
case|:
name|value
operator|->
name|v
operator|.
name|integer
operator|=
name|bif
operator|->
name|stp_version
expr_stmt|;
break|break;
case|case
name|LEAF_dot1dStpTxHoldCount
case|:
name|value
operator|->
name|v
operator|.
name|integer
operator|=
name|bif
operator|->
name|tx_hold_count
expr_stmt|;
block|}
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
case|case
name|SNMP_OP_GETNEXT
case|:
name|abort
argument_list|()
expr_stmt|;
case|case
name|SNMP_OP_SET
case|:
switch|switch
condition|(
name|value
operator|->
name|var
operator|.
name|subs
index|[
name|sub
operator|-
literal|1
index|]
condition|)
block|{
case|case
name|LEAF_dot1dStpPriority
case|:
name|ctx
operator|->
name|scratch
operator|->
name|int1
operator|=
name|bif
operator|->
name|priority
expr_stmt|;
name|ret
operator|=
name|bridge_set_priority
argument_list|(
name|bif
argument_list|,
name|value
operator|->
name|v
operator|.
name|integer
argument_list|)
expr_stmt|;
break|break;
case|case
name|LEAF_dot1dStpBridgeMaxAge
case|:
name|ctx
operator|->
name|scratch
operator|->
name|int1
operator|=
name|bif
operator|->
name|bridge_max_age
expr_stmt|;
name|ret
operator|=
name|bridge_set_maxage
argument_list|(
name|bif
argument_list|,
name|value
operator|->
name|v
operator|.
name|integer
argument_list|)
expr_stmt|;
break|break;
case|case
name|LEAF_dot1dStpBridgeHelloTime
case|:
name|ctx
operator|->
name|scratch
operator|->
name|int1
operator|=
name|bif
operator|->
name|bridge_hello_time
expr_stmt|;
name|ret
operator|=
name|bridge_set_hello_time
argument_list|(
name|bif
argument_list|,
name|value
operator|->
name|v
operator|.
name|integer
argument_list|)
expr_stmt|;
break|break;
case|case
name|LEAF_dot1dStpBridgeForwardDelay
case|:
name|ctx
operator|->
name|scratch
operator|->
name|int1
operator|=
name|bif
operator|->
name|bridge_fwd_delay
expr_stmt|;
name|ret
operator|=
name|bridge_set_forward_delay
argument_list|(
name|bif
argument_list|,
name|value
operator|->
name|v
operator|.
name|integer
argument_list|)
expr_stmt|;
break|break;
case|case
name|LEAF_dot1dStpVersion
case|:
name|ctx
operator|->
name|scratch
operator|->
name|int1
operator|=
name|bif
operator|->
name|stp_version
expr_stmt|;
name|ret
operator|=
name|bridge_set_stp_version
argument_list|(
name|bif
argument_list|,
name|value
operator|->
name|v
operator|.
name|integer
argument_list|)
expr_stmt|;
break|break;
case|case
name|LEAF_dot1dStpTxHoldCount
case|:
name|ctx
operator|->
name|scratch
operator|->
name|int1
operator|=
name|bif
operator|->
name|tx_hold_count
expr_stmt|;
name|ret
operator|=
name|bridge_set_tx_hold_count
argument_list|(
name|bif
argument_list|,
name|value
operator|->
name|v
operator|.
name|integer
argument_list|)
expr_stmt|;
break|break;
case|case
name|LEAF_dot1dStpProtocolSpecification
case|:
case|case
name|LEAF_dot1dStpTimeSinceTopologyChange
case|:
case|case
name|LEAF_dot1dStpTopChanges
case|:
case|case
name|LEAF_dot1dStpDesignatedRoot
case|:
case|case
name|LEAF_dot1dStpRootCost
case|:
case|case
name|LEAF_dot1dStpRootPort
case|:
case|case
name|LEAF_dot1dStpMaxAge
case|:
case|case
name|LEAF_dot1dStpHelloTime
case|:
case|case
name|LEAF_dot1dStpHoldTime
case|:
case|case
name|LEAF_dot1dStpForwardDelay
case|:
return|return
operator|(
name|SNMP_ERR_NOT_WRITEABLE
operator|)
return|;
default|default:
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
block|}
if|if
condition|(
name|ret
operator|==
operator|-
literal|2
condition|)
return|return
operator|(
name|SNMP_ERR_WRONG_VALUE
operator|)
return|;
elseif|else
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
return|return
operator|(
name|SNMP_ERR_GENERR
operator|)
return|;
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
case|case
name|SNMP_OP_ROLLBACK
case|:
switch|switch
condition|(
name|value
operator|->
name|var
operator|.
name|subs
index|[
name|sub
operator|-
literal|1
index|]
condition|)
block|{
case|case
name|LEAF_dot1dStpPriority
case|:
name|bridge_set_priority
argument_list|(
name|bif
argument_list|,
name|ctx
operator|->
name|scratch
operator|->
name|int1
argument_list|)
expr_stmt|;
break|break;
case|case
name|LEAF_dot1dStpBridgeMaxAge
case|:
name|bridge_set_maxage
argument_list|(
name|bif
argument_list|,
name|ctx
operator|->
name|scratch
operator|->
name|int1
argument_list|)
expr_stmt|;
break|break;
case|case
name|LEAF_dot1dStpBridgeHelloTime
case|:
name|bridge_set_hello_time
argument_list|(
name|bif
argument_list|,
name|ctx
operator|->
name|scratch
operator|->
name|int1
argument_list|)
expr_stmt|;
break|break;
case|case
name|LEAF_dot1dStpBridgeForwardDelay
case|:
name|bridge_set_forward_delay
argument_list|(
name|bif
argument_list|,
name|ctx
operator|->
name|scratch
operator|->
name|int1
argument_list|)
expr_stmt|;
break|break;
case|case
name|LEAF_dot1dStpVersion
case|:
name|bridge_set_stp_version
argument_list|(
name|bif
argument_list|,
name|ctx
operator|->
name|scratch
operator|->
name|int1
argument_list|)
expr_stmt|;
break|break;
case|case
name|LEAF_dot1dStpTxHoldCount
case|:
name|bridge_set_tx_hold_count
argument_list|(
name|bif
argument_list|,
name|ctx
operator|->
name|scratch
operator|->
name|int1
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
case|case
name|SNMP_OP_COMMIT
case|:
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
block|}
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
block|}
end_function

begin_function
name|int
name|op_dot1d_tp
parameter_list|(
name|struct
name|snmp_context
modifier|*
name|ctx
parameter_list|,
name|struct
name|snmp_value
modifier|*
name|value
parameter_list|,
name|uint
name|sub
parameter_list|,
name|uint
name|iidx
name|__unused
parameter_list|,
name|enum
name|snmp_op
name|op
parameter_list|)
block|{
name|struct
name|bridge_if
modifier|*
name|bif
decl_stmt|;
if|if
condition|(
operator|(
name|bif
operator|=
name|bridge_get_default
argument_list|()
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
if|if
condition|(
name|time
argument_list|(
name|NULL
argument_list|)
operator|-
name|bif
operator|->
name|entry_age
operator|>
name|bridge_get_data_maxage
argument_list|()
operator|&&
name|bridge_update_bif
argument_list|(
name|bif
argument_list|)
operator|<=
literal|0
condition|)
comment|/* It was just deleted. */
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
switch|switch
condition|(
name|op
condition|)
block|{
case|case
name|SNMP_OP_GET
case|:
switch|switch
condition|(
name|value
operator|->
name|var
operator|.
name|subs
index|[
name|sub
operator|-
literal|1
index|]
condition|)
block|{
case|case
name|LEAF_dot1dTpLearnedEntryDiscards
case|:
name|value
operator|->
name|v
operator|.
name|uint32
operator|=
name|bif
operator|->
name|lrnt_drops
expr_stmt|;
break|break;
case|case
name|LEAF_dot1dTpAgingTime
case|:
name|value
operator|->
name|v
operator|.
name|integer
operator|=
name|bif
operator|->
name|age_time
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
case|case
name|SNMP_OP_GETNEXT
case|:
name|abort
argument_list|()
expr_stmt|;
case|case
name|SNMP_OP_SET
case|:
if|if
condition|(
name|value
operator|->
name|var
operator|.
name|subs
index|[
name|sub
operator|-
literal|1
index|]
operator|==
name|LEAF_dot1dTpAgingTime
condition|)
block|{
name|ctx
operator|->
name|scratch
operator|->
name|int1
operator|=
name|bif
operator|->
name|age_time
expr_stmt|;
if|if
condition|(
name|bridge_set_aging_time
argument_list|(
name|bif
argument_list|,
name|value
operator|->
name|v
operator|.
name|integer
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
name|SNMP_ERR_GENERR
operator|)
return|;
block|}
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
case|case
name|SNMP_OP_ROLLBACK
case|:
if|if
condition|(
name|value
operator|->
name|var
operator|.
name|subs
index|[
name|sub
operator|-
literal|1
index|]
operator|==
name|LEAF_dot1dTpAgingTime
condition|)
name|bridge_set_aging_time
argument_list|(
name|bif
argument_list|,
name|ctx
operator|->
name|scratch
operator|->
name|int1
argument_list|)
expr_stmt|;
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
case|case
name|SNMP_OP_COMMIT
case|:
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
block|}
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Private BEGEMOT-BRIDGE-MIB specifics.  */
end_comment

begin_comment
comment|/*  * Get the bridge name from an OID index.  */
end_comment

begin_function
specifier|static
name|char
modifier|*
name|bridge_name_index_get
parameter_list|(
specifier|const
name|struct
name|asn_oid
modifier|*
name|oid
parameter_list|,
name|uint
name|sub
parameter_list|,
name|char
modifier|*
name|b_name
parameter_list|)
block|{
name|uint
name|i
decl_stmt|;
if|if
condition|(
name|oid
operator|->
name|len
operator|-
name|sub
operator|!=
name|oid
operator|->
name|subs
index|[
name|sub
index|]
operator|+
literal|1
operator|||
name|oid
operator|->
name|subs
index|[
name|sub
index|]
operator|>=
name|IFNAMSIZ
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|oid
operator|->
name|subs
index|[
name|sub
index|]
condition|;
name|i
operator|++
control|)
name|b_name
index|[
name|i
index|]
operator|=
name|oid
operator|->
name|subs
index|[
name|sub
operator|+
name|i
operator|+
literal|1
index|]
expr_stmt|;
name|b_name
index|[
name|i
index|]
operator|=
literal|'\0'
expr_stmt|;
return|return
operator|(
name|b_name
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bridge_if_index_append
parameter_list|(
name|struct
name|asn_oid
modifier|*
name|oid
parameter_list|,
name|uint
name|sub
parameter_list|,
specifier|const
name|struct
name|bridge_if
modifier|*
name|bif
parameter_list|)
block|{
name|uint
name|i
decl_stmt|;
name|oid
operator|->
name|len
operator|=
name|sub
operator|+
name|strlen
argument_list|(
name|bif
operator|->
name|bif_name
argument_list|)
operator|+
literal|1
expr_stmt|;
name|oid
operator|->
name|subs
index|[
name|sub
index|]
operator|=
name|strlen
argument_list|(
name|bif
operator|->
name|bif_name
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
name|strlen
argument_list|(
name|bif
operator|->
name|bif_name
argument_list|)
condition|;
name|i
operator|++
control|)
name|oid
operator|->
name|subs
index|[
name|sub
operator|+
name|i
index|]
operator|=
name|bif
operator|->
name|bif_name
index|[
name|i
operator|-
literal|1
index|]
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|bridge_if
modifier|*
name|bridge_if_index_get
parameter_list|(
specifier|const
name|struct
name|asn_oid
modifier|*
name|oid
parameter_list|,
name|uint
name|sub
parameter_list|)
block|{
name|uint
name|i
decl_stmt|;
name|char
name|bif_name
index|[
name|IFNAMSIZ
index|]
decl_stmt|;
if|if
condition|(
name|oid
operator|->
name|len
operator|-
name|sub
operator|!=
name|oid
operator|->
name|subs
index|[
name|sub
index|]
operator|+
literal|1
operator|||
name|oid
operator|->
name|subs
index|[
name|sub
index|]
operator|>=
name|IFNAMSIZ
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|oid
operator|->
name|subs
index|[
name|sub
index|]
condition|;
name|i
operator|++
control|)
name|bif_name
index|[
name|i
index|]
operator|=
name|oid
operator|->
name|subs
index|[
name|sub
operator|+
name|i
operator|+
literal|1
index|]
expr_stmt|;
name|bif_name
index|[
name|i
index|]
operator|=
literal|'\0'
expr_stmt|;
return|return
operator|(
name|bridge_if_find_ifname
argument_list|(
name|bif_name
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|bridge_if
modifier|*
name|bridge_if_index_getnext
parameter_list|(
specifier|const
name|struct
name|asn_oid
modifier|*
name|oid
parameter_list|,
name|uint
name|sub
parameter_list|)
block|{
name|uint
name|i
decl_stmt|;
name|char
name|bif_name
index|[
name|IFNAMSIZ
index|]
decl_stmt|;
name|struct
name|bridge_if
modifier|*
name|bif
decl_stmt|;
if|if
condition|(
name|oid
operator|->
name|len
operator|-
name|sub
operator|==
literal|0
condition|)
return|return
operator|(
name|bridge_first_bif
argument_list|()
operator|)
return|;
if|if
condition|(
name|oid
operator|->
name|len
operator|-
name|sub
operator|!=
name|oid
operator|->
name|subs
index|[
name|sub
index|]
operator|+
literal|1
operator|||
name|oid
operator|->
name|subs
index|[
name|sub
index|]
operator|>=
name|IFNAMSIZ
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|oid
operator|->
name|subs
index|[
name|sub
index|]
condition|;
name|i
operator|++
control|)
name|bif_name
index|[
name|i
index|]
operator|=
name|oid
operator|->
name|subs
index|[
name|sub
operator|+
name|i
operator|+
literal|1
index|]
expr_stmt|;
name|bif_name
index|[
name|i
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|(
name|bif
operator|=
name|bridge_if_find_ifname
argument_list|(
name|bif_name
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
return|return
operator|(
name|bridge_next_bif
argument_list|(
name|bif
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bridge_set_if_status
parameter_list|(
name|struct
name|snmp_context
modifier|*
name|ctx
parameter_list|,
name|struct
name|snmp_value
modifier|*
name|val
parameter_list|,
name|uint
name|sub
parameter_list|)
block|{
name|struct
name|bridge_if
modifier|*
name|bif
decl_stmt|;
name|char
name|bif_name
index|[
name|IFNAMSIZ
index|]
decl_stmt|;
name|bif
operator|=
name|bridge_if_index_get
argument_list|(
operator|&
name|val
operator|->
name|var
argument_list|,
name|sub
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|val
operator|->
name|v
operator|.
name|integer
condition|)
block|{
case|case
name|RowStatus_active
case|:
if|if
condition|(
name|bif
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_INCONS_VALUE
operator|)
return|;
name|ctx
operator|->
name|scratch
operator|->
name|int1
operator|=
name|bif
operator|->
name|if_status
expr_stmt|;
switch|switch
condition|(
name|bif
operator|->
name|if_status
condition|)
block|{
case|case
name|RowStatus_active
case|:
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
case|case
name|RowStatus_notInService
case|:
if|if
condition|(
name|bridge_set_if_up
argument_list|(
name|bif
operator|->
name|bif_name
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
name|SNMP_ERR_GENERR
operator|)
return|;
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
default|default:
break|break;
block|}
return|return
operator|(
name|SNMP_ERR_INCONS_VALUE
operator|)
return|;
case|case
name|RowStatus_notInService
case|:
if|if
condition|(
name|bif
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_INCONS_VALUE
operator|)
return|;
name|ctx
operator|->
name|scratch
operator|->
name|int1
operator|=
name|bif
operator|->
name|if_status
expr_stmt|;
switch|switch
condition|(
name|bif
operator|->
name|if_status
condition|)
block|{
case|case
name|RowStatus_active
case|:
if|if
condition|(
name|bridge_set_if_up
argument_list|(
name|bif
operator|->
name|bif_name
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
name|SNMP_ERR_GENERR
operator|)
return|;
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
case|case
name|RowStatus_notInService
case|:
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
default|default:
break|break;
block|}
return|return
operator|(
name|SNMP_ERR_INCONS_VALUE
operator|)
return|;
case|case
name|RowStatus_notReady
case|:
return|return
operator|(
name|SNMP_ERR_INCONS_VALUE
operator|)
return|;
case|case
name|RowStatus_createAndGo
case|:
if|if
condition|(
name|bif
operator|!=
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_INCONS_VALUE
operator|)
return|;
name|ctx
operator|->
name|scratch
operator|->
name|int1
operator|=
name|RowStatus_destroy
expr_stmt|;
if|if
condition|(
name|bridge_name_index_get
argument_list|(
operator|&
name|val
operator|->
name|var
argument_list|,
name|sub
argument_list|,
name|bif_name
argument_list|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_BADVALUE
operator|)
return|;
if|if
condition|(
name|bridge_if_create
argument_list|(
name|bif_name
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
name|SNMP_ERR_GENERR
operator|)
return|;
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
case|case
name|RowStatus_createAndWait
case|:
if|if
condition|(
name|bif
operator|!=
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_INCONS_VALUE
operator|)
return|;
if|if
condition|(
name|bridge_name_index_get
argument_list|(
operator|&
name|val
operator|->
name|var
argument_list|,
name|sub
argument_list|,
name|bif_name
argument_list|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_BADVALUE
operator|)
return|;
name|ctx
operator|->
name|scratch
operator|->
name|int1
operator|=
name|RowStatus_destroy
expr_stmt|;
if|if
condition|(
name|bridge_if_create
argument_list|(
name|bif_name
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
name|SNMP_ERR_GENERR
operator|)
return|;
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
case|case
name|RowStatus_destroy
case|:
if|if
condition|(
name|bif
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
name|ctx
operator|->
name|scratch
operator|->
name|int1
operator|=
name|bif
operator|->
name|if_status
expr_stmt|;
name|bif
operator|->
name|if_status
operator|=
name|RowStatus_destroy
expr_stmt|;
block|}
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bridge_rollback_if_status
parameter_list|(
name|struct
name|snmp_context
modifier|*
name|ctx
parameter_list|,
name|struct
name|snmp_value
modifier|*
name|val
parameter_list|,
name|uint
name|sub
parameter_list|)
block|{
name|struct
name|bridge_if
modifier|*
name|bif
decl_stmt|;
if|if
condition|(
operator|(
name|bif
operator|=
name|bridge_if_index_get
argument_list|(
operator|&
name|val
operator|->
name|var
argument_list|,
name|sub
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_GENERR
operator|)
return|;
switch|switch
condition|(
name|ctx
operator|->
name|scratch
operator|->
name|int1
condition|)
block|{
case|case
name|RowStatus_destroy
case|:
name|bridge_if_destroy
argument_list|(
name|bif
argument_list|)
expr_stmt|;
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
case|case
name|RowStatus_notInService
case|:
if|if
condition|(
name|bif
operator|->
name|if_status
operator|!=
name|ctx
operator|->
name|scratch
operator|->
name|int1
condition|)
name|bridge_set_if_up
argument_list|(
name|bif
operator|->
name|bif_name
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bif
operator|->
name|if_status
operator|=
name|RowStatus_notInService
expr_stmt|;
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
case|case
name|RowStatus_active
case|:
if|if
condition|(
name|bif
operator|->
name|if_status
operator|!=
name|ctx
operator|->
name|scratch
operator|->
name|int1
condition|)
name|bridge_set_if_up
argument_list|(
name|bif
operator|->
name|bif_name
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|bif
operator|->
name|if_status
operator|=
name|RowStatus_active
expr_stmt|;
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
block|}
name|abort
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|bridge_commit_if_status
parameter_list|(
name|struct
name|snmp_value
modifier|*
name|val
parameter_list|,
name|uint
name|sub
parameter_list|)
block|{
name|struct
name|bridge_if
modifier|*
name|bif
decl_stmt|;
if|if
condition|(
operator|(
name|bif
operator|=
name|bridge_if_index_get
argument_list|(
operator|&
name|val
operator|->
name|var
argument_list|,
name|sub
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_GENERR
operator|)
return|;
if|if
condition|(
name|bif
operator|->
name|if_status
operator|==
name|RowStatus_destroy
operator|&&
name|bridge_if_destroy
argument_list|(
name|bif
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
name|SNMP_ERR_COMMIT_FAILED
operator|)
return|;
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
block|}
end_function

begin_function
name|int
name|op_begemot_base_bridge
parameter_list|(
name|struct
name|snmp_context
modifier|*
name|ctx
parameter_list|,
name|struct
name|snmp_value
modifier|*
name|val
parameter_list|,
name|uint
name|sub
parameter_list|,
name|uint
name|iidx
name|__unused
parameter_list|,
name|enum
name|snmp_op
name|op
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|struct
name|bridge_if
modifier|*
name|bif
decl_stmt|;
if|if
condition|(
name|time
argument_list|(
name|NULL
argument_list|)
operator|-
name|bridge_list_age
operator|>
name|bridge_get_data_maxage
argument_list|()
condition|)
name|bridge_update_all_ifs
argument_list|()
expr_stmt|;
switch|switch
condition|(
name|op
condition|)
block|{
case|case
name|SNMP_OP_GET
case|:
if|if
condition|(
operator|(
name|bif
operator|=
name|bridge_if_index_get
argument_list|(
operator|&
name|val
operator|->
name|var
argument_list|,
name|sub
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
break|break;
case|case
name|SNMP_OP_GETNEXT
case|:
if|if
condition|(
operator|(
name|bif
operator|=
name|bridge_if_index_getnext
argument_list|(
operator|&
name|val
operator|->
name|var
argument_list|,
name|sub
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
name|bridge_if_index_append
argument_list|(
operator|&
name|val
operator|->
name|var
argument_list|,
name|sub
argument_list|,
name|bif
argument_list|)
expr_stmt|;
break|break;
case|case
name|SNMP_OP_SET
case|:
switch|switch
condition|(
name|val
operator|->
name|var
operator|.
name|subs
index|[
name|sub
operator|-
literal|1
index|]
condition|)
block|{
case|case
name|LEAF_begemotBridgeBaseStatus
case|:
return|return
operator|(
name|bridge_set_if_status
argument_list|(
name|ctx
argument_list|,
name|val
argument_list|,
name|sub
argument_list|)
operator|)
return|;
case|case
name|LEAF_begemotBridgeBaseName
case|:
case|case
name|LEAF_begemotBridgeBaseAddress
case|:
case|case
name|LEAF_begemotBridgeBaseNumPorts
case|:
case|case
name|LEAF_begemotBridgeBaseType
case|:
return|return
operator|(
name|SNMP_ERR_NOT_WRITEABLE
operator|)
return|;
block|}
name|abort
argument_list|()
expr_stmt|;
case|case
name|SNMP_OP_ROLLBACK
case|:
return|return
operator|(
name|bridge_rollback_if_status
argument_list|(
name|ctx
argument_list|,
name|val
argument_list|,
name|sub
argument_list|)
operator|)
return|;
case|case
name|SNMP_OP_COMMIT
case|:
return|return
operator|(
name|bridge_commit_if_status
argument_list|(
name|val
argument_list|,
name|sub
argument_list|)
operator|)
return|;
default|default:
name|abort
argument_list|()
expr_stmt|;
block|}
name|ret
operator|=
name|SNMP_ERR_NOERROR
expr_stmt|;
switch|switch
condition|(
name|val
operator|->
name|var
operator|.
name|subs
index|[
name|sub
operator|-
literal|1
index|]
condition|)
block|{
case|case
name|LEAF_begemotBridgeBaseName
case|:
name|ret
operator|=
name|string_get
argument_list|(
name|val
argument_list|,
name|bif
operator|->
name|bif_name
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|LEAF_begemotBridgeBaseAddress
case|:
name|ret
operator|=
name|string_get
argument_list|(
name|val
argument_list|,
name|bif
operator|->
name|br_addr
operator|.
name|octet
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
break|break;
case|case
name|LEAF_begemotBridgeBaseNumPorts
case|:
name|val
operator|->
name|v
operator|.
name|integer
operator|=
name|bif
operator|->
name|num_ports
expr_stmt|;
break|break;
case|case
name|LEAF_begemotBridgeBaseType
case|:
name|val
operator|->
name|v
operator|.
name|integer
operator|=
name|bif
operator|->
name|br_type
expr_stmt|;
break|break;
case|case
name|LEAF_begemotBridgeBaseStatus
case|:
name|val
operator|->
name|v
operator|.
name|integer
operator|=
name|bif
operator|->
name|if_status
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
name|int
name|op_begemot_stp
parameter_list|(
name|struct
name|snmp_context
modifier|*
name|ctx
parameter_list|,
name|struct
name|snmp_value
modifier|*
name|val
parameter_list|,
name|uint
name|sub
parameter_list|,
name|uint
name|iidx
name|__unused
parameter_list|,
name|enum
name|snmp_op
name|op
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|struct
name|bridge_if
modifier|*
name|bif
decl_stmt|;
if|if
condition|(
name|time
argument_list|(
name|NULL
argument_list|)
operator|-
name|bridge_list_age
operator|>
name|bridge_get_data_maxage
argument_list|()
condition|)
name|bridge_update_all_ifs
argument_list|()
expr_stmt|;
switch|switch
condition|(
name|op
condition|)
block|{
case|case
name|SNMP_OP_GET
case|:
if|if
condition|(
operator|(
name|bif
operator|=
name|bridge_if_index_get
argument_list|(
operator|&
name|val
operator|->
name|var
argument_list|,
name|sub
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
break|break;
case|case
name|SNMP_OP_GETNEXT
case|:
if|if
condition|(
operator|(
name|bif
operator|=
name|bridge_if_index_getnext
argument_list|(
operator|&
name|val
operator|->
name|var
argument_list|,
name|sub
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
name|bridge_if_index_append
argument_list|(
operator|&
name|val
operator|->
name|var
argument_list|,
name|sub
argument_list|,
name|bif
argument_list|)
expr_stmt|;
break|break;
case|case
name|SNMP_OP_SET
case|:
if|if
condition|(
operator|(
name|bif
operator|=
name|bridge_if_index_get
argument_list|(
operator|&
name|val
operator|->
name|var
argument_list|,
name|sub
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
switch|switch
condition|(
name|val
operator|->
name|var
operator|.
name|subs
index|[
name|sub
operator|-
literal|1
index|]
condition|)
block|{
case|case
name|LEAF_begemotBridgeStpPriority
case|:
name|ctx
operator|->
name|scratch
operator|->
name|int1
operator|=
name|bif
operator|->
name|priority
expr_stmt|;
name|ret
operator|=
name|bridge_set_priority
argument_list|(
name|bif
argument_list|,
name|val
operator|->
name|v
operator|.
name|integer
argument_list|)
expr_stmt|;
break|break;
case|case
name|LEAF_begemotBridgeStpBridgeMaxAge
case|:
name|ctx
operator|->
name|scratch
operator|->
name|int1
operator|=
name|bif
operator|->
name|bridge_max_age
expr_stmt|;
name|ret
operator|=
name|bridge_set_maxage
argument_list|(
name|bif
argument_list|,
name|val
operator|->
name|v
operator|.
name|integer
argument_list|)
expr_stmt|;
break|break;
case|case
name|LEAF_begemotBridgeStpBridgeHelloTime
case|:
name|ctx
operator|->
name|scratch
operator|->
name|int1
operator|=
name|bif
operator|->
name|bridge_hello_time
expr_stmt|;
name|ret
operator|=
name|bridge_set_hello_time
argument_list|(
name|bif
argument_list|,
name|val
operator|->
name|v
operator|.
name|integer
argument_list|)
expr_stmt|;
break|break;
case|case
name|LEAF_begemotBridgeStpBridgeForwardDelay
case|:
name|ctx
operator|->
name|scratch
operator|->
name|int1
operator|=
name|bif
operator|->
name|bridge_fwd_delay
expr_stmt|;
name|ret
operator|=
name|bridge_set_forward_delay
argument_list|(
name|bif
argument_list|,
name|val
operator|->
name|v
operator|.
name|integer
argument_list|)
expr_stmt|;
break|break;
case|case
name|LEAF_begemotBridgeStpVersion
case|:
name|ctx
operator|->
name|scratch
operator|->
name|int1
operator|=
name|bif
operator|->
name|stp_version
expr_stmt|;
name|ret
operator|=
name|bridge_set_stp_version
argument_list|(
name|bif
argument_list|,
name|val
operator|->
name|v
operator|.
name|integer
argument_list|)
expr_stmt|;
break|break;
case|case
name|LEAF_begemotBridgeStpTxHoldCount
case|:
name|ctx
operator|->
name|scratch
operator|->
name|int1
operator|=
name|bif
operator|->
name|tx_hold_count
expr_stmt|;
name|ret
operator|=
name|bridge_set_tx_hold_count
argument_list|(
name|bif
argument_list|,
name|val
operator|->
name|v
operator|.
name|integer
argument_list|)
expr_stmt|;
break|break;
case|case
name|LEAF_begemotBridgeStpProtocolSpecification
case|:
case|case
name|LEAF_begemotBridgeStpTimeSinceTopologyChange
case|:
case|case
name|LEAF_begemotBridgeStpTopChanges
case|:
case|case
name|LEAF_begemotBridgeStpDesignatedRoot
case|:
case|case
name|LEAF_begemotBridgeStpRootCost
case|:
case|case
name|LEAF_begemotBridgeStpRootPort
case|:
case|case
name|LEAF_begemotBridgeStpMaxAge
case|:
case|case
name|LEAF_begemotBridgeStpHelloTime
case|:
case|case
name|LEAF_begemotBridgeStpHoldTime
case|:
case|case
name|LEAF_begemotBridgeStpForwardDelay
case|:
return|return
operator|(
name|SNMP_ERR_NOT_WRITEABLE
operator|)
return|;
default|default:
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
block|}
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
elseif|else
if|if
condition|(
name|ret
operator|==
operator|-
literal|2
condition|)
return|return
operator|(
name|SNMP_ERR_WRONG_VALUE
operator|)
return|;
return|return
operator|(
name|SNMP_ERR_GENERR
operator|)
return|;
case|case
name|SNMP_OP_ROLLBACK
case|:
if|if
condition|(
operator|(
name|bif
operator|=
name|bridge_if_index_get
argument_list|(
operator|&
name|val
operator|->
name|var
argument_list|,
name|sub
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
switch|switch
condition|(
name|val
operator|->
name|var
operator|.
name|subs
index|[
name|sub
operator|-
literal|1
index|]
condition|)
block|{
case|case
name|LEAF_begemotBridgeStpPriority
case|:
name|bridge_set_priority
argument_list|(
name|bif
argument_list|,
name|ctx
operator|->
name|scratch
operator|->
name|int1
argument_list|)
expr_stmt|;
break|break;
case|case
name|LEAF_begemotBridgeStpBridgeMaxAge
case|:
name|bridge_set_maxage
argument_list|(
name|bif
argument_list|,
name|ctx
operator|->
name|scratch
operator|->
name|int1
argument_list|)
expr_stmt|;
break|break;
case|case
name|LEAF_begemotBridgeStpBridgeHelloTime
case|:
name|bridge_set_hello_time
argument_list|(
name|bif
argument_list|,
name|ctx
operator|->
name|scratch
operator|->
name|int1
argument_list|)
expr_stmt|;
break|break;
case|case
name|LEAF_begemotBridgeStpBridgeForwardDelay
case|:
name|bridge_set_forward_delay
argument_list|(
name|bif
argument_list|,
name|ctx
operator|->
name|scratch
operator|->
name|int1
argument_list|)
expr_stmt|;
break|break;
case|case
name|LEAF_begemotBridgeStpVersion
case|:
name|bridge_set_stp_version
argument_list|(
name|bif
argument_list|,
name|ctx
operator|->
name|scratch
operator|->
name|int1
argument_list|)
expr_stmt|;
break|break;
case|case
name|LEAF_begemotBridgeStpTxHoldCount
case|:
name|bridge_set_tx_hold_count
argument_list|(
name|bif
argument_list|,
name|ctx
operator|->
name|scratch
operator|->
name|int1
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
case|case
name|SNMP_OP_COMMIT
case|:
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
default|default:
name|abort
argument_list|()
expr_stmt|;
block|}
name|ret
operator|=
name|SNMP_ERR_NOERROR
expr_stmt|;
switch|switch
condition|(
name|val
operator|->
name|var
operator|.
name|subs
index|[
name|sub
operator|-
literal|1
index|]
condition|)
block|{
case|case
name|LEAF_begemotBridgeStpProtocolSpecification
case|:
name|val
operator|->
name|v
operator|.
name|integer
operator|=
name|bif
operator|->
name|prot_spec
expr_stmt|;
break|break;
case|case
name|LEAF_begemotBridgeStpPriority
case|:
name|val
operator|->
name|v
operator|.
name|integer
operator|=
name|bif
operator|->
name|priority
expr_stmt|;
break|break;
case|case
name|LEAF_begemotBridgeStpTimeSinceTopologyChange
case|:
if|if
condition|(
name|bridge_get_time_since_tc
argument_list|(
name|bif
argument_list|,
operator|&
operator|(
name|val
operator|->
name|v
operator|.
name|uint32
operator|)
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
name|SNMP_ERR_GENERR
operator|)
return|;
break|break;
case|case
name|LEAF_begemotBridgeStpTopChanges
case|:
name|val
operator|->
name|v
operator|.
name|uint32
operator|=
name|bif
operator|->
name|top_changes
expr_stmt|;
break|break;
case|case
name|LEAF_begemotBridgeStpDesignatedRoot
case|:
name|ret
operator|=
name|string_get
argument_list|(
name|val
argument_list|,
name|bif
operator|->
name|design_root
argument_list|,
name|SNMP_BRIDGE_ID_LEN
argument_list|)
expr_stmt|;
break|break;
case|case
name|LEAF_begemotBridgeStpRootCost
case|:
name|val
operator|->
name|v
operator|.
name|integer
operator|=
name|bif
operator|->
name|root_cost
expr_stmt|;
break|break;
case|case
name|LEAF_begemotBridgeStpRootPort
case|:
name|val
operator|->
name|v
operator|.
name|integer
operator|=
name|bif
operator|->
name|root_port
expr_stmt|;
break|break;
case|case
name|LEAF_begemotBridgeStpMaxAge
case|:
name|val
operator|->
name|v
operator|.
name|integer
operator|=
name|bif
operator|->
name|max_age
expr_stmt|;
break|break;
case|case
name|LEAF_begemotBridgeStpHelloTime
case|:
name|val
operator|->
name|v
operator|.
name|integer
operator|=
name|bif
operator|->
name|hello_time
expr_stmt|;
break|break;
case|case
name|LEAF_begemotBridgeStpHoldTime
case|:
name|val
operator|->
name|v
operator|.
name|integer
operator|=
name|bif
operator|->
name|hold_time
expr_stmt|;
break|break;
case|case
name|LEAF_begemotBridgeStpForwardDelay
case|:
name|val
operator|->
name|v
operator|.
name|integer
operator|=
name|bif
operator|->
name|fwd_delay
expr_stmt|;
break|break;
case|case
name|LEAF_begemotBridgeStpBridgeMaxAge
case|:
name|val
operator|->
name|v
operator|.
name|integer
operator|=
name|bif
operator|->
name|bridge_max_age
expr_stmt|;
break|break;
case|case
name|LEAF_begemotBridgeStpBridgeHelloTime
case|:
name|val
operator|->
name|v
operator|.
name|integer
operator|=
name|bif
operator|->
name|bridge_hello_time
expr_stmt|;
break|break;
case|case
name|LEAF_begemotBridgeStpBridgeForwardDelay
case|:
name|val
operator|->
name|v
operator|.
name|integer
operator|=
name|bif
operator|->
name|bridge_fwd_delay
expr_stmt|;
break|break;
case|case
name|LEAF_begemotBridgeStpVersion
case|:
name|val
operator|->
name|v
operator|.
name|integer
operator|=
name|bif
operator|->
name|stp_version
expr_stmt|;
break|break;
case|case
name|LEAF_begemotBridgeStpTxHoldCount
case|:
name|val
operator|->
name|v
operator|.
name|integer
operator|=
name|bif
operator|->
name|tx_hold_count
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
name|int
name|op_begemot_tp
parameter_list|(
name|struct
name|snmp_context
modifier|*
name|ctx
parameter_list|,
name|struct
name|snmp_value
modifier|*
name|val
parameter_list|,
name|uint
name|sub
parameter_list|,
name|uint
name|iidx
name|__unused
parameter_list|,
name|enum
name|snmp_op
name|op
parameter_list|)
block|{
name|struct
name|bridge_if
modifier|*
name|bif
decl_stmt|;
if|if
condition|(
name|time
argument_list|(
name|NULL
argument_list|)
operator|-
name|bridge_list_age
operator|>
name|bridge_get_data_maxage
argument_list|()
condition|)
name|bridge_update_all_ifs
argument_list|()
expr_stmt|;
switch|switch
condition|(
name|op
condition|)
block|{
case|case
name|SNMP_OP_GET
case|:
if|if
condition|(
operator|(
name|bif
operator|=
name|bridge_if_index_get
argument_list|(
operator|&
name|val
operator|->
name|var
argument_list|,
name|sub
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
break|break;
case|case
name|SNMP_OP_GETNEXT
case|:
if|if
condition|(
operator|(
name|bif
operator|=
name|bridge_if_index_getnext
argument_list|(
operator|&
name|val
operator|->
name|var
argument_list|,
name|sub
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
name|bridge_if_index_append
argument_list|(
operator|&
name|val
operator|->
name|var
argument_list|,
name|sub
argument_list|,
name|bif
argument_list|)
expr_stmt|;
break|break;
case|case
name|SNMP_OP_SET
case|:
if|if
condition|(
operator|(
name|bif
operator|=
name|bridge_if_index_get
argument_list|(
operator|&
name|val
operator|->
name|var
argument_list|,
name|sub
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
switch|switch
condition|(
name|val
operator|->
name|var
operator|.
name|subs
index|[
name|sub
operator|-
literal|1
index|]
condition|)
block|{
case|case
name|LEAF_begemotBridgeTpAgingTime
case|:
name|ctx
operator|->
name|scratch
operator|->
name|int1
operator|=
name|bif
operator|->
name|age_time
expr_stmt|;
if|if
condition|(
name|bridge_set_aging_time
argument_list|(
name|bif
argument_list|,
name|val
operator|->
name|v
operator|.
name|integer
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
name|SNMP_ERR_GENERR
operator|)
return|;
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
case|case
name|LEAF_begemotBridgeTpMaxAddresses
case|:
name|ctx
operator|->
name|scratch
operator|->
name|int1
operator|=
name|bif
operator|->
name|max_addrs
expr_stmt|;
if|if
condition|(
name|bridge_set_max_cache
argument_list|(
name|bif
argument_list|,
name|val
operator|->
name|v
operator|.
name|integer
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
name|SNMP_ERR_GENERR
operator|)
return|;
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
case|case
name|LEAF_begemotBridgeTpLearnedEntryDiscards
case|:
return|return
operator|(
name|SNMP_ERR_NOT_WRITEABLE
operator|)
return|;
block|}
name|abort
argument_list|()
expr_stmt|;
case|case
name|SNMP_OP_ROLLBACK
case|:
if|if
condition|(
operator|(
name|bif
operator|=
name|bridge_if_index_get
argument_list|(
operator|&
name|val
operator|->
name|var
argument_list|,
name|sub
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_GENERR
operator|)
return|;
switch|switch
condition|(
name|val
operator|->
name|var
operator|.
name|subs
index|[
name|sub
operator|-
literal|1
index|]
condition|)
block|{
case|case
name|LEAF_begemotBridgeTpAgingTime
case|:
name|bridge_set_aging_time
argument_list|(
name|bif
argument_list|,
name|ctx
operator|->
name|scratch
operator|->
name|int1
argument_list|)
expr_stmt|;
break|break;
case|case
name|LEAF_begemotBridgeTpMaxAddresses
case|:
name|bridge_set_max_cache
argument_list|(
name|bif
argument_list|,
name|ctx
operator|->
name|scratch
operator|->
name|int1
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
case|case
name|SNMP_OP_COMMIT
case|:
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
default|default:
name|abort
argument_list|()
expr_stmt|;
block|}
switch|switch
condition|(
name|val
operator|->
name|var
operator|.
name|subs
index|[
name|sub
operator|-
literal|1
index|]
condition|)
block|{
case|case
name|LEAF_begemotBridgeTpLearnedEntryDiscards
case|:
name|val
operator|->
name|v
operator|.
name|uint32
operator|=
name|bif
operator|->
name|lrnt_drops
expr_stmt|;
break|break;
case|case
name|LEAF_begemotBridgeTpAgingTime
case|:
name|val
operator|->
name|v
operator|.
name|integer
operator|=
name|bif
operator|->
name|age_time
expr_stmt|;
break|break;
case|case
name|LEAF_begemotBridgeTpMaxAddresses
case|:
name|val
operator|->
name|v
operator|.
name|integer
operator|=
name|bif
operator|->
name|max_addrs
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
block|}
end_function

end_unit


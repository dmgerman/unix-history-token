begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2006 Shteryana Shopova<syrinx@FreeBSD.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * Bridge MIB implementation for SNMPd.  * Bridge OS specific ioctls.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/linker.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_if
if|#
directive|if
name|__FreeBSD_version
operator|>
literal|700018
end_if

begin_include
include|#
directive|include
file|<net/bridgestp.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<net/ethernet.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_bridgevar.h>
end_include

begin_include
include|#
directive|include
file|<net/if_dl.h>
end_include

begin_include
include|#
directive|include
file|<net/if_mib.h>
end_include

begin_include
include|#
directive|include
file|<net/if_types.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<ifaddrs.h>
end_include

begin_include
include|#
directive|include
file|<stdarg.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<syslog.h>
end_include

begin_include
include|#
directive|include
file|<bsnmp/snmpmod.h>
end_include

begin_include
include|#
directive|include
file|<bsnmp/snmp_mibII.h>
end_include

begin_include
include|#
directive|include
file|"bridge_tree.h"
end_include

begin_include
include|#
directive|include
file|"bridge_snmp.h"
end_include

begin_decl_stmt
name|int
name|sock
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|bridge_ioctl_init
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
operator|(
name|sock
operator|=
name|socket
argument_list|(
name|PF_INET
argument_list|,
name|SOCK_DGRAM
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"cannot open socket : %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Load the if_bridge.ko module in kernel if not already there.  */
end_comment

begin_function
name|int
name|bridge_kmod_load
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|fileid
decl_stmt|,
name|modid
decl_stmt|;
specifier|const
name|char
name|mod_name
index|[]
init|=
literal|"if_bridge"
decl_stmt|;
name|struct
name|module_stat
name|mstat
decl_stmt|;
comment|/* Scan files in kernel. */
name|mstat
operator|.
name|version
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|module_stat
argument_list|)
expr_stmt|;
for|for
control|(
name|fileid
operator|=
name|kldnext
argument_list|(
literal|0
argument_list|)
init|;
name|fileid
operator|>
literal|0
condition|;
name|fileid
operator|=
name|kldnext
argument_list|(
name|fileid
argument_list|)
control|)
block|{
comment|/* Scan modules in file. */
for|for
control|(
name|modid
operator|=
name|kldfirstmod
argument_list|(
name|fileid
argument_list|)
init|;
name|modid
operator|>
literal|0
condition|;
name|modid
operator|=
name|modfnext
argument_list|(
name|modid
argument_list|)
control|)
block|{
if|if
condition|(
name|modstat
argument_list|(
name|modid
argument_list|,
operator|&
name|mstat
argument_list|)
operator|<
literal|0
condition|)
continue|continue;
if|if
condition|(
name|strcmp
argument_list|(
name|mod_name
argument_list|,
name|mstat
operator|.
name|name
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
comment|/* Not present - load it. */
if|if
condition|(
name|kldload
argument_list|(
name|mod_name
argument_list|)
operator|<
literal|0
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"failed to load %s kernel module"
argument_list|,
name|mod_name
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/************************************************************************  * Bridge interfaces.  */
end_comment

begin_comment
comment|/*  * Convert the kernel uint64_t value for a bridge id  */
end_comment

begin_function
specifier|static
name|void
name|snmp_uint64_to_bridgeid
parameter_list|(
name|uint64_t
name|id
parameter_list|,
name|bridge_id
name|b_id
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|u_char
modifier|*
name|o
decl_stmt|;
name|o
operator|=
operator|(
name|u_char
operator|*
operator|)
operator|&
name|id
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SNMP_BRIDGE_ID_LEN
condition|;
name|i
operator|++
operator|,
name|o
operator|++
control|)
name|b_id
index|[
name|SNMP_BRIDGE_ID_LEN
operator|-
name|i
operator|-
literal|1
index|]
operator|=
operator|*
name|o
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Fetch the bridge configuration parameters from the kernel excluding  * it's base MAC address.  */
end_comment

begin_function
specifier|static
name|int
name|bridge_get_conf_param
parameter_list|(
name|struct
name|bridge_if
modifier|*
name|bif
parameter_list|)
block|{
name|struct
name|ifdrv
name|ifd
decl_stmt|;
name|struct
name|ifbrparam
name|b_param
decl_stmt|;
name|strlcpy
argument_list|(
name|ifd
operator|.
name|ifd_name
argument_list|,
name|bif
operator|->
name|bif_name
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
name|ifd
operator|.
name|ifd_len
operator|=
sizeof|sizeof
argument_list|(
name|b_param
argument_list|)
expr_stmt|;
name|ifd
operator|.
name|ifd_data
operator|=
operator|&
name|b_param
expr_stmt|;
comment|/* Bridge priority. */
name|ifd
operator|.
name|ifd_cmd
operator|=
name|BRDGGPRI
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|sock
argument_list|,
name|SIOCGDRVSPEC
argument_list|,
operator|&
name|ifd
argument_list|)
operator|<
literal|0
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"update bridge: ioctl(BRDGGPRI) failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|bif
operator|->
name|priority
operator|=
name|b_param
operator|.
name|ifbrp_prio
expr_stmt|;
comment|/* Configured max age. */
name|ifd
operator|.
name|ifd_cmd
operator|=
name|BRDGGMA
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|sock
argument_list|,
name|SIOCGDRVSPEC
argument_list|,
operator|&
name|ifd
argument_list|)
operator|<
literal|0
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"update bridge: ioctl(BRDGGMA) failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* Centi-seconds. */
name|bif
operator|->
name|bridge_max_age
operator|=
literal|100
operator|*
name|b_param
operator|.
name|ifbrp_maxage
expr_stmt|;
comment|/* Configured hello time. */
name|ifd
operator|.
name|ifd_cmd
operator|=
name|BRDGGHT
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|sock
argument_list|,
name|SIOCGDRVSPEC
argument_list|,
operator|&
name|ifd
argument_list|)
operator|<
literal|0
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"update bridge: ioctl(BRDGGHT) failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|bif
operator|->
name|bridge_hello_time
operator|=
literal|100
operator|*
name|b_param
operator|.
name|ifbrp_hellotime
expr_stmt|;
comment|/* Forward delay. */
name|ifd
operator|.
name|ifd_cmd
operator|=
name|BRDGGFD
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|sock
argument_list|,
name|SIOCGDRVSPEC
argument_list|,
operator|&
name|ifd
argument_list|)
operator|<
literal|0
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"update bridge: ioctl(BRDGGFD) failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|bif
operator|->
name|bridge_fwd_delay
operator|=
literal|100
operator|*
name|b_param
operator|.
name|ifbrp_fwddelay
expr_stmt|;
comment|/* Number of dropped addresses. */
name|ifd
operator|.
name|ifd_cmd
operator|=
name|BRDGGRTE
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|sock
argument_list|,
name|SIOCGDRVSPEC
argument_list|,
operator|&
name|ifd
argument_list|)
operator|<
literal|0
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"update bridge: ioctl(BRDGGRTE) failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|bif
operator|->
name|lrnt_drops
operator|=
name|b_param
operator|.
name|ifbrp_cexceeded
expr_stmt|;
comment|/* Address table timeout. */
name|ifd
operator|.
name|ifd_cmd
operator|=
name|BRDGGTO
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|sock
argument_list|,
name|SIOCGDRVSPEC
argument_list|,
operator|&
name|ifd
argument_list|)
operator|<
literal|0
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"update bridge: ioctl(BRDGGTO) failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|bif
operator|->
name|age_time
operator|=
name|b_param
operator|.
name|ifbrp_ctime
expr_stmt|;
comment|/* Address table size. */
name|ifd
operator|.
name|ifd_cmd
operator|=
name|BRDGGCACHE
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|sock
argument_list|,
name|SIOCGDRVSPEC
argument_list|,
operator|&
name|ifd
argument_list|)
operator|<
literal|0
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"update bridge: ioctl(BRDGGCACHE) "
literal|"failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|bif
operator|->
name|max_addrs
operator|=
name|b_param
operator|.
name|ifbrp_csize
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Fetch the current bridge STP operational parameters.  * Returns: -1 - on error;  *	     0 - old TC time and Root Port values are same;  *	     1 - topologyChange notification should be sent;  *	     2 - newRoot notification should be sent.  */
end_comment

begin_function
name|int
name|bridge_get_op_param
parameter_list|(
name|struct
name|bridge_if
modifier|*
name|bif
parameter_list|)
block|{
name|int
name|new_root_send
decl_stmt|;
name|struct
name|ifdrv
name|ifd
decl_stmt|;
name|struct
name|ifbropreq
name|b_req
decl_stmt|;
name|strlcpy
argument_list|(
name|ifd
operator|.
name|ifd_name
argument_list|,
name|bif
operator|->
name|bif_name
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
name|ifd
operator|.
name|ifd_len
operator|=
sizeof|sizeof
argument_list|(
name|b_req
argument_list|)
expr_stmt|;
name|ifd
operator|.
name|ifd_data
operator|=
operator|&
name|b_req
expr_stmt|;
name|ifd
operator|.
name|ifd_cmd
operator|=
name|BRDGPARAM
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|sock
argument_list|,
name|SIOCGDRVSPEC
argument_list|,
operator|&
name|ifd
argument_list|)
operator|<
literal|0
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"update bridge: ioctl(BRDGPARAM) failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|bif
operator|->
name|max_age
operator|=
literal|100
operator|*
name|b_req
operator|.
name|ifbop_maxage
expr_stmt|;
name|bif
operator|->
name|hello_time
operator|=
literal|100
operator|*
name|b_req
operator|.
name|ifbop_hellotime
expr_stmt|;
name|bif
operator|->
name|fwd_delay
operator|=
literal|100
operator|*
name|b_req
operator|.
name|ifbop_fwddelay
expr_stmt|;
if|#
directive|if
name|__FreeBSD_version
operator|>
literal|700024
name|bif
operator|->
name|stp_version
operator|=
name|b_req
operator|.
name|ifbop_protocol
expr_stmt|;
name|bif
operator|->
name|tx_hold_count
operator|=
name|b_req
operator|.
name|ifbop_holdcount
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|b_req
operator|.
name|ifbop_root_port
operator|==
literal|0
operator|&&
name|bif
operator|->
name|root_port
operator|!=
name|b_req
operator|.
name|ifbop_root_port
condition|)
name|new_root_send
operator|=
literal|2
expr_stmt|;
else|else
name|new_root_send
operator|=
literal|0
expr_stmt|;
name|bif
operator|->
name|root_port
operator|=
name|b_req
operator|.
name|ifbop_root_port
expr_stmt|;
name|bif
operator|->
name|root_cost
operator|=
name|b_req
operator|.
name|ifbop_root_path_cost
expr_stmt|;
name|snmp_uint64_to_bridgeid
argument_list|(
name|b_req
operator|.
name|ifbop_designated_root
argument_list|,
name|bif
operator|->
name|design_root
argument_list|)
expr_stmt|;
if|if
condition|(
name|bif
operator|->
name|last_tc_time
operator|.
name|tv_sec
operator|!=
name|b_req
operator|.
name|ifbop_last_tc_time
operator|.
name|tv_sec
condition|)
block|{
name|bif
operator|->
name|top_changes
operator|++
expr_stmt|;
name|bif
operator|->
name|last_tc_time
operator|.
name|tv_sec
operator|=
name|b_req
operator|.
name|ifbop_last_tc_time
operator|.
name|tv_sec
expr_stmt|;
name|bif
operator|->
name|last_tc_time
operator|.
name|tv_usec
operator|=
name|b_req
operator|.
name|ifbop_last_tc_time
operator|.
name|tv_usec
expr_stmt|;
comment|/* 		 * "The trap is not sent if a (begemotBridge)NewRoot 		 * trap is sent for the same transition." 		 */
if|if
condition|(
name|new_root_send
operator|==
literal|0
condition|)
return|return
operator|(
literal|1
operator|)
return|;
block|}
return|return
operator|(
name|new_root_send
operator|)
return|;
block|}
end_function

begin_function
name|int
name|bridge_getinfo_bif
parameter_list|(
name|struct
name|bridge_if
modifier|*
name|bif
parameter_list|)
block|{
if|if
condition|(
name|bridge_get_conf_param
argument_list|(
name|bif
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
return|return
operator|(
name|bridge_get_op_param
argument_list|(
name|bif
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|bridge_set_priority
parameter_list|(
name|struct
name|bridge_if
modifier|*
name|bif
parameter_list|,
name|int32_t
name|priority
parameter_list|)
block|{
name|struct
name|ifdrv
name|ifd
decl_stmt|;
name|struct
name|ifbrparam
name|b_param
decl_stmt|;
name|strlcpy
argument_list|(
name|ifd
operator|.
name|ifd_name
argument_list|,
name|bif
operator|->
name|bif_name
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
name|ifd
operator|.
name|ifd_len
operator|=
sizeof|sizeof
argument_list|(
name|b_param
argument_list|)
expr_stmt|;
name|ifd
operator|.
name|ifd_data
operator|=
operator|&
name|b_param
expr_stmt|;
name|b_param
operator|.
name|ifbrp_prio
operator|=
operator|(
name|uint32_t
operator|)
name|priority
expr_stmt|;
name|ifd
operator|.
name|ifd_cmd
operator|=
name|BRDGSPRI
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|sock
argument_list|,
name|SIOCSDRVSPEC
argument_list|,
operator|&
name|ifd
argument_list|)
operator|<
literal|0
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"set bridge param: ioctl(BRDGSPRI) "
literal|"failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* 	 * Re-fetching the data from the driver after that might be a good 	 * idea, since changing our bridge's priority should invoke  	 * recalculation of the active spanning tree topology in the network. 	 */
name|bif
operator|->
name|priority
operator|=
name|priority
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Convert 1/100 of seconds to 1/256 of seconds.  * Timeout ::= TEXTUAL-CONVENTION.  * To convert a Timeout value into a value in units of  * 1/256 seconds, the following algorithm should be used:  *	b = floor( (n * 256) / 100)  * The conversion to 1/256 of a second happens in the kernel -  * just make sure we correctly convert the seconds to Timout  * and vice versa.  */
end_comment

begin_function
specifier|static
name|uint32_t
name|snmp_timeout2_sec
parameter_list|(
name|int32_t
name|secs
parameter_list|)
block|{
return|return
operator|(
name|secs
operator|/
literal|100
operator|)
return|;
block|}
end_function

begin_function
name|int
name|bridge_set_maxage
parameter_list|(
name|struct
name|bridge_if
modifier|*
name|bif
parameter_list|,
name|int32_t
name|max_age
parameter_list|)
block|{
name|struct
name|ifdrv
name|ifd
decl_stmt|;
name|struct
name|ifbrparam
name|b_param
decl_stmt|;
name|strlcpy
argument_list|(
name|ifd
operator|.
name|ifd_name
argument_list|,
name|bif
operator|->
name|bif_name
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
name|ifd
operator|.
name|ifd_len
operator|=
sizeof|sizeof
argument_list|(
name|b_param
argument_list|)
expr_stmt|;
name|ifd
operator|.
name|ifd_data
operator|=
operator|&
name|b_param
expr_stmt|;
name|b_param
operator|.
name|ifbrp_maxage
operator|=
name|snmp_timeout2_sec
argument_list|(
name|max_age
argument_list|)
expr_stmt|;
name|ifd
operator|.
name|ifd_cmd
operator|=
name|BRDGSMA
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|sock
argument_list|,
name|SIOCSDRVSPEC
argument_list|,
operator|&
name|ifd
argument_list|)
operator|<
literal|0
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"set bridge param: ioctl(BRDGSMA) "
literal|"failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|bif
operator|->
name|bridge_max_age
operator|=
name|max_age
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|bridge_set_hello_time
parameter_list|(
name|struct
name|bridge_if
modifier|*
name|bif
parameter_list|,
name|int32_t
name|hello_time
parameter_list|)
block|{
name|struct
name|ifdrv
name|ifd
decl_stmt|;
name|struct
name|ifbrparam
name|b_param
decl_stmt|;
name|strlcpy
argument_list|(
name|ifd
operator|.
name|ifd_name
argument_list|,
name|bif
operator|->
name|bif_name
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
name|ifd
operator|.
name|ifd_len
operator|=
sizeof|sizeof
argument_list|(
name|b_param
argument_list|)
expr_stmt|;
name|ifd
operator|.
name|ifd_data
operator|=
operator|&
name|b_param
expr_stmt|;
name|b_param
operator|.
name|ifbrp_hellotime
operator|=
name|snmp_timeout2_sec
argument_list|(
name|hello_time
argument_list|)
expr_stmt|;
name|ifd
operator|.
name|ifd_cmd
operator|=
name|BRDGSHT
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|sock
argument_list|,
name|SIOCSDRVSPEC
argument_list|,
operator|&
name|ifd
argument_list|)
operator|<
literal|0
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"set bridge param: ioctl(BRDGSHT) "
literal|"failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|bif
operator|->
name|bridge_hello_time
operator|=
name|b_param
operator|.
name|ifbrp_hellotime
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|bridge_set_forward_delay
parameter_list|(
name|struct
name|bridge_if
modifier|*
name|bif
parameter_list|,
name|int32_t
name|fwd_delay
parameter_list|)
block|{
name|struct
name|ifdrv
name|ifd
decl_stmt|;
name|struct
name|ifbrparam
name|b_param
decl_stmt|;
name|strlcpy
argument_list|(
name|ifd
operator|.
name|ifd_name
argument_list|,
name|bif
operator|->
name|bif_name
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
name|ifd
operator|.
name|ifd_len
operator|=
sizeof|sizeof
argument_list|(
name|b_param
argument_list|)
expr_stmt|;
name|ifd
operator|.
name|ifd_data
operator|=
operator|&
name|b_param
expr_stmt|;
name|b_param
operator|.
name|ifbrp_fwddelay
operator|=
name|snmp_timeout2_sec
argument_list|(
name|fwd_delay
argument_list|)
expr_stmt|;
name|ifd
operator|.
name|ifd_cmd
operator|=
name|BRDGSFD
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|sock
argument_list|,
name|SIOCSDRVSPEC
argument_list|,
operator|&
name|ifd
argument_list|)
operator|<
literal|0
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"set bridge param: ioctl(BRDGSFD) "
literal|"failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|bif
operator|->
name|bridge_fwd_delay
operator|=
name|b_param
operator|.
name|ifbrp_fwddelay
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|bridge_set_aging_time
parameter_list|(
name|struct
name|bridge_if
modifier|*
name|bif
parameter_list|,
name|int32_t
name|age_time
parameter_list|)
block|{
name|struct
name|ifdrv
name|ifd
decl_stmt|;
name|struct
name|ifbrparam
name|b_param
decl_stmt|;
name|strlcpy
argument_list|(
name|ifd
operator|.
name|ifd_name
argument_list|,
name|bif
operator|->
name|bif_name
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
name|ifd
operator|.
name|ifd_len
operator|=
sizeof|sizeof
argument_list|(
name|b_param
argument_list|)
expr_stmt|;
name|ifd
operator|.
name|ifd_data
operator|=
operator|&
name|b_param
expr_stmt|;
name|b_param
operator|.
name|ifbrp_ctime
operator|=
operator|(
name|uint32_t
operator|)
name|age_time
expr_stmt|;
name|ifd
operator|.
name|ifd_cmd
operator|=
name|BRDGSTO
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|sock
argument_list|,
name|SIOCSDRVSPEC
argument_list|,
operator|&
name|ifd
argument_list|)
operator|<
literal|0
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"set bridge param: ioctl(BRDGSTO) "
literal|"failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|bif
operator|->
name|age_time
operator|=
name|age_time
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|bridge_set_max_cache
parameter_list|(
name|struct
name|bridge_if
modifier|*
name|bif
parameter_list|,
name|int32_t
name|max_cache
parameter_list|)
block|{
name|struct
name|ifdrv
name|ifd
decl_stmt|;
name|struct
name|ifbrparam
name|b_param
decl_stmt|;
name|strlcpy
argument_list|(
name|ifd
operator|.
name|ifd_name
argument_list|,
name|bif
operator|->
name|bif_name
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
name|ifd
operator|.
name|ifd_len
operator|=
sizeof|sizeof
argument_list|(
name|b_param
argument_list|)
expr_stmt|;
name|ifd
operator|.
name|ifd_data
operator|=
operator|&
name|b_param
expr_stmt|;
name|b_param
operator|.
name|ifbrp_csize
operator|=
name|max_cache
expr_stmt|;
name|ifd
operator|.
name|ifd_cmd
operator|=
name|BRDGSCACHE
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|sock
argument_list|,
name|SIOCSDRVSPEC
argument_list|,
operator|&
name|ifd
argument_list|)
operator|<
literal|0
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"set bridge param: ioctl(BRDGSCACHE) "
literal|"failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|bif
operator|->
name|max_addrs
operator|=
name|b_param
operator|.
name|ifbrp_csize
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|bridge_set_tx_hold_count
parameter_list|(
name|struct
name|bridge_if
modifier|*
name|bif
name|__unused
parameter_list|,
name|int32_t
name|tx_hc
name|__unused
parameter_list|)
block|{
if|#
directive|if
name|__FreeBSD_version
operator|>
literal|700024
name|struct
name|ifdrv
name|ifd
decl_stmt|;
name|struct
name|ifbrparam
name|b_param
decl_stmt|;
if|if
condition|(
name|tx_hc
operator|<
name|SNMP_BRIDGE_MIN_TXHC
operator|||
name|tx_hc
operator|>
name|SNMP_BRIDGE_MAX_TXHC
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|strlcpy
argument_list|(
name|ifd
operator|.
name|ifd_name
argument_list|,
name|bif
operator|->
name|bif_name
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
name|ifd
operator|.
name|ifd_len
operator|=
sizeof|sizeof
argument_list|(
name|b_param
argument_list|)
expr_stmt|;
name|ifd
operator|.
name|ifd_data
operator|=
operator|&
name|b_param
expr_stmt|;
name|b_param
operator|.
name|ifbrp_txhc
operator|=
name|tx_hc
expr_stmt|;
name|ifd
operator|.
name|ifd_cmd
operator|=
name|BRDGSTXHC
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|sock
argument_list|,
name|SIOCSDRVSPEC
argument_list|,
operator|&
name|ifd
argument_list|)
operator|<
literal|0
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"set bridge param: ioctl(BRDGSTXHC) "
literal|"failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|bif
operator|->
name|tx_hold_count
operator|=
name|b_param
operator|.
name|ifbrp_txhc
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
else|#
directive|else
return|return
operator|(
operator|-
literal|1
operator|)
return|;
endif|#
directive|endif
block|}
end_function

begin_function
name|int
name|bridge_set_stp_version
parameter_list|(
name|struct
name|bridge_if
modifier|*
name|bif
name|__unused
parameter_list|,
name|int32_t
name|stp_proto
name|__unused
parameter_list|)
block|{
if|#
directive|if
name|__FreeBSD_version
operator|>
literal|700024
name|struct
name|ifdrv
name|ifd
decl_stmt|;
name|struct
name|ifbrparam
name|b_param
decl_stmt|;
name|strlcpy
argument_list|(
name|ifd
operator|.
name|ifd_name
argument_list|,
name|bif
operator|->
name|bif_name
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
name|ifd
operator|.
name|ifd_len
operator|=
sizeof|sizeof
argument_list|(
name|b_param
argument_list|)
expr_stmt|;
name|ifd
operator|.
name|ifd_data
operator|=
operator|&
name|b_param
expr_stmt|;
name|b_param
operator|.
name|ifbrp_proto
operator|=
name|stp_proto
expr_stmt|;
name|ifd
operator|.
name|ifd_cmd
operator|=
name|BRDGSPROTO
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|sock
argument_list|,
name|SIOCSDRVSPEC
argument_list|,
operator|&
name|ifd
argument_list|)
operator|<
literal|0
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"set bridge param: ioctl(BRDGSPROTO) "
literal|"failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|bif
operator|->
name|stp_version
operator|=
name|b_param
operator|.
name|ifbrp_proto
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
else|#
directive|else
return|return
operator|(
operator|-
literal|1
operator|)
return|;
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/*  * Set the bridge interface status to up/down.  */
end_comment

begin_function
name|int
name|bridge_set_if_up
parameter_list|(
specifier|const
name|char
modifier|*
name|b_name
parameter_list|,
name|int8_t
name|up
parameter_list|)
block|{
name|int
name|flags
decl_stmt|;
name|struct
name|ifreq
name|ifr
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|ifr
argument_list|,
sizeof|sizeof
argument_list|(
name|ifr
argument_list|)
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|,
name|b_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|sock
argument_list|,
name|SIOCGIFFLAGS
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|ifr
argument_list|)
operator|<
literal|0
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"set bridge up: ioctl(SIOCGIFFLAGS) "
literal|"failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|flags
operator|=
operator|(
name|ifr
operator|.
name|ifr_flags
operator|&
literal|0xffff
operator|)
operator||
operator|(
name|ifr
operator|.
name|ifr_flagshigh
operator|<<
literal|16
operator|)
expr_stmt|;
if|if
condition|(
name|up
operator|==
literal|1
condition|)
name|flags
operator||=
name|IFF_UP
expr_stmt|;
else|else
name|flags
operator|&=
operator|~
name|IFF_UP
expr_stmt|;
name|ifr
operator|.
name|ifr_flags
operator|=
name|flags
operator|&
literal|0xffff
expr_stmt|;
name|ifr
operator|.
name|ifr_flagshigh
operator|=
name|flags
operator|>>
literal|16
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|sock
argument_list|,
name|SIOCSIFFLAGS
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|ifr
argument_list|)
operator|<
literal|0
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"set bridge up: ioctl(SIOCSIFFLAGS) "
literal|"failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|bridge_create
parameter_list|(
specifier|const
name|char
modifier|*
name|b_name
parameter_list|)
block|{
name|char
modifier|*
name|new_name
decl_stmt|;
name|struct
name|ifreq
name|ifr
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|ifr
argument_list|,
sizeof|sizeof
argument_list|(
name|ifr
argument_list|)
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|,
name|b_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|sock
argument_list|,
name|SIOCIFCREATE
argument_list|,
operator|&
name|ifr
argument_list|)
operator|<
literal|0
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"create bridge: ioctl(SIOCIFCREATE) "
literal|"failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|b_name
argument_list|,
name|ifr
operator|.
name|ifr_name
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
operator|(
name|new_name
operator|=
name|strdup
argument_list|(
name|b_name
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"create bridge: strdup() failed"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|ifr
operator|.
name|ifr_data
operator|=
name|new_name
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|sock
argument_list|,
name|SIOCSIFNAME
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|ifr
argument_list|)
operator|<
literal|0
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"create bridge: ioctl(SIOCSIFNAME) "
literal|"failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|new_name
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|bridge_destroy
parameter_list|(
specifier|const
name|char
modifier|*
name|b_name
parameter_list|)
block|{
name|struct
name|ifreq
name|ifr
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|ifr
argument_list|,
sizeof|sizeof
argument_list|(
name|ifr
argument_list|)
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|,
name|b_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|sock
argument_list|,
name|SIOCIFDESTROY
argument_list|,
operator|&
name|ifr
argument_list|)
operator|<
literal|0
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"destroy bridge: ioctl(SIOCIFDESTROY) "
literal|"failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Fetch the bridge base MAC address. Return pointer to the  * buffer containing the mac address, NULL on failure.  */
end_comment

begin_function
name|u_char
modifier|*
name|bridge_get_basemac
parameter_list|(
specifier|const
name|char
modifier|*
name|bif_name
parameter_list|,
name|u_char
modifier|*
name|mac
parameter_list|)
block|{
name|int
name|len
decl_stmt|;
name|char
name|if_name
index|[
name|IFNAMSIZ
index|]
decl_stmt|;
name|struct
name|ifaddrs
modifier|*
name|ifap
decl_stmt|,
modifier|*
name|tmp
decl_stmt|;
name|struct
name|sockaddr_dl
modifier|*
name|sdl
decl_stmt|;
if|if
condition|(
name|getifaddrs
argument_list|(
operator|&
name|ifap
argument_list|)
operator|<
literal|0
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"bridge get mac: getifaddrs() failed - %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
for|for
control|(
name|tmp
operator|=
name|ifap
init|;
name|tmp
operator|!=
name|NULL
condition|;
name|tmp
operator|=
name|tmp
operator|->
name|ifa_next
control|)
block|{
name|sdl
operator|=
operator|(
expr|struct
name|sockaddr_dl
operator|*
operator|)
name|tmp
operator|->
name|ifa_addr
expr_stmt|;
if|if
condition|(
operator|(
name|len
operator|=
name|sdl
operator|->
name|sdl_nlen
operator|)
operator|>=
name|IFNAMSIZ
condition|)
name|len
operator|=
name|IFNAMSIZ
operator|-
literal|1
expr_stmt|;
name|bcopy
argument_list|(
name|sdl
operator|->
name|sdl_data
argument_list|,
name|if_name
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|if_name
index|[
name|len
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|sdl
operator|->
name|sdl_family
operator|==
name|AF_LINK
operator|&&
operator|!
name|strncmp
argument_list|(
name|bif_name
argument_list|,
name|if_name
argument_list|,
name|strlen
argument_list|(
name|bif_name
argument_list|)
argument_list|)
condition|)
block|{
name|bcopy
argument_list|(
name|sdl
operator|->
name|sdl_data
operator|+
name|sdl
operator|->
name|sdl_nlen
argument_list|,
name|mac
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|freeifaddrs
argument_list|(
name|ifap
argument_list|)
expr_stmt|;
return|return
operator|(
name|mac
operator|)
return|;
block|}
block|}
name|freeifaddrs
argument_list|(
name|ifap
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_comment
comment|/************************************************************************  * Bridge ports.  */
end_comment

begin_comment
comment|/*  * Convert the kernel STP port state into  * the corresopnding enumerated type from SNMP Bridge MIB.  */
end_comment

begin_function
specifier|static
name|int
name|state2snmp_st
parameter_list|(
name|uint8_t
name|ifbr_state
parameter_list|)
block|{
switch|switch
condition|(
name|ifbr_state
condition|)
block|{
case|case
name|BSTP_IFSTATE_DISABLED
case|:
return|return
operator|(
name|StpPortState_disabled
operator|)
return|;
case|case
name|BSTP_IFSTATE_LISTENING
case|:
return|return
operator|(
name|StpPortState_listening
operator|)
return|;
case|case
name|BSTP_IFSTATE_LEARNING
case|:
return|return
operator|(
name|StpPortState_learning
operator|)
return|;
case|case
name|BSTP_IFSTATE_FORWARDING
case|:
return|return
operator|(
name|StpPortState_forwarding
operator|)
return|;
case|case
name|BSTP_IFSTATE_BLOCKING
case|:
if|#
directive|if
name|__FreeBSD_version
operator|>
literal|700024
case|case
name|BSTP_IFSTATE_DISCARDING
case|:
endif|#
directive|endif
return|return
operator|(
name|StpPortState_blocking
operator|)
return|;
block|}
return|return
operator|(
name|StpPortState_broken
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Fill in a bridge member information according to data polled from kernel.  */
end_comment

begin_function
specifier|static
name|void
name|bridge_port_getinfo_conf
parameter_list|(
name|struct
name|ifbreq
modifier|*
name|k_info
parameter_list|,
name|struct
name|bridge_port
modifier|*
name|bp
parameter_list|)
block|{
name|bp
operator|->
name|state
operator|=
name|state2snmp_st
argument_list|(
name|k_info
operator|->
name|ifbr_state
argument_list|)
expr_stmt|;
name|bp
operator|->
name|priority
operator|=
name|k_info
operator|->
name|ifbr_priority
expr_stmt|;
comment|/* 	 * RFC 4188: 	 * "New implementations should support dot1dStpPortPathCost32. 	 * If the port path costs exceeds the maximum value of this 	 * object then this object should report the maximum value, 	 * namely 65535.  Applications should try to read the 	 * dot1dStpPortPathCost32 object if this object reports 	 * the maximum value." 	 */
if|#
directive|if
name|__FreeBSD_version
operator|>
literal|700024
if|if
condition|(
name|k_info
operator|->
name|ifbr_ifsflags
operator|&
name|IFBIF_BSTP_ADMCOST
condition|)
name|bp
operator|->
name|admin_path_cost
operator|=
name|k_info
operator|->
name|ifbr_path_cost
expr_stmt|;
else|else
name|bp
operator|->
name|admin_path_cost
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
name|bp
operator|->
name|path_cost
operator|=
name|k_info
operator|->
name|ifbr_path_cost
expr_stmt|;
if|if
condition|(
name|k_info
operator|->
name|ifbr_ifsflags
operator|&
name|IFBIF_STP
condition|)
name|bp
operator|->
name|enable
operator|=
name|dot1dStpPortEnable_enabled
expr_stmt|;
else|else
name|bp
operator|->
name|enable
operator|=
name|dot1dStpPortEnable_disabled
expr_stmt|;
comment|/* Begemot Bridge MIB only. */
if|if
condition|(
name|k_info
operator|->
name|ifbr_ifsflags
operator|&
name|IFBIF_SPAN
condition|)
name|bp
operator|->
name|span_enable
operator|=
name|begemotBridgeBaseSpanEnabled_enabled
expr_stmt|;
else|else
name|bp
operator|->
name|span_enable
operator|=
name|begemotBridgeBaseSpanEnabled_disabled
expr_stmt|;
if|#
directive|if
name|__FreeBSD_version
operator|>
literal|700024
if|if
condition|(
name|k_info
operator|->
name|ifbr_ifsflags
operator|&
name|IFBIF_BSTP_ADMEDGE
condition|)
name|bp
operator|->
name|admin_edge
operator|=
name|TruthValue_true
expr_stmt|;
else|else
name|bp
operator|->
name|admin_edge
operator|=
name|TruthValue_false
expr_stmt|;
if|if
condition|(
name|k_info
operator|->
name|ifbr_ifsflags
operator|&
name|IFBIF_BSTP_EDGE
condition|)
name|bp
operator|->
name|oper_edge
operator|=
name|TruthValue_true
expr_stmt|;
else|else
name|bp
operator|->
name|oper_edge
operator|=
name|TruthValue_false
expr_stmt|;
if|if
condition|(
name|k_info
operator|->
name|ifbr_ifsflags
operator|&
name|IFBIF_BSTP_AUTOPTP
condition|)
block|{
name|bp
operator|->
name|admin_ptp
operator|=
name|StpPortAdminPointToPointType_auto
expr_stmt|;
if|if
condition|(
name|k_info
operator|->
name|ifbr_ifsflags
operator|&
name|IFBIF_BSTP_PTP
condition|)
name|bp
operator|->
name|oper_ptp
operator|=
name|TruthValue_true
expr_stmt|;
else|else
name|bp
operator|->
name|oper_ptp
operator|=
name|TruthValue_false
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|k_info
operator|->
name|ifbr_ifsflags
operator|&
name|IFBIF_BSTP_PTP
condition|)
block|{
name|bp
operator|->
name|admin_ptp
operator|=
name|StpPortAdminPointToPointType_forceTrue
expr_stmt|;
name|bp
operator|->
name|oper_ptp
operator|=
name|TruthValue_true
expr_stmt|;
block|}
else|else
block|{
name|bp
operator|->
name|admin_ptp
operator|=
name|StpPortAdminPointToPointType_forceFalse
expr_stmt|;
name|bp
operator|->
name|oper_ptp
operator|=
name|TruthValue_false
expr_stmt|;
block|}
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/*  * Fill in a bridge interface STP information according to  * data polled from kernel.  */
end_comment

begin_function
specifier|static
name|void
name|bridge_port_getinfo_opstp
parameter_list|(
name|struct
name|ifbpstpreq
modifier|*
name|bp_stp
parameter_list|,
name|struct
name|bridge_port
modifier|*
name|bp
parameter_list|)
block|{
name|bp
operator|->
name|enable
operator|=
name|dot1dStpPortEnable_enabled
expr_stmt|;
name|bp
operator|->
name|fwd_trans
operator|=
name|bp_stp
operator|->
name|ifbp_fwd_trans
expr_stmt|;
name|bp
operator|->
name|design_cost
operator|=
name|bp_stp
operator|->
name|ifbp_design_cost
expr_stmt|;
name|snmp_uint64_to_bridgeid
argument_list|(
name|bp_stp
operator|->
name|ifbp_design_root
argument_list|,
name|bp
operator|->
name|design_root
argument_list|)
expr_stmt|;
name|snmp_uint64_to_bridgeid
argument_list|(
name|bp_stp
operator|->
name|ifbp_design_bridge
argument_list|,
name|bp
operator|->
name|design_bridge
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|&
operator|(
name|bp_stp
operator|->
name|ifbp_design_port
operator|)
argument_list|,
operator|&
operator|(
name|bp
operator|->
name|design_port
operator|)
argument_list|,
sizeof|sizeof
argument_list|(
name|uint16_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Clear a bridge interface STP information.  */
end_comment

begin_function
specifier|static
name|void
name|bridge_port_clearinfo_opstp
parameter_list|(
name|struct
name|bridge_port
modifier|*
name|bp
parameter_list|)
block|{
if|if
condition|(
name|bp
operator|->
name|enable
operator|==
name|dot1dStpPortEnable_enabled
condition|)
block|{
name|bp
operator|->
name|design_cost
operator|=
literal|0
expr_stmt|;
name|bzero
argument_list|(
operator|&
operator|(
name|bp
operator|->
name|design_root
operator|)
argument_list|,
sizeof|sizeof
argument_list|(
name|bridge_id
argument_list|)
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|&
operator|(
name|bp
operator|->
name|design_bridge
operator|)
argument_list|,
sizeof|sizeof
argument_list|(
name|bridge_id
argument_list|)
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|&
operator|(
name|bp
operator|->
name|design_port
operator|)
argument_list|,
sizeof|sizeof
argument_list|(
name|port_id
argument_list|)
argument_list|)
expr_stmt|;
name|bp
operator|->
name|fwd_trans
operator|=
literal|0
expr_stmt|;
block|}
name|bp
operator|->
name|enable
operator|=
name|dot1dStpPortEnable_disabled
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Set a bridge member priority.  */
end_comment

begin_function
name|int
name|bridge_port_set_priority
parameter_list|(
specifier|const
name|char
modifier|*
name|bif_name
parameter_list|,
name|struct
name|bridge_port
modifier|*
name|bp
parameter_list|,
name|int32_t
name|priority
parameter_list|)
block|{
name|struct
name|ifdrv
name|ifd
decl_stmt|;
name|struct
name|ifbreq
name|b_req
decl_stmt|;
name|strlcpy
argument_list|(
name|ifd
operator|.
name|ifd_name
argument_list|,
name|bif_name
argument_list|,
sizeof|sizeof
argument_list|(
name|ifd
operator|.
name|ifd_name
argument_list|)
argument_list|)
expr_stmt|;
name|ifd
operator|.
name|ifd_len
operator|=
sizeof|sizeof
argument_list|(
name|b_req
argument_list|)
expr_stmt|;
name|ifd
operator|.
name|ifd_data
operator|=
operator|&
name|b_req
expr_stmt|;
name|strlcpy
argument_list|(
name|b_req
operator|.
name|ifbr_ifsname
argument_list|,
name|bp
operator|->
name|p_name
argument_list|,
sizeof|sizeof
argument_list|(
name|b_req
operator|.
name|ifbr_ifsname
argument_list|)
argument_list|)
expr_stmt|;
name|b_req
operator|.
name|ifbr_priority
operator|=
operator|(
name|uint8_t
operator|)
name|priority
expr_stmt|;
name|ifd
operator|.
name|ifd_cmd
operator|=
name|BRDGSIFPRIO
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|sock
argument_list|,
name|SIOCSDRVSPEC
argument_list|,
operator|&
name|ifd
argument_list|)
operator|<
literal|0
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"set member %s param: ioctl(BRDGSIFPRIO) "
literal|"failed: %s"
argument_list|,
name|bp
operator|->
name|p_name
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|bp
operator|->
name|priority
operator|=
name|priority
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Set a bridge member STP-enabled flag.  */
end_comment

begin_function
name|int
name|bridge_port_set_stp_enable
parameter_list|(
specifier|const
name|char
modifier|*
name|bif_name
parameter_list|,
name|struct
name|bridge_port
modifier|*
name|bp
parameter_list|,
name|uint32_t
name|enable
parameter_list|)
block|{
name|struct
name|ifdrv
name|ifd
decl_stmt|;
name|struct
name|ifbreq
name|b_req
decl_stmt|;
if|if
condition|(
name|bp
operator|->
name|enable
operator|==
name|enable
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|bzero
argument_list|(
operator|&
name|b_req
argument_list|,
sizeof|sizeof
argument_list|(
name|b_req
argument_list|)
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|ifd
operator|.
name|ifd_name
argument_list|,
name|bif_name
argument_list|,
sizeof|sizeof
argument_list|(
name|ifd
operator|.
name|ifd_name
argument_list|)
argument_list|)
expr_stmt|;
name|ifd
operator|.
name|ifd_len
operator|=
sizeof|sizeof
argument_list|(
name|b_req
argument_list|)
expr_stmt|;
name|ifd
operator|.
name|ifd_data
operator|=
operator|&
name|b_req
expr_stmt|;
name|strlcpy
argument_list|(
name|b_req
operator|.
name|ifbr_ifsname
argument_list|,
name|bp
operator|->
name|p_name
argument_list|,
sizeof|sizeof
argument_list|(
name|b_req
operator|.
name|ifbr_ifsname
argument_list|)
argument_list|)
expr_stmt|;
name|ifd
operator|.
name|ifd_cmd
operator|=
name|BRDGGIFFLGS
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|sock
argument_list|,
name|SIOCGDRVSPEC
argument_list|,
operator|&
name|ifd
argument_list|)
operator|<
literal|0
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"get member %s param: ioctl(BRDGGIFFLGS) "
literal|"failed: %s"
argument_list|,
name|bp
operator|->
name|p_name
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|enable
operator|==
name|dot1dStpPortEnable_enabled
condition|)
name|b_req
operator|.
name|ifbr_ifsflags
operator||=
name|IFBIF_STP
expr_stmt|;
else|else
name|b_req
operator|.
name|ifbr_ifsflags
operator|&=
operator|~
name|IFBIF_STP
expr_stmt|;
name|ifd
operator|.
name|ifd_cmd
operator|=
name|BRDGSIFFLGS
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|sock
argument_list|,
name|SIOCSDRVSPEC
argument_list|,
operator|&
name|ifd
argument_list|)
operator|<
literal|0
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"set member %s param: ioctl(BRDGSIFFLGS) "
literal|"failed: %s"
argument_list|,
name|bp
operator|->
name|p_name
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|bp
operator|->
name|enable
operator|=
name|enable
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Set a bridge member STP path cost.  */
end_comment

begin_function
name|int
name|bridge_port_set_path_cost
parameter_list|(
specifier|const
name|char
modifier|*
name|bif_name
parameter_list|,
name|struct
name|bridge_port
modifier|*
name|bp
parameter_list|,
name|int32_t
name|path_cost
parameter_list|)
block|{
name|struct
name|ifdrv
name|ifd
decl_stmt|;
name|struct
name|ifbreq
name|b_req
decl_stmt|;
if|#
directive|if
name|__FreeBSD_version
operator|<
literal|700025
if|if
condition|(
name|path_cost
operator|<
name|SNMP_PORT_MIN_PATHCOST
operator|||
name|path_cost
operator|>
name|SNMP_PORT_PATHCOST_OBSOLETE
condition|)
return|return
operator|(
operator|-
literal|2
operator|)
return|;
endif|#
directive|endif
name|strlcpy
argument_list|(
name|ifd
operator|.
name|ifd_name
argument_list|,
name|bif_name
argument_list|,
sizeof|sizeof
argument_list|(
name|ifd
operator|.
name|ifd_name
argument_list|)
argument_list|)
expr_stmt|;
name|ifd
operator|.
name|ifd_len
operator|=
sizeof|sizeof
argument_list|(
name|b_req
argument_list|)
expr_stmt|;
name|ifd
operator|.
name|ifd_data
operator|=
operator|&
name|b_req
expr_stmt|;
name|strlcpy
argument_list|(
name|b_req
operator|.
name|ifbr_ifsname
argument_list|,
name|bp
operator|->
name|p_name
argument_list|,
sizeof|sizeof
argument_list|(
name|b_req
operator|.
name|ifbr_ifsname
argument_list|)
argument_list|)
expr_stmt|;
name|b_req
operator|.
name|ifbr_path_cost
operator|=
name|path_cost
expr_stmt|;
name|ifd
operator|.
name|ifd_cmd
operator|=
name|BRDGSIFCOST
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|sock
argument_list|,
name|SIOCSDRVSPEC
argument_list|,
operator|&
name|ifd
argument_list|)
operator|<
literal|0
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"set member %s param: ioctl(BRDGSIFCOST) "
literal|"failed: %s"
argument_list|,
name|bp
operator|->
name|p_name
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|#
directive|if
name|__FreeBSD_version
operator|>
literal|700024
name|bp
operator|->
name|admin_path_cost
operator|=
name|path_cost
expr_stmt|;
else|#
directive|else
name|bp
operator|->
name|path_cost
operator|=
name|path_cost
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Set the PonitToPoint status of the link administratively.  */
end_comment

begin_function
name|int
name|bridge_port_set_admin_ptp
parameter_list|(
specifier|const
name|char
modifier|*
name|bif_name
name|__unused
parameter_list|,
name|struct
name|bridge_port
modifier|*
name|bp
name|__unused
parameter_list|,
name|uint32_t
name|admin_ptp
name|__unused
parameter_list|)
block|{
if|#
directive|if
name|__FreeBSD_version
operator|>
literal|700024
name|struct
name|ifdrv
name|ifd
decl_stmt|;
name|struct
name|ifbreq
name|b_req
decl_stmt|;
if|if
condition|(
name|bp
operator|->
name|admin_ptp
operator|==
name|admin_ptp
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|bzero
argument_list|(
operator|&
name|b_req
argument_list|,
sizeof|sizeof
argument_list|(
name|b_req
argument_list|)
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|ifd
operator|.
name|ifd_name
argument_list|,
name|bif_name
argument_list|,
sizeof|sizeof
argument_list|(
name|ifd
operator|.
name|ifd_name
argument_list|)
argument_list|)
expr_stmt|;
name|ifd
operator|.
name|ifd_len
operator|=
sizeof|sizeof
argument_list|(
name|b_req
argument_list|)
expr_stmt|;
name|ifd
operator|.
name|ifd_data
operator|=
operator|&
name|b_req
expr_stmt|;
name|strlcpy
argument_list|(
name|b_req
operator|.
name|ifbr_ifsname
argument_list|,
name|bp
operator|->
name|p_name
argument_list|,
sizeof|sizeof
argument_list|(
name|b_req
operator|.
name|ifbr_ifsname
argument_list|)
argument_list|)
expr_stmt|;
name|ifd
operator|.
name|ifd_cmd
operator|=
name|BRDGGIFFLGS
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|sock
argument_list|,
name|SIOCGDRVSPEC
argument_list|,
operator|&
name|ifd
argument_list|)
operator|<
literal|0
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"get member %s param: ioctl(BRDGGIFFLGS) "
literal|"failed: %s"
argument_list|,
name|bp
operator|->
name|p_name
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
switch|switch
condition|(
name|admin_ptp
condition|)
block|{
case|case
name|StpPortAdminPointToPointType_forceTrue
case|:
name|b_req
operator|.
name|ifbr_ifsflags
operator|&=
operator|~
name|IFBIF_BSTP_AUTOPTP
expr_stmt|;
name|b_req
operator|.
name|ifbr_ifsflags
operator||=
name|IFBIF_BSTP_PTP
expr_stmt|;
break|break;
case|case
name|StpPortAdminPointToPointType_forceFalse
case|:
name|b_req
operator|.
name|ifbr_ifsflags
operator|&=
operator|~
name|IFBIF_BSTP_AUTOPTP
expr_stmt|;
name|b_req
operator|.
name|ifbr_ifsflags
operator|&=
operator|~
name|IFBIF_BSTP_PTP
expr_stmt|;
break|break;
case|case
name|StpPortAdminPointToPointType_auto
case|:
name|b_req
operator|.
name|ifbr_ifsflags
operator||=
name|IFBIF_BSTP_AUTOPTP
expr_stmt|;
break|break;
block|}
name|ifd
operator|.
name|ifd_cmd
operator|=
name|BRDGSIFFLGS
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|sock
argument_list|,
name|SIOCSDRVSPEC
argument_list|,
operator|&
name|ifd
argument_list|)
operator|<
literal|0
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"set member %s param: ioctl(BRDGSIFFLGS) "
literal|"failed: %s"
argument_list|,
name|bp
operator|->
name|p_name
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|bp
operator|->
name|admin_ptp
operator|=
name|admin_ptp
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
else|#
directive|else
return|return
operator|(
operator|-
literal|1
operator|)
return|;
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/*  * Set admin edge.  */
end_comment

begin_function
name|int
name|bridge_port_set_admin_edge
parameter_list|(
specifier|const
name|char
modifier|*
name|bif_name
name|__unused
parameter_list|,
name|struct
name|bridge_port
modifier|*
name|bp
name|__unused
parameter_list|,
name|uint32_t
name|enable
name|__unused
parameter_list|)
block|{
if|#
directive|if
name|__FreeBSD_version
operator|>
literal|700024
name|struct
name|ifdrv
name|ifd
decl_stmt|;
name|struct
name|ifbreq
name|b_req
decl_stmt|;
if|if
condition|(
name|bp
operator|->
name|admin_edge
operator|==
name|enable
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|bzero
argument_list|(
operator|&
name|b_req
argument_list|,
sizeof|sizeof
argument_list|(
name|b_req
argument_list|)
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|ifd
operator|.
name|ifd_name
argument_list|,
name|bif_name
argument_list|,
sizeof|sizeof
argument_list|(
name|ifd
operator|.
name|ifd_name
argument_list|)
argument_list|)
expr_stmt|;
name|ifd
operator|.
name|ifd_len
operator|=
sizeof|sizeof
argument_list|(
name|b_req
argument_list|)
expr_stmt|;
name|ifd
operator|.
name|ifd_data
operator|=
operator|&
name|b_req
expr_stmt|;
name|strlcpy
argument_list|(
name|b_req
operator|.
name|ifbr_ifsname
argument_list|,
name|bp
operator|->
name|p_name
argument_list|,
sizeof|sizeof
argument_list|(
name|b_req
operator|.
name|ifbr_ifsname
argument_list|)
argument_list|)
expr_stmt|;
name|ifd
operator|.
name|ifd_cmd
operator|=
name|BRDGGIFFLGS
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|sock
argument_list|,
name|SIOCGDRVSPEC
argument_list|,
operator|&
name|ifd
argument_list|)
operator|<
literal|0
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"get member %s param: ioctl(BRDGGIFFLGS) "
literal|"failed: %s"
argument_list|,
name|bp
operator|->
name|p_name
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|enable
operator|==
name|TruthValue_true
condition|)
block|{
name|b_req
operator|.
name|ifbr_ifsflags
operator|&=
operator|~
name|IFBIF_BSTP_AUTOEDGE
expr_stmt|;
name|b_req
operator|.
name|ifbr_ifsflags
operator||=
name|IFBIF_BSTP_EDGE
expr_stmt|;
block|}
else|else
name|b_req
operator|.
name|ifbr_ifsflags
operator|&=
operator|~
name|IFBIF_BSTP_EDGE
expr_stmt|;
name|ifd
operator|.
name|ifd_cmd
operator|=
name|BRDGSIFFLGS
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|sock
argument_list|,
name|SIOCSDRVSPEC
argument_list|,
operator|&
name|ifd
argument_list|)
operator|<
literal|0
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"set member %s param: ioctl(BRDGSIFFLGS) "
literal|"failed: %s"
argument_list|,
name|bp
operator|->
name|p_name
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|bp
operator|->
name|admin_edge
operator|=
name|enable
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
else|#
directive|else
return|return
operator|(
operator|-
literal|1
operator|)
return|;
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/*  * Add a bridge member port.  */
end_comment

begin_function
name|int
name|bridge_port_addm
parameter_list|(
name|struct
name|bridge_port
modifier|*
name|bp
parameter_list|,
specifier|const
name|char
modifier|*
name|b_name
parameter_list|)
block|{
name|struct
name|ifdrv
name|ifd
decl_stmt|;
name|struct
name|ifbreq
name|b_req
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|ifd
argument_list|,
sizeof|sizeof
argument_list|(
name|ifd
argument_list|)
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|b_req
argument_list|,
sizeof|sizeof
argument_list|(
name|b_req
argument_list|)
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|ifd
operator|.
name|ifd_name
argument_list|,
name|b_name
argument_list|,
sizeof|sizeof
argument_list|(
name|ifd
operator|.
name|ifd_name
argument_list|)
argument_list|)
expr_stmt|;
name|ifd
operator|.
name|ifd_len
operator|=
sizeof|sizeof
argument_list|(
name|b_req
argument_list|)
expr_stmt|;
name|ifd
operator|.
name|ifd_data
operator|=
operator|&
name|b_req
expr_stmt|;
name|strlcpy
argument_list|(
name|b_req
operator|.
name|ifbr_ifsname
argument_list|,
name|bp
operator|->
name|p_name
argument_list|,
sizeof|sizeof
argument_list|(
name|b_req
operator|.
name|ifbr_ifsname
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bp
operator|->
name|span_enable
operator|==
name|begemotBridgeBaseSpanEnabled_enabled
condition|)
name|ifd
operator|.
name|ifd_cmd
operator|=
name|BRDGADDS
expr_stmt|;
else|else
name|ifd
operator|.
name|ifd_cmd
operator|=
name|BRDGADD
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|sock
argument_list|,
name|SIOCSDRVSPEC
argument_list|,
operator|&
name|ifd
argument_list|)
operator|<
literal|0
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"%s - add member : ioctl(%s) failed: %s"
argument_list|,
name|bp
operator|->
name|p_name
argument_list|,
operator|(
name|ifd
operator|.
name|ifd_cmd
operator|==
name|BRDGADDS
condition|?
literal|"BRDGADDS"
else|:
literal|"BRDGADD"
operator|)
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Delete a bridge member port.  */
end_comment

begin_function
name|int
name|bridge_port_delm
parameter_list|(
name|struct
name|bridge_port
modifier|*
name|bp
parameter_list|,
specifier|const
name|char
modifier|*
name|b_name
parameter_list|)
block|{
name|struct
name|ifdrv
name|ifd
decl_stmt|;
name|struct
name|ifbreq
name|b_req
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|ifd
argument_list|,
sizeof|sizeof
argument_list|(
name|ifd
argument_list|)
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|b_req
argument_list|,
sizeof|sizeof
argument_list|(
name|b_req
argument_list|)
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|ifd
operator|.
name|ifd_name
argument_list|,
name|b_name
argument_list|,
sizeof|sizeof
argument_list|(
name|ifd
operator|.
name|ifd_name
argument_list|)
argument_list|)
expr_stmt|;
name|ifd
operator|.
name|ifd_len
operator|=
sizeof|sizeof
argument_list|(
name|b_req
argument_list|)
expr_stmt|;
name|ifd
operator|.
name|ifd_data
operator|=
operator|&
name|b_req
expr_stmt|;
name|strlcpy
argument_list|(
name|b_req
operator|.
name|ifbr_ifsname
argument_list|,
name|bp
operator|->
name|p_name
argument_list|,
sizeof|sizeof
argument_list|(
name|b_req
operator|.
name|ifbr_ifsname
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bp
operator|->
name|span_enable
operator|==
name|begemotBridgeBaseSpanEnabled_enabled
condition|)
name|ifd
operator|.
name|ifd_cmd
operator|=
name|BRDGDELS
expr_stmt|;
else|else
name|ifd
operator|.
name|ifd_cmd
operator|=
name|BRDGDEL
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|sock
argument_list|,
name|SIOCSDRVSPEC
argument_list|,
operator|&
name|ifd
argument_list|)
operator|<
literal|0
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"%s - add member : ioctl(%s) failed: %s"
argument_list|,
name|bp
operator|->
name|p_name
argument_list|,
operator|(
name|ifd
operator|.
name|ifd_cmd
operator|==
name|BRDGDELS
condition|?
literal|"BRDGDELS"
else|:
literal|"BRDGDEL"
operator|)
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Fetch the bridge member list from kernel.  * Return -1 on error, or buffer len if successful.  */
end_comment

begin_function
specifier|static
name|int32_t
name|bridge_port_get_iflist
parameter_list|(
name|struct
name|bridge_if
modifier|*
name|bif
parameter_list|,
name|char
modifier|*
modifier|*
name|buf
parameter_list|)
block|{
name|uint32_t
name|len
init|=
literal|8192
decl_stmt|;
comment|/* ??? */
name|char
modifier|*
name|ninbuf
decl_stmt|;
name|struct
name|ifbifconf
name|ifbc
decl_stmt|;
name|struct
name|ifdrv
name|ifd
decl_stmt|;
operator|*
name|buf
operator|=
name|NULL
expr_stmt|;
name|strlcpy
argument_list|(
name|ifd
operator|.
name|ifd_name
argument_list|,
name|bif
operator|->
name|bif_name
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
name|ifd
operator|.
name|ifd_cmd
operator|=
name|BRDGGIFS
expr_stmt|;
name|ifd
operator|.
name|ifd_len
operator|=
sizeof|sizeof
argument_list|(
name|ifbc
argument_list|)
expr_stmt|;
name|ifd
operator|.
name|ifd_data
operator|=
operator|&
name|ifbc
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
operator|(
name|ninbuf
operator|=
name|realloc
argument_list|(
operator|*
name|buf
argument_list|,
name|len
argument_list|)
comment|/* ??? */
operator|)
operator|==
name|NULL
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"get bridge member list: "
literal|"realloc failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|*
name|buf
argument_list|)
expr_stmt|;
operator|*
name|buf
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|ifbc
operator|.
name|ifbic_len
operator|=
name|len
expr_stmt|;
name|ifbc
operator|.
name|ifbic_buf
operator|=
operator|*
name|buf
operator|=
name|ninbuf
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|sock
argument_list|,
name|SIOCGDRVSPEC
argument_list|,
operator|&
name|ifd
argument_list|)
operator|<
literal|0
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"get bridge member list: ioctl "
literal|"(BRDGGIFS) failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|*
name|buf
argument_list|)
expr_stmt|;
name|buf
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|ifbc
operator|.
name|ifbic_len
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|ifbreq
argument_list|)
operator|)
operator|<
name|len
condition|)
break|break;
name|len
operator|+=
literal|8192
expr_stmt|;
block|}
return|return
operator|(
name|ifbc
operator|.
name|ifbic_len
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Fetch the bridge STP member list from kernel.  * Return -1 on error, or buffer len if successful.  */
end_comment

begin_function
specifier|static
name|int32_t
name|bridge_port_get_ifstplist
parameter_list|(
name|struct
name|bridge_if
modifier|*
name|bif
parameter_list|,
name|char
modifier|*
modifier|*
name|buf
parameter_list|)
block|{
name|uint32_t
name|len
init|=
literal|8192
decl_stmt|;
comment|/* ??? */
name|char
modifier|*
name|ninbuf
decl_stmt|;
name|struct
name|ifbpstpconf
name|ifbstp
decl_stmt|;
name|struct
name|ifdrv
name|ifd
decl_stmt|;
operator|*
name|buf
operator|=
name|NULL
expr_stmt|;
name|strlcpy
argument_list|(
name|ifd
operator|.
name|ifd_name
argument_list|,
name|bif
operator|->
name|bif_name
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
name|ifd
operator|.
name|ifd_cmd
operator|=
name|BRDGGIFSSTP
expr_stmt|;
name|ifd
operator|.
name|ifd_len
operator|=
sizeof|sizeof
argument_list|(
name|ifbstp
argument_list|)
expr_stmt|;
name|ifd
operator|.
name|ifd_data
operator|=
operator|&
name|ifbstp
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
operator|(
name|ninbuf
operator|=
name|realloc
argument_list|(
operator|*
name|buf
argument_list|,
name|len
argument_list|)
comment|/* ??? */
operator|)
operator|==
name|NULL
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"get bridge STP ports list: "
literal|"realloc failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|*
name|buf
argument_list|)
expr_stmt|;
operator|*
name|buf
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|ifbstp
operator|.
name|ifbpstp_len
operator|=
name|len
expr_stmt|;
name|ifbstp
operator|.
name|ifbpstp_buf
operator|=
operator|*
name|buf
operator|=
name|ninbuf
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|sock
argument_list|,
name|SIOCGDRVSPEC
argument_list|,
operator|&
name|ifd
argument_list|)
operator|<
literal|0
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"get bridge STP ports list: ioctl "
literal|"(BRDGGIFSSTP) failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|*
name|buf
argument_list|)
expr_stmt|;
name|buf
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|ifbstp
operator|.
name|ifbpstp_len
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|ifbpstpreq
argument_list|)
operator|)
operator|<
name|len
condition|)
break|break;
name|len
operator|+=
literal|8192
expr_stmt|;
block|}
return|return
operator|(
name|ifbstp
operator|.
name|ifbpstp_len
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Locate a bridge if STP params structure in a buffer.  */
end_comment

begin_function
specifier|static
name|struct
name|ifbpstpreq
modifier|*
name|bridge_port_find_ifstplist
parameter_list|(
name|uint8_t
name|port_no
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|uint32_t
name|buf_len
parameter_list|)
block|{
name|uint32_t
name|i
decl_stmt|;
name|struct
name|ifbpstpreq
modifier|*
name|bstp
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|buf_len
operator|/
sizeof|sizeof
argument_list|(
operator|*
name|bstp
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|bstp
operator|=
operator|(
expr|struct
name|ifbpstpreq
operator|*
operator|)
name|buf
operator|+
name|i
expr_stmt|;
if|if
condition|(
name|bstp
operator|->
name|ifbp_portno
operator|==
name|port_no
condition|)
return|return
operator|(
name|bstp
operator|)
return|;
block|}
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Read the initial info for all members of a bridge interface.  * Returns the number of ports, 0 - if none, otherwise  * -1 if some other error occured.  */
end_comment

begin_function
name|int
name|bridge_getinfo_bif_ports
parameter_list|(
name|struct
name|bridge_if
modifier|*
name|bif
parameter_list|)
block|{
name|uint32_t
name|i
decl_stmt|;
name|int32_t
name|buf_len
decl_stmt|;
name|char
modifier|*
name|mem_buf
decl_stmt|;
name|struct
name|ifbreq
modifier|*
name|b_req
decl_stmt|;
name|struct
name|ifbpstpreq
modifier|*
name|bs_req
decl_stmt|;
name|struct
name|bridge_port
modifier|*
name|bp
decl_stmt|;
name|struct
name|mibif
modifier|*
name|m_if
decl_stmt|;
if|if
condition|(
operator|(
name|buf_len
operator|=
name|bridge_port_get_iflist
argument_list|(
name|bif
argument_list|,
operator|&
name|mem_buf
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|buf_len
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|ifbreq
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|b_req
operator|=
operator|(
expr|struct
name|ifbreq
operator|*
operator|)
name|mem_buf
operator|+
name|i
expr_stmt|;
if|if
condition|(
operator|(
name|m_if
operator|=
name|mib_find_if_sys
argument_list|(
name|b_req
operator|->
name|ifbr_portno
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
comment|/* Hopefully we will not fail here. */
if|if
condition|(
operator|(
name|bp
operator|=
name|bridge_new_port
argument_list|(
name|m_if
argument_list|,
name|bif
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|bp
operator|->
name|status
operator|=
name|RowStatus_active
expr_stmt|;
name|bridge_port_getinfo_conf
argument_list|(
name|b_req
argument_list|,
name|bp
argument_list|)
expr_stmt|;
name|bridge_port_getinfo_mibif
argument_list|(
name|m_if
argument_list|,
name|bp
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"bridge member %s not present "
literal|"in mibII ifTable"
argument_list|,
name|b_req
operator|->
name|ifbr_ifsname
argument_list|)
expr_stmt|;
block|}
block|}
name|free
argument_list|(
name|mem_buf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|buf_len
operator|=
name|bridge_port_get_ifstplist
argument_list|(
name|bif
argument_list|,
operator|&
name|mem_buf
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
for|for
control|(
name|bp
operator|=
name|bridge_port_bif_first
argument_list|(
name|bif
argument_list|)
init|;
name|bp
operator|!=
name|NULL
condition|;
name|bp
operator|=
name|bridge_port_bif_next
argument_list|(
name|bp
argument_list|)
control|)
block|{
if|if
condition|(
operator|(
name|bs_req
operator|=
name|bridge_port_find_ifstplist
argument_list|(
name|bp
operator|->
name|port_no
argument_list|,
name|mem_buf
argument_list|,
name|buf_len
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|bridge_port_clearinfo_opstp
argument_list|(
name|bp
argument_list|)
expr_stmt|;
else|else
name|bridge_port_getinfo_opstp
argument_list|(
name|bs_req
argument_list|,
name|bp
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|mem_buf
argument_list|)
expr_stmt|;
return|return
operator|(
name|i
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Update the information for the bridge interface members.  */
end_comment

begin_function
name|int
name|bridge_update_memif
parameter_list|(
name|struct
name|bridge_if
modifier|*
name|bif
parameter_list|)
block|{
name|int
name|added
decl_stmt|,
name|updated
decl_stmt|;
name|uint32_t
name|i
decl_stmt|;
name|int32_t
name|buf_len
decl_stmt|;
name|char
modifier|*
name|if_buf
decl_stmt|;
name|struct
name|ifbreq
modifier|*
name|b_req
decl_stmt|;
name|struct
name|ifbpstpreq
modifier|*
name|bs_req
decl_stmt|;
name|struct
name|bridge_port
modifier|*
name|bp
decl_stmt|,
modifier|*
name|bp_next
decl_stmt|;
name|struct
name|mibif
modifier|*
name|m_if
decl_stmt|;
if|if
condition|(
operator|(
name|buf_len
operator|=
name|bridge_port_get_iflist
argument_list|(
name|bif
argument_list|,
operator|&
name|if_buf
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|added
operator|=
name|updated
operator|=
literal|0
expr_stmt|;
define|#
directive|define
name|BP_FOUND
value|0x01
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|buf_len
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|ifbreq
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|b_req
operator|=
operator|(
expr|struct
name|ifbreq
operator|*
operator|)
name|if_buf
operator|+
name|i
expr_stmt|;
if|if
condition|(
operator|(
name|m_if
operator|=
name|mib_find_if_sys
argument_list|(
name|b_req
operator|->
name|ifbr_portno
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"bridge member %s not present "
literal|"in mibII ifTable"
argument_list|,
name|b_req
operator|->
name|ifbr_ifsname
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|(
name|bp
operator|=
name|bridge_port_find
argument_list|(
name|m_if
operator|->
name|index
argument_list|,
name|bif
argument_list|)
operator|)
operator|==
name|NULL
operator|&&
operator|(
name|bp
operator|=
name|bridge_new_port
argument_list|(
name|m_if
argument_list|,
name|bif
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|bp
operator|->
name|status
operator|=
name|RowStatus_active
expr_stmt|;
name|added
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|bp
operator|!=
name|NULL
condition|)
block|{
name|updated
operator|++
expr_stmt|;
name|bridge_port_getinfo_conf
argument_list|(
name|b_req
argument_list|,
name|bp
argument_list|)
expr_stmt|;
name|bridge_port_getinfo_mibif
argument_list|(
name|m_if
argument_list|,
name|bp
argument_list|)
expr_stmt|;
name|bp
operator|->
name|flags
operator||=
name|BP_FOUND
expr_stmt|;
block|}
block|}
name|free
argument_list|(
name|if_buf
argument_list|)
expr_stmt|;
comment|/* Clean up list. */
for|for
control|(
name|bp
operator|=
name|bridge_port_bif_first
argument_list|(
name|bif
argument_list|)
init|;
name|bp
operator|!=
name|NULL
condition|;
name|bp
operator|=
name|bp_next
control|)
block|{
name|bp_next
operator|=
name|bridge_port_bif_next
argument_list|(
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|bp
operator|->
name|flags
operator|&
name|BP_FOUND
operator|)
operator|==
literal|0
operator|&&
name|bp
operator|->
name|status
operator|==
name|RowStatus_active
condition|)
name|bridge_port_remove
argument_list|(
name|bp
argument_list|,
name|bif
argument_list|)
expr_stmt|;
else|else
name|bp
operator|->
name|flags
operator||=
operator|~
name|BP_FOUND
expr_stmt|;
block|}
undef|#
directive|undef
name|BP_FOUND
if|if
condition|(
operator|(
name|buf_len
operator|=
name|bridge_port_get_ifstplist
argument_list|(
name|bif
argument_list|,
operator|&
name|if_buf
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
for|for
control|(
name|bp
operator|=
name|bridge_port_bif_first
argument_list|(
name|bif
argument_list|)
init|;
name|bp
operator|!=
name|NULL
condition|;
name|bp
operator|=
name|bridge_port_bif_next
argument_list|(
name|bp
argument_list|)
control|)
block|{
if|if
condition|(
operator|(
name|bs_req
operator|=
name|bridge_port_find_ifstplist
argument_list|(
name|bp
operator|->
name|port_no
argument_list|,
name|if_buf
argument_list|,
name|buf_len
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|bridge_port_clearinfo_opstp
argument_list|(
name|bp
argument_list|)
expr_stmt|;
else|else
name|bridge_port_getinfo_opstp
argument_list|(
name|bs_req
argument_list|,
name|bp
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|if_buf
argument_list|)
expr_stmt|;
name|bif
operator|->
name|ports_age
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
return|return
operator|(
name|updated
operator|)
return|;
block|}
end_function

begin_comment
comment|/************************************************************************  * Bridge addresses.  */
end_comment

begin_comment
comment|/*  * Update the bridge address info according to the polled data.  */
end_comment

begin_function
specifier|static
name|void
name|bridge_addrs_info_ifaddrlist
parameter_list|(
name|struct
name|ifbareq
modifier|*
name|ifba
parameter_list|,
name|struct
name|tp_entry
modifier|*
name|tpe
parameter_list|)
block|{
name|tpe
operator|->
name|port_no
operator|=
name|if_nametoindex
argument_list|(
name|ifba
operator|->
name|ifba_ifsname
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ifba
operator|->
name|ifba_flags
operator|&
name|IFBAF_TYPEMASK
operator|)
operator|==
name|IFBAF_STATIC
condition|)
name|tpe
operator|->
name|status
operator|=
name|TpFdbStatus_mgmt
expr_stmt|;
else|else
name|tpe
operator|->
name|status
operator|=
name|TpFdbStatus_learned
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Read the bridge addresses from kernel.  * Return -1 on error, or buffer len if successful.  */
end_comment

begin_function
specifier|static
name|int32_t
name|bridge_addrs_getinfo_ifalist
parameter_list|(
name|struct
name|bridge_if
modifier|*
name|bif
parameter_list|,
name|char
modifier|*
modifier|*
name|buf
parameter_list|)
block|{
name|uint32_t
name|len
init|=
literal|8192
decl_stmt|;
comment|/* ??? */
name|char
modifier|*
name|ninbuf
decl_stmt|;
name|struct
name|ifbaconf
name|bac
decl_stmt|;
name|struct
name|ifdrv
name|ifd
decl_stmt|;
operator|*
name|buf
operator|=
name|NULL
expr_stmt|;
name|strlcpy
argument_list|(
name|ifd
operator|.
name|ifd_name
argument_list|,
name|bif
operator|->
name|bif_name
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
name|ifd
operator|.
name|ifd_cmd
operator|=
name|BRDGRTS
expr_stmt|;
name|ifd
operator|.
name|ifd_len
operator|=
sizeof|sizeof
argument_list|(
name|bac
argument_list|)
expr_stmt|;
name|ifd
operator|.
name|ifd_data
operator|=
operator|&
name|bac
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
operator|(
name|ninbuf
operator|=
name|realloc
argument_list|(
operator|*
name|buf
argument_list|,
name|len
argument_list|)
comment|/* ??? */
operator|)
operator|==
name|NULL
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"get bridge address list: "
literal|" realloc failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|*
name|buf
argument_list|)
expr_stmt|;
operator|*
name|buf
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|bac
operator|.
name|ifbac_len
operator|=
name|len
expr_stmt|;
name|bac
operator|.
name|ifbac_buf
operator|=
operator|*
name|buf
operator|=
name|ninbuf
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|sock
argument_list|,
name|SIOCGDRVSPEC
argument_list|,
operator|&
name|ifd
argument_list|)
operator|<
literal|0
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"get bridge address list: "
literal|"ioctl(BRDGRTS) failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|*
name|buf
argument_list|)
expr_stmt|;
name|buf
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|bac
operator|.
name|ifbac_len
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|ifbareq
argument_list|)
operator|)
operator|<
name|len
condition|)
break|break;
name|len
operator|+=
literal|8192
expr_stmt|;
block|}
return|return
operator|(
name|bac
operator|.
name|ifbac_len
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Read the initial info for all addresses on a bridge interface.  * Returns the number of addresses, 0 - if none, otherwise  * -1 if some other error occured.  */
end_comment

begin_function
name|int
name|bridge_getinfo_bif_addrs
parameter_list|(
name|struct
name|bridge_if
modifier|*
name|bif
parameter_list|)
block|{
name|uint32_t
name|i
decl_stmt|;
name|int32_t
name|buf_len
decl_stmt|;
name|char
modifier|*
name|addr_buf
decl_stmt|;
name|struct
name|ifbareq
modifier|*
name|addr_req
decl_stmt|;
name|struct
name|tp_entry
modifier|*
name|te
decl_stmt|;
if|if
condition|(
operator|(
name|buf_len
operator|=
name|bridge_addrs_getinfo_ifalist
argument_list|(
name|bif
argument_list|,
operator|&
name|addr_buf
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|buf_len
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|ifbareq
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|addr_req
operator|=
operator|(
expr|struct
name|ifbareq
operator|*
operator|)
name|addr_buf
operator|+
name|i
expr_stmt|;
if|if
condition|(
operator|(
name|te
operator|=
name|bridge_new_addrs
argument_list|(
name|addr_req
operator|->
name|ifba_dst
argument_list|,
name|bif
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
name|bridge_addrs_info_ifaddrlist
argument_list|(
name|addr_req
argument_list|,
name|te
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|addr_buf
argument_list|)
expr_stmt|;
return|return
operator|(
name|i
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Update the addresses for the bridge interface.  */
end_comment

begin_function
name|int
name|bridge_update_addrs
parameter_list|(
name|struct
name|bridge_if
modifier|*
name|bif
parameter_list|)
block|{
name|int
name|added
decl_stmt|,
name|updated
decl_stmt|;
name|uint32_t
name|i
decl_stmt|;
name|int32_t
name|buf_len
decl_stmt|;
name|char
modifier|*
name|ifbad_buf
decl_stmt|;
name|struct
name|tp_entry
modifier|*
name|te
decl_stmt|,
modifier|*
name|te_next
decl_stmt|;
name|struct
name|ifbareq
modifier|*
name|a_req
decl_stmt|;
if|if
condition|(
operator|(
name|buf_len
operator|=
name|bridge_addrs_getinfo_ifalist
argument_list|(
name|bif
argument_list|,
operator|&
name|ifbad_buf
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|added
operator|=
name|updated
operator|=
literal|0
expr_stmt|;
define|#
directive|define
name|BA_FOUND
value|0x01
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|buf_len
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|ifbareq
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|a_req
operator|=
operator|(
expr|struct
name|ifbareq
operator|*
operator|)
name|ifbad_buf
operator|+
name|i
expr_stmt|;
if|if
condition|(
operator|(
name|te
operator|=
name|bridge_addrs_find
argument_list|(
name|a_req
operator|->
name|ifba_dst
argument_list|,
name|bif
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|added
operator|++
expr_stmt|;
if|if
condition|(
operator|(
name|te
operator|=
name|bridge_new_addrs
argument_list|(
name|a_req
operator|->
name|ifba_dst
argument_list|,
name|bif
argument_list|)
operator|)
operator|==
name|NULL
condition|)
continue|continue;
block|}
else|else
name|updated
operator|++
expr_stmt|;
name|bridge_addrs_info_ifaddrlist
argument_list|(
name|a_req
argument_list|,
name|te
argument_list|)
expr_stmt|;
name|te
operator|->
name|flags
operator||=
name|BA_FOUND
expr_stmt|;
block|}
name|free
argument_list|(
name|ifbad_buf
argument_list|)
expr_stmt|;
for|for
control|(
name|te
operator|=
name|bridge_addrs_bif_first
argument_list|(
name|bif
argument_list|)
init|;
name|te
operator|!=
name|NULL
condition|;
name|te
operator|=
name|te_next
control|)
block|{
name|te_next
operator|=
name|bridge_addrs_bif_next
argument_list|(
name|te
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|te
operator|->
name|flags
operator|&
name|BA_FOUND
operator|)
operator|==
literal|0
condition|)
name|bridge_addrs_remove
argument_list|(
name|te
argument_list|,
name|bif
argument_list|)
expr_stmt|;
else|else
name|te
operator|->
name|flags
operator|&=
operator|~
name|BA_FOUND
expr_stmt|;
block|}
undef|#
directive|undef
name|BA_FOUND
name|bif
operator|->
name|addrs_age
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
return|return
operator|(
name|updated
operator|+
name|added
operator|)
return|;
block|}
end_function

begin_comment
comment|/************************************************************************  * Bridge packet filtering.  */
end_comment

begin_decl_stmt
specifier|const
name|char
name|bridge_sysctl
index|[]
init|=
literal|"net.link.bridge."
decl_stmt|;
end_decl_stmt

begin_struct
specifier|static
struct|struct
block|{
name|int32_t
name|val
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
block|}
name|bridge_pf_sysctl
index|[]
init|=
block|{
block|{
literal|1
block|,
literal|"pfil_bridge"
block|}
block|,
block|{
literal|1
block|,
literal|"pfil_member"
block|}
block|,
block|{
literal|1
block|,
literal|"pfil_onlyip"
block|}
block|,
block|{
literal|0
block|,
literal|"ipfw"
block|}
block|, }
struct|;
end_struct

begin_function
name|int32_t
name|bridge_get_pfval
parameter_list|(
name|uint8_t
name|which
parameter_list|)
block|{
if|if
condition|(
name|which
operator|>
sizeof|sizeof
argument_list|(
name|bridge_pf_sysctl
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|bridge_pf_sysctl
index|[
literal|0
index|]
argument_list|)
operator|||
name|which
operator|<
literal|1
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
return|return
operator|(
name|bridge_pf_sysctl
index|[
name|which
operator|-
literal|1
index|]
operator|.
name|val
operator|)
return|;
block|}
end_function

begin_function
name|int32_t
name|bridge_do_pfctl
parameter_list|(
name|int32_t
name|bridge_ctl
parameter_list|,
name|enum
name|snmp_op
name|op
parameter_list|,
name|int32_t
modifier|*
name|val
parameter_list|)
block|{
name|char
name|mib_name
index|[
literal|100
index|]
decl_stmt|;
name|int32_t
name|i
decl_stmt|,
name|s_i
decl_stmt|;
name|size_t
name|len
decl_stmt|,
name|s_len
decl_stmt|;
if|if
condition|(
name|bridge_ctl
operator|>=
name|LEAF_begemotBridgeLayer2PfStatus
condition|)
return|return
operator|(
operator|-
literal|2
operator|)
return|;
if|if
condition|(
name|op
operator|==
name|SNMP_OP_SET
condition|)
block|{
name|s_i
operator|=
operator|*
name|val
expr_stmt|;
name|s_len
operator|=
sizeof|sizeof
argument_list|(
name|s_i
argument_list|)
expr_stmt|;
block|}
else|else
name|s_len
operator|=
literal|0
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
name|i
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|mib_name
argument_list|,
name|bridge_sysctl
argument_list|)
expr_stmt|;
if|if
condition|(
name|sysctlbyname
argument_list|(
name|strcat
argument_list|(
name|mib_name
argument_list|,
name|bridge_pf_sysctl
index|[
name|bridge_ctl
index|]
operator|.
name|name
argument_list|)
argument_list|,
operator|&
name|i
argument_list|,
operator|&
name|len
argument_list|,
operator|(
name|op
operator|==
name|SNMP_OP_SET
condition|?
operator|&
name|s_i
else|:
name|NULL
operator|)
argument_list|,
name|s_len
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"sysctl(%s%s) failed - %s"
argument_list|,
name|bridge_sysctl
argument_list|,
name|bridge_pf_sysctl
index|[
name|bridge_ctl
index|]
operator|.
name|name
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|bridge_pf_sysctl
index|[
name|bridge_ctl
index|]
operator|.
name|val
operator|=
name|i
expr_stmt|;
operator|*
name|val
operator|=
name|i
expr_stmt|;
return|return
operator|(
name|i
operator|)
return|;
block|}
end_function

begin_function
name|void
name|bridge_pf_dump
parameter_list|(
name|void
parameter_list|)
block|{
name|uint8_t
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|bridge_pf_sysctl
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|bridge_pf_sysctl
index|[
literal|0
index|]
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"%s%s = %d"
argument_list|,
name|bridge_sysctl
argument_list|,
name|bridge_pf_sysctl
index|[
name|i
index|]
operator|.
name|name
argument_list|,
name|bridge_pf_sysctl
index|[
name|i
index|]
operator|.
name|val
argument_list|)
expr_stmt|;
block|}
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2005 Philip Paeps<philip@FreeBSD.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<bsnmp/snmpmod.h>
end_include

begin_include
include|#
directive|include
file|<net/pfvar.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<stdint.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<syslog.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|"pf_oid.h"
end_include

begin_include
include|#
directive|include
file|"pf_tree.h"
end_include

begin_decl_stmt
name|struct
name|lmodule
modifier|*
name|module
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|dev
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|started
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|uint64_t
name|pf_tick
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|pf_status
name|pfs
decl_stmt|;
end_decl_stmt

begin_enum
enum|enum
block|{
name|IN
block|,
name|OUT
block|}
enum|;
end_enum

begin_enum
enum|enum
block|{
name|IPV4
block|,
name|IPV6
block|}
enum|;
end_enum

begin_enum
enum|enum
block|{
name|PASS
block|,
name|BLOCK
block|}
enum|;
end_enum

begin_define
define|#
directive|define
name|PFI_IFTYPE_GROUP
value|0
end_define

begin_define
define|#
directive|define
name|PFI_IFTYPE_INSTANCE
value|1
end_define

begin_define
define|#
directive|define
name|PFI_IFTYPE_DETACHED
value|2
end_define

begin_struct
struct|struct
name|pfi_entry
block|{
name|struct
name|pfi_kif
name|pfi
decl_stmt|;
name|u_int
name|index
decl_stmt|;
name|TAILQ_ENTRY
argument_list|(
argument|pfi_entry
argument_list|)
name|link
expr_stmt|;
block|}
struct|;
end_struct

begin_expr_stmt
name|TAILQ_HEAD
argument_list|(
name|pfi_table
argument_list|,
name|pfi_entry
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|struct
name|pfi_table
name|pfi_table
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|time_t
name|pfi_table_age
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|pfi_table_count
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|PFI_TABLE_MAXAGE
value|5
end_define

begin_struct
struct|struct
name|pft_entry
block|{
name|struct
name|pfr_tstats
name|pft
decl_stmt|;
name|u_int
name|index
decl_stmt|;
name|TAILQ_ENTRY
argument_list|(
argument|pft_entry
argument_list|)
name|link
expr_stmt|;
block|}
struct|;
end_struct

begin_expr_stmt
name|TAILQ_HEAD
argument_list|(
name|pft_table
argument_list|,
name|pft_entry
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|struct
name|pft_table
name|pft_table
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|time_t
name|pft_table_age
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|pft_table_count
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|PFT_TABLE_MAXAGE
value|5
end_define

begin_struct
struct|struct
name|pfq_entry
block|{
name|struct
name|pf_altq
name|altq
decl_stmt|;
name|u_int
name|index
decl_stmt|;
name|TAILQ_ENTRY
argument_list|(
argument|pfq_entry
argument_list|)
name|link
expr_stmt|;
block|}
struct|;
end_struct

begin_expr_stmt
name|TAILQ_HEAD
argument_list|(
name|pfq_table
argument_list|,
name|pfq_entry
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|struct
name|pfq_table
name|pfq_table
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|time_t
name|pfq_table_age
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|pfq_table_count
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|altq_enabled
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|PFQ_TABLE_MAXAGE
value|5
end_define

begin_comment
comment|/* Forward declarations */
end_comment

begin_function_decl
specifier|static
name|int
name|pfi_refresh
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|pfq_refresh
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|pfs_refresh
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|pft_refresh
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|pfi_entry
modifier|*
name|pfi_table_find
parameter_list|(
name|u_int
name|idx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|pfq_entry
modifier|*
name|pfq_table_find
parameter_list|(
name|u_int
name|idx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|pft_entry
modifier|*
name|pft_table_find
parameter_list|(
name|u_int
name|idx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|altq_is_enabled
parameter_list|(
name|int
name|pfdevice
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|int
name|pf_status
parameter_list|(
name|struct
name|snmp_context
name|__unused
modifier|*
name|ctx
parameter_list|,
name|struct
name|snmp_value
modifier|*
name|val
parameter_list|,
name|u_int
name|sub
parameter_list|,
name|u_int
name|__unused
name|vindex
parameter_list|,
name|enum
name|snmp_op
name|op
parameter_list|)
block|{
name|asn_subid_t
name|which
init|=
name|val
operator|->
name|var
operator|.
name|subs
index|[
name|sub
operator|-
literal|1
index|]
decl_stmt|;
name|time_t
name|runtime
decl_stmt|;
name|unsigned
name|char
name|str
index|[
literal|128
index|]
decl_stmt|;
if|if
condition|(
name|op
operator|==
name|SNMP_OP_SET
condition|)
return|return
operator|(
name|SNMP_ERR_NOT_WRITEABLE
operator|)
return|;
if|if
condition|(
name|op
operator|==
name|SNMP_OP_GET
condition|)
block|{
if|if
condition|(
name|pfs_refresh
argument_list|()
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
name|SNMP_ERR_GENERR
operator|)
return|;
switch|switch
condition|(
name|which
condition|)
block|{
case|case
name|LEAF_pfStatusRunning
case|:
name|val
operator|->
name|v
operator|.
name|uint32
operator|=
name|pfs
operator|.
name|running
expr_stmt|;
break|break;
case|case
name|LEAF_pfStatusRuntime
case|:
name|runtime
operator|=
operator|(
name|pfs
operator|.
name|since
operator|>
literal|0
operator|)
condition|?
name|time
argument_list|(
name|NULL
argument_list|)
operator|-
name|pfs
operator|.
name|since
else|:
literal|0
expr_stmt|;
name|val
operator|->
name|v
operator|.
name|uint32
operator|=
name|runtime
operator|*
literal|100
expr_stmt|;
break|break;
case|case
name|LEAF_pfStatusDebug
case|:
name|val
operator|->
name|v
operator|.
name|uint32
operator|=
name|pfs
operator|.
name|debug
expr_stmt|;
break|break;
case|case
name|LEAF_pfStatusHostId
case|:
name|sprintf
argument_list|(
name|str
argument_list|,
literal|"0x%08x"
argument_list|,
name|ntohl
argument_list|(
name|pfs
operator|.
name|hostid
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|string_get
argument_list|(
name|val
argument_list|,
name|str
argument_list|,
name|strlen
argument_list|(
name|str
argument_list|)
argument_list|)
operator|)
return|;
default|default:
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
block|}
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
block|}
name|abort
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|int
name|pf_counter
parameter_list|(
name|struct
name|snmp_context
name|__unused
modifier|*
name|ctx
parameter_list|,
name|struct
name|snmp_value
modifier|*
name|val
parameter_list|,
name|u_int
name|sub
parameter_list|,
name|u_int
name|__unused
name|vindex
parameter_list|,
name|enum
name|snmp_op
name|op
parameter_list|)
block|{
name|asn_subid_t
name|which
init|=
name|val
operator|->
name|var
operator|.
name|subs
index|[
name|sub
operator|-
literal|1
index|]
decl_stmt|;
if|if
condition|(
name|op
operator|==
name|SNMP_OP_SET
condition|)
return|return
operator|(
name|SNMP_ERR_NOT_WRITEABLE
operator|)
return|;
if|if
condition|(
name|op
operator|==
name|SNMP_OP_GET
condition|)
block|{
if|if
condition|(
name|pfs_refresh
argument_list|()
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
name|SNMP_ERR_GENERR
operator|)
return|;
switch|switch
condition|(
name|which
condition|)
block|{
case|case
name|LEAF_pfCounterMatch
case|:
name|val
operator|->
name|v
operator|.
name|counter64
operator|=
name|pfs
operator|.
name|counters
index|[
name|PFRES_MATCH
index|]
expr_stmt|;
break|break;
case|case
name|LEAF_pfCounterBadOffset
case|:
name|val
operator|->
name|v
operator|.
name|counter64
operator|=
name|pfs
operator|.
name|counters
index|[
name|PFRES_BADOFF
index|]
expr_stmt|;
break|break;
case|case
name|LEAF_pfCounterFragment
case|:
name|val
operator|->
name|v
operator|.
name|counter64
operator|=
name|pfs
operator|.
name|counters
index|[
name|PFRES_FRAG
index|]
expr_stmt|;
break|break;
case|case
name|LEAF_pfCounterShort
case|:
name|val
operator|->
name|v
operator|.
name|counter64
operator|=
name|pfs
operator|.
name|counters
index|[
name|PFRES_SHORT
index|]
expr_stmt|;
break|break;
case|case
name|LEAF_pfCounterNormalize
case|:
name|val
operator|->
name|v
operator|.
name|counter64
operator|=
name|pfs
operator|.
name|counters
index|[
name|PFRES_NORM
index|]
expr_stmt|;
break|break;
case|case
name|LEAF_pfCounterMemDrop
case|:
name|val
operator|->
name|v
operator|.
name|counter64
operator|=
name|pfs
operator|.
name|counters
index|[
name|PFRES_MEMORY
index|]
expr_stmt|;
break|break;
default|default:
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
block|}
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
block|}
name|abort
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|int
name|pf_statetable
parameter_list|(
name|struct
name|snmp_context
name|__unused
modifier|*
name|ctx
parameter_list|,
name|struct
name|snmp_value
modifier|*
name|val
parameter_list|,
name|u_int
name|sub
parameter_list|,
name|u_int
name|__unused
name|vindex
parameter_list|,
name|enum
name|snmp_op
name|op
parameter_list|)
block|{
name|asn_subid_t
name|which
init|=
name|val
operator|->
name|var
operator|.
name|subs
index|[
name|sub
operator|-
literal|1
index|]
decl_stmt|;
if|if
condition|(
name|op
operator|==
name|SNMP_OP_SET
condition|)
return|return
operator|(
name|SNMP_ERR_NOT_WRITEABLE
operator|)
return|;
if|if
condition|(
name|op
operator|==
name|SNMP_OP_GET
condition|)
block|{
if|if
condition|(
name|pfs_refresh
argument_list|()
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
name|SNMP_ERR_GENERR
operator|)
return|;
switch|switch
condition|(
name|which
condition|)
block|{
case|case
name|LEAF_pfStateTableCount
case|:
name|val
operator|->
name|v
operator|.
name|uint32
operator|=
name|pfs
operator|.
name|states
expr_stmt|;
break|break;
case|case
name|LEAF_pfStateTableSearches
case|:
name|val
operator|->
name|v
operator|.
name|counter64
operator|=
name|pfs
operator|.
name|fcounters
index|[
name|FCNT_STATE_SEARCH
index|]
expr_stmt|;
break|break;
case|case
name|LEAF_pfStateTableInserts
case|:
name|val
operator|->
name|v
operator|.
name|counter64
operator|=
name|pfs
operator|.
name|fcounters
index|[
name|FCNT_STATE_INSERT
index|]
expr_stmt|;
break|break;
case|case
name|LEAF_pfStateTableRemovals
case|:
name|val
operator|->
name|v
operator|.
name|counter64
operator|=
name|pfs
operator|.
name|fcounters
index|[
name|FCNT_STATE_REMOVALS
index|]
expr_stmt|;
break|break;
default|default:
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
block|}
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
block|}
name|abort
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|int
name|pf_srcnodes
parameter_list|(
name|struct
name|snmp_context
name|__unused
modifier|*
name|ctx
parameter_list|,
name|struct
name|snmp_value
modifier|*
name|val
parameter_list|,
name|u_int
name|sub
parameter_list|,
name|u_int
name|__unused
name|vindex
parameter_list|,
name|enum
name|snmp_op
name|op
parameter_list|)
block|{
name|asn_subid_t
name|which
init|=
name|val
operator|->
name|var
operator|.
name|subs
index|[
name|sub
operator|-
literal|1
index|]
decl_stmt|;
if|if
condition|(
name|op
operator|==
name|SNMP_OP_SET
condition|)
return|return
operator|(
name|SNMP_ERR_NOT_WRITEABLE
operator|)
return|;
if|if
condition|(
name|op
operator|==
name|SNMP_OP_GET
condition|)
block|{
if|if
condition|(
name|pfs_refresh
argument_list|()
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
name|SNMP_ERR_GENERR
operator|)
return|;
switch|switch
condition|(
name|which
condition|)
block|{
case|case
name|LEAF_pfSrcNodesCount
case|:
name|val
operator|->
name|v
operator|.
name|uint32
operator|=
name|pfs
operator|.
name|src_nodes
expr_stmt|;
break|break;
case|case
name|LEAF_pfSrcNodesSearches
case|:
name|val
operator|->
name|v
operator|.
name|counter64
operator|=
name|pfs
operator|.
name|scounters
index|[
name|SCNT_SRC_NODE_SEARCH
index|]
expr_stmt|;
break|break;
case|case
name|LEAF_pfSrcNodesInserts
case|:
name|val
operator|->
name|v
operator|.
name|counter64
operator|=
name|pfs
operator|.
name|scounters
index|[
name|SCNT_SRC_NODE_INSERT
index|]
expr_stmt|;
break|break;
case|case
name|LEAF_pfSrcNodesRemovals
case|:
name|val
operator|->
name|v
operator|.
name|counter64
operator|=
name|pfs
operator|.
name|scounters
index|[
name|SCNT_SRC_NODE_REMOVALS
index|]
expr_stmt|;
break|break;
default|default:
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
block|}
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
block|}
name|abort
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|int
name|pf_limits
parameter_list|(
name|struct
name|snmp_context
name|__unused
modifier|*
name|ctx
parameter_list|,
name|struct
name|snmp_value
modifier|*
name|val
parameter_list|,
name|u_int
name|sub
parameter_list|,
name|u_int
name|__unused
name|vindex
parameter_list|,
name|enum
name|snmp_op
name|op
parameter_list|)
block|{
name|asn_subid_t
name|which
init|=
name|val
operator|->
name|var
operator|.
name|subs
index|[
name|sub
operator|-
literal|1
index|]
decl_stmt|;
name|struct
name|pfioc_limit
name|pl
decl_stmt|;
if|if
condition|(
name|op
operator|==
name|SNMP_OP_SET
condition|)
return|return
operator|(
name|SNMP_ERR_NOT_WRITEABLE
operator|)
return|;
if|if
condition|(
name|op
operator|==
name|SNMP_OP_GET
condition|)
block|{
name|bzero
argument_list|(
operator|&
name|pl
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|pfioc_limit
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|which
condition|)
block|{
case|case
name|LEAF_pfLimitsStates
case|:
name|pl
operator|.
name|index
operator|=
name|PF_LIMIT_STATES
expr_stmt|;
break|break;
case|case
name|LEAF_pfLimitsSrcNodes
case|:
name|pl
operator|.
name|index
operator|=
name|PF_LIMIT_SRC_NODES
expr_stmt|;
break|break;
case|case
name|LEAF_pfLimitsFrags
case|:
name|pl
operator|.
name|index
operator|=
name|PF_LIMIT_FRAGS
expr_stmt|;
break|break;
default|default:
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
block|}
if|if
condition|(
name|ioctl
argument_list|(
name|dev
argument_list|,
name|DIOCGETLIMIT
argument_list|,
operator|&
name|pl
argument_list|)
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"pf_limits(): ioctl(): %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|SNMP_ERR_GENERR
operator|)
return|;
block|}
name|val
operator|->
name|v
operator|.
name|uint32
operator|=
name|pl
operator|.
name|limit
expr_stmt|;
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
block|}
name|abort
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|int
name|pf_timeouts
parameter_list|(
name|struct
name|snmp_context
name|__unused
modifier|*
name|ctx
parameter_list|,
name|struct
name|snmp_value
modifier|*
name|val
parameter_list|,
name|u_int
name|sub
parameter_list|,
name|u_int
name|__unused
name|vindex
parameter_list|,
name|enum
name|snmp_op
name|op
parameter_list|)
block|{
name|asn_subid_t
name|which
init|=
name|val
operator|->
name|var
operator|.
name|subs
index|[
name|sub
operator|-
literal|1
index|]
decl_stmt|;
name|struct
name|pfioc_tm
name|pt
decl_stmt|;
if|if
condition|(
name|op
operator|==
name|SNMP_OP_SET
condition|)
return|return
operator|(
name|SNMP_ERR_NOT_WRITEABLE
operator|)
return|;
if|if
condition|(
name|op
operator|==
name|SNMP_OP_GET
condition|)
block|{
name|bzero
argument_list|(
operator|&
name|pt
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|pfioc_tm
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|which
condition|)
block|{
case|case
name|LEAF_pfTimeoutsTcpFirst
case|:
name|pt
operator|.
name|timeout
operator|=
name|PFTM_TCP_FIRST_PACKET
expr_stmt|;
break|break;
case|case
name|LEAF_pfTimeoutsTcpOpening
case|:
name|pt
operator|.
name|timeout
operator|=
name|PFTM_TCP_OPENING
expr_stmt|;
break|break;
case|case
name|LEAF_pfTimeoutsTcpEstablished
case|:
name|pt
operator|.
name|timeout
operator|=
name|PFTM_TCP_ESTABLISHED
expr_stmt|;
break|break;
case|case
name|LEAF_pfTimeoutsTcpClosing
case|:
name|pt
operator|.
name|timeout
operator|=
name|PFTM_TCP_CLOSING
expr_stmt|;
break|break;
case|case
name|LEAF_pfTimeoutsTcpFinWait
case|:
name|pt
operator|.
name|timeout
operator|=
name|PFTM_TCP_FIN_WAIT
expr_stmt|;
break|break;
case|case
name|LEAF_pfTimeoutsTcpClosed
case|:
name|pt
operator|.
name|timeout
operator|=
name|PFTM_TCP_CLOSED
expr_stmt|;
break|break;
case|case
name|LEAF_pfTimeoutsUdpFirst
case|:
name|pt
operator|.
name|timeout
operator|=
name|PFTM_UDP_FIRST_PACKET
expr_stmt|;
break|break;
case|case
name|LEAF_pfTimeoutsUdpSingle
case|:
name|pt
operator|.
name|timeout
operator|=
name|PFTM_UDP_SINGLE
expr_stmt|;
break|break;
case|case
name|LEAF_pfTimeoutsUdpMultiple
case|:
name|pt
operator|.
name|timeout
operator|=
name|PFTM_UDP_MULTIPLE
expr_stmt|;
break|break;
case|case
name|LEAF_pfTimeoutsIcmpFirst
case|:
name|pt
operator|.
name|timeout
operator|=
name|PFTM_ICMP_FIRST_PACKET
expr_stmt|;
break|break;
case|case
name|LEAF_pfTimeoutsIcmpError
case|:
name|pt
operator|.
name|timeout
operator|=
name|PFTM_ICMP_ERROR_REPLY
expr_stmt|;
break|break;
case|case
name|LEAF_pfTimeoutsOtherFirst
case|:
name|pt
operator|.
name|timeout
operator|=
name|PFTM_OTHER_FIRST_PACKET
expr_stmt|;
break|break;
case|case
name|LEAF_pfTimeoutsOtherSingle
case|:
name|pt
operator|.
name|timeout
operator|=
name|PFTM_OTHER_SINGLE
expr_stmt|;
break|break;
case|case
name|LEAF_pfTimeoutsOtherMultiple
case|:
name|pt
operator|.
name|timeout
operator|=
name|PFTM_OTHER_MULTIPLE
expr_stmt|;
break|break;
case|case
name|LEAF_pfTimeoutsFragment
case|:
name|pt
operator|.
name|timeout
operator|=
name|PFTM_FRAG
expr_stmt|;
break|break;
case|case
name|LEAF_pfTimeoutsInterval
case|:
name|pt
operator|.
name|timeout
operator|=
name|PFTM_INTERVAL
expr_stmt|;
break|break;
case|case
name|LEAF_pfTimeoutsAdaptiveStart
case|:
name|pt
operator|.
name|timeout
operator|=
name|PFTM_ADAPTIVE_START
expr_stmt|;
break|break;
case|case
name|LEAF_pfTimeoutsAdaptiveEnd
case|:
name|pt
operator|.
name|timeout
operator|=
name|PFTM_ADAPTIVE_END
expr_stmt|;
break|break;
case|case
name|LEAF_pfTimeoutsSrcNode
case|:
name|pt
operator|.
name|timeout
operator|=
name|PFTM_SRC_NODE
expr_stmt|;
break|break;
default|default:
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
block|}
if|if
condition|(
name|ioctl
argument_list|(
name|dev
argument_list|,
name|DIOCGETTIMEOUT
argument_list|,
operator|&
name|pt
argument_list|)
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"pf_timeouts(): ioctl(): %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|SNMP_ERR_GENERR
operator|)
return|;
block|}
name|val
operator|->
name|v
operator|.
name|integer
operator|=
name|pt
operator|.
name|seconds
expr_stmt|;
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
block|}
name|abort
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|int
name|pf_logif
parameter_list|(
name|struct
name|snmp_context
name|__unused
modifier|*
name|ctx
parameter_list|,
name|struct
name|snmp_value
modifier|*
name|val
parameter_list|,
name|u_int
name|sub
parameter_list|,
name|u_int
name|__unused
name|vindex
parameter_list|,
name|enum
name|snmp_op
name|op
parameter_list|)
block|{
name|asn_subid_t
name|which
init|=
name|val
operator|->
name|var
operator|.
name|subs
index|[
name|sub
operator|-
literal|1
index|]
decl_stmt|;
name|unsigned
name|char
name|str
index|[
name|IFNAMSIZ
index|]
decl_stmt|;
if|if
condition|(
name|op
operator|==
name|SNMP_OP_SET
condition|)
return|return
operator|(
name|SNMP_ERR_NOT_WRITEABLE
operator|)
return|;
if|if
condition|(
name|op
operator|==
name|SNMP_OP_GET
condition|)
block|{
if|if
condition|(
name|pfs_refresh
argument_list|()
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
name|SNMP_ERR_GENERR
operator|)
return|;
switch|switch
condition|(
name|which
condition|)
block|{
case|case
name|LEAF_pfLogInterfaceName
case|:
name|strlcpy
argument_list|(
name|str
argument_list|,
name|pfs
operator|.
name|ifname
argument_list|,
sizeof|sizeof
name|str
argument_list|)
expr_stmt|;
return|return
operator|(
name|string_get
argument_list|(
name|val
argument_list|,
name|str
argument_list|,
name|strlen
argument_list|(
name|str
argument_list|)
argument_list|)
operator|)
return|;
case|case
name|LEAF_pfLogInterfaceIp4BytesIn
case|:
name|val
operator|->
name|v
operator|.
name|counter64
operator|=
name|pfs
operator|.
name|bcounters
index|[
name|IPV4
index|]
index|[
name|IN
index|]
expr_stmt|;
break|break;
case|case
name|LEAF_pfLogInterfaceIp4BytesOut
case|:
name|val
operator|->
name|v
operator|.
name|counter64
operator|=
name|pfs
operator|.
name|bcounters
index|[
name|IPV4
index|]
index|[
name|OUT
index|]
expr_stmt|;
break|break;
case|case
name|LEAF_pfLogInterfaceIp4PktsInPass
case|:
name|val
operator|->
name|v
operator|.
name|counter64
operator|=
name|pfs
operator|.
name|pcounters
index|[
name|IPV4
index|]
index|[
name|IN
index|]
index|[
name|PF_PASS
index|]
expr_stmt|;
break|break;
case|case
name|LEAF_pfLogInterfaceIp4PktsInDrop
case|:
name|val
operator|->
name|v
operator|.
name|counter64
operator|=
name|pfs
operator|.
name|pcounters
index|[
name|IPV4
index|]
index|[
name|IN
index|]
index|[
name|PF_DROP
index|]
expr_stmt|;
break|break;
case|case
name|LEAF_pfLogInterfaceIp4PktsOutPass
case|:
name|val
operator|->
name|v
operator|.
name|counter64
operator|=
name|pfs
operator|.
name|pcounters
index|[
name|IPV4
index|]
index|[
name|OUT
index|]
index|[
name|PF_PASS
index|]
expr_stmt|;
break|break;
case|case
name|LEAF_pfLogInterfaceIp4PktsOutDrop
case|:
name|val
operator|->
name|v
operator|.
name|counter64
operator|=
name|pfs
operator|.
name|pcounters
index|[
name|IPV4
index|]
index|[
name|OUT
index|]
index|[
name|PF_DROP
index|]
expr_stmt|;
break|break;
case|case
name|LEAF_pfLogInterfaceIp6BytesIn
case|:
name|val
operator|->
name|v
operator|.
name|counter64
operator|=
name|pfs
operator|.
name|bcounters
index|[
name|IPV6
index|]
index|[
name|IN
index|]
expr_stmt|;
break|break;
case|case
name|LEAF_pfLogInterfaceIp6BytesOut
case|:
name|val
operator|->
name|v
operator|.
name|counter64
operator|=
name|pfs
operator|.
name|bcounters
index|[
name|IPV6
index|]
index|[
name|OUT
index|]
expr_stmt|;
break|break;
case|case
name|LEAF_pfLogInterfaceIp6PktsInPass
case|:
name|val
operator|->
name|v
operator|.
name|counter64
operator|=
name|pfs
operator|.
name|pcounters
index|[
name|IPV6
index|]
index|[
name|IN
index|]
index|[
name|PF_PASS
index|]
expr_stmt|;
break|break;
case|case
name|LEAF_pfLogInterfaceIp6PktsInDrop
case|:
name|val
operator|->
name|v
operator|.
name|counter64
operator|=
name|pfs
operator|.
name|pcounters
index|[
name|IPV6
index|]
index|[
name|IN
index|]
index|[
name|PF_DROP
index|]
expr_stmt|;
break|break;
case|case
name|LEAF_pfLogInterfaceIp6PktsOutPass
case|:
name|val
operator|->
name|v
operator|.
name|counter64
operator|=
name|pfs
operator|.
name|pcounters
index|[
name|IPV6
index|]
index|[
name|OUT
index|]
index|[
name|PF_PASS
index|]
expr_stmt|;
break|break;
case|case
name|LEAF_pfLogInterfaceIp6PktsOutDrop
case|:
name|val
operator|->
name|v
operator|.
name|counter64
operator|=
name|pfs
operator|.
name|pcounters
index|[
name|IPV6
index|]
index|[
name|OUT
index|]
index|[
name|PF_DROP
index|]
expr_stmt|;
break|break;
default|default:
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
block|}
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
block|}
name|abort
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|int
name|pf_interfaces
parameter_list|(
name|struct
name|snmp_context
name|__unused
modifier|*
name|ctx
parameter_list|,
name|struct
name|snmp_value
modifier|*
name|val
parameter_list|,
name|u_int
name|sub
parameter_list|,
name|u_int
name|__unused
name|vindex
parameter_list|,
name|enum
name|snmp_op
name|op
parameter_list|)
block|{
name|asn_subid_t
name|which
init|=
name|val
operator|->
name|var
operator|.
name|subs
index|[
name|sub
operator|-
literal|1
index|]
decl_stmt|;
if|if
condition|(
name|op
operator|==
name|SNMP_OP_SET
condition|)
return|return
operator|(
name|SNMP_ERR_NOT_WRITEABLE
operator|)
return|;
if|if
condition|(
name|op
operator|==
name|SNMP_OP_GET
condition|)
block|{
if|if
condition|(
operator|(
name|time
argument_list|(
name|NULL
argument_list|)
operator|-
name|pfi_table_age
operator|)
operator|>
name|PFI_TABLE_MAXAGE
condition|)
if|if
condition|(
name|pfi_refresh
argument_list|()
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
name|SNMP_ERR_GENERR
operator|)
return|;
switch|switch
condition|(
name|which
condition|)
block|{
case|case
name|LEAF_pfInterfacesIfNumber
case|:
name|val
operator|->
name|v
operator|.
name|uint32
operator|=
name|pfi_table_count
expr_stmt|;
break|break;
default|default:
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
block|}
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
block|}
name|abort
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|int
name|pf_iftable
parameter_list|(
name|struct
name|snmp_context
name|__unused
modifier|*
name|ctx
parameter_list|,
name|struct
name|snmp_value
modifier|*
name|val
parameter_list|,
name|u_int
name|sub
parameter_list|,
name|u_int
name|__unused
name|vindex
parameter_list|,
name|enum
name|snmp_op
name|op
parameter_list|)
block|{
name|asn_subid_t
name|which
init|=
name|val
operator|->
name|var
operator|.
name|subs
index|[
name|sub
operator|-
literal|1
index|]
decl_stmt|;
name|struct
name|pfi_entry
modifier|*
name|e
init|=
name|NULL
decl_stmt|;
switch|switch
condition|(
name|op
condition|)
block|{
case|case
name|SNMP_OP_SET
case|:
return|return
operator|(
name|SNMP_ERR_NOT_WRITEABLE
operator|)
return|;
case|case
name|SNMP_OP_GETNEXT
case|:
if|if
condition|(
operator|(
name|e
operator|=
name|NEXT_OBJECT_INT
argument_list|(
operator|&
name|pfi_table
argument_list|,
operator|&
name|val
operator|->
name|var
argument_list|,
name|sub
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
name|val
operator|->
name|var
operator|.
name|len
operator|=
name|sub
operator|+
literal|1
expr_stmt|;
name|val
operator|->
name|var
operator|.
name|subs
index|[
name|sub
index|]
operator|=
name|e
operator|->
name|index
expr_stmt|;
break|break;
case|case
name|SNMP_OP_GET
case|:
if|if
condition|(
name|val
operator|->
name|var
operator|.
name|len
operator|-
name|sub
operator|!=
literal|1
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
if|if
condition|(
operator|(
name|e
operator|=
name|pfi_table_find
argument_list|(
name|val
operator|->
name|var
operator|.
name|subs
index|[
name|sub
index|]
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
break|break;
case|case
name|SNMP_OP_COMMIT
case|:
case|case
name|SNMP_OP_ROLLBACK
case|:
default|default:
name|abort
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|time
argument_list|(
name|NULL
argument_list|)
operator|-
name|pfi_table_age
operator|)
operator|>
name|PFI_TABLE_MAXAGE
condition|)
name|pfi_refresh
argument_list|()
expr_stmt|;
switch|switch
condition|(
name|which
condition|)
block|{
case|case
name|LEAF_pfInterfacesIfDescr
case|:
return|return
operator|(
name|string_get
argument_list|(
name|val
argument_list|,
name|e
operator|->
name|pfi
operator|.
name|pfik_name
argument_list|,
operator|-
literal|1
argument_list|)
operator|)
return|;
case|case
name|LEAF_pfInterfacesIfType
case|:
name|val
operator|->
name|v
operator|.
name|integer
operator|=
name|PFI_IFTYPE_INSTANCE
expr_stmt|;
break|break;
case|case
name|LEAF_pfInterfacesIfTZero
case|:
name|val
operator|->
name|v
operator|.
name|uint32
operator|=
operator|(
name|time
argument_list|(
name|NULL
argument_list|)
operator|-
name|e
operator|->
name|pfi
operator|.
name|pfik_tzero
operator|)
operator|*
literal|100
expr_stmt|;
break|break;
case|case
name|LEAF_pfInterfacesIfRefsState
case|:
name|val
operator|->
name|v
operator|.
name|uint32
operator|=
name|e
operator|->
name|pfi
operator|.
name|pfik_states
expr_stmt|;
break|break;
case|case
name|LEAF_pfInterfacesIfRefsRule
case|:
name|val
operator|->
name|v
operator|.
name|uint32
operator|=
name|e
operator|->
name|pfi
operator|.
name|pfik_rules
expr_stmt|;
break|break;
case|case
name|LEAF_pfInterfacesIf4BytesInPass
case|:
name|val
operator|->
name|v
operator|.
name|counter64
operator|=
name|e
operator|->
name|pfi
operator|.
name|pfik_bytes
index|[
name|IPV4
index|]
index|[
name|IN
index|]
index|[
name|PASS
index|]
expr_stmt|;
break|break;
case|case
name|LEAF_pfInterfacesIf4BytesInBlock
case|:
name|val
operator|->
name|v
operator|.
name|counter64
operator|=
name|e
operator|->
name|pfi
operator|.
name|pfik_bytes
index|[
name|IPV4
index|]
index|[
name|IN
index|]
index|[
name|BLOCK
index|]
expr_stmt|;
break|break;
case|case
name|LEAF_pfInterfacesIf4BytesOutPass
case|:
name|val
operator|->
name|v
operator|.
name|counter64
operator|=
name|e
operator|->
name|pfi
operator|.
name|pfik_bytes
index|[
name|IPV4
index|]
index|[
name|OUT
index|]
index|[
name|PASS
index|]
expr_stmt|;
break|break;
case|case
name|LEAF_pfInterfacesIf4BytesOutBlock
case|:
name|val
operator|->
name|v
operator|.
name|counter64
operator|=
name|e
operator|->
name|pfi
operator|.
name|pfik_bytes
index|[
name|IPV4
index|]
index|[
name|OUT
index|]
index|[
name|BLOCK
index|]
expr_stmt|;
break|break;
case|case
name|LEAF_pfInterfacesIf4PktsInPass
case|:
name|val
operator|->
name|v
operator|.
name|counter64
operator|=
name|e
operator|->
name|pfi
operator|.
name|pfik_packets
index|[
name|IPV4
index|]
index|[
name|IN
index|]
index|[
name|PASS
index|]
expr_stmt|;
break|break;
case|case
name|LEAF_pfInterfacesIf4PktsInBlock
case|:
name|val
operator|->
name|v
operator|.
name|counter64
operator|=
name|e
operator|->
name|pfi
operator|.
name|pfik_packets
index|[
name|IPV4
index|]
index|[
name|IN
index|]
index|[
name|BLOCK
index|]
expr_stmt|;
break|break;
case|case
name|LEAF_pfInterfacesIf4PktsOutPass
case|:
name|val
operator|->
name|v
operator|.
name|counter64
operator|=
name|e
operator|->
name|pfi
operator|.
name|pfik_packets
index|[
name|IPV4
index|]
index|[
name|OUT
index|]
index|[
name|PASS
index|]
expr_stmt|;
break|break;
case|case
name|LEAF_pfInterfacesIf4PktsOutBlock
case|:
name|val
operator|->
name|v
operator|.
name|counter64
operator|=
name|e
operator|->
name|pfi
operator|.
name|pfik_packets
index|[
name|IPV4
index|]
index|[
name|OUT
index|]
index|[
name|BLOCK
index|]
expr_stmt|;
break|break;
case|case
name|LEAF_pfInterfacesIf6BytesInPass
case|:
name|val
operator|->
name|v
operator|.
name|counter64
operator|=
name|e
operator|->
name|pfi
operator|.
name|pfik_bytes
index|[
name|IPV6
index|]
index|[
name|IN
index|]
index|[
name|PASS
index|]
expr_stmt|;
break|break;
case|case
name|LEAF_pfInterfacesIf6BytesInBlock
case|:
name|val
operator|->
name|v
operator|.
name|counter64
operator|=
name|e
operator|->
name|pfi
operator|.
name|pfik_bytes
index|[
name|IPV6
index|]
index|[
name|IN
index|]
index|[
name|BLOCK
index|]
expr_stmt|;
break|break;
case|case
name|LEAF_pfInterfacesIf6BytesOutPass
case|:
name|val
operator|->
name|v
operator|.
name|counter64
operator|=
name|e
operator|->
name|pfi
operator|.
name|pfik_bytes
index|[
name|IPV6
index|]
index|[
name|OUT
index|]
index|[
name|PASS
index|]
expr_stmt|;
break|break;
case|case
name|LEAF_pfInterfacesIf6BytesOutBlock
case|:
name|val
operator|->
name|v
operator|.
name|counter64
operator|=
name|e
operator|->
name|pfi
operator|.
name|pfik_bytes
index|[
name|IPV6
index|]
index|[
name|OUT
index|]
index|[
name|BLOCK
index|]
expr_stmt|;
break|break;
case|case
name|LEAF_pfInterfacesIf6PktsInPass
case|:
name|val
operator|->
name|v
operator|.
name|counter64
operator|=
name|e
operator|->
name|pfi
operator|.
name|pfik_packets
index|[
name|IPV6
index|]
index|[
name|IN
index|]
index|[
name|PASS
index|]
expr_stmt|;
break|break;
case|case
name|LEAF_pfInterfacesIf6PktsInBlock
case|:
name|val
operator|->
name|v
operator|.
name|counter64
operator|=
name|e
operator|->
name|pfi
operator|.
name|pfik_packets
index|[
name|IPV6
index|]
index|[
name|IN
index|]
index|[
name|BLOCK
index|]
expr_stmt|;
break|break;
case|case
name|LEAF_pfInterfacesIf6PktsOutPass
case|:
name|val
operator|->
name|v
operator|.
name|counter64
operator|=
name|e
operator|->
name|pfi
operator|.
name|pfik_packets
index|[
name|IPV6
index|]
index|[
name|OUT
index|]
index|[
name|PASS
index|]
expr_stmt|;
break|break;
case|case
name|LEAF_pfInterfacesIf6PktsOutBlock
case|:
name|val
operator|->
name|v
operator|.
name|counter64
operator|=
name|e
operator|->
name|pfi
operator|.
name|pfik_packets
index|[
name|IPV6
index|]
index|[
name|OUT
index|]
index|[
name|BLOCK
index|]
expr_stmt|;
break|break;
default|default:
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
block|}
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
block|}
end_function

begin_function
name|int
name|pf_tables
parameter_list|(
name|struct
name|snmp_context
name|__unused
modifier|*
name|ctx
parameter_list|,
name|struct
name|snmp_value
modifier|*
name|val
parameter_list|,
name|u_int
name|sub
parameter_list|,
name|u_int
name|__unused
name|vindex
parameter_list|,
name|enum
name|snmp_op
name|op
parameter_list|)
block|{
name|asn_subid_t
name|which
init|=
name|val
operator|->
name|var
operator|.
name|subs
index|[
name|sub
operator|-
literal|1
index|]
decl_stmt|;
if|if
condition|(
name|op
operator|==
name|SNMP_OP_SET
condition|)
return|return
operator|(
name|SNMP_ERR_NOT_WRITEABLE
operator|)
return|;
if|if
condition|(
name|op
operator|==
name|SNMP_OP_GET
condition|)
block|{
if|if
condition|(
operator|(
name|time
argument_list|(
name|NULL
argument_list|)
operator|-
name|pft_table_age
operator|)
operator|>
name|PFT_TABLE_MAXAGE
condition|)
if|if
condition|(
name|pft_refresh
argument_list|()
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
name|SNMP_ERR_GENERR
operator|)
return|;
switch|switch
condition|(
name|which
condition|)
block|{
case|case
name|LEAF_pfTablesTblNumber
case|:
name|val
operator|->
name|v
operator|.
name|uint32
operator|=
name|pft_table_count
expr_stmt|;
break|break;
default|default:
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
block|}
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
block|}
name|abort
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|int
name|pf_tbltable
parameter_list|(
name|struct
name|snmp_context
name|__unused
modifier|*
name|ctx
parameter_list|,
name|struct
name|snmp_value
modifier|*
name|val
parameter_list|,
name|u_int
name|sub
parameter_list|,
name|u_int
name|__unused
name|vindex
parameter_list|,
name|enum
name|snmp_op
name|op
parameter_list|)
block|{
name|asn_subid_t
name|which
init|=
name|val
operator|->
name|var
operator|.
name|subs
index|[
name|sub
operator|-
literal|1
index|]
decl_stmt|;
name|struct
name|pft_entry
modifier|*
name|e
init|=
name|NULL
decl_stmt|;
switch|switch
condition|(
name|op
condition|)
block|{
case|case
name|SNMP_OP_SET
case|:
return|return
operator|(
name|SNMP_ERR_NOT_WRITEABLE
operator|)
return|;
case|case
name|SNMP_OP_GETNEXT
case|:
if|if
condition|(
operator|(
name|e
operator|=
name|NEXT_OBJECT_INT
argument_list|(
operator|&
name|pft_table
argument_list|,
operator|&
name|val
operator|->
name|var
argument_list|,
name|sub
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
name|val
operator|->
name|var
operator|.
name|len
operator|=
name|sub
operator|+
literal|1
expr_stmt|;
name|val
operator|->
name|var
operator|.
name|subs
index|[
name|sub
index|]
operator|=
name|e
operator|->
name|index
expr_stmt|;
break|break;
case|case
name|SNMP_OP_GET
case|:
if|if
condition|(
name|val
operator|->
name|var
operator|.
name|len
operator|-
name|sub
operator|!=
literal|1
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
if|if
condition|(
operator|(
name|e
operator|=
name|pft_table_find
argument_list|(
name|val
operator|->
name|var
operator|.
name|subs
index|[
name|sub
index|]
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
break|break;
case|case
name|SNMP_OP_COMMIT
case|:
case|case
name|SNMP_OP_ROLLBACK
case|:
default|default:
name|abort
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|time
argument_list|(
name|NULL
argument_list|)
operator|-
name|pft_table_age
operator|)
operator|>
name|PFT_TABLE_MAXAGE
condition|)
name|pft_refresh
argument_list|()
expr_stmt|;
switch|switch
condition|(
name|which
condition|)
block|{
case|case
name|LEAF_pfTablesTblDescr
case|:
return|return
operator|(
name|string_get
argument_list|(
name|val
argument_list|,
name|e
operator|->
name|pft
operator|.
name|pfrts_name
argument_list|,
operator|-
literal|1
argument_list|)
operator|)
return|;
case|case
name|LEAF_pfTablesTblCount
case|:
name|val
operator|->
name|v
operator|.
name|integer
operator|=
name|e
operator|->
name|pft
operator|.
name|pfrts_cnt
expr_stmt|;
break|break;
case|case
name|LEAF_pfTablesTblTZero
case|:
name|val
operator|->
name|v
operator|.
name|uint32
operator|=
operator|(
name|time
argument_list|(
name|NULL
argument_list|)
operator|-
name|e
operator|->
name|pft
operator|.
name|pfrts_tzero
operator|)
operator|*
literal|100
expr_stmt|;
break|break;
case|case
name|LEAF_pfTablesTblRefsAnchor
case|:
name|val
operator|->
name|v
operator|.
name|integer
operator|=
name|e
operator|->
name|pft
operator|.
name|pfrts_refcnt
index|[
name|PFR_REFCNT_ANCHOR
index|]
expr_stmt|;
break|break;
case|case
name|LEAF_pfTablesTblRefsRule
case|:
name|val
operator|->
name|v
operator|.
name|integer
operator|=
name|e
operator|->
name|pft
operator|.
name|pfrts_refcnt
index|[
name|PFR_REFCNT_RULE
index|]
expr_stmt|;
break|break;
case|case
name|LEAF_pfTablesTblEvalMatch
case|:
name|val
operator|->
name|v
operator|.
name|counter64
operator|=
name|e
operator|->
name|pft
operator|.
name|pfrts_match
expr_stmt|;
break|break;
case|case
name|LEAF_pfTablesTblEvalNoMatch
case|:
name|val
operator|->
name|v
operator|.
name|counter64
operator|=
name|e
operator|->
name|pft
operator|.
name|pfrts_nomatch
expr_stmt|;
break|break;
case|case
name|LEAF_pfTablesTblBytesInPass
case|:
name|val
operator|->
name|v
operator|.
name|counter64
operator|=
name|e
operator|->
name|pft
operator|.
name|pfrts_bytes
index|[
name|PFR_DIR_IN
index|]
index|[
name|PFR_OP_PASS
index|]
expr_stmt|;
break|break;
case|case
name|LEAF_pfTablesTblBytesInBlock
case|:
name|val
operator|->
name|v
operator|.
name|counter64
operator|=
name|e
operator|->
name|pft
operator|.
name|pfrts_bytes
index|[
name|PFR_DIR_IN
index|]
index|[
name|PFR_OP_BLOCK
index|]
expr_stmt|;
break|break;
case|case
name|LEAF_pfTablesTblBytesInXPass
case|:
name|val
operator|->
name|v
operator|.
name|counter64
operator|=
name|e
operator|->
name|pft
operator|.
name|pfrts_bytes
index|[
name|PFR_DIR_IN
index|]
index|[
name|PFR_OP_XPASS
index|]
expr_stmt|;
break|break;
case|case
name|LEAF_pfTablesTblBytesOutPass
case|:
name|val
operator|->
name|v
operator|.
name|counter64
operator|=
name|e
operator|->
name|pft
operator|.
name|pfrts_bytes
index|[
name|PFR_DIR_OUT
index|]
index|[
name|PFR_OP_PASS
index|]
expr_stmt|;
break|break;
case|case
name|LEAF_pfTablesTblBytesOutBlock
case|:
name|val
operator|->
name|v
operator|.
name|counter64
operator|=
name|e
operator|->
name|pft
operator|.
name|pfrts_bytes
index|[
name|PFR_DIR_OUT
index|]
index|[
name|PFR_OP_BLOCK
index|]
expr_stmt|;
break|break;
case|case
name|LEAF_pfTablesTblBytesOutXPass
case|:
name|val
operator|->
name|v
operator|.
name|counter64
operator|=
name|e
operator|->
name|pft
operator|.
name|pfrts_bytes
index|[
name|PFR_DIR_OUT
index|]
index|[
name|PFR_OP_XPASS
index|]
expr_stmt|;
break|break;
case|case
name|LEAF_pfTablesTblPktsInPass
case|:
name|val
operator|->
name|v
operator|.
name|counter64
operator|=
name|e
operator|->
name|pft
operator|.
name|pfrts_packets
index|[
name|PFR_DIR_IN
index|]
index|[
name|PFR_OP_PASS
index|]
expr_stmt|;
break|break;
case|case
name|LEAF_pfTablesTblPktsInBlock
case|:
name|val
operator|->
name|v
operator|.
name|counter64
operator|=
name|e
operator|->
name|pft
operator|.
name|pfrts_packets
index|[
name|PFR_DIR_IN
index|]
index|[
name|PFR_OP_BLOCK
index|]
expr_stmt|;
break|break;
case|case
name|LEAF_pfTablesTblPktsInXPass
case|:
name|val
operator|->
name|v
operator|.
name|counter64
operator|=
name|e
operator|->
name|pft
operator|.
name|pfrts_packets
index|[
name|PFR_DIR_IN
index|]
index|[
name|PFR_OP_XPASS
index|]
expr_stmt|;
break|break;
case|case
name|LEAF_pfTablesTblPktsOutPass
case|:
name|val
operator|->
name|v
operator|.
name|counter64
operator|=
name|e
operator|->
name|pft
operator|.
name|pfrts_packets
index|[
name|PFR_DIR_OUT
index|]
index|[
name|PFR_OP_PASS
index|]
expr_stmt|;
break|break;
case|case
name|LEAF_pfTablesTblPktsOutBlock
case|:
name|val
operator|->
name|v
operator|.
name|counter64
operator|=
name|e
operator|->
name|pft
operator|.
name|pfrts_packets
index|[
name|PFR_DIR_OUT
index|]
index|[
name|PFR_OP_BLOCK
index|]
expr_stmt|;
break|break;
case|case
name|LEAF_pfTablesTblPktsOutXPass
case|:
name|val
operator|->
name|v
operator|.
name|counter64
operator|=
name|e
operator|->
name|pft
operator|.
name|pfrts_packets
index|[
name|PFR_DIR_OUT
index|]
index|[
name|PFR_OP_XPASS
index|]
expr_stmt|;
break|break;
default|default:
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
block|}
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
block|}
end_function

begin_function
name|int
name|pf_tbladdr
parameter_list|(
name|struct
name|snmp_context
name|__unused
modifier|*
name|ctx
parameter_list|,
name|struct
name|snmp_value
name|__unused
modifier|*
name|val
parameter_list|,
name|u_int
name|__unused
name|sub
parameter_list|,
name|u_int
name|__unused
name|vindex
parameter_list|,
name|enum
name|snmp_op
name|__unused
name|op
parameter_list|)
block|{
return|return
operator|(
name|SNMP_ERR_GENERR
operator|)
return|;
block|}
end_function

begin_function
name|int
name|pf_altq
parameter_list|(
name|struct
name|snmp_context
name|__unused
modifier|*
name|ctx
parameter_list|,
name|struct
name|snmp_value
modifier|*
name|val
parameter_list|,
name|u_int
name|sub
parameter_list|,
name|u_int
name|__unused
name|vindex
parameter_list|,
name|enum
name|snmp_op
name|op
parameter_list|)
block|{
name|asn_subid_t
name|which
init|=
name|val
operator|->
name|var
operator|.
name|subs
index|[
name|sub
operator|-
literal|1
index|]
decl_stmt|;
if|if
condition|(
operator|!
name|altq_enabled
condition|)
block|{
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
block|}
if|if
condition|(
name|op
operator|==
name|SNMP_OP_SET
condition|)
return|return
operator|(
name|SNMP_ERR_NOT_WRITEABLE
operator|)
return|;
if|if
condition|(
name|op
operator|==
name|SNMP_OP_GET
condition|)
block|{
if|if
condition|(
operator|(
name|time
argument_list|(
name|NULL
argument_list|)
operator|-
name|pfq_table_age
operator|)
operator|>
name|PFQ_TABLE_MAXAGE
condition|)
if|if
condition|(
name|pfq_refresh
argument_list|()
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
name|SNMP_ERR_GENERR
operator|)
return|;
switch|switch
condition|(
name|which
condition|)
block|{
case|case
name|LEAF_pfAltqQueueNumber
case|:
name|val
operator|->
name|v
operator|.
name|uint32
operator|=
name|pfq_table_count
expr_stmt|;
break|break;
default|default:
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
block|}
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
block|}
name|abort
argument_list|()
expr_stmt|;
return|return
operator|(
name|SNMP_ERR_GENERR
operator|)
return|;
block|}
end_function

begin_function
name|int
name|pf_altqq
parameter_list|(
name|struct
name|snmp_context
name|__unused
modifier|*
name|ctx
parameter_list|,
name|struct
name|snmp_value
modifier|*
name|val
parameter_list|,
name|u_int
name|sub
parameter_list|,
name|u_int
name|__unused
name|vindex
parameter_list|,
name|enum
name|snmp_op
name|op
parameter_list|)
block|{
name|asn_subid_t
name|which
init|=
name|val
operator|->
name|var
operator|.
name|subs
index|[
name|sub
operator|-
literal|1
index|]
decl_stmt|;
name|struct
name|pfq_entry
modifier|*
name|e
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|!
name|altq_enabled
condition|)
block|{
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
block|}
switch|switch
condition|(
name|op
condition|)
block|{
case|case
name|SNMP_OP_SET
case|:
return|return
operator|(
name|SNMP_ERR_NOT_WRITEABLE
operator|)
return|;
case|case
name|SNMP_OP_GETNEXT
case|:
if|if
condition|(
operator|(
name|e
operator|=
name|NEXT_OBJECT_INT
argument_list|(
operator|&
name|pfq_table
argument_list|,
operator|&
name|val
operator|->
name|var
argument_list|,
name|sub
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
name|val
operator|->
name|var
operator|.
name|len
operator|=
name|sub
operator|+
literal|1
expr_stmt|;
name|val
operator|->
name|var
operator|.
name|subs
index|[
name|sub
index|]
operator|=
name|e
operator|->
name|index
expr_stmt|;
break|break;
case|case
name|SNMP_OP_GET
case|:
if|if
condition|(
name|val
operator|->
name|var
operator|.
name|len
operator|-
name|sub
operator|!=
literal|1
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
if|if
condition|(
operator|(
name|e
operator|=
name|pfq_table_find
argument_list|(
name|val
operator|->
name|var
operator|.
name|subs
index|[
name|sub
index|]
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
break|break;
case|case
name|SNMP_OP_COMMIT
case|:
case|case
name|SNMP_OP_ROLLBACK
case|:
default|default:
name|abort
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|time
argument_list|(
name|NULL
argument_list|)
operator|-
name|pfq_table_age
operator|)
operator|>
name|PFQ_TABLE_MAXAGE
condition|)
name|pfq_refresh
argument_list|()
expr_stmt|;
switch|switch
condition|(
name|which
condition|)
block|{
case|case
name|LEAF_pfAltqQueueDescr
case|:
return|return
operator|(
name|string_get
argument_list|(
name|val
argument_list|,
name|e
operator|->
name|altq
operator|.
name|qname
argument_list|,
operator|-
literal|1
argument_list|)
operator|)
return|;
case|case
name|LEAF_pfAltqQueueParent
case|:
return|return
operator|(
name|string_get
argument_list|(
name|val
argument_list|,
name|e
operator|->
name|altq
operator|.
name|parent
argument_list|,
operator|-
literal|1
argument_list|)
operator|)
return|;
case|case
name|LEAF_pfAltqQueueScheduler
case|:
name|val
operator|->
name|v
operator|.
name|integer
operator|=
name|e
operator|->
name|altq
operator|.
name|scheduler
expr_stmt|;
break|break;
case|case
name|LEAF_pfAltqQueueBandwidth
case|:
name|val
operator|->
name|v
operator|.
name|uint32
operator|=
name|e
operator|->
name|altq
operator|.
name|bandwidth
expr_stmt|;
break|break;
case|case
name|LEAF_pfAltqQueuePriority
case|:
name|val
operator|->
name|v
operator|.
name|integer
operator|=
name|e
operator|->
name|altq
operator|.
name|priority
expr_stmt|;
break|break;
case|case
name|LEAF_pfAltqQueueLimit
case|:
name|val
operator|->
name|v
operator|.
name|integer
operator|=
name|e
operator|->
name|altq
operator|.
name|qlimit
expr_stmt|;
break|break;
default|default:
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
block|}
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|pfi_entry
modifier|*
name|pfi_table_find
parameter_list|(
name|u_int
name|idx
parameter_list|)
block|{
name|struct
name|pfi_entry
modifier|*
name|e
decl_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|e
argument_list|,
argument|&pfi_table
argument_list|,
argument|link
argument_list|)
if|if
condition|(
name|e
operator|->
name|index
operator|==
name|idx
condition|)
return|return
operator|(
name|e
operator|)
return|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|pfq_entry
modifier|*
name|pfq_table_find
parameter_list|(
name|u_int
name|idx
parameter_list|)
block|{
name|struct
name|pfq_entry
modifier|*
name|e
decl_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|e
argument_list|,
argument|&pfq_table
argument_list|,
argument|link
argument_list|)
if|if
condition|(
name|e
operator|->
name|index
operator|==
name|idx
condition|)
return|return
operator|(
name|e
operator|)
return|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|pft_entry
modifier|*
name|pft_table_find
parameter_list|(
name|u_int
name|idx
parameter_list|)
block|{
name|struct
name|pft_entry
modifier|*
name|e
decl_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|e
argument_list|,
argument|&pft_table
argument_list|,
argument|link
argument_list|)
if|if
condition|(
name|e
operator|->
name|index
operator|==
name|idx
condition|)
return|return
operator|(
name|e
operator|)
return|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|pfi_refresh
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|pfioc_iface
name|io
decl_stmt|;
name|struct
name|pfi_kif
modifier|*
name|p
init|=
name|NULL
decl_stmt|;
name|struct
name|pfi_entry
modifier|*
name|e
decl_stmt|;
name|int
name|i
decl_stmt|,
name|numifs
init|=
literal|1
decl_stmt|;
if|if
condition|(
name|started
operator|&&
name|this_tick
operator|<=
name|pf_tick
condition|)
return|return
operator|(
literal|0
operator|)
return|;
while|while
condition|(
operator|!
name|TAILQ_EMPTY
argument_list|(
operator|&
name|pfi_table
argument_list|)
condition|)
block|{
name|e
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|pfi_table
argument_list|)
expr_stmt|;
name|TAILQ_REMOVE
argument_list|(
operator|&
name|pfi_table
argument_list|,
name|e
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|e
argument_list|)
expr_stmt|;
block|}
name|bzero
argument_list|(
operator|&
name|io
argument_list|,
sizeof|sizeof
argument_list|(
name|io
argument_list|)
argument_list|)
expr_stmt|;
name|io
operator|.
name|pfiio_esize
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|pfi_kif
argument_list|)
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|p
operator|=
name|reallocf
argument_list|(
name|p
argument_list|,
name|numifs
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|pfi_kif
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"pfi_refresh(): reallocf() numifs=%d: %s"
argument_list|,
name|numifs
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|err2
goto|;
block|}
name|io
operator|.
name|pfiio_size
operator|=
name|numifs
expr_stmt|;
name|io
operator|.
name|pfiio_buffer
operator|=
name|p
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|dev
argument_list|,
name|DIOCIGETIFACES
argument_list|,
operator|&
name|io
argument_list|)
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"pfi_refresh(): ioctl(): %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|err2
goto|;
block|}
if|if
condition|(
name|numifs
operator|>=
name|io
operator|.
name|pfiio_size
condition|)
break|break;
name|numifs
operator|=
name|io
operator|.
name|pfiio_size
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|numifs
condition|;
name|i
operator|++
control|)
block|{
name|e
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|pfi_entry
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|e
operator|==
name|NULL
condition|)
goto|goto
name|err1
goto|;
name|e
operator|->
name|index
operator|=
name|i
operator|+
literal|1
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|e
operator|->
name|pfi
argument_list|,
name|p
operator|+
name|i
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|pfi_kif
argument_list|)
argument_list|)
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|pfi_table
argument_list|,
name|e
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
name|pfi_table_age
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|pfi_table_count
operator|=
name|numifs
expr_stmt|;
name|pf_tick
operator|=
name|this_tick
expr_stmt|;
name|free
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|err1
label|:
while|while
condition|(
operator|!
name|TAILQ_EMPTY
argument_list|(
operator|&
name|pfi_table
argument_list|)
condition|)
block|{
name|e
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|pfi_table
argument_list|)
expr_stmt|;
name|TAILQ_REMOVE
argument_list|(
operator|&
name|pfi_table
argument_list|,
name|e
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|e
argument_list|)
expr_stmt|;
block|}
name|err2
label|:
name|free
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|pfq_refresh
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|pfioc_altq
name|pa
decl_stmt|;
name|struct
name|pfq_entry
modifier|*
name|e
decl_stmt|;
name|int
name|i
decl_stmt|,
name|numqs
decl_stmt|,
name|ticket
decl_stmt|;
if|if
condition|(
name|started
operator|&&
name|this_tick
operator|<=
name|pf_tick
condition|)
return|return
operator|(
literal|0
operator|)
return|;
while|while
condition|(
operator|!
name|TAILQ_EMPTY
argument_list|(
operator|&
name|pfq_table
argument_list|)
condition|)
block|{
name|e
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|pfq_table
argument_list|)
expr_stmt|;
name|TAILQ_REMOVE
argument_list|(
operator|&
name|pfq_table
argument_list|,
name|e
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|e
argument_list|)
expr_stmt|;
block|}
name|bzero
argument_list|(
operator|&
name|pa
argument_list|,
sizeof|sizeof
argument_list|(
name|pa
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|dev
argument_list|,
name|DIOCGETALTQS
argument_list|,
operator|&
name|pa
argument_list|)
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"pfq_refresh: ioctl(DIOCGETALTQS): %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|numqs
operator|=
name|pa
operator|.
name|nr
expr_stmt|;
name|ticket
operator|=
name|pa
operator|.
name|ticket
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|numqs
condition|;
name|i
operator|++
control|)
block|{
name|e
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|pfq_entry
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|e
operator|==
name|NULL
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"pfq_refresh(): "
literal|"malloc(): %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|pa
operator|.
name|ticket
operator|=
name|ticket
expr_stmt|;
name|pa
operator|.
name|nr
operator|=
name|i
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|dev
argument_list|,
name|DIOCGETALTQ
argument_list|,
operator|&
name|pa
argument_list|)
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"pfq_refresh(): "
literal|"ioctl(DIOCGETALTQ): %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|pa
operator|.
name|altq
operator|.
name|qid
operator|>
literal|0
condition|)
block|{
name|memcpy
argument_list|(
operator|&
name|e
operator|->
name|altq
argument_list|,
operator|&
name|pa
operator|.
name|altq
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|pf_altq
argument_list|)
argument_list|)
expr_stmt|;
name|e
operator|->
name|index
operator|=
name|pa
operator|.
name|altq
operator|.
name|qid
expr_stmt|;
name|pfq_table_count
operator|=
name|i
expr_stmt|;
name|INSERT_OBJECT_INT_LINK_INDEX
argument_list|(
name|e
argument_list|,
operator|&
name|pfq_table
argument_list|,
name|link
argument_list|,
name|index
argument_list|)
expr_stmt|;
block|}
block|}
name|pfq_table_age
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|pf_tick
operator|=
name|this_tick
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|err
label|:
name|free
argument_list|(
name|e
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
name|TAILQ_EMPTY
argument_list|(
operator|&
name|pfq_table
argument_list|)
condition|)
block|{
name|e
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|pfq_table
argument_list|)
expr_stmt|;
name|TAILQ_REMOVE
argument_list|(
operator|&
name|pfq_table
argument_list|,
name|e
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|e
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|pfs_refresh
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
name|started
operator|&&
name|this_tick
operator|<=
name|pf_tick
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|bzero
argument_list|(
operator|&
name|pfs
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|pf_status
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|dev
argument_list|,
name|DIOCGETSTATUS
argument_list|,
operator|&
name|pfs
argument_list|)
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"pfs_refresh(): ioctl(): %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|pf_tick
operator|=
name|this_tick
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|pft_refresh
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|pfioc_table
name|io
decl_stmt|;
name|struct
name|pfr_tstats
modifier|*
name|t
init|=
name|NULL
decl_stmt|;
name|struct
name|pft_entry
modifier|*
name|e
decl_stmt|;
name|int
name|i
decl_stmt|,
name|numtbls
init|=
literal|1
decl_stmt|;
if|if
condition|(
name|started
operator|&&
name|this_tick
operator|<=
name|pf_tick
condition|)
return|return
operator|(
literal|0
operator|)
return|;
while|while
condition|(
operator|!
name|TAILQ_EMPTY
argument_list|(
operator|&
name|pft_table
argument_list|)
condition|)
block|{
name|e
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|pft_table
argument_list|)
expr_stmt|;
name|TAILQ_REMOVE
argument_list|(
operator|&
name|pft_table
argument_list|,
name|e
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|e
argument_list|)
expr_stmt|;
block|}
name|bzero
argument_list|(
operator|&
name|io
argument_list|,
sizeof|sizeof
argument_list|(
name|io
argument_list|)
argument_list|)
expr_stmt|;
name|io
operator|.
name|pfrio_esize
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|pfr_tstats
argument_list|)
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|t
operator|=
name|reallocf
argument_list|(
name|t
argument_list|,
name|numtbls
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|pfr_tstats
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|==
name|NULL
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"pft_refresh(): reallocf() numtbls=%d: %s"
argument_list|,
name|numtbls
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|err2
goto|;
block|}
name|io
operator|.
name|pfrio_size
operator|=
name|numtbls
expr_stmt|;
name|io
operator|.
name|pfrio_buffer
operator|=
name|t
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|dev
argument_list|,
name|DIOCRGETTSTATS
argument_list|,
operator|&
name|io
argument_list|)
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"pft_refresh(): ioctl(): %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|err2
goto|;
block|}
if|if
condition|(
name|numtbls
operator|>=
name|io
operator|.
name|pfrio_size
condition|)
break|break;
name|numtbls
operator|=
name|io
operator|.
name|pfrio_size
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|numtbls
condition|;
name|i
operator|++
control|)
block|{
name|e
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|pft_entry
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|e
operator|==
name|NULL
condition|)
goto|goto
name|err1
goto|;
name|e
operator|->
name|index
operator|=
name|i
operator|+
literal|1
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|e
operator|->
name|pft
argument_list|,
name|t
operator|+
name|i
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|pfr_tstats
argument_list|)
argument_list|)
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|pft_table
argument_list|,
name|e
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
name|pft_table_age
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|pft_table_count
operator|=
name|numtbls
expr_stmt|;
name|pf_tick
operator|=
name|this_tick
expr_stmt|;
name|free
argument_list|(
name|t
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|err1
label|:
while|while
condition|(
operator|!
name|TAILQ_EMPTY
argument_list|(
operator|&
name|pft_table
argument_list|)
condition|)
block|{
name|e
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|pft_table
argument_list|)
expr_stmt|;
name|TAILQ_REMOVE
argument_list|(
operator|&
name|pft_table
argument_list|,
name|e
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|e
argument_list|)
expr_stmt|;
block|}
name|err2
label|:
name|free
argument_list|(
name|t
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * check whether altq support is enabled in kernel  */
end_comment

begin_function
specifier|static
name|int
name|altq_is_enabled
parameter_list|(
name|int
name|pfdev
parameter_list|)
block|{
name|struct
name|pfioc_altq
name|pa
decl_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|pfdev
argument_list|,
name|DIOCGETALTQS
argument_list|,
operator|&
name|pa
argument_list|)
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|ENODEV
condition|)
block|{
name|syslog
argument_list|(
name|LOG_INFO
argument_list|,
literal|"No ALTQ support in kernel\n"
literal|"ALTQ related functions disabled\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
else|else
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"DIOCGETALTQS returned an error: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Implement the bsnmpd module interface  */
end_comment

begin_function
specifier|static
name|int
name|pf_init
parameter_list|(
name|struct
name|lmodule
modifier|*
name|mod
parameter_list|,
name|int
name|__unused
name|argc
parameter_list|,
name|char
name|__unused
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|module
operator|=
name|mod
expr_stmt|;
if|if
condition|(
operator|(
name|dev
operator|=
name|open
argument_list|(
literal|"/dev/pf"
argument_list|,
name|O_RDONLY
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"pf_init(): open(): %s\n"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|altq_enabled
operator|=
name|altq_is_enabled
argument_list|(
name|dev
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"pf_init(): altq test failed"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* Prepare internal state */
name|TAILQ_INIT
argument_list|(
operator|&
name|pfi_table
argument_list|)
expr_stmt|;
name|TAILQ_INIT
argument_list|(
operator|&
name|pfq_table
argument_list|)
expr_stmt|;
name|TAILQ_INIT
argument_list|(
operator|&
name|pft_table
argument_list|)
expr_stmt|;
name|pfi_refresh
argument_list|()
expr_stmt|;
if|if
condition|(
name|altq_enabled
condition|)
block|{
name|pfq_refresh
argument_list|()
expr_stmt|;
block|}
name|pfs_refresh
argument_list|()
expr_stmt|;
name|pft_refresh
argument_list|()
expr_stmt|;
name|started
operator|=
literal|1
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|pf_fini
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|pfi_entry
modifier|*
name|i1
decl_stmt|,
modifier|*
name|i2
decl_stmt|;
name|struct
name|pfq_entry
modifier|*
name|q1
decl_stmt|,
modifier|*
name|q2
decl_stmt|;
name|struct
name|pft_entry
modifier|*
name|t1
decl_stmt|,
modifier|*
name|t2
decl_stmt|;
comment|/* Empty the list of interfaces */
name|i1
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|pfi_table
argument_list|)
expr_stmt|;
while|while
condition|(
name|i1
operator|!=
name|NULL
condition|)
block|{
name|i2
operator|=
name|TAILQ_NEXT
argument_list|(
name|i1
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|i1
argument_list|)
expr_stmt|;
name|i1
operator|=
name|i2
expr_stmt|;
block|}
comment|/* List of queues */
name|q1
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|pfq_table
argument_list|)
expr_stmt|;
while|while
condition|(
name|q1
operator|!=
name|NULL
condition|)
block|{
name|q2
operator|=
name|TAILQ_NEXT
argument_list|(
name|q1
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|q1
argument_list|)
expr_stmt|;
name|q1
operator|=
name|q2
expr_stmt|;
block|}
comment|/* And the list of tables */
name|t1
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|pft_table
argument_list|)
expr_stmt|;
while|while
condition|(
name|t1
operator|!=
name|NULL
condition|)
block|{
name|t2
operator|=
name|TAILQ_NEXT
argument_list|(
name|t1
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|t1
argument_list|)
expr_stmt|;
name|t1
operator|=
name|t2
expr_stmt|;
block|}
name|close
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|pf_dump
parameter_list|(
name|void
parameter_list|)
block|{
name|pfi_refresh
argument_list|()
expr_stmt|;
if|if
condition|(
name|altq_enabled
condition|)
block|{
name|pfq_refresh
argument_list|()
expr_stmt|;
block|}
name|pft_refresh
argument_list|()
expr_stmt|;
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"Dump: pfi_table_age = %jd"
argument_list|,
operator|(
name|intmax_t
operator|)
name|pfi_table_age
argument_list|)
expr_stmt|;
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"Dump: pfi_table_count = %d"
argument_list|,
name|pfi_table_count
argument_list|)
expr_stmt|;
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"Dump: pfq_table_age = %jd"
argument_list|,
operator|(
name|intmax_t
operator|)
name|pfq_table_age
argument_list|)
expr_stmt|;
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"Dump: pfq_table_count = %d"
argument_list|,
name|pfq_table_count
argument_list|)
expr_stmt|;
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"Dump: pft_table_age = %jd"
argument_list|,
operator|(
name|intmax_t
operator|)
name|pft_table_age
argument_list|)
expr_stmt|;
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"Dump: pft_table_count = %d"
argument_list|,
name|pft_table_count
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|const
name|struct
name|snmp_module
name|config
init|=
block|{
operator|.
name|comment
operator|=
literal|"This module implements a MIB for the pf packet filter."
block|,
operator|.
name|init
operator|=
name|pf_init
block|,
operator|.
name|fini
operator|=
name|pf_fini
block|,
operator|.
name|tree
operator|=
name|pf_ctree
block|,
operator|.
name|dump
operator|=
name|pf_dump
block|,
operator|.
name|tree_size
operator|=
name|pf_CTREE_SIZE
block|, }
decl_stmt|;
end_decl_stmt

end_unit


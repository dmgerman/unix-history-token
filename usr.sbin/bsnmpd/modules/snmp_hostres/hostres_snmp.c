begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2005-2006 The FreeBSD Project  * All rights reserved.  *  * Author: Victor Cruceru<soc-victor@freebsd.org>  *  * Redistribution of this software and documentation and use in source and  * binary forms, with or without modification, are permitted provided that  * the following conditions are met:  *  * 1. Redistributions of source code or documentation must retain the above  *    copyright notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * This C file contains code developed by Poul-Henning Kamp under the  * following license:  *  * FreeBSD: src/sbin/mdconfig/mdconfig.c,v 1.33.2.1 2004/09/14 03:32:21 jmg Exp  * ----------------------------------------------------------------------------  * "THE BEER-WARE LICENSE" (Revision 42):  *<phk@FreeBSD.ORG> wrote this file.  As long as you retain this notice you  * can do whatever you want with this stuff. If we meet some day, and you think  * this stuff is worth it, you can buy me a beer in return.   Poul-Henning Kamp  * ----------------------------------------------------------------------------  *  * $FreeBSD$  */
end_comment

begin_comment
comment|/*  * Host Resources MIB implementation for bsnmpd.  */
end_comment

begin_include
include|#
directive|include
file|<paths.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<syslog.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|"hostres_snmp.h"
end_include

begin_include
include|#
directive|include
file|"hostres_oid.h"
end_include

begin_include
include|#
directive|include
file|"hostres_tree.h"
end_include

begin_comment
comment|/* Internal id got after we'll register this module with the agent */
end_comment

begin_decl_stmt
specifier|static
name|u_int
name|host_registration_id
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* This our hostres module */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|lmodule
modifier|*
name|hostres_module
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* See the generated file hostres_oid.h */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|asn_oid
name|oid_host
init|=
name|OIDX_host
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* descriptor to access kernel memory */
end_comment

begin_decl_stmt
name|kvm_t
modifier|*
name|hr_kd
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * HOST RESOURCES mib module finalization hook.  * Returns 0 on success,< 0 on error  */
end_comment

begin_function
specifier|static
name|int
name|hostres_fini
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
name|hr_kd
operator|!=
name|NULL
condition|)
operator|(
name|void
operator|)
name|kvm_close
argument_list|(
name|hr_kd
argument_list|)
expr_stmt|;
name|fini_storage_tbl
argument_list|()
expr_stmt|;
name|fini_fs_tbl
argument_list|()
expr_stmt|;
name|fini_processor_tbl
argument_list|()
expr_stmt|;
name|fini_disk_storage_tbl
argument_list|()
expr_stmt|;
name|fini_device_tbl
argument_list|()
expr_stmt|;
name|fini_partition_tbl
argument_list|()
expr_stmt|;
name|fini_network_tbl
argument_list|()
expr_stmt|;
name|fini_printer_tbl
argument_list|()
expr_stmt|;
name|fini_swrun_tbl
argument_list|()
expr_stmt|;
name|fini_swins_tbl
argument_list|()
expr_stmt|;
name|fini_scalars
argument_list|()
expr_stmt|;
if|if
condition|(
name|host_registration_id
operator|>
literal|0
condition|)
name|or_unregister
argument_list|(
name|host_registration_id
argument_list|)
expr_stmt|;
name|HRDBG
argument_list|(
literal|"done."
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * HOST RESOURCES mib module initialization hook.  * Returns 0 on success,< 0 on error  */
end_comment

begin_function
specifier|static
name|int
name|hostres_init
parameter_list|(
name|struct
name|lmodule
modifier|*
name|mod
parameter_list|,
name|int
name|argc
name|__unused
parameter_list|,
name|char
modifier|*
name|argv
index|[]
name|__unused
parameter_list|)
block|{
name|hostres_module
operator|=
name|mod
expr_stmt|;
comment|/* 	 * NOTE: order of these calls is important here! 	 */
if|if
condition|(
operator|(
name|hr_kd
operator|=
name|kvm_open
argument_list|(
name|NULL
argument_list|,
name|_PATH_DEVNULL
argument_list|,
name|NULL
argument_list|,
name|O_RDONLY
argument_list|,
literal|"kvm_open"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"kvm_open failed: %m "
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* 	 * The order is relevant here, because some table depend on each other. 	 */
name|init_device_tbl
argument_list|()
expr_stmt|;
comment|/* populates partition table too */
if|if
condition|(
name|init_disk_storage_tbl
argument_list|()
condition|)
block|{
name|hostres_fini
argument_list|()
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|init_processor_tbl
argument_list|()
expr_stmt|;
name|init_printer_tbl
argument_list|()
expr_stmt|;
comment|/* 	 * populate storage and FS tables. Must be done after device 	 * initialisation because the FS refresh code calls into the 	 * partition refresh code. 	 */
name|init_storage_tbl
argument_list|()
expr_stmt|;
comment|/* also the hrSWRunPerfTable's support is initialized here */
name|init_swrun_tbl
argument_list|()
expr_stmt|;
name|init_swins_tbl
argument_list|()
expr_stmt|;
name|HRDBG
argument_list|(
literal|"done."
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * HOST RESOURCES mib module start operation  * returns nothing  */
end_comment

begin_function
specifier|static
name|void
name|hostres_start
parameter_list|(
name|void
parameter_list|)
block|{
name|host_registration_id
operator|=
name|or_register
argument_list|(
operator|&
name|oid_host
argument_list|,
literal|"The MIB module for Host Resource MIB (RFC 2790)."
argument_list|,
name|hostres_module
argument_list|)
expr_stmt|;
name|start_device_tbl
argument_list|(
name|hostres_module
argument_list|)
expr_stmt|;
name|start_processor_tbl
argument_list|(
name|hostres_module
argument_list|)
expr_stmt|;
name|start_network_tbl
argument_list|()
expr_stmt|;
name|HRDBG
argument_list|(
literal|"done."
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* this identifies the HOST RESOURCES mib module */
end_comment

begin_decl_stmt
specifier|const
name|struct
name|snmp_module
name|config
init|=
block|{
literal|"This module implements the host resource mib (rfc 2790)"
block|,
name|hostres_init
block|,
name|hostres_fini
block|,
name|NULL
block|,
comment|/* idle function, do not use it */
name|NULL
block|,
name|NULL
block|,
name|hostres_start
block|,
name|NULL
block|,
comment|/* proxy a PDU */
name|hostres_ctree
block|,
comment|/* see the generated hostres_tree.h */
name|hostres_CTREE_SIZE
block|,
comment|/* see the generated hostres_tree.h */
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/**  * Make an SNMP DateAndTime from a struct tm. This should be in the library.  */
end_comment

begin_function
name|int
name|make_date_time
parameter_list|(
name|u_char
modifier|*
name|str
parameter_list|,
specifier|const
name|struct
name|tm
modifier|*
name|tm
parameter_list|,
name|u_int
name|decisecs
parameter_list|)
block|{
name|str
index|[
literal|0
index|]
operator|=
call|(
name|u_char
call|)
argument_list|(
operator|(
name|tm
operator|->
name|tm_year
operator|+
literal|1900
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|str
index|[
literal|1
index|]
operator|=
call|(
name|u_char
call|)
argument_list|(
name|tm
operator|->
name|tm_year
operator|+
literal|1900
argument_list|)
expr_stmt|;
name|str
index|[
literal|2
index|]
operator|=
name|tm
operator|->
name|tm_mon
operator|+
literal|1
expr_stmt|;
name|str
index|[
literal|3
index|]
operator|=
name|tm
operator|->
name|tm_mday
expr_stmt|;
name|str
index|[
literal|4
index|]
operator|=
name|tm
operator|->
name|tm_hour
expr_stmt|;
name|str
index|[
literal|5
index|]
operator|=
name|tm
operator|->
name|tm_min
expr_stmt|;
name|str
index|[
literal|6
index|]
operator|=
name|tm
operator|->
name|tm_sec
expr_stmt|;
name|str
index|[
literal|7
index|]
operator|=
name|decisecs
expr_stmt|;
if|if
condition|(
name|tm
operator|->
name|tm_gmtoff
operator|<
literal|0
condition|)
name|str
index|[
literal|8
index|]
operator|=
literal|'-'
expr_stmt|;
else|else
name|str
index|[
literal|8
index|]
operator|=
literal|'+'
expr_stmt|;
name|str
index|[
literal|9
index|]
operator|=
call|(
name|u_char
call|)
argument_list|(
name|abs
argument_list|(
name|tm
operator|->
name|tm_gmtoff
argument_list|)
operator|/
literal|3600
argument_list|)
expr_stmt|;
name|str
index|[
literal|10
index|]
operator|=
call|(
name|u_char
call|)
argument_list|(
operator|(
name|abs
argument_list|(
name|tm
operator|->
name|tm_gmtoff
argument_list|)
operator|%
literal|3600
operator|)
operator|/
literal|60
argument_list|)
expr_stmt|;
return|return
operator|(
literal|11
operator|)
return|;
block|}
end_function

end_unit


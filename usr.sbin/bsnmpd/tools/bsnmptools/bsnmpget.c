begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2005-2006 The FreeBSD Project  * All rights reserved.  *  * Author: Shteryana Shopova<syrinx@FreeBSD.org>  *  * Redistribution of this software and documentation and use in source and  * binary forms, with or without modification, are permitted provided that  * the following conditions are met:  *  * 1. Redistributions of source code or documentation must retain the above  *    copyright notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * Bsnmpget and bsnmpwalk are simple tools for querying SNMP agents,  * bsnmpset can be used to set MIB objects in an agent.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<assert.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<err.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<stdarg.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<syslog.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<bsnmp/asn1.h>
end_include

begin_include
include|#
directive|include
file|<bsnmp/snmp.h>
end_include

begin_include
include|#
directive|include
file|<bsnmp/snmpclient.h>
end_include

begin_include
include|#
directive|include
file|"bsnmptc.h"
end_include

begin_include
include|#
directive|include
file|"bsnmptools.h"
end_include

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|program_name
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_enum
specifier|static
enum|enum
name|program_e
block|{
name|BSNMPGET
block|,
name|BSNMPWALK
block|,
name|BSNMPSET
block|}
name|program
enum|;
end_enum

begin_comment
comment|/* *****************************************************************************  * Common bsnmptools functions.  */
end_comment

begin_function
specifier|static
name|void
name|usage
parameter_list|(
name|void
parameter_list|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Usage:\n"
literal|"%s %s [-A options] [-b buffersize] [-C options] [-I options]\n"
literal|"\t[-i filelist] [-l filename]%s [-o output] [-P options]\n"
literal|"\t%s[-r retries] [-s [trans::][community@][server][:port]]\n"
literal|"\t[-t timeout] [-U options] [-v version]%s\n"
argument_list|,
name|program_name
argument_list|,
operator|(
name|program
operator|==
name|BSNMPGET
operator|)
condition|?
literal|"[-aDdehnK]"
else|:
operator|(
name|program
operator|==
name|BSNMPWALK
operator|)
condition|?
literal|"[-dhnK]"
else|:
operator|(
name|program
operator|==
name|BSNMPSET
operator|)
condition|?
literal|"[-adehnK]"
else|:
literal|""
argument_list|,
operator|(
name|program
operator|==
name|BSNMPGET
operator|||
name|program
operator|==
name|BSNMPWALK
operator|)
condition|?
literal|" [-M max-repetitions] [-N non-repeaters]"
else|:
literal|""
argument_list|,
operator|(
name|program
operator|==
name|BSNMPGET
operator|||
name|program
operator|==
name|BSNMPWALK
operator|)
condition|?
literal|"[-p pdu] "
else|:
literal|""
argument_list|,
operator|(
name|program
operator|==
name|BSNMPGET
operator|)
condition|?
literal|" OID [OID ...]"
else|:
operator|(
name|program
operator|==
name|BSNMPWALK
operator|||
name|program
operator|==
name|BSNMPSET
operator|)
condition|?
literal|" [OID ...]"
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int32_t
name|parse_max_repetitions
parameter_list|(
name|struct
name|snmp_toolinfo
modifier|*
name|snmptoolctx
parameter_list|,
name|char
modifier|*
name|opt_arg
parameter_list|)
block|{
name|uint32_t
name|v
decl_stmt|;
name|assert
argument_list|(
name|opt_arg
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|v
operator|=
name|strtoul
argument_list|(
name|opt_arg
argument_list|,
operator|(
name|void
operator|*
operator|)
name|NULL
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|>
name|SNMP_MAX_BINDINGS
condition|)
block|{
name|warnx
argument_list|(
literal|"Max repetitions value greater than %d maximum allowed."
argument_list|,
name|SNMP_MAX_BINDINGS
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|SET_MAXREP
argument_list|(
name|snmptoolctx
argument_list|,
name|v
argument_list|)
expr_stmt|;
return|return
operator|(
literal|2
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int32_t
name|parse_non_repeaters
parameter_list|(
name|struct
name|snmp_toolinfo
modifier|*
name|snmptoolctx
parameter_list|,
name|char
modifier|*
name|opt_arg
parameter_list|)
block|{
name|uint32_t
name|v
decl_stmt|;
name|assert
argument_list|(
name|opt_arg
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|v
operator|=
name|strtoul
argument_list|(
name|opt_arg
argument_list|,
operator|(
name|void
operator|*
operator|)
name|NULL
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|>
name|SNMP_MAX_BINDINGS
condition|)
block|{
name|warnx
argument_list|(
literal|"Non repeaters value greater than %d maximum allowed."
argument_list|,
name|SNMP_MAX_BINDINGS
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|SET_NONREP
argument_list|(
name|snmptoolctx
argument_list|,
name|v
argument_list|)
expr_stmt|;
return|return
operator|(
literal|2
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int32_t
name|parse_pdu_type
parameter_list|(
name|struct
name|snmp_toolinfo
modifier|*
name|snmptoolctx
parameter_list|,
name|char
modifier|*
name|opt_arg
parameter_list|)
block|{
name|assert
argument_list|(
name|opt_arg
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|opt_arg
argument_list|,
literal|"getbulk"
argument_list|)
operator|==
literal|0
condition|)
name|SET_PDUTYPE
argument_list|(
name|snmptoolctx
argument_list|,
name|SNMP_PDU_GETBULK
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|opt_arg
argument_list|,
literal|"getnext"
argument_list|)
operator|==
literal|0
condition|)
name|SET_PDUTYPE
argument_list|(
name|snmptoolctx
argument_list|,
name|SNMP_PDU_GETNEXT
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|opt_arg
argument_list|,
literal|"get"
argument_list|)
operator|==
literal|0
condition|)
name|SET_PDUTYPE
argument_list|(
name|snmptoolctx
argument_list|,
name|SNMP_PDU_GET
argument_list|)
expr_stmt|;
else|else
block|{
name|warnx
argument_list|(
literal|"PDU type '%s' not supported."
argument_list|,
name|opt_arg
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|2
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int32_t
name|snmptool_parse_options
parameter_list|(
name|struct
name|snmp_toolinfo
modifier|*
name|snmptoolctx
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|int32_t
name|count
decl_stmt|,
name|optnum
init|=
literal|0
decl_stmt|;
name|int
name|ch
decl_stmt|;
specifier|const
name|char
modifier|*
name|opts
decl_stmt|;
switch|switch
condition|(
name|program
condition|)
block|{
case|case
name|BSNMPWALK
case|:
name|opts
operator|=
literal|"dhnKA:b:C:I:i:l:M:N:o:P:p:r:s:t:U:v:"
expr_stmt|;
break|break;
case|case
name|BSNMPGET
case|:
name|opts
operator|=
literal|"aDdehnKA:b:C:I:i:l:M:N:o:P:p:r:s:t:U:v:"
expr_stmt|;
break|break;
case|case
name|BSNMPSET
case|:
name|opts
operator|=
literal|"adehnKA:b:C:I:i:l:o:P:r:s:t:U:v:"
expr_stmt|;
break|break;
default|default:
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
while|while
condition|(
operator|(
name|ch
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|opts
argument_list|)
operator|)
operator|!=
name|EOF
condition|)
block|{
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'A'
case|:
name|count
operator|=
name|parse_authentication
argument_list|(
name|snmptoolctx
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'a'
case|:
name|count
operator|=
name|parse_skip_access
argument_list|(
name|snmptoolctx
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'b'
case|:
name|count
operator|=
name|parse_buflen
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'D'
case|:
name|count
operator|=
name|parse_discovery
argument_list|(
name|snmptoolctx
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
name|count
operator|=
name|parse_debug
argument_list|()
expr_stmt|;
break|break;
case|case
literal|'e'
case|:
name|count
operator|=
name|parse_errors
argument_list|(
name|snmptoolctx
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'h'
case|:
name|usage
argument_list|()
expr_stmt|;
return|return
operator|(
operator|-
literal|2
operator|)
return|;
case|case
literal|'C'
case|:
name|count
operator|=
name|parse_context
argument_list|(
name|snmptoolctx
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'I'
case|:
name|count
operator|=
name|parse_include
argument_list|(
name|snmptoolctx
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'i'
case|:
name|count
operator|=
name|parse_file
argument_list|(
name|snmptoolctx
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'K'
case|:
name|count
operator|=
name|parse_local_key
argument_list|(
name|snmptoolctx
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
name|count
operator|=
name|parse_local_path
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'M'
case|:
name|count
operator|=
name|parse_max_repetitions
argument_list|(
name|snmptoolctx
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'N'
case|:
name|count
operator|=
name|parse_non_repeaters
argument_list|(
name|snmptoolctx
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'n'
case|:
name|count
operator|=
name|parse_num_oids
argument_list|(
name|snmptoolctx
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'o'
case|:
name|count
operator|=
name|parse_output
argument_list|(
name|snmptoolctx
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'P'
case|:
name|count
operator|=
name|parse_privacy
argument_list|(
name|snmptoolctx
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
name|count
operator|=
name|parse_pdu_type
argument_list|(
name|snmptoolctx
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'r'
case|:
name|count
operator|=
name|parse_retry
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
name|count
operator|=
name|parse_server
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
name|count
operator|=
name|parse_timeout
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'U'
case|:
name|count
operator|=
name|parse_user_security
argument_list|(
name|snmptoolctx
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'v'
case|:
name|count
operator|=
name|parse_version
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'?'
case|:
default|default:
name|usage
argument_list|()
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|count
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|optnum
operator|+=
name|count
expr_stmt|;
block|}
return|return
operator|(
name|optnum
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Read user input OID - one of following formats:  * 1) 1.2.1.1.2.1.0 - that is if option numeric was given;  * 2) string - in such case append .0 to the asn_oid subs;  * 3) string.1 - no additional processing required in such case.  */
end_comment

begin_function
specifier|static
name|char
modifier|*
name|snmptools_parse_stroid
parameter_list|(
name|struct
name|snmp_toolinfo
modifier|*
name|snmptoolctx
parameter_list|,
name|struct
name|snmp_object
modifier|*
name|obj
parameter_list|,
name|char
modifier|*
name|argv
parameter_list|)
block|{
name|char
name|string
index|[
name|MAXSTR
index|]
decl_stmt|,
modifier|*
name|str
decl_stmt|;
name|int32_t
name|i
init|=
literal|0
decl_stmt|;
name|struct
name|asn_oid
name|in_oid
decl_stmt|;
name|str
operator|=
name|argv
expr_stmt|;
if|if
condition|(
operator|*
name|str
operator|==
literal|'.'
condition|)
name|str
operator|++
expr_stmt|;
while|while
condition|(
name|isalpha
argument_list|(
operator|*
name|str
argument_list|)
operator|||
operator|*
name|str
operator|==
literal|'_'
operator|||
operator|(
name|i
operator|!=
literal|0
operator|&&
name|isdigit
argument_list|(
operator|*
name|str
argument_list|)
operator|)
condition|)
block|{
name|str
operator|++
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|<=
literal|0
operator|||
name|i
operator|>=
name|MAXSTR
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|memset
argument_list|(
operator|&
name|in_oid
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|asn_oid
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|str
operator|=
name|snmp_parse_suboid
argument_list|(
operator|(
name|argv
operator|+
name|i
operator|)
argument_list|,
operator|&
name|in_oid
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|warnx
argument_list|(
literal|"Invalid OID - %s"
argument_list|,
name|argv
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|strlcpy
argument_list|(
name|string
argument_list|,
name|argv
argument_list|,
name|i
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|snmp_lookup_oidall
argument_list|(
name|snmptoolctx
argument_list|,
name|obj
argument_list|,
name|string
argument_list|)
operator|<
literal|0
condition|)
block|{
name|warnx
argument_list|(
literal|"No entry for %s in mapping lists"
argument_list|,
name|string
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
comment|/* If OID given on command line append it. */
if|if
condition|(
name|in_oid
operator|.
name|len
operator|>
literal|0
condition|)
name|asn_append_oid
argument_list|(
operator|&
operator|(
name|obj
operator|->
name|val
operator|.
name|var
operator|)
argument_list|,
operator|&
name|in_oid
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|*
name|str
operator|==
literal|'['
condition|)
block|{
if|if
condition|(
operator|(
name|str
operator|=
name|snmp_parse_index
argument_list|(
name|snmptoolctx
argument_list|,
name|str
operator|+
literal|1
argument_list|,
name|obj
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|obj
operator|->
name|val
operator|.
name|syntax
operator|>
literal|0
operator|&&
name|GET_PDUTYPE
argument_list|(
name|snmptoolctx
argument_list|)
operator|==
name|SNMP_PDU_GET
condition|)
block|{
if|if
condition|(
name|snmp_suboid_append
argument_list|(
operator|&
operator|(
name|obj
operator|->
name|val
operator|.
name|var
operator|)
argument_list|,
operator|(
name|asn_subid_t
operator|)
literal|0
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
block|}
return|return
operator|(
name|str
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int32_t
name|snmptools_parse_oid
parameter_list|(
name|struct
name|snmp_toolinfo
modifier|*
name|snmptoolctx
parameter_list|,
name|struct
name|snmp_object
modifier|*
name|obj
parameter_list|,
name|char
modifier|*
name|argv
parameter_list|)
block|{
if|if
condition|(
name|argv
operator|==
name|NULL
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|ISSET_NUMERIC
argument_list|(
name|snmptoolctx
argument_list|)
condition|)
block|{
if|if
condition|(
name|snmp_parse_numoid
argument_list|(
name|argv
argument_list|,
operator|&
operator|(
name|obj
operator|->
name|val
operator|.
name|var
operator|)
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
else|else
block|{
if|if
condition|(
name|snmptools_parse_stroid
argument_list|(
name|snmptoolctx
argument_list|,
name|obj
argument_list|,
name|argv
argument_list|)
operator|==
name|NULL
operator|&&
name|snmp_parse_numoid
argument_list|(
name|argv
argument_list|,
operator|&
operator|(
name|obj
operator|->
name|val
operator|.
name|var
operator|)
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int32_t
name|snmptool_add_vbind
parameter_list|(
name|struct
name|snmp_pdu
modifier|*
name|pdu
parameter_list|,
name|struct
name|snmp_object
modifier|*
name|obj
parameter_list|)
block|{
if|if
condition|(
name|obj
operator|->
name|error
operator|>
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|asn_append_oid
argument_list|(
operator|&
operator|(
name|pdu
operator|->
name|bindings
index|[
name|pdu
operator|->
name|nbindings
index|]
operator|.
name|var
operator|)
argument_list|,
operator|&
operator|(
name|obj
operator|->
name|val
operator|.
name|var
operator|)
argument_list|)
expr_stmt|;
name|pdu
operator|->
name|nbindings
operator|++
expr_stmt|;
return|return
operator|(
name|pdu
operator|->
name|nbindings
operator|)
return|;
block|}
end_function

begin_comment
comment|/* *****************************************************************************  * bsnmpget private functions.  */
end_comment

begin_function
specifier|static
name|int32_t
name|snmpget_verify_vbind
parameter_list|(
name|struct
name|snmp_toolinfo
modifier|*
name|snmptoolctx
parameter_list|,
name|struct
name|snmp_pdu
modifier|*
name|pdu
parameter_list|,
name|struct
name|snmp_object
modifier|*
name|obj
parameter_list|)
block|{
if|if
condition|(
name|pdu
operator|->
name|version
operator|==
name|SNMP_V1
operator|&&
name|obj
operator|->
name|val
operator|.
name|syntax
operator|==
name|SNMP_SYNTAX_COUNTER64
condition|)
block|{
name|warnx
argument_list|(
literal|"64-bit counters are not supported in SNMPv1 PDU"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|ISSET_NUMERIC
argument_list|(
name|snmptoolctx
argument_list|)
operator|||
name|pdu
operator|->
name|type
operator|==
name|SNMP_PDU_GETNEXT
operator|||
name|pdu
operator|->
name|type
operator|==
name|SNMP_PDU_GETBULK
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
name|pdu
operator|->
name|type
operator|==
name|SNMP_PDU_GET
operator|&&
name|obj
operator|->
name|val
operator|.
name|syntax
operator|==
name|SNMP_SYNTAX_NULL
condition|)
block|{
name|warnx
argument_list|(
literal|"Only leaf object values can be added to GET PDU"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * In case of a getbulk PDU, the error_status and error_index fields are used by  * libbsnmp to hold the values of the non-repeaters and max-repetitions fields  * that are present only in the getbulk - so before sending the PDU make sure  * these have correct values as well.  */
end_comment

begin_function
specifier|static
name|void
name|snmpget_fix_getbulk
parameter_list|(
name|struct
name|snmp_pdu
modifier|*
name|pdu
parameter_list|,
name|uint32_t
name|max_rep
parameter_list|,
name|uint32_t
name|non_rep
parameter_list|)
block|{
name|assert
argument_list|(
name|pdu
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|pdu
operator|->
name|nbindings
operator|<
name|non_rep
condition|)
name|pdu
operator|->
name|error_status
operator|=
name|pdu
operator|->
name|nbindings
expr_stmt|;
else|else
name|pdu
operator|->
name|error_status
operator|=
name|non_rep
expr_stmt|;
if|if
condition|(
name|max_rep
operator|>
literal|0
condition|)
name|pdu
operator|->
name|error_index
operator|=
name|max_rep
expr_stmt|;
else|else
name|pdu
operator|->
name|error_index
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|snmptool_get
parameter_list|(
name|struct
name|snmp_toolinfo
modifier|*
name|snmptoolctx
parameter_list|)
block|{
name|struct
name|snmp_pdu
name|req
decl_stmt|,
name|resp
decl_stmt|;
name|snmp_pdu_create
argument_list|(
operator|&
name|req
argument_list|,
name|GET_PDUTYPE
argument_list|(
name|snmptoolctx
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|snmp_pdu_add_bindings
argument_list|(
name|snmptoolctx
argument_list|,
name|snmpget_verify_vbind
argument_list|,
name|snmptool_add_vbind
argument_list|,
operator|&
name|req
argument_list|,
name|SNMP_MAX_BINDINGS
argument_list|)
operator|)
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|GET_PDUTYPE
argument_list|(
name|snmptoolctx
argument_list|)
operator|==
name|SNMP_PDU_GETBULK
condition|)
name|snmpget_fix_getbulk
argument_list|(
operator|&
name|req
argument_list|,
name|GET_MAXREP
argument_list|(
name|snmptoolctx
argument_list|)
argument_list|,
name|GET_NONREP
argument_list|(
name|snmptoolctx
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|snmp_dialog
argument_list|(
operator|&
name|req
argument_list|,
operator|&
name|resp
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|warnx
argument_list|(
literal|"Snmp dialog - %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|snmp_parse_resp
argument_list|(
operator|&
name|resp
argument_list|,
operator|&
name|req
argument_list|)
operator|>=
literal|0
condition|)
block|{
name|snmp_output_resp
argument_list|(
name|snmptoolctx
argument_list|,
operator|&
name|resp
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
break|break;
block|}
name|snmp_output_err_resp
argument_list|(
name|snmptoolctx
argument_list|,
operator|&
name|resp
argument_list|)
expr_stmt|;
if|if
condition|(
name|GET_PDUTYPE
argument_list|(
name|snmptoolctx
argument_list|)
operator|==
name|SNMP_PDU_GETBULK
operator|||
operator|!
name|ISSET_RETRY
argument_list|(
name|snmptoolctx
argument_list|)
condition|)
break|break;
comment|/* 		 * Loop through the object list and set object->error to the 		 * varbinding that caused the error. 		 */
if|if
condition|(
name|snmp_object_seterror
argument_list|(
name|snmptoolctx
argument_list|,
operator|&
operator|(
name|resp
operator|.
name|bindings
index|[
name|resp
operator|.
name|error_index
operator|-
literal|1
index|]
operator|)
argument_list|,
name|resp
operator|.
name|error_status
argument_list|)
operator|<=
literal|0
condition|)
break|break;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Retrying...\n"
argument_list|)
expr_stmt|;
name|snmp_pdu_free
argument_list|(
operator|&
name|resp
argument_list|)
expr_stmt|;
name|snmp_pdu_create
argument_list|(
operator|&
name|req
argument_list|,
name|GET_PDUTYPE
argument_list|(
name|snmptoolctx
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|snmp_pdu_free
argument_list|(
operator|&
name|resp
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* *****************************************************************************  * bsnmpwalk private functions.  */
end_comment

begin_comment
comment|/* The default tree to walk. */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|asn_oid
name|snmp_mibII_OID
init|=
block|{
literal|6
block|,
block|{
literal|1
block|,
literal|3
block|,
literal|6
block|,
literal|1
block|,
literal|2
block|,
literal|1
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int32_t
name|snmpwalk_add_default
parameter_list|(
name|struct
name|snmp_toolinfo
modifier|*
name|snmptoolctx
name|__unused
parameter_list|,
name|struct
name|snmp_object
modifier|*
name|obj
parameter_list|,
name|char
modifier|*
name|string
name|__unused
parameter_list|)
block|{
name|asn_append_oid
argument_list|(
operator|&
operator|(
name|obj
operator|->
name|val
operator|.
name|var
operator|)
argument_list|,
operator|&
name|snmp_mibII_OID
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Prepare the next GetNext/Get PDU to send.  */
end_comment

begin_function
specifier|static
name|void
name|snmpwalk_nextpdu_create
parameter_list|(
name|uint32_t
name|op
parameter_list|,
name|struct
name|asn_oid
modifier|*
name|var
parameter_list|,
name|struct
name|snmp_pdu
modifier|*
name|pdu
parameter_list|)
block|{
name|snmp_pdu_create
argument_list|(
name|pdu
argument_list|,
name|op
argument_list|)
expr_stmt|;
name|asn_append_oid
argument_list|(
operator|&
operator|(
name|pdu
operator|->
name|bindings
index|[
literal|0
index|]
operator|.
name|var
operator|)
argument_list|,
name|var
argument_list|)
expr_stmt|;
name|pdu
operator|->
name|nbindings
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|snmptool_walk
parameter_list|(
name|struct
name|snmp_toolinfo
modifier|*
name|snmptoolctx
parameter_list|)
block|{
name|struct
name|snmp_pdu
name|req
decl_stmt|,
name|resp
decl_stmt|;
name|struct
name|asn_oid
name|root
decl_stmt|;
comment|/* Keep the initial oid. */
name|int32_t
name|outputs
decl_stmt|,
name|rc
decl_stmt|;
name|uint32_t
name|op
decl_stmt|;
if|if
condition|(
name|GET_PDUTYPE
argument_list|(
name|snmptoolctx
argument_list|)
operator|==
name|SNMP_PDU_GETBULK
condition|)
name|op
operator|=
name|SNMP_PDU_GETBULK
expr_stmt|;
else|else
name|op
operator|=
name|SNMP_PDU_GETNEXT
expr_stmt|;
name|snmp_pdu_create
argument_list|(
operator|&
name|req
argument_list|,
name|op
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|rc
operator|=
name|snmp_pdu_add_bindings
argument_list|(
name|snmptoolctx
argument_list|,
name|NULL
argument_list|,
name|snmptool_add_vbind
argument_list|,
operator|&
name|req
argument_list|,
literal|1
argument_list|)
operator|)
operator|>
literal|0
condition|)
block|{
comment|/* Remember the root where the walk started from. */
name|memset
argument_list|(
operator|&
name|root
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|asn_oid
argument_list|)
argument_list|)
expr_stmt|;
name|asn_append_oid
argument_list|(
operator|&
name|root
argument_list|,
operator|&
operator|(
name|req
operator|.
name|bindings
index|[
literal|0
index|]
operator|.
name|var
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|op
operator|==
name|SNMP_PDU_GETBULK
condition|)
name|snmpget_fix_getbulk
argument_list|(
operator|&
name|req
argument_list|,
name|GET_MAXREP
argument_list|(
name|snmptoolctx
argument_list|)
argument_list|,
name|GET_NONREP
argument_list|(
name|snmptoolctx
argument_list|)
argument_list|)
expr_stmt|;
name|outputs
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|snmp_dialog
argument_list|(
operator|&
name|req
argument_list|,
operator|&
name|resp
argument_list|)
operator|>=
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|snmp_parse_resp
argument_list|(
operator|&
name|resp
argument_list|,
operator|&
name|req
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|snmp_output_err_resp
argument_list|(
name|snmptoolctx
argument_list|,
operator|&
name|resp
argument_list|)
expr_stmt|;
name|snmp_pdu_free
argument_list|(
operator|&
name|resp
argument_list|)
expr_stmt|;
name|outputs
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
name|rc
operator|=
name|snmp_output_resp
argument_list|(
name|snmptoolctx
argument_list|,
operator|&
name|resp
argument_list|,
operator|&
name|root
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|<
literal|0
condition|)
block|{
name|snmp_pdu_free
argument_list|(
operator|&
name|resp
argument_list|)
expr_stmt|;
name|outputs
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
name|outputs
operator|+=
name|rc
expr_stmt|;
name|snmp_pdu_free
argument_list|(
operator|&
name|resp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|u_int
operator|)
name|rc
operator|<
name|resp
operator|.
name|nbindings
condition|)
break|break;
name|snmpwalk_nextpdu_create
argument_list|(
name|op
argument_list|,
operator|&
operator|(
name|resp
operator|.
name|bindings
index|[
name|resp
operator|.
name|nbindings
operator|-
literal|1
index|]
operator|.
name|var
operator|)
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|op
operator|==
name|SNMP_PDU_GETBULK
condition|)
name|snmpget_fix_getbulk
argument_list|(
operator|&
name|req
argument_list|,
name|GET_MAXREP
argument_list|(
name|snmptoolctx
argument_list|)
argument_list|,
name|GET_NONREP
argument_list|(
name|snmptoolctx
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* Just in case our root was a leaf. */
if|if
condition|(
name|outputs
operator|==
literal|0
condition|)
block|{
name|snmpwalk_nextpdu_create
argument_list|(
name|SNMP_PDU_GET
argument_list|,
operator|&
name|root
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|snmp_dialog
argument_list|(
operator|&
name|req
argument_list|,
operator|&
name|resp
argument_list|)
operator|==
name|SNMP_CODE_OK
condition|)
block|{
if|if
condition|(
name|snmp_parse_resp
argument_list|(
operator|&
name|resp
argument_list|,
operator|&
name|req
argument_list|)
operator|<
literal|0
condition|)
name|snmp_output_err_resp
argument_list|(
name|snmptoolctx
argument_list|,
operator|&
name|resp
argument_list|)
expr_stmt|;
else|else
name|snmp_output_resp
argument_list|(
name|snmptoolctx
argument_list|,
operator|&
operator|(
name|resp
operator|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|snmp_pdu_free
argument_list|(
operator|&
name|resp
argument_list|)
expr_stmt|;
block|}
else|else
name|warnx
argument_list|(
literal|"Snmp dialog - %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|snmp_object_remove
argument_list|(
name|snmptoolctx
argument_list|,
operator|&
name|root
argument_list|)
operator|<
literal|0
condition|)
block|{
name|warnx
argument_list|(
literal|"snmp_object_remove"
argument_list|)
expr_stmt|;
break|break;
block|}
name|snmp_pdu_create
argument_list|(
operator|&
name|req
argument_list|,
name|op
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rc
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
else|else
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/* *****************************************************************************  * bsnmpset private functions.  */
end_comment

begin_function
specifier|static
name|int32_t
name|parse_oid_numeric
parameter_list|(
name|struct
name|snmp_value
modifier|*
name|value
parameter_list|,
name|char
modifier|*
name|val
parameter_list|)
block|{
name|char
modifier|*
name|endptr
decl_stmt|;
name|int32_t
name|saved_errno
decl_stmt|;
name|asn_subid_t
name|suboid
decl_stmt|;
do|do
block|{
name|saved_errno
operator|=
name|errno
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|suboid
operator|=
name|strtoul
argument_list|(
name|val
argument_list|,
operator|&
name|endptr
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|errno
operator|!=
literal|0
condition|)
block|{
name|warnx
argument_list|(
literal|"Value %s not supported - %s"
argument_list|,
name|val
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|errno
operator|=
name|saved_errno
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|errno
operator|=
name|saved_errno
expr_stmt|;
if|if
condition|(
operator|(
name|asn_subid_t
operator|)
name|suboid
operator|>
name|ASN_MAXID
condition|)
block|{
name|warnx
argument_list|(
literal|"Suboid %u> ASN_MAXID"
argument_list|,
name|suboid
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|snmp_suboid_append
argument_list|(
operator|&
operator|(
name|value
operator|->
name|v
operator|.
name|oid
operator|)
argument_list|,
name|suboid
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|val
operator|=
name|endptr
operator|+
literal|1
expr_stmt|;
block|}
do|while
condition|(
operator|*
name|endptr
operator|==
literal|'.'
condition|)
do|;
if|if
condition|(
operator|*
name|endptr
operator|!=
literal|'\0'
condition|)
name|warnx
argument_list|(
literal|"OID value %s not supported"
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|value
operator|->
name|syntax
operator|=
name|SNMP_SYNTAX_OID
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Allow OID leaf in both forms:  * 1) 1.3.6.1.2... ->  in such case call directly the function reading raw OIDs;  * 2) begemotSnmpdAgentFreeBSD -> lookup the ASN OID corresponding to that.  */
end_comment

begin_function
specifier|static
name|int32_t
name|parse_oid_string
parameter_list|(
name|struct
name|snmp_toolinfo
modifier|*
name|snmptoolctx
parameter_list|,
name|struct
name|snmp_value
modifier|*
name|value
parameter_list|,
name|char
modifier|*
name|string
parameter_list|)
block|{
name|struct
name|snmp_object
name|obj
decl_stmt|;
if|if
condition|(
name|isdigit
argument_list|(
name|string
index|[
literal|0
index|]
argument_list|)
condition|)
return|return
operator|(
name|parse_oid_numeric
argument_list|(
name|value
argument_list|,
name|string
argument_list|)
operator|)
return|;
name|memset
argument_list|(
operator|&
name|obj
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|snmp_object
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|snmp_lookup_enumoid
argument_list|(
name|snmptoolctx
argument_list|,
operator|&
name|obj
argument_list|,
name|string
argument_list|)
operator|<
literal|0
condition|)
block|{
name|warnx
argument_list|(
literal|"Unknown OID enum string - %s"
argument_list|,
name|string
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|asn_append_oid
argument_list|(
operator|&
operator|(
name|value
operator|->
name|v
operator|.
name|oid
operator|)
argument_list|,
operator|&
operator|(
name|obj
operator|.
name|val
operator|.
name|var
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int32_t
name|parse_ip
parameter_list|(
name|struct
name|snmp_value
modifier|*
name|value
parameter_list|,
name|char
modifier|*
name|val
parameter_list|)
block|{
name|uint32_t
name|v
decl_stmt|;
name|int32_t
name|i
decl_stmt|;
name|char
modifier|*
name|endptr
decl_stmt|,
modifier|*
name|str
decl_stmt|;
name|str
operator|=
name|val
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
name|v
operator|=
name|strtoul
argument_list|(
name|str
argument_list|,
operator|&
name|endptr
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|>
literal|0xff
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
operator|*
name|endptr
operator|!=
literal|'.'
operator|&&
operator|*
name|endptr
operator|!=
literal|'\0'
operator|&&
name|i
operator|!=
literal|3
condition|)
break|break;
name|str
operator|=
name|endptr
operator|+
literal|1
expr_stmt|;
name|value
operator|->
name|v
operator|.
name|ipaddress
index|[
name|i
index|]
operator|=
operator|(
name|uint8_t
operator|)
name|v
expr_stmt|;
block|}
name|value
operator|->
name|syntax
operator|=
name|SNMP_SYNTAX_IPADDRESS
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int32_t
name|parse_int
parameter_list|(
name|struct
name|snmp_value
modifier|*
name|value
parameter_list|,
name|char
modifier|*
name|val
parameter_list|)
block|{
name|char
modifier|*
name|endptr
decl_stmt|;
name|int32_t
name|v
decl_stmt|,
name|saved_errno
decl_stmt|;
name|saved_errno
operator|=
name|errno
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|v
operator|=
name|strtol
argument_list|(
name|val
argument_list|,
operator|&
name|endptr
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|errno
operator|!=
literal|0
condition|)
block|{
name|warnx
argument_list|(
literal|"Value %s not supported - %s"
argument_list|,
name|val
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|errno
operator|=
name|saved_errno
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|value
operator|->
name|syntax
operator|=
name|SNMP_SYNTAX_INTEGER
expr_stmt|;
name|value
operator|->
name|v
operator|.
name|integer
operator|=
name|v
expr_stmt|;
name|errno
operator|=
name|saved_errno
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int32_t
name|parse_int_string
parameter_list|(
name|struct
name|snmp_object
modifier|*
name|object
parameter_list|,
name|char
modifier|*
name|val
parameter_list|)
block|{
name|int32_t
name|v
decl_stmt|;
if|if
condition|(
name|isdigit
argument_list|(
name|val
index|[
literal|0
index|]
argument_list|)
condition|)
return|return
operator|(
operator|(
name|parse_int
argument_list|(
operator|&
operator|(
name|object
operator|->
name|val
operator|)
argument_list|,
name|val
argument_list|)
operator|)
operator|)
return|;
if|if
condition|(
name|object
operator|->
name|info
operator|==
name|NULL
condition|)
block|{
name|warnx
argument_list|(
literal|"Unknown enumerated integer type - %s"
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|v
operator|=
name|enum_number_lookup
argument_list|(
name|object
operator|->
name|info
operator|->
name|snmp_enum
argument_list|,
name|val
argument_list|)
operator|)
operator|<
literal|0
condition|)
name|warnx
argument_list|(
literal|"Unknown enumerated integer type - %s"
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|object
operator|->
name|val
operator|.
name|v
operator|.
name|integer
operator|=
name|v
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Here syntax may be one of SNMP_SYNTAX_COUNTER, SNMP_SYNTAX_GAUGE,  * SNMP_SYNTAX_TIMETICKS.  */
end_comment

begin_function
specifier|static
name|int32_t
name|parse_uint
parameter_list|(
name|struct
name|snmp_value
modifier|*
name|value
parameter_list|,
name|char
modifier|*
name|val
parameter_list|)
block|{
name|char
modifier|*
name|endptr
decl_stmt|;
name|uint32_t
name|v
init|=
literal|0
decl_stmt|;
name|int32_t
name|saved_errno
decl_stmt|;
name|saved_errno
operator|=
name|errno
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|v
operator|=
name|strtoul
argument_list|(
name|val
argument_list|,
operator|&
name|endptr
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|errno
operator|!=
literal|0
condition|)
block|{
name|warnx
argument_list|(
literal|"Value %s not supported - %s"
argument_list|,
name|val
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|errno
operator|=
name|saved_errno
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|value
operator|->
name|v
operator|.
name|uint32
operator|=
name|v
expr_stmt|;
name|errno
operator|=
name|saved_errno
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int32_t
name|parse_ticks
parameter_list|(
name|struct
name|snmp_value
modifier|*
name|value
parameter_list|,
name|char
modifier|*
name|val
parameter_list|)
block|{
if|if
condition|(
name|parse_uint
argument_list|(
name|value
argument_list|,
name|val
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|value
operator|->
name|syntax
operator|=
name|SNMP_SYNTAX_TIMETICKS
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int32_t
name|parse_gauge
parameter_list|(
name|struct
name|snmp_value
modifier|*
name|value
parameter_list|,
name|char
modifier|*
name|val
parameter_list|)
block|{
if|if
condition|(
name|parse_uint
argument_list|(
name|value
argument_list|,
name|val
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|value
operator|->
name|syntax
operator|=
name|SNMP_SYNTAX_GAUGE
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int32_t
name|parse_counter
parameter_list|(
name|struct
name|snmp_value
modifier|*
name|value
parameter_list|,
name|char
modifier|*
name|val
parameter_list|)
block|{
if|if
condition|(
name|parse_uint
argument_list|(
name|value
argument_list|,
name|val
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|value
operator|->
name|syntax
operator|=
name|SNMP_SYNTAX_COUNTER
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int32_t
name|parse_uint64
parameter_list|(
name|struct
name|snmp_value
modifier|*
name|value
parameter_list|,
name|char
modifier|*
name|val
parameter_list|)
block|{
name|char
modifier|*
name|endptr
decl_stmt|;
name|int32_t
name|saved_errno
decl_stmt|;
name|uint64_t
name|v
decl_stmt|;
name|saved_errno
operator|=
name|errno
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|v
operator|=
name|strtoull
argument_list|(
name|val
argument_list|,
operator|&
name|endptr
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|errno
operator|!=
literal|0
condition|)
block|{
name|warnx
argument_list|(
literal|"Value %s not supported - %s"
argument_list|,
name|val
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|errno
operator|=
name|saved_errno
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|value
operator|->
name|syntax
operator|=
name|SNMP_SYNTAX_COUNTER64
expr_stmt|;
name|value
operator|->
name|v
operator|.
name|counter64
operator|=
name|v
expr_stmt|;
name|errno
operator|=
name|saved_errno
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int32_t
name|parse_syntax_val
parameter_list|(
name|struct
name|snmp_value
modifier|*
name|value
parameter_list|,
name|enum
name|snmp_syntax
name|syntax
parameter_list|,
name|char
modifier|*
name|val
parameter_list|)
block|{
switch|switch
condition|(
name|syntax
condition|)
block|{
case|case
name|SNMP_SYNTAX_INTEGER
case|:
return|return
operator|(
name|parse_int
argument_list|(
name|value
argument_list|,
name|val
argument_list|)
operator|)
return|;
case|case
name|SNMP_SYNTAX_IPADDRESS
case|:
return|return
operator|(
name|parse_ip
argument_list|(
name|value
argument_list|,
name|val
argument_list|)
operator|)
return|;
case|case
name|SNMP_SYNTAX_COUNTER
case|:
return|return
operator|(
name|parse_counter
argument_list|(
name|value
argument_list|,
name|val
argument_list|)
operator|)
return|;
case|case
name|SNMP_SYNTAX_GAUGE
case|:
return|return
operator|(
name|parse_gauge
argument_list|(
name|value
argument_list|,
name|val
argument_list|)
operator|)
return|;
case|case
name|SNMP_SYNTAX_TIMETICKS
case|:
return|return
operator|(
name|parse_ticks
argument_list|(
name|value
argument_list|,
name|val
argument_list|)
operator|)
return|;
case|case
name|SNMP_SYNTAX_COUNTER64
case|:
return|return
operator|(
name|parse_uint64
argument_list|(
name|value
argument_list|,
name|val
argument_list|)
operator|)
return|;
case|case
name|SNMP_SYNTAX_OCTETSTRING
case|:
return|return
operator|(
name|snmp_tc2oct
argument_list|(
name|SNMP_STRING
argument_list|,
name|value
argument_list|,
name|val
argument_list|)
operator|)
return|;
case|case
name|SNMP_SYNTAX_OID
case|:
return|return
operator|(
name|parse_oid_numeric
argument_list|(
name|value
argument_list|,
name|val
argument_list|)
operator|)
return|;
default|default:
comment|/* NOTREACHED */
break|break;
block|}
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Parse a command line argument of type OID=syntax:value and fill in whatever   * fields can be derived from the input into snmp_value structure. Reads numeric  * OIDs.  */
end_comment

begin_function
specifier|static
name|int32_t
name|parse_pair_numoid_val
parameter_list|(
name|char
modifier|*
name|str
parameter_list|,
name|struct
name|snmp_value
modifier|*
name|snmp_val
parameter_list|)
block|{
name|int32_t
name|cnt
decl_stmt|;
name|char
modifier|*
name|ptr
decl_stmt|;
name|enum
name|snmp_syntax
name|syntax
decl_stmt|;
name|char
name|oid_str
index|[
name|ASN_OIDSTRLEN
index|]
decl_stmt|;
name|ptr
operator|=
name|str
expr_stmt|;
for|for
control|(
name|cnt
operator|=
literal|0
init|;
name|cnt
operator|<
name|ASN_OIDSTRLEN
condition|;
name|cnt
operator|++
control|)
if|if
condition|(
name|ptr
index|[
name|cnt
index|]
operator|==
literal|'='
condition|)
break|break;
if|if
condition|(
name|cnt
operator|>=
name|ASN_OIDSTRLEN
condition|)
block|{
name|warnx
argument_list|(
literal|"OID too long - %s"
argument_list|,
name|str
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|strlcpy
argument_list|(
name|oid_str
argument_list|,
name|ptr
argument_list|,
call|(
name|size_t
call|)
argument_list|(
name|cnt
operator|+
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|ptr
operator|=
name|str
operator|+
name|cnt
operator|+
literal|1
expr_stmt|;
for|for
control|(
name|cnt
operator|=
literal|0
init|;
name|cnt
operator|<
name|MAX_CMD_SYNTAX_LEN
condition|;
name|cnt
operator|++
control|)
if|if
condition|(
name|ptr
index|[
name|cnt
index|]
operator|==
literal|':'
condition|)
break|break;
if|if
condition|(
name|cnt
operator|>=
name|MAX_CMD_SYNTAX_LEN
condition|)
block|{
name|warnx
argument_list|(
literal|"Unknown syntax in OID - %s"
argument_list|,
name|str
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|syntax
operator|=
name|parse_syntax
argument_list|(
name|ptr
argument_list|)
operator|)
operator|<=
name|SNMP_SYNTAX_NULL
condition|)
block|{
name|warnx
argument_list|(
literal|"Unknown syntax in OID - %s"
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|ptr
operator|=
name|ptr
operator|+
name|cnt
operator|+
literal|1
expr_stmt|;
for|for
control|(
name|cnt
operator|=
literal|0
init|;
name|cnt
operator|<
name|MAX_OCTSTRING_LEN
condition|;
name|cnt
operator|++
control|)
if|if
condition|(
name|ptr
index|[
name|cnt
index|]
operator|==
literal|'\0'
condition|)
break|break;
if|if
condition|(
name|ptr
index|[
name|cnt
index|]
operator|!=
literal|'\0'
condition|)
block|{
name|warnx
argument_list|(
literal|"Value string too long - %s"
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* 	 * Here try parsing the OIDs and syntaxes and then check values - have 	 * to know syntax to check value boundaries. 	 */
if|if
condition|(
name|snmp_parse_numoid
argument_list|(
name|oid_str
argument_list|,
operator|&
operator|(
name|snmp_val
operator|->
name|var
operator|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|warnx
argument_list|(
literal|"Error parsing OID %s"
argument_list|,
name|oid_str
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|parse_syntax_val
argument_list|(
name|snmp_val
argument_list|,
name|syntax
argument_list|,
name|ptr
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/* XXX-BZ aruments should be swapped. */
end_comment

begin_function
specifier|static
name|int32_t
name|parse_syntax_strval
parameter_list|(
name|struct
name|snmp_toolinfo
modifier|*
name|snmptoolctx
parameter_list|,
name|char
modifier|*
name|str
parameter_list|,
name|struct
name|snmp_object
modifier|*
name|object
parameter_list|)
block|{
name|uint32_t
name|len
decl_stmt|;
name|enum
name|snmp_syntax
name|syn
decl_stmt|;
comment|/* 	 * Syntax string here not required  - still may be present. 	 */
if|if
condition|(
name|GET_OUTPUT
argument_list|(
name|snmptoolctx
argument_list|)
operator|==
name|OUTPUT_VERBOSE
condition|)
block|{
for|for
control|(
name|len
operator|=
literal|0
init|;
operator|*
operator|(
name|str
operator|+
name|len
operator|)
operator|!=
literal|':'
condition|;
name|len
operator|++
control|)
block|{
if|if
condition|(
operator|*
operator|(
name|str
operator|+
name|len
operator|)
operator|==
literal|'\0'
condition|)
block|{
name|warnx
argument_list|(
literal|"Syntax missing in value - %s"
argument_list|,
name|str
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
if|if
condition|(
operator|(
name|syn
operator|=
name|parse_syntax
argument_list|(
name|str
argument_list|)
operator|)
operator|<=
name|SNMP_SYNTAX_NULL
condition|)
block|{
name|warnx
argument_list|(
literal|"Unknown syntax in - %s"
argument_list|,
name|str
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|syn
operator|!=
name|object
operator|->
name|val
operator|.
name|syntax
condition|)
block|{
if|if
condition|(
operator|!
name|ISSET_ERRIGNORE
argument_list|(
name|snmptoolctx
argument_list|)
condition|)
block|{
name|warnx
argument_list|(
literal|"Bad syntax in - %s"
argument_list|,
name|str
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
else|else
name|object
operator|->
name|val
operator|.
name|syntax
operator|=
name|syn
expr_stmt|;
block|}
name|len
operator|++
expr_stmt|;
block|}
else|else
name|len
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|object
operator|->
name|val
operator|.
name|syntax
condition|)
block|{
case|case
name|SNMP_SYNTAX_INTEGER
case|:
return|return
operator|(
name|parse_int_string
argument_list|(
name|object
argument_list|,
name|str
operator|+
name|len
argument_list|)
operator|)
return|;
case|case
name|SNMP_SYNTAX_IPADDRESS
case|:
return|return
operator|(
name|parse_ip
argument_list|(
operator|&
operator|(
name|object
operator|->
name|val
operator|)
argument_list|,
name|str
operator|+
name|len
argument_list|)
operator|)
return|;
case|case
name|SNMP_SYNTAX_COUNTER
case|:
return|return
operator|(
name|parse_counter
argument_list|(
operator|&
operator|(
name|object
operator|->
name|val
operator|)
argument_list|,
name|str
operator|+
name|len
argument_list|)
operator|)
return|;
case|case
name|SNMP_SYNTAX_GAUGE
case|:
return|return
operator|(
name|parse_gauge
argument_list|(
operator|&
operator|(
name|object
operator|->
name|val
operator|)
argument_list|,
name|str
operator|+
name|len
argument_list|)
operator|)
return|;
case|case
name|SNMP_SYNTAX_TIMETICKS
case|:
return|return
operator|(
name|parse_ticks
argument_list|(
operator|&
operator|(
name|object
operator|->
name|val
operator|)
argument_list|,
name|str
operator|+
name|len
argument_list|)
operator|)
return|;
case|case
name|SNMP_SYNTAX_COUNTER64
case|:
return|return
operator|(
name|parse_uint64
argument_list|(
operator|&
operator|(
name|object
operator|->
name|val
operator|)
argument_list|,
name|str
operator|+
name|len
argument_list|)
operator|)
return|;
case|case
name|SNMP_SYNTAX_OCTETSTRING
case|:
return|return
operator|(
name|snmp_tc2oct
argument_list|(
name|object
operator|->
name|info
operator|->
name|tc
argument_list|,
operator|&
operator|(
name|object
operator|->
name|val
operator|)
argument_list|,
name|str
operator|+
name|len
argument_list|)
operator|)
return|;
case|case
name|SNMP_SYNTAX_OID
case|:
return|return
operator|(
name|parse_oid_string
argument_list|(
name|snmptoolctx
argument_list|,
operator|&
operator|(
name|object
operator|->
name|val
operator|)
argument_list|,
name|str
operator|+
name|len
argument_list|)
operator|)
return|;
default|default:
comment|/* NOTREACHED */
break|break;
block|}
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int32_t
name|parse_pair_stroid_val
parameter_list|(
name|struct
name|snmp_toolinfo
modifier|*
name|snmptoolctx
parameter_list|,
name|struct
name|snmp_object
modifier|*
name|obj
parameter_list|,
name|char
modifier|*
name|argv
parameter_list|)
block|{
name|char
modifier|*
name|ptr
decl_stmt|;
if|if
condition|(
operator|(
name|ptr
operator|=
name|snmptools_parse_stroid
argument_list|(
name|snmptoolctx
argument_list|,
name|obj
argument_list|,
name|argv
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
operator|*
name|ptr
operator|!=
literal|'='
condition|)
block|{
name|warnx
argument_list|(
literal|"Value to set expected after OID"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|parse_syntax_strval
argument_list|(
name|snmptoolctx
argument_list|,
name|ptr
operator|+
literal|1
argument_list|,
name|obj
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int32_t
name|snmpset_parse_oid
parameter_list|(
name|struct
name|snmp_toolinfo
modifier|*
name|snmptoolctx
parameter_list|,
name|struct
name|snmp_object
modifier|*
name|obj
parameter_list|,
name|char
modifier|*
name|argv
parameter_list|)
block|{
if|if
condition|(
name|argv
operator|==
name|NULL
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|ISSET_NUMERIC
argument_list|(
name|snmptoolctx
argument_list|)
condition|)
block|{
if|if
condition|(
name|parse_pair_numoid_val
argument_list|(
name|argv
argument_list|,
operator|&
operator|(
name|obj
operator|->
name|val
operator|)
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
else|else
block|{
if|if
condition|(
name|parse_pair_stroid_val
argument_list|(
name|snmptoolctx
argument_list|,
name|obj
argument_list|,
name|argv
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int32_t
name|add_ip_syntax
parameter_list|(
name|struct
name|snmp_value
modifier|*
name|dst
parameter_list|,
name|struct
name|snmp_value
modifier|*
name|src
parameter_list|)
block|{
name|int8_t
name|i
decl_stmt|;
name|dst
operator|->
name|syntax
operator|=
name|SNMP_SYNTAX_IPADDRESS
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
name|dst
operator|->
name|v
operator|.
name|ipaddress
index|[
name|i
index|]
operator|=
name|src
operator|->
name|v
operator|.
name|ipaddress
index|[
name|i
index|]
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int32_t
name|add_octstring_syntax
parameter_list|(
name|struct
name|snmp_value
modifier|*
name|dst
parameter_list|,
name|struct
name|snmp_value
modifier|*
name|src
parameter_list|)
block|{
if|if
condition|(
name|src
operator|->
name|v
operator|.
name|octetstring
operator|.
name|len
operator|>
name|ASN_MAXOCTETSTRING
condition|)
block|{
name|warnx
argument_list|(
literal|"OctetString len too big - %u"
argument_list|,
name|src
operator|->
name|v
operator|.
name|octetstring
operator|.
name|len
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|dst
operator|->
name|v
operator|.
name|octetstring
operator|.
name|octets
operator|=
name|malloc
argument_list|(
name|src
operator|->
name|v
operator|.
name|octetstring
operator|.
name|len
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"malloc() failed - %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|memcpy
argument_list|(
name|dst
operator|->
name|v
operator|.
name|octetstring
operator|.
name|octets
argument_list|,
name|src
operator|->
name|v
operator|.
name|octetstring
operator|.
name|octets
argument_list|,
name|src
operator|->
name|v
operator|.
name|octetstring
operator|.
name|len
argument_list|)
expr_stmt|;
name|dst
operator|->
name|syntax
operator|=
name|SNMP_SYNTAX_OCTETSTRING
expr_stmt|;
name|dst
operator|->
name|v
operator|.
name|octetstring
operator|.
name|len
operator|=
name|src
operator|->
name|v
operator|.
name|octetstring
operator|.
name|len
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int32_t
name|add_oid_syntax
parameter_list|(
name|struct
name|snmp_value
modifier|*
name|dst
parameter_list|,
name|struct
name|snmp_value
modifier|*
name|src
parameter_list|)
block|{
name|asn_append_oid
argument_list|(
operator|&
operator|(
name|dst
operator|->
name|v
operator|.
name|oid
operator|)
argument_list|,
operator|&
operator|(
name|src
operator|->
name|v
operator|.
name|oid
operator|)
argument_list|)
expr_stmt|;
name|dst
operator|->
name|syntax
operator|=
name|SNMP_SYNTAX_OID
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Check syntax - if one of SNMP_SYNTAX_NULL, SNMP_SYNTAX_NOSUCHOBJECT,  * SNMP_SYNTAX_NOSUCHINSTANCE, SNMP_SYNTAX_ENDOFMIBVIEW or anything not known -  * return error.  */
end_comment

begin_function
specifier|static
name|int32_t
name|snmpset_add_value
parameter_list|(
name|struct
name|snmp_value
modifier|*
name|dst
parameter_list|,
name|struct
name|snmp_value
modifier|*
name|src
parameter_list|)
block|{
if|if
condition|(
name|dst
operator|==
name|NULL
operator|||
name|src
operator|==
name|NULL
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
switch|switch
condition|(
name|src
operator|->
name|syntax
condition|)
block|{
case|case
name|SNMP_SYNTAX_INTEGER
case|:
name|dst
operator|->
name|v
operator|.
name|integer
operator|=
name|src
operator|->
name|v
operator|.
name|integer
expr_stmt|;
name|dst
operator|->
name|syntax
operator|=
name|SNMP_SYNTAX_INTEGER
expr_stmt|;
break|break;
case|case
name|SNMP_SYNTAX_TIMETICKS
case|:
name|dst
operator|->
name|v
operator|.
name|uint32
operator|=
name|src
operator|->
name|v
operator|.
name|uint32
expr_stmt|;
name|dst
operator|->
name|syntax
operator|=
name|SNMP_SYNTAX_TIMETICKS
expr_stmt|;
break|break;
case|case
name|SNMP_SYNTAX_GAUGE
case|:
name|dst
operator|->
name|v
operator|.
name|uint32
operator|=
name|src
operator|->
name|v
operator|.
name|uint32
expr_stmt|;
name|dst
operator|->
name|syntax
operator|=
name|SNMP_SYNTAX_GAUGE
expr_stmt|;
break|break;
case|case
name|SNMP_SYNTAX_COUNTER
case|:
name|dst
operator|->
name|v
operator|.
name|uint32
operator|=
name|src
operator|->
name|v
operator|.
name|uint32
expr_stmt|;
name|dst
operator|->
name|syntax
operator|=
name|SNMP_SYNTAX_COUNTER
expr_stmt|;
break|break;
case|case
name|SNMP_SYNTAX_COUNTER64
case|:
name|dst
operator|->
name|v
operator|.
name|counter64
operator|=
name|src
operator|->
name|v
operator|.
name|counter64
expr_stmt|;
name|dst
operator|->
name|syntax
operator|=
name|SNMP_SYNTAX_COUNTER64
expr_stmt|;
break|break;
case|case
name|SNMP_SYNTAX_IPADDRESS
case|:
name|add_ip_syntax
argument_list|(
name|dst
argument_list|,
name|src
argument_list|)
expr_stmt|;
break|break;
case|case
name|SNMP_SYNTAX_OCTETSTRING
case|:
name|add_octstring_syntax
argument_list|(
name|dst
argument_list|,
name|src
argument_list|)
expr_stmt|;
break|break;
case|case
name|SNMP_SYNTAX_OID
case|:
name|add_oid_syntax
argument_list|(
name|dst
argument_list|,
name|src
argument_list|)
expr_stmt|;
break|break;
default|default:
name|warnx
argument_list|(
literal|"Unknown syntax %d"
argument_list|,
name|src
operator|->
name|syntax
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int32_t
name|snmpset_verify_vbind
parameter_list|(
name|struct
name|snmp_toolinfo
modifier|*
name|snmptoolctx
parameter_list|,
name|struct
name|snmp_pdu
modifier|*
name|pdu
parameter_list|,
name|struct
name|snmp_object
modifier|*
name|obj
parameter_list|)
block|{
if|if
condition|(
name|pdu
operator|->
name|version
operator|==
name|SNMP_V1
operator|&&
name|obj
operator|->
name|val
operator|.
name|syntax
operator|==
name|SNMP_SYNTAX_COUNTER64
condition|)
block|{
name|warnx
argument_list|(
literal|"64-bit counters are not supported in SNMPv1 PDU"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|ISSET_NUMERIC
argument_list|(
name|snmptoolctx
argument_list|)
operator|||
name|ISSET_ERRIGNORE
argument_list|(
name|snmptoolctx
argument_list|)
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
name|obj
operator|->
name|info
operator|->
name|access
operator|<
name|SNMP_ACCESS_SET
condition|)
block|{
name|warnx
argument_list|(
literal|"Object %s not accessible for set - try 'bsnmpset -a'"
argument_list|,
name|obj
operator|->
name|info
operator|->
name|string
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int32_t
name|snmpset_add_vbind
parameter_list|(
name|struct
name|snmp_pdu
modifier|*
name|pdu
parameter_list|,
name|struct
name|snmp_object
modifier|*
name|obj
parameter_list|)
block|{
if|if
condition|(
name|pdu
operator|->
name|nbindings
operator|>
name|SNMP_MAX_BINDINGS
condition|)
block|{
name|warnx
argument_list|(
literal|"Too many OIDs for one PDU"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|obj
operator|->
name|error
operator|>
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|snmpset_add_value
argument_list|(
operator|&
operator|(
name|pdu
operator|->
name|bindings
index|[
name|pdu
operator|->
name|nbindings
index|]
operator|)
argument_list|,
operator|&
operator|(
name|obj
operator|->
name|val
operator|)
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|asn_append_oid
argument_list|(
operator|&
operator|(
name|pdu
operator|->
name|bindings
index|[
name|pdu
operator|->
name|nbindings
index|]
operator|.
name|var
operator|)
argument_list|,
operator|&
operator|(
name|obj
operator|->
name|val
operator|.
name|var
operator|)
argument_list|)
expr_stmt|;
name|pdu
operator|->
name|nbindings
operator|++
expr_stmt|;
return|return
operator|(
name|pdu
operator|->
name|nbindings
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|snmptool_set
parameter_list|(
name|struct
name|snmp_toolinfo
modifier|*
name|snmptoolctx
parameter_list|)
block|{
name|struct
name|snmp_pdu
name|req
decl_stmt|,
name|resp
decl_stmt|;
name|snmp_pdu_create
argument_list|(
operator|&
name|req
argument_list|,
name|SNMP_PDU_SET
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|snmp_pdu_add_bindings
argument_list|(
name|snmptoolctx
argument_list|,
name|snmpset_verify_vbind
argument_list|,
name|snmpset_add_vbind
argument_list|,
operator|&
name|req
argument_list|,
name|SNMP_MAX_BINDINGS
argument_list|)
operator|)
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|snmp_dialog
argument_list|(
operator|&
name|req
argument_list|,
operator|&
name|resp
argument_list|)
condition|)
block|{
name|warnx
argument_list|(
literal|"Snmp dialog - %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|snmp_pdu_check
argument_list|(
operator|&
name|req
argument_list|,
operator|&
name|resp
argument_list|)
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|GET_OUTPUT
argument_list|(
name|snmptoolctx
argument_list|)
operator|!=
name|OUTPUT_QUIET
condition|)
name|snmp_output_resp
argument_list|(
name|snmptoolctx
argument_list|,
operator|&
name|resp
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
break|break;
block|}
name|snmp_output_err_resp
argument_list|(
name|snmptoolctx
argument_list|,
operator|&
name|resp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ISSET_RETRY
argument_list|(
name|snmptoolctx
argument_list|)
condition|)
break|break;
if|if
condition|(
name|snmp_object_seterror
argument_list|(
name|snmptoolctx
argument_list|,
operator|&
operator|(
name|resp
operator|.
name|bindings
index|[
name|resp
operator|.
name|error_index
operator|-
literal|1
index|]
operator|)
argument_list|,
name|resp
operator|.
name|error_status
argument_list|)
operator|<=
literal|0
condition|)
break|break;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Retrying...\n"
argument_list|)
expr_stmt|;
name|snmp_pdu_free
argument_list|(
operator|&
name|req
argument_list|)
expr_stmt|;
name|snmp_pdu_free
argument_list|(
operator|&
name|resp
argument_list|)
expr_stmt|;
name|snmp_pdu_create
argument_list|(
operator|&
name|req
argument_list|,
name|SNMP_PDU_SET
argument_list|)
expr_stmt|;
block|}
name|snmp_pdu_free
argument_list|(
operator|&
name|resp
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* *****************************************************************************  * main  */
end_comment

begin_comment
comment|/*  * According to command line options prepare SNMP Get | GetNext | GetBulk PDU.  * Wait for a response and print it.  */
end_comment

begin_comment
comment|/*  * Do a 'snmp walk' - according to command line options request for values  * lexicographically subsequent and subrooted at a common node. Send a GetNext  * PDU requesting the value for each next variable and print the response. Stop  * when a Response PDU is received that contains the value of a variable not  * subrooted at the variable the walk started.  */
end_comment

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|struct
name|snmp_toolinfo
name|snmptoolctx
decl_stmt|;
name|int32_t
name|oid_cnt
decl_stmt|,
name|last_oid
decl_stmt|,
name|opt_num
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
comment|/* Make sure program_name is set and valid. */
if|if
condition|(
operator|*
name|argv
operator|==
name|NULL
condition|)
name|program_name
operator|=
literal|"snmptool"
expr_stmt|;
else|else
block|{
name|program_name
operator|=
name|strrchr
argument_list|(
operator|*
name|argv
argument_list|,
literal|'/'
argument_list|)
expr_stmt|;
if|if
condition|(
name|program_name
operator|!=
name|NULL
condition|)
name|program_name
operator|++
expr_stmt|;
else|else
name|program_name
operator|=
operator|*
name|argv
expr_stmt|;
block|}
if|if
condition|(
name|program_name
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Error: No program name?\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|program_name
argument_list|,
literal|"bsnmpget"
argument_list|)
operator|==
literal|0
condition|)
name|program
operator|=
name|BSNMPGET
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|program_name
argument_list|,
literal|"bsnmpwalk"
argument_list|)
operator|==
literal|0
condition|)
name|program
operator|=
name|BSNMPWALK
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|program_name
argument_list|,
literal|"bsnmpset"
argument_list|)
operator|==
literal|0
condition|)
name|program
operator|=
name|BSNMPSET
expr_stmt|;
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Unknown snmp tool name '%s'.\n"
argument_list|,
name|program_name
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* Initialize. */
if|if
condition|(
name|snmptool_init
argument_list|(
operator|&
name|snmptoolctx
argument_list|)
operator|<
literal|0
condition|)
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|opt_num
operator|=
name|snmptool_parse_options
argument_list|(
operator|&
name|snmptoolctx
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|snmp_tool_freeall
argument_list|(
operator|&
name|snmptoolctx
argument_list|)
expr_stmt|;
comment|/* On -h (help) exit without error. */
if|if
condition|(
name|opt_num
operator|==
operator|-
literal|2
condition|)
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
else|else
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|oid_cnt
operator|=
name|argc
operator|-
name|opt_num
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|oid_cnt
operator|==
literal|0
condition|)
block|{
switch|switch
condition|(
name|program
condition|)
block|{
case|case
name|BSNMPGET
case|:
if|if
condition|(
operator|!
name|ISSET_EDISCOVER
argument_list|(
operator|&
name|snmptoolctx
argument_list|)
operator|&&
operator|!
name|ISSET_LOCALKEY
argument_list|(
operator|&
name|snmptoolctx
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"No OID given.\n"
argument_list|)
expr_stmt|;
name|usage
argument_list|()
expr_stmt|;
name|snmp_tool_freeall
argument_list|(
operator|&
name|snmptoolctx
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|BSNMPWALK
case|:
if|if
condition|(
name|snmp_object_add
argument_list|(
operator|&
name|snmptoolctx
argument_list|,
name|snmpwalk_add_default
argument_list|,
name|NULL
argument_list|)
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Error setting default subtree.\n"
argument_list|)
expr_stmt|;
name|snmp_tool_freeall
argument_list|(
operator|&
name|snmptoolctx
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|BSNMPSET
case|:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"No OID given.\n"
argument_list|)
expr_stmt|;
name|usage
argument_list|()
expr_stmt|;
name|snmp_tool_freeall
argument_list|(
operator|&
name|snmptoolctx
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|snmp_import_all
argument_list|(
operator|&
name|snmptoolctx
argument_list|)
operator|<
literal|0
condition|)
block|{
name|snmp_tool_freeall
argument_list|(
operator|&
name|snmptoolctx
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* A simple sanity check - can not send GETBULK when using SNMPv1. */
if|if
condition|(
name|program
operator|==
name|BSNMPGET
operator|&&
name|snmp_client
operator|.
name|version
operator|==
name|SNMP_V1
operator|&&
name|GET_PDUTYPE
argument_list|(
operator|&
name|snmptoolctx
argument_list|)
operator|==
name|SNMP_PDU_GETBULK
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Cannot send GETBULK PDU with SNMPv1.\n"
argument_list|)
expr_stmt|;
name|snmp_tool_freeall
argument_list|(
operator|&
name|snmptoolctx
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|last_oid
operator|=
name|argc
operator|-
literal|1
init|;
name|oid_cnt
operator|>
literal|0
condition|;
name|last_oid
operator|--
operator|,
name|oid_cnt
operator|--
control|)
block|{
if|if
condition|(
operator|(
name|snmp_object_add
argument_list|(
operator|&
name|snmptoolctx
argument_list|,
operator|(
name|program
operator|==
name|BSNMPSET
operator|)
condition|?
name|snmpset_parse_oid
else|:
name|snmptools_parse_oid
argument_list|,
name|argv
index|[
name|last_oid
index|]
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Error parsing OID string '%s'.\n"
argument_list|,
name|argv
index|[
name|last_oid
index|]
argument_list|)
expr_stmt|;
name|snmp_tool_freeall
argument_list|(
operator|&
name|snmptoolctx
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|snmp_open
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|warnx
argument_list|(
literal|"Failed to open snmp session: %s."
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|snmp_tool_freeall
argument_list|(
operator|&
name|snmptoolctx
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|snmp_client
operator|.
name|version
operator|==
name|SNMP_V3
operator|&&
name|snmp_client
operator|.
name|engine
operator|.
name|engine_len
operator|==
literal|0
condition|)
name|SET_EDISCOVER
argument_list|(
operator|&
name|snmptoolctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|ISSET_EDISCOVER
argument_list|(
operator|&
name|snmptoolctx
argument_list|)
operator|&&
name|snmp_discover_engine
argument_list|(
name|snmptoolctx
operator|.
name|passwd
argument_list|)
operator|<
literal|0
condition|)
block|{
name|warnx
argument_list|(
literal|"Unknown SNMP Engine ID: %s."
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|rc
operator|=
literal|1
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
if|if
condition|(
name|GET_OUTPUT
argument_list|(
operator|&
name|snmptoolctx
argument_list|)
operator|==
name|OUTPUT_VERBOSE
operator|||
name|ISSET_EDISCOVER
argument_list|(
operator|&
name|snmptoolctx
argument_list|)
condition|)
name|snmp_output_engine
argument_list|()
expr_stmt|;
if|if
condition|(
name|snmp_client
operator|.
name|version
operator|==
name|SNMP_V3
operator|&&
name|ISSET_LOCALKEY
argument_list|(
operator|&
name|snmptoolctx
argument_list|)
operator|&&
operator|!
name|ISSET_EDISCOVER
argument_list|(
operator|&
name|snmptoolctx
argument_list|)
condition|)
block|{
if|if
condition|(
name|snmp_passwd_to_keys
argument_list|(
operator|&
name|snmp_client
operator|.
name|user
argument_list|,
name|snmptoolctx
operator|.
name|passwd
argument_list|)
operator|!=
name|SNMP_CODE_OK
operator|||
name|snmp_get_local_keys
argument_list|(
operator|&
name|snmp_client
operator|.
name|user
argument_list|,
name|snmp_client
operator|.
name|engine
operator|.
name|engine_id
argument_list|,
name|snmp_client
operator|.
name|engine
operator|.
name|engine_len
argument_list|)
operator|!=
name|SNMP_CODE_OK
condition|)
block|{
name|warnx
argument_list|(
literal|"Failed to get keys: %s."
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|rc
operator|=
literal|1
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
block|}
if|if
condition|(
name|GET_OUTPUT
argument_list|(
operator|&
name|snmptoolctx
argument_list|)
operator|==
name|OUTPUT_VERBOSE
operator|||
name|ISSET_EDISCOVER
argument_list|(
operator|&
name|snmptoolctx
argument_list|)
condition|)
name|snmp_output_keys
argument_list|()
expr_stmt|;
if|if
condition|(
name|ISSET_EDISCOVER
argument_list|(
operator|&
name|snmptoolctx
argument_list|)
operator|&&
name|snmptoolctx
operator|.
name|objects
operator|==
literal|0
condition|)
goto|goto
name|cleanup
goto|;
switch|switch
condition|(
name|program
condition|)
block|{
case|case
name|BSNMPGET
case|:
name|rc
operator|=
name|snmptool_get
argument_list|(
operator|&
name|snmptoolctx
argument_list|)
expr_stmt|;
break|break;
case|case
name|BSNMPWALK
case|:
name|rc
operator|=
name|snmptool_walk
argument_list|(
operator|&
name|snmptoolctx
argument_list|)
expr_stmt|;
break|break;
case|case
name|BSNMPSET
case|:
name|rc
operator|=
name|snmptool_set
argument_list|(
operator|&
name|snmptoolctx
argument_list|)
expr_stmt|;
break|break;
block|}
name|cleanup
label|:
name|snmp_tool_freeall
argument_list|(
operator|&
name|snmptoolctx
argument_list|)
expr_stmt|;
name|snmp_close
argument_list|()
expr_stmt|;
name|exit
argument_list|(
name|rc
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


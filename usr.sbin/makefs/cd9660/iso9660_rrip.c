begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	$NetBSD: iso9660_rrip.c,v 1.11 2012/04/29 13:32:21 joerg Exp $	*/
end_comment

begin_comment
comment|/*  * Copyright (c) 2005 Daniel Watt, Walter Deignan, Ryan Gabrys, Alan  * Perez-Rathke and Ram Vedam.  All rights reserved.  *  * This code was written by Daniel Watt, Walter Deignan, Ryan Gabrys,  * Alan Perez-Rathke and Ram Vedam.  *  * Redistribution and use in source and binary forms, with or  * without modification, are permitted provided that the following  * conditions are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above  *    copyright notice, this list of conditions and the following  *    disclaimer in the documentation and/or other materials provided  *    with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY DANIEL WATT, WALTER DEIGNAN, RYAN  * GABRYS, ALAN PEREZ-RATHKE AND RAM VEDAM ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE  * DISCLAIMED.  IN NO EVENT SHALL DANIEL WATT, WALTER DEIGNAN, RYAN  * GABRYS, ALAN PEREZ-RATHKE AND RAM VEDAM BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF  * USE,DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY  * OF SUCH DAMAGE.  */
end_comment

begin_comment
comment|/* This will hold all the function definitions  * defined in iso9660_rrip.h  */
end_comment

begin_include
include|#
directive|include
file|"makefs.h"
end_include

begin_include
include|#
directive|include
file|"cd9660.h"
end_include

begin_include
include|#
directive|include
file|"iso9660_rrip.h"
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function_decl
specifier|static
name|void
name|cd9660_rrip_initialize_inode
parameter_list|(
name|cd9660node
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|cd9660_susp_handle_continuation
parameter_list|(
name|cd9660node
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|cd9660_susp_handle_continuation_common
parameter_list|(
name|cd9660node
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|int
name|cd9660_susp_initialize
parameter_list|(
name|cd9660node
modifier|*
name|node
parameter_list|,
name|cd9660node
modifier|*
name|parent
parameter_list|,
name|cd9660node
modifier|*
name|grandparent
parameter_list|)
block|{
name|cd9660node
modifier|*
name|cn
decl_stmt|;
name|int
name|r
decl_stmt|;
comment|/* Make sure the node is not NULL. If it is, there are major problems */
name|assert
argument_list|(
name|node
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|node
operator|->
name|type
operator|&
name|CD9660_TYPE_DOT
operator|)
operator|&&
operator|!
operator|(
name|node
operator|->
name|type
operator|&
name|CD9660_TYPE_DOTDOT
operator|)
condition|)
name|TAILQ_INIT
argument_list|(
operator|&
operator|(
name|node
operator|->
name|head
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|->
name|dot_record
operator|!=
literal|0
condition|)
name|TAILQ_INIT
argument_list|(
operator|&
operator|(
name|node
operator|->
name|dot_record
operator|->
name|head
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|->
name|dot_dot_record
operator|!=
literal|0
condition|)
name|TAILQ_INIT
argument_list|(
operator|&
operator|(
name|node
operator|->
name|dot_dot_record
operator|->
name|head
operator|)
argument_list|)
expr_stmt|;
comment|/* SUSP specific entries here */
if|if
condition|(
operator|(
name|r
operator|=
name|cd9660_susp_initialize_node
argument_list|(
name|node
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|r
return|;
comment|/* currently called cd9660node_rrip_init_links */
name|r
operator|=
name|cd9660_rrip_initialize_node
argument_list|(
name|node
argument_list|,
name|parent
argument_list|,
name|grandparent
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|<
literal|0
condition|)
return|return
name|r
return|;
comment|/* 	 * See if we need a CE record, and set all of the 	 * associated counters. 	 * 	 * This should be called after all extensions. After 	 * this is called, no new records should be added. 	 */
if|if
condition|(
operator|(
name|r
operator|=
name|cd9660_susp_handle_continuation
argument_list|(
name|node
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|r
return|;
comment|/* Recurse on children. */
name|TAILQ_FOREACH
argument_list|(
argument|cn
argument_list|,
argument|&node->cn_children
argument_list|,
argument|cn_next_child
argument_list|)
block|{
if|if
condition|(
operator|(
name|r
operator|=
name|cd9660_susp_initialize
argument_list|(
name|cn
argument_list|,
name|node
argument_list|,
name|parent
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
literal|0
return|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_function
name|int
name|cd9660_susp_finalize
parameter_list|(
name|cd9660node
modifier|*
name|node
parameter_list|)
block|{
name|cd9660node
modifier|*
name|temp
decl_stmt|;
name|int
name|r
decl_stmt|;
name|assert
argument_list|(
name|node
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|==
name|diskStructure
operator|.
name|rootNode
condition|)
name|diskStructure
operator|.
name|susp_continuation_area_current_free
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|r
operator|=
name|cd9660_susp_finalize_node
argument_list|(
name|node
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|r
return|;
if|if
condition|(
operator|(
name|r
operator|=
name|cd9660_rrip_finalize_node
argument_list|(
name|node
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|r
return|;
name|TAILQ_FOREACH
argument_list|(
argument|temp
argument_list|,
argument|&node->cn_children
argument_list|,
argument|cn_next_child
argument_list|)
block|{
if|if
condition|(
operator|(
name|r
operator|=
name|cd9660_susp_finalize
argument_list|(
name|temp
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|r
return|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/*  * If we really wanted to speed things up, we could have some sort of  * lookup table on the SUSP entry type that calls a functor. Or, we could  * combine the functions. These functions are kept separate to allow  * easier addition of other extensions.   * For the sake of simplicity and clarity, we won't be doing that for now.  */
end_comment

begin_comment
comment|/*  * SUSP needs to update the following types:  * CE (continuation area)  */
end_comment

begin_function
name|int
name|cd9660_susp_finalize_node
parameter_list|(
name|cd9660node
modifier|*
name|node
parameter_list|)
block|{
name|struct
name|ISO_SUSP_ATTRIBUTES
modifier|*
name|t
decl_stmt|;
comment|/* Handle CE counters */
if|if
condition|(
name|node
operator|->
name|susp_entry_ce_length
operator|>
literal|0
condition|)
block|{
name|node
operator|->
name|susp_entry_ce_start
operator|=
name|diskStructure
operator|.
name|susp_continuation_area_current_free
expr_stmt|;
name|diskStructure
operator|.
name|susp_continuation_area_current_free
operator|+=
name|node
operator|->
name|susp_entry_ce_length
expr_stmt|;
block|}
name|TAILQ_FOREACH
argument_list|(
argument|t
argument_list|,
argument|&node->head
argument_list|,
argument|rr_ll
argument_list|)
block|{
if|if
condition|(
name|t
operator|->
name|susp_type
operator|!=
name|SUSP_TYPE_SUSP
operator|||
name|t
operator|->
name|entry_type
operator|!=
name|SUSP_ENTRY_SUSP_CE
condition|)
continue|continue;
name|cd9660_bothendian_dword
argument_list|(
name|diskStructure
operator|.
name|susp_continuation_area_start_sector
argument_list|,
name|t
operator|->
name|attr
operator|.
name|su_entry
operator|.
name|CE
operator|.
name|ca_sector
argument_list|)
expr_stmt|;
name|cd9660_bothendian_dword
argument_list|(
name|diskStructure
operator|.
name|susp_continuation_area_start_sector
argument_list|,
name|t
operator|->
name|attr
operator|.
name|su_entry
operator|.
name|CE
operator|.
name|ca_sector
argument_list|)
expr_stmt|;
name|cd9660_bothendian_dword
argument_list|(
name|node
operator|->
name|susp_entry_ce_start
argument_list|,
name|t
operator|->
name|attr
operator|.
name|su_entry
operator|.
name|CE
operator|.
name|offset
argument_list|)
expr_stmt|;
name|cd9660_bothendian_dword
argument_list|(
name|node
operator|->
name|susp_entry_ce_length
argument_list|,
name|t
operator|->
name|attr
operator|.
name|su_entry
operator|.
name|CE
operator|.
name|length
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|cd9660_rrip_finalize_node
parameter_list|(
name|cd9660node
modifier|*
name|node
parameter_list|)
block|{
name|struct
name|ISO_SUSP_ATTRIBUTES
modifier|*
name|t
decl_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|t
argument_list|,
argument|&node->head
argument_list|,
argument|rr_ll
argument_list|)
block|{
if|if
condition|(
name|t
operator|->
name|susp_type
operator|!=
name|SUSP_TYPE_RRIP
condition|)
continue|continue;
switch|switch
condition|(
name|t
operator|->
name|entry_type
condition|)
block|{
case|case
name|SUSP_ENTRY_RRIP_CL
case|:
comment|/* Look at rr_relocated*/
if|if
condition|(
name|node
operator|->
name|rr_relocated
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|cd9660_bothendian_dword
argument_list|(
name|node
operator|->
name|rr_relocated
operator|->
name|fileDataSector
argument_list|,
operator|(
name|unsigned
name|char
operator|*
operator|)
name|t
operator|->
name|attr
operator|.
name|rr_entry
operator|.
name|CL
operator|.
name|dir_loc
argument_list|)
expr_stmt|;
break|break;
case|case
name|SUSP_ENTRY_RRIP_PL
case|:
comment|/* Look at rr_real_parent */
if|if
condition|(
name|node
operator|->
name|parent
operator|==
name|NULL
operator|||
name|node
operator|->
name|parent
operator|->
name|rr_real_parent
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|cd9660_bothendian_dword
argument_list|(
name|node
operator|->
name|parent
operator|->
name|rr_real_parent
operator|->
name|fileDataSector
argument_list|,
operator|(
name|unsigned
name|char
operator|*
operator|)
name|t
operator|->
name|attr
operator|.
name|rr_entry
operator|.
name|PL
operator|.
name|dir_loc
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cd9660_susp_handle_continuation_common
parameter_list|(
name|cd9660node
modifier|*
name|node
parameter_list|,
name|int
name|space
parameter_list|)
block|{
name|int
name|ca_used
decl_stmt|,
name|susp_used
decl_stmt|,
name|susp_used_pre_ce
decl_stmt|,
name|working
decl_stmt|;
name|struct
name|ISO_SUSP_ATTRIBUTES
modifier|*
name|temp
decl_stmt|,
modifier|*
name|pre_ce
decl_stmt|,
modifier|*
name|last
decl_stmt|,
modifier|*
name|CE
decl_stmt|,
modifier|*
name|ST
decl_stmt|;
name|pre_ce
operator|=
name|last
operator|=
name|NULL
expr_stmt|;
name|working
operator|=
literal|254
operator|-
name|space
expr_stmt|;
if|if
condition|(
name|node
operator|->
name|su_tail_size
operator|>
literal|0
condition|)
comment|/* Allow 4 bytes for "ST" record. */
name|working
operator|-=
name|node
operator|->
name|su_tail_size
operator|+
literal|4
expr_stmt|;
comment|/* printf("There are %i bytes to work with\n",working); */
name|susp_used_pre_ce
operator|=
name|susp_used
operator|=
literal|0
expr_stmt|;
name|ca_used
operator|=
literal|0
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|temp
argument_list|,
argument|&node->head
argument_list|,
argument|rr_ll
argument_list|)
block|{
if|if
condition|(
name|working
operator|<
literal|0
condition|)
break|break;
comment|/* 		 * printf("SUSP Entry found, length is %i\n", 		 * CD9660_SUSP_ENTRY_SIZE(temp)); 		 */
name|working
operator|-=
name|CD9660_SUSP_ENTRY_SIZE
argument_list|(
name|temp
argument_list|)
expr_stmt|;
if|if
condition|(
name|working
operator|>=
literal|0
condition|)
block|{
name|last
operator|=
name|temp
expr_stmt|;
name|susp_used
operator|+=
name|CD9660_SUSP_ENTRY_SIZE
argument_list|(
name|temp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|working
operator|>=
literal|28
condition|)
block|{
comment|/* 			 * Remember the last entry after which we 			 * could insert a "CE" entry. 			 */
name|pre_ce
operator|=
name|last
expr_stmt|;
name|susp_used_pre_ce
operator|=
name|susp_used
expr_stmt|;
block|}
block|}
comment|/* A CE entry is needed */
if|if
condition|(
name|working
operator|<=
literal|0
condition|)
block|{
name|CE
operator|=
name|cd9660node_susp_create_node
argument_list|(
name|SUSP_TYPE_SUSP
argument_list|,
name|SUSP_ENTRY_SUSP_CE
argument_list|,
literal|"CE"
argument_list|,
name|SUSP_LOC_ENTRY
argument_list|)
expr_stmt|;
name|cd9660_susp_ce
argument_list|(
name|CE
argument_list|,
name|node
argument_list|)
expr_stmt|;
comment|/* This will automatically insert at the appropriate location */
if|if
condition|(
name|pre_ce
operator|!=
name|NULL
condition|)
name|TAILQ_INSERT_AFTER
argument_list|(
operator|&
name|node
operator|->
name|head
argument_list|,
name|pre_ce
argument_list|,
name|CE
argument_list|,
name|rr_ll
argument_list|)
expr_stmt|;
else|else
name|TAILQ_INSERT_HEAD
argument_list|(
operator|&
name|node
operator|->
name|head
argument_list|,
name|CE
argument_list|,
name|rr_ll
argument_list|)
expr_stmt|;
name|last
operator|=
name|CE
expr_stmt|;
name|susp_used
operator|=
name|susp_used_pre_ce
operator|+
literal|28
expr_stmt|;
comment|/* Count how much CA data is necessary */
for|for
control|(
name|temp
operator|=
name|TAILQ_NEXT
argument_list|(
name|last
argument_list|,
name|rr_ll
argument_list|)
init|;
name|temp
operator|!=
name|NULL
condition|;
name|temp
operator|=
name|TAILQ_NEXT
argument_list|(
name|temp
argument_list|,
name|rr_ll
argument_list|)
control|)
block|{
name|ca_used
operator|+=
name|CD9660_SUSP_ENTRY_SIZE
argument_list|(
name|temp
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* An ST entry is needed */
if|if
condition|(
name|node
operator|->
name|su_tail_size
operator|>
literal|0
condition|)
block|{
name|ST
operator|=
name|cd9660node_susp_create_node
argument_list|(
name|SUSP_TYPE_SUSP
argument_list|,
name|SUSP_ENTRY_SUSP_ST
argument_list|,
literal|"ST"
argument_list|,
name|SUSP_LOC_ENTRY
argument_list|)
expr_stmt|;
name|cd9660_susp_st
argument_list|(
name|ST
argument_list|,
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|last
operator|!=
name|NULL
condition|)
name|TAILQ_INSERT_AFTER
argument_list|(
operator|&
name|node
operator|->
name|head
argument_list|,
name|last
argument_list|,
name|ST
argument_list|,
name|rr_ll
argument_list|)
expr_stmt|;
else|else
name|TAILQ_INSERT_HEAD
argument_list|(
operator|&
name|node
operator|->
name|head
argument_list|,
name|ST
argument_list|,
name|rr_ll
argument_list|)
expr_stmt|;
name|last
operator|=
name|ST
expr_stmt|;
name|susp_used
operator|+=
literal|4
expr_stmt|;
block|}
if|if
condition|(
name|last
operator|!=
name|NULL
condition|)
name|last
operator|->
name|last_in_suf
operator|=
literal|1
expr_stmt|;
name|node
operator|->
name|susp_entry_size
operator|=
name|susp_used
expr_stmt|;
name|node
operator|->
name|susp_entry_ce_length
operator|=
name|ca_used
expr_stmt|;
name|diskStructure
operator|.
name|susp_continuation_area_size
operator|+=
name|ca_used
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/* See if a continuation entry is needed for each of the different types */
end_comment

begin_function
specifier|static
name|int
name|cd9660_susp_handle_continuation
parameter_list|(
name|cd9660node
modifier|*
name|node
parameter_list|)
block|{
name|assert
argument_list|(
name|node
operator|!=
name|NULL
argument_list|)
expr_stmt|;
comment|/* Entry */
if|if
condition|(
name|cd9660_susp_handle_continuation_common
argument_list|(
name|node
argument_list|,
call|(
name|int
call|)
argument_list|(
name|node
operator|->
name|isoDirRecord
operator|->
name|length
index|[
literal|0
index|]
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
return|return
literal|0
return|;
return|return
literal|1
return|;
block|}
end_function

begin_function
name|int
name|cd9660_susp_initialize_node
parameter_list|(
name|cd9660node
modifier|*
name|node
parameter_list|)
block|{
name|struct
name|ISO_SUSP_ATTRIBUTES
modifier|*
name|temp
decl_stmt|;
comment|/* 	 * Requirements/notes: 	 * CE: is added for us where needed 	 * ST: not sure if it is even required, but if so, should be 	 *     handled by the CE code 	 * PD: isn't needed (though might be added for testing) 	 * SP: is stored ONLY on the . record of the root directory 	 * ES: not sure 	 */
comment|/* Check for root directory, add SP and ER if needed. */
if|if
condition|(
name|node
operator|->
name|type
operator|&
name|CD9660_TYPE_DOT
condition|)
block|{
if|if
condition|(
name|node
operator|->
name|parent
operator|==
name|diskStructure
operator|.
name|rootNode
condition|)
block|{
name|temp
operator|=
name|cd9660node_susp_create_node
argument_list|(
name|SUSP_TYPE_SUSP
argument_list|,
name|SUSP_ENTRY_SUSP_SP
argument_list|,
literal|"SP"
argument_list|,
name|SUSP_LOC_DOT
argument_list|)
expr_stmt|;
name|cd9660_susp_sp
argument_list|(
name|temp
argument_list|,
name|node
argument_list|)
expr_stmt|;
comment|/* Should be first entry. */
name|TAILQ_INSERT_HEAD
argument_list|(
operator|&
name|node
operator|->
name|head
argument_list|,
name|temp
argument_list|,
name|rr_ll
argument_list|)
expr_stmt|;
block|}
block|}
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|cd9660_rrip_initialize_inode
parameter_list|(
name|cd9660node
modifier|*
name|node
parameter_list|)
block|{
name|struct
name|ISO_SUSP_ATTRIBUTES
modifier|*
name|attr
decl_stmt|;
comment|/* 	 * Inode dependent values - this may change, 	 * but for now virtual files and directories do 	 * not have an inode structure 	 */
if|if
condition|(
operator|(
name|node
operator|->
name|node
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|node
operator|->
name|node
operator|->
name|inode
operator|!=
name|NULL
operator|)
condition|)
block|{
comment|/* PX - POSIX attributes */
name|attr
operator|=
name|cd9660node_susp_create_node
argument_list|(
name|SUSP_TYPE_RRIP
argument_list|,
name|SUSP_ENTRY_RRIP_PX
argument_list|,
literal|"PX"
argument_list|,
name|SUSP_LOC_ENTRY
argument_list|)
expr_stmt|;
name|cd9660node_rrip_px
argument_list|(
name|attr
argument_list|,
name|node
operator|->
name|node
argument_list|)
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|node
operator|->
name|head
argument_list|,
name|attr
argument_list|,
name|rr_ll
argument_list|)
expr_stmt|;
comment|/* TF - timestamp */
name|attr
operator|=
name|cd9660node_susp_create_node
argument_list|(
name|SUSP_TYPE_RRIP
argument_list|,
name|SUSP_ENTRY_RRIP_TF
argument_list|,
literal|"TF"
argument_list|,
name|SUSP_LOC_ENTRY
argument_list|)
expr_stmt|;
name|cd9660node_rrip_tf
argument_list|(
name|attr
argument_list|,
name|node
operator|->
name|node
argument_list|)
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|node
operator|->
name|head
argument_list|,
name|attr
argument_list|,
name|rr_ll
argument_list|)
expr_stmt|;
comment|/* SL - Symbolic link */
comment|/* ?????????? Dan - why is this here? */
if|if
condition|(
name|TAILQ_EMPTY
argument_list|(
operator|&
name|node
operator|->
name|cn_children
argument_list|)
operator|&&
name|node
operator|->
name|node
operator|->
name|inode
operator|!=
name|NULL
operator|&&
name|S_ISLNK
argument_list|(
name|node
operator|->
name|node
operator|->
name|inode
operator|->
name|st
operator|.
name|st_mode
argument_list|)
condition|)
name|cd9660_createSL
argument_list|(
name|node
argument_list|)
expr_stmt|;
comment|/* PN - device number */
if|if
condition|(
name|node
operator|->
name|node
operator|->
name|inode
operator|!=
name|NULL
operator|&&
operator|(
operator|(
name|S_ISCHR
argument_list|(
name|node
operator|->
name|node
operator|->
name|inode
operator|->
name|st
operator|.
name|st_mode
argument_list|)
operator|||
name|S_ISBLK
argument_list|(
name|node
operator|->
name|node
operator|->
name|inode
operator|->
name|st
operator|.
name|st_mode
argument_list|)
operator|)
operator|)
condition|)
block|{
name|attr
operator|=
name|cd9660node_susp_create_node
argument_list|(
name|SUSP_TYPE_RRIP
argument_list|,
name|SUSP_ENTRY_RRIP_PN
argument_list|,
literal|"PN"
argument_list|,
name|SUSP_LOC_ENTRY
argument_list|)
expr_stmt|;
name|cd9660node_rrip_pn
argument_list|(
name|attr
argument_list|,
name|node
operator|->
name|node
argument_list|)
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|node
operator|->
name|head
argument_list|,
name|attr
argument_list|,
name|rr_ll
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|int
name|cd9660_rrip_initialize_node
parameter_list|(
name|cd9660node
modifier|*
name|node
parameter_list|,
name|cd9660node
modifier|*
name|parent
parameter_list|,
name|cd9660node
modifier|*
name|grandparent
parameter_list|)
block|{
name|struct
name|ISO_SUSP_ATTRIBUTES
modifier|*
name|current
init|=
name|NULL
decl_stmt|;
name|assert
argument_list|(
name|node
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|->
name|type
operator|&
name|CD9660_TYPE_DOT
condition|)
block|{
comment|/* 		 * Handle ER - should be the only entry to appear on 		 * a "." record 		 */
if|if
condition|(
name|node
operator|->
name|parent
operator|==
name|diskStructure
operator|.
name|rootNode
condition|)
block|{
name|cd9660_susp_ER
argument_list|(
name|node
argument_list|,
literal|1
argument_list|,
name|SUSP_RRIP_ER_EXT_ID
argument_list|,
name|SUSP_RRIP_ER_EXT_DES
argument_list|,
name|SUSP_RRIP_ER_EXT_SRC
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|parent
operator|!=
name|NULL
operator|&&
name|parent
operator|->
name|node
operator|!=
name|NULL
operator|&&
name|parent
operator|->
name|node
operator|->
name|inode
operator|!=
name|NULL
condition|)
block|{
comment|/* PX - POSIX attributes */
name|current
operator|=
name|cd9660node_susp_create_node
argument_list|(
name|SUSP_TYPE_RRIP
argument_list|,
name|SUSP_ENTRY_RRIP_PX
argument_list|,
literal|"PX"
argument_list|,
name|SUSP_LOC_ENTRY
argument_list|)
expr_stmt|;
name|cd9660node_rrip_px
argument_list|(
name|current
argument_list|,
name|parent
operator|->
name|node
argument_list|)
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|node
operator|->
name|head
argument_list|,
name|current
argument_list|,
name|rr_ll
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|node
operator|->
name|type
operator|&
name|CD9660_TYPE_DOTDOT
condition|)
block|{
if|if
condition|(
name|grandparent
operator|!=
name|NULL
operator|&&
name|grandparent
operator|->
name|node
operator|!=
name|NULL
operator|&&
name|grandparent
operator|->
name|node
operator|->
name|inode
operator|!=
name|NULL
condition|)
block|{
comment|/* PX - POSIX attributes */
name|current
operator|=
name|cd9660node_susp_create_node
argument_list|(
name|SUSP_TYPE_RRIP
argument_list|,
name|SUSP_ENTRY_RRIP_PX
argument_list|,
literal|"PX"
argument_list|,
name|SUSP_LOC_ENTRY
argument_list|)
expr_stmt|;
name|cd9660node_rrip_px
argument_list|(
name|current
argument_list|,
name|grandparent
operator|->
name|node
argument_list|)
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|node
operator|->
name|head
argument_list|,
name|current
argument_list|,
name|rr_ll
argument_list|)
expr_stmt|;
block|}
comment|/* Handle PL */
if|if
condition|(
name|parent
operator|!=
name|NULL
operator|&&
name|parent
operator|->
name|rr_real_parent
operator|!=
name|NULL
condition|)
block|{
name|current
operator|=
name|cd9660node_susp_create_node
argument_list|(
name|SUSP_TYPE_RRIP
argument_list|,
name|SUSP_ENTRY_RRIP_PL
argument_list|,
literal|"PL"
argument_list|,
name|SUSP_LOC_DOTDOT
argument_list|)
expr_stmt|;
name|cd9660_rrip_PL
argument_list|(
name|current
argument_list|,
name|node
argument_list|)
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|node
operator|->
name|head
argument_list|,
name|current
argument_list|,
name|rr_ll
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|cd9660_rrip_initialize_inode
argument_list|(
name|node
argument_list|)
expr_stmt|;
comment|/* 		 * Not every node needs a NM set - only if the name is 		 * actually different. IE: If a file is TEST -> TEST, 		 * no NM. test -> TEST, need a NM 		 * 		 * The rr_moved_dir needs to be assigned a NM record as well. 		 */
if|if
condition|(
name|node
operator|==
name|diskStructure
operator|.
name|rr_moved_dir
condition|)
block|{
name|cd9660_rrip_add_NM
argument_list|(
name|node
argument_list|,
name|RRIP_DEFAULT_MOVE_DIR_NAME
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|node
operator|->
name|node
operator|!=
name|NULL
operator|)
operator|&&
operator|(
operator|(
name|strlen
argument_list|(
name|node
operator|->
name|node
operator|->
name|name
argument_list|)
operator|!=
operator|(
name|uint8_t
operator|)
name|node
operator|->
name|isoDirRecord
operator|->
name|name_len
index|[
literal|0
index|]
operator|)
operator|||
operator|(
name|memcmp
argument_list|(
name|node
operator|->
name|node
operator|->
name|name
argument_list|,
name|node
operator|->
name|isoDirRecord
operator|->
name|name
argument_list|,
operator|(
name|uint8_t
operator|)
name|node
operator|->
name|isoDirRecord
operator|->
name|name_len
index|[
literal|0
index|]
argument_list|)
operator|!=
literal|0
operator|)
operator|)
condition|)
block|{
name|cd9660_rrip_NM
argument_list|(
name|node
argument_list|)
expr_stmt|;
block|}
comment|/* Rock ridge directory relocation code here. */
comment|/* First handle the CL for the placeholder file. */
if|if
condition|(
name|node
operator|->
name|rr_relocated
operator|!=
name|NULL
condition|)
block|{
name|current
operator|=
name|cd9660node_susp_create_node
argument_list|(
name|SUSP_TYPE_RRIP
argument_list|,
name|SUSP_ENTRY_RRIP_CL
argument_list|,
literal|"CL"
argument_list|,
name|SUSP_LOC_ENTRY
argument_list|)
expr_stmt|;
name|cd9660_rrip_CL
argument_list|(
name|current
argument_list|,
name|node
argument_list|)
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|node
operator|->
name|head
argument_list|,
name|current
argument_list|,
name|rr_ll
argument_list|)
expr_stmt|;
block|}
comment|/* Handle RE*/
if|if
condition|(
name|node
operator|->
name|rr_real_parent
operator|!=
name|NULL
condition|)
block|{
name|current
operator|=
name|cd9660node_susp_create_node
argument_list|(
name|SUSP_TYPE_RRIP
argument_list|,
name|SUSP_ENTRY_RRIP_RE
argument_list|,
literal|"RE"
argument_list|,
name|SUSP_LOC_ENTRY
argument_list|)
expr_stmt|;
name|cd9660_rrip_RE
argument_list|(
name|current
argument_list|,
name|node
argument_list|)
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|node
operator|->
name|head
argument_list|,
name|current
argument_list|,
name|rr_ll
argument_list|)
expr_stmt|;
block|}
block|}
return|return
literal|1
return|;
block|}
end_function

begin_function
name|struct
name|ISO_SUSP_ATTRIBUTES
modifier|*
name|cd9660node_susp_create_node
parameter_list|(
name|int
name|susp_type
parameter_list|,
name|int
name|entry_type
parameter_list|,
specifier|const
name|char
modifier|*
name|type_id
parameter_list|,
name|int
name|write_loc
parameter_list|)
block|{
name|struct
name|ISO_SUSP_ATTRIBUTES
modifier|*
name|temp
decl_stmt|;
if|if
condition|(
operator|(
name|temp
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|ISO_SUSP_ATTRIBUTES
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|CD9660_MEM_ALLOC_ERROR
argument_list|(
literal|"cd9660node_susp_create_node"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|temp
operator|->
name|susp_type
operator|=
name|susp_type
expr_stmt|;
name|temp
operator|->
name|entry_type
operator|=
name|entry_type
expr_stmt|;
name|temp
operator|->
name|last_in_suf
operator|=
literal|0
expr_stmt|;
comment|/* Phase this out */
name|temp
operator|->
name|type_of
index|[
literal|0
index|]
operator|=
name|type_id
index|[
literal|0
index|]
expr_stmt|;
name|temp
operator|->
name|type_of
index|[
literal|1
index|]
operator|=
name|type_id
index|[
literal|1
index|]
expr_stmt|;
name|temp
operator|->
name|write_location
operator|=
name|write_loc
expr_stmt|;
comment|/* 	 * Since the first four bytes is common, lets go ahead and 	 * set the type identifier, since we are passing that to this 	 * function anyhow. 	 */
name|temp
operator|->
name|attr
operator|.
name|su_entry
operator|.
name|SP
operator|.
name|h
operator|.
name|type
index|[
literal|0
index|]
operator|=
name|type_id
index|[
literal|0
index|]
expr_stmt|;
name|temp
operator|->
name|attr
operator|.
name|su_entry
operator|.
name|SP
operator|.
name|h
operator|.
name|type
index|[
literal|1
index|]
operator|=
name|type_id
index|[
literal|1
index|]
expr_stmt|;
return|return
name|temp
return|;
block|}
end_function

begin_function
name|int
name|cd9660_rrip_PL
parameter_list|(
name|struct
name|ISO_SUSP_ATTRIBUTES
modifier|*
name|p
parameter_list|,
name|cd9660node
modifier|*
name|node
name|__unused
parameter_list|)
block|{
name|p
operator|->
name|attr
operator|.
name|rr_entry
operator|.
name|PL
operator|.
name|h
operator|.
name|length
index|[
literal|0
index|]
operator|=
literal|12
expr_stmt|;
name|p
operator|->
name|attr
operator|.
name|rr_entry
operator|.
name|PL
operator|.
name|h
operator|.
name|version
index|[
literal|0
index|]
operator|=
literal|1
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
name|int
name|cd9660_rrip_CL
parameter_list|(
name|struct
name|ISO_SUSP_ATTRIBUTES
modifier|*
name|p
parameter_list|,
name|cd9660node
modifier|*
name|node
name|__unused
parameter_list|)
block|{
name|p
operator|->
name|attr
operator|.
name|rr_entry
operator|.
name|CL
operator|.
name|h
operator|.
name|length
index|[
literal|0
index|]
operator|=
literal|12
expr_stmt|;
name|p
operator|->
name|attr
operator|.
name|rr_entry
operator|.
name|CL
operator|.
name|h
operator|.
name|version
index|[
literal|0
index|]
operator|=
literal|1
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
name|int
name|cd9660_rrip_RE
parameter_list|(
name|struct
name|ISO_SUSP_ATTRIBUTES
modifier|*
name|p
parameter_list|,
name|cd9660node
modifier|*
name|node
name|__unused
parameter_list|)
block|{
name|p
operator|->
name|attr
operator|.
name|rr_entry
operator|.
name|RE
operator|.
name|h
operator|.
name|length
index|[
literal|0
index|]
operator|=
literal|4
expr_stmt|;
name|p
operator|->
name|attr
operator|.
name|rr_entry
operator|.
name|RE
operator|.
name|h
operator|.
name|version
index|[
literal|0
index|]
operator|=
literal|1
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
name|void
name|cd9660_createSL
parameter_list|(
name|cd9660node
modifier|*
name|node
parameter_list|)
block|{
name|struct
name|ISO_SUSP_ATTRIBUTES
modifier|*
name|current
decl_stmt|;
name|int
name|path_count
decl_stmt|,
name|dir_count
decl_stmt|,
name|done
decl_stmt|,
name|i
decl_stmt|,
name|j
decl_stmt|,
name|dir_copied
decl_stmt|;
name|char
name|temp_cr
index|[
literal|255
index|]
decl_stmt|;
name|char
name|temp_sl
index|[
literal|255
index|]
decl_stmt|;
comment|/* used in copying continuation entry*/
name|char
modifier|*
name|sl_ptr
decl_stmt|;
name|sl_ptr
operator|=
name|node
operator|->
name|node
operator|->
name|symlink
expr_stmt|;
name|done
operator|=
literal|0
expr_stmt|;
name|path_count
operator|=
literal|0
expr_stmt|;
name|dir_count
operator|=
literal|0
expr_stmt|;
name|dir_copied
operator|=
literal|0
expr_stmt|;
name|current
operator|=
name|cd9660node_susp_create_node
argument_list|(
name|SUSP_TYPE_RRIP
argument_list|,
name|SUSP_ENTRY_RRIP_SL
argument_list|,
literal|"SL"
argument_list|,
name|SUSP_LOC_ENTRY
argument_list|)
expr_stmt|;
name|current
operator|->
name|attr
operator|.
name|rr_entry
operator|.
name|SL
operator|.
name|h
operator|.
name|version
index|[
literal|0
index|]
operator|=
literal|1
expr_stmt|;
name|current
operator|->
name|attr
operator|.
name|rr_entry
operator|.
name|SL
operator|.
name|flags
index|[
literal|0
index|]
operator|=
name|SL_FLAGS_NONE
expr_stmt|;
if|if
condition|(
operator|*
name|sl_ptr
operator|==
literal|'/'
condition|)
block|{
name|temp_cr
index|[
literal|0
index|]
operator|=
name|SL_FLAGS_ROOT
expr_stmt|;
name|temp_cr
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|memcpy
argument_list|(
name|current
operator|->
name|attr
operator|.
name|rr_entry
operator|.
name|SL
operator|.
name|component
operator|+
name|path_count
argument_list|,
name|temp_cr
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|path_count
operator|+=
literal|2
expr_stmt|;
name|sl_ptr
operator|++
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|dir_count
operator|+
literal|2
operator|)
condition|;
name|i
operator|++
control|)
name|temp_cr
index|[
name|i
index|]
operator|=
literal|'\0'
expr_stmt|;
while|while
condition|(
operator|!
name|done
condition|)
block|{
while|while
condition|(
operator|(
operator|*
name|sl_ptr
operator|!=
literal|'/'
operator|)
operator|&&
operator|(
operator|*
name|sl_ptr
operator|!=
literal|'\0'
operator|)
condition|)
block|{
name|dir_copied
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|*
name|sl_ptr
operator|==
literal|'.'
condition|)
block|{
if|if
condition|(
operator|(
operator|*
operator|(
name|sl_ptr
operator|+
literal|1
operator|)
operator|==
literal|'/'
operator|)
operator|||
operator|(
operator|*
operator|(
name|sl_ptr
operator|+
literal|1
operator|)
operator|==
literal|'\0'
operator|)
condition|)
block|{
name|temp_cr
index|[
literal|0
index|]
operator|=
name|SL_FLAGS_CURRENT
expr_stmt|;
name|sl_ptr
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|*
operator|(
name|sl_ptr
operator|+
literal|1
operator|)
operator|==
literal|'.'
condition|)
block|{
if|if
condition|(
operator|(
operator|*
operator|(
name|sl_ptr
operator|+
literal|2
operator|)
operator|==
literal|'/'
operator|)
operator|||
operator|(
operator|*
operator|(
name|sl_ptr
operator|+
literal|2
operator|)
operator|==
literal|'\0'
operator|)
condition|)
block|{
name|temp_cr
index|[
literal|0
index|]
operator|=
name|SL_FLAGS_PARENT
expr_stmt|;
name|sl_ptr
operator|+=
literal|2
expr_stmt|;
block|}
block|}
else|else
block|{
name|temp_cr
index|[
name|dir_count
operator|+
literal|2
index|]
operator|=
operator|*
name|sl_ptr
expr_stmt|;
name|sl_ptr
operator|++
expr_stmt|;
name|dir_count
operator|++
expr_stmt|;
block|}
block|}
else|else
block|{
name|temp_cr
index|[
name|dir_count
operator|+
literal|2
index|]
operator|=
operator|*
name|sl_ptr
expr_stmt|;
name|sl_ptr
operator|++
expr_stmt|;
name|dir_count
operator|++
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|path_count
operator|+
name|dir_count
operator|)
operator|>=
literal|249
condition|)
block|{
name|current
operator|->
name|attr
operator|.
name|rr_entry
operator|.
name|SL
operator|.
name|flags
index|[
literal|0
index|]
operator||=
name|SL_FLAGS_CONTINUE
expr_stmt|;
name|j
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|path_count
operator|<=
literal|249
condition|)
block|{
while|while
condition|(
name|j
operator|!=
operator|(
literal|249
operator|-
name|path_count
operator|)
condition|)
block|{
name|temp_sl
index|[
name|j
index|]
operator|=
name|temp_cr
index|[
name|j
index|]
expr_stmt|;
name|j
operator|++
expr_stmt|;
block|}
name|temp_sl
index|[
literal|0
index|]
operator|=
name|SL_FLAGS_CONTINUE
expr_stmt|;
name|temp_sl
index|[
literal|1
index|]
operator|=
name|j
operator|-
literal|2
expr_stmt|;
name|memcpy
argument_list|(
name|current
operator|->
name|attr
operator|.
name|rr_entry
operator|.
name|SL
operator|.
name|component
operator|+
name|path_count
argument_list|,
name|temp_sl
argument_list|,
name|j
argument_list|)
expr_stmt|;
block|}
name|path_count
operator|+=
name|j
expr_stmt|;
name|current
operator|->
name|attr
operator|.
name|rr_entry
operator|.
name|SL
operator|.
name|h
operator|.
name|length
index|[
literal|0
index|]
operator|=
name|path_count
operator|+
literal|5
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|node
operator|->
name|head
argument_list|,
name|current
argument_list|,
name|rr_ll
argument_list|)
expr_stmt|;
name|current
operator|=
name|cd9660node_susp_create_node
argument_list|(
name|SUSP_TYPE_RRIP
argument_list|,
name|SUSP_ENTRY_RRIP_SL
argument_list|,
literal|"SL"
argument_list|,
name|SUSP_LOC_ENTRY
argument_list|)
expr_stmt|;
name|current
operator|->
name|attr
operator|.
name|rr_entry
operator|.
name|SL
operator|.
name|h
operator|.
name|version
index|[
literal|0
index|]
operator|=
literal|1
expr_stmt|;
name|current
operator|->
name|attr
operator|.
name|rr_entry
operator|.
name|SL
operator|.
name|flags
index|[
literal|0
index|]
operator|=
name|SL_FLAGS_NONE
expr_stmt|;
name|path_count
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|dir_count
operator|>
literal|2
condition|)
block|{
while|while
condition|(
name|j
operator|!=
name|dir_count
operator|+
literal|2
condition|)
block|{
name|current
operator|->
name|attr
operator|.
name|rr_entry
operator|.
name|SL
operator|.
name|component
index|[
name|path_count
operator|+
literal|2
index|]
operator|=
name|temp_cr
index|[
name|j
index|]
expr_stmt|;
name|j
operator|++
expr_stmt|;
name|path_count
operator|++
expr_stmt|;
block|}
name|current
operator|->
name|attr
operator|.
name|rr_entry
operator|.
name|SL
operator|.
name|component
index|[
literal|1
index|]
operator|=
name|path_count
expr_stmt|;
name|path_count
operator|+=
literal|2
expr_stmt|;
block|}
else|else
block|{
while|while
condition|(
name|j
operator|!=
name|dir_count
condition|)
block|{
name|current
operator|->
name|attr
operator|.
name|rr_entry
operator|.
name|SL
operator|.
name|component
index|[
name|path_count
operator|+
literal|2
index|]
operator|=
name|temp_cr
index|[
name|j
index|]
expr_stmt|;
name|j
operator|++
expr_stmt|;
name|path_count
operator|++
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
if|if
condition|(
name|dir_copied
operator|==
literal|1
condition|)
block|{
name|temp_cr
index|[
literal|1
index|]
operator|=
name|dir_count
expr_stmt|;
name|memcpy
argument_list|(
name|current
operator|->
name|attr
operator|.
name|rr_entry
operator|.
name|SL
operator|.
name|component
operator|+
name|path_count
argument_list|,
name|temp_cr
argument_list|,
name|dir_count
operator|+
literal|2
argument_list|)
expr_stmt|;
name|path_count
operator|+=
name|dir_count
operator|+
literal|2
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|*
name|sl_ptr
operator|==
literal|'\0'
condition|)
block|{
name|done
operator|=
literal|1
expr_stmt|;
name|current
operator|->
name|attr
operator|.
name|rr_entry
operator|.
name|SL
operator|.
name|h
operator|.
name|length
index|[
literal|0
index|]
operator|=
name|path_count
operator|+
literal|5
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|node
operator|->
name|head
argument_list|,
name|current
argument_list|,
name|rr_ll
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|sl_ptr
operator|++
expr_stmt|;
name|dir_count
operator|=
literal|0
expr_stmt|;
name|dir_copied
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|255
condition|;
name|i
operator|++
control|)
block|{
name|temp_cr
index|[
name|i
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_function
name|int
name|cd9660node_rrip_px
parameter_list|(
name|struct
name|ISO_SUSP_ATTRIBUTES
modifier|*
name|v
parameter_list|,
name|fsnode
modifier|*
name|pxinfo
parameter_list|)
block|{
name|v
operator|->
name|attr
operator|.
name|rr_entry
operator|.
name|PX
operator|.
name|h
operator|.
name|length
index|[
literal|0
index|]
operator|=
literal|44
expr_stmt|;
name|v
operator|->
name|attr
operator|.
name|rr_entry
operator|.
name|PX
operator|.
name|h
operator|.
name|version
index|[
literal|0
index|]
operator|=
literal|1
expr_stmt|;
name|cd9660_bothendian_dword
argument_list|(
name|pxinfo
operator|->
name|inode
operator|->
name|st
operator|.
name|st_mode
argument_list|,
name|v
operator|->
name|attr
operator|.
name|rr_entry
operator|.
name|PX
operator|.
name|mode
argument_list|)
expr_stmt|;
name|cd9660_bothendian_dword
argument_list|(
name|pxinfo
operator|->
name|inode
operator|->
name|st
operator|.
name|st_nlink
argument_list|,
name|v
operator|->
name|attr
operator|.
name|rr_entry
operator|.
name|PX
operator|.
name|links
argument_list|)
expr_stmt|;
name|cd9660_bothendian_dword
argument_list|(
name|pxinfo
operator|->
name|inode
operator|->
name|st
operator|.
name|st_uid
argument_list|,
name|v
operator|->
name|attr
operator|.
name|rr_entry
operator|.
name|PX
operator|.
name|uid
argument_list|)
expr_stmt|;
name|cd9660_bothendian_dword
argument_list|(
name|pxinfo
operator|->
name|inode
operator|->
name|st
operator|.
name|st_gid
argument_list|,
name|v
operator|->
name|attr
operator|.
name|rr_entry
operator|.
name|PX
operator|.
name|gid
argument_list|)
expr_stmt|;
name|cd9660_bothendian_dword
argument_list|(
name|pxinfo
operator|->
name|inode
operator|->
name|st
operator|.
name|st_ino
argument_list|,
name|v
operator|->
name|attr
operator|.
name|rr_entry
operator|.
name|PX
operator|.
name|serial
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
name|int
name|cd9660node_rrip_pn
parameter_list|(
name|struct
name|ISO_SUSP_ATTRIBUTES
modifier|*
name|pn_field
parameter_list|,
name|fsnode
modifier|*
name|fnode
parameter_list|)
block|{
name|pn_field
operator|->
name|attr
operator|.
name|rr_entry
operator|.
name|PN
operator|.
name|h
operator|.
name|length
index|[
literal|0
index|]
operator|=
literal|20
expr_stmt|;
name|pn_field
operator|->
name|attr
operator|.
name|rr_entry
operator|.
name|PN
operator|.
name|h
operator|.
name|version
index|[
literal|0
index|]
operator|=
literal|1
expr_stmt|;
if|if
condition|(
sizeof|sizeof
argument_list|(
name|fnode
operator|->
name|inode
operator|->
name|st
operator|.
name|st_dev
argument_list|)
operator|>
literal|32
condition|)
name|cd9660_bothendian_dword
argument_list|(
operator|(
name|uint64_t
operator|)
name|fnode
operator|->
name|inode
operator|->
name|st
operator|.
name|st_dev
operator|>>
literal|32
argument_list|,
name|pn_field
operator|->
name|attr
operator|.
name|rr_entry
operator|.
name|PN
operator|.
name|high
argument_list|)
expr_stmt|;
else|else
name|cd9660_bothendian_dword
argument_list|(
literal|0
argument_list|,
name|pn_field
operator|->
name|attr
operator|.
name|rr_entry
operator|.
name|PN
operator|.
name|high
argument_list|)
expr_stmt|;
name|cd9660_bothendian_dword
argument_list|(
name|fnode
operator|->
name|inode
operator|->
name|st
operator|.
name|st_dev
operator|&
literal|0xffffffff
argument_list|,
name|pn_field
operator|->
name|attr
operator|.
name|rr_entry
operator|.
name|PN
operator|.
name|low
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_if
if|#
directive|if
literal|0
end_if

begin_endif
unit|int cd9660node_rrip_nm(struct ISO_SUSP_ATTRIBUTES *p, cd9660node *file_node) { 	int nm_length = strlen(file_node->isoDirRecord->name) + 5;         p->attr.rr_entry.NM.h.type[0] = 'N'; 	p->attr.rr_entry.NM.h.type[1] = 'M'; 	sprintf(p->attr.rr_entry.NM.altname, "%s", file_node->isoDirRecord->name); 	p->attr.rr_entry.NM.h.length[0] = (unsigned char)nm_length; 	p->attr.rr_entry.NM.h.version[0] = (unsigned char)1; 	p->attr.rr_entry.NM.flags[0] = (unsigned char) NM_PARENT; 	return 1; }
endif|#
directive|endif
end_endif

begin_function
name|int
name|cd9660node_rrip_tf
parameter_list|(
name|struct
name|ISO_SUSP_ATTRIBUTES
modifier|*
name|p
parameter_list|,
name|fsnode
modifier|*
name|_node
parameter_list|)
block|{
name|p
operator|->
name|attr
operator|.
name|rr_entry
operator|.
name|TF
operator|.
name|flags
index|[
literal|0
index|]
operator|=
name|TF_MODIFY
operator||
name|TF_ACCESS
operator||
name|TF_ATTRIBUTES
expr_stmt|;
name|p
operator|->
name|attr
operator|.
name|rr_entry
operator|.
name|TF
operator|.
name|h
operator|.
name|length
index|[
literal|0
index|]
operator|=
literal|5
expr_stmt|;
name|p
operator|->
name|attr
operator|.
name|rr_entry
operator|.
name|TF
operator|.
name|h
operator|.
name|version
index|[
literal|0
index|]
operator|=
literal|1
expr_stmt|;
comment|/* 	 * Need to add creation time, backup time, 	 * expiration time, and effective time. 	 */
name|cd9660_time_915
argument_list|(
name|p
operator|->
name|attr
operator|.
name|rr_entry
operator|.
name|TF
operator|.
name|timestamp
argument_list|,
name|_node
operator|->
name|inode
operator|->
name|st
operator|.
name|st_atime
argument_list|)
expr_stmt|;
name|p
operator|->
name|attr
operator|.
name|rr_entry
operator|.
name|TF
operator|.
name|h
operator|.
name|length
index|[
literal|0
index|]
operator|+=
literal|7
expr_stmt|;
name|cd9660_time_915
argument_list|(
name|p
operator|->
name|attr
operator|.
name|rr_entry
operator|.
name|TF
operator|.
name|timestamp
operator|+
literal|7
argument_list|,
name|_node
operator|->
name|inode
operator|->
name|st
operator|.
name|st_mtime
argument_list|)
expr_stmt|;
name|p
operator|->
name|attr
operator|.
name|rr_entry
operator|.
name|TF
operator|.
name|h
operator|.
name|length
index|[
literal|0
index|]
operator|+=
literal|7
expr_stmt|;
name|cd9660_time_915
argument_list|(
name|p
operator|->
name|attr
operator|.
name|rr_entry
operator|.
name|TF
operator|.
name|timestamp
operator|+
literal|14
argument_list|,
name|_node
operator|->
name|inode
operator|->
name|st
operator|.
name|st_ctime
argument_list|)
expr_stmt|;
name|p
operator|->
name|attr
operator|.
name|rr_entry
operator|.
name|TF
operator|.
name|h
operator|.
name|length
index|[
literal|0
index|]
operator|+=
literal|7
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
name|int
name|cd9660_susp_sp
parameter_list|(
name|struct
name|ISO_SUSP_ATTRIBUTES
modifier|*
name|p
parameter_list|,
name|cd9660node
modifier|*
name|spinfo
name|__unused
parameter_list|)
block|{
name|p
operator|->
name|attr
operator|.
name|su_entry
operator|.
name|SP
operator|.
name|h
operator|.
name|length
index|[
literal|0
index|]
operator|=
literal|7
expr_stmt|;
name|p
operator|->
name|attr
operator|.
name|su_entry
operator|.
name|SP
operator|.
name|h
operator|.
name|version
index|[
literal|0
index|]
operator|=
literal|1
expr_stmt|;
name|p
operator|->
name|attr
operator|.
name|su_entry
operator|.
name|SP
operator|.
name|check
index|[
literal|0
index|]
operator|=
literal|0xBE
expr_stmt|;
name|p
operator|->
name|attr
operator|.
name|su_entry
operator|.
name|SP
operator|.
name|check
index|[
literal|1
index|]
operator|=
literal|0xEF
expr_stmt|;
name|p
operator|->
name|attr
operator|.
name|su_entry
operator|.
name|SP
operator|.
name|len_skp
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
name|int
name|cd9660_susp_st
parameter_list|(
name|struct
name|ISO_SUSP_ATTRIBUTES
modifier|*
name|p
parameter_list|,
name|cd9660node
modifier|*
name|stinfo
name|__unused
parameter_list|)
block|{
name|p
operator|->
name|attr
operator|.
name|su_entry
operator|.
name|ST
operator|.
name|h
operator|.
name|type
index|[
literal|0
index|]
operator|=
literal|'S'
expr_stmt|;
name|p
operator|->
name|attr
operator|.
name|su_entry
operator|.
name|ST
operator|.
name|h
operator|.
name|type
index|[
literal|1
index|]
operator|=
literal|'T'
expr_stmt|;
name|p
operator|->
name|attr
operator|.
name|su_entry
operator|.
name|ST
operator|.
name|h
operator|.
name|length
index|[
literal|0
index|]
operator|=
literal|4
expr_stmt|;
name|p
operator|->
name|attr
operator|.
name|su_entry
operator|.
name|ST
operator|.
name|h
operator|.
name|version
index|[
literal|0
index|]
operator|=
literal|1
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
name|int
name|cd9660_susp_ce
parameter_list|(
name|struct
name|ISO_SUSP_ATTRIBUTES
modifier|*
name|p
parameter_list|,
name|cd9660node
modifier|*
name|spinfo
name|__unused
parameter_list|)
block|{
name|p
operator|->
name|attr
operator|.
name|su_entry
operator|.
name|CE
operator|.
name|h
operator|.
name|length
index|[
literal|0
index|]
operator|=
literal|28
expr_stmt|;
name|p
operator|->
name|attr
operator|.
name|su_entry
operator|.
name|CE
operator|.
name|h
operator|.
name|version
index|[
literal|0
index|]
operator|=
literal|1
expr_stmt|;
comment|/* Other attributes dont matter right now, will be updated later */
return|return
literal|1
return|;
block|}
end_function

begin_function
name|int
name|cd9660_susp_pd
parameter_list|(
name|struct
name|ISO_SUSP_ATTRIBUTES
modifier|*
name|p
name|__unused
parameter_list|,
name|int
name|length
name|__unused
parameter_list|)
block|{
return|return
literal|1
return|;
block|}
end_function

begin_function
name|void
name|cd9660_rrip_add_NM
parameter_list|(
name|cd9660node
modifier|*
name|node
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
name|int
name|working
decl_stmt|,
name|len
decl_stmt|;
specifier|const
name|char
modifier|*
name|p
decl_stmt|;
name|struct
name|ISO_SUSP_ATTRIBUTES
modifier|*
name|r
decl_stmt|;
comment|/* 	 * Each NM record has 254 byes to work with. This means that 	 * the name data itself only has 249 bytes to work with. So, a 	 * name with 251 characters would require two nm records. 	 */
name|p
operator|=
name|name
expr_stmt|;
name|working
operator|=
literal|1
expr_stmt|;
while|while
condition|(
name|working
condition|)
block|{
name|r
operator|=
name|cd9660node_susp_create_node
argument_list|(
name|SUSP_TYPE_RRIP
argument_list|,
name|SUSP_ENTRY_RRIP_NM
argument_list|,
literal|"NM"
argument_list|,
name|SUSP_LOC_ENTRY
argument_list|)
expr_stmt|;
name|r
operator|->
name|attr
operator|.
name|rr_entry
operator|.
name|NM
operator|.
name|h
operator|.
name|version
index|[
literal|0
index|]
operator|=
literal|1
expr_stmt|;
name|r
operator|->
name|attr
operator|.
name|rr_entry
operator|.
name|NM
operator|.
name|flags
index|[
literal|0
index|]
operator|=
name|RRIP_NM_FLAGS_NONE
expr_stmt|;
name|len
operator|=
name|strlen
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
literal|249
condition|)
block|{
name|len
operator|=
literal|249
expr_stmt|;
name|r
operator|->
name|attr
operator|.
name|rr_entry
operator|.
name|NM
operator|.
name|flags
index|[
literal|0
index|]
operator|=
name|RRIP_NM_FLAGS_CONTINUE
expr_stmt|;
block|}
else|else
block|{
name|working
operator|=
literal|0
expr_stmt|;
block|}
name|memcpy
argument_list|(
name|r
operator|->
name|attr
operator|.
name|rr_entry
operator|.
name|NM
operator|.
name|altname
argument_list|,
name|p
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|r
operator|->
name|attr
operator|.
name|rr_entry
operator|.
name|NM
operator|.
name|h
operator|.
name|length
index|[
literal|0
index|]
operator|=
literal|5
operator|+
name|len
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|node
operator|->
name|head
argument_list|,
name|r
argument_list|,
name|rr_ll
argument_list|)
expr_stmt|;
name|p
operator|+=
name|len
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|cd9660_rrip_NM
parameter_list|(
name|cd9660node
modifier|*
name|node
parameter_list|)
block|{
name|cd9660_rrip_add_NM
argument_list|(
name|node
argument_list|,
name|node
operator|->
name|node
operator|->
name|name
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|struct
name|ISO_SUSP_ATTRIBUTES
modifier|*
name|cd9660_susp_ER
parameter_list|(
name|cd9660node
modifier|*
name|node
parameter_list|,
name|u_char
name|ext_version
parameter_list|,
specifier|const
name|char
modifier|*
name|ext_id
parameter_list|,
specifier|const
name|char
modifier|*
name|ext_des
parameter_list|,
specifier|const
name|char
modifier|*
name|ext_src
parameter_list|)
block|{
name|int
name|l
decl_stmt|;
name|struct
name|ISO_SUSP_ATTRIBUTES
modifier|*
name|r
decl_stmt|;
name|r
operator|=
name|cd9660node_susp_create_node
argument_list|(
name|SUSP_TYPE_SUSP
argument_list|,
name|SUSP_ENTRY_SUSP_ER
argument_list|,
literal|"ER"
argument_list|,
name|SUSP_LOC_DOT
argument_list|)
expr_stmt|;
comment|/* Fixed data is 8 bytes */
name|r
operator|->
name|attr
operator|.
name|su_entry
operator|.
name|ER
operator|.
name|h
operator|.
name|length
index|[
literal|0
index|]
operator|=
literal|8
expr_stmt|;
name|r
operator|->
name|attr
operator|.
name|su_entry
operator|.
name|ER
operator|.
name|h
operator|.
name|version
index|[
literal|0
index|]
operator|=
literal|1
expr_stmt|;
name|r
operator|->
name|attr
operator|.
name|su_entry
operator|.
name|ER
operator|.
name|len_id
index|[
literal|0
index|]
operator|=
operator|(
name|u_char
operator|)
name|strlen
argument_list|(
name|ext_id
argument_list|)
expr_stmt|;
name|r
operator|->
name|attr
operator|.
name|su_entry
operator|.
name|ER
operator|.
name|len_des
index|[
literal|0
index|]
operator|=
operator|(
name|u_char
operator|)
name|strlen
argument_list|(
name|ext_des
argument_list|)
expr_stmt|;
name|r
operator|->
name|attr
operator|.
name|su_entry
operator|.
name|ER
operator|.
name|len_src
index|[
literal|0
index|]
operator|=
operator|(
name|u_char
operator|)
name|strlen
argument_list|(
name|ext_src
argument_list|)
expr_stmt|;
name|l
operator|=
name|r
operator|->
name|attr
operator|.
name|su_entry
operator|.
name|ER
operator|.
name|len_id
index|[
literal|0
index|]
operator|+
name|r
operator|->
name|attr
operator|.
name|su_entry
operator|.
name|ER
operator|.
name|len_src
index|[
literal|0
index|]
operator|+
name|r
operator|->
name|attr
operator|.
name|su_entry
operator|.
name|ER
operator|.
name|len_des
index|[
literal|0
index|]
expr_stmt|;
comment|/* Everything must fit. */
name|assert
argument_list|(
name|l
operator|+
name|r
operator|->
name|attr
operator|.
name|su_entry
operator|.
name|ER
operator|.
name|h
operator|.
name|length
index|[
literal|0
index|]
operator|<=
literal|254
argument_list|)
expr_stmt|;
name|r
operator|->
name|attr
operator|.
name|su_entry
operator|.
name|ER
operator|.
name|h
operator|.
name|length
index|[
literal|0
index|]
operator|+=
operator|(
name|u_char
operator|)
name|l
expr_stmt|;
name|r
operator|->
name|attr
operator|.
name|su_entry
operator|.
name|ER
operator|.
name|ext_ver
index|[
literal|0
index|]
operator|=
name|ext_version
expr_stmt|;
name|memcpy
argument_list|(
name|r
operator|->
name|attr
operator|.
name|su_entry
operator|.
name|ER
operator|.
name|ext_data
argument_list|,
name|ext_id
argument_list|,
operator|(
name|int
operator|)
name|r
operator|->
name|attr
operator|.
name|su_entry
operator|.
name|ER
operator|.
name|len_id
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|l
operator|=
operator|(
name|int
operator|)
name|r
operator|->
name|attr
operator|.
name|su_entry
operator|.
name|ER
operator|.
name|len_id
index|[
literal|0
index|]
expr_stmt|;
name|memcpy
argument_list|(
name|r
operator|->
name|attr
operator|.
name|su_entry
operator|.
name|ER
operator|.
name|ext_data
operator|+
name|l
argument_list|,
name|ext_des
argument_list|,
operator|(
name|int
operator|)
name|r
operator|->
name|attr
operator|.
name|su_entry
operator|.
name|ER
operator|.
name|len_des
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|l
operator|+=
operator|(
name|int
operator|)
name|r
operator|->
name|attr
operator|.
name|su_entry
operator|.
name|ER
operator|.
name|len_des
index|[
literal|0
index|]
expr_stmt|;
name|memcpy
argument_list|(
name|r
operator|->
name|attr
operator|.
name|su_entry
operator|.
name|ER
operator|.
name|ext_data
operator|+
name|l
argument_list|,
name|ext_src
argument_list|,
operator|(
name|int
operator|)
name|r
operator|->
name|attr
operator|.
name|su_entry
operator|.
name|ER
operator|.
name|len_src
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|node
operator|->
name|head
argument_list|,
name|r
argument_list|,
name|rr_ll
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
end_function

begin_function
name|struct
name|ISO_SUSP_ATTRIBUTES
modifier|*
name|cd9660_susp_ES
parameter_list|(
name|struct
name|ISO_SUSP_ATTRIBUTES
modifier|*
name|last
name|__unused
parameter_list|,
name|cd9660node
modifier|*
name|node
name|__unused
parameter_list|)
block|{
return|return
name|NULL
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*   * pmap_set - set portmapper table from data produced by pmap_dump   *   * Author: Wietse Venema (wietse@wzv.win.tue.nl), dept. of Mathematics and   * Computing Science, Eindhoven University of Technology, The Netherlands.   */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_if
if|#
directive|if
literal|0
end_if

begin_endif
unit|static char sccsid[] = "@(#) pmap_set.c 1.1 92/06/11 22:53:16";
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|static
specifier|const
name|char
name|rcsid
index|[]
init|=
literal|"$Id$"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<err.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|SYSV40
end_ifdef

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<rpc/rpc.h>
end_include

begin_include
include|#
directive|include
file|<rpc/pmap_clnt.h>
end_include

begin_decl_stmt
name|int
name|parse_line
name|__P
argument_list|(
operator|(
name|char
operator|*
operator|,
name|u_long
operator|*
operator|,
name|u_long
operator|*
operator|,
name|int
operator|*
operator|,
name|unsigned
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|struct
name|sockaddr_in
name|addr
decl_stmt|;
name|char
name|buf
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|u_long
name|prog
decl_stmt|;
name|u_long
name|vers
decl_stmt|;
name|int
name|prot
decl_stmt|;
name|unsigned
name|port
decl_stmt|;
name|get_myaddress
argument_list|(
operator|&
name|addr
argument_list|)
expr_stmt|;
while|while
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|stdin
argument_list|)
condition|)
block|{
if|if
condition|(
name|parse_line
argument_list|(
name|buf
argument_list|,
operator|&
name|prog
argument_list|,
operator|&
name|vers
argument_list|,
operator|&
name|prot
argument_list|,
operator|&
name|port
argument_list|)
operator|==
literal|0
condition|)
block|{
name|warnx
argument_list|(
literal|"malformed line: %s"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|pmap_set
argument_list|(
name|prog
argument_list|,
name|vers
argument_list|,
name|prot
argument_list|,
operator|(
name|unsigned
name|short
operator|)
name|port
argument_list|)
operator|==
literal|0
condition|)
name|warnx
argument_list|(
literal|"not registered: %s"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* parse_line - convert line to numbers */
end_comment

begin_function
name|int
name|parse_line
parameter_list|(
name|buf
parameter_list|,
name|prog
parameter_list|,
name|vers
parameter_list|,
name|prot
parameter_list|,
name|port
parameter_list|)
name|char
modifier|*
name|buf
decl_stmt|;
name|u_long
modifier|*
name|prog
decl_stmt|;
name|u_long
modifier|*
name|vers
decl_stmt|;
name|int
modifier|*
name|prot
decl_stmt|;
name|unsigned
modifier|*
name|port
decl_stmt|;
block|{
name|char
name|proto_name
index|[
name|BUFSIZ
index|]
decl_stmt|;
if|if
condition|(
name|sscanf
argument_list|(
name|buf
argument_list|,
literal|"%lu %lu %s %u"
argument_list|,
name|prog
argument_list|,
name|vers
argument_list|,
name|proto_name
argument_list|,
name|port
argument_list|)
operator|!=
literal|4
condition|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|proto_name
argument_list|,
literal|"tcp"
argument_list|)
operator|==
literal|0
condition|)
block|{
operator|*
name|prot
operator|=
name|IPPROTO_TCP
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|proto_name
argument_list|,
literal|"udp"
argument_list|)
operator|==
literal|0
condition|)
block|{
operator|*
name|prot
operator|=
name|IPPROTO_UDP
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|sscanf
argument_list|(
name|proto_name
argument_list|,
literal|"%d"
argument_list|,
name|prot
argument_list|)
operator|==
literal|1
condition|)
block|{
return|return
operator|(
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2008 Yahoo!, Inc.  * All rights reserved.  * Written by: John Baldwin<jhb@FreeBSD.org>  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. Neither the name of the author nor the names of any co-contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__RCSID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/errno.h>
end_include

begin_include
include|#
directive|include
file|<err.h>
end_include

begin_include
include|#
directive|include
file|<libutil.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|"mptutil.h"
end_include

begin_expr_stmt
name|MPT_TABLE
argument_list|(
name|top
argument_list|,
name|show
argument_list|)
expr_stmt|;
end_expr_stmt

begin_define
define|#
directive|define
name|STANDALONE_STATE
value|"ONLINE"
end_define

begin_function
specifier|static
name|void
name|format_stripe
parameter_list|(
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|buflen
parameter_list|,
name|U32
name|stripe
parameter_list|)
block|{
name|humanize_number
argument_list|(
name|buf
argument_list|,
name|buflen
argument_list|,
name|stripe
operator|*
literal|512
argument_list|,
literal|""
argument_list|,
name|HN_AUTOSCALE
argument_list|,
name|HN_B
operator||
name|HN_NOSPACE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|display_stripe_map
parameter_list|(
specifier|const
name|char
modifier|*
name|label
parameter_list|,
name|U32
name|StripeMap
parameter_list|)
block|{
name|char
name|stripe
index|[
literal|5
index|]
decl_stmt|;
name|int
name|comma
decl_stmt|,
name|i
decl_stmt|;
name|comma
operator|=
literal|0
expr_stmt|;
name|printf
argument_list|(
literal|"%s: "
argument_list|,
name|label
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|StripeMap
operator|!=
literal|0
condition|;
name|i
operator|++
operator|,
name|StripeMap
operator|>>=
literal|1
control|)
if|if
condition|(
name|StripeMap
operator|&
literal|1
condition|)
block|{
name|format_stripe
argument_list|(
name|stripe
argument_list|,
sizeof|sizeof
argument_list|(
name|stripe
argument_list|)
argument_list|,
literal|1
operator|<<
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|comma
condition|)
name|printf
argument_list|(
literal|", "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|stripe
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|1
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|show_adapter
parameter_list|(
name|int
name|ac
parameter_list|,
name|char
modifier|*
modifier|*
name|av
parameter_list|)
block|{
name|CONFIG_PAGE_MANUFACTURING_0
modifier|*
name|man0
decl_stmt|;
name|CONFIG_PAGE_IOC_2
modifier|*
name|ioc2
decl_stmt|;
name|CONFIG_PAGE_IOC_6
modifier|*
name|ioc6
decl_stmt|;
name|int
name|fd
decl_stmt|,
name|comma
decl_stmt|;
if|if
condition|(
name|ac
operator|!=
literal|1
condition|)
block|{
name|warnx
argument_list|(
literal|"show adapter: extra arguments"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
name|fd
operator|=
name|mpt_open
argument_list|(
name|mpt_unit
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|<
literal|0
condition|)
block|{
name|warn
argument_list|(
literal|"mpt_open"
argument_list|)
expr_stmt|;
return|return
operator|(
name|errno
operator|)
return|;
block|}
name|man0
operator|=
name|mpt_read_man_page
argument_list|(
name|fd
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|man0
operator|==
name|NULL
condition|)
block|{
name|warn
argument_list|(
literal|"Failed to get controller info"
argument_list|)
expr_stmt|;
return|return
operator|(
name|errno
operator|)
return|;
block|}
if|if
condition|(
name|man0
operator|->
name|Header
operator|.
name|PageLength
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|man0
argument_list|)
operator|/
literal|4
condition|)
block|{
name|warn
argument_list|(
literal|"Invalid controller info"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
name|printf
argument_list|(
literal|"mpt%d Adapter:\n"
argument_list|,
name|mpt_unit
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"       Board Name: %.16s\n"
argument_list|,
name|man0
operator|->
name|BoardName
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"   Board Assembly: %.16s\n"
argument_list|,
name|man0
operator|->
name|BoardAssembly
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"        Chip Name: %.16s\n"
argument_list|,
name|man0
operator|->
name|ChipName
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    Chip Revision: %.16s\n"
argument_list|,
name|man0
operator|->
name|ChipRevision
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|man0
argument_list|)
expr_stmt|;
name|ioc2
operator|=
name|mpt_read_ioc_page
argument_list|(
name|fd
argument_list|,
literal|2
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioc2
operator|!=
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"      RAID Levels:"
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ioc2
operator|->
name|CapabilitiesFlags
operator|&
name|MPI_IOCPAGE2_CAP_FLAGS_IS_SUPPORT
condition|)
block|{
name|printf
argument_list|(
literal|" RAID0"
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|ioc2
operator|->
name|CapabilitiesFlags
operator|&
name|MPI_IOCPAGE2_CAP_FLAGS_IM_SUPPORT
condition|)
block|{
name|printf
argument_list|(
literal|"%s RAID1"
argument_list|,
name|comma
condition|?
literal|","
else|:
literal|""
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|ioc2
operator|->
name|CapabilitiesFlags
operator|&
name|MPI_IOCPAGE2_CAP_FLAGS_IME_SUPPORT
condition|)
block|{
name|printf
argument_list|(
literal|"%s RAID1E"
argument_list|,
name|comma
condition|?
literal|","
else|:
literal|""
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|ioc2
operator|->
name|CapabilitiesFlags
operator|&
name|MPI_IOCPAGE2_CAP_FLAGS_RAID_5_SUPPORT
condition|)
block|{
name|printf
argument_list|(
literal|"%s RAID5"
argument_list|,
name|comma
condition|?
literal|","
else|:
literal|""
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|ioc2
operator|->
name|CapabilitiesFlags
operator|&
name|MPI_IOCPAGE2_CAP_FLAGS_RAID_6_SUPPORT
condition|)
block|{
name|printf
argument_list|(
literal|"%s RAID6"
argument_list|,
name|comma
condition|?
literal|","
else|:
literal|""
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|ioc2
operator|->
name|CapabilitiesFlags
operator|&
name|MPI_IOCPAGE2_CAP_FLAGS_RAID_10_SUPPORT
condition|)
block|{
name|printf
argument_list|(
literal|"%s RAID10"
argument_list|,
name|comma
condition|?
literal|","
else|:
literal|""
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|ioc2
operator|->
name|CapabilitiesFlags
operator|&
name|MPI_IOCPAGE2_CAP_FLAGS_RAID_50_SUPPORT
condition|)
block|{
name|printf
argument_list|(
literal|"%s RAID50"
argument_list|,
name|comma
condition|?
literal|","
else|:
literal|""
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|comma
condition|)
name|printf
argument_list|(
literal|" none"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|ioc2
argument_list|)
expr_stmt|;
block|}
name|ioc6
operator|=
name|mpt_read_ioc_page
argument_list|(
name|fd
argument_list|,
literal|6
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioc6
operator|!=
name|NULL
condition|)
block|{
name|display_stripe_map
argument_list|(
literal|"    RAID0 Stripes"
argument_list|,
name|ioc6
operator|->
name|SupportedStripeSizeMapIS
argument_list|)
expr_stmt|;
name|display_stripe_map
argument_list|(
literal|"   RAID1E Stripes"
argument_list|,
name|ioc6
operator|->
name|SupportedStripeSizeMapIME
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" RAID0 Drives/Vol: %u"
argument_list|,
name|ioc6
operator|->
name|MinDrivesIS
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioc6
operator|->
name|MinDrivesIS
operator|!=
name|ioc6
operator|->
name|MaxDrivesIS
condition|)
name|printf
argument_list|(
literal|"-%u"
argument_list|,
name|ioc6
operator|->
name|MaxDrivesIS
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" RAID1 Drives/Vol: %u"
argument_list|,
name|ioc6
operator|->
name|MinDrivesIM
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioc6
operator|->
name|MinDrivesIM
operator|!=
name|ioc6
operator|->
name|MaxDrivesIM
condition|)
name|printf
argument_list|(
literal|"-%u"
argument_list|,
name|ioc6
operator|->
name|MaxDrivesIM
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"RAID1E Drives/Vol: %u"
argument_list|,
name|ioc6
operator|->
name|MinDrivesIME
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioc6
operator|->
name|MinDrivesIME
operator|!=
name|ioc6
operator|->
name|MaxDrivesIME
condition|)
name|printf
argument_list|(
literal|"-%u"
argument_list|,
name|ioc6
operator|->
name|MaxDrivesIME
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|ioc6
argument_list|)
expr_stmt|;
block|}
comment|/* TODO: Add an ioctl to fetch IOC_FACTS and print firmware version. */
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_expr_stmt
name|MPT_COMMAND
argument_list|(
name|show
argument_list|,
name|adapter
argument_list|,
name|show_adapter
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|void
name|print_vol
parameter_list|(
name|CONFIG_PAGE_RAID_VOL_0
modifier|*
name|info
parameter_list|,
name|int
name|state_len
parameter_list|)
block|{
name|uint64_t
name|size
decl_stmt|;
specifier|const
name|char
modifier|*
name|level
decl_stmt|,
modifier|*
name|state
decl_stmt|;
name|char
name|buf
index|[
literal|6
index|]
decl_stmt|,
name|stripe
index|[
literal|5
index|]
decl_stmt|;
name|size
operator|=
operator|(
operator|(
name|uint64_t
operator|)
name|info
operator|->
name|MaxLBAHigh
operator|<<
literal|32
operator|)
operator||
name|info
operator|->
name|MaxLBA
expr_stmt|;
name|humanize_number
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
operator|(
name|size
operator|+
literal|1
operator|)
operator|*
literal|512
argument_list|,
literal|""
argument_list|,
name|HN_AUTOSCALE
argument_list|,
name|HN_B
operator||
name|HN_NOSPACE
operator||
name|HN_DECIMAL
argument_list|)
expr_stmt|;
if|if
condition|(
name|info
operator|->
name|VolumeType
operator|==
name|MPI_RAID_VOL_TYPE_IM
condition|)
name|stripe
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
else|else
name|format_stripe
argument_list|(
name|stripe
argument_list|,
sizeof|sizeof
argument_list|(
name|stripe
argument_list|)
argument_list|,
name|info
operator|->
name|StripeSize
argument_list|)
expr_stmt|;
name|level
operator|=
name|mpt_raid_level
argument_list|(
name|info
operator|->
name|VolumeType
argument_list|)
expr_stmt|;
name|state
operator|=
name|mpt_volstate
argument_list|(
name|info
operator|->
name|VolumeStatus
operator|.
name|State
argument_list|)
expr_stmt|;
if|if
condition|(
name|state_len
operator|>
literal|0
condition|)
name|printf
argument_list|(
literal|"(%6s) %-8s %6s %-*s"
argument_list|,
name|buf
argument_list|,
name|level
argument_list|,
name|stripe
argument_list|,
name|state_len
argument_list|,
name|state
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|stripe
index|[
literal|0
index|]
operator|!=
literal|'\0'
condition|)
name|printf
argument_list|(
literal|"(%s) %s %s %s"
argument_list|,
name|buf
argument_list|,
name|level
argument_list|,
name|stripe
argument_list|,
name|state
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"(%s) %s %s"
argument_list|,
name|buf
argument_list|,
name|level
argument_list|,
name|state
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_pd
parameter_list|(
name|CONFIG_PAGE_RAID_PHYS_DISK_0
modifier|*
name|info
parameter_list|,
name|int
name|state_len
parameter_list|,
name|int
name|location
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|inq
decl_stmt|,
modifier|*
name|state
decl_stmt|;
name|char
name|buf
index|[
literal|6
index|]
decl_stmt|;
name|humanize_number
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
operator|(
operator|(
name|uint64_t
operator|)
name|info
operator|->
name|MaxLBA
operator|+
literal|1
operator|)
operator|*
literal|512
argument_list|,
literal|""
argument_list|,
name|HN_AUTOSCALE
argument_list|,
name|HN_B
operator||
name|HN_NOSPACE
operator||
name|HN_DECIMAL
argument_list|)
expr_stmt|;
name|state
operator|=
name|mpt_pdstate
argument_list|(
name|info
argument_list|)
expr_stmt|;
if|if
condition|(
name|state_len
operator|>
literal|0
condition|)
name|printf
argument_list|(
literal|"(%6s) %-*s"
argument_list|,
name|buf
argument_list|,
name|state_len
argument_list|,
name|state
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"(%s) %s"
argument_list|,
name|buf
argument_list|,
name|state
argument_list|)
expr_stmt|;
name|inq
operator|=
name|mpt_pd_inq_string
argument_list|(
name|info
argument_list|)
expr_stmt|;
if|if
condition|(
name|inq
operator|!=
name|NULL
condition|)
name|printf
argument_list|(
literal|" %s"
argument_list|,
name|inq
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|location
condition|)
return|return;
name|printf
argument_list|(
literal|" bus %d id %d"
argument_list|,
name|info
operator|->
name|PhysDiskBus
argument_list|,
name|info
operator|->
name|PhysDiskID
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_standalone
parameter_list|(
name|struct
name|mpt_standalone_disk
modifier|*
name|disk
parameter_list|,
name|int
name|state_len
parameter_list|,
name|int
name|location
parameter_list|)
block|{
name|char
name|buf
index|[
literal|6
index|]
decl_stmt|;
name|humanize_number
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
operator|(
name|disk
operator|->
name|maxlba
operator|+
literal|1
operator|)
operator|*
literal|512
argument_list|,
literal|""
argument_list|,
name|HN_AUTOSCALE
argument_list|,
name|HN_B
operator||
name|HN_NOSPACE
operator||
name|HN_DECIMAL
argument_list|)
expr_stmt|;
if|if
condition|(
name|state_len
operator|>
literal|0
condition|)
name|printf
argument_list|(
literal|"(%6s) %-*s"
argument_list|,
name|buf
argument_list|,
name|state_len
argument_list|,
name|STANDALONE_STATE
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"(%s) %s"
argument_list|,
name|buf
argument_list|,
name|STANDALONE_STATE
argument_list|)
expr_stmt|;
if|if
condition|(
name|disk
operator|->
name|inqstring
index|[
literal|0
index|]
operator|!=
literal|'\0'
condition|)
name|printf
argument_list|(
literal|" %s"
argument_list|,
name|disk
operator|->
name|inqstring
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|location
condition|)
return|return;
name|printf
argument_list|(
literal|" bus %d id %d"
argument_list|,
name|disk
operator|->
name|bus
argument_list|,
name|disk
operator|->
name|target
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_spare_pools
parameter_list|(
name|U8
name|HotSparePool
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|HotSparePool
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"none"
argument_list|)
expr_stmt|;
return|return;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|HotSparePool
operator|!=
literal|0
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|HotSparePool
operator|&
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|HotSparePool
operator|==
literal|1
condition|)
break|break;
name|printf
argument_list|(
literal|", "
argument_list|)
expr_stmt|;
block|}
name|HotSparePool
operator|>>=
literal|1
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|show_config
parameter_list|(
name|int
name|ac
parameter_list|,
name|char
modifier|*
modifier|*
name|av
parameter_list|)
block|{
name|CONFIG_PAGE_IOC_2
modifier|*
name|ioc2
decl_stmt|;
name|CONFIG_PAGE_IOC_2_RAID_VOL
modifier|*
name|vol
decl_stmt|;
name|CONFIG_PAGE_IOC_5
modifier|*
name|ioc5
decl_stmt|;
name|IOC_5_HOT_SPARE
modifier|*
name|spare
decl_stmt|;
name|CONFIG_PAGE_RAID_VOL_0
modifier|*
name|vinfo
decl_stmt|;
name|RAID_VOL0_PHYS_DISK
modifier|*
name|disk
decl_stmt|;
name|CONFIG_PAGE_RAID_VOL_1
modifier|*
name|vnames
decl_stmt|;
name|CONFIG_PAGE_RAID_PHYS_DISK_0
modifier|*
name|pinfo
decl_stmt|;
name|struct
name|mpt_standalone_disk
modifier|*
name|sdisks
decl_stmt|;
name|int
name|fd
decl_stmt|,
name|i
decl_stmt|,
name|j
decl_stmt|,
name|nsdisks
decl_stmt|;
if|if
condition|(
name|ac
operator|!=
literal|1
condition|)
block|{
name|warnx
argument_list|(
literal|"show config: extra arguments"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
name|fd
operator|=
name|mpt_open
argument_list|(
name|mpt_unit
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|<
literal|0
condition|)
block|{
name|warn
argument_list|(
literal|"mpt_open"
argument_list|)
expr_stmt|;
return|return
operator|(
name|errno
operator|)
return|;
block|}
comment|/* Get the config from the controller. */
name|ioc2
operator|=
name|mpt_read_ioc_page
argument_list|(
name|fd
argument_list|,
literal|2
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ioc5
operator|=
name|mpt_read_ioc_page
argument_list|(
name|fd
argument_list|,
literal|5
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioc2
operator|==
name|NULL
operator|||
name|ioc5
operator|==
name|NULL
condition|)
block|{
name|warn
argument_list|(
literal|"Failed to get config"
argument_list|)
expr_stmt|;
return|return
operator|(
name|errno
operator|)
return|;
block|}
if|if
condition|(
name|mpt_fetch_disks
argument_list|(
name|fd
argument_list|,
operator|&
name|nsdisks
argument_list|,
operator|&
name|sdisks
argument_list|)
operator|<
literal|0
condition|)
block|{
name|warn
argument_list|(
literal|"Failed to get standalone drive list"
argument_list|)
expr_stmt|;
return|return
operator|(
name|errno
operator|)
return|;
block|}
comment|/* Dump out the configuration. */
name|printf
argument_list|(
literal|"mpt%d Configuration: %d volumes, %d drives\n"
argument_list|,
name|mpt_unit
argument_list|,
name|ioc2
operator|->
name|NumActiveVolumes
argument_list|,
name|ioc2
operator|->
name|NumActivePhysDisks
operator|+
name|nsdisks
argument_list|)
expr_stmt|;
name|vol
operator|=
name|ioc2
operator|->
name|RaidVolume
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ioc2
operator|->
name|NumActiveVolumes
condition|;
name|vol
operator|++
operator|,
name|i
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"    volume %s "
argument_list|,
name|mpt_volume_name
argument_list|(
name|vol
operator|->
name|VolumeBus
argument_list|,
name|vol
operator|->
name|VolumeID
argument_list|)
argument_list|)
expr_stmt|;
name|vinfo
operator|=
name|mpt_vol_info
argument_list|(
name|fd
argument_list|,
name|vol
operator|->
name|VolumeBus
argument_list|,
name|vol
operator|->
name|VolumeID
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|vinfo
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"%s UNKNOWN"
argument_list|,
name|mpt_raid_level
argument_list|(
name|vol
operator|->
name|VolumeType
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|print_vol
argument_list|(
name|vinfo
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|vnames
operator|=
name|mpt_vol_names
argument_list|(
name|fd
argument_list|,
name|vol
operator|->
name|VolumeBus
argument_list|,
name|vol
operator|->
name|VolumeID
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|vnames
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|vnames
operator|->
name|Name
index|[
literal|0
index|]
operator|!=
literal|'\0'
condition|)
name|printf
argument_list|(
literal|"<%s>"
argument_list|,
name|vnames
operator|->
name|Name
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|vnames
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|vinfo
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|printf
argument_list|(
literal|" spans:\n"
argument_list|)
expr_stmt|;
name|disk
operator|=
name|vinfo
operator|->
name|PhysDisk
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|vinfo
operator|->
name|NumPhysDisks
condition|;
name|disk
operator|++
operator|,
name|j
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"        drive %u "
argument_list|,
name|disk
operator|->
name|PhysDiskNum
argument_list|)
expr_stmt|;
name|pinfo
operator|=
name|mpt_pd_info
argument_list|(
name|fd
argument_list|,
name|disk
operator|->
name|PhysDiskNum
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|pinfo
operator|!=
name|NULL
condition|)
block|{
name|print_pd
argument_list|(
name|pinfo
argument_list|,
operator|-
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|pinfo
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|vinfo
operator|->
name|VolumeSettings
operator|.
name|HotSparePool
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"        spare pools: "
argument_list|)
expr_stmt|;
name|print_spare_pools
argument_list|(
name|vinfo
operator|->
name|VolumeSettings
operator|.
name|HotSparePool
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|vinfo
argument_list|)
expr_stmt|;
block|}
name|spare
operator|=
name|ioc5
operator|->
name|HotSpare
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ioc5
operator|->
name|NumHotSpares
condition|;
name|spare
operator|++
operator|,
name|i
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"    spare %u "
argument_list|,
name|spare
operator|->
name|PhysDiskNum
argument_list|)
expr_stmt|;
name|pinfo
operator|=
name|mpt_pd_info
argument_list|(
name|fd
argument_list|,
name|spare
operator|->
name|PhysDiskNum
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|pinfo
operator|!=
name|NULL
condition|)
block|{
name|print_pd
argument_list|(
name|pinfo
argument_list|,
operator|-
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|pinfo
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|" backs pool %d\n"
argument_list|,
name|ffs
argument_list|(
name|spare
operator|->
name|HotSparePool
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nsdisks
condition|;
name|i
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"    drive %s "
argument_list|,
name|sdisks
index|[
name|i
index|]
operator|.
name|devname
argument_list|)
expr_stmt|;
name|print_standalone
argument_list|(
operator|&
name|sdisks
index|[
name|i
index|]
argument_list|,
operator|-
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|ioc2
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|ioc5
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|sdisks
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_expr_stmt
name|MPT_COMMAND
argument_list|(
name|show
argument_list|,
name|config
argument_list|,
name|show_config
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|int
name|show_volumes
parameter_list|(
name|int
name|ac
parameter_list|,
name|char
modifier|*
modifier|*
name|av
parameter_list|)
block|{
name|CONFIG_PAGE_IOC_2
modifier|*
name|ioc2
decl_stmt|;
name|CONFIG_PAGE_IOC_2_RAID_VOL
modifier|*
name|vol
decl_stmt|;
name|CONFIG_PAGE_RAID_VOL_0
modifier|*
modifier|*
name|volumes
decl_stmt|;
name|CONFIG_PAGE_RAID_VOL_1
modifier|*
name|vnames
decl_stmt|;
name|int
name|fd
decl_stmt|,
name|i
decl_stmt|,
name|len
decl_stmt|,
name|state_len
decl_stmt|;
if|if
condition|(
name|ac
operator|!=
literal|1
condition|)
block|{
name|warnx
argument_list|(
literal|"show volumes: extra arguments"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
name|fd
operator|=
name|mpt_open
argument_list|(
name|mpt_unit
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|<
literal|0
condition|)
block|{
name|warn
argument_list|(
literal|"mpt_open"
argument_list|)
expr_stmt|;
return|return
operator|(
name|errno
operator|)
return|;
block|}
comment|/* Get the volume list from the controller. */
name|ioc2
operator|=
name|mpt_read_ioc_page
argument_list|(
name|fd
argument_list|,
literal|2
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioc2
operator|==
name|NULL
condition|)
block|{
name|warn
argument_list|(
literal|"Failed to get volume list"
argument_list|)
expr_stmt|;
return|return
operator|(
name|errno
operator|)
return|;
block|}
comment|/* 	 * Go ahead and read the info for all the volumes and figure 	 * out the maximum width of the state field. 	 */
name|volumes
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|volumes
argument_list|)
operator|*
name|ioc2
operator|->
name|NumActiveVolumes
argument_list|)
expr_stmt|;
name|state_len
operator|=
name|strlen
argument_list|(
literal|"State"
argument_list|)
expr_stmt|;
name|vol
operator|=
name|ioc2
operator|->
name|RaidVolume
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ioc2
operator|->
name|NumActiveVolumes
condition|;
name|vol
operator|++
operator|,
name|i
operator|++
control|)
block|{
name|volumes
index|[
name|i
index|]
operator|=
name|mpt_vol_info
argument_list|(
name|fd
argument_list|,
name|vol
operator|->
name|VolumeBus
argument_list|,
name|vol
operator|->
name|VolumeID
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|volumes
index|[
name|i
index|]
operator|==
name|NULL
condition|)
name|len
operator|=
name|strlen
argument_list|(
literal|"UNKNOWN"
argument_list|)
expr_stmt|;
else|else
name|len
operator|=
name|strlen
argument_list|(
name|mpt_volstate
argument_list|(
name|volumes
index|[
name|i
index|]
operator|->
name|VolumeStatus
operator|.
name|State
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|state_len
condition|)
name|state_len
operator|=
name|len
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"mpt%d Volumes:\n"
argument_list|,
name|mpt_unit
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  Id     Size    Level   Stripe "
argument_list|)
expr_stmt|;
name|len
operator|=
name|state_len
operator|-
name|strlen
argument_list|(
literal|"State"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|len
operator|+
literal|1
operator|)
operator|/
literal|2
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"State"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
operator|/
literal|2
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" Write-Cache  Name\n"
argument_list|)
expr_stmt|;
name|vol
operator|=
name|ioc2
operator|->
name|RaidVolume
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ioc2
operator|->
name|NumActiveVolumes
condition|;
name|vol
operator|++
operator|,
name|i
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"%6s "
argument_list|,
name|mpt_volume_name
argument_list|(
name|vol
operator|->
name|VolumeBus
argument_list|,
name|vol
operator|->
name|VolumeID
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|volumes
index|[
name|i
index|]
operator|!=
name|NULL
condition|)
name|print_vol
argument_list|(
name|volumes
index|[
name|i
index|]
argument_list|,
name|state_len
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"         %-8s %-*s"
argument_list|,
name|mpt_raid_level
argument_list|(
name|vol
operator|->
name|VolumeType
argument_list|)
argument_list|,
name|state_len
argument_list|,
literal|"UNKNOWN"
argument_list|)
expr_stmt|;
if|if
condition|(
name|volumes
index|[
name|i
index|]
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|volumes
index|[
name|i
index|]
operator|->
name|VolumeSettings
operator|.
name|Settings
operator|&
name|MPI_RAIDVOL0_SETTING_WRITE_CACHING_ENABLE
condition|)
name|printf
argument_list|(
literal|"   Enabled   "
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"   Disabled  "
argument_list|)
expr_stmt|;
block|}
else|else
name|printf
argument_list|(
literal|"             "
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|volumes
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|vnames
operator|=
name|mpt_vol_names
argument_list|(
name|fd
argument_list|,
name|vol
operator|->
name|VolumeBus
argument_list|,
name|vol
operator|->
name|VolumeID
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|vnames
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|vnames
operator|->
name|Name
index|[
literal|0
index|]
operator|!=
literal|'\0'
condition|)
name|printf
argument_list|(
literal|"<%s>"
argument_list|,
name|vnames
operator|->
name|Name
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|vnames
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|ioc2
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_expr_stmt
name|MPT_COMMAND
argument_list|(
name|show
argument_list|,
name|volumes
argument_list|,
name|show_volumes
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|int
name|show_drives
parameter_list|(
name|int
name|ac
parameter_list|,
name|char
modifier|*
modifier|*
name|av
parameter_list|)
block|{
name|struct
name|mpt_drive_list
modifier|*
name|list
decl_stmt|;
name|struct
name|mpt_standalone_disk
modifier|*
name|sdisks
decl_stmt|;
name|int
name|fd
decl_stmt|,
name|i
decl_stmt|,
name|len
decl_stmt|,
name|nsdisks
decl_stmt|,
name|state_len
decl_stmt|;
if|if
condition|(
name|ac
operator|!=
literal|1
condition|)
block|{
name|warnx
argument_list|(
literal|"show drives: extra arguments"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
name|fd
operator|=
name|mpt_open
argument_list|(
name|mpt_unit
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|<
literal|0
condition|)
block|{
name|warn
argument_list|(
literal|"mpt_open"
argument_list|)
expr_stmt|;
return|return
operator|(
name|errno
operator|)
return|;
block|}
comment|/* Get the drive list. */
name|list
operator|=
name|mpt_pd_list
argument_list|(
name|fd
argument_list|)
expr_stmt|;
if|if
condition|(
name|list
operator|==
name|NULL
condition|)
block|{
name|warn
argument_list|(
literal|"Failed to get drive list"
argument_list|)
expr_stmt|;
return|return
operator|(
name|errno
operator|)
return|;
block|}
comment|/* Fetch the list of standalone disks for this controller. */
name|state_len
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|mpt_fetch_disks
argument_list|(
name|fd
argument_list|,
operator|&
name|nsdisks
argument_list|,
operator|&
name|sdisks
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|nsdisks
operator|=
literal|0
expr_stmt|;
name|sdisks
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|nsdisks
operator|!=
literal|0
condition|)
name|state_len
operator|=
name|strlen
argument_list|(
name|STANDALONE_STATE
argument_list|)
expr_stmt|;
comment|/* Walk the drive list to determine width of state column. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|list
operator|->
name|ndrives
condition|;
name|i
operator|++
control|)
block|{
name|len
operator|=
name|strlen
argument_list|(
name|mpt_pdstate
argument_list|(
name|list
operator|->
name|drives
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|state_len
condition|)
name|state_len
operator|=
name|len
expr_stmt|;
block|}
comment|/* List the drives. */
name|printf
argument_list|(
literal|"mpt%d Physical Drives:\n"
argument_list|,
name|mpt_unit
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|list
operator|->
name|ndrives
condition|;
name|i
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"%4u "
argument_list|,
name|list
operator|->
name|drives
index|[
name|i
index|]
operator|->
name|PhysDiskNum
argument_list|)
expr_stmt|;
name|print_pd
argument_list|(
name|list
operator|->
name|drives
index|[
name|i
index|]
argument_list|,
name|state_len
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|mpt_free_pd_list
argument_list|(
name|list
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nsdisks
condition|;
name|i
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"%4s "
argument_list|,
name|sdisks
index|[
name|i
index|]
operator|.
name|devname
argument_list|)
expr_stmt|;
name|print_standalone
argument_list|(
operator|&
name|sdisks
index|[
name|i
index|]
argument_list|,
name|state_len
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|sdisks
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_expr_stmt
name|MPT_COMMAND
argument_list|(
name|show
argument_list|,
name|drives
argument_list|,
name|show_drives
argument_list|)
expr_stmt|;
end_expr_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|DEBUG
end_ifdef

begin_function
specifier|static
name|int
name|show_physdisks
parameter_list|(
name|int
name|ac
parameter_list|,
name|char
modifier|*
modifier|*
name|av
parameter_list|)
block|{
name|CONFIG_PAGE_RAID_PHYS_DISK_0
modifier|*
name|pinfo
decl_stmt|;
name|U16
name|IOCStatus
decl_stmt|;
name|int
name|fd
decl_stmt|,
name|i
decl_stmt|;
if|if
condition|(
name|ac
operator|!=
literal|1
condition|)
block|{
name|warnx
argument_list|(
literal|"show drives: extra arguments"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
name|fd
operator|=
name|mpt_open
argument_list|(
name|mpt_unit
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|<
literal|0
condition|)
block|{
name|warn
argument_list|(
literal|"mpt_open"
argument_list|)
expr_stmt|;
return|return
operator|(
name|errno
operator|)
return|;
block|}
comment|/* Try to find each possible phys disk page. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
literal|0xff
condition|;
name|i
operator|++
control|)
block|{
name|pinfo
operator|=
name|mpt_pd_info
argument_list|(
name|fd
argument_list|,
name|i
argument_list|,
operator|&
name|IOCStatus
argument_list|)
expr_stmt|;
if|if
condition|(
name|pinfo
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|IOCStatus
operator|!=
name|MPI_IOCSTATUS_CONFIG_INVALID_PAGE
condition|)
name|warnx
argument_list|(
literal|"mpt_pd_info(%d): %s"
argument_list|,
name|i
argument_list|,
name|mpt_ioc_status
argument_list|(
name|IOCStatus
argument_list|)
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|printf
argument_list|(
literal|"%3u "
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|print_pd
argument_list|(
name|pinfo
argument_list|,
operator|-
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_expr_stmt
name|MPT_COMMAND
argument_list|(
name|show
argument_list|,
name|pd
argument_list|,
name|show_physdisks
argument_list|)
expr_stmt|;
end_expr_stmt

begin_endif
endif|#
directive|endif
end_endif

end_unit


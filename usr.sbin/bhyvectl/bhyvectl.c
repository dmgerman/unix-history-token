begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2011 NetApp, Inc.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY NETAPP, INC ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL NETAPP, INC OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/errno.h>
end_include

begin_include
include|#
directive|include
file|<sys/mman.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<libgen.h>
end_include

begin_include
include|#
directive|include
file|<libutil.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<getopt.h>
end_include

begin_include
include|#
directive|include
file|<assert.h>
end_include

begin_include
include|#
directive|include
file|<machine/vmm.h>
end_include

begin_include
include|#
directive|include
file|<vmmapi.h>
end_include

begin_include
include|#
directive|include
file|"intel/vmcs.h"
end_include

begin_define
define|#
directive|define
name|MB
value|(1UL<< 20)
end_define

begin_define
define|#
directive|define
name|GB
value|(1UL<< 30)
end_define

begin_define
define|#
directive|define
name|REQ_ARG
value|required_argument
end_define

begin_define
define|#
directive|define
name|NO_ARG
value|no_argument
end_define

begin_define
define|#
directive|define
name|OPT_ARG
value|optional_argument
end_define

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|progname
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|usage
parameter_list|(
name|void
parameter_list|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Usage: %s --vm=<vmname>\n"
literal|"       [--cpu=<vcpu_number>]\n"
literal|"       [--create]\n"
literal|"       [--destroy]\n"
literal|"       [--get-all]\n"
literal|"       [--get-stats]\n"
literal|"       [--set-desc-ds]\n"
literal|"       [--get-desc-ds]\n"
literal|"       [--set-desc-es]\n"
literal|"       [--get-desc-es]\n"
literal|"       [--set-desc-gs]\n"
literal|"       [--get-desc-gs]\n"
literal|"       [--set-desc-fs]\n"
literal|"       [--get-desc-fs]\n"
literal|"       [--set-desc-cs]\n"
literal|"       [--get-desc-cs]\n"
literal|"       [--set-desc-ss]\n"
literal|"       [--get-desc-ss]\n"
literal|"       [--set-desc-tr]\n"
literal|"       [--get-desc-tr]\n"
literal|"       [--set-desc-ldtr]\n"
literal|"       [--get-desc-ldtr]\n"
literal|"       [--set-desc-gdtr]\n"
literal|"       [--get-desc-gdtr]\n"
literal|"       [--set-desc-idtr]\n"
literal|"       [--get-desc-idtr]\n"
literal|"       [--run]\n"
literal|"       [--capname=<capname>]\n"
literal|"       [--getcap]\n"
literal|"       [--setcap=<0|1>]\n"
literal|"       [--desc-base=<BASE>]\n"
literal|"       [--desc-limit=<LIMIT>]\n"
literal|"       [--desc-access=<ACCESS>]\n"
literal|"       [--set-cr0=<CR0>]\n"
literal|"       [--get-cr0]\n"
literal|"       [--set-cr3=<CR3>]\n"
literal|"       [--get-cr3]\n"
literal|"       [--set-cr4=<CR4>]\n"
literal|"       [--get-cr4]\n"
literal|"       [--set-dr7=<DR7>]\n"
literal|"       [--get-dr7]\n"
literal|"       [--set-rsp=<RSP>]\n"
literal|"       [--get-rsp]\n"
literal|"       [--set-rip=<RIP>]\n"
literal|"       [--get-rip]\n"
literal|"       [--get-rax]\n"
literal|"       [--set-rax=<RAX>]\n"
literal|"       [--get-rbx]\n"
literal|"       [--get-rcx]\n"
literal|"       [--get-rdx]\n"
literal|"       [--get-rsi]\n"
literal|"       [--get-rdi]\n"
literal|"       [--get-rbp]\n"
literal|"       [--get-r8]\n"
literal|"       [--get-r9]\n"
literal|"       [--get-r10]\n"
literal|"       [--get-r11]\n"
literal|"       [--get-r12]\n"
literal|"       [--get-r13]\n"
literal|"       [--get-r14]\n"
literal|"       [--get-r15]\n"
literal|"       [--set-rflags=<RFLAGS>]\n"
literal|"       [--get-rflags]\n"
literal|"       [--set-cs]\n"
literal|"       [--get-cs]\n"
literal|"       [--set-ds]\n"
literal|"       [--get-ds]\n"
literal|"       [--set-es]\n"
literal|"       [--get-es]\n"
literal|"       [--set-fs]\n"
literal|"       [--get-fs]\n"
literal|"       [--set-gs]\n"
literal|"       [--get-gs]\n"
literal|"       [--set-ss]\n"
literal|"       [--get-ss]\n"
literal|"       [--get-tr]\n"
literal|"       [--get-ldtr]\n"
literal|"       [--get-vmcs-pinbased-ctls]\n"
literal|"       [--get-vmcs-procbased-ctls]\n"
literal|"       [--get-vmcs-procbased-ctls2]\n"
literal|"       [--get-vmcs-entry-interruption-info]\n"
literal|"       [--set-vmcs-entry-interruption-info=<info>]\n"
literal|"       [--get-vmcs-eptp]\n"
literal|"       [--get-vmcs-guest-physical-address\n"
literal|"       [--get-vmcs-guest-linear-address\n"
literal|"       [--set-vmcs-exception-bitmap]\n"
literal|"       [--get-vmcs-exception-bitmap]\n"
literal|"       [--get-vmcs-io-bitmap-address]\n"
literal|"       [--get-vmcs-tsc-offset]\n"
literal|"       [--get-vmcs-guest-pat]\n"
literal|"       [--get-vmcs-host-pat]\n"
literal|"       [--get-vmcs-host-cr0]\n"
literal|"       [--get-vmcs-host-cr3]\n"
literal|"       [--get-vmcs-host-cr4]\n"
literal|"       [--get-vmcs-host-rip]\n"
literal|"       [--get-vmcs-host-rsp]\n"
literal|"       [--get-vmcs-cr0-mask]\n"
literal|"       [--get-vmcs-cr0-shadow]\n"
literal|"       [--get-vmcs-cr4-mask]\n"
literal|"       [--get-vmcs-cr4-shadow]\n"
literal|"       [--get-vmcs-cr3-targets]\n"
literal|"       [--get-vmcs-apic-access-address]\n"
literal|"       [--get-vmcs-virtual-apic-address]\n"
literal|"       [--get-vmcs-tpr-threshold]\n"
literal|"       [--get-vmcs-msr-bitmap]\n"
literal|"       [--get-vmcs-msr-bitmap-address]\n"
literal|"       [--get-vmcs-vpid]\n"
literal|"       [--get-vmcs-ple-gap]\n"
literal|"       [--get-vmcs-ple-window]\n"
literal|"       [--get-vmcs-instruction-error]\n"
literal|"       [--get-vmcs-exit-ctls]\n"
literal|"       [--get-vmcs-entry-ctls]\n"
literal|"       [--get-vmcs-guest-sysenter]\n"
literal|"       [--get-vmcs-link]\n"
literal|"       [--get-vmcs-exit-reason]\n"
literal|"       [--get-vmcs-exit-qualification]\n"
literal|"       [--get-vmcs-exit-interruption-info]\n"
literal|"       [--get-vmcs-exit-interruption-error]\n"
literal|"       [--get-vmcs-interruptibility]\n"
literal|"       [--set-x2apic-state=<state>]\n"
literal|"       [--get-x2apic-state]\n"
literal|"       [--unassign-pptdev=<bus/slot/func>]\n"
literal|"       [--set-mem=<memory in units of MB>]\n"
literal|"       [--get-lowmem]\n"
literal|"       [--get-highmem]\n"
literal|"       [--get-gpa-pmap]\n"
literal|"       [--assert-lapic-lvt=<pin>]\n"
literal|"       [--inject-nmi]\n"
literal|"       [--force-reset]\n"
literal|"       [--force-poweroff]\n"
argument_list|,
name|progname
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
name|int
name|get_stats
decl_stmt|,
name|getcap
decl_stmt|,
name|setcap
decl_stmt|,
name|capval
decl_stmt|,
name|get_gpa_pmap
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|inject_nmi
decl_stmt|,
name|assert_lapic_lvt
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|force_reset
decl_stmt|,
name|force_poweroff
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|capname
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|create
decl_stmt|,
name|destroy
decl_stmt|,
name|get_lowmem
decl_stmt|,
name|get_highmem
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|uint64_t
name|memsize
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|set_cr0
decl_stmt|,
name|get_cr0
decl_stmt|,
name|set_cr3
decl_stmt|,
name|get_cr3
decl_stmt|,
name|set_cr4
decl_stmt|,
name|get_cr4
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|set_efer
decl_stmt|,
name|get_efer
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|set_dr7
decl_stmt|,
name|get_dr7
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|set_rsp
decl_stmt|,
name|get_rsp
decl_stmt|,
name|set_rip
decl_stmt|,
name|get_rip
decl_stmt|,
name|set_rflags
decl_stmt|,
name|get_rflags
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|set_rax
decl_stmt|,
name|get_rax
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|get_rbx
decl_stmt|,
name|get_rcx
decl_stmt|,
name|get_rdx
decl_stmt|,
name|get_rsi
decl_stmt|,
name|get_rdi
decl_stmt|,
name|get_rbp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|get_r8
decl_stmt|,
name|get_r9
decl_stmt|,
name|get_r10
decl_stmt|,
name|get_r11
decl_stmt|,
name|get_r12
decl_stmt|,
name|get_r13
decl_stmt|,
name|get_r14
decl_stmt|,
name|get_r15
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|set_desc_ds
decl_stmt|,
name|get_desc_ds
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|set_desc_es
decl_stmt|,
name|get_desc_es
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|set_desc_fs
decl_stmt|,
name|get_desc_fs
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|set_desc_gs
decl_stmt|,
name|get_desc_gs
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|set_desc_cs
decl_stmt|,
name|get_desc_cs
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|set_desc_ss
decl_stmt|,
name|get_desc_ss
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|set_desc_gdtr
decl_stmt|,
name|get_desc_gdtr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|set_desc_idtr
decl_stmt|,
name|get_desc_idtr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|set_desc_tr
decl_stmt|,
name|get_desc_tr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|set_desc_ldtr
decl_stmt|,
name|get_desc_ldtr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|set_cs
decl_stmt|,
name|set_ds
decl_stmt|,
name|set_es
decl_stmt|,
name|set_fs
decl_stmt|,
name|set_gs
decl_stmt|,
name|set_ss
decl_stmt|,
name|set_tr
decl_stmt|,
name|set_ldtr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|get_cs
decl_stmt|,
name|get_ds
decl_stmt|,
name|get_es
decl_stmt|,
name|get_fs
decl_stmt|,
name|get_gs
decl_stmt|,
name|get_ss
decl_stmt|,
name|get_tr
decl_stmt|,
name|get_ldtr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|set_x2apic_state
decl_stmt|,
name|get_x2apic_state
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|enum
name|x2apic_state
name|x2apic_state
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|unassign_pptdev
decl_stmt|,
name|bus
decl_stmt|,
name|slot
decl_stmt|,
name|func
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|run
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * VMCS-specific fields  */
end_comment

begin_decl_stmt
specifier|static
name|int
name|get_pinbased_ctls
decl_stmt|,
name|get_procbased_ctls
decl_stmt|,
name|get_procbased_ctls2
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|get_eptp
decl_stmt|,
name|get_io_bitmap
decl_stmt|,
name|get_tsc_offset
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|get_vmcs_entry_interruption_info
decl_stmt|,
name|set_vmcs_entry_interruption_info
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|get_vmcs_interruptibility
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|uint32_t
name|vmcs_entry_interruption_info
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|get_vmcs_gpa
decl_stmt|,
name|get_vmcs_gla
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|get_exception_bitmap
decl_stmt|,
name|set_exception_bitmap
decl_stmt|,
name|exception_bitmap
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|get_cr0_mask
decl_stmt|,
name|get_cr0_shadow
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|get_cr4_mask
decl_stmt|,
name|get_cr4_shadow
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|get_cr3_targets
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|get_apic_access_addr
decl_stmt|,
name|get_virtual_apic_addr
decl_stmt|,
name|get_tpr_threshold
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|get_msr_bitmap
decl_stmt|,
name|get_msr_bitmap_address
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|get_vpid
decl_stmt|,
name|get_ple_gap
decl_stmt|,
name|get_ple_window
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|get_inst_err
decl_stmt|,
name|get_exit_ctls
decl_stmt|,
name|get_entry_ctls
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|get_host_cr0
decl_stmt|,
name|get_host_cr3
decl_stmt|,
name|get_host_cr4
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|get_host_rip
decl_stmt|,
name|get_host_rsp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|get_guest_pat
decl_stmt|,
name|get_host_pat
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|get_guest_sysenter
decl_stmt|,
name|get_vmcs_link
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|get_vmcs_exit_reason
decl_stmt|,
name|get_vmcs_exit_qualification
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|get_vmcs_exit_interruption_info
decl_stmt|,
name|get_vmcs_exit_interruption_error
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|uint64_t
name|desc_base
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|uint32_t
name|desc_limit
decl_stmt|,
name|desc_access
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|get_all
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|dump_vm_run_exitcode
parameter_list|(
name|struct
name|vm_exit
modifier|*
name|vmexit
parameter_list|,
name|int
name|vcpu
parameter_list|)
block|{
name|printf
argument_list|(
literal|"vm exit[%d]\n"
argument_list|,
name|vcpu
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\trip\t\t0x%016lx\n"
argument_list|,
name|vmexit
operator|->
name|rip
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tinst_length\t%d\n"
argument_list|,
name|vmexit
operator|->
name|inst_length
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|vmexit
operator|->
name|exitcode
condition|)
block|{
case|case
name|VM_EXITCODE_INOUT
case|:
name|printf
argument_list|(
literal|"\treason\t\tINOUT\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tdirection\t%s\n"
argument_list|,
name|vmexit
operator|->
name|u
operator|.
name|inout
operator|.
name|in
condition|?
literal|"IN"
else|:
literal|"OUT"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tbytes\t\t%d\n"
argument_list|,
name|vmexit
operator|->
name|u
operator|.
name|inout
operator|.
name|bytes
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tflags\t\t%s%s\n"
argument_list|,
name|vmexit
operator|->
name|u
operator|.
name|inout
operator|.
name|string
condition|?
literal|"STRING "
else|:
literal|""
argument_list|,
name|vmexit
operator|->
name|u
operator|.
name|inout
operator|.
name|rep
condition|?
literal|"REP "
else|:
literal|""
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tport\t\t0x%04x\n"
argument_list|,
name|vmexit
operator|->
name|u
operator|.
name|inout
operator|.
name|port
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\teax\t\t0x%08x\n"
argument_list|,
name|vmexit
operator|->
name|u
operator|.
name|inout
operator|.
name|eax
argument_list|)
expr_stmt|;
break|break;
case|case
name|VM_EXITCODE_VMX
case|:
name|printf
argument_list|(
literal|"\treason\t\tVMX\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tstatus\t\t%d\n"
argument_list|,
name|vmexit
operator|->
name|u
operator|.
name|vmx
operator|.
name|status
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\texit_reason\t0x%08x (%u)\n"
argument_list|,
name|vmexit
operator|->
name|u
operator|.
name|vmx
operator|.
name|exit_reason
argument_list|,
name|vmexit
operator|->
name|u
operator|.
name|vmx
operator|.
name|exit_reason
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tqualification\t0x%016lx\n"
argument_list|,
name|vmexit
operator|->
name|u
operator|.
name|vmx
operator|.
name|exit_qualification
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tinst_type\t\t%d\n"
argument_list|,
name|vmexit
operator|->
name|u
operator|.
name|vmx
operator|.
name|inst_type
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tinst_error\t\t%d\n"
argument_list|,
name|vmexit
operator|->
name|u
operator|.
name|vmx
operator|.
name|inst_error
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"*** unknown vm run exitcode %d\n"
argument_list|,
name|vmexit
operator|->
name|exitcode
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|dump_vmcs_msr_bitmap
parameter_list|(
name|int
name|vcpu
parameter_list|,
name|u_long
name|addr
parameter_list|)
block|{
name|int
name|error
decl_stmt|,
name|fd
decl_stmt|,
name|byte
decl_stmt|,
name|bit
decl_stmt|,
name|readable
decl_stmt|,
name|writeable
decl_stmt|;
name|u_int
name|msr
decl_stmt|;
specifier|const
name|char
modifier|*
name|bitmap
decl_stmt|;
name|error
operator|=
operator|-
literal|1
expr_stmt|;
name|bitmap
operator|=
name|MAP_FAILED
expr_stmt|;
name|fd
operator|=
name|open
argument_list|(
literal|"/dev/mem"
argument_list|,
name|O_RDONLY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|<
literal|0
condition|)
goto|goto
name|done
goto|;
name|bitmap
operator|=
name|mmap
argument_list|(
name|NULL
argument_list|,
name|PAGE_SIZE
argument_list|,
name|PROT_READ
argument_list|,
literal|0
argument_list|,
name|fd
argument_list|,
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|bitmap
operator|==
name|MAP_FAILED
condition|)
goto|goto
name|done
goto|;
for|for
control|(
name|msr
operator|=
literal|0
init|;
name|msr
operator|<
literal|0x2000
condition|;
name|msr
operator|++
control|)
block|{
name|byte
operator|=
name|msr
operator|/
literal|8
expr_stmt|;
name|bit
operator|=
name|msr
operator|&
literal|0x7
expr_stmt|;
comment|/* Look at MSRs in the range 0x00000000 to 0x00001FFF */
name|readable
operator|=
operator|(
name|bitmap
index|[
name|byte
index|]
operator|&
operator|(
literal|1
operator|<<
name|bit
operator|)
operator|)
condition|?
literal|0
else|:
literal|1
expr_stmt|;
name|writeable
operator|=
operator|(
name|bitmap
index|[
literal|2048
operator|+
name|byte
index|]
operator|&
operator|(
literal|1
operator|<<
name|bit
operator|)
operator|)
condition|?
literal|0
else|:
literal|1
expr_stmt|;
if|if
condition|(
name|readable
operator|||
name|writeable
condition|)
block|{
name|printf
argument_list|(
literal|"msr 0x%08x[%d]\t\t%c%c\n"
argument_list|,
name|msr
argument_list|,
name|vcpu
argument_list|,
name|readable
condition|?
literal|'R'
else|:
literal|'-'
argument_list|,
name|writeable
condition|?
literal|'W'
else|:
literal|'-'
argument_list|)
expr_stmt|;
block|}
comment|/* Look at MSRs in the range 0xC0000000 to 0xC0001FFF */
name|byte
operator|+=
literal|1024
expr_stmt|;
name|readable
operator|=
operator|(
name|bitmap
index|[
name|byte
index|]
operator|&
operator|(
literal|1
operator|<<
name|bit
operator|)
operator|)
condition|?
literal|0
else|:
literal|1
expr_stmt|;
name|writeable
operator|=
operator|(
name|bitmap
index|[
literal|2048
operator|+
name|byte
index|]
operator|&
operator|(
literal|1
operator|<<
name|bit
operator|)
operator|)
condition|?
literal|0
else|:
literal|1
expr_stmt|;
if|if
condition|(
name|readable
operator|||
name|writeable
condition|)
block|{
name|printf
argument_list|(
literal|"msr 0x%08x[%d]\t\t%c%c\n"
argument_list|,
literal|0xc0000000
operator|+
name|msr
argument_list|,
name|vcpu
argument_list|,
name|readable
condition|?
literal|'R'
else|:
literal|'-'
argument_list|,
name|writeable
condition|?
literal|'W'
else|:
literal|'-'
argument_list|)
expr_stmt|;
block|}
block|}
name|error
operator|=
literal|0
expr_stmt|;
name|done
label|:
if|if
condition|(
name|bitmap
operator|!=
name|MAP_FAILED
condition|)
name|munmap
argument_list|(
operator|(
name|void
operator|*
operator|)
name|bitmap
argument_list|,
name|PAGE_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|>=
literal|0
condition|)
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vm_get_vmcs_field
parameter_list|(
name|struct
name|vmctx
modifier|*
name|ctx
parameter_list|,
name|int
name|vcpu
parameter_list|,
name|int
name|field
parameter_list|,
name|uint64_t
modifier|*
name|ret_val
parameter_list|)
block|{
return|return
operator|(
name|vm_get_register
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VMCS_IDENT
argument_list|(
name|field
argument_list|)
argument_list|,
name|ret_val
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vm_set_vmcs_field
parameter_list|(
name|struct
name|vmctx
modifier|*
name|ctx
parameter_list|,
name|int
name|vcpu
parameter_list|,
name|int
name|field
parameter_list|,
name|uint64_t
name|val
parameter_list|)
block|{
return|return
operator|(
name|vm_set_register
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VMCS_IDENT
argument_list|(
name|field
argument_list|)
argument_list|,
name|val
argument_list|)
operator|)
return|;
block|}
end_function

begin_enum
enum|enum
block|{
name|VMNAME
init|=
literal|1000
block|,
comment|/* avoid collision with return values from getopt */
name|VCPU
block|,
name|SET_MEM
block|,
name|SET_EFER
block|,
name|SET_CR0
block|,
name|SET_CR3
block|,
name|SET_CR4
block|,
name|SET_DR7
block|,
name|SET_RSP
block|,
name|SET_RIP
block|,
name|SET_RAX
block|,
name|SET_RFLAGS
block|,
name|DESC_BASE
block|,
name|DESC_LIMIT
block|,
name|DESC_ACCESS
block|,
name|SET_CS
block|,
name|SET_DS
block|,
name|SET_ES
block|,
name|SET_FS
block|,
name|SET_GS
block|,
name|SET_SS
block|,
name|SET_TR
block|,
name|SET_LDTR
block|,
name|SET_X2APIC_STATE
block|,
name|SET_VMCS_EXCEPTION_BITMAP
block|,
name|SET_VMCS_ENTRY_INTERRUPTION_INFO
block|,
name|SET_CAP
block|,
name|CAPNAME
block|,
name|UNASSIGN_PPTDEV
block|,
name|GET_GPA_PMAP
block|,
name|ASSERT_LAPIC_LVT
block|, }
enum|;
end_enum

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|char
modifier|*
name|vmname
decl_stmt|;
name|int
name|error
decl_stmt|,
name|ch
decl_stmt|,
name|vcpu
decl_stmt|,
name|ptenum
decl_stmt|;
name|vm_paddr_t
name|gpa
decl_stmt|,
name|gpa_pmap
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|struct
name|vm_exit
name|vmexit
decl_stmt|;
name|uint64_t
name|ctl
decl_stmt|,
name|eptp
decl_stmt|,
name|bm
decl_stmt|,
name|addr
decl_stmt|,
name|u64
decl_stmt|,
name|pteval
index|[
literal|4
index|]
decl_stmt|,
modifier|*
name|pte
decl_stmt|;
name|struct
name|vmctx
modifier|*
name|ctx
decl_stmt|;
name|int
name|wired
decl_stmt|;
name|uint64_t
name|cr0
decl_stmt|,
name|cr3
decl_stmt|,
name|cr4
decl_stmt|,
name|dr7
decl_stmt|,
name|rsp
decl_stmt|,
name|rip
decl_stmt|,
name|rflags
decl_stmt|,
name|efer
decl_stmt|,
name|pat
decl_stmt|;
name|uint64_t
name|rax
decl_stmt|,
name|rbx
decl_stmt|,
name|rcx
decl_stmt|,
name|rdx
decl_stmt|,
name|rsi
decl_stmt|,
name|rdi
decl_stmt|,
name|rbp
decl_stmt|;
name|uint64_t
name|r8
decl_stmt|,
name|r9
decl_stmt|,
name|r10
decl_stmt|,
name|r11
decl_stmt|,
name|r12
decl_stmt|,
name|r13
decl_stmt|,
name|r14
decl_stmt|,
name|r15
decl_stmt|;
name|uint64_t
name|cs
decl_stmt|,
name|ds
decl_stmt|,
name|es
decl_stmt|,
name|fs
decl_stmt|,
name|gs
decl_stmt|,
name|ss
decl_stmt|,
name|tr
decl_stmt|,
name|ldtr
decl_stmt|;
name|struct
name|option
name|opts
index|[]
init|=
block|{
block|{
literal|"vm"
block|,
name|REQ_ARG
block|,
literal|0
block|,
name|VMNAME
block|}
block|,
block|{
literal|"cpu"
block|,
name|REQ_ARG
block|,
literal|0
block|,
name|VCPU
block|}
block|,
block|{
literal|"set-mem"
block|,
name|REQ_ARG
block|,
literal|0
block|,
name|SET_MEM
block|}
block|,
block|{
literal|"set-efer"
block|,
name|REQ_ARG
block|,
literal|0
block|,
name|SET_EFER
block|}
block|,
block|{
literal|"set-cr0"
block|,
name|REQ_ARG
block|,
literal|0
block|,
name|SET_CR0
block|}
block|,
block|{
literal|"set-cr3"
block|,
name|REQ_ARG
block|,
literal|0
block|,
name|SET_CR3
block|}
block|,
block|{
literal|"set-cr4"
block|,
name|REQ_ARG
block|,
literal|0
block|,
name|SET_CR4
block|}
block|,
block|{
literal|"set-dr7"
block|,
name|REQ_ARG
block|,
literal|0
block|,
name|SET_DR7
block|}
block|,
block|{
literal|"set-rsp"
block|,
name|REQ_ARG
block|,
literal|0
block|,
name|SET_RSP
block|}
block|,
block|{
literal|"set-rip"
block|,
name|REQ_ARG
block|,
literal|0
block|,
name|SET_RIP
block|}
block|,
block|{
literal|"set-rax"
block|,
name|REQ_ARG
block|,
literal|0
block|,
name|SET_RAX
block|}
block|,
block|{
literal|"set-rflags"
block|,
name|REQ_ARG
block|,
literal|0
block|,
name|SET_RFLAGS
block|}
block|,
block|{
literal|"desc-base"
block|,
name|REQ_ARG
block|,
literal|0
block|,
name|DESC_BASE
block|}
block|,
block|{
literal|"desc-limit"
block|,
name|REQ_ARG
block|,
literal|0
block|,
name|DESC_LIMIT
block|}
block|,
block|{
literal|"desc-access"
block|,
name|REQ_ARG
block|,
literal|0
block|,
name|DESC_ACCESS
block|}
block|,
block|{
literal|"set-cs"
block|,
name|REQ_ARG
block|,
literal|0
block|,
name|SET_CS
block|}
block|,
block|{
literal|"set-ds"
block|,
name|REQ_ARG
block|,
literal|0
block|,
name|SET_DS
block|}
block|,
block|{
literal|"set-es"
block|,
name|REQ_ARG
block|,
literal|0
block|,
name|SET_ES
block|}
block|,
block|{
literal|"set-fs"
block|,
name|REQ_ARG
block|,
literal|0
block|,
name|SET_FS
block|}
block|,
block|{
literal|"set-gs"
block|,
name|REQ_ARG
block|,
literal|0
block|,
name|SET_GS
block|}
block|,
block|{
literal|"set-ss"
block|,
name|REQ_ARG
block|,
literal|0
block|,
name|SET_SS
block|}
block|,
block|{
literal|"set-tr"
block|,
name|REQ_ARG
block|,
literal|0
block|,
name|SET_TR
block|}
block|,
block|{
literal|"set-ldtr"
block|,
name|REQ_ARG
block|,
literal|0
block|,
name|SET_LDTR
block|}
block|,
block|{
literal|"set-x2apic-state"
block|,
name|REQ_ARG
block|,
literal|0
block|,
name|SET_X2APIC_STATE
block|}
block|,
block|{
literal|"set-vmcs-exception-bitmap"
block|,
name|REQ_ARG
block|,
literal|0
block|,
name|SET_VMCS_EXCEPTION_BITMAP
block|}
block|,
block|{
literal|"set-vmcs-entry-interruption-info"
block|,
name|REQ_ARG
block|,
literal|0
block|,
name|SET_VMCS_ENTRY_INTERRUPTION_INFO
block|}
block|,
block|{
literal|"capname"
block|,
name|REQ_ARG
block|,
literal|0
block|,
name|CAPNAME
block|}
block|,
block|{
literal|"unassign-pptdev"
block|,
name|REQ_ARG
block|,
literal|0
block|,
name|UNASSIGN_PPTDEV
block|}
block|,
block|{
literal|"setcap"
block|,
name|REQ_ARG
block|,
literal|0
block|,
name|SET_CAP
block|}
block|,
block|{
literal|"get-gpa-pmap"
block|,
name|REQ_ARG
block|,
literal|0
block|,
name|GET_GPA_PMAP
block|}
block|,
block|{
literal|"assert-lapic-lvt"
block|,
name|REQ_ARG
block|,
literal|0
block|,
name|ASSERT_LAPIC_LVT
block|}
block|,
block|{
literal|"getcap"
block|,
name|NO_ARG
block|,
operator|&
name|getcap
block|,
literal|1
block|}
block|,
block|{
literal|"get-stats"
block|,
name|NO_ARG
block|,
operator|&
name|get_stats
block|,
literal|1
block|}
block|,
block|{
literal|"get-desc-ds"
block|,
name|NO_ARG
block|,
operator|&
name|get_desc_ds
block|,
literal|1
block|}
block|,
block|{
literal|"set-desc-ds"
block|,
name|NO_ARG
block|,
operator|&
name|set_desc_ds
block|,
literal|1
block|}
block|,
block|{
literal|"get-desc-es"
block|,
name|NO_ARG
block|,
operator|&
name|get_desc_es
block|,
literal|1
block|}
block|,
block|{
literal|"set-desc-es"
block|,
name|NO_ARG
block|,
operator|&
name|set_desc_es
block|,
literal|1
block|}
block|,
block|{
literal|"get-desc-ss"
block|,
name|NO_ARG
block|,
operator|&
name|get_desc_ss
block|,
literal|1
block|}
block|,
block|{
literal|"set-desc-ss"
block|,
name|NO_ARG
block|,
operator|&
name|set_desc_ss
block|,
literal|1
block|}
block|,
block|{
literal|"get-desc-cs"
block|,
name|NO_ARG
block|,
operator|&
name|get_desc_cs
block|,
literal|1
block|}
block|,
block|{
literal|"set-desc-cs"
block|,
name|NO_ARG
block|,
operator|&
name|set_desc_cs
block|,
literal|1
block|}
block|,
block|{
literal|"get-desc-fs"
block|,
name|NO_ARG
block|,
operator|&
name|get_desc_fs
block|,
literal|1
block|}
block|,
block|{
literal|"set-desc-fs"
block|,
name|NO_ARG
block|,
operator|&
name|set_desc_fs
block|,
literal|1
block|}
block|,
block|{
literal|"get-desc-gs"
block|,
name|NO_ARG
block|,
operator|&
name|get_desc_gs
block|,
literal|1
block|}
block|,
block|{
literal|"set-desc-gs"
block|,
name|NO_ARG
block|,
operator|&
name|set_desc_gs
block|,
literal|1
block|}
block|,
block|{
literal|"get-desc-tr"
block|,
name|NO_ARG
block|,
operator|&
name|get_desc_tr
block|,
literal|1
block|}
block|,
block|{
literal|"set-desc-tr"
block|,
name|NO_ARG
block|,
operator|&
name|set_desc_tr
block|,
literal|1
block|}
block|,
block|{
literal|"set-desc-ldtr"
block|,
name|NO_ARG
block|,
operator|&
name|set_desc_ldtr
block|,
literal|1
block|}
block|,
block|{
literal|"get-desc-ldtr"
block|,
name|NO_ARG
block|,
operator|&
name|get_desc_ldtr
block|,
literal|1
block|}
block|,
block|{
literal|"set-desc-gdtr"
block|,
name|NO_ARG
block|,
operator|&
name|set_desc_gdtr
block|,
literal|1
block|}
block|,
block|{
literal|"get-desc-gdtr"
block|,
name|NO_ARG
block|,
operator|&
name|get_desc_gdtr
block|,
literal|1
block|}
block|,
block|{
literal|"set-desc-idtr"
block|,
name|NO_ARG
block|,
operator|&
name|set_desc_idtr
block|,
literal|1
block|}
block|,
block|{
literal|"get-desc-idtr"
block|,
name|NO_ARG
block|,
operator|&
name|get_desc_idtr
block|,
literal|1
block|}
block|,
block|{
literal|"get-lowmem"
block|,
name|NO_ARG
block|,
operator|&
name|get_lowmem
block|,
literal|1
block|}
block|,
block|{
literal|"get-highmem"
block|,
name|NO_ARG
block|,
operator|&
name|get_highmem
block|,
literal|1
block|}
block|,
block|{
literal|"get-efer"
block|,
name|NO_ARG
block|,
operator|&
name|get_efer
block|,
literal|1
block|}
block|,
block|{
literal|"get-cr0"
block|,
name|NO_ARG
block|,
operator|&
name|get_cr0
block|,
literal|1
block|}
block|,
block|{
literal|"get-cr3"
block|,
name|NO_ARG
block|,
operator|&
name|get_cr3
block|,
literal|1
block|}
block|,
block|{
literal|"get-cr4"
block|,
name|NO_ARG
block|,
operator|&
name|get_cr4
block|,
literal|1
block|}
block|,
block|{
literal|"get-dr7"
block|,
name|NO_ARG
block|,
operator|&
name|get_dr7
block|,
literal|1
block|}
block|,
block|{
literal|"get-rsp"
block|,
name|NO_ARG
block|,
operator|&
name|get_rsp
block|,
literal|1
block|}
block|,
block|{
literal|"get-rip"
block|,
name|NO_ARG
block|,
operator|&
name|get_rip
block|,
literal|1
block|}
block|,
block|{
literal|"get-rax"
block|,
name|NO_ARG
block|,
operator|&
name|get_rax
block|,
literal|1
block|}
block|,
block|{
literal|"get-rbx"
block|,
name|NO_ARG
block|,
operator|&
name|get_rbx
block|,
literal|1
block|}
block|,
block|{
literal|"get-rcx"
block|,
name|NO_ARG
block|,
operator|&
name|get_rcx
block|,
literal|1
block|}
block|,
block|{
literal|"get-rdx"
block|,
name|NO_ARG
block|,
operator|&
name|get_rdx
block|,
literal|1
block|}
block|,
block|{
literal|"get-rsi"
block|,
name|NO_ARG
block|,
operator|&
name|get_rsi
block|,
literal|1
block|}
block|,
block|{
literal|"get-rdi"
block|,
name|NO_ARG
block|,
operator|&
name|get_rdi
block|,
literal|1
block|}
block|,
block|{
literal|"get-rbp"
block|,
name|NO_ARG
block|,
operator|&
name|get_rbp
block|,
literal|1
block|}
block|,
block|{
literal|"get-r8"
block|,
name|NO_ARG
block|,
operator|&
name|get_r8
block|,
literal|1
block|}
block|,
block|{
literal|"get-r9"
block|,
name|NO_ARG
block|,
operator|&
name|get_r9
block|,
literal|1
block|}
block|,
block|{
literal|"get-r10"
block|,
name|NO_ARG
block|,
operator|&
name|get_r10
block|,
literal|1
block|}
block|,
block|{
literal|"get-r11"
block|,
name|NO_ARG
block|,
operator|&
name|get_r11
block|,
literal|1
block|}
block|,
block|{
literal|"get-r12"
block|,
name|NO_ARG
block|,
operator|&
name|get_r12
block|,
literal|1
block|}
block|,
block|{
literal|"get-r13"
block|,
name|NO_ARG
block|,
operator|&
name|get_r13
block|,
literal|1
block|}
block|,
block|{
literal|"get-r14"
block|,
name|NO_ARG
block|,
operator|&
name|get_r14
block|,
literal|1
block|}
block|,
block|{
literal|"get-r15"
block|,
name|NO_ARG
block|,
operator|&
name|get_r15
block|,
literal|1
block|}
block|,
block|{
literal|"get-rflags"
block|,
name|NO_ARG
block|,
operator|&
name|get_rflags
block|,
literal|1
block|}
block|,
block|{
literal|"get-cs"
block|,
name|NO_ARG
block|,
operator|&
name|get_cs
block|,
literal|1
block|}
block|,
block|{
literal|"get-ds"
block|,
name|NO_ARG
block|,
operator|&
name|get_ds
block|,
literal|1
block|}
block|,
block|{
literal|"get-es"
block|,
name|NO_ARG
block|,
operator|&
name|get_es
block|,
literal|1
block|}
block|,
block|{
literal|"get-fs"
block|,
name|NO_ARG
block|,
operator|&
name|get_fs
block|,
literal|1
block|}
block|,
block|{
literal|"get-gs"
block|,
name|NO_ARG
block|,
operator|&
name|get_gs
block|,
literal|1
block|}
block|,
block|{
literal|"get-ss"
block|,
name|NO_ARG
block|,
operator|&
name|get_ss
block|,
literal|1
block|}
block|,
block|{
literal|"get-tr"
block|,
name|NO_ARG
block|,
operator|&
name|get_tr
block|,
literal|1
block|}
block|,
block|{
literal|"get-ldtr"
block|,
name|NO_ARG
block|,
operator|&
name|get_ldtr
block|,
literal|1
block|}
block|,
block|{
literal|"get-vmcs-pinbased-ctls"
block|,
name|NO_ARG
block|,
operator|&
name|get_pinbased_ctls
block|,
literal|1
block|}
block|,
block|{
literal|"get-vmcs-procbased-ctls"
block|,
name|NO_ARG
block|,
operator|&
name|get_procbased_ctls
block|,
literal|1
block|}
block|,
block|{
literal|"get-vmcs-procbased-ctls2"
block|,
name|NO_ARG
block|,
operator|&
name|get_procbased_ctls2
block|,
literal|1
block|}
block|,
block|{
literal|"get-vmcs-guest-linear-address"
block|,
name|NO_ARG
block|,
operator|&
name|get_vmcs_gla
block|,
literal|1
block|}
block|,
block|{
literal|"get-vmcs-guest-physical-address"
block|,
name|NO_ARG
block|,
operator|&
name|get_vmcs_gpa
block|,
literal|1
block|}
block|,
block|{
literal|"get-vmcs-entry-interruption-info"
block|,
name|NO_ARG
block|,
operator|&
name|get_vmcs_entry_interruption_info
block|,
literal|1
block|}
block|,
block|{
literal|"get-vmcs-eptp"
block|,
name|NO_ARG
block|,
operator|&
name|get_eptp
block|,
literal|1
block|}
block|,
block|{
literal|"get-vmcs-exception-bitmap"
block|,
name|NO_ARG
block|,
operator|&
name|get_exception_bitmap
block|,
literal|1
block|}
block|,
block|{
literal|"get-vmcs-io-bitmap-address"
block|,
name|NO_ARG
block|,
operator|&
name|get_io_bitmap
block|,
literal|1
block|}
block|,
block|{
literal|"get-vmcs-tsc-offset"
block|,
name|NO_ARG
block|,
operator|&
name|get_tsc_offset
block|,
literal|1
block|}
block|,
block|{
literal|"get-vmcs-cr0-mask"
block|,
name|NO_ARG
block|,
operator|&
name|get_cr0_mask
block|,
literal|1
block|}
block|,
block|{
literal|"get-vmcs-cr0-shadow"
block|,
name|NO_ARG
block|,
operator|&
name|get_cr0_shadow
block|,
literal|1
block|}
block|,
block|{
literal|"get-vmcs-cr4-mask"
block|,
name|NO_ARG
block|,
operator|&
name|get_cr4_mask
block|,
literal|1
block|}
block|,
block|{
literal|"get-vmcs-cr4-shadow"
block|,
name|NO_ARG
block|,
operator|&
name|get_cr4_shadow
block|,
literal|1
block|}
block|,
block|{
literal|"get-vmcs-cr3-targets"
block|,
name|NO_ARG
block|,
operator|&
name|get_cr3_targets
block|,
literal|1
block|}
block|,
block|{
literal|"get-vmcs-apic-access-address"
block|,
name|NO_ARG
block|,
operator|&
name|get_apic_access_addr
block|,
literal|1
block|}
block|,
block|{
literal|"get-vmcs-virtual-apic-address"
block|,
name|NO_ARG
block|,
operator|&
name|get_virtual_apic_addr
block|,
literal|1
block|}
block|,
block|{
literal|"get-vmcs-tpr-threshold"
block|,
name|NO_ARG
block|,
operator|&
name|get_tpr_threshold
block|,
literal|1
block|}
block|,
block|{
literal|"get-vmcs-msr-bitmap"
block|,
name|NO_ARG
block|,
operator|&
name|get_msr_bitmap
block|,
literal|1
block|}
block|,
block|{
literal|"get-vmcs-msr-bitmap-address"
block|,
name|NO_ARG
block|,
operator|&
name|get_msr_bitmap_address
block|,
literal|1
block|}
block|,
block|{
literal|"get-vmcs-vpid"
block|,
name|NO_ARG
block|,
operator|&
name|get_vpid
block|,
literal|1
block|}
block|,
block|{
literal|"get-vmcs-ple-gap"
block|,
name|NO_ARG
block|,
operator|&
name|get_ple_gap
block|,
literal|1
block|}
block|,
block|{
literal|"get-vmcs-ple-window"
block|,
name|NO_ARG
block|,
operator|&
name|get_ple_window
block|,
literal|1
block|}
block|,
block|{
literal|"get-vmcs-instruction-error"
block|,
name|NO_ARG
block|,
operator|&
name|get_inst_err
block|,
literal|1
block|}
block|,
block|{
literal|"get-vmcs-exit-ctls"
block|,
name|NO_ARG
block|,
operator|&
name|get_exit_ctls
block|,
literal|1
block|}
block|,
block|{
literal|"get-vmcs-entry-ctls"
block|,
name|NO_ARG
block|,
operator|&
name|get_entry_ctls
block|,
literal|1
block|}
block|,
block|{
literal|"get-vmcs-guest-pat"
block|,
name|NO_ARG
block|,
operator|&
name|get_guest_pat
block|,
literal|1
block|}
block|,
block|{
literal|"get-vmcs-host-pat"
block|,
name|NO_ARG
block|,
operator|&
name|get_host_pat
block|,
literal|1
block|}
block|,
block|{
literal|"get-vmcs-host-cr0"
block|,
name|NO_ARG
block|,
operator|&
name|get_host_cr0
block|,
literal|1
block|}
block|,
block|{
literal|"get-vmcs-host-cr3"
block|,
name|NO_ARG
block|,
operator|&
name|get_host_cr3
block|,
literal|1
block|}
block|,
block|{
literal|"get-vmcs-host-cr4"
block|,
name|NO_ARG
block|,
operator|&
name|get_host_cr4
block|,
literal|1
block|}
block|,
block|{
literal|"get-vmcs-host-rip"
block|,
name|NO_ARG
block|,
operator|&
name|get_host_rip
block|,
literal|1
block|}
block|,
block|{
literal|"get-vmcs-host-rsp"
block|,
name|NO_ARG
block|,
operator|&
name|get_host_rsp
block|,
literal|1
block|}
block|,
block|{
literal|"get-vmcs-guest-sysenter"
block|,
name|NO_ARG
block|,
operator|&
name|get_guest_sysenter
block|,
literal|1
block|}
block|,
block|{
literal|"get-vmcs-link"
block|,
name|NO_ARG
block|,
operator|&
name|get_vmcs_link
block|,
literal|1
block|}
block|,
block|{
literal|"get-vmcs-exit-reason"
block|,
name|NO_ARG
block|,
operator|&
name|get_vmcs_exit_reason
block|,
literal|1
block|}
block|,
block|{
literal|"get-vmcs-exit-qualification"
block|,
name|NO_ARG
block|,
operator|&
name|get_vmcs_exit_qualification
block|,
literal|1
block|}
block|,
block|{
literal|"get-vmcs-exit-interruption-info"
block|,
name|NO_ARG
block|,
operator|&
name|get_vmcs_exit_interruption_info
block|,
literal|1
block|}
block|,
block|{
literal|"get-vmcs-exit-interruption-error"
block|,
name|NO_ARG
block|,
operator|&
name|get_vmcs_exit_interruption_error
block|,
literal|1
block|}
block|,
block|{
literal|"get-vmcs-interruptibility"
block|,
name|NO_ARG
block|,
operator|&
name|get_vmcs_interruptibility
block|,
literal|1
block|}
block|,
block|{
literal|"get-x2apic-state"
block|,
name|NO_ARG
block|,
operator|&
name|get_x2apic_state
block|,
literal|1
block|}
block|,
block|{
literal|"get-all"
block|,
name|NO_ARG
block|,
operator|&
name|get_all
block|,
literal|1
block|}
block|,
block|{
literal|"run"
block|,
name|NO_ARG
block|,
operator|&
name|run
block|,
literal|1
block|}
block|,
block|{
literal|"create"
block|,
name|NO_ARG
block|,
operator|&
name|create
block|,
literal|1
block|}
block|,
block|{
literal|"destroy"
block|,
name|NO_ARG
block|,
operator|&
name|destroy
block|,
literal|1
block|}
block|,
block|{
literal|"inject-nmi"
block|,
name|NO_ARG
block|,
operator|&
name|inject_nmi
block|,
literal|1
block|}
block|,
block|{
literal|"force-reset"
block|,
name|NO_ARG
block|,
operator|&
name|force_reset
block|,
literal|1
block|}
block|,
block|{
literal|"force-poweroff"
block|,
name|NO_ARG
block|,
operator|&
name|force_poweroff
block|,
literal|1
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|,
name|NULL
block|,
literal|0
block|}
block|}
decl_stmt|;
name|vcpu
operator|=
literal|0
expr_stmt|;
name|assert_lapic_lvt
operator|=
operator|-
literal|1
expr_stmt|;
name|progname
operator|=
name|basename
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|ch
operator|=
name|getopt_long
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|""
argument_list|,
name|opts
argument_list|,
name|NULL
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|0
case|:
break|break;
case|case
name|VMNAME
case|:
name|vmname
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
name|VCPU
case|:
name|vcpu
operator|=
name|atoi
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
name|SET_MEM
case|:
name|memsize
operator|=
name|atoi
argument_list|(
name|optarg
argument_list|)
operator|*
name|MB
expr_stmt|;
name|memsize
operator|=
name|roundup
argument_list|(
name|memsize
argument_list|,
literal|2
operator|*
name|MB
argument_list|)
expr_stmt|;
break|break;
case|case
name|SET_EFER
case|:
name|efer
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|set_efer
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|SET_CR0
case|:
name|cr0
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|set_cr0
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|SET_CR3
case|:
name|cr3
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|set_cr3
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|SET_CR4
case|:
name|cr4
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|set_cr4
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|SET_DR7
case|:
name|dr7
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|set_dr7
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|SET_RSP
case|:
name|rsp
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|set_rsp
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|SET_RIP
case|:
name|rip
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|set_rip
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|SET_RAX
case|:
name|rax
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|set_rax
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|SET_RFLAGS
case|:
name|rflags
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|set_rflags
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|DESC_BASE
case|:
name|desc_base
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|DESC_LIMIT
case|:
name|desc_limit
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|DESC_ACCESS
case|:
name|desc_access
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|SET_CS
case|:
name|cs
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|set_cs
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|SET_DS
case|:
name|ds
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|set_ds
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|SET_ES
case|:
name|es
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|set_es
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|SET_FS
case|:
name|fs
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|set_fs
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|SET_GS
case|:
name|gs
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|set_gs
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|SET_SS
case|:
name|ss
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|set_ss
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|SET_TR
case|:
name|tr
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|set_tr
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|SET_LDTR
case|:
name|ldtr
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|set_ldtr
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|SET_X2APIC_STATE
case|:
name|x2apic_state
operator|=
name|strtol
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|set_x2apic_state
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|SET_VMCS_EXCEPTION_BITMAP
case|:
name|exception_bitmap
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|set_exception_bitmap
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|SET_VMCS_ENTRY_INTERRUPTION_INFO
case|:
name|vmcs_entry_interruption_info
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|set_vmcs_entry_interruption_info
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|SET_CAP
case|:
name|capval
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|setcap
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|GET_GPA_PMAP
case|:
name|gpa_pmap
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|get_gpa_pmap
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CAPNAME
case|:
name|capname
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
name|UNASSIGN_PPTDEV
case|:
name|unassign_pptdev
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|sscanf
argument_list|(
name|optarg
argument_list|,
literal|"%d/%d/%d"
argument_list|,
operator|&
name|bus
argument_list|,
operator|&
name|slot
argument_list|,
operator|&
name|func
argument_list|)
operator|!=
literal|3
condition|)
name|usage
argument_list|()
expr_stmt|;
break|break;
case|case
name|ASSERT_LAPIC_LVT
case|:
name|assert_lapic_lvt
operator|=
name|atoi
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
default|default:
name|usage
argument_list|()
expr_stmt|;
block|}
block|}
name|argc
operator|-=
name|optind
expr_stmt|;
name|argv
operator|+=
name|optind
expr_stmt|;
if|if
condition|(
name|vmname
operator|==
name|NULL
condition|)
name|usage
argument_list|()
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|error
operator|&&
name|create
condition|)
name|error
operator|=
name|vm_create
argument_list|(
name|vmname
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
block|{
name|ctx
operator|=
name|vm_open
argument_list|(
name|vmname
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|==
name|NULL
condition|)
name|error
operator|=
operator|-
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
name|memsize
condition|)
name|error
operator|=
name|vm_setup_memory
argument_list|(
name|ctx
argument_list|,
name|memsize
argument_list|,
name|VM_MMAP_NONE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
operator|&&
name|set_efer
condition|)
name|error
operator|=
name|vm_set_register
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_EFER
argument_list|,
name|efer
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
operator|&&
name|set_cr0
condition|)
name|error
operator|=
name|vm_set_register
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_CR0
argument_list|,
name|cr0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
operator|&&
name|set_cr3
condition|)
name|error
operator|=
name|vm_set_register
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_CR3
argument_list|,
name|cr3
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
operator|&&
name|set_cr4
condition|)
name|error
operator|=
name|vm_set_register
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_CR4
argument_list|,
name|cr4
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
operator|&&
name|set_dr7
condition|)
name|error
operator|=
name|vm_set_register
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_DR7
argument_list|,
name|dr7
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
operator|&&
name|set_rsp
condition|)
name|error
operator|=
name|vm_set_register
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_RSP
argument_list|,
name|rsp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
operator|&&
name|set_rip
condition|)
name|error
operator|=
name|vm_set_register
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_RIP
argument_list|,
name|rip
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
operator|&&
name|set_rax
condition|)
name|error
operator|=
name|vm_set_register
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_RAX
argument_list|,
name|rax
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
operator|&&
name|set_rflags
condition|)
block|{
name|error
operator|=
name|vm_set_register
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_RFLAGS
argument_list|,
name|rflags
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
name|set_desc_ds
condition|)
block|{
name|error
operator|=
name|vm_set_desc
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_DS
argument_list|,
name|desc_base
argument_list|,
name|desc_limit
argument_list|,
name|desc_access
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
name|set_desc_es
condition|)
block|{
name|error
operator|=
name|vm_set_desc
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_ES
argument_list|,
name|desc_base
argument_list|,
name|desc_limit
argument_list|,
name|desc_access
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
name|set_desc_ss
condition|)
block|{
name|error
operator|=
name|vm_set_desc
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_SS
argument_list|,
name|desc_base
argument_list|,
name|desc_limit
argument_list|,
name|desc_access
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
name|set_desc_cs
condition|)
block|{
name|error
operator|=
name|vm_set_desc
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_CS
argument_list|,
name|desc_base
argument_list|,
name|desc_limit
argument_list|,
name|desc_access
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
name|set_desc_fs
condition|)
block|{
name|error
operator|=
name|vm_set_desc
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_FS
argument_list|,
name|desc_base
argument_list|,
name|desc_limit
argument_list|,
name|desc_access
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
name|set_desc_gs
condition|)
block|{
name|error
operator|=
name|vm_set_desc
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_GS
argument_list|,
name|desc_base
argument_list|,
name|desc_limit
argument_list|,
name|desc_access
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
name|set_desc_tr
condition|)
block|{
name|error
operator|=
name|vm_set_desc
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_TR
argument_list|,
name|desc_base
argument_list|,
name|desc_limit
argument_list|,
name|desc_access
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
name|set_desc_ldtr
condition|)
block|{
name|error
operator|=
name|vm_set_desc
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_LDTR
argument_list|,
name|desc_base
argument_list|,
name|desc_limit
argument_list|,
name|desc_access
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
name|set_desc_gdtr
condition|)
block|{
name|error
operator|=
name|vm_set_desc
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_GDTR
argument_list|,
name|desc_base
argument_list|,
name|desc_limit
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
name|set_desc_idtr
condition|)
block|{
name|error
operator|=
name|vm_set_desc
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_IDTR
argument_list|,
name|desc_base
argument_list|,
name|desc_limit
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
name|set_cs
condition|)
name|error
operator|=
name|vm_set_register
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_CS
argument_list|,
name|cs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
operator|&&
name|set_ds
condition|)
name|error
operator|=
name|vm_set_register
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_DS
argument_list|,
name|ds
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
operator|&&
name|set_es
condition|)
name|error
operator|=
name|vm_set_register
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_ES
argument_list|,
name|es
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
operator|&&
name|set_fs
condition|)
name|error
operator|=
name|vm_set_register
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_FS
argument_list|,
name|fs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
operator|&&
name|set_gs
condition|)
name|error
operator|=
name|vm_set_register
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_GS
argument_list|,
name|gs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
operator|&&
name|set_ss
condition|)
name|error
operator|=
name|vm_set_register
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_SS
argument_list|,
name|ss
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
operator|&&
name|set_tr
condition|)
name|error
operator|=
name|vm_set_register
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_TR
argument_list|,
name|tr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
operator|&&
name|set_ldtr
condition|)
name|error
operator|=
name|vm_set_register
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_LDTR
argument_list|,
name|ldtr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
operator|&&
name|set_x2apic_state
condition|)
name|error
operator|=
name|vm_set_x2apic_state
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|x2apic_state
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
operator|&&
name|unassign_pptdev
condition|)
name|error
operator|=
name|vm_unassign_pptdev
argument_list|(
name|ctx
argument_list|,
name|bus
argument_list|,
name|slot
argument_list|,
name|func
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
operator|&&
name|set_exception_bitmap
condition|)
block|{
name|error
operator|=
name|vm_set_vmcs_field
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VMCS_EXCEPTION_BITMAP
argument_list|,
name|exception_bitmap
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
name|set_vmcs_entry_interruption_info
condition|)
block|{
name|error
operator|=
name|vm_set_vmcs_field
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VMCS_ENTRY_INTR_INFO
argument_list|,
name|vmcs_entry_interruption_info
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
name|inject_nmi
condition|)
block|{
name|error
operator|=
name|vm_inject_nmi
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
name|assert_lapic_lvt
operator|!=
operator|-
literal|1
condition|)
block|{
name|error
operator|=
name|vm_lapic_local_irq
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|assert_lapic_lvt
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_lowmem
operator|||
name|get_all
operator|)
condition|)
block|{
name|gpa
operator|=
literal|0
expr_stmt|;
name|error
operator|=
name|vm_get_memory_seg
argument_list|(
name|ctx
argument_list|,
name|gpa
argument_list|,
operator|&
name|len
argument_list|,
operator|&
name|wired
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"lowmem\t\t0x%016lx/%ld%s\n"
argument_list|,
name|gpa
argument_list|,
name|len
argument_list|,
name|wired
condition|?
literal|" wired"
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_highmem
operator|||
name|get_all
operator|)
condition|)
block|{
name|gpa
operator|=
literal|4
operator|*
name|GB
expr_stmt|;
name|error
operator|=
name|vm_get_memory_seg
argument_list|(
name|ctx
argument_list|,
name|gpa
argument_list|,
operator|&
name|len
argument_list|,
operator|&
name|wired
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"highmem\t\t0x%016lx/%ld%s\n"
argument_list|,
name|gpa
argument_list|,
name|len
argument_list|,
name|wired
condition|?
literal|" wired"
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_efer
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_register
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_EFER
argument_list|,
operator|&
name|efer
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"efer[%d]\t\t0x%016lx\n"
argument_list|,
name|vcpu
argument_list|,
name|efer
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_cr0
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_register
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_CR0
argument_list|,
operator|&
name|cr0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"cr0[%d]\t\t0x%016lx\n"
argument_list|,
name|vcpu
argument_list|,
name|cr0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_cr3
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_register
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_CR3
argument_list|,
operator|&
name|cr3
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"cr3[%d]\t\t0x%016lx\n"
argument_list|,
name|vcpu
argument_list|,
name|cr3
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_cr4
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_register
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_CR4
argument_list|,
operator|&
name|cr4
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"cr4[%d]\t\t0x%016lx\n"
argument_list|,
name|vcpu
argument_list|,
name|cr4
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_dr7
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_register
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_DR7
argument_list|,
operator|&
name|dr7
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"dr7[%d]\t\t0x%016lx\n"
argument_list|,
name|vcpu
argument_list|,
name|dr7
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_rsp
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_register
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_RSP
argument_list|,
operator|&
name|rsp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"rsp[%d]\t\t0x%016lx\n"
argument_list|,
name|vcpu
argument_list|,
name|rsp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_rip
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_register
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_RIP
argument_list|,
operator|&
name|rip
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"rip[%d]\t\t0x%016lx\n"
argument_list|,
name|vcpu
argument_list|,
name|rip
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_rax
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_register
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_RAX
argument_list|,
operator|&
name|rax
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"rax[%d]\t\t0x%016lx\n"
argument_list|,
name|vcpu
argument_list|,
name|rax
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_rbx
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_register
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_RBX
argument_list|,
operator|&
name|rbx
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"rbx[%d]\t\t0x%016lx\n"
argument_list|,
name|vcpu
argument_list|,
name|rbx
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_rcx
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_register
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_RCX
argument_list|,
operator|&
name|rcx
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"rcx[%d]\t\t0x%016lx\n"
argument_list|,
name|vcpu
argument_list|,
name|rcx
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_rdx
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_register
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_RDX
argument_list|,
operator|&
name|rdx
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"rdx[%d]\t\t0x%016lx\n"
argument_list|,
name|vcpu
argument_list|,
name|rdx
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_rsi
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_register
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_RSI
argument_list|,
operator|&
name|rsi
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"rsi[%d]\t\t0x%016lx\n"
argument_list|,
name|vcpu
argument_list|,
name|rsi
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_rdi
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_register
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_RDI
argument_list|,
operator|&
name|rdi
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"rdi[%d]\t\t0x%016lx\n"
argument_list|,
name|vcpu
argument_list|,
name|rdi
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_rbp
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_register
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_RBP
argument_list|,
operator|&
name|rbp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"rbp[%d]\t\t0x%016lx\n"
argument_list|,
name|vcpu
argument_list|,
name|rbp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_r8
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_register
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_R8
argument_list|,
operator|&
name|r8
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"r8[%d]\t\t0x%016lx\n"
argument_list|,
name|vcpu
argument_list|,
name|r8
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_r9
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_register
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_R9
argument_list|,
operator|&
name|r9
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"r9[%d]\t\t0x%016lx\n"
argument_list|,
name|vcpu
argument_list|,
name|r9
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_r10
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_register
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_R10
argument_list|,
operator|&
name|r10
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"r10[%d]\t\t0x%016lx\n"
argument_list|,
name|vcpu
argument_list|,
name|r10
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_r11
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_register
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_R11
argument_list|,
operator|&
name|r11
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"r11[%d]\t\t0x%016lx\n"
argument_list|,
name|vcpu
argument_list|,
name|r11
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_r12
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_register
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_R12
argument_list|,
operator|&
name|r12
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"r12[%d]\t\t0x%016lx\n"
argument_list|,
name|vcpu
argument_list|,
name|r12
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_r13
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_register
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_R13
argument_list|,
operator|&
name|r13
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"r13[%d]\t\t0x%016lx\n"
argument_list|,
name|vcpu
argument_list|,
name|r13
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_r14
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_register
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_R14
argument_list|,
operator|&
name|r14
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"r14[%d]\t\t0x%016lx\n"
argument_list|,
name|vcpu
argument_list|,
name|r14
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_r15
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_register
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_R15
argument_list|,
operator|&
name|r15
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"r15[%d]\t\t0x%016lx\n"
argument_list|,
name|vcpu
argument_list|,
name|r15
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_rflags
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_register
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_RFLAGS
argument_list|,
operator|&
name|rflags
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"rflags[%d]\t0x%016lx\n"
argument_list|,
name|vcpu
argument_list|,
name|rflags
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_stats
operator|||
name|get_all
operator|)
condition|)
block|{
name|int
name|i
decl_stmt|,
name|num_stats
decl_stmt|;
name|uint64_t
modifier|*
name|stats
decl_stmt|;
name|struct
name|timeval
name|tv
decl_stmt|;
specifier|const
name|char
modifier|*
name|desc
decl_stmt|;
name|stats
operator|=
name|vm_get_stats
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
operator|&
name|tv
argument_list|,
operator|&
name|num_stats
argument_list|)
expr_stmt|;
if|if
condition|(
name|stats
operator|!=
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"vcpu%d\n"
argument_list|,
name|vcpu
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_stats
condition|;
name|i
operator|++
control|)
block|{
name|desc
operator|=
name|vm_get_stat_desc
argument_list|(
name|ctx
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%-40s\t%ld\n"
argument_list|,
name|desc
argument_list|,
name|stats
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_desc_ds
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_desc
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_DS
argument_list|,
operator|&
name|desc_base
argument_list|,
operator|&
name|desc_limit
argument_list|,
operator|&
name|desc_access
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"ds desc[%d]\t0x%016lx/0x%08x/0x%08x\n"
argument_list|,
name|vcpu
argument_list|,
name|desc_base
argument_list|,
name|desc_limit
argument_list|,
name|desc_access
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_desc_es
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_desc
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_ES
argument_list|,
operator|&
name|desc_base
argument_list|,
operator|&
name|desc_limit
argument_list|,
operator|&
name|desc_access
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"es desc[%d]\t0x%016lx/0x%08x/0x%08x\n"
argument_list|,
name|vcpu
argument_list|,
name|desc_base
argument_list|,
name|desc_limit
argument_list|,
name|desc_access
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_desc_fs
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_desc
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_FS
argument_list|,
operator|&
name|desc_base
argument_list|,
operator|&
name|desc_limit
argument_list|,
operator|&
name|desc_access
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"fs desc[%d]\t0x%016lx/0x%08x/0x%08x\n"
argument_list|,
name|vcpu
argument_list|,
name|desc_base
argument_list|,
name|desc_limit
argument_list|,
name|desc_access
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_desc_gs
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_desc
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_GS
argument_list|,
operator|&
name|desc_base
argument_list|,
operator|&
name|desc_limit
argument_list|,
operator|&
name|desc_access
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"gs desc[%d]\t0x%016lx/0x%08x/0x%08x\n"
argument_list|,
name|vcpu
argument_list|,
name|desc_base
argument_list|,
name|desc_limit
argument_list|,
name|desc_access
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_desc_ss
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_desc
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_SS
argument_list|,
operator|&
name|desc_base
argument_list|,
operator|&
name|desc_limit
argument_list|,
operator|&
name|desc_access
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"ss desc[%d]\t0x%016lx/0x%08x/0x%08x\n"
argument_list|,
name|vcpu
argument_list|,
name|desc_base
argument_list|,
name|desc_limit
argument_list|,
name|desc_access
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_desc_cs
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_desc
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_CS
argument_list|,
operator|&
name|desc_base
argument_list|,
operator|&
name|desc_limit
argument_list|,
operator|&
name|desc_access
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"cs desc[%d]\t0x%016lx/0x%08x/0x%08x\n"
argument_list|,
name|vcpu
argument_list|,
name|desc_base
argument_list|,
name|desc_limit
argument_list|,
name|desc_access
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_desc_tr
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_desc
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_TR
argument_list|,
operator|&
name|desc_base
argument_list|,
operator|&
name|desc_limit
argument_list|,
operator|&
name|desc_access
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"tr desc[%d]\t0x%016lx/0x%08x/0x%08x\n"
argument_list|,
name|vcpu
argument_list|,
name|desc_base
argument_list|,
name|desc_limit
argument_list|,
name|desc_access
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_desc_ldtr
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_desc
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_LDTR
argument_list|,
operator|&
name|desc_base
argument_list|,
operator|&
name|desc_limit
argument_list|,
operator|&
name|desc_access
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"ldtr desc[%d]\t0x%016lx/0x%08x/0x%08x\n"
argument_list|,
name|vcpu
argument_list|,
name|desc_base
argument_list|,
name|desc_limit
argument_list|,
name|desc_access
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_desc_gdtr
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_desc
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_GDTR
argument_list|,
operator|&
name|desc_base
argument_list|,
operator|&
name|desc_limit
argument_list|,
operator|&
name|desc_access
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"gdtr[%d]\t\t0x%016lx/0x%08x\n"
argument_list|,
name|vcpu
argument_list|,
name|desc_base
argument_list|,
name|desc_limit
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_desc_idtr
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_desc
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_IDTR
argument_list|,
operator|&
name|desc_base
argument_list|,
operator|&
name|desc_limit
argument_list|,
operator|&
name|desc_access
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"idtr[%d]\t\t0x%016lx/0x%08x\n"
argument_list|,
name|vcpu
argument_list|,
name|desc_base
argument_list|,
name|desc_limit
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_cs
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_register
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_CS
argument_list|,
operator|&
name|cs
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"cs[%d]\t\t0x%04lx\n"
argument_list|,
name|vcpu
argument_list|,
name|cs
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_ds
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_register
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_DS
argument_list|,
operator|&
name|ds
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"ds[%d]\t\t0x%04lx\n"
argument_list|,
name|vcpu
argument_list|,
name|ds
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_es
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_register
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_ES
argument_list|,
operator|&
name|es
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"es[%d]\t\t0x%04lx\n"
argument_list|,
name|vcpu
argument_list|,
name|es
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_fs
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_register
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_FS
argument_list|,
operator|&
name|fs
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"fs[%d]\t\t0x%04lx\n"
argument_list|,
name|vcpu
argument_list|,
name|fs
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_gs
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_register
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_GS
argument_list|,
operator|&
name|gs
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"gs[%d]\t\t0x%04lx\n"
argument_list|,
name|vcpu
argument_list|,
name|gs
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_ss
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_register
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_SS
argument_list|,
operator|&
name|ss
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"ss[%d]\t\t0x%04lx\n"
argument_list|,
name|vcpu
argument_list|,
name|ss
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_tr
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_register
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_TR
argument_list|,
operator|&
name|tr
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"tr[%d]\t\t0x%04lx\n"
argument_list|,
name|vcpu
argument_list|,
name|tr
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_ldtr
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_register
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_LDTR
argument_list|,
operator|&
name|ldtr
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"ldtr[%d]\t\t0x%04lx\n"
argument_list|,
name|vcpu
argument_list|,
name|ldtr
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_x2apic_state
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_x2apic_state
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
operator|&
name|x2apic_state
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"x2apic_state[%d]\t%d\n"
argument_list|,
name|vcpu
argument_list|,
name|x2apic_state
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_pinbased_ctls
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_vmcs_field
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VMCS_PIN_BASED_CTLS
argument_list|,
operator|&
name|ctl
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"pinbased_ctls[%d]\t0x%08lx\n"
argument_list|,
name|vcpu
argument_list|,
name|ctl
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_procbased_ctls
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_vmcs_field
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VMCS_PRI_PROC_BASED_CTLS
argument_list|,
operator|&
name|ctl
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"procbased_ctls[%d]\t0x%08lx\n"
argument_list|,
name|vcpu
argument_list|,
name|ctl
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_procbased_ctls2
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_vmcs_field
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VMCS_SEC_PROC_BASED_CTLS
argument_list|,
operator|&
name|ctl
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"procbased_ctls2[%d]\t0x%08lx\n"
argument_list|,
name|vcpu
argument_list|,
name|ctl
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_vmcs_gla
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_vmcs_field
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VMCS_GUEST_LINEAR_ADDRESS
argument_list|,
operator|&
name|u64
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"gla[%d]\t\t0x%016lx\n"
argument_list|,
name|vcpu
argument_list|,
name|u64
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_vmcs_gpa
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_vmcs_field
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VMCS_GUEST_PHYSICAL_ADDRESS
argument_list|,
operator|&
name|u64
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"gpa[%d]\t\t0x%016lx\n"
argument_list|,
name|vcpu
argument_list|,
name|u64
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_vmcs_entry_interruption_info
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_vmcs_field
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VMCS_ENTRY_INTR_INFO
argument_list|,
operator|&
name|u64
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"entry_interruption_info[%d]\t0x%08lx\n"
argument_list|,
name|vcpu
argument_list|,
name|u64
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_eptp
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_vmcs_field
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VMCS_EPTP
argument_list|,
operator|&
name|eptp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"eptp[%d]\t\t0x%016lx\n"
argument_list|,
name|vcpu
argument_list|,
name|eptp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_exception_bitmap
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_vmcs_field
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VMCS_EXCEPTION_BITMAP
argument_list|,
operator|&
name|bm
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"exception_bitmap[%d]\t0x%08lx\n"
argument_list|,
name|vcpu
argument_list|,
name|bm
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_io_bitmap
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_vmcs_field
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VMCS_IO_BITMAP_A
argument_list|,
operator|&
name|bm
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"io_bitmap_a[%d]\t0x%08lx\n"
argument_list|,
name|vcpu
argument_list|,
name|bm
argument_list|)
expr_stmt|;
name|error
operator|=
name|vm_get_vmcs_field
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VMCS_IO_BITMAP_B
argument_list|,
operator|&
name|bm
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"io_bitmap_b[%d]\t0x%08lx\n"
argument_list|,
name|vcpu
argument_list|,
name|bm
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_tsc_offset
operator|||
name|get_all
operator|)
condition|)
block|{
name|uint64_t
name|tscoff
decl_stmt|;
name|error
operator|=
name|vm_get_vmcs_field
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VMCS_TSC_OFFSET
argument_list|,
operator|&
name|tscoff
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"tsc_offset[%d]\t0x%016lx\n"
argument_list|,
name|vcpu
argument_list|,
name|tscoff
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_cr0_mask
operator|||
name|get_all
operator|)
condition|)
block|{
name|uint64_t
name|cr0mask
decl_stmt|;
name|error
operator|=
name|vm_get_vmcs_field
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VMCS_CR0_MASK
argument_list|,
operator|&
name|cr0mask
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"cr0_mask[%d]\t\t0x%016lx\n"
argument_list|,
name|vcpu
argument_list|,
name|cr0mask
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_cr0_shadow
operator|||
name|get_all
operator|)
condition|)
block|{
name|uint64_t
name|cr0shadow
decl_stmt|;
name|error
operator|=
name|vm_get_vmcs_field
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VMCS_CR0_SHADOW
argument_list|,
operator|&
name|cr0shadow
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"cr0_shadow[%d]\t\t0x%016lx\n"
argument_list|,
name|vcpu
argument_list|,
name|cr0shadow
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_cr4_mask
operator|||
name|get_all
operator|)
condition|)
block|{
name|uint64_t
name|cr4mask
decl_stmt|;
name|error
operator|=
name|vm_get_vmcs_field
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VMCS_CR4_MASK
argument_list|,
operator|&
name|cr4mask
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"cr4_mask[%d]\t\t0x%016lx\n"
argument_list|,
name|vcpu
argument_list|,
name|cr4mask
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_cr4_shadow
operator|||
name|get_all
operator|)
condition|)
block|{
name|uint64_t
name|cr4shadow
decl_stmt|;
name|error
operator|=
name|vm_get_vmcs_field
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VMCS_CR4_SHADOW
argument_list|,
operator|&
name|cr4shadow
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"cr4_shadow[%d]\t\t0x%016lx\n"
argument_list|,
name|vcpu
argument_list|,
name|cr4shadow
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_cr3_targets
operator|||
name|get_all
operator|)
condition|)
block|{
name|uint64_t
name|target_count
decl_stmt|,
name|target_addr
decl_stmt|;
name|error
operator|=
name|vm_get_vmcs_field
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VMCS_CR3_TARGET_COUNT
argument_list|,
operator|&
name|target_count
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"cr3_target_count[%d]\t0x%08lx\n"
argument_list|,
name|vcpu
argument_list|,
name|target_count
argument_list|)
expr_stmt|;
block|}
name|error
operator|=
name|vm_get_vmcs_field
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VMCS_CR3_TARGET0
argument_list|,
operator|&
name|target_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"cr3_target0[%d]\t\t0x%016lx\n"
argument_list|,
name|vcpu
argument_list|,
name|target_addr
argument_list|)
expr_stmt|;
block|}
name|error
operator|=
name|vm_get_vmcs_field
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VMCS_CR3_TARGET1
argument_list|,
operator|&
name|target_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"cr3_target1[%d]\t\t0x%016lx\n"
argument_list|,
name|vcpu
argument_list|,
name|target_addr
argument_list|)
expr_stmt|;
block|}
name|error
operator|=
name|vm_get_vmcs_field
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VMCS_CR3_TARGET2
argument_list|,
operator|&
name|target_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"cr3_target2[%d]\t\t0x%016lx\n"
argument_list|,
name|vcpu
argument_list|,
name|target_addr
argument_list|)
expr_stmt|;
block|}
name|error
operator|=
name|vm_get_vmcs_field
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VMCS_CR3_TARGET3
argument_list|,
operator|&
name|target_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"cr3_target3[%d]\t\t0x%016lx\n"
argument_list|,
name|vcpu
argument_list|,
name|target_addr
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_apic_access_addr
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_vmcs_field
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VMCS_APIC_ACCESS
argument_list|,
operator|&
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"apic_access_addr[%d]\t0x%016lx\n"
argument_list|,
name|vcpu
argument_list|,
name|addr
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_virtual_apic_addr
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_vmcs_field
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VMCS_VIRTUAL_APIC
argument_list|,
operator|&
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"virtual_apic_addr[%d]\t0x%016lx\n"
argument_list|,
name|vcpu
argument_list|,
name|addr
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_tpr_threshold
operator|||
name|get_all
operator|)
condition|)
block|{
name|uint64_t
name|threshold
decl_stmt|;
name|error
operator|=
name|vm_get_vmcs_field
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VMCS_TPR_THRESHOLD
argument_list|,
operator|&
name|threshold
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"tpr_threshold[%d]\t0x%08lx\n"
argument_list|,
name|vcpu
argument_list|,
name|threshold
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_msr_bitmap_address
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_vmcs_field
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VMCS_MSR_BITMAP
argument_list|,
operator|&
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"msr_bitmap[%d]\t\t0x%016lx\n"
argument_list|,
name|vcpu
argument_list|,
name|addr
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_msr_bitmap
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_vmcs_field
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VMCS_MSR_BITMAP
argument_list|,
operator|&
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|error
operator|=
name|dump_vmcs_msr_bitmap
argument_list|(
name|vcpu
argument_list|,
name|addr
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_vpid
operator|||
name|get_all
operator|)
condition|)
block|{
name|uint64_t
name|vpid
decl_stmt|;
name|error
operator|=
name|vm_get_vmcs_field
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VMCS_VPID
argument_list|,
operator|&
name|vpid
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"vpid[%d]\t\t0x%04lx\n"
argument_list|,
name|vcpu
argument_list|,
name|vpid
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_ple_window
operator|||
name|get_all
operator|)
condition|)
block|{
name|uint64_t
name|window
decl_stmt|;
name|error
operator|=
name|vm_get_vmcs_field
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VMCS_PLE_WINDOW
argument_list|,
operator|&
name|window
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"ple_window[%d]\t\t0x%08lx\n"
argument_list|,
name|vcpu
argument_list|,
name|window
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_ple_gap
operator|||
name|get_all
operator|)
condition|)
block|{
name|uint64_t
name|gap
decl_stmt|;
name|error
operator|=
name|vm_get_vmcs_field
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VMCS_PLE_GAP
argument_list|,
operator|&
name|gap
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"ple_gap[%d]\t\t0x%08lx\n"
argument_list|,
name|vcpu
argument_list|,
name|gap
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_inst_err
operator|||
name|get_all
operator|)
condition|)
block|{
name|uint64_t
name|insterr
decl_stmt|;
name|error
operator|=
name|vm_get_vmcs_field
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VMCS_INSTRUCTION_ERROR
argument_list|,
operator|&
name|insterr
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"instruction_error[%d]\t0x%08lx\n"
argument_list|,
name|vcpu
argument_list|,
name|insterr
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_exit_ctls
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_vmcs_field
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VMCS_EXIT_CTLS
argument_list|,
operator|&
name|ctl
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"exit_ctls[%d]\t\t0x%08lx\n"
argument_list|,
name|vcpu
argument_list|,
name|ctl
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_entry_ctls
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_vmcs_field
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VMCS_ENTRY_CTLS
argument_list|,
operator|&
name|ctl
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"entry_ctls[%d]\t\t0x%08lx\n"
argument_list|,
name|vcpu
argument_list|,
name|ctl
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_host_pat
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_vmcs_field
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VMCS_HOST_IA32_PAT
argument_list|,
operator|&
name|pat
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"host_pat[%d]\t\t0x%016lx\n"
argument_list|,
name|vcpu
argument_list|,
name|pat
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_guest_pat
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_vmcs_field
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VMCS_GUEST_IA32_PAT
argument_list|,
operator|&
name|pat
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"guest_pat[%d]\t\t0x%016lx\n"
argument_list|,
name|vcpu
argument_list|,
name|pat
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_host_cr0
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_vmcs_field
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VMCS_HOST_CR0
argument_list|,
operator|&
name|cr0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"host_cr0[%d]\t\t0x%016lx\n"
argument_list|,
name|vcpu
argument_list|,
name|cr0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_host_cr3
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_vmcs_field
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VMCS_HOST_CR3
argument_list|,
operator|&
name|cr3
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"host_cr3[%d]\t\t0x%016lx\n"
argument_list|,
name|vcpu
argument_list|,
name|cr3
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_host_cr4
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_vmcs_field
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VMCS_HOST_CR4
argument_list|,
operator|&
name|cr4
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"host_cr4[%d]\t\t0x%016lx\n"
argument_list|,
name|vcpu
argument_list|,
name|cr4
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_host_rip
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_vmcs_field
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VMCS_HOST_RIP
argument_list|,
operator|&
name|rip
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"host_rip[%d]\t\t0x%016lx\n"
argument_list|,
name|vcpu
argument_list|,
name|rip
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_host_rsp
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_vmcs_field
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VMCS_HOST_RSP
argument_list|,
operator|&
name|rsp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"host_rsp[%d]\t\t0x%016lx\n"
argument_list|,
name|vcpu
argument_list|,
name|rsp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_guest_sysenter
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_vmcs_field
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VMCS_GUEST_IA32_SYSENTER_CS
argument_list|,
operator|&
name|cs
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"guest_sysenter_cs[%d]\t0x%08lx\n"
argument_list|,
name|vcpu
argument_list|,
name|cs
argument_list|)
expr_stmt|;
name|error
operator|=
name|vm_get_vmcs_field
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VMCS_GUEST_IA32_SYSENTER_ESP
argument_list|,
operator|&
name|rsp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"guest_sysenter_sp[%d]\t0x%016lx\n"
argument_list|,
name|vcpu
argument_list|,
name|rsp
argument_list|)
expr_stmt|;
name|error
operator|=
name|vm_get_vmcs_field
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VMCS_GUEST_IA32_SYSENTER_EIP
argument_list|,
operator|&
name|rip
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"guest_sysenter_ip[%d]\t0x%016lx\n"
argument_list|,
name|vcpu
argument_list|,
name|rip
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_vmcs_link
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_vmcs_field
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VMCS_LINK_POINTER
argument_list|,
operator|&
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"vmcs_pointer[%d]\t0x%016lx\n"
argument_list|,
name|vcpu
argument_list|,
name|addr
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_vmcs_exit_reason
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_vmcs_field
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VMCS_EXIT_REASON
argument_list|,
operator|&
name|u64
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"vmcs_exit_reason[%d]\t0x%016lx\n"
argument_list|,
name|vcpu
argument_list|,
name|u64
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_vmcs_exit_qualification
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_vmcs_field
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VMCS_EXIT_QUALIFICATION
argument_list|,
operator|&
name|u64
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"vmcs_exit_qualification[%d]\t0x%016lx\n"
argument_list|,
name|vcpu
argument_list|,
name|u64
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_vmcs_exit_interruption_info
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_vmcs_field
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VMCS_EXIT_INTR_INFO
argument_list|,
operator|&
name|u64
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"vmcs_exit_interruption_info[%d]\t0x%08lx\n"
argument_list|,
name|vcpu
argument_list|,
name|u64
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_vmcs_exit_interruption_error
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_vmcs_field
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VMCS_EXIT_INTR_ERRCODE
argument_list|,
operator|&
name|u64
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"vmcs_exit_interruption_error[%d]\t0x%08lx\n"
argument_list|,
name|vcpu
argument_list|,
name|u64
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|get_vmcs_interruptibility
operator|||
name|get_all
operator|)
condition|)
block|{
name|error
operator|=
name|vm_get_vmcs_field
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VMCS_GUEST_INTERRUPTIBILITY
argument_list|,
operator|&
name|u64
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"vmcs_guest_interruptibility[%d]\t0x%08lx\n"
argument_list|,
name|vcpu
argument_list|,
name|u64
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|error
operator|&&
name|setcap
condition|)
block|{
name|int
name|captype
decl_stmt|;
name|captype
operator|=
name|vm_capability_name2type
argument_list|(
name|capname
argument_list|)
expr_stmt|;
name|error
operator|=
name|vm_set_capability
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|captype
argument_list|,
name|capval
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
operator|&&
name|errno
operator|==
name|ENOENT
condition|)
name|printf
argument_list|(
literal|"Capability \"%s\" is not available\n"
argument_list|,
name|capname
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
name|get_gpa_pmap
condition|)
block|{
name|error
operator|=
name|vm_get_gpa_pmap
argument_list|(
name|ctx
argument_list|,
name|gpa_pmap
argument_list|,
name|pteval
argument_list|,
operator|&
name|ptenum
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"gpa %#lx:"
argument_list|,
name|gpa_pmap
argument_list|)
expr_stmt|;
name|pte
operator|=
operator|&
name|pteval
index|[
literal|0
index|]
expr_stmt|;
while|while
condition|(
name|ptenum
operator|--
operator|>
literal|0
condition|)
name|printf
argument_list|(
literal|" %#lx"
argument_list|,
operator|*
name|pte
operator|++
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|error
operator|&&
operator|(
name|getcap
operator|||
name|get_all
operator|)
condition|)
block|{
name|int
name|captype
decl_stmt|,
name|val
decl_stmt|,
name|getcaptype
decl_stmt|;
if|if
condition|(
name|getcap
operator|&&
name|capname
condition|)
name|getcaptype
operator|=
name|vm_capability_name2type
argument_list|(
name|capname
argument_list|)
expr_stmt|;
else|else
name|getcaptype
operator|=
operator|-
literal|1
expr_stmt|;
for|for
control|(
name|captype
operator|=
literal|0
init|;
name|captype
operator|<
name|VM_CAP_MAX
condition|;
name|captype
operator|++
control|)
block|{
if|if
condition|(
name|getcaptype
operator|>=
literal|0
operator|&&
name|captype
operator|!=
name|getcaptype
condition|)
continue|continue;
name|error
operator|=
name|vm_get_capability
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|captype
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Capability \"%s\" is %s on vcpu %d\n"
argument_list|,
name|vm_capability_type2name
argument_list|(
name|captype
argument_list|)
argument_list|,
name|val
condition|?
literal|"set"
else|:
literal|"not set"
argument_list|,
name|vcpu
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|errno
operator|==
name|ENOENT
condition|)
block|{
name|error
operator|=
literal|0
expr_stmt|;
name|printf
argument_list|(
literal|"Capability \"%s\" is not available\n"
argument_list|,
name|vm_capability_type2name
argument_list|(
name|captype
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
break|break;
block|}
block|}
block|}
if|if
condition|(
operator|!
name|error
operator|&&
name|run
condition|)
block|{
name|error
operator|=
name|vm_get_register
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|VM_REG_GUEST_RIP
argument_list|,
operator|&
name|rip
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|error
operator|==
literal|0
argument_list|)
expr_stmt|;
name|error
operator|=
name|vm_run
argument_list|(
name|ctx
argument_list|,
name|vcpu
argument_list|,
name|rip
argument_list|,
operator|&
name|vmexit
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|dump_vm_run_exitcode
argument_list|(
operator|&
name|vmexit
argument_list|,
name|vcpu
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"vm_run error %d\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
name|force_reset
condition|)
name|error
operator|=
name|vm_suspend
argument_list|(
name|ctx
argument_list|,
name|VM_SUSPEND_RESET
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
operator|&&
name|force_poweroff
condition|)
name|error
operator|=
name|vm_suspend
argument_list|(
name|ctx
argument_list|,
name|VM_SUSPEND_POWEROFF
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
name|printf
argument_list|(
literal|"errno = %d\n"
argument_list|,
name|errno
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
operator|&&
name|destroy
condition|)
name|vm_destroy
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|error
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


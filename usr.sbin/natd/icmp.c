begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_systm.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip_icmp.h>
end_include

begin_include
include|#
directive|include
file|<machine/in_cksum.h>
end_include

begin_include
include|#
directive|include
file|<alias.h>
end_include

begin_include
include|#
directive|include
file|"natd.h"
end_include

begin_function
name|int
name|SendNeedFragIcmp
parameter_list|(
name|int
name|sock
parameter_list|,
name|struct
name|ip
modifier|*
name|failedDgram
parameter_list|,
name|int
name|mtu
parameter_list|)
block|{
name|char
name|icmpBuf
index|[
name|IP_MAXPACKET
index|]
decl_stmt|;
name|struct
name|ip
modifier|*
name|ip
decl_stmt|;
name|struct
name|icmp
modifier|*
name|icmp
decl_stmt|;
name|int
name|icmpLen
decl_stmt|;
name|int
name|failBytes
decl_stmt|;
name|int
name|failHdrLen
decl_stmt|;
name|struct
name|sockaddr_in
name|addr
decl_stmt|;
name|int
name|wrote
decl_stmt|;
name|struct
name|in_addr
name|swap
decl_stmt|;
comment|/*  * Don't send error if packet is  * not the first fragment.  */
if|if
condition|(
name|ntohs
argument_list|(
name|failedDgram
operator|->
name|ip_off
argument_list|)
operator|&
operator|~
operator|(
name|IP_MF
operator||
name|IP_DF
operator|)
condition|)
return|return
literal|0
return|;
comment|/*  * Dont respond if failed datagram is ICMP.  */
if|if
condition|(
name|failedDgram
operator|->
name|ip_p
operator|==
name|IPPROTO_ICMP
condition|)
return|return
literal|0
return|;
comment|/*  * Start building the message.  */
name|ip
operator|=
operator|(
expr|struct
name|ip
operator|*
operator|)
name|icmpBuf
expr_stmt|;
name|icmp
operator|=
operator|(
expr|struct
name|icmp
operator|*
operator|)
operator|(
name|icmpBuf
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|ip
argument_list|)
operator|)
expr_stmt|;
comment|/*  * Complete ICMP part.  */
name|icmp
operator|->
name|icmp_type
operator|=
name|ICMP_UNREACH
expr_stmt|;
name|icmp
operator|->
name|icmp_code
operator|=
name|ICMP_UNREACH_NEEDFRAG
expr_stmt|;
name|icmp
operator|->
name|icmp_cksum
operator|=
literal|0
expr_stmt|;
name|icmp
operator|->
name|icmp_void
operator|=
literal|0
expr_stmt|;
name|icmp
operator|->
name|icmp_nextmtu
operator|=
name|htons
argument_list|(
name|mtu
argument_list|)
expr_stmt|;
comment|/*  * Copy header + 64 bits of original datagram.  */
name|failHdrLen
operator|=
operator|(
name|failedDgram
operator|->
name|ip_hl
operator|<<
literal|2
operator|)
expr_stmt|;
name|failBytes
operator|=
name|failedDgram
operator|->
name|ip_len
operator|-
name|failHdrLen
expr_stmt|;
if|if
condition|(
name|failBytes
operator|>
literal|8
condition|)
name|failBytes
operator|=
literal|8
expr_stmt|;
name|failBytes
operator|+=
name|failHdrLen
expr_stmt|;
name|icmpLen
operator|=
name|ICMP_MINLEN
operator|+
name|failBytes
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|icmp
operator|->
name|icmp_ip
argument_list|,
name|failedDgram
argument_list|,
name|failBytes
argument_list|)
expr_stmt|;
comment|/*  * Calculate checksum.  */
name|icmp
operator|->
name|icmp_cksum
operator|=
name|InternetChecksum
argument_list|(
operator|(
name|u_short
operator|*
operator|)
name|icmp
argument_list|,
name|icmpLen
argument_list|)
expr_stmt|;
comment|/*  * Add IP header using old IP header as template.  */
name|memcpy
argument_list|(
name|ip
argument_list|,
name|failedDgram
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ip
argument_list|)
argument_list|)
expr_stmt|;
name|ip
operator|->
name|ip_v
operator|=
literal|4
expr_stmt|;
name|ip
operator|->
name|ip_hl
operator|=
literal|5
expr_stmt|;
name|ip
operator|->
name|ip_len
operator|=
name|htons
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|ip
argument_list|)
operator|+
name|icmpLen
argument_list|)
expr_stmt|;
name|ip
operator|->
name|ip_p
operator|=
name|IPPROTO_ICMP
expr_stmt|;
name|ip
operator|->
name|ip_tos
operator|=
literal|0
expr_stmt|;
name|swap
operator|=
name|ip
operator|->
name|ip_dst
expr_stmt|;
name|ip
operator|->
name|ip_dst
operator|=
name|ip
operator|->
name|ip_src
expr_stmt|;
name|ip
operator|->
name|ip_src
operator|=
name|swap
expr_stmt|;
name|PacketAliasIn
argument_list|(
operator|(
name|char
operator|*
operator|)
name|ip
argument_list|,
name|IP_MAXPACKET
argument_list|)
expr_stmt|;
name|addr
operator|.
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|addr
operator|.
name|sin_addr
operator|=
name|ip
operator|->
name|ip_dst
expr_stmt|;
name|addr
operator|.
name|sin_port
operator|=
literal|0
expr_stmt|;
comment|/*  * Put packet into processing queue.  */
name|wrote
operator|=
name|sendto
argument_list|(
name|sock
argument_list|,
name|icmp
argument_list|,
name|icmpLen
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|addr
argument_list|,
sizeof|sizeof
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|wrote
operator|!=
name|icmpLen
condition|)
name|Warn
argument_list|(
literal|"Cannot send ICMP message."
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

end_unit


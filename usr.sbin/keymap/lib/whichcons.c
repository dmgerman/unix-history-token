begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Contributed to 386bsd 0.1 and later versions  *  *	Copyright 1992 by Holger Veit  *	May be freely used with Bill Jolitz's port of   *	386bsd and may be included in a 386bsd collection  *	as long as binary and source are available and reproduce the above  *	copyright.  *  *	You may freely modify this code and contribute improvements based  *	on this code as long as you don't claim to be the original author.  *	Commercial use of this source requires permittance of the copyright   *	holder. A general license for 386bsd will override this restriction.  *  *	Use at your own risk. The copyright holder or any person who makes  *	this code available for the public (administrators of public archives  *	for instance) are not responsible for any harm to hardware or software  *	that might happen due to wrong application or program faults.  *  * You must have the codrv-0.1.1 or later driver in the same package   * generated into the 386bsd kernel, otherwise this program does not work.  *  *	@(#)whichcons.c	1.0 (386bsd contribution) 01/10/93  */
end_comment

begin_include
include|#
directive|include
file|"pathnames.h"
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_define
define|#
directive|define
name|COMPAT_CO011
end_define

begin_define
define|#
directive|define
name|COMPAT_PCCONS
end_define

begin_include
include|#
directive|include
file|<sys/ioctl_pc.h>
end_include

begin_comment
comment|/*  *  find out, which console driver is there  *  *  returns:  *	-1:	error  *	0:	unknown  *	1:	pccons.c  *	2:	pccons with X support  *	3:	codrv-0.1.1  *	4:	codrv-0.1.2 or later  *	5:	Rich's version (hopefully)  */
end_comment

begin_define
define|#
directive|define
name|UNKNOWN
value|0
end_define

begin_define
define|#
directive|define
name|PCCONS
value|1
end_define

begin_define
define|#
directive|define
name|PCCONSX
value|2
end_define

begin_define
define|#
directive|define
name|CODRV011
value|3
end_define

begin_define
define|#
directive|define
name|CODRV01X
value|4
end_define

begin_define
define|#
directive|define
name|PCCONSR
value|5
end_define

begin_function
name|int
name|whichcons
parameter_list|()
block|{
name|int
name|fd
decl_stmt|;
name|struct
name|consinfo
name|ci
decl_stmt|;
name|struct
name|oldconsinfo
name|oci
decl_stmt|;
name|unsigned
name|long
modifier|*
name|ip
decl_stmt|;
name|fd
operator|=
name|open
argument_list|(
name|_PATH_KEYBOARD
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|<
literal|0
condition|)
block|{
comment|/* no /dev/kbd, can be pccons with or without X */
name|fd
operator|=
name|open
argument_list|(
name|_PATH_CONSOLE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|<
literal|0
condition|)
return|return
name|UNKNOWN
return|;
block|}
name|ip
operator|=
literal|0
expr_stmt|;
comment|/* try to get console info structure */
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|CONSGINFO
argument_list|,
operator|&
name|ci
argument_list|)
operator|>=
literal|0
condition|)
name|ip
operator|=
operator|&
name|ci
operator|.
name|info1
expr_stmt|;
elseif|else
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|OLDCONSGINFO
argument_list|,
operator|&
name|oci
argument_list|)
operator|>=
literal|0
condition|)
name|ip
operator|=
operator|&
name|oci
operator|.
name|info1
expr_stmt|;
if|if
condition|(
name|ip
condition|)
block|{
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
comment|/* good, this can be a new driver */
if|if
condition|(
operator|*
name|ip
operator|&
name|CONS_ISPC
condition|)
return|return
operator|(
operator|*
name|ip
operator|&
name|CONS_HASOX386
operator|)
condition|?
name|PCCONSX
else|:
name|PCCONSR
return|;
elseif|else
if|if
condition|(
operator|*
name|ip
operator|&
name|CONS_ISCO
condition|)
return|return
operator|(
operator|*
name|ip
operator|&
name|CONS_CODRV2
operator|)
condition|?
name|CODRV01X
else|:
name|CODRV011
return|;
else|else
comment|/* who dared to use these fields */
return|return
name|UNKNOWN
return|;
block|}
comment|/* check whether console X MODE exists */
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|CONSOLE_X_MODE_OFF
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
block|{
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
name|PCCONS
return|;
block|}
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
name|PCCONSX
return|;
block|}
end_function

end_unit


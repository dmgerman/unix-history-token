begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * search.c  *  * Copyright (c) 2001-2003 Maksim Yevmenkin<m_evmenkin@yahoo.com>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $Id: search.c,v 1.2 2003/09/08 17:35:15 max Exp $  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<bluetooth.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<sdp.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|"sdpcontrol.h"
end_include

begin_comment
comment|/* List of the attributes we are looking for */
end_comment

begin_decl_stmt
specifier|static
name|uint32_t
name|attrs
index|[]
init|=
block|{
name|SDP_ATTR_RANGE
argument_list|(
name|SDP_ATTR_SERVICE_RECORD_HANDLE
argument_list|,
name|SDP_ATTR_SERVICE_RECORD_HANDLE
argument_list|)
block|,
name|SDP_ATTR_RANGE
argument_list|(
name|SDP_ATTR_SERVICE_CLASS_ID_LIST
argument_list|,
name|SDP_ATTR_SERVICE_CLASS_ID_LIST
argument_list|)
block|,
name|SDP_ATTR_RANGE
argument_list|(
name|SDP_ATTR_PROTOCOL_DESCRIPTOR_LIST
argument_list|,
name|SDP_ATTR_PROTOCOL_DESCRIPTOR_LIST
argument_list|)
block|,
name|SDP_ATTR_RANGE
argument_list|(
argument|SDP_ATTR_BLUETOOTH_PROFILE_DESCRIPTOR_LIST
argument_list|,
argument|SDP_ATTR_BLUETOOTH_PROFILE_DESCRIPTOR_LIST
argument_list|)
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|attrs_len
value|(sizeof(attrs)/sizeof(attrs[0]))
end_define

begin_comment
comment|/* Buffer for the attributes */
end_comment

begin_define
define|#
directive|define
name|NRECS
value|25
end_define

begin_comment
comment|/* request this much records from the SDP server */
end_comment

begin_define
define|#
directive|define
name|BSIZE
value|256
end_define

begin_comment
comment|/* one attribute buffer size */
end_comment

begin_decl_stmt
specifier|static
name|uint8_t
name|buffer
index|[
name|NRECS
operator|*
name|attrs_len
index|]
index|[
name|BSIZE
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* SDP attributes */
end_comment

begin_decl_stmt
specifier|static
name|sdp_attr_t
name|values
index|[
name|NRECS
operator|*
name|attrs_len
index|]
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|values_len
value|(sizeof(values)/sizeof(values[0]))
end_define

begin_comment
comment|/*  * Print Service Class ID List  *  * The ServiceClassIDList attribute consists of a data element sequence in   * which each data element is a UUID representing the service classes that  * a given service record conforms to. The UUIDs are listed in order from   * the most specific class to the most general class. The ServiceClassIDList  * must contain at least one service class UUID.  */
end_comment

begin_function
specifier|static
name|void
name|print_service_class_id_list
parameter_list|(
name|uint8_t
specifier|const
modifier|*
name|start
parameter_list|,
name|uint8_t
specifier|const
modifier|*
name|end
parameter_list|)
block|{
name|uint32_t
name|type
decl_stmt|,
name|len
decl_stmt|,
name|value
decl_stmt|;
if|if
condition|(
name|end
operator|-
name|start
operator|<
literal|2
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Invalid Service Class ID List. "
expr|\
literal|"Too short, len=%d\n"
argument_list|,
name|end
operator|-
name|start
argument_list|)
expr_stmt|;
return|return;
block|}
name|SDP_GET8
argument_list|(
name|type
argument_list|,
name|start
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|SDP_DATA_SEQ8
case|:
name|SDP_GET8
argument_list|(
name|len
argument_list|,
name|start
argument_list|)
expr_stmt|;
break|break;
case|case
name|SDP_DATA_SEQ16
case|:
name|SDP_GET16
argument_list|(
name|len
argument_list|,
name|start
argument_list|)
expr_stmt|;
break|break;
case|case
name|SDP_DATA_SEQ32
case|:
name|SDP_GET32
argument_list|(
name|len
argument_list|,
name|start
argument_list|)
expr_stmt|;
break|break;
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Invalid Service Class ID List. "
expr|\
literal|"Not a sequence, type=%#x\n"
argument_list|,
name|type
argument_list|)
expr_stmt|;
return|return;
comment|/* NOT REACHED */
block|}
while|while
condition|(
name|start
operator|<
name|end
condition|)
block|{
name|SDP_GET8
argument_list|(
name|type
argument_list|,
name|start
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|SDP_DATA_UUID16
case|:
name|SDP_GET16
argument_list|(
name|value
argument_list|,
name|start
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"\t%s (%#4.4x)\n"
argument_list|,
name|sdp_uuid2desc
argument_list|(
name|value
argument_list|)
argument_list|,
name|value
argument_list|)
expr_stmt|;
break|break;
case|case
name|SDP_DATA_UUID32
case|:
name|SDP_GET32
argument_list|(
name|value
argument_list|,
name|start
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"\t%#8.8x\n"
argument_list|,
name|value
argument_list|)
expr_stmt|;
break|break;
case|case
name|SDP_DATA_UUID128
case|:
block|{
name|int128_t
name|uuid
decl_stmt|;
name|SDP_GET128
argument_list|(
operator|&
name|uuid
argument_list|,
name|start
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"\t%#8.8x-%4.4x-%4.4x-%4.4x-%4.4x%8.8x\n"
argument_list|,
operator|*
operator|(
name|uint32_t
operator|*
operator|)
operator|&
name|uuid
operator|.
name|b
index|[
literal|0
index|]
argument_list|,
operator|*
operator|(
name|uint16_t
operator|*
operator|)
operator|&
name|uuid
operator|.
name|b
index|[
literal|4
index|]
argument_list|,
operator|*
operator|(
name|uint16_t
operator|*
operator|)
operator|&
name|uuid
operator|.
name|b
index|[
literal|6
index|]
argument_list|,
operator|*
operator|(
name|uint16_t
operator|*
operator|)
operator|&
name|uuid
operator|.
name|b
index|[
literal|8
index|]
argument_list|,
operator|*
operator|(
name|uint16_t
operator|*
operator|)
operator|&
name|uuid
operator|.
name|b
index|[
literal|10
index|]
argument_list|,
operator|*
operator|(
name|uint32_t
operator|*
operator|)
operator|&
name|uuid
operator|.
name|b
index|[
literal|12
index|]
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Invalid Service Class ID List. "
expr|\
literal|"Not a UUID, type=%#x\n"
argument_list|,
name|type
argument_list|)
expr_stmt|;
return|return;
comment|/* NOT REACHED */
block|}
block|}
block|}
end_function

begin_comment
comment|/* print_service_class_id_list */
end_comment

begin_comment
comment|/*  * Print Protocol Descriptor List  *  * If the ProtocolDescriptorList describes a single stack, it takes the form   * of a data element sequence in which each element of the sequence is a   * protocol descriptor. Each protocol descriptor is, in turn, a data element   * sequence whose first element is a UUID identifying the protocol and whose   * successive elements are protocol-specific parameters. The protocol   * descriptors are listed in order from the lowest layer protocol to the   * highest layer protocol used to gain access to the service. If it is possible  * for more than one kind of protocol stack to be used to gain access to the   * service, the ProtocolDescriptorList takes the form of a data element   * alternative where each member is a data element sequence as described above.  */
end_comment

begin_function
specifier|static
name|void
name|print_protocol_descriptor
parameter_list|(
name|uint8_t
specifier|const
modifier|*
name|start
parameter_list|,
name|uint8_t
specifier|const
modifier|*
name|end
parameter_list|)
block|{
union|union
block|{
name|uint8_t
name|uint8
decl_stmt|;
name|uint16_t
name|uint16
decl_stmt|;
name|uint32_t
name|uint32
decl_stmt|;
name|uint64_t
name|uint64
decl_stmt|;
name|int128_t
name|int128
decl_stmt|;
block|}
name|value
union|;
name|uint32_t
name|type
decl_stmt|,
name|len
decl_stmt|,
name|param
decl_stmt|;
comment|/* Get Protocol UUID */
name|SDP_GET8
argument_list|(
name|type
argument_list|,
name|start
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|SDP_DATA_UUID16
case|:
name|SDP_GET16
argument_list|(
name|value
operator|.
name|uint16
argument_list|,
name|start
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"\t%s (%#4.4x)\n"
argument_list|,
name|sdp_uuid2desc
argument_list|(
name|value
operator|.
name|uint16
argument_list|)
argument_list|,
name|value
operator|.
name|uint16
argument_list|)
expr_stmt|;
break|break;
case|case
name|SDP_DATA_UUID32
case|:
name|SDP_GET32
argument_list|(
name|value
operator|.
name|uint32
argument_list|,
name|start
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"\t%#8.8x\n"
argument_list|,
name|value
operator|.
name|uint32
argument_list|)
expr_stmt|;
break|break;
case|case
name|SDP_DATA_UUID128
case|:
name|SDP_GET128
argument_list|(
operator|&
name|value
operator|.
name|int128
argument_list|,
name|start
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"\t%#8.8x-%4.4x-%4.4x-%4.4x-%4.4x%8.8x\n"
argument_list|,
operator|*
operator|(
name|uint32_t
operator|*
operator|)
operator|&
name|value
operator|.
name|int128
operator|.
name|b
index|[
literal|0
index|]
argument_list|,
operator|*
operator|(
name|uint16_t
operator|*
operator|)
operator|&
name|value
operator|.
name|int128
operator|.
name|b
index|[
literal|4
index|]
argument_list|,
operator|*
operator|(
name|uint16_t
operator|*
operator|)
operator|&
name|value
operator|.
name|int128
operator|.
name|b
index|[
literal|6
index|]
argument_list|,
operator|*
operator|(
name|uint16_t
operator|*
operator|)
operator|&
name|value
operator|.
name|int128
operator|.
name|b
index|[
literal|8
index|]
argument_list|,
operator|*
operator|(
name|uint16_t
operator|*
operator|)
operator|&
name|value
operator|.
name|int128
operator|.
name|b
index|[
literal|10
index|]
argument_list|,
operator|*
operator|(
name|uint32_t
operator|*
operator|)
operator|&
name|value
operator|.
name|int128
operator|.
name|b
index|[
literal|12
index|]
argument_list|)
expr_stmt|;
break|break;
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Invalid Protocol Descriptor. "
expr|\
literal|"Not a UUID, type=%#x\n"
argument_list|,
name|type
argument_list|)
expr_stmt|;
return|return;
comment|/* NOT REACHED */
block|}
comment|/* Protocol specific parameters */
for|for
control|(
name|param
operator|=
literal|1
init|;
name|start
operator|<
name|end
condition|;
name|param
operator|++
control|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"\t\tProtocol specific parameter #%d: "
argument_list|,
name|param
argument_list|)
expr_stmt|;
name|SDP_GET8
argument_list|(
name|type
argument_list|,
name|start
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|SDP_DATA_NIL
case|:
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"nil\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|SDP_DATA_UINT8
case|:
case|case
name|SDP_DATA_INT8
case|:
case|case
name|SDP_DATA_BOOL
case|:
name|SDP_GET8
argument_list|(
name|value
operator|.
name|uint8
argument_list|,
name|start
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"u/int8/bool %u\n"
argument_list|,
name|value
operator|.
name|uint8
argument_list|)
expr_stmt|;
break|break;
case|case
name|SDP_DATA_UINT16
case|:
case|case
name|SDP_DATA_INT16
case|:
case|case
name|SDP_DATA_UUID16
case|:
name|SDP_GET16
argument_list|(
name|value
operator|.
name|uint16
argument_list|,
name|start
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"u/int/uuid16 %u\n"
argument_list|,
name|value
operator|.
name|uint16
argument_list|)
expr_stmt|;
break|break;
case|case
name|SDP_DATA_UINT32
case|:
case|case
name|SDP_DATA_INT32
case|:
case|case
name|SDP_DATA_UUID32
case|:
name|SDP_GET32
argument_list|(
name|value
operator|.
name|uint32
argument_list|,
name|start
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"u/int/uuid32 %u\n"
argument_list|,
name|value
operator|.
name|uint32
argument_list|)
expr_stmt|;
break|break;
case|case
name|SDP_DATA_UINT64
case|:
case|case
name|SDP_DATA_INT64
case|:
name|SDP_GET64
argument_list|(
name|value
operator|.
name|uint64
argument_list|,
name|start
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"u/int64 %llu\n"
argument_list|,
name|value
operator|.
name|uint64
argument_list|)
expr_stmt|;
break|break;
case|case
name|SDP_DATA_UINT128
case|:
case|case
name|SDP_DATA_INT128
case|:
case|case
name|SDP_DATA_UUID128
case|:
name|SDP_GET128
argument_list|(
operator|&
name|value
operator|.
name|int128
argument_list|,
name|start
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"u/int/uuid128 %#8.8x-%4.4x-%4.4x-%4.4x-%4.4x%8.8x\n"
argument_list|,
operator|*
operator|(
name|uint32_t
operator|*
operator|)
operator|&
name|value
operator|.
name|int128
operator|.
name|b
index|[
literal|0
index|]
argument_list|,
operator|*
operator|(
name|uint16_t
operator|*
operator|)
operator|&
name|value
operator|.
name|int128
operator|.
name|b
index|[
literal|4
index|]
argument_list|,
operator|*
operator|(
name|uint16_t
operator|*
operator|)
operator|&
name|value
operator|.
name|int128
operator|.
name|b
index|[
literal|6
index|]
argument_list|,
operator|*
operator|(
name|uint16_t
operator|*
operator|)
operator|&
name|value
operator|.
name|int128
operator|.
name|b
index|[
literal|8
index|]
argument_list|,
operator|*
operator|(
name|uint16_t
operator|*
operator|)
operator|&
name|value
operator|.
name|int128
operator|.
name|b
index|[
literal|10
index|]
argument_list|,
operator|*
operator|(
name|uint32_t
operator|*
operator|)
operator|&
name|value
operator|.
name|int128
operator|.
name|b
index|[
literal|12
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|SDP_DATA_STR8
case|:
case|case
name|SDP_DATA_URL8
case|:
name|SDP_GET8
argument_list|(
name|len
argument_list|,
name|start
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"%*.*s\n"
argument_list|,
name|len
argument_list|,
name|len
argument_list|,
operator|(
name|char
operator|*
operator|)
name|start
argument_list|)
expr_stmt|;
name|start
operator|+=
name|len
expr_stmt|;
break|break;
case|case
name|SDP_DATA_STR16
case|:
case|case
name|SDP_DATA_URL16
case|:
name|SDP_GET16
argument_list|(
name|len
argument_list|,
name|start
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"%*.*s\n"
argument_list|,
name|len
argument_list|,
name|len
argument_list|,
operator|(
name|char
operator|*
operator|)
name|start
argument_list|)
expr_stmt|;
name|start
operator|+=
name|len
expr_stmt|;
break|break;
case|case
name|SDP_DATA_STR32
case|:
case|case
name|SDP_DATA_URL32
case|:
name|SDP_GET32
argument_list|(
name|len
argument_list|,
name|start
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"%*.*s\n"
argument_list|,
name|len
argument_list|,
name|len
argument_list|,
operator|(
name|char
operator|*
operator|)
name|start
argument_list|)
expr_stmt|;
name|start
operator|+=
name|len
expr_stmt|;
break|break;
case|case
name|SDP_DATA_SEQ8
case|:
case|case
name|SDP_DATA_ALT8
case|:
name|SDP_GET8
argument_list|(
name|len
argument_list|,
name|start
argument_list|)
expr_stmt|;
for|for
control|(
init|;
name|len
operator|>
literal|0
condition|;
name|start
operator|++
operator|,
name|len
operator|--
control|)
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"%#2.2x "
argument_list|,
operator|*
name|start
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|SDP_DATA_SEQ16
case|:
case|case
name|SDP_DATA_ALT16
case|:
name|SDP_GET16
argument_list|(
name|len
argument_list|,
name|start
argument_list|)
expr_stmt|;
for|for
control|(
init|;
name|len
operator|>
literal|0
condition|;
name|start
operator|++
operator|,
name|len
operator|--
control|)
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"%#2.2x "
argument_list|,
operator|*
name|start
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|SDP_DATA_SEQ32
case|:
case|case
name|SDP_DATA_ALT32
case|:
name|SDP_GET32
argument_list|(
name|len
argument_list|,
name|start
argument_list|)
expr_stmt|;
for|for
control|(
init|;
name|len
operator|>
literal|0
condition|;
name|start
operator|++
operator|,
name|len
operator|--
control|)
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"%#2.2x "
argument_list|,
operator|*
name|start
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Invalid Protocol Descriptor. "
expr|\
literal|"Unknown data type: %#02x\n"
argument_list|,
name|type
argument_list|)
expr_stmt|;
return|return;
comment|/* NOT REACHED */
block|}
block|}
block|}
end_function

begin_comment
comment|/* print_protocol_descriptor */
end_comment

begin_function
specifier|static
name|void
name|print_protocol_descriptor_list
parameter_list|(
name|uint8_t
specifier|const
modifier|*
name|start
parameter_list|,
name|uint8_t
specifier|const
modifier|*
name|end
parameter_list|)
block|{
name|uint32_t
name|type
decl_stmt|,
name|len
decl_stmt|;
if|if
condition|(
name|end
operator|-
name|start
operator|<
literal|2
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Invalid Protocol Descriptor List. "
expr|\
literal|"Too short, len=%d\n"
argument_list|,
name|end
operator|-
name|start
argument_list|)
expr_stmt|;
return|return;
block|}
name|SDP_GET8
argument_list|(
name|type
argument_list|,
name|start
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|SDP_DATA_SEQ8
case|:
name|SDP_GET8
argument_list|(
name|len
argument_list|,
name|start
argument_list|)
expr_stmt|;
break|break;
case|case
name|SDP_DATA_SEQ16
case|:
name|SDP_GET16
argument_list|(
name|len
argument_list|,
name|start
argument_list|)
expr_stmt|;
break|break;
case|case
name|SDP_DATA_SEQ32
case|:
name|SDP_GET32
argument_list|(
name|len
argument_list|,
name|start
argument_list|)
expr_stmt|;
break|break;
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Invalid Protocol Descriptor List. "
expr|\
literal|"Not a sequence, type=%#x\n"
argument_list|,
name|type
argument_list|)
expr_stmt|;
return|return;
comment|/* NOT REACHED */
block|}
while|while
condition|(
name|start
operator|<
name|end
condition|)
block|{
name|SDP_GET8
argument_list|(
name|type
argument_list|,
name|start
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|SDP_DATA_SEQ8
case|:
name|SDP_GET8
argument_list|(
name|len
argument_list|,
name|start
argument_list|)
expr_stmt|;
break|break;
case|case
name|SDP_DATA_SEQ16
case|:
name|SDP_GET16
argument_list|(
name|len
argument_list|,
name|start
argument_list|)
expr_stmt|;
break|break;
case|case
name|SDP_DATA_SEQ32
case|:
name|SDP_GET32
argument_list|(
name|len
argument_list|,
name|start
argument_list|)
expr_stmt|;
break|break;
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Invalid Protocol Descriptor List. "
expr|\
literal|"Not a sequence, type=%#x\n"
argument_list|,
name|type
argument_list|)
expr_stmt|;
return|return;
comment|/* NOT REACHED */
block|}
name|print_protocol_descriptor
argument_list|(
name|start
argument_list|,
name|start
operator|+
name|len
argument_list|)
expr_stmt|;
name|start
operator|+=
name|len
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* print_protocol_descriptor_list */
end_comment

begin_comment
comment|/*  * Print Bluetooth Profile Descriptor List  *  * The BluetoothProfileDescriptorList attribute consists of a data element   * sequence in which each element is a profile descriptor that contains   * information about a Bluetooth profile to which the service represented by   * this service record conforms. Each profile descriptor is a data element   * sequence whose first element is the UUID assigned to the profile and whose   * second element is a 16-bit profile version number. Each version of a profile  * is assigned a 16-bit unsigned integer profile version number, which consists  * of two 8-bit fields. The higher-order 8 bits contain the major version   * number field and the lower-order 8 bits contain the minor version number   * field.  */
end_comment

begin_function
specifier|static
name|void
name|print_bluetooth_profile_descriptor_list
parameter_list|(
name|uint8_t
specifier|const
modifier|*
name|start
parameter_list|,
name|uint8_t
specifier|const
modifier|*
name|end
parameter_list|)
block|{
name|uint32_t
name|type
decl_stmt|,
name|len
decl_stmt|,
name|value
decl_stmt|;
if|if
condition|(
name|end
operator|-
name|start
operator|<
literal|2
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Invalid Bluetooth Profile Descriptor List. "
expr|\
literal|"Too short, len=%d\n"
argument_list|,
name|end
operator|-
name|start
argument_list|)
expr_stmt|;
return|return;
block|}
name|SDP_GET8
argument_list|(
name|type
argument_list|,
name|start
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|SDP_DATA_SEQ8
case|:
name|SDP_GET8
argument_list|(
name|len
argument_list|,
name|start
argument_list|)
expr_stmt|;
break|break;
case|case
name|SDP_DATA_SEQ16
case|:
name|SDP_GET16
argument_list|(
name|len
argument_list|,
name|start
argument_list|)
expr_stmt|;
break|break;
case|case
name|SDP_DATA_SEQ32
case|:
name|SDP_GET32
argument_list|(
name|len
argument_list|,
name|start
argument_list|)
expr_stmt|;
break|break;
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Invalid Bluetooth Profile Descriptor List. "
expr|\
literal|"Not a sequence, type=%#x\n"
argument_list|,
name|type
argument_list|)
expr_stmt|;
return|return;
comment|/* NOT REACHED */
block|}
while|while
condition|(
name|start
operator|<
name|end
condition|)
block|{
name|SDP_GET8
argument_list|(
name|type
argument_list|,
name|start
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|SDP_DATA_SEQ8
case|:
name|SDP_GET8
argument_list|(
name|len
argument_list|,
name|start
argument_list|)
expr_stmt|;
break|break;
case|case
name|SDP_DATA_SEQ16
case|:
name|SDP_GET16
argument_list|(
name|len
argument_list|,
name|start
argument_list|)
expr_stmt|;
break|break;
case|case
name|SDP_DATA_SEQ32
case|:
name|SDP_GET32
argument_list|(
name|len
argument_list|,
name|start
argument_list|)
expr_stmt|;
break|break;
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Invalid Bluetooth Profile "
expr|\
literal|"Descriptor List. "
expr|\
literal|"Not a sequence, type=%#x\n"
argument_list|,
name|type
argument_list|)
expr_stmt|;
return|return;
comment|/* NOT REACHED */
block|}
comment|/* Get UUID */
name|SDP_GET8
argument_list|(
name|type
argument_list|,
name|start
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|SDP_DATA_UUID16
case|:
name|SDP_GET16
argument_list|(
name|value
argument_list|,
name|start
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"\t%s (%#4.4x) "
argument_list|,
name|sdp_uuid2desc
argument_list|(
name|value
argument_list|)
argument_list|,
name|value
argument_list|)
expr_stmt|;
break|break;
case|case
name|SDP_DATA_UUID32
case|:
name|SDP_GET32
argument_list|(
name|value
argument_list|,
name|start
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"\t%#8.8x "
argument_list|,
name|value
argument_list|)
expr_stmt|;
break|break;
case|case
name|SDP_DATA_UUID128
case|:
block|{
name|int128_t
name|uuid
decl_stmt|;
name|SDP_GET128
argument_list|(
operator|&
name|uuid
argument_list|,
name|start
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"\t%#8.8x-%4.4x-%4.4x-%4.4x-%4.4x%8.8x "
argument_list|,
operator|*
operator|(
name|uint32_t
operator|*
operator|)
operator|&
name|uuid
operator|.
name|b
index|[
literal|0
index|]
argument_list|,
operator|*
operator|(
name|uint16_t
operator|*
operator|)
operator|&
name|uuid
operator|.
name|b
index|[
literal|4
index|]
argument_list|,
operator|*
operator|(
name|uint16_t
operator|*
operator|)
operator|&
name|uuid
operator|.
name|b
index|[
literal|6
index|]
argument_list|,
operator|*
operator|(
name|uint16_t
operator|*
operator|)
operator|&
name|uuid
operator|.
name|b
index|[
literal|8
index|]
argument_list|,
operator|*
operator|(
name|uint16_t
operator|*
operator|)
operator|&
name|uuid
operator|.
name|b
index|[
literal|10
index|]
argument_list|,
operator|*
operator|(
name|uint32_t
operator|*
operator|)
operator|&
name|uuid
operator|.
name|b
index|[
literal|12
index|]
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Invalid Bluetooth Profile "
expr|\
literal|"Descriptor List. "
expr|\
literal|"Not a UUID, type=%#x\n"
argument_list|,
name|type
argument_list|)
expr_stmt|;
return|return;
comment|/* NOT REACHED */
block|}
comment|/* Get version */
name|SDP_GET8
argument_list|(
name|type
argument_list|,
name|start
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|!=
name|SDP_DATA_UINT16
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Invalid Bluetooth Profile "
expr|\
literal|"Descriptor List. "
expr|\
literal|"Invalid version type=%#x\n"
argument_list|,
name|type
argument_list|)
expr_stmt|;
return|return;
block|}
name|SDP_GET16
argument_list|(
name|value
argument_list|,
name|start
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"ver. %d.%d\n"
argument_list|,
operator|(
name|value
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|,
name|value
operator|&
literal|0xff
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* print_bluetooth_profile_descriptor_list */
end_comment

begin_comment
comment|/* Perform SDP search command */
end_comment

begin_function
specifier|static
name|int
name|do_sdp_search
parameter_list|(
name|void
modifier|*
name|xs
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|char
modifier|*
name|ep
init|=
name|NULL
decl_stmt|;
name|int32_t
name|n
decl_stmt|,
name|type
decl_stmt|,
name|value
decl_stmt|;
name|uint16_t
name|service
decl_stmt|;
comment|/* Parse command line arguments */
switch|switch
condition|(
name|argc
condition|)
block|{
case|case
literal|1
case|:
name|n
operator|=
name|strtoul
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
operator|&
name|ep
argument_list|,
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|ep
operator|!=
literal|0
condition|)
block|{
switch|switch
condition|(
name|tolower
argument_list|(
name|argv
index|[
literal|0
index|]
index|[
literal|0
index|]
argument_list|)
condition|)
block|{
case|case
literal|'c'
case|:
comment|/* CIP/CTP */
switch|switch
condition|(
name|tolower
argument_list|(
name|argv
index|[
literal|0
index|]
index|[
literal|1
index|]
argument_list|)
condition|)
block|{
case|case
literal|'i'
case|:
name|service
operator|=
name|SDP_SERVICE_CLASS_COMMON_ISDN_ACCESS
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
name|service
operator|=
name|SDP_SERVICE_CLASS_CORDLESS_TELEPHONY
expr_stmt|;
break|break;
default|default:
return|return
operator|(
name|USAGE
operator|)
return|;
comment|/* NOT REACHED */
block|}
break|break;
case|case
literal|'d'
case|:
comment|/* DialUp Networking */
name|service
operator|=
name|SDP_SERVICE_CLASS_DIALUP_NETWORKING
expr_stmt|;
break|break;
case|case
literal|'f'
case|:
comment|/* Fax/OBEX File Transfer */
switch|switch
condition|(
name|tolower
argument_list|(
name|argv
index|[
literal|0
index|]
index|[
literal|1
index|]
argument_list|)
condition|)
block|{
case|case
literal|'a'
case|:
name|service
operator|=
name|SDP_SERVICE_CLASS_FAX
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
name|service
operator|=
name|SDP_SERVICE_CLASS_OBEX_FILE_TRANSFER
expr_stmt|;
break|break;
default|default:
return|return
operator|(
name|USAGE
operator|)
return|;
comment|/* NOT REACHED */
block|}
break|break;
case|case
literal|'g'
case|:
comment|/* GN */
name|service
operator|=
name|SDP_SERVICE_CLASS_GN
expr_stmt|;
break|break;
case|case
literal|'h'
case|:
comment|/* Headset/HID */
switch|switch
condition|(
name|tolower
argument_list|(
name|argv
index|[
literal|0
index|]
index|[
literal|1
index|]
argument_list|)
condition|)
block|{
case|case
literal|'i'
case|:
name|service
operator|=
name|SDP_SERVICE_CLASS_HUMAN_INTERFACE_DEVICE
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
name|service
operator|=
name|SDP_SERVICE_CLASS_HEADSET
expr_stmt|;
break|break;
default|default:
return|return
operator|(
name|USAGE
operator|)
return|;
comment|/* NOT REACHED */
block|}
break|break;
case|case
literal|'l'
case|:
comment|/* LAN Access Using PPP */
name|service
operator|=
name|SDP_SERVICE_CLASS_LAN_ACCESS_USING_PPP
expr_stmt|;
break|break;
case|case
literal|'n'
case|:
comment|/* NAP */
name|service
operator|=
name|SDP_SERVICE_CLASS_NAP
expr_stmt|;
break|break;
case|case
literal|'o'
case|:
comment|/* OBEX Object Push */
name|service
operator|=
name|SDP_SERVICE_CLASS_OBEX_OBJECT_PUSH
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
comment|/* Serial Port */
name|service
operator|=
name|SDP_SERVICE_CLASS_SERIAL_PORT
expr_stmt|;
break|break;
default|default:
return|return
operator|(
name|USAGE
operator|)
return|;
comment|/* NOT REACHED */
block|}
block|}
else|else
name|service
operator|=
operator|(
name|uint16_t
operator|)
name|n
expr_stmt|;
break|break;
default|default:
return|return
operator|(
name|USAGE
operator|)
return|;
block|}
if|if
condition|(
name|service
operator|<
name|SDP_SERVICE_CLASS_SERVICE_DISCOVERY_SERVER
condition|)
return|return
operator|(
name|USAGE
operator|)
return|;
comment|/* Initialize attribute values array */
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|values_len
condition|;
name|n
operator|++
control|)
block|{
name|values
index|[
name|n
index|]
operator|.
name|flags
operator|=
name|SDP_ATTR_INVALID
expr_stmt|;
name|values
index|[
name|n
index|]
operator|.
name|attr
operator|=
literal|0
expr_stmt|;
name|values
index|[
name|n
index|]
operator|.
name|vlen
operator|=
name|BSIZE
expr_stmt|;
name|values
index|[
name|n
index|]
operator|.
name|value
operator|=
name|buffer
index|[
name|n
index|]
expr_stmt|;
block|}
comment|/* Do SDP Service Search Attribute Request */
name|n
operator|=
name|sdp_search
argument_list|(
name|xs
argument_list|,
literal|1
argument_list|,
operator|&
name|service
argument_list|,
name|attrs_len
argument_list|,
name|attrs
argument_list|,
name|values_len
argument_list|,
name|values
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|!=
literal|0
condition|)
return|return
operator|(
name|ERROR
operator|)
return|;
comment|/* Print attributes values */
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|values_len
condition|;
name|n
operator|++
control|)
block|{
if|if
condition|(
name|values
index|[
name|n
index|]
operator|.
name|flags
operator|!=
name|SDP_ATTR_OK
condition|)
break|break;
switch|switch
condition|(
name|values
index|[
name|n
index|]
operator|.
name|attr
condition|)
block|{
case|case
name|SDP_ATTR_SERVICE_RECORD_HANDLE
case|:
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|values
index|[
name|n
index|]
operator|.
name|vlen
operator|==
literal|5
condition|)
block|{
name|SDP_GET8
argument_list|(
name|type
argument_list|,
name|values
index|[
name|n
index|]
operator|.
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|SDP_DATA_UINT32
condition|)
block|{
name|SDP_GET32
argument_list|(
name|value
argument_list|,
name|values
index|[
name|n
index|]
operator|.
name|value
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"Record Handle: "
expr|\
literal|"%#8.8x\n"
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
else|else
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Invalid type=%#x "
expr|\
literal|"Record Handle "
expr|\
literal|"attribute!\n"
argument_list|,
name|type
argument_list|)
expr_stmt|;
block|}
else|else
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Invalid size=%d for Record "
expr|\
literal|"Handle attribute\n"
argument_list|,
name|values
index|[
name|n
index|]
operator|.
name|vlen
argument_list|)
expr_stmt|;
break|break;
case|case
name|SDP_ATTR_SERVICE_CLASS_ID_LIST
case|:
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"Service Class ID List:\n"
argument_list|)
expr_stmt|;
name|print_service_class_id_list
argument_list|(
name|values
index|[
name|n
index|]
operator|.
name|value
argument_list|,
name|values
index|[
name|n
index|]
operator|.
name|value
operator|+
name|values
index|[
name|n
index|]
operator|.
name|vlen
argument_list|)
expr_stmt|;
break|break;
case|case
name|SDP_ATTR_PROTOCOL_DESCRIPTOR_LIST
case|:
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"Protocol Descriptor List:\n"
argument_list|)
expr_stmt|;
name|print_protocol_descriptor_list
argument_list|(
name|values
index|[
name|n
index|]
operator|.
name|value
argument_list|,
name|values
index|[
name|n
index|]
operator|.
name|value
operator|+
name|values
index|[
name|n
index|]
operator|.
name|vlen
argument_list|)
expr_stmt|;
break|break;
case|case
name|SDP_ATTR_BLUETOOTH_PROFILE_DESCRIPTOR_LIST
case|:
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"Bluetooth Profile Descriptor List:\n"
argument_list|)
expr_stmt|;
name|print_bluetooth_profile_descriptor_list
argument_list|(
name|values
index|[
name|n
index|]
operator|.
name|value
argument_list|,
name|values
index|[
name|n
index|]
operator|.
name|value
operator|+
name|values
index|[
name|n
index|]
operator|.
name|vlen
argument_list|)
expr_stmt|;
break|break;
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Unexpected attribute ID=%#4.4x\n"
argument_list|,
name|values
index|[
name|n
index|]
operator|.
name|attr
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
return|return
operator|(
name|OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/* do_sdp_search */
end_comment

begin_comment
comment|/* Perform SDP browse command */
end_comment

begin_function
specifier|static
name|int
name|do_sdp_browse
parameter_list|(
name|void
modifier|*
name|xs
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
undef|#
directive|undef
name|_STR
undef|#
directive|undef
name|STR
define|#
directive|define
name|_STR
parameter_list|(
name|x
parameter_list|)
value|#x
define|#
directive|define
name|STR
parameter_list|(
name|x
parameter_list|)
value|_STR(x)
specifier|static
name|char
specifier|const
modifier|*
specifier|const
name|av
index|[]
init|=
block|{
name|STR
argument_list|(
name|SDP_SERVICE_CLASS_PUBLIC_BROWSE_GROUP
argument_list|)
block|,
name|NULL
block|}
decl_stmt|;
switch|switch
condition|(
name|argc
condition|)
block|{
case|case
literal|0
case|:
name|argc
operator|=
literal|1
expr_stmt|;
name|argv
operator|=
operator|(
name|char
operator|*
operator|*
operator|)
name|av
expr_stmt|;
comment|/* FALL THROUGH */
case|case
literal|1
case|:
return|return
operator|(
name|do_sdp_search
argument_list|(
name|xs
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|)
operator|)
return|;
block|}
return|return
operator|(
name|USAGE
operator|)
return|;
block|}
end_function

begin_comment
comment|/* do_sdp_browse */
end_comment

begin_comment
comment|/* List of SDP commands */
end_comment

begin_decl_stmt
name|struct
name|sdp_command
name|sdp_commands
index|[]
init|=
block|{
block|{
literal|"Browse [<Group>]"
block|,
literal|"Browse for services. The<Group> parameter is a 16-bit UUID of the group\n"
expr|\
literal|"to browse. If omitted<Group> is set to Public Browse Group.\n\n"
expr|\
literal|"\t<Group> - xxxx; 16-bit UUID of the group to browse\n"
block|,
name|do_sdp_browse
block|}
block|,
block|{
literal|"Search<Service>"
block|,
literal|"Search for the<Service>. The<Service> parameter is a 16-bit UUID of the\n"
expr|\
literal|"service to search for. For some services it is possible to use service name\n"
expr|\
literal|"instead of service UUID\n\n"
expr|\
literal|"\t<Service> - xxxx; 16-bit UUID of the service to search for\n\n"
expr|\
literal|"\tKnown service names\n"
expr|\
literal|"\t===================\n"
expr|\
literal|"\tCIP   - Common ISDN Access\n"
expr|\
literal|"\tCTP   - Cordless Telephony\n"
expr|\
literal|"\tDUN   - DialUp Networking\n"
expr|\
literal|"\tFAX   - Fax\n"
expr|\
literal|"\tFTRN  - OBEX File Transfer\n"
expr|\
literal|"\tGN    - GN\n"
expr|\
literal|"\tHID   - Human Interface Device\n"
expr|\
literal|"\tHSET  - Headset\n"
expr|\
literal|"\tLAN   - LAN Access Using PPP\n"
expr|\
literal|"\tNAP   - Network Access Point\n"
expr|\
literal|"\tOPUSH - OBEX Object Push\n"
expr|\
literal|"\tSP    - Serial Port\n"
block|,
name|do_sdp_search
block|}
block|,
block|{
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

end_unit


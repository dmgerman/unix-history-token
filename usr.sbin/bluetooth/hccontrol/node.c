begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * node.c  *  * Copyright (c) 2001-2002 Maksim Yevmenkin<m_evmenkin@yahoo.com>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $Id: node.c,v 1.4 2003/03/23 21:28:17 max Exp $  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<bitstring.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<ng_hci.h>
end_include

begin_include
include|#
directive|include
file|<ng_l2cap.h>
end_include

begin_include
include|#
directive|include
file|<ng_btsocket.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|"hccontrol.h"
end_include

begin_comment
comment|/* Send Read_Node_State command to the node */
end_comment

begin_function
specifier|static
name|int
name|hci_read_node_state
parameter_list|(
name|int
name|s
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|struct
name|ng_btsocket_hci_raw_node_state
name|r
decl_stmt|;
name|memset
argument_list|(
operator|&
name|r
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|r
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOC_HCI_RAW_NODE_GET_STATE
argument_list|,
operator|&
name|r
argument_list|,
sizeof|sizeof
argument_list|(
name|r
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
name|ERROR
operator|)
return|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"State: %#x\n"
argument_list|,
name|r
operator|.
name|state
argument_list|)
expr_stmt|;
return|return
operator|(
name|OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/* hci_read_node_state */
end_comment

begin_comment
comment|/* Send Intitialize command to the node */
end_comment

begin_function
specifier|static
name|int
name|hci_node_initialize
parameter_list|(
name|int
name|s
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOC_HCI_RAW_NODE_INIT
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
name|ERROR
operator|)
return|;
return|return
operator|(
name|OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/* hci_node_initialize */
end_comment

begin_comment
comment|/* Send Read_Debug_Level command to the node */
end_comment

begin_function
specifier|static
name|int
name|hci_read_debug_level
parameter_list|(
name|int
name|s
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|struct
name|ng_btsocket_hci_raw_node_debug
name|r
decl_stmt|;
name|memset
argument_list|(
operator|&
name|r
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|r
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOC_HCI_RAW_NODE_GET_DEBUG
argument_list|,
operator|&
name|r
argument_list|,
sizeof|sizeof
argument_list|(
name|r
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
name|ERROR
operator|)
return|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"Debug level: %d\n"
argument_list|,
name|r
operator|.
name|debug
argument_list|)
expr_stmt|;
return|return
operator|(
name|OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/* hci_read_debug_level */
end_comment

begin_comment
comment|/* Send Write_Debug_Level command to the node */
end_comment

begin_function
specifier|static
name|int
name|hci_write_debug_level
parameter_list|(
name|int
name|s
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|struct
name|ng_btsocket_hci_raw_node_debug
name|r
decl_stmt|;
name|memset
argument_list|(
operator|&
name|r
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|r
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|argc
condition|)
block|{
case|case
literal|1
case|:
name|r
operator|.
name|debug
operator|=
name|atoi
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
default|default:
return|return
operator|(
name|USAGE
operator|)
return|;
block|}
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOC_HCI_RAW_NODE_SET_DEBUG
argument_list|,
operator|&
name|r
argument_list|,
sizeof|sizeof
argument_list|(
name|r
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
name|ERROR
operator|)
return|;
return|return
operator|(
name|OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/* hci_write_debug_level */
end_comment

begin_comment
comment|/* Send Read_Node_Buffer_Size command to the node */
end_comment

begin_function
specifier|static
name|int
name|hci_read_node_buffer_size
parameter_list|(
name|int
name|s
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|struct
name|ng_btsocket_hci_raw_node_buffer
name|r
decl_stmt|;
name|memset
argument_list|(
operator|&
name|r
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|r
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOC_HCI_RAW_NODE_GET_BUFFER
argument_list|,
operator|&
name|r
argument_list|,
sizeof|sizeof
argument_list|(
name|r
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
name|ERROR
operator|)
return|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"Number of free command buffers: %d\n"
argument_list|,
name|r
operator|.
name|buffer
operator|.
name|cmd_free
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"Max. ACL packet size: %d\n"
argument_list|,
name|r
operator|.
name|buffer
operator|.
name|acl_size
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"Numbef of free ACL buffers: %d\n"
argument_list|,
name|r
operator|.
name|buffer
operator|.
name|acl_free
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"Total number of ACL buffers: %d\n"
argument_list|,
name|r
operator|.
name|buffer
operator|.
name|acl_pkts
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"Max. SCO packet size: %d\n"
argument_list|,
name|r
operator|.
name|buffer
operator|.
name|sco_size
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"Numbef of free SCO buffers: %d\n"
argument_list|,
name|r
operator|.
name|buffer
operator|.
name|sco_free
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"Total number of SCO buffers: %d\n"
argument_list|,
name|r
operator|.
name|buffer
operator|.
name|sco_pkts
argument_list|)
expr_stmt|;
return|return
operator|(
name|OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/* hci_read_node_buffer_size */
end_comment

begin_comment
comment|/* Send Read_Node_BD_ADDR command to the node */
end_comment

begin_function
specifier|static
name|int
name|hci_read_node_bd_addr
parameter_list|(
name|int
name|s
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|struct
name|ng_btsocket_hci_raw_node_bdaddr
name|r
decl_stmt|;
name|memset
argument_list|(
operator|&
name|r
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|r
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOC_HCI_RAW_NODE_GET_BDADDR
argument_list|,
operator|&
name|r
argument_list|,
sizeof|sizeof
argument_list|(
name|r
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
name|ERROR
operator|)
return|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"BD_ADDR: %02x:%02x:%02x:%02x:%02x:%02x\n"
argument_list|,
name|r
operator|.
name|bdaddr
operator|.
name|b
index|[
literal|5
index|]
argument_list|,
name|r
operator|.
name|bdaddr
operator|.
name|b
index|[
literal|4
index|]
argument_list|,
name|r
operator|.
name|bdaddr
operator|.
name|b
index|[
literal|3
index|]
argument_list|,
name|r
operator|.
name|bdaddr
operator|.
name|b
index|[
literal|2
index|]
argument_list|,
name|r
operator|.
name|bdaddr
operator|.
name|b
index|[
literal|1
index|]
argument_list|,
name|r
operator|.
name|bdaddr
operator|.
name|b
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
return|return
operator|(
name|OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/* hci_read_node_bd_addr */
end_comment

begin_comment
comment|/* Send Read_Node_Features command to the node */
end_comment

begin_function
specifier|static
name|int
name|hci_read_node_features
parameter_list|(
name|int
name|s
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|struct
name|ng_btsocket_hci_raw_node_features
name|r
decl_stmt|;
name|int
name|n
decl_stmt|;
name|char
name|buffer
index|[
literal|1024
index|]
decl_stmt|;
name|memset
argument_list|(
operator|&
name|r
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|r
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOC_HCI_RAW_NODE_GET_FEATURES
argument_list|,
operator|&
name|r
argument_list|,
sizeof|sizeof
argument_list|(
name|r
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
name|ERROR
operator|)
return|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"Features: "
argument_list|)
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
sizeof|sizeof
argument_list|(
name|r
operator|.
name|features
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|r
operator|.
name|features
index|[
literal|0
index|]
argument_list|)
condition|;
name|n
operator|++
control|)
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"%#02x "
argument_list|,
name|r
operator|.
name|features
index|[
name|n
index|]
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"\n%s\n"
argument_list|,
name|hci_features2str
argument_list|(
name|r
operator|.
name|features
argument_list|,
name|buffer
argument_list|,
sizeof|sizeof
argument_list|(
name|buffer
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/* hci_read_node_features */
end_comment

begin_comment
comment|/* Send Read_Node_Stat command to the node */
end_comment

begin_function
specifier|static
name|int
name|hci_read_node_stat
parameter_list|(
name|int
name|s
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|struct
name|ng_btsocket_hci_raw_node_stat
name|r
decl_stmt|;
name|memset
argument_list|(
operator|&
name|r
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|r
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOC_HCI_RAW_NODE_GET_STAT
argument_list|,
operator|&
name|r
argument_list|,
sizeof|sizeof
argument_list|(
name|r
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
name|ERROR
operator|)
return|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"Commands sent: %d\n"
argument_list|,
name|r
operator|.
name|stat
operator|.
name|cmd_sent
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"Events received: %d\n"
argument_list|,
name|r
operator|.
name|stat
operator|.
name|evnt_recv
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"ACL packets received: %d\n"
argument_list|,
name|r
operator|.
name|stat
operator|.
name|acl_recv
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"ACL packets sent: %d\n"
argument_list|,
name|r
operator|.
name|stat
operator|.
name|acl_sent
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"SCO packets received: %d\n"
argument_list|,
name|r
operator|.
name|stat
operator|.
name|sco_recv
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"SCO packets sent: %d\n"
argument_list|,
name|r
operator|.
name|stat
operator|.
name|sco_sent
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"Bytes received: %d\n"
argument_list|,
name|r
operator|.
name|stat
operator|.
name|bytes_recv
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"Bytes sent: %d\n"
argument_list|,
name|r
operator|.
name|stat
operator|.
name|bytes_sent
argument_list|)
expr_stmt|;
return|return
operator|(
name|OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/* hci_read_node_stat */
end_comment

begin_comment
comment|/* Send Reset_Node_Stat command to the node */
end_comment

begin_function
specifier|static
name|int
name|hci_reset_node_stat
parameter_list|(
name|int
name|s
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOC_HCI_RAW_NODE_RESET_STAT
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
name|ERROR
operator|)
return|;
return|return
operator|(
name|OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/* hci_reset_node_stat */
end_comment

begin_comment
comment|/* Send Flush_Neighbor_Cache command to the node */
end_comment

begin_function
specifier|static
name|int
name|hci_flush_neighbor_cache
parameter_list|(
name|int
name|s
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOC_HCI_RAW_NODE_FLUSH_NEIGHBOR_CACHE
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
name|ERROR
operator|)
return|;
return|return
operator|(
name|OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/* hci_flush_neighbor_cache */
end_comment

begin_comment
comment|/* Send Read_Neighbor_Cache command to the node */
end_comment

begin_function
specifier|static
name|int
name|hci_read_neighbor_cache
parameter_list|(
name|int
name|s
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|struct
name|ng_btsocket_hci_raw_node_neighbor_cache
name|r
decl_stmt|;
name|int
name|n
decl_stmt|,
name|error
init|=
name|OK
decl_stmt|;
name|memset
argument_list|(
operator|&
name|r
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|r
argument_list|)
argument_list|)
expr_stmt|;
name|r
operator|.
name|num_entries
operator|=
name|NG_HCI_MAX_NEIGHBOR_NUM
expr_stmt|;
name|r
operator|.
name|entries
operator|=
name|calloc
argument_list|(
name|NG_HCI_MAX_NEIGHBOR_NUM
argument_list|,
sizeof|sizeof
argument_list|(
name|ng_hci_node_neighbor_cache_entry_ep
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|.
name|entries
operator|==
name|NULL
condition|)
block|{
name|errno
operator|=
name|ENOMEM
expr_stmt|;
return|return
operator|(
name|ERROR
operator|)
return|;
block|}
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOC_HCI_RAW_NODE_GET_NEIGHBOR_CACHE
argument_list|,
operator|&
name|r
argument_list|,
sizeof|sizeof
argument_list|(
name|r
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|error
operator|=
name|ERROR
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"BD_ADDR           "
expr|\
literal|"Features                "
expr|\
literal|"Clock offset "
expr|\
literal|"Page scan "
expr|\
literal|"Rep. scan\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|r
operator|.
name|num_entries
condition|;
name|n
operator|++
control|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"%02x:%02x:%02x:%02x:%02x:%02x "
expr|\
literal|"%02x %02x %02x %02x %02x %02x %02x %02x "
expr|\
literal|"%#12x "
expr|\
literal|"%#9x "
expr|\
literal|"%#9x\n"
argument_list|,
name|r
operator|.
name|entries
index|[
name|n
index|]
operator|.
name|bdaddr
operator|.
name|b
index|[
literal|5
index|]
argument_list|,
name|r
operator|.
name|entries
index|[
name|n
index|]
operator|.
name|bdaddr
operator|.
name|b
index|[
literal|4
index|]
argument_list|,
name|r
operator|.
name|entries
index|[
name|n
index|]
operator|.
name|bdaddr
operator|.
name|b
index|[
literal|3
index|]
argument_list|,
name|r
operator|.
name|entries
index|[
name|n
index|]
operator|.
name|bdaddr
operator|.
name|b
index|[
literal|2
index|]
argument_list|,
name|r
operator|.
name|entries
index|[
name|n
index|]
operator|.
name|bdaddr
operator|.
name|b
index|[
literal|1
index|]
argument_list|,
name|r
operator|.
name|entries
index|[
name|n
index|]
operator|.
name|bdaddr
operator|.
name|b
index|[
literal|0
index|]
argument_list|,
name|r
operator|.
name|entries
index|[
name|n
index|]
operator|.
name|features
index|[
literal|0
index|]
argument_list|,
name|r
operator|.
name|entries
index|[
name|n
index|]
operator|.
name|features
index|[
literal|1
index|]
argument_list|,
name|r
operator|.
name|entries
index|[
name|n
index|]
operator|.
name|features
index|[
literal|2
index|]
argument_list|,
name|r
operator|.
name|entries
index|[
name|n
index|]
operator|.
name|features
index|[
literal|3
index|]
argument_list|,
name|r
operator|.
name|entries
index|[
name|n
index|]
operator|.
name|features
index|[
literal|4
index|]
argument_list|,
name|r
operator|.
name|entries
index|[
name|n
index|]
operator|.
name|features
index|[
literal|5
index|]
argument_list|,
name|r
operator|.
name|entries
index|[
name|n
index|]
operator|.
name|features
index|[
literal|6
index|]
argument_list|,
name|r
operator|.
name|entries
index|[
name|n
index|]
operator|.
name|features
index|[
literal|7
index|]
argument_list|,
name|r
operator|.
name|entries
index|[
name|n
index|]
operator|.
name|clock_offset
argument_list|,
name|r
operator|.
name|entries
index|[
name|n
index|]
operator|.
name|page_scan_mode
argument_list|,
name|r
operator|.
name|entries
index|[
name|n
index|]
operator|.
name|page_scan_rep_mode
argument_list|)
expr_stmt|;
block|}
name|out
label|:
name|free
argument_list|(
name|r
operator|.
name|entries
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/* hci_read_neightbor_cache */
end_comment

begin_comment
comment|/* Send Read_Connection_List command to the node */
end_comment

begin_function
specifier|static
name|int
name|hci_read_connection_list
parameter_list|(
name|int
name|s
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|struct
name|ng_btsocket_hci_raw_con_list
name|r
decl_stmt|;
name|int
name|n
decl_stmt|,
name|error
init|=
name|OK
decl_stmt|;
name|memset
argument_list|(
operator|&
name|r
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|r
argument_list|)
argument_list|)
expr_stmt|;
name|r
operator|.
name|num_connections
operator|=
name|NG_HCI_MAX_CON_NUM
expr_stmt|;
name|r
operator|.
name|connections
operator|=
name|calloc
argument_list|(
name|NG_HCI_MAX_CON_NUM
argument_list|,
sizeof|sizeof
argument_list|(
name|ng_hci_node_con_ep
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|.
name|connections
operator|==
name|NULL
condition|)
block|{
name|errno
operator|=
name|ENOMEM
expr_stmt|;
return|return
operator|(
name|ERROR
operator|)
return|;
block|}
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOC_HCI_RAW_NODE_GET_CON_LIST
argument_list|,
operator|&
name|r
argument_list|,
sizeof|sizeof
argument_list|(
name|r
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|error
operator|=
name|ERROR
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"Remote BD_ADDR    "
expr|\
literal|"Handle "
expr|\
literal|"Type "
expr|\
literal|"Mode "
expr|\
literal|"Role "
expr|\
literal|"Encrypt "
expr|\
literal|"Pending "
expr|\
literal|"Queue "
expr|\
literal|"State\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|r
operator|.
name|num_connections
condition|;
name|n
operator|++
control|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"%02x:%02x:%02x:%02x:%02x:%02x "
expr|\
literal|"%6d "
expr|\
literal|"%4.4s "
expr|\
literal|"%4d "
expr|\
literal|"%4.4s "
expr|\
literal|"%7.7s "
expr|\
literal|"%7d "
expr|\
literal|"%5d "
expr|\
literal|"%s\n"
argument_list|,
name|r
operator|.
name|connections
index|[
name|n
index|]
operator|.
name|bdaddr
operator|.
name|b
index|[
literal|5
index|]
argument_list|,
name|r
operator|.
name|connections
index|[
name|n
index|]
operator|.
name|bdaddr
operator|.
name|b
index|[
literal|4
index|]
argument_list|,
name|r
operator|.
name|connections
index|[
name|n
index|]
operator|.
name|bdaddr
operator|.
name|b
index|[
literal|3
index|]
argument_list|,
name|r
operator|.
name|connections
index|[
name|n
index|]
operator|.
name|bdaddr
operator|.
name|b
index|[
literal|2
index|]
argument_list|,
name|r
operator|.
name|connections
index|[
name|n
index|]
operator|.
name|bdaddr
operator|.
name|b
index|[
literal|1
index|]
argument_list|,
name|r
operator|.
name|connections
index|[
name|n
index|]
operator|.
name|bdaddr
operator|.
name|b
index|[
literal|0
index|]
argument_list|,
name|r
operator|.
name|connections
index|[
name|n
index|]
operator|.
name|con_handle
argument_list|,
operator|(
name|r
operator|.
name|connections
index|[
name|n
index|]
operator|.
name|link_type
operator|==
name|NG_HCI_LINK_ACL
operator|)
condition|?
literal|"ACL"
else|:
literal|"SCO"
argument_list|,
name|r
operator|.
name|connections
index|[
name|n
index|]
operator|.
name|mode
argument_list|,
operator|(
name|r
operator|.
name|connections
index|[
name|n
index|]
operator|.
name|role
operator|==
name|NG_HCI_ROLE_MASTER
operator|)
condition|?
literal|"MAST"
else|:
literal|"SLAV"
argument_list|,
name|hci_encrypt2str
argument_list|(
name|r
operator|.
name|connections
index|[
name|n
index|]
operator|.
name|encryption_mode
argument_list|,
literal|1
argument_list|)
argument_list|,
name|r
operator|.
name|connections
index|[
name|n
index|]
operator|.
name|pending
argument_list|,
name|r
operator|.
name|connections
index|[
name|n
index|]
operator|.
name|queue_len
argument_list|,
name|hci_con_state2str
argument_list|(
name|r
operator|.
name|connections
index|[
name|n
index|]
operator|.
name|state
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|out
label|:
name|free
argument_list|(
name|r
operator|.
name|connections
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/* hci_read_connection_list */
end_comment

begin_comment
comment|/* Send Read_Node_Link_Policy_Settings_Mask command to the node */
end_comment

begin_function
name|int
name|hci_read_node_link_policy_settings_mask
parameter_list|(
name|int
name|s
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|struct
name|ng_btsocket_hci_raw_node_link_policy_mask
name|r
decl_stmt|;
name|memset
argument_list|(
operator|&
name|r
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|r
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOC_HCI_RAW_NODE_GET_LINK_POLICY_MASK
argument_list|,
operator|&
name|r
argument_list|,
sizeof|sizeof
argument_list|(
name|r
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
name|ERROR
operator|)
return|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"Link Policy Settings mask: %#04x\n"
argument_list|,
name|r
operator|.
name|policy_mask
argument_list|)
expr_stmt|;
return|return
operator|(
name|OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/* hci_read_node_link_policy_settings_mask */
end_comment

begin_comment
comment|/* Send Write_Node_Link_Policy_Settings_Mask command to the node */
end_comment

begin_function
name|int
name|hci_write_node_link_policy_settings_mask
parameter_list|(
name|int
name|s
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|struct
name|ng_btsocket_hci_raw_node_link_policy_mask
name|r
decl_stmt|;
name|int
name|m
decl_stmt|;
name|memset
argument_list|(
operator|&
name|r
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|r
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|argc
condition|)
block|{
case|case
literal|1
case|:
if|if
condition|(
name|sscanf
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"%x"
argument_list|,
operator|&
name|m
argument_list|)
operator|!=
literal|1
condition|)
return|return
operator|(
name|USAGE
operator|)
return|;
name|r
operator|.
name|policy_mask
operator|=
operator|(
name|m
operator|&
literal|0xffff
operator|)
expr_stmt|;
break|break;
default|default:
return|return
operator|(
name|USAGE
operator|)
return|;
block|}
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOC_HCI_RAW_NODE_SET_LINK_POLICY_MASK
argument_list|,
operator|&
name|r
argument_list|,
sizeof|sizeof
argument_list|(
name|r
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
name|ERROR
operator|)
return|;
return|return
operator|(
name|OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/* hci_write_node_link_policy_settings_mask */
end_comment

begin_comment
comment|/* Send Read_Node_Packet_Mask command to the node */
end_comment

begin_function
name|int
name|hci_read_node_packet_mask
parameter_list|(
name|int
name|s
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|struct
name|ng_btsocket_hci_raw_node_packet_mask
name|r
decl_stmt|;
name|memset
argument_list|(
operator|&
name|r
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|r
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOC_HCI_RAW_NODE_GET_PACKET_MASK
argument_list|,
operator|&
name|r
argument_list|,
sizeof|sizeof
argument_list|(
name|r
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
name|ERROR
operator|)
return|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"Packet mask: %#04x\n"
argument_list|,
name|r
operator|.
name|packet_mask
argument_list|)
expr_stmt|;
return|return
operator|(
name|OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/* hci_read_node_packet_mask */
end_comment

begin_comment
comment|/* Send Write_Node_Packet_Mask command to the node */
end_comment

begin_function
name|int
name|hci_write_node_packet_mask
parameter_list|(
name|int
name|s
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|struct
name|ng_btsocket_hci_raw_node_packet_mask
name|r
decl_stmt|;
name|int
name|m
decl_stmt|;
name|memset
argument_list|(
operator|&
name|r
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|r
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|argc
condition|)
block|{
case|case
literal|1
case|:
if|if
condition|(
name|sscanf
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"%x"
argument_list|,
operator|&
name|m
argument_list|)
operator|!=
literal|1
condition|)
return|return
operator|(
name|USAGE
operator|)
return|;
name|r
operator|.
name|packet_mask
operator|=
operator|(
name|m
operator|&
literal|0xffff
operator|)
expr_stmt|;
break|break;
default|default:
return|return
operator|(
name|USAGE
operator|)
return|;
block|}
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOC_HCI_RAW_NODE_SET_PACKET_MASK
argument_list|,
operator|&
name|r
argument_list|,
sizeof|sizeof
argument_list|(
name|r
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
name|ERROR
operator|)
return|;
return|return
operator|(
name|OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/* hci_write_node_packet_mask */
end_comment

begin_comment
comment|/* Send Read_Node_Role_Switch command to the node */
end_comment

begin_function
name|int
name|hci_read_node_role_switch
parameter_list|(
name|int
name|s
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|struct
name|ng_btsocket_hci_raw_node_role_switch
name|r
decl_stmt|;
name|memset
argument_list|(
operator|&
name|r
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|r
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOC_HCI_RAW_NODE_GET_ROLE_SWITCH
argument_list|,
operator|&
name|r
argument_list|,
sizeof|sizeof
argument_list|(
name|r
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
name|ERROR
operator|)
return|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"Role switch: %d\n"
argument_list|,
name|r
operator|.
name|role_switch
argument_list|)
expr_stmt|;
return|return
operator|(
name|OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/* hci_read_node_role_switch */
end_comment

begin_comment
comment|/* Send Write_Node_Role_Switch command to the node */
end_comment

begin_function
name|int
name|hci_write_node_role_switch
parameter_list|(
name|int
name|s
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|struct
name|ng_btsocket_hci_raw_node_role_switch
name|r
decl_stmt|;
name|int
name|m
decl_stmt|;
name|memset
argument_list|(
operator|&
name|r
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|r
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|argc
condition|)
block|{
case|case
literal|1
case|:
if|if
condition|(
name|sscanf
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"%d"
argument_list|,
operator|&
name|m
argument_list|)
operator|!=
literal|1
condition|)
return|return
operator|(
name|USAGE
operator|)
return|;
name|r
operator|.
name|role_switch
operator|=
name|m
condition|?
literal|1
else|:
literal|0
expr_stmt|;
break|break;
default|default:
return|return
operator|(
name|USAGE
operator|)
return|;
block|}
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOC_HCI_RAW_NODE_SET_ROLE_SWITCH
argument_list|,
operator|&
name|r
argument_list|,
sizeof|sizeof
argument_list|(
name|r
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
name|ERROR
operator|)
return|;
return|return
operator|(
name|OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/* hci_write_node_role_switch */
end_comment

begin_decl_stmt
name|struct
name|hci_command
name|node_commands
index|[]
init|=
block|{
block|{
literal|"read_node_state"
block|,
literal|"Get the HCI node state"
block|,
operator|&
name|hci_read_node_state
block|}
block|,
block|{
literal|"initialize"
block|,
literal|"Initialize the HCI node"
block|,
operator|&
name|hci_node_initialize
block|}
block|,
block|{
literal|"read_debug_level"
block|,
literal|"Read the HCI node debug level"
block|,
operator|&
name|hci_read_debug_level
block|}
block|,
block|{
literal|"write_debug_level<level>"
block|,
literal|"Write the HCI node debug level"
block|,
operator|&
name|hci_write_debug_level
block|}
block|,
block|{
literal|"read_node_buffer_size"
block|,
literal|"Read the HCI node buffer information. This will return current state of the\n"
expr|\
literal|"HCI buffer for the HCI node"
block|,
operator|&
name|hci_read_node_buffer_size
block|}
block|,
block|{
literal|"read_node_bd_addr"
block|,
literal|"Read the HCI node BD_ADDR. Returns device BD_ADDR as cached by the HCI node"
block|,
operator|&
name|hci_read_node_bd_addr
block|}
block|,
block|{
literal|"read_node_features"
block|,
literal|"Read the HCI node features. This will return list of supported features as\n"
expr|\
literal|"cached by the HCI node"
block|,
operator|&
name|hci_read_node_features
block|}
block|,
block|{
literal|"read_node_stat"
block|,
literal|"Read packets and bytes counters for the HCI node"
block|,
operator|&
name|hci_read_node_stat
block|}
block|,
block|{
literal|"reset_node_stat"
block|,
literal|"Reset packets and bytes counters for the HCI node"
block|,
operator|&
name|hci_reset_node_stat
block|}
block|,
block|{
literal|"flush_neighbor_cache"
block|,
literal|"Flush content of the HCI node neighbor cache"
block|,
operator|&
name|hci_flush_neighbor_cache
block|}
block|,
block|{
literal|"read_neighbor_cache"
block|,
literal|"Read content of the HCI node neighbor cache"
block|,
operator|&
name|hci_read_neighbor_cache
block|}
block|,
block|{
literal|"read_connection_list"
block|,
literal|"Read the baseband connection descriptors list for the HCI node"
block|,
operator|&
name|hci_read_connection_list
block|}
block|,
block|{
literal|"read_node_link_policy_settings_mask"
block|,
literal|"Read the value of the Link Policy Settinngs mask for the HCI node"
block|,
operator|&
name|hci_read_node_link_policy_settings_mask
block|}
block|,
block|{
literal|"write_node_link_policy_settings_mask<policy_mask>"
block|,
literal|"Write the value of the Link Policy Settings mask for the HCI node. By default\n"
expr|\
literal|"all supported Link Policy modes (as reported by the local device features) are\n"
expr|\
literal|"enabled. The particular Link Policy mode is enabled if local device supports\n"
expr|\
literal|"it and correspinding bit in the mask was set\n\n"
expr|\
literal|"\t<policy_mask> - xxxx; Link Policy mask\n"
expr|\
literal|"\t\t0x0000 - Disable All LM Modes\n"
expr|\
literal|"\t\t0x0001 - Enable Master Slave Switch\n"
expr|\
literal|"\t\t0x0002 - Enable Hold Mode\n"
expr|\
literal|"\t\t0x0004 - Enable Sniff Mode\n"
expr|\
literal|"\t\t0x0008 - Enable Park Mode\n"
block|,
operator|&
name|hci_write_node_link_policy_settings_mask
block|}
block|,
block|{
literal|"read_node_packet_mask"
block|,
literal|"Read the value of the Packet mask for the HCI node"
block|,
operator|&
name|hci_read_node_packet_mask
block|}
block|,
block|{
literal|"write_node_packet_mask<packet_mask>"
block|,
literal|"Write the value of the Packet mask for the HCI node. By default all supported\n"
expr|\
literal|"packet types (as reported by the local device features) are enabled. The\n"
expr|\
literal|"particular packet type is enabled if local device supports it and corresponding\n"
expr|\
literal|"bit in the mask was set\n\n"
expr|\
literal|"\t<packet_mask> - xxxx; packet type mask\n"
expr|\
literal|""
expr|\
literal|"\t\tACL packets\n"
expr|\
literal|"\t\t-----------\n"
expr|\
literal|"\t\t0x0008 DM1\n"
expr|\
literal|"\t\t0x0010 DH1\n"
expr|\
literal|"\t\t0x0400 DM3\n"
expr|\
literal|"\t\t0x0800 DH3\n"
expr|\
literal|"\t\t0x4000 DM5\n"
expr|\
literal|"\t\t0x8000 DH5\n"
expr|\
literal|"\n"
expr|\
literal|"\t\tSCO packets\n"
expr|\
literal|"\t\t-----------\n"
expr|\
literal|"\t\t0x0020 HV1\n"
expr|\
literal|"\t\t0x0040 HV2\n"
expr|\
literal|"\t\t0x0080 HV3\n"
block|,
operator|&
name|hci_write_node_packet_mask
block|}
block|,
block|{
literal|"read_node_role_switch"
block|,
literal|"Read the value of the Role Switch parameter for the HCI node"
block|,
operator|&
name|hci_read_node_role_switch
block|}
block|,
block|{
literal|"write_node_role_switch {0|1}"
block|,
literal|"Write the value of the Role Switch parameter for the HCI node. By default,\n"
expr|\
literal|"if Role Switch is supported, local device will try to perform Role Switch\n"
expr|\
literal|"and become Master on incoming connection. Some devices do not support Role\n"
expr|\
literal|"Switch and thus incomming connections from such devices will fail. Setting\n"
expr|\
literal|"this parameter to zero will prevent Role Switch and thus accepting device\n"
expr|\
literal|"will remain Slave"
block|,
operator|&
name|hci_write_node_role_switch
block|}
block|,
block|{
name|NULL
block|, }
block|}
decl_stmt|;
end_decl_stmt

end_unit


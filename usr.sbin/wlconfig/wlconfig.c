begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) 1996  *      Michael Smith.  All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY Michael Smith AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL Michael Smith OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
specifier|const
name|char
name|rcsid
index|[]
init|=
literal|"$Id$"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* not lint */
end_comment

begin_comment
comment|/*  * wlconfig.c  *   * utility to read out and change various WAVELAN parameters.  * Currently supports NWID and IRQ values.  *  * The NWID is used by 2 or more wavelan controllers to determine  * if packets should be received or not.  It is a filter that  * is roughly analogous to the "channel" setting with a garage  * door controller.  Two companies side by side with wavelan devices  * that could actually hear each other can use different NWIDs  * and ignore packets.  In truth however, the air space is shared,   * and the NWID is a virtual filter.  *  * In the current set of wavelan drivers, ioctls changed only  * the runtime radio modem registers which act in a manner analogous  * to an ethernet transceiver.  The ioctls do not change the   * stored nvram PSA (or parameter storage area).  At boot, the PSA  * values are stored in the radio modem.   Thus when the  * system reboots it will restore the wavelan NWID to the value  * stored in the PSA.  The NCR/ATT dos utilities must be used to  * change the initial NWID values in the PSA.  The wlconfig utility  * may be used to set a different NWID at runtime; this is only  * permitted while the interface is up and running.  *  * By contrast, the IRQ value can only be changed while the   * Wavelan card is down and unconfigured, and it will remain  * disabled after an IRQ change until reboot.  *  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<machine/if_wl_wavelan.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_var.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/if_ether.h>
end_include

begin_function_decl
specifier|extern
name|struct
name|ether_addr
modifier|*
name|ether_aton
parameter_list|(
name|char
modifier|*
name|a
parameter_list|)
function_decl|;
end_function_decl

begin_include
include|#
directive|include
file|<err.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<limits.h>
end_include

begin_comment
comment|/* translate IRQ bit to number */
end_comment

begin_comment
comment|/* array for maping irq numbers to values for the irq parameter register */
end_comment

begin_decl_stmt
specifier|static
name|int
name|irqvals
index|[
literal|16
index|]
init|=
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0x01
block|,
literal|0x02
block|,
literal|0x04
block|,
literal|0
block|,
literal|0x08
block|,
literal|0
block|,
literal|0
block|,
literal|0x10
block|,
literal|0x20
block|,
literal|0x40
block|,
literal|0
block|,
literal|0
block|,
literal|0x80
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* cache */
end_comment

begin_decl_stmt
specifier|static
name|int
name|w_sigitems
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* count of valid items */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|w_sigcache
name|wsc
index|[
name|MAXCACHEITEMS
index|]
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|wlirq
parameter_list|(
name|int
name|irqval
parameter_list|)
block|{
name|int
name|irq
decl_stmt|;
for|for
control|(
name|irq
operator|=
literal|0
init|;
name|irq
operator|<
literal|16
condition|;
name|irq
operator|++
control|)
if|if
condition|(
name|irqvals
index|[
name|irq
index|]
operator|==
name|irqval
condition|)
return|return
operator|(
name|irq
operator|)
return|;
return|return
literal|0
return|;
block|}
end_function

begin_decl_stmt
name|char
modifier|*
name|compat_type
index|[]
init|=
block|{
literal|"PC-AT 915MHz"
block|,
literal|"PC-MC 915MHz"
block|,
literal|"PC-AT 2.4GHz"
block|,
literal|"PC-MC 2.4GHz"
block|,
literal|"PCCARD or 1/2 size AT, 915MHz or 2.4GHz"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|subband
index|[]
init|=
block|{
literal|"915MHz/see WaveModem"
block|,
literal|"2425MHz"
block|,
literal|"2460MHz"
block|,
literal|"2484MHz"
block|,
literal|"2430.5MHz"
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* ** print_psa ** ** Given a pointer to a PSA structure, print it out */
end_comment

begin_function
name|void
name|print_psa
parameter_list|(
name|u_char
modifier|*
name|psa
parameter_list|,
name|int
name|currnwid
parameter_list|)
block|{
name|int
name|nwid
decl_stmt|;
comment|/*     ** Work out what sort of board we have     */
if|if
condition|(
name|psa
index|[
literal|0
index|]
operator|==
literal|0x14
condition|)
block|{
name|printf
argument_list|(
literal|"Board type            : Microchannel\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|psa
index|[
literal|1
index|]
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Board type            : PCCARD\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"Board type            : ISA"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|psa
index|[
literal|4
index|]
operator|==
literal|0
operator|)
operator|&&
operator|(
name|psa
index|[
literal|5
index|]
operator|==
literal|0
operator|)
operator|&&
operator|(
name|psa
index|[
literal|6
index|]
operator|==
literal|0
operator|)
condition|)
name|printf
argument_list|(
literal|" (DEC OEM)"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Base address options  : 0x300, 0x%02x0, 0x%02x0, 0x%02x0\n"
argument_list|,
operator|(
name|int
operator|)
name|psa
index|[
literal|1
index|]
argument_list|,
operator|(
name|int
operator|)
name|psa
index|[
literal|2
index|]
argument_list|,
operator|(
name|int
operator|)
name|psa
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Waitstates            : %d\n"
argument_list|,
name|psa
index|[
literal|7
index|]
operator|&
literal|0xf
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Bus mode              : %s\n"
argument_list|,
operator|(
name|psa
index|[
literal|7
index|]
operator|&
literal|0x10
operator|)
condition|?
literal|"EISA"
else|:
literal|"ISA"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"IRQ                   : %d\n"
argument_list|,
name|wlirq
argument_list|(
name|psa
index|[
literal|8
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
name|printf
argument_list|(
literal|"Default MAC address   : %02x:%02x:%02x:%02x:%02x:%02x\n"
argument_list|,
name|psa
index|[
literal|0x10
index|]
argument_list|,
name|psa
index|[
literal|0x11
index|]
argument_list|,
name|psa
index|[
literal|0x12
index|]
argument_list|,
name|psa
index|[
literal|0x13
index|]
argument_list|,
name|psa
index|[
literal|0x14
index|]
argument_list|,
name|psa
index|[
literal|0x15
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Soft MAC address      : %02x:%02x:%02x:%02x:%02x:%02x\n"
argument_list|,
name|psa
index|[
literal|0x16
index|]
argument_list|,
name|psa
index|[
literal|0x17
index|]
argument_list|,
name|psa
index|[
literal|0x18
index|]
argument_list|,
name|psa
index|[
literal|0x19
index|]
argument_list|,
name|psa
index|[
literal|0x1a
index|]
argument_list|,
name|psa
index|[
literal|0x1b
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Current MAC address   : %s\n"
argument_list|,
operator|(
name|psa
index|[
literal|0x1c
index|]
operator|&
literal|0x1
operator|)
condition|?
literal|"Soft"
else|:
literal|"Default"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Adapter compatability : "
argument_list|)
expr_stmt|;
if|if
condition|(
name|psa
index|[
literal|0x1d
index|]
operator|<
literal|5
condition|)
block|{
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|compat_type
index|[
name|psa
index|[
literal|0x1d
index|]
index|]
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"unknown\n"
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Threshold preset      : %d\n"
argument_list|,
name|psa
index|[
literal|0x1e
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Call code required    : %s\n"
argument_list|,
operator|(
name|psa
index|[
literal|0x1f
index|]
operator|&
literal|0x1
operator|)
condition|?
literal|"YES"
else|:
literal|"NO"
argument_list|)
expr_stmt|;
if|if
condition|(
name|psa
index|[
literal|0x1f
index|]
operator|&
literal|0x1
condition|)
name|printf
argument_list|(
literal|"Call code             : 0x%02x%02x%02x%02x%02x%02x%02x%02x\n"
argument_list|,
name|psa
index|[
literal|0x30
index|]
argument_list|,
name|psa
index|[
literal|0x31
index|]
argument_list|,
name|psa
index|[
literal|0x32
index|]
argument_list|,
name|psa
index|[
literal|0x33
index|]
argument_list|,
name|psa
index|[
literal|0x34
index|]
argument_list|,
name|psa
index|[
literal|0x35
index|]
argument_list|,
name|psa
index|[
literal|0x36
index|]
argument_list|,
name|psa
index|[
literal|0x37
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Subband               : %s\n"
argument_list|,
name|subband
index|[
name|psa
index|[
literal|0x20
index|]
operator|&
literal|0xf
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Quality threshold     : %d\n"
argument_list|,
name|psa
index|[
literal|0x21
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Hardware version      : %d (%s)\n"
argument_list|,
name|psa
index|[
literal|0x22
index|]
argument_list|,
name|psa
index|[
literal|0x22
index|]
condition|?
literal|"Rel3"
else|:
literal|"Rel1/Rel2"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Network ID enable     : %s\n"
argument_list|,
operator|(
name|psa
index|[
literal|0x25
index|]
operator|&
literal|0x1
operator|)
condition|?
literal|"YES"
else|:
literal|"NO"
argument_list|)
expr_stmt|;
if|if
condition|(
name|psa
index|[
literal|0x25
index|]
operator|&
literal|0x1
condition|)
block|{
name|nwid
operator|=
operator|(
name|psa
index|[
literal|0x23
index|]
operator|<<
literal|8
operator|)
operator|+
name|psa
index|[
literal|0x24
index|]
expr_stmt|;
name|printf
argument_list|(
literal|"NWID                  : 0x%04x\n"
argument_list|,
name|nwid
argument_list|)
expr_stmt|;
if|if
condition|(
name|nwid
operator|!=
name|currnwid
condition|)
block|{
name|printf
argument_list|(
literal|"Current NWID          : 0x%04x\n"
argument_list|,
name|currnwid
argument_list|)
expr_stmt|;
block|}
block|}
name|printf
argument_list|(
literal|"Datalink security     : %s\n"
argument_list|,
operator|(
name|psa
index|[
literal|0x26
index|]
operator|&
literal|0x1
operator|)
condition|?
literal|"YES"
else|:
literal|"NO"
argument_list|)
expr_stmt|;
if|if
condition|(
name|psa
index|[
literal|0x26
index|]
operator|&
literal|0x1
condition|)
block|{
name|printf
argument_list|(
literal|"Encryption key        : "
argument_list|)
expr_stmt|;
if|if
condition|(
name|psa
index|[
literal|0x27
index|]
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"DENIED\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"0x%02x%02x%02x%02x%02x%02x%02x%02x\n"
argument_list|,
name|psa
index|[
literal|0x27
index|]
argument_list|,
name|psa
index|[
literal|0x28
index|]
argument_list|,
name|psa
index|[
literal|0x29
index|]
argument_list|,
name|psa
index|[
literal|0x2a
index|]
argument_list|,
name|psa
index|[
literal|0x2b
index|]
argument_list|,
name|psa
index|[
literal|0x2c
index|]
argument_list|,
name|psa
index|[
literal|0x2d
index|]
argument_list|,
name|psa
index|[
literal|0x2e
index|]
argument_list|)
expr_stmt|;
block|}
block|}
name|printf
argument_list|(
literal|"Databus width         : %d (%s)\n"
argument_list|,
operator|(
name|psa
index|[
literal|0x2f
index|]
operator|&
literal|0x1
operator|)
condition|?
literal|16
else|:
literal|8
argument_list|,
operator|(
name|psa
index|[
literal|0x2f
index|]
operator|&
literal|0x80
operator|)
condition|?
literal|"fixed"
else|:
literal|"variable"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Configuration state   : %sconfigured\n"
argument_list|,
operator|(
name|psa
index|[
literal|0x38
index|]
operator|&
literal|0x1
operator|)
condition|?
literal|""
else|:
literal|"un"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"CRC-16                : 0x%02x%02x\n"
argument_list|,
name|psa
index|[
literal|0x3e
index|]
argument_list|,
name|psa
index|[
literal|0x3d
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"CRC status            : "
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|psa
index|[
literal|0x3f
index|]
condition|)
block|{
case|case
literal|0xaa
case|:
name|printf
argument_list|(
literal|"OK\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x55
case|:
name|printf
argument_list|(
literal|"BAD\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"Error\n"
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|usage
parameter_list|()
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"usage: wlconfig ifname [param value ...]\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|get_cache
parameter_list|(
name|int
name|sd
parameter_list|,
name|struct
name|ifreq
modifier|*
name|ifr
parameter_list|)
block|{
comment|/* get the cache count */
if|if
condition|(
name|ioctl
argument_list|(
name|sd
argument_list|,
name|SIOCGWLCITEM
argument_list|,
operator|(
name|caddr_t
operator|)
name|ifr
argument_list|)
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"SIOCGWLCITEM - get cache count"
argument_list|)
expr_stmt|;
name|w_sigitems
operator|=
operator|(
name|int
operator|)
name|ifr
operator|->
name|ifr_data
expr_stmt|;
name|ifr
operator|->
name|ifr_data
operator|=
operator|(
name|caddr_t
operator|)
operator|&
name|wsc
expr_stmt|;
comment|/* get the cache */
if|if
condition|(
name|ioctl
argument_list|(
name|sd
argument_list|,
name|SIOCGWLCACHE
argument_list|,
operator|(
name|caddr_t
operator|)
name|ifr
argument_list|)
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"SIOCGWLCACHE - get cache count"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|scale_value
parameter_list|(
name|int
name|value
parameter_list|,
name|int
name|max
parameter_list|)
block|{
name|double
name|dmax
init|=
operator|(
name|double
operator|)
name|max
decl_stmt|;
if|if
condition|(
name|value
operator|>
name|max
condition|)
return|return
operator|(
literal|100
operator|)
return|;
return|return
operator|(
operator|(
name|value
operator|/
name|dmax
operator|)
operator|*
literal|100
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_cache
parameter_list|(
name|int
name|rawFlag
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|signal
decl_stmt|,
name|silence
decl_stmt|,
name|quality
decl_stmt|;
if|if
condition|(
name|rawFlag
condition|)
name|printf
argument_list|(
literal|"signal range 0..63: silence 0..63: quality 0..15\n"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"signal range 0..100: silence 0..100: quality 0..100\n"
argument_list|)
expr_stmt|;
comment|/* after you read it, loop through structure,i.e. wsc          * print each item: 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|w_sigitems
condition|;
name|i
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"[%d:%d]>\n"
argument_list|,
name|i
operator|+
literal|1
argument_list|,
name|w_sigitems
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tip: %d.%d.%d.%d,"
argument_list|,
operator|(
operator|(
name|wsc
index|[
name|i
index|]
operator|.
name|ipsrc
operator|>>
literal|0
operator|)
operator|&
literal|0xff
operator|)
argument_list|,
operator|(
operator|(
name|wsc
index|[
name|i
index|]
operator|.
name|ipsrc
operator|>>
literal|8
operator|)
operator|&
literal|0xff
operator|)
argument_list|,
operator|(
operator|(
name|wsc
index|[
name|i
index|]
operator|.
name|ipsrc
operator|>>
literal|16
operator|)
operator|&
literal|0xff
operator|)
argument_list|,
operator|(
operator|(
name|wsc
index|[
name|i
index|]
operator|.
name|ipsrc
operator|>>
literal|24
operator|)
operator|&
literal|0xff
operator|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" mac: %02x:%02x:%02x:%02x:%02x:%02x\n"
argument_list|,
name|wsc
index|[
name|i
index|]
operator|.
name|macsrc
index|[
literal|0
index|]
operator|&
literal|0xff
argument_list|,
name|wsc
index|[
name|i
index|]
operator|.
name|macsrc
index|[
literal|1
index|]
operator|&
literal|0xff
argument_list|,
name|wsc
index|[
name|i
index|]
operator|.
name|macsrc
index|[
literal|2
index|]
operator|&
literal|0xff
argument_list|,
name|wsc
index|[
name|i
index|]
operator|.
name|macsrc
index|[
literal|3
index|]
operator|&
literal|0xff
argument_list|,
name|wsc
index|[
name|i
index|]
operator|.
name|macsrc
index|[
literal|4
index|]
operator|&
literal|0xff
argument_list|,
name|wsc
index|[
name|i
index|]
operator|.
name|macsrc
index|[
literal|5
index|]
operator|&
literal|0xff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rawFlag
condition|)
block|{
name|signal
operator|=
name|wsc
index|[
name|i
index|]
operator|.
name|signal
expr_stmt|;
name|silence
operator|=
name|wsc
index|[
name|i
index|]
operator|.
name|silence
expr_stmt|;
name|quality
operator|=
name|wsc
index|[
name|i
index|]
operator|.
name|quality
expr_stmt|;
block|}
else|else
block|{
name|signal
operator|=
name|scale_value
argument_list|(
name|wsc
index|[
name|i
index|]
operator|.
name|signal
argument_list|,
literal|63
argument_list|)
expr_stmt|;
name|silence
operator|=
name|scale_value
argument_list|(
name|wsc
index|[
name|i
index|]
operator|.
name|silence
argument_list|,
literal|63
argument_list|)
expr_stmt|;
name|quality
operator|=
name|scale_value
argument_list|(
name|wsc
index|[
name|i
index|]
operator|.
name|quality
argument_list|,
literal|15
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\tsignal: %d, silence: %d, quality: %d, "
argument_list|,
name|signal
argument_list|,
name|silence
argument_list|,
name|quality
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"snr: %d\n"
argument_list|,
name|signal
operator|-
name|silence
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_define
define|#
directive|define
name|raw_cache
parameter_list|()
value|dump_cache(1)
end_define

begin_define
define|#
directive|define
name|scale_cache
parameter_list|()
value|dump_cache(0)
end_define

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|int
name|sd
decl_stmt|;
name|struct
name|ifreq
name|ifr
decl_stmt|;
name|u_char
name|psabuf
index|[
literal|0x40
index|]
decl_stmt|;
name|int
name|val
decl_stmt|,
name|argind
decl_stmt|,
name|i
decl_stmt|;
name|char
modifier|*
name|cp
decl_stmt|,
modifier|*
name|param
decl_stmt|,
modifier|*
name|value
decl_stmt|;
name|struct
name|ether_addr
modifier|*
name|ea
decl_stmt|;
name|int
name|work
init|=
literal|0
decl_stmt|;
name|int
name|currnwid
decl_stmt|;
if|if
condition|(
operator|(
name|argc
operator|<
literal|2
operator|)
operator|||
operator|(
name|argc
operator|%
literal|2
operator|)
condition|)
name|usage
argument_list|()
expr_stmt|;
comment|/* get a socket */
name|sd
operator|=
name|socket
argument_list|(
name|AF_INET
argument_list|,
name|SOCK_DGRAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|sd
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"socket"
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|)
argument_list|)
expr_stmt|;
name|ifr
operator|.
name|ifr_addr
operator|.
name|sa_family
operator|=
name|AF_INET
expr_stmt|;
comment|/* get the PSA */
name|ifr
operator|.
name|ifr_data
operator|=
operator|(
name|caddr_t
operator|)
name|psabuf
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|sd
argument_list|,
name|SIOCGWLPSA
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|ifr
argument_list|)
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"get PSA"
argument_list|)
expr_stmt|;
comment|/* get the current NWID */
if|if
condition|(
name|ioctl
argument_list|(
name|sd
argument_list|,
name|SIOCGWLCNWID
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|ifr
argument_list|)
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"get NWID"
argument_list|)
expr_stmt|;
name|currnwid
operator|=
operator|(
name|int
operator|)
name|ifr
operator|.
name|ifr_data
expr_stmt|;
comment|/* just dump and exit? */
if|if
condition|(
name|argc
operator|==
literal|2
condition|)
block|{
name|print_psa
argument_list|(
name|psabuf
argument_list|,
name|currnwid
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
comment|/* loop reading arg pairs */
for|for
control|(
name|argind
operator|=
literal|2
init|;
name|argind
operator|<
name|argc
condition|;
name|argind
operator|+=
literal|2
control|)
block|{
name|param
operator|=
name|argv
index|[
name|argind
index|]
expr_stmt|;
name|value
operator|=
name|argv
index|[
name|argind
operator|+
literal|1
index|]
expr_stmt|;
comment|/* What to do? */
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
name|param
argument_list|,
literal|"currnwid"
argument_list|)
condition|)
block|{
comment|/* set current NWID */
name|val
operator|=
name|strtol
argument_list|(
name|value
argument_list|,
operator|&
name|cp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|val
operator|<
literal|0
operator|)
operator|||
operator|(
name|val
operator|>
literal|0xffff
operator|)
operator|||
operator|(
name|cp
operator|==
name|value
operator|)
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"bad NWID '%s'"
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|ifr
operator|.
name|ifr_data
operator|=
operator|(
name|caddr_t
operator|)
name|val
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|sd
argument_list|,
name|SIOCSWLCNWID
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|ifr
argument_list|)
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"set NWID (interface not up?)"
argument_list|)
expr_stmt|;
continue|continue ;
block|}
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
name|param
argument_list|,
literal|"irq"
argument_list|)
condition|)
block|{
name|val
operator|=
name|strtol
argument_list|(
name|value
argument_list|,
operator|&
name|cp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|val
operator|=
name|irqvals
index|[
name|val
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|val
operator|==
literal|0
operator|)
operator|||
operator|(
name|cp
operator|==
name|value
operator|)
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"bad IRQ '%s'"
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|psabuf
index|[
name|WLPSA_IRQNO
index|]
operator|=
operator|(
name|u_char
operator|)
name|val
expr_stmt|;
name|work
operator|=
literal|1
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
name|param
argument_list|,
literal|"mac"
argument_list|)
condition|)
block|{
if|if
condition|(
operator|(
name|ea
operator|=
name|ether_aton
argument_list|(
name|value
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"bad ethernet address '%s'"
argument_list|,
name|value
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|6
condition|;
name|i
operator|++
control|)
name|psabuf
index|[
name|WLPSA_LOCALMAC
operator|+
name|i
index|]
operator|=
name|ea
operator|->
name|octet
index|[
name|i
index|]
expr_stmt|;
name|work
operator|=
literal|1
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
name|param
argument_list|,
literal|"macsel"
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
name|value
argument_list|,
literal|"local"
argument_list|)
condition|)
block|{
name|psabuf
index|[
name|WLPSA_MACSEL
index|]
operator||=
literal|0x1
expr_stmt|;
name|work
operator|=
literal|1
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
name|value
argument_list|,
literal|"universal"
argument_list|)
condition|)
block|{
name|psabuf
index|[
name|WLPSA_MACSEL
index|]
operator|&=
operator|~
literal|0x1
expr_stmt|;
name|work
operator|=
literal|1
expr_stmt|;
continue|continue;
block|}
name|errx
argument_list|(
literal|1
argument_list|,
literal|"bad macsel value '%s'"
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
name|param
argument_list|,
literal|"nwid"
argument_list|)
condition|)
block|{
name|val
operator|=
name|strtol
argument_list|(
name|value
argument_list|,
operator|&
name|cp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|val
operator|<
literal|0
operator|)
operator|||
operator|(
name|val
operator|>
literal|0xffff
operator|)
operator|||
operator|(
name|cp
operator|==
name|value
operator|)
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"bad NWID '%s'"
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|psabuf
index|[
name|WLPSA_NWID
index|]
operator|=
operator|(
name|val
operator|>>
literal|8
operator|)
operator|&
literal|0xff
expr_stmt|;
name|psabuf
index|[
name|WLPSA_NWID
operator|+
literal|1
index|]
operator|=
name|val
operator|&
literal|0xff
expr_stmt|;
name|work
operator|=
literal|1
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
name|param
argument_list|,
literal|"cache"
argument_list|)
condition|)
block|{
comment|/* raw cache dump 	    */
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
name|value
argument_list|,
literal|"raw"
argument_list|)
condition|)
block|{
name|get_cache
argument_list|(
name|sd
argument_list|,
operator|&
name|ifr
argument_list|)
expr_stmt|;
name|raw_cache
argument_list|()
expr_stmt|;
continue|continue;
block|}
comment|/* scaled cache dump 	    */
elseif|else
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
name|value
argument_list|,
literal|"scale"
argument_list|)
condition|)
block|{
name|get_cache
argument_list|(
name|sd
argument_list|,
operator|&
name|ifr
argument_list|)
expr_stmt|;
name|scale_cache
argument_list|()
expr_stmt|;
continue|continue;
block|}
comment|/* zero out cache 	    */
elseif|else
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
name|value
argument_list|,
literal|"zero"
argument_list|)
condition|)
block|{
if|if
condition|(
name|ioctl
argument_list|(
name|sd
argument_list|,
name|SIOCDWLCACHE
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|ifr
argument_list|)
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"zero cache"
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|errx
argument_list|(
literal|1
argument_list|,
literal|"unknown value '%s'"
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
name|errx
argument_list|(
literal|1
argument_list|,
literal|"unknown parameter '%s'"
argument_list|,
name|param
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|work
condition|)
block|{
name|ifr
operator|.
name|ifr_data
operator|=
operator|(
name|caddr_t
operator|)
name|psabuf
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|sd
argument_list|,
name|SIOCSWLPSA
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|ifr
argument_list|)
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"set PSA"
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


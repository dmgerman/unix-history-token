begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
specifier|const
name|char
name|rcsid
index|[]
init|=
literal|"$FreeBSD$"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* not lint */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<rpc/rpc.h>
end_include

begin_include
include|#
directive|include
file|<rpcsvc/sm_inter.h>
end_include

begin_comment
comment|/* Default timeout can be changed using clnt_control() */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|timeval
name|TIMEOUT
init|=
block|{
literal|25
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|struct
name|sm_stat_res
modifier|*
name|sm_stat_1
parameter_list|(
name|argp
parameter_list|,
name|clnt
parameter_list|)
name|struct
name|sm_name
modifier|*
name|argp
decl_stmt|;
name|CLIENT
modifier|*
name|clnt
decl_stmt|;
block|{
specifier|static
name|struct
name|sm_stat_res
name|res
decl_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|res
argument_list|,
sizeof|sizeof
argument_list|(
name|res
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|clnt_call
argument_list|(
name|clnt
argument_list|,
name|SM_STAT
argument_list|,
name|xdr_sm_name
argument_list|,
name|argp
argument_list|,
name|xdr_sm_stat_res
argument_list|,
operator|&
name|res
argument_list|,
name|TIMEOUT
argument_list|)
operator|!=
name|RPC_SUCCESS
condition|)
block|{
return|return
operator|(
name|NULL
operator|)
return|;
block|}
return|return
operator|(
operator|&
name|res
operator|)
return|;
block|}
end_function

begin_function
name|struct
name|sm_stat_res
modifier|*
name|sm_mon_1
parameter_list|(
name|argp
parameter_list|,
name|clnt
parameter_list|)
name|struct
name|mon
modifier|*
name|argp
decl_stmt|;
name|CLIENT
modifier|*
name|clnt
decl_stmt|;
block|{
specifier|static
name|struct
name|sm_stat_res
name|res
decl_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|res
argument_list|,
sizeof|sizeof
argument_list|(
name|res
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|clnt_call
argument_list|(
name|clnt
argument_list|,
name|SM_MON
argument_list|,
name|xdr_mon
argument_list|,
name|argp
argument_list|,
name|xdr_sm_stat_res
argument_list|,
operator|&
name|res
argument_list|,
name|TIMEOUT
argument_list|)
operator|!=
name|RPC_SUCCESS
condition|)
block|{
return|return
operator|(
name|NULL
operator|)
return|;
block|}
return|return
operator|(
operator|&
name|res
operator|)
return|;
block|}
end_function

begin_function
name|struct
name|sm_stat
modifier|*
name|sm_unmon_1
parameter_list|(
name|argp
parameter_list|,
name|clnt
parameter_list|)
name|struct
name|mon_id
modifier|*
name|argp
decl_stmt|;
name|CLIENT
modifier|*
name|clnt
decl_stmt|;
block|{
specifier|static
name|struct
name|sm_stat
name|res
decl_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|res
argument_list|,
sizeof|sizeof
argument_list|(
name|res
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|clnt_call
argument_list|(
name|clnt
argument_list|,
name|SM_UNMON
argument_list|,
name|xdr_mon_id
argument_list|,
name|argp
argument_list|,
name|xdr_sm_stat
argument_list|,
operator|&
name|res
argument_list|,
name|TIMEOUT
argument_list|)
operator|!=
name|RPC_SUCCESS
condition|)
block|{
return|return
operator|(
name|NULL
operator|)
return|;
block|}
return|return
operator|(
operator|&
name|res
operator|)
return|;
block|}
end_function

begin_function
name|struct
name|sm_stat
modifier|*
name|sm_unmon_all_1
parameter_list|(
name|argp
parameter_list|,
name|clnt
parameter_list|)
name|struct
name|my_id
modifier|*
name|argp
decl_stmt|;
name|CLIENT
modifier|*
name|clnt
decl_stmt|;
block|{
specifier|static
name|struct
name|sm_stat
name|res
decl_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|res
argument_list|,
sizeof|sizeof
argument_list|(
name|res
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|clnt_call
argument_list|(
name|clnt
argument_list|,
name|SM_UNMON_ALL
argument_list|,
name|xdr_my_id
argument_list|,
name|argp
argument_list|,
name|xdr_sm_stat
argument_list|,
operator|&
name|res
argument_list|,
name|TIMEOUT
argument_list|)
operator|!=
name|RPC_SUCCESS
condition|)
block|{
return|return
operator|(
name|NULL
operator|)
return|;
block|}
return|return
operator|(
operator|&
name|res
operator|)
return|;
block|}
end_function

begin_function
name|void
modifier|*
name|sm_simu_crash_1
parameter_list|(
name|argp
parameter_list|,
name|clnt
parameter_list|)
name|void
modifier|*
name|argp
decl_stmt|;
name|CLIENT
modifier|*
name|clnt
decl_stmt|;
block|{
specifier|static
name|char
name|res
decl_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|res
argument_list|,
sizeof|sizeof
argument_list|(
name|res
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|clnt_call
argument_list|(
name|clnt
argument_list|,
name|SM_SIMU_CRASH
argument_list|,
name|xdr_void
argument_list|,
name|argp
argument_list|,
name|xdr_void
argument_list|,
operator|&
name|res
argument_list|,
name|TIMEOUT
argument_list|)
operator|!=
name|RPC_SUCCESS
condition|)
block|{
return|return
operator|(
name|NULL
operator|)
return|;
block|}
return|return
operator|(
operator|(
name|void
operator|*
operator|)
operator|&
name|res
operator|)
return|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|CLIENT
modifier|*
name|cli
decl_stmt|;
name|char
name|dummy
decl_stmt|;
name|void
modifier|*
name|out
decl_stmt|;
name|struct
name|mon
name|mon
decl_stmt|;
if|if
condition|(
name|argc
operator|<
literal|2
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"usage: test<hostname> | crash\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"always talks to statd at localhost\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Creating client for localhost\n"
argument_list|)
expr_stmt|;
name|cli
operator|=
name|clnt_create
argument_list|(
literal|"localhost"
argument_list|,
name|SM_PROG
argument_list|,
name|SM_VERS
argument_list|,
literal|"udp"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cli
condition|)
block|{
name|printf
argument_list|(
literal|"Failed to create client\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|mon
operator|.
name|mon_id
operator|.
name|mon_name
operator|=
name|argv
index|[
literal|1
index|]
expr_stmt|;
name|mon
operator|.
name|mon_id
operator|.
name|my_id
operator|.
name|my_name
operator|=
name|argv
index|[
literal|1
index|]
expr_stmt|;
name|mon
operator|.
name|mon_id
operator|.
name|my_id
operator|.
name|my_prog
operator|=
name|SM_PROG
expr_stmt|;
name|mon
operator|.
name|mon_id
operator|.
name|my_id
operator|.
name|my_vers
operator|=
name|SM_VERS
expr_stmt|;
name|mon
operator|.
name|mon_id
operator|.
name|my_id
operator|.
name|my_proc
operator|=
literal|1
expr_stmt|;
comment|/* have it call sm_stat() !!!	*/
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
literal|"crash"
argument_list|)
condition|)
block|{
comment|/* Hostname given		*/
name|struct
name|sm_stat_res
modifier|*
name|res
decl_stmt|;
if|if
condition|(
name|res
operator|=
name|sm_mon_1
argument_list|(
operator|&
name|mon
argument_list|,
name|cli
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Success!\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"Fail\n"
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|out
operator|=
name|sm_simu_crash_1
argument_list|(
operator|&
name|dummy
argument_list|,
name|cli
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Success!\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"Fail\n"
argument_list|)
expr_stmt|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	$FreeBSD$	*/
end_comment

begin_comment
comment|/*	$KAME: test-pfkey.c,v 1.4 2000/06/07 00:29:14 itojun Exp $	*/
end_comment

begin_comment
comment|/*  * Copyright (C) 1995, 1996, 1997, 1998, and 1999 WIDE Project.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. Neither the name of the project nor the names of its contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE PROJECT AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE PROJECT OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<net/route.h>
end_include

begin_include
include|#
directive|include
file|<net/pfkeyv2.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netkey/keydb.h>
end_include

begin_include
include|#
directive|include
file|<netkey/key_var.h>
end_include

begin_include
include|#
directive|include
file|<netkey/key_debug.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<limits.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_decl_stmt
name|u_char
name|m_buf
index|[
name|BUFSIZ
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_int
name|m_len
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|pname
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|Usage
name|__P
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|sendkeymsg
name|__P
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|key_setsadbmsg
name|__P
argument_list|(
operator|(
name|u_int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|key_setsadbsens
name|__P
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|key_setsadbprop
name|__P
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|key_setsadbid
name|__P
argument_list|(
operator|(
name|u_int
operator|,
name|caddr_t
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|key_setsadblft
name|__P
argument_list|(
operator|(
name|u_int
operator|,
name|u_int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|key_setspirange
name|__P
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|key_setsadbkey
name|__P
argument_list|(
operator|(
name|u_int
operator|,
name|caddr_t
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|key_setsadbsa
name|__P
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|key_setsadbaddr
name|__P
argument_list|(
operator|(
name|u_int
operator|,
name|u_int
operator|,
name|caddr_t
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|key_setsadbextbuf
name|__P
argument_list|(
operator|(
name|caddr_t
operator|,
name|int
operator|,
name|caddr_t
operator|,
name|int
operator|,
name|caddr_t
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|Usage
parameter_list|()
block|{
name|printf
argument_list|(
literal|"Usage:\t%s number\n"
argument_list|,
name|pname
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|ac
parameter_list|,
name|av
parameter_list|)
name|int
name|ac
decl_stmt|;
name|char
modifier|*
modifier|*
name|av
decl_stmt|;
block|{
name|pname
operator|=
operator|*
name|av
expr_stmt|;
if|if
condition|(
name|ac
operator|==
literal|1
condition|)
name|Usage
argument_list|()
expr_stmt|;
name|key_setsadbmsg
argument_list|(
name|atoi
argument_list|(
operator|*
operator|(
name|av
operator|+
literal|1
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|sendkeymsg
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* %%% */
end_comment

begin_function
name|int
name|sendkeymsg
parameter_list|()
block|{
name|u_char
name|rbuf
index|[
literal|1024
operator|*
literal|32
index|]
decl_stmt|;
comment|/* XXX: Enough ? Should I do MSG_PEEK ? */
name|int
name|so
decl_stmt|,
name|len
decl_stmt|;
if|if
condition|(
operator|(
name|so
operator|=
name|socket
argument_list|(
name|PF_KEY
argument_list|,
name|SOCK_RAW
argument_list|,
name|PF_KEY_V2
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"socket(PF_KEY)"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
if|#
directive|if
literal|0
block|{
include|#
directive|include
file|<sys/time.h>
block|struct timeval tv; 	tv.tv_sec = 1; 	tv.tv_usec = 0; 	if (setsockopt(so, SOL_SOCKET, SO_RCVTIMEO,&tv, sizeof(tv))< 0) { 		perror("setsockopt"); 		goto end; 	}     }
endif|#
directive|endif
name|pfkey_sadump
argument_list|(
operator|(
expr|struct
name|sadb_msg
operator|*
operator|)
name|m_buf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|len
operator|=
name|send
argument_list|(
name|so
argument_list|,
name|m_buf
argument_list|,
name|m_len
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"send"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
if|if
condition|(
operator|(
name|len
operator|=
name|recv
argument_list|(
name|so
argument_list|,
name|rbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|rbuf
argument_list|)
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"recv"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
name|pfkey_sadump
argument_list|(
operator|(
expr|struct
name|sadb_msg
operator|*
operator|)
name|rbuf
argument_list|)
expr_stmt|;
name|end
label|:
operator|(
name|void
operator|)
name|close
argument_list|(
name|so
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|void
name|key_setsadbmsg
parameter_list|(
name|type
parameter_list|)
name|u_int
name|type
decl_stmt|;
block|{
name|struct
name|sadb_msg
name|m_msg
decl_stmt|;
name|memset
argument_list|(
operator|&
name|m_msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|m_msg
argument_list|)
argument_list|)
expr_stmt|;
name|m_msg
operator|.
name|sadb_msg_version
operator|=
name|PF_KEY_V2
expr_stmt|;
name|m_msg
operator|.
name|sadb_msg_type
operator|=
name|type
expr_stmt|;
name|m_msg
operator|.
name|sadb_msg_errno
operator|=
literal|0
expr_stmt|;
name|m_msg
operator|.
name|sadb_msg_satype
operator|=
name|SADB_SATYPE_ESP
expr_stmt|;
if|#
directive|if
literal|0
block|m_msg.sadb_msg_reserved = 0;
endif|#
directive|endif
name|m_msg
operator|.
name|sadb_msg_seq
operator|=
literal|0
expr_stmt|;
name|m_msg
operator|.
name|sadb_msg_pid
operator|=
name|getpid
argument_list|()
expr_stmt|;
name|m_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sadb_msg
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|m_buf
argument_list|,
operator|&
name|m_msg
argument_list|,
name|m_len
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|SADB_GETSPI
case|:
comment|/*<base, address(SD), SPI range>*/
name|key_setsadbaddr
argument_list|(
name|SADB_EXT_ADDRESS_SRC
argument_list|,
name|AF_INET
argument_list|,
literal|"10.0.3.4"
argument_list|)
expr_stmt|;
name|key_setsadbaddr
argument_list|(
name|SADB_EXT_ADDRESS_DST
argument_list|,
name|AF_INET
argument_list|,
literal|"127.0.0.1"
argument_list|)
expr_stmt|;
name|key_setspirange
argument_list|()
expr_stmt|;
comment|/*<base, SA(*), address(SD)>*/
break|break;
case|case
name|SADB_ADD
case|:
comment|/*<base, SA, (lifetime(HSC),) address(SD), (address(P),) 		   key(AE), (identity(SD),) (sensitivity)> */
name|key_setsadbaddr
argument_list|(
name|SADB_EXT_ADDRESS_PROXY
argument_list|,
name|AF_INET6
argument_list|,
literal|"3ffe::1"
argument_list|)
expr_stmt|;
case|case
name|SADB_UPDATE
case|:
name|key_setsadbsa
argument_list|()
expr_stmt|;
name|key_setsadblft
argument_list|(
name|SADB_EXT_LIFETIME_HARD
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|key_setsadblft
argument_list|(
name|SADB_EXT_LIFETIME_SOFT
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|key_setsadbaddr
argument_list|(
name|SADB_EXT_ADDRESS_SRC
argument_list|,
name|AF_INET
argument_list|,
literal|"192.168.1.1"
argument_list|)
expr_stmt|;
name|key_setsadbaddr
argument_list|(
name|SADB_EXT_ADDRESS_DST
argument_list|,
name|AF_INET
argument_list|,
literal|"10.0.3.4"
argument_list|)
expr_stmt|;
comment|/* XXX key_setsadbkey(SADB_EXT_KEY_AUTH, "abcde"); */
name|key_setsadbkey
argument_list|(
name|SADB_EXT_KEY_AUTH
argument_list|,
literal|"1234567812345678"
argument_list|)
expr_stmt|;
name|key_setsadbkey
argument_list|(
name|SADB_EXT_KEY_ENCRYPT
argument_list|,
literal|"12345678"
argument_list|)
expr_stmt|;
name|key_setsadbid
argument_list|(
name|SADB_EXT_IDENTITY_SRC
argument_list|,
literal|"hoge1234@hoge.com"
argument_list|)
expr_stmt|;
name|key_setsadbid
argument_list|(
name|SADB_EXT_IDENTITY_DST
argument_list|,
literal|"hage5678@hage.net"
argument_list|)
expr_stmt|;
name|key_setsadbsens
argument_list|()
expr_stmt|;
comment|/*<base, SA, (lifetime(HSC),) address(SD), (address(P),) 		  (identity(SD),) (sensitivity)> */
break|break;
case|case
name|SADB_DELETE
case|:
comment|/*<base, SA(*), address(SDP)> */
name|key_setsadbsa
argument_list|()
expr_stmt|;
name|key_setsadbaddr
argument_list|(
name|SADB_EXT_ADDRESS_SRC
argument_list|,
name|AF_INET
argument_list|,
literal|"192.168.1.1"
argument_list|)
expr_stmt|;
name|key_setsadbaddr
argument_list|(
name|SADB_EXT_ADDRESS_DST
argument_list|,
name|AF_INET
argument_list|,
literal|"10.0.3.4"
argument_list|)
expr_stmt|;
name|key_setsadbaddr
argument_list|(
name|SADB_EXT_ADDRESS_PROXY
argument_list|,
name|AF_INET6
argument_list|,
literal|"3ffe::1"
argument_list|)
expr_stmt|;
comment|/*<base, SA(*), address(SDP)> */
break|break;
case|case
name|SADB_GET
case|:
comment|/*<base, SA(*), address(SDP)> */
name|key_setsadbsa
argument_list|()
expr_stmt|;
name|key_setsadbaddr
argument_list|(
name|SADB_EXT_ADDRESS_SRC
argument_list|,
name|AF_INET
argument_list|,
literal|"192.168.1.1"
argument_list|)
expr_stmt|;
name|key_setsadbaddr
argument_list|(
name|SADB_EXT_ADDRESS_DST
argument_list|,
name|AF_INET
argument_list|,
literal|"10.0.3.4"
argument_list|)
expr_stmt|;
name|key_setsadbaddr
argument_list|(
name|SADB_EXT_ADDRESS_PROXY
argument_list|,
name|AF_INET6
argument_list|,
literal|"3ffe::1"
argument_list|)
expr_stmt|;
comment|/*<base, SA, (lifetime(HSC),) address(SD), (address(P),) 		   key(AE), (identity(SD),) (sensitivity)> */
break|break;
case|case
name|SADB_ACQUIRE
case|:
comment|/*<base, address(SD), (address(P),) (identity(SD),) 		   (sensitivity,) proposal> */
name|key_setsadbaddr
argument_list|(
name|SADB_EXT_ADDRESS_SRC
argument_list|,
name|AF_INET
argument_list|,
literal|"192.168.1.1"
argument_list|)
expr_stmt|;
name|key_setsadbaddr
argument_list|(
name|SADB_EXT_ADDRESS_DST
argument_list|,
name|AF_INET
argument_list|,
literal|"10.0.3.4"
argument_list|)
expr_stmt|;
name|key_setsadbaddr
argument_list|(
name|SADB_EXT_ADDRESS_PROXY
argument_list|,
name|AF_INET6
argument_list|,
literal|"3ffe::1"
argument_list|)
expr_stmt|;
name|key_setsadbid
argument_list|(
name|SADB_EXT_IDENTITY_SRC
argument_list|,
literal|"hoge1234@hoge.com"
argument_list|)
expr_stmt|;
name|key_setsadbid
argument_list|(
name|SADB_EXT_IDENTITY_DST
argument_list|,
literal|"hage5678@hage.net"
argument_list|)
expr_stmt|;
name|key_setsadbsens
argument_list|()
expr_stmt|;
name|key_setsadbprop
argument_list|()
expr_stmt|;
comment|/*<base, address(SD), (address(P),) (identity(SD),) 		   (sensitivity,) proposal> */
break|break;
case|case
name|SADB_REGISTER
case|:
comment|/*<base> */
comment|/*<base, supported> */
break|break;
case|case
name|SADB_EXPIRE
case|:
case|case
name|SADB_FLUSH
case|:
break|break;
case|case
name|SADB_DUMP
case|:
break|break;
case|case
name|SADB_X_PROMISC
case|:
comment|/*<base> */
comment|/*<base, base(, others)> */
break|break;
case|case
name|SADB_X_PCHANGE
case|:
break|break;
comment|/* for SPD management */
case|case
name|SADB_X_SPDFLUSH
case|:
case|case
name|SADB_X_SPDDUMP
case|:
break|break;
case|case
name|SADB_X_SPDADD
case|:
if|#
directive|if
literal|0
block|{ 		struct sadb_x_policy m_policy;  		m_policy.sadb_x_policy_len = PFKEY_UNIT64(sizeof(m_policy)); 		m_policy.sadb_x_policy_exttype = SADB_X_EXT_POLICY; 		m_policy.sadb_x_policy_type = SADB_X_PL_IPSEC; 		m_policy.sadb_x_policy_esp_trans = 1; 		m_policy.sadb_x_policy_ah_trans = 2; 		m_policy.sadb_x_policy_esp_network = 3; 		m_policy.sadb_x_policy_ah_network = 4; 		m_policy.sadb_x_policy_reserved = 0;  		memcpy(m_buf + m_len,&m_policy, sizeof(struct sadb_x_policy)); 		m_len += sizeof(struct sadb_x_policy); 	    }
endif|#
directive|endif
case|case
name|SADB_X_SPDDELETE
case|:
name|key_setsadbaddr
argument_list|(
name|SADB_EXT_ADDRESS_SRC
argument_list|,
name|AF_INET
argument_list|,
literal|"192.168.1.1"
argument_list|)
expr_stmt|;
name|key_setsadbaddr
argument_list|(
name|SADB_EXT_ADDRESS_DST
argument_list|,
name|AF_INET
argument_list|,
literal|"10.0.3.4"
argument_list|)
expr_stmt|;
break|break;
block|}
operator|(
operator|(
expr|struct
name|sadb_msg
operator|*
operator|)
name|m_buf
operator|)
operator|->
name|sadb_msg_len
operator|=
name|PFKEY_UNIT64
argument_list|(
name|m_len
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|void
name|key_setsadbsens
parameter_list|()
block|{
name|struct
name|sadb_sens
name|m_sens
decl_stmt|;
name|u_char
name|buf
index|[
literal|64
index|]
decl_stmt|;
name|u_int
name|s
decl_stmt|,
name|i
decl_stmt|,
name|slen
decl_stmt|,
name|ilen
decl_stmt|,
name|len
decl_stmt|;
comment|/* make sens& integ */
name|s
operator|=
name|htonl
argument_list|(
literal|0x01234567
argument_list|)
expr_stmt|;
name|i
operator|=
name|htonl
argument_list|(
literal|0x89abcdef
argument_list|)
expr_stmt|;
name|slen
operator|=
sizeof|sizeof
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|ilen
operator|=
sizeof|sizeof
argument_list|(
name|i
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|buf
argument_list|,
operator|&
name|s
argument_list|,
name|slen
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|buf
operator|+
name|slen
argument_list|,
operator|&
name|i
argument_list|,
name|ilen
argument_list|)
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
name|m_sens
argument_list|)
operator|+
name|PFKEY_ALIGN8
argument_list|(
name|slen
argument_list|)
operator|+
name|PFKEY_ALIGN8
argument_list|(
name|ilen
argument_list|)
expr_stmt|;
name|m_sens
operator|.
name|sadb_sens_len
operator|=
name|PFKEY_UNIT64
argument_list|(
name|len
argument_list|)
expr_stmt|;
name|m_sens
operator|.
name|sadb_sens_exttype
operator|=
name|SADB_EXT_SENSITIVITY
expr_stmt|;
name|m_sens
operator|.
name|sadb_sens_dpd
operator|=
literal|1
expr_stmt|;
name|m_sens
operator|.
name|sadb_sens_sens_level
operator|=
literal|2
expr_stmt|;
name|m_sens
operator|.
name|sadb_sens_sens_len
operator|=
name|PFKEY_ALIGN8
argument_list|(
name|slen
argument_list|)
expr_stmt|;
name|m_sens
operator|.
name|sadb_sens_integ_level
operator|=
literal|3
expr_stmt|;
name|m_sens
operator|.
name|sadb_sens_integ_len
operator|=
name|PFKEY_ALIGN8
argument_list|(
name|ilen
argument_list|)
expr_stmt|;
name|m_sens
operator|.
name|sadb_sens_reserved
operator|=
literal|0
expr_stmt|;
name|key_setsadbextbuf
argument_list|(
name|m_buf
argument_list|,
name|m_len
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|m_sens
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sadb_sens
argument_list|)
argument_list|,
name|buf
argument_list|,
name|slen
operator|+
name|ilen
argument_list|)
expr_stmt|;
name|m_len
operator|+=
name|len
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|void
name|key_setsadbprop
parameter_list|()
block|{
name|struct
name|sadb_prop
name|m_prop
decl_stmt|;
name|struct
name|sadb_comb
modifier|*
name|m_comb
decl_stmt|;
name|u_char
name|buf
index|[
literal|256
index|]
decl_stmt|;
name|u_int
name|len
init|=
sizeof|sizeof
argument_list|(
name|m_prop
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|m_comb
argument_list|)
operator|*
literal|2
decl_stmt|;
comment|/* make prop& comb */
name|m_prop
operator|.
name|sadb_prop_len
operator|=
name|PFKEY_UNIT64
argument_list|(
name|len
argument_list|)
expr_stmt|;
name|m_prop
operator|.
name|sadb_prop_exttype
operator|=
name|SADB_EXT_PROPOSAL
expr_stmt|;
name|m_prop
operator|.
name|sadb_prop_replay
operator|=
literal|0
expr_stmt|;
name|m_prop
operator|.
name|sadb_prop_reserved
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|m_prop
operator|.
name|sadb_prop_reserved
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|m_prop
operator|.
name|sadb_prop_reserved
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
comment|/* the 1st is ESP DES-CBC HMAC-MD5 */
name|m_comb
operator|=
operator|(
expr|struct
name|sadb_comb
operator|*
operator|)
name|buf
expr_stmt|;
name|m_comb
operator|->
name|sadb_comb_auth
operator|=
name|SADB_AALG_MD5HMAC
expr_stmt|;
name|m_comb
operator|->
name|sadb_comb_encrypt
operator|=
name|SADB_EALG_DESCBC
expr_stmt|;
name|m_comb
operator|->
name|sadb_comb_flags
operator|=
literal|0
expr_stmt|;
name|m_comb
operator|->
name|sadb_comb_auth_minbits
operator|=
literal|8
expr_stmt|;
name|m_comb
operator|->
name|sadb_comb_auth_maxbits
operator|=
literal|96
expr_stmt|;
name|m_comb
operator|->
name|sadb_comb_encrypt_minbits
operator|=
literal|64
expr_stmt|;
name|m_comb
operator|->
name|sadb_comb_encrypt_maxbits
operator|=
literal|64
expr_stmt|;
name|m_comb
operator|->
name|sadb_comb_reserved
operator|=
literal|0
expr_stmt|;
name|m_comb
operator|->
name|sadb_comb_soft_allocations
operator|=
literal|0
expr_stmt|;
name|m_comb
operator|->
name|sadb_comb_hard_allocations
operator|=
literal|0
expr_stmt|;
name|m_comb
operator|->
name|sadb_comb_soft_bytes
operator|=
literal|0
expr_stmt|;
name|m_comb
operator|->
name|sadb_comb_hard_bytes
operator|=
literal|0
expr_stmt|;
name|m_comb
operator|->
name|sadb_comb_soft_addtime
operator|=
literal|0
expr_stmt|;
name|m_comb
operator|->
name|sadb_comb_hard_addtime
operator|=
literal|0
expr_stmt|;
name|m_comb
operator|->
name|sadb_comb_soft_usetime
operator|=
literal|0
expr_stmt|;
name|m_comb
operator|->
name|sadb_comb_hard_usetime
operator|=
literal|0
expr_stmt|;
comment|/* the 2st is ESP 3DES-CBC and AH HMAC-SHA1 */
name|m_comb
operator|=
operator|(
expr|struct
name|sadb_comb
operator|*
operator|)
operator|(
name|buf
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|m_comb
argument_list|)
operator|)
expr_stmt|;
name|m_comb
operator|->
name|sadb_comb_auth
operator|=
name|SADB_AALG_SHA1HMAC
expr_stmt|;
name|m_comb
operator|->
name|sadb_comb_encrypt
operator|=
name|SADB_EALG_3DESCBC
expr_stmt|;
name|m_comb
operator|->
name|sadb_comb_flags
operator|=
literal|0
expr_stmt|;
name|m_comb
operator|->
name|sadb_comb_auth_minbits
operator|=
literal|8
expr_stmt|;
name|m_comb
operator|->
name|sadb_comb_auth_maxbits
operator|=
literal|96
expr_stmt|;
name|m_comb
operator|->
name|sadb_comb_encrypt_minbits
operator|=
literal|64
expr_stmt|;
name|m_comb
operator|->
name|sadb_comb_encrypt_maxbits
operator|=
literal|64
expr_stmt|;
name|m_comb
operator|->
name|sadb_comb_reserved
operator|=
literal|0
expr_stmt|;
name|m_comb
operator|->
name|sadb_comb_soft_allocations
operator|=
literal|0
expr_stmt|;
name|m_comb
operator|->
name|sadb_comb_hard_allocations
operator|=
literal|0
expr_stmt|;
name|m_comb
operator|->
name|sadb_comb_soft_bytes
operator|=
literal|0
expr_stmt|;
name|m_comb
operator|->
name|sadb_comb_hard_bytes
operator|=
literal|0
expr_stmt|;
name|m_comb
operator|->
name|sadb_comb_soft_addtime
operator|=
literal|0
expr_stmt|;
name|m_comb
operator|->
name|sadb_comb_hard_addtime
operator|=
literal|0
expr_stmt|;
name|m_comb
operator|->
name|sadb_comb_soft_usetime
operator|=
literal|0
expr_stmt|;
name|m_comb
operator|->
name|sadb_comb_hard_usetime
operator|=
literal|0
expr_stmt|;
name|key_setsadbextbuf
argument_list|(
name|m_buf
argument_list|,
name|m_len
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|m_prop
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sadb_prop
argument_list|)
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|m_comb
argument_list|)
operator|*
literal|2
argument_list|)
expr_stmt|;
name|m_len
operator|+=
name|len
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|void
name|key_setsadbid
parameter_list|(
name|ext
parameter_list|,
name|str
parameter_list|)
name|u_int
name|ext
decl_stmt|;
name|caddr_t
name|str
decl_stmt|;
block|{
name|struct
name|sadb_ident
name|m_id
decl_stmt|;
name|u_int
name|idlen
init|=
name|strlen
argument_list|(
name|str
argument_list|)
decl_stmt|,
name|len
decl_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
name|m_id
argument_list|)
operator|+
name|PFKEY_ALIGN8
argument_list|(
name|idlen
argument_list|)
expr_stmt|;
name|m_id
operator|.
name|sadb_ident_len
operator|=
name|PFKEY_UNIT64
argument_list|(
name|len
argument_list|)
expr_stmt|;
name|m_id
operator|.
name|sadb_ident_exttype
operator|=
name|ext
expr_stmt|;
name|m_id
operator|.
name|sadb_ident_type
operator|=
name|SADB_IDENTTYPE_USERFQDN
expr_stmt|;
name|m_id
operator|.
name|sadb_ident_reserved
operator|=
literal|0
expr_stmt|;
name|m_id
operator|.
name|sadb_ident_id
operator|=
name|getpid
argument_list|()
expr_stmt|;
name|key_setsadbextbuf
argument_list|(
name|m_buf
argument_list|,
name|m_len
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|m_id
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sadb_ident
argument_list|)
argument_list|,
name|str
argument_list|,
name|idlen
argument_list|)
expr_stmt|;
name|m_len
operator|+=
name|len
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|void
name|key_setsadblft
parameter_list|(
name|ext
parameter_list|,
name|time
parameter_list|)
name|u_int
name|ext
decl_stmt|,
name|time
decl_stmt|;
block|{
name|struct
name|sadb_lifetime
name|m_lft
decl_stmt|;
name|m_lft
operator|.
name|sadb_lifetime_len
operator|=
name|PFKEY_UNIT64
argument_list|(
sizeof|sizeof
argument_list|(
name|m_lft
argument_list|)
argument_list|)
expr_stmt|;
name|m_lft
operator|.
name|sadb_lifetime_exttype
operator|=
name|ext
expr_stmt|;
name|m_lft
operator|.
name|sadb_lifetime_allocations
operator|=
literal|0x2
expr_stmt|;
name|m_lft
operator|.
name|sadb_lifetime_bytes
operator|=
literal|0x1000
expr_stmt|;
name|m_lft
operator|.
name|sadb_lifetime_addtime
operator|=
name|time
expr_stmt|;
name|m_lft
operator|.
name|sadb_lifetime_usetime
operator|=
literal|0x0020
expr_stmt|;
name|memcpy
argument_list|(
name|m_buf
operator|+
name|m_len
argument_list|,
operator|&
name|m_lft
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sadb_lifetime
argument_list|)
argument_list|)
expr_stmt|;
name|m_len
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|sadb_lifetime
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|void
name|key_setspirange
parameter_list|()
block|{
name|struct
name|sadb_spirange
name|m_spi
decl_stmt|;
name|m_spi
operator|.
name|sadb_spirange_len
operator|=
name|PFKEY_UNIT64
argument_list|(
sizeof|sizeof
argument_list|(
name|m_spi
argument_list|)
argument_list|)
expr_stmt|;
name|m_spi
operator|.
name|sadb_spirange_exttype
operator|=
name|SADB_EXT_SPIRANGE
expr_stmt|;
name|m_spi
operator|.
name|sadb_spirange_min
operator|=
literal|0x00001000
expr_stmt|;
name|m_spi
operator|.
name|sadb_spirange_max
operator|=
literal|0x00002000
expr_stmt|;
name|m_spi
operator|.
name|sadb_spirange_reserved
operator|=
literal|0
expr_stmt|;
name|memcpy
argument_list|(
name|m_buf
operator|+
name|m_len
argument_list|,
operator|&
name|m_spi
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sadb_spirange
argument_list|)
argument_list|)
expr_stmt|;
name|m_len
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|sadb_spirange
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|void
name|key_setsadbkey
parameter_list|(
name|ext
parameter_list|,
name|str
parameter_list|)
name|u_int
name|ext
decl_stmt|;
name|caddr_t
name|str
decl_stmt|;
block|{
name|struct
name|sadb_key
name|m_key
decl_stmt|;
name|u_int
name|keylen
init|=
name|strlen
argument_list|(
name|str
argument_list|)
decl_stmt|;
name|u_int
name|len
decl_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sadb_key
argument_list|)
operator|+
name|PFKEY_ALIGN8
argument_list|(
name|keylen
argument_list|)
expr_stmt|;
name|m_key
operator|.
name|sadb_key_len
operator|=
name|PFKEY_UNIT64
argument_list|(
name|len
argument_list|)
expr_stmt|;
name|m_key
operator|.
name|sadb_key_exttype
operator|=
name|ext
expr_stmt|;
name|m_key
operator|.
name|sadb_key_bits
operator|=
name|keylen
operator|*
literal|8
expr_stmt|;
name|m_key
operator|.
name|sadb_key_reserved
operator|=
literal|0
expr_stmt|;
name|key_setsadbextbuf
argument_list|(
name|m_buf
argument_list|,
name|m_len
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|m_key
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sadb_key
argument_list|)
argument_list|,
name|str
argument_list|,
name|keylen
argument_list|)
expr_stmt|;
name|m_len
operator|+=
name|len
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|void
name|key_setsadbsa
parameter_list|()
block|{
name|struct
name|sadb_sa
name|m_sa
decl_stmt|;
name|m_sa
operator|.
name|sadb_sa_len
operator|=
name|PFKEY_UNIT64
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|sadb_sa
argument_list|)
argument_list|)
expr_stmt|;
name|m_sa
operator|.
name|sadb_sa_exttype
operator|=
name|SADB_EXT_SA
expr_stmt|;
name|m_sa
operator|.
name|sadb_sa_spi
operator|=
name|htonl
argument_list|(
literal|0x12345678
argument_list|)
expr_stmt|;
name|m_sa
operator|.
name|sadb_sa_replay
operator|=
literal|4
expr_stmt|;
name|m_sa
operator|.
name|sadb_sa_state
operator|=
literal|0
expr_stmt|;
name|m_sa
operator|.
name|sadb_sa_auth
operator|=
name|SADB_AALG_MD5HMAC
expr_stmt|;
name|m_sa
operator|.
name|sadb_sa_encrypt
operator|=
name|SADB_EALG_DESCBC
expr_stmt|;
name|m_sa
operator|.
name|sadb_sa_flags
operator|=
literal|0
expr_stmt|;
name|memcpy
argument_list|(
name|m_buf
operator|+
name|m_len
argument_list|,
operator|&
name|m_sa
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sadb_sa
argument_list|)
argument_list|)
expr_stmt|;
name|m_len
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|sadb_sa
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|void
name|key_setsadbaddr
parameter_list|(
name|ext
parameter_list|,
name|af
parameter_list|,
name|str
parameter_list|)
name|u_int
name|ext
decl_stmt|,
name|af
decl_stmt|;
name|caddr_t
name|str
decl_stmt|;
block|{
name|struct
name|sadb_address
name|m_addr
decl_stmt|;
name|u_int
name|len
decl_stmt|;
name|struct
name|addrinfo
name|hints
decl_stmt|,
modifier|*
name|res
decl_stmt|;
specifier|const
name|char
modifier|*
name|serv
decl_stmt|;
name|int
name|plen
decl_stmt|;
switch|switch
condition|(
name|af
condition|)
block|{
case|case
name|AF_INET
case|:
name|plen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
operator|<<
literal|3
expr_stmt|;
break|break;
case|case
name|AF_INET6
case|:
name|plen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
operator|<<
literal|3
expr_stmt|;
break|break;
default|default:
comment|/* XXX bark */
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* make sockaddr buffer */
name|memset
argument_list|(
operator|&
name|hints
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|hints
argument_list|)
argument_list|)
expr_stmt|;
name|hints
operator|.
name|ai_family
operator|=
name|af
expr_stmt|;
name|hints
operator|.
name|ai_socktype
operator|=
name|SOCK_DGRAM
expr_stmt|;
comment|/*dummy*/
name|hints
operator|.
name|ai_flags
operator|=
name|AI_NUMERICHOST
expr_stmt|;
name|serv
operator|=
operator|(
name|ext
operator|==
name|SADB_EXT_ADDRESS_PROXY
condition|?
literal|"0"
else|:
literal|"4660"
operator|)
expr_stmt|;
comment|/*0x1234*/
if|if
condition|(
name|getaddrinfo
argument_list|(
name|str
argument_list|,
name|serv
argument_list|,
operator|&
name|hints
argument_list|,
operator|&
name|res
argument_list|)
operator|!=
literal|0
operator|||
name|res
operator|->
name|ai_next
condition|)
block|{
comment|/* XXX bark */
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sadb_address
argument_list|)
operator|+
name|PFKEY_ALIGN8
argument_list|(
name|res
operator|->
name|ai_addrlen
argument_list|)
expr_stmt|;
name|m_addr
operator|.
name|sadb_address_len
operator|=
name|PFKEY_UNIT64
argument_list|(
name|len
argument_list|)
expr_stmt|;
name|m_addr
operator|.
name|sadb_address_exttype
operator|=
name|ext
expr_stmt|;
name|m_addr
operator|.
name|sadb_address_proto
operator|=
operator|(
name|ext
operator|==
name|SADB_EXT_ADDRESS_PROXY
condition|?
literal|0
else|:
name|IPPROTO_TCP
operator|)
expr_stmt|;
name|m_addr
operator|.
name|sadb_address_prefixlen
operator|=
name|plen
expr_stmt|;
name|m_addr
operator|.
name|sadb_address_reserved
operator|=
literal|0
expr_stmt|;
name|key_setsadbextbuf
argument_list|(
name|m_buf
argument_list|,
name|m_len
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|m_addr
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sadb_address
argument_list|)
argument_list|,
operator|(
name|caddr_t
operator|)
name|res
operator|->
name|ai_addr
argument_list|,
name|res
operator|->
name|ai_addrlen
argument_list|)
expr_stmt|;
name|m_len
operator|+=
name|len
expr_stmt|;
name|freeaddrinfo
argument_list|(
name|res
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|void
name|key_setsadbextbuf
parameter_list|(
name|dst
parameter_list|,
name|off
parameter_list|,
name|ebuf
parameter_list|,
name|elen
parameter_list|,
name|vbuf
parameter_list|,
name|vlen
parameter_list|)
name|caddr_t
name|dst
decl_stmt|,
name|ebuf
decl_stmt|,
name|vbuf
decl_stmt|;
name|int
name|off
decl_stmt|,
name|elen
decl_stmt|,
name|vlen
decl_stmt|;
block|{
name|memset
argument_list|(
name|dst
operator|+
name|off
argument_list|,
literal|0
argument_list|,
name|elen
operator|+
name|vlen
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|dst
operator|+
name|off
argument_list|,
operator|(
name|caddr_t
operator|)
name|ebuf
argument_list|,
name|elen
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|dst
operator|+
name|off
operator|+
name|elen
argument_list|,
name|vbuf
argument_list|,
name|vlen
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

end_unit


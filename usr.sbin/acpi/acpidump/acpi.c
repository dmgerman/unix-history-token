begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 1998 Doug Rabson  * Copyright (c) 2000 Mitsuru IWASAKI<iwasaki@FreeBSD.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  *	$FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<sys/wait.h>
end_include

begin_include
include|#
directive|include
file|<assert.h>
end_include

begin_include
include|#
directive|include
file|<err.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<paths.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdint.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|"acpidump.h"
end_include

begin_define
define|#
directive|define
name|BEGIN_COMMENT
value|"/*\n"
end_define

begin_define
define|#
directive|define
name|END_COMMENT
value|" */\n"
end_define

begin_function_decl
specifier|static
name|void
name|acpi_print_string
parameter_list|(
name|char
modifier|*
name|s
parameter_list|,
name|size_t
name|length
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_print_gas
parameter_list|(
name|ACPI_GENERIC_ADDRESS
modifier|*
name|gas
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|acpi_get_fadt_revision
parameter_list|(
name|ACPI_TABLE_FADT
modifier|*
name|fadt
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_handle_fadt
parameter_list|(
name|ACPI_TABLE_HEADER
modifier|*
name|fadt
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_print_cpu
parameter_list|(
name|u_char
name|cpu_id
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_print_cpu_uid
parameter_list|(
name|uint32_t
name|uid
parameter_list|,
name|char
modifier|*
name|uid_string
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_print_local_apic
parameter_list|(
name|uint32_t
name|apic_id
parameter_list|,
name|uint32_t
name|flags
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_print_io_apic
parameter_list|(
name|uint32_t
name|apic_id
parameter_list|,
name|uint32_t
name|int_base
parameter_list|,
name|uint64_t
name|apic_addr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_print_mps_flags
parameter_list|(
name|uint16_t
name|flags
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_print_intr
parameter_list|(
name|uint32_t
name|intr
parameter_list|,
name|uint16_t
name|mps_flags
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_print_local_nmi
parameter_list|(
name|u_int
name|lint
parameter_list|,
name|uint16_t
name|mps_flags
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_print_madt
parameter_list|(
name|ACPI_SUBTABLE_HEADER
modifier|*
name|mp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_handle_madt
parameter_list|(
name|ACPI_TABLE_HEADER
modifier|*
name|sdp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_handle_ecdt
parameter_list|(
name|ACPI_TABLE_HEADER
modifier|*
name|sdp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_handle_hpet
parameter_list|(
name|ACPI_TABLE_HEADER
modifier|*
name|sdp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_handle_mcfg
parameter_list|(
name|ACPI_TABLE_HEADER
modifier|*
name|sdp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_handle_slit
parameter_list|(
name|ACPI_TABLE_HEADER
modifier|*
name|sdp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_print_srat_cpu
parameter_list|(
name|uint32_t
name|apic_id
parameter_list|,
name|uint32_t
name|proximity_domain
parameter_list|,
name|uint32_t
name|flags
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_print_srat_memory
parameter_list|(
name|ACPI_SRAT_MEM_AFFINITY
modifier|*
name|mp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_print_srat
parameter_list|(
name|ACPI_SUBTABLE_HEADER
modifier|*
name|srat
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_handle_srat
parameter_list|(
name|ACPI_TABLE_HEADER
modifier|*
name|sdp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_handle_tcpa
parameter_list|(
name|ACPI_TABLE_HEADER
modifier|*
name|sdp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_print_sdt
parameter_list|(
name|ACPI_TABLE_HEADER
modifier|*
name|sdp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_print_fadt
parameter_list|(
name|ACPI_TABLE_HEADER
modifier|*
name|sdp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_print_facs
parameter_list|(
name|ACPI_TABLE_FACS
modifier|*
name|facs
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_print_dsdt
parameter_list|(
name|ACPI_TABLE_HEADER
modifier|*
name|dsdp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ACPI_TABLE_HEADER
modifier|*
name|acpi_map_sdt
parameter_list|(
name|vm_offset_t
name|pa
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_print_rsd_ptr
parameter_list|(
name|ACPI_TABLE_RSDP
modifier|*
name|rp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_handle_rsdt
parameter_list|(
name|ACPI_TABLE_HEADER
modifier|*
name|rsdp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_walk_subtables
parameter_list|(
name|ACPI_TABLE_HEADER
modifier|*
name|table
parameter_list|,
name|void
modifier|*
name|first
parameter_list|,
name|void
function_decl|(
modifier|*
name|action
function_decl|)
parameter_list|(
name|ACPI_SUBTABLE_HEADER
modifier|*
parameter_list|)
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* Size of an address. 32-bit for ACPI 1.0, 64-bit for ACPI 2.0 and up. */
end_comment

begin_decl_stmt
specifier|static
name|int
name|addr_size
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Strings used in the TCPA table */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|tcpa_event_type_strings
index|[]
init|=
block|{
literal|"PREBOOT Certificate"
block|,
literal|"POST Code"
block|,
literal|"Unused"
block|,
literal|"No Action"
block|,
literal|"Separator"
block|,
literal|"Action"
block|,
literal|"Event Tag"
block|,
literal|"S-CRTM Contents"
block|,
literal|"S-CRTM Version"
block|,
literal|"CPU Microcode"
block|,
literal|"Platform Config Flags"
block|,
literal|"Table of Devices"
block|,
literal|"Compact Hash"
block|,
literal|"IPL"
block|,
literal|"IPL Partition Data"
block|,
literal|"Non-Host Code"
block|,
literal|"Non-Host Config"
block|,
literal|"Non-Host Info"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|TCPA_pcclient_strings
index|[]
init|=
block|{
literal|"<undefined>"
block|,
literal|"SMBIOS"
block|,
literal|"BIS Certificate"
block|,
literal|"POST BIOS ROM Strings"
block|,
literal|"ESCD"
block|,
literal|"CMOS"
block|,
literal|"NVRAM"
block|,
literal|"Option ROM Execute"
block|,
literal|"Option ROM Configurateion"
block|,
literal|"<undefined>"
block|,
literal|"Option ROM Microcode Update "
block|,
literal|"S-CRTM Version String"
block|,
literal|"S-CRTM Contents"
block|,
literal|"POST Contents"
block|,
literal|"Table of Devices"
block|, }
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|PRINTFLAG_END
parameter_list|()
value|printflag_end()
end_define

begin_decl_stmt
specifier|static
name|char
name|pf_sep
init|=
literal|'{'
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|printflag_end
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
name|pf_sep
operator|!=
literal|'{'
condition|)
block|{
name|printf
argument_list|(
literal|"}"
argument_list|)
expr_stmt|;
name|pf_sep
operator|=
literal|'{'
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|printflag
parameter_list|(
name|uint64_t
name|var
parameter_list|,
name|uint64_t
name|mask
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
if|if
condition|(
name|var
operator|&
name|mask
condition|)
block|{
name|printf
argument_list|(
literal|"%c%s"
argument_list|,
name|pf_sep
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|pf_sep
operator|=
literal|','
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_print_string
parameter_list|(
name|char
modifier|*
name|s
parameter_list|,
name|size_t
name|length
parameter_list|)
block|{
name|int
name|c
decl_stmt|;
comment|/* Trim trailing spaces and NULLs */
while|while
condition|(
name|length
operator|>
literal|0
operator|&&
operator|(
name|s
index|[
name|length
operator|-
literal|1
index|]
operator|==
literal|' '
operator|||
name|s
index|[
name|length
operator|-
literal|1
index|]
operator|==
literal|'\0'
operator|)
condition|)
name|length
operator|--
expr_stmt|;
while|while
condition|(
name|length
operator|--
condition|)
block|{
name|c
operator|=
operator|*
name|s
operator|++
expr_stmt|;
name|putchar
argument_list|(
name|c
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_print_gas
parameter_list|(
name|ACPI_GENERIC_ADDRESS
modifier|*
name|gas
parameter_list|)
block|{
switch|switch
condition|(
name|gas
operator|->
name|SpaceId
condition|)
block|{
case|case
name|ACPI_GAS_MEMORY
case|:
if|if
condition|(
name|gas
operator|->
name|BitWidth
operator|<=
literal|32
condition|)
name|printf
argument_list|(
literal|"0x%08x:%u[%u] (Memory)"
argument_list|,
operator|(
name|u_int
operator|)
name|gas
operator|->
name|Address
argument_list|,
name|gas
operator|->
name|BitOffset
argument_list|,
name|gas
operator|->
name|BitWidth
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"0x%016jx:%u[%u] (Memory)"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|gas
operator|->
name|Address
argument_list|,
name|gas
operator|->
name|BitOffset
argument_list|,
name|gas
operator|->
name|BitWidth
argument_list|)
expr_stmt|;
break|break;
case|case
name|ACPI_GAS_IO
case|:
name|printf
argument_list|(
literal|"0x%02x:%u[%u] (IO)"
argument_list|,
operator|(
name|u_int
operator|)
name|gas
operator|->
name|Address
argument_list|,
name|gas
operator|->
name|BitOffset
argument_list|,
name|gas
operator|->
name|BitWidth
argument_list|)
expr_stmt|;
break|break;
case|case
name|ACPI_GAS_PCI
case|:
name|printf
argument_list|(
literal|"%x:%x+0x%x (PCI)"
argument_list|,
call|(
name|uint16_t
call|)
argument_list|(
name|gas
operator|->
name|Address
operator|>>
literal|32
argument_list|)
argument_list|,
call|(
name|uint16_t
call|)
argument_list|(
operator|(
name|gas
operator|->
name|Address
operator|>>
literal|16
operator|)
operator|&
literal|0xffff
argument_list|)
argument_list|,
operator|(
name|uint16_t
operator|)
name|gas
operator|->
name|Address
argument_list|)
expr_stmt|;
break|break;
comment|/* XXX How to handle these below? */
case|case
name|ACPI_GAS_EMBEDDED
case|:
name|printf
argument_list|(
literal|"0x%x:%u[%u] (EC)"
argument_list|,
operator|(
name|uint16_t
operator|)
name|gas
operator|->
name|Address
argument_list|,
name|gas
operator|->
name|BitOffset
argument_list|,
name|gas
operator|->
name|BitWidth
argument_list|)
expr_stmt|;
break|break;
case|case
name|ACPI_GAS_SMBUS
case|:
name|printf
argument_list|(
literal|"0x%x:%u[%u] (SMBus)"
argument_list|,
operator|(
name|uint16_t
operator|)
name|gas
operator|->
name|Address
argument_list|,
name|gas
operator|->
name|BitOffset
argument_list|,
name|gas
operator|->
name|BitWidth
argument_list|)
expr_stmt|;
break|break;
case|case
name|ACPI_GAS_CMOS
case|:
case|case
name|ACPI_GAS_PCIBAR
case|:
case|case
name|ACPI_GAS_DATATABLE
case|:
case|case
name|ACPI_GAS_FIXED
case|:
default|default:
name|printf
argument_list|(
literal|"0x%016jx (?)"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|gas
operator|->
name|Address
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/* The FADT revision indicates whether we use the DSDT or X_DSDT addresses. */
end_comment

begin_function
specifier|static
name|int
name|acpi_get_fadt_revision
parameter_list|(
name|ACPI_TABLE_FADT
modifier|*
name|fadt
parameter_list|)
block|{
name|int
name|fadt_revision
decl_stmt|;
comment|/* Set the FADT revision separately from the RSDP version. */
if|if
condition|(
name|addr_size
operator|==
literal|8
condition|)
block|{
name|fadt_revision
operator|=
literal|2
expr_stmt|;
comment|/* 		 * A few systems (e.g., IBM T23) have an RSDP that claims 		 * revision 2 but the 64 bit addresses are invalid.  If 		 * revision 2 and the 32 bit address is non-zero but the 		 * 32 and 64 bit versions don't match, prefer the 32 bit 		 * version for all subsequent tables. 		 */
if|if
condition|(
name|fadt
operator|->
name|Facs
operator|!=
literal|0
operator|&&
operator|(
name|fadt
operator|->
name|XFacs
operator|&
literal|0xffffffff
operator|)
operator|!=
name|fadt
operator|->
name|Facs
condition|)
name|fadt_revision
operator|=
literal|1
expr_stmt|;
block|}
else|else
name|fadt_revision
operator|=
literal|1
expr_stmt|;
return|return
operator|(
name|fadt_revision
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_handle_fadt
parameter_list|(
name|ACPI_TABLE_HEADER
modifier|*
name|sdp
parameter_list|)
block|{
name|ACPI_TABLE_HEADER
modifier|*
name|dsdp
decl_stmt|;
name|ACPI_TABLE_FACS
modifier|*
name|facs
decl_stmt|;
name|ACPI_TABLE_FADT
modifier|*
name|fadt
decl_stmt|;
name|int
name|fadt_revision
decl_stmt|;
name|fadt
operator|=
operator|(
name|ACPI_TABLE_FADT
operator|*
operator|)
name|sdp
expr_stmt|;
name|acpi_print_fadt
argument_list|(
name|sdp
argument_list|)
expr_stmt|;
name|fadt_revision
operator|=
name|acpi_get_fadt_revision
argument_list|(
name|fadt
argument_list|)
expr_stmt|;
if|if
condition|(
name|fadt_revision
operator|==
literal|1
condition|)
name|facs
operator|=
operator|(
name|ACPI_TABLE_FACS
operator|*
operator|)
name|acpi_map_sdt
argument_list|(
name|fadt
operator|->
name|Facs
argument_list|)
expr_stmt|;
else|else
name|facs
operator|=
operator|(
name|ACPI_TABLE_FACS
operator|*
operator|)
name|acpi_map_sdt
argument_list|(
name|fadt
operator|->
name|XFacs
argument_list|)
expr_stmt|;
if|if
condition|(
name|memcmp
argument_list|(
name|facs
operator|->
name|Signature
argument_list|,
name|ACPI_SIG_FACS
argument_list|,
literal|4
argument_list|)
operator|!=
literal|0
operator|||
name|facs
operator|->
name|Length
operator|<
literal|64
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"FACS is corrupt"
argument_list|)
expr_stmt|;
name|acpi_print_facs
argument_list|(
name|facs
argument_list|)
expr_stmt|;
if|if
condition|(
name|fadt_revision
operator|==
literal|1
condition|)
name|dsdp
operator|=
operator|(
name|ACPI_TABLE_HEADER
operator|*
operator|)
name|acpi_map_sdt
argument_list|(
name|fadt
operator|->
name|Dsdt
argument_list|)
expr_stmt|;
else|else
name|dsdp
operator|=
operator|(
name|ACPI_TABLE_HEADER
operator|*
operator|)
name|acpi_map_sdt
argument_list|(
name|fadt
operator|->
name|XDsdt
argument_list|)
expr_stmt|;
if|if
condition|(
name|acpi_checksum
argument_list|(
name|dsdp
argument_list|,
name|dsdp
operator|->
name|Length
argument_list|)
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"DSDT is corrupt"
argument_list|)
expr_stmt|;
name|acpi_print_dsdt
argument_list|(
name|dsdp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_walk_subtables
parameter_list|(
name|ACPI_TABLE_HEADER
modifier|*
name|table
parameter_list|,
name|void
modifier|*
name|first
parameter_list|,
name|void
function_decl|(
modifier|*
name|action
function_decl|)
parameter_list|(
name|ACPI_SUBTABLE_HEADER
modifier|*
parameter_list|)
parameter_list|)
block|{
name|ACPI_SUBTABLE_HEADER
modifier|*
name|subtable
decl_stmt|;
name|char
modifier|*
name|end
decl_stmt|;
name|subtable
operator|=
name|first
expr_stmt|;
name|end
operator|=
operator|(
name|char
operator|*
operator|)
name|table
operator|+
name|table
operator|->
name|Length
expr_stmt|;
while|while
condition|(
operator|(
name|char
operator|*
operator|)
name|subtable
operator|<
name|end
condition|)
block|{
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|action
argument_list|(
name|subtable
argument_list|)
expr_stmt|;
name|subtable
operator|=
operator|(
name|ACPI_SUBTABLE_HEADER
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|subtable
operator|+
name|subtable
operator|->
name|Length
operator|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_print_cpu
parameter_list|(
name|u_char
name|cpu_id
parameter_list|)
block|{
name|printf
argument_list|(
literal|"\tACPI CPU="
argument_list|)
expr_stmt|;
if|if
condition|(
name|cpu_id
operator|==
literal|0xff
condition|)
name|printf
argument_list|(
literal|"ALL\n"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%d\n"
argument_list|,
operator|(
name|u_int
operator|)
name|cpu_id
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_print_cpu_uid
parameter_list|(
name|uint32_t
name|uid
parameter_list|,
name|char
modifier|*
name|uid_string
parameter_list|)
block|{
name|printf
argument_list|(
literal|"\tUID=%d"
argument_list|,
name|uid
argument_list|)
expr_stmt|;
if|if
condition|(
name|uid_string
operator|!=
name|NULL
condition|)
name|printf
argument_list|(
literal|" (%s)"
argument_list|,
name|uid_string
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_print_local_apic
parameter_list|(
name|uint32_t
name|apic_id
parameter_list|,
name|uint32_t
name|flags
parameter_list|)
block|{
name|printf
argument_list|(
literal|"\tFlags={"
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|ACPI_MADT_ENABLED
condition|)
name|printf
argument_list|(
literal|"ENABLED"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"DISABLED"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"}\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tAPIC ID=%d\n"
argument_list|,
name|apic_id
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_print_io_apic
parameter_list|(
name|uint32_t
name|apic_id
parameter_list|,
name|uint32_t
name|int_base
parameter_list|,
name|uint64_t
name|apic_addr
parameter_list|)
block|{
name|printf
argument_list|(
literal|"\tAPIC ID=%d\n"
argument_list|,
name|apic_id
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tINT BASE=%d\n"
argument_list|,
name|int_base
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tADDR=0x%016jx\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|apic_addr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_print_mps_flags
parameter_list|(
name|uint16_t
name|flags
parameter_list|)
block|{
name|printf
argument_list|(
literal|"\tFlags={Polarity="
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|flags
operator|&
name|ACPI_MADT_POLARITY_MASK
condition|)
block|{
case|case
name|ACPI_MADT_POLARITY_CONFORMS
case|:
name|printf
argument_list|(
literal|"conforming"
argument_list|)
expr_stmt|;
break|break;
case|case
name|ACPI_MADT_POLARITY_ACTIVE_HIGH
case|:
name|printf
argument_list|(
literal|"active-hi"
argument_list|)
expr_stmt|;
break|break;
case|case
name|ACPI_MADT_POLARITY_ACTIVE_LOW
case|:
name|printf
argument_list|(
literal|"active-lo"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"0x%x"
argument_list|,
name|flags
operator|&
name|ACPI_MADT_POLARITY_MASK
argument_list|)
expr_stmt|;
break|break;
block|}
name|printf
argument_list|(
literal|", Trigger="
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|flags
operator|&
name|ACPI_MADT_TRIGGER_MASK
condition|)
block|{
case|case
name|ACPI_MADT_TRIGGER_CONFORMS
case|:
name|printf
argument_list|(
literal|"conforming"
argument_list|)
expr_stmt|;
break|break;
case|case
name|ACPI_MADT_TRIGGER_EDGE
case|:
name|printf
argument_list|(
literal|"edge"
argument_list|)
expr_stmt|;
break|break;
case|case
name|ACPI_MADT_TRIGGER_LEVEL
case|:
name|printf
argument_list|(
literal|"level"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"0x%x"
argument_list|,
operator|(
name|flags
operator|&
name|ACPI_MADT_TRIGGER_MASK
operator|)
operator|>>
literal|2
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"}\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_print_gicc_flags
parameter_list|(
name|uint32_t
name|flags
parameter_list|)
block|{
name|printf
argument_list|(
literal|"\tFlags={Performance intr="
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|ACPI_MADT_PERFORMANCE_IRQ_MODE
condition|)
name|printf
argument_list|(
literal|"edge"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"level"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|", VGIC intr="
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|ACPI_MADT_VGIC_IRQ_MODE
condition|)
name|printf
argument_list|(
literal|"edge"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"level"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"}\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_print_intr
parameter_list|(
name|uint32_t
name|intr
parameter_list|,
name|uint16_t
name|mps_flags
parameter_list|)
block|{
name|printf
argument_list|(
literal|"\tINTR=%d\n"
argument_list|,
name|intr
argument_list|)
expr_stmt|;
name|acpi_print_mps_flags
argument_list|(
name|mps_flags
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_print_local_nmi
parameter_list|(
name|u_int
name|lint
parameter_list|,
name|uint16_t
name|mps_flags
parameter_list|)
block|{
name|printf
argument_list|(
literal|"\tLINT Pin=%d\n"
argument_list|,
name|lint
argument_list|)
expr_stmt|;
name|acpi_print_mps_flags
argument_list|(
name|mps_flags
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|apic_types
index|[]
init|=
block|{
literal|"Local APIC"
block|,
literal|"IO APIC"
block|,
literal|"INT Override"
block|,
literal|"NMI"
block|,
literal|"Local APIC NMI"
block|,
literal|"Local APIC Override"
block|,
literal|"IO SAPIC"
block|,
literal|"Local SAPIC"
block|,
literal|"Platform Interrupt"
block|,
literal|"Local X2APIC"
block|,
literal|"Local X2APIC NMI"
block|,
literal|"GIC CPU Interface Structure"
block|,
literal|"GIC Distributor Structure"
block|,
literal|"GICv2m MSI Frame"
block|,
literal|"GIC Redistributor Structure"
block|,
literal|"GIC ITS Structure"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|platform_int_types
index|[]
init|=
block|{
literal|"0 (unknown)"
block|,
literal|"PMI"
block|,
literal|"INIT"
block|,
literal|"Corrected Platform Error"
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|acpi_print_madt
parameter_list|(
name|ACPI_SUBTABLE_HEADER
modifier|*
name|mp
parameter_list|)
block|{
name|ACPI_MADT_LOCAL_APIC
modifier|*
name|lapic
decl_stmt|;
name|ACPI_MADT_IO_APIC
modifier|*
name|ioapic
decl_stmt|;
name|ACPI_MADT_INTERRUPT_OVERRIDE
modifier|*
name|over
decl_stmt|;
name|ACPI_MADT_NMI_SOURCE
modifier|*
name|nmi
decl_stmt|;
name|ACPI_MADT_LOCAL_APIC_NMI
modifier|*
name|lapic_nmi
decl_stmt|;
name|ACPI_MADT_LOCAL_APIC_OVERRIDE
modifier|*
name|lapic_over
decl_stmt|;
name|ACPI_MADT_IO_SAPIC
modifier|*
name|iosapic
decl_stmt|;
name|ACPI_MADT_LOCAL_SAPIC
modifier|*
name|lsapic
decl_stmt|;
name|ACPI_MADT_INTERRUPT_SOURCE
modifier|*
name|isrc
decl_stmt|;
name|ACPI_MADT_LOCAL_X2APIC
modifier|*
name|x2apic
decl_stmt|;
name|ACPI_MADT_LOCAL_X2APIC_NMI
modifier|*
name|x2apic_nmi
decl_stmt|;
name|ACPI_MADT_GENERIC_INTERRUPT
modifier|*
name|gicc
decl_stmt|;
name|ACPI_MADT_GENERIC_DISTRIBUTOR
modifier|*
name|gicd
decl_stmt|;
name|ACPI_MADT_GENERIC_REDISTRIBUTOR
modifier|*
name|gicr
decl_stmt|;
name|ACPI_MADT_GENERIC_TRANSLATOR
modifier|*
name|gict
decl_stmt|;
if|if
condition|(
name|mp
operator|->
name|Type
operator|<
name|nitems
argument_list|(
name|apic_types
argument_list|)
condition|)
name|printf
argument_list|(
literal|"\tType=%s\n"
argument_list|,
name|apic_types
index|[
name|mp
operator|->
name|Type
index|]
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"\tType=%d (unknown)\n"
argument_list|,
name|mp
operator|->
name|Type
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|mp
operator|->
name|Type
condition|)
block|{
case|case
name|ACPI_MADT_TYPE_LOCAL_APIC
case|:
name|lapic
operator|=
operator|(
name|ACPI_MADT_LOCAL_APIC
operator|*
operator|)
name|mp
expr_stmt|;
name|acpi_print_cpu
argument_list|(
name|lapic
operator|->
name|ProcessorId
argument_list|)
expr_stmt|;
name|acpi_print_local_apic
argument_list|(
name|lapic
operator|->
name|Id
argument_list|,
name|lapic
operator|->
name|LapicFlags
argument_list|)
expr_stmt|;
break|break;
case|case
name|ACPI_MADT_TYPE_IO_APIC
case|:
name|ioapic
operator|=
operator|(
name|ACPI_MADT_IO_APIC
operator|*
operator|)
name|mp
expr_stmt|;
name|acpi_print_io_apic
argument_list|(
name|ioapic
operator|->
name|Id
argument_list|,
name|ioapic
operator|->
name|GlobalIrqBase
argument_list|,
name|ioapic
operator|->
name|Address
argument_list|)
expr_stmt|;
break|break;
case|case
name|ACPI_MADT_TYPE_INTERRUPT_OVERRIDE
case|:
name|over
operator|=
operator|(
name|ACPI_MADT_INTERRUPT_OVERRIDE
operator|*
operator|)
name|mp
expr_stmt|;
name|printf
argument_list|(
literal|"\tBUS=%d\n"
argument_list|,
operator|(
name|u_int
operator|)
name|over
operator|->
name|Bus
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tIRQ=%d\n"
argument_list|,
operator|(
name|u_int
operator|)
name|over
operator|->
name|SourceIrq
argument_list|)
expr_stmt|;
name|acpi_print_intr
argument_list|(
name|over
operator|->
name|GlobalIrq
argument_list|,
name|over
operator|->
name|IntiFlags
argument_list|)
expr_stmt|;
break|break;
case|case
name|ACPI_MADT_TYPE_NMI_SOURCE
case|:
name|nmi
operator|=
operator|(
name|ACPI_MADT_NMI_SOURCE
operator|*
operator|)
name|mp
expr_stmt|;
name|acpi_print_intr
argument_list|(
name|nmi
operator|->
name|GlobalIrq
argument_list|,
name|nmi
operator|->
name|IntiFlags
argument_list|)
expr_stmt|;
break|break;
case|case
name|ACPI_MADT_TYPE_LOCAL_APIC_NMI
case|:
name|lapic_nmi
operator|=
operator|(
name|ACPI_MADT_LOCAL_APIC_NMI
operator|*
operator|)
name|mp
expr_stmt|;
name|acpi_print_cpu
argument_list|(
name|lapic_nmi
operator|->
name|ProcessorId
argument_list|)
expr_stmt|;
name|acpi_print_local_nmi
argument_list|(
name|lapic_nmi
operator|->
name|Lint
argument_list|,
name|lapic_nmi
operator|->
name|IntiFlags
argument_list|)
expr_stmt|;
break|break;
case|case
name|ACPI_MADT_TYPE_LOCAL_APIC_OVERRIDE
case|:
name|lapic_over
operator|=
operator|(
name|ACPI_MADT_LOCAL_APIC_OVERRIDE
operator|*
operator|)
name|mp
expr_stmt|;
name|printf
argument_list|(
literal|"\tLocal APIC ADDR=0x%016jx\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|lapic_over
operator|->
name|Address
argument_list|)
expr_stmt|;
break|break;
case|case
name|ACPI_MADT_TYPE_IO_SAPIC
case|:
name|iosapic
operator|=
operator|(
name|ACPI_MADT_IO_SAPIC
operator|*
operator|)
name|mp
expr_stmt|;
name|acpi_print_io_apic
argument_list|(
name|iosapic
operator|->
name|Id
argument_list|,
name|iosapic
operator|->
name|GlobalIrqBase
argument_list|,
name|iosapic
operator|->
name|Address
argument_list|)
expr_stmt|;
break|break;
case|case
name|ACPI_MADT_TYPE_LOCAL_SAPIC
case|:
name|lsapic
operator|=
operator|(
name|ACPI_MADT_LOCAL_SAPIC
operator|*
operator|)
name|mp
expr_stmt|;
name|acpi_print_cpu
argument_list|(
name|lsapic
operator|->
name|ProcessorId
argument_list|)
expr_stmt|;
name|acpi_print_local_apic
argument_list|(
name|lsapic
operator|->
name|Id
argument_list|,
name|lsapic
operator|->
name|LapicFlags
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tAPIC EID=%d\n"
argument_list|,
operator|(
name|u_int
operator|)
name|lsapic
operator|->
name|Eid
argument_list|)
expr_stmt|;
if|if
condition|(
name|mp
operator|->
name|Length
operator|>
name|__offsetof
argument_list|(
name|ACPI_MADT_LOCAL_SAPIC
argument_list|,
name|Uid
argument_list|)
condition|)
name|acpi_print_cpu_uid
argument_list|(
name|lsapic
operator|->
name|Uid
argument_list|,
name|lsapic
operator|->
name|UidString
argument_list|)
expr_stmt|;
break|break;
case|case
name|ACPI_MADT_TYPE_INTERRUPT_SOURCE
case|:
name|isrc
operator|=
operator|(
name|ACPI_MADT_INTERRUPT_SOURCE
operator|*
operator|)
name|mp
expr_stmt|;
if|if
condition|(
name|isrc
operator|->
name|Type
operator|<
name|nitems
argument_list|(
name|platform_int_types
argument_list|)
condition|)
name|printf
argument_list|(
literal|"\tType=%s\n"
argument_list|,
name|platform_int_types
index|[
name|isrc
operator|->
name|Type
index|]
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"\tType=%d (unknown)\n"
argument_list|,
name|isrc
operator|->
name|Type
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tAPIC ID=%d\n"
argument_list|,
operator|(
name|u_int
operator|)
name|isrc
operator|->
name|Id
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tAPIC EID=%d\n"
argument_list|,
operator|(
name|u_int
operator|)
name|isrc
operator|->
name|Eid
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tSAPIC Vector=%d\n"
argument_list|,
operator|(
name|u_int
operator|)
name|isrc
operator|->
name|IoSapicVector
argument_list|)
expr_stmt|;
name|acpi_print_intr
argument_list|(
name|isrc
operator|->
name|GlobalIrq
argument_list|,
name|isrc
operator|->
name|IntiFlags
argument_list|)
expr_stmt|;
break|break;
case|case
name|ACPI_MADT_TYPE_LOCAL_X2APIC
case|:
name|x2apic
operator|=
operator|(
name|ACPI_MADT_LOCAL_X2APIC
operator|*
operator|)
name|mp
expr_stmt|;
name|acpi_print_cpu_uid
argument_list|(
name|x2apic
operator|->
name|Uid
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|acpi_print_local_apic
argument_list|(
name|x2apic
operator|->
name|LocalApicId
argument_list|,
name|x2apic
operator|->
name|LapicFlags
argument_list|)
expr_stmt|;
break|break;
case|case
name|ACPI_MADT_TYPE_LOCAL_X2APIC_NMI
case|:
name|x2apic_nmi
operator|=
operator|(
name|ACPI_MADT_LOCAL_X2APIC_NMI
operator|*
operator|)
name|mp
expr_stmt|;
name|acpi_print_cpu_uid
argument_list|(
name|x2apic_nmi
operator|->
name|Uid
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|acpi_print_local_nmi
argument_list|(
name|x2apic_nmi
operator|->
name|Lint
argument_list|,
name|x2apic_nmi
operator|->
name|IntiFlags
argument_list|)
expr_stmt|;
break|break;
case|case
name|ACPI_MADT_TYPE_GENERIC_INTERRUPT
case|:
name|gicc
operator|=
operator|(
name|ACPI_MADT_GENERIC_INTERRUPT
operator|*
operator|)
name|mp
expr_stmt|;
name|acpi_print_cpu_uid
argument_list|(
name|gicc
operator|->
name|Uid
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tCPU INTERFACE=%x\n"
argument_list|,
name|gicc
operator|->
name|CpuInterfaceNumber
argument_list|)
expr_stmt|;
name|acpi_print_gicc_flags
argument_list|(
name|gicc
operator|->
name|Flags
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tParking Protocol Version=%x\n"
argument_list|,
name|gicc
operator|->
name|ParkingVersion
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tPERF INTR=%d\n"
argument_list|,
name|gicc
operator|->
name|PerformanceInterrupt
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tParked ADDR=%016jx\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|gicc
operator|->
name|ParkedAddress
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tBase ADDR=%016jx\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|gicc
operator|->
name|BaseAddress
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tGICV=%016jx\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|gicc
operator|->
name|GicvBaseAddress
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tGICH=%016jx\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|gicc
operator|->
name|GichBaseAddress
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tVGIC INTR=%d\n"
argument_list|,
name|gicc
operator|->
name|VgicInterrupt
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tGICR ADDR=%016jx\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|gicc
operator|->
name|GicrBaseAddress
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tMPIDR=%jx\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|gicc
operator|->
name|ArmMpidr
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tEfficency Class=%d\n"
argument_list|,
operator|(
name|u_int
operator|)
name|gicc
operator|->
name|EfficiencyClass
argument_list|)
expr_stmt|;
break|break;
case|case
name|ACPI_MADT_TYPE_GENERIC_DISTRIBUTOR
case|:
name|gicd
operator|=
operator|(
name|ACPI_MADT_GENERIC_DISTRIBUTOR
operator|*
operator|)
name|mp
expr_stmt|;
name|printf
argument_list|(
literal|"\tGIC ID=%d\n"
argument_list|,
operator|(
name|u_int
operator|)
name|gicd
operator|->
name|GicId
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tBase ADDR=%016jx\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|gicd
operator|->
name|BaseAddress
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tVector Base=%d\n"
argument_list|,
name|gicd
operator|->
name|GlobalIrqBase
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tGIC VERSION=%d\n"
argument_list|,
operator|(
name|u_int
operator|)
name|gicd
operator|->
name|Version
argument_list|)
expr_stmt|;
break|break;
case|case
name|ACPI_MADT_TYPE_GENERIC_REDISTRIBUTOR
case|:
name|gicr
operator|=
operator|(
name|ACPI_MADT_GENERIC_REDISTRIBUTOR
operator|*
operator|)
name|mp
expr_stmt|;
name|printf
argument_list|(
literal|"\tBase ADDR=%016jx\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|gicr
operator|->
name|BaseAddress
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tLength=%08x\n"
argument_list|,
name|gicr
operator|->
name|Length
argument_list|)
expr_stmt|;
break|break;
case|case
name|ACPI_MADT_TYPE_GENERIC_TRANSLATOR
case|:
name|gict
operator|=
operator|(
name|ACPI_MADT_GENERIC_TRANSLATOR
operator|*
operator|)
name|mp
expr_stmt|;
name|printf
argument_list|(
literal|"\tGIC ITS ID=%d\n"
argument_list|,
name|gict
operator|->
name|TranslationId
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tBase ADDR=%016jx\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|gict
operator|->
name|BaseAddress
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_handle_madt
parameter_list|(
name|ACPI_TABLE_HEADER
modifier|*
name|sdp
parameter_list|)
block|{
name|ACPI_TABLE_MADT
modifier|*
name|madt
decl_stmt|;
name|printf
argument_list|(
name|BEGIN_COMMENT
argument_list|)
expr_stmt|;
name|acpi_print_sdt
argument_list|(
name|sdp
argument_list|)
expr_stmt|;
name|madt
operator|=
operator|(
name|ACPI_TABLE_MADT
operator|*
operator|)
name|sdp
expr_stmt|;
name|printf
argument_list|(
literal|"\tLocal APIC ADDR=0x%08x\n"
argument_list|,
name|madt
operator|->
name|Address
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tFlags={"
argument_list|)
expr_stmt|;
if|if
condition|(
name|madt
operator|->
name|Flags
operator|&
name|ACPI_MADT_PCAT_COMPAT
condition|)
name|printf
argument_list|(
literal|"PC-AT"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"}\n"
argument_list|)
expr_stmt|;
name|acpi_walk_subtables
argument_list|(
name|sdp
argument_list|,
operator|(
name|madt
operator|+
literal|1
operator|)
argument_list|,
name|acpi_print_madt
argument_list|)
expr_stmt|;
name|printf
argument_list|(
name|END_COMMENT
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_handle_hpet
parameter_list|(
name|ACPI_TABLE_HEADER
modifier|*
name|sdp
parameter_list|)
block|{
name|ACPI_TABLE_HPET
modifier|*
name|hpet
decl_stmt|;
name|printf
argument_list|(
name|BEGIN_COMMENT
argument_list|)
expr_stmt|;
name|acpi_print_sdt
argument_list|(
name|sdp
argument_list|)
expr_stmt|;
name|hpet
operator|=
operator|(
name|ACPI_TABLE_HPET
operator|*
operator|)
name|sdp
expr_stmt|;
name|printf
argument_list|(
literal|"\tHPET Number=%d\n"
argument_list|,
name|hpet
operator|->
name|Sequence
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tADDR="
argument_list|)
expr_stmt|;
name|acpi_print_gas
argument_list|(
operator|&
name|hpet
operator|->
name|Address
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tHW Rev=0x%x\n"
argument_list|,
name|hpet
operator|->
name|Id
operator|&
name|ACPI_HPET_ID_HARDWARE_REV_ID
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tComparators=%d\n"
argument_list|,
operator|(
name|hpet
operator|->
name|Id
operator|&
name|ACPI_HPET_ID_COMPARATORS
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tCounter Size=%d\n"
argument_list|,
name|hpet
operator|->
name|Id
operator|&
name|ACPI_HPET_ID_COUNT_SIZE_CAP
condition|?
literal|1
else|:
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tLegacy IRQ routing capable={"
argument_list|)
expr_stmt|;
if|if
condition|(
name|hpet
operator|->
name|Id
operator|&
name|ACPI_HPET_ID_LEGACY_CAPABLE
condition|)
name|printf
argument_list|(
literal|"TRUE}\n"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"FALSE}\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tPCI Vendor ID=0x%04x\n"
argument_list|,
name|hpet
operator|->
name|Id
operator|>>
literal|16
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tMinimal Tick=%d\n"
argument_list|,
name|hpet
operator|->
name|MinimumTick
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tFlags=0x%02x\n"
argument_list|,
name|hpet
operator|->
name|Flags
argument_list|)
expr_stmt|;
name|printf
argument_list|(
name|END_COMMENT
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_handle_ecdt
parameter_list|(
name|ACPI_TABLE_HEADER
modifier|*
name|sdp
parameter_list|)
block|{
name|ACPI_TABLE_ECDT
modifier|*
name|ecdt
decl_stmt|;
name|printf
argument_list|(
name|BEGIN_COMMENT
argument_list|)
expr_stmt|;
name|acpi_print_sdt
argument_list|(
name|sdp
argument_list|)
expr_stmt|;
name|ecdt
operator|=
operator|(
name|ACPI_TABLE_ECDT
operator|*
operator|)
name|sdp
expr_stmt|;
name|printf
argument_list|(
literal|"\tEC_CONTROL="
argument_list|)
expr_stmt|;
name|acpi_print_gas
argument_list|(
operator|&
name|ecdt
operator|->
name|Control
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n\tEC_DATA="
argument_list|)
expr_stmt|;
name|acpi_print_gas
argument_list|(
operator|&
name|ecdt
operator|->
name|Data
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n\tUID=%#x, "
argument_list|,
name|ecdt
operator|->
name|Uid
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"GPE_BIT=%#x\n"
argument_list|,
name|ecdt
operator|->
name|Gpe
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tEC_ID=%s\n"
argument_list|,
name|ecdt
operator|->
name|Id
argument_list|)
expr_stmt|;
name|printf
argument_list|(
name|END_COMMENT
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_handle_mcfg
parameter_list|(
name|ACPI_TABLE_HEADER
modifier|*
name|sdp
parameter_list|)
block|{
name|ACPI_TABLE_MCFG
modifier|*
name|mcfg
decl_stmt|;
name|ACPI_MCFG_ALLOCATION
modifier|*
name|alloc
decl_stmt|;
name|u_int
name|i
decl_stmt|,
name|entries
decl_stmt|;
name|printf
argument_list|(
name|BEGIN_COMMENT
argument_list|)
expr_stmt|;
name|acpi_print_sdt
argument_list|(
name|sdp
argument_list|)
expr_stmt|;
name|mcfg
operator|=
operator|(
name|ACPI_TABLE_MCFG
operator|*
operator|)
name|sdp
expr_stmt|;
name|entries
operator|=
operator|(
name|sdp
operator|->
name|Length
operator|-
sizeof|sizeof
argument_list|(
name|ACPI_TABLE_MCFG
argument_list|)
operator|)
operator|/
sizeof|sizeof
argument_list|(
name|ACPI_MCFG_ALLOCATION
argument_list|)
expr_stmt|;
name|alloc
operator|=
operator|(
name|ACPI_MCFG_ALLOCATION
operator|*
operator|)
operator|(
name|mcfg
operator|+
literal|1
operator|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|entries
condition|;
name|i
operator|++
operator|,
name|alloc
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tBase Address=0x%016jx\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|alloc
operator|->
name|Address
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tSegment Group=0x%04x\n"
argument_list|,
name|alloc
operator|->
name|PciSegment
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tStart Bus=%d\n"
argument_list|,
name|alloc
operator|->
name|StartBusNumber
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tEnd Bus=%d\n"
argument_list|,
name|alloc
operator|->
name|EndBusNumber
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
name|END_COMMENT
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_handle_slit
parameter_list|(
name|ACPI_TABLE_HEADER
modifier|*
name|sdp
parameter_list|)
block|{
name|ACPI_TABLE_SLIT
modifier|*
name|slit
decl_stmt|;
name|UINT64
name|i
decl_stmt|,
name|j
decl_stmt|;
name|printf
argument_list|(
name|BEGIN_COMMENT
argument_list|)
expr_stmt|;
name|acpi_print_sdt
argument_list|(
name|sdp
argument_list|)
expr_stmt|;
name|slit
operator|=
operator|(
name|ACPI_TABLE_SLIT
operator|*
operator|)
name|sdp
expr_stmt|;
name|printf
argument_list|(
literal|"\tLocality Count=%ju\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|slit
operator|->
name|LocalityCount
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n\t      "
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|slit
operator|->
name|LocalityCount
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|" %3ju"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|i
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n\t     +"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|slit
operator|->
name|LocalityCount
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"----"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|slit
operator|->
name|LocalityCount
condition|;
name|i
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"\t %3ju |"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|i
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|slit
operator|->
name|LocalityCount
condition|;
name|j
operator|++
control|)
name|printf
argument_list|(
literal|" %3d"
argument_list|,
name|slit
operator|->
name|Entry
index|[
name|i
operator|*
name|slit
operator|->
name|LocalityCount
operator|+
name|j
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
name|END_COMMENT
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_print_srat_cpu
parameter_list|(
name|uint32_t
name|apic_id
parameter_list|,
name|uint32_t
name|proximity_domain
parameter_list|,
name|uint32_t
name|flags
parameter_list|)
block|{
name|printf
argument_list|(
literal|"\tFlags={"
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|ACPI_SRAT_CPU_ENABLED
condition|)
name|printf
argument_list|(
literal|"ENABLED"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"DISABLED"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"}\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tAPIC ID=%d\n"
argument_list|,
name|apic_id
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tProximity Domain=%d\n"
argument_list|,
name|proximity_domain
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|acpi_tcpa_evname
parameter_list|(
name|struct
name|TCPAevent
modifier|*
name|event
parameter_list|)
block|{
name|struct
name|TCPApc_event
modifier|*
name|pc_event
decl_stmt|;
name|char
modifier|*
name|eventname
init|=
name|NULL
decl_stmt|;
name|pc_event
operator|=
operator|(
expr|struct
name|TCPApc_event
operator|*
operator|)
operator|(
name|event
operator|+
literal|1
operator|)
expr_stmt|;
switch|switch
condition|(
name|event
operator|->
name|event_type
condition|)
block|{
case|case
name|PREBOOT
case|:
case|case
name|POST_CODE
case|:
case|case
name|UNUSED
case|:
case|case
name|NO_ACTION
case|:
case|case
name|SEPARATOR
case|:
case|case
name|SCRTM_CONTENTS
case|:
case|case
name|SCRTM_VERSION
case|:
case|case
name|CPU_MICROCODE
case|:
case|case
name|PLATFORM_CONFIG_FLAGS
case|:
case|case
name|TABLE_OF_DEVICES
case|:
case|case
name|COMPACT_HASH
case|:
case|case
name|IPL
case|:
case|case
name|IPL_PARTITION_DATA
case|:
case|case
name|NONHOST_CODE
case|:
case|case
name|NONHOST_CONFIG
case|:
case|case
name|NONHOST_INFO
case|:
name|asprintf
argument_list|(
operator|&
name|eventname
argument_list|,
literal|"%s"
argument_list|,
name|tcpa_event_type_strings
index|[
name|event
operator|->
name|event_type
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|ACTION
case|:
name|eventname
operator|=
name|calloc
argument_list|(
name|event
operator|->
name|event_size
operator|+
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|char
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|eventname
argument_list|,
name|pc_event
argument_list|,
name|event
operator|->
name|event_size
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_TAG
case|:
switch|switch
condition|(
name|pc_event
operator|->
name|event_id
condition|)
block|{
case|case
name|SMBIOS
case|:
case|case
name|BIS_CERT
case|:
case|case
name|CMOS
case|:
case|case
name|NVRAM
case|:
case|case
name|OPTION_ROM_EXEC
case|:
case|case
name|OPTION_ROM_CONFIG
case|:
case|case
name|S_CRTM_VERSION
case|:
case|case
name|POST_BIOS_ROM
case|:
case|case
name|ESCD
case|:
case|case
name|OPTION_ROM_MICROCODE
case|:
case|case
name|S_CRTM_CONTENTS
case|:
case|case
name|POST_CONTENTS
case|:
name|asprintf
argument_list|(
operator|&
name|eventname
argument_list|,
literal|"%s"
argument_list|,
name|TCPA_pcclient_strings
index|[
name|pc_event
operator|->
name|event_id
index|]
argument_list|)
expr_stmt|;
break|break;
default|default:
name|asprintf
argument_list|(
operator|&
name|eventname
argument_list|,
literal|"<unknown tag 0x%02x>"
argument_list|,
name|pc_event
operator|->
name|event_id
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
default|default:
name|asprintf
argument_list|(
operator|&
name|eventname
argument_list|,
literal|"<unknown 0x%02x>"
argument_list|,
name|event
operator|->
name|event_type
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
name|eventname
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_print_tcpa
parameter_list|(
name|struct
name|TCPAevent
modifier|*
name|event
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|char
modifier|*
name|eventname
decl_stmt|;
name|eventname
operator|=
name|acpi_tcpa_evname
argument_list|(
name|event
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t%d"
argument_list|,
name|event
operator|->
name|pcr_index
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" 0x"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|20
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"%02x"
argument_list|,
name|event
operator|->
name|pcr_value
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" [%s]\n"
argument_list|,
name|eventname
condition|?
name|eventname
else|:
literal|"<unknown>"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|eventname
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_handle_tcpa
parameter_list|(
name|ACPI_TABLE_HEADER
modifier|*
name|sdp
parameter_list|)
block|{
name|struct
name|TCPAbody
modifier|*
name|tcpa
decl_stmt|;
name|struct
name|TCPAevent
modifier|*
name|event
decl_stmt|;
name|uintmax_t
name|len
decl_stmt|,
name|paddr
decl_stmt|;
name|unsigned
name|char
modifier|*
name|vaddr
init|=
name|NULL
decl_stmt|;
name|unsigned
name|char
modifier|*
name|vend
init|=
name|NULL
decl_stmt|;
name|printf
argument_list|(
name|BEGIN_COMMENT
argument_list|)
expr_stmt|;
name|acpi_print_sdt
argument_list|(
name|sdp
argument_list|)
expr_stmt|;
name|tcpa
operator|=
operator|(
expr|struct
name|TCPAbody
operator|*
operator|)
name|sdp
expr_stmt|;
switch|switch
condition|(
name|tcpa
operator|->
name|platform_class
condition|)
block|{
case|case
name|ACPI_TCPA_BIOS_CLIENT
case|:
name|len
operator|=
name|tcpa
operator|->
name|client
operator|.
name|log_max_len
expr_stmt|;
name|paddr
operator|=
name|tcpa
operator|->
name|client
operator|.
name|log_start_addr
expr_stmt|;
break|break;
case|case
name|ACPI_TCPA_BIOS_SERVER
case|:
name|len
operator|=
name|tcpa
operator|->
name|server
operator|.
name|log_max_len
expr_stmt|;
name|paddr
operator|=
name|tcpa
operator|->
name|server
operator|.
name|log_start_addr
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"XXX"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
name|END_COMMENT
argument_list|)
expr_stmt|;
return|return;
block|}
name|printf
argument_list|(
literal|"\tClass %u Base Address 0x%jx Length %ju\n\n"
argument_list|,
name|tcpa
operator|->
name|platform_class
argument_list|,
name|paddr
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"\tEmpty TCPA table\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
name|END_COMMENT
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|sdp
operator|->
name|Revision
operator|==
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"\tOLD TCPA spec log found. Dumping not supported.\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
name|END_COMMENT
argument_list|)
expr_stmt|;
return|return;
block|}
name|vaddr
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|acpi_map_physical
argument_list|(
name|paddr
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|vend
operator|=
name|vaddr
operator|+
name|len
expr_stmt|;
while|while
condition|(
name|vaddr
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
name|vaddr
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|TCPAevent
argument_list|)
operator|>=
name|vend
operator|)
operator|||
operator|(
name|vaddr
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|TCPAevent
argument_list|)
operator|<
name|vaddr
operator|)
condition|)
break|break;
name|event
operator|=
operator|(
expr|struct
name|TCPAevent
operator|*
operator|)
operator|(
name|void
operator|*
operator|)
name|vaddr
expr_stmt|;
if|if
condition|(
name|vaddr
operator|+
name|event
operator|->
name|event_size
operator|>=
name|vend
condition|)
break|break;
if|if
condition|(
name|vaddr
operator|+
name|event
operator|->
name|event_size
operator|<
name|vaddr
condition|)
break|break;
if|if
condition|(
name|event
operator|->
name|event_type
operator|==
literal|0
operator|&&
name|event
operator|->
name|event_size
operator|==
literal|0
condition|)
break|break;
if|#
directive|if
literal|0
block|{ 		unsigned int i, j, k;  		printf("\n\tsize %d\n\t\t%p ", event->event_size, vaddr); 		for (j = 0, i = 0; i< 		    sizeof(struct TCPAevent) + event->event_size; i++) { 			printf("%02x ", vaddr[i]); 			if ((i+1) % 8 == 0) { 				for (k = 0; k< 8; k++) 					printf("%c", isprint(vaddr[j+k]) ? 					    vaddr[j+k] : '.'); 				printf("\n\t\t%p ",&vaddr[i + 1]); 				j = i + 1; 			} 		} 		printf("\n"); }
endif|#
directive|endif
name|acpi_print_tcpa
argument_list|(
name|event
argument_list|)
expr_stmt|;
name|vaddr
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|TCPAevent
argument_list|)
operator|+
name|event
operator|->
name|event_size
expr_stmt|;
block|}
name|printf
argument_list|(
name|END_COMMENT
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|devscope_type2str
parameter_list|(
name|int
name|type
parameter_list|)
block|{
specifier|static
name|char
name|typebuf
index|[
literal|16
index|]
decl_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
literal|1
case|:
return|return
operator|(
literal|"PCI Endpoint Device"
operator|)
return|;
case|case
literal|2
case|:
return|return
operator|(
literal|"PCI Sub-Hierarchy"
operator|)
return|;
case|case
literal|3
case|:
return|return
operator|(
literal|"IOAPIC"
operator|)
return|;
case|case
literal|4
case|:
return|return
operator|(
literal|"HPET"
operator|)
return|;
default|default:
name|snprintf
argument_list|(
name|typebuf
argument_list|,
sizeof|sizeof
argument_list|(
name|typebuf
argument_list|)
argument_list|,
literal|"%d"
argument_list|,
name|type
argument_list|)
expr_stmt|;
return|return
operator|(
name|typebuf
operator|)
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|acpi_handle_dmar_devscope
parameter_list|(
name|void
modifier|*
name|addr
parameter_list|,
name|int
name|remaining
parameter_list|)
block|{
name|char
name|sep
decl_stmt|;
name|int
name|pathlen
decl_stmt|;
name|ACPI_DMAR_PCI_PATH
modifier|*
name|path
decl_stmt|,
modifier|*
name|pathend
decl_stmt|;
name|ACPI_DMAR_DEVICE_SCOPE
modifier|*
name|devscope
init|=
name|addr
decl_stmt|;
if|if
condition|(
name|remaining
operator|<
operator|(
name|int
operator|)
sizeof|sizeof
argument_list|(
name|ACPI_DMAR_DEVICE_SCOPE
argument_list|)
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|remaining
operator|<
name|devscope
operator|->
name|Length
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\tType=%s\n"
argument_list|,
name|devscope_type2str
argument_list|(
name|devscope
operator|->
name|EntryType
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\tLength=%d\n"
argument_list|,
name|devscope
operator|->
name|Length
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\tEnumerationId=%d\n"
argument_list|,
name|devscope
operator|->
name|EnumerationId
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\tStartBusNumber=%d\n"
argument_list|,
name|devscope
operator|->
name|Bus
argument_list|)
expr_stmt|;
name|path
operator|=
operator|(
name|ACPI_DMAR_PCI_PATH
operator|*
operator|)
operator|(
name|devscope
operator|+
literal|1
operator|)
expr_stmt|;
name|pathlen
operator|=
name|devscope
operator|->
name|Length
operator|-
sizeof|sizeof
argument_list|(
name|ACPI_DMAR_DEVICE_SCOPE
argument_list|)
expr_stmt|;
name|pathend
operator|=
name|path
operator|+
name|pathlen
operator|/
sizeof|sizeof
argument_list|(
name|ACPI_DMAR_PCI_PATH
argument_list|)
expr_stmt|;
if|if
condition|(
name|path
operator|<
name|pathend
condition|)
block|{
name|sep
operator|=
literal|'{'
expr_stmt|;
name|printf
argument_list|(
literal|"\t\tPath="
argument_list|)
expr_stmt|;
do|do
block|{
name|printf
argument_list|(
literal|"%c%d:%d"
argument_list|,
name|sep
argument_list|,
name|path
operator|->
name|Device
argument_list|,
name|path
operator|->
name|Function
argument_list|)
expr_stmt|;
name|sep
operator|=
literal|','
expr_stmt|;
name|path
operator|++
expr_stmt|;
block|}
do|while
condition|(
name|path
operator|<
name|pathend
condition|)
do|;
name|printf
argument_list|(
literal|"}\n"
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|devscope
operator|->
name|Length
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_handle_dmar_drhd
parameter_list|(
name|ACPI_DMAR_HARDWARE_UNIT
modifier|*
name|drhd
parameter_list|)
block|{
name|char
modifier|*
name|cp
decl_stmt|;
name|int
name|remaining
decl_stmt|,
name|consumed
decl_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tType=DRHD\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tLength=%d\n"
argument_list|,
name|drhd
operator|->
name|Header
operator|.
name|Length
argument_list|)
expr_stmt|;
define|#
directive|define
name|PRINTFLAG
parameter_list|(
name|var
parameter_list|,
name|flag
parameter_list|)
value|printflag((var), ACPI_DMAR_## flag, #flag)
name|printf
argument_list|(
literal|"\tFlags="
argument_list|)
expr_stmt|;
name|PRINTFLAG
argument_list|(
name|drhd
operator|->
name|Flags
argument_list|,
name|INCLUDE_ALL
argument_list|)
expr_stmt|;
name|PRINTFLAG_END
argument_list|()
expr_stmt|;
undef|#
directive|undef
name|PRINTFLAG
name|printf
argument_list|(
literal|"\tSegment=%d\n"
argument_list|,
name|drhd
operator|->
name|Segment
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tAddress=0x%016jx\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|drhd
operator|->
name|Address
argument_list|)
expr_stmt|;
name|remaining
operator|=
name|drhd
operator|->
name|Header
operator|.
name|Length
operator|-
sizeof|sizeof
argument_list|(
name|ACPI_DMAR_HARDWARE_UNIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|remaining
operator|>
literal|0
condition|)
name|printf
argument_list|(
literal|"\tDevice Scope:"
argument_list|)
expr_stmt|;
while|while
condition|(
name|remaining
operator|>
literal|0
condition|)
block|{
name|cp
operator|=
operator|(
name|char
operator|*
operator|)
name|drhd
operator|+
name|drhd
operator|->
name|Header
operator|.
name|Length
operator|-
name|remaining
expr_stmt|;
name|consumed
operator|=
name|acpi_handle_dmar_devscope
argument_list|(
name|cp
argument_list|,
name|remaining
argument_list|)
expr_stmt|;
if|if
condition|(
name|consumed
operator|<=
literal|0
condition|)
break|break;
else|else
name|remaining
operator|-=
name|consumed
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_handle_dmar_rmrr
parameter_list|(
name|ACPI_DMAR_RESERVED_MEMORY
modifier|*
name|rmrr
parameter_list|)
block|{
name|char
modifier|*
name|cp
decl_stmt|;
name|int
name|remaining
decl_stmt|,
name|consumed
decl_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tType=RMRR\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tLength=%d\n"
argument_list|,
name|rmrr
operator|->
name|Header
operator|.
name|Length
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tSegment=%d\n"
argument_list|,
name|rmrr
operator|->
name|Segment
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tBaseAddress=0x%016jx\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|rmrr
operator|->
name|BaseAddress
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tLimitAddress=0x%016jx\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|rmrr
operator|->
name|EndAddress
argument_list|)
expr_stmt|;
name|remaining
operator|=
name|rmrr
operator|->
name|Header
operator|.
name|Length
operator|-
sizeof|sizeof
argument_list|(
name|ACPI_DMAR_RESERVED_MEMORY
argument_list|)
expr_stmt|;
if|if
condition|(
name|remaining
operator|>
literal|0
condition|)
name|printf
argument_list|(
literal|"\tDevice Scope:"
argument_list|)
expr_stmt|;
while|while
condition|(
name|remaining
operator|>
literal|0
condition|)
block|{
name|cp
operator|=
operator|(
name|char
operator|*
operator|)
name|rmrr
operator|+
name|rmrr
operator|->
name|Header
operator|.
name|Length
operator|-
name|remaining
expr_stmt|;
name|consumed
operator|=
name|acpi_handle_dmar_devscope
argument_list|(
name|cp
argument_list|,
name|remaining
argument_list|)
expr_stmt|;
if|if
condition|(
name|consumed
operator|<=
literal|0
condition|)
break|break;
else|else
name|remaining
operator|-=
name|consumed
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_handle_dmar_atsr
parameter_list|(
name|ACPI_DMAR_ATSR
modifier|*
name|atsr
parameter_list|)
block|{
name|char
modifier|*
name|cp
decl_stmt|;
name|int
name|remaining
decl_stmt|,
name|consumed
decl_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tType=ATSR\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tLength=%d\n"
argument_list|,
name|atsr
operator|->
name|Header
operator|.
name|Length
argument_list|)
expr_stmt|;
define|#
directive|define
name|PRINTFLAG
parameter_list|(
name|var
parameter_list|,
name|flag
parameter_list|)
value|printflag((var), ACPI_DMAR_## flag, #flag)
name|printf
argument_list|(
literal|"\tFlags="
argument_list|)
expr_stmt|;
name|PRINTFLAG
argument_list|(
name|atsr
operator|->
name|Flags
argument_list|,
name|ALL_PORTS
argument_list|)
expr_stmt|;
name|PRINTFLAG_END
argument_list|()
expr_stmt|;
undef|#
directive|undef
name|PRINTFLAG
name|printf
argument_list|(
literal|"\tSegment=%d\n"
argument_list|,
name|atsr
operator|->
name|Segment
argument_list|)
expr_stmt|;
name|remaining
operator|=
name|atsr
operator|->
name|Header
operator|.
name|Length
operator|-
sizeof|sizeof
argument_list|(
name|ACPI_DMAR_ATSR
argument_list|)
expr_stmt|;
if|if
condition|(
name|remaining
operator|>
literal|0
condition|)
name|printf
argument_list|(
literal|"\tDevice Scope:"
argument_list|)
expr_stmt|;
while|while
condition|(
name|remaining
operator|>
literal|0
condition|)
block|{
name|cp
operator|=
operator|(
name|char
operator|*
operator|)
name|atsr
operator|+
name|atsr
operator|->
name|Header
operator|.
name|Length
operator|-
name|remaining
expr_stmt|;
name|consumed
operator|=
name|acpi_handle_dmar_devscope
argument_list|(
name|cp
argument_list|,
name|remaining
argument_list|)
expr_stmt|;
if|if
condition|(
name|consumed
operator|<=
literal|0
condition|)
break|break;
else|else
name|remaining
operator|-=
name|consumed
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_handle_dmar_rhsa
parameter_list|(
name|ACPI_DMAR_RHSA
modifier|*
name|rhsa
parameter_list|)
block|{
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tType=RHSA\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tLength=%d\n"
argument_list|,
name|rhsa
operator|->
name|Header
operator|.
name|Length
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tBaseAddress=0x%016jx\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|rhsa
operator|->
name|BaseAddress
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tProximityDomain=0x%08x\n"
argument_list|,
name|rhsa
operator|->
name|ProximityDomain
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|acpi_handle_dmar_remapping_structure
parameter_list|(
name|void
modifier|*
name|addr
parameter_list|,
name|int
name|remaining
parameter_list|)
block|{
name|ACPI_DMAR_HEADER
modifier|*
name|hdr
init|=
name|addr
decl_stmt|;
if|if
condition|(
name|remaining
operator|<
operator|(
name|int
operator|)
sizeof|sizeof
argument_list|(
name|ACPI_DMAR_HEADER
argument_list|)
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|remaining
operator|<
name|hdr
operator|->
name|Length
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
switch|switch
condition|(
name|hdr
operator|->
name|Type
condition|)
block|{
case|case
name|ACPI_DMAR_TYPE_HARDWARE_UNIT
case|:
name|acpi_handle_dmar_drhd
argument_list|(
name|addr
argument_list|)
expr_stmt|;
break|break;
case|case
name|ACPI_DMAR_TYPE_RESERVED_MEMORY
case|:
name|acpi_handle_dmar_rmrr
argument_list|(
name|addr
argument_list|)
expr_stmt|;
break|break;
case|case
name|ACPI_DMAR_TYPE_ROOT_ATS
case|:
name|acpi_handle_dmar_atsr
argument_list|(
name|addr
argument_list|)
expr_stmt|;
break|break;
case|case
name|ACPI_DMAR_TYPE_HARDWARE_AFFINITY
case|:
name|acpi_handle_dmar_rhsa
argument_list|(
name|addr
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tType=%d\n"
argument_list|,
name|hdr
operator|->
name|Type
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tLength=%d\n"
argument_list|,
name|hdr
operator|->
name|Length
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|hdr
operator|->
name|Length
operator|)
return|;
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|ACPI_DMAR_X2APIC_OPT_OUT
end_ifndef

begin_define
define|#
directive|define
name|ACPI_DMAR_X2APIC_OPT_OUT
value|(0x2)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|void
name|acpi_handle_dmar
parameter_list|(
name|ACPI_TABLE_HEADER
modifier|*
name|sdp
parameter_list|)
block|{
name|char
modifier|*
name|cp
decl_stmt|;
name|int
name|remaining
decl_stmt|,
name|consumed
decl_stmt|;
name|ACPI_TABLE_DMAR
modifier|*
name|dmar
decl_stmt|;
name|printf
argument_list|(
name|BEGIN_COMMENT
argument_list|)
expr_stmt|;
name|acpi_print_sdt
argument_list|(
name|sdp
argument_list|)
expr_stmt|;
name|dmar
operator|=
operator|(
name|ACPI_TABLE_DMAR
operator|*
operator|)
name|sdp
expr_stmt|;
name|printf
argument_list|(
literal|"\tHost Address Width=%d\n"
argument_list|,
name|dmar
operator|->
name|Width
operator|+
literal|1
argument_list|)
expr_stmt|;
define|#
directive|define
name|PRINTFLAG
parameter_list|(
name|var
parameter_list|,
name|flag
parameter_list|)
value|printflag((var), ACPI_DMAR_## flag, #flag)
name|printf
argument_list|(
literal|"\tFlags="
argument_list|)
expr_stmt|;
name|PRINTFLAG
argument_list|(
name|dmar
operator|->
name|Flags
argument_list|,
name|INTR_REMAP
argument_list|)
expr_stmt|;
name|PRINTFLAG
argument_list|(
name|dmar
operator|->
name|Flags
argument_list|,
name|X2APIC_OPT_OUT
argument_list|)
expr_stmt|;
name|PRINTFLAG_END
argument_list|()
expr_stmt|;
undef|#
directive|undef
name|PRINTFLAG
name|remaining
operator|=
name|sdp
operator|->
name|Length
operator|-
sizeof|sizeof
argument_list|(
name|ACPI_TABLE_DMAR
argument_list|)
expr_stmt|;
while|while
condition|(
name|remaining
operator|>
literal|0
condition|)
block|{
name|cp
operator|=
operator|(
name|char
operator|*
operator|)
name|sdp
operator|+
name|sdp
operator|->
name|Length
operator|-
name|remaining
expr_stmt|;
name|consumed
operator|=
name|acpi_handle_dmar_remapping_structure
argument_list|(
name|cp
argument_list|,
name|remaining
argument_list|)
expr_stmt|;
if|if
condition|(
name|consumed
operator|<=
literal|0
condition|)
break|break;
else|else
name|remaining
operator|-=
name|consumed
expr_stmt|;
block|}
name|printf
argument_list|(
name|END_COMMENT
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_print_srat_memory
parameter_list|(
name|ACPI_SRAT_MEM_AFFINITY
modifier|*
name|mp
parameter_list|)
block|{
name|printf
argument_list|(
literal|"\tFlags={"
argument_list|)
expr_stmt|;
if|if
condition|(
name|mp
operator|->
name|Flags
operator|&
name|ACPI_SRAT_MEM_ENABLED
condition|)
name|printf
argument_list|(
literal|"ENABLED"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"DISABLED"
argument_list|)
expr_stmt|;
if|if
condition|(
name|mp
operator|->
name|Flags
operator|&
name|ACPI_SRAT_MEM_HOT_PLUGGABLE
condition|)
name|printf
argument_list|(
literal|",HOT_PLUGGABLE"
argument_list|)
expr_stmt|;
if|if
condition|(
name|mp
operator|->
name|Flags
operator|&
name|ACPI_SRAT_MEM_NON_VOLATILE
condition|)
name|printf
argument_list|(
literal|",NON_VOLATILE"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"}\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tBase Address=0x%016jx\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|mp
operator|->
name|BaseAddress
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tLength=0x%016jx\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|mp
operator|->
name|Length
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tProximity Domain=%d\n"
argument_list|,
name|mp
operator|->
name|ProximityDomain
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|srat_types
index|[]
init|=
block|{
literal|"CPU"
block|,
literal|"Memory"
block|,
literal|"X2APIC"
block|,
literal|"GICC"
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|acpi_print_srat
parameter_list|(
name|ACPI_SUBTABLE_HEADER
modifier|*
name|srat
parameter_list|)
block|{
name|ACPI_SRAT_CPU_AFFINITY
modifier|*
name|cpu
decl_stmt|;
name|ACPI_SRAT_X2APIC_CPU_AFFINITY
modifier|*
name|x2apic
decl_stmt|;
name|ACPI_SRAT_GICC_AFFINITY
modifier|*
name|gic
decl_stmt|;
if|if
condition|(
name|srat
operator|->
name|Type
operator|<
name|nitems
argument_list|(
name|srat_types
argument_list|)
condition|)
name|printf
argument_list|(
literal|"\tType=%s\n"
argument_list|,
name|srat_types
index|[
name|srat
operator|->
name|Type
index|]
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"\tType=%d (unknown)\n"
argument_list|,
name|srat
operator|->
name|Type
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|srat
operator|->
name|Type
condition|)
block|{
case|case
name|ACPI_SRAT_TYPE_CPU_AFFINITY
case|:
name|cpu
operator|=
operator|(
name|ACPI_SRAT_CPU_AFFINITY
operator|*
operator|)
name|srat
expr_stmt|;
name|acpi_print_srat_cpu
argument_list|(
name|cpu
operator|->
name|ApicId
argument_list|,
name|cpu
operator|->
name|ProximityDomainHi
index|[
literal|2
index|]
operator|<<
literal|24
operator||
name|cpu
operator|->
name|ProximityDomainHi
index|[
literal|1
index|]
operator|<<
literal|16
operator||
name|cpu
operator|->
name|ProximityDomainHi
index|[
literal|0
index|]
operator|<<
literal|0
operator||
name|cpu
operator|->
name|ProximityDomainLo
argument_list|,
name|cpu
operator|->
name|Flags
argument_list|)
expr_stmt|;
break|break;
case|case
name|ACPI_SRAT_TYPE_MEMORY_AFFINITY
case|:
name|acpi_print_srat_memory
argument_list|(
operator|(
name|ACPI_SRAT_MEM_AFFINITY
operator|*
operator|)
name|srat
argument_list|)
expr_stmt|;
break|break;
case|case
name|ACPI_SRAT_TYPE_X2APIC_CPU_AFFINITY
case|:
name|x2apic
operator|=
operator|(
name|ACPI_SRAT_X2APIC_CPU_AFFINITY
operator|*
operator|)
name|srat
expr_stmt|;
name|acpi_print_srat_cpu
argument_list|(
name|x2apic
operator|->
name|ApicId
argument_list|,
name|x2apic
operator|->
name|ProximityDomain
argument_list|,
name|x2apic
operator|->
name|Flags
argument_list|)
expr_stmt|;
break|break;
case|case
name|ACPI_SRAT_TYPE_GICC_AFFINITY
case|:
name|gic
operator|=
operator|(
name|ACPI_SRAT_GICC_AFFINITY
operator|*
operator|)
name|srat
expr_stmt|;
name|acpi_print_srat_cpu
argument_list|(
name|gic
operator|->
name|AcpiProcessorUid
argument_list|,
name|gic
operator|->
name|ProximityDomain
argument_list|,
name|gic
operator|->
name|Flags
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_handle_srat
parameter_list|(
name|ACPI_TABLE_HEADER
modifier|*
name|sdp
parameter_list|)
block|{
name|ACPI_TABLE_SRAT
modifier|*
name|srat
decl_stmt|;
name|printf
argument_list|(
name|BEGIN_COMMENT
argument_list|)
expr_stmt|;
name|acpi_print_sdt
argument_list|(
name|sdp
argument_list|)
expr_stmt|;
name|srat
operator|=
operator|(
name|ACPI_TABLE_SRAT
operator|*
operator|)
name|sdp
expr_stmt|;
name|printf
argument_list|(
literal|"\tTable Revision=%d\n"
argument_list|,
name|srat
operator|->
name|TableRevision
argument_list|)
expr_stmt|;
name|acpi_walk_subtables
argument_list|(
name|sdp
argument_list|,
operator|(
name|srat
operator|+
literal|1
operator|)
argument_list|,
name|acpi_print_srat
argument_list|)
expr_stmt|;
name|printf
argument_list|(
name|END_COMMENT
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_print_sdt
parameter_list|(
name|ACPI_TABLE_HEADER
modifier|*
name|sdp
parameter_list|)
block|{
name|printf
argument_list|(
literal|"  "
argument_list|)
expr_stmt|;
name|acpi_print_string
argument_list|(
name|sdp
operator|->
name|Signature
argument_list|,
name|ACPI_NAME_SIZE
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|": Length=%d, Revision=%d, Checksum=%d,\n"
argument_list|,
name|sdp
operator|->
name|Length
argument_list|,
name|sdp
operator|->
name|Revision
argument_list|,
name|sdp
operator|->
name|Checksum
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tOEMID="
argument_list|)
expr_stmt|;
name|acpi_print_string
argument_list|(
name|sdp
operator|->
name|OemId
argument_list|,
name|ACPI_OEM_ID_SIZE
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|", OEM Table ID="
argument_list|)
expr_stmt|;
name|acpi_print_string
argument_list|(
name|sdp
operator|->
name|OemTableId
argument_list|,
name|ACPI_OEM_TABLE_ID_SIZE
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|", OEM Revision=0x%x,\n"
argument_list|,
name|sdp
operator|->
name|OemRevision
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tCreator ID="
argument_list|)
expr_stmt|;
name|acpi_print_string
argument_list|(
name|sdp
operator|->
name|AslCompilerId
argument_list|,
name|ACPI_NAME_SIZE
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|", Creator Revision=0x%x\n"
argument_list|,
name|sdp
operator|->
name|AslCompilerRevision
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_print_rsdt
parameter_list|(
name|ACPI_TABLE_HEADER
modifier|*
name|rsdp
parameter_list|)
block|{
name|ACPI_TABLE_RSDT
modifier|*
name|rsdt
decl_stmt|;
name|ACPI_TABLE_XSDT
modifier|*
name|xsdt
decl_stmt|;
name|int
name|i
decl_stmt|,
name|entries
decl_stmt|;
name|rsdt
operator|=
operator|(
name|ACPI_TABLE_RSDT
operator|*
operator|)
name|rsdp
expr_stmt|;
name|xsdt
operator|=
operator|(
name|ACPI_TABLE_XSDT
operator|*
operator|)
name|rsdp
expr_stmt|;
name|printf
argument_list|(
name|BEGIN_COMMENT
argument_list|)
expr_stmt|;
name|acpi_print_sdt
argument_list|(
name|rsdp
argument_list|)
expr_stmt|;
name|entries
operator|=
operator|(
name|rsdp
operator|->
name|Length
operator|-
sizeof|sizeof
argument_list|(
name|ACPI_TABLE_HEADER
argument_list|)
operator|)
operator|/
name|addr_size
expr_stmt|;
name|printf
argument_list|(
literal|"\tEntries={ "
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|entries
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|>
literal|0
condition|)
name|printf
argument_list|(
literal|", "
argument_list|)
expr_stmt|;
if|if
condition|(
name|addr_size
operator|==
literal|4
condition|)
name|printf
argument_list|(
literal|"0x%08x"
argument_list|,
name|le32toh
argument_list|(
name|rsdt
operator|->
name|TableOffsetEntry
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"0x%016jx"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|le64toh
argument_list|(
name|xsdt
operator|->
name|TableOffsetEntry
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|" }\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
name|END_COMMENT
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|acpi_pm_profiles
index|[]
init|=
block|{
literal|"Unspecified"
block|,
literal|"Desktop"
block|,
literal|"Mobile"
block|,
literal|"Workstation"
block|,
literal|"Enterprise Server"
block|,
literal|"SOHO Server"
block|,
literal|"Appliance PC"
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|acpi_print_fadt
parameter_list|(
name|ACPI_TABLE_HEADER
modifier|*
name|sdp
parameter_list|)
block|{
name|ACPI_TABLE_FADT
modifier|*
name|fadt
decl_stmt|;
specifier|const
name|char
modifier|*
name|pm
decl_stmt|;
name|fadt
operator|=
operator|(
name|ACPI_TABLE_FADT
operator|*
operator|)
name|sdp
expr_stmt|;
name|printf
argument_list|(
name|BEGIN_COMMENT
argument_list|)
expr_stmt|;
name|acpi_print_sdt
argument_list|(
name|sdp
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" \tFACS=0x%x, DSDT=0x%x\n"
argument_list|,
name|fadt
operator|->
name|Facs
argument_list|,
name|fadt
operator|->
name|Dsdt
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tINT_MODEL=%s\n"
argument_list|,
name|fadt
operator|->
name|Model
condition|?
literal|"APIC"
else|:
literal|"PIC"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fadt
operator|->
name|PreferredProfile
operator|>=
sizeof|sizeof
argument_list|(
name|acpi_pm_profiles
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
condition|)
name|pm
operator|=
literal|"Reserved"
expr_stmt|;
else|else
name|pm
operator|=
name|acpi_pm_profiles
index|[
name|fadt
operator|->
name|PreferredProfile
index|]
expr_stmt|;
name|printf
argument_list|(
literal|"\tPreferred_PM_Profile=%s (%d)\n"
argument_list|,
name|pm
argument_list|,
name|fadt
operator|->
name|PreferredProfile
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tSCI_INT=%d\n"
argument_list|,
name|fadt
operator|->
name|SciInterrupt
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tSMI_CMD=0x%x, "
argument_list|,
name|fadt
operator|->
name|SmiCommand
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"ACPI_ENABLE=0x%x, "
argument_list|,
name|fadt
operator|->
name|AcpiEnable
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"ACPI_DISABLE=0x%x, "
argument_list|,
name|fadt
operator|->
name|AcpiDisable
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"S4BIOS_REQ=0x%x\n"
argument_list|,
name|fadt
operator|->
name|S4BiosRequest
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tPSTATE_CNT=0x%x\n"
argument_list|,
name|fadt
operator|->
name|PstateControl
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tPM1a_EVT_BLK=0x%x-0x%x\n"
argument_list|,
name|fadt
operator|->
name|Pm1aEventBlock
argument_list|,
name|fadt
operator|->
name|Pm1aEventBlock
operator|+
name|fadt
operator|->
name|Pm1EventLength
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|fadt
operator|->
name|Pm1bEventBlock
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"\tPM1b_EVT_BLK=0x%x-0x%x\n"
argument_list|,
name|fadt
operator|->
name|Pm1bEventBlock
argument_list|,
name|fadt
operator|->
name|Pm1bEventBlock
operator|+
name|fadt
operator|->
name|Pm1EventLength
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tPM1a_CNT_BLK=0x%x-0x%x\n"
argument_list|,
name|fadt
operator|->
name|Pm1aControlBlock
argument_list|,
name|fadt
operator|->
name|Pm1aControlBlock
operator|+
name|fadt
operator|->
name|Pm1ControlLength
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|fadt
operator|->
name|Pm1bControlBlock
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"\tPM1b_CNT_BLK=0x%x-0x%x\n"
argument_list|,
name|fadt
operator|->
name|Pm1bControlBlock
argument_list|,
name|fadt
operator|->
name|Pm1bControlBlock
operator|+
name|fadt
operator|->
name|Pm1ControlLength
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|fadt
operator|->
name|Pm2ControlBlock
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"\tPM2_CNT_BLK=0x%x-0x%x\n"
argument_list|,
name|fadt
operator|->
name|Pm2ControlBlock
argument_list|,
name|fadt
operator|->
name|Pm2ControlBlock
operator|+
name|fadt
operator|->
name|Pm2ControlLength
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tPM_TMR_BLK=0x%x-0x%x\n"
argument_list|,
name|fadt
operator|->
name|PmTimerBlock
argument_list|,
name|fadt
operator|->
name|PmTimerBlock
operator|+
name|fadt
operator|->
name|PmTimerLength
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|fadt
operator|->
name|Gpe0Block
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"\tGPE0_BLK=0x%x-0x%x\n"
argument_list|,
name|fadt
operator|->
name|Gpe0Block
argument_list|,
name|fadt
operator|->
name|Gpe0Block
operator|+
name|fadt
operator|->
name|Gpe0BlockLength
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|fadt
operator|->
name|Gpe1Block
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"\tGPE1_BLK=0x%x-0x%x, GPE1_BASE=%d\n"
argument_list|,
name|fadt
operator|->
name|Gpe1Block
argument_list|,
name|fadt
operator|->
name|Gpe1Block
operator|+
name|fadt
operator|->
name|Gpe1BlockLength
operator|-
literal|1
argument_list|,
name|fadt
operator|->
name|Gpe1Base
argument_list|)
expr_stmt|;
if|if
condition|(
name|fadt
operator|->
name|CstControl
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"\tCST_CNT=0x%x\n"
argument_list|,
name|fadt
operator|->
name|CstControl
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tP_LVL2_LAT=%d us, P_LVL3_LAT=%d us\n"
argument_list|,
name|fadt
operator|->
name|C2Latency
argument_list|,
name|fadt
operator|->
name|C3Latency
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tFLUSH_SIZE=%d, FLUSH_STRIDE=%d\n"
argument_list|,
name|fadt
operator|->
name|FlushSize
argument_list|,
name|fadt
operator|->
name|FlushStride
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tDUTY_OFFSET=%d, DUTY_WIDTH=%d\n"
argument_list|,
name|fadt
operator|->
name|DutyOffset
argument_list|,
name|fadt
operator|->
name|DutyWidth
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tDAY_ALRM=%d, MON_ALRM=%d, CENTURY=%d\n"
argument_list|,
name|fadt
operator|->
name|DayAlarm
argument_list|,
name|fadt
operator|->
name|MonthAlarm
argument_list|,
name|fadt
operator|->
name|Century
argument_list|)
expr_stmt|;
define|#
directive|define
name|PRINTFLAG
parameter_list|(
name|var
parameter_list|,
name|flag
parameter_list|)
value|printflag((var), ACPI_FADT_## flag, #flag)
name|printf
argument_list|(
literal|"\tIAPC_BOOT_ARCH="
argument_list|)
expr_stmt|;
name|PRINTFLAG
argument_list|(
name|fadt
operator|->
name|BootFlags
argument_list|,
name|LEGACY_DEVICES
argument_list|)
expr_stmt|;
name|PRINTFLAG
argument_list|(
name|fadt
operator|->
name|BootFlags
argument_list|,
literal|8042
argument_list|)
expr_stmt|;
name|PRINTFLAG
argument_list|(
name|fadt
operator|->
name|BootFlags
argument_list|,
name|NO_VGA
argument_list|)
expr_stmt|;
name|PRINTFLAG
argument_list|(
name|fadt
operator|->
name|BootFlags
argument_list|,
name|NO_MSI
argument_list|)
expr_stmt|;
name|PRINTFLAG
argument_list|(
name|fadt
operator|->
name|BootFlags
argument_list|,
name|NO_ASPM
argument_list|)
expr_stmt|;
name|PRINTFLAG
argument_list|(
name|fadt
operator|->
name|BootFlags
argument_list|,
name|NO_CMOS_RTC
argument_list|)
expr_stmt|;
name|PRINTFLAG_END
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"\tFlags="
argument_list|)
expr_stmt|;
name|PRINTFLAG
argument_list|(
name|fadt
operator|->
name|Flags
argument_list|,
name|WBINVD
argument_list|)
expr_stmt|;
name|PRINTFLAG
argument_list|(
name|fadt
operator|->
name|Flags
argument_list|,
name|WBINVD_FLUSH
argument_list|)
expr_stmt|;
name|PRINTFLAG
argument_list|(
name|fadt
operator|->
name|Flags
argument_list|,
name|C1_SUPPORTED
argument_list|)
expr_stmt|;
name|PRINTFLAG
argument_list|(
name|fadt
operator|->
name|Flags
argument_list|,
name|C2_MP_SUPPORTED
argument_list|)
expr_stmt|;
name|PRINTFLAG
argument_list|(
name|fadt
operator|->
name|Flags
argument_list|,
name|POWER_BUTTON
argument_list|)
expr_stmt|;
name|PRINTFLAG
argument_list|(
name|fadt
operator|->
name|Flags
argument_list|,
name|SLEEP_BUTTON
argument_list|)
expr_stmt|;
name|PRINTFLAG
argument_list|(
name|fadt
operator|->
name|Flags
argument_list|,
name|FIXED_RTC
argument_list|)
expr_stmt|;
name|PRINTFLAG
argument_list|(
name|fadt
operator|->
name|Flags
argument_list|,
name|S4_RTC_WAKE
argument_list|)
expr_stmt|;
name|PRINTFLAG
argument_list|(
name|fadt
operator|->
name|Flags
argument_list|,
literal|32BIT_TIMER
argument_list|)
expr_stmt|;
name|PRINTFLAG
argument_list|(
name|fadt
operator|->
name|Flags
argument_list|,
name|DOCKING_SUPPORTED
argument_list|)
expr_stmt|;
name|PRINTFLAG
argument_list|(
name|fadt
operator|->
name|Flags
argument_list|,
name|RESET_REGISTER
argument_list|)
expr_stmt|;
name|PRINTFLAG
argument_list|(
name|fadt
operator|->
name|Flags
argument_list|,
name|SEALED_CASE
argument_list|)
expr_stmt|;
name|PRINTFLAG
argument_list|(
name|fadt
operator|->
name|Flags
argument_list|,
name|HEADLESS
argument_list|)
expr_stmt|;
name|PRINTFLAG
argument_list|(
name|fadt
operator|->
name|Flags
argument_list|,
name|SLEEP_TYPE
argument_list|)
expr_stmt|;
name|PRINTFLAG
argument_list|(
name|fadt
operator|->
name|Flags
argument_list|,
name|PCI_EXPRESS_WAKE
argument_list|)
expr_stmt|;
name|PRINTFLAG
argument_list|(
name|fadt
operator|->
name|Flags
argument_list|,
name|PLATFORM_CLOCK
argument_list|)
expr_stmt|;
name|PRINTFLAG
argument_list|(
name|fadt
operator|->
name|Flags
argument_list|,
name|S4_RTC_VALID
argument_list|)
expr_stmt|;
name|PRINTFLAG
argument_list|(
name|fadt
operator|->
name|Flags
argument_list|,
name|REMOTE_POWER_ON
argument_list|)
expr_stmt|;
name|PRINTFLAG
argument_list|(
name|fadt
operator|->
name|Flags
argument_list|,
name|APIC_CLUSTER
argument_list|)
expr_stmt|;
name|PRINTFLAG
argument_list|(
name|fadt
operator|->
name|Flags
argument_list|,
name|APIC_PHYSICAL
argument_list|)
expr_stmt|;
name|PRINTFLAG
argument_list|(
name|fadt
operator|->
name|Flags
argument_list|,
name|HW_REDUCED
argument_list|)
expr_stmt|;
name|PRINTFLAG
argument_list|(
name|fadt
operator|->
name|Flags
argument_list|,
name|LOW_POWER_S0
argument_list|)
expr_stmt|;
name|PRINTFLAG_END
argument_list|()
expr_stmt|;
undef|#
directive|undef
name|PRINTFLAG
if|if
condition|(
name|fadt
operator|->
name|Flags
operator|&
name|ACPI_FADT_RESET_REGISTER
condition|)
block|{
name|printf
argument_list|(
literal|"\tRESET_REG="
argument_list|)
expr_stmt|;
name|acpi_print_gas
argument_list|(
operator|&
name|fadt
operator|->
name|ResetRegister
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|", RESET_VALUE=%#x\n"
argument_list|,
name|fadt
operator|->
name|ResetValue
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|acpi_get_fadt_revision
argument_list|(
name|fadt
argument_list|)
operator|>
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"\tX_FACS=0x%016jx, "
argument_list|,
operator|(
name|uintmax_t
operator|)
name|fadt
operator|->
name|XFacs
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"X_DSDT=0x%016jx\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|fadt
operator|->
name|XDsdt
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tX_PM1a_EVT_BLK="
argument_list|)
expr_stmt|;
name|acpi_print_gas
argument_list|(
operator|&
name|fadt
operator|->
name|XPm1aEventBlock
argument_list|)
expr_stmt|;
if|if
condition|(
name|fadt
operator|->
name|XPm1bEventBlock
operator|.
name|Address
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"\n\tX_PM1b_EVT_BLK="
argument_list|)
expr_stmt|;
name|acpi_print_gas
argument_list|(
operator|&
name|fadt
operator|->
name|XPm1bEventBlock
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n\tX_PM1a_CNT_BLK="
argument_list|)
expr_stmt|;
name|acpi_print_gas
argument_list|(
operator|&
name|fadt
operator|->
name|XPm1aControlBlock
argument_list|)
expr_stmt|;
if|if
condition|(
name|fadt
operator|->
name|XPm1bControlBlock
operator|.
name|Address
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"\n\tX_PM1b_CNT_BLK="
argument_list|)
expr_stmt|;
name|acpi_print_gas
argument_list|(
operator|&
name|fadt
operator|->
name|XPm1bControlBlock
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fadt
operator|->
name|XPm2ControlBlock
operator|.
name|Address
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"\n\tX_PM2_CNT_BLK="
argument_list|)
expr_stmt|;
name|acpi_print_gas
argument_list|(
operator|&
name|fadt
operator|->
name|XPm2ControlBlock
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n\tX_PM_TMR_BLK="
argument_list|)
expr_stmt|;
name|acpi_print_gas
argument_list|(
operator|&
name|fadt
operator|->
name|XPmTimerBlock
argument_list|)
expr_stmt|;
if|if
condition|(
name|fadt
operator|->
name|XGpe0Block
operator|.
name|Address
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"\n\tX_GPE0_BLK="
argument_list|)
expr_stmt|;
name|acpi_print_gas
argument_list|(
operator|&
name|fadt
operator|->
name|XGpe0Block
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fadt
operator|->
name|XGpe1Block
operator|.
name|Address
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"\n\tX_GPE1_BLK="
argument_list|)
expr_stmt|;
name|acpi_print_gas
argument_list|(
operator|&
name|fadt
operator|->
name|XGpe1Block
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
name|END_COMMENT
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_print_facs
parameter_list|(
name|ACPI_TABLE_FACS
modifier|*
name|facs
parameter_list|)
block|{
name|printf
argument_list|(
name|BEGIN_COMMENT
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  FACS:\tLength=%u, "
argument_list|,
name|facs
operator|->
name|Length
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"HwSig=0x%08x, "
argument_list|,
name|facs
operator|->
name|HardwareSignature
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Firm_Wake_Vec=0x%08x\n"
argument_list|,
name|facs
operator|->
name|FirmwareWakingVector
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tGlobal_Lock="
argument_list|)
expr_stmt|;
if|if
condition|(
name|facs
operator|->
name|GlobalLock
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|facs
operator|->
name|GlobalLock
operator|&
name|ACPI_GLOCK_PENDING
condition|)
name|printf
argument_list|(
literal|"PENDING,"
argument_list|)
expr_stmt|;
if|if
condition|(
name|facs
operator|->
name|GlobalLock
operator|&
name|ACPI_GLOCK_OWNED
condition|)
name|printf
argument_list|(
literal|"OWNED"
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tFlags="
argument_list|)
expr_stmt|;
if|if
condition|(
name|facs
operator|->
name|Flags
operator|&
name|ACPI_FACS_S4_BIOS_PRESENT
condition|)
name|printf
argument_list|(
literal|"S4BIOS"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|facs
operator|->
name|XFirmwareWakingVector
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"\tX_Firm_Wake_Vec=%016jx\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|facs
operator|->
name|XFirmwareWakingVector
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tVersion=%u\n"
argument_list|,
name|facs
operator|->
name|Version
argument_list|)
expr_stmt|;
name|printf
argument_list|(
name|END_COMMENT
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_print_dsdt
parameter_list|(
name|ACPI_TABLE_HEADER
modifier|*
name|dsdp
parameter_list|)
block|{
name|printf
argument_list|(
name|BEGIN_COMMENT
argument_list|)
expr_stmt|;
name|acpi_print_sdt
argument_list|(
name|dsdp
argument_list|)
expr_stmt|;
name|printf
argument_list|(
name|END_COMMENT
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|acpi_checksum
parameter_list|(
name|void
modifier|*
name|p
parameter_list|,
name|size_t
name|length
parameter_list|)
block|{
name|uint8_t
modifier|*
name|bp
decl_stmt|;
name|uint8_t
name|sum
decl_stmt|;
name|bp
operator|=
name|p
expr_stmt|;
name|sum
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|length
operator|--
condition|)
name|sum
operator|+=
operator|*
name|bp
operator|++
expr_stmt|;
return|return
operator|(
name|sum
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|ACPI_TABLE_HEADER
modifier|*
name|acpi_map_sdt
parameter_list|(
name|vm_offset_t
name|pa
parameter_list|)
block|{
name|ACPI_TABLE_HEADER
modifier|*
name|sp
decl_stmt|;
name|sp
operator|=
name|acpi_map_physical
argument_list|(
name|pa
argument_list|,
sizeof|sizeof
argument_list|(
name|ACPI_TABLE_HEADER
argument_list|)
argument_list|)
expr_stmt|;
name|sp
operator|=
name|acpi_map_physical
argument_list|(
name|pa
argument_list|,
name|sp
operator|->
name|Length
argument_list|)
expr_stmt|;
return|return
operator|(
name|sp
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_print_rsd_ptr
parameter_list|(
name|ACPI_TABLE_RSDP
modifier|*
name|rp
parameter_list|)
block|{
name|printf
argument_list|(
name|BEGIN_COMMENT
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  RSD PTR: OEM="
argument_list|)
expr_stmt|;
name|acpi_print_string
argument_list|(
name|rp
operator|->
name|OemId
argument_list|,
name|ACPI_OEM_ID_SIZE
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|", ACPI_Rev=%s (%d)\n"
argument_list|,
name|rp
operator|->
name|Revision
operator|<
literal|2
condition|?
literal|"1.0x"
else|:
literal|"2.0x"
argument_list|,
name|rp
operator|->
name|Revision
argument_list|)
expr_stmt|;
if|if
condition|(
name|rp
operator|->
name|Revision
operator|<
literal|2
condition|)
block|{
name|printf
argument_list|(
literal|"\tRSDT=0x%08x, cksum=%u\n"
argument_list|,
name|rp
operator|->
name|RsdtPhysicalAddress
argument_list|,
name|rp
operator|->
name|Checksum
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"\tXSDT=0x%016jx, length=%u, cksum=%u\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|rp
operator|->
name|XsdtPhysicalAddress
argument_list|,
name|rp
operator|->
name|Length
argument_list|,
name|rp
operator|->
name|ExtendedChecksum
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
name|END_COMMENT
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_handle_rsdt
parameter_list|(
name|ACPI_TABLE_HEADER
modifier|*
name|rsdp
parameter_list|)
block|{
name|ACPI_TABLE_HEADER
modifier|*
name|sdp
decl_stmt|;
name|ACPI_TABLE_RSDT
modifier|*
name|rsdt
decl_stmt|;
name|ACPI_TABLE_XSDT
modifier|*
name|xsdt
decl_stmt|;
name|vm_offset_t
name|addr
decl_stmt|;
name|int
name|entries
decl_stmt|,
name|i
decl_stmt|;
name|acpi_print_rsdt
argument_list|(
name|rsdp
argument_list|)
expr_stmt|;
name|rsdt
operator|=
operator|(
name|ACPI_TABLE_RSDT
operator|*
operator|)
name|rsdp
expr_stmt|;
name|xsdt
operator|=
operator|(
name|ACPI_TABLE_XSDT
operator|*
operator|)
name|rsdp
expr_stmt|;
name|entries
operator|=
operator|(
name|rsdp
operator|->
name|Length
operator|-
sizeof|sizeof
argument_list|(
name|ACPI_TABLE_HEADER
argument_list|)
operator|)
operator|/
name|addr_size
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|entries
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|addr_size
operator|==
literal|4
condition|)
name|addr
operator|=
name|le32toh
argument_list|(
name|rsdt
operator|->
name|TableOffsetEntry
index|[
name|i
index|]
argument_list|)
expr_stmt|;
else|else
name|addr
operator|=
name|le64toh
argument_list|(
name|xsdt
operator|->
name|TableOffsetEntry
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|addr
operator|==
literal|0
condition|)
continue|continue;
name|sdp
operator|=
operator|(
name|ACPI_TABLE_HEADER
operator|*
operator|)
name|acpi_map_sdt
argument_list|(
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|acpi_checksum
argument_list|(
name|sdp
argument_list|,
name|sdp
operator|->
name|Length
argument_list|)
condition|)
block|{
name|warnx
argument_list|(
literal|"RSDT entry %d (sig %.4s) is corrupt"
argument_list|,
name|i
argument_list|,
name|sdp
operator|->
name|Signature
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|!
name|memcmp
argument_list|(
name|sdp
operator|->
name|Signature
argument_list|,
name|ACPI_SIG_FADT
argument_list|,
literal|4
argument_list|)
condition|)
name|acpi_handle_fadt
argument_list|(
name|sdp
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|memcmp
argument_list|(
name|sdp
operator|->
name|Signature
argument_list|,
name|ACPI_SIG_MADT
argument_list|,
literal|4
argument_list|)
condition|)
name|acpi_handle_madt
argument_list|(
name|sdp
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|memcmp
argument_list|(
name|sdp
operator|->
name|Signature
argument_list|,
name|ACPI_SIG_HPET
argument_list|,
literal|4
argument_list|)
condition|)
name|acpi_handle_hpet
argument_list|(
name|sdp
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|memcmp
argument_list|(
name|sdp
operator|->
name|Signature
argument_list|,
name|ACPI_SIG_ECDT
argument_list|,
literal|4
argument_list|)
condition|)
name|acpi_handle_ecdt
argument_list|(
name|sdp
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|memcmp
argument_list|(
name|sdp
operator|->
name|Signature
argument_list|,
name|ACPI_SIG_MCFG
argument_list|,
literal|4
argument_list|)
condition|)
name|acpi_handle_mcfg
argument_list|(
name|sdp
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|memcmp
argument_list|(
name|sdp
operator|->
name|Signature
argument_list|,
name|ACPI_SIG_SLIT
argument_list|,
literal|4
argument_list|)
condition|)
name|acpi_handle_slit
argument_list|(
name|sdp
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|memcmp
argument_list|(
name|sdp
operator|->
name|Signature
argument_list|,
name|ACPI_SIG_SRAT
argument_list|,
literal|4
argument_list|)
condition|)
name|acpi_handle_srat
argument_list|(
name|sdp
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|memcmp
argument_list|(
name|sdp
operator|->
name|Signature
argument_list|,
name|ACPI_SIG_TCPA
argument_list|,
literal|4
argument_list|)
condition|)
name|acpi_handle_tcpa
argument_list|(
name|sdp
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|memcmp
argument_list|(
name|sdp
operator|->
name|Signature
argument_list|,
name|ACPI_SIG_DMAR
argument_list|,
literal|4
argument_list|)
condition|)
name|acpi_handle_dmar
argument_list|(
name|sdp
argument_list|)
expr_stmt|;
else|else
block|{
name|printf
argument_list|(
name|BEGIN_COMMENT
argument_list|)
expr_stmt|;
name|acpi_print_sdt
argument_list|(
name|sdp
argument_list|)
expr_stmt|;
name|printf
argument_list|(
name|END_COMMENT
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|ACPI_TABLE_HEADER
modifier|*
name|sdt_load_devmem
parameter_list|(
name|void
parameter_list|)
block|{
name|ACPI_TABLE_RSDP
modifier|*
name|rp
decl_stmt|;
name|ACPI_TABLE_HEADER
modifier|*
name|rsdp
decl_stmt|;
name|rp
operator|=
name|acpi_find_rsd_ptr
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|rp
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"Can't find ACPI information"
argument_list|)
expr_stmt|;
if|if
condition|(
name|tflag
condition|)
name|acpi_print_rsd_ptr
argument_list|(
name|rp
argument_list|)
expr_stmt|;
if|if
condition|(
name|rp
operator|->
name|Revision
operator|<
literal|2
condition|)
block|{
name|rsdp
operator|=
operator|(
name|ACPI_TABLE_HEADER
operator|*
operator|)
name|acpi_map_sdt
argument_list|(
name|rp
operator|->
name|RsdtPhysicalAddress
argument_list|)
expr_stmt|;
if|if
condition|(
name|memcmp
argument_list|(
name|rsdp
operator|->
name|Signature
argument_list|,
literal|"RSDT"
argument_list|,
literal|4
argument_list|)
operator|!=
literal|0
operator|||
name|acpi_checksum
argument_list|(
name|rsdp
argument_list|,
name|rsdp
operator|->
name|Length
argument_list|)
operator|!=
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"RSDT is corrupted"
argument_list|)
expr_stmt|;
name|addr_size
operator|=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|rsdp
operator|=
operator|(
name|ACPI_TABLE_HEADER
operator|*
operator|)
name|acpi_map_sdt
argument_list|(
name|rp
operator|->
name|XsdtPhysicalAddress
argument_list|)
expr_stmt|;
if|if
condition|(
name|memcmp
argument_list|(
name|rsdp
operator|->
name|Signature
argument_list|,
literal|"XSDT"
argument_list|,
literal|4
argument_list|)
operator|!=
literal|0
operator|||
name|acpi_checksum
argument_list|(
name|rsdp
argument_list|,
name|rsdp
operator|->
name|Length
argument_list|)
operator|!=
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"XSDT is corrupted"
argument_list|)
expr_stmt|;
name|addr_size
operator|=
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|rsdp
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Write the DSDT to a file, concatenating any SSDTs (if present). */
end_comment

begin_function
specifier|static
name|int
name|write_dsdt
parameter_list|(
name|int
name|fd
parameter_list|,
name|ACPI_TABLE_HEADER
modifier|*
name|rsdt
parameter_list|,
name|ACPI_TABLE_HEADER
modifier|*
name|dsdt
parameter_list|)
block|{
name|ACPI_TABLE_HEADER
name|sdt
decl_stmt|;
name|ACPI_TABLE_HEADER
modifier|*
name|ssdt
decl_stmt|;
name|uint8_t
name|sum
decl_stmt|;
comment|/* Create a new checksum to account for the DSDT and any SSDTs. */
name|sdt
operator|=
operator|*
name|dsdt
expr_stmt|;
if|if
condition|(
name|rsdt
operator|!=
name|NULL
condition|)
block|{
name|sdt
operator|.
name|Checksum
operator|=
literal|0
expr_stmt|;
name|sum
operator|=
name|acpi_checksum
argument_list|(
name|dsdt
operator|+
literal|1
argument_list|,
name|dsdt
operator|->
name|Length
operator|-
sizeof|sizeof
argument_list|(
name|ACPI_TABLE_HEADER
argument_list|)
argument_list|)
expr_stmt|;
name|ssdt
operator|=
name|sdt_from_rsdt
argument_list|(
name|rsdt
argument_list|,
name|ACPI_SIG_SSDT
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
while|while
condition|(
name|ssdt
operator|!=
name|NULL
condition|)
block|{
name|sdt
operator|.
name|Length
operator|+=
name|ssdt
operator|->
name|Length
operator|-
sizeof|sizeof
argument_list|(
name|ACPI_TABLE_HEADER
argument_list|)
expr_stmt|;
name|sum
operator|+=
name|acpi_checksum
argument_list|(
name|ssdt
operator|+
literal|1
argument_list|,
name|ssdt
operator|->
name|Length
operator|-
sizeof|sizeof
argument_list|(
name|ACPI_TABLE_HEADER
argument_list|)
argument_list|)
expr_stmt|;
name|ssdt
operator|=
name|sdt_from_rsdt
argument_list|(
name|rsdt
argument_list|,
name|ACPI_SIG_SSDT
argument_list|,
name|ssdt
argument_list|)
expr_stmt|;
block|}
name|sum
operator|+=
name|acpi_checksum
argument_list|(
operator|&
name|sdt
argument_list|,
sizeof|sizeof
argument_list|(
name|ACPI_TABLE_HEADER
argument_list|)
argument_list|)
expr_stmt|;
name|sdt
operator|.
name|Checksum
operator|-=
name|sum
expr_stmt|;
block|}
comment|/* Write out the DSDT header and body. */
name|write
argument_list|(
name|fd
argument_list|,
operator|&
name|sdt
argument_list|,
sizeof|sizeof
argument_list|(
name|ACPI_TABLE_HEADER
argument_list|)
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|fd
argument_list|,
name|dsdt
operator|+
literal|1
argument_list|,
name|dsdt
operator|->
name|Length
operator|-
sizeof|sizeof
argument_list|(
name|ACPI_TABLE_HEADER
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Write out any SSDTs (if present.) */
if|if
condition|(
name|rsdt
operator|!=
name|NULL
condition|)
block|{
name|ssdt
operator|=
name|sdt_from_rsdt
argument_list|(
name|rsdt
argument_list|,
literal|"SSDT"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
while|while
condition|(
name|ssdt
operator|!=
name|NULL
condition|)
block|{
name|write
argument_list|(
name|fd
argument_list|,
name|ssdt
operator|+
literal|1
argument_list|,
name|ssdt
operator|->
name|Length
operator|-
sizeof|sizeof
argument_list|(
name|ACPI_TABLE_HEADER
argument_list|)
argument_list|)
expr_stmt|;
name|ssdt
operator|=
name|sdt_from_rsdt
argument_list|(
name|rsdt
argument_list|,
literal|"SSDT"
argument_list|,
name|ssdt
argument_list|)
expr_stmt|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dsdt_save_file
parameter_list|(
name|char
modifier|*
name|outfile
parameter_list|,
name|ACPI_TABLE_HEADER
modifier|*
name|rsdt
parameter_list|,
name|ACPI_TABLE_HEADER
modifier|*
name|dsdp
parameter_list|)
block|{
name|int
name|fd
decl_stmt|;
name|mode_t
name|mode
decl_stmt|;
name|assert
argument_list|(
name|outfile
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|mode
operator|=
name|S_IRUSR
operator||
name|S_IWUSR
operator||
name|S_IRGRP
operator||
name|S_IROTH
expr_stmt|;
name|fd
operator|=
name|open
argument_list|(
name|outfile
argument_list|,
name|O_WRONLY
operator||
name|O_CREAT
operator||
name|O_TRUNC
argument_list|,
name|mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"dsdt_save_file"
argument_list|)
expr_stmt|;
return|return;
block|}
name|write_dsdt
argument_list|(
name|fd
argument_list|,
name|rsdt
argument_list|,
name|dsdp
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|aml_disassemble
parameter_list|(
name|ACPI_TABLE_HEADER
modifier|*
name|rsdt
parameter_list|,
name|ACPI_TABLE_HEADER
modifier|*
name|dsdp
parameter_list|)
block|{
name|char
name|buf
index|[
name|PATH_MAX
index|]
decl_stmt|,
name|tmpstr
index|[
name|PATH_MAX
index|]
decl_stmt|,
name|wrkdir
index|[
name|PATH_MAX
index|]
decl_stmt|;
specifier|const
name|char
modifier|*
name|iname
init|=
literal|"/acpdump.din"
decl_stmt|;
specifier|const
name|char
modifier|*
name|oname
init|=
literal|"/acpdump.dsl"
decl_stmt|;
specifier|const
name|char
modifier|*
name|tmpdir
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|int
name|fd
decl_stmt|,
name|status
decl_stmt|;
name|pid_t
name|pid
decl_stmt|;
name|tmpdir
operator|=
name|getenv
argument_list|(
literal|"TMPDIR"
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmpdir
operator|==
name|NULL
condition|)
name|tmpdir
operator|=
name|_PATH_TMP
expr_stmt|;
if|if
condition|(
name|realpath
argument_list|(
name|tmpdir
argument_list|,
name|buf
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|perror
argument_list|(
literal|"realpath tmp dir"
argument_list|)
expr_stmt|;
return|return;
block|}
name|len
operator|=
sizeof|sizeof
argument_list|(
name|wrkdir
argument_list|)
operator|-
name|strlen
argument_list|(
name|iname
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|size_t
operator|)
name|snprintf
argument_list|(
name|wrkdir
argument_list|,
name|len
argument_list|,
literal|"%s/acpidump.XXXXXX"
argument_list|,
name|buf
argument_list|)
operator|>
name|len
operator|-
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"$TMPDIR too long\n"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|mkdtemp
argument_list|(
name|wrkdir
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|perror
argument_list|(
literal|"mkdtemp tmp working dir"
argument_list|)
expr_stmt|;
return|return;
block|}
name|len
operator|=
operator|(
name|size_t
operator|)
name|snprintf
argument_list|(
name|tmpstr
argument_list|,
sizeof|sizeof
argument_list|(
name|tmpstr
argument_list|)
argument_list|,
literal|"%s%s"
argument_list|,
name|wrkdir
argument_list|,
name|iname
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|len
operator|<=
sizeof|sizeof
argument_list|(
name|tmpstr
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|fd
operator|=
name|open
argument_list|(
name|tmpstr
argument_list|,
name|O_CREAT
operator||
name|O_WRONLY
argument_list|,
name|S_IRUSR
operator||
name|S_IWUSR
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"iasl tmp file"
argument_list|)
expr_stmt|;
return|return;
block|}
name|write_dsdt
argument_list|(
name|fd
argument_list|,
name|rsdt
argument_list|,
name|dsdp
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
comment|/* Run iasl -d on the temp file */
if|if
condition|(
operator|(
name|pid
operator|=
name|fork
argument_list|()
operator|)
operator|==
literal|0
condition|)
block|{
name|close
argument_list|(
name|STDOUT_FILENO
argument_list|)
expr_stmt|;
if|if
condition|(
name|vflag
operator|==
literal|0
condition|)
name|close
argument_list|(
name|STDERR_FILENO
argument_list|)
expr_stmt|;
name|execl
argument_list|(
literal|"/usr/sbin/iasl"
argument_list|,
literal|"iasl"
argument_list|,
literal|"-d"
argument_list|,
name|tmpstr
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|err
argument_list|(
literal|1
argument_list|,
literal|"exec"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pid
operator|>
literal|0
condition|)
name|wait
argument_list|(
operator|&
name|status
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlink
argument_list|(
name|tmpstr
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"unlink"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|pid
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"fork"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|status
operator|!=
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"iast exit status = %d\n"
argument_list|,
name|status
argument_list|)
expr_stmt|;
block|}
comment|/* Dump iasl's output to stdout */
name|len
operator|=
operator|(
name|size_t
operator|)
name|snprintf
argument_list|(
name|tmpstr
argument_list|,
sizeof|sizeof
argument_list|(
name|tmpstr
argument_list|)
argument_list|,
literal|"%s%s"
argument_list|,
name|wrkdir
argument_list|,
name|oname
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|len
operator|<=
sizeof|sizeof
argument_list|(
name|tmpstr
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|fp
operator|=
name|fopen
argument_list|(
name|tmpstr
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlink
argument_list|(
name|tmpstr
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"unlink"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|fp
operator|==
name|NULL
condition|)
block|{
name|perror
argument_list|(
literal|"iasl tmp file (read)"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
while|while
condition|(
operator|(
name|len
operator|=
name|fread
argument_list|(
name|buf
argument_list|,
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|fp
argument_list|)
operator|)
operator|>
literal|0
condition|)
name|fwrite
argument_list|(
name|buf
argument_list|,
literal|1
argument_list|,
name|len
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|out
label|:
if|if
condition|(
name|rmdir
argument_list|(
name|wrkdir
argument_list|)
operator|<
literal|0
condition|)
name|perror
argument_list|(
literal|"rmdir"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|sdt_print_all
parameter_list|(
name|ACPI_TABLE_HEADER
modifier|*
name|rsdp
parameter_list|)
block|{
name|acpi_handle_rsdt
argument_list|(
name|rsdp
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Fetch a table matching the given signature via the RSDT. */
end_comment

begin_function
name|ACPI_TABLE_HEADER
modifier|*
name|sdt_from_rsdt
parameter_list|(
name|ACPI_TABLE_HEADER
modifier|*
name|rsdp
parameter_list|,
specifier|const
name|char
modifier|*
name|sig
parameter_list|,
name|ACPI_TABLE_HEADER
modifier|*
name|last
parameter_list|)
block|{
name|ACPI_TABLE_HEADER
modifier|*
name|sdt
decl_stmt|;
name|ACPI_TABLE_RSDT
modifier|*
name|rsdt
decl_stmt|;
name|ACPI_TABLE_XSDT
modifier|*
name|xsdt
decl_stmt|;
name|vm_offset_t
name|addr
decl_stmt|;
name|int
name|entries
decl_stmt|,
name|i
decl_stmt|;
name|rsdt
operator|=
operator|(
name|ACPI_TABLE_RSDT
operator|*
operator|)
name|rsdp
expr_stmt|;
name|xsdt
operator|=
operator|(
name|ACPI_TABLE_XSDT
operator|*
operator|)
name|rsdp
expr_stmt|;
name|entries
operator|=
operator|(
name|rsdp
operator|->
name|Length
operator|-
sizeof|sizeof
argument_list|(
name|ACPI_TABLE_HEADER
argument_list|)
operator|)
operator|/
name|addr_size
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|entries
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|addr_size
operator|==
literal|4
condition|)
name|addr
operator|=
name|le32toh
argument_list|(
name|rsdt
operator|->
name|TableOffsetEntry
index|[
name|i
index|]
argument_list|)
expr_stmt|;
else|else
name|addr
operator|=
name|le64toh
argument_list|(
name|xsdt
operator|->
name|TableOffsetEntry
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|addr
operator|==
literal|0
condition|)
continue|continue;
name|sdt
operator|=
operator|(
name|ACPI_TABLE_HEADER
operator|*
operator|)
name|acpi_map_sdt
argument_list|(
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|last
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|sdt
operator|==
name|last
condition|)
name|last
operator|=
name|NULL
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|memcmp
argument_list|(
name|sdt
operator|->
name|Signature
argument_list|,
name|sig
argument_list|,
name|strlen
argument_list|(
name|sig
argument_list|)
argument_list|)
condition|)
continue|continue;
if|if
condition|(
name|acpi_checksum
argument_list|(
name|sdt
argument_list|,
name|sdt
operator|->
name|Length
argument_list|)
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"RSDT entry %d is corrupt"
argument_list|,
name|i
argument_list|)
expr_stmt|;
return|return
operator|(
name|sdt
operator|)
return|;
block|}
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_function
name|ACPI_TABLE_HEADER
modifier|*
name|dsdt_from_fadt
parameter_list|(
name|ACPI_TABLE_FADT
modifier|*
name|fadt
parameter_list|)
block|{
name|ACPI_TABLE_HEADER
modifier|*
name|sdt
decl_stmt|;
comment|/* Use the DSDT address if it is version 1, otherwise use XDSDT. */
if|if
condition|(
name|acpi_get_fadt_revision
argument_list|(
name|fadt
argument_list|)
operator|==
literal|1
condition|)
name|sdt
operator|=
operator|(
name|ACPI_TABLE_HEADER
operator|*
operator|)
name|acpi_map_sdt
argument_list|(
name|fadt
operator|->
name|Dsdt
argument_list|)
expr_stmt|;
else|else
name|sdt
operator|=
operator|(
name|ACPI_TABLE_HEADER
operator|*
operator|)
name|acpi_map_sdt
argument_list|(
name|fadt
operator|->
name|XDsdt
argument_list|)
expr_stmt|;
if|if
condition|(
name|acpi_checksum
argument_list|(
name|sdt
argument_list|,
name|sdt
operator|->
name|Length
argument_list|)
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"DSDT is corrupt\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|sdt
operator|)
return|;
block|}
end_function

end_unit


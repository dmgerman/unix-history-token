begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 1999, 2000 Mitsuru IWASAKI<iwasaki@FreeBSD.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  *	$Id: aml_memman.c,v 1.10 2000/08/09 14:47:43 iwasaki Exp $  *	$FreeBSD$  */
end_comment

begin_comment
comment|/*  * Generic Memory Management  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<aml/aml_memman.h>
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|_KERNEL
end_ifndef

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* _KERNEL */
end_comment

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_expr_stmt
name|MALLOC_DEFINE
argument_list|(
name|M_MEMMAN
argument_list|,
literal|"memman"
argument_list|,
literal|"Generic and Simple Memory Management"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* !_KERNEL */
end_comment

begin_decl_stmt
name|unsigned
name|int
name|memid_unkown
init|=
literal|255
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|int
name|manage_block
parameter_list|(
name|struct
name|memman
modifier|*
name|memman
parameter_list|,
name|unsigned
name|int
name|id
parameter_list|,
name|void
modifier|*
name|block
parameter_list|,
name|unsigned
name|static_mem
parameter_list|,
name|unsigned
name|entries
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|blockman_init
parameter_list|(
name|struct
name|memman
modifier|*
name|memman
parameter_list|,
name|unsigned
name|int
name|id
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|memman_flexsize_add_histogram
parameter_list|(
name|struct
name|memman
modifier|*
name|memman
parameter_list|,
name|size_t
name|size
parameter_list|,
name|int
name|tolerance
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|memman_comp_histogram_size
parameter_list|(
specifier|const
name|void
modifier|*
name|a
parameter_list|,
specifier|const
name|void
modifier|*
name|b
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|memman_sort_histogram_by_size
parameter_list|(
name|struct
name|memman
modifier|*
name|memman
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|unsigned
name|int
name|memman_guess_memid
parameter_list|(
name|struct
name|memman
modifier|*
name|memman
parameter_list|,
name|void
modifier|*
name|chunk
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|memman_statistics_fixedsize
parameter_list|(
name|struct
name|memman
modifier|*
name|memman
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|memman_statistics_flexsize
parameter_list|(
name|struct
name|memman
modifier|*
name|memman
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|int
name|manage_block
parameter_list|(
name|struct
name|memman
modifier|*
name|memman
parameter_list|,
name|unsigned
name|int
name|id
parameter_list|,
name|void
modifier|*
name|block
parameter_list|,
name|unsigned
name|static_mem
parameter_list|,
name|unsigned
name|entries
parameter_list|)
block|{
name|unsigned
name|int
name|i
decl_stmt|;
name|size_t
name|alloc_size
decl_stmt|;
name|void
modifier|*
name|tmp
decl_stmt|,
modifier|*
name|realblock
decl_stmt|;
name|struct
name|memman_blockman
modifier|*
name|bmp
decl_stmt|;
name|struct
name|memman_block
modifier|*
name|memblock
decl_stmt|;
name|struct
name|memman_node
modifier|*
name|memnodes
decl_stmt|;
name|bmp
operator|=
operator|&
name|memman
operator|->
name|blockman
index|[
name|id
index|]
expr_stmt|;
name|alloc_size
operator|=
name|MEMMAN_BLOCKNODE_SIZE
argument_list|(
name|entries
argument_list|)
expr_stmt|;
if|if
condition|(
name|static_mem
condition|)
block|{
name|tmp
operator|=
operator|(
name|void
operator|*
operator|)
name|block
expr_stmt|;
name|realblock
operator|=
operator|(
name|char
operator|*
operator|)
name|block
operator|+
name|alloc_size
expr_stmt|;
block|}
else|else
block|{
name|tmp
operator|=
name|MEMMAN_SYSMALLOC
argument_list|(
name|alloc_size
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tmp
condition|)
block|{
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|realblock
operator|=
name|block
expr_stmt|;
name|memman
operator|->
name|allocated_mem
operator|+=
name|alloc_size
expr_stmt|;
name|memman
operator|->
name|salloc_called
operator|++
expr_stmt|;
block|}
name|memblock
operator|=
operator|(
expr|struct
name|memman_block
operator|*
operator|)
name|tmp
expr_stmt|;
name|memnodes
operator|=
operator|(
expr|struct
name|memman_node
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|tmp
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|memman_block
argument_list|)
operator|)
expr_stmt|;
name|memblock
operator|->
name|block
operator|=
name|realblock
expr_stmt|;
name|memblock
operator|->
name|static_mem
operator|=
name|static_mem
expr_stmt|;
name|memblock
operator|->
name|allocated
operator|=
name|entries
expr_stmt|;
name|memblock
operator|->
name|available
operator|=
name|entries
expr_stmt|;
if|if
condition|(
operator|!
name|static_mem
condition|)
block|{
name|alloc_size
operator|+=
name|roundup
argument_list|(
name|bmp
operator|->
name|size
operator|*
name|entries
argument_list|,
name|ROUNDUP_UNIT
argument_list|)
expr_stmt|;
block|}
name|memblock
operator|->
name|allocated_mem
operator|=
name|alloc_size
expr_stmt|;
name|LIST_INSERT_HEAD
argument_list|(
operator|&
name|bmp
operator|->
name|block_list
argument_list|,
name|memblock
argument_list|,
name|links
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|entries
condition|;
operator|++
name|i
control|)
block|{
name|memnodes
index|[
name|i
index|]
operator|.
name|node
operator|=
operator|(
operator|(
name|char
operator|*
operator|)
name|realblock
operator|+
operator|(
name|i
operator|*
operator|(
name|bmp
operator|->
name|size
operator|)
operator|)
operator|)
expr_stmt|;
name|memnodes
index|[
name|i
index|]
operator|.
name|memblock
operator|=
name|memblock
expr_stmt|;
name|LIST_INSERT_HEAD
argument_list|(
operator|&
name|bmp
operator|->
name|free_node_list
argument_list|,
operator|&
name|memnodes
index|[
name|i
index|]
argument_list|,
name|links
argument_list|)
expr_stmt|;
block|}
name|bmp
operator|->
name|available
operator|=
name|entries
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|blockman_init
parameter_list|(
name|struct
name|memman
modifier|*
name|memman
parameter_list|,
name|unsigned
name|int
name|id
parameter_list|)
block|{
name|int
name|status
decl_stmt|;
name|struct
name|memman_blockman
modifier|*
name|bmp
decl_stmt|;
name|bmp
operator|=
operator|&
name|memman
operator|->
name|blockman
index|[
name|id
index|]
expr_stmt|;
name|bmp
operator|->
name|initialized
operator|=
literal|1
expr_stmt|;
name|LIST_INIT
argument_list|(
operator|&
name|bmp
operator|->
name|block_list
argument_list|)
expr_stmt|;
name|LIST_INIT
argument_list|(
operator|&
name|bmp
operator|->
name|free_node_list
argument_list|)
expr_stmt|;
name|LIST_INIT
argument_list|(
operator|&
name|bmp
operator|->
name|occupied_node_list
argument_list|)
expr_stmt|;
name|status
operator|=
name|manage_block
argument_list|(
name|memman
argument_list|,
name|id
argument_list|,
name|bmp
operator|->
name|initial_block
argument_list|,
literal|1
argument_list|,
name|MEMMAN_INITIAL_SIZE
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_function
name|void
modifier|*
name|memman_alloc
parameter_list|(
name|struct
name|memman
modifier|*
name|memman
parameter_list|,
name|unsigned
name|int
name|id
parameter_list|)
block|{
name|size_t
name|alloc_size
decl_stmt|;
name|void
modifier|*
name|chunk
decl_stmt|,
modifier|*
name|block
decl_stmt|;
name|struct
name|memman_blockman
modifier|*
name|bmp
decl_stmt|;
name|struct
name|memman_node
modifier|*
name|memnode
decl_stmt|;
if|if
condition|(
name|memman
operator|->
name|max_memid
operator|<=
name|id
condition|)
block|{
name|printf
argument_list|(
literal|"memman_alloc: invalid memory type id\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|bmp
operator|=
operator|&
name|memman
operator|->
name|blockman
index|[
name|id
index|]
expr_stmt|;
if|if
condition|(
operator|!
name|bmp
operator|->
name|initialized
condition|)
block|{
if|if
condition|(
name|blockman_init
argument_list|(
name|memman
argument_list|,
name|id
argument_list|)
condition|)
block|{
goto|goto
name|malloc_fail
goto|;
block|}
block|}
name|memman
operator|->
name|alloc_called
operator|++
expr_stmt|;
if|if
condition|(
name|bmp
operator|->
name|available
operator|==
literal|0
condition|)
block|{
name|alloc_size
operator|=
name|roundup
argument_list|(
name|bmp
operator|->
name|size
operator|*
name|MEMMAN_INCR_SIZE
argument_list|,
name|ROUNDUP_UNIT
argument_list|)
expr_stmt|;
name|block
operator|=
name|MEMMAN_SYSMALLOC
argument_list|(
name|alloc_size
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block
condition|)
block|{
goto|goto
name|malloc_fail
goto|;
block|}
name|memman
operator|->
name|required_mem
operator|+=
name|bmp
operator|->
name|size
operator|*
name|MEMMAN_INCR_SIZE
expr_stmt|;
name|memman
operator|->
name|allocated_mem
operator|+=
name|alloc_size
expr_stmt|;
name|memman
operator|->
name|salloc_called
operator|++
expr_stmt|;
if|if
condition|(
name|manage_block
argument_list|(
name|memman
argument_list|,
name|id
argument_list|,
name|block
argument_list|,
literal|0
argument_list|,
name|MEMMAN_INCR_SIZE
argument_list|)
condition|)
block|{
goto|goto
name|malloc_fail
goto|;
block|}
block|}
name|memnode
operator|=
name|LIST_FIRST
argument_list|(
operator|&
name|bmp
operator|->
name|free_node_list
argument_list|)
expr_stmt|;
name|LIST_REMOVE
argument_list|(
name|memnode
argument_list|,
name|links
argument_list|)
expr_stmt|;
name|chunk
operator|=
name|memnode
operator|->
name|node
expr_stmt|;
name|LIST_INSERT_HEAD
argument_list|(
operator|&
name|bmp
operator|->
name|occupied_node_list
argument_list|,
name|memnode
argument_list|,
name|links
argument_list|)
expr_stmt|;
name|memnode
operator|->
name|memblock
operator|->
name|available
operator|--
expr_stmt|;
name|bmp
operator|->
name|available
operator|--
expr_stmt|;
return|return
operator|(
name|chunk
operator|)
return|;
name|malloc_fail
label|:
name|printf
argument_list|(
literal|"memman_alloc: could not allocate memory\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|memman_flexsize_add_histogram
parameter_list|(
name|struct
name|memman
modifier|*
name|memman
parameter_list|,
name|size_t
name|size
parameter_list|,
name|int
name|tolerance
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|gap
decl_stmt|;
if|if
condition|(
name|size
operator|==
literal|0
condition|)
block|{
return|return;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|memman
operator|->
name|flex_mem_histogram_ptr
condition|;
name|i
operator|++
control|)
block|{
name|gap
operator|=
name|memman
operator|->
name|flex_mem_histogram
index|[
name|i
index|]
operator|.
name|mem_size
operator|-
name|size
expr_stmt|;
if|if
condition|(
name|gap
operator|>=
operator|(
name|tolerance
operator|*
operator|-
literal|1
operator|)
operator|&&
name|gap
operator|<=
name|tolerance
condition|)
block|{
name|memman
operator|->
name|flex_mem_histogram
index|[
name|i
index|]
operator|.
name|count
operator|++
expr_stmt|;
if|if
condition|(
name|memman
operator|->
name|flex_mem_histogram
index|[
name|i
index|]
operator|.
name|mem_size
operator|<
name|size
condition|)
block|{
name|memman
operator|->
name|flex_mem_histogram
index|[
name|i
index|]
operator|.
name|mem_size
operator|=
name|size
expr_stmt|;
block|}
return|return;
block|}
block|}
if|if
condition|(
name|memman
operator|->
name|flex_mem_histogram_ptr
operator|==
name|MEMMAN_HISTOGRAM_SIZE
condition|)
block|{
name|memman_flexsize_add_histogram
argument_list|(
name|memman
argument_list|,
name|size
argument_list|,
name|tolerance
operator|+
literal|1
argument_list|)
expr_stmt|;
return|return;
block|}
name|i
operator|=
name|memman
operator|->
name|flex_mem_histogram_ptr
expr_stmt|;
name|memman
operator|->
name|flex_mem_histogram
index|[
name|i
index|]
operator|.
name|mem_size
operator|=
name|size
expr_stmt|;
name|memman
operator|->
name|flex_mem_histogram
index|[
name|i
index|]
operator|.
name|count
operator|=
literal|1
expr_stmt|;
name|memman
operator|->
name|flex_mem_histogram_ptr
operator|++
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|memman_comp_histogram_size
parameter_list|(
specifier|const
name|void
modifier|*
name|a
parameter_list|,
specifier|const
name|void
modifier|*
name|b
parameter_list|)
block|{
name|int
name|delta
decl_stmt|;
name|delta
operator|=
operator|(
operator|(
specifier|const
expr|struct
name|memman_histogram
operator|*
operator|)
name|a
operator|)
operator|->
name|mem_size
operator|-
operator|(
operator|(
specifier|const
expr|struct
name|memman_histogram
operator|*
operator|)
name|b
operator|)
operator|->
name|mem_size
expr_stmt|;
return|return
operator|(
name|delta
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|memman_sort_histogram_by_size
parameter_list|(
name|struct
name|memman
modifier|*
name|memman
parameter_list|)
block|{
name|qsort
argument_list|(
name|memman
operator|->
name|flex_mem_histogram
argument_list|,
name|memman
operator|->
name|flex_mem_histogram_ptr
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|memman_histogram
argument_list|)
argument_list|,
name|memman_comp_histogram_size
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
modifier|*
name|memman_alloc_flexsize
parameter_list|(
name|struct
name|memman
modifier|*
name|memman
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
name|void
modifier|*
name|mem
decl_stmt|;
name|struct
name|memman_flexmem_info
modifier|*
name|info
decl_stmt|;
if|if
condition|(
name|size
operator|==
literal|0
condition|)
block|{
return|return
operator|(
name|NULL
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|mem
operator|=
name|MEMMAN_SYSMALLOC
argument_list|(
name|size
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
comment|/* XXX */
name|info
operator|=
name|MEMMAN_SYSMALLOC
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|memman_flexmem_info
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|info
condition|)
block|{
if|if
condition|(
operator|!
name|memman
operator|->
name|flex_mem_initialized
condition|)
block|{
name|LIST_INIT
argument_list|(
operator|&
name|memman
operator|->
name|flexmem_info_list
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|memman
operator|->
name|flex_mem_histogram
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|memman_histogram
argument_list|)
argument_list|)
expr_stmt|;
name|memman
operator|->
name|flex_mem_initialized
operator|=
literal|1
expr_stmt|;
block|}
name|info
operator|->
name|addr
operator|=
name|mem
expr_stmt|;
name|info
operator|->
name|mem_size
operator|=
name|size
expr_stmt|;
name|LIST_INSERT_HEAD
argument_list|(
operator|&
name|memman
operator|->
name|flexmem_info_list
argument_list|,
name|info
argument_list|,
name|links
argument_list|)
expr_stmt|;
block|}
name|memman
operator|->
name|flex_alloc_called
operator|++
expr_stmt|;
name|memman
operator|->
name|flex_salloc_called
operator|++
expr_stmt|;
name|memman
operator|->
name|flex_required_mem
operator|+=
name|size
expr_stmt|;
name|memman
operator|->
name|flex_allocated_mem
operator|+=
name|size
expr_stmt|;
if|if
condition|(
name|memman
operator|->
name|flex_mem_size_min
operator|==
literal|0
operator|||
name|memman
operator|->
name|flex_mem_size_min
operator|>
name|size
condition|)
block|{
name|memman
operator|->
name|flex_mem_size_min
operator|=
name|size
expr_stmt|;
block|}
if|if
condition|(
name|memman
operator|->
name|flex_mem_size_max
operator|<
name|size
condition|)
block|{
name|memman
operator|->
name|flex_mem_size_max
operator|=
name|size
expr_stmt|;
block|}
if|if
condition|(
name|memman
operator|->
name|flex_peak_mem_usage
operator|<
operator|(
name|memman
operator|->
name|flex_allocated_mem
operator|-
name|memman
operator|->
name|flex_reclaimed_mem
operator|)
condition|)
block|{
name|memman
operator|->
name|flex_peak_mem_usage
operator|=
operator|(
name|memman
operator|->
name|flex_allocated_mem
operator|-
name|memman
operator|->
name|flex_reclaimed_mem
operator|)
expr_stmt|;
block|}
name|memman_flexsize_add_histogram
argument_list|(
name|memman
argument_list|,
name|size
argument_list|,
name|memman
operator|->
name|flex_mem_histogram_initial_tolerance
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|mem
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|unsigned
name|int
name|memman_guess_memid
parameter_list|(
name|struct
name|memman
modifier|*
name|memman
parameter_list|,
name|void
modifier|*
name|chunk
parameter_list|)
block|{
name|unsigned
name|int
name|id
decl_stmt|;
name|struct
name|memman_blockman
modifier|*
name|bmp
decl_stmt|;
name|struct
name|memman_node
modifier|*
name|memnode
decl_stmt|;
for|for
control|(
name|id
operator|=
literal|0
init|;
name|id
operator|<
name|memman
operator|->
name|max_memid
condition|;
name|id
operator|++
control|)
block|{
name|bmp
operator|=
operator|&
name|memman
operator|->
name|blockman
index|[
name|id
index|]
expr_stmt|;
if|if
condition|(
operator|!
name|bmp
operator|->
name|initialized
condition|)
block|{
if|if
condition|(
name|blockman_init
argument_list|(
name|memman
argument_list|,
name|id
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"memman_free: could not initialized\n"
argument_list|)
expr_stmt|;
block|}
block|}
name|LIST_FOREACH
argument_list|(
argument|memnode
argument_list|,
argument|&bmp->occupied_node_list
argument_list|,
argument|links
argument_list|)
block|{
if|if
condition|(
name|memnode
operator|->
name|node
operator|==
name|chunk
condition|)
block|{
return|return
operator|(
name|id
operator|)
return|;
comment|/* got it! */
block|}
block|}
block|}
return|return
operator|(
name|memid_unkown
operator|)
return|;
comment|/* gave up */
block|}
end_function

begin_function
name|void
name|memman_free
parameter_list|(
name|struct
name|memman
modifier|*
name|memman
parameter_list|,
name|unsigned
name|int
name|memid
parameter_list|,
name|void
modifier|*
name|chunk
parameter_list|)
block|{
name|unsigned
name|int
name|id
decl_stmt|;
name|unsigned
name|found
decl_stmt|;
name|void
modifier|*
name|block
decl_stmt|;
name|struct
name|memman_blockman
modifier|*
name|bmp
decl_stmt|;
name|struct
name|memman_block
modifier|*
name|memblock
decl_stmt|;
name|struct
name|memman_node
modifier|*
name|memnode
decl_stmt|;
name|id
operator|=
name|memid
expr_stmt|;
if|if
condition|(
name|memid
operator|==
name|memid_unkown
condition|)
block|{
name|id
operator|=
name|memman_guess_memid
argument_list|(
name|memman
argument_list|,
name|chunk
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|memman
operator|->
name|max_memid
operator|<=
name|id
condition|)
block|{
name|printf
argument_list|(
literal|"memman_free: invalid memory type id\n"
argument_list|)
expr_stmt|;
name|MEMMAN_SYSABORT
argument_list|()
expr_stmt|;
return|return;
block|}
name|bmp
operator|=
operator|&
name|memman
operator|->
name|blockman
index|[
name|id
index|]
expr_stmt|;
if|if
condition|(
operator|!
name|bmp
operator|->
name|initialized
condition|)
block|{
if|if
condition|(
name|blockman_init
argument_list|(
name|memman
argument_list|,
name|id
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"memman_free: could not initialized\n"
argument_list|)
expr_stmt|;
block|}
block|}
name|found
operator|=
literal|0
expr_stmt|;
name|LIST_FOREACH
argument_list|(
argument|memnode
argument_list|,
argument|&bmp->occupied_node_list
argument_list|,
argument|links
argument_list|)
block|{
if|if
condition|(
name|memnode
operator|->
name|node
operator|==
name|chunk
condition|)
block|{
name|found
operator|=
literal|1
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
operator|!
name|found
condition|)
block|{
name|printf
argument_list|(
literal|"memman_free: invalid address\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|memman
operator|->
name|free_called
operator|++
expr_stmt|;
name|LIST_REMOVE
argument_list|(
name|memnode
argument_list|,
name|links
argument_list|)
expr_stmt|;
name|memblock
operator|=
name|memnode
operator|->
name|memblock
expr_stmt|;
name|memblock
operator|->
name|available
operator|++
expr_stmt|;
name|LIST_INSERT_HEAD
argument_list|(
operator|&
name|bmp
operator|->
name|free_node_list
argument_list|,
name|memnode
argument_list|,
name|links
argument_list|)
expr_stmt|;
name|bmp
operator|->
name|available
operator|++
expr_stmt|;
if|if
condition|(
operator|!
name|memblock
operator|->
name|static_mem
operator|&&
name|memblock
operator|->
name|available
operator|==
name|memblock
operator|->
name|allocated
condition|)
block|{
name|LIST_FOREACH
argument_list|(
argument|memnode
argument_list|,
argument|&bmp->free_node_list
argument_list|,
argument|links
argument_list|)
block|{
if|if
condition|(
name|memnode
operator|->
name|memblock
operator|!=
name|memblock
condition|)
block|{
continue|continue;
block|}
name|LIST_REMOVE
argument_list|(
name|memnode
argument_list|,
name|links
argument_list|)
expr_stmt|;
name|bmp
operator|->
name|available
operator|--
expr_stmt|;
block|}
name|block
operator|=
name|memblock
operator|->
name|block
expr_stmt|;
name|MEMMAN_SYSFREE
argument_list|(
name|block
argument_list|)
expr_stmt|;
name|memman
operator|->
name|sfree_called
operator|++
expr_stmt|;
name|LIST_REMOVE
argument_list|(
name|memblock
argument_list|,
name|links
argument_list|)
expr_stmt|;
name|memman
operator|->
name|sfree_called
operator|++
expr_stmt|;
name|memman
operator|->
name|reclaimed_mem
operator|+=
name|memblock
operator|->
name|allocated_mem
expr_stmt|;
name|MEMMAN_SYSFREE
argument_list|(
name|memblock
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|memman_free_flexsize
parameter_list|(
name|struct
name|memman
modifier|*
name|memman
parameter_list|,
name|void
modifier|*
name|chunk
parameter_list|)
block|{
name|struct
name|memman_flexmem_info
modifier|*
name|info
decl_stmt|;
name|LIST_FOREACH
argument_list|(
argument|info
argument_list|,
argument|&memman->flexmem_info_list
argument_list|,
argument|links
argument_list|)
block|{
if|if
condition|(
name|info
operator|->
name|addr
operator|==
name|chunk
condition|)
block|{
name|memman
operator|->
name|flex_reclaimed_mem
operator|+=
name|info
operator|->
name|mem_size
expr_stmt|;
name|LIST_REMOVE
argument_list|(
name|info
argument_list|,
name|links
argument_list|)
expr_stmt|;
name|MEMMAN_SYSFREE
argument_list|(
name|info
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
comment|/* XXX */
name|memman
operator|->
name|flex_free_called
operator|++
expr_stmt|;
name|memman
operator|->
name|flex_sfree_called
operator|++
expr_stmt|;
name|MEMMAN_SYSFREE
argument_list|(
name|chunk
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|memman_freeall
parameter_list|(
name|struct
name|memman
modifier|*
name|memman
parameter_list|)
block|{
name|int
name|id
decl_stmt|;
name|void
modifier|*
name|chunk
decl_stmt|;
name|struct
name|memman_blockman
modifier|*
name|bmp
decl_stmt|;
name|struct
name|memman_node
modifier|*
name|memnode
decl_stmt|;
name|struct
name|memman_block
modifier|*
name|memblock
decl_stmt|;
name|struct
name|memman_flexmem_info
modifier|*
name|info
decl_stmt|;
for|for
control|(
name|id
operator|=
literal|0
init|;
name|id
operator|<
name|memman
operator|->
name|max_memid
condition|;
name|id
operator|++
control|)
block|{
name|bmp
operator|=
operator|&
name|memman
operator|->
name|blockman
index|[
name|id
index|]
expr_stmt|;
while|while
condition|(
operator|(
name|memnode
operator|=
name|LIST_FIRST
argument_list|(
operator|&
name|bmp
operator|->
name|occupied_node_list
argument_list|)
operator|)
condition|)
block|{
name|chunk
operator|=
name|memnode
operator|->
name|node
expr_stmt|;
name|printf
argument_list|(
literal|"memman_freeall: fixed size (id = %d)\n"
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|memman_free
argument_list|(
name|memman
argument_list|,
name|id
argument_list|,
name|chunk
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
operator|(
name|memblock
operator|=
name|LIST_FIRST
argument_list|(
operator|&
name|bmp
operator|->
name|block_list
argument_list|)
operator|)
condition|)
block|{
name|LIST_REMOVE
argument_list|(
name|memblock
argument_list|,
name|links
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|memblock
operator|->
name|static_mem
condition|)
block|{
name|memman
operator|->
name|sfree_called
operator|++
expr_stmt|;
name|memman
operator|->
name|reclaimed_mem
operator|+=
name|memblock
operator|->
name|allocated_mem
expr_stmt|;
name|MEMMAN_SYSFREE
argument_list|(
name|memblock
argument_list|)
expr_stmt|;
block|}
block|}
name|bmp
operator|->
name|initialized
operator|=
literal|0
expr_stmt|;
block|}
name|LIST_FOREACH
argument_list|(
argument|info
argument_list|,
argument|&memman->flexmem_info_list
argument_list|,
argument|links
argument_list|)
block|{
name|printf
argument_list|(
literal|"memman_freeall: flex size (size = %d, addr = %p)\n"
argument_list|,
name|info
operator|->
name|mem_size
argument_list|,
name|info
operator|->
name|addr
argument_list|)
expr_stmt|;
name|memman_free_flexsize
argument_list|(
name|memman
argument_list|,
name|info
operator|->
name|addr
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|memman_statistics_fixedsize
parameter_list|(
name|struct
name|memman
modifier|*
name|memman
parameter_list|)
block|{
name|printf
argument_list|(
literal|"  fixed size memory blocks\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    alloc():		%d times\n"
argument_list|,
name|memman
operator|->
name|alloc_called
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    system malloc():	%d times\n"
argument_list|,
name|memman
operator|->
name|salloc_called
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    free():		%d times\n"
argument_list|,
name|memman
operator|->
name|free_called
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    system free():	%d times\n"
argument_list|,
name|memman
operator|->
name|sfree_called
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    required memory:	%d bytes\n"
argument_list|,
name|memman
operator|->
name|required_mem
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    allocated memory:	%d bytes\n"
argument_list|,
name|memman
operator|->
name|allocated_mem
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    reclaimed memory:	%d bytes\n"
argument_list|,
name|memman
operator|->
name|reclaimed_mem
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|memman_statistics_flexsize
parameter_list|(
name|struct
name|memman
modifier|*
name|memman
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"  flexible size memory blocks\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    alloc():		%d times\n"
argument_list|,
name|memman
operator|->
name|flex_alloc_called
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    system malloc():	%d times\n"
argument_list|,
name|memman
operator|->
name|flex_salloc_called
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    free():		%d times\n"
argument_list|,
name|memman
operator|->
name|flex_free_called
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    system free():	%d times\n"
argument_list|,
name|memman
operator|->
name|flex_sfree_called
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    required memory:	%d bytes\n"
argument_list|,
name|memman
operator|->
name|flex_required_mem
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    allocated memory:	%d bytes\n"
argument_list|,
name|memman
operator|->
name|flex_allocated_mem
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    reclaimed memory:	%d bytes\n"
argument_list|,
name|memman
operator|->
name|flex_reclaimed_mem
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    peak memory usage:	%d bytes\n"
argument_list|,
name|memman
operator|->
name|flex_peak_mem_usage
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    min memory size:	%d bytes\n"
argument_list|,
name|memman
operator|->
name|flex_mem_size_min
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    max memory size:	%d bytes\n"
argument_list|,
name|memman
operator|->
name|flex_mem_size_max
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    avg memory size:	%d bytes\n"
argument_list|,
operator|(
name|memman
operator|->
name|flex_alloc_called
operator|)
condition|?
name|memman
operator|->
name|flex_allocated_mem
operator|/
name|memman
operator|->
name|flex_alloc_called
else|:
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    memory size histogram (%d entries):\n"
argument_list|,
name|memman
operator|->
name|flex_mem_histogram_ptr
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"	size	count\n"
argument_list|)
expr_stmt|;
name|memman_sort_histogram_by_size
argument_list|(
name|memman
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|memman
operator|->
name|flex_mem_histogram_ptr
condition|;
name|i
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"	%d	%d\n"
argument_list|,
name|memman
operator|->
name|flex_mem_histogram
index|[
name|i
index|]
operator|.
name|mem_size
argument_list|,
name|memman
operator|->
name|flex_mem_histogram
index|[
name|i
index|]
operator|.
name|count
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|memman_statistics
parameter_list|(
name|struct
name|memman
modifier|*
name|memman
parameter_list|)
block|{
name|printf
argument_list|(
literal|"memman: reporting statistics\n"
argument_list|)
expr_stmt|;
name|memman_statistics_fixedsize
argument_list|(
name|memman
argument_list|)
expr_stmt|;
name|memman_statistics_flexsize
argument_list|(
name|memman
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|size_t
name|memman_memid2size
parameter_list|(
name|struct
name|memman
modifier|*
name|memman
parameter_list|,
name|unsigned
name|int
name|id
parameter_list|)
block|{
if|if
condition|(
name|memman
operator|->
name|max_memid
operator|<=
name|id
condition|)
block|{
name|printf
argument_list|(
literal|"memman_alloc: invalid memory type id\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
return|return
operator|(
name|memman
operator|->
name|blockman
index|[
name|id
index|]
operator|.
name|size
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2007 Yahoo!, Inc.  * All rights reserved.  * Written by: John Baldwin<jhb@FreeBSD.org>  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. Neither the name of the author nor the names of any co-contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
specifier|const
name|char
name|rcsid
index|[]
init|=
literal|"$FreeBSD$"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* not lint */
end_comment

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<err.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<strings.h>
end_include

begin_include
include|#
directive|include
file|<sys/agpio.h>
end_include

begin_include
include|#
directive|include
file|<sys/pciio.h>
end_include

begin_include
include|#
directive|include
file|<dev/agp/agpreg.h>
end_include

begin_include
include|#
directive|include
file|<dev/pci/pcireg.h>
end_include

begin_include
include|#
directive|include
file|"pciconf.h"
end_include

begin_function_decl
specifier|static
name|void
name|list_ecaps
parameter_list|(
name|int
name|fd
parameter_list|,
name|struct
name|pci_conf
modifier|*
name|p
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|void
name|cap_power
parameter_list|(
name|int
name|fd
parameter_list|,
name|struct
name|pci_conf
modifier|*
name|p
parameter_list|,
name|uint8_t
name|ptr
parameter_list|)
block|{
name|uint16_t
name|cap
decl_stmt|,
name|status
decl_stmt|;
name|cap
operator|=
name|read_config
argument_list|(
name|fd
argument_list|,
operator|&
name|p
operator|->
name|pc_sel
argument_list|,
name|ptr
operator|+
name|PCIR_POWER_CAP
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|status
operator|=
name|read_config
argument_list|(
name|fd
argument_list|,
operator|&
name|p
operator|->
name|pc_sel
argument_list|,
name|ptr
operator|+
name|PCIR_POWER_STATUS
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"powerspec %d  supports D0%s%s D3  current D%d"
argument_list|,
name|cap
operator|&
name|PCIM_PCAP_SPEC
argument_list|,
name|cap
operator|&
name|PCIM_PCAP_D1SUPP
condition|?
literal|" D1"
else|:
literal|""
argument_list|,
name|cap
operator|&
name|PCIM_PCAP_D2SUPP
condition|?
literal|" D2"
else|:
literal|""
argument_list|,
name|status
operator|&
name|PCIM_PSTAT_DMASK
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|cap_agp
parameter_list|(
name|int
name|fd
parameter_list|,
name|struct
name|pci_conf
modifier|*
name|p
parameter_list|,
name|uint8_t
name|ptr
parameter_list|)
block|{
name|uint32_t
name|status
decl_stmt|,
name|command
decl_stmt|;
name|status
operator|=
name|read_config
argument_list|(
name|fd
argument_list|,
operator|&
name|p
operator|->
name|pc_sel
argument_list|,
name|ptr
operator|+
name|AGP_STATUS
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|command
operator|=
name|read_config
argument_list|(
name|fd
argument_list|,
operator|&
name|p
operator|->
name|pc_sel
argument_list|,
name|ptr
operator|+
name|AGP_CAPID
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"AGP "
argument_list|)
expr_stmt|;
if|if
condition|(
name|AGP_MODE_GET_MODE_3
argument_list|(
name|status
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"v3 "
argument_list|)
expr_stmt|;
if|if
condition|(
name|AGP_MODE_GET_RATE
argument_list|(
name|status
argument_list|)
operator|&
name|AGP_MODE_V3_RATE_8x
condition|)
name|printf
argument_list|(
literal|"8x "
argument_list|)
expr_stmt|;
if|if
condition|(
name|AGP_MODE_GET_RATE
argument_list|(
name|status
argument_list|)
operator|&
name|AGP_MODE_V3_RATE_4x
condition|)
name|printf
argument_list|(
literal|"4x "
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|AGP_MODE_GET_RATE
argument_list|(
name|status
argument_list|)
operator|&
name|AGP_MODE_V2_RATE_4x
condition|)
name|printf
argument_list|(
literal|"4x "
argument_list|)
expr_stmt|;
if|if
condition|(
name|AGP_MODE_GET_RATE
argument_list|(
name|status
argument_list|)
operator|&
name|AGP_MODE_V2_RATE_2x
condition|)
name|printf
argument_list|(
literal|"2x "
argument_list|)
expr_stmt|;
if|if
condition|(
name|AGP_MODE_GET_RATE
argument_list|(
name|status
argument_list|)
operator|&
name|AGP_MODE_V2_RATE_1x
condition|)
name|printf
argument_list|(
literal|"1x "
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|AGP_MODE_GET_SBA
argument_list|(
name|status
argument_list|)
condition|)
name|printf
argument_list|(
literal|"SBA "
argument_list|)
expr_stmt|;
if|if
condition|(
name|AGP_MODE_GET_AGP
argument_list|(
name|command
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"enabled at "
argument_list|)
expr_stmt|;
if|if
condition|(
name|AGP_MODE_GET_MODE_3
argument_list|(
name|command
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"v3 "
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|AGP_MODE_GET_RATE
argument_list|(
name|command
argument_list|)
condition|)
block|{
case|case
name|AGP_MODE_V3_RATE_8x
case|:
name|printf
argument_list|(
literal|"8x "
argument_list|)
expr_stmt|;
break|break;
case|case
name|AGP_MODE_V3_RATE_4x
case|:
name|printf
argument_list|(
literal|"4x "
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
else|else
switch|switch
condition|(
name|AGP_MODE_GET_RATE
argument_list|(
name|command
argument_list|)
condition|)
block|{
case|case
name|AGP_MODE_V2_RATE_4x
case|:
name|printf
argument_list|(
literal|"4x "
argument_list|)
expr_stmt|;
break|break;
case|case
name|AGP_MODE_V2_RATE_2x
case|:
name|printf
argument_list|(
literal|"2x "
argument_list|)
expr_stmt|;
break|break;
case|case
name|AGP_MODE_V2_RATE_1x
case|:
name|printf
argument_list|(
literal|"1x "
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|AGP_MODE_GET_SBA
argument_list|(
name|command
argument_list|)
condition|)
name|printf
argument_list|(
literal|"SBA "
argument_list|)
expr_stmt|;
block|}
else|else
name|printf
argument_list|(
literal|"disabled"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|cap_vpd
parameter_list|(
name|int
name|fd
name|__unused
parameter_list|,
name|struct
name|pci_conf
modifier|*
name|p
name|__unused
parameter_list|,
name|uint8_t
name|ptr
name|__unused
parameter_list|)
block|{
name|printf
argument_list|(
literal|"VPD"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|cap_msi
parameter_list|(
name|int
name|fd
parameter_list|,
name|struct
name|pci_conf
modifier|*
name|p
parameter_list|,
name|uint8_t
name|ptr
parameter_list|)
block|{
name|uint16_t
name|ctrl
decl_stmt|;
name|int
name|msgnum
decl_stmt|;
name|ctrl
operator|=
name|read_config
argument_list|(
name|fd
argument_list|,
operator|&
name|p
operator|->
name|pc_sel
argument_list|,
name|ptr
operator|+
name|PCIR_MSI_CTRL
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|msgnum
operator|=
literal|1
operator|<<
operator|(
operator|(
name|ctrl
operator|&
name|PCIM_MSICTRL_MMC_MASK
operator|)
operator|>>
literal|1
operator|)
expr_stmt|;
name|printf
argument_list|(
literal|"MSI supports %d message%s%s%s "
argument_list|,
name|msgnum
argument_list|,
operator|(
name|msgnum
operator|==
literal|1
operator|)
condition|?
literal|""
else|:
literal|"s"
argument_list|,
operator|(
name|ctrl
operator|&
name|PCIM_MSICTRL_64BIT
operator|)
condition|?
literal|", 64 bit"
else|:
literal|""
argument_list|,
operator|(
name|ctrl
operator|&
name|PCIM_MSICTRL_VECTOR
operator|)
condition|?
literal|", vector masks"
else|:
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctrl
operator|&
name|PCIM_MSICTRL_MSI_ENABLE
condition|)
block|{
name|msgnum
operator|=
literal|1
operator|<<
operator|(
operator|(
name|ctrl
operator|&
name|PCIM_MSICTRL_MME_MASK
operator|)
operator|>>
literal|4
operator|)
expr_stmt|;
name|printf
argument_list|(
literal|"enabled with %d message%s"
argument_list|,
name|msgnum
argument_list|,
operator|(
name|msgnum
operator|==
literal|1
operator|)
condition|?
literal|""
else|:
literal|"s"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|cap_pcix
parameter_list|(
name|int
name|fd
parameter_list|,
name|struct
name|pci_conf
modifier|*
name|p
parameter_list|,
name|uint8_t
name|ptr
parameter_list|)
block|{
name|uint32_t
name|status
decl_stmt|;
name|int
name|comma
decl_stmt|,
name|max_splits
decl_stmt|,
name|max_burst_read
decl_stmt|;
name|status
operator|=
name|read_config
argument_list|(
name|fd
argument_list|,
operator|&
name|p
operator|->
name|pc_sel
argument_list|,
name|ptr
operator|+
name|PCIXR_STATUS
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"PCI-X "
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|PCIXM_STATUS_64BIT
condition|)
name|printf
argument_list|(
literal|"64-bit "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p
operator|->
name|pc_hdr
operator|&
name|PCIM_HDRTYPE
operator|)
operator|==
literal|1
condition|)
name|printf
argument_list|(
literal|"bridge "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p
operator|->
name|pc_hdr
operator|&
name|PCIM_HDRTYPE
operator|)
operator|!=
literal|1
operator|||
operator|(
name|status
operator|&
operator|(
name|PCIXM_STATUS_133CAP
operator||
name|PCIXM_STATUS_266CAP
operator||
name|PCIXM_STATUS_533CAP
operator|)
operator|)
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"supports"
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|PCIXM_STATUS_133CAP
condition|)
block|{
name|printf
argument_list|(
literal|"%s 133MHz"
argument_list|,
name|comma
condition|?
literal|","
else|:
literal|""
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|&
name|PCIXM_STATUS_266CAP
condition|)
block|{
name|printf
argument_list|(
literal|"%s 266MHz"
argument_list|,
name|comma
condition|?
literal|","
else|:
literal|""
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|&
name|PCIXM_STATUS_533CAP
condition|)
block|{
name|printf
argument_list|(
literal|"%s 533MHz"
argument_list|,
name|comma
condition|?
literal|","
else|:
literal|""
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|p
operator|->
name|pc_hdr
operator|&
name|PCIM_HDRTYPE
operator|)
operator|==
literal|1
condition|)
return|return;
name|max_burst_read
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|status
operator|&
name|PCIXM_STATUS_MAX_READ
condition|)
block|{
case|case
name|PCIXM_STATUS_MAX_READ_512
case|:
name|max_burst_read
operator|=
literal|512
expr_stmt|;
break|break;
case|case
name|PCIXM_STATUS_MAX_READ_1024
case|:
name|max_burst_read
operator|=
literal|1024
expr_stmt|;
break|break;
case|case
name|PCIXM_STATUS_MAX_READ_2048
case|:
name|max_burst_read
operator|=
literal|2048
expr_stmt|;
break|break;
case|case
name|PCIXM_STATUS_MAX_READ_4096
case|:
name|max_burst_read
operator|=
literal|4096
expr_stmt|;
break|break;
block|}
name|max_splits
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|status
operator|&
name|PCIXM_STATUS_MAX_SPLITS
condition|)
block|{
case|case
name|PCIXM_STATUS_MAX_SPLITS_1
case|:
name|max_splits
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|PCIXM_STATUS_MAX_SPLITS_2
case|:
name|max_splits
operator|=
literal|2
expr_stmt|;
break|break;
case|case
name|PCIXM_STATUS_MAX_SPLITS_3
case|:
name|max_splits
operator|=
literal|3
expr_stmt|;
break|break;
case|case
name|PCIXM_STATUS_MAX_SPLITS_4
case|:
name|max_splits
operator|=
literal|4
expr_stmt|;
break|break;
case|case
name|PCIXM_STATUS_MAX_SPLITS_8
case|:
name|max_splits
operator|=
literal|8
expr_stmt|;
break|break;
case|case
name|PCIXM_STATUS_MAX_SPLITS_12
case|:
name|max_splits
operator|=
literal|12
expr_stmt|;
break|break;
case|case
name|PCIXM_STATUS_MAX_SPLITS_16
case|:
name|max_splits
operator|=
literal|16
expr_stmt|;
break|break;
case|case
name|PCIXM_STATUS_MAX_SPLITS_32
case|:
name|max_splits
operator|=
literal|32
expr_stmt|;
break|break;
block|}
name|printf
argument_list|(
literal|"%s %d burst read, %d split transaction%s"
argument_list|,
name|comma
condition|?
literal|","
else|:
literal|""
argument_list|,
name|max_burst_read
argument_list|,
name|max_splits
argument_list|,
name|max_splits
operator|==
literal|1
condition|?
literal|""
else|:
literal|"s"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|cap_ht
parameter_list|(
name|int
name|fd
parameter_list|,
name|struct
name|pci_conf
modifier|*
name|p
parameter_list|,
name|uint8_t
name|ptr
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
name|uint16_t
name|command
decl_stmt|;
name|command
operator|=
name|read_config
argument_list|(
name|fd
argument_list|,
operator|&
name|p
operator|->
name|pc_sel
argument_list|,
name|ptr
operator|+
name|PCIR_HT_COMMAND
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"HT "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|command
operator|&
literal|0xe000
operator|)
operator|==
name|PCIM_HTCAP_SLAVE
condition|)
name|printf
argument_list|(
literal|"slave"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|command
operator|&
literal|0xe000
operator|)
operator|==
name|PCIM_HTCAP_HOST
condition|)
name|printf
argument_list|(
literal|"host"
argument_list|)
expr_stmt|;
else|else
switch|switch
condition|(
name|command
operator|&
name|PCIM_HTCMD_CAP_MASK
condition|)
block|{
case|case
name|PCIM_HTCAP_SWITCH
case|:
name|printf
argument_list|(
literal|"switch"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCIM_HTCAP_INTERRUPT
case|:
name|printf
argument_list|(
literal|"interrupt"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCIM_HTCAP_REVISION_ID
case|:
name|printf
argument_list|(
literal|"revision ID"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCIM_HTCAP_UNITID_CLUMPING
case|:
name|printf
argument_list|(
literal|"unit ID clumping"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCIM_HTCAP_EXT_CONFIG_SPACE
case|:
name|printf
argument_list|(
literal|"extended config space"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCIM_HTCAP_ADDRESS_MAPPING
case|:
name|printf
argument_list|(
literal|"address mapping"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCIM_HTCAP_MSI_MAPPING
case|:
name|printf
argument_list|(
literal|"MSI %saddress window %s at 0x"
argument_list|,
name|command
operator|&
name|PCIM_HTCMD_MSI_FIXED
condition|?
literal|"fixed "
else|:
literal|""
argument_list|,
name|command
operator|&
name|PCIM_HTCMD_MSI_ENABLE
condition|?
literal|"enabled"
else|:
literal|"disabled"
argument_list|)
expr_stmt|;
if|if
condition|(
name|command
operator|&
name|PCIM_HTCMD_MSI_FIXED
condition|)
name|printf
argument_list|(
literal|"fee00000"
argument_list|)
expr_stmt|;
else|else
block|{
name|reg
operator|=
name|read_config
argument_list|(
name|fd
argument_list|,
operator|&
name|p
operator|->
name|pc_sel
argument_list|,
name|ptr
operator|+
name|PCIR_HTMSI_ADDRESS_HI
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|reg
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"%08x"
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|read_config
argument_list|(
name|fd
argument_list|,
operator|&
name|p
operator|->
name|pc_sel
argument_list|,
name|ptr
operator|+
name|PCIR_HTMSI_ADDRESS_LO
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%08x"
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|PCIM_HTCAP_DIRECT_ROUTE
case|:
name|printf
argument_list|(
literal|"direct route"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCIM_HTCAP_VCSET
case|:
name|printf
argument_list|(
literal|"VC set"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCIM_HTCAP_RETRY_MODE
case|:
name|printf
argument_list|(
literal|"retry mode"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCIM_HTCAP_X86_ENCODING
case|:
name|printf
argument_list|(
literal|"X86 encoding"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCIM_HTCAP_GEN3
case|:
name|printf
argument_list|(
literal|"Gen3"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCIM_HTCAP_FLE
case|:
name|printf
argument_list|(
literal|"function-level extension"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCIM_HTCAP_PM
case|:
name|printf
argument_list|(
literal|"power management"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCIM_HTCAP_HIGH_NODE_COUNT
case|:
name|printf
argument_list|(
literal|"high node count"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"unknown %02x"
argument_list|,
name|command
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|cap_vendor
parameter_list|(
name|int
name|fd
parameter_list|,
name|struct
name|pci_conf
modifier|*
name|p
parameter_list|,
name|uint8_t
name|ptr
parameter_list|)
block|{
name|uint8_t
name|length
decl_stmt|;
name|length
operator|=
name|read_config
argument_list|(
name|fd
argument_list|,
operator|&
name|p
operator|->
name|pc_sel
argument_list|,
name|ptr
operator|+
name|PCIR_VENDOR_LENGTH
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"vendor (length %d)"
argument_list|,
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|pc_vendor
operator|==
literal|0x8086
condition|)
block|{
comment|/* Intel */
name|uint8_t
name|version
decl_stmt|;
name|version
operator|=
name|read_config
argument_list|(
name|fd
argument_list|,
operator|&
name|p
operator|->
name|pc_sel
argument_list|,
name|ptr
operator|+
name|PCIR_VENDOR_DATA
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" Intel cap %d version %d"
argument_list|,
name|version
operator|>>
literal|4
argument_list|,
name|version
operator|&
literal|0xf
argument_list|)
expr_stmt|;
if|if
condition|(
name|version
operator|>>
literal|4
operator|==
literal|1
operator|&&
name|length
operator|==
literal|12
condition|)
block|{
comment|/* Feature Detection */
name|uint32_t
name|fvec
decl_stmt|;
name|int
name|comma
decl_stmt|;
name|comma
operator|=
literal|0
expr_stmt|;
name|fvec
operator|=
name|read_config
argument_list|(
name|fd
argument_list|,
operator|&
name|p
operator|->
name|pc_sel
argument_list|,
name|ptr
operator|+
name|PCIR_VENDOR_DATA
operator|+
literal|5
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n\t\t features:"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fvec
operator|&
operator|(
literal|1
operator|<<
literal|0
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|" AMT"
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|1
expr_stmt|;
block|}
name|fvec
operator|=
name|read_config
argument_list|(
name|fd
argument_list|,
operator|&
name|p
operator|->
name|pc_sel
argument_list|,
name|ptr
operator|+
name|PCIR_VENDOR_DATA
operator|+
literal|1
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|fvec
operator|&
operator|(
literal|1
operator|<<
literal|21
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"%s Quick Resume"
argument_list|,
name|comma
condition|?
literal|","
else|:
literal|""
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|fvec
operator|&
operator|(
literal|1
operator|<<
literal|18
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"%s SATA RAID-5"
argument_list|,
name|comma
condition|?
literal|","
else|:
literal|""
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|fvec
operator|&
operator|(
literal|1
operator|<<
literal|9
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"%s Mobile"
argument_list|,
name|comma
condition|?
literal|","
else|:
literal|""
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|fvec
operator|&
operator|(
literal|1
operator|<<
literal|7
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"%s 6 PCI-e x1 slots"
argument_list|,
name|comma
condition|?
literal|","
else|:
literal|""
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"%s 4 PCI-e x1 slots"
argument_list|,
name|comma
condition|?
literal|","
else|:
literal|""
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|fvec
operator|&
operator|(
literal|1
operator|<<
literal|5
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"%s SATA RAID-0/1/10"
argument_list|,
name|comma
condition|?
literal|","
else|:
literal|""
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|fvec
operator|&
operator|(
literal|1
operator|<<
literal|3
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"%s SATA AHCI"
argument_list|,
name|comma
condition|?
literal|","
else|:
literal|""
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|1
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|cap_debug
parameter_list|(
name|int
name|fd
parameter_list|,
name|struct
name|pci_conf
modifier|*
name|p
parameter_list|,
name|uint8_t
name|ptr
parameter_list|)
block|{
name|uint16_t
name|debug_port
decl_stmt|;
name|debug_port
operator|=
name|read_config
argument_list|(
name|fd
argument_list|,
operator|&
name|p
operator|->
name|pc_sel
argument_list|,
name|ptr
operator|+
name|PCIR_DEBUG_PORT
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"EHCI Debug Port at offset 0x%x in map 0x%x"
argument_list|,
name|debug_port
operator|&
name|PCIM_DEBUG_PORT_OFFSET
argument_list|,
name|PCIR_BAR
argument_list|(
name|debug_port
operator|>>
literal|13
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|cap_subvendor
parameter_list|(
name|int
name|fd
parameter_list|,
name|struct
name|pci_conf
modifier|*
name|p
parameter_list|,
name|uint8_t
name|ptr
parameter_list|)
block|{
name|uint32_t
name|id
decl_stmt|;
name|id
operator|=
name|read_config
argument_list|(
name|fd
argument_list|,
operator|&
name|p
operator|->
name|pc_sel
argument_list|,
name|ptr
operator|+
name|PCIR_SUBVENDCAP_ID
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"PCI Bridge card=0x%08x"
argument_list|,
name|id
argument_list|)
expr_stmt|;
block|}
end_function

begin_define
define|#
directive|define
name|MAX_PAYLOAD
parameter_list|(
name|field
parameter_list|)
value|(128<< (field))
end_define

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|link_speed_string
parameter_list|(
name|uint8_t
name|speed
parameter_list|)
block|{
switch|switch
condition|(
name|speed
condition|)
block|{
case|case
literal|1
case|:
return|return
operator|(
literal|"2.5"
operator|)
return|;
case|case
literal|2
case|:
return|return
operator|(
literal|"5.0"
operator|)
return|;
case|case
literal|3
case|:
return|return
operator|(
literal|"8.0"
operator|)
return|;
default|default:
return|return
operator|(
literal|"undef"
operator|)
return|;
block|}
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|aspm_string
parameter_list|(
name|uint8_t
name|aspm
parameter_list|)
block|{
switch|switch
condition|(
name|aspm
condition|)
block|{
case|case
literal|1
case|:
return|return
operator|(
literal|"L0s"
operator|)
return|;
case|case
literal|2
case|:
return|return
operator|(
literal|"L1"
operator|)
return|;
case|case
literal|3
case|:
return|return
operator|(
literal|"L0s/L1"
operator|)
return|;
default|default:
return|return
operator|(
literal|"disabled"
operator|)
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|cap_express
parameter_list|(
name|int
name|fd
parameter_list|,
name|struct
name|pci_conf
modifier|*
name|p
parameter_list|,
name|uint8_t
name|ptr
parameter_list|)
block|{
name|uint32_t
name|cap
decl_stmt|;
name|uint16_t
name|ctl
decl_stmt|,
name|flags
decl_stmt|,
name|sta
decl_stmt|;
name|unsigned
name|int
name|version
decl_stmt|;
name|flags
operator|=
name|read_config
argument_list|(
name|fd
argument_list|,
operator|&
name|p
operator|->
name|pc_sel
argument_list|,
name|ptr
operator|+
name|PCIER_FLAGS
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|version
operator|=
name|flags
operator|&
name|PCIEM_FLAGS_VERSION
expr_stmt|;
name|printf
argument_list|(
literal|"PCI-Express %u "
argument_list|,
name|version
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|flags
operator|&
name|PCIEM_FLAGS_TYPE
condition|)
block|{
case|case
name|PCIEM_TYPE_ENDPOINT
case|:
name|printf
argument_list|(
literal|"endpoint"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCIEM_TYPE_LEGACY_ENDPOINT
case|:
name|printf
argument_list|(
literal|"legacy endpoint"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCIEM_TYPE_ROOT_PORT
case|:
name|printf
argument_list|(
literal|"root port"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCIEM_TYPE_UPSTREAM_PORT
case|:
name|printf
argument_list|(
literal|"upstream port"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCIEM_TYPE_DOWNSTREAM_PORT
case|:
name|printf
argument_list|(
literal|"downstream port"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCIEM_TYPE_PCI_BRIDGE
case|:
name|printf
argument_list|(
literal|"PCI bridge"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCIEM_TYPE_PCIE_BRIDGE
case|:
name|printf
argument_list|(
literal|"PCI to PCIe bridge"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCIEM_TYPE_ROOT_INT_EP
case|:
name|printf
argument_list|(
literal|"root endpoint"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCIEM_TYPE_ROOT_EC
case|:
name|printf
argument_list|(
literal|"event collector"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"type %d"
argument_list|,
operator|(
name|flags
operator|&
name|PCIEM_FLAGS_TYPE
operator|)
operator|>>
literal|4
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|flags
operator|&
name|PCIEM_FLAGS_SLOT
condition|)
name|printf
argument_list|(
literal|" slot"
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|PCIEM_FLAGS_IRQ
condition|)
name|printf
argument_list|(
literal|" MSI %d"
argument_list|,
operator|(
name|flags
operator|&
name|PCIEM_FLAGS_IRQ
operator|)
operator|>>
literal|9
argument_list|)
expr_stmt|;
name|cap
operator|=
name|read_config
argument_list|(
name|fd
argument_list|,
operator|&
name|p
operator|->
name|pc_sel
argument_list|,
name|ptr
operator|+
name|PCIER_DEVICE_CAP
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|ctl
operator|=
name|read_config
argument_list|(
name|fd
argument_list|,
operator|&
name|p
operator|->
name|pc_sel
argument_list|,
name|ptr
operator|+
name|PCIER_DEVICE_CTL
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" max data %d(%d)"
argument_list|,
name|MAX_PAYLOAD
argument_list|(
operator|(
name|ctl
operator|&
name|PCIEM_CTL_MAX_PAYLOAD
operator|)
operator|>>
literal|5
argument_list|)
argument_list|,
name|MAX_PAYLOAD
argument_list|(
name|cap
operator|&
name|PCIEM_CAP_MAX_PAYLOAD
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|cap
operator|&
name|PCIEM_CAP_FLR
operator|)
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|" FLR"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctl
operator|&
name|PCIEM_CTL_RELAXED_ORD_ENABLE
condition|)
name|printf
argument_list|(
literal|" RO"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctl
operator|&
name|PCIEM_CTL_NOSNOOP_ENABLE
condition|)
name|printf
argument_list|(
literal|" NS"
argument_list|)
expr_stmt|;
if|if
condition|(
name|version
operator|>=
literal|2
condition|)
block|{
name|cap
operator|=
name|read_config
argument_list|(
name|fd
argument_list|,
operator|&
name|p
operator|->
name|pc_sel
argument_list|,
name|ptr
operator|+
name|PCIER_DEVICE_CAP2
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|cap
operator|&
name|PCIEM_CAP2_ARI
operator|)
operator|!=
literal|0
condition|)
block|{
name|ctl
operator|=
name|read_config
argument_list|(
name|fd
argument_list|,
operator|&
name|p
operator|->
name|pc_sel
argument_list|,
name|ptr
operator|+
name|PCIER_DEVICE_CTL2
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" ARI %s"
argument_list|,
operator|(
name|ctl
operator|&
name|PCIEM_CTL2_ARI
operator|)
condition|?
literal|"enabled"
else|:
literal|"disabled"
argument_list|)
expr_stmt|;
block|}
block|}
name|cap
operator|=
name|read_config
argument_list|(
name|fd
argument_list|,
operator|&
name|p
operator|->
name|pc_sel
argument_list|,
name|ptr
operator|+
name|PCIER_LINK_CAP
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|sta
operator|=
name|read_config
argument_list|(
name|fd
argument_list|,
operator|&
name|p
operator|->
name|pc_sel
argument_list|,
name|ptr
operator|+
name|PCIER_LINK_STA
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|cap
operator|==
literal|0
operator|&&
name|sta
operator|==
literal|0
condition|)
return|return;
name|printf
argument_list|(
literal|"\n                "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" link x%d(x%d)"
argument_list|,
operator|(
name|sta
operator|&
name|PCIEM_LINK_STA_WIDTH
operator|)
operator|>>
literal|4
argument_list|,
operator|(
name|cap
operator|&
name|PCIEM_LINK_CAP_MAX_WIDTH
operator|)
operator|>>
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|cap
operator|&
name|PCIEM_LINK_CAP_MAX_WIDTH
operator|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|" speed %s(%s)"
argument_list|,
operator|(
name|sta
operator|&
name|PCIEM_LINK_STA_WIDTH
operator|)
operator|==
literal|0
condition|?
literal|"0.0"
else|:
name|link_speed_string
argument_list|(
name|sta
operator|&
name|PCIEM_LINK_STA_SPEED
argument_list|)
argument_list|,
name|link_speed_string
argument_list|(
name|cap
operator|&
name|PCIEM_LINK_CAP_MAX_SPEED
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|cap
operator|&
name|PCIEM_LINK_CAP_ASPM
operator|)
operator|!=
literal|0
condition|)
block|{
name|ctl
operator|=
name|read_config
argument_list|(
name|fd
argument_list|,
operator|&
name|p
operator|->
name|pc_sel
argument_list|,
name|ptr
operator|+
name|PCIER_LINK_CTL
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" ASPM %s(%s)"
argument_list|,
name|aspm_string
argument_list|(
name|ctl
operator|&
name|PCIEM_LINK_CTL_ASPMC
argument_list|)
argument_list|,
name|aspm_string
argument_list|(
operator|(
name|cap
operator|&
name|PCIEM_LINK_CAP_ASPM
operator|)
operator|>>
literal|10
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|cap_msix
parameter_list|(
name|int
name|fd
parameter_list|,
name|struct
name|pci_conf
modifier|*
name|p
parameter_list|,
name|uint8_t
name|ptr
parameter_list|)
block|{
name|uint32_t
name|pba_offset
decl_stmt|,
name|table_offset
decl_stmt|,
name|val
decl_stmt|;
name|int
name|msgnum
decl_stmt|,
name|pba_bar
decl_stmt|,
name|table_bar
decl_stmt|;
name|uint16_t
name|ctrl
decl_stmt|;
name|ctrl
operator|=
name|read_config
argument_list|(
name|fd
argument_list|,
operator|&
name|p
operator|->
name|pc_sel
argument_list|,
name|ptr
operator|+
name|PCIR_MSIX_CTRL
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|msgnum
operator|=
operator|(
name|ctrl
operator|&
name|PCIM_MSIXCTRL_TABLE_SIZE
operator|)
operator|+
literal|1
expr_stmt|;
name|val
operator|=
name|read_config
argument_list|(
name|fd
argument_list|,
operator|&
name|p
operator|->
name|pc_sel
argument_list|,
name|ptr
operator|+
name|PCIR_MSIX_TABLE
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|table_bar
operator|=
name|PCIR_BAR
argument_list|(
name|val
operator|&
name|PCIM_MSIX_BIR_MASK
argument_list|)
expr_stmt|;
name|table_offset
operator|=
name|val
operator|&
operator|~
name|PCIM_MSIX_BIR_MASK
expr_stmt|;
name|val
operator|=
name|read_config
argument_list|(
name|fd
argument_list|,
operator|&
name|p
operator|->
name|pc_sel
argument_list|,
name|ptr
operator|+
name|PCIR_MSIX_PBA
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|pba_bar
operator|=
name|PCIR_BAR
argument_list|(
name|val
operator|&
name|PCIM_MSIX_BIR_MASK
argument_list|)
expr_stmt|;
name|pba_offset
operator|=
name|val
operator|&
operator|~
name|PCIM_MSIX_BIR_MASK
expr_stmt|;
name|printf
argument_list|(
literal|"MSI-X supports %d message%s%s\n"
argument_list|,
name|msgnum
argument_list|,
operator|(
name|msgnum
operator|==
literal|1
operator|)
condition|?
literal|""
else|:
literal|"s"
argument_list|,
operator|(
name|ctrl
operator|&
name|PCIM_MSIXCTRL_MSIX_ENABLE
operator|)
condition|?
literal|", enabled"
else|:
literal|""
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"                 "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Table in map 0x%x[0x%x], PBA in map 0x%x[0x%x]"
argument_list|,
name|table_bar
argument_list|,
name|table_offset
argument_list|,
name|pba_bar
argument_list|,
name|pba_offset
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|cap_sata
parameter_list|(
name|int
name|fd
name|__unused
parameter_list|,
name|struct
name|pci_conf
modifier|*
name|p
name|__unused
parameter_list|,
name|uint8_t
name|ptr
name|__unused
parameter_list|)
block|{
name|printf
argument_list|(
literal|"SATA Index-Data Pair"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|cap_pciaf
parameter_list|(
name|int
name|fd
parameter_list|,
name|struct
name|pci_conf
modifier|*
name|p
parameter_list|,
name|uint8_t
name|ptr
parameter_list|)
block|{
name|uint8_t
name|cap
decl_stmt|;
name|cap
operator|=
name|read_config
argument_list|(
name|fd
argument_list|,
operator|&
name|p
operator|->
name|pc_sel
argument_list|,
name|ptr
operator|+
name|PCIR_PCIAF_CAP
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"PCI Advanced Features:%s%s"
argument_list|,
name|cap
operator|&
name|PCIM_PCIAFCAP_FLR
condition|?
literal|" FLR"
else|:
literal|""
argument_list|,
name|cap
operator|&
name|PCIM_PCIAFCAP_TP
condition|?
literal|" TP"
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|ea_bei_to_name
parameter_list|(
name|int
name|bei
parameter_list|)
block|{
specifier|static
specifier|const
name|char
modifier|*
name|barstr
index|[]
init|=
block|{
literal|"BAR0"
block|,
literal|"BAR1"
block|,
literal|"BAR2"
block|,
literal|"BAR3"
block|,
literal|"BAR4"
block|,
literal|"BAR5"
block|}
decl_stmt|;
specifier|static
specifier|const
name|char
modifier|*
name|vfbarstr
index|[]
init|=
block|{
literal|"VFBAR0"
block|,
literal|"VFBAR1"
block|,
literal|"VFBAR2"
block|,
literal|"VFBAR3"
block|,
literal|"VFBAR4"
block|,
literal|"VFBAR5"
block|}
decl_stmt|;
if|if
condition|(
operator|(
name|bei
operator|>=
name|PCIM_EA_BEI_BAR_0
operator|)
operator|&&
operator|(
name|bei
operator|<=
name|PCIM_EA_BEI_BAR_5
operator|)
condition|)
return|return
operator|(
name|barstr
index|[
name|bei
operator|-
name|PCIM_EA_BEI_BAR_0
index|]
operator|)
return|;
if|if
condition|(
operator|(
name|bei
operator|>=
name|PCIM_EA_BEI_VF_BAR_0
operator|)
operator|&&
operator|(
name|bei
operator|<=
name|PCIM_EA_BEI_VF_BAR_5
operator|)
condition|)
return|return
operator|(
name|vfbarstr
index|[
name|bei
operator|-
name|PCIM_EA_BEI_VF_BAR_0
index|]
operator|)
return|;
switch|switch
condition|(
name|bei
condition|)
block|{
case|case
name|PCIM_EA_BEI_BRIDGE
case|:
return|return
literal|"BRIDGE"
return|;
case|case
name|PCIM_EA_BEI_ENI
case|:
return|return
literal|"ENI"
return|;
case|case
name|PCIM_EA_BEI_ROM
case|:
return|return
literal|"ROM"
return|;
case|case
name|PCIM_EA_BEI_RESERVED
case|:
default|default:
return|return
literal|"RSVD"
return|;
block|}
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|ea_prop_to_name
parameter_list|(
name|uint8_t
name|prop
parameter_list|)
block|{
switch|switch
condition|(
name|prop
condition|)
block|{
case|case
name|PCIM_EA_P_MEM
case|:
return|return
literal|"Non-Prefetchable Memory"
return|;
case|case
name|PCIM_EA_P_MEM_PREFETCH
case|:
return|return
literal|"Prefetchable Memory"
return|;
case|case
name|PCIM_EA_P_IO
case|:
return|return
literal|"I/O Space"
return|;
case|case
name|PCIM_EA_P_VF_MEM_PREFETCH
case|:
return|return
literal|"VF Prefetchable Memory"
return|;
case|case
name|PCIM_EA_P_VF_MEM
case|:
return|return
literal|"VF Non-Prefetchable Memory"
return|;
case|case
name|PCIM_EA_P_BRIDGE_MEM
case|:
return|return
literal|"Bridge Non-Prefetchable Memory"
return|;
case|case
name|PCIM_EA_P_BRIDGE_MEM_PREFETCH
case|:
return|return
literal|"Bridge Prefetchable Memory"
return|;
case|case
name|PCIM_EA_P_BRIDGE_IO
case|:
return|return
literal|"Bridge I/O Space"
return|;
case|case
name|PCIM_EA_P_MEM_RESERVED
case|:
return|return
literal|"Reserved Memory"
return|;
case|case
name|PCIM_EA_P_IO_RESERVED
case|:
return|return
literal|"Reserved I/O Space"
return|;
case|case
name|PCIM_EA_P_UNAVAILABLE
case|:
return|return
literal|"Unavailable"
return|;
default|default:
return|return
literal|"Reserved"
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|cap_ea
parameter_list|(
name|int
name|fd
parameter_list|,
name|struct
name|pci_conf
modifier|*
name|p
parameter_list|,
name|uint8_t
name|ptr
parameter_list|)
block|{
name|int
name|num_ent
decl_stmt|;
name|int
name|a
decl_stmt|,
name|b
decl_stmt|;
name|uint32_t
name|bei
decl_stmt|;
name|uint32_t
name|val
decl_stmt|;
name|int
name|ent_size
decl_stmt|;
name|uint32_t
name|dw
index|[
literal|4
index|]
decl_stmt|;
name|uint32_t
name|flags
decl_stmt|,
name|flags_pp
decl_stmt|,
name|flags_sp
decl_stmt|;
name|uint64_t
name|base
decl_stmt|,
name|max_offset
decl_stmt|;
name|uint8_t
name|fixed_sub_bus_nr
decl_stmt|,
name|fixed_sec_bus_nr
decl_stmt|;
comment|/* Determine the number of entries */
name|num_ent
operator|=
name|read_config
argument_list|(
name|fd
argument_list|,
operator|&
name|p
operator|->
name|pc_sel
argument_list|,
name|ptr
operator|+
name|PCIR_EA_NUM_ENT
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|num_ent
operator|&=
name|PCIM_EA_NUM_ENT_MASK
expr_stmt|;
name|printf
argument_list|(
literal|"PCI Enhanced Allocation (%d entries)"
argument_list|,
name|num_ent
argument_list|)
expr_stmt|;
comment|/* Find the first entry to care of */
name|ptr
operator|+=
name|PCIR_EA_FIRST_ENT
expr_stmt|;
comment|/* Print BUS numbers for bridges */
if|if
condition|(
operator|(
name|p
operator|->
name|pc_hdr
operator|&
name|PCIM_HDRTYPE
operator|)
operator|==
name|PCIM_HDRTYPE_BRIDGE
condition|)
block|{
name|val
operator|=
name|read_config
argument_list|(
name|fd
argument_list|,
operator|&
name|p
operator|->
name|pc_sel
argument_list|,
name|ptr
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|fixed_sec_bus_nr
operator|=
name|PCIM_EA_SEC_NR
argument_list|(
name|val
argument_list|)
expr_stmt|;
name|fixed_sub_bus_nr
operator|=
name|PCIM_EA_SUB_NR
argument_list|(
name|val
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n\t\t BRIDGE, sec bus [%d], sub bus [%d]"
argument_list|,
name|fixed_sec_bus_nr
argument_list|,
name|fixed_sub_bus_nr
argument_list|)
expr_stmt|;
name|ptr
operator|+=
literal|4
expr_stmt|;
block|}
for|for
control|(
name|a
operator|=
literal|0
init|;
name|a
operator|<
name|num_ent
condition|;
name|a
operator|++
control|)
block|{
comment|/* Read a number of dwords in the entry */
name|val
operator|=
name|read_config
argument_list|(
name|fd
argument_list|,
operator|&
name|p
operator|->
name|pc_sel
argument_list|,
name|ptr
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|ptr
operator|+=
literal|4
expr_stmt|;
name|ent_size
operator|=
operator|(
name|val
operator|&
name|PCIM_EA_ES
operator|)
expr_stmt|;
for|for
control|(
name|b
operator|=
literal|0
init|;
name|b
operator|<
name|ent_size
condition|;
name|b
operator|++
control|)
block|{
name|dw
index|[
name|b
index|]
operator|=
name|read_config
argument_list|(
name|fd
argument_list|,
operator|&
name|p
operator|->
name|pc_sel
argument_list|,
name|ptr
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|ptr
operator|+=
literal|4
expr_stmt|;
block|}
name|flags
operator|=
name|val
expr_stmt|;
name|flags_pp
operator|=
operator|(
name|flags
operator|&
name|PCIM_EA_PP
operator|)
operator|>>
name|PCIM_EA_PP_OFFSET
expr_stmt|;
name|flags_sp
operator|=
operator|(
name|flags
operator|&
name|PCIM_EA_SP
operator|)
operator|>>
name|PCIM_EA_SP_OFFSET
expr_stmt|;
name|bei
operator|=
operator|(
name|PCIM_EA_BEI
operator|&
name|val
operator|)
operator|>>
name|PCIM_EA_BEI_OFFSET
expr_stmt|;
name|base
operator|=
name|dw
index|[
literal|0
index|]
operator|&
name|PCIM_EA_FIELD_MASK
expr_stmt|;
name|max_offset
operator|=
name|dw
index|[
literal|1
index|]
operator||
operator|~
name|PCIM_EA_FIELD_MASK
expr_stmt|;
name|b
operator|=
literal|2
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|dw
index|[
literal|0
index|]
operator|&
name|PCIM_EA_IS_64
operator|)
operator|!=
literal|0
operator|)
operator|&&
operator|(
name|b
operator|<
name|ent_size
operator|)
condition|)
block|{
name|base
operator||=
operator|(
name|uint64_t
operator|)
name|dw
index|[
name|b
index|]
operator|<<
literal|32UL
expr_stmt|;
name|b
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|(
operator|(
name|dw
index|[
literal|1
index|]
operator|&
name|PCIM_EA_IS_64
operator|)
operator|!=
literal|0
operator|)
operator|&&
operator|(
name|b
operator|<
name|ent_size
operator|)
condition|)
block|{
name|max_offset
operator||=
operator|(
name|uint64_t
operator|)
name|dw
index|[
name|b
index|]
operator|<<
literal|32UL
expr_stmt|;
name|b
operator|++
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n\t\t [%d] %s, %s, %s, base [0x%jx], size [0x%jx]"
literal|"\n\t\t\tPrimary properties [0x%x] (%s)"
literal|"\n\t\t\tSecondary properties [0x%x] (%s)"
argument_list|,
name|bei
argument_list|,
name|ea_bei_to_name
argument_list|(
name|bei
argument_list|)
argument_list|,
operator|(
name|flags
operator|&
name|PCIM_EA_ENABLE
condition|?
literal|"Enabled"
else|:
literal|"Disabled"
operator|)
argument_list|,
operator|(
name|flags
operator|&
name|PCIM_EA_WRITABLE
condition|?
literal|"Writable"
else|:
literal|"Read-only"
operator|)
argument_list|,
operator|(
name|uintmax_t
operator|)
name|base
argument_list|,
call|(
name|uintmax_t
call|)
argument_list|(
name|max_offset
operator|+
literal|1
argument_list|)
argument_list|,
name|flags_pp
argument_list|,
name|ea_prop_to_name
argument_list|(
name|flags_pp
argument_list|)
argument_list|,
name|flags_sp
argument_list|,
name|ea_prop_to_name
argument_list|(
name|flags_sp
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|list_caps
parameter_list|(
name|int
name|fd
parameter_list|,
name|struct
name|pci_conf
modifier|*
name|p
parameter_list|)
block|{
name|int
name|express
decl_stmt|;
name|uint16_t
name|sta
decl_stmt|;
name|uint8_t
name|ptr
decl_stmt|,
name|cap
decl_stmt|;
comment|/* Are capabilities present for this device? */
name|sta
operator|=
name|read_config
argument_list|(
name|fd
argument_list|,
operator|&
name|p
operator|->
name|pc_sel
argument_list|,
name|PCIR_STATUS
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|sta
operator|&
name|PCIM_STATUS_CAPPRESENT
operator|)
condition|)
return|return;
switch|switch
condition|(
name|p
operator|->
name|pc_hdr
operator|&
name|PCIM_HDRTYPE
condition|)
block|{
case|case
name|PCIM_HDRTYPE_NORMAL
case|:
case|case
name|PCIM_HDRTYPE_BRIDGE
case|:
name|ptr
operator|=
name|PCIR_CAP_PTR
expr_stmt|;
break|break;
case|case
name|PCIM_HDRTYPE_CARDBUS
case|:
name|ptr
operator|=
name|PCIR_CAP_PTR_2
expr_stmt|;
break|break;
default|default:
name|errx
argument_list|(
literal|1
argument_list|,
literal|"list_caps: bad header type"
argument_list|)
expr_stmt|;
block|}
comment|/* Walk the capability list. */
name|express
operator|=
literal|0
expr_stmt|;
name|ptr
operator|=
name|read_config
argument_list|(
name|fd
argument_list|,
operator|&
name|p
operator|->
name|pc_sel
argument_list|,
name|ptr
argument_list|,
literal|1
argument_list|)
expr_stmt|;
while|while
condition|(
name|ptr
operator|!=
literal|0
operator|&&
name|ptr
operator|!=
literal|0xff
condition|)
block|{
name|cap
operator|=
name|read_config
argument_list|(
name|fd
argument_list|,
operator|&
name|p
operator|->
name|pc_sel
argument_list|,
name|ptr
operator|+
name|PCICAP_ID
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    cap %02x[%02x] = "
argument_list|,
name|cap
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cap
condition|)
block|{
case|case
name|PCIY_PMG
case|:
name|cap_power
argument_list|(
name|fd
argument_list|,
name|p
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCIY_AGP
case|:
name|cap_agp
argument_list|(
name|fd
argument_list|,
name|p
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCIY_VPD
case|:
name|cap_vpd
argument_list|(
name|fd
argument_list|,
name|p
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCIY_MSI
case|:
name|cap_msi
argument_list|(
name|fd
argument_list|,
name|p
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCIY_PCIX
case|:
name|cap_pcix
argument_list|(
name|fd
argument_list|,
name|p
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCIY_HT
case|:
name|cap_ht
argument_list|(
name|fd
argument_list|,
name|p
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCIY_VENDOR
case|:
name|cap_vendor
argument_list|(
name|fd
argument_list|,
name|p
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCIY_DEBUG
case|:
name|cap_debug
argument_list|(
name|fd
argument_list|,
name|p
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCIY_SUBVENDOR
case|:
name|cap_subvendor
argument_list|(
name|fd
argument_list|,
name|p
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCIY_EXPRESS
case|:
name|express
operator|=
literal|1
expr_stmt|;
name|cap_express
argument_list|(
name|fd
argument_list|,
name|p
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCIY_MSIX
case|:
name|cap_msix
argument_list|(
name|fd
argument_list|,
name|p
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCIY_SATA
case|:
name|cap_sata
argument_list|(
name|fd
argument_list|,
name|p
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCIY_PCIAF
case|:
name|cap_pciaf
argument_list|(
name|fd
argument_list|,
name|p
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCIY_EA
case|:
name|cap_ea
argument_list|(
name|fd
argument_list|,
name|p
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"unknown"
argument_list|)
expr_stmt|;
break|break;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|ptr
operator|=
name|read_config
argument_list|(
name|fd
argument_list|,
operator|&
name|p
operator|->
name|pc_sel
argument_list|,
name|ptr
operator|+
name|PCICAP_NEXTPTR
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|express
condition|)
name|list_ecaps
argument_list|(
name|fd
argument_list|,
name|p
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* From<sys/systm.h>. */
end_comment

begin_function
specifier|static
name|__inline
name|uint32_t
name|bitcount32
parameter_list|(
name|uint32_t
name|x
parameter_list|)
block|{
name|x
operator|=
operator|(
name|x
operator|&
literal|0x55555555
operator|)
operator|+
operator|(
operator|(
name|x
operator|&
literal|0xaaaaaaaa
operator|)
operator|>>
literal|1
operator|)
expr_stmt|;
name|x
operator|=
operator|(
name|x
operator|&
literal|0x33333333
operator|)
operator|+
operator|(
operator|(
name|x
operator|&
literal|0xcccccccc
operator|)
operator|>>
literal|2
operator|)
expr_stmt|;
name|x
operator|=
operator|(
name|x
operator|+
operator|(
name|x
operator|>>
literal|4
operator|)
operator|)
operator|&
literal|0x0f0f0f0f
expr_stmt|;
name|x
operator|=
operator|(
name|x
operator|+
operator|(
name|x
operator|>>
literal|8
operator|)
operator|)
expr_stmt|;
name|x
operator|=
operator|(
name|x
operator|+
operator|(
name|x
operator|>>
literal|16
operator|)
operator|)
operator|&
literal|0x000000ff
expr_stmt|;
return|return
operator|(
name|x
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ecap_aer
parameter_list|(
name|int
name|fd
parameter_list|,
name|struct
name|pci_conf
modifier|*
name|p
parameter_list|,
name|uint16_t
name|ptr
parameter_list|,
name|uint8_t
name|ver
parameter_list|)
block|{
name|uint32_t
name|sta
decl_stmt|,
name|mask
decl_stmt|;
name|printf
argument_list|(
literal|"AER %d"
argument_list|,
name|ver
argument_list|)
expr_stmt|;
if|if
condition|(
name|ver
operator|<
literal|1
condition|)
return|return;
name|sta
operator|=
name|read_config
argument_list|(
name|fd
argument_list|,
operator|&
name|p
operator|->
name|pc_sel
argument_list|,
name|ptr
operator|+
name|PCIR_AER_UC_STATUS
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|mask
operator|=
name|read_config
argument_list|(
name|fd
argument_list|,
operator|&
name|p
operator|->
name|pc_sel
argument_list|,
name|ptr
operator|+
name|PCIR_AER_UC_SEVERITY
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" %d fatal"
argument_list|,
name|bitcount32
argument_list|(
name|sta
operator|&
name|mask
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" %d non-fatal"
argument_list|,
name|bitcount32
argument_list|(
name|sta
operator|&
operator|~
name|mask
argument_list|)
argument_list|)
expr_stmt|;
name|sta
operator|=
name|read_config
argument_list|(
name|fd
argument_list|,
operator|&
name|p
operator|->
name|pc_sel
argument_list|,
name|ptr
operator|+
name|PCIR_AER_COR_STATUS
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" %d corrected\n"
argument_list|,
name|bitcount32
argument_list|(
name|sta
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ecap_vc
parameter_list|(
name|int
name|fd
parameter_list|,
name|struct
name|pci_conf
modifier|*
name|p
parameter_list|,
name|uint16_t
name|ptr
parameter_list|,
name|uint8_t
name|ver
parameter_list|)
block|{
name|uint32_t
name|cap1
decl_stmt|;
name|printf
argument_list|(
literal|"VC %d"
argument_list|,
name|ver
argument_list|)
expr_stmt|;
if|if
condition|(
name|ver
operator|<
literal|1
condition|)
return|return;
name|cap1
operator|=
name|read_config
argument_list|(
name|fd
argument_list|,
operator|&
name|p
operator|->
name|pc_sel
argument_list|,
name|ptr
operator|+
name|PCIR_VC_CAP1
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" max VC%d"
argument_list|,
name|cap1
operator|&
name|PCIM_VC_CAP1_EXT_COUNT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|cap1
operator|&
name|PCIM_VC_CAP1_LOWPRI_EXT_COUNT
operator|)
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|" lowpri VC0-VC%d"
argument_list|,
operator|(
name|cap1
operator|&
name|PCIM_VC_CAP1_LOWPRI_EXT_COUNT
operator|)
operator|>>
literal|4
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ecap_sernum
parameter_list|(
name|int
name|fd
parameter_list|,
name|struct
name|pci_conf
modifier|*
name|p
parameter_list|,
name|uint16_t
name|ptr
parameter_list|,
name|uint8_t
name|ver
parameter_list|)
block|{
name|uint32_t
name|high
decl_stmt|,
name|low
decl_stmt|;
name|printf
argument_list|(
literal|"Serial %d"
argument_list|,
name|ver
argument_list|)
expr_stmt|;
if|if
condition|(
name|ver
operator|<
literal|1
condition|)
return|return;
name|low
operator|=
name|read_config
argument_list|(
name|fd
argument_list|,
operator|&
name|p
operator|->
name|pc_sel
argument_list|,
name|ptr
operator|+
name|PCIR_SERIAL_LOW
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|high
operator|=
name|read_config
argument_list|(
name|fd
argument_list|,
operator|&
name|p
operator|->
name|pc_sel
argument_list|,
name|ptr
operator|+
name|PCIR_SERIAL_HIGH
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" %08x%08x\n"
argument_list|,
name|high
argument_list|,
name|low
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ecap_vendor
parameter_list|(
name|int
name|fd
parameter_list|,
name|struct
name|pci_conf
modifier|*
name|p
parameter_list|,
name|uint16_t
name|ptr
parameter_list|,
name|uint8_t
name|ver
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|;
name|printf
argument_list|(
literal|"Vendor %d"
argument_list|,
name|ver
argument_list|)
expr_stmt|;
if|if
condition|(
name|ver
operator|<
literal|1
condition|)
return|return;
name|val
operator|=
name|read_config
argument_list|(
name|fd
argument_list|,
operator|&
name|p
operator|->
name|pc_sel
argument_list|,
name|ptr
operator|+
literal|4
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" ID %d\n"
argument_list|,
name|val
operator|&
literal|0xffff
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ecap_sec_pcie
parameter_list|(
name|int
name|fd
parameter_list|,
name|struct
name|pci_conf
modifier|*
name|p
parameter_list|,
name|uint16_t
name|ptr
parameter_list|,
name|uint8_t
name|ver
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|;
name|printf
argument_list|(
literal|"PCIe Sec %d"
argument_list|,
name|ver
argument_list|)
expr_stmt|;
if|if
condition|(
name|ver
operator|<
literal|1
condition|)
return|return;
name|val
operator|=
name|read_config
argument_list|(
name|fd
argument_list|,
operator|&
name|p
operator|->
name|pc_sel
argument_list|,
name|ptr
operator|+
literal|8
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" lane errors %#x\n"
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|check_enabled
parameter_list|(
name|int
name|value
parameter_list|)
block|{
return|return
operator|(
name|value
condition|?
literal|"enabled"
else|:
literal|"disabled"
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ecap_sriov
parameter_list|(
name|int
name|fd
parameter_list|,
name|struct
name|pci_conf
modifier|*
name|p
parameter_list|,
name|uint16_t
name|ptr
parameter_list|,
name|uint8_t
name|ver
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|comma
decl_stmt|,
modifier|*
name|enabled
decl_stmt|;
name|uint16_t
name|iov_ctl
decl_stmt|,
name|total_vfs
decl_stmt|,
name|num_vfs
decl_stmt|,
name|vf_offset
decl_stmt|,
name|vf_stride
decl_stmt|,
name|vf_did
decl_stmt|;
name|uint32_t
name|page_caps
decl_stmt|,
name|page_size
decl_stmt|,
name|page_shift
decl_stmt|,
name|size
decl_stmt|;
name|int
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"SR-IOV %d "
argument_list|,
name|ver
argument_list|)
expr_stmt|;
name|iov_ctl
operator|=
name|read_config
argument_list|(
name|fd
argument_list|,
operator|&
name|p
operator|->
name|pc_sel
argument_list|,
name|ptr
operator|+
name|PCIR_SRIOV_CTL
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"IOV %s, Memory Space %s, ARI %s\n"
argument_list|,
name|check_enabled
argument_list|(
name|iov_ctl
operator|&
name|PCIM_SRIOV_VF_EN
argument_list|)
argument_list|,
name|check_enabled
argument_list|(
name|iov_ctl
operator|&
name|PCIM_SRIOV_VF_MSE
argument_list|)
argument_list|,
name|check_enabled
argument_list|(
name|iov_ctl
operator|&
name|PCIM_SRIOV_ARI_EN
argument_list|)
argument_list|)
expr_stmt|;
name|total_vfs
operator|=
name|read_config
argument_list|(
name|fd
argument_list|,
operator|&
name|p
operator|->
name|pc_sel
argument_list|,
name|ptr
operator|+
name|PCIR_SRIOV_TOTAL_VFS
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|num_vfs
operator|=
name|read_config
argument_list|(
name|fd
argument_list|,
operator|&
name|p
operator|->
name|pc_sel
argument_list|,
name|ptr
operator|+
name|PCIR_SRIOV_NUM_VFS
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"                     "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%d VFs configured out of %d supported\n"
argument_list|,
name|num_vfs
argument_list|,
name|total_vfs
argument_list|)
expr_stmt|;
name|vf_offset
operator|=
name|read_config
argument_list|(
name|fd
argument_list|,
operator|&
name|p
operator|->
name|pc_sel
argument_list|,
name|ptr
operator|+
name|PCIR_SRIOV_VF_OFF
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|vf_stride
operator|=
name|read_config
argument_list|(
name|fd
argument_list|,
operator|&
name|p
operator|->
name|pc_sel
argument_list|,
name|ptr
operator|+
name|PCIR_SRIOV_VF_STRIDE
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"                     "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"First VF RID Offset 0x%04x, VF RID Stride 0x%04x\n"
argument_list|,
name|vf_offset
argument_list|,
name|vf_stride
argument_list|)
expr_stmt|;
name|vf_did
operator|=
name|read_config
argument_list|(
name|fd
argument_list|,
operator|&
name|p
operator|->
name|pc_sel
argument_list|,
name|ptr
operator|+
name|PCIR_SRIOV_VF_DID
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"                     VF Device ID 0x%04x\n"
argument_list|,
name|vf_did
argument_list|)
expr_stmt|;
name|page_caps
operator|=
name|read_config
argument_list|(
name|fd
argument_list|,
operator|&
name|p
operator|->
name|pc_sel
argument_list|,
name|ptr
operator|+
name|PCIR_SRIOV_PAGE_CAP
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|page_size
operator|=
name|read_config
argument_list|(
name|fd
argument_list|,
operator|&
name|p
operator|->
name|pc_sel
argument_list|,
name|ptr
operator|+
name|PCIR_SRIOV_PAGE_SIZE
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"                     "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Page Sizes: "
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|""
expr_stmt|;
while|while
condition|(
name|page_caps
operator|!=
literal|0
condition|)
block|{
name|page_shift
operator|=
name|ffs
argument_list|(
name|page_caps
argument_list|)
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|page_caps
operator|&
name|page_size
condition|)
name|enabled
operator|=
literal|" (enabled)"
expr_stmt|;
else|else
name|enabled
operator|=
literal|""
expr_stmt|;
name|size
operator|=
operator|(
literal|1
operator|<<
operator|(
name|page_shift
operator|+
name|PCI_SRIOV_BASE_PAGE_SHIFT
operator|)
operator|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s%d%s"
argument_list|,
name|comma
argument_list|,
name|size
argument_list|,
name|enabled
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|", "
expr_stmt|;
name|page_caps
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|page_shift
operator|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
name|PCIR_MAX_BAR_0
condition|;
name|i
operator|++
control|)
name|print_bar
argument_list|(
name|fd
argument_list|,
name|p
argument_list|,
literal|"iov bar  "
argument_list|,
name|ptr
operator|+
name|PCIR_SRIOV_BAR
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_struct
specifier|static
struct|struct
block|{
name|uint16_t
name|id
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
block|}
name|ecap_names
index|[]
init|=
block|{
block|{
name|PCIZ_PWRBDGT
block|,
literal|"Power Budgeting"
block|}
block|,
block|{
name|PCIZ_RCLINK_DCL
block|,
literal|"Root Complex Link Declaration"
block|}
block|,
block|{
name|PCIZ_RCLINK_CTL
block|,
literal|"Root Complex Internal Link Control"
block|}
block|,
block|{
name|PCIZ_RCEC_ASSOC
block|,
literal|"Root Complex Event Collector ASsociation"
block|}
block|,
block|{
name|PCIZ_MFVC
block|,
literal|"MFVC"
block|}
block|,
block|{
name|PCIZ_RCRB
block|,
literal|"RCRB"
block|}
block|,
block|{
name|PCIZ_ACS
block|,
literal|"ACS"
block|}
block|,
block|{
name|PCIZ_ARI
block|,
literal|"ARI"
block|}
block|,
block|{
name|PCIZ_ATS
block|,
literal|"ATS"
block|}
block|,
block|{
name|PCIZ_MULTICAST
block|,
literal|"Multicast"
block|}
block|,
block|{
name|PCIZ_RESIZE_BAR
block|,
literal|"Resizable BAR"
block|}
block|,
block|{
name|PCIZ_DPA
block|,
literal|"DPA"
block|}
block|,
block|{
name|PCIZ_TPH_REQ
block|,
literal|"TPH Requester"
block|}
block|,
block|{
name|PCIZ_LTR
block|,
literal|"LTR"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
name|list_ecaps
parameter_list|(
name|int
name|fd
parameter_list|,
name|struct
name|pci_conf
modifier|*
name|p
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|uint32_t
name|ecap
decl_stmt|;
name|uint16_t
name|ptr
decl_stmt|;
name|int
name|i
decl_stmt|;
name|ptr
operator|=
name|PCIR_EXTCAP
expr_stmt|;
name|ecap
operator|=
name|read_config
argument_list|(
name|fd
argument_list|,
operator|&
name|p
operator|->
name|pc_sel
argument_list|,
name|ptr
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|ecap
operator|==
literal|0xffffffff
operator|||
name|ecap
operator|==
literal|0
condition|)
return|return;
for|for
control|(
init|;
condition|;
control|)
block|{
name|printf
argument_list|(
literal|"    ecap %04x[%03x] = "
argument_list|,
name|PCI_EXTCAP_ID
argument_list|(
name|ecap
argument_list|)
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|PCI_EXTCAP_ID
argument_list|(
name|ecap
argument_list|)
condition|)
block|{
case|case
name|PCIZ_AER
case|:
name|ecap_aer
argument_list|(
name|fd
argument_list|,
name|p
argument_list|,
name|ptr
argument_list|,
name|PCI_EXTCAP_VER
argument_list|(
name|ecap
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCIZ_VC
case|:
name|ecap_vc
argument_list|(
name|fd
argument_list|,
name|p
argument_list|,
name|ptr
argument_list|,
name|PCI_EXTCAP_VER
argument_list|(
name|ecap
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCIZ_SERNUM
case|:
name|ecap_sernum
argument_list|(
name|fd
argument_list|,
name|p
argument_list|,
name|ptr
argument_list|,
name|PCI_EXTCAP_VER
argument_list|(
name|ecap
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCIZ_VENDOR
case|:
name|ecap_vendor
argument_list|(
name|fd
argument_list|,
name|p
argument_list|,
name|ptr
argument_list|,
name|PCI_EXTCAP_VER
argument_list|(
name|ecap
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCIZ_SEC_PCIE
case|:
name|ecap_sec_pcie
argument_list|(
name|fd
argument_list|,
name|p
argument_list|,
name|ptr
argument_list|,
name|PCI_EXTCAP_VER
argument_list|(
name|ecap
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCIZ_SRIOV
case|:
name|ecap_sriov
argument_list|(
name|fd
argument_list|,
name|p
argument_list|,
name|ptr
argument_list|,
name|PCI_EXTCAP_VER
argument_list|(
name|ecap
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|name
operator|=
literal|"unknown"
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|ecap_names
index|[
name|i
index|]
operator|.
name|name
operator|!=
name|NULL
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|ecap_names
index|[
name|i
index|]
operator|.
name|id
operator|==
name|PCI_EXTCAP_ID
argument_list|(
name|ecap
argument_list|)
condition|)
block|{
name|name
operator|=
name|ecap_names
index|[
name|i
index|]
operator|.
name|name
expr_stmt|;
break|break;
block|}
name|printf
argument_list|(
literal|"%s %d\n"
argument_list|,
name|name
argument_list|,
name|PCI_EXTCAP_VER
argument_list|(
name|ecap
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|ptr
operator|=
name|PCI_EXTCAP_NEXTPTR
argument_list|(
name|ecap
argument_list|)
expr_stmt|;
if|if
condition|(
name|ptr
operator|==
literal|0
condition|)
break|break;
name|ecap
operator|=
name|read_config
argument_list|(
name|fd
argument_list|,
operator|&
name|p
operator|->
name|pc_sel
argument_list|,
name|ptr
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* Find offset of a specific capability.  Returns 0 on failure. */
end_comment

begin_function
name|uint8_t
name|pci_find_cap
parameter_list|(
name|int
name|fd
parameter_list|,
name|struct
name|pci_conf
modifier|*
name|p
parameter_list|,
name|uint8_t
name|id
parameter_list|)
block|{
name|uint16_t
name|sta
decl_stmt|;
name|uint8_t
name|ptr
decl_stmt|,
name|cap
decl_stmt|;
comment|/* Are capabilities present for this device? */
name|sta
operator|=
name|read_config
argument_list|(
name|fd
argument_list|,
operator|&
name|p
operator|->
name|pc_sel
argument_list|,
name|PCIR_STATUS
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|sta
operator|&
name|PCIM_STATUS_CAPPRESENT
operator|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
switch|switch
condition|(
name|p
operator|->
name|pc_hdr
operator|&
name|PCIM_HDRTYPE
condition|)
block|{
case|case
name|PCIM_HDRTYPE_NORMAL
case|:
case|case
name|PCIM_HDRTYPE_BRIDGE
case|:
name|ptr
operator|=
name|PCIR_CAP_PTR
expr_stmt|;
break|break;
case|case
name|PCIM_HDRTYPE_CARDBUS
case|:
name|ptr
operator|=
name|PCIR_CAP_PTR_2
expr_stmt|;
break|break;
default|default:
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|ptr
operator|=
name|read_config
argument_list|(
name|fd
argument_list|,
operator|&
name|p
operator|->
name|pc_sel
argument_list|,
name|ptr
argument_list|,
literal|1
argument_list|)
expr_stmt|;
while|while
condition|(
name|ptr
operator|!=
literal|0
operator|&&
name|ptr
operator|!=
literal|0xff
condition|)
block|{
name|cap
operator|=
name|read_config
argument_list|(
name|fd
argument_list|,
operator|&
name|p
operator|->
name|pc_sel
argument_list|,
name|ptr
operator|+
name|PCICAP_ID
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|cap
operator|==
name|id
condition|)
return|return
operator|(
name|ptr
operator|)
return|;
name|ptr
operator|=
name|read_config
argument_list|(
name|fd
argument_list|,
operator|&
name|p
operator|->
name|pc_sel
argument_list|,
name|ptr
operator|+
name|PCICAP_NEXTPTR
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Find offset of a specific extended capability.  Returns 0 on failure. */
end_comment

begin_function
name|uint16_t
name|pcie_find_cap
parameter_list|(
name|int
name|fd
parameter_list|,
name|struct
name|pci_conf
modifier|*
name|p
parameter_list|,
name|uint16_t
name|id
parameter_list|)
block|{
name|uint32_t
name|ecap
decl_stmt|;
name|uint16_t
name|ptr
decl_stmt|;
name|ptr
operator|=
name|PCIR_EXTCAP
expr_stmt|;
name|ecap
operator|=
name|read_config
argument_list|(
name|fd
argument_list|,
operator|&
name|p
operator|->
name|pc_sel
argument_list|,
name|ptr
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|ecap
operator|==
literal|0xffffffff
operator|||
name|ecap
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|PCI_EXTCAP_ID
argument_list|(
name|ecap
argument_list|)
operator|==
name|id
condition|)
return|return
operator|(
name|ptr
operator|)
return|;
name|ptr
operator|=
name|PCI_EXTCAP_NEXTPTR
argument_list|(
name|ecap
argument_list|)
expr_stmt|;
if|if
condition|(
name|ptr
operator|==
literal|0
condition|)
break|break;
name|ecap
operator|=
name|read_config
argument_list|(
name|fd
argument_list|,
operator|&
name|p
operator|->
name|pc_sel
argument_list|,
name|ptr
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1992 Carnegie Mellon University  * All Rights Reserved.  *   * Permission to use, copy, modify and distribute this software and its  * documentation is hereby granted, provided that both the copyright  * notice and this permission notice appear in all copies of the  * software, derivative works or modified versions, and any portions  * thereof, and that both notices appear in supporting documentation.  *  * CARNEGIE MELLON ALLOWS FREE USE OF THIS SOFTWARE IN ITS "AS IS"  * CONDITION.  CARNEGIE MELLON DISCLAIMS ANY LIABILITY OF ANY KIND FOR  * ANY DAMAGES WHATSOEVER RESULTING FROM THE USE OF THIS SOFTWARE.  *  * Carnegie Mellon requests users of this software to return to  *  *  Software Distribution Coordinator  or  Software_Distribution@CS.CMU.EDU  *  School of Computer Science  *  Carnegie Mellon University  *  Pittsburgh PA 15213-3890  *  * any improvements or extensions that they make and grant Carnegie Mellon  * the rights to redistribute these changes.  */
end_comment

begin_comment
comment|/*  **********************************************************************  * HISTORY  *  * 7-July-93  Nate Williams at Montana State University  *	Modified SUP to use gzip based compression when sending files  *	across the network to save BandWidth  *  * $Log: supmsg.c,v $  * Revision 1.1.1.1  1995/12/26 04:54:47  peter  * Import the unmodified version of the sup that we are using.  * The heritage of this version is not clear.  It appears to be NetBSD  * derived from some time ago.  *  * Revision 1.1.1.1  1993/08/21  00:46:35  jkh  * Current sup with compression support.  *  * Revision 1.1.1.1  1993/05/21  14:52:19  cgd  * initial import of CMU's SUP to NetBSD  *  * Revision 2.4  92/09/09  22:05:17  mrt  * 	Moved PFI definition under __STDC__ conditional since it  * 	is already defined in libc.h in this case.  * 	[92/09/01            mrt]  *   * Revision 2.3  92/08/11  12:08:12  mrt  * 	Added copyright  * 	[92/08/10            mrt]  * 	Brad's changes: Delinted, Incorporated updated variable   * 	argument list usage from old msgxfer.c  * 	[92/07/24            mrt]  *   * Revision 2.2  89/08/23  15:02:56  gm0w  * 	Created from separate message modules.  * 	[89/08/14            gm0w]  *   **********************************************************************  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_if
if|#
directive|if
name|__STDC__
end_if

begin_include
include|#
directive|include
file|<stdarg.h>
end_include

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<varargs.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<libc.h>
end_include

begin_include
include|#
directive|include
file|<c.h>
end_include

begin_include
include|#
directive|include
file|"sup.h"
end_include

begin_define
define|#
directive|define
name|MSGSUBR
end_define

begin_define
define|#
directive|define
name|MSGFILE
end_define

begin_include
include|#
directive|include
file|"supmsg.h"
end_include

begin_comment
comment|/*  * signon message  */
end_comment

begin_decl_stmt
specifier|extern
name|int
name|pgmver
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* program version of partner */
end_comment

begin_decl_stmt
specifier|extern
name|int
name|pgmversion
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* my program version */
end_comment

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|scmver
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* scm version of partner */
end_comment

begin_decl_stmt
specifier|extern
name|int
name|fspid
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* process id of fileserver */
end_comment

begin_function
name|int
name|msgsignon
parameter_list|()
block|{
specifier|register
name|int
name|x
decl_stmt|;
if|if
condition|(
name|server
condition|)
block|{
name|x
operator|=
name|readmsg
argument_list|(
name|MSGSIGNON
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|readint
argument_list|(
operator|&
name|protver
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|readint
argument_list|(
operator|&
name|pgmver
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|readstring
argument_list|(
operator|&
name|scmver
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|readmend
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|x
operator|=
name|writemsg
argument_list|(
name|MSGSIGNON
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|writeint
argument_list|(
name|PROTOVERSION
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|writeint
argument_list|(
name|pgmversion
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|writestring
argument_list|(
name|scmversion
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|writemend
argument_list|()
expr_stmt|;
block|}
return|return
operator|(
name|x
operator|)
return|;
block|}
end_function

begin_function
name|int
name|msgsignonack
parameter_list|()
block|{
specifier|register
name|int
name|x
decl_stmt|;
if|if
condition|(
name|server
condition|)
block|{
name|x
operator|=
name|writemsg
argument_list|(
name|MSGSIGNONACK
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|writeint
argument_list|(
name|PROTOVERSION
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|writeint
argument_list|(
name|pgmversion
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|writestring
argument_list|(
name|scmversion
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|writeint
argument_list|(
name|fspid
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|writemend
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|x
operator|=
name|readmsg
argument_list|(
name|MSGSIGNONACK
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|readint
argument_list|(
operator|&
name|protver
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|readint
argument_list|(
operator|&
name|pgmver
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|readstring
argument_list|(
operator|&
name|scmver
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|readint
argument_list|(
operator|&
name|fspid
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|readmend
argument_list|()
expr_stmt|;
block|}
return|return
operator|(
name|x
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * setup message  */
end_comment

begin_decl_stmt
specifier|extern
name|int
name|xpatch
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* setup crosspatch to a new client */
end_comment

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|xuser
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* user,group,acct for crosspatch */
end_comment

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|collname
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* base directory */
end_comment

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|basedir
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* base directory */
end_comment

begin_decl_stmt
specifier|extern
name|int
name|basedev
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* base directory device */
end_comment

begin_decl_stmt
specifier|extern
name|int
name|baseino
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* base directory inode */
end_comment

begin_decl_stmt
specifier|extern
name|long
name|lasttime
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* time of last upgrade */
end_comment

begin_decl_stmt
specifier|extern
name|int
name|listonly
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* only listing files, no data xfer */
end_comment

begin_decl_stmt
specifier|extern
name|int
name|newonly
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* only send new files */
end_comment

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|release
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* release name */
end_comment

begin_decl_stmt
specifier|extern
name|int
name|setupack
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* ack return value for setup */
end_comment

begin_function
name|int
name|msgsetup
parameter_list|()
block|{
specifier|register
name|int
name|x
decl_stmt|;
if|if
condition|(
name|server
condition|)
block|{
name|x
operator|=
name|readmsg
argument_list|(
name|MSGSETUP
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|!=
name|SCMOK
condition|)
return|return
operator|(
name|x
operator|)
return|;
if|if
condition|(
name|protver
operator|>=
literal|7
condition|)
block|{
name|x
operator|=
name|readint
argument_list|(
operator|&
name|xpatch
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|!=
name|SCMOK
condition|)
return|return
operator|(
name|x
operator|)
return|;
block|}
else|else
name|xpatch
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
name|xpatch
condition|)
block|{
name|x
operator|=
name|readstring
argument_list|(
operator|&
name|xuser
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|!=
name|SCMOK
condition|)
return|return
operator|(
name|x
operator|)
return|;
return|return
operator|(
name|readmend
argument_list|()
operator|)
return|;
block|}
name|x
operator|=
name|readstring
argument_list|(
operator|&
name|collname
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|readint
argument_list|(
operator|(
name|int
operator|*
operator|)
operator|&
name|lasttime
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|readstring
argument_list|(
operator|&
name|basedir
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|readint
argument_list|(
operator|&
name|basedev
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|readint
argument_list|(
operator|&
name|baseino
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|readint
argument_list|(
operator|&
name|listonly
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|readint
argument_list|(
operator|&
name|newonly
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
if|if
condition|(
name|protver
operator|<
literal|6
condition|)
name|release
operator|=
operator|(
name|char
operator|*
operator|)
name|NULL
expr_stmt|;
else|else
name|x
operator|=
name|readstring
argument_list|(
operator|&
name|release
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|readmend
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|x
operator|=
name|writemsg
argument_list|(
name|MSGSETUP
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|!=
name|SCMOK
condition|)
return|return
operator|(
name|x
operator|)
return|;
if|if
condition|(
name|protver
operator|>=
literal|7
condition|)
block|{
name|x
operator|=
name|writeint
argument_list|(
name|xpatch
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|!=
name|SCMOK
condition|)
return|return
operator|(
name|x
operator|)
return|;
block|}
if|if
condition|(
name|xpatch
condition|)
block|{
name|x
operator|=
name|writestring
argument_list|(
name|xuser
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|!=
name|SCMOK
condition|)
return|return
operator|(
name|x
operator|)
return|;
return|return
operator|(
name|writemend
argument_list|()
operator|)
return|;
block|}
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|writestring
argument_list|(
name|collname
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|writeint
argument_list|(
operator|(
name|int
operator|)
name|lasttime
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|writestring
argument_list|(
name|basedir
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|writeint
argument_list|(
name|basedev
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|writeint
argument_list|(
name|baseino
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|writeint
argument_list|(
name|listonly
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|writeint
argument_list|(
name|newonly
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
operator|&&
name|protver
operator|>=
literal|6
condition|)
name|x
operator|=
name|writestring
argument_list|(
name|release
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|writemend
argument_list|()
expr_stmt|;
block|}
return|return
operator|(
name|x
operator|)
return|;
block|}
end_function

begin_function
name|int
name|msgsetupack
parameter_list|()
block|{
if|if
condition|(
name|server
condition|)
return|return
operator|(
name|writemint
argument_list|(
name|MSGSETUPACK
argument_list|,
name|setupack
argument_list|)
operator|)
return|;
return|return
operator|(
name|readmint
argument_list|(
name|MSGSETUPACK
argument_list|,
operator|&
name|setupack
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * crypt test message  */
end_comment

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|crypttest
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* encryption test string */
end_comment

begin_function
name|int
name|msgcrypt
parameter_list|()
block|{
if|if
condition|(
name|server
condition|)
return|return
operator|(
name|readmstr
argument_list|(
name|MSGCRYPT
argument_list|,
operator|&
name|crypttest
argument_list|)
operator|)
return|;
return|return
operator|(
name|writemstr
argument_list|(
name|MSGCRYPT
argument_list|,
name|crypttest
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|msgcryptok
parameter_list|()
block|{
if|if
condition|(
name|server
condition|)
return|return
operator|(
name|writemnull
argument_list|(
name|MSGCRYPTOK
argument_list|)
operator|)
return|;
return|return
operator|(
name|readmnull
argument_list|(
name|MSGCRYPTOK
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * login message  */
end_comment

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|logcrypt
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* login encryption test */
end_comment

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|loguser
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* login username */
end_comment

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|logpswd
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* password for login */
end_comment

begin_decl_stmt
specifier|extern
name|int
name|logack
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* login ack status */
end_comment

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|logerror
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* error from login */
end_comment

begin_function
name|int
name|msglogin
parameter_list|()
block|{
specifier|register
name|int
name|x
decl_stmt|;
if|if
condition|(
name|server
condition|)
block|{
name|x
operator|=
name|readmsg
argument_list|(
name|MSGLOGIN
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|readstring
argument_list|(
operator|&
name|logcrypt
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|readstring
argument_list|(
operator|&
name|loguser
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|readstring
argument_list|(
operator|&
name|logpswd
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|readmend
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|x
operator|=
name|writemsg
argument_list|(
name|MSGLOGIN
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|writestring
argument_list|(
name|logcrypt
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|writestring
argument_list|(
name|loguser
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|writestring
argument_list|(
name|logpswd
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|writemend
argument_list|()
expr_stmt|;
block|}
return|return
operator|(
name|x
operator|)
return|;
block|}
end_function

begin_function
name|int
name|msglogack
parameter_list|()
block|{
specifier|register
name|int
name|x
decl_stmt|;
if|if
condition|(
name|server
condition|)
block|{
name|x
operator|=
name|writemsg
argument_list|(
name|MSGLOGACK
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|writeint
argument_list|(
name|logack
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|writestring
argument_list|(
name|logerror
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|writemend
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|x
operator|=
name|readmsg
argument_list|(
name|MSGLOGACK
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|readint
argument_list|(
operator|&
name|logack
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|readstring
argument_list|(
operator|&
name|logerror
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|readmend
argument_list|()
expr_stmt|;
block|}
return|return
operator|(
name|x
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * refuse list message  */
end_comment

begin_decl_stmt
specifier|extern
name|TREE
modifier|*
name|refuseT
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* tree of files to refuse */
end_comment

begin_function
specifier|static
name|int
name|refuseone
parameter_list|(
name|t
parameter_list|)
specifier|register
name|TREE
modifier|*
name|t
decl_stmt|;
block|{
return|return
operator|(
name|writestring
argument_list|(
name|t
operator|->
name|Tname
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|msgrefuse
parameter_list|()
block|{
specifier|register
name|int
name|x
decl_stmt|;
if|if
condition|(
name|server
condition|)
block|{
name|char
modifier|*
name|name
decl_stmt|;
name|x
operator|=
name|readmsg
argument_list|(
name|MSGREFUSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|readstring
argument_list|(
operator|&
name|name
argument_list|)
expr_stmt|;
while|while
condition|(
name|x
operator|==
name|SCMOK
condition|)
block|{
if|if
condition|(
name|name
operator|==
name|NULL
condition|)
break|break;
operator|(
name|void
operator|)
name|Tinsert
argument_list|(
operator|&
name|refuseT
argument_list|,
name|name
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|x
operator|=
name|readstring
argument_list|(
operator|&
name|name
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|readmend
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|x
operator|=
name|writemsg
argument_list|(
name|MSGREFUSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|Tprocess
argument_list|(
name|refuseT
argument_list|,
name|refuseone
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|writestring
argument_list|(
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|writemend
argument_list|()
expr_stmt|;
block|}
return|return
operator|(
name|x
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * list files message  */
end_comment

begin_decl_stmt
specifier|extern
name|TREE
modifier|*
name|listT
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* tree of files to list */
end_comment

begin_decl_stmt
specifier|extern
name|TREE
modifier|*
name|renameT
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* tree of rename target files */
end_comment

begin_decl_stmt
specifier|extern
name|long
name|scantime
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* time that collection was scanned */
end_comment

begin_function
specifier|static
name|int
name|listone
parameter_list|(
name|t
parameter_list|)
specifier|register
name|TREE
modifier|*
name|t
decl_stmt|;
block|{
specifier|register
name|int
name|x
decl_stmt|;
name|x
operator|=
name|writestring
argument_list|(
name|t
operator|->
name|Tname
argument_list|)
expr_stmt|;
if|if
condition|(
name|protver
operator|>
literal|8
condition|)
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|writestring
argument_list|(
name|t
operator|->
name|Tnewname
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|writeint
argument_list|(
operator|(
name|int
operator|)
name|t
operator|->
name|Tmode
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|writeint
argument_list|(
operator|(
name|int
operator|)
name|t
operator|->
name|Tflags
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|writeint
argument_list|(
name|t
operator|->
name|Tmtime
argument_list|)
expr_stmt|;
return|return
operator|(
name|x
operator|)
return|;
block|}
end_function

begin_function
name|int
name|msglist
parameter_list|()
block|{
specifier|register
name|int
name|x
decl_stmt|;
if|if
condition|(
name|server
condition|)
block|{
name|x
operator|=
name|writemsg
argument_list|(
name|MSGLIST
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|Tprocess
argument_list|(
name|listT
argument_list|,
name|listone
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|writestring
argument_list|(
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|writeint
argument_list|(
operator|(
name|int
operator|)
name|scantime
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|writemend
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|char
modifier|*
name|name
decl_stmt|,
modifier|*
name|newname
init|=
name|NULL
decl_stmt|;
name|int
name|mode
decl_stmt|,
name|flags
decl_stmt|,
name|mtime
decl_stmt|;
specifier|register
name|TREE
modifier|*
name|t
decl_stmt|;
name|x
operator|=
name|readmsg
argument_list|(
name|MSGLIST
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|readstring
argument_list|(
operator|&
name|name
argument_list|)
expr_stmt|;
while|while
condition|(
name|x
operator|==
name|SCMOK
condition|)
block|{
if|if
condition|(
name|name
operator|==
name|NULL
condition|)
break|break;
if|if
condition|(
name|protver
operator|>
literal|8
condition|)
block|{
name|x
operator|=
name|readstring
argument_list|(
operator|&
name|newname
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|readint
argument_list|(
operator|&
name|mode
argument_list|)
expr_stmt|;
block|}
else|else
name|x
operator|=
name|readint
argument_list|(
operator|&
name|mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|readint
argument_list|(
operator|&
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|readint
argument_list|(
operator|&
name|mtime
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|!=
name|SCMOK
condition|)
break|break;
name|t
operator|=
name|Tinsert
argument_list|(
operator|&
name|listT
argument_list|,
name|name
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|t
operator|->
name|Tnewname
operator|=
name|newname
expr_stmt|;
name|t
operator|->
name|Tmode
operator|=
name|mode
expr_stmt|;
name|t
operator|->
name|Tflags
operator|=
name|flags
expr_stmt|;
name|t
operator|->
name|Tmtime
operator|=
name|mtime
expr_stmt|;
name|x
operator|=
name|readstring
argument_list|(
operator|&
name|name
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|readint
argument_list|(
operator|(
name|int
operator|*
operator|)
operator|&
name|scantime
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|readmend
argument_list|()
expr_stmt|;
block|}
return|return
operator|(
name|x
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * files needed message  */
end_comment

begin_decl_stmt
specifier|extern
name|TREE
modifier|*
name|needT
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* tree of files to need */
end_comment

begin_function
specifier|static
name|int
name|needone
parameter_list|(
name|t
parameter_list|)
specifier|register
name|TREE
modifier|*
name|t
decl_stmt|;
block|{
specifier|register
name|int
name|x
decl_stmt|;
name|x
operator|=
name|writestring
argument_list|(
name|t
operator|->
name|Tname
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|writeint
argument_list|(
operator|(
name|t
operator|->
name|Tflags
operator|&
name|FUPDATE
operator|)
operator|!=
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|x
operator|)
return|;
block|}
end_function

begin_function
name|int
name|msgneed
parameter_list|()
block|{
specifier|register
name|int
name|x
decl_stmt|;
if|if
condition|(
name|server
condition|)
block|{
name|char
modifier|*
name|name
decl_stmt|;
name|int
name|update
decl_stmt|;
specifier|register
name|TREE
modifier|*
name|t
decl_stmt|;
name|x
operator|=
name|readmsg
argument_list|(
name|MSGNEED
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|readstring
argument_list|(
operator|&
name|name
argument_list|)
expr_stmt|;
while|while
condition|(
name|x
operator|==
name|SCMOK
condition|)
block|{
if|if
condition|(
name|name
operator|==
name|NULL
condition|)
break|break;
name|x
operator|=
name|readint
argument_list|(
operator|&
name|update
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|!=
name|SCMOK
condition|)
break|break;
name|t
operator|=
name|Tinsert
argument_list|(
operator|&
name|needT
argument_list|,
name|name
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|update
condition|)
name|t
operator|->
name|Tflags
operator||=
name|FUPDATE
expr_stmt|;
name|x
operator|=
name|readstring
argument_list|(
operator|&
name|name
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|readmend
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|x
operator|=
name|writemsg
argument_list|(
name|MSGNEED
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|Tprocess
argument_list|(
name|needT
argument_list|,
name|needone
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|writestring
argument_list|(
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|writemend
argument_list|()
expr_stmt|;
block|}
return|return
operator|(
name|x
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * files denied message  */
end_comment

begin_decl_stmt
specifier|extern
name|TREE
modifier|*
name|denyT
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* tree of files to deny */
end_comment

begin_function
specifier|static
name|int
name|denyone
parameter_list|(
name|t
parameter_list|)
specifier|register
name|TREE
modifier|*
name|t
decl_stmt|;
block|{
return|return
operator|(
name|writestring
argument_list|(
name|t
operator|->
name|Tname
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|msgdeny
parameter_list|()
block|{
specifier|register
name|int
name|x
decl_stmt|;
if|if
condition|(
name|server
condition|)
block|{
name|x
operator|=
name|writemsg
argument_list|(
name|MSGDENY
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|Tprocess
argument_list|(
name|denyT
argument_list|,
name|denyone
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|writestring
argument_list|(
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|writemend
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|char
modifier|*
name|name
decl_stmt|;
name|x
operator|=
name|readmsg
argument_list|(
name|MSGDENY
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|readstring
argument_list|(
operator|&
name|name
argument_list|)
expr_stmt|;
while|while
condition|(
name|x
operator|==
name|SCMOK
condition|)
block|{
if|if
condition|(
name|name
operator|==
name|NULL
condition|)
break|break;
operator|(
name|void
operator|)
name|Tinsert
argument_list|(
operator|&
name|denyT
argument_list|,
name|name
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|x
operator|=
name|readstring
argument_list|(
operator|&
name|name
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|readmend
argument_list|()
expr_stmt|;
block|}
return|return
operator|(
name|x
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * send file message  */
end_comment

begin_function
name|int
name|msgsend
parameter_list|()
block|{
if|if
condition|(
name|server
condition|)
return|return
operator|(
name|readmnull
argument_list|(
name|MSGSEND
argument_list|)
operator|)
return|;
return|return
operator|(
name|writemnull
argument_list|(
name|MSGSEND
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * receive file message  */
end_comment

begin_decl_stmt
specifier|extern
name|TREE
modifier|*
name|upgradeT
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* pointer to file being upgraded */
end_comment

begin_function
specifier|static
name|int
name|writeone
parameter_list|(
name|t
parameter_list|)
specifier|register
name|TREE
modifier|*
name|t
decl_stmt|;
block|{
return|return
operator|(
name|writestring
argument_list|(
name|t
operator|->
name|Tname
argument_list|)
operator|)
return|;
block|}
end_function

begin_if
if|#
directive|if
name|__STDC__
end_if

begin_decl_stmt
name|int
name|msgrecv
argument_list|(
name|PFI
name|xferfile
argument_list|,
operator|...
argument_list|)
else|#
directive|else
comment|/*VARARGS*/
comment|/*ARGSUSED*/
name|int
name|msgrecv
argument_list|(
name|va_alist
argument_list|)
name|va_dcl
endif|#
directive|endif
block|{
if|#
directive|if
operator|!
name|__STDC__
typedef|typedef
name|int
function_decl|(
modifier|*
name|PFI
function_decl|)
parameter_list|()
function_decl|;
name|PFI
name|xferfile
decl_stmt|;
endif|#
directive|endif
name|va_list
name|args
decl_stmt|;
specifier|register
name|int
name|x
decl_stmt|;
specifier|register
name|TREE
modifier|*
name|t
init|=
name|upgradeT
decl_stmt|;
if|#
directive|if
name|__STDC__
name|va_start
argument_list|(
name|args
argument_list|,
name|xferfile
argument_list|)
expr_stmt|;
else|#
directive|else
name|va_start
argument_list|(
name|args
argument_list|)
expr_stmt|;
name|xferfile
operator|=
name|va_arg
argument_list|(
name|args
argument_list|,
name|PFI
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|server
condition|)
block|{
name|x
operator|=
name|writemsg
argument_list|(
name|MSGRECV
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|writestring
argument_list|(
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|writemend
argument_list|()
expr_stmt|;
return|return
operator|(
name|x
operator|)
return|;
block|}
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|writestring
argument_list|(
name|t
operator|->
name|Tname
argument_list|)
expr_stmt|;
if|if
condition|(
name|protver
operator|>
literal|8
condition|)
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|writestring
argument_list|(
name|t
operator|->
name|Tnewname
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|writeint
argument_list|(
name|t
operator|->
name|Tmode
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|->
name|Tmode
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|writemend
argument_list|()
expr_stmt|;
return|return
operator|(
name|x
operator|)
return|;
block|}
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|writeint
argument_list|(
name|t
operator|->
name|Tflags
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|writestring
argument_list|(
name|t
operator|->
name|Tuser
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|writestring
argument_list|(
name|t
operator|->
name|Tgroup
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|writeint
argument_list|(
name|t
operator|->
name|Tmtime
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|Tprocess
argument_list|(
name|t
operator|->
name|Tlink
argument_list|,
name|writeone
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|writestring
argument_list|(
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|Tprocess
argument_list|(
name|t
operator|->
name|Texec
argument_list|,
name|writeone
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|writestring
argument_list|(
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
call|(
modifier|*
name|xferfile
call|)
argument_list|(
name|t
argument_list|,
name|args
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|writemend
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|char
modifier|*
name|linkname
decl_stmt|,
modifier|*
name|execcmd
decl_stmt|;
if|if
condition|(
name|t
operator|==
name|NULL
condition|)
return|return
operator|(
name|SCMERR
operator|)
return|;
name|x
operator|=
name|readmsg
argument_list|(
name|MSGRECV
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|readstring
argument_list|(
operator|&
name|t
operator|->
name|Tname
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
operator|&&
name|t
operator|->
name|Tname
operator|==
name|NULL
condition|)
block|{
name|x
operator|=
name|readmend
argument_list|()
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
call|(
modifier|*
name|xferfile
call|)
argument_list|(
name|NULL
argument_list|,
name|args
argument_list|)
expr_stmt|;
return|return
operator|(
name|x
operator|)
return|;
block|}
if|if
condition|(
name|protver
operator|>
literal|8
condition|)
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|readstring
argument_list|(
operator|&
name|t
operator|->
name|Tnewname
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|readint
argument_list|(
operator|&
name|t
operator|->
name|Tmode
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|->
name|Tmode
operator|==
literal|0
condition|)
block|{
name|x
operator|=
name|readmend
argument_list|()
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
call|(
modifier|*
name|xferfile
call|)
argument_list|(
name|t
argument_list|,
name|args
argument_list|)
expr_stmt|;
return|return
operator|(
name|x
operator|)
return|;
block|}
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|readint
argument_list|(
operator|&
name|t
operator|->
name|Tflags
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|readstring
argument_list|(
operator|&
name|t
operator|->
name|Tuser
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|readstring
argument_list|(
operator|&
name|t
operator|->
name|Tgroup
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|readint
argument_list|(
operator|&
name|t
operator|->
name|Tmtime
argument_list|)
expr_stmt|;
name|t
operator|->
name|Tlink
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|readstring
argument_list|(
operator|&
name|linkname
argument_list|)
expr_stmt|;
while|while
condition|(
name|x
operator|==
name|SCMOK
condition|)
block|{
if|if
condition|(
name|linkname
operator|==
name|NULL
condition|)
break|break;
operator|(
name|void
operator|)
name|Tinsert
argument_list|(
operator|&
name|t
operator|->
name|Tlink
argument_list|,
name|linkname
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|linkname
argument_list|)
expr_stmt|;
name|x
operator|=
name|readstring
argument_list|(
operator|&
name|linkname
argument_list|)
expr_stmt|;
block|}
name|t
operator|->
name|Texec
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|readstring
argument_list|(
operator|&
name|execcmd
argument_list|)
expr_stmt|;
while|while
condition|(
name|x
operator|==
name|SCMOK
condition|)
block|{
if|if
condition|(
name|execcmd
operator|==
name|NULL
condition|)
break|break;
operator|(
name|void
operator|)
name|Tinsert
argument_list|(
operator|&
name|t
operator|->
name|Texec
argument_list|,
name|execcmd
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|execcmd
argument_list|)
expr_stmt|;
name|x
operator|=
name|readstring
argument_list|(
operator|&
name|execcmd
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
call|(
modifier|*
name|xferfile
call|)
argument_list|(
name|t
argument_list|,
name|args
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|readmend
argument_list|()
expr_stmt|;
block|}
name|va_end
argument_list|(
name|args
argument_list|)
expr_stmt|;
return|return
operator|(
name|x
operator|)
return|;
block|}
end_decl_stmt

begin_comment
comment|/*  * protocol done message  */
end_comment

begin_decl_stmt
specifier|extern
name|int
name|doneack
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|donereason
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|msgdone
parameter_list|()
block|{
specifier|register
name|int
name|x
decl_stmt|;
if|if
condition|(
name|protver
operator|<
literal|6
condition|)
block|{
name|printf
argument_list|(
literal|"Error, msgdone should not have been called."
argument_list|)
expr_stmt|;
return|return
operator|(
name|SCMERR
operator|)
return|;
block|}
if|if
condition|(
name|server
condition|)
block|{
name|x
operator|=
name|readmsg
argument_list|(
name|MSGDONE
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|readint
argument_list|(
operator|&
name|doneack
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|readstring
argument_list|(
operator|&
name|donereason
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|readmend
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|x
operator|=
name|writemsg
argument_list|(
name|MSGDONE
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|writeint
argument_list|(
name|doneack
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|writestring
argument_list|(
name|donereason
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|SCMOK
condition|)
name|x
operator|=
name|writemend
argument_list|()
expr_stmt|;
block|}
return|return
operator|(
name|x
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * go away message  */
end_comment

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|goawayreason
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* reason for goaway */
end_comment

begin_function
name|int
name|msggoaway
parameter_list|()
block|{
return|return
operator|(
name|writemstr
argument_list|(
name|MSGGOAWAY
argument_list|,
name|goawayreason
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * cross-patch protocol message  */
end_comment

begin_decl_stmt
specifier|extern
name|int
name|xargc
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* arg count for crosspatch */
end_comment

begin_decl_stmt
specifier|extern
name|char
modifier|*
modifier|*
name|xargv
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* arg array for crosspatch */
end_comment

begin_function
name|int
name|msgxpatch
parameter_list|()
block|{
specifier|register
name|int
name|x
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
if|if
condition|(
name|server
condition|)
block|{
name|x
operator|=
name|readmsg
argument_list|(
name|MSGXPATCH
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|!=
name|SCMOK
condition|)
return|return
operator|(
name|x
operator|)
return|;
name|x
operator|=
name|readint
argument_list|(
operator|&
name|xargc
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|!=
name|SCMOK
condition|)
return|return
operator|(
name|x
operator|)
return|;
name|xargc
operator|+=
literal|2
expr_stmt|;
name|xargv
operator|=
operator|(
name|char
operator|*
operator|*
operator|)
name|calloc
argument_list|(
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|,
operator|(
name|unsigned
operator|)
name|xargc
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|xargv
operator|==
name|NULL
condition|)
return|return
operator|(
name|SCMERR
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|2
init|;
name|i
operator|<
name|xargc
condition|;
name|i
operator|++
control|)
block|{
name|x
operator|=
name|readstring
argument_list|(
operator|&
name|xargv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|!=
name|SCMOK
condition|)
return|return
operator|(
name|x
operator|)
return|;
block|}
name|x
operator|=
name|readmend
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|x
operator|=
name|writemsg
argument_list|(
name|MSGXPATCH
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|!=
name|SCMOK
condition|)
return|return
operator|(
name|x
operator|)
return|;
name|x
operator|=
name|writeint
argument_list|(
name|xargc
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|!=
name|SCMOK
condition|)
return|return
operator|(
name|x
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|xargc
condition|;
name|i
operator|++
control|)
block|{
name|x
operator|=
name|writestring
argument_list|(
name|xargv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|!=
name|SCMOK
condition|)
return|return
operator|(
name|x
operator|)
return|;
block|}
name|x
operator|=
name|writemend
argument_list|()
expr_stmt|;
block|}
return|return
operator|(
name|x
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Compression check protocol message  */
end_comment

begin_decl_stmt
specifier|extern
name|int
name|docompress
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Compress file before sending? */
end_comment

begin_function
name|int
name|msgcompress
parameter_list|()
block|{
if|if
condition|(
name|server
condition|)
return|return
operator|(
name|readmint
argument_list|(
name|MSGCOMPRESS
argument_list|,
operator|&
name|docompress
argument_list|)
operator|)
return|;
return|return
operator|(
name|writemint
argument_list|(
name|MSGCOMPRESS
argument_list|,
name|docompress
argument_list|)
operator|)
return|;
block|}
end_function

end_unit


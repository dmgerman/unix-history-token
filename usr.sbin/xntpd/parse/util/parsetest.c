begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * /src/NTP/REPOSITORY/v3/parse/util/parsetest.c,v 3.14 1994/05/12 12:49:27 kardel Exp  *  * parsetest.c,v 3.14 1994/05/12 12:49:27 kardel Exp  *  * Copyright (c) 1989,1990,1991,1992,1993,1994  * Frank Kardel Friedrich-Alexander Universitaet Erlangen-Nuernberg  *  * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  *  * $Log: parsetest.c,v $  * Revision 3.14  1994/05/12  12:49:27  kardel  * printf fmt/arg cleanup  *  * Revision 3.14  1994/05/11  09:25:43  kardel  * 3.3r + printf fmt/arg fixes  *  * Revision 3.13  1994/02/20  13:04:46  kardel  * parse add/delete second support  *  * Revision 3.12  1994/02/02  17:45:51  kardel  * rcs ids fixed  *  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|STREAM
end_ifndef

begin_function
name|ONLY
name|STREAM
name|OPERATION
name|SUPPORTED
endif|#
directive|endif
define|#
directive|define
name|PARSESTREAM
comment|/* there is no other choice - TEST HACK */
include|#
directive|include
file|<unistd.h>
include|#
directive|include
file|<fcntl.h>
include|#
directive|include
file|<stdio.h>
include|#
directive|include
file|<sys/types.h>
include|#
directive|include
file|<sys/errno.h>
include|#
directive|include
file|<sys/time.h>
include|#
directive|include
file|<sys/stream.h>
include|#
directive|include
file|<sys/stropts.h>
include|#
directive|include
file|<sys/errno.h>
include|#
directive|include
file|<fcntl.h>
define|#
directive|define
name|P
parameter_list|(
name|X
parameter_list|)
value|()
include|#
directive|include
file|"ntp_fp.h"
ifdef|#
directive|ifdef
name|USE_PROTOTYPES
include|#
directive|include
file|"ntp_stdlib.h"
endif|#
directive|endif
include|#
directive|include
file|"parse.h"
specifier|static
name|char
modifier|*
name|strstatus
parameter_list|(
name|buffer
parameter_list|,
name|state
parameter_list|)
name|char
modifier|*
name|buffer
decl_stmt|;
name|unsigned
name|LONG
name|state
decl_stmt|;
block|{
specifier|static
struct|struct
name|bits
block|{
name|unsigned
name|LONG
name|bit
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
block|}
name|flagstrings
index|[]
init|=
block|{
block|{
name|PARSEB_ANNOUNCE
block|,
literal|"DST SWITCH WARNING"
block|}
block|,
block|{
name|PARSEB_POWERUP
block|,
literal|"NOT SYNCHRONIZED"
block|}
block|,
block|{
name|PARSEB_NOSYNC
block|,
literal|"TIME CODE NOT CONFIRMED"
block|}
block|,
block|{
name|PARSEB_DST
block|,
literal|"DST"
block|}
block|,
block|{
name|PARSEB_UTC
block|,
literal|"UTC DISPLAY"
block|}
block|,
block|{
name|PARSEB_LEAPADD
block|,
literal|"LEAP ADDITION WARNING"
block|}
block|,
block|{
name|PARSEB_LEAPDEL
block|,
literal|"LEAP DELETION WARNING"
block|}
block|,
block|{
name|PARSEB_LEAPSECOND
block|,
literal|"LEAP SECOND"
block|}
block|,
block|{
name|PARSEB_ALTERNATE
block|,
literal|"ALTERNATE ANTENNA"
block|}
block|,
block|{
name|PARSEB_TIMECODE
block|,
literal|"TIME CODE"
block|}
block|,
block|{
name|PARSEB_PPS
block|,
literal|"PPS"
block|}
block|,
block|{
name|PARSEB_POSITION
block|,
literal|"POSITION"
block|}
block|,
block|{
literal|0
block|}
block|}
struct|;
specifier|static
struct|struct
name|sbits
block|{
name|unsigned
name|LONG
name|bit
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
block|}
name|sflagstrings
index|[]
init|=
block|{
block|{
name|PARSEB_S_LEAP
block|,
literal|"LEAP INDICATION"
block|}
block|,
block|{
name|PARSEB_S_PPS
block|,
literal|"PPS SIGNAL"
block|}
block|,
block|{
name|PARSEB_S_ANTENNA
block|,
literal|"ANTENNA"
block|}
block|,
block|{
name|PARSEB_S_POSITION
block|,
literal|"POSITION"
block|}
block|,
block|{
literal|0
block|}
block|}
struct|;
name|int
name|i
decl_stmt|;
operator|*
name|buffer
operator|=
literal|'\0'
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|flagstrings
index|[
name|i
index|]
operator|.
name|bit
condition|)
block|{
if|if
condition|(
name|flagstrings
index|[
name|i
index|]
operator|.
name|bit
operator|&
name|state
condition|)
block|{
if|if
condition|(
name|buffer
index|[
literal|0
index|]
condition|)
name|strcat
argument_list|(
name|buffer
argument_list|,
literal|"; "
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|buffer
argument_list|,
name|flagstrings
index|[
name|i
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
block|}
name|i
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|state
operator|&
operator|(
name|PARSEB_S_LEAP
operator||
name|PARSEB_S_ANTENNA
operator||
name|PARSEB_S_PPS
operator||
name|PARSEB_S_POSITION
operator|)
condition|)
block|{
specifier|register
name|char
modifier|*
name|s
decl_stmt|,
modifier|*
name|t
decl_stmt|;
if|if
condition|(
name|buffer
index|[
literal|0
index|]
condition|)
name|strcat
argument_list|(
name|buffer
argument_list|,
literal|"; "
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|buffer
argument_list|,
literal|"("
argument_list|)
expr_stmt|;
name|t
operator|=
name|s
operator|=
name|buffer
operator|+
name|strlen
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|sflagstrings
index|[
name|i
index|]
operator|.
name|bit
condition|)
block|{
if|if
condition|(
name|sflagstrings
index|[
name|i
index|]
operator|.
name|bit
operator|&
name|state
condition|)
block|{
if|if
condition|(
name|t
operator|!=
name|s
condition|)
block|{
name|strcpy
argument_list|(
name|t
argument_list|,
literal|"; "
argument_list|)
expr_stmt|;
name|t
operator|+=
literal|2
expr_stmt|;
block|}
name|strcpy
argument_list|(
name|t
argument_list|,
name|sflagstrings
index|[
name|i
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
name|t
operator|+=
name|strlen
argument_list|(
name|t
argument_list|)
expr_stmt|;
block|}
name|i
operator|++
expr_stmt|;
block|}
name|strcpy
argument_list|(
name|t
argument_list|,
literal|")"
argument_list|)
expr_stmt|;
block|}
return|return
name|buffer
return|;
block|}
end_function

begin_comment
comment|/*--------------------------------------------------  * convert a status flag field to a string  */
end_comment

begin_function
specifier|static
name|char
modifier|*
name|parsestatus
parameter_list|(
name|state
parameter_list|,
name|buffer
parameter_list|)
name|unsigned
name|LONG
name|state
decl_stmt|;
name|char
modifier|*
name|buffer
decl_stmt|;
block|{
specifier|static
struct|struct
name|bits
block|{
name|unsigned
name|LONG
name|bit
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
block|}
name|flagstrings
index|[]
init|=
block|{
block|{
name|CVT_OK
block|,
literal|"CONVERSION SUCCESSFUL"
block|}
block|,
block|{
name|CVT_NONE
block|,
literal|"NO CONVERSION"
block|}
block|,
block|{
name|CVT_FAIL
block|,
literal|"CONVERSION FAILED"
block|}
block|,
block|{
name|CVT_BADFMT
block|,
literal|"ILLEGAL FORMAT"
block|}
block|,
block|{
name|CVT_BADDATE
block|,
literal|"DATE ILLEGAL"
block|}
block|,
block|{
name|CVT_BADTIME
block|,
literal|"TIME ILLEGAL"
block|}
block|,
block|{
literal|0
block|}
block|}
struct|;
name|int
name|i
decl_stmt|;
operator|*
name|buffer
operator|=
literal|'\0'
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|flagstrings
index|[
name|i
index|]
operator|.
name|bit
condition|)
block|{
if|if
condition|(
name|flagstrings
index|[
name|i
index|]
operator|.
name|bit
operator|&
name|state
condition|)
block|{
if|if
condition|(
name|buffer
index|[
literal|0
index|]
condition|)
name|strcat
argument_list|(
name|buffer
argument_list|,
literal|"; "
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|buffer
argument_list|,
name|flagstrings
index|[
name|i
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
block|}
name|i
operator|++
expr_stmt|;
block|}
return|return
name|buffer
return|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
if|if
condition|(
name|argc
operator|!=
literal|2
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"usage: %s<parse-device>\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|int
name|fd
decl_stmt|;
name|fd
operator|=
name|open
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
name|O_RDWR
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|parsectl_t
name|dct
decl_stmt|;
name|parsetime_t
name|parsetime
decl_stmt|;
name|struct
name|strioctl
name|strioc
decl_stmt|;
name|printf
argument_list|(
literal|"parsetest.c,v 3.11 1994/01/23 19:00:01 kardel Exp\n"
argument_list|)
expr_stmt|;
while|while
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|I_POP
argument_list|,
literal|0
argument_list|)
operator|==
literal|0
condition|)
empty_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|I_PUSH
argument_list|,
literal|"parse"
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl(I_PUSH,\"parse\")"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|strioc
operator|.
name|ic_cmd
operator|=
name|PARSEIOC_GETSTAT
expr_stmt|;
name|strioc
operator|.
name|ic_timout
operator|=
literal|0
expr_stmt|;
name|strioc
operator|.
name|ic_dp
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
name|dct
expr_stmt|;
name|strioc
operator|.
name|ic_len
operator|=
sizeof|sizeof
argument_list|(
name|parsectl_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|I_STR
argument_list|,
operator|&
name|strioc
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl(fd, I_STR(PARSEIOC_GETSTAT))"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"parse status: %04lx\n"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|dct
operator|.
name|parsestatus
operator|.
name|flags
argument_list|)
expr_stmt|;
name|dct
operator|.
name|parsestatus
operator|.
name|flags
operator||=
name|PARSE_STAT_FILTER
expr_stmt|;
name|strioc
operator|.
name|ic_cmd
operator|=
name|PARSEIOC_SETSTAT
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|I_STR
argument_list|,
operator|&
name|strioc
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl(fd, I_STR(PARSEIOC_SETSTAT))"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"PARSE clock FILTERMODE\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|I_STR
argument_list|,
operator|&
name|strioc
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl(fd, I_STR(PARSEIOC_GETSTAT))"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"parse status: %04lx\n"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|dct
operator|.
name|parsestatus
operator|.
name|flags
argument_list|)
expr_stmt|;
while|while
condition|(
name|read
argument_list|(
name|fd
argument_list|,
operator|&
name|parsetime
argument_list|,
sizeof|sizeof
argument_list|(
name|parsetime
argument_list|)
argument_list|)
operator|==
sizeof|sizeof
argument_list|(
name|parsetime
argument_list|)
condition|)
block|{
name|char
name|tmp
index|[
literal|200
index|]
decl_stmt|,
name|tmp1
index|[
literal|200
index|]
decl_stmt|,
name|tmp2
index|[
literal|60
index|]
decl_stmt|;
name|strncpy
argument_list|(
name|tmp
argument_list|,
name|asctime
argument_list|(
name|localtime
argument_list|(
operator|&
name|parsetime
operator|.
name|parse_time
operator|.
name|tv
operator|.
name|tv_sec
argument_list|)
argument_list|)
argument_list|,
literal|30
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|tmp1
argument_list|,
name|asctime
argument_list|(
name|localtime
argument_list|(
operator|&
name|parsetime
operator|.
name|parse_stime
operator|.
name|tv
operator|.
name|tv_sec
argument_list|)
argument_list|)
argument_list|,
literal|30
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|tmp2
argument_list|,
name|asctime
argument_list|(
name|localtime
argument_list|(
operator|&
name|parsetime
operator|.
name|parse_ptime
operator|.
name|tv
operator|.
name|tv_sec
argument_list|)
argument_list|)
argument_list|,
literal|30
argument_list|)
expr_stmt|;
name|tmp
index|[
literal|24
index|]
operator|=
literal|'\0'
expr_stmt|;
name|tmp1
index|[
literal|24
index|]
operator|=
literal|'\0'
expr_stmt|;
name|tmp2
index|[
literal|24
index|]
operator|=
literal|'\0'
expr_stmt|;
name|printf
argument_list|(
literal|"%s (+%06ldus) %s PPS: %s (+%06ldus), "
argument_list|,
name|tmp1
argument_list|,
operator|(
name|long
name|int
operator|)
name|parsetime
operator|.
name|parse_stime
operator|.
name|tv
operator|.
name|tv_usec
argument_list|,
name|tmp
argument_list|,
name|tmp2
argument_list|,
operator|(
name|long
name|int
operator|)
name|parsetime
operator|.
name|parse_ptime
operator|.
name|tv
operator|.
name|tv_usec
argument_list|)
expr_stmt|;
name|strstatus
argument_list|(
name|tmp
argument_list|,
name|parsetime
operator|.
name|parse_state
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"state: 0x%lx (%s) error: %ldus, dispersion: %ldus, Status: 0x%lx (%s)\n"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|parsetime
operator|.
name|parse_state
argument_list|,
name|tmp
argument_list|,
operator|(
name|long
operator|)
name|parsetime
operator|.
name|parse_usecerror
argument_list|,
operator|(
name|long
operator|)
name|parsetime
operator|.
name|parse_usecdisp
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|parsetime
operator|.
name|parse_status
argument_list|,
name|parsestatus
argument_list|(
name|parsetime
operator|.
name|parse_status
argument_list|,
name|tmp1
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

end_unit


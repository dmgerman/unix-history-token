begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_if
if|#
directive|if
name|defined
argument_list|(
name|REFCLOCK
argument_list|)
operator|&&
operator|(
name|defined
argument_list|(
name|PARSE
argument_list|)
operator|||
name|defined
argument_list|(
name|PARSEPPS
argument_list|)
operator|)
operator|&&
name|defined
argument_list|(
name|CLOCK_TRIMTAIP
argument_list|)
end_if

begin_comment
comment|/*  * $FreeBSD$  *  * Trimble SV6 clock support  */
end_comment

begin_include
include|#
directive|include
file|"sys/types.h"
end_include

begin_include
include|#
directive|include
file|"sys/time.h"
end_include

begin_include
include|#
directive|include
file|"sys/errno.h"
end_include

begin_include
include|#
directive|include
file|"ntp_fp.h"
end_include

begin_include
include|#
directive|include
file|"ntp_unixtime.h"
end_include

begin_include
include|#
directive|include
file|"ntp_calendar.h"
end_include

begin_include
include|#
directive|include
file|"parse.h"
end_include

begin_comment
comment|/*	0000000000111111111122222222223333333	/ char  *	0123456789012345678901234567890123456	\ posn  *>RTMhhmmssdddDDMMYYYYoodnnvrrrrr;*xx<	Actual  *	----33445566600112222BB7__-_____--99-	Parse  *>RTM                      1     ;*<",	Check  */
end_comment

begin_define
define|#
directive|define
name|hexval
parameter_list|(
name|x
parameter_list|)
value|(('0'<= (x)&& (x)<= '9') ? (x) - '0' : \ 	('a'<= (x)&& (x)<= 'f') ? (x) - 'a' + 10 : \ 	('A'<= (x)&& (x)<= 'F') ? (x) - 'A' + 10 : \ 	-1)
end_define

begin_define
define|#
directive|define
name|O_USEC
value|O_WDAY
end_define

begin_define
define|#
directive|define
name|O_GPSFIX
value|O_FLAGS
end_define

begin_define
define|#
directive|define
name|O_CHKSUM
value|O_UTCHOFFSET
end_define

begin_decl_stmt
specifier|static
name|struct
name|format
name|trimsv6_fmt
init|=
block|{
block|{
block|{
literal|13
block|,
literal|2
block|}
block|,
block|{
literal|15
block|,
literal|2
block|}
block|,
block|{
literal|17
block|,
literal|4
block|}
block|,
comment|/* Day, Month, Year */
block|{
literal|4
block|,
literal|2
block|}
block|,
block|{
literal|6
block|,
literal|2
block|}
block|,
block|{
literal|8
block|,
literal|2
block|}
block|,
comment|/* Hour, Minute, Second */
block|{
literal|10
block|,
literal|3
block|}
block|,
block|{
literal|23
block|,
literal|1
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|,
comment|/* uSec, FIXes (WeekDAY, FLAGS, ZONE) */
block|{
literal|34
block|,
literal|2
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|21
block|,
literal|2
block|}
block|,
comment|/* cksum, -, utcS (UTC[HMS]OFFSET) */
block|}
block|,
literal|">RTM                      1     ;*<"
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|unsigned
name|LONG
name|cvt_trimtaip
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|clockformat_t
name|clock_trimtaip
init|=
block|{
operator|(
name|unsigned
name|LONG
argument_list|(
operator|*
argument_list|)
argument_list|()
operator|)
literal|0
block|,
comment|/* no input handling */
name|cvt_trimtaip
block|,
comment|/* Trimble conversion */
name|syn_simple
block|,
comment|/* easy time stamps for RS232 (fallback) */
name|pps_simple
block|,
comment|/* easy PPS monitoring */
operator|(
name|unsigned
name|LONG
argument_list|(
operator|*
argument_list|)
argument_list|()
operator|)
literal|0
block|,
comment|/* no time code synthesizer monitoring */
operator|(
name|void
operator|*
operator|)
operator|&
name|trimsv6_fmt
block|,
comment|/* conversion configuration */
literal|"Trimble SV6/TAIP"
block|,
literal|37
block|,
comment|/* string buffer */
name|F_START
operator||
name|F_END
operator||
name|SYNC_START
operator||
name|SYNC_ONE
block|,
comment|/* paket START/END delimiter, START synchronisation, PPS ONE sampling */
literal|0
block|,
comment|/* no private data */
block|{
literal|0
block|,
literal|0
block|}
block|,
literal|'>'
block|,
literal|'<'
block|,
literal|'\0'
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|unsigned
name|LONG
name|cvt_trimtaip
parameter_list|(
name|buffer
parameter_list|,
name|size
parameter_list|,
name|format
parameter_list|,
name|clock
parameter_list|)
specifier|register
name|char
modifier|*
name|buffer
decl_stmt|;
specifier|register
name|int
name|size
decl_stmt|;
specifier|register
name|struct
name|format
modifier|*
name|format
decl_stmt|;
specifier|register
name|clocktime_t
modifier|*
name|clock
decl_stmt|;
block|{
name|LONG
name|gpsfix
decl_stmt|;
name|u_char
name|calc_csum
init|=
literal|0
decl_stmt|;
name|long
name|recv_csum
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|Strok
argument_list|(
name|buffer
argument_list|,
name|format
operator|->
name|fixed_string
argument_list|)
condition|)
return|return
name|CVT_NONE
return|;
define|#
directive|define
name|OFFS
parameter_list|(
name|x
parameter_list|)
value|format->field_offsets[(x)].offset
define|#
directive|define
name|STOI
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|)
define|\
value|Stoi(&buffer[OFFS(x)], y, \ 	       format->field_offsets[(x)].length)
if|if
condition|(
name|STOI
argument_list|(
name|O_DAY
argument_list|,
operator|&
name|clock
operator|->
name|day
argument_list|)
operator|||
name|STOI
argument_list|(
name|O_MONTH
argument_list|,
operator|&
name|clock
operator|->
name|month
argument_list|)
operator|||
name|STOI
argument_list|(
name|O_YEAR
argument_list|,
operator|&
name|clock
operator|->
name|year
argument_list|)
operator|||
name|STOI
argument_list|(
name|O_HOUR
argument_list|,
operator|&
name|clock
operator|->
name|hour
argument_list|)
operator|||
name|STOI
argument_list|(
name|O_MIN
argument_list|,
operator|&
name|clock
operator|->
name|minute
argument_list|)
operator|||
name|STOI
argument_list|(
name|O_SEC
argument_list|,
operator|&
name|clock
operator|->
name|second
argument_list|)
operator|||
name|STOI
argument_list|(
name|O_USEC
argument_list|,
operator|&
name|clock
operator|->
name|usecond
argument_list|)
operator|||
name|STOI
argument_list|(
name|O_GPSFIX
argument_list|,
operator|&
name|gpsfix
argument_list|)
condition|)
return|return
name|CVT_FAIL
operator||
name|CVT_BADFMT
return|;
name|clock
operator|->
name|usecond
operator|*=
literal|1000
expr_stmt|;
comment|/* Check that the checksum is right */
for|for
control|(
name|i
operator|=
name|OFFS
argument_list|(
name|O_CHKSUM
argument_list|)
operator|-
literal|1
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
name|calc_csum
operator|^=
name|buffer
index|[
name|i
index|]
expr_stmt|;
name|recv_csum
operator|=
operator|(
name|hexval
argument_list|(
name|buffer
index|[
name|OFFS
argument_list|(
name|O_CHKSUM
argument_list|)
index|]
argument_list|)
operator|<<
literal|4
operator|)
operator||
name|hexval
argument_list|(
name|buffer
index|[
name|OFFS
argument_list|(
name|O_CHKSUM
argument_list|)
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|recv_csum
operator|<
literal|0
condition|)
return|return
name|CVT_FAIL
operator||
name|CVT_BADTIME
return|;
if|if
condition|(
operator|(
operator|(
name|u_char
operator|)
name|recv_csum
operator|)
operator|!=
name|calc_csum
condition|)
return|return
name|CVT_FAIL
operator||
name|CVT_BADTIME
return|;
name|clock
operator|->
name|utcoffset
operator|=
literal|0
expr_stmt|;
comment|/* What should flags be set to ? */
name|clock
operator|->
name|flags
operator|=
name|PARSEB_UTC
expr_stmt|;
comment|/* if the current GPS fix is 9 (unknown), reject */
if|if
condition|(
literal|0
operator|>
name|gpsfix
operator|||
name|gpsfix
operator|>
literal|9
condition|)
name|clock
operator|->
name|flags
operator||=
name|PARSEB_POWERUP
expr_stmt|;
return|return
name|CVT_OK
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* defined(PARSE)&& defined(CLOCK_TRIMTAIP) */
end_comment

begin_comment
comment|/*  * History:  *  * $Log: clk_trimtaip.c,v $  * Revision 1.1.1.1  1994/09/29 23:01:31  wollman  * xntp 3.4e from Dave Mills @ UDel  *  * Revision 3.9  1994/02/02  17:45:27  kardel  * rcs ids fixed  *  * Revision 3.7  1994/01/25  19:05:17  kardel  * 94/01/23 reconcilation  *  * Revision 3.6  1993/10/30  09:44:45  kardel  * conditional compilation flag cleanup  *  * Revision 3.5  1993/10/09  15:01:35  kardel  * file structure unified  *  * revision 3.4  * date: 1993/10/08 14:44:51;  author: kardel;  * trimble - initial working version  *  * revision 3.3  * date: 1993/10/03 19:10:50;  author: kardel;  * restructured I/O handling  *  * revision 3.2  * date: 1993/09/27 21:07:17;  author: kardel;  * Trimble alpha integration  *  * revision 3.1  * date: 1993/09/26 23:40:29;  author: kardel;  * new parse driver logic  *  */
end_comment

end_unit


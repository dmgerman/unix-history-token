begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * refclock_datum - clock driver for the Datum watchayamacallit  */
end_comment

begin_if
if|#
directive|if
name|defined
argument_list|(
name|REFCLOCK
argument_list|)
operator|&&
operator|(
name|defined
argument_list|(
name|DATUM
argument_list|)
operator|||
name|defined
argument_list|(
name|DATUMCLK
argument_list|)
operator|||
name|defined
argument_list|(
name|DATUMPPS
argument_list|)
operator|)
end_if

begin_comment
comment|/*									*/
end_comment

begin_comment
comment|/*...... Include Files .................................................*/
end_comment

begin_comment
comment|/*									*/
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/errno.h>
end_include

begin_include
include|#
directive|include
file|"ntpd.h"
end_include

begin_include
include|#
directive|include
file|"ntp_io.h"
end_include

begin_include
include|#
directive|include
file|"ntp_refclock.h"
end_include

begin_include
include|#
directive|include
file|"ntp_unixtime.h"
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|HAVE_BSD_TTYS
argument_list|)
end_if

begin_include
include|#
directive|include
file|<sgtty.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_BSD_TTYS */
end_comment

begin_if
if|#
directive|if
name|defined
argument_list|(
name|HAVE_SYSV_TTYS
argument_list|)
end_if

begin_include
include|#
directive|include
file|<termio.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_SYSV_TTYS */
end_comment

begin_if
if|#
directive|if
name|defined
argument_list|(
name|HAVE_TERMIOS
argument_list|)
end_if

begin_include
include|#
directive|include
file|<termios.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|defined
argument_list|(
name|STREAM
argument_list|)
end_if

begin_include
include|#
directive|include
file|<stropts.h>
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|WWVBCLK
argument_list|)
end_if

begin_include
include|#
directive|include
file|<sys/clkdefs.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* WWVBCLK */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* STREAM */
end_comment

begin_if
if|#
directive|if
name|defined
argument_list|(
name|WWVBPPS
argument_list|)
end_if

begin_include
include|#
directive|include
file|<sys/ppsclock.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* WWVBPPS */
end_comment

begin_include
include|#
directive|include
file|"ntp_stdlib.h"
end_include

begin_comment
comment|/* #include "temp.c" void set_logfile(); */
end_comment

begin_define
define|#
directive|define
name|DEBUG_DATUM_PTC
end_define

begin_comment
comment|/*									*/
end_comment

begin_comment
comment|/*...... #defines ......................................................*/
end_comment

begin_comment
comment|/*									*/
end_comment

begin_comment
comment|/* #define refclock_datum_pts refclock_wwvb */
end_comment

begin_define
define|#
directive|define
name|MAXUNITS
value|4
end_define

begin_define
define|#
directive|define
name|PTSPRECISION
value|(-13)
end_define

begin_comment
comment|/* precision assumed (about 100 us) */
end_comment

begin_define
define|#
directive|define
name|GMT
value|7
end_define

begin_define
define|#
directive|define
name|DATUM_MAX_ERROR
value|0.100
end_define

begin_define
define|#
directive|define
name|DATUM_MAX_ERROR2
value|DATUM_MAX_ERROR*DATUM_MAX_ERROR
end_define

begin_comment
comment|/*									*/
end_comment

begin_comment
comment|/*...... externals .....................................................*/
end_comment

begin_comment
comment|/*									*/
end_comment

begin_decl_stmt
specifier|extern
name|U_LONG
name|current_time
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* current time (s) */
end_comment

begin_decl_stmt
specifier|extern
name|int
name|debug
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* global debug flag */
end_comment

begin_comment
comment|/*									*/
end_comment

begin_comment
comment|/*...... My structure ..................................................*/
end_comment

begin_comment
comment|/*									*/
end_comment

begin_struct
struct|struct
name|datum_pts_unit
block|{
name|struct
name|peer
modifier|*
name|peer
decl_stmt|;
comment|/* peer used by xntp */
name|struct
name|refclockio
name|io
decl_stmt|;
comment|/* io structure used by xntp */
name|int
name|PTS_fd
decl_stmt|;
comment|/* file descriptor for PTS */
name|int
name|PTS_START
decl_stmt|;
comment|/* ? */
name|u_int
name|unit
decl_stmt|;
comment|/* id for unit */
name|U_LONG
name|timestarted
decl_stmt|;
comment|/* time started */
name|int
name|inuse
decl_stmt|;
comment|/* in use flag */
name|l_fp
name|lastrec
decl_stmt|;
name|l_fp
name|lastref
decl_stmt|;
name|int
name|yearstart
decl_stmt|;
name|int
name|coderecv
decl_stmt|;
name|int
name|day
decl_stmt|;
comment|/* day */
name|int
name|hour
decl_stmt|;
comment|/* hour */
name|int
name|minute
decl_stmt|;
comment|/* minutes */
name|int
name|second
decl_stmt|;
comment|/* seconds */
name|int
name|msec
decl_stmt|;
comment|/* miliseconds */
name|int
name|usec
decl_stmt|;
comment|/* miliseconds */
name|u_char
name|leap
decl_stmt|;
name|char
name|retbuf
index|[
literal|8
index|]
decl_stmt|;
comment|/* returned time from the datum pts */
name|char
name|nbytes
decl_stmt|;
comment|/* number of bytes received from datum pts */
name|double
name|sigma2
decl_stmt|;
comment|/* average squared error (roughly) */
block|}
struct|;
end_struct

begin_comment
comment|/*									*/
end_comment

begin_comment
comment|/*...... pts static constant variables for internal use ................*/
end_comment

begin_comment
comment|/*									*/
end_comment

begin_decl_stmt
specifier|static
name|char
name|STOP_GENERATOR
index|[
literal|6
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|START_GENERATOR
index|[
literal|6
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|TIME_REQUEST
index|[
literal|6
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|nunits
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|datum_pts_unit
modifier|*
modifier|*
name|datum_pts_unit
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|u_char
name|stratumtouse
index|[
name|MAXUNITS
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|l_fp
name|fudgefactor
index|[
name|MAXUNITS
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|FILE
modifier|*
name|logfile
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*									*/
end_comment

begin_comment
comment|/*...... callback functions that xntp knows about ......................*/
end_comment

begin_comment
comment|/*									*/
end_comment

begin_decl_stmt
specifier|static
name|int
name|datum_pts_start
name|P
argument_list|(
operator|(
name|u_int
operator|,
expr|struct
name|peer
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|datum_pts_shutdown
name|P
argument_list|(
operator|(
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|datum_pts_poll
name|P
argument_list|(
operator|(
name|int
operator|,
expr|struct
name|peer
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|datum_pts_control
name|P
argument_list|(
operator|(
name|u_int
operator|,
expr|struct
name|refclockstat
operator|*
operator|,
expr|struct
name|refclockstat
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|datum_pts_init
name|P
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|datum_pts_buginfo
name|P
argument_list|(
operator|(
name|int
operator|,
expr|struct
name|refclockbug
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|refclock
name|refclock_datum
init|=
block|{
name|datum_pts_start
block|,
name|datum_pts_shutdown
block|,
name|datum_pts_poll
block|,
name|datum_pts_control
block|,
name|datum_pts_init
block|,
name|datum_pts_buginfo
block|,
name|NOFLAGS
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* struct	refclock refclock_wvvb = {   datum_pts_start,   datum_pts_shutdown,   datum_pts_poll,   datum_pts_control,   datum_pts_init,   datum_pts_buginfo,   NOFLAGS }; */
end_comment

begin_comment
comment|/*									*/
end_comment

begin_comment
comment|/*...... receive callback functions for xntp  ..........................*/
end_comment

begin_comment
comment|/*									*/
end_comment

begin_decl_stmt
specifier|static
name|void
name|datum_pts_receive
name|P
argument_list|(
operator|(
expr|struct
name|recvbuf
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*......................................................................*/
end_comment

begin_comment
comment|/*	datum_pts_start							*/
end_comment

begin_comment
comment|/*......................................................................*/
end_comment

begin_function
specifier|static
name|int
name|datum_pts_start
parameter_list|(
name|unit
parameter_list|,
name|peer
parameter_list|)
name|u_int
name|unit
decl_stmt|;
name|struct
name|peer
modifier|*
name|peer
decl_stmt|;
block|{
name|struct
name|datum_pts_unit
modifier|*
modifier|*
name|temp_datum_pts_unit
decl_stmt|;
name|struct
name|datum_pts_unit
modifier|*
name|datum_pts
decl_stmt|;
name|struct
name|termios
name|arg
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUG_DATUM_PTC
name|fprintf
argument_list|(
name|logfile
argument_list|,
literal|"Starting Datum PTS unit %d\n"
argument_list|,
name|unit
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|logfile
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/*									*/
comment|/*...... create the memory for the new unit ............................*/
comment|/*									*/
name|temp_datum_pts_unit
operator|=
operator|(
expr|struct
name|datum_pts_unit
operator|*
operator|*
operator|)
name|malloc
argument_list|(
operator|(
name|nunits
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|datum_pts_unit
operator|*
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|nunits
operator|>
literal|0
condition|)
name|memcpy
argument_list|(
name|temp_datum_pts_unit
argument_list|,
name|datum_pts_unit
argument_list|,
name|nunits
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|datum_pts_unit
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|datum_pts_unit
argument_list|)
expr_stmt|;
name|datum_pts_unit
operator|=
name|temp_datum_pts_unit
expr_stmt|;
name|datum_pts_unit
index|[
name|nunits
index|]
operator|=
operator|(
expr|struct
name|datum_pts_unit
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|datum_pts_unit
argument_list|)
argument_list|)
expr_stmt|;
name|datum_pts
operator|=
name|datum_pts_unit
index|[
name|nunits
index|]
expr_stmt|;
name|datum_pts
operator|->
name|unit
operator|=
name|unit
expr_stmt|;
name|datum_pts
operator|->
name|yearstart
operator|=
literal|0
expr_stmt|;
name|datum_pts
operator|->
name|sigma2
operator|=
literal|0.0
expr_stmt|;
comment|/*									*/
comment|/*...... open the datum pts device .....................................*/
comment|/*									*/
name|datum_pts
operator|->
name|PTS_fd
operator|=
name|open
argument_list|(
literal|"/dev/ttya"
argument_list|,
name|O_RDWR
argument_list|)
expr_stmt|;
name|fcntl
argument_list|(
name|datum_pts
operator|->
name|PTS_fd
argument_list|,
name|F_SETFL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG_DATUM_PTC
name|fprintf
argument_list|(
name|logfile
argument_list|,
literal|"Opening RS232 port ttya with file descriptor %d\n"
argument_list|,
name|datum_pts
operator|->
name|PTS_fd
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|logfile
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/*									*/
comment|/*...... set up the RS232 terminal device information ..................*/
comment|/*									*/
name|arg
operator|.
name|c_iflag
operator|=
name|IGNBRK
expr_stmt|;
name|arg
operator|.
name|c_oflag
operator|=
literal|0
expr_stmt|;
name|arg
operator|.
name|c_cflag
operator|=
name|B9600
operator||
name|CS8
operator||
name|CREAD
operator||
name|PARENB
operator||
name|CLOCAL
expr_stmt|;
name|arg
operator|.
name|c_lflag
operator|=
literal|0
expr_stmt|;
name|arg
operator|.
name|c_line
operator|=
literal|0
expr_stmt|;
name|arg
operator|.
name|c_cc
index|[
name|VMIN
index|]
operator|=
literal|0
expr_stmt|;
comment|/* start timeout timer right away */
name|arg
operator|.
name|c_cc
index|[
name|VTIME
index|]
operator|=
literal|30
expr_stmt|;
comment|/* this is a 3 second timout on reads */
name|tcsetattr
argument_list|(
name|datum_pts
operator|->
name|PTS_fd
argument_list|,
name|TCSANOW
argument_list|,
operator|&
name|arg
argument_list|)
expr_stmt|;
comment|/*									*/
comment|/*...... initialize the io structure ...................................*/
comment|/*									*/
name|datum_pts
operator|->
name|peer
operator|=
name|peer
expr_stmt|;
name|datum_pts
operator|->
name|timestarted
operator|=
name|current_time
expr_stmt|;
name|datum_pts
operator|->
name|io
operator|.
name|clock_recv
operator|=
name|datum_pts_receive
expr_stmt|;
name|datum_pts
operator|->
name|io
operator|.
name|srcclock
operator|=
operator|(
name|caddr_t
operator|)
name|datum_pts
expr_stmt|;
name|datum_pts
operator|->
name|io
operator|.
name|datalen
operator|=
literal|0
expr_stmt|;
name|datum_pts
operator|->
name|io
operator|.
name|fd
operator|=
name|datum_pts
operator|->
name|PTS_fd
expr_stmt|;
if|if
condition|(
operator|!
name|io_addclock
argument_list|(
operator|&
operator|(
name|datum_pts
operator|->
name|io
operator|)
argument_list|)
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG_DATUM_PTC
name|fprintf
argument_list|(
name|logfile
argument_list|,
literal|"Problem adding clock\n"
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|logfile
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"Datum_PTS: Problem adding clock"
argument_list|)
expr_stmt|;
block|}
name|peer
operator|->
name|precision
operator|=
name|PTSPRECISION
expr_stmt|;
name|peer
operator|->
name|rootdelay
operator|=
literal|0
expr_stmt|;
name|peer
operator|->
name|rootdispersion
operator|=
literal|0
expr_stmt|;
name|peer
operator|->
name|stratum
operator|=
name|stratumtouse
index|[
name|unit
index|]
expr_stmt|;
comment|/*									*/
comment|/*...... now add one to the number of units ............................*/
comment|/*									*/
name|nunits
operator|++
expr_stmt|;
comment|/*									*/
comment|/*...... return successful code ........................................*/
comment|/*									*/
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/*......................................................................*/
end_comment

begin_comment
comment|/*	datum_pts_shutdown						*/
end_comment

begin_comment
comment|/*......................................................................*/
end_comment

begin_function
specifier|static
name|void
name|datum_pts_shutdown
parameter_list|(
name|unit
parameter_list|)
name|int
name|unit
decl_stmt|;
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|struct
name|datum_pts_unit
modifier|*
modifier|*
name|temp_datum_pts_unit
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUG_DATUM_PTC
name|fprintf
argument_list|(
name|logfile
argument_list|,
literal|"Shutdown Datum PTS\n"
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|logfile
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"Datum_PTS: Shutdown Datum PTS"
argument_list|)
expr_stmt|;
comment|/*									*/
comment|/*...... loop until the right unit is found ............................*/
comment|/*									*/
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nunits
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|datum_pts_unit
index|[
name|i
index|]
operator|->
name|unit
operator|==
name|unit
condition|)
block|{
comment|/*									*/
comment|/*...... found it so close the file descriptor and free up memory .....*/
comment|/*									*/
name|io_closeclock
argument_list|(
operator|&
name|datum_pts_unit
index|[
name|i
index|]
operator|->
name|io
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|datum_pts_unit
index|[
name|i
index|]
operator|->
name|PTS_fd
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|datum_pts_unit
index|[
name|i
index|]
argument_list|)
expr_stmt|;
comment|/*									*/
comment|/*...... clean up the datum_pts_unit array (no holes) ..................*/
comment|/*									*/
if|if
condition|(
name|nunits
operator|>
literal|1
condition|)
block|{
name|temp_datum_pts_unit
operator|=
operator|(
expr|struct
name|datum_pts_unit
operator|*
operator|*
operator|)
name|malloc
argument_list|(
operator|(
name|nunits
operator|-
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|datum_pts_unit
operator|*
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|!=
literal|0
condition|)
name|memcpy
argument_list|(
name|temp_datum_pts_unit
argument_list|,
name|datum_pts_unit
argument_list|,
name|i
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|datum_pts_unit
operator|*
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
name|i
operator|+
literal|1
init|;
name|j
operator|<
name|nunits
condition|;
name|j
operator|++
control|)
block|{
name|temp_datum_pts_unit
index|[
name|j
operator|-
literal|1
index|]
operator|=
name|datum_pts_unit
index|[
name|j
index|]
expr_stmt|;
block|}
name|free
argument_list|(
name|datum_pts_unit
argument_list|)
expr_stmt|;
name|datum_pts_unit
operator|=
name|temp_datum_pts_unit
expr_stmt|;
block|}
else|else
block|{
name|free
argument_list|(
name|datum_pts_unit
argument_list|)
expr_stmt|;
name|datum_pts_unit
operator|=
name|NULL
expr_stmt|;
block|}
return|return;
block|}
block|}
ifdef|#
directive|ifdef
name|DEBUG_DATUM_PTC
name|fprintf
argument_list|(
name|logfile
argument_list|,
literal|"Error, could not shut down unit %d\n"
argument_list|,
name|unit
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|logfile
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"Datum_PTS: Could not shut down Datum PTS unit %d"
argument_list|,
name|unit
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*......................................................................*/
end_comment

begin_comment
comment|/*	datum_pts_poll							*/
end_comment

begin_comment
comment|/*......................................................................*/
end_comment

begin_function
specifier|static
name|void
name|datum_pts_poll
parameter_list|(
name|unit
parameter_list|,
name|peer
parameter_list|)
name|int
name|unit
decl_stmt|;
name|struct
name|peer
modifier|*
name|peer
decl_stmt|;
block|{
name|int
name|i
decl_stmt|;
name|int
name|index
decl_stmt|;
name|int
name|error_code
decl_stmt|;
name|l_fp
name|tstmp
decl_stmt|;
name|struct
name|datum_pts_unit
modifier|*
name|datum_pts
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUG_DATUM_PTC
name|fprintf
argument_list|(
name|logfile
argument_list|,
literal|"Poll Datum PTS\n"
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|logfile
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/*									*/
comment|/*...... find the unit and send out a time request .....................*/
comment|/*									*/
name|index
operator|=
operator|-
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nunits
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|datum_pts_unit
index|[
name|i
index|]
operator|->
name|unit
operator|==
name|unit
condition|)
block|{
name|index
operator|=
name|i
expr_stmt|;
name|datum_pts
operator|=
name|datum_pts_unit
index|[
name|i
index|]
expr_stmt|;
name|error_code
operator|=
name|write
argument_list|(
name|datum_pts
operator|->
name|PTS_fd
argument_list|,
name|TIME_REQUEST
argument_list|,
literal|6
argument_list|)
expr_stmt|;
if|if
condition|(
name|error_code
operator|!=
literal|6
condition|)
name|perror
argument_list|(
literal|"TIME_REQUEST"
argument_list|)
expr_stmt|;
name|datum_pts
operator|->
name|nbytes
operator|=
literal|0
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|index
operator|==
operator|-
literal|1
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG_DATUM_PTC
name|fprintf
argument_list|(
name|logfile
argument_list|,
literal|"Error, could not poll unit %d\n"
argument_list|,
name|unit
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|logfile
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"Datum_PTS: Could not poll unit %d"
argument_list|,
name|unit
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
end_function

begin_comment
comment|/*......................................................................*/
end_comment

begin_comment
comment|/*	datum_pts_control						*/
end_comment

begin_comment
comment|/*......................................................................*/
end_comment

begin_function
specifier|static
name|void
name|datum_pts_control
parameter_list|(
name|unit
parameter_list|,
name|in
parameter_list|,
name|out
parameter_list|)
name|u_int
name|unit
decl_stmt|;
name|struct
name|refclockstat
modifier|*
name|in
decl_stmt|;
name|struct
name|refclockstat
modifier|*
name|out
decl_stmt|;
block|{
ifdef|#
directive|ifdef
name|DEBUG_DATUM_PTC
name|fprintf
argument_list|(
name|logfile
argument_list|,
literal|"Control Datum PTS\n"
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|logfile
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/*......................................................................*/
end_comment

begin_comment
comment|/*	datum_pts_init							*/
end_comment

begin_comment
comment|/*......................................................................*/
end_comment

begin_function
specifier|static
name|void
name|datum_pts_init
parameter_list|()
block|{
ifdef|#
directive|ifdef
name|DEBUG_DATUM_PTC
name|logfile
operator|=
name|fopen
argument_list|(
literal|"xntpd.log"
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|logfile
argument_list|,
literal|"Init Datum PTS\n"
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|logfile
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|memcpy
argument_list|(
name|START_GENERATOR
argument_list|,
literal|"//kk01"
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|STOP_GENERATOR
argument_list|,
literal|"//kk00"
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|TIME_REQUEST
argument_list|,
literal|"//k/mn"
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|datum_pts_unit
operator|=
name|NULL
expr_stmt|;
name|nunits
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_comment
comment|/*......................................................................*/
end_comment

begin_comment
comment|/*	datum_pts_buginfo						*/
end_comment

begin_comment
comment|/*......................................................................*/
end_comment

begin_function
specifier|static
name|void
name|datum_pts_buginfo
parameter_list|(
name|unit
parameter_list|,
name|bug
parameter_list|)
name|int
name|unit
decl_stmt|;
specifier|register
name|struct
name|refclockbug
modifier|*
name|bug
decl_stmt|;
block|{
ifdef|#
directive|ifdef
name|DEBUG_DATUM_PTC
name|fprintf
argument_list|(
name|logfile
argument_list|,
literal|"Buginfo Datum PTS\n"
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|logfile
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/*......................................................................*/
end_comment

begin_comment
comment|/*	datum_pts_receive						*/
end_comment

begin_comment
comment|/*......................................................................*/
end_comment

begin_function
specifier|static
name|void
name|datum_pts_receive
parameter_list|(
name|rbufp
parameter_list|)
name|struct
name|recvbuf
modifier|*
name|rbufp
decl_stmt|;
block|{
name|int
name|i
decl_stmt|;
name|l_fp
name|tstmp
decl_stmt|,
name|trtmp
decl_stmt|,
name|tstmp1
decl_stmt|;
name|struct
name|datum_pts_unit
modifier|*
name|datum_pts
decl_stmt|;
name|char
modifier|*
name|dpt
decl_stmt|;
name|int
name|dpend
decl_stmt|;
name|time_t
name|tim
decl_stmt|;
name|struct
name|tm
modifier|*
name|loctm
decl_stmt|;
name|int
name|tzoff
decl_stmt|;
name|int
name|timerr
decl_stmt|;
name|double
name|ftimerr
decl_stmt|,
name|abserr
decl_stmt|;
name|datum_pts
operator|=
operator|(
expr|struct
name|datum_pts_unit
operator|*
operator|)
name|rbufp
operator|->
name|recv_srcclock
expr_stmt|;
name|dpt
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
name|rbufp
operator|->
name|recv_space
expr_stmt|;
name|dpend
operator|=
name|rbufp
operator|->
name|recv_length
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG_DATUM_PTC
name|fprintf
argument_list|(
name|logfile
argument_list|,
literal|"Receive Datum PTS: %d bytes\n"
argument_list|,
name|dpend
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|logfile
argument_list|)
expr_stmt|;
endif|#
directive|endif
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dpend
condition|;
name|i
operator|++
control|)
block|{
name|datum_pts
operator|->
name|retbuf
index|[
name|datum_pts
operator|->
name|nbytes
operator|+
name|i
index|]
operator|=
name|dpt
index|[
name|i
index|]
expr_stmt|;
block|}
name|datum_pts
operator|->
name|nbytes
operator|+=
name|dpend
expr_stmt|;
if|if
condition|(
name|datum_pts
operator|->
name|nbytes
operator|!=
literal|7
condition|)
block|{
return|return;
block|}
comment|/*									*/
comment|/*...... save the ntp system time ......................................*/
comment|/*									*/
name|trtmp
operator|=
name|rbufp
operator|->
name|recv_time
expr_stmt|;
name|datum_pts
operator|->
name|lastrec
operator|=
name|trtmp
expr_stmt|;
comment|/*									*/
comment|/*...... convert the time from the buffer ..............................*/
comment|/*									*/
name|datum_pts
operator|->
name|day
operator|=
literal|100
operator|*
operator|(
name|datum_pts
operator|->
name|retbuf
index|[
literal|0
index|]
operator|&
literal|0x0f
operator|)
operator|+
literal|10
operator|*
operator|(
operator|(
name|datum_pts
operator|->
name|retbuf
index|[
literal|1
index|]
operator|&
literal|0xf0
operator|)
operator|>>
literal|4
operator|)
operator|+
operator|(
name|datum_pts
operator|->
name|retbuf
index|[
literal|1
index|]
operator|&
literal|0x0f
operator|)
expr_stmt|;
name|datum_pts
operator|->
name|hour
operator|=
literal|10
operator|*
operator|(
operator|(
name|datum_pts
operator|->
name|retbuf
index|[
literal|2
index|]
operator|&
literal|0x30
operator|)
operator|>>
literal|4
operator|)
operator|+
operator|(
name|datum_pts
operator|->
name|retbuf
index|[
literal|2
index|]
operator|&
literal|0x0f
operator|)
expr_stmt|;
name|datum_pts
operator|->
name|minute
operator|=
literal|10
operator|*
operator|(
operator|(
name|datum_pts
operator|->
name|retbuf
index|[
literal|3
index|]
operator|&
literal|0x70
operator|)
operator|>>
literal|4
operator|)
operator|+
operator|(
name|datum_pts
operator|->
name|retbuf
index|[
literal|3
index|]
operator|&
literal|0x0f
operator|)
expr_stmt|;
name|datum_pts
operator|->
name|second
operator|=
literal|10
operator|*
operator|(
operator|(
name|datum_pts
operator|->
name|retbuf
index|[
literal|4
index|]
operator|&
literal|0x70
operator|)
operator|>>
literal|4
operator|)
operator|+
operator|(
name|datum_pts
operator|->
name|retbuf
index|[
literal|4
index|]
operator|&
literal|0x0f
operator|)
expr_stmt|;
name|datum_pts
operator|->
name|msec
operator|=
literal|100
operator|*
operator|(
operator|(
name|datum_pts
operator|->
name|retbuf
index|[
literal|5
index|]
operator|&
literal|0xf0
operator|)
operator|>>
literal|4
operator|)
operator|+
literal|10
operator|*
operator|(
name|datum_pts
operator|->
name|retbuf
index|[
literal|5
index|]
operator|&
literal|0x0f
operator|)
operator|+
operator|(
operator|(
name|datum_pts
operator|->
name|retbuf
index|[
literal|6
index|]
operator|&
literal|0xf0
operator|)
operator|>>
literal|4
operator|)
expr_stmt|;
name|datum_pts
operator|->
name|usec
operator|=
literal|1000
operator|*
name|datum_pts
operator|->
name|msec
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG_DATUM_PTC
name|fprintf
argument_list|(
name|logfile
argument_list|,
literal|"day %d, hour %d, minute %d, second %d, msec %d\n"
argument_list|,
name|datum_pts
operator|->
name|day
argument_list|,
name|datum_pts
operator|->
name|hour
argument_list|,
name|datum_pts
operator|->
name|minute
argument_list|,
name|datum_pts
operator|->
name|second
argument_list|,
name|datum_pts
operator|->
name|msec
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|logfile
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/*									*/
comment|/*...... get the GMT time zone offset ..................................*/
comment|/*									*/
name|tim
operator|=
name|trtmp
operator|.
name|l_ui
operator|-
name|JAN_1970
expr_stmt|;
name|loctm
operator|=
name|localtime
argument_list|(
operator|&
name|tim
argument_list|)
expr_stmt|;
name|tzoff
operator|=
operator|-
name|loctm
operator|->
name|tm_gmtoff
operator|/
literal|3600
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG_DATUM_PTC
name|fprintf
argument_list|(
name|logfile
argument_list|,
literal|"Time Zone = %d, time (sec) since 1970 = %d\n"
argument_list|,
name|tzoff
argument_list|,
name|tim
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|logfile
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/*									*/
comment|/*...... make sure that we have a good time from the Datum PTS .........*/
comment|/*									*/
if|if
condition|(
operator|!
name|clocktime
argument_list|(
name|datum_pts
operator|->
name|day
argument_list|,
name|datum_pts
operator|->
name|hour
argument_list|,
name|datum_pts
operator|->
name|minute
argument_list|,
name|datum_pts
operator|->
name|second
argument_list|,
name|tzoff
argument_list|,
name|datum_pts
operator|->
name|lastrec
operator|.
name|l_ui
argument_list|,
operator|&
name|datum_pts
operator|->
name|yearstart
argument_list|,
operator|&
name|datum_pts
operator|->
name|lastref
operator|.
name|l_ui
argument_list|)
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG_DATUM_PTC
name|fprintf
argument_list|(
name|logfile
argument_list|,
literal|"Error: bad clocktime\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|logfile
argument_list|,
literal|"GMT %d, lastrec %d, yearstart %d, lastref %d\n"
argument_list|,
name|tzoff
argument_list|,
name|datum_pts
operator|->
name|lastrec
operator|.
name|l_ui
argument_list|,
name|datum_pts
operator|->
name|yearstart
argument_list|,
name|datum_pts
operator|->
name|lastref
operator|.
name|l_ui
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|logfile
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"Datum_PTS: Bad clocktime"
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
ifdef|#
directive|ifdef
name|DEBUG_DATUM_PTC
name|fprintf
argument_list|(
name|logfile
argument_list|,
literal|"Good clocktime\n"
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|logfile
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
comment|/*									*/
comment|/*...... we have datum_pts->lastref.l_ui set, get useconds now .........*/
comment|/*									*/
name|TVUTOTSF
argument_list|(
name|datum_pts
operator|->
name|usec
argument_list|,
name|datum_pts
operator|->
name|lastref
operator|.
name|l_uf
argument_list|)
expr_stmt|;
comment|/*									*/
comment|/*...... pass the new time to xntpd ....................................*/
comment|/*									*/
name|tstmp
operator|=
name|datum_pts
operator|->
name|lastref
expr_stmt|;
name|L_SUB
argument_list|(
operator|&
name|tstmp
argument_list|,
operator|&
name|datum_pts
operator|->
name|lastrec
argument_list|)
expr_stmt|;
comment|/* tstmp is the time correction */
name|datum_pts
operator|->
name|coderecv
operator|++
expr_stmt|;
comment|/*   set_logfile(logfile); */
name|refclock_receive
argument_list|(
name|datum_pts
operator|->
name|peer
argument_list|,
operator|&
name|tstmp
argument_list|,
name|tzoff
argument_list|,
literal|0
argument_list|,
operator|&
name|datum_pts
operator|->
name|lastrec
argument_list|,
operator|&
name|datum_pts
operator|->
name|lastrec
argument_list|,
name|datum_pts
operator|->
name|leap
argument_list|)
expr_stmt|;
name|timerr
operator|=
name|tstmp
operator|.
name|l_ui
operator|<<
literal|20
expr_stmt|;
name|timerr
operator||=
operator|(
name|tstmp
operator|.
name|l_uf
operator|>>
literal|12
operator|)
operator|&
literal|0x000fffff
expr_stmt|;
name|ftimerr
operator|=
name|timerr
expr_stmt|;
name|ftimerr
operator|/=
literal|1024
operator|*
literal|1024
expr_stmt|;
name|abserr
operator|=
name|ftimerr
expr_stmt|;
if|if
condition|(
name|ftimerr
operator|<
literal|0.0
condition|)
name|abserr
operator|=
operator|-
name|ftimerr
expr_stmt|;
if|if
condition|(
name|datum_pts
operator|->
name|sigma2
operator|==
literal|0.0
condition|)
block|{
if|if
condition|(
name|abserr
operator|<
name|DATUM_MAX_ERROR
condition|)
block|{
name|datum_pts
operator|->
name|sigma2
operator|=
name|abserr
operator|*
name|abserr
expr_stmt|;
block|}
else|else
block|{
name|datum_pts
operator|->
name|sigma2
operator|=
name|DATUM_MAX_ERROR2
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|abserr
operator|<
name|DATUM_MAX_ERROR
condition|)
block|{
name|datum_pts
operator|->
name|sigma2
operator|=
literal|0.95
operator|*
name|datum_pts
operator|->
name|sigma2
operator|+
literal|0.05
operator|*
name|abserr
operator|*
name|abserr
expr_stmt|;
block|}
else|else
block|{
name|datum_pts
operator|->
name|sigma2
operator|=
literal|0.95
operator|*
name|datum_pts
operator|->
name|sigma2
operator|+
literal|0.05
operator|*
name|DATUM_MAX_ERROR2
expr_stmt|;
block|}
block|}
ifdef|#
directive|ifdef
name|DEBUG_DATUM_PTC
name|fprintf
argument_list|(
name|logfile
argument_list|,
literal|"Time error = %f seconds, Sigma Squared = %f\n"
argument_list|,
name|ftimerr
argument_list|,
name|datum_pts
operator|->
name|sigma2
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|logfile
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/*									*/
comment|/*...... make sure that we understand the format for xntp time .........*/
comment|/*									*/
ifdef|#
directive|ifdef
name|DEBUG_DATUM_PTC
name|tstmp
operator|.
name|l_ui
operator|=
literal|2
expr_stmt|;
name|TVUTOTSF
argument_list|(
literal|123456
argument_list|,
name|tstmp
operator|.
name|l_uf
argument_list|)
expr_stmt|;
name|timerr
operator|=
name|tstmp
operator|.
name|l_ui
operator|<<
literal|20
expr_stmt|;
name|timerr
operator||=
operator|(
name|tstmp
operator|.
name|l_uf
operator|>>
literal|12
operator|)
operator|&
literal|0x000fffff
expr_stmt|;
name|ftimerr
operator|=
name|timerr
expr_stmt|;
name|ftimerr
operator|/=
literal|1024
operator|*
literal|1024
expr_stmt|;
name|fprintf
argument_list|(
name|logfile
argument_list|,
literal|"Test1 2.123456 = %f\n"
argument_list|,
name|ftimerr
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|logfile
argument_list|)
expr_stmt|;
name|tstmp1
operator|.
name|l_ui
operator|=
literal|3
expr_stmt|;
name|TVUTOTSF
argument_list|(
literal|223456
argument_list|,
name|tstmp1
operator|.
name|l_uf
argument_list|)
expr_stmt|;
name|timerr
operator|=
name|tstmp1
operator|.
name|l_ui
operator|<<
literal|20
expr_stmt|;
name|timerr
operator||=
operator|(
name|tstmp1
operator|.
name|l_uf
operator|>>
literal|12
operator|)
operator|&
literal|0x000fffff
expr_stmt|;
name|ftimerr
operator|=
name|timerr
expr_stmt|;
name|ftimerr
operator|/=
literal|1024
operator|*
literal|1024
expr_stmt|;
name|fprintf
argument_list|(
name|logfile
argument_list|,
literal|"Test2 3.223456 = %f\n"
argument_list|,
name|ftimerr
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|logfile
argument_list|)
expr_stmt|;
name|L_SUB
argument_list|(
operator|&
name|tstmp
argument_list|,
operator|&
name|tstmp1
argument_list|)
expr_stmt|;
name|timerr
operator|=
name|tstmp
operator|.
name|l_ui
operator|<<
literal|20
expr_stmt|;
name|timerr
operator||=
operator|(
name|tstmp
operator|.
name|l_uf
operator|>>
literal|12
operator|)
operator|&
literal|0x000fffff
expr_stmt|;
name|ftimerr
operator|=
name|timerr
expr_stmt|;
name|ftimerr
operator|/=
literal|1024
operator|*
literal|1024
expr_stmt|;
name|fprintf
argument_list|(
name|logfile
argument_list|,
literal|"Test3 -1.100000 = %f\n"
argument_list|,
name|ftimerr
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|logfile
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

end_unit

